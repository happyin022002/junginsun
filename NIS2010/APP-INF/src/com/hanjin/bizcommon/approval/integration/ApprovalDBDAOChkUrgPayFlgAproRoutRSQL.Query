<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ApprovalDBDAOChkUrgPayFlgAproRoutRSQL">
			<desc><![CDATA[후결 가능 여부 검사 : PDT님이 apro step의 마지막인지 검사 + 최소2개 이상의 apro step 존재여부 검사]]></desc>
			<sql><![CDATA[
SELECT 
--    X.URG_PAY_FLG, X.CSR_USD_AMT, X.APRO_USR_ID, X.APRO_RQST_SEQ, X.CRNT_APRO_SEQ,
    CASE
    WHEN NVL(X.URG_PAY_FLG,'N') = 'Y'
    THEN
        CASE
        WHEN 
            CASE
            WHEN ACCT_XCH_RT_YRMON IS NOT NULL AND CSR_USD_AMT IS NOT NULL
            THEN 
                CASE
                WHEN X.KNT < 2
                THEN 'K'
                ELSE DECODE(NVL(AP_COM_CHECK_CEO_YN_FNC(X.APRO_USR_ID),'X'),'N','P',NVL(AP_COM_CHECK_CEO_YN_FNC(X.APRO_USR_ID),'X'))
                END
            WHEN (ACCT_XCH_RT_YRMON IS NOT NULL AND CSR_USD_AMT IS NULL) OR (ACCT_XCH_RT_YRMON IS NULL AND CSR_USD_AMT IS NOT NULL)
            THEN 'E' /* 둘중 하나만 값이 있으면 잘못 된것 */
            ELSE 'X' /* 둘다 없으면 이번 대상아니라고 판단해야함 */
            END = 'Y'
        THEN
            CASE 
            WHEN X.APRO_RQST_SEQ-1 = @[apro_rqst_seq] /* X.CRNT_APRO_SEQ  최종 결재자 SEQ - 1 = 현재 단계 결재 SEQ와 같은 경우에는 후결 가능 */
            THEN 'Y'
            ELSE 'N2' 
            END 
        ELSE 'X2'
        END       
    ELSE 'N3'
    END RETVAL
FROM (
    SELECT 
        A.CSR_NO
        , A.SRC_CTNT
        , A.GL_DT
        , A.CSR_CURR_CD
        , A.CSR_AMT
        , A.ACCT_XCH_RT_YRMON
        , A.CSR_USD_AMT
        , COUNT(R.APRO_RQST_SEQ) OVER (PARTITION BY R.APRO_RQST_NO) KNT
        , DENSE_RANK() OVER (PARTITION BY R.APRO_RQST_NO ORDER BY R.APRO_RQST_SEQ DESC) RNK
        , R.APRO_RQST_NO
        , R.APRO_RQST_SEQ
        , R.APRO_USR_ID
        , R.APRO_USR_NM
        , A.URG_PAY_FLG
        , H.CRNT_APRO_SEQ
    FROM AP_INV_HDR A, COM_APRO_RQST_HDR H, COM_APRO_CSR_DTL D, COM_APRO_RQST_ROUT R 
    WHERE 1=1
    AND A.CSR_NO = D.CSR_NO
    AND H.APRO_RQST_NO = D.APRO_RQST_NO
    AND H.APRO_RQST_NO = R.APRO_RQST_NO
    AND A.CSR_NO = @[csr_no]
) X
WHERE RNK = 1			]]></sql>
			<params>
				<param name="apro_rqst_seq" type="12" value="" out="N"/>
				<param name="csr_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
