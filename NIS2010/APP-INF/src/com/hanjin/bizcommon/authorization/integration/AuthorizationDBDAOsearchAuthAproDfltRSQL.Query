<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="AuthorizationDBDAOsearchAuthAproDfltRSQL">
			<desc><![CDATA[Authorization Approval Default 목록 조회]]></desc>
			<sql><![CDATA[
WITH PRE_APRO_HIS AS ( 
    SELECT X.*
    FROM (
        SELECT R.AUTH_APRO_RQST_NO 
        FROM COM_AUTH_APRO_RQST R 
        WHERE R.RQST_USR_ID = @[usr_id]
		AND NVL(R.DELT_FLG,'N') <> 'Y'
		AND NVL(R.CFM_FLG,'N') = 'Y'
        AND EXISTS (
            SELECT 1 
            FROM COM_AUTH_APRO_RQST_ROUT T
            WHERE T.AUTH_APRO_RQST_NO = R.AUTH_APRO_RQST_NO
			AND NVL(T.DELT_FLG,'N') <> 'Y'
        )
        ORDER BY R.AUTH_APRO_RQST_NO DESC
    ) X
    WHERE ROWNUM = 1
)
SELECT
U.AUTH_APRO_ROUT_USR_SEQ, U.AUTH_APRO_USR_ID, U.AUTH_APRO_USR_NM, B.OFC_CD AUTH_APRO_OFC_CD, U.AUTH_APRO_USR_JB_TIT_NM
FROM COM_AUTH_APRO_DFLT_ROUT R, COM_AUTH_APRO_DFLT_ROUT_USR U, COM_USER B
WHERE R.AUTH_APRO_ROUT_SEQ = U.AUTH_APRO_ROUT_SEQ
AND R.SUB_SYS_CD = DECODE(@[sub_sys_cd],'TLL','MNR',@[sub_sys_cd]) 
AND R.OFC_CD = @[ofc_cd] 
AND R.PGM_NO = @[pgm_no] 
AND R.AUTH_APRO_TP_CD = @[auth_apro_tp_cd]
AND NVL(R.DELT_FLG,'N') <> 'Y'
AND NVL(U.DELT_FLG,'N') <> 'Y'
AND NVL(B.USE_FLG,'N') = 'Y'
AND U.AUTH_APRO_USR_ID IN (B.USR_ID,B.EP_ID)
AND 'N' =   CASE 
            WHEN NVL((SELECT H.AUTH_APRO_RQST_NO FROM PRE_APRO_HIS H),'') IS NOT NULL
            THEN 'Y'
            ELSE 'N'
            END
UNION ALL
SELECT 
AUTH_APRO_RQST_ROUT_SEQ, AUTH_APRO_USR_ID, AUTH_APRO_USR_NM, AUTH_APRO_OFC_CD, AUTH_APRO_USR_JB_TIT_NM
FROM COM_AUTH_APRO_RQST_ROUT 
WHERE AUTH_APRO_RQST_NO = (SELECT H.AUTH_APRO_RQST_NO FROM PRE_APRO_HIS H) 
AND NVL(DELT_FLG,'N') <> 'Y'
AND 'Y' =   CASE 
            WHEN NVL((SELECT H.AUTH_APRO_RQST_NO FROM PRE_APRO_HIS H),'') IS NOT NULL
            THEN 'Y'
            ELSE 'N'
            END
ORDER BY AUTH_APRO_ROUT_USR_SEQ DESC			]]></sql>
			<params>
				<param name="usr_id" type="12" value="" out="N"/>
				<param name="sub_sys_cd" type="12" value="" out="N"/>
				<param name="ofc_cd" type="12" value="" out="N"/>
				<param name="pgm_no" type="12" value="" out="N"/>
				<param name="auth_apro_tp_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
