<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="AuthorizationDBDAOsearchAuthChkXlsBtnPrmtRSQL">
			<desc><![CDATA[Excel Download 승인여부 확인하는 화면인지 조회]]></desc>
			<sql><![CDATA[
WITH XLS_RSTR AS (
    SELECT 
    P.XLS_DL_RSTR_ACT_FLG, P.DFLT_XLS_DL_DUR_HRS
    , P.AUTH_PGM_SEQ, NVL(P.USE_FLG,'N') PGM_USE_FLG
    , B.AUTH_PGM_BTN_SEQ, NVL(B.USE_FLG,'N') BTN_USE_FLG
    FROM COM_AUTH_PGM P, COM_PROGRAM C, COM_AUTH_PGM_BTN B
    WHERE 1=1
    AND P.PGM_NO = C.PGM_NO
    AND NVL(C.USE_FLG,'N') = 'Y'
    AND P.AUTH_PGM_SEQ = B.AUTH_PGM_SEQ
    AND P.SUB_SYS_CD = @[sub_sys_cd_auth]
    AND P.PGM_NO = @[pgm_no]
    AND B.PGM_BTN_ID = 'EXCEL_DOWN_DUMMY' 
    AND B.AUTH_APRO_TP_CD = NVL(@[auth_apro_tp_cd],'BF')
    AND ROWNUM = 1
)
, RQST AS (
    SELECT Q.* FROM (  
        SELECT 
        DENSE_RANK() OVER (ORDER BY DECODE(NVL(R.AUTH_APSTS_CD,'X'),'C',1,'P',2,3), R.AUTH_APRO_RQST_NO DESC) RNK
        , R.AUTH_APRO_RQST_NO
        , NVL(R.AUTH_APSTS_CD,'X') AUTH_APSTS_CD
        FROM COM_AUTH_APRO_RQST R
        WHERE 1=1
        AND NVL(R.DELT_FLG,'N') <> 'Y'
        AND NVL(R.CFM_FLG,'N') = 'Y'
        AND R.AUTH_PGM_BTN_SEQ = (SELECT X.AUTH_PGM_BTN_SEQ FROM XLS_RSTR X)
        AND R.RQST_USR_ID = @[usr_id]
        AND (
            (NVL(R.AUTH_APSTS_CD,'X') = 'C' AND GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC(R.RQST_OFC_CD) BETWEEN R.RQST_END_DT AND R.RQST_END_DT + NVL((SELECT X.DFLT_XLS_DL_DUR_HRS FROM XLS_RSTR X),0)/24)
            OR
            (NVL(R.AUTH_APSTS_CD,'X') = 'P')
            )
    ) Q
    WHERE Q.RNK = 1
)
SELECT
  CASE
  WHEN NVL((SELECT X.PGM_USE_FLG FROM XLS_RSTR X),'') = 'Y' AND NVL((SELECT X.AUTH_PGM_SEQ FROM XLS_RSTR X),'') IS NOT NULL AND
       NVL((SELECT X.BTN_USE_FLG FROM XLS_RSTR X),'') = 'Y' AND NVL((SELECT X.AUTH_PGM_BTN_SEQ FROM XLS_RSTR X),'') IS NOT NULL
  THEN NVL((SELECT X.XLS_DL_RSTR_ACT_FLG FROM XLS_RSTR X),'X')
  ELSE 'X'
  END XLS_DL_RSTR_ACT_FLG
, NVL((SELECT R.AUTH_APSTS_CD FROM RQST R),'') AUTH_APSTS_CD
, NVL((SELECT R.AUTH_APRO_RQST_NO FROM RQST R),'') AUTH_APRO_RQST_NO
, NVL((SELECT X.AUTH_PGM_SEQ FROM XLS_RSTR X),'') AUTH_PGM_SEQ  
, NVL((SELECT X.AUTH_PGM_BTN_SEQ FROM XLS_RSTR X),'') AUTH_PGM_BTN_SEQ
FROM DUAL			]]></sql>
			<params>
				<param name="sub_sys_cd_auth" type="12" value="" out="N"/>
				<param name="pgm_no" type="12" value="" out="N"/>
				<param name="auth_apro_tp_cd" type="12" value="" out="N"/>
				<param name="usr_id" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
