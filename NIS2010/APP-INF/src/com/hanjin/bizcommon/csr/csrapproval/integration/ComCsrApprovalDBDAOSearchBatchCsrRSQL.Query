<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ComCsrApprovalDBDAOSearchBatchCsrRSQL">
			<desc><![CDATA[batch 대상 csr조회]]></desc>
			<sql><![CDATA[
WITH CSR_BASE AS (
    SELECT 
    L.*
    FROM COM_AP_CSR_HIS L
    WHERE 1=1
    AND L.COM_AP_CSR_APRO_HIS_SEQ > 0
    AND NVL(L.GW_APRO_RSLT_CD,'X') = 'Y'
)
SELECT 
N.CSR_NO
,N.TJ_OFC_CD OFC_CD
,N.APRO_USR_ID USER_ID
,N.APRO_USR_NM
,N.APRO_USR_JB_TIT_NM
,N.AGMT_DOC_CFM_CD
,N.GW_AGMT_DOC_CFM_CD
FROM (
SELECT
H.*, 
DENSE_RANK() OVER (PARTITION BY X.CSR_NO ORDER BY X.COM_AP_CSR_APRO_HIS_SEQ DESC) RNK,
X.COM_AP_CSR_APRO_HIS_SEQ, X.APRO_USR_ID, X.APRO_USR_NM, X.APRO_USR_JB_TIT_NM
FROM CSR_BASE X, AP_INV_HDR H
WHERE 1=1
AND H.CSR_NO = X.CSR_NO
AND NVL(H.CSR_APRO_TP_CD,'AL') = 'GW'
AND NVL(H.EXE_ACT_TP_CD,'N') = 'B'
AND NVL(H.RQST_APRO_STEP_FLG,'X') <> 'Y'
AND H.IF_FLG IS NULL
AND H.RCV_ERR_FLG IS NULL
AND H.AFT_ACT_FLG IS NULL
AND H.CSR_APRO_CMPL_DT IS NOT NULL
AND H.CSR_RJCT_DT IS NULL
AND CASE WHEN H.IF_ERR_RSN IS NOT NULL THEN SUBSTR(UPPER(H.IF_ERR_RSN),1,7) ELSE 'X' END <> 'SENDING'
AND H.CRE_DT >= NVL((SELECT V.CFM_DT FROM COM_AP_ACCT_VER V WHERE V.AP_ACCT_VER_NO = (SELECT MAX(M.AP_ACCT_VER_NO) FROM COM_AP_ACCT_VER M WHERE NVL(M.CFM_FLG,'N') = 'Y')),SYSDATE-100)
AND ROWNUM <= NVL((SELECT V.EXE_ROW_KNT FROM COM_AP_ACCT_VER V WHERE V.AP_ACCT_VER_NO = (SELECT MAX(M.AP_ACCT_VER_NO) FROM COM_AP_ACCT_VER M WHERE NVL(M.CFM_FLG,'N') = 'Y')),100)
AND NOT EXISTS (
    SELECT 'X'
    FROM COM_AP_CSR_HIS E
    WHERE 1=1
    AND E.CSR_NO = H.CSR_NO
    AND E.COM_AP_CSR_APRO_HIS_SEQ > 0
    AND E.COM_AP_CSR_APRO_HIS_SEQ = (
        SELECT MAX(X.COM_AP_CSR_APRO_HIS_SEQ)
        FROM COM_AP_CSR_HIS X
        WHERE 1=1
        AND X.CSR_NO = E.CSR_NO
        AND X.COM_AP_CSR_APRO_HIS_SEQ > 0
        )
    AND E.AP_CSR_IF_STS_CD IN ('EX','SD','SE','IC','IE','BE') --// 10분 BATCH 주기를 넘어서 ERP에서 REPLY가 오는 경우가 있어서 BE(batch end)인 경우도 일단 제외한다.
    )
) N
WHERE N.RNK = 1
ORDER BY N.CRE_DT DESC			]]></sql>
			<params>
			</params>
		</query>
	</querys>
</sqls>
