<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="AgreementNoticeDBDAOSearchAgreementListRSQL">
			<desc><![CDATA[Notice popup user list 조회]]></desc>
			<sql><![CDATA[
WITH USR_MGMT AS (
    SELECT M.*    
    FROM COM_CTRT_USR_MGMT M
    WHERE 1=1
    AND M.ROOT_PGM_NO = @[pgm_no]
    AND EXISTS (
        SELECT 'X'
        FROM COM_CTRT_USR_LIST L
        WHERE 1=1
        AND L.SYS_CD = M.SYS_CD
        AND L.CTRT_OFC_CD = M.CTRT_OFC_CD
        AND L.AGMT_NO = M.AGMT_NO
        AND L.NTC_USR_ID = @[user_id]
        AND L.NTC_USR_SEQ <= COM_NTC_USR_KNT_FNC()
    )   
)
SELECT C1.SYS_CD
      ,C1.AGMT_NO
      ,C1.VNDR_NM
      ,C1.AGMT_TRSP_TP_CD
      ,C1.CTRT_OFC_CD
      ,C1.CTRT_CRE_USR_ID
      ,C1.CTRT_CRE_USR_NM
      ,C1.LIVE_FLG
      ,C1.AGMT_EFF_DT
      ,C1.AGMT_EXP_DT
      ,C1.CTRT_UPD_DT
      ,MAX(C1.CNT) OVER (PARTITION BY C1.SYS_CD) AGMT_CNT
 FROM 
       (SELECT B1.SYS_CD
              ,B1.AGMT_NO
              ,B1.VNDR_NM
              ,B1.AGMT_TRSP_TP_CD
              ,B1.CTRT_OFC_CD
              ,B1.CTRT_CRE_USR_ID
              ,B1.CTRT_CRE_USR_NM
              ,NVL(B1.LIVE_FLG, 'N') LIVE_FLG
              ,B1.AGMT_EFF_DT
              ,B1.AGMT_EXP_DT
              ,B1.CTRT_UPD_DT
              ,DENSE_RANK() OVER (PARTITION BY B1.SYS_CD ORDER BY B1.AGMT_NO) CNT
          FROM
              (SELECT A1.SYS_CD
                      ,CASE WHEN A1.SYS_CD = 'TRS' THEN
                            	CASE WHEN INSTR(A1.AGMT_NO,'-') > 0 THEN SUBSTR(A1.AGMT_NO,1,INSTR(A1.AGMT_NO,'-',1,1)-1) ELSE A1.AGMT_NO END
                            ELSE A1.AGMT_NO
                       END AS AGMT_NO
                      ,(SELECT VNDR_LGL_ENG_NM FROM MDM_VENDOR WHERE VNDR_SEQ = A1.VNDR_SEQ) VNDR_NM
                      ,A1.AGMT_TRSP_TP_CD
                      ,A1.CTRT_OFC_CD
                      ,A1.CTRT_CRE_USR_ID
                      ,(SELECT USR_NM FROM COM_USER WHERE USR_ID = A1.CTRT_CRE_USR_ID) CTRT_CRE_USR_NM
                      ,(SELECT USE_FLG FROM COM_USER WHERE USR_ID = A1.CTRT_CRE_USR_ID) LIVE_FLG
                      ,TO_CHAR(A1.AGMT_EFF_DT, 'YYYY-MM-DD') AGMT_EFF_DT
                      ,TO_CHAR(A1.AGMT_EXP_DT, 'YYYY-MM-DD') AGMT_EXP_DT
                      ,TO_CHAR(A1.CTRT_UPD_DT, 'YYYY-MM-DD HH24:MI') CTRT_UPD_DT
                      ,(SELECT AR_HD_QTR_OFC_CD FROM MDM_ORGANIZATION WHERE OFC_CD = A1.CTRT_OFC_CD) CTRT_RHQ
                FROM COM_CTRT_NTC_INFO A1
               ) B1
              ,USR_MGMT B2
        WHERE B1.SYS_CD = B2.SYS_CD
          AND DECODE(B2.OFC_TP_CD, 'BB', B1.CTRT_OFC_CD, 'HQ', B1.CTRT_RHQ, 'HO', B2.CTRT_OFC_CD) = B2.CTRT_OFC_CD
          AND B1.AGMT_NO LIKE DECODE(B2.AGMT_NO, 'ALL', B1.AGMT_NO, B2.AGMT_MAPG_NO)||'%'
       ) C1
ORDER BY C1.AGMT_EXP_DT, C1.AGMT_NO			]]></sql>
			<params>
				<param name="pgm_no" type="12" value="" out="N"/>
				<param name="user_id" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
