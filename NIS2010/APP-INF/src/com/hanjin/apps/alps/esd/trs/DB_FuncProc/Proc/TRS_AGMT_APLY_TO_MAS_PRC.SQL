CREATE OR REPLACE PROCEDURE TRS_AGMT_APLY_TO_MAS_PRC(                                                                                                                                                                                                                                                                                                                                                        pi_bkg_no              IN  MAS_COM_PARA.BKG_NO%TYPE                                                                                                                                                                                                                                                                                        ,    pi_start_pctl_no       IN  MAS_COM_PARA.PCTL_NO%TYPE                                                                                                                                                                                                                                                                                       ,    pi_end_pctl_no         IN  MAS_COM_PARA.PCTL_NO%TYPE                                                                                                                                                                                                                                                                                       ,    pi_aoc_bat_seq         IN  VARCHAR                                                                                                                                                                                                                                                                                                         ,    pi_debug_flg           IN  VARCHAR                                                                                                                                                                                                                                                                                                         ,    po_rtn_cd              OUT NUMBER                                                                                                                                                                                                                                                                                                      )                                                                                                                                                                                                                                                                                                                                               AUTHID CURRENT_USER                                                                                                                                                                                                                                                                                                                               IS                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              /*###################################################################                                                                                                                                                                                                                                                                           # -- Type    : PROCEDURE                                                                                                                                                                                                                                                                                                                        # -- Author  : JEONG SANG-KI                                                                                                                                                                                                                                                                                                                    # -- Created : JAN 23, 2007                                                                                                                                                                                                                                                                                                                     # -- Table   : TRS_AGMT_*                                                                                                                                                                                                                                                                                                                       # -- Purpose : SERVICE PROVIDER RATE CALCULATION for COst Assignment.                                                                                                                                                                                                                                                                           # __________________________________________________________________                                                                                                                                                                                                                                                                            # >> SURCHARGE CALCULATION RULE FOR MAS <<                                                                                                                                                                                                                                                                                                      # 1. MAS_COST_SRC_CD V8 : RATE TYPE(2) + DETAIL TYPE(2) + Carrior Mode(2)                                                                                                                                                                                                                                                                       #  1-1. TR : BASIC RATE                                                                                                                                                                                                                                                                                                                         #  1-2. SC : Surcharge -> FU/OW                                                                                                                                                                                                                                                                                                                 #   1-2-1. TRS_AGMT_SCG_RT.CURR_CD값이 '%' 이면 1-1에 대한 RATE                                                                                                                                                                                                                                                                                 #   1-2-2. TRS_AGMT_SCG_RT.CURR_CD값이 '%' 아니고 CURRENCY CODE이면 FU/OW에 따른 RATE                                                                                                                                                                                                                                                           #  1-3. SM : Surcharge의 하나로 MAS_COM_COST_PARA.BKG_CGO_TP_CD = 'R'(Revenue Empty)인 경우만 해당됨. - 1-2와 동일.                                                                                                                                                                                                                             # __________________________________________________________________                                                                                                                                                                                                                                                                            # >> SURCHARGE CALCULATION RULE FOR TRS <<                                                                                                                                                                                                                                                                                                      # 1. FUEL SURCHARGE : FUA에서 찾고 없으면 FUE에서 찾는다.                                                                                                                                                                                                                                                                                       #  1-1. 동일한 ROUTE에 대한 동일한 RATE                                                                                                                                                                                                                                                                                                         # 2. OVER WEIGHT SURCHARG                                                                                                                                                                                                                                                                                                                       #  2-1. S/O WEIGHT > TRS_AGMT_SCG_RT.TO_WGT 일경우에 RATE 적용.                                                                                                                                                                                                                                                                                 # __________________________________________________________________                                                                                                                                                                                                                                                                            # >> TRANS. MODE = 'WD'/'WR'/'RW'/'WT'/'TW'인경우에 Agreement Pair Type의 Water Receiving Term & Water Delivery Term을 MAS에 UPDATE - 2007.03.08 <<                                                                                                                                                                                             # Agreement Table_Name : TRS_AGMT_EQ_RT                                                                                                                                                                                                                                                                                                         # 'WD'      - PAIR ONLY                                                                                                                                                                                                                                                                                                                         # 'WR'      - PAIR + PAIR/distance, DISTANCE/pair, DISTANCE                                                                                                                                                                                                                                                                                     # 'RW'      - PAIR ONLY                                                                                                                                                                                                                                                                                                                         # 'WT'      - PAIR ONLY                                                                                                                                                                                                                                                                                                                         # 'TW'      - PAIR ONLY                                                                                                                                                                                                                                                                                                                         # MAS Table_Name       : MAS_COM_COST_PARA                                                                                                                                                                                                                                                                                                      #     Column_Name #1      - xxx                                                                                                                                                                                                                                                                                                                 #     Column_Name #2      - xxx                                                                                                                                                                                                                                                                                                                 # 2012.10.15 LEE JU HYUN [CHM-201220664] [TRS] O5 컨테이너 추정 관련 로직 적용 --> O5의 Rate가 없을 경우 O4의 Rate로 추정 처리                                                                                                                                                                                                                  # 2012.12.10 CHO PY [HINTERLAND 2차 TF] [TRS] AOC OLD FLAG 가 존재하는 경우 --> 미주인경우 OLD FLAG가 존재해도 조회된 AGMT를 사용하도록 처리                                                                                                                                                                                                    # 2013.01.07 CHO PY [HINTERLAND 2차 TF] AOC 에서 호출할경우 BASIS DATE를 SYSDATE로 설정                                                                                                                                                                                                                                                         # 2013.01.16 CHO PY [HINTERLAND 2차 TF] AOC 에서 호출할경우 aoc_bat_seq로 지정된 weight를 설정                                                                                                                                                                                                                                                  #####################################################################*/                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         /* RETURN CODE DEFINITION */                                                                                                                                                                                                                                                                                                                    /* --------------------------                                                                                                                                                                                                                                                                                                                   # 0   : SUCESS                                                                                                                                                                                                                                                                                                                                  -------- FAILURE ------------                                                                                                                                                                                                                                                                                                                   # -1  : FAILURE                                                                                                                                                                                                                                                                                                                                 ----------------------------- */                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    CHO        CONSTANT VARCHAR2(3) := 'CO';                                                                                                                                                                                                                                                                                                        CHR        CONSTANT VARCHAR2(3) := 'CR';                                                                                                                                                                                                                                                                                                        THO        CONSTANT VARCHAR2(3) := 'TO';                                                                                                                                                                                                                                                                                                        THR        CONSTANT VARCHAR2(3) := 'TR';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        MAS_TR     CONSTANT VARCHAR2(3) := 'TR';                                                                                                                                                                                                                                                                                                        MAS_SC     CONSTANT VARCHAR2(3) := 'SC';                                                                                                                                                                                                                                                                                                        MAS_SM     CONSTANT VARCHAR2(3) := 'TR';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        MAS_BZC    CONSTANT VARCHAR2(3) := 'BZC';                                                                                                                                                                                                                                                                                                       MAS_SC_FU  CONSTANT VARCHAR2(3) := 'FU';                                                                                                                                                                                                                                                                                                        MAS_SC_OW  CONSTANT VARCHAR2(3) := 'OW';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        MAS_WAY_TP CONSTANT VARCHAR2(3) := '';                                                                                                                                                                                                                                                                                                          C_SCG_TP_DIV        VARCHAR2(1) := '%';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         v_bound_cd           VARCHAR2(10) := '';                                                                                                                                                                                                                                                                                                        v_cost_mod_cd        VARCHAR2(10) := '';                                                                                                                                                                                                                                                                                                        v_crr_mod_cd         VARCHAR2(10) := '';                                                                                                                                                                                                                                                                                                        v_fst_vndr_seq       NUMBER(6)    := 0;                                                                                                                                                                                                                                                                                                         v_snd_vndr_seq       NUMBER(6)    := 0;                                                                                                                                                                                                                                                                                                         v_trd_vndr_seq       NUMBER(6)    := 0;                                                                                                                                                                                                                                                                                                         v_ctrl_ofc_cd        VARCHAR2(10) := '';                                                                                                                                                                                                                                                                                                        v_basis_dt           DATE         := SYSDATE;                                                                                                                                                                                                                                                                                                   v_from_nod_cd        VARCHAR2(7)  := '';                                                                                                                                                                                                                                                                                                        v_via_nod_cd         VARCHAR2(7)  := '';                                                                                                                                                                                                                                                                                                        v_door_nod_cd        VARCHAR2(7)  := '';                                                                                                                                                                                                                                                                                                        v_to_nod_cd          VARCHAR2(7)  := '';                                                                                                                                                                                                                                                                                                        v_cust_nomi_trkr_flg VARCHAR2(1)  := '';                                                                                                                                                                                                                                                                                                        v_cust_cnt_cd        VARCHAR2(10) := '';                                                                                                                                                                                                                                                                                                        v_cust_seq           NUMBER(6)    := 0;                                                                                                                                                                                                                                                                                                         v_cmdt_cd            VARCHAR2(10) := '';                                                                                                                                                                                                                                                                                                        v_cgo_tp_cd          VARCHAR2(10) := '';                                                                                                                                                                                                                                                                                                        v_wgt_uom            VARCHAR2(10) := '';                                                                                                                                                                                                                                                                                                        v_wgt_qty            NUMBER(18,3) := 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         v_rail_svc_tp_cd     VARCHAR2(10) := '';                                                                                                                                                                                                                                                                                                        v_1st_rail_crr_tp_cd VARCHAR2(2)  := '';     /* CO, CR, TO, TR     */                                                                                                                                                                                                                                                                           v_2nd_rail_crr_tp_cd VARCHAR2(2)  := '';     /* CO, CR, TO, TR     */                                                                                                                                                                                                                                                                           v_3rd_rail_crr_tp_cd VARCHAR2(2)  := '';     /* CO, CR, TO, TR     */                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           v_rcv_term_cd        VARCHAR2(10) := '';                                                                                                                                                                                                                                                                                                        v_de_term_cd         VARCHAR2(10) := '';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        v_trs_agmt_rt_knd    VARCHAR2(6)  := '';     /* BZC, SCG Indicator */                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           /* US IRG 변경에 따른 추가 : 2007/04/24      */                                                                                                                                                                                                                                                                                                 v_1st_trsp_agmt_ofc_cty_cd     TRS_AGMT_EQ_RT.TRSP_AGMT_OFC_CTY_CD%TYPE   ;                                                                                                                                                                                                                                                                     v_1st_trsp_agmt_seq            TRS_AGMT_EQ_RT.TRSP_AGMT_SEQ%TYPE          ;                                                                                                                                                                                                                                                                     v_2nd_trsp_agmt_ofc_cty_cd     TRS_AGMT_EQ_RT.TRSP_AGMT_OFC_CTY_CD%TYPE   ;                                                                                                                                                                                                                                                                     v_2nd_trsp_agmt_seq            TRS_AGMT_EQ_RT.TRSP_AGMT_SEQ%TYPE          ;                                                                                                                                                                                                                                                                     v_3rd_trsp_agmt_ofc_cty_cd     TRS_AGMT_EQ_RT.TRSP_AGMT_OFC_CTY_CD%TYPE   ;                                                                                                                                                                                                                                                                     v_3rd_trsp_agmt_seq            TRS_AGMT_EQ_RT.TRSP_AGMT_SEQ%TYPE          ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     v_tmp_trsp_agmt_ofc_cty_cd     TRS_AGMT_EQ_RT.TRSP_AGMT_OFC_CTY_CD%TYPE   ;                                                                                                                                                                                                                                                                     v_tmp_trsp_agmt_seq            TRS_AGMT_EQ_RT.TRSP_AGMT_SEQ%TYPE          ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     v_agmt_ref_1st_no              TRS_AGMT_HDR.AGMT_REF_NO%TYPE              ;                                                                                                                                                                                                                                                                     v_agmt_ref_2nd_no              TRS_AGMT_HDR.AGMT_REF_NO%TYPE              ;                                                                                                                                                                                                                                                                     v_agmt_ref_3rd_no              TRS_AGMT_HDR.AGMT_REF_NO%TYPE              ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     v_tmp_agmt_ref_no              TRS_AGMT_HDR.AGMT_REF_NO%TYPE              ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     /* US IRG 변경에 따른 추가 : 2007/04/24      */                                                                                                                                                                                                                                                                                                 link_cnt             NUMBER(1)    := 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         /* PRIMARY KEY */                                                                                                                                                                                                                                                                                                                               v_pctl_no          MAS_COM_COST_PARA.PCTL_NO%TYPE           ;                                                                                                                                                                                                                                                                                   v_cost_act_grp_seq MAS_COM_COST_PARA.COST_ACT_GRP_SEQ%TYPE  ;                                                                                                                                                                                                                                                                                   v_cntr_tpsz_cd     MAS_COM_COST_PARA.CNTR_TPSZ_CD%TYPE      ;                                                                                                                                                                                                                                                                                   v_mas_cost_src_cd  MAS_COM_COST_PARA.MAS_COST_SRC_CD%TYPE   ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   /* TRS RATE CAL PROCEDURE - OUTPUT PARAMETER */                                                                                                                                                                                                                                                                                                 vo_way_type             VARCHAR2(3)     := '';                                                                                                                                                                                                                                                                                                  vo_curr_cd              VARCHAR2(3)     := '';                                                                                                                                                                                                                                                                                                  vo_final_rt             NUMBER(18,3)    := 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   vo_wtr_rcv_term_cd      TRS_AGMT_EQ_RT.WTR_RCV_TERM_CD%TYPE ;                                                                                                                                                                                                                                                                                   vo_wtr_de_term_cd       TRS_AGMT_EQ_RT.WTR_DE_TERM_CD%TYPE  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   vo_fuel_scg_rt          NUMBER(18,3)    := 0;                                                                                                                                                                                                                                                                                                   vo_fuel_scg_rt_tp       VARCHAR2(3)     := '';                                                                                                                                                                                                                                                                                                  vo_over_wgt_scg_rt      NUMBER(18,3)    := 0;                                                                                                                                                                                                                                                                                                   vo_over_wgt_scg_rt_tp   VARCHAR2(3)     := '';                                                                                                                                                                                                                                                                                                  vo_rt_cal_rtn_cd        NUMBER(18,3)    := 0;                                                                                                                                                                                                                                                                                                   vo_rt_cal_rtn_msg       VARCHAR2(100)   := '';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  vo_basic_rt_rtn_cd      NUMBER          ;                                                                                                                                                                                                                                                                                                       vo_scg_rt_rtn_cd        NUMBER          ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       /* TEMPORAY VARIABLES */                                                                                                                                                                                                                                                                                                                        v_tmp_from_nod_cd       VARCHAR2(7)  := '';                                                                                                                                                                                                                                                                                                     v_tmp_via_nod_cd        VARCHAR2(7)  := '';                                                                                                                                                                                                                                                                                                     v_tmp_door_nod_cd       VARCHAR2(7)  := '';                                                                                                                                                                                                                                                                                                     v_tmp_to_nod_cd         VARCHAR2(7)  := '';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     v_tmp_1st_nod_cd        VARCHAR2(7)  := '';                                                                                                                                                                                                                                                                                                     v_tmp_2nd_nod_cd        VARCHAR2(7)  := '';                                                                                                                                                                                                                                                                                                     v_tmp_3rd_nod_cd        VARCHAR2(7)  := '';                                                                                                                                                                                                                                                                                                     v_tmp_4th_nod_cd        VARCHAR2(7)  := '';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     v_mas_tmp_1st_nod_cd        VARCHAR2(7)  := '  ';                                                                                                                                                                                                                                                                                               v_mas_tmp_2nd_nod_cd        VARCHAR2(7)  := '  ';                                                                                                                                                                                                                                                                                               v_mas_tmp_3rd_nod_cd        VARCHAR2(7)  := '  ';                                                                                                                                                                                                                                                                                               v_mas_tmp_4th_nod_cd        VARCHAR2(7)  := '  ';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               vo_basic_rate_tmp       NUMBER(18,3)    := 0;                                                                                                                                                                                                                                                                                                   vo_scg_rate_tmp         NUMBER(18,3)    := 0;                                                                                                                                                                                                                                                                                                   vo_fuel_scg_rate_tmp    NUMBER(18,3)    := 0;                                                                                                                                                                                                                                                                                                   vo_ovw_scg_rate_tmp    NUMBER(18,3)    := 0;                                                                                                                                                                                                                                                                                                    vo_hzm_scg_rate_tmp    NUMBER(18,3)    := 0;                                                                                                                                                                                                                                                                                                    vo_ttl_scg_rate_tmp    NUMBER(18,3)    := 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    vo_vat_scg_rate_tmp    NUMBER(18,3)    := 0;                                                                                                                                                                                                                                                                                                    vo_isg_scg_rate_tmp    NUMBER(18,3)    := 0;                                                                                                                                                                                                                                                                                                    vo_scg2_rate_tmp       NUMBER(18,3)    := 0;                                                                                                                                                                                                                                                                                                    vo_agmt_return_msg       VARCHAR2(1000)  := '';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 vo_local_curr_tot_amt  NUMBER(18,3)    := 0;                                                                                                                                                                                                                                                                                                    vo_usd_curr_tot_amt    NUMBER(18,3)    := 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    v_vndr_seq              NUMBER(6)       := 0;                                                                                                                                                                                                                                                                                                   v_vndr_eff_flag         VARCHAR2(1)     := '';           /* Y : S/P Effective, N : S/P Non-Effective */                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         vo_scg_cd               VARCHAR2(5)     := '';                                                                                                                                                                                                                                                                                                  vo_trsp_agmt_rt_tp_nm   VARCHAR2(50);                                                                                                                                                                                                                                                                                                           vo_sp_type              VARCHAR2(10);                                                                                                                                                                                                                                                                                                           debug_flg               VARCHAR2(3); /* Y : 전체 Log 출력, T : MAS 프로시져Log만 출력, 숫자(1~999) : 해당 COST의 Log만 출력, N : Log 출력 없음 */                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               v_cost_act_grp_cd       VARCHAR2(4);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            v_bfr_trsp_mod_cd       VARCHAR2(2);                                                                                                                                                                                                                                                                                                            v_aft_trsp_mod_cd       VARCHAR2(2);                                                                                                                                                                                                                                                                                                            v_bil_patt_cd           VARCHAR2(3);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            /* TRS AGREEMENT SEARCH DEFAULT KEY FROM FINDING OUT BASIC RATE CALCULATION */                                                                                                                                                                                                                                                                  vo_trsp_agmt_ofc_cty_cd      TRS_AGMT_EQ_RT.TRSP_AGMT_OFC_CTY_CD%TYPE    ;                                                                                                                                                                                                                                                                      vo_trsp_agmt_seq             TRS_AGMT_EQ_RT.TRSP_AGMT_SEQ%TYPE           ;                                                                                                                                                                                                                                                                      vo_trsp_agmt_rt_tp_seq_no    TRS_AGMT_EQ_RT.TRSP_AGMT_RT_TP_SER_NO%TYPE  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      vo_trsp_scg_cd              TRS_AGMT_SCG_NOD.TRSP_SCG_CD%TYPE             ;                                                                                                                                                                                                                                                                     vo_trsp_agmt_scg_seq        TRS_AGMT_SCG_NOD.TRSP_AGMT_SCG_NOD_SEQ%TYPE       ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 vo_scg_union_exp            VARCHAR2(50)                                      ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 vo_vndr_seq                  TRS_AGMT_APLY_VNDR.VNDR_SEQ%TYPE            ;                                                                                                                                                                                                                                                                      vo_cust_nomi_trkr_flg        TRS_AGMT_RT_TP.CUST_NOMI_TRKR_FLG%TYPE      ;                                                                                                                                                                                                                                                                      vo_cust_cnt_cd               TRS_AGMT_RT_TP.CUST_CNT_CD%TYPE             ;                                                                                                                                                                                                                                                                      vo_cust_seq                  TRS_AGMT_RT_TP.CUST_SEQ%TYPE                ;                                                                                                                                                                                                                                                                      vo_trsp_agmt_rt_tp_cd        TRS_AGMT_RT_TP.TRSP_AGMT_RT_TP_CD%TYPE      ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      vo_process_rslt_msg          VARCHAR2(1000)                                   ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 v_tmp_outer_loop_cnt         NUMBER   := 0                                    ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 v_rtn_cd                     NUMBER   := 0                                    ;                                                                                                                                                                                                                                                                 v_trsp_agmt_ofc_cty_cd       TRS_AGMT_RT_TP.TRSP_AGMT_OFC_CTY_CD%TYPE  ;                                                                                                                                                                                                                                                                        v_trsp_agmt_seq              TRS_AGMT_RT_TP.TRSP_AGMT_SEQ%TYPE         ;                                                                                                                                                                                                                                                                        v_spcl_cgo_cntr_tp_cd        VARCHAR2(5)  := '';                                                                                                                                                                                                                                                                                                v_hjs_vndr_seq               VARCHAR2(10) := '';                                                                                                                                                                                                                                                                                                v_hjs_vndr_curr              VARCHAR2(3)  := '';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                v_trsp_agmt_old_flg          VARCHAR2(1)  := '';                                                                                                                                                                                                                                                                                                v_agmt_emy_pkup_rtn_yd_cd    VARCHAR2(7)  := '';                                                                                                                                                                                                                                                                                                v_agmt_wgt                   VARCHAR2(10)  := '';                                                                                                                                                                                                                                                                                               v_aoc_flag                   VARCHAR2(1)   := CASE WHEN SUBSTR(pi_start_pctl_no, 1,1) IN ('H', 'F') THEN 'Y' ELSE 'N' END;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      CURSOR TRS_AGMT_RATE_CSR IS                                                                                                                                                                                                                                                                                                                     SELECT * FROM (                                                                                                                                                                                                                                                                                                                                     SELECT      Y.COST_ACT_GRP_CD                                                                  /* ACTIVITY GROUP CODE */                                                                                                                                                                                                                                  , DECODE(SUBSTR(Y.COST_ACT_GRP_CD,1,1),'I','I','O','O','') BOUND_CD                  /* BOUND CD I/O/T */                                                                                                                                                                                                                                       , CASE WHEN Y.COST_ACT_GRP_CD = 'TRWD' OR SUBSTR(Y.COST_ACT_GRP_CD,1,1) = 'P' THEN 'CY'   /* TS -->> PR(E)+PO(ST) 구분됨. */                                                                                                                                                                                                                           ELSE                                                                                                                                                                                                                                                                                                                                                 CASE SUBSTR(Y.COST_ACT_GRP_CD,2,1) WHEN 'D' THEN 'DR'                                                                                                                                                                                                                                                                                                                         WHEN 'Y' THEN 'CY'                                                                                                                                                                                                                                                                                                                              ELSE ''                                                                                                                                                                                                                                                                                                           END                                                                                                                                                                                                                                                                                                                                   END COST_MODE_CD                                   /* COST MODE CODE D/Y  */                                                                                                                                                                                                                                                                  , SUBSTR(Y.COST_ACT_GRP_CD,3,2) TRSP_CRR_MOD_CD           /* TRANSPORTATION MODE CODE */                                                                                                                                                                                                                                                        , Y.N1ST_VNDR_SEQ FST_VNDR_SEQ                       /* SERVICE PROVIDER    */                                                                                                                                                                                                                                                                  , Y.N2ND_VNDR_SEQ SND_VNDR_SEQ                                                                                                                                                                                                                                                                                                                  , Y.N3RD_VNDR_SEQ TRD_VNDR_SEQ                                                                                                                                                                                                                                                                                                                  , Y.CTRL_OFC_CD                                      /* CONTROL OFFICE CODE */                                                                                                                                                                                                                                                                  , (CASE WHEN v_aoc_flag='Y' OR Y.N1ST_ESTM_DT IS NULL THEN SYSDATE                                                                                                                                                                                                                                                                                      ELSE Y.N1ST_ESTM_DT                                                                                                                                                                                                                                                                                                                             END ) BASIS_DT               /* APPLY BASIS TIME    */                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    /* ROUTE - FROM NODE             */                                                                                                                                                                                                                                                                                                           , Y.N1ST_NOD_CD FROM_NOD_CD                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       /* ROUTE - VIA NODE             */                                                                                                                                                                                                                                                                                                            , CASE LENGTH(Y.N4TH_NOD_CD) WHEN 7 THEN                                                                                                                                                                                                                                                                                                                                            CASE SUBSTR(Y.COST_ACT_GRP_CD,1,1) WHEN 'I' THEN Y.N2ND_NOD_CD                                                                                                                                                                                                                                                                                                                WHEN 'O' THEN Y.N3RD_NOD_CD                                                                                                                                                                                                                                                                                                                     ELSE ''                                                                                                                                                                                                                                                                                                           END                                                                                                                                                                                                                                                                                                                                      ELSE                                                                                                                                                                                                                                                                                                                                                  CASE SUBSTR(Y.COST_ACT_GRP_CD,2,1)  WHEN 'D' THEN ''                                                                                                                                                                                                                                                                                                                           ELSE                                                                                                                                                                                                                                                                                                                                                     CASE LENGTH(Y.N3RD_NOD_CD) WHEN 7 THEN Y.N2ND_NOD_CD                                                                                                                                                                                                                                                                                                                              ELSE ''                                                                                                                                                                                                                                                                                                       END                                                                                                                                                                                                                                                                                                     END                                                                                                                                                                                                                                                                                                            END VIA_NOD_CD                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  /* ROUTE - DOOR NODE             */                                                                                                                                                                                                                                                                                                           , CASE LENGTH(Y.N4TH_NOD_CD) WHEN 7 THEN                                                                                                                                                                                                                                                                                                                                            CASE SUBSTR(Y.COST_ACT_GRP_CD,1,1) WHEN 'I' THEN Y.N3RD_NOD_CD                                                                                                                                                                                                                                                                                                                WHEN 'O' THEN Y.N2ND_NOD_CD                                                                                                                                                                                                                                                                                                                     ELSE ''                                                                                                                                                                                                                                                                                                           END                                                                                                                                                                                                                                                                                                                                      ELSE                                                                                                                                                                                                                                                                                                                                                  CASE SUBSTR(Y.COST_ACT_GRP_CD,2,1)  WHEN 'D' THEN Y.N2ND_NOD_CD                                                                                                                                                                                                                                                                                                                ELSE ''                                                                                                                                                                                                                                                                                                          END                                                                                                                                                                                                                                                                                                            END DOOR_NOD_CD                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 /* ROUTE - TO NODE             */                                                                                                                                                                                                                                                                                                             , CASE LENGTH(Y.N4TH_NOD_CD) WHEN 7 THEN Y.N4TH_NOD_CD                                                                                                                                                                                                                                                                                                                       ELSE                                                                                                                                                                                                                                                                                                                                                   CASE LENGTH(Y.N3RD_NOD_CD) WHEN 7 THEN Y.N3RD_NOD_CD                                                                                                                                                                                                                                                                                                                       ELSE Y.N2ND_NOD_CD    END                                                                                                                                                                                                                                                          END TO_NOD_CD                                                                                                                                                                                                                                                                                                                                 , Y.CUST_NOMI_TRKR_FLG                                                                                                                                                                                                                                                                                                                          , CASE WHEN Y.CUST_NOMI_TRKR_FLG = 'Y' THEN                                                                                                                                                                                                                                                                                                                 CASE SUBSTR(Y.COST_ACT_GRP_CD,1,1) WHEN 'I' THEN X.CNEE_CNT_CD                                                                                                                                                                                                                                                                                                                WHEN 'O' THEN X.SHPR_CNT_CD                                                                                                                                                                                                                                                                                                                     ELSE ''                                                                                                                                                                                                                                                                                                           END                                                                                                                                                                                                                                                                                                                                        ELSE ''                                                                                                                                                                                                                                                                                                                                    END CUST_CNT_CD                                    /* CNT CUSTOMER CNT CODE */                                                                                                                                                                                                                                                                , CASE WHEN Y.CUST_NOMI_TRKR_FLG = 'Y' THEN                                                                                                                                                                                                                                                                                                                 CASE SUBSTR(Y.COST_ACT_GRP_CD,1,1) WHEN 'I' THEN X.CNEE_SEQ                                                                                                                                                                                                                                                                                                                   WHEN 'O' THEN X.SHPR_SEQ                                                                                                                                                                                                                                                                                                                        ELSE 0                                                                                                                                                                                                                                                                                                            END                                                                                                                                                                                                                                                                                                                                        ELSE 0                                                                                                                                                                                                                                                                                                                                     END CUST_SEQ                                       /* CNT CUSTOMER SEQ      */                                                                                                                                                                                                                                                                , X.CMDT_CD                                          /* COMMODITY CODE        */                                                                                                                                                                                                                                                                , Y.CNTR_TPSZ_CD                                     /* EQ TYPE SIZE CODE     *//* PRIMARY KEY COLUMN #3 */                                                                                                                                                                                                                                     , 'F'   CGO_TP_CD                                                                                                                                                                                                                                                                                                                               , (CASE WHEN v_aoc_flag='Y' THEN 'K' ELSE X.BKG_WGT_UT_CD END) AS BKG_WGT_UT_CD                                                                                                                                                                                                                                             $IF PRI_PRS_CC_CTRL_PKG.CC_CTRL_FLG = 1 $THEN                                              , (CASE WHEN v_aoc_flag='Y' THEN                           NVL((SELECT (CASE WHEN Y.CNTR_TPSZ_CD IN ('D2', 'R2') THEN A.CNTR_20FT_CRTE_WGT                                            WHEN Y.CNTR_TPSZ_CD IN ('D4', 'R4') THEN A.CNTR_40FT_CRTE_WGT                                            WHEN Y.CNTR_TPSZ_CD IN ('D7', 'R7') THEN A.CNTR_45FT_CRTE_WGT                                            ELSE 0                                       END)                                  FROM AOC_TRF_BAT A                                WHERE A.COST_TRF_BAT_SEQ = pi_aoc_bat_seq),0)                       ELSE                           NVL((SELECT B.CNTR_WGT                               FROM   SCE_COP_HDR   A                                     ,BKG_CONTAINER B                                WHERE  A.BKG_NO  = B.BKG_NO                               AND    A.CNTR_NO = B.CNTR_NO                               AND    A.COP_NO  = X.PCTL_NO),0)                       END) AS BKG_WGT $ELSE                    , NVL((SELECT B.CNTR_WGT                           FROM   SCE_COP_HDR   A                                 ,BKG_CONTAINER B                           WHERE  A.BKG_NO  = B.BKG_NO                           AND    A.CNTR_NO = B.CNTR_NO                           AND    A.COP_NO  = X.PCTL_NO),0) AS BKG_WGT$END                                                                                                                                                                                                                                                                                                                                , CASE SUBSTR(Y.COST_ACT_GRP_CD,3,2) WHEN 'RD' THEN SUBSTR(Y.RAIL_SVC_TP_CD,1,1)||SUBSTR(Y.RAIL_SVC_TP_CD,3,1)                                                                                                                                                                                                                                                                  ELSE ''                                                                                                                                                                                                                                                                                                           END RAIL_SVC_TP_CD                                 /* RAIL SERVICE TYPE CODE CO/CR/TO/TR - CRR MODE = 'RD' 일때만 존재. */                                                                                                                                                                                                                    , SUBSTR(Y.N1ST_RAIL_CRR_TP_CD,1,2)   N1ST_RAIL_CRR_TP_CD                                                                                                                                                                                                                                                                                       , SUBSTR(Y.N2ND_RAIL_CRR_TP_CD,1,2)   N2ND_RAIL_CRR_TP_CD                                                                                                                                                                                                                                                                                       , SUBSTR(Y.N3RD_RAIL_CRR_TP_CD,1,2)   N3RD_RAIL_CRR_TP_CD                                                                                                                                                                                                                                                                                       , Y.PCTL_NO                                          /* PRIMARY KEY COLUMN #1 */                                                                                                                                                                                                                                                                , Y.COST_ACT_GRP_SEQ                                 /* PRIMARY KEY COLUMN #2 */                                                                                                                                                                                                                                                                , Y.MAS_COST_SRC_CD                                  /* PRIMARY KEY COLUMN #4 *//* MAS COST CODE : TR-basic/SC-surcharge */                                                                                                                                                                                                                     , CASE WHEN Z.INLND_ROUT_INV_BIL_PATT_CD = 'C2T' OR Z.INLND_ROUT_INV_BIL_PATT_CD = 'C3T' THEN 1  /* C2T, C3T는 Loop를 돌지 않는다. */                                                                                                                                                                                                                  ELSE DECODE(LENGTH(Y.N4TH_NOD_CD),7,3,DECODE(LENGTH(Y.N3RD_NOD_CD),7,2,1))                                                                                                                                                                                                                                                                 END LINK_CNT                                                                                                                                                                                                                                                                                                                                  , CASE SUBSTR(Y.MAS_COST_SRC_CD,1,2) WHEN 'TR' THEN                                                                                                                                                                                                                                                                                                                                            CASE Y.MAS_COST_SRC_CD WHEN 'TRFXRD' THEN 'ISG'                                                                                                                                                                                                                                                                                                      ELSE 'BZC'                                                                                                                                                                                                                                                                                                                                 END                                                                                                                                                                                                                                                                                                                                   WHEN 'SC' THEN                                                                                                                                                                                                                                                                                                                                            CASE SUBSTR(Y.MAS_COST_SRC_CD,3,2) WHEN 'FU' THEN 'FU'                                                                                                                                                                                                                                                                                                                             WHEN 'OW' THEN 'OW'                                                                                                                                                                                                                                                                                                                             ELSE CASE Y.MAS_COST_SRC_CD WHEN 'SCHLCF' THEN 'SCHLCF'                                                                                                                                                                                                                                                                                                                     WHEN 'SCHLOP' THEN 'SCHLOP'                                                                                                                                                                                                                                                                                                                     WHEN 'SCTLAL' THEN 'TF'                                                                                                                                                                                                                                                                                                  ELSE ''                                                                                                                                                                                                                                                                                                                                         END                                                                                                                                                                                                                                                                                                     END                                                                                                                                                                                                                                                                                                                                   WHEN 'SM' THEN                                                                                                                                                                                                                                                                                                                                            CASE SUBSTR(Y.MAS_COST_SRC_CD,3,2) WHEN 'FU' THEN 'FU'                                                                                                                                                                                                                                                                                                                             WHEN 'OW' THEN 'OW'                                                                                                                                                                                                                                                                                                                             ELSE CASE Y.MAS_COST_SRC_CD WHEN 'SMTLAL' THEN 'TF'                                                                                                                                                                                                                                                                                                  ELSE ''                                                                                                                                                                                                                                                                                                                                         END                                                                                                                                                                                                                                                                                                     END                                                                                                                                                                                                                                                                                                                                   ELSE ''                                                                                                                                                                                                                                                                                                      END TRS_AGMT_RT_KND                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           , Y.N1ST_NOD_CD                                                                                                                                                                                                                                                                                                                                 , Y.N2ND_NOD_CD                                                                                                                                                                                                                                                                                                                                 , Y.N3RD_NOD_CD                                                                                                                                                                                                                                                                                                                                 , Y.N4TH_NOD_CD                                                                                                                                                                                                                                                                                                                                 , Y.N1ST_TRSP_AGMT_OFC_CTY_CD                          AGMT_OFC_CTY_1ST_CD                                                                                                                                                                                                                                                                      , Y.N1ST_TRSP_AGMT_SEQ                                 AGMT_1ST_SEQ                                                                                                                                                                                                                                                                             , Y.N2ND_TRSP_AGMT_OFC_CTY_CD                          AGMT_OFC_CTY_2ND_CD                                                                                                                                                                                                                                                                      , Y.N2ND_TRSP_AGMT_SEQ                                 AGMT_2ND_SEQ                                                                                                                                                                                                                                                                             , Y.N3RD_TRSP_AGMT_OFC_CTY_CD                          AGMT_OFC_CTY_3RD_CD                                                                                                                                                                                                                                                                      , Y.N3RD_TRSP_AGMT_SEQ                                 AGMT_3RD_SEQ                                                                                                                                                                                                                                                                             , CASE WHEN SUBSTR(Y.CNTR_TPSZ_CD,0,1)='R' AND X.SOC_FLG='Y' AND X.RF_SPCL_FLG='N' THEN 'RD'                                                                                                                                                                                                                                                           WHEN SUBSTR(Y.CNTR_TPSZ_CD,0,1)='R' AND X.RD_SPCL_FLG='Y' THEN 'RD'                                                                                                                                                                                                                                                                             WHEN X.DG_SPCL_FLG = 'Y' THEN 'DG'                                                                                                                                                                                                                                                                                                              WHEN V.RAIL_BLK_CD = 'G' THEN 'G'                                                                                                                                                                                                                                                                                                          END SPCL_CGO_CNTR_TP_CD                                                                                                                                                                                                                                                                                                                       , Y.BFR_TRSP_MOD_CD                                                                                                                                                                                                                                                                                                                             , Y.AFT_TRSP_MOD_CD                                                                                                                                                                                                                                                                                                                             , Z.INLND_ROUT_INV_BIL_PATT_CD                                                                                                                                                                                                                                                                                                        FROM        MAS_COM_PARA                           X                                                                                                                                                                                                                                                                                                      , MAS_COM_COST_PARA                      Y                                                                                                                                                                                                                                                                                                      , PRD_PROD_CTL_ACT_GRP_DTL               Z                                                                                                                                                                                                                                                                                                      , BKG_BOOKING                            V                                                                                                                                                                                                                                                                                            WHERE       X.PCTL_NO                              = Y.PCTL_NO                                                                                                                                                                                                                                                                                  AND         DECODE(SUBSTR(X.PCTL_NO, 1,1), 'H', X.PCTL_NO                                                                                                                                                                                                                                                                                                                                , 'F', X.PCTL_NO                                                                                                                                                                                                                                                                                                                                , 'T', X.PCTL_NO                                                                                                                                                                                                                                                                                                                                ,DECODE(LENGTH(X.COST_ROUT_NO),1,X.PCTL_NO,X.ORG_PCTL_NO))  = Z.PCTL_NO                                                                                                                                                                                                                                AND         Y.COST_ACT_GRP_SEQ                     = Z.COST_ACT_GRP_SEQ                                                                                                                                                                                                                                                                         AND         Y.COST_SRC_SYS_CD                      = 'TRS'                                                                                                                                                                                                                                                                                      AND         Y.COST_ASS_BSE_CD                      = 'C'                                                                                                                                                                                                                                                                                        AND         NVL(X.BKG_NO      , 'N/A')             = NVL(pi_bkg_no      , 'N/A')                                                                                                                                                                                                                                                                AND         X.PCTL_NO BETWEEN pi_start_pctl_no AND pi_end_pctl_no                                                                                                                                                                                                                                                                               AND         X.BKG_NO  = V.BKG_NO(+)                                                                                                                                                                                                                                                                                                         )                                                                                                                                                                                                                                                                                                                                               WHERE TRS_AGMT_RT_KND IS NOT NULL                                                                                                                                                                                                                                                                                                                   ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       BEGIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           /*===================================================================================                                                                                                                                                                                                                                                           * BILLING PATTERN CODE (COMBINED THROUGH TYPE CODE)                                                                                                                                                                                                                                                                                             * ----------- [W/O ISSUED TO] ---- [INVOICE RECEIVED FROM] --- [Invoice S/P Count]                                                                                                                                                                                                                                                              * S1R     :   A                    A                                    1                                                                                                                                                                                                                                                                       * C2T     :   A                    A                                    1                                                                                                                                                                                                                                                                       * C3T     :   A                    A                                    1                                                                                                                                                                                                                                                                       * C2R     :   A                    A,B                                  2                                                                                                                                                                                                                                                                       * C3R     :   A                    A,B,C                                3                                                                                                                                                                                                                                                                       * S2R     :   A,B                  A,B                                  2                                                                                                                                                                                                                                                                       * S3R     :   A,B,C                A,B,C                                3                                                                                                                                                                                                                                                                       * C2C     :   A                    B(+A)                                1                                                                                                                                                                                                                                                                       * C3S     :   A                    B(+A),C                              2                                                                                                                                                                                                                                                                       -------------------------------------------------------------------------------------                                                                                                                                                                                                                                                           * TRUCK   :   1                                                                                                                                                                                                                                                                                                                                 *====================================================================================*/                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             /** 초기값 설정 **/                                                                                                                                                                                                                                                                                                                             debug_flg := pi_debug_flg;                                                                                                                                                                                                                                                                                                                      IF debug_flg NOT IN ('Y', 'T') AND (ASCII(debug_flg) < 49 OR ASCII(debug_flg) > 57)  THEN                                                                                                                                                                                                                                                         debug_flg := 'N';                                                                                                                                                                                                                                                                                                                             END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         /* LOG */                                                                                                                                                                                                                                                                                                                                       IF debug_flg IN ('Y', 'T') OR (ASCII(debug_flg) BETWEEN 49 AND 57)  THEN                                                                                                                                                                                                                                                                          DBMS_OUTPUT.PUT_LINE('[TRS_AGMT_APPLY_TO_MAS] : Started (Input Parameter - ' || pi_start_pctl_no || ', ' || pi_end_pctl_no || '), ****************' || to_char(sysdate,'yyyy/mm/dd hh24:mi:ss'));                                                                                                                                             END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         FOR AGMT_RATE_LIST IN TRS_AGMT_RATE_CSR LOOP                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        v_tmp_outer_loop_cnt := v_tmp_outer_loop_cnt + 1;                                                                                                                                                                                                                                                                                               IF debug_flg IN ('Y', 'T') OR (ASCII(v_tmp_outer_loop_cnt) = ASCII(debug_flg)) THEN                                                                                                                                                                                                                                                                 DBMS_OUTPUT.PUT_LINE('■■■■■■■■■■■■■ ['||v_tmp_outer_loop_cnt||'] ■■■■■■■■■■■■■');                                                                                                                                                                                                                                 END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         v_ctrl_ofc_cd       := AGMT_RATE_LIST.CTRL_OFC_CD        ;                                                                                                                                                                                                                                                                                      v_fst_vndr_seq      := AGMT_RATE_LIST.FST_VNDR_SEQ       ;                                                                                                                                                                                                                                                                                      v_snd_vndr_seq      := AGMT_RATE_LIST.SND_VNDR_SEQ       ;                                                                                                                                                                                                                                                                                      v_trd_vndr_seq      := AGMT_RATE_LIST.TRD_VNDR_SEQ       ;                                                                                                                                                                                                                                                                                      v_basis_dt          := AGMT_RATE_LIST.BASIS_DT           ;                                                                                                                                                                                                                                                                                      v_crr_mod_cd        := AGMT_RATE_LIST.TRSP_CRR_MOD_CD    ;                                                                                                                                                                                                                                                                                      v_cost_mod_cd       := AGMT_RATE_LIST.COST_MODE_CD       ;                                                                                                                                                                                                                                                                                      v_bound_cd          := AGMT_RATE_LIST.BOUND_CD           ;                                                                                                                                                                                                                                                                                      v_cntr_tpsz_cd      := AGMT_RATE_LIST.CNTR_TPSZ_CD       ;                                                                                                                                                                                                                                                                                      v_cgo_tp_cd         := AGMT_RATE_LIST.CGO_TP_CD          ;                                                                                                                                                                                                                                                                                      v_from_nod_cd       := AGMT_RATE_LIST.FROM_NOD_CD        ;                                                                                                                                                                                                                                                                                      v_via_nod_cd        := AGMT_RATE_LIST.VIA_NOD_CD         ;                                                                                                                                                                                                                                                                                      v_door_nod_cd       := AGMT_RATE_LIST.DOOR_NOD_CD        ;                                                                                                                                                                                                                                                                                      v_to_nod_cd         := AGMT_RATE_LIST.TO_NOD_CD          ;                                                                                                                                                                                                                                                                                      v_cust_nomi_trkr_flg:= AGMT_RATE_LIST.CUST_NOMI_TRKR_FLG ;                                                                                                                                                                                                                                                                                      v_cust_cnt_cd       := AGMT_RATE_LIST.CUST_CNT_CD        ;                                                                                                                                                                                                                                                                                      v_cust_seq          := AGMT_RATE_LIST.CUST_SEQ           ;                                                                                                                                                                                                                                                                                      v_1st_rail_crr_tp_cd:= AGMT_RATE_LIST.N1ST_RAIL_CRR_TP_CD;     /* CHO, CHR, THO, THR     */                                                                                                                                                                                                                                                     v_2nd_rail_crr_tp_cd:= AGMT_RATE_LIST.N2ND_RAIL_CRR_TP_CD;     /* CHO, CHR, THO, THR     */                                                                                                                                                                                                                                                     v_3rd_rail_crr_tp_cd:= AGMT_RATE_LIST.N3RD_RAIL_CRR_TP_CD;     /* CHO, CHR, THO, THR     */                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     v_cmdt_cd           := AGMT_RATE_LIST.CMDT_CD            ;                                                                                                                                                                                                                                                                                      v_wgt_uom           := AGMT_RATE_LIST.BKG_WGT_UT_CD      ;                                                                                                                                                                                                                                                                                      v_wgt_qty           := AGMT_RATE_LIST.BKG_WGT            ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      v_pctl_no           := AGMT_RATE_LIST.PCTL_NO            ;                                                                                                                                                                                                                                                                                      v_cost_act_grp_seq  := AGMT_RATE_LIST.COST_ACT_GRP_SEQ   ;                                                                                                                                                                                                                                                                                      v_mas_cost_src_cd   := AGMT_RATE_LIST.MAS_COST_SRC_CD    ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      link_cnt            := AGMT_RATE_LIST.LINK_CNT           ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      v_trs_agmt_rt_knd   := AGMT_RATE_LIST.TRS_AGMT_RT_KND    ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      /* US IRG 변경에 따른 추가 : 2007/04/24      */                                                                                                                                                                                                                                                                                                 v_1st_trsp_agmt_ofc_cty_cd     := AGMT_RATE_LIST.AGMT_OFC_CTY_1ST_CD      ;                                                                                                                                                                                                                                                                     v_1st_trsp_agmt_seq            := AGMT_RATE_LIST.AGMT_1ST_SEQ             ;                                                                                                                                                                                                                                                                     v_2nd_trsp_agmt_ofc_cty_cd     := AGMT_RATE_LIST.AGMT_OFC_CTY_2ND_CD      ;                                                                                                                                                                                                                                                                     v_2nd_trsp_agmt_seq            := AGMT_RATE_LIST.AGMT_2ND_SEQ             ;                                                                                                                                                                                                                                                                     v_3rd_trsp_agmt_ofc_cty_cd     := AGMT_RATE_LIST.AGMT_OFC_CTY_3RD_CD      ;                                                                                                                                                                                                                                                                     v_3rd_trsp_agmt_seq            := AGMT_RATE_LIST.AGMT_3RD_SEQ             ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     v_tmp_1st_nod_cd               := AGMT_RATE_LIST.N1ST_NOD_CD              ;                                                                                                                                                                                                                                                                     v_tmp_2nd_nod_cd               := AGMT_RATE_LIST.N2ND_NOD_CD              ;                                                                                                                                                                                                                                                                     v_tmp_3rd_nod_cd               := AGMT_RATE_LIST.N3RD_NOD_CD              ;                                                                                                                                                                                                                                                                     v_tmp_4th_nod_cd               := AGMT_RATE_LIST.N4TH_NOD_CD              ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     v_cost_act_grp_cd              := AGMT_RATE_LIST.COST_ACT_GRP_CD          ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     v_bfr_trsp_mod_cd              := AGMT_RATE_LIST.BFR_TRSP_MOD_CD          ;                                                                                                                                                                                                                                                                     v_aft_trsp_mod_cd              := AGMT_RATE_LIST.AFT_TRSP_MOD_CD          ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     IF LENGTH(v_tmp_1st_nod_cd) > 0 THEN                                                                                                                                                                                                                                                                                                              v_mas_tmp_1st_nod_cd           := AGMT_RATE_LIST.N1ST_NOD_CD              ;                                                                                                                                                                                                                                                                   END IF;                                                                                                                                                                                                                                                                                                                                         IF LENGTH(v_tmp_2nd_nod_cd) > 0 THEN                                                                                                                                                                                                                                                                                                              v_mas_tmp_2nd_nod_cd           := AGMT_RATE_LIST.N2ND_NOD_CD              ;                                                                                                                                                                                                                                                                   END IF;                                                                                                                                                                                                                                                                                                                                         IF LENGTH(v_tmp_3rd_nod_cd) > 0 THEN                                                                                                                                                                                                                                                                                                              v_mas_tmp_3rd_nod_cd           := AGMT_RATE_LIST.N3RD_NOD_CD              ;                                                                                                                                                                                                                                                                   END IF;                                                                                                                                                                                                                                                                                                                                         IF LENGTH(v_tmp_4th_nod_cd) > 0 THEN                                                                                                                                                                                                                                                                                                              v_mas_tmp_4th_nod_cd           := AGMT_RATE_LIST.N4TH_NOD_CD              ;                                                                                                                                                                                                                                                                   END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         /* US IRG 변경에 따른 추가 : 2007/04/24      */                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 /************************************************************************************************************                                                                                                                                                                                                                                    pi_pair_dist_indicator VARCHAR2   -- P : PAIR, D : DISTANCE                                                                                                                                                                                                                                                                                   , pi_eq_knd_cd           VARCHAR2   -- U : Container, Z : CHassis, G : Genset                                                                                                                                                                                                                                                                   , pi_cgo_tp_cd           VARCHAR2   -- F : Full, M : EMpty                                                                                                                                                                                                                                                                                      , pi_eq_tpsz_cd          VARCHAR2   -- D2, R2, F?, ...                                                                                                                                                                                                                                                                                          , pi_cmb_tp_cd           VARCHAR2   -- BD : Bundle, CF : Combined Case One, FF : Full+Full, FM : Full_Empty                                                                                                                                                                                                                                     , pi_cost_mod_cd         VARCHAR2   -- DR : Door                                                                                                                                                                                                                                                                                                 **************************************************************************************************************/                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 v_tmp_from_nod_cd       := AGMT_RATE_LIST.FROM_NOD_CD     ;                                                                                                                                                                                                                                                                                     v_tmp_via_nod_cd        := AGMT_RATE_LIST.VIA_NOD_CD      ;                                                                                                                                                                                                                                                                                     v_tmp_door_nod_cd       := AGMT_RATE_LIST.DOOR_NOD_CD     ;                                                                                                                                                                                                                                                                                     v_tmp_to_nod_cd         := AGMT_RATE_LIST.TO_NOD_CD       ;                                                                                                                                                                                                                                                                                     v_spcl_cgo_cntr_tp_cd   := AGMT_RATE_LIST.SPCL_CGO_CNTR_TP_CD;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  /* RAIL Billing Pattern Code별 분리에 따른 추가 : 2011/11.24      */                                                                                                                                                                                                                                                                            v_bil_patt_cd                  := AGMT_RATE_LIST.INLND_ROUT_INV_BIL_PATT_CD ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   SELECT COUNT(LOC_GRP_TP_CD)                                                                                                                                                                                                                                                                                                                     INTO   vo_rt_cal_rtn_cd                                                                                                                                                                                                                                                                                                                         FROM   (                                                                                                                                                                                                                                                                                                                                                SELECT LOC_GRP_TP_CD  -- MAS에서 해당구간에 AGMT 적용 예외 등록 체크 (Yard 단위)                                                                                                                                                                                                                                                                  FROM MAS_AGMT_RSTR_MGMT                                                                                                                                                                                                                                                                                                                        WHERE LOC_GRP_TP_CD = 'Y'                                                                                                                                                                                                                                                                                                                         AND MAS_COST_SRC_CD = v_mas_cost_src_cd                                                                                                                                                                                                                                                                                                         AND N1ST_NOD_CD = v_mas_tmp_1st_nod_cd                                                                                                                                                                                                                                                                                                          AND N2ND_NOD_CD = v_mas_tmp_2nd_nod_cd                                                                                                                                                                                                                                                                                                          AND N3RD_NOD_CD = v_mas_tmp_3rd_nod_cd                                                                                                                                                                                                                                                                                                          AND N4TH_NOD_CD = v_mas_tmp_4th_nod_cd                                                                                                                                                                                                                                                                                                          AND COST_SRC_USE_FLG = 'Y'                                                                                                                                                                                                                                                                                                                      AND LOC_DELT_FLG = 'N'                                                                                                                                                                                                                                                                                                                       UNION ALL                                                                                                                                                                                                                                                                                                                                       SELECT LOC_GRP_TP_CD -- MAS에서 해당구간에 AGMT 적용 예외 등록 체크 (Location 단위)                                                                                                                                                                                                                                                               FROM MAS_AGMT_RSTR_MGMT                                                                                                                                                                                                                                                                                                                        WHERE LOC_GRP_TP_CD = 'L'                                                                                                                                                                                                                                                                                                                         AND MAS_COST_SRC_CD = v_mas_cost_src_cd                                                                                                                                                                                                                                                                                                         AND N1ST_NOD_CD LIKE SUBSTR(v_mas_tmp_1st_nod_cd,1,5)                                                                                                                                                                                                                                                                                           AND N2ND_NOD_CD LIKE SUBSTR(v_mas_tmp_2nd_nod_cd,1,5)                                                                                                                                                                                                                                                                                           AND N3RD_NOD_CD LIKE SUBSTR(v_mas_tmp_3rd_nod_cd,1,5)                                                                                                                                                                                                                                                                                           AND N4TH_NOD_CD LIKE SUBSTR(v_mas_tmp_4th_nod_cd,1,5)                                                                                                                                                                                                                                                                                           AND COST_SRC_USE_FLG = 'Y'                                                                                                                                                                                                                                                                                                                      AND LOC_DELT_FLG = 'N'                                                                                                                                                                                                                                                                                                                       UNION ALL                                                                                                                                                                                                                                                                                                                                       SELECT LOC_GRP_TP_CD -- MAS에서 해당구간에 AGMT 적용 예외 등록 체크 (Country 단위)                                                                                                                                                                                                                                                                FROM MAS_AGMT_RSTR_MGMT                                                                                                                                                                                                                                                                                                                        WHERE LOC_GRP_TP_CD = 'C'                                                                                                                                                                                                                                                                                                                         AND MAS_COST_SRC_CD = v_mas_cost_src_cd                                                                                                                                                                                                                                                                                                         AND N1ST_NOD_CD LIKE SUBSTR(v_mas_tmp_1st_nod_cd,1,2)                                                                                                                                                                                                                                                                                           AND N2ND_NOD_CD LIKE SUBSTR(v_mas_tmp_2nd_nod_cd,1,2)                                                                                                                                                                                                                                                                                           AND N3RD_NOD_CD LIKE SUBSTR(v_mas_tmp_3rd_nod_cd,1,2)                                                                                                                                                                                                                                                                                           AND N4TH_NOD_CD LIKE SUBSTR(v_mas_tmp_4th_nod_cd,1,2)                                                                                                                                                                                                                                                                                           AND COST_SRC_USE_FLG = 'Y'                                                                                                                                                                                                                                                                                                                      AND LOC_DELT_FLG = 'N'                                                                                                                                                                                                                                                                                                                      )                                                                                                                                                                                                                                                                                                                                        ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               /* FINAL TOTAL RATE INITIALIZE */                                                                                                                                                                                                                                                                                                               vo_final_rt := 0;                                                                                                                                                                                                                                                                                                                               IF (debug_flg IN ('Y', 'T') OR (ASCII(v_tmp_outer_loop_cnt) = ASCII(debug_flg))) AND v_trs_agmt_rt_knd IS NOT NULL THEN                                                                                                                                                                                                                             IF vo_rt_cal_rtn_cd > 0 THEN                                                                                                                                                                                                                                                                                                                        DBMS_OUTPUT.put_line('▶ MAS AGMT 적용여부(vo_rt_cal_rtn_cd) : ' || vo_rt_cal_rtn_cd || ' (MAS에서 AGMT 적용 예외로 등록)');                                                                                                                                                                                                                END IF;                                                                                                                                                                                                                                                                                                                                         DBMS_OUTPUT.put_line('▶ Trans Mode : ' || v_crr_mod_cd );                                                                                                                                                                                                                                                                                      DBMS_OUTPUT.put_line('▶ Rail Carry Type Code : ' || v_1st_rail_crr_tp_cd );                                                                                                                                                                                                                                                                    DBMS_OUTPUT.put_line('▶ Agreement Rate Type(Basic/Surcharge) : ' || v_trs_agmt_rt_knd );                                                                                                                                                                                                                                                   END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         IF vo_rt_cal_rtn_cd = 0 THEN                                                                                                                                                                                                                                                                                                                        /* US RAIL BILLING : S/P RATE */                                                                                                                                                                                                                                                                                                                IF v_crr_mod_cd = 'RD' AND ( v_1st_rail_crr_tp_cd = CHO OR v_1st_rail_crr_tp_cd = CHR OR v_1st_rail_crr_tp_cd = THO OR v_1st_rail_crr_tp_cd = THR) THEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             v_vndr_eff_flag := 'Y';                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         /* LINK ... FOR LOOP START */                                                                                                                                                                                                                                                                                                                   FOR i IN 1..link_cnt LOOP                                                                                                                                                                                                                                                                                                                           IF i = 1 THEN                                                                                                                                                                                                                                                                                                                                       IF v_bil_patt_cd = 'C2T' THEN                                                                                                                                                                                                                                                                                                                       v_from_nod_cd       := v_tmp_1st_nod_cd  ;                                                                                                                                                                                                                                                                                                      v_via_nod_cd        := ''                ;                                                                                                                                                                                                                                                                                                      v_door_nod_cd       := ''                ;                                                                                                                                                                                                                                                                                                      v_to_nod_cd         := v_tmp_3rd_nod_cd  ;                                                                                                                                                                                                                                                                                                  ELSIF v_bil_patt_cd = 'C3T' THEN                                                                                                                                                                                                                                                                                                                    v_from_nod_cd       := v_tmp_1st_nod_cd  ;                                                                                                                                                                                                                                                                                                      v_via_nod_cd        := ''                ;                                                                                                                                                                                                                                                                                                      v_door_nod_cd       := ''                ;                                                                                                                                                                                                                                                                                                      v_to_nod_cd         := v_tmp_4th_nod_cd  ;                                                                                                                                                                                                                                                                                                  ELSE -- C1T, C2R, C3R                                                                                                                                                                                                                                                                                                                               v_from_nod_cd       := v_tmp_1st_nod_cd  ;                                                                                                                                                                                                                                                                                                      v_via_nod_cd        := ''                ;                                                                                                                                                                                                                                                                                                      v_door_nod_cd       := ''                ;                                                                                                                                                                                                                                                                                                      v_to_nod_cd         := v_tmp_2nd_nod_cd  ;                                                                                                                                                                                                                                                                                                  END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         v_vndr_seq          := v_fst_vndr_seq       ;                                                                                                                                                                                                                                                                                                   v_rail_svc_tp_cd    := v_1st_rail_crr_tp_cd ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   TRS_AGMT_RATE_CC_PKG.GET_USRAIL_CONV_AGMT_NO_PRC(v_vndr_seq                                                                                                                                                                                                                                                                                                                                       , v_cmdt_cd                                                                                                                                                                                                                                                                                                                                     , v_spcl_cgo_cntr_tp_cd                                                                                                                                                                                                                                                                                                                         , v_rtn_cd                                                                                                                                                                                                                                                                                                                                      , v_trsp_agmt_ofc_cty_cd                                                                                                                                                                                                                                                                                                                        , v_trsp_agmt_seq);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           IF v_rtn_cd = 0 THEN                                                                                                                                                                                                                                                                                                                                 v_tmp_trsp_agmt_ofc_cty_cd   := v_trsp_agmt_ofc_cty_cd ;                                                                                                                                                                                                                                                                                        v_tmp_trsp_agmt_seq          := v_trsp_agmt_seq        ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ELSE                                                                                                                                                                                                                                                                                                                                                v_tmp_trsp_agmt_ofc_cty_cd   := v_1st_trsp_agmt_ofc_cty_cd ;                                                                                                                                                                                                                                                                                    v_tmp_trsp_agmt_seq          := v_1st_trsp_agmt_seq        ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ELSIF i = 2 THEN                                                                                                                                                                                                                                                                                                                                    v_from_nod_cd       := v_tmp_2nd_nod_cd  ;                                                                                                                                                                                                                                                                                                      v_via_nod_cd        := ''                ;                                                                                                                                                                                                                                                                                                      v_door_nod_cd       := ''                ;                                                                                                                                                                                                                                                                                                      v_to_nod_cd         := v_tmp_3rd_nod_cd ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       v_vndr_seq          := v_snd_vndr_seq       ;                                                                                                                                                                                                                                                                                                   v_rail_svc_tp_cd    := v_2nd_rail_crr_tp_cd ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   TRS_AGMT_RATE_CC_PKG.GET_USRAIL_CONV_AGMT_NO_PRC(v_vndr_seq                                                                                                                                                                                                                                                                                                                                       , v_cmdt_cd                                                                                                                                                                                                                                                                                                                                     , v_spcl_cgo_cntr_tp_cd                                                                                                                                                                                                                                                                                                                         , v_rtn_cd                                                                                                                                                                                                                                                                                                                                      , v_trsp_agmt_ofc_cty_cd                                                                                                                                                                                                                                                                                                                        , v_trsp_agmt_seq);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           IF v_rtn_cd = 0 THEN                                                                                                                                                                                                                                                                                                                                 v_tmp_trsp_agmt_ofc_cty_cd   := v_trsp_agmt_ofc_cty_cd ;                                                                                                                                                                                                                                                                                        v_tmp_trsp_agmt_seq          := v_trsp_agmt_seq        ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ELSE                                                                                                                                                                                                                                                                                                                                                v_tmp_trsp_agmt_ofc_cty_cd   := v_2nd_trsp_agmt_ofc_cty_cd ;                                                                                                                                                                                                                                                                                    v_tmp_trsp_agmt_seq          := v_2nd_trsp_agmt_seq        ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ELSIF i = 3 THEN                                                                                                                                                                                                                                                                                                                                    v_from_nod_cd       := v_tmp_3rd_nod_cd ;                                                                                                                                                                                                                                                                                                       v_via_nod_cd        := ''               ;                                                                                                                                                                                                                                                                                                       v_door_nod_cd       := ''               ;                                                                                                                                                                                                                                                                                                       v_to_nod_cd         := v_tmp_4th_nod_cd ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       v_vndr_seq          := v_trd_vndr_seq       ;                                                                                                                                                                                                                                                                                                   v_rail_svc_tp_cd    := v_3rd_rail_crr_tp_cd ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   TRS_AGMT_RATE_CC_PKG.GET_USRAIL_CONV_AGMT_NO_PRC(v_vndr_seq                                                                                                                                                                                                                                                                                                                                       , v_cmdt_cd                                                                                                                                                                                                                                                                                                                                     , v_spcl_cgo_cntr_tp_cd                                                                                                                                                                                                                                                                                                                         , v_rtn_cd                                                                                                                                                                                                                                                                                                                                      , v_trsp_agmt_ofc_cty_cd                                                                                                                                                                                                                                                                                                                        , v_trsp_agmt_seq);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           IF v_rtn_cd = 0 THEN                                                                                                                                                                                                                                                                                                                                 v_tmp_trsp_agmt_ofc_cty_cd   := v_trsp_agmt_ofc_cty_cd ;                                                                                                                                                                                                                                                                                        v_tmp_trsp_agmt_seq          := v_trsp_agmt_seq        ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ELSE                                                                                                                                                                                                                                                                                                                                                v_tmp_trsp_agmt_ofc_cty_cd   := v_3rd_trsp_agmt_ofc_cty_cd ;                                                                                                                                                                                                                                                                                    v_tmp_trsp_agmt_seq          := v_3rd_trsp_agmt_seq        ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                END IF;                                                                                                                                                                                                                                                                                                                                    END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         -- empty pickup/return yard까지 모두 체크                                                                                                                                                                                                                                                                                                       TRS_AGMT_RATE_CC_PKG.GET_TRS_ALL_RATE_PRC                                                                                                                                                                                                                                                                                                       (                                                                                                                                                                                                                                                                                                                                                     'COA1'||v_aoc_flag                                                                                                                                                                                                                                                                                                                            , v_ctrl_ofc_cd          /* Pair - X , Distance - Mandatory */                                                                                                                                                                                                                                                                                  , v_vndr_seq                                                                                                                                                                                                                                                                                                                                    , v_basis_dt                                                                                                                                                                                                                                                                                                                                    , MAS_WAY_TP             /* way type code - Only ONEWAY     */                                                                                                                                                                                                                                                                                  , 'U'                    /* EQ TYPE */                                                                                                                                                                                                                                                                                                          --, v_cntr_tpsz_cd   CHM-201539073  MAS에서 RD로 검색할 때 TRS Agreement 요율 매핑 로직 변경                                ,CASE WHEN SUBSTR(v_cntr_tpsz_cd   ,1,1) = 'R' AND  LENGTH(v_cntr_tpsz_cd   ) > 2 THEN REPLACE(v_cntr_tpsz_cd   ,'D','')                               ELSE v_cntr_tpsz_cd                            END                                               , ''                     /* COMBINED TYPE CODE */                                                                                                                                                                                                                                                                                               , v_cgo_tp_cd                                                                                                                                                                                                                                                                                                                                   , v_bound_cd                                                                                                                                                                                                                                                                                                                                    , v_crr_mod_cd                                                                                                                                                                                                                                                                                                                                  , v_cost_mod_cd                                                                                                                                                                                                                                                                                                                                 , v_cust_nomi_trkr_flg                                                                                                                                                                                                                                                                                                                          , v_cust_cnt_cd                                                                                                                                                                                                                                                                                                                                 , v_cust_seq                                                                                                                                                                                                                                                                                                                                    , v_rail_svc_tp_cd                                                                                                                                                                                                                                                                                                                              , v_cmdt_cd                                                                                                                                                                                                                                                                                                                                     , v_from_nod_cd                                                                                                                                                                                                                                                                                                                                 , v_via_nod_cd                                                                                                                                                                                                                                                                                                                                  , v_door_nod_cd                                                                                                                                                                                                                                                                                                                                 , v_to_nod_cd                                                                                                                                                                                                                                                                                                                                   , 0                    /* COUNT OF BUNDLING */                                                                                                                                                                                                                                                                                                  , v_wgt_uom                                                                                                                                                                                                                                                                                                                                     , v_wgt_qty                                                                                                                                                                                                                                                                                                                                     , ''  /* pi_rcv_term */                                                                                                                                                                                                                                                                                                                         , ''  /* pi_de_term */                                                                                                                                                                                                                                                                                                                          , v_tmp_trsp_agmt_ofc_cty_cd                                                                                                                                                                                                                                                                                                                    , v_tmp_trsp_agmt_seq                                                                                                                                                                                                                                                                                                                           , v_spcl_cgo_cntr_tp_cd                                                                                                                                                                                                                                                                                                                         , CASE WHEN ASCII(v_tmp_outer_loop_cnt) = ASCII(debug_flg) AND v_trs_agmt_rt_knd IS NOT NULL THEN 'Y'                                                                                                                                                                                                                                                  WHEN debug_flg = 'Y' AND v_trs_agmt_rt_knd IS NOT NULL THEN 'Y'                                                                                                                                                                                                                                                                                 ELSE 'N'                                                                                                                                                                                                                                                                                                                                   END /* pi_debug_flg   */                                                                                                                                                                                                                                                                                                                      , vo_trsp_agmt_ofc_cty_cd                                                                                                                                                                                                                                                                                                                       , vo_trsp_agmt_seq                                                                                                                                                                                                                                                                                                                              , vo_trsp_agmt_rt_tp_cd                                                                                                                                                                                                                                                                                                                         , vo_way_type                                                                                                                                                                                                                                                                                                                                   , vo_trsp_agmt_rt_tp_nm  /* po_trsp_agmt_rt_tp_nm */                                                                                                                                                                                                                                                                                            , vo_sp_type /* po_sp_type */                                                                                                                                                                                                                                                                                                                   , vo_cust_nomi_trkr_flg                                                                                                                                                                                                                                                                                                                         , vo_cust_cnt_cd                                                                                                                                                                                                                                                                                                                                , vo_cust_seq                                                                                                                                                                                                                                                                                                                                   , vo_curr_cd                                                                                                                                                                                                                                                                                                                                    , vo_basic_rate_tmp                                                                                                                                                                                                                                                                                                                             , vo_fuel_scg_rate_tmp                                                                                                                                                                                                                                                                                                                          , vo_ovw_scg_rate_tmp                                                                                                                                                                                                                                                                                                                           , vo_hzm_scg_rate_tmp                                                                                                                                                                                                                                                                                                                           , vo_ttl_scg_rate_tmp                                                                                                                                                                                                                                                                                                                           , vo_vat_scg_rate_tmp                                                                                                                                                                                                                                                                                                                           , vo_isg_scg_rate_tmp                                                                                                                                                                                                                                                                                                                           , vo_scg2_rate_tmp                                                                                                                                                                                                                                                                                                                              , vo_agmt_return_msg                                                                                                                                                                                                                                                                                                                            , vo_local_curr_tot_amt                                                                                                                                                                                                                                                                                                                         , vo_usd_curr_tot_amt                                                                                                                                                                                                                                                                                                                           , vo_wtr_rcv_term_cd                                                                                                                                                                                                                                                                                                                            , vo_wtr_de_term_cd                                                                                                                                                                                                                                                                                                                             , vo_basic_rt_rtn_cd                                                                                                                                                                                                                                                                                                                            , vo_process_rslt_msg                                                                                                                                                                                                                                                                                                                       );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              IF vo_trsp_agmt_ofc_cty_cd IS NULL THEN                                                                                                                                                                                                                                                                                                         -- empty pickup/return yard를 무시하고 계산                                                                                                                                                                                                                                                                                                         TRS_AGMT_RATE_CC_PKG.GET_TRS_ALL_RATE_PRC                                                                                                                                                                                                                                                                                                       (                                                                                                                                                                                                                                                                                                                                                     'COA2'||v_aoc_flag                                                                                                                                                                                                                                                                                                                            , v_ctrl_ofc_cd          /* Pair - X , Distance - Mandatory */                                                                                                                                                                                                                                                                                  , v_vndr_seq                                                                                                                                                                                                                                                                                                                                    , v_basis_dt                                                                                                                                                                                                                                                                                                                                    , MAS_WAY_TP             /* way type code - Only ONEWAY     */                                                                                                                                                                                                                                                                                  , 'U'                    /* EQ TYPE */                                                                                                                                                                                                                                                                            --                              , v_cntr_tpsz_cd   CHM-201539073  MAS에서 RD로 검색할 때 TRS Agreement 요율 매핑 로직 변경                                  ,CASE WHEN SUBSTR(v_cntr_tpsz_cd   ,1,1) = 'R' AND  LENGTH(v_cntr_tpsz_cd   ) > 2 THEN REPLACE(v_cntr_tpsz_cd   ,'D','')                                    ELSE v_cntr_tpsz_cd                                 END                                   , ''                     /* COMBINED TYPE CODE */                                                                                                                                                                                                                                                                                               , v_cgo_tp_cd                                                                                                                                                                                                                                                                                                                                   , v_bound_cd                                                                                                                                                                                                                                                                                                                                    , v_crr_mod_cd                                                                                                                                                                                                                                                                                                                                  , v_cost_mod_cd                                                                                                                                                                                                                                                                                                                                 , v_cust_nomi_trkr_flg                                                                                                                                                                                                                                                                                                                          , v_cust_cnt_cd                                                                                                                                                                                                                                                                                                                                 , v_cust_seq                                                                                                                                                                                                                                                                                                                                    , v_rail_svc_tp_cd                                                                                                                                                                                                                                                                                                                              , v_cmdt_cd                                                                                                                                                                                                                                                                                                                                     , v_from_nod_cd                                                                                                                                                                                                                                                                                                                                 , v_via_nod_cd                                                                                                                                                                                                                                                                                                                                  , v_door_nod_cd                                                                                                                                                                                                                                                                                                                                 , v_to_nod_cd                                                                                                                                                                                                                                                                                                                                   , 0                    /* COUNT OF BUNDLING */                                                                                                                                                                                                                                                                                                  , v_wgt_uom                                                                                                                                                                                                                                                                                                                                     , v_wgt_qty                                                                                                                                                                                                                                                                                                                                     , ''  /* pi_rcv_term */                                                                                                                                                                                                                                                                                                                         , ''  /* pi_de_term */                                                                                                                                                                                                                                                                                                                          , v_tmp_trsp_agmt_ofc_cty_cd                                                                                                                                                                                                                                                                                                                    , v_tmp_trsp_agmt_seq                                                                                                                                                                                                                                                                                                                           , v_spcl_cgo_cntr_tp_cd                                                                                                                                                                                                                                                                                                                         , CASE WHEN ASCII(v_tmp_outer_loop_cnt) = ASCII(debug_flg) AND v_trs_agmt_rt_knd IS NOT NULL THEN 'Y'                                                                                                                                                                                                                                                  WHEN debug_flg = 'Y' AND v_trs_agmt_rt_knd IS NOT NULL THEN 'Y'                                                                                                                                                                                                                                                                                 ELSE 'N'                                                                                                                                                                                                                                                                                                                                   END /* pi_debug_flg   */                                                                                                                                                                                                                                                                                                                      , vo_trsp_agmt_ofc_cty_cd                                                                                                                                                                                                                                                                                                                       , vo_trsp_agmt_seq                                                                                                                                                                                                                                                                                                                              , vo_trsp_agmt_rt_tp_cd                                                                                                                                                                                                                                                                                                                         , vo_way_type                                                                                                                                                                                                                                                                                                                                   , vo_trsp_agmt_rt_tp_nm  /* po_trsp_agmt_rt_tp_nm */                                                                                                                                                                                                                                                                                            , vo_sp_type /* po_sp_type */                                                                                                                                                                                                                                                                                                                   , vo_cust_nomi_trkr_flg                                                                                                                                                                                                                                                                                                                         , vo_cust_cnt_cd                                                                                                                                                                                                                                                                                                                                , vo_cust_seq                                                                                                                                                                                                                                                                                                                                   , vo_curr_cd                                                                                                                                                                                                                                                                                                                                    , vo_basic_rate_tmp                                                                                                                                                                                                                                                                                                                             , vo_fuel_scg_rate_tmp                                                                                                                                                                                                                                                                                                                          , vo_ovw_scg_rate_tmp                                                                                                                                                                                                                                                                                                                           , vo_hzm_scg_rate_tmp                                                                                                                                                                                                                                                                                                                           , vo_ttl_scg_rate_tmp                                                                                                                                                                                                                                                                                                                           , vo_vat_scg_rate_tmp                                                                                                                                                                                                                                                                                                                           , vo_isg_scg_rate_tmp                                                                                                                                                                                                                                                                                                                           , vo_scg2_rate_tmp                                                                                                                                                                                                                                                                                                                              , vo_agmt_return_msg                                                                                                                                                                                                                                                                                                                            , vo_local_curr_tot_amt                                                                                                                                                                                                                                                                                                                         , vo_usd_curr_tot_amt                                                                                                                                                                                                                                                                                                                           , vo_wtr_rcv_term_cd                                                                                                                                                                                                                                                                                                                            , vo_wtr_de_term_cd                                                                                                                                                                                                                                                                                                                             , vo_basic_rt_rtn_cd                                                                                                                                                                                                                                                                                                                            , vo_process_rslt_msg                                                                                                                                                                                                                                                                                                                       );                                                                                                                                                                                                                                                                                                                                          END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         IF v_trs_agmt_rt_knd = MAS_BZC THEN                                                                                                                                                                                                                                                                                                                 vo_final_rt       := vo_final_rt + NVL(vo_basic_rate_tmp, 0) + NVL(vo_ovw_scg_rate_tmp, 0) + NVL(vo_hzm_scg_rate_tmp, 0) + NVL(vo_ttl_scg_rate_tmp, 0) + NVL(vo_vat_scg_rate_tmp, 0);                                                                                                                                                           vo_rt_cal_rtn_cd  := vo_basic_rt_rtn_cd;                                                                                                                                                                                                                                                                                                        IF NVL(vo_basic_rate_tmp, 0) = 0 THEN /* C2R, C3R 일 경우 한구간이라도 agmt rate가 없으면 전구간 0으로 처리한다. (2011.11.25) */                                                                                                                                                                                                                    vo_final_rt := NULL;                                                                                                                                                                                                                                                                                                                            IF debug_flg IN ('Y', 'T') OR (ASCII(v_tmp_outer_loop_cnt) = ASCII(debug_flg)) THEN                                                                                                                                                                                                                                                                 DBMS_OUTPUT.PUT_LINE('◐ US RAIL RESULT >>> '|| v_from_nod_cd ||'/'|| v_to_nod_cd || ' 구간에 AGMT 자료가 존재하지 않아 전체 US Rail 구간의 요율을 NULL로 처리');                                                                                                                                                                           END IF;                                                                                                                                                                                                                                                                                                                                     END IF;                                                                                                                                                                                                                                                                                                                                         IF debug_flg IN ('Y', 'T') OR (ASCII(v_tmp_outer_loop_cnt) = ASCII(debug_flg)) THEN                                                                                                                                                                                                                                                                 DBMS_OUTPUT.PUT_LINE('■ RAIL BASIC RATE START >>>>>>>>>>>>>>>>>>>>>>>>>'||v_mas_cost_src_cd||'/'||v_cost_act_grp_seq);                                                                                                                                                                                                                         DBMS_OUTPUT.PUT_LINE('◀ NO :'||i);                                                                                                                                                                                                                                                                                                             DBMS_OUTPUT.PUT_LINE('◀ v_bil_patt_cd :'||v_bil_patt_cd);                                                                                                                                                                                                                                                                                      DBMS_OUTPUT.PUT_LINE('◀ v_from_nod_cd :'||v_from_nod_cd);                                                                                                                                                                                                                                                                                      DBMS_OUTPUT.PUT_LINE('◀ v_to_nod_cd :'||v_to_nod_cd);                                                                                                                                                                                                                                                                                          DBMS_OUTPUT.PUT_LINE('◀ v_basis_dt:'||v_basis_dt);                                                                                                                                                                                                                                                                                             DBMS_OUTPUT.PUT_LINE('◀ v_wgt_qty:'||v_wgt_qty);                                                                                                                                                                                                                                                                                               DBMS_OUTPUT.PUT_LINE('◀ v_wgt_uom:'||v_wgt_uom);                                                                                                                                                                                                                                                                                               DBMS_OUTPUT.PUT_LINE('◀ vo_final_rt:'||vo_final_rt);                                                                                                                                                                                                                                                                                           DBMS_OUTPUT.PUT_LINE('◀ vo_basic_rate_tmp:'||vo_basic_rate_tmp);                                                                                                                                                                                                                                                                               DBMS_OUTPUT.PUT_LINE('◀ vo_ovw_scg_rate_tmp:'||vo_ovw_scg_rate_tmp);                                                                                                                                                                                                                                                                           DBMS_OUTPUT.PUT_LINE('◀ vo_hzm_scg_rate_tmp:'||vo_hzm_scg_rate_tmp);                                                                                                                                                                                                                                                                           DBMS_OUTPUT.PUT_LINE('◀ vo_ttl_scg_rate_tmp:'||vo_ttl_scg_rate_tmp);                                                                                                                                                                                                                                                                           DBMS_OUTPUT.PUT_LINE('◀ vo_vat_scg_rate_tmp:'||vo_vat_scg_rate_tmp);                                                                                                                                                                                                                                                                           DBMS_OUTPUT.PUT_LINE('◀ vo_local_curr_tot_amt:'||vo_local_curr_tot_amt);                                                                                                                                                                                                                                                                       DBMS_OUTPUT.PUT_LINE('■ RAIL BASIC RATE END >>>>>>>>>>>>>>>>>>>>>>>>>>');                                                                                                                                                                                                                                                                  END IF;                                                                                                                                                                                                                                                                                                                                     ELSIF v_trs_agmt_rt_knd = MAS_SC_FU /*OR v_trs_agmt_rt_knd = MAS_SC_OW*/ THEN                                                                                                                                                                                                                                                                       vo_final_rt       := vo_final_rt + NVL(vo_fuel_scg_rate_tmp, 0);                                                                                                                                                                                                                                                                                vo_rt_cal_rtn_cd  := vo_basic_rt_rtn_cd;                                                                                                                                                                                                                                                                                                        IF NVL(vo_fuel_scg_rate_tmp, 0) = 0 THEN /* C2R, C3R 일 경우 한구간이라도 agmt rate가 없으면 전구간 0으로 처리한다. (2011.11.25) */                                                                                                                                                                                                                 vo_final_rt := NULL;                                                                                                                                                                                                                                                                                                                            IF debug_flg IN ('Y', 'T') OR (ASCII(v_tmp_outer_loop_cnt) = ASCII(debug_flg)) THEN                                                                                                                                                                                                                                                                 DBMS_OUTPUT.PUT_LINE('◐ US RAIL RESULT(FSG) >>> '|| v_from_nod_cd ||'/'|| v_to_nod_cd || ' 구간에 AGMT 자료가 존재하지 않아 전체 US Rail 구간의 요율을 NULL로 처리');                                                                                                                                                                      END IF;                                                                                                                                                                                                                                                                                                                                     END IF;                                                                                                                                                                                                                                                                                                                                         IF debug_flg IN ('Y', 'T') OR (ASCII(v_tmp_outer_loop_cnt) = ASCII(debug_flg)) THEN                                                                                                                                                                                                                                                                 DBMS_OUTPUT.PUT_LINE('■ FU SCG RATE START>>>>>>>>>>>>>>>>>>>>>>>>'||v_mas_cost_src_cd||'/'||v_cost_act_grp_seq);                                                                                                                                                                                                                               DBMS_OUTPUT.PUT_LINE('◀ v_bil_patt_cd :'||v_bil_patt_cd);                                                                                                                                                                                                                                                                                      DBMS_OUTPUT.PUT_LINE('◀ v_from_nod_cd :'||v_from_nod_cd);                                                                                                                                                                                                                                                                                      DBMS_OUTPUT.PUT_LINE('◀ v_to_nod_cd :'||v_to_nod_cd);                                                                                                                                                                                                                                                                                          DBMS_OUTPUT.PUT_LINE('◀ vo_final_rt:'||vo_final_rt);                                                                                                                                                                                                                                                                                           DBMS_OUTPUT.PUT_LINE('◀ v_basis_dt:'||v_basis_dt);                                                                                                                                                                                                                                                                                             DBMS_OUTPUT.PUT_LINE('◀ v_wgt_qty:'||v_wgt_qty);                                                                                                                                                                                                                                                                                               DBMS_OUTPUT.PUT_LINE('◀ v_wgt_uom:'||v_wgt_uom);                                                                                                                                                                                                                                                                                               DBMS_OUTPUT.PUT_LINE('◀ vo_basic_rate_tmp:'||vo_basic_rate_tmp);                                                                                                                                                                                                                                                                               DBMS_OUTPUT.PUT_LINE('◀ vo_fuel_scg_rate_tmp:'||vo_fuel_scg_rate_tmp);                                                                                                                                                                                                                                                                         DBMS_OUTPUT.PUT_LINE('◀ vo_local_curr_tot_amt:'||vo_local_curr_tot_amt);                                                                                                                                                                                                                                                                       DBMS_OUTPUT.PUT_LINE('■ FU SCG RATE END>>>>>>>>>>>>>>>>>>>>>>>>');                                                                                                                                                                                                                                                                         END IF;                                                                                                                                                                                                                                                                                                                                     ELSIF v_trs_agmt_rt_knd = 'ISG' THEN -- Incentive는 C2R, C3R 일 경우라도 한구간이라도 agmt rate가 있으면 금액을 계산한다.                                                                                                                                                                                                                           vo_final_rt  := vo_final_rt + NVL(vo_isg_scg_rate_tmp, 0);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      IF debug_flg IN ('Y', 'T') OR (ASCII(v_tmp_outer_loop_cnt) = ASCII(debug_flg)) THEN                                                                                                                                                                                                                                                                 DBMS_OUTPUT.PUT_LINE('■ ISG SCG RATE >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>'||v_mas_cost_src_cd||'/'||v_cost_act_grp_seq);                                                                                                                                                                                                                          DBMS_OUTPUT.PUT_LINE('◀ v_bil_patt_cd :'||v_bil_patt_cd);                                                                                                                                                                                                                                                                                      DBMS_OUTPUT.PUT_LINE('◀ v_from_nod_cd :'||v_from_nod_cd);                                                                                                                                                                                                                                                                                      DBMS_OUTPUT.PUT_LINE('◀ v_to_nod_cd :'||v_to_nod_cd);                                                                                                                                                                                                                                                                                          DBMS_OUTPUT.PUT_LINE('◀ vo_final_rt:'||vo_final_rt);                                                                                                                                                                                                                                                                                           DBMS_OUTPUT.PUT_LINE('◀ v_basis_dt:'||v_basis_dt);                                                                                                                                                                                                                                                                                             DBMS_OUTPUT.PUT_LINE('◀ v_wgt_qty:'||v_wgt_qty);                                                                                                                                                                                                                                                                                               DBMS_OUTPUT.PUT_LINE('◀ v_wgt_uom:'||v_wgt_uom);                                                                                                                                                                                                                                                                                               DBMS_OUTPUT.PUT_LINE('◀ vo_basic_rate_tmp:'||vo_basic_rate_tmp);                                                                                                                                                                                                                                                                               DBMS_OUTPUT.PUT_LINE('◀ vo_isg_scg_rate_tmp:'||vo_isg_scg_rate_tmp);                                                                                                                                                                                                                                                                           DBMS_OUTPUT.PUT_LINE('◀ vo_local_curr_tot_amt:'||vo_local_curr_tot_amt);                                                                                                                                                                                                                                                                       DBMS_OUTPUT.PUT_LINE('■ ISG SCG RATE >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>');                                                                                                                                                                                                                                                                  END IF;                                                                                                                                                                                                                                                                                                                                     END IF;                                                                                                                                                                                                                                                                                                                                         /* RATE CALCULATION END */                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  END LOOP;                                                                                                                                                                                                                                                                                                                                       /* LINK ... FOR LOOP END */                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     IF debug_flg IN ('Y', 'T') OR (ASCII(v_tmp_outer_loop_cnt) = ASCII(debug_flg)) THEN                                                                                                                                                                                                                                                                 DBMS_OUTPUT.PUT_LINE('[MAS] US RAIL S/O RATE CALCULATION FINAL RESULT = ['||vo_final_rt||']');                                                                                                                                                                                                                                              END IF;                                                                                                                                                                                                                                                                                                                                     ELSE                                                                                                                                                                                                                                                                                                                                            /* NONE US RAIL TRANSPORTATION - EXCEPT US RAIL TRANSPORTATION */                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   IF v_snd_vndr_seq IS NOT NULL AND v_trd_vndr_seq IS NOT NULL AND LENGTH(v_snd_vndr_seq) = 6 AND LENGTH(v_trd_vndr_seq) = 6 THEN                                                                                                                                                                                                                     IF  v_fst_vndr_seq != v_snd_vndr_seq OR v_fst_vndr_seq != v_trd_vndr_seq THEN                                                                                                                                                                                                                                                                       v_vndr_eff_flag := 'N';                                                                                                                                                                                                                                                                                                                     ELSE                                                                                                                                                                                                                                                                                                                                                v_vndr_eff_flag := 'Y';                                                                                                                                                                                                                                                                                                                     END IF;                                                                                                                                                                                                                                                                                                                                     ELSIF v_snd_vndr_seq IS NOT NULL AND LENGTH(v_snd_vndr_seq) = 6 THEN                                                                                                                                                                                                                                                                                IF  v_fst_vndr_seq != v_snd_vndr_seq THEN                                                                                                                                                                                                                                                                                                           v_vndr_eff_flag := 'N';                                                                                                                                                                                                                                                                                                                     ELSE                                                                                                                                                                                                                                                                                                                                                v_vndr_eff_flag := 'Y';                                                                                                                                                                                                                                                                                                                     END IF;                                                                                                                                                                                                                                                                                                                                     ELSIF v_trd_vndr_seq IS NOT NULL AND LENGTH(v_trd_vndr_seq) = 6 THEN                                                                                                                                                                                                                                                                                IF  v_fst_vndr_seq != v_trd_vndr_seq THEN                                                                                                                                                                                                                                                                                                           v_vndr_eff_flag := 'N';                                                                                                                                                                                                                                                                                                                     ELSE                                                                                                                                                                                                                                                                                                                                                v_vndr_eff_flag := 'Y';                                                                                                                                                                                                                                                                                                                     END IF;                                                                                                                                                                                                                                                                                                                                     ELSE                                                                                                                                                                                                                                                                                                                                                v_vndr_eff_flag := 'Y';                                                                                                                                                                                                                                                                                                                     END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         v_vndr_seq := v_fst_vndr_seq;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   v_from_nod_cd       := v_tmp_from_nod_cd  ;                                                                                                                                                                                                                                                                                                     v_via_nod_cd        := v_tmp_via_nod_cd   ;                                                                                                                                                                                                                                                                                                     v_door_nod_cd       := v_tmp_door_nod_cd  ;                                                                                                                                                                                                                                                                                                     v_to_nod_cd         := v_tmp_to_nod_cd    ;                    v_rail_svc_tp_cd    := '';                  v_tmp_trsp_agmt_ofc_cty_cd := '';                  v_tmp_trsp_agmt_seq :='';                                                                                                                                                                                                                                                                                                                                                                  /* US RAIL 이외의 운송에 대하여 S/P의 유효성 체크 -> 유효할때만 RATE CALCULATION */                                                                                                                                                                                                                                                             IF v_vndr_eff_flag = 'Y' THEN                                                                                                                                                                                                                                                                                                                       IF debug_flg IN ('Y', 'T') OR (ASCII(v_tmp_outer_loop_cnt) = ASCII(debug_flg)) THEN                                                                                                                                                                                                                                                                 DBMS_OUTPUT.put_line('▶ Vendor effectiveness : ' || v_trs_agmt_rt_knd );                                                                                                                                                                                                                                                                   END IF;                                                                                                                                                                                                                                                                                                                                             /* BASIC RATE CALCULATION START */                                                                                                                                                                                                                                                                                                                TRS_AGMT_RATE_CC_PKG.GET_TRS_ALL_RATE_PRC                                                                                                                                                                                                                                                                                                       (                                                                                                                                                                                                                                                                                                                                                     'COA1'||v_aoc_flag                                                                                                                                                                                                                                                                                                                            , v_ctrl_ofc_cd          /* Pair - X , Distance - Mandatory */                                                                                                                                                                                                                                                                                  , v_vndr_seq                                                                                                                                                                                                                                                                                                                                    , v_basis_dt                                                                                                                                                                                                                                                                                                                                    , MAS_WAY_TP             /* way type code - Only ONEWAY     */                                                                                                                                                                                                                                                                                  , 'U'                    /* EQ TYPE */                                                                                                                                                                                                                                                                          --                                , v_cntr_tpsz_cd   CHM-201539073  MAS에서 RD로 검색할 때 TRS Agreement 요율 매핑 로직 변경                                   ,CASE WHEN SUBSTR(v_cntr_tpsz_cd   ,1,1) = 'R' AND  LENGTH(v_cntr_tpsz_cd   ) > 2 THEN REPLACE(v_cntr_tpsz_cd   ,'D','')                                    ELSE v_cntr_tpsz_cd                                  END                                 , ''                     /* COMBINED TYPE CODE */                                                                                                                                                                                                                                                                                               , v_cgo_tp_cd                                                                                                                                                                                                                                                                                                                                   , v_bound_cd                                                                                                                                                                                                                                                                                                                                    , v_crr_mod_cd                                                                                                                                                                                                                                                                                                                                  , v_cost_mod_cd                                                                                                                                                                                                                                                                                                                                 , v_cust_nomi_trkr_flg                                                                                                                                                                                                                                                                                                                          , v_cust_cnt_cd                                                                                                                                                                                                                                                                                                                                 , v_cust_seq                                                                                                                                                                                                                                                                                                                                    , v_rail_svc_tp_cd                                                                                                                                                                                                                                                                                                                              , v_cmdt_cd                                                                                                                                                                                                                                                                                                                                     , v_from_nod_cd                                                                                                                                                                                                                                                                                                                                 , v_via_nod_cd                                                                                                                                                                                                                                                                                                                                  , v_door_nod_cd                                                                                                                                                                                                                                                                                                                                 , v_to_nod_cd                                                                                                                                                                                                                                                                                                                                   , 0                    /* COUNT OF BUNDLING */                                                                                                                                                                                                                                                                                                  , v_wgt_uom                                                                                                                                                                                                                                                                                                                                     , v_wgt_qty                                                                                                                                                                                                                                                                                                                                     , ''  /* pi_rcv_term */                                                                                                                                                                                                                                                                                                                         , ''  /* pi_de_term */                                                                                                                                                                                                                                                                                                                          , v_tmp_trsp_agmt_ofc_cty_cd                                                                                                                                                                                                                                                                                                                    , v_tmp_trsp_agmt_seq                                                                                                                                                                                                                                                                                                                           , v_spcl_cgo_cntr_tp_cd                                                                                                                                                                                                                                                                                                                         , CASE WHEN ASCII(v_tmp_outer_loop_cnt) = ASCII(debug_flg) AND v_trs_agmt_rt_knd IS NOT NULL THEN 'Y'                                                                                                                                                                                                                                                  WHEN debug_flg = 'Y' AND v_trs_agmt_rt_knd IS NOT NULL THEN 'Y'                                                                                                                                                                                                                                                                                 ELSE 'N'                                                                                                                                                                                                                                                                                                                                   END /* pi_debug_flg   */                                                                                                                                                                                                                                                                                                                      , vo_trsp_agmt_ofc_cty_cd                                                                                                                                                                                                                                                                                                                       , vo_trsp_agmt_seq                                                                                                                                                                                                                                                                                                                              , vo_trsp_agmt_rt_tp_cd                                                                                                                                                                                                                                                                                                                         , vo_way_type                                                                                                                                                                                                                                                                                                                                   , vo_trsp_agmt_rt_tp_nm  /* po_trsp_agmt_rt_tp_nm */                                                                                                                                                                                                                                                                                            , vo_sp_type /* po_sp_type */                                                                                                                                                                                                                                                                                                                   , vo_cust_nomi_trkr_flg                                                                                                                                                                                                                                                                                                                         , vo_cust_cnt_cd                                                                                                                                                                                                                                                                                                                                , vo_cust_seq                                                                                                                                                                                                                                                                                                                                   , vo_curr_cd                                                                                                                                                                                                                                                                                                                                    , vo_basic_rate_tmp                                                                                                                                                                                                                                                                                                                             , vo_fuel_scg_rate_tmp                                                                                                                                                                                                                                                                                                                          , vo_ovw_scg_rate_tmp                                                                                                                                                                                                                                                                                                                           , vo_hzm_scg_rate_tmp                                                                                                                                                                                                                                                                                                                           , vo_ttl_scg_rate_tmp                                                                                                                                                                                                                                                                                                                           , vo_vat_scg_rate_tmp                                                                                                                                                                                                                                                                                                                           , vo_isg_scg_rate_tmp                                                                                                                                                                                                                                                                                                                           , vo_scg2_rate_tmp                                                                                                                                                                                                                                                                                                                              , vo_agmt_return_msg                                                                                                                                                                                                                                                                                                                            , vo_local_curr_tot_amt                                                                                                                                                                                                                                                                                                                         , vo_usd_curr_tot_amt                                                                                                                                                                                                                                                                                                                           , vo_wtr_rcv_term_cd                                                                                                                                                                                                                                                                                                                            , vo_wtr_de_term_cd                                                                                                                                                                                                                                                                                                                             , vo_basic_rt_rtn_cd                                                                                                                                                                                                                                                                                                                            , vo_process_rslt_msg                                                                                                                                                                                                                                                                                                                       );                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        IF vo_trsp_agmt_ofc_cty_cd IS NULL THEN                                                                                                                                                                                                                                                                                                         -- empty pickup/return yard를 무시하고 계산                                                                                                                                                                                                                                                                                                         TRS_AGMT_RATE_CC_PKG.GET_TRS_ALL_RATE_PRC                                                                                                                                                                                                                                                                                                       (                                                                                                                                                                                                                                                                                                                                                     'COA2'||v_aoc_flag                                                                                                                                                                                                                                                                                                                            , v_ctrl_ofc_cd          /* Pair - X , Distance - Mandatory */                                                                                                                                                                                                                                                                                  , v_vndr_seq                                                                                                                                                                                                                                                                                                                                    , v_basis_dt                                                                                                                                                                                                                                                                                                                                    , MAS_WAY_TP             /* way type code - Only ONEWAY     */                                                                                                                                                                                                                                                                                  , 'U'                    /* EQ TYPE */                                                                                                                                                                                                                                                                            --                              , v_cntr_tpsz_cd   CHM-201539073  MAS에서 RD로 검색할 때 TRS Agreement 요율 매핑 로직 변경                                       ,CASE WHEN SUBSTR(v_cntr_tpsz_cd   ,1,1) = 'R' AND  LENGTH(v_cntr_tpsz_cd   ) > 2 THEN REPLACE(v_cntr_tpsz_cd   ,'D','')                                    ELSE v_cntr_tpsz_cd                                 END                               , ''                     /* COMBINED TYPE CODE */                                                                                                                                                                                                                                                                                               , v_cgo_tp_cd                                                                                                                                                                                                                                                                                                                                   , v_bound_cd                                                                                                                                                                                                                                                                                                                                    , v_crr_mod_cd                                                                                                                                                                                                                                                                                                                                  , v_cost_mod_cd                                                                                                                                                                                                                                                                                                                                 , v_cust_nomi_trkr_flg                                                                                                                                                                                                                                                                                                                          , v_cust_cnt_cd                                                                                                                                                                                                                                                                                                                                 , v_cust_seq                                                                                                                                                                                                                                                                                                                                    , v_rail_svc_tp_cd                                                                                                                                                                                                                                                                                                                              , v_cmdt_cd                                                                                                                                                                                                                                                                                                                                     , v_from_nod_cd                                                                                                                                                                                                                                                                                                                                 , v_via_nod_cd                                                                                                                                                                                                                                                                                                                                  , v_door_nod_cd                                                                                                                                                                                                                                                                                                                                 , v_to_nod_cd                                                                                                                                                                                                                                                                                                                                   , 0                    /* COUNT OF BUNDLING */                                                                                                                                                                                                                                                                                                  , v_wgt_uom                                                                                                                                                                                                                                                                                                                                     , v_wgt_qty                                                                                                                                                                                                                                                                                                                                     , ''  /* pi_rcv_term */                                                                                                                                                                                                                                                                                                                         , ''  /* pi_de_term */                                                                                                                                                                                                                                                                                                                          , v_tmp_trsp_agmt_ofc_cty_cd                                                                                                                                                                                                                                                                                                                    , v_tmp_trsp_agmt_seq                                                                                                                                                                                                                                                                                                                           , v_spcl_cgo_cntr_tp_cd                                                                                                                                                                                                                                                                                                                         , CASE WHEN ASCII(v_tmp_outer_loop_cnt) = ASCII(debug_flg) AND v_trs_agmt_rt_knd IS NOT NULL THEN 'Y'                                                                                                                                                                                                                                                  WHEN debug_flg = 'Y' AND v_trs_agmt_rt_knd IS NOT NULL THEN 'Y'                                                                                                                                                                                                                                                                                 ELSE 'N'                                                                                                                                                                                                                                                                                                                                   END /* pi_debug_flg   */                                                                                                                                                                                                                                                                                                                      , vo_trsp_agmt_ofc_cty_cd                                                                                                                                                                                                                                                                                                                       , vo_trsp_agmt_seq                                                                                                                                                                                                                                                                                                                              , vo_trsp_agmt_rt_tp_cd                                                                                                                                                                                                                                                                                                                         , vo_way_type                                                                                                                                                                                                                                                                                                                                   , vo_trsp_agmt_rt_tp_nm  /* po_trsp_agmt_rt_tp_nm */                                                                                                                                                                                                                                                                                            , vo_sp_type /* po_sp_type */                                                                                                                                                                                                                                                                                                                   , vo_cust_nomi_trkr_flg                                                                                                                                                                                                                                                                                                                         , vo_cust_cnt_cd                                                                                                                                                                                                                                                                                                                                , vo_cust_seq                                                                                                                                                                                                                                                                                                                                   , vo_curr_cd                                                                                                                                                                                                                                                                                                                                    , vo_basic_rate_tmp                                                                                                                                                                                                                                                                                                                             , vo_fuel_scg_rate_tmp                                                                                                                                                                                                                                                                                                                          , vo_ovw_scg_rate_tmp                                                                                                                                                                                                                                                                                                                           , vo_hzm_scg_rate_tmp                                                                                                                                                                                                                                                                                                                           , vo_ttl_scg_rate_tmp                                                                                                                                                                                                                                                                                                                           , vo_vat_scg_rate_tmp                                                                                                                                                                                                                                                                                                                           , vo_isg_scg_rate_tmp                                                                                                                                                                                                                                                                                                                           , vo_scg2_rate_tmp                                                                                                                                                                                                                                                                                                                              , vo_agmt_return_msg                                                                                                                                                                                                                                                                                                                            , vo_local_curr_tot_amt                                                                                                                                                                                                                                                                                                                         , vo_usd_curr_tot_amt                                                                                                                                                                                                                                                                                                                           , vo_wtr_rcv_term_cd                                                                                                                                                                                                                                                                                                                            , vo_wtr_de_term_cd                                                                                                                                                                                                                                                                                                                             , vo_basic_rt_rtn_cd                                                                                                                                                                                                                                                                                                                            , vo_process_rslt_msg                                                                                                                                                                                                                                                                                                                       );                                                                                                                                                                                                                                                                                                                                          END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         IF v_trs_agmt_rt_knd = MAS_BZC THEN                                                                                                                                                                                                                                                                                                                 vo_final_rt       := NVL(vo_basic_rate_tmp, 0);                                                                                                                                                                                                                                                                                                 vo_rt_cal_rtn_cd  := vo_basic_rt_rtn_cd;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        IF debug_flg IN ('Y', 'T') OR (ASCII(v_tmp_outer_loop_cnt) = ASCII(debug_flg)) THEN                                                                                                                                                                                                                                                                 DBMS_OUTPUT.PUT_LINE('■ BASIC RATE >>>>>>>>>>>>>>>>>>>>>>>>>>>'||v_mas_cost_src_cd||'/'||v_cost_act_grp_seq);                                                                                                                                                                                                                                  DBMS_OUTPUT.PUT_LINE('◈ v_from_nod_cd :'||v_from_nod_cd);                                                                                                                                                                                                                                                                                      DBMS_OUTPUT.PUT_LINE('◈ v_via_nod_cd :'||v_via_nod_cd);                                                                                                                                                                                                                                                                                        DBMS_OUTPUT.PUT_LINE('◈ v_door_nod_cd :'||v_door_nod_cd);                                                                                                                                                                                                                                                                                      DBMS_OUTPUT.PUT_LINE('◈ v_to_nod_cd :'||v_to_nod_cd);                                                                                                                                                                                                                                                                                          DBMS_OUTPUT.PUT_LINE('◈ vo_final_rt:'||vo_final_rt);                                                                                                                                                                                                                                                                                           DBMS_OUTPUT.PUT_LINE('◈ v_basis_dt:'||v_basis_dt);                                                                                                                                                                                                                                                                                             DBMS_OUTPUT.PUT_LINE('◈ v_wgt_qty:'||v_wgt_qty);                                                                                                                                                                                                                                                                                               DBMS_OUTPUT.PUT_LINE('◈ v_wgt_uom:'||v_wgt_uom);                                                                                                                                                                                                                                                                                               DBMS_OUTPUT.PUT_LINE('◈ vo_basic_rate_tmp:'||vo_basic_rate_tmp);                                                                                                                                                                                                                                                                               DBMS_OUTPUT.PUT_LINE('◈ vo_fuel_scg_rate_tmp:'||vo_fuel_scg_rate_tmp);                                                                                                                                                                                                                                                                         DBMS_OUTPUT.PUT_LINE('◈ vo_ovw_scg_rate_tmp:'||vo_ovw_scg_rate_tmp);                                                                                                                                                                                                                                                                           DBMS_OUTPUT.PUT_LINE('◈ vo_local_curr_tot_amt:'||vo_local_curr_tot_amt);                                                                                                                                                                                                                                                                       DBMS_OUTPUT.PUT_LINE('◈ vo_agmt_return_msg:'||vo_agmt_return_msg);                                                                                                                                                                                                                                                                             DBMS_OUTPUT.PUT_LINE('■ BASIC RATE >>>>>>>>>>>>>>>>>>>>>>>>>>>');                                                                                                                                                                                                                                                                          END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     ELSIF v_trs_agmt_rt_knd = MAS_SC_FU /*OR v_trs_agmt_rt_knd = MAS_SC_OW*/ THEN                                                                                                                                                                                                                                                                       vo_final_rt       := NVL(vo_fuel_scg_rate_tmp, 0);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              IF vo_basic_rt_rtn_cd = 0 AND vo_final_rt > 0 THEN /* 0 access */                                                                                                                                                                                                                                                                           vo_rt_cal_rtn_cd  := vo_basic_rt_rtn_cd;                                                                                                                                                                                                                                                                                                    ELSE                                                                                                                                                                                                                                                                                                                                                vo_rt_cal_rtn_cd  := -99;                                                                                                                                                                                                                                                                                                                   END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         IF debug_flg IN ('Y', 'T') OR (ASCII(v_tmp_outer_loop_cnt) = ASCII(debug_flg)) THEN                                                                                                                                                                                                                                                                 DBMS_OUTPUT.PUT_LINE('■ FU SCG RATE >>>>>>>>>>>>>>>>>>>>>>>>>'||v_mas_cost_src_cd||'/'||v_cost_act_grp_seq);                                                                                                                                                                                                                                   DBMS_OUTPUT.PUT_LINE('◈ v_from_nod_cd :'||v_from_nod_cd);                                                                                                                                                                                                                                                                                      DBMS_OUTPUT.PUT_LINE('◈ v_via_nod_cd :'||v_via_nod_cd);                                                                                                                                                                                                                                                                                        DBMS_OUTPUT.PUT_LINE('◈ v_door_nod_cd :'||v_door_nod_cd);                                                                                                                                                                                                                                                                                      DBMS_OUTPUT.PUT_LINE('◈ v_to_nod_cd :'||v_to_nod_cd);                                                                                                                                                                                                                                                                                          DBMS_OUTPUT.PUT_LINE('◈ vo_final_rt:'||vo_final_rt);                                                                                                                                                                                                                                                                                           DBMS_OUTPUT.PUT_LINE('◈ v_basis_dt:'||v_basis_dt);                                                                                                                                                                                                                                                                                             DBMS_OUTPUT.PUT_LINE('◈ v_wgt_qty:'||v_wgt_qty);                                                                                                                                                                                                                                                                                               DBMS_OUTPUT.PUT_LINE('◈ v_wgt_uom:'||v_wgt_uom);                                                                                                                                                                                                                                                                                               DBMS_OUTPUT.PUT_LINE('◈ vo_basic_rate_tmp:'||vo_basic_rate_tmp);                                                                                                                                                                                                                                                                               DBMS_OUTPUT.PUT_LINE('◈ vo_fuel_scg_rate_tmp:'||vo_fuel_scg_rate_tmp);                                                                                                                                                                                                                                                                         DBMS_OUTPUT.PUT_LINE('◈ vo_ovw_scg_rate_tmp:'||vo_ovw_scg_rate_tmp);                                                                                                                                                                                                                                                                           DBMS_OUTPUT.PUT_LINE('◈ vo_local_curr_tot_amt:'||vo_local_curr_tot_amt);                                                                                                                                                                                                                                                                       DBMS_OUTPUT.PUT_LINE('■ FU SCG RATE >>>>>>>>>>>>>>>>>>>>>>>>');                                                                                                                                                                                                                                                                            END IF;                                                                                                                                                                                                                                                                                                                                      ELSIF v_trs_agmt_rt_knd = 'TF' THEN -- Incentive는 C2R, C3R 일 경우라도 한구간이라도 agmt rate가 있으면 금액을 계산한다.                                                                                                                                                                                                                           vo_final_rt  := vo_final_rt + NVL(vo_scg2_rate_tmp, 0);                                                    IF vo_basic_rt_rtn_cd = 0 AND NVL(vo_scg2_rate_tmp, 0) <> 0 THEN /* 0 access */                              vo_rt_cal_rtn_cd  := vo_basic_rt_rtn_cd;                          ELSE                              vo_rt_cal_rtn_cd  := -99;                          END IF;                                                                                                                                                                                                                                                                                                                                                                          IF debug_flg IN ('Y', 'T') OR (ASCII(v_tmp_outer_loop_cnt) = ASCII(debug_flg)) THEN                                                                                                                                                                                                                                                                 DBMS_OUTPUT.PUT_LINE('■ TOLL FEE SCG RATE >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>'||v_mas_cost_src_cd||'/'||v_cost_act_grp_seq);                                                                                                                                                                                                                     DBMS_OUTPUT.PUT_LINE('◈ v_from_nod_cd :'||v_from_nod_cd);                                                                                                                                                                                                                                                                                      DBMS_OUTPUT.PUT_LINE('◈ v_via_nod_cd :'||v_via_nod_cd);                                                                                                                                                                                                                                                                                        DBMS_OUTPUT.PUT_LINE('◈ v_door_nod_cd :'||v_door_nod_cd);                                                                                                                                                                                                                                                                                      DBMS_OUTPUT.PUT_LINE('◈ v_to_nod_cd :'||v_to_nod_cd);                                                                                                                                                                                                                                                                                          DBMS_OUTPUT.PUT_LINE('◈ v_vndr_eff_flag:'|| v_vndr_eff_flag);                                                                                                                                                                                                                                                                                  DBMS_OUTPUT.PUT_LINE('◈ v_pctl_no :'|| v_pctl_no);                                                                                                                                                                                                                                                                                             DBMS_OUTPUT.PUT_LINE('◈ v_cost_act_grp_seq :'|| v_cost_act_grp_seq);                                                                                                                                                                                                                                                                           DBMS_OUTPUT.PUT_LINE('◈ v_cntr_tpsz_cd :'|| v_cntr_tpsz_cd);                                                                                                                                                                                                                                                                                   DBMS_OUTPUT.PUT_LINE('◈ v_coa_cost_src_cd :'|| v_mas_cost_src_cd);                                                                                                                                                                                                                                                                             DBMS_OUTPUT.PUT_LINE('◀ vo_final_rt:'||vo_final_rt);                                                                                                                                                                                                                                                                                           DBMS_OUTPUT.PUT_LINE('◀ v_basis_dt:'||v_basis_dt);                               DBMS_OUTPUT.PUT_LINE('◀ vo_rt_cal_rtn_cd:'||vo_rt_cal_rtn_cd);                              DBMS_OUTPUT.PUT_LINE('■ TOLL FEE RATE >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>');                                                                                                                                                                                                                                                                 END IF;                                                                                                                                                                                                                                                                                                                                     ELSIF v_trs_agmt_rt_knd = 'SCHLCF' AND (v_ctrl_ofc_cd IN ('HAMSC', 'FXTSC', 'RTMSC', 'LEHSC')) THEN /* HJL Cost Recovery */                                                                                                                                                                                                                         IF debug_flg IN ('Y', 'T') OR (ASCII(v_tmp_outer_loop_cnt) = ASCII(debug_flg)) THEN                                                                                                                                                                                                                                                                 DBMS_OUTPUT.PUT_LINE('HJL Cost Recovery basis date>>>>>>>>>>>>>>>>>>>>>>'||TO_CHAR(v_basis_dt, 'YYYYMMDD'));                                                                                                                                                                                                                                    DBMS_OUTPUT.PUT_LINE('HJL Cost Recovery Office>>>>>>>>>>>>>>'||v_ctrl_ofc_cd||', vo_curr_cd : '|| vo_curr_cd );                                                                                                                                                                                                                             END IF;                                                                                                                                                                                                                                                                                                                                         BEGIN                                                                                                                                                                                                                                                                                                                                               SELECT VNDR_SEQ, CURR_CD, COST_RCVR_AMT                                                                                                                                                                                                                                                                                                           INTO v_hjs_vndr_seq, v_hjs_vndr_curr, vo_final_rt                                                                                                                                                                                                                                                                                               FROM                                                                                                                                                                                                                                                                                                                                              (                                                                                                                                                                                                                                                                                                                                               SELECT VNDR_SEQ                                                                                                                                                                                                                                                                                                                                      , CURR_CD                                                                                                                                                                                                                                                                                                                                       , TRS_COMMON_PKG.GET_CONVERSION_AMT_FNC(CURR_CD, NVL(vo_curr_cd, CURR_CD), COST_RCVR_AMT, TO_CHAR(GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC(v_ctrl_ofc_cd),'YYYYMM')) COST_RCVR_AMT                                                                                                                                                                  FROM TRS_HJL_HNDL_FEE                                                                                                                                                                                                                                                                                                                          WHERE HJL_OFC_CD = v_ctrl_ofc_cd                                                                                                                                                                                                                                                                                                                  AND v_basis_dt BETWEEN EFF_FM_DT AND TO_DATE('99991231', 'YYYYMMDD')+0.99999                                                                                                                                                                                                                                                                 UNION                                                                                                                                                                                                                                                                                                                                           SELECT VNDR_SEQ                                                                                                                                                                                                                                                                                                                                      , CURR_CD                                                                                                                                                                                                                                                                                                                                       , TRS_COMMON_PKG.GET_CONVERSION_AMT_FNC(CURR_CD, vo_curr_cd, COST_RCVR_AMT, TO_CHAR(GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC(v_ctrl_ofc_cd),'YYYYMM')) COST_RCVR_AMT                                                                                                                                                                                FROM TRS_HJL_HNDL_FEE_HIS                                                                                                                                                                                                                                                                                                                      WHERE HJL_OFC_CD = v_ctrl_ofc_cd                                                                                                                                                                                                                                                                                                                  AND v_basis_dt BETWEEN EFF_FM_DT AND EFF_TO_DT                                                                                                                                                                                                                                                                                                  AND ROWNUM = 1                                                                                                                                                                                                                                                                                                                               );                                                                                                                                                                                                                                                                                                                                          vo_curr_cd := NVL(vo_curr_cd, v_hjs_vndr_curr);                                                                                                                                                                                                                                                                                                 vo_rt_cal_rtn_cd := 0;                                                                                                                                                                                                                                                                                                                      EXCEPTION                                                                                                                                                                                                                                                                                                                                            WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                vo_rt_cal_rtn_cd  := -99;                                                                                                                                                                                                                                                                                                                  END;                                                                                                                                                                                                                                                                                                                                        ELSIF v_trs_agmt_rt_knd = 'SCHLOP' AND (v_ctrl_ofc_cd IN ('HAMSC', 'FXTSC', 'RTMSC', 'LEHSC')) THEN /* HJL Commission */                                                                                                                                                                                                                            BEGIN                                                                                                                                                                                                                                                                                                                                               SELECT VNDR_SEQ, CURR_CD, COST_RCVR_AMT                                                                                                                                                                                                                                                                                                           INTO v_hjs_vndr_seq, v_hjs_vndr_curr, vo_final_rt                                                                                                                                                                                                                                                                                               FROM                                                                                                                                                                                                                                                                                                                                              (                                                                                                                                                                                                                                                                                                                                               SELECT VNDR_SEQ                                                                                                                                                                                                                                                                                                                                      , CURR_CD                                                                                                                                                                                                                                                                                                                                       , TRS_COMMON_PKG.GET_CONVERSION_AMT_FNC(CURR_CD, NVL(vo_curr_cd, CURR_CD), COMM_AMT, TO_CHAR(GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC(v_ctrl_ofc_cd),'YYYYMM')) COST_RCVR_AMT                                                                                                                                                                       FROM TRS_HJL_HNDL_FEE                                                                                                                                                                                                                                                                                                                          WHERE HJL_OFC_CD = v_ctrl_ofc_cd                                                                                                                                                                                                                                                                                                                  AND v_basis_dt BETWEEN EFF_FM_DT AND TO_DATE('99991231', 'YYYYMMDD')+0.99999                                                                                                                                                                                                                                                                 UNION                                                                                                                                                                                                                                                                                                                                           SELECT VNDR_SEQ                                                                                                                                                                                                                                                                                                                                      , CURR_CD                                                                                                                                                                                                                                                                                                                                       , TRS_COMMON_PKG.GET_CONVERSION_AMT_FNC(CURR_CD, vo_curr_cd, COMM_AMT, TO_CHAR(GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC(v_ctrl_ofc_cd),'YYYYMM')) COST_RCVR_AMT                                                                                                                                                                                     FROM TRS_HJL_HNDL_FEE_HIS                                                                                                                                                                                                                                                                                                                      WHERE HJL_OFC_CD = v_ctrl_ofc_cd                                                                                                                                                                                                                                                                                                                  AND v_basis_dt BETWEEN EFF_FM_DT AND EFF_TO_DT                                                                                                                                                                                                                                                                                                  AND ROWNUM = 1                                                                                                                                                                                                                                                                                                                               );                                                                                                                                                                                                                                                                                                                                          vo_curr_cd := NVL(vo_curr_cd, v_hjs_vndr_curr);                                                                                                                                                                                                                                                                                                 vo_rt_cal_rtn_cd := 0;                                                                                                                                                                                                                                                                                                                          IF debug_flg IN ('Y', 'T') OR (ASCII(v_tmp_outer_loop_cnt) = ASCII(debug_flg)) THEN                                                                                                                                                                                                                                                                 DBMS_OUTPUT.PUT_LINE('HJL Cost Recovery Office :'||v_ctrl_ofc_cd||', hjs_vndr_curr : '|| v_hjs_vndr_curr ||', vo_curr_cd : '|| vo_curr_cd );                                                                                                                                                                                                    DBMS_OUTPUT.PUT_LINE('HJL Commission Rate>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>'||vo_final_rt);                                                                                                                                                                                                                                      END IF;                                                                                                                                                                                                                                                                                                                                     EXCEPTION                                                                                                                                                                                                                                                                                                                                            WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                vo_rt_cal_rtn_cd  := -99;                                                                                                                                                                                                                                                                                                                  END;                                                                                                                                                                                                                                                                                                                                        END IF;                                                                                                                                                                                                                                                                                                                                         /* RATE CALCULATION END */                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ELSE                                                                                                                                                                                                                                                                                                                                            /* Non-Effective S/P */                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             IF debug_flg IN ('Y', 'T') OR (ASCII(v_tmp_outer_loop_cnt) = ASCII(debug_flg)) THEN                                                                                                                                                                                                                                                                 DBMS_OUTPUT.PUT_LINE('');                                                                                                                                                                                                                                                                                                                       DBMS_OUTPUT.PUT_LINE(' ======================== [[[ Non-Effective S/P ]]] ======================== ');                                                                                                                                                                                                                                          DBMS_OUTPUT.PUT_LINE('');                                                                                                                                                                                                                                                                                                                   END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         vo_rt_cal_rtn_cd     := -99;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                END IF;                                                                                                                                                                                                                                                                                                                                         /* US RAIL 이외의 운송에 대하여 S/P의 유효성 체크 + RATE CALCULATION END. */                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    IF debug_flg IN ('Y', 'T') OR (ASCII(v_tmp_outer_loop_cnt) = ASCII(debug_flg)) THEN                                                                                                                                                                                                                                                                 DBMS_OUTPUT.PUT_LINE('NONE US RAIL S/O RATE CALCULATION FINAL RESULT = ['||vo_final_rt||']');                                                                                                                                                                                                                                               END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     END IF;                                                                                                                                                                                                                                                                                                                                         /* S/P RATE CALCULATION END. */                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         /* UNIT TOTAL BASIC RATE */                                                                                                                                                                                                                                                                                                                     /* UPDATE 'Y' WHEN REAL RATE IS ZERO VALUE, UPDATE 'N' WHEN RATE NOT FOUND + RATE ZERO 강제세팅 */                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              /* COST_ACT_GRP_CD : TYTD 인 특정 Pair 건의 경우 Mother-Mother 간의 TS 비용을 0으로 고정*/                                                                                                                                                                                                                                                      IF (( (v_mas_tmp_1st_nod_cd ='CNHKGHT' AND v_mas_tmp_2nd_nod_cd ='CNHKGHT')                                                                                                                                                                                                                                                                        OR (v_mas_tmp_1st_nod_cd ='CNHKGHT' AND v_mas_tmp_2nd_nod_cd ='CNHKGCH')                                                                                                                                                                                                                                                                        OR (v_mas_tmp_1st_nod_cd ='CNHKGHT' AND v_mas_tmp_2nd_nod_cd ='CNHKGM2')                                                                                                                                                                                                                                                                        OR (v_mas_tmp_1st_nod_cd ='CNHKGHT' AND v_mas_tmp_2nd_nod_cd ='CNHKGFS')                                                                                                                                                                                                                                                                        OR (v_mas_tmp_1st_nod_cd ='CNHKGCH' AND v_mas_tmp_2nd_nod_cd ='CNHKGHT')                                                                                                                                                                                                                                                                        OR (v_mas_tmp_1st_nod_cd ='CNHKGCH' AND v_mas_tmp_2nd_nod_cd ='CNHKGCH')                                                                                                                                                                                                                                                                        OR (v_mas_tmp_1st_nod_cd ='CNHKGCH' AND v_mas_tmp_2nd_nod_cd ='CNHKGM2')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        OR (v_mas_tmp_1st_nod_cd ='CNHKGM2' AND v_mas_tmp_2nd_nod_cd ='CNHKGHT')                                                                                                                                                                                                                                                                        OR (v_mas_tmp_1st_nod_cd ='CNHKGM2' AND v_mas_tmp_2nd_nod_cd ='CNHKGCH')                                                                                                                                                                                                                                                                        OR (v_mas_tmp_1st_nod_cd ='CNHKGM2' AND v_mas_tmp_2nd_nod_cd ='CNHKGM2')                                                                                                                                                                                                                                                                        OR (v_mas_tmp_1st_nod_cd ='CNHKGM2' AND v_mas_tmp_2nd_nod_cd ='CNHKGFS')                                                                                                                                                                                                                                                                        OR (v_mas_tmp_1st_nod_cd ='CNHKGFS' AND v_mas_tmp_2nd_nod_cd ='CNHKGHT')                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        OR (v_mas_tmp_1st_nod_cd ='CNHKGFS' AND v_mas_tmp_2nd_nod_cd ='CNHKGM2')                                                                                                                                                                                                                                                                        OR (v_mas_tmp_1st_nod_cd ='CNHKGFS' AND v_mas_tmp_2nd_nod_cd ='CNHKGFS')                                                                                                                                                                                                                                                                        )                                                                                                                                                                                                                                                                                                                                               AND v_cost_act_grp_cd ='TYTD'                                                                                                                                                                                                                                                                                                                   AND v_bfr_trsp_mod_cd = 'VD' AND v_aft_trsp_mod_cd = 'VD'                                                                                                                                                                                                                                                                                       )                                                                                                                                                                                                                                                                                                                                               THEN                                                                                                                                                                                                                                                                                                                                               vo_final_rt := 0;                                                                                                                                                                                                                                                                                                                         END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         IF v_trs_agmt_rt_knd = 'ISG' AND vo_final_rt = 0 THEN                                                                                                                                                                                                                                                                                               vo_rt_cal_rtn_cd := -99;                                                                                                                                                                                                                                                                                                                    END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         /*                                                                                                                                                                                                                                                                                                                                                 Billing pattern code가 C2R, C3R일 경우 금액이 없으면 모든 Link의 agmt 자료는 없는것으로 간주한다.                                                                                                                                                                                                                                               금액은 산출이 link 하나라도 값이 없을 경우 null을 더하였으므로 이미 null로 산출되었다.                                                                                                                                                                                                                                                          단, US Incentive의 경우는 Link중 한 구간만이라도 금액이 있으면 agmt 금액을 산출한다.                                                                                                                                                                                                                                                                (incentive금액은 위의 계산 로직에서 금액이 산출되었으므로 아래 if절 조건의 vo_final_rt IS NULL 의하여 예외처리는 되지 않는다.)                                                                                                                                                                                                           */                                                                                                                                                                                                                                                                                                                                              IF (v_bil_patt_cd = 'C2R' OR v_bil_patt_cd = 'C3R') AND vo_final_rt IS NULL THEN                                                                                                                                                                                                                                                                    vo_rt_cal_rtn_cd := -99;                                                                                                                                                                                                                                                                                                                    END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         v_trsp_agmt_old_flg := SUBSTR(vo_agmt_return_msg, 1, INSTR(vo_agmt_return_msg, '$', 1, 1) - 1);                                                                                                                                                                                                                                                 v_agmt_emy_pkup_rtn_yd_cd := SUBSTR(vo_agmt_return_msg, INSTR(vo_agmt_return_msg, '$', 1, 1) + 1, INSTR(vo_agmt_return_msg, '$', 1, 2) - INSTR(vo_agmt_return_msg, '$', 1, 1) - 1);                                                                                                                                                             v_agmt_wgt := SUBSTR(vo_agmt_return_msg, INSTR(vo_agmt_return_msg, '$', 1, 2) + 1, INSTR(vo_agmt_return_msg, '$', 1, 3) - INSTR(vo_agmt_return_msg, '$', 1, 2) - 1);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            IF v_aoc_flag='Y' AND SUBSTR(v_from_nod_cd,1,2) NOT IN ('US','CA') AND v_trsp_agmt_old_flg = 'Y' THEN                                                                                                                                                                                                                                                   vo_rt_cal_rtn_cd := -99;                                                                                                                                                                                                                                                                                                                END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         /* EFFECTIVE S/P + BASIC/FUEL */                                                                                                                                                                                                                                                                                                                DBMS_OUTPUT.put_line('▶▶▶ PU v_trs_agmt_rt_knd : ' ||v_trs_agmt_rt_knd );          DBMS_OUTPUT.put_line('▶▶▶ PU vo_rt_cal_rtn_cd : ' ||vo_rt_cal_rtn_cd );          DBMS_OUTPUT.put_line('▶▶▶ PU vo_final_rt : ' ||vo_final_rt );                                                                                                                                                                                                                                                                                                                                                        IF (v_trs_agmt_rt_knd = MAS_BZC OR v_trs_agmt_rt_knd = MAS_SC_FU OR v_trs_agmt_rt_knd = 'ISG' OR v_trs_agmt_rt_knd = 'TF' OR v_trs_agmt_rt_knd = 'SCHLCF' OR v_trs_agmt_rt_knd = 'SCHLOP' ) AND v_vndr_eff_flag = 'Y' THEN                                                                                                                                                      IF debug_flg IN ('Y', 'T') OR (ASCII(debug_flg) BETWEEN 49 AND 57) THEN                                                                                                                                                                                                                                                                             IF (ASCII(v_tmp_outer_loop_cnt) = ASCII(debug_flg)) THEN                                                                                                                                                                                                                                                                                            DBMS_OUTPUT.put_line('[MAS] PCTL_NO = ['||v_pctl_no||'] - COST_ACT_GRP_SEQ = ['||v_cost_act_grp_seq||'] - CNTR_TPSZ_CD = ['||v_cntr_tpsz_cd||'] - MAS_COST_SRC_CD = ['||v_mas_cost_src_cd||'] <<< ['||TRS_AGMT_RATE_CSR%ROWCOUNT||'th updated! ***'||to_char(sysdate,'yyyy/mm/dd hh24:mi:ss')||'***');                                          DBMS_OUTPUT.put_line('[MAS] vo_rt_cal_rtn_cd =['||vo_rt_cal_rtn_cd||'],  way_type = ['||vo_way_type||'], vo_final_rt = ['||vo_final_rt||'], vo_curr_cd = ['||vo_curr_cd||']'||', vo_final_rt = ['||vo_final_rt||'] ___ '||TRS_AGMT_RATE_CSR%ROWCOUNT||'th updated! ***'||to_char(sysdate,'yyyy/mm/dd hh24:mi:ss')||'***');                  END IF;                                                                                                                                                                                                                                                                                                                                     ELSE                                                                                                                                                                                                                                                                                                                                                UPDATE     MAS_COM_COST_PARA  Y                                                                                                                                                                                                                                                                                                                 SET        Y.LOCL_CURR_CD     = CASE vo_rt_cal_rtn_cd WHEN 0   THEN vo_curr_cd    -- SUCCESS(RATE FOUND).                                                                                                                                                                                                                                                                                             ELSE ''                                                                                                                                                                                                                                                                                                                   END                                                                                                                                                                                                                                                                                                                      , Y.ESTM_UC_AMT      = CASE vo_rt_cal_rtn_cd WHEN 0   THEN vo_final_rt   -- SUCCESS(RATE FOUND).                                                                                                                                                                                                                                                                                             ELSE 0                                                                                                                                                                                                                                                                                                                    END                                                                                                                                                                                                                                                                                                                      , Y.RESPB_UC_AMT     = CASE vo_rt_cal_rtn_cd WHEN 0   THEN vo_final_rt   -- SUCCESS(RATE FOUND).                                                                                                                                                                                                                                                                                             ELSE 0                                                                                                                                                                                                                                                                                                                    END                                                                                                                                                                                                                                                                                                                      , Y.CTRT_RTN_FLG     = CASE vo_rt_cal_rtn_cd WHEN 0   THEN 'Y'           -- SUCCESS(RATE FOUND).                                                                                                                                                                                                                                                                                             ELSE 'N'                                                                                                                                                                                                                                                                                                                  END                                                                                                                                                                                                                                                                                                                      , Y.WTR_RCV_TERM_CD  = CASE vo_rt_cal_rtn_cd WHEN 0   THEN DECODE(vo_wtr_rcv_term_cd,'0','',vo_wtr_rcv_term_cd)  -- SUCCESS(RATE FOUND).                                                                                                                                                                                                                                                     ELSE ''                                                                                                                                                                                                                                                                                                                   END                                                                                                                                                                                                                                                                                                                      , Y.WTR_DE_TERM_CD   = CASE vo_rt_cal_rtn_cd WHEN 0   THEN DECODE(vo_wtr_de_term_cd,'0','',vo_wtr_de_term_cd)   -- SUCCESS(RATE FOUND).                                                                                                                                                                                                                                                      ELSE ''                                                                                                                                                                                                                                                                                                                   END                                                                                                                                                                                                                                                                                                                      , Y.TRSP_AGMT_WY_TP_CD = CASE vo_rt_cal_rtn_cd WHEN 0   THEN vo_way_type           -- SUCCESS(RATE FOUND).                                                                                                                                                                                                                                                                                   ELSE ''                                                                                                                                                                                                                                                                                                                     END                                                                                                                                                                                                                                                                                                                    , Y.TRSP_AGMT_RMK    = v_agmt_wgt||'$'                                                                                                                                                                                                                                                                                                          , Y.TRSP_AGMT_OLD_FLG = v_trsp_agmt_old_flg                                                                                                                                                                                                                                                                                            WHERE      Y.PCTL_NO          = v_pctl_no                                                                                                                                                                                                                                                                                                       AND        Y.COST_ACT_GRP_SEQ = v_cost_act_grp_seq                                                                                                                                                                                                                                                                                              AND        Y.CNTR_TPSZ_CD     IN (  v_cntr_tpsz_cd                                                                                                                                                                                                                                                                                                                                , DECODE(v_cntr_tpsz_cd, 'O4', DECODE(Y.CNTR_TPSZ_CD, 'O5', DECODE(SIGN(NVL(Y.ESTM_UC_AMT, 0)), 1, 'O5', 'XX')                                                                                                                                                                                                                                                                                       , 'XX')                                                                                                                                                                                                                                                                                                           , 'XX')                                                                                                                                                                                                                                                                                                                 )                                                                                                                                                                                                                                                                                                              AND        Y.MAS_COST_SRC_CD  = v_mas_cost_src_cd                                                                                                                                                                                                                                                                                               ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               IF SUBSTR(v_pctl_no, 1,1) IN ('H', 'F') THEN                                                                                                                                                                                                                                                                                                        UPDATE     MAS_COM_PARA  X                                                                                                                                                                                                                                                                                                                      SET        X.AGMT_MTY_PKUP_RTN_YD_CD = v_agmt_emy_pkup_rtn_yd_cd                                                                                                                                                                                                                                                                                WHERE      X.PCTL_NO                 = v_pctl_no                                                                                                                                                                                                                                                                                                ;                                                                                                                                                                                                                                                                                                                                           END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     END IF;                                                                                                                                                                                                                                                                                                                                     END IF;                                                                                                                                                                                                                                                                                                                                     END LOOP;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       po_rtn_cd   := 0;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               IF debug_flg IN ('Y', 'T') OR (ASCII(debug_flg) BETWEEN 49 AND 57)  THEN                                                                                                                                                                                                                                                                            DBMS_OUTPUT.PUT_LINE('[TRS_AGMT_APPLY_TO_MAS] : FINISHED TIME IS ' || to_char(sysdate,'yyyy/mm/dd hh24:mi:ss'));                                                                                                                                                                                                                            END IF;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     EXCEPTION                                                                                                                                                                                                                                                                                                                                           WHEN OTHERS THEN                                                                                                                                                                                                                                                                                                                                     po_rtn_cd := -1;                                                                                                                                                                                                                                                                                                                                DBMS_OUTPUT.PUT_LINE('%%TRS_AGMT_APPLY_TO_MAS_PRC%% <OTHERS> ERROR MSG = ['||SQLERRM||']');                                                                                                                                                                                                                                                RAISE;                                                                                                                                                                                                                                                                                                                                      END TRS_AGMT_APLY_TO_MAS_PRC;