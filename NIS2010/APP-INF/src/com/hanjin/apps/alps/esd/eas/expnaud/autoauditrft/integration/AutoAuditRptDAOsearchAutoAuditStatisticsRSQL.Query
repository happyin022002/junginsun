<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="AutoAuditRptDAOsearchAutoAuditStatisticsRSQL">
			<desc><![CDATA[Auto Audit Statistics 조회]]></desc>
			<sql><![CDATA[
WITH SRC AS (
    SELECT RHQ_CD
          ,INV_OFC_CD
          ,AUTO_EXPN_AUD_STS_CD
          ,AUTO_EXPN_AUD_STS_NM
          ,MDL_CD
          ,TOT_CNT
          ,CASE WHEN RNK = 1 THEN TOT_CNT_PER + (100 - SUM(TOT_CNT_PER) OVER (PARTITION BY MDL_CD, RHQ_CD, INV_OFC_CD ORDER BY 1))
                ELSE TOT_CNT_PER
           END TOT_CNT_PER
          ,TOT_AMT
          ,CASE WHEN RNK = 1 THEN TOT_AMT_PER + (100 - SUM(TOT_AMT_PER) OVER (PARTITION BY MDL_CD, RHQ_CD, INV_OFC_CD ORDER BY 1))
                ELSE TOT_AMT_PER
           END TOT_AMT_PER
          ,AUDIT_CNT
          ,CASE WHEN RNK = 1 THEN AUDIT_CNT_PER + (100 - SUM(AUDIT_CNT_PER) OVER (PARTITION BY MDL_CD, RHQ_CD, INV_OFC_CD ORDER BY 1))
                ELSE AUDIT_CNT_PER
           END AUDIT_CNT_PER
          ,AUDIT_AMT
          ,CASE WHEN RNK = 1 THEN AUDIT_AMT_PER + (100 - SUM(AUDIT_AMT_PER) OVER (PARTITION BY MDL_CD, RHQ_CD, INV_OFC_CD ORDER BY 1))
                ELSE AUDIT_AMT_PER
           END AUDIT_AMT_PER
          ,NO_AUDIT_CNT
          ,CASE WHEN RNK = 1 THEN NO_AUDIT_CNT_PER + (100 - SUM(NO_AUDIT_CNT_PER) OVER (PARTITION BY MDL_CD, RHQ_CD, INV_OFC_CD ORDER BY 1))
                ELSE NO_AUDIT_CNT_PER
           END NO_AUDIT_CNT_PER
          ,NO_AUDIT_AMT
          ,CASE WHEN RNK = 1 THEN NO_AUDIT_AMT_PER + (100 - SUM(NO_AUDIT_AMT_PER) OVER (PARTITION BY MDL_CD, RHQ_CD, INV_OFC_CD ORDER BY 1))
                ELSE NO_AUDIT_AMT_PER
           END NO_AUDIT_AMT_PER
           ,AUD_USD_DIFF_AMT
      FROM (
            SELECT RHQ_CD
                  ,INV_OFC_CD
                  ,AUTO_EXPN_AUD_STS_CD
                  ,(SELECT INTG_CD_VAL_DP_DESC FROM COM_INTG_CD_DTL X WHERE X.INTG_CD_ID = 'CD03417' AND INTG_CD_VAL_CTNT = AA.AUTO_EXPN_AUD_STS_CD) AUTO_EXPN_AUD_STS_NM  
                  ,MDL_CD
                  ,TOT_CNT
                  ,ROUND((TOT_CNT / SUM(TOT_CNT) OVER (PARTITION BY MDL_CD, RHQ_CD, INV_OFC_CD ORDER BY 1)) * 100, 2) TOT_CNT_PER
                  ,TOT_AMT
                  ,ROUND((TOT_AMT / SUM(TOT_AMT) OVER (PARTITION BY MDL_CD, RHQ_CD, INV_OFC_CD ORDER BY 1)) * 100, 2) TOT_AMT_PER
                  ,AUDIT_CNT
                  ,ROUND((AUDIT_CNT / SUM(AUDIT_CNT) OVER (PARTITION BY MDL_CD, RHQ_CD, INV_OFC_CD ORDER BY 1)) * 100, 2) AUDIT_CNT_PER
                  ,AUDIT_AMT
                  ,ROUND((AUDIT_AMT / SUM(AUDIT_AMT) OVER (PARTITION BY MDL_CD, RHQ_CD, INV_OFC_CD ORDER BY 1)) * 100, 2) AUDIT_AMT_PER
                  ,NO_AUDIT_CNT
                  ,ROUND((NO_AUDIT_CNT / SUM(NO_AUDIT_CNT) OVER (PARTITION BY MDL_CD, RHQ_CD, INV_OFC_CD ORDER BY 1)) * 100, 2) NO_AUDIT_CNT_PER
                  ,NO_AUDIT_AMT
                  ,ROUND((NO_AUDIT_AMT / SUM(NO_AUDIT_AMT) OVER (PARTITION BY MDL_CD, RHQ_CD, INV_OFC_CD ORDER BY 1)) * 100, 2) NO_AUDIT_AMT_PER
                  ,RANK() OVER (PARTITION BY MDL_CD, RHQ_CD, INV_OFC_CD ORDER BY MDL_CD, RHQ_CD, INV_OFC_CD, AUTO_EXPN_AUD_STS_CD) RNK
                  ,AUD_USD_DIFF_AMT
              FROM (
                    SELECT MDL_CD 
                          ,RHQ_CD
                           #if(${s_ofc_cd} == '')
                            ,RHQ_CD AS INV_OFC_CD
                           #else
                            ,INV_OFC_CD
                           #end
                          ,AUTO_EXPN_AUD_STS_CD
                          ,COUNT(1) TOT_CNT
                          ,ROUND(SUM(INV_AMT / US_XCH_RT), 2) AS TOT_AMT
                          ,SUM(AUDIT_CNT) AUDIT_CNT
                          ,ROUND(SUM(AUDIT_AMT / US_XCH_RT), 2) AS AUDIT_AMT
                          ,SUM(NO_AUDIT_CNT) NO_AUDIT_CNT
                          ,ROUND(SUM(NO_AUDIT_AMT / US_XCH_RT), 2) AS NO_AUDIT_AMT
                          ,SUM(AUD_USD_DIFF_AMT) AS AUD_USD_DIFF_AMT
                      FROM (
                            SELECT NULL MDL_CD
                                 , NULL RHQ_CD
                                 , NULL INV_OFC_CD 
                                 , NULL AUTO_EXPN_AUD_STS_CD
                                 , NULL EXPN_AUD_STS_CD
                                 , NULL EXPN_AUD_RSLT_CD
                                 , NULL CURR_CD
                                 , NULL INV_AMT 
                                 , NULL INV_CFM_DT 
                                 , NULL AUDIT_CNT
                                 , NULL AUDIT_AMT
                                 , NULL NO_AUDIT_CNT
                                 , NULL NO_AUDIT_AMT
                                 , NULL US_XCH_RT
                                 , NULL AUD_USD_DIFF_AMT
                             FROM DUAL
                            #if(${s_mdl_cd} == '' || ${s_mdl_cd} == 'TRS')
                            UNION ALL
                            SELECT 'TRS' MDL_CD 
                                 , RHQ_CD 
                                 , INV_OFC_CD 
                                 , AUTO_EXPN_AUD_STS_CD
                                 , EXPN_AUD_STS_CD
                                 , EXPN_AUD_RSLT_CD
                                 , CURR_CD
                                 , INV_AMT 
                                 , INV_CFM_DT 
                                 , (CASE WHEN EXPN_AUD_STS_CD IS NOT NULL THEN 1 END) AUDIT_CNT
                                 , (CASE WHEN EXPN_AUD_STS_CD IS NOT NULL THEN INV_AMT END) AUDIT_AMT
                                 , (CASE WHEN EXPN_AUD_STS_CD IS NULL THEN 1 END) NO_AUDIT_CNT
                                 , (CASE WHEN EXPN_AUD_STS_CD IS NULL THEN INV_AMT END) NO_AUDIT_AMT
                                 , CASE WHEN NVL(A.CURR_CD, 'USD') = 'USD' THEN 1
                                        ELSE (
                                             SELECT USD_LOCL_XCH_RT
                                               FROM GL_MON_XCH_RT XCH
                                              WHERE XCH.ACCT_XCH_RT_LVL = 1
                                                AND XCH.CURR_CD = A.CURR_CD
                                                AND XCH.ACCT_XCH_RT_YRMON = TO_CHAR(A.INV_CFM_DT, 'YYYYMM')
                                             )
                                   END US_XCH_RT
                                   , AUD_USD_DIFF_AMT
                              FROM EAS_TRSP_AUD A
                             WHERE A.INV_CFM_DT BETWEEN TO_DATE(REPLACE(@[s_inv_cfm_fm_dt],'-',''),'YYYYMMDD') AND TO_DATE(REPLACE(@[s_inv_cfm_to_dt],'-',''),'YYYYMMDD') + 0.99999
                               AND A.AUTO_EXPN_AUD_STS_CD IN ('S', 'F', 'C')
                               AND EXISTS (SELECT 'X'             
                                             FROM TRS_TRSP_INV_WRK X
                                                 ,AP_INV_HDR Y
                                            WHERE X.INV_NO       = A.INV_NO    
                                              AND X.INV_VNDR_SEQ = A.INV_VNDR_SEQ
                                              AND X.CSR_NO       = Y.CSR_NO(+)
                                              AND X.TRSP_INV_AUD_STS_CD <> 'RJ'
                                              AND Y.RCV_ERR_FLG(+) <> 'E'
                                            UNION ALL
                                           SELECT 'X'             
                                             FROM TRS_TRSP_RAIL_INV_WRK X
                                                 ,AP_INV_HDR Y
                                            WHERE X.INV_NO       = A.INV_NO    
                                              AND X.INV_VNDR_SEQ = A.INV_VNDR_SEQ
                                              AND X.CSR_NO       = Y.CSR_NO(+)
                                              AND X.TRSP_INV_AUD_STS_CD <> 'RJ'
                                              AND Y.RCV_ERR_FLG(+) <> 'E'
                                          )
                             #if(${s_rhq_ofc_cd} != '')
                               AND A.RHQ_CD = @[s_rhq_ofc_cd]
                             #end
                             #if(${s_ofc_cd} != '' && ${s_ofc_cd} != 'ALL')
                               AND A.INV_OFC_CD = @[s_ofc_cd]
                             #end
                             #if(${s_mdl_cd} == '' || ${s_mdl_cd} == 'TRS')
                               AND 1=1
                             #else
                               AND 1=2
                             #end

                             #if(${s_eac_if_flg} != '')
                               #if(${s_eac_if_flg} == 'Y')
                               AND EXISTS (SELECT 1
                                             FROM EAS_TRSP_AUD_CHK X
                                            WHERE X.INV_NO = A.INV_NO
                                              AND X.INV_VNDR_SEQ = A.INV_VNDR_SEQ
                                              AND X.TRSP_SO_TP_CD = A.TRSP_SO_TP_CD
                                          )
                               #else
                               AND NOT EXISTS (SELECT 1
                                                 FROM EAS_TRSP_AUD_CHK X
                                                WHERE X.INV_NO = A.INV_NO
                                                  AND X.INV_VNDR_SEQ = A.INV_VNDR_SEQ
                                                  AND X.TRSP_SO_TP_CD = A.TRSP_SO_TP_CD
                                              )
                               #end
                             #end
                            #end
                            #if(${s_mdl_cd} == '' || ${s_mdl_cd} == 'TES')
                            UNION ALL 
                            SELECT 'TES' MDL_CD 
                                 , A.RHQ_CD 
                                 , A.INV_OFC_CD 
                                 , A.AUTO_EXPN_AUD_STS_CD
                                 , A.EXPN_AUD_STS_CD 
                                 , A.EXPN_AUD_RSLT_CD 
                                 , A.CURR_CD 
                                 , A.INV_AMT
                                 , A.INV_CFM_DT 
                                 , (CASE WHEN A.EXPN_AUD_STS_CD IS NOT NULL THEN 1 END) AUDIT_CNT
                                 , (CASE WHEN A.EXPN_AUD_STS_CD IS NOT NULL THEN INV_AMT END) AUDIT_AMT
                                 , (CASE WHEN A.EXPN_AUD_STS_CD IS NULL THEN 1 END) NO_AUDIT_CNT
                                 , (CASE WHEN A.EXPN_AUD_STS_CD IS NULL THEN INV_AMT END) NO_AUDIT_AMT
                                 , CASE WHEN NVL(A.CURR_CD, 'USD') = 'USD' THEN 1
                                        ELSE (
                                             SELECT USD_LOCL_XCH_RT
                                               FROM GL_MON_XCH_RT XCH
                                              WHERE XCH.ACCT_XCH_RT_LVL = 1
                                                AND XCH.CURR_CD = A.CURR_CD
                                                AND XCH.ACCT_XCH_RT_YRMON = TO_CHAR(A.INV_CFM_DT, 'YYYYMM')
                                             )
                                   END US_XCH_RT
                                   , AUD_USD_DIFF_AMT
                              FROM EAS_TML_AUD A
                                 , TES_TML_SO_HDR H
                                 , AP_INV_HDR AH
                             WHERE 1 = 1
                               AND A.YD_CD   = H.YD_CD
                               AND A.VNDR_SEQ  = H.VNDR_SEQ
                               AND A.INV_NO  = H.INV_NO
                               AND A.INV_CFM_DT = H.INV_CFM_DT
                               AND NVL(H.DELT_FLG, 'N')    = 'N'
                               -- Detail중 한건이라도 Estimation 물량집계 데이타가 있는 데이타를 기본으로 보여주고 Estimation 물량이 없을 경우 Confirm후 14일 이후 심사대상으로 조회한다.
                               -- Estimation 물량이 없을 경우 Confirm후 5일 이후 심사대상으로 조회한다. 2017.08.11
                               -- Confirm후 5일이후 조건 잠시 삭제 2018.05.03
                               AND ( ((NVL(A.AUD_DTL_TGT_QTY, 0) - NVL(A.BAT_ESTM_VOL_RSLT_CD_QTY, 0)) > 0) 
                               OR  ( ((NVL(A.AUD_DTL_TGT_QTY, 0) - NVL(A.BAT_ESTM_VOL_RSLT_CD_QTY, 0)) = 0) 
                               -- AND  A.INV_CFM_DT < SYSDATE - 5
                                ))
                               AND H.CSR_NO  = AH.CSR_NO(+)
                               AND H.TML_INV_STS_CD <> 'R'
                               AND H.TML_INV_RJCT_STS_CD <> 'RJ'
                               AND AH.RCV_ERR_FLG(+) <> 'E'
                               AND A.INV_CFM_DT BETWEEN TO_DATE(REPLACE(@[s_inv_cfm_fm_dt],'-',''),'YYYYMMDD') AND TO_DATE(REPLACE(@[s_inv_cfm_to_dt],'-',''),'YYYYMMDD') + 0.99999
                               AND A.AUTO_EXPN_AUD_STS_CD IN ('S', 'F', 'C')
                             #if(${s_rhq_ofc_cd} != '')
                               AND A.RHQ_CD = @[s_rhq_ofc_cd]
                             #end
                             #if(${s_ofc_cd} != '' && ${s_ofc_cd} != 'ALL')
                               AND A.INV_OFC_CD = @[s_ofc_cd]
                             #end
                             #if(${s_mdl_cd} == '' || ${s_mdl_cd} == 'TES')
                               AND 1=1
                             #else
                               AND 1=2
                             #end

                             #if(${s_eac_if_flg} != '')
                               #if(${s_eac_if_flg} == 'Y')
                               AND EXISTS (SELECT 1
                                             FROM EAS_TML_AUD_DTL X
                                            WHERE X.INV_NO = A.INV_NO
                                              AND X.VNDR_SEQ = A.VNDR_SEQ
                                              AND X.INV_CFM_DT = A.INV_CFM_DT
                                              AND X.EXPN_AUD_SEQ = A.EXPN_AUD_SEQ
                                          )
                               #else
                               AND NOT EXISTS (SELECT 1
                                                 FROM EAS_TML_AUD_DTL X
                                                WHERE X.INV_NO = A.INV_NO
                                                  AND X.VNDR_SEQ = A.VNDR_SEQ
                                                  AND X.INV_CFM_DT = A.INV_CFM_DT
                                                  AND X.EXPN_AUD_SEQ = A.EXPN_AUD_SEQ
                                              )
                               #end
                             #end
                            #end
                            #if(${s_mdl_cd} == '' || ${s_mdl_cd} == 'MNR')
                            UNION ALL 
                            SELECT 'MNR' MDL_CD
                                 , A.RHQ_CD 
                                 , A.INV_OFC_CD 
                                 , A.AUTO_EXPN_AUD_STS_CD 
                                 , A.EXPN_AUD_STS_CD 
                                 , A.EXPN_AUD_RSLT_CD 
                                 , A.CURR_CD 
                                 , A.INV_AMT 
                                 , A.INV_CFM_DT 
                                 , (CASE WHEN A.EXPN_AUD_STS_CD IS NOT NULL THEN 1 END) AUDIT_CNT
                                 , (CASE WHEN A.EXPN_AUD_STS_CD IS NOT NULL THEN INV_AMT END) AUDIT_AMT
                                 , (CASE WHEN A.EXPN_AUD_STS_CD IS NULL THEN 1 END) NO_AUDIT_CNT
                                 , (CASE WHEN A.EXPN_AUD_STS_CD IS NULL THEN INV_AMT END) NO_AUDIT_AMT
                                 , CASE WHEN NVL(A.INV_CURR_CD, 'USD') = 'USD' THEN 1
                                        ELSE (
                                             SELECT USD_LOCL_XCH_RT
                                               FROM GL_MON_XCH_RT XCH
                                              WHERE XCH.ACCT_XCH_RT_LVL = 1
                                                AND XCH.CURR_CD = A.INV_CURR_CD
                                                AND XCH.ACCT_XCH_RT_YRMON = TO_CHAR(A.INV_CFM_DT, 'YYYYMM')
                                             )
                                   END US_XCH_RT 
                                   , AUD_USD_DIFF_AMT
                              FROM EAS_MNR_CFM_INV A
                                 , AP_PAY_INV B
                                 , AP_INV_HDR C
                                 , MDM_VENDOR D
                                 , MNR_PAY_INV_WRK E
                             WHERE A.INV_RGST_NO = B.INV_RGST_NO
                               AND B.CSR_NO = C.CSR_NO(+)
                               AND A.VNDR_SEQ = D.VNDR_SEQ
                               AND A.INV_RGST_NO = E.INV_RGST_NO
                               AND E.MNR_INV_STS_CD = 'HC'
                               AND C.RCV_ERR_FLG(+) IS NULL --E(AP REJECT) OR NULL
                               AND C.IF_FLG(+) IS NULL -- Y(정상) E(ERROR) NULL(진행안함)
                               AND C.AFT_ACT_FLG(+) IS NULL -- N(CANCEL) X(CANCEL : ) NULL(정상)
                               AND A.INV_CFM_DT BETWEEN TO_DATE(REPLACE(@[s_inv_cfm_fm_dt],'-',''),'YYYYMMDD') AND TO_DATE(REPLACE(@[s_inv_cfm_to_dt],'-',''),'YYYYMMDD') + 0.99999
                               AND A.AUTO_EXPN_AUD_STS_CD IN ('S', 'F', 'C')
                             #if(${s_rhq_ofc_cd} != '')
                               AND A.RHQ_CD = @[s_rhq_ofc_cd]
                             #end
                             #if(${s_ofc_cd} != '' && ${s_ofc_cd} != 'ALL')
                               AND A.INV_OFC_CD = @[s_ofc_cd]
                             #end
                             #if(${s_mdl_cd} == '' || ${s_mdl_cd} == 'MNR')
                               AND 1=1
                             #else
                               AND 1=2
                             #end

                             #if(${s_eac_if_flg} != '')
                               #if(${s_eac_if_flg} == 'Y')
                               AND EXISTS (SELECT 1
                                             FROM EAS_MNR_CFM_INV_DTL X
                                            WHERE X.INV_NO = A.INV_NO
                                              AND X.VNDR_SEQ = A.VNDR_SEQ
                                              AND X.EQ_KND_CD = A.EQ_KND_CD
                                          )
                               #else
                               AND NOT EXISTS (SELECT 1
                                                 FROM EAS_MNR_CFM_INV_DTL X
                                                WHERE X.INV_NO = A.INV_NO
                                                  AND X.VNDR_SEQ = A.VNDR_SEQ
                                                  AND X.EQ_KND_CD = A.EQ_KND_CD
                                              )
                               #end
                             #end
                            #end
                            #if(${s_mdl_cd} == '' || ${s_mdl_cd} == 'PSO')
                            UNION ALL
                            SELECT 'PSO' MDL_CD
                                 , RHQ_CD
                                 , INV_OFC_CD
                                 , AUTO_EXPN_AUD_STS_CD
                                 , EXPN_AUD_STS_CD
                                 , EXPN_AUD_RSLT_CD
                                 , CURR_CD
                                 , INV_AMT
                                 , INV_CFM_DT
                                 , (CASE WHEN PORT_CHG_AUD_CHK_CD IS NOT NULL THEN 1 END) AUDIT_CNT
                                 , (CASE WHEN PORT_CHG_AUD_CHK_CD IS NOT NULL THEN INV_AMT END) AUDIT_AMT
                                 , (CASE WHEN PORT_CHG_AUD_CHK_CD IS NULL THEN 1 END) NO_AUDIT_CNT
                                 , (CASE WHEN PORT_CHG_AUD_CHK_CD IS NULL THEN INV_AMT END) NO_AUDIT_AMT
                                 , CASE WHEN NVL(AB.CURR_CD, 'USD') = 'USD' THEN 1
                                        ELSE (
                                             SELECT USD_LOCL_XCH_RT
                                               FROM GL_MON_XCH_RT XCH
                                              WHERE XCH.ACCT_XCH_RT_LVL = 1
                                                AND XCH.CURR_CD = AB.CURR_CD
                                                AND XCH.ACCT_XCH_RT_YRMON = TO_CHAR(AB.INV_CFM_DT, 'YYYYMM')
                                             )
                                   END US_XCH_RT
                                   , AUD_USD_DIFF_AMT
                              FROM (
                                    SELECT MAX(A.RHQ_CD) AS RHQ_CD
                                         , MAX(A.INV_OFC_CD) AS INV_OFC_CD
                                         , MAX(A.AUTO_EXPN_AUD_STS_CD) AS AUTO_EXPN_AUD_STS_CD
                                         , MAX(A.PORT_CHG_AUD_CHK_CD) AS EXPN_AUD_STS_CD 
                                         , MAX(A.EXPN_AUD_RSLT_CD) AS  EXPN_AUD_RSLT_CD
                                         , MAX(A.CURR_CD) AS CURR_CD
                                         , MAX(A.INV_AMT) AS INV_AMT
                                         , MAX(A.INV_CFM_DT) AS INV_CFM_DT
                                         , MAX(A.PORT_CHG_AUD_CHK_CD) AS PORT_CHG_AUD_CHK_CD
                                         , A.ISS_CTY_CD
                                         , A.SO_SEQ
                                         , A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD VVD
                                         , A.LGS_COST_CD 
                                         , A.AUD_USD_DIFF_AMT
                                      FROM EAS_PORT_SO_CFM_INV A
                                         , TES_LGS_COST C
                                         , MDM_ACCOUNT MA
                                         , EAS_PORT_SO_CHG_ACCT CS
                                         , AP_PAY_INV AI
                                         , AP_INV_HDR AH
                                         , PSO_CHARGE PSO
                                         , EAS_AUTO_AUD_BAT B
                                     WHERE 1 = 1
                                       AND A.ACCT_CD = MA.ACCT_CD
                                       AND A.LGS_COST_CD = C.LGS_COST_CD
                                       AND A.RHQ_CD = CS.AUD_OFC_CD
                                       AND A.LGS_COST_CD = CS.LGS_COST_CD
                                       AND A.ISS_CTY_CD = PSO.ISS_CTY_CD 
                                       AND A.SO_SEQ = PSO.SO_SEQ
                                       AND PSO.INV_RGST_NO  = AI.INV_RGST_NO
                                       AND AI.CSR_NO       = AH.CSR_NO(+)
                                       AND B.SUB_SYS_CD(+) = 'PSO'
                                       AND A.ISS_CTY_CD   = B.ISS_CTY_CD(+)
                                       AND A.SO_SEQ       = B.SO_SEQ(+)
                                       AND A.SO_DTL_SEQ   = B.SO_DTL_SEQ(+)
                               AND LENGTH(A.LGS_COST_CD) = 6
                               AND C.ACCT_CD NOT IN ('999999', '511795')
                               AND ((SUBSTR(C.ACCT_CD,0,4) IN ('5117', '5118', '5119') AND CS.LGS_COST_AUD_FLG = 'Y'))
                               AND A.INV_CFM_DT BETWEEN TO_DATE(REPLACE(@[s_inv_cfm_fm_dt],'-',''),'YYYYMMDD') AND TO_DATE(REPLACE(@[s_inv_cfm_to_dt],'-',''),'YYYYMMDD') + 0.99999
                               AND A.AUTO_EXPN_AUD_STS_CD IN ('S', 'F', 'C')
                               AND NVL(AH.RCV_ERR_FLG, 'X') <> 'E'
                             #if(${s_rhq_ofc_cd} != '')
                               AND A.RHQ_CD = @[s_rhq_ofc_cd]
                             #end
                             #if(${s_ofc_cd} != '' && ${s_ofc_cd} != 'ALL')
                               AND A.INV_OFC_CD = @[s_ofc_cd]
                             #end
                             #if(${s_mdl_cd} == '' || ${s_mdl_cd} == 'PSO')
                               AND 1=1
                             #else
                               AND 1=2
                             #end

                             #if(${s_eac_if_flg} != '')
                               #if(${s_eac_if_flg} == 'Y')
                                 AND A.EAC_NO IS NOT NULL
                               #else
                                 AND A.EAC_NO IS NULL
                               #end
                             #end
                            GROUP BY A.ISS_CTY_CD
                                   , A.SO_SEQ
                                   , A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD
                                   , A.LGS_COST_CD
                                   , A.AUD_USD_DIFF_AMT 
                             ) AB
                           #end
                           )
                     WHERE MDL_CD IN ('TRS', 'TES', 'MNR', 'PSO')
                     GROUP BY 
                           MDL_CD 
                          ,RHQ_CD 
                           #if(${s_ofc_cd} == '')
                            ,RHQ_CD
                           #else
                            ,INV_OFC_CD
                           #end
                          ,AUTO_EXPN_AUD_STS_CD 
                   ) AA
    ) AAA
)

SELECT RHQ_CD
      ,INV_OFC_CD
      ,AUTO_EXPN_AUD_STS_NM
      ,MDL_CD
      ,TOT_CNT
      ,TOT_CNT_PER
      ,TOT_AMT
      ,TOT_AMT_PER
      ,AUDIT_CNT
      ,ROUND(AUDIT_CNT / ((NVL(AUDIT_CNT,0) + NVL(NO_AUDIT_CNT,0))) * 100,2) AUDIT_CNT_PER
      ,AUDIT_AMT
      ,ROUND(AUDIT_AMT / ((NVL(AUDIT_AMT,0) + NVL(NO_AUDIT_AMT,0))) * 100,2) AUDIT_AMT_PER
      ,NO_AUDIT_CNT
      ,ROUND(NO_AUDIT_CNT / ((NVL(AUDIT_CNT,0) + NVL(NO_AUDIT_CNT,0))) * 100,2) NO_AUDIT_CNT_PER
      ,NO_AUDIT_AMT
      ,ROUND(NO_AUDIT_AMT / ((NVL(AUDIT_AMT,0) + NVL(NO_AUDIT_AMT,0))) * 100,2) NO_AUDIT_AMT_PER
      ,TP_CD
      ,RHQ_ORD
      ,INV_OFC_ORD
      ,MDL_CD_ORD
      ,AUTO_EXPN_AUD_STS_CD
      ,AUD_USD_DIFF_AMT
  FROM (
        SELECT RHQ_CD
              ,INV_OFC_CD
              ,AUTO_EXPN_AUD_STS_NM
              ,MDL_CD
              ,TOT_CNT
              ,TOT_CNT_PER
              ,TOT_AMT
              ,TOT_AMT_PER
              ,AUDIT_CNT
              ,AUDIT_CNT_PER
              ,AUDIT_AMT
              ,AUDIT_AMT_PER
              ,NO_AUDIT_CNT
              ,NO_AUDIT_CNT_PER
              ,NO_AUDIT_AMT
              ,NO_AUDIT_AMT_PER
              ,1 TP_CD
              ,RHQ_CD AS RHQ_ORD
              ,INV_OFC_CD AS INV_OFC_ORD
              ,MDL_CD MDL_CD_ORD
              ,AUTO_EXPN_AUD_STS_CD
              ,AUD_USD_DIFF_AMT
          FROM SRC
         WHERE 1=1
         #if(${s_auto_expn_aud_sts_cd} != '')
         AND AUTO_EXPN_AUD_STS_CD = @[s_auto_expn_aud_sts_cd]
         #end
#if(${s_auto_expn_aud_sts_cd} == '')
        UNION ALL
        SELECT 'Sub Total' RHQ_CD
              ,'' INV_OFC_CD
              ,'' AUTO_EXPN_AUD_STS_NM
              ,NULL MDL_CD
              ,SUM(TOT_CNT) AS TOT_CNT
              ,SUM(TOT_CNT_PER) AS TOT_CNT_PER
              ,SUM(TOT_AMT) AS TOT_AMT
              ,SUM(TOT_AMT_PER) AS TOT_AMT_PER
              ,SUM(AUDIT_CNT) AS AUDIT_CNT
              ,SUM(AUDIT_CNT_PER) AS AUDIT_CNT_PER
              ,SUM(AUDIT_AMT) AS AUDIT_AMT
              ,SUM(AUDIT_AMT_PER) AS AUDIT_AMT_PER
              ,SUM(NO_AUDIT_CNT) AS NO_AUDIT_CNT
              ,SUM(NO_AUDIT_CNT_PER) AS NO_AUDIT_CNT_PER
              ,SUM(NO_AUDIT_AMT) AS NO_AUDIT_AMT
              ,SUM(NO_AUDIT_AMT_PER) AS NO_AUDIT_AMT_PER
              ,2 TP_CD
              ,RHQ_CD AS RHQ_ORD
              ,INV_OFC_CD AS INV_OFC_ORD
              ,MDL_CD MDL_CD_ORD
              ,'' AUTO_EXPN_AUD_STS_CD
              ,SUM(AUD_USD_DIFF_AMT) AUD_USD_DIFF_AMT
          FROM SRC
         WHERE 1=1
         #if(${s_auto_expn_aud_sts_cd} != '')
         AND AUTO_EXPN_AUD_STS_CD = @[s_auto_expn_aud_sts_cd]
         #end
         GROUP BY RHQ_CD, INV_OFC_CD, MDL_CD
#end
        UNION ALL
        SELECT 'Grand Total' AS RHQ_CD
              ,NULL INV_OFC_CD
              ,AUTO_EXPN_AUD_STS_NM
              ,NULL MDL_CD
              ,TOT_CNT
              ,CASE WHEN RNK = 1 THEN TOT_CNT_PER + (100 - SUM(TOT_CNT_PER) OVER (ORDER BY 1))
                    ELSE TOT_CNT_PER
               END TOT_CNT_PER
              ,TOT_AMT
              ,CASE WHEN RNK = 1 THEN TOT_AMT_PER + (100 - SUM(TOT_AMT_PER) OVER (ORDER BY 1))
                    ELSE TOT_AMT_PER
               END TOT_AMT_PER
              ,AUDIT_CNT
              ,NULL AS AUDIT_CNT_PER
              ,AUDIT_AMT
              ,NULL AS AUDIT_AMT_PER
              ,NO_AUDIT_CNT
              ,NULL AS NO_AUDIT_CNT_PER
              ,NO_AUDIT_AMT
              ,NULL AS NO_AUDIT_AMT_PER
              ,3 TP_CD
              ,'XXXXX' AS RHQ_ORD
              ,'XXXXX' AS INV_OFC_ORD
              ,NULL MDL_CD_ORD
              ,AUTO_EXPN_AUD_STS_CD
              ,AUD_USD_DIFF_AMT
          FROM (
                SELECT AUTO_EXPN_AUD_STS_NM
                      ,TOT_CNT
                      ,ROUND((TOT_CNT / SUM(TOT_CNT) OVER (ORDER BY 1)) * 100, 2) TOT_CNT_PER
                      ,TOT_AMT
                      ,ROUND((TOT_AMT / SUM(TOT_AMT) OVER (ORDER BY 1)) * 100, 2) TOT_AMT_PER
                      ,AUDIT_CNT
                      ,AUDIT_AMT
                      ,NO_AUDIT_CNT
                      ,NO_AUDIT_AMT
                      ,AUTO_EXPN_AUD_STS_CD
                      ,RANK() OVER (ORDER BY AUTO_EXPN_AUD_STS_CD) RNK
                      ,AUD_USD_DIFF_AMT
                  FROM (
                
                         SELECT AUTO_EXPN_AUD_STS_NM
                               ,SUM(TOT_CNT) AS TOT_CNT
                               ,SUM(TOT_AMT) AS TOT_AMT
                               ,SUM(AUDIT_CNT) AS AUDIT_CNT
                               ,SUM(AUDIT_AMT) AS AUDIT_AMT
                               ,SUM(NO_AUDIT_CNT) AS NO_AUDIT_CNT
                               ,SUM(NO_AUDIT_AMT) AS NO_AUDIT_AMT
                               ,AUTO_EXPN_AUD_STS_CD
                               ,SUM(AUD_USD_DIFF_AMT) AS AUD_USD_DIFF_AMT
                           FROM SRC
                          WHERE 1=1
                          #if(${s_auto_expn_aud_sts_cd} != '')
                            AND AUTO_EXPN_AUD_STS_CD = @[s_auto_expn_aud_sts_cd]
                          #end
                          GROUP BY AUTO_EXPN_AUD_STS_CD, AUTO_EXPN_AUD_STS_NM
                       )  
               )
        UNION ALL
        SELECT 'G.Total Sum' RHQ_CD
              ,'' INV_OFC_CD
              ,'' AUTO_EXPN_AUD_STS_NM
              ,'' MDL_CD
              ,SUM(TOT_CNT) AS TOT_CNT
              ,100 AS TOT_CNT_PER
              ,SUM(TOT_AMT) AS TOT_AMT
              ,100 AS TOT_AMT_PER
              ,SUM(AUDIT_CNT) AS AUDIT_CNT
              ,NULL AS AUDIT_CNT_PER
              ,SUM(AUDIT_AMT) AS AUDIT_AMT
              ,NULL AS AUDIT_AMT_PER
              ,SUM(NO_AUDIT_CNT) AS NO_AUDIT_CNT
              ,NULL AS NO_AUDIT_CNT_PER
              ,SUM(NO_AUDIT_AMT) AS NO_AUDIT_AMT
              ,NULL AS NO_AUDIT_AMT_PER
              ,4 TP_CD
              ,'XXXXX' AS RHQ_ORD
              ,'XXXXX' AS INV_OFC_ORD
              ,NULL MDL_CD_ORD
              ,NULL EXPN_AUD_STS_CD
              ,SUM(AUD_USD_DIFF_AMT) AUD_USD_DIFF_AMT
          FROM SRC
         WHERE 1=1
         #if(${s_auto_expn_aud_sts_cd} != '')
         AND AUTO_EXPN_AUD_STS_CD = @[s_auto_expn_aud_sts_cd]
         #end
)
ORDER BY RHQ_ORD, INV_OFC_ORD, MDL_CD_ORD, TP_CD,AUTO_EXPN_AUD_STS_NM
/*
SELECT
  '' RHQ_CD
, '' INV_OFC_CD
, '' AUTO_EXPN_AUD_STS_NM
, '' MDL_CD
, '' TOT_CNT
, '' TOT_CNT_PER
, '' TOT_AMT
, '' TOT_AMT_PER
, '' AUDIT_CNT
, '' AUDIT_CNT_PER
, '' AUDIT_AMT
, '' AUDIT_AMT_PER
, '' NO_AUDIT_CNT
, '' NO_AUDIT_CNT_PER
, '' NO_AUDIT_AMT
, '' NO_AUDIT_AMT_PER
, '' TP_CD
, '' RHQ_ORD
, '' INV_OFC_ORD
, '' MDL_CD_ORD
, '' AUTO_EXPN_AUD_STS_CD
, '' S_RHQ_OFC_CD
, '' S_OFC_CD
, '' S_INV_CFM_FM_DT
, '' S_INV_CFM_TO_DT
, '' S_MDL_CD
, '' S_AUTO_EXPN_AUD_STS_CD
, '' S_EAC_IF_FLG
 FROM DUAL
*/			]]></sql>
			<params>
				<param name="s_inv_cfm_fm_dt" type="12" value="" out="N"/>
				<param name="s_inv_cfm_to_dt" type="12" value="" out="N"/>
				<param name="s_rhq_ofc_cd" type="12" value="" out="N"/>
				<param name="s_ofc_cd" type="12" value="" out="N"/>
				<param name="s_auto_expn_aud_sts_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
