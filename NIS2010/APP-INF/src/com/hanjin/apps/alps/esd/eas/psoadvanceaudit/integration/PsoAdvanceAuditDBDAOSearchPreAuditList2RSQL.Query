<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="PsoAdvanceAuditDBDAOSearchPreAuditList2RSQL">
			<desc><![CDATA[* 2016.03.25 CHM-201640191 Split02-Auto Audit - Invoice Batch 개발 요청
  RMK 오류(컬럼명 DIFF) 수정
2016.06.14 CHM-201642096 (긴급) EAS Auto Audit Performnace 수정 요청(A/P Rjected 대상 제외)]]></desc>
			<sql><![CDATA[
SELECT * FROM (
SELECT '' SEL, '' IBFLAG, '' SELECT_FLG
     , T1.ISS_CTY_CD
     , T1.SO_SEQ
     , MAX(T1.SO_DTL_SEQ) SO_DTL_SEQ
     , MAX(T1.EAC_NO) EAC_NO
     , MAX(T1.VSL_CD) VSL_CD
     , MAX(T1.CNTR_VSL_CLSS_CAPA) CNTR_VSL_CLSS_CAPA
     , MAX(T1.PORT_CHG_AUD_CHK_CD) AS SELECT_FLG_TEMP
	 --, '계산' AUTO_AUDIT_FLG --AUTO_EXPN_AUD_STS_CD
     , MAX(T1.AUTO_EXPN_AUD_STS_CD )                  AS AUTO_AUDIT_FLG
     , MAX(T1.RHQ_CD   )                              AS RHQ
     , MAX(T1.INV_OFC_CD  )                           AS OFFICE
     , MAX(SUBSTR(T1.YD_CD,1,5) )                     AS PORT
     , MAX(T1.YD_CD   )                               AS YARD
     , T1.VSL_CD||T1.SKD_VOY_NO||T1.SKD_DIR_CD        AS VVD
     , MAX(DECODE(T1.DP_IO_BND_CD, 'I', 'IN', 'O', 'OUT', 'IN/OUT')) AS BOUND
     , MAX(T1.VPS_ETB_DT    )  AS VPS_ATB_DT
     , MAX(T1.ACCT_CD) ACCT_CD
     , MAX(MA.ACCT_ENG_NM) AS ACCT_NM
     , T1.LGS_COST_CD AS COST_CD
     , C.LGS_COST_FULL_NM AS COST_NM
     , MAX(T1.VNDR_SEQ )                               AS SP_NO
     , MAX(T1.INV_NO) INV_NO
--     , (SELECT X.USR_NM FROM COM_USER X WHERE X.USR_ID = CRE_USR_ID) AS CRE_USR_ID
     , MAX((SELECT X.USR_NM FROM COM_USER X WHERE X.USR_ID = T1.INV_CRE_USR_ID)) AS CRE_USR_ID 
     , MAX(TO_CHAR(T1.ISS_DT,'YYYY-MM-DD'))    ISS_DT
     , MAX(T1.CURR_CD) CURR_CD
     , MAX(T1.CALC_AMT)                               AS TARIFF_COST
     , MAX(DECODE(T1.CALC_AMT, NULL, DECODE(T1.ADJ_AMT, NULL, T1.LOCL_AMT, T1.ADJ_AMT), T1.ADJ_AMT)) AS ADJCOST
     --, T1.LOCL_AMT                               AS AMOUNT
     , MAX(INV_AMT)                                AS AMOUNT
     --, MAX(T1.DIFF_AMT)                             DIFF
     --, MAX(T1.DIFF_AMT)                             DIFF
     , CASE WHEN NVL(MAX(T1.CALC_AMT),0) = 0 THEN NULL ELSE 
		ROUND((MAX(INV_AMT) - MAX(T1.CALC_AMT)) / MAX(T1.CALC_AMT) * 100 , 2 ) END DIFF
     , MAX(T1.FOML_DESC)                              AS FOML1
     , MAX(T1.XPR_DESC )                              AS FOML2
     , MAX(T1.DIFF_RMK)                               AS RMK
------------
#if (${chargeType} == '00' || ${chargeType} == '01' || ${chargeType} == '02')
------------ chargetype '00', '01', '02'
     , MAX(T1.BRTH_HRS) AS BERTHING_HOUR
     , MAX(SUBSTR(T1.ST_PORT_CD, 0, 2)) COUNTRY_OF_NP
     , MAX(T1.NET_RGST_TONG_WGT) AS NRT
     , MAX(T1.ARR_TUG_BOT_KNT) ARR_TUG_BOT_KNT
     , MAX(T1.DEP_TUG_BOT_KNT) DEP_TUG_BOT_KNT
#end    
#if (${chargeType} == '00' || ${chargeType} == '01' || ${chargeType} == '02' || ${chargeType} == '03')
------------ chargetype '00', '01', '02', '03'
     , MAX(T1.GRS_RGST_TONG_WGT) AS GRT 
     , MAX(T1.LST_PORT_CD  )   LAST_PORT--LST_PORT_CD
#end
#if (${chargeType} == '00' || ${chargeType} == '03')
------------ chargetype '00', '03'
     , MAX(T1.SUZ_GT_WGT) SUZ_GT_WGT
     , MAX(T1.MADN_VOY_SUZ_NET_TONG_WGT) MADN_VOY_SUZ_NET_TONG_WGT
	 , '' AS NIGHT_FLG
     , MAX(T1.SDR_XCH_RT) SDR_RT
     , MAX(T1.VSL_TR_NO) SCG_CAR_TIER
#end     
     , MAX(DECODE(T1.PORT_CHG_AUD_CHK_CD,'','',(SELECT X.USR_NM FROM COM_USER X WHERE X.USR_ID = T1.UPD_USR_ID))) AS UPD_USR_ID
     , MAX(DECODE(T1.PORT_CHG_AUD_CHK_CD,'','',(SELECT X.USR_NM FROM COM_USER X WHERE X.USR_ID = T1.PORT_CHG_AUD_USR_ID))) AS AUDIT_USR_ID --심사자
     , MAX(DECODE(T1.PORT_CHG_AUD_CHK_CD,'','',TO_CHAR(PORT_CHG_AUD_DT, 'YYYY-MM-DD'))) AUDIT_DT --심사일
     , MAX(T1.PORT_CHG_AUD_RSLT_RMK) PORT_CHG_AUD_RSLT_RMK
     , MAX(T1.PORT_CHG_AUD_RSLT_USR_ID) PORT_CHG_AUD_RSLT_USR_ID
     , MAX((SELECT X.USR_NM FROM COM_USER X WHERE X.USR_ID = T1.PORT_CHG_AUD_RSLT_USR_ID)) AS PORT_CHG_AUD_RSLT_USR_NM
     , MAX(T1.PAY_TERM_DYS) PAY_TERM_DYS
     , MAX(AI.CSR_NO)    CSR_NO -- INV 테이블 걸어서 실시간으로
     , MAX(TO_CHAR(AI.PAY_DUE_DT, 'YYYY-MM-DD')) PAY_DUE_DT-- INV 테이블 걸어서 실시간으로 하거나 없으면 PAY_TERM_DYS로 계산해서 사용
     , MAX(AI.AP_PAY_DT) AP_PAY_DT -- INV 테이블 걸어서 실시간으로
     --, MAX(TO_CHAR(T1.UPD_DT,'YYYY-MM-DD')) UPD_DT
     , MAX(TO_CHAR(T1.INV_CFM_DT,'YYYY-MM-DD')) upd_dt --INV_CFM_DT -- Invoice Confirmed
     , MAX(T1.ATCH_FILE_LNK_ID) ATCH_FILE_LNK_ID
     , MAX(T1.EXPN_AUD_RSLT_CD) EXPN_AUD_RSLT_CD
     --, FLET_CTRT_TP_CD
     , MAX(B.BAT_PROG_STS_CD) bat_prog_sts_cd -- 배치상태 코드
     , DECODE(MAX(B.BAT_PROG_STS_CD), 'P', 'Progressing', 'B','Created') bat_prog_sts_NM-- 배치상태 코드 
	 , AUD_CURR_CD AS INV_AUD_CURR_CD
	 , AUD_DIFF_AMT AS INV_AUD_DIFF_AMT
	 , AUD_USD_DIFF_AMT AS INV_AUD_USD_DIFF_AMT
  FROM EAS_PORT_SO_CFM_INV T1, TES_LGS_COST C, MDM_ACCOUNT MA, EAS_PORT_SO_CHG_ACCT CS
       , AP_PAY_INV AI
       , AP_INV_HDR AH
       , PSO_CHARGE PSO
       , EAS_AUTO_AUD_BAT B
WHERE T1.ACCT_CD = MA.ACCT_CD
AND T1.LGS_COST_CD = C.LGS_COST_CD
AND T1.RHQ_CD = CS.AUD_OFC_CD
AND T1.LGS_COST_CD = CS.LGS_COST_CD
AND T1.ISS_CTY_CD = PSO.ISS_CTY_CD 
AND T1.SO_SEQ = PSO.SO_SEQ
AND PSO.INV_RGST_NO  = AI.INV_RGST_NO
AND AI.CSR_NO       = AH.CSR_NO(+)
AND B.SUB_SYS_CD(+) = 'PSO'
AND T1.ISS_CTY_CD   = B.ISS_CTY_CD(+)
AND T1.SO_SEQ       = B.SO_SEQ(+)
AND T1.SO_DTL_SEQ   = B.SO_DTL_SEQ(+)
--검색조건
#if ( ${rhq} !='' )
--RHQ
AND RHQ_CD      = @[rhq]
#end

#if ( ${csr_no} !='' )
--CSR NO
AND AI.CSR_NO IN (
 #foreach( ${key} IN ${csrNos}) 
   #if($velocityCount < $csrNos.size()) 
     '${key}',
   #else 
     '${key}'
   #end 
 #end
 )
#end

#if (${inv_no} != '')
--INV NO
 AND T1.INV_NO IN (
 #foreach( ${key} IN ${invNos}) 
   #if($velocityCount < $invNos.size()) 
     '${key}',
   #else 
     '${key}'
   #end 
 #end
 )
#end

#if ( ${auditStatus} !='ALL' && ${diffNum} !='')
--audit status
AND EXISTS  (
   SELECT 'Y'
     FROM EAS_PORT_SO_CHG_ACCT S
    WHERE S.LGS_COST_CD = T1.LGS_COST_CD
      AND S.LGS_COST_AUD_FLG      = 'Y'
      AND CASE WHEN NVL(T1.CALC_AMT, 0) = 0 THEN 0
               ELSE S.EXPN_MAX_PRMT_RTO
          END
          <=
          CASE WHEN NVL(T1.CALC_AMT, 0) = 0 THEN 0
               ELSE ROUND((LOCL_AMT - T1.CALC_AMT) / T1.CALC_AMT * 100, 3)
          END
      AND ROWNUM = 1
    )
#end

#if ( ${office} !='ALL' && ${office} !='') 
--OFFICE, as is pso.cost_ofc_cd
AND @[office] IN (T1.INV_OFC_CD, DECODE(PSO.COST_OFC_CD,'PUSMOV', 'SELIB', PSO.COST_OFC_CD)) 
#end

#if ( ${period1} !='' && ${period2} !='' ) 
--Period period1 period2 INV_CFM_DT로 변경
AND T1.INV_CFM_DT BETWEEN TO_DATE(@[period1],'YYYY-MM-DD') AND TO_DATE(@[period2],'YYYY-MM-DD') + 0.99999
#end


AND LENGTH(T1.LGS_COST_CD) = 6

--2번째 줄 조회조건:123
#if (${chargeType} == '01' || ${chargeType} == '02' || ${chargeType} == '03')
AND CS.LGS_COST_AUD_FLG = DECODE(@[divChargeType],'1','Y','2','N')
#end

--CHARGE TYPE : PORT CHARGE, PORT SERVICE CHARGE
#if (${chargeType} == '01' )
 --PORT CHARGE 선택시
   AND C.ACCT_CD NOT IN ('999999', '511795')
   AND C.ACCT_CD LIKE '5117%'
   AND MA.ACCT_ENG_NM NOT LIKE 'OTHER PORT%'
#end
#if (${chargeType} == '02' ) 
 --PORT SERVICE CHARGE 선택시
   AND C.ACCT_CD LIKE '5118%'
   AND MA.ACCT_ENG_NM NOT LIKE 'OTHER PORT%'
#end
#if (${chargeType} == '03' ) 
--Canal Transit Fee 선택시
   AND C.ACCT_CD LIKE '5119%'
   AND MA.ACCT_ENG_NM NOT LIKE 'OTHER PORT%'
#end
#if ((${chargeType} != '' && ${chargeType} == '04') ) 
--Other 선택시
   AND C.ACCT_CD <> '999999' 
   AND (C.ACCT_CD IN ('564611', '511795') OR MA.ACCT_ENG_NM LIKE 'OTHER PORT%')
#end
#if (${chargeType} == '00')
--chargeType 00
  AND C.ACCT_CD NOT IN ('999999', '511795')
  #if (${portlChargeType} == '' && ${serviceChargeType} == '' && ${canalChargeType} == '' && ${otherChargeType} == '')
      AND ((SUBSTR(C.ACCT_CD,0,4) IN ('5117', '5118', '5119') AND CS.LGS_COST_AUD_FLG = DECODE(@[divChargeType],'1','Y','2','N')))
    #else
      #if (${divChargeType} == '1')
            #if (${otherChargeType} != '564611')
                AND ((SUBSTR(C.ACCT_CD,0,4) IN (@[portlChargeType], @[serviceChargeType], @[canalChargeType]) AND CS.LGS_COST_AUD_FLG = DECODE(@[divChargeType],'1','Y','2','N')))
            #else
                AND ((SUBSTR(C.ACCT_CD,0,4) IN (@[portlChargeType], @[serviceChargeType], @[canalChargeType]) AND CS.LGS_COST_AUD_FLG = DECODE(@[divChargeType],'1','Y','2','N')) OR (C.ACCT_CD IN ('564611', '511795') OR MA.ACCT_ENG_NM LIKE 'OTHER PORT%'))
            #end
        #else
            #if (${otherChargeType} == '564611')
                AND ((SUBSTR(C.ACCT_CD,0,4) IN (DECODE(@[portlChargeType],'5117','null','5117'), DECODE(@[serviceChargeType],'5118','null','5118'), DECODE(@[canalChargeType],'5119','null','5119')) AND CS.LGS_COST_AUD_FLG = DECODE(@[divChargeType],'1','Y','2','N')))
            #else
                AND ((SUBSTR(C.ACCT_CD,0,4) IN (DECODE(@[portlChargeType],'5117','null','5117'), DECODE(@[serviceChargeType],'5118','null','5118'), DECODE(@[canalChargeType],'5119','null','5119')) AND CS.LGS_COST_AUD_FLG = DECODE(@[divChargeType],'1','Y','2','N')) OR (C.ACCT_CD IN ('564611', '511795') OR MA.ACCT_ENG_NM LIKE 'OTHER PORT%'))
            #end
        #end
    #end
#end

#if ( ${accountCode} !='' ) 
--ACCOUNT CODE
AND T1.ACCT_CD = @[accountCode]
#end

#if ( ${costCode} !='' )
--COST CODE
AND T1.LGS_COST_CD = @[costCode]
#end


#if ( ${portCode} !='' ) 
--PORT CODE
AND T1.YD_CD LIKE @[portCode]||@[yardCd]||'%'
#end

#if ( ${spNo} !='' ) 
--SP NO
AND T1.VNDR_SEQ = @[spNo]
#end


#if ( ${contractType} !='' && ${contractType} !='ALL' && ${period1} !='' && ${period2} !='') 
--Contract type 
AND T1.VSL_CD IN (SELECT V.VSL_CD FROM MDM_VSL_CNTR V WHERE V.VSL_CD IN (SELECT F.VSL_CD FROM FMS_CONTRACT F WHERE FLET_CTRT_TP_CD IN (@[contractType])))
#end

#if ( ${vesselClass} !='' && ${vesselClass} !='ALL' ) 
--Vessel Class
AND T1.CNTR_VSL_CLSS_CAPA =  @[vesselClass]
#end

#if ( ${vessel} !='' ) 
--Vessel
AND T1.VSL_CD = @[vessel]
#end

#if ( ${remark} !='' ) 
--Diff
AND UPPER(T1.DIFF_RMK) LIKE '%'||UPPER(@[remark])||'%'
#end

-- Audit Status로 조회시	
#if(${expn_aud_sts_cd} == 'N')	
-- Audit Status 'N'
    AND T1.PORT_CHG_AUD_CHK_CD IS NULL	
#elseif(${expn_aud_sts_cd} == 'D') 	
-- Audit Status 'D'
    AND T1.PORT_CHG_AUD_CHK_CD IS NOT NULL	
#elseif(${expn_aud_sts_cd} == 'P' || ${expn_aud_sts_cd} == 'E' || ${expn_aud_sts_cd} == 'A')
-- Audit Status 'P', 'E', 'A'
    AND T1.PORT_CHG_AUD_CHK_CD = @[expn_aud_sts_cd]
#elseif(${expn_aud_sts_cd} == 'I')
-- Audit Status 'I'
    AND T1.EAC_NO IS NOT NULL
#end


#if (${if_status} != '')
--CSR Status
AND (CASE WHEN AI.INV_STS_CD = 'D' THEN 'D' -- Paid
          WHEN AH.IF_FLG = 'Y' AND AH.RCV_ERR_FLG IS NULL THEN 'P' -- I/F Success
          WHEN AH.RCV_ERR_FLG = 'E' THEN 'J' -- A/P Rejected
          WHEN AH.IF_FLG = 'E' THEN 'E' -- I/F Error
          WHEN AH.IF_FLG IS NULL AND AH.APRO_FLG = 'Y' AND AH.IF_ERR_RSN = 'Sending...' THEN 'S' -- Sending
          WHEN AI.INV_STS_CD = 'R' OR AI.INV_STS_CD = 'B' OR AH.CSR_RJCT_DT IS NOT NULL THEN 'R' -- Disapproved
          WHEN AH.IF_FLG IS NULL AND NVL(AH.RQST_APRO_STEP_FLG,'N') = 'N' THEN 'A' -- Approval Requested
          WHEN AH.IF_FLG IS NULL AND NVL(AH.RQST_APRO_STEP_FLG,'N') = 'Y' THEN 'L' -- Requesting Approval
          WHEN PSO.PSO_CHG_STS_CD = 'A' THEN 'C'
     END) = @[if_status]
#else
AND NVL(AH.RCV_ERR_FLG, 'X') <> 'E'
#end

 
#if (${auditStatus}!= '')
-- Auto Audit Status로 조회시 
    AND T1.AUTO_EXPN_AUD_STS_CD = @[auditStatus]
#end
#if (${sExpnAudStsCd}!= '')
	#if (${sExpnAudStsCd} == 'N')
-- sExpnAudStsCd 'N'
    	AND T1.PORT_CHG_AUD_CHK_CD IS NULL
	#elseif (${sExpnAudStsCd} == 'D')
-- sExpnAudStsCd 'D'
		AND T1.PORT_CHG_AUD_CHK_CD IS NOT NULL
-- sExpnAudStsCd 'N', 'D' 아닌경우
	#elseif (${sExpnAudStsCd} != 'N' && ${sExpnAudStsCd} != 'D')
		AND T1.PORT_CHG_AUD_CHK_CD = @[sExpnAudStsCd]
	#end
#end
GROUP BY T1.ISS_CTY_CD
     , T1.SO_SEQ
     , T1.VSL_CD||T1.SKD_VOY_NO||T1.SKD_DIR_CD
     , T1.LGS_COST_CD , C.LGS_COST_FULL_NM
     , T1.AUD_CURR_CD
     , T1.AUD_DIFF_AMT
     , T1.AUD_USD_DIFF_AMT

) WHERE 1=1
#if ((${diff} =='01' || ${diff} =='02' || ${diff} =='03') && (${diffNum} !=''))
-- DIFF
    AND DIFF
          #if ( ${diff} =='01') 
            <= TO_NUMBER(@[diffNum])
          #elseif ( ${diff} =='02') 
            = TO_NUMBER(@[diffNum])
          #elseif ( ${diff} =='03') 
            >= TO_NUMBER(@[diffNum])
          #end
#end			]]></sql>
			<params>
				<param name="rhq" type="12" value="" out="N"/>
				<param name="office" type="12" value="" out="N"/>
				<param name="period1" type="12" value="" out="N"/>
				<param name="period2" type="12" value="" out="N"/>
				<param name="divChargeType" type="12" value="" out="N"/>
				<param name="portlChargeType" type="12" value="" out="N"/>
				<param name="serviceChargeType" type="12" value="" out="N"/>
				<param name="canalChargeType" type="12" value="" out="N"/>
				<param name="accountCode" type="12" value="" out="N"/>
				<param name="costCode" type="12" value="" out="N"/>
				<param name="portCode" type="12" value="" out="N"/>
				<param name="yardCd" type="12" value="" out="N"/>
				<param name="spNo" type="12" value="" out="N"/>
				<param name="contractType" type="12" value="" out="N"/>
				<param name="vesselClass" type="12" value="" out="N"/>
				<param name="vessel" type="12" value="" out="N"/>
				<param name="remark" type="12" value="" out="N"/>
				<param name="expn_aud_sts_cd" type="12" value="" out="N"/>
				<param name="if_status" type="12" value="" out="N"/>
				<param name="auditStatus" type="12" value="" out="N"/>
				<param name="sExpnAudStsCd" type="12" value="" out="N"/>
				<param name="diffNum" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
