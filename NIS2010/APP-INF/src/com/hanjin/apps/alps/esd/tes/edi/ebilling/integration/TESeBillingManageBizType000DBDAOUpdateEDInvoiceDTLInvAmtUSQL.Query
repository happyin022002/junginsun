<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TESeBillingManageBizType000DBDAOUpdateEDInvoiceDTLInvAmtUSQL">
			<desc><![CDATA[수동 비용의 경우 DTL별 INV AMT 누락시 RATE * VOL으로 넣어준다]]></desc>
			<sql><![CDATA[
UPDATE TES_EDI_SO_DTL D
SET D.INV_AMT =   NVL(
                CASE 
                WHEN D.INV_AMT IS NULL OR D.INV_AMT = 0
                THEN 
					CASE
					WHEN (SELECT H.TML_INV_TP_CD FROM TES_EDI_SO_HDR H WHERE H.TML_EDI_SO_OFC_CTY_CD = D.TML_EDI_SO_OFC_CTY_CD AND H.TML_EDI_SO_SEQ = D.TML_EDI_SO_SEQ) = 'TM'
					THEN NVL(CTRT_RT,0) * NVL(CALC_VOL_QTY,0)
					WHEN (SELECT H.TML_INV_TP_CD FROM TES_EDI_SO_HDR H WHERE H.TML_EDI_SO_OFC_CTY_CD = D.TML_EDI_SO_OFC_CTY_CD AND H.TML_EDI_SO_SEQ = D.TML_EDI_SO_SEQ) = 'ST' 
					THEN NVL(CTRT_RT,0) * NVL(STAY_DYS,0)
					END
                ELSE INV_AMT
                END,0)
WHERE 1=1
AND D.TML_EDI_SO_OFC_CTY_CD = @[tml_edi_so_ofc_cty_cd]
AND D.TML_EDI_SO_SEQ = @[tml_edi_so_seq]
AND (D.INV_AMT IS NULL OR NVL(D.INV_AMT,0) = 0)
AND NVL(D.CTRT_RT,0) <> 0 
AND EXISTS (
    SELECT 'X'
    FROM TES_EDI_SO_HDR H
    WHERE 1=1
    AND H.TML_EDI_SO_OFC_CTY_CD = D.TML_EDI_SO_OFC_CTY_CD
    AND H.TML_EDI_SO_SEQ = D.TML_EDI_SO_SEQ
    AND NVL(H.DELT_FLG,'N') <> 'Y'
	AND H.TML_INV_EDI_SEQ = @[tml_inv_edi_seq]
)			]]></sql>
			<params>
				<param name="tml_edi_so_ofc_cty_cd" type="12" value="" out="N"/>
				<param name="tml_edi_so_seq" type="12" value="" out="N"/>
				<param name="tml_inv_edi_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
