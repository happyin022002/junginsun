<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TESeBillingManageBizType003DBDAODeleteNonTESTariffInvoiceUSQL">
			<desc><![CDATA[기본 수신단계에서 유효성 확인까지 마치고, NON-TES tariff로만 된 경우(cost code mapping이 하나도 안된 경우라 추정) invoice를 삭제처리한다.]]></desc>
			<sql><![CDATA[
UPDATE TES_EDI_SO_HDR H
SET DELT_FLG       = 'Y'
    , INV_RJCT_RMK = 'NON-TES DELT'||CASE WHEN INV_RJCT_RMK IS NOT NULL THEN ', '||INV_RJCT_RMK ELSE '' END
  	, UPD_USR_ID   = NVL(@[upd_usr_id],'eNIS_TES')
  	, UPD_DT	   = SYSDATE
	, LOCL_UPD_DT  = NVL(GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC(H.INV_OFC_CD),LOCL_CRE_DT)
WHERE 1=1
AND NVL(H.DELT_FLG,'N') <> 'Y'
AND H.VNDR_SEQ = @[psa_vndr_seq]
AND H.TML_EDI_SO_OFC_CTY_CD = @[tml_edi_so_ofc_cty_cd]
AND H.TML_EDI_SO_SEQ = @[tml_edi_so_seq]
AND H.TML_INV_EDI_SEQ = @[tml_inv_edi_seq]
AND NVL((
    SELECT 
        CASE
        WHEN COUNT(P.TRF_DESC) > 0 
             AND COUNT(P.LGS_COST_CD) > 0
             AND COUNT(P.TML_EDI_SO_PSA_DTL_SEQ) = COUNT(P.TRF_DESC)
             AND COUNT(P.LGS_COST_CD) = COUNT(P.TRF_DESC)
             AND COUNT(P.TML_EDI_SO_PSA_DTL_SEQ) = COUNT(C.LGS_COST_CD)
             AND COUNT(T.LGS_COST_CD) = 0
        THEN 'Y'
        ELSE 'N'
        END NON_TES_CHK
    FROM TES_EDI_SO_PSA_DTL P, TES_LGS_COST C, TES_TML_SO_COST T
    WHERE 1=1
    AND P.LGS_COST_CD = C.LGS_COST_CD(+)
    AND P.LGS_COST_CD = T.LGS_COST_CD(+)
    AND P.TML_EDI_SO_PSA_DTL_SEQ > 0
    AND P.TML_EDI_SO_OFC_CTY_CD = H.TML_EDI_SO_OFC_CTY_CD
    AND P.TML_EDI_SO_SEQ = H.TML_EDI_SO_SEQ
    AND P.TML_INV_EDI_SEQ = H.TML_INV_EDI_SEQ
    AND P.TRF_DESC <> 'GST'
    ),'N') = 'Y'			]]></sql>
			<params>
				<param name="upd_usr_id" type="12" value="" out="N"/>
				<param name="psa_vndr_seq" type="12" value="" out="N"/>
				<param name="tml_edi_so_ofc_cty_cd" type="12" value="" out="N"/>
				<param name="tml_edi_so_seq" type="12" value="" out="N"/>
				<param name="tml_inv_edi_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
