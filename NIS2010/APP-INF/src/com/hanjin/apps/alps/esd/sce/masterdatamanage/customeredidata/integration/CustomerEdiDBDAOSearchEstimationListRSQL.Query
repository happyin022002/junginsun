<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CustomerEdiDBDAOSearchEstimationListRSQL">
			<desc><![CDATA[SearchEstimationList]]></desc>
			<sql><![CDATA[
select bkg_no,
  bl_no,
  cntr_no,
  edi_sts_cd,
  cust_sts_cd,
  nod_cd,
  vvd,
  estm_dt ,
  act_dt,
  Delays,
  dat_rcv_dt
from (
    select aa.bkg_no bkg_no,
      aa.cntr_no cntr_no,
      aa.a_edi_sts_cd edi_sts_cd,
      aa.bl_no bl_no,
      aa.a_cust_edi_sts_cd cust_sts_cd,
      d.nod_cd nod_cd,
      aa.vvd vvd,
      to_char(d.estm_dt, 'YYYY-MM-DD HH24:MI:SS') estm_dt,
      to_char(d.act_dt, 'YYYY-MM-DD HH24:MI:SS') act_dt,
      case when d.act_dt is not null then round((d.act_dt - d.estm_dt)*24) else round((GLOBALDATE_PKG.TIME_CONV_FNC(SUBSTR('KRPUS', 1, 5), SYSDATE, SUBSTR(d.nod_cd, 1, 5)) - d.estm_dt)*24) end Delays,
      to_char(ACT_DAT_RCV_DT, 'YYYY-MM-DD HH24:MI:SS') dat_rcv_dt,
      rownum no
    from sce_cop_dtl d,
      (
        SELECT 
          DISTINCT vvd,
          hb.bkg_no,
          cntr_no,
          hb.por_cd,
          hb.pol_cd,
          hb.pod_cd,
          hb.del_cd,
          hb.cop_no,
          cgo.EDI_STND_STS_CD a_edi_sts_cd,
          cgo.CUST_EDI_STS_CD a_cust_edi_sts_cd,
          e.edi_grp_cd aaa,
          rail_chk,
          hb.bl_no
        FROM (
            SELECT DISTINCT h.trnk_vsl_cd||h.trnk_skd_voy_no||h.trnk_skd_dir_cd vvd,
              h.bkg_no,
              h.cntr_no,
              substr(h.por_nod_cd,1,5) por_cd,
              substr(h.pol_nod_cd,1,5) pol_cd,
              substr(h.pod_nod_cd,1,5) pod_cd,
              substr(h.del_nod_cd,1,5) del_cd,
              h.cop_no,

              h.COP_RAIL_CHK_CD rail_chk,
              b.bl_no
            FROM sce_cop_hdr h ,
              bkg_booking b

/* condition - fmd_dt */
#if ((${fmd_dt} != '') || (${fma_dt} != ''))
	            		,  ( SELECT /*+ index (VSK_VSL_PORT_SKD XAK1VSK_VSL_PORT_SKD) */  VSL_CD || SKD_VOY_NO || SKD_DIR_CD vvd   
	              	FROM VSK_VSL_PORT_SKD   
	                  WHERE NVL(SKD_CNG_STS_CD, ' ') <> 'S'   
/* condition - fmd_dt */
#if (${fmd_dt} != '') 
	        	         and VPS_ETD_DT BETWEEN TO_DATE( @[fmd_dt], 'YYYY-MM-DD' ) AND TO_DATE( @[tod_dt], 'YYYY-MM-DD' ) + 0.9999    
	        	         and NVL(TURN_PORT_IND_CD, ' ') NOT IN ('V', 'D', 'F')   
#end
	       
/* condition - fma_dt */
#if (${fma_dt} != '') 	        
	     
	        	         and VPS_ETA_DT BETWEEN TO_DATE( @[fma_dt], 'YYYY-MM-DD' ) AND TO_DATE( @[toa_dt], 'YYYY-MM-DD' ) + 0.9999  
	        	         and NVL(TURN_PORT_IND_CD, ' ') IN ('N', 'V', 'D', 'F')  
#end	  
	        
/* condition - eve_loc */
#if (${eve_loc} != '') 	
	         			 AND VPS_PORT_CD LIKE  '%'|| substr(@[eve_loc],1,5) || '%'  
#end	        
	        
	               		AND CLPT_IND_SEQ = '1'   
	          		) v    
#end


            WHERE b.bkg_no = h.bkg_no
              and h.cop_sts_cd IN ('C',
                  'T',
                  'F')
              AND h.cntr_no <> 'SMCU0000000'

/* condition - vvd , fmd_dt,fma_dt */
#if ((${vvd} != '') && ((${fmd_dt} != '') || (${fma_dt} != '')))
	          and h.TRNK_VSL_CD = substr(v.vvd, 1, 4)   
	          and h.TRNK_SKD_VOY_NO = substr(v.vvd, 5, 4)   
	          and h.TRNK_SKD_DIR_CD = substr(v.vvd, 9, 1) 
			  AND h.TRNK_VSL_CD||h.TRNK_SKD_VOY_NO||h.TRNK_SKD_DIR_CD in (
			  #foreach($ele IN ${vvd})
			  #if($velocityCount == 1 ) 
			  '$ele'
			  #else 
			  ,'$ele' 
			  #end 
			  #end
			  )  )hb,  
#elseif((${fmd_dt} != '') || (${fma_dt} != ''))
	          and h.TRNK_VSL_CD = substr(v.vvd, 1, 4)   
	          and h.TRNK_SKD_VOY_NO = substr(v.vvd, 5, 4)   
	          and h.TRNK_SKD_DIR_CD = substr(v.vvd, 9, 1) )hb, 

#elseif(${vvd} != '') 
AND h.TRNK_VSL_CD||h.TRNK_SKD_VOY_NO||h.TRNK_SKD_DIR_CD in (
#foreach($ele IN ${vvd})
#if($velocityCount == 1 ) 
'$ele'
#else 
,'$ele' 
#end 
#end
)  )hb,
#end
				
          EDI_GRP_CUST e,
          edi_grp_cgo cgo,
          bkg_customer bkg_cust,
          bkg_booking bkg_rt
        WHERE hb.bkg_no = bkg_cust.bkg_no
          and hb.bkg_no = bkg_rt.bkg_no
          and ( (e.CUST_CNT_CD = bkg_cust.CUST_CNT_CD 
                  and e.CUST_SEQ = bkg_cust.CUST_SEQ)
              or (e.sc_no = case when e.bkg_ctrt_div_cd is null
                  or e.bkg_ctrt_div_cd = '1' then bkg_rt.sc_no else bkg_rt.rfa_no end ) 
                  )
          
/* condition - cs_grp_id */
#if (${cs_grp_id} != '') 
	AND E.EDI_GRP_CD  =  @[cs_grp_id]
#end

          AND e.edi_grp_cd = cgo.edi_grp_cd
          AND E.CGO_TRC_SVC_FLG <> 'N'
         
/* condition - eve_sel */
#if (${eve_sel} != '') 
	AND cgo.EDI_STND_STS_CD  =  @[eve_sel]
#end

) aa
    where aa.cop_no = d.cop_No

/* condition - eve_sel */
#if (${eve_sel} != '') 
	AND d.STND_EDI_STS_CD  =  @[eve_sel]
#end

/* condition - eve_loc */
#if (${eve_loc} != '') 
	AND NOD_CD LIKE  @[eve_loc]||'%'
#end
      
)ll
where no between 1 and 300			]]></sql>
			<params>
				<param name="fmd_dt" type="12" value="" out="N"/>
				<param name="tod_dt" type="12" value="" out="N"/>
				<param name="fma_dt" type="12" value="" out="N"/>
				<param name="toa_dt" type="12" value="" out="N"/>
				<param name="eve_loc" type="12" value="" out="N"/>
				<param name="cs_grp_id" type="12" value="" out="N"/>
				<param name="eve_sel" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
