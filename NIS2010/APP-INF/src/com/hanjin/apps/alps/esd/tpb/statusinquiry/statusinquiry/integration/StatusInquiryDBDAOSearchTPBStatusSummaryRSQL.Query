<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="StatusInquiryDBDAOSearchTPBStatusSummaryRSQL">
			<desc><![CDATA[SearchTPBStatusSummary]]></desc>
			<sql><![CDATA[
#if (${s_status} == 'S')---- 1. By Status

SELECT   O.RHQ IF_RHQ_CD
       , O.OFC IF_OFC_CD
       , NVL(A.CNT,0) CNT_A, NVL(A.AMT,0) AS AMT_A
       , NVL(B.CNT,0) CNT_B, NVL(B.AMT,0) AS AMT_B
       , NVL(C.CNT,0) CNT_C, NVL(C.AMT,0) AS AMT_C
       , NVL(D.CNT,0) CNT_D, NVL(D.AMT,0) AS AMT_D
       , NVL(E.CNT,0) CNT_E, NVL(E.AMT,0) AS AMT_E
       , NVL(F.CNT,0) CNT_F, NVL(F.AMT,0) AS AMT_F
       , NVL(G.CNT,0) CNT_G, NVL(G.AMT,0) AS AMT_G
       , NVL(A.CNT,0)+NVL(B.CNT,0)+NVL(C.CNT,0)+NVL(D.CNT,0)+NVL(E.CNT,0)+NVL(F.CNT,0)+NVL(G.CNT,0) AS CNT_TOT
       , NVL(A.AMT,0)+NVL(B.AMT,0)+NVL(C.AMT,0)+NVL(D.AMT,0)+NVL(E.AMT,0)+NVL(F.AMT,0)+NVL(G.AMT,0) AS AMT_TOT
FROM     (
           SELECT   0 AS SEQ
                  , RHQ_CD AS RHQ
                  , OFC_CD AS OFC
           FROM     TPB_HNDL_OFC
           WHERE    1 = 1
           AND      N3PTY_OFC_TP_CD = 'T'
           AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
           AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
           AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
           AND      OFC_CD = @[s_if_ofc_cd]
#end
           UNION ALL
           SELECT   999 AS SEQ
                  , '(TOTAL)' AS RHQ
                  , '(TOTAL)' AS OFC
           FROM     DUAL
         ) O
       , (
           -- Initial Confirm. / O
           SELECT   NVL(M.RHQ,'(TOTAL)') AS RHQ
                  , NVL(M.OFC,'(TOTAL)') AS OFC
                  , COUNT(0) AS CNT
                  , SUM(TPB_GET_USD_AMT_FNC(A.OTS_AMT,A.CURR_CD,TPB_GET_LCL_DATE_FNC(ADD_MONTHS(SYSDATE,-1),A.OFC_CD))) AS AMT
           FROM     TPB_OTS_GRP A
                  , TPB_OTS_GRP_STS C
                  , (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   999 AS SEQ
                             , '(TOTAL)' AS RHQ
                             , '(TOTAL)' AS OFC
                      FROM     DUAL
                    ) M
           WHERE    1 = 1
           AND      A.N3PTY_NO = C.N3PTY_NO
           AND      A.OFC_CD = M.OFC
           AND      A.N3PTY_DELT_TP_CD IN ('N')
           AND      A.N3PTY_BIL_TP_CD IN
                    (
#if (${s_exclude_jo} == 'X') -- excluding JO
	/* 2009-02-03 O Wan-Ki      1.5 Bill Type Code : MX 누락에 의한 보완 */
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD NOT IN ('JO') AND ACT_FLG = 'Y' UNION ALL SELECT 'MX' N3PTY_BIL_TP_CD FROM DUAL
#elseif (${s_exclude_jo} == 'O') 
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD IN ('JO') AND ACT_FLG = 'Y'
#elseif (${s_exclude_jo} == 'A')
			          SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE ACT_FLG='Y' UNION ALL SELECT 'MX' N3PTY_BIL_TP_CD FROM DUAL
#end
                    )
           AND      C.OTS_STS_LST_FLG = 'Y'
           AND      C.OTS_STS_CD IN ('O')
           AND      A.OFC_CD IN
                    (
                      SELECT   OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   '(TOTAL)' AS OFC
                      FROM     DUAL
                    )
           GROUP BY ROLLUP(M.RHQ, M.OFC)
           HAVING GROUPING(M.RHQ) = 1 OR GROUPING(M.OFC)= 0
         ) A
       , (
          -- Cancellation Invoice / M
           SELECT   NVL(M.RHQ,'(TOTAL)') AS RHQ
                  , NVL(M.OFC,'(TOTAL)') AS OFC
                  , COUNT(0) AS CNT
                  , SUM(TPB_GET_USD_AMT_FNC(A.OTS_AMT,A.CURR_CD,TPB_GET_LCL_DATE_FNC(ADD_MONTHS(SYSDATE,-1),A.OFC_CD))) AS AMT
           FROM     TPB_OTS_GRP A
                  , TPB_OTS_GRP_STS C
                  , (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   999 AS SEQ
                             , '(TOTAL)' AS RHQ
                             , '(TOTAL)' AS OFC
                      FROM     DUAL
                    ) M
           WHERE    1 = 1
           AND      A.N3PTY_NO = C.N3PTY_NO
           AND      A.OFC_CD = M.OFC
           AND      A.N3PTY_DELT_TP_CD IN ('N')
           AND      A.N3PTY_BIL_TP_CD IN
                    (
#if (${s_exclude_jo} == 'X') -- excluding JO
	/* 2009-02-03 O Wan-Ki      1.5 Bill Type Code : MX 누락에 의한 보완 */
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD NOT IN ('JO') AND ACT_FLG = 'Y' UNION ALL SELECT 'MX' N3PTY_BIL_TP_CD FROM DUAL
#elseif (${s_exclude_jo} == 'O') 
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD IN ('JO') AND ACT_FLG = 'Y'
#elseif (${s_exclude_jo} == 'A')
			          SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE ACT_FLG = 'Y' UNION ALL SELECT 'MX' N3PTY_BIL_TP_CD FROM DUAL
#end
                    )
           AND      c.ots_sts_lst_flg = 'Y'
           AND      c.ots_sts_cd IN ('M')
           AND      a.ofc_cd IN (
                      SELECT   OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   '(TOTAL)' AS OFC
                      FROM     DUAL
                             )
        GROUP BY ROLLUP(m.rhq, m.ofc)
          HAVING GROUPING(m.rhq)=1 OR GROUPING(m.ofc)=0
       ) b,
       (
          -- INV Issued / I, N
          SELECT NVL(m.rhq,'(TOTAL)') rhq, NVL(m.ofc,'(TOTAL)') ofc
                ,COUNT(0) cnt
                ,SUM(TPB_GET_USD_AMT_FNC(a.ots_amt,a.curr_cd,TPB_GET_LCL_DATE_FNC(ADD_MONTHS(sysdate,-1),a.ofc_cd))) amt
            FROM TPB_OTS_GRP a, TPB_OTS_GRP_STS c,
                 (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   999 AS SEQ
                             , '(TOTAL)' AS RHQ
                             , '(TOTAL)' AS OFC
                      FROM     DUAL
                 ) m
           WHERE a.n3pty_no = c.n3pty_no
             AND a.ofc_cd = m.ofc
             AND a.n3pty_delt_tp_cd IN ('N')
             AND a.n3pty_bil_tp_cd IN (
#if (${s_exclude_jo} == 'X') -- excluding JO
	/* 2009-02-03 O Wan-Ki      1.5 Bill Type Code : MX 누락에 의한 보완 */
                                        SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd NOT IN ('JO') AND ACT_FLG='Y' UNION ALL SELECT 'MX' n3pty_bil_tp_cd FROM DUAL
#elseif (${s_exclude_jo} == 'O') 
                                        SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd IN ('JO') AND ACT_FLG='Y'
#elseif (${s_exclude_jo} == 'A')
			SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE ACT_FLG='Y' UNION ALL SELECT 'MX' N3PTY_BIL_TP_CD FROM DUAL
#end
                                      )
             AND c.ots_sts_lst_flg = 'Y'
             AND c.ots_sts_cd IN ('I','N')
             AND a.ofc_cd IN (
                      SELECT   OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   '(TOTAL)' AS OFC
                      FROM     DUAL
                             )
        GROUP BY ROLLUP(m.rhq, m.ofc)
          HAVING GROUPING(m.rhq)=1 OR GROUPING(m.ofc)=0
       ) c,
       (
          -- Bal. remained (ERP I/F) / L, A
          SELECT NVL(m.rhq,'(TOTAL)') rhq, NVL(m.ofc,'(TOTAL)') ofc
                ,COUNT(0) cnt
                ,SUM(TPB_GET_USD_AMT_FNC(a.ots_amt,a.curr_cd,TPB_GET_LCL_DATE_FNC(ADD_MONTHS(sysdate,-1),a.ofc_cd))) amt
            FROM TPB_OTS_GRP a, TPB_OTS_GRP_STS c,
                 (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   999 AS SEQ
                             , '(TOTAL)' AS RHQ
                             , '(TOTAL)' AS OFC
                      FROM     DUAL
                 ) m
           WHERE a.n3pty_no = c.n3pty_no
             AND a.ofc_cd = m.ofc
             AND a.n3pty_delt_tp_cd IN ('N')
             AND a.n3pty_bil_tp_cd IN (
#if (${s_exclude_jo} == 'X') -- excluding JO
	/* 2009-02-03 O Wan-Ki      1.5 Bill Type Code : MX 누락에 의한 보완 */
                                        SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd NOT IN ('JO') AND ACT_FLG='Y' UNION ALL SELECT 'MX' n3pty_bil_tp_cd FROM DUAL
#elseif (${s_exclude_jo} == 'O') 
                                        SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd IN ('JO') AND ACT_FLG='Y'
#elseif (${s_exclude_jo} == 'A')
			SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE ACT_FLG='Y' UNION ALL SELECT 'MX' N3PTY_BIL_TP_CD FROM DUAL
#end
                                      )
             AND c.ots_sts_lst_flg = 'Y'
			/* L(ERP I/F 되었으나 Balance Amount가 남아있는)상태도 종결로 처리함. */
             AND c.ots_sts_cd IN ('A')
             AND a.ofc_cd IN (
                      SELECT   OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   '(TOTAL)' AS OFC
                      FROM     DUAL
                             )
        GROUP BY ROLLUP(m.rhq, m.ofc)
          HAVING GROUPING(m.rhq)=1 OR GROUPING(m.ofc)=0
       ) d,
       (
          -- ADJ. Requested / R
          SELECT NVL(m.rhq,'(TOTAL)') rhq, NVL(m.ofc,'(TOTAL)') ofc
                ,COUNT(0) cnt
                ,SUM(TPB_GET_USD_AMT_FNC(a.ots_amt,a.curr_cd,TPB_GET_LCL_DATE_FNC(ADD_MONTHS(sysdate,-1),a.ofc_cd))) amt
            FROM TPB_OTS_GRP a, TPB_OTS_GRP_STS c,
                 (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   999 AS SEQ
                             , '(TOTAL)' AS RHQ
                             , '(TOTAL)' AS OFC
                      FROM     DUAL
                 ) m
           WHERE a.n3pty_no = c.n3pty_no
             AND a.ofc_cd = m.ofc
             AND a.n3pty_delt_tp_cd IN ('N')
             AND a.n3pty_bil_tp_cd IN (
#if (${s_exclude_jo} == 'X') -- excluding JO
	/* 2009-02-03 O Wan-Ki      1.5 Bill Type Code : MX 누락에 의한 보완 */
                                        SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd NOT IN ('JO') AND ACT_FLG='Y' UNION ALL SELECT 'MX' n3pty_bil_tp_cd FROM DUAL
#elseif (${s_exclude_jo} == 'O') 
                                        SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd IN ('JO') AND ACT_FLG='Y'
#elseif (${s_exclude_jo} == 'A')
			SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE ACT_FLG='Y' UNION ALL SELECT 'MX' N3PTY_BIL_TP_CD FROM DUAL
#end
)
             AND c.ots_sts_lst_flg = 'Y'
             AND c.ots_sts_cd IN ('R')
#if (${s_exclude_roc_requested} == 'Y') 
             AND EXISTS ( SELECT 0 FROM tpb_adj_sts e WHERE e.n3pty_no=a.n3pty_no AND e.n3pty_stl_tp_cd IN ('D','C','W') AND e.stl_sts_lst_flg = 'Y' )
#end
             AND a.ofc_cd IN (
                      SELECT   OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   '(TOTAL)' AS OFC
                      FROM     DUAL
                             )
        GROUP BY ROLLUP(m.rhq, m.ofc)
          HAVING GROUPING(m.rhq)=1 OR GROUPING(m.ofc)=0
       ) e,
       (
          -- ADJ. Rejected / J,K
          SELECT NVL(m.rhq,'(TOTAL)') rhq, NVL(m.ofc,'(TOTAL)') ofc
                ,COUNT(0) cnt
                ,SUM(TPB_GET_USD_AMT_FNC(a.ots_amt,a.curr_cd,TPB_GET_LCL_DATE_FNC(ADD_MONTHS(sysdate,-1),a.ofc_cd))) amt
            FROM TPB_OTS_GRP a, TPB_OTS_GRP_STS c,
                 (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   999 AS SEQ
                             , '(TOTAL)' AS RHQ
                             , '(TOTAL)' AS OFC
                      FROM     DUAL
                 ) m
           WHERE a.n3pty_no = c.n3pty_no
             AND a.ofc_cd = m.ofc
             AND a.n3pty_delt_tp_cd IN ('N')
             AND a.n3pty_bil_tp_cd IN (
#if (${s_exclude_jo} == 'X') -- excluding JO
	/* 2009-02-03 O Wan-Ki      1.5 Bill Type Code : MX 누락에 의한 보완 */
                                        SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd NOT IN ('JO') AND ACT_FLG='Y' UNION ALL SELECT 'MX' n3pty_bil_tp_cd FROM DUAL
#elseif (${s_exclude_jo} == 'O') 
                                        SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd IN ('JO') AND ACT_FLG='Y'
#elseif (${s_exclude_jo} == 'A')
			SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE ACT_FLG='Y' UNION ALL SELECT 'MX' N3PTY_BIL_TP_CD FROM DUAL
#end
                                      )
             AND c.ots_sts_lst_flg = 'Y'
             AND c.ots_sts_cd IN ('J','K')
#if (${s_exclude_roc_requested} == 'Y') 
             AND EXISTS ( SELECT 0 FROM tpb_adj_sts e WHERE e.n3pty_no=a.n3pty_no AND e.n3pty_stl_tp_cd IN ('D','C','W') AND e.stl_sts_lst_flg = 'Y' )
#end
             AND a.ofc_cd IN (
                      SELECT   OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   '(TOTAL)' AS OFC
                      FROM     DUAL
                             )
        GROUP BY ROLLUP(m.rhq, m.ofc)
          HAVING GROUPING(m.rhq)=1 OR GROUPING(m.ofc)=0
       ) f,
       (
          -- Collection Agency & Legal Action / Y
          SELECT NVL(m.rhq,'(TOTAL)') rhq, NVL(m.ofc,'(TOTAL)') ofc
                ,COUNT(0) cnt
                ,SUM(TPB_GET_USD_AMT_FNC(a.ots_amt,a.curr_cd,TPB_GET_LCL_DATE_FNC(ADD_MONTHS(sysdate,-1),a.ofc_cd))) amt
            FROM TPB_OTS_GRP a, TPB_OTS_GRP_STS c,
                 (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   999 AS SEQ
                             , '(TOTAL)' AS RHQ
                             , '(TOTAL)' AS OFC
                      FROM     DUAL
                 ) m
           WHERE a.n3pty_no = c.n3pty_no
             AND a.ofc_cd = m.ofc
             AND a.n3pty_delt_tp_cd IN ('N')
             AND a.n3pty_bil_tp_cd IN (
#if (${s_exclude_jo} == 'X') -- excluding JO
	/* 2009-02-03 O Wan-Ki      1.5 Bill Type Code : MX 누락에 의한 보완 */
                                        SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd NOT IN ('JO') AND ACT_FLG='Y' UNION ALL SELECT 'MX' n3pty_bil_tp_cd FROM DUAL
#elseif (${s_exclude_jo} == 'O') 
                                        SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd IN ('JO') AND ACT_FLG='Y'
#elseif (${s_exclude_jo} == 'A')
			SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE ACT_FLG='Y' UNION ALL SELECT 'MX' N3PTY_BIL_TP_CD FROM DUAL
#end
                                      )
             AND c.ots_sts_lst_flg = 'Y'
             AND c.ots_sts_cd IN ('Y')
             AND a.ofc_cd IN (
                      SELECT   OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   '(TOTAL)' AS OFC
                      FROM     DUAL
                             )
        GROUP BY ROLLUP(m.rhq, m.ofc)
          HAVING GROUPING(m.rhq)=1 OR GROUPING(m.ofc)=0
       ) g
 WHERE 1 = 1
   AND o.rhq = a.rhq(+) AND o.ofc = a.ofc(+)
   AND o.rhq = b.rhq(+) AND o.ofc = b.ofc(+)
   AND o.rhq = c.rhq(+) AND o.ofc = c.ofc(+)
   AND o.rhq = d.rhq(+) AND o.ofc = d.ofc(+)
   AND o.rhq = e.rhq(+) AND o.ofc = e.ofc(+)
   AND o.rhq = f.rhq(+) AND o.ofc = f.ofc(+)
   AND o.rhq = g.rhq(+) AND o.ofc = g.ofc(+)
 ORDER BY o.seq, o.rhq, o.ofc
 
#elseif (${s_status} == 'E') ---- 2. By Expense Type

SELECT o.rhq if_rhq_cd, o.ofc if_ofc_cd
      ,NVL(a.cnt,0) cnt_a, NVL(a.amt,0) amt_a
      ,NVL(b.cnt,0) cnt_b, NVL(b.amt,0) amt_b
      ,NVL(c.cnt,0) cnt_c, NVL(c.amt,0) amt_c
 	  ,NVL(d.cnt,0) cnt_d, NVL(d.amt,0) amt_d
      ,NVL(a.cnt,0)+NVL(b.cnt,0)+NVL(c.cnt,0)+NVL(d.cnt,0) cnt_tot
      ,NVL(a.amt,0)+NVL(b.amt,0)+NVL(c.amt,0)+NVL(d.amt,0) amt_tot
  FROM (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   999 AS SEQ
                             , '(TOTAL)' AS RHQ
                             , '(TOTAL)' AS OFC
                      FROM     DUAL
       ) o,
       (
          -- TES
          SELECT NVL(m.rhq,'(TOTAL)') rhq, NVL(m.ofc,'(TOTAL)') ofc
                ,COUNT(0) cnt
                ,SUM(TPB_GET_USD_AMT_FNC(a.ots_amt,a.curr_cd,TPB_GET_LCL_DATE_FNC(ADD_MONTHS(sysdate,-1),a.ofc_cd))) amt
            FROM TPB_OTS_GRP a, TPB_OTS_GRP_STS c,
                 (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   999 AS SEQ
                             , '(TOTAL)' AS RHQ
                             , '(TOTAL)' AS OFC
                      FROM     DUAL
                 ) m
           WHERE a.n3pty_no = c.n3pty_no
             AND a.ofc_cd = m.ofc
             AND a.n3pty_delt_tp_cd IN ('N')
             AND a.n3pty_bil_tp_cd IN (
#if (${s_exclude_jo} == 'X') -- excluding JO
	/* 2009-02-03 O Wan-Ki      1.5 Bill Type Code : MX 누락에 의한 보완 */
                                        SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd NOT IN ('JO') AND ACT_FLG='Y' UNION ALL SELECT 'MX' n3pty_bil_tp_cd FROM DUAL
#elseif (${s_exclude_jo} == 'O') 
                                        SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd IN ('JO') AND ACT_FLG='Y'
#elseif (${s_exclude_jo} == 'A')
			SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE ACT_FLG='Y' UNION ALL SELECT 'MX' N3PTY_BIL_TP_CD FROM DUAL
#end
                                      )
             AND c.ots_sts_lst_flg = 'Y'
             --AND c.ots_sts_cd IN ('O','M','I','N','R','J','K','Y') /* 'L','A' close상태, 제외 */
             AND C.OTS_STS_CD NOT IN ('D','E','L','A')
             AND a.n3pty_expn_tp_cd = 'TES'
#if (${s_exclude_roc_requested} == 'Y') 
             AND ( c.ots_sts_cd IN ('O','M','I','N','Y') OR ( c.ots_sts_cd IN ('R','J','K') AND EXISTS ( SELECT 0 FROM tpb_adj_sts e WHERE e.n3pty_no=a.n3pty_no AND e.n3pty_stl_tp_cd IN ('D','C','W') AND e.stl_sts_lst_flg = 'Y' ) ) )
#end
             AND a.ofc_cd IN (
                      SELECT   OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   '(TOTAL)' AS OFC
                      FROM     DUAL
                             )
        GROUP BY ROLLUP(m.rhq, m.ofc)
          HAVING GROUPING(m.rhq)=1 OR GROUPING(m.ofc)=0
       ) a,
       (
          -- TRS
          SELECT NVL(m.rhq,'(TOTAL)') rhq, NVL(m.ofc,'(TOTAL)') ofc
                ,COUNT(0) cnt
                ,SUM(TPB_GET_USD_AMT_FNC(a.ots_amt,a.curr_cd,TPB_GET_LCL_DATE_FNC(ADD_MONTHS(sysdate,-1),a.ofc_cd))) amt
            FROM TPB_OTS_GRP a, TPB_OTS_GRP_STS c,
                 (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   999 AS SEQ
                             , '(TOTAL)' AS RHQ
                             , '(TOTAL)' AS OFC
                      FROM     DUAL
                 ) m
           WHERE a.n3pty_no = c.n3pty_no
             AND a.ofc_cd = m.ofc
             AND a.n3pty_delt_tp_cd IN ('N')
             AND a.n3pty_bil_tp_cd IN (
#if (${s_exclude_jo} == 'X') -- excluding JO
	/* 2009-02-03 O Wan-Ki      1.5 Bill Type Code : MX 누락에 의한 보완 */
                                        SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd NOT IN ('JO') AND ACT_FLG='Y' UNION ALL SELECT 'MX' n3pty_bil_tp_cd FROM DUAL
#elseif (${s_exclude_jo} == 'O') 
                                        SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd IN ('JO') AND ACT_FLG='Y'
#elseif (${s_exclude_jo} == 'A')
			SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE ACT_FLG='Y' UNION ALL SELECT 'MX' N3PTY_BIL_TP_CD FROM DUAL
#end
                                      )
             AND c.ots_sts_lst_flg = 'Y'
             --AND c.ots_sts_cd IN ('O','M','I','N','R','J','K','Y')  /* 'L','A' close상태, 제외 */
             AND C.OTS_STS_CD NOT IN ('D','E','L','A')
             AND a.n3pty_expn_tp_cd = 'TRS'
#if (${s_exclude_roc_requested} == 'Y') 
             AND ( c.ots_sts_cd IN ('O','M','I','N','Y') OR ( c.ots_sts_cd IN ('R','J','K') AND EXISTS ( SELECT 0 FROM tpb_adj_sts e WHERE e.n3pty_no=a.n3pty_no AND e.n3pty_stl_tp_cd IN ('D','C','W') AND e.stl_sts_lst_flg = 'Y' ) ) )
#end
             AND a.ofc_cd IN (
                      SELECT   OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   '(TOTAL)' AS OFC
                      FROM     DUAL
                             )
        GROUP BY ROLLUP(m.rhq, m.ofc)
          HAVING GROUPING(m.rhq)=1 OR GROUPING(m.ofc)=0
       ) b,
       (
          -- MNR
          SELECT NVL(m.rhq,'(TOTAL)') rhq, NVL(m.ofc,'(TOTAL)') ofc
                ,COUNT(0) cnt
                ,SUM(TPB_GET_USD_AMT_FNC(a.ots_amt,a.curr_cd,TPB_GET_LCL_DATE_FNC(ADD_MONTHS(sysdate,-1),a.ofc_cd))) amt
            FROM TPB_OTS_GRP a, TPB_OTS_GRP_STS c,
                 (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   999 AS SEQ
                             , '(TOTAL)' AS RHQ
                             , '(TOTAL)' AS OFC
                      FROM     DUAL
                 ) m
           WHERE a.n3pty_no = c.n3pty_no
             AND a.ofc_cd = m.ofc
             AND a.n3pty_delt_tp_cd IN ('N')
             AND a.n3pty_bil_tp_cd IN (
#if (${s_exclude_jo} == 'X') -- excluding JO
	/* 2009-02-03 O Wan-Ki      1.5 Bill Type Code : MX 누락에 의한 보완 */
                                        SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd NOT IN ('JO') AND ACT_FLG='Y' UNION ALL SELECT 'MX' n3pty_bil_tp_cd FROM DUAL
#elseif (${s_exclude_jo} == 'O') 
                                        SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd IN ('JO') AND ACT_FLG='Y'
#elseif (${s_exclude_jo} == 'A')
			SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE ACT_FLG='Y' UNION ALL SELECT 'MX' N3PTY_BIL_TP_CD FROM DUAL
#end
                                      )
             AND c.ots_sts_lst_flg = 'Y'
             --AND c.ots_sts_cd IN ('O','M','I','N','R','J','K','Y')  /* 'L','A' close상태, 제외 */
             AND C.OTS_STS_CD NOT IN ('D','E','L','A')
             AND a.n3pty_expn_tp_cd = 'MNR'
#if (${s_exclude_roc_requested} == 'Y') 
             AND ( c.ots_sts_cd IN ('O','M','I','N','Y') OR ( c.ots_sts_cd IN ('R','J','K') AND EXISTS ( SELECT 0 FROM tpb_adj_sts e WHERE e.n3pty_no=a.n3pty_no AND e.n3pty_stl_tp_cd IN ('D','C','W') AND e.stl_sts_lst_flg = 'Y' ) ) )
#end
             AND a.ofc_cd IN (
                      SELECT   OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   '(TOTAL)' AS OFC
                      FROM     DUAL
                             )
        GROUP BY ROLLUP(m.rhq, m.ofc)
          HAVING GROUPING(m.rhq)=1 OR GROUPING(m.ofc)=0
       ) c
-- PSO [CHM-201222161-01]start-----------------------------
,
  (
-- PSO
    SELECT NVL(m.rhq, '(TOTAL)') rhq,
      NVL(m.ofc, '(TOTAL)') ofc ,
      COUNT(0) cnt ,
      SUM(TPB_GET_USD_AMT_FNC(a.ots_amt, a.curr_cd, TPB_GET_LCL_DATE_FNC(ADD_MONTHS(sysdate, -1), a.ofc_cd))) amt
    FROM TPB_OTS_GRP a,
      TPB_OTS_GRP_STS c,
      (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
                      UNION ALL
                      SELECT   999 AS SEQ
                             , '(TOTAL)' AS RHQ
                             , '(TOTAL)' AS OFC
                      FROM     DUAL
                    ) m
    WHERE a.n3pty_no = c.n3pty_no
      AND a.ofc_cd = m.ofc
      AND a.n3pty_delt_tp_cd IN ('N')
      AND c.ots_sts_lst_flg = 'Y'
      AND c.ots_sts_cd IN ('O',
          'M',
          'I',
          'N',
          'R',
          'J',
          'K',
          'Y') /* 'L','A' close????, ???? */
      AND a.n3pty_expn_tp_cd = 'PSO'
      AND a.ofc_cd IN (
        SELECT ofc_cd ofc
        FROM TPB_HNDL_OFC
        WHERE n3pty_ofc_tp_cd='T'
           #if (${s_if_rhq_cd} != '' )
              AND rhq_cd = @[s_if_rhq_cd]     /* bind */
           #end
        UNION ALL
        SELECT '(TOTAL)' ofc
        FROM DUAL )
    GROUP BY ROLLUP(m.rhq, m.ofc)
    HAVING GROUPING(m.rhq)=1
      OR GROUPING(m.ofc)=0  ) d
-- PSO [CHM-201222161-01]end-------------------------------      

 WHERE 1 = 1
   AND o.rhq = a.rhq(+) AND o.ofc = a.ofc(+)
   AND o.rhq = b.rhq(+) AND o.ofc = b.ofc(+)
   AND o.rhq = c.rhq(+) AND o.ofc = c.ofc(+)
--[CHM-201222161-01]start------  
  AND o.rhq = d.rhq(+)
  AND o.ofc = d.ofc(+)
--[CHM-201222161-01]end--------

 ORDER BY o.seq, o.rhq, o.ofc
 
#elseif (${s_status} == 'A') ---- 3. By Aging

SELECT o.rhq if_rhq_cd, o.ofc if_ofc_cd
      ,NVL(a.cnt,0) cnt_a, NVL(a.amt,0) amt_a
      ,NVL(b.cnt,0) cnt_b, NVL(b.amt,0) amt_b
      ,NVL(c.cnt,0) cnt_c, NVL(c.amt,0) amt_c
      ,NVL(d.cnt,0) cnt_d, NVL(d.amt,0) amt_d
      ,NVL(e.cnt,0) cnt_e, NVL(e.amt,0) amt_e
      ,NVL(a.cnt,0)+NVL(b.cnt,0)+NVL(c.cnt,0)+NVL(d.cnt,0)+NVL(e.cnt,0) cnt_tot
      ,NVL(a.amt,0)+NVL(b.amt,0)+NVL(c.amt,0)+NVL(d.amt,0)+NVL(e.amt,0) amt_tot
  FROM (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   999 AS SEQ
                             , '(TOTAL)' AS RHQ
                             , '(TOTAL)' AS OFC
                      FROM     DUAL
       ) o,
       (
          -- in 30 days
          SELECT NVL(m.rhq,'(TOTAL)') rhq, NVL(m.ofc,'(TOTAL)') ofc
                ,COUNT(0) cnt
                ,SUM(TPB_GET_USD_AMT_FNC(a.ots_amt,a.curr_cd,TPB_GET_LCL_DATE_FNC(ADD_MONTHS(sysdate,0),a.ofc_cd))) amt        --[CHM-201322948]
            FROM TPB_OTS_GRP a, TPB_OTS_GRP_STS c,
                 (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   999 AS SEQ
                             , '(TOTAL)' AS RHQ
                             , '(TOTAL)' AS OFC
                      FROM     DUAL
                 ) m
           WHERE a.n3pty_no = c.n3pty_no
             AND a.ofc_cd = m.ofc
             AND a.n3pty_delt_tp_cd IN ('N')
             AND a.n3pty_bil_tp_cd IN (
#if (${s_exclude_jo} == 'X') -- excluding JO
	/* 2009-02-03 O Wan-Ki      1.5 Bill Type Code : MX 누락에 의한 보완 */
                                        SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd NOT IN ('JO') AND ACT_FLG='Y' UNION ALL SELECT 'MX' n3pty_bil_tp_cd FROM DUAL
#elseif (${s_exclude_jo} == 'O') 
                                        SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd IN ('JO') AND ACT_FLG='Y'
#elseif (${s_exclude_jo} == 'A')
			SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE ACT_FLG='Y' UNION ALL SELECT 'MX' N3PTY_BIL_TP_CD FROM DUAL
#end
                                      )
             AND c.ots_sts_lst_flg = 'Y'
             --AND c.ots_sts_cd IN ('O','M','I','N','R','J','K','Y')                                                    -- 'L','A' close상태, 제외
             AND C.OTS_STS_CD NOT IN ('D','E','L','A')
/*	2009-02-17 O Wan-Ki      1.6 Status Summary - Aging Overdue별 집계쿼리보완. */
             AND DECODE((SELECT COUNT(1) FROM tpb_ots_grp_sts WHERE ots_sts_cd = 'T' AND n3pty_no = a.n3pty_no),0,TRUNC(SYSDATE - a.cfm_dt),TRUNC(SYSDATE-(SELECT MAX(cre_dt) FROM tpb_ots_grp_sts WHERE ots_sts_cd = 'T' AND n3pty_no = a.n3pty_no))) <= '30'
#if (${s_exclude_roc_requested} == 'Y')
             AND ( c.ots_sts_cd IN ('O','M','I','N','Y') OR ( c.ots_sts_cd IN ('R','J','K') AND EXISTS ( SELECT 0 FROM tpb_adj_sts e WHERE e.n3pty_no=a.n3pty_no AND e.n3pty_stl_tp_cd IN ('D','C','W') AND e.stl_sts_lst_flg = 'Y' ) ) )
#end
             AND a.ofc_cd IN (
                      SELECT   OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   '(TOTAL)' AS OFC
                      FROM     DUAL
                             )
        GROUP BY ROLLUP(m.rhq, m.ofc)
          HAVING GROUPING(m.rhq)=1 OR GROUPING(m.ofc)=0
       ) a,
       (
          -- 31~60 days
          SELECT NVL(m.rhq,'(TOTAL)') rhq, NVL(m.ofc,'(TOTAL)') ofc
                ,COUNT(0) cnt
                ,SUM(TPB_GET_USD_AMT_FNC(a.ots_amt,a.curr_cd,TPB_GET_LCL_DATE_FNC(ADD_MONTHS(sysdate,0),a.ofc_cd))) amt        --[CHM-201322948]
            FROM TPB_OTS_GRP a, TPB_OTS_GRP_STS c,
                 (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   999 AS SEQ
                             , '(TOTAL)' AS RHQ
                             , '(TOTAL)' AS OFC
                      FROM     DUAL
                 ) m
           WHERE a.n3pty_no = c.n3pty_no
             AND a.ofc_cd = m.ofc
             AND a.n3pty_delt_tp_cd IN ('N')
             AND a.n3pty_bil_tp_cd IN (
#if (${s_exclude_jo} == 'X') -- excluding JO
	/* 2009-02-03 O Wan-Ki      1.5 Bill Type Code : MX 누락에 의한 보완 */
                                        SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd NOT IN ('JO') AND ACT_FLG='Y' UNION ALL SELECT 'MX' n3pty_bil_tp_cd FROM DUAL
#elseif (${s_exclude_jo} == 'O') 
                                        SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd IN ('JO') AND ACT_FLG='Y'
#elseif (${s_exclude_jo} == 'A')
			SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE ACT_FLG='Y' UNION ALL SELECT 'MX' N3PTY_BIL_TP_CD FROM DUAL
#end
                                      )
             AND c.ots_sts_lst_flg = 'Y'
             --AND c.ots_sts_cd IN ('O','M','I','N','R','J','K','Y')                                                    -- 'L','A' close상태, 제외
             AND C.OTS_STS_CD NOT IN ('D','E','L','A')
/*	2009-02-17 O Wan-Ki      1.6 Status Summary - Aging Overdue별 집계쿼리보완. */
             AND DECODE((SELECT COUNT(1) FROM tpb_ots_grp_sts WHERE ots_sts_cd = 'T' AND n3pty_no = a.n3pty_no),0,TRUNC(SYSDATE - a.cfm_dt),TRUNC(SYSDATE-(SELECT MAX(cre_dt) FROM tpb_ots_grp_sts WHERE ots_sts_cd = 'T' AND n3pty_no = a.n3pty_no))) >= '31'
             AND DECODE((SELECT COUNT(1) FROM tpb_ots_grp_sts WHERE ots_sts_cd = 'T' AND n3pty_no = a.n3pty_no),0,TRUNC(SYSDATE - a.cfm_dt),TRUNC(SYSDATE-(SELECT MAX(cre_dt) FROM tpb_ots_grp_sts WHERE ots_sts_cd = 'T' AND n3pty_no = a.n3pty_no))) <= '60'
#if (${s_exclude_roc_requested} == 'Y')
             AND ( c.ots_sts_cd IN ('O','M','I','N','Y') OR ( c.ots_sts_cd IN ('R','J','K') AND EXISTS ( SELECT 0 FROM tpb_adj_sts e WHERE e.n3pty_no=a.n3pty_no AND e.n3pty_stl_tp_cd IN ('D','C','W') AND e.stl_sts_lst_flg = 'Y' ) ) )
#end
             AND a.ofc_cd IN (
                      SELECT   OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   '(TOTAL)' AS OFC
                      FROM     DUAL
                             )
        GROUP BY ROLLUP(m.rhq, m.ofc)
          HAVING GROUPING(m.rhq)=1 OR GROUPING(m.ofc)=0
       ) b,
       (
          -- 61~90 days
          SELECT NVL(m.rhq,'(TOTAL)') rhq, NVL(m.ofc,'(TOTAL)') ofc
                ,COUNT(0) cnt
                ,SUM(TPB_GET_USD_AMT_FNC(a.ots_amt,a.curr_cd,TPB_GET_LCL_DATE_FNC(ADD_MONTHS(sysdate,0),a.ofc_cd))) amt        --[CHM-201322948]
            FROM TPB_OTS_GRP a, TPB_OTS_GRP_STS c,
                 (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   999 AS SEQ
                             , '(TOTAL)' AS RHQ
                             , '(TOTAL)' AS OFC
                      FROM     DUAL
                 ) m
           WHERE a.n3pty_no = c.n3pty_no
             AND a.ofc_cd = m.ofc
             AND a.n3pty_delt_tp_cd IN ('N')
             AND a.n3pty_bil_tp_cd IN (
#if (${s_exclude_jo} == 'X') -- excluding JO
	/* 2009-02-03 O Wan-Ki      1.5 Bill Type Code : MX 누락에 의한 보완 */
                                        SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd NOT IN ('JO') AND ACT_FLG='Y' UNION ALL SELECT 'MX' n3pty_bil_tp_cd FROM DUAL
#elseif (${s_exclude_jo} == 'O') 
                                        SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd IN ('JO') AND ACT_FLG='Y'
#elseif (${s_exclude_jo} == 'A')
			SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE ACT_FLG='Y' UNION ALL SELECT 'MX' N3PTY_BIL_TP_CD FROM DUAL
#end
                                      )
             AND c.ots_sts_lst_flg = 'Y'
             --AND c.ots_sts_cd IN ('O','M','I','N','R','J','K','Y')                                                    -- 'L','A' close상태, 제외
             AND C.OTS_STS_CD NOT IN ('D','E','L','A')
/*	2009-02-17 O Wan-Ki      1.6 Status Summary - Aging Overdue별 집계쿼리보완. */
             AND DECODE((SELECT COUNT(1) FROM tpb_ots_grp_sts WHERE ots_sts_cd = 'T' AND n3pty_no = a.n3pty_no),0,TRUNC(SYSDATE - a.cfm_dt),TRUNC(SYSDATE-(SELECT MAX(cre_dt) FROM tpb_ots_grp_sts WHERE ots_sts_cd = 'T' AND n3pty_no = a.n3pty_no))) >= '61'
             AND DECODE((SELECT COUNT(1) FROM tpb_ots_grp_sts WHERE ots_sts_cd = 'T' AND n3pty_no = a.n3pty_no),0,TRUNC(SYSDATE - a.cfm_dt),TRUNC(SYSDATE-(SELECT MAX(cre_dt) FROM tpb_ots_grp_sts WHERE ots_sts_cd = 'T' AND n3pty_no = a.n3pty_no))) <= '90'

#if (${s_exclude_roc_requested} == 'Y')
             AND ( c.ots_sts_cd IN ('O','M','I','N','Y') OR ( c.ots_sts_cd IN ('R','J','K') AND EXISTS ( SELECT 0 FROM tpb_adj_sts e WHERE e.n3pty_no=a.n3pty_no AND e.n3pty_stl_tp_cd IN ('D','C','W') AND e.stl_sts_lst_flg = 'Y' ) ) )
#end
             AND a.ofc_cd IN (
                      SELECT   OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   '(TOTAL)' AS OFC
                      FROM     DUAL
                             )
        GROUP BY ROLLUP(m.rhq, m.ofc)
          HAVING GROUPING(m.rhq)=1 OR GROUPING(m.ofc)=0
       ) c,
       (
          -- 91~180 days
          SELECT NVL(m.rhq,'(TOTAL)') rhq, NVL(m.ofc,'(TOTAL)') ofc
                ,COUNT(0) cnt
                ,SUM(TPB_GET_USD_AMT_FNC(a.ots_amt,a.curr_cd,TPB_GET_LCL_DATE_FNC(ADD_MONTHS(sysdate,0),a.ofc_cd))) amt        --[CHM-201322948]
            FROM TPB_OTS_GRP a, TPB_OTS_GRP_STS c,
                 (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   999 AS SEQ
                             , '(TOTAL)' AS RHQ
                             , '(TOTAL)' AS OFC
                      FROM     DUAL
                 ) m
           WHERE a.n3pty_no = c.n3pty_no
             AND a.ofc_cd = m.ofc
             AND a.n3pty_delt_tp_cd IN ('N')
             AND a.n3pty_bil_tp_cd IN (
#if (${s_exclude_jo} == 'X') -- excluding JO
	/* 2009-02-03 O Wan-Ki      1.5 Bill Type Code : MX 누락에 의한 보완 */
                                        SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd NOT IN ('JO') AND ACT_FLG='Y' UNION ALL SELECT 'MX' n3pty_bil_tp_cd FROM DUAL
#elseif (${s_exclude_jo} == 'O') 
                                        SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd IN ('JO') AND ACT_FLG='Y'
#elseif (${s_exclude_jo} == 'A')
			SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE ACT_FLG='Y' UNION ALL SELECT 'MX' N3PTY_BIL_TP_CD FROM DUAL
#end
)
             AND c.ots_sts_lst_flg = 'Y'
             --AND c.ots_sts_cd IN ('O','M','I','N','R','J','K','Y')                                                    -- 'L','A' close상태, 제외
             AND C.OTS_STS_CD NOT IN ('D','E','L','A')

/*	2009-02-17 O Wan-Ki      1.6 Status Summary - Aging Overdue별 집계쿼리보완. */
             AND DECODE((SELECT COUNT(1) FROM tpb_ots_grp_sts WHERE ots_sts_cd = 'T' AND n3pty_no = a.n3pty_no),0,TRUNC(SYSDATE - a.cfm_dt),TRUNC(SYSDATE-(SELECT MAX(cre_dt) FROM tpb_ots_grp_sts WHERE ots_sts_cd = 'T' AND n3pty_no = a.n3pty_no))) >= '91'
             AND DECODE((SELECT COUNT(1) FROM tpb_ots_grp_sts WHERE ots_sts_cd = 'T' AND n3pty_no = a.n3pty_no),0,TRUNC(SYSDATE - a.cfm_dt),TRUNC(SYSDATE-(SELECT MAX(cre_dt) FROM tpb_ots_grp_sts WHERE ots_sts_cd = 'T' AND n3pty_no = a.n3pty_no))) <= '180'

#if (${s_exclude_roc_requested} == 'Y')
             AND ( c.ots_sts_cd IN ('O','M','I','N','Y') OR ( c.ots_sts_cd IN ('R','J','K') AND EXISTS ( SELECT 0 FROM tpb_adj_sts e WHERE e.n3pty_no=a.n3pty_no AND e.n3pty_stl_tp_cd IN ('D','C','W') AND e.stl_sts_lst_flg = 'Y' ) ) )
#end
             AND a.ofc_cd IN (
                      SELECT   OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   '(TOTAL)' AS OFC
                      FROM     DUAL
                             )
        GROUP BY ROLLUP(m.rhq, m.ofc)
          HAVING GROUPING(m.rhq)=1 OR GROUPING(m.ofc)=0
       ) d,
       (
          -- over 180 days
          SELECT NVL(m.rhq,'(TOTAL)') rhq, NVL(m.ofc,'(TOTAL)') ofc
                ,COUNT(0) cnt
                ,SUM(TPB_GET_USD_AMT_FNC(a.ots_amt,a.curr_cd,TPB_GET_LCL_DATE_FNC(ADD_MONTHS(sysdate,0),a.ofc_cd))) amt        --[CHM-201322948]
            FROM TPB_OTS_GRP a, TPB_OTS_GRP_STS c,
                 (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   999 AS SEQ
                             , '(TOTAL)' AS RHQ
                             , '(TOTAL)' AS OFC
                      FROM     DUAL
                 ) m
           WHERE a.n3pty_no = c.n3pty_no
             AND a.ofc_cd = m.ofc
             AND a.n3pty_delt_tp_cd IN ('N')
             AND a.n3pty_bil_tp_cd IN (
#if (${s_exclude_jo} == 'X') -- excluding JO
	/* 2009-02-03 O Wan-Ki      1.5 Bill Type Code : MX 누락에 의한 보완 */
                                        SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd NOT IN ('JO') AND ACT_FLG='Y' UNION ALL SELECT 'MX' n3pty_bil_tp_cd FROM DUAL
#elseif (${s_exclude_jo} == 'O') 
                                        SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd IN ('JO') AND ACT_FLG='Y'
#elseif (${s_exclude_jo} == 'A')
			SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE ACT_FLG='Y' UNION ALL SELECT 'MX' N3PTY_BIL_TP_CD FROM DUAL
#end
                                      )
             AND c.ots_sts_lst_flg = 'Y'
             --AND c.ots_sts_cd IN ('O','M','I','N','R','J','K','Y')                                                    -- 'L','A' close상태, 제외
             AND C.OTS_STS_CD NOT IN ('D','E','L','A')

/*	2009-02-17 O Wan-Ki      1.6 Status Summary - Aging Overdue별 집계쿼리보완. */
             AND DECODE((SELECT COUNT(1) FROM tpb_ots_grp_sts WHERE ots_sts_cd = 'T' AND n3pty_no = a.n3pty_no),0,TRUNC(SYSDATE - a.cfm_dt),TRUNC(SYSDATE-(SELECT MAX(cre_dt) FROM tpb_ots_grp_sts WHERE ots_sts_cd = 'T' AND n3pty_no = a.n3pty_no))) >= '181'

#if (${s_exclude_roc_requested} == 'Y')
             AND ( c.ots_sts_cd IN ('O','M','I','N','Y') OR ( c.ots_sts_cd IN ('R','J','K') AND EXISTS ( SELECT 0 FROM tpb_adj_sts e WHERE e.n3pty_no=a.n3pty_no AND e.n3pty_stl_tp_cd IN ('D','C','W') AND e.stl_sts_lst_flg = 'Y' ) ) )
#end
             AND a.ofc_cd IN (
                      SELECT   OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   '(TOTAL)' AS OFC
                      FROM     DUAL
                             )
        GROUP BY ROLLUP(m.rhq, m.ofc)
          HAVING GROUPING(m.rhq)=1 OR GROUPING(m.ofc)=0
       ) e
 WHERE 1 = 1
   AND o.rhq = a.rhq(+) AND o.ofc = a.ofc(+)
   AND o.rhq = b.rhq(+) AND o.ofc = b.ofc(+)
   AND o.rhq = c.rhq(+) AND o.ofc = c.ofc(+)
   AND o.rhq = d.rhq(+) AND o.ofc = d.ofc(+)
   AND o.rhq = e.rhq(+) AND o.ofc = e.ofc(+)
 ORDER BY o.seq, o.rhq, o.ofc
 
#elseif (${s_status} == 'C') ---- 4. Current Status

SELECT   O.RHQ AS IF_RHQ_CD
       , O.OFC AS IF_OFC_CD
       , NVL(A.CNT,0) CNT_A, NVL(A.AMT,0) AMT_A
       , NVL(B.CNT,0) CNT_B, NVL(B.AMT,0) AMT_B
       , NVL(C.CNT,0) CNT_C, NVL(C.AMT,0) AMT_C
       , NVL(D.CNT,0) CNT_D, NVL(D.AMT,0) AMT_D
       , NVL(E.CNT,0) CNT_E, NVL(E.AMT,0) AMT_E
       , NVL(B.CNT,0)+NVL(C.CNT,0)+NVL(D.CNT,0)+NVL(E.CNT,0) CNT_TOT
       , NVL(B.AMT,0)+NVL(C.AMT,0)+NVL(D.AMT,0)+NVL(E.AMT,0) AMT_TOT
FROM     (
           SELECT   0 AS SEQ
                  , RHQ_CD AS RHQ
                  , OFC_CD
           FROM     TPB_HNDL_OFC
           WHERE    1 = 1
           AND      N3PTY_OFC_TP_CD = 'T'
           AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
           AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
           AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
           AND      OFC_CD = @[s_if_ofc_cd]
#end
           UNION ALL
           SELECT   999 AS SEQ
                  , '(TOTAL)' AS RHQ
                  , '(TOTAL)' AS OFC
           FROM     DUAL
         ) O
       , (
          -- Open
          SELECT NVL(m.rhq,'(TOTAL)') rhq, NVL(m.ofc,'(TOTAL)') ofc
                ,COUNT(0) cnt
                ,SUM(TPB_GET_USD_AMT_FNC(a.ots_amt,a.curr_cd,TPB_GET_LCL_DATE_FNC(ADD_MONTHS(sysdate,-1),a.ofc_cd))) amt
            FROM TPB_OTS_GRP a, TPB_OTS_GRP_STS c,
                 (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   999 AS SEQ
                             , '(TOTAL)' AS RHQ
                             , '(TOTAL)' AS OFC
                      FROM     DUAL
                 ) m            
           WHERE a.n3pty_no = c.n3pty_no
             AND a.ofc_cd = m.ofc
             AND a.n3pty_delt_tp_cd IN ('N')
             AND a.n3pty_bil_tp_cd IN (
#if (${s_exclude_jo} == 'X') -- excluding JO
	/* 2009-02-03 O Wan-Ki      1.5 Bill Type Code : MX 누락에 의한 보완 */
                                        SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd NOT IN ('JO') AND ACT_FLG='Y' UNION ALL SELECT 'MX' n3pty_bil_tp_cd FROM DUAL
#elseif (${s_exclude_jo} == 'O') 
                                        SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD IN ('JO') AND ACT_FLG = 'Y'
#elseif (${s_exclude_jo} == 'A')
			SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE ACT_FLG='Y' UNION ALL SELECT 'MX' N3PTY_BIL_TP_CD FROM DUAL
#end
)
             AND C.OTS_STS_LST_FLG = 'Y'
             AND C.OTS_STS_CD NOT IN ('D','E','L','A')
#if (${s_exclude_roc_requested} == 'Y')
             AND ( C.OTS_STS_CD IN ('O','M','I','N','Y') OR ( C.OTS_STS_CD IN ('R','J','K') AND EXISTS ( SELECT 0 FROM TPB_ADJ_STS E WHERE E.N3PTY_NO=A.N3PTY_NO AND E.N3PTY_STL_TP_CD IN ('D','C','W') AND E.STL_STS_LST_FLG = 'Y' ) ) )
#end
             AND A.OFC_CD IN (
                      SELECT   OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   '(TOTAL)' AS OFC
                      FROM     DUAL
                             )
        GROUP BY ROLLUP(M.RHQ, M.OFC)
          HAVING GROUPING(M.RHQ)=1 OR GROUPING(M.OFC)=0
       ) A,
       (
          -- CLOSED ERP I/F
          SELECT NVL(M.RHQ,'(TOTAL)') RHQ, NVL(M.OFC,'(TOTAL)') OFC
                ,COUNT(0) CNT
                ,SUM(TPB_GET_USD_AMT_FNC(A.CLT_AMT,A.CURR_CD,TPB_GET_LCL_DATE_FNC(C.OTS_STS_CRE_DT,A.OFC_CD))) AMT
            FROM TPB_OTS_GRP A, TPB_OTS_GRP_STS C,
                 (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   999 AS SEQ
                             , '(TOTAL)' AS RHQ
                             , '(TOTAL)' AS OFC
                      FROM     DUAL
                 ) M
           WHERE A.N3PTY_NO = C.N3PTY_NO
             AND A.OFC_CD = M.OFC
             AND A.N3PTY_DELT_TP_CD IN ('N')
             AND A.N3PTY_BIL_TP_CD IN (
#if (${s_exclude_jo} == 'X') -- excluding JO
	/* 2009-02-03 O Wan-Ki      1.5 Bill Type Code : MX 누락에 의한 보완 */
                                        SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD NOT IN ('JO') AND ACT_FLG='Y' UNION ALL SELECT 'MX' N3PTY_BIL_TP_CD FROM DUAL
#elseif (${s_exclude_jo} == 'O') 
                                        SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD IN ('JO') AND ACT_FLG = 'Y'
#elseif (${s_exclude_jo} == 'A')
			SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE ACT_FLG='Y' UNION ALL SELECT 'MX' N3PTY_BIL_TP_CD FROM DUAL
#end
                                      )
             AND C.OTS_STS_LST_FLG = 'Y'
             AND C.OTS_STS_CD IN ('E','L','A') -- ADD L A
             AND ( A.ADJ_AMT IS NULL OR A.ADJ_AMT = 0 )
             AND A.OFC_CD IN (
                      SELECT   OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   '(TOTAL)' AS OFC
                      FROM     DUAL
                             )
        GROUP BY ROLLUP(M.RHQ, M.OFC)
          HAVING GROUPING(M.RHQ)=1 OR GROUPING(M.OFC)=0
       ) B,
       (
          -- Closed Write-Off
          SELECT NVL(M.RHQ,'(TOTAL)') RHQ, NVL(M.OFC,'(TOTAL)') OFC
                ,COUNT(0) CNT
                ,SUM(TPB_GET_USD_AMT_FNC(A.ADJ_AMT,A.CURR_CD,TPB_GET_LCL_DATE_FNC(C.OTS_STS_CRE_DT,A.OFC_CD))) AMT
            FROM TPB_OTS_GRP A, TPB_OTS_GRP_STS C,
                 (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   999 AS SEQ
                             , '(TOTAL)' AS RHQ
                             , '(TOTAL)' AS OFC
                      FROM     DUAL
                 ) M
           WHERE A.N3PTY_NO = C.N3PTY_NO
             AND A.OFC_CD = M.OFC
             AND A.N3PTY_DELT_TP_CD IN ('N')
             AND A.N3PTY_BIL_TP_CD IN (
#if (${s_exclude_jo} == 'X') -- excluding JO
	/* 2009-02-03 O Wan-Ki      1.5 Bill Type Code : MX 누락에 의한 보완 */
                                        SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD NOT IN ('JO') AND ACT_FLG='Y' UNION ALL SELECT 'MX' N3PTY_BIL_TP_CD FROM DUAL
#elseif (${s_exclude_jo} == 'O') 
                                        SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD IN ('JO') AND ACT_FLG='Y'
#elseif (${s_exclude_jo} == 'A')
			SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE ACT_FLG='Y' UNION ALL SELECT 'MX' N3PTY_BIL_TP_CD FROM DUAL
#end
)
             AND C.OTS_STS_LST_FLG = 'Y'
             AND C.OTS_STS_CD IN ('E')
             AND A.ADJ_AMT != 0
             AND A.OFC_CD IN (
                                SELECT OFC_CD OFC
                                  FROM TPB_HNDL_OFC
                                 WHERE N3PTY_OFC_TP_CD = 'T'
#if (${s_if_rhq_cd} != '' )
                                   AND RHQ_CD = @[s_if_rhq_cd]     /* bind */
#end
#if (${s_if_ctrl_cd} != '' )
                                   AND N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                                   AND OFC_CD = @[s_if_ofc_cd]     /* bind */
#end
                             UNION ALL
                                SELECT '(TOTAL)' OFC
                                  FROM DUAL
                             )
        GROUP BY ROLLUP(M.RHQ, M.OFC)
          HAVING GROUPING(M.RHQ)=1 OR GROUPING(M.OFC)=0
       ) C,
       (
          -- Closed ROC
          SELECT NVL(M.RHQ,'(TOTAL)') RHQ, NVL(M.OFC,'(TOTAL)') OFC
                ,COUNT(0) CNT
                ,SUM(TPB_GET_USD_AMT_FNC(A.OTS_AMT,A.CURR_CD,TPB_GET_LCL_DATE_FNC(C.OTS_STS_CRE_DT,A.OFC_CD))) AMT
            FROM TPB_OTS_GRP A, TPB_OTS_GRP_STS C,
                 (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   999 AS SEQ
                             , '(TOTAL)' AS RHQ
                             , '(TOTAL)' AS OFC
                      FROM     DUAL
                 ) M
           WHERE A.N3PTY_NO = C.N3PTY_NO
             AND A.OFC_CD = M.OFC
             AND A.N3PTY_DELT_TP_CD IN ('N')
             AND A.N3PTY_BIL_TP_CD IN (
#if (${s_exclude_jo} == 'X') -- excluding JO
	/* 2009-02-03 O Wan-Ki      1.5 Bill Type Code : MX 누락에 의한 보완 */
                                        SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD NOT IN ('JO') AND ACT_FLG='Y' UNION ALL SELECT 'MX' N3PTY_BIL_TP_CD FROM DUAL
#elseif (${s_exclude_jo} == 'O') 
                                        SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD IN ('JO') AND ACT_FLG = 'Y'
#elseif (${s_exclude_jo} == 'A')
			SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE ACT_FLG = 'Y' UNION ALL SELECT 'MX' N3PTY_BIL_TP_CD FROM DUAL
#end
)
             AND C.OTS_STS_LST_FLG = 'Y'
             AND C.OTS_STS_CD IN ('E')
             AND A.OFC_CD IN (
                      SELECT   OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   '(TOTAL)' AS OFC
                      FROM     DUAL
                             )
        GROUP BY ROLLUP(M.RHQ, M.OFC)
          HAVING GROUPING(M.RHQ)=1 OR GROUPING(M.OFC)=0
       ) D,
       (
          -- PROCESS CLOSE
          SELECT NVL(M.RHQ,'(TOTAL)') RHQ, NVL(M.OFC,'(TOTAL)') OFC
                ,COUNT(0) CNT
                ,SUM(TPB_GET_USD_AMT_FNC(A.OTS_AMT,A.CURR_CD,TPB_GET_LCL_DATE_FNC(C.OTS_STS_CRE_DT,A.OFC_CD))) AMT
            FROM TPB_OTS_GRP A, TPB_OTS_GRP_STS C,
                 (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   999 AS SEQ
                             , '(TOTAL)' AS RHQ
                             , '(TOTAL)' AS OFC
                      FROM     DUAL
                 ) M
           WHERE A.N3PTY_NO = C.N3PTY_NO
             AND A.OFC_CD = M.OFC
             AND A.N3PTY_DELT_TP_CD IN ('C')
             AND A.N3PTY_BIL_TP_CD IN (
#if (${s_exclude_jo} == 'X') -- excluding JO
	/* 2009-02-03 O Wan-Ki      1.5 Bill Type Code : MX 누락에 의한 보완 */
                                        SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD NOT IN ('JO') AND ACT_FLG = 'Y' UNION ALL SELECT 'MX' N3PTY_BIL_TP_CD FROM DUAL
#elseif (${s_exclude_jo} == 'O') 
                                        SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD IN ('JO') AND ACT_FLG='Y'
#elseif (${s_exclude_jo} == 'A')
			SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE ACT_FLG = 'Y' UNION ALL SELECT 'MX' N3PTY_BIL_TP_CD FROM DUAL
#end
                                      )
             AND C.OTS_STS_LST_FLG = 'Y'
             AND A.OFC_CD IN (
                      SELECT   OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '' )
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '' )
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '' )
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                      UNION ALL
                      SELECT   '(TOTAL)' AS OFC
                      FROM     DUAL
                             )
        GROUP BY ROLLUP(M.RHQ, M.OFC)
          HAVING GROUPING(M.RHQ)=1 OR GROUPING(M.OFC)=0
       ) E
WHERE    1 = 1
AND      O.RHQ = A.RHQ(+)
AND      O.OFC = A.OFC(+)
AND      O.RHQ = B.RHQ(+)
AND      O.OFC = B.OFC(+)
AND      O.RHQ = C.RHQ(+)
AND      O.OFC = C.OFC(+)
AND      O.RHQ = D.RHQ(+)
AND      O.OFC = D.OFC(+)
AND      O.RHQ = E.RHQ(+)
AND      O.OFC = E.OFC(+)
ORDER BY O.SEQ
       , O.RHQ
       , O.OFC
#end			]]></sql>
			<params>
				<param name="s_if_rhq_cd" type="12" value="" out="N"/>
				<param name="s_if_ctrl_cd" type="12" value="" out="N"/>
				<param name="s_if_ofc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
