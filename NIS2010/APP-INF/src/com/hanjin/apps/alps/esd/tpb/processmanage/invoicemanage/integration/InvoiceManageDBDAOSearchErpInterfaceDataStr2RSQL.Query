<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="InvoiceManageDBDAOSearchErpInterfaceDataStr2RSQL">
			<desc><![CDATA[SearchErpInterfaceDataStr2]]></desc>
			<sql><![CDATA[
SELECT  ----- GENERAL BILLING CASE
    @[ar_if_no] As ar_if_no,
    dtl.n3pty_inv_rvis_dtl_seq As chg_seq,
    bt.chg_cd As n3pty_inv_chg_tp_cd,       /* Like 3CC (general), 'XXX' ('JO' case) */
    CASE WHEN bt.chg_cd = 'VGA' OR bt.chg_cd = 'VGO' OR bt.chg_cd = 'VGP' OR bt.chg_cd = 'VGW' THEN NVL(dtl.inv_dtl_amt,0) + NVL(dtl.add_amt,0) - NVL(dtl.rev_amt,0) 
         ELSE NVL(dtl.inv_dtl_amt,0) - NVL(dtl.rev_amt,0) 
    END As chg_amt,
    --NVL(dtl.inv_dtl_amt,0) - NVL(dtl.rev_amt,0) As chg_amt,
    COMMCODE_PKG.GET_COMDTL_NAME_FNC('CD01394',bt.chg_cd ) As chg_full_nm,  /* ADDED CHARGE TYPE CODE NAME ... */
    hdr.curr_cd As chg_curr_cd,
    DECODE(dtl.n3pty_bil_tp_cd, 'JO','954117',NULL) As rev_acct_cd,
    --DECODE(nvl(otl.n3pty_tp_cd,'X'), 'R', bt.rev_acct_cd, DECODE(ots.n3pty_expn_tp_cd, 'TES','512181', 'TRS','512381', 'MNR','511581', 'PSO','511881', NULL)) As acct_cd,   /* ACCT_CD DECISION */
    bt.rev_acct_cd As acct_cd,   /* ACCT_CD DECISION */
    null As inv_if_flg,
    null As inv_if_no,
    TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') As inv_if_dt,
    inv.ofc_cd As inv_if_ofc_cd,
    null As cre_usr_id,
    TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') As cre_dt,
    null As upd_usr_id,
    TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') As upd_dt,
	@[user_ofc_cd] user_ofc_cd, @[user_id] user_id
FROM TPB_OTS_GRP ots, TPB_INVOICE inv, TPB_INV_RVIS hdr, TPB_INV_RVIS_DTL dtl, TPB_OTS_DTL otl, TPB_N3RD_PTY_BIL_TP  bt
WHERE inv.n3pty_inv_no = hdr.n3pty_inv_no
    AND inv.n3pty_inv_no = dtl.n3pty_inv_no
    AND inv.n3pty_inv_no = ots.n3pty_inv_no
    AND hdr.n3pty_inv_rvis_seq = dtl.n3pty_inv_rvis_seq
    AND dtl.n3pty_no = ots.n3pty_no
    AND ots.n3pty_no = otl.n3pty_no
    AND otl.n3pty_no_dp_seq = 1
    AND ots.n3pty_delt_tp_cd = 'N'
    AND inv.n3pty_delt_tp_cd = 'N'
    AND hdr.n3pty_delt_tp_cd = 'N'
    AND dtl.n3pty_delt_tp_cd = 'N'
    AND hdr.n3pty_inv_no = @[s_n3pty_inv_no]
    AND hdr.n3pty_inv_rvis_seq = @[s_n3pty_inv_his_seq]
    AND dtl.n3pty_bil_tp_cd = bt.n3pty_bil_tp_cd
----- ----- -----
UNION ALL -------
----- ----- -----
SELECT  ----- 'JO' BILLING CASE - REVENUE
    @[ar_if_no] As ar_if_no,
    ( SELECT MAX(n3pty_inv_rvis_dtl_seq) FROM TPB_INV_RVIS_DTL aa WHERE aa.n3pty_inv_no = hdr.n3pty_inv_no AND aa.n3pty_inv_rvis_seq = hdr.n3pty_inv_rvis_seq ) + ROWNUM As chg_seq,
    'TPC' As n3pty_inv_chg_tp_cd,                              /* TPC (case 'JO' Revenue) */
    NVL(dtl.rev_amt,0) As chg_amt,
    COMMCODE_PKG.GET_COMDTL_NAME_FNC('CD01394','TPC') As chg_full_nm,   /* ADDED CHARGE TYPE CODE NAME ... */
    hdr.curr_cd As chg_curr_cd,
    DECODE(dtl.n3pty_bil_tp_cd, 'JO','954117',NULL) As rev_acct_cd,
    DECODE(ots.n3pty_expn_tp_cd, 'TES','512181', 'TRS','512381', 'MNR','511581', 'PSO','511881', NULL) As acct_cd,   /* ACCT_CD DECISION */
    null As inv_if_flg,
    null As inv_if_no,
    TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') As inv_if_dt,
    inv.ofc_cd As inv_if_ofc_cd,
    null As cre_usr_id,
    TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') As cre_dt,
    null As upd_usr_id,
    TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') As upd_dt,
	@[user_ofc_cd] user_ofc_cd, @[user_id] user_id
FROM TPB_OTS_GRP ots, TPB_INVOICE inv, TPB_INV_RVIS hdr, TPB_INV_RVIS_DTL dtl
WHERE inv.n3pty_inv_no = hdr.n3pty_inv_no
    AND inv.n3pty_inv_no = dtl.n3pty_inv_no
    AND inv.n3pty_inv_no = ots.n3pty_inv_no
    AND hdr.n3pty_inv_rvis_seq = dtl.n3pty_inv_rvis_seq
    AND dtl.n3pty_no = ots.n3pty_no
    AND ots.n3pty_delt_tp_cd = 'N'
    AND inv.n3pty_delt_tp_cd = 'N'
    AND hdr.n3pty_delt_tp_cd = 'N'
    AND dtl.n3pty_delt_tp_cd = 'N'
    AND hdr.n3pty_inv_no = @[s_n3pty_inv_no]
    AND hdr.n3pty_inv_rvis_seq = @[s_n3pty_inv_his_seq]
    AND dtl.n3pty_bil_tp_cd = 'JO'                          /* Only JO */
    AND ( dtl.rev_amt IS NOT NULL AND dtl.rev_amt != 0.0 )   /* rev_amt is not null and not 0.0 ... */
----- ----- -----
UNION ALL -------
----- ----- -----
SELECT ----- TAX CASE
    @[ar_if_no] As ar_if_no,
    ( SELECT MAX(n3pty_inv_rvis_dtl_seq) FROM TPB_INV_RVIS_DTL aa WHERE aa.n3pty_inv_no = hdr.n3pty_inv_no AND aa.n3pty_inv_rvis_seq = hdr.n3pty_inv_rvis_seq )    --- CHG_SEQ -- START 
    + ( SELECT COUNT(0) CNT
        FROM TPB_OTS_GRP ots1, TPB_INVOICE inv1, TPB_INV_RVIS hdr1, TPB_INV_RVIS_DTL dtl1
        WHERE inv1.n3pty_inv_no = hdr1.n3pty_inv_no
            AND inv1.n3pty_inv_no = dtl1.n3pty_inv_no
            AND inv1.n3pty_inv_no = ots1.n3pty_inv_no
            AND hdr1.n3pty_inv_rvis_seq = dtl1.n3pty_inv_rvis_seq
            AND dtl1.n3pty_no = ots1.n3pty_no
            AND ots1.n3pty_delt_tp_cd = 'N'
            AND inv1.n3pty_delt_tp_cd = 'N'
            AND hdr1.n3pty_delt_tp_cd = 'N'
            AND dtl1.n3pty_delt_tp_cd = 'N'
            AND hdr1.n3pty_inv_no = hdr.n3pty_inv_no
            AND hdr1.n3pty_inv_rvis_seq = hdr.n3pty_inv_rvis_seq
            AND dtl1.n3pty_bil_tp_cd = 'JO'                             /* Only JO */
            AND ( dtl1.rev_amt IS NOT NULL AND dtl1.rev_amt != 0.0 )   /* rev_amt is not null and not 01.0 1.1.1. */
      )
    + ROWNUM As chg_seq,                                               --- CHG_SEQ -- END
    'TVA' As ar_inv_chg_tp_cd,                                         /* VAT Case ... TVA */
    NVL(hdr.vat_amt,0) As chg_amt,
    COMMCODE_PKG.GET_COMDTL_NAME_FNC('CD01394','TVA') As chg_full_nm,   /* ADDED CHARGE TYPE CODE NAME */
    hdr.curr_cd As chg_curr_cd,
    DECODE(dtl.n3pty_bil_tp_cd, 'JO','954117', NULL) As rev_acct_cd,
    '954117' As acct_cd,      /* TVA case, '954117' */
    null As inv_if_flg,
    null As inv_if_no,
    TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') As inv_if_dt,
    inv.ofc_cd As inv_if_ofc_cd,
    null As cre_usr_id,
    TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') As cre_dt,
    null As upd_usr_id,
    TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') As upd_dt,
	@[user_ofc_cd] user_ofc_cd, @[user_id] user_id
FROM TPB_OTS_GRP ots, TPB_INVOICE inv, TPB_INV_RVIS hdr, TPB_INV_RVIS_DTL dtl
WHERE inv.n3pty_inv_no = hdr.n3pty_inv_no
    AND inv.n3pty_inv_no = dtl.n3pty_inv_no
    AND inv.n3pty_inv_no = ots.n3pty_inv_no
    AND hdr.n3pty_inv_rvis_seq = dtl.n3pty_inv_rvis_seq
    AND dtl.n3pty_no = ots.n3pty_no
    AND ots.n3pty_delt_tp_cd = 'N'
    AND inv.n3pty_delt_tp_cd = 'N'
    AND hdr.n3pty_delt_tp_cd = 'N'
    AND dtl.n3pty_delt_tp_cd = 'N'
    AND hdr.n3pty_inv_no = @[s_n3pty_inv_no]
    AND hdr.n3pty_inv_rvis_seq = @[s_n3pty_inv_his_seq]
    AND ( hdr.vat_amt IS NOT NULL AND hdr.vat_amt > 0.0 )     /* VAT_AMT IS VALID */
    AND dtl.N3pty_inv_rvis_dtl_seq = 1                        /* 한 행만... */

UNION ALL 
SELECT ----- SBC CASE
    @[ar_if_no] As ar_if_no,
    ( SELECT MAX(n3pty_inv_rvis_dtl_seq)+1 FROM TPB_INV_RVIS_DTL aa WHERE aa.n3pty_inv_no = hdr.n3pty_inv_no AND aa.n3pty_inv_rvis_seq = hdr.n3pty_inv_rvis_seq )    --- CHG_SEQ -- START 
    + ( SELECT COUNT(0) CNT
        FROM TPB_OTS_GRP ots1, TPB_INVOICE inv1, TPB_INV_RVIS hdr1, TPB_INV_RVIS_DTL dtl1
        WHERE inv1.n3pty_inv_no = hdr1.n3pty_inv_no
            AND inv1.n3pty_inv_no = dtl1.n3pty_inv_no
            AND inv1.n3pty_inv_no = ots1.n3pty_inv_no
            AND hdr1.n3pty_inv_rvis_seq = dtl1.n3pty_inv_rvis_seq
            AND dtl1.n3pty_no = ots1.n3pty_no
            AND ots1.n3pty_delt_tp_cd = 'N'
            AND inv1.n3pty_delt_tp_cd = 'N'
            AND hdr1.n3pty_delt_tp_cd = 'N'
            AND dtl1.n3pty_delt_tp_cd = 'N'
            AND hdr1.n3pty_inv_no = hdr.n3pty_inv_no
            AND hdr1.n3pty_inv_rvis_seq = hdr.n3pty_inv_rvis_seq
            AND dtl1.n3pty_bil_tp_cd = 'JO'                            
            AND ( dtl1.rev_amt IS NOT NULL AND dtl1.rev_amt != 0.0 )  
      )
    + ROWNUM As chg_seq,                                  
    'SBC' As ar_inv_chg_tp_cd,    
    NVL(hdr.locl_tax_amt,0) As chg_amt,
    COMMCODE_PKG.GET_COMDTL_NAME_FNC('CD01394','TVA') As chg_full_nm,   
    hdr.curr_cd As chg_curr_cd,
    DECODE(dtl.n3pty_bil_tp_cd, 'JO','954117', NULL) As rev_acct_cd,
    '954117' As acct_cd,      /* SBC case, '954117' */
    null As inv_if_flg,
    null As inv_if_no,
    TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') As inv_if_dt,
    inv.ofc_cd As inv_if_ofc_cd,
    null As cre_usr_id,
    TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') As cre_dt,
    null As upd_usr_id,
    TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') As upd_dt,
	@[user_ofc_cd] user_ofc_cd, @[user_id] user_id
FROM TPB_OTS_GRP ots, TPB_INVOICE inv, TPB_INV_RVIS hdr, TPB_INV_RVIS_DTL dtl
WHERE inv.n3pty_inv_no = hdr.n3pty_inv_no
    AND inv.n3pty_inv_no = dtl.n3pty_inv_no
    AND inv.n3pty_inv_no = ots.n3pty_inv_no
    AND hdr.n3pty_inv_rvis_seq = dtl.n3pty_inv_rvis_seq
    AND dtl.n3pty_no = ots.n3pty_no
    AND ots.n3pty_delt_tp_cd = 'N'
    AND inv.n3pty_delt_tp_cd = 'N'
    AND hdr.n3pty_delt_tp_cd = 'N'
    AND dtl.n3pty_delt_tp_cd = 'N'
    AND hdr.n3pty_inv_no = @[s_n3pty_inv_no]
    AND hdr.n3pty_inv_rvis_seq = @[s_n3pty_inv_his_seq]
    AND ( hdr.locl_tax_amt IS NOT NULL AND hdr.locl_tax_amt > 0.0 )    
    AND dtl.N3pty_inv_rvis_dtl_seq = 1
UNION ALL 
SELECT ----- INDIA KKC CASE
    @[ar_if_no] As ar_if_no,
    ( SELECT MAX(n3pty_inv_rvis_dtl_seq)+2 FROM TPB_INV_RVIS_DTL aa WHERE aa.n3pty_inv_no = hdr.n3pty_inv_no AND aa.n3pty_inv_rvis_seq = hdr.n3pty_inv_rvis_seq )    --- CHG_SEQ -- START 
    + ( SELECT COUNT(0) CNT
        FROM TPB_OTS_GRP ots1, TPB_INVOICE inv1, TPB_INV_RVIS hdr1, TPB_INV_RVIS_DTL dtl1
        WHERE inv1.n3pty_inv_no = hdr1.n3pty_inv_no
            AND inv1.n3pty_inv_no = dtl1.n3pty_inv_no
            AND inv1.n3pty_inv_no = ots1.n3pty_inv_no
            AND hdr1.n3pty_inv_rvis_seq = dtl1.n3pty_inv_rvis_seq
            AND dtl1.n3pty_no = ots1.n3pty_no
            AND ots1.n3pty_delt_tp_cd = 'N'
            AND inv1.n3pty_delt_tp_cd = 'N'
            AND hdr1.n3pty_delt_tp_cd = 'N'
            AND dtl1.n3pty_delt_tp_cd = 'N'
            AND hdr1.n3pty_inv_no = hdr.n3pty_inv_no
            AND hdr1.n3pty_inv_rvis_seq = hdr.n3pty_inv_rvis_seq
            AND dtl1.n3pty_bil_tp_cd = 'JO'                            
            AND ( dtl1.rev_amt IS NOT NULL AND dtl1.rev_amt != 0.0 )  
      )
    + ROWNUM As chg_seq,                                  
    'KKC' As ar_inv_chg_tp_cd,    
    NVL(hdr.locl_tax_amt,0) As chg_amt,
    COMMCODE_PKG.GET_COMDTL_NAME_FNC('CD01394','TVA') As chg_full_nm,   
    hdr.curr_cd As chg_curr_cd,
    DECODE(dtl.n3pty_bil_tp_cd, 'JO','954117', NULL) As rev_acct_cd,
    '954117' As acct_cd,      /* SBC case, '954117' */
    null As inv_if_flg,
    null As inv_if_no,
    TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') As inv_if_dt,
    inv.ofc_cd As inv_if_ofc_cd,
    null As cre_usr_id,
    TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') As cre_dt,
    null As upd_usr_id,
    TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') As upd_dt,
	@[user_ofc_cd] user_ofc_cd, @[user_id] user_id
FROM TPB_OTS_GRP ots, TPB_INVOICE inv, TPB_INV_RVIS hdr, TPB_INV_RVIS_DTL dtl
WHERE inv.n3pty_inv_no = hdr.n3pty_inv_no
    AND inv.n3pty_inv_no = dtl.n3pty_inv_no
    AND inv.n3pty_inv_no = ots.n3pty_inv_no
    AND hdr.n3pty_inv_rvis_seq = dtl.n3pty_inv_rvis_seq
    AND dtl.n3pty_no = ots.n3pty_no
    AND ots.n3pty_delt_tp_cd = 'N'
    AND inv.n3pty_delt_tp_cd = 'N'
    AND hdr.n3pty_delt_tp_cd = 'N'
    AND dtl.n3pty_delt_tp_cd = 'N'
    AND hdr.n3pty_inv_no = @[s_n3pty_inv_no]
    AND hdr.n3pty_inv_rvis_seq = @[s_n3pty_inv_his_seq]
    AND ( hdr.n2nd_locl_tax_amt IS NOT NULL AND hdr.n2nd_locl_tax_amt > 0.0 )    
    AND dtl.N3pty_inv_rvis_dtl_seq = 1			]]></sql>
			<params>
				<param name="ar_if_no" type="12" value="" out="N"/>
				<param name="user_ofc_cd" type="12" value="" out="N"/>
				<param name="user_id" type="12" value="" out="N"/>
				<param name="s_n3pty_inv_no" type="12" value="" out="N"/>
				<param name="s_n3pty_inv_his_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
