<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="OffdockCYInvoiceManageDBDAORecalculateRevisedVolumeCountSeparateMUSQL">
			<desc><![CDATA[RecalculateRevisedVolumeCountSeparateM]]></desc>
			<sql><![CDATA[
UPDATE TES_TML_SO_DTL D
 SET D.RVIS_VOL_QTY = (SELECT SUM(
                       CASE
                       WHEN A.INV_GATE_IN_DT IS NOT NULL AND REPLACE(@[fm_prd_dt],'-') IS NOT NULL AND LENGTH(REPLACE(@[fm_prd_dt],'-'))=8
                       THEN DECODE(SIGN(REPLACE(@[fm_prd_dt],'-')||'0000'-TO_CHAR(A.INV_GATE_IN_DT,'YYYYMMDDHH24MI')),1,0,DECODE(A.RVIS_GATE_IN_FLG,'Y',0,1))
                       ELSE 0
                        END) +
                      SUM(
                      CASE
                      WHEN A.INV_GATE_OUT_DT IS NOT NULL AND REPLACE(@[fm_prd_dt],'-') IS NOT NULL AND LENGTH(REPLACE(@[fm_prd_dt],'-'))=8
                      THEN DECODE(A.RVIS_GATE_OUT_FLG,'Y',0,1)
                      ELSE 0
                      END)  RVIS_VOL_QTY
                      FROM TES_TML_SO_RVIS_LIST A
                      WHERE 1 = 1
                      AND A.TML_SO_OFC_CTY_CD = @[tml_so_ofc_cty_cd]
                      AND A.TML_SO_SEQ = @[tml_so_seq]
                      AND A.TML_SO_DTL_SEQ = @[tml_so_dtl_seq]),
     D.CALC_VOL_QTY = (SELECT SUM(
                       CASE
                       WHEN A.INV_GATE_IN_DT IS NOT NULL AND REPLACE(@[fm_prd_dt],'-') IS NOT NULL AND LENGTH(REPLACE(@[fm_prd_dt],'-'))=8
                       THEN DECODE(SIGN(REPLACE(@[fm_prd_dt],'-')||'0000'-TO_CHAR(A.INV_GATE_IN_DT,'YYYYMMDDHH24MI')),1,0,DECODE(A.RVIS_GATE_IN_FLG,'Y',0,1))
                       ELSE 0
                        END) +
                      SUM(
                      CASE
                      WHEN A.INV_GATE_OUT_DT IS NOT NULL AND REPLACE(@[fm_prd_dt],'-') IS NOT NULL AND LENGTH(REPLACE(@[fm_prd_dt],'-'))=8
                      THEN DECODE(A.RVIS_GATE_OUT_FLG,'Y',0,1)
                      ELSE 0
                      END)  RVIS_VOL_QTY
                      FROM TES_TML_SO_RVIS_LIST A
                      WHERE 1 = 1
                      AND A.TML_SO_OFC_CTY_CD = @[tml_so_ofc_cty_cd]
                      AND A.TML_SO_SEQ = @[tml_so_seq]
                      AND A.TML_SO_DTL_SEQ = @[tml_so_dtl_seq]),
    D.INV_AMT = ( D.CTRT_RT *  (SELECT SUM(
                       CASE
                       WHEN A.INV_GATE_IN_DT IS NOT NULL AND REPLACE(@[fm_prd_dt],'-') IS NOT NULL AND LENGTH(REPLACE(@[fm_prd_dt],'-'))=8
                       THEN DECODE(SIGN(REPLACE(@[fm_prd_dt],'-')||'0000'-TO_CHAR(A.INV_GATE_IN_DT,'YYYYMMDDHH24MI')),1,0,DECODE(A.RVIS_GATE_IN_FLG,'Y',0,1))
                       ELSE 0
                        END) +
                      SUM(
                      CASE
                      WHEN A.INV_GATE_OUT_DT IS NOT NULL AND REPLACE(@[fm_prd_dt],'-') IS NOT NULL AND LENGTH(REPLACE(@[fm_prd_dt],'-'))=8
                      THEN DECODE(A.RVIS_GATE_OUT_FLG,'Y',0,1)
                      ELSE 0
                      END)  RVIS_VOL_QTY
                      FROM TES_TML_SO_RVIS_LIST A
                      WHERE 1 = 1
                      AND A.TML_SO_OFC_CTY_CD = @[tml_so_ofc_cty_cd]
                      AND A.TML_SO_SEQ = @[tml_so_seq]
                      AND A.TML_SO_DTL_SEQ = @[tml_so_dtl_seq]))
 WHERE 1 = 1
 AND D.TML_SO_OFC_CTY_CD = @[tml_so_ofc_cty_cd]
 AND D.TML_SO_SEQ = @[tml_so_seq]
 AND D.TML_SO_DTL_SEQ = @[tml_so_dtl_seq]			]]></sql>
			<params>
				<param name="fm_prd_dt" type="12" value="" out="N"/>
				<param name="tml_so_ofc_cty_cd" type="12" value="" out="N"/>
				<param name="tml_so_seq" type="12" value="" out="N"/>
				<param name="tml_so_dtl_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
