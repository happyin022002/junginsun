<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BkgCopManageDBDAOSearchOBCopRSQL">
			<desc><![CDATA[구주 지역은 BKG_EURO_TRO_DTL, 그 이외 지역은 BKG_TRO_DTL 을 참조하여 OUTBOUND 의 TRO 가 MAPPING 될 COP 정보를 조회한다.]]></desc>
			<sql><![CDATA[
SELECT
  COP_NO
, BKG_NO
, ACT_STS_CD
, AFT_PLN_DT PLAN_DT
, A.VSL_CD VSL_CD
, A.SKD_VOY_NO SKD_VOY_NO
, A.SKD_DIR_CD SKD_DIR_CD
, CLPT_IND_SEQ
, MTY_PKUP_YD_CD
, POR_NOD_CD
, FULL_RTN_YD_CD
, CNTR_NO
, MST_COP_NO
, MST_FLG
, MST_COP_ORD
, (SELECT BKG_NO FROM SCE_COP_HDR WHERE COP_NO = A.MST_COP_NO AND COP_STS_CD != 'X' AND ROWNUM = 1) AS MST_BKG_NO
, CNTR_ORD
, CNTR_TPSZ_ORD
, CNTR_TPSZ_CD
FROM (
    SELECT
      D.COP_NO
    , H.BKG_NO
    , H.MST_COP_NO
    , DECODE(H.MST_COP_NO, H.COP_NO, 'Y', 'N') AS MST_FLG
    , DECODE(H.MST_COP_NO, H.COP_NO, 0, 1) AS MST_COP_ORD
    , DECODE(H.CNTR_NO, 'SMCU0000000', 1, 0) AS CNTR_ORD
    , D.ACT_STS_CD
    , P.MTY_PKUP_YD_CD
    , P.POR_NOD_CD
    , P.FULL_RTN_YD_CD
    , LEAD(D.PLN_DT, 1) OVER (PARTITION BY D.COP_NO ORDER BY D.COP_NO, D.COP_DTL_SEQ) AFT_PLN_DT
    , LEAD(D.VSL_CD, 1) OVER (PARTITION BY D.COP_NO ORDER BY D.COP_NO, D.COP_DTL_SEQ) VSL_CD
    , LEAD(D.SKD_VOY_NO, 1) OVER (PARTITION BY D.COP_NO ORDER BY D.COP_NO, D.COP_DTL_SEQ) SKD_VOY_NO
    , LEAD(D.SKD_DIR_CD, 1) OVER (PARTITION BY D.COP_NO ORDER BY D.COP_NO, D.COP_DTL_SEQ) SKD_DIR_CD
    , LEAD(D.CLPT_IND_SEQ, 1) OVER (PARTITION BY D.COP_NO ORDER BY D.COP_NO, D.COP_DTL_SEQ) CLPT_IND_SEQ
    , D.ACT_CD
    , H.CNTR_NO
    , CNTR_TPSZ_ORD
    , H.CNTR_TPSZ_CD    
    FROM 
      SCE_COP_HDR H
    , SCE_COP_DTL D
    , PRD_PROD_CTL_MST P
#if (${area_conti_cd} == 'E')
    , (
        SELECT
          TD1.BKG_NO
        , TD1.IO_BND_CD
        , TD1.TRO_SEQ
        , TD1.TRO_SUB_SEQ
        , TH1.CNTR_TPSZ_CD
        , '1' AS CNTR_TPSZ_ORD
         FROM BKG_EUR_TRO TH1, BKG_EUR_TRO_DTL TD1
        WHERE 1=1
          AND TD1.BKG_NO = @[bkg_no]
          AND TD1.IO_BND_CD = @[io_bnd_cd]
          AND TD1.TRO_SEQ = @[tro_seq]
          AND TD1.TRO_SUB_SEQ = @[tro_sub_seq]          
          AND TH1.BKG_NO = TD1.BKG_NO
          AND TH1.IO_BND_CD = TD1.IO_BND_CD
          AND TH1.TRO_SEQ = TD1.TRO_SEQ
        UNION
        SELECT
          TD2.BKG_NO
        , TD2.IO_BND_CD
        , TD2.TRO_SEQ
        , TD2.TRO_SUB_SEQ
        , PROV_CNTR_TPSZ_CD AS CNTR_TPSZ_CD
        , '2' AS CNTR_TPSZ_ORD
         FROM BKG_EUR_TRO TH2, BKG_EUR_TRO_DTL TD2, BKG_BOOKING B, SCE_COP_CNTR_REPO_RULE R
        WHERE 1=1
          AND TD2.BKG_NO = @[bkg_no]
          AND TD2.IO_BND_CD = @[io_bnd_cd]
          AND TD2.TRO_SEQ = @[tro_seq]
          AND TD2.TRO_SUB_SEQ = @[tro_sub_seq]
          AND TH2.BKG_NO = TD2.BKG_NO
          AND TH2.IO_BND_CD = TD2.IO_BND_CD
          AND TH2.TRO_SEQ = TD2.TRO_SEQ
          AND TH2.BKG_NO = B.BKG_NO
          AND B.FLEX_HGT_FLG = 'Y'
          AND TH2.CNTR_TPSZ_CD = R.CNTR_TPSZ_CD
      ) T
#else
    , (
        SELECT
          T1.BKG_NO
        , T1.IO_BND_CD
        , T1.TRO_SEQ
        , T1.TRO_SUB_SEQ
        , T1.CNTR_TPSZ_CD
        , '1' AS CNTR_TPSZ_ORD
         FROM BKG_TRO_DTL T1
        WHERE 1=1
          AND T1.BKG_NO = @[bkg_no]
          AND T1.IO_BND_CD = @[io_bnd_cd]
          AND T1.TRO_SEQ = @[tro_seq]
          AND T1.TRO_SUB_SEQ = @[tro_sub_seq]
          AND NVL(T1.RTN_TRO_FLG,'N') = 'N' -- 'Y' 인건은 S/O 가 발생하지 않으며 한국지역에서만 생김
        UNION
        SELECT
          T2.BKG_NO
        , T2.IO_BND_CD
        , T2.TRO_SEQ
        , T2.TRO_SUB_SEQ
        , PROV_CNTR_TPSZ_CD AS CNTR_TPSZ_CD
        , '2' AS CNTR_TPSZ_ORD
         FROM BKG_TRO_DTL T2, BKG_BOOKING B, SCE_COP_CNTR_REPO_RULE R
        WHERE 1=1
          AND T2.BKG_NO = @[bkg_no]
          AND T2.IO_BND_CD = @[io_bnd_cd]
          AND T2.TRO_SEQ = @[tro_seq]
          AND T2.TRO_SUB_SEQ = @[tro_sub_seq]               
          AND T2.BKG_NO = B.BKG_NO
          AND B.FLEX_HGT_FLG = 'Y'
          AND T2.CNTR_TPSZ_CD = R.CNTR_TPSZ_CD
          AND NVL(T2.RTN_TRO_FLG,'N') = 'N' -- 'Y' 인건은 S/O 가 발생하지 않으며 한국지역에서만 생김
      ) T
#end
    WHERE H.BKG_NO = @[bkg_no]
      AND H.BKG_NO = T.BKG_NO
      AND H.PCTL_NO = P.PCTL_NO
      AND H.CNTR_TPSZ_CD = T.CNTR_TPSZ_CD
      AND H.COP_NO = D.COP_NO
      AND NOT EXISTS (SELECT 'X' FROM SCE_TRO_MAPG M WHERE 1=1 AND M.COP_NO = H.COP_NO AND AREA_CONTI_CD=@[area_conti_cd])
      AND H.COP_STS_CD <> 'X'
      AND D.ACT_CD IN ('FLWMLO','FLVMLO','FLWMDO','FLVMDO')
    ) A
WHERE 1=1
  AND A.ACT_CD IN ('FLWMLO','FLVMLO')
ORDER BY
  MST_COP_ORD
, CNTR_ORD
, CNTR_TPSZ_ORD			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="NYC000134100" out="N"/>
				<param name="io_bnd_cd" type="12" value="O" out="N"/>
				<param name="tro_seq" type="12" value="1" out="N"/>
				<param name="tro_sub_seq" type="12" value="36" out="N"/>
				<param name="area_conti_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
