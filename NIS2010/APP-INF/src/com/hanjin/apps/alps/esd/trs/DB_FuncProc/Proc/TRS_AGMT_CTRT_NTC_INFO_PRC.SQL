CREATE OR REPLACE PROCEDURE TRS_AGMT_CTRT_NTC_INFO_PRCAUTHID CURRENT_USERIS/******************************************************************************  1. Name        : Sang geun Kim  2. Create Date : 2014-02-07  3. Description :     - Usage     : Notice information of TRS agreement expired date before 3 month ago.     - Parameter :     - Remark    :  4. Revision History    2014-02-07   : Created by Sang geun Kim    2014-05-02   : Modified by CJH******************************************************************************/CURSOR TRS_CURSOR IS    SELECT NVL(A.SYS_CD, B.SYS_CD) AS SYS_CD           ,NVL(A.CTRT_OFC_CD, B.CTRT_OFC_CD) AS CTRT_OFC_CD          ,NVL(A.AGMT_NO, B.AGMT_NO) AS AGMT_NO          ,A.VNDR_SEQ          ,A.AGMT_EFF_DT          ,A.AGMT_EXP_DT          ,A.CTRT_CRE_USR_ID          ,A.CTRT_CRE_DT          ,A.CTRT_UPD_USR_ID          ,A.CTRT_UPD_DT          ,A.AGMT_TRSP_TP_CD          ,DECODE(A.SYS_CD, NULL, 'N', 'Y') AS AGMT_YN   -- AGREEMENT 존재여부          ,DECODE(B.SYS_CD, NULL, 'N', 'Y') AS NOTICE_YN -- NOTICE 발송내역 존재여부          ,B.AGMT_EXP_DT AS NOTICE_EXP_DT      FROM (           SELECT 'TRS' AS SYS_CD                 ,H.CTRT_OFC_CD AS CTRT_OFC_CD                 ,H.TRSP_AGMT_OFC_CTY_CD||H.TRSP_AGMT_SEQ AS AGMT_NO                 ,V.VNDR_SEQ    AS VNDR_SEQ                 ,MAX(R.EFF_FM_DT) AS AGMT_EFF_DT                 ,MIN(R.EFF_TO_DT) AS AGMT_EXP_DT                 ,MAX(R.CRE_USR_ID) AS CTRT_CRE_USR_ID                 ,MAX(R.CRE_DT) AS CTRT_CRE_DT                 ,MAX(R.UPD_USR_ID)  AS CTRT_UPD_USR_ID                 ,MAX(R.UPD_DT) AS CTRT_UPD_DT                 ,MAX(Z.AGMT_TRSP_TP_CD) AS AGMT_TRSP_TP_CD             FROM TRS_AGMT_HDR H                 ,TRS_AGMT_APLY_VNDR V                 ,TRS_AGMT_RT_TP Z                 ,TRS_AGMT_EQ_RT R            WHERE H.TRSP_AGMT_OFC_CTY_CD = V.TRSP_AGMT_OFC_CTY_CD              AND H.TRSP_AGMT_SEQ        = V.TRSP_AGMT_SEQ              AND H.TRSP_AGMT_OFC_CTY_CD = Z.TRSP_AGMT_OFC_CTY_CD              AND H.TRSP_AGMT_SEQ        = Z.TRSP_AGMT_SEQ              AND Z.TRSP_AGMT_OFC_CTY_CD = R.TRSP_AGMT_OFC_CTY_CD              AND Z.TRSP_AGMT_SEQ        = R.TRSP_AGMT_SEQ              AND Z.TRSP_AGMT_RT_TP_SER_NO = R.TRSP_AGMT_RT_TP_SER_NO                                          AND V.DELT_FLG             = 'N'              AND V.AGMT_VNDR_PRMRY_FLG  = 'Y'              AND NVL(Z.DELT_FLG, 'N')   = 'N'              AND R.DELT_FLG = 'N'              AND R.EFF_TO_DT BETWEEN TO_DATE(TO_CHAR(SYSDATE, 'YYYYMMDD'), 'YYYYMMDD') AND TO_DATE(TO_CHAR(SYSDATE, 'YYYYMMDD'), 'YYYYMMDD') + 90.99999            GROUP BY H.CTRT_OFC_CD                 ,H.TRSP_AGMT_OFC_CTY_CD                 ,H.TRSP_AGMT_SEQ                 ,V.VNDR_SEQ           ) A          FULL OUTER JOIN          (SELECT SYS_CD                 ,CTRT_OFC_CD                 ,AGMT_NO                 ,AGMT_EXP_DT             FROM COM_CTRT_NTC_INFO            WHERE SYS_CD = 'TRS'          ) B       ON A.SYS_CD      = B.SYS_CD      AND A.CTRT_OFC_CD = B.CTRT_OFC_CD      AND A.AGMT_NO     = B.AGMT_NO    ;    BEGIN        FOR CUR IN TRS_CURSOR LOOP              IF CUR.NOTICE_YN = 'Y' AND CUR.AGMT_YN = 'Y' THEN /* NOTICE가 완료되고 동일 AGREEMENT NO가 존재 할 경우 */                IF CUR.NOTICE_EXP_DT = CUR.AGMT_EXP_DT THEN /* 기발송 내역의 EFFECTIVE END DATE가 AGREEMENT와 동일 할 경우 발생대상에서 제외 */                    UPDATE COM_CTRT_NTC_INFO                       SET EML_SND_FLG    = 'N'                     WHERE SYS_CD      = CUR.SYS_CD                       AND AGMT_NO     = CUR.AGMT_NO                       AND CTRT_OFC_CD = CUR.CTRT_OFC_CD                    ;                    --DBMS_OUTPUT.PUT_LINE('1. NOTICE_YN:'||CUR.NOTICE_YN ||', AGMT_YN:'||CUR.AGMT_YN);                ELSE /* 발송내역이 존재하지만 EFFECTIVE END DATE가 AGREEMENT와 다른 경우 재발송 대상으로 변경 */                    UPDATE COM_CTRT_NTC_INFO                       SET AGMT_EFF_DT = CUR.AGMT_EFF_DT                          ,AGMT_EXP_DT = CUR.AGMT_EXP_DT                          ,EML_SND_FLG = 'Y'                          ,UPD_DT   = SYSDATE                     WHERE SYS_CD      = CUR.SYS_CD                       AND AGMT_NO     = CUR.AGMT_NO                       AND CTRT_OFC_CD = CUR.CTRT_OFC_CD                    ;                    --DBMS_OUTPUT.PUT_LINE('2. NOTICE_YN:'||CUR.NOTICE_YN ||', AGMT_YN:'||CUR.AGMT_YN);                END IF;            ELSIF CUR.NOTICE_YN = 'Y' AND CUR.AGMT_YN = 'N' THEN /* NOTICE된 완료되고 AGREEMENT가 존재하지 않는 경우 자료 삭제 */                DELETE FROM COM_CTRT_NTC_INFO                 WHERE SYS_CD      = CUR.SYS_CD                   AND AGMT_NO     = CUR.AGMT_NO                   AND CTRT_OFC_CD = CUR.CTRT_OFC_CD                ;                --DBMS_OUTPUT.PUT_LINE('3. NOTICE_YN:'||CUR.NOTICE_YN ||', AGMT_YN:'||CUR.AGMT_YN);            ELSIF CUR.NOTICE_YN = 'N' AND CUR.AGMT_YN = 'Y' THEN /* NOTICE가 안되고 AGREEMENT가 존재하는 경우 대상 입력 */              --DBMS_OUTPUT.PUT_LINE('4. NOTICE_YN:'||CUR.NOTICE_YN ||', AGMT_YN:'||CUR.AGMT_YN);              INSERT INTO COM_CTRT_NTC_INFO              (                  SYS_CD                 ,CTRT_OFC_CD                 ,AGMT_NO                 ,VNDR_SEQ                 ,AGMT_EFF_DT                 ,AGMT_EXP_DT                 ,CTRT_CRE_USR_ID                 ,CTRT_CRE_DT                 ,CTRT_UPD_USR_ID                 ,CTRT_UPD_DT                 ,NTC_RMK                 ,CRE_USR_ID                 ,CRE_DT                 ,UPD_USR_ID                 ,UPD_DT                 ,AGMT_TRSP_TP_CD                 ,EML_SND_FLG              )              VALUES (                  CUR.SYS_CD                 ,CUR.CTRT_OFC_CD                 ,CUR.AGMT_NO                 ,CUR.VNDR_SEQ                 ,CUR.AGMT_EFF_DT                 ,CUR.AGMT_EXP_DT                 ,CUR.CTRT_CRE_USR_ID                 ,CUR.CTRT_CRE_DT                 ,CUR.CTRT_UPD_USR_ID                 ,CUR.CTRT_UPD_DT                 ,''                 ,'TRS_SYSTEM'                 ,SYSDATE                 ,'TRS_SYSTEM'                 ,SYSDATE                 ,CUR.AGMT_TRSP_TP_CD                 ,'Y'              )              ;            END IF;        END LOOP;        COMMIT;    EXCEPTION        WHEN OTHERS THEN             DBMS_OUTPUT.PUT_LINE('%%TRS_AGMT_CTRT_NTC_INFO_PRC%% <OTHERS> ERROR MSG = ['||SQLERRM||']');             ROLLBACK;    END TRS_AGMT_CTRT_NTC_INFO_PRC;