<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="DODInvoiceMgtDBDAOSearchBKGCntrListRSQL">
			<desc><![CDATA[SearchBKGCntrList]]></desc>
			<sql><![CDATA[
WITH BL_CNTR AS ( 
   SELECT BKG_NO,CNTR_NO 
   FROM(
       SELECT C2.BKG_NO BKG_NO, C2.CNTR_NO, V.VSL_CD||V.SKD_VOY_NO||V.SKD_DIR_CD AS VVD1, 
              B1.BKG_NO BKG2, V2.VSL_CD||V2.SKD_VOY_NO||V2.SKD_DIR_CD AS VVD2 
         FROM BKG_BOOKING B1,
              BKG_CONTAINER C1,
              BKG_CONTAINER C2,
              BKG_VVD  V,
              VSK_VSL_PORT_SKD ACT,
              BKG_VVD  V2,
              VSK_VSL_PORT_SKD ACT2
         WHERE B1.BL_NO   = @[in_bl_no]   
           AND B1.BKG_NO  = C1.BKG_NO
           AND C1.CNTR_NO = C2.CNTR_NO
           AND C2.BKG_NO  = V.BKG_NO
           AND V.VSL_CD   = ACT.VSL_CD 
           AND V.SKD_VOY_NO = ACT.SKD_VOY_NO 
           AND V.SKD_DIR_CD = ACT.SKD_DIR_CD 
           AND V.POL_CD = ACT.VPS_PORT_CD 
           AND V.POL_CLPT_IND_SEQ = ACT.CLPT_IND_SEQ 
           AND ACT.VPS_ETD_DT = (SELECT MAX(VPS_ETD_DT)
                                 FROM  BKG_VVD BV
                                      ,VSK_VSL_PORT_SKD ACT
                                 WHERE  BV.VSL_CD  = ACT.VSL_CD 
                                 AND BV.SKD_VOY_NO = ACT.SKD_VOY_NO 
                                 AND BV.SKD_DIR_CD = ACT.SKD_DIR_CD 
                                 AND BV.POL_CD     = ACT.VPS_PORT_CD 
                                 AND BV.POL_CLPT_IND_SEQ = ACT.CLPT_IND_SEQ 
                                 AND BV.BKG_NO =  C2.BKG_NO) 
          AND B1.BKG_NO = V2.BKG_NO
          AND V2.VSL_CD = ACT2.VSL_CD 
          AND V2.SKD_VOY_NO = ACT2.SKD_VOY_NO 
          AND V2.SKD_DIR_CD = ACT2.SKD_DIR_CD 
          AND V2.POL_CD = ACT2.VPS_PORT_CD 
          AND V2.POL_CLPT_IND_SEQ = ACT2.CLPT_IND_SEQ 
          AND ACT2.VPS_ETD_DT = (SELECT MAX(ACT2.VPS_ETD_DT)
                                 FROM  BKG_VVD  BV2
                                      ,VSK_VSL_PORT_SKD ACT2
                                 WHERE  BV2.VSL_CD = ACT2.VSL_CD 
                                 AND BV2.SKD_VOY_NO = ACT2.SKD_VOY_NO 
                                 AND BV2.SKD_DIR_CD = ACT2.SKD_DIR_CD 
                                 AND BV2.POL_CD = ACT2.VPS_PORT_CD 
                                 AND BV2.POL_CLPT_IND_SEQ = ACT2.CLPT_IND_SEQ 
                                 AND BV2.BKG_NO =  B1.BKG_NO) 
        ) WHERE VVD1 = VVD2                     
)
SELECT  X.CNTR_NO
      , X.CNTR_TPSZ_CD
      , DECODE(NVL(Y.DOD_LOC_CD,'X'),'X',DECODE(SUBSTR(@[in_session_ofc_cd],1,3),'KAN','KRKAN','INC','KREIW'),Y.DOD_LOC_CD) AS DOD_LOC_CD
      , 'KRW' AS BIL_CURR_CD
      , Y.BIL_AMT
      , NVL(Y.ADD_AMT,0) AS ADD_AMT
      , (Y.BIL_AMT + NVL(Y.ADD_AMT,0)) AS TOT_BIL_AMT
      , Y.TAX_AMT
      , Y.INV_AMT
      , '' AS CRE_USR_ID
      , X.POL_CD
      , X.POL_CONTI_CD
      , X.POL_CONTI_NM
      , X.POD_CD
      , X.DEL_CD
      , X.DE_TERM_CD  
      , X.CNEE
      , X.NFTY 
      , X.SHPR --ADD 2014.1.16
      , X.DOD_INV_NO
      , X.BKG_NO
      , X.BL_NO
      , X.LSTM_CD
 FROM (
        SELECT C.CNTR_NO
             , C.CNTR_TPSZ_CD
             , B.POL_CD
             , (SELECT L.CONTI_CD FROM MDM_LOCATION L WHERE L.LOC_CD = B.POL_CD ) POL_CONTI_CD
             , (SELECT CT.CONTI_NM
                  FROM MDM_LOCATION L, MDM_CONTINENT CT 
                 WHERE L.LOC_CD = B.POL_CD 
                   AND L.CONTI_CD = CT.CONTI_CD ) POL_CONTI_NM
             , B.POD_CD
             , B.DEL_CD
             , B.DE_TERM_CD  
             , ( SELECT K.CUST_NM
                   FROM BKG_CUSTOMER K 
                  WHERE K.BKG_NO = B.BKG_NO
                    AND K.BKG_CUST_TP_CD ='C' ) AS CNEE
             , ( SELECT K.CUST_NM
                   FROM BKG_CUSTOMER K 
                  WHERE K.BKG_NO = B.BKG_NO
                    AND K.BKG_CUST_TP_CD ='N' ) AS NFTY 
             , ( SELECT K.CUST_NM
                   FROM BKG_CUSTOMER K 
                  WHERE K.BKG_NO = B.BKG_NO
                    AND K.BKG_CUST_TP_CD ='S' ) AS SHPR 
             , (  SELECT  DT.DOD_INV_NO
                    FROM EAS_DOD_INV_DTL DT 
                    WHERE  DOD_INV_NO IN ( SELECT M.DOD_INV_NO 
                                           FROM EAS_DOD_INV_MN M,
                                                EAS_DOD_INV_DTL D,
                                                BL_CNTR CV 
                                           WHERE  CV.BKG_NO =  M.BKG_NO
                                           AND CV.CNTR_NO =  D.CNTR_NO
                                           AND M.DOD_INV_STS_CD = 'I' )
                    AND DT.CNTR_NO = C.CNTR_NO
                    AND ROWNUM = 1  
                   ) AS DOD_INV_NO
              , B.BKG_NO
              , B.BL_NO
              , M.LSTM_CD
        FROM BKG_BOOKING B,
             BKG_CONTAINER C,
             MST_CONTAINER M
        WHERE B.BKG_NO = C.BKG_NO
        AND B.BL_NO = @[in_bl_no]
        AND B.BKG_STS_CD <> 'S'
        AND B.BKG_STS_CD <> 'X'
        AND C.CNTR_NO = M.CNTR_NO
       ) X
    , EAS_DOD_INV_DTL Y
WHERE X.CNTR_NO = Y.CNTR_NO(+)
  AND X.DOD_INV_NO = Y.DOD_INV_NO(+)
ORDER BY NVL(X.DOD_INV_NO,1), X.CNTR_NO ASC			]]></sql>
			<params>
				<param name="in_bl_no" type="12" value="" out="N"/>
				<param name="in_session_ofc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
