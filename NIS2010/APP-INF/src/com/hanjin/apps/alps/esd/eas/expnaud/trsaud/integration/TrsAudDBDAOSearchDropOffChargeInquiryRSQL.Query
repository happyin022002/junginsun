<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TrsAudDBDAOSearchDropOffChargeInquiryRSQL">
			<desc><![CDATA[Drop-Off Charge Inquiry 조회]]></desc>
			<sql><![CDATA[
SELECT @[s_ecc] ECC_CD
       ,BBB.BKG_STS_CD
       ,AAA.CNTR_NO
       ,AAA.CNTR_TPSZ_CD
       ,AAA.BKG_NO
       ,BBB.POR_CD
       ,BBB.POL_CD
       ,BBB.POD_CD
       ,BBB.DEL_CD
       ,BBB.DE_TERM_CD
       ,SHP.CUST_CNT_CD || LPAD(TO_CHAR(SHP.CUST_SEQ), 6, '0') SHP_CD
       ,CASE WHEN CNE.CUST_SEQ IS NOT NULL THEN CNE.CUST_CNT_CD || LPAD(TO_CHAR(CNE.CUST_SEQ), 6, '0')
             WHEN NTY.CUST_SEQ IS NOT NULL THEN NTY.CUST_CNT_CD || LPAD(TO_CHAR(NTY.CUST_SEQ), 6, '0')
        END CNE_CD
       ,AAA.ORG_YD_CD  AS DEL_YD_CD
       ,AAA.TO_YD_CD   AS ACT_RTN_YD_CD
       ,BBB.SC_NO
       ,BBB.RFA_NO
       ,(SELECT X.INTG_CD_VAL_DP_DESC 
           FROM COM_INTG_CD_DTL X 
          WHERE X.INTG_CD_ID = 'CD02080' 
            AND X.INTG_CD_VAL_CTNT = BKG_GET_TOKEN_FNC(AAA.BKG_SCG_INFO,1,'^')
        ) BKG_SCG_TERM_NM
       ,BKG_GET_TOKEN_FNC(AAA.BKG_SCG_INFO,2,'^') BKG_SCG_CUR_CD
       ,BKG_GET_TOKEN_FNC(AAA.BKG_SCG_INFO,3,'^') BKG_SCG_RAT_UT_CD
       ,BKG_GET_TOKEN_FNC(AAA.BKG_SCG_INFO,4,'^') BKG_SCG_AMT
       ,BKG_GET_TOKEN_FNC(AAA.BKG_SCG_INFO,5,'^') BKG_SCG_CD
       ,CASE WHEN SUBSTR(AAA.ORG_YD_CD, 1, 2) = 'KR' THEN BKG_GET_TOKEN_FNC(AAA.KR_DOD_INFO,1,'^')
             ELSE BKG_GET_TOKEN_FNC(AAA.N3PTY_INFO,1,'^')
        END TPB_NO
       ,CASE WHEN SUBSTR(AAA.ORG_YD_CD, 1, 2) = 'KR' THEN BKG_GET_TOKEN_FNC(AAA.KR_DOD_INFO,2,'^')
             ELSE BKG_GET_TOKEN_FNC(AAA.N3PTY_INFO,2,'^')
        END TPB_AMT
       ,(SELECT 'Y'
           FROM EAS_DRP_OFF_CHG_CHK X
          WHERE X.BKG_NO        = AAA.BKG_NO
            AND X.CNTR_NO       = AAA.CNTR_NO
            AND X.MTY_RTN_YD_CD = AAA.ORG_YD_CD
        ) EAC_IF_FLG
  FROM (
        SELECT AA.ORG_YD_CD
              ,AA.CNTR_NO
              ,AA.CNTR_TPSZ_CD
              ,AA.FM_MVMT_STS_CD
              ,BKG_GET_TOKEN_FNC(AA.TO_MVMT_STS_INFO,1,'^') TO_MVMT_STS_CD
              ,BKG_GET_TOKEN_FNC(AA.TO_MVMT_STS_INFO,2,'^') TO_EVNT_DT
              ,BKG_GET_TOKEN_FNC(AA.TO_MVMT_STS_INFO,3,'^') BKG_NO
              ,BKG_GET_TOKEN_FNC(AA.TO_MVMT_STS_INFO,4,'^') TO_YD_CD
              ,(SELECT FRT_TERM_CD||'^'||CURR_CD||'^'||RAT_UT_CD||'^'||CHG_UT_AMT||'^'||X.CHG_CD
                  FROM BKG_CHG_RT X
                 WHERE X.BKG_NO = BKG_GET_TOKEN_FNC(AA.TO_MVMT_STS_INFO,3,'^')
                   AND X.CHG_CD IN ('OCP', 'DOD')
                   AND ((X.RAT_UT_CD = AA.CNTR_TPSZ_CD) OR (CASE WHEN SUBSTR(AA.CNTR_TPSZ_CD, 2,1) IN ('2', '3') THEN '20'
                                                                 WHEN SUBSTR(AA.CNTR_TPSZ_CD, 2,1) IN ('4', '5') THEN '40'
                                                                 WHEN SUBSTR(AA.CNTR_TPSZ_CD, 2,1) IN ('6', '7') THEN '45'
                                                            END
                                                           ) = X.RAT_UT_CD)
                   AND ROWNUM = 1
               ) BKG_SCG_INFO
              ,(SELECT MAX(X.N3PTY_NO) ||'^'||
                       SUM(ROUND(TRS_COMMON_PKG.GET_CONVERSION_USD_AMT_FNC(X.CFM_CURR_CD, X.CFM_AMT, TO_CHAR(X.CFM_DT,'YYYYMM')),2)) TPB_AMT_USD
                  FROM TPB_OTS_DTL X
                 WHERE X.BKG_NO = BKG_GET_TOKEN_FNC(AA.TO_MVMT_STS_INFO,3,'^')
                   AND X.EQ_NO  = AA.CNTR_NO
                   AND X.N3PTY_EXPN_TP_CD   = 'TRS'
               ) N3PTY_INFO
              ,(SELECT MAX(X.DOD_INV_NO) ||'^'||
                       SUM(ROUND(TRS_COMMON_PKG.GET_CONVERSION_USD_AMT_FNC(Y.BIL_CURR_CD, Y.INV_AMT, TO_CHAR(SYSDATE,'YYYYMM')),2)) DOD_AMT_USD
                  FROM EAS_DOD_INV_MN  X
                      ,EAS_DOD_INV_DTL Y
                 WHERE X.DOD_INV_NO = Y.DOD_INV_NO
                   AND X.BKG_NO  = BKG_GET_TOKEN_FNC(AA.TO_MVMT_STS_INFO,3,'^')
                   AND Y.CNTR_NO = AA.CNTR_NO                 
               ) KR_DOD_INFO
          FROM (
                SELECT ORG_YD_CD
                      ,CNTR_NO
                      ,CNTR_TPSZ_CD
                      ,MVMT_STS_CD AS FM_MVMT_STS_CD
                      ,(SELECT /*+ INDEX (X XPKCTM_MOVEMENT) */
                               X.MVMT_STS_CD||'^'||TO_CHAR(X.CNMV_EVNT_DT, 'YYYY-MM-DD HH24:MI:SS')||'^'||X.BKG_NO||'^'||ORG_YD_CD
                          FROM CTM_MOVEMENT X
                         WHERE X.CNTR_NO  = M.CNTR_NO
                           AND X.CNMV_YR  >= M.CNMV_YR
                           AND X.CNMV_YR||LPAD(X.CNMV_ID_NO, 3, '0') > M.CNMV_YR||LPAD(M.CNMV_ID_NO, 3, '0')
                           AND ROWNUM = 1
                       ) TO_MVMT_STS_INFO
                  FROM CTM_MOVEMENT M
                 WHERE MVMT_STS_CD IN ('ID')
                 #if (${s_ecc} != '') 
                   AND EXISTS (SELECT 'Y'
                                 FROM MDM_EQ_ORZ_CHT X
                                     ,MDM_LOCATION   Y
                                     ,MDM_YARD       Z
                                WHERE X.SCC_CD = Y.SCC_CD
                                  AND Y.LOC_CD = Z.LOC_CD
                                  AND X.ECC_CD = @[s_ecc]
                                  AND Z.YD_CD  = M.ORG_YD_CD
                              )
                 #end
                 #if (${s_loc} != '') 
                   AND EXISTS (SELECT 'Y'
                                 FROM MDM_LOCATION  Y
                                     ,MDM_YARD      Z
                                WHERE Y.LOC_CD = Z.LOC_CD
                                  AND Y.LOC_CD = @[s_loc]
                                  AND Z.YD_CD  = M.ORG_YD_CD
                              )
                 #end
                   AND M.CNMV_EVNT_DT BETWEEN TO_DATE(REPLACE(@[s_fm_dt],'-',''), 'YYYYMMDD')-30 AND TO_DATE(REPLACE(@[s_to_dt],'-',''), 'YYYYMMDD') + 0.99999
                 #if (${s_cntr_no} != '')
                   AND M.CNTR_NO = @[s_cntr_no]
                 #end
                 #if (${s_cntr_tpsz} != '')
                   AND INSTR(@[s_cntr_tpsz], M.CNTR_TPSZ_CD) > 0     -- TP/SZ를 Multi로 받아서 처리
                 #end
               ) AA
           WHERE (AA.FM_MVMT_STS_CD, BKG_GET_TOKEN_FNC(AA.TO_MVMT_STS_INFO,1,'^')) IN (('ID', 'MT'))
             AND (TO_DATE(BKG_GET_TOKEN_FNC(TO_MVMT_STS_INFO,2,'^'), 'YYYY-MM-DD HH24:MI:SS') BETWEEN TO_DATE(@[s_fm_dt], 'YYYY-MM-DD') AND TO_DATE(@[s_to_dt], 'YYYY-MM-DD') + 0.99999) 
       ) AAA
      ,BKG_BOOKING  BBB
      ,BKG_CUSTOMER SHP
      ,BKG_CUSTOMER CNE
      ,BKG_CUSTOMER NTY
 WHERE AAA.BKG_NO = BBB.BKG_NO
   AND AAA.BKG_NO = SHP.BKG_NO(+)
   AND 'S'        = SHP.BKG_CUST_TP_CD(+)
   AND AAA.BKG_NO = CNE.BKG_NO(+)
   AND 'C'        = CNE.BKG_CUST_TP_CD(+)
   AND AAA.BKG_NO = NTY.BKG_NO(+)
   AND 'N'        = NTY.BKG_CUST_TP_CD(+)
   #if (${s_bkg_no} != '')
     AND BBB.BKG_NO = @[s_bkg_no]
   #end
   #if (${s_de_term_cd} != '')
     AND BBB.DE_TERM_CD = @[s_de_term_cd]
   #end
   #if (${s_cust_tp_cd} == 'S' && ${s_cust_cd} != '')
     AND (SHP.CUST_CNT_CD, SHP.CUST_SEQ) IN ((SUBSTR(@[s_cust_cd], 1,2), TO_NUMBER(SUBSTR(@[s_cust_cd], 3))))
   #end
   #if (${s_cust_tp_cd} == 'C' && ${s_cust_cd} != '')
     AND (CNE.CUST_CNT_CD, CNE.CUST_SEQ) IN ((SUBSTR(@[s_cust_cd], 1,2), TO_NUMBER(SUBSTR(@[s_cust_cd], 3))))
   #end
   #if (${s_eac_if} != '')
     #if (${s_eac_if} == 'Y')
       AND EXISTS (SELECT '1'
                     FROM EAS_DRP_OFF_CHG_CHK X
                    WHERE X.BKG_NO            = AAA.BKG_NO
                      AND X.CNTR_NO           = AAA.CNTR_NO
                      AND X.MTY_RTN_YD_CD     = AAA.ORG_YD_CD
                   )
     #else
       AND NOT EXISTS (SELECT '1'
                         FROM EAS_DRP_OFF_CHG_CHK X
                        WHERE X.BKG_NO            = AAA.BKG_NO
                          AND X.CNTR_NO           = AAA.CNTR_NO
                          AND X.MTY_RTN_YD_CD     = AAA.ORG_YD_CD
                       )
     #end
   #end
   AND AAA.ORG_YD_CD <> AAA.TO_YD_CD			]]></sql>
			<params>
				<param name="s_ecc" type="12" value="" out="N"/>
				<param name="s_loc" type="12" value="" out="N"/>
				<param name="s_fm_dt" type="12" value="" out="N"/>
				<param name="s_to_dt" type="12" value="" out="N"/>
				<param name="s_cntr_no" type="12" value="" out="N"/>
				<param name="s_cntr_tpsz" type="12" value="" out="N"/>
				<param name="s_bkg_no" type="12" value="" out="N"/>
				<param name="s_de_term_cd" type="12" value="" out="N"/>
				<param name="s_cust_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
