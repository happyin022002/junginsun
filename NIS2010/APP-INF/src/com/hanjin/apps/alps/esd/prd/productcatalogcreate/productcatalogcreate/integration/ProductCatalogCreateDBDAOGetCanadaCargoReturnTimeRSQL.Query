<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ProductCatalogCreateDBDAOGetCanadaCargoReturnTimeRSQL">
			<desc><![CDATA[ProductCatalogCreateDBDAOGetCanadaCargoReturnTimeRSQL]]></desc>
			<sql><![CDATA[
SELECT   
    DECODE(UPPER(POL_ETA_DAY),'SUN',ARR_SUN_DYS,'MON',ARR_MON_DYS,
                              'TUE',ARR_TUE_DYS,'WED',ARR_WED_DYS,
                              'THU',ARR_THU_DYS,'FRI',ARR_FRI_DYS,
                              'SAT',ARR_SAT_DYS) LRD_DT
    ,(CASE WHEN POL_NOD_CD LIKE 'US%'    --US일 경우 ETA 대신 CCT FNC 추가                  
           THEN TO_CHAR(US_CCT - TO_NUMBER(@[holyday]) - DECODE(UPPER(US_CCT_DAY),'SUN',ARR_SUN_DYS,'MON',ARR_MON_DYS,
                                     'TUE',ARR_TUE_DYS,'WED',ARR_WED_DYS,
                                     'THU',ARR_THU_DYS,'FRI',ARR_FRI_DYS,
                                     'SAT',ARR_SAT_DYS),'YYYYMMDD')||NVL(CCT_HRMNT,'0000')   -- US LRD
           ELSE TO_CHAR(POL_ETA - TO_NUMBER(@[holyday]) - DECODE(UPPER(POL_ETA_DAY),'SUN',ARR_SUN_DYS,'MON',ARR_MON_DYS,
                                     'TUE',ARR_TUE_DYS,'WED',ARR_WED_DYS,
                                     'THU',ARR_THU_DYS,'FRI',ARR_FRI_DYS,
                                     'SAT',ARR_SAT_DYS),'YYYYMMDD')||NVL(CCT_HRMNT,'0000')  --CA LRD
      END) CUT_OFF   --LRD
    ,(CASE WHEN POL_NOD_CD LIKE 'US%'    --US일 경우 ETA 대신 CCT FNC 추가                  
           THEN TO_CHAR(US_CCT - TO_NUMBER(@[holyday]) - DECODE(UPPER(US_CCT_DAY),'SUN',ARR_SUN_DYS,'MON',ARR_MON_DYS,
                                         'TUE',ARR_TUE_DYS,'WED',ARR_WED_DYS,
                                         'THU',ARR_THU_DYS,'FRI',ARR_FRI_DYS,
                                         'SAT',ARR_SAT_DYS),'DY','NLS_DATE_LANGUAGE=ENGLISH')   -- US LRD
           ELSE TO_CHAR(POL_ETA - TO_NUMBER(@[holyday]) - DECODE(UPPER(POL_ETA_DAY),'SUN',ARR_SUN_DYS,'MON',ARR_MON_DYS,
                                         'TUE',ARR_TUE_DYS,'WED',ARR_WED_DYS,
                                         'THU',ARR_THU_DYS,'FRI',ARR_FRI_DYS,
                                         'SAT',ARR_SAT_DYS),'DY','NLS_DATE_LANGUAGE=ENGLISH')  --CA LRD
      END) LRD_DAY
    ,(CASE WHEN POL_NOD_CD LIKE 'US%'    --US일 경우 ETA 대신 CCT FNC 추가
           THEN (SELECT RCV_ITVAL_DYS
                   FROM PRD_USA_CCT_ITVAL_MGMT CCTI
                  WHERE LTST_RCV_DY_CD = TO_CHAR(US_CCT - DECODE(UPPER(US_CCT_DAY),'SUN',ARR_SUN_DYS,'MON',ARR_MON_DYS,
                                                                         'TUE',ARR_TUE_DYS,'WED',ARR_WED_DYS,
                                                                         'THU',ARR_THU_DYS,'FRI',ARR_FRI_DYS,
                                                                         'SAT',ARR_SAT_DYS),'DY','NLS_DATE_LANGUAGE=ENGLISH') 
                )
           ELSE
                (SELECT RCV_ITVAL_DYS
                   FROM PRD_CND_CCT_ITVAL_MGMT CCTI
                  WHERE LTST_RCV_DY_CD = TO_CHAR(POL_ETA - DECODE(UPPER(POL_ETA_DAY),'SUN',ARR_SUN_DYS,'MON',ARR_MON_DYS,
                                                                         'TUE',ARR_TUE_DYS,'WED',ARR_WED_DYS,
                                                                         'THU',ARR_THU_DYS,'FRI',ARR_FRI_DYS,
                                                                         'SAT',ARR_SAT_DYS),'DY','NLS_DATE_LANGUAGE=ENGLISH')
                )
     END) IVAL
    ,(CASE WHEN POL_NOD_CD LIKE 'US%'   --US일 경우 ETA 대신 CCT FNC 추가
           THEN TO_CHAR(US_CCT - TO_NUMBER(@[holyday]) - DECODE(US_CCT_DAY,'SUN',ARR_SUN_DYS,'MON',ARR_MON_DYS,
                                                      'TUE',ARR_TUE_DYS,'WED',ARR_WED_DYS,
                                                      'THU',ARR_THU_DYS,'FRI',ARR_FRI_DYS,
                                                      'SAT',ARR_SAT_DYS)
                 - (SELECT RCV_ITVAL_DYS
                      FROM PRD_USA_CCT_ITVAL_MGMT CCTI
                     WHERE LTST_RCV_DY_CD = TO_CHAR(US_CCT - DECODE(UPPER(US_CCT_DAY),'SUN',ARR_SUN_DYS,'MON',ARR_MON_DYS,
                                                                                      'TUE',ARR_TUE_DYS,'WED',ARR_WED_DYS,
                                                                                      'THU',ARR_THU_DYS,'FRI',ARR_FRI_DYS,
                                                                                      'SAT',ARR_SAT_DYS),'DY','NLS_DATE_LANGUAGE=ENGLISH')                 
                    ),'YYYYMMDDhh24mi')  -- US ERD
           ELSE TO_CHAR(POL_ETA - TO_NUMBER(@[holyday]) - DECODE(POL_ETA_DAY,'SUN',ARR_SUN_DYS,'MON',ARR_MON_DYS,
                                  'TUE',ARR_TUE_DYS,'WED',ARR_WED_DYS,
                                  'THU',ARR_THU_DYS,'FRI',ARR_FRI_DYS,
                                  'SAT',ARR_SAT_DYS)
                 - (SELECT RCV_ITVAL_DYS
                      FROM PRD_CND_CCT_ITVAL_MGMT CCTI
                     WHERE LTST_RCV_DY_CD = TO_CHAR(POL_ETA - DECODE(UPPER(POL_ETA_DAY),'SUN',ARR_SUN_DYS,'MON',ARR_MON_DYS,
                                                                                        'TUE',ARR_TUE_DYS,'WED',ARR_WED_DYS,
                                                                                        'THU',ARR_THU_DYS,'FRI',ARR_FRI_DYS,
                                                                                        'SAT',ARR_SAT_DYS),'DY','NLS_DATE_LANGUAGE=ENGLISH')
                   ),'YYYYMMDDhh24mi')  -- CA ERD
     END) RTN_TIME --ERD 
    ,RN
FROM (
    SELECT --PRDD.* --COUNT(PRDD.PCTL_NO),PRDD.PCTL_NO
        --(SELECT MIN(TRUNC(NVL(PF_ETA_DT,VPS_ETA_DT))) --ETA 날짜는 제외하고, 그 전날을 기준으로 산출 (전날은 하루로 포함되어야 하므로, ETA에서 TRIM만 처리한다) -- 20120308
        (SELECT CASE WHEN SUBSTR(PRDM.POL_CD,1,2)='US' THEN TRUNC(COALESCE(MIN(VPS_ETB_DT),MIN(VPS_ETA_DT),MIN(PF_ETA_DT)))
                     ELSE TRUNC(COALESCE(MIN(VPS_ETA_DT),MIN(PF_ETA_DT)))
                     END 
         FROM PRD_PROD_CTL_ROUT_DTL E, VSK_VSL_PORT_SKD V
         WHERE E.PCTL_NO = PRDM.PCTL_NO
         AND E.ORG_NOD_CD LIKE PRDM.POL_CD||'%'
         AND E.NOD_LNK_DIV_CD = 'L'
         AND E.TRSP_MOD_CD = 'VD' -- 미주는 FEEDER 없음
         AND E.VSL_CD = V.VSL_CD
         AND E.SKD_VOY_NO = V.SKD_VOY_NO
         AND E.SKD_DIR_CD = V.SKD_DIR_CD
         AND E.ORG_NOD_CD = V.YD_CD
         AND NVL(V.PORT_SKD_STS_CD,'X') <> 'S'
         ) POL_ETA
         ,TO_CHAR((SELECT CASE WHEN SUBSTR(PRDM.POL_CD,1,2)='US' THEN TRUNC(COALESCE(MIN(VPS_ETB_DT),MIN(VPS_ETA_DT),MIN(PF_ETA_DT)))
                     ELSE TRUNC(COALESCE(MIN(VPS_ETA_DT),MIN(PF_ETA_DT)))
                     END --ETA 날짜는 제외하고, 그 전날을 기준으로 산출 (전날은 하루로 포함되어야 하므로, ETA에서 TRIM만 처리한다) -- 20120308
         FROM PRD_PROD_CTL_ROUT_DTL E, VSK_VSL_PORT_SKD V
         WHERE E.PCTL_NO = PRDM.PCTL_NO
         AND E.ORG_NOD_CD LIKE PRDM.POL_CD||'%'
         AND E.NOD_LNK_DIV_CD = 'L'
         AND E.TRSP_MOD_CD = 'VD' -- 미주는 FEEDER 없음
         AND E.VSL_CD = V.VSL_CD
         AND E.SKD_VOY_NO = V.SKD_VOY_NO
         AND E.SKD_DIR_CD = V.SKD_DIR_CD
         AND E.ORG_NOD_CD = V.YD_CD
         AND NVL(V.PORT_SKD_STS_CD,'X') <> 'S'
         ),'DY','NLS_DATE_LANGUAGE=ENGLISH') POL_ETA_DAY
         ,CCTM.*
         ------------------------------por node add
         ,RANK() OVER(PARTITION BY PRDM.POL_NOD_CD ORDER BY DECODE(PRDM.POL_NOD_CD ,CCTM.POL_NOD_CD, 1, 2) ,
                                                          DECODE((
                                                                    SELECT ORG_NOD_CD
                                                                    FROM PRD_PROD_CTL_ROUT_DTL D 
                                                                    WHERE D.PCTL_NO = @[pctl_no]
                                                                    AND D.PCTL_IO_BND_CD = 'O' 
                                                                    AND D.TRSP_MOD_CD = 'RD' 
                                                                    AND ROWNUM = 1 
                                                                   ) ,CCTM.POR_NOD_CD, 1, 2) )  RN
#if(${bkg_no} != '')
         ,NVL((SELECT PRD_GET_CCT_FNC(skd.pol_nod_cd, SKD.SLAN_CD, SKD.SLAN_DIR_CD, SKD.CGO_TP_CD, SKD.VPS_ETB_DT, SKD.VPS_ETD_DT, SKD.VSL_CD||SKD.SKD_VOY_NO||SKD.SKD_DIR_CD) CCT
                                                     FROM (SELECT SKD.SLAN_CD SLAN_CD
                                                                 , VVD.SKD_DIR_CD SLAN_DIR_CD
                                                                 , CASE WHEN RC_FLG   = 'Y' THEN 'RF'
                                                                        WHEN DCGO_FLG = 'Y' THEN 'DG'
                                                                        WHEN DCGO_FLG = 'N' AND RC_FLG = 'N' AND AWK_CGO_FLG = 'N' AND BB_CGO_FLG = 'N' THEN 'DR'
                                                                        ELSE 'AL' END CGO_TP_CD
                                                                 , VPS_ETB_DT
                                                                 , VPS_ETD_DT
                                                                 , pol_nod_cd
                                                                 , VVD.VSL_CD
                                                                 , VVD.SKD_VOY_NO
                                                                 , VVD.SKD_DIR_CD
                                                               FROM BKG_BOOKING BK, BKG_VVD VVD, VSK_VSL_PORT_SKD SKD
                                                              WHERE BK.BKG_NO = VVD.BKG_NO
                                                                AND BK.POL_CD = VVD.POL_CD
                                                                AND VVD.VSL_PRE_PST_CD IN ('S', 'T')
																AND VVD.VSL_CD	   NOT IN ('HJXX','HJYY','HJZZ')
                                                                AND VVD.VSL_CD     = SKD.VSL_CD
                                                                AND VVD.SKD_VOY_NO = SKD.SKD_VOY_NO
                                                                AND VVD.SKD_DIR_CD = SKD.SKD_DIR_CD
                                                                AND VVD.POL_CD     = SKD.VPS_PORT_CD
                                                                AND NVL(VVD.POL_CLPT_IND_SEQ, 1) = SKD.CLPT_IND_SEQ
                                                                AND BK.BKG_NO      = nvl(@[bkg_no],'') 
							     ) SKD
             ), '') US_CCT      -- 20151218 유저 요청으로 US 지역 rail cut off 계산시 ETA 대신 CCT 사용
         ,TO_CHAR(NVL((select PRD_GET_CCT_FNC(skd.pol_nod_cd, SKD.SLAN_CD, SKD.SLAN_DIR_CD, SKD.CGO_TP_CD, SKD.VPS_ETB_DT, SKD.VPS_ETD_DT, SKD.VSL_CD||SKD.SKD_VOY_NO||SKD.SKD_DIR_CD) CCT
                                                     FROM (SELECT SKD.SLAN_CD SLAN_CD
                                                                 , VVD.SKD_DIR_CD SLAN_DIR_CD
                                                                 , CASE WHEN RC_FLG   = 'Y' THEN 'RF'
                                                                        WHEN DCGO_FLG = 'Y' THEN 'DG'
                                                                        WHEN DCGO_FLG = 'N' AND RC_FLG = 'N' AND AWK_CGO_FLG = 'N' AND BB_CGO_FLG = 'N' THEN 'DR'
                                                                        ELSE 'AL' END CGO_TP_CD
                                                                 , VPS_ETB_DT
                                                                 , VPS_ETD_DT
                                                                 , pol_nod_cd
                                                                 , VVD.VSL_CD
                                                                 , VVD.SKD_VOY_NO
                                                                 , VVD.SKD_DIR_CD
                                                               FROM BKG_BOOKING BK, BKG_VVD VVD, VSK_VSL_PORT_SKD SKD
                                                              WHERE BK.BKG_NO = VVD.BKG_NO
                                                                AND BK.POL_CD = VVD.POL_CD
                                                                AND VVD.VSL_PRE_PST_CD IN ('S', 'T')
																AND VVD.VSL_CD	   NOT IN ('HJXX','HJYY','HJZZ')
                                                                AND VVD.VSL_CD     = SKD.VSL_CD
                                                                AND VVD.SKD_VOY_NO = SKD.SKD_VOY_NO
                                                                AND VVD.SKD_DIR_CD = SKD.SKD_DIR_CD
                                                                AND VVD.POL_CD     = SKD.VPS_PORT_CD
                                                                AND NVL(VVD.POL_CLPT_IND_SEQ, 1) = SKD.CLPT_IND_SEQ
                                                                AND BK.BKG_NO      = nvl(@[bkg_no],'') 
							     ) skd
             ), '') ,'DY','NLS_DATE_LANGUAGE=ENGLISH') US_CCT_DAY
#else
         ,NVL((SELECT DISTINCT PRD_GET_CCT_FNC(D.ORG_NOD_CD,D.VSL_SLAN_CD,D.SKD_DIR_CD,DECODE(M.RF_SPCL_FLG,'Y','RF',DECODE(M.DG_SPCL_FLG,'Y','DG','DR')),NVL(S.VPS_ETB_DT,D.ARR_ST_DT),NVL(S.VPS_ETD_DT,D.ARR_ST_DT), D.VSL_CD||D.SKD_VOY_NO||D.SKD_DIR_CD) CCT      
                 FROM PRD_PROD_CTL_MST M,PRD_PROD_CTL_ROUT_DTL D,VSK_VSL_PORT_SKD S
                WHERE M.PCTL_NO = @[pctl_no]
                  AND M.PCTL_NO =D.PCTL_NO
                  AND D.PCTL_IO_BND_CD ='T'
                  AND D.TRSP_MOD_CD IN ('WD','VD')
                  AND SUBSTR(D.ORG_NOD_CD,1,5) = M.POL_CD
                  AND S.VSL_CD(+) = D.VSL_CD
                  AND S.SKD_VOY_NO(+) = D.SKD_VOY_NO
                  AND S.SKD_DIR_CD(+) = D.SKD_DIR_CD
                  AND S.CLPT_IND_SEQ(+) = D.ORG_CLPT_IND_SEQ
                  AND S.YD_CD(+) = D.ORG_NOD_CD
	           ), '') US_CCT -- 2016.02.22 시뮬레이션일때도 동일한 값이 나오게 하기 위해 소스 수정
         ,TO_CHAR(NVL((SELECT DISTINCT PRD_GET_CCT_FNC(D.ORG_NOD_CD,D.VSL_SLAN_CD,D.SKD_DIR_CD,DECODE(M.RF_SPCL_FLG,'Y','RF',DECODE(M.DG_SPCL_FLG,'Y','DG','DR')),NVL(S.VPS_ETB_DT,D.ARR_ST_DT),NVL(S.VPS_ETD_DT,D.ARR_ST_DT), D.VSL_CD||D.SKD_VOY_NO||D.SKD_DIR_CD) CCT      
                 FROM PRD_PROD_CTL_MST M,PRD_PROD_CTL_ROUT_DTL D,VSK_VSL_PORT_SKD S
                WHERE M.PCTL_NO = @[pctl_no]
                  AND M.PCTL_NO =D.PCTL_NO
                  AND D.PCTL_IO_BND_CD ='T'
                  AND D.TRSP_MOD_CD IN ('WD','VD')
                  AND SUBSTR(D.ORG_NOD_CD,1,5) = M.POL_CD
                  AND S.VSL_CD(+) = D.VSL_CD
                  AND S.SKD_VOY_NO(+) = D.SKD_VOY_NO
                  AND S.SKD_DIR_CD(+) = D.SKD_DIR_CD
                  AND S.CLPT_IND_SEQ(+) = D.ORG_CLPT_IND_SEQ
                  AND S.YD_CD(+) = D.ORG_NOD_CD
	           ), ''),'DY','NLS_DATE_LANGUAGE=ENGLISH') US_CCT_DAY
#end
         --,row_number() over(partition by CCTM.POR_CD,CCTM.POL_NOD_CD order by trim(CCTM.POR_NOD_CD) )  rn
    FROM PRD_PROD_CTL_MST PRDM, PRD_CND_TML_CCT_MGMT CCTM --,PRD_PROD_CTL_ROUT_DTL PRDD
--    WHERE PRDM.POR_CD = CCTM.POR_CD
    WHERE CCTM.POR_CD = (
                            SELECT SUBSTR(ORG_NOD_CD,1,5) 
                            FROM PRD_PROD_CTL_ROUT_DTL D 
                            WHERE D.PCTL_NO = @[pctl_no]
                            AND D.PCTL_IO_BND_CD = 'O' 
                            AND D.TRSP_MOD_CD = 'RD' 
                            AND ROWNUM = 1 
--                            ORDER BY D.PCTL_SEQ
                        )
    ------------------------------por node add
    AND CCTM.POR_NOD_CD = DECODE( CCTM.POR_NOD_CD, ' ', CCTM.POR_NOD_CD,
                                    (
                                    SELECT ORG_NOD_CD
                                    FROM PRD_PROD_CTL_ROUT_DTL D 
                                    WHERE D.PCTL_NO = @[pctl_no]
                                    AND D.PCTL_IO_BND_CD = 'O' 
                                    AND D.TRSP_MOD_CD = 'RD' 
                                    AND ROWNUM = 1 
                                   )
                                )
    ------------------------------
--    AND PRDM.POL_CD = CCTM.POL_CD
--    AND PRDM.POL_nod_CD = CCTM.POL_CD -- JSY , POL 이 7자리로 변경
    AND DECODE(LENGTH(CCTM.POL_NOD_CD),5,PRDM.POL_CD ,PRDM.POL_NOD_CD  )  = CCTM.POL_NOD_CD -- JSY , POL 이 5또는 7자리로 변경, 컬럼명 변경
    AND PRDM.PCTL_NO = @[pctl_no]

) S
WHERE RN = 1			]]></sql>
			<params>
				<param name="holyday" type="12" value="" out="N"/>
				<param name="pctl_no" type="12" value="" out="N"/>
				<param name="bkg_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
