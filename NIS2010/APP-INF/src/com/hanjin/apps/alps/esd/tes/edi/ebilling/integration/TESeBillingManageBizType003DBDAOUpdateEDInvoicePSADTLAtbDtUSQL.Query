<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TESeBillingManageBizType003DBDAOUpdateEDInvoicePSADTLAtbDtUSQL">
			<desc><![CDATA[PSA DTL ATB_DT 찾아 넣는 작업 : PSA HDR에 정품 YARD가  있어야  처리 가능하기에 PSA DTL에 부모까지 찾은 상태에서 실행한다.]]></desc>
			<sql><![CDATA[
UPDATE TES_EDI_SO_PSA_DTL P
SET  P.ATB_DT = (
    CASE
    WHEN P.PSA_IO_BND_CD IS NOT NULL AND P.PSA_IO_BND_CD IN ('I','D') AND P.IB_VVD_CD IS NOT NULL
    THEN (
        	SELECT 
                V.VPS_ETB_DT ATB_DT
        	FROM VSK_VSL_PORT_SKD V
			WHERE 1=1
			AND V.VPS_PORT_CD = SUBSTR((SELECT H.YD_CD FROM TES_EDI_SO_HDR H WHERE H.TML_INV_EDI_SEQ = @[tml_inv_edi_seq] AND H.TML_EDI_SO_OFC_CTY_CD = P.TML_EDI_SO_OFC_CTY_CD AND H.TML_EDI_SO_SEQ = P.TML_EDI_SO_SEQ),1,5)
			AND V.VSL_CD <> 'CNTC'
			AND SUBSTR(P.IB_VVD_CD,1,4) <> 'CNTC'
			AND V.VSL_CD = SUBSTR(P.IB_VVD_CD,1,4)
			AND V.SKD_VOY_NO = SUBSTR(P.IB_VVD_CD,5,4)
			AND V.SKD_DIR_CD = SUBSTR(P.IB_VVD_CD,9) 
			AND ROWNUM = 1
			UNION 
			SELECT 
                LAST_DAY(TO_DATE(SUBSTR(P.IB_VVD_CD,5,4),'YYMM')) ATB_DT
            FROM DUAL
            WHERE 1=1
			AND SUBSTR(P.IB_VVD_CD,1,4) = 'CNTC'			           
			AND ROWNUM = 1
         )
    WHEN P.PSA_IO_BND_CD IS NOT NULL AND P.PSA_IO_BND_CD IN ('O','L') AND P.OB_VVD_CD IS NOT NULL
    THEN (
        	SELECT 
    	       V.VPS_ETB_DT ATB_DT
        	FROM VSK_VSL_PORT_SKD V
			WHERE 1=1
			AND V.VPS_PORT_CD = SUBSTR((SELECT H.YD_CD FROM TES_EDI_SO_HDR H WHERE H.TML_INV_EDI_SEQ = @[tml_inv_edi_seq] AND H.TML_EDI_SO_OFC_CTY_CD = P.TML_EDI_SO_OFC_CTY_CD AND H.TML_EDI_SO_SEQ = P.TML_EDI_SO_SEQ),1,5)
			AND V.VSL_CD <> 'CNTC'
			AND SUBSTR(P.OB_VVD_CD,1,4) <> 'CNTC'
			AND V.VSL_CD = SUBSTR(P.OB_VVD_CD,1,4)
			AND V.SKD_VOY_NO = SUBSTR(P.OB_VVD_CD,5,4)
			AND V.SKD_DIR_CD = SUBSTR(P.OB_VVD_CD,9)   
			AND ROWNUM = 1
			UNION 
			SELECT 
                LAST_DAY(TO_DATE(SUBSTR(P.OB_VVD_CD,5,4),'YYMM')) ATB_DT
            FROM DUAL
            WHERE 1=1
			AND SUBSTR(P.OB_VVD_CD,1,4) = 'CNTC'			         
			AND ROWNUM = 1
         )
    ELSE NULL 
    END )
WHERE P.TML_EDI_SO_PSA_DTL_SEQ > 0
AND P.TRF_DESC <> 'GST'
AND P.TML_INV_EDI_SEQ = @[tml_inv_edi_seq]
AND EXISTS (
    SELECT 'X' 
    FROM TES_EDI_SO_HDR H 
    WHERE H.TML_INV_EDI_SEQ = @[tml_inv_edi_seq]
    AND H.TML_EDI_SO_OFC_CTY_CD = P.TML_EDI_SO_OFC_CTY_CD 
    AND H.TML_EDI_SO_SEQ = P.TML_EDI_SO_SEQ
    AND NVL(H.DELT_FLG,'N') <> 'Y'
    AND H.TML_INV_TP_CD IN ('TM')
--    AND H.VNDR_SEQ = psa_vndr_seq
)			]]></sql>
			<params>
				<param name="tml_inv_edi_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
