<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TESeBillingManageBizType000DBDAOUpdateEDInvoiceTmpFmToDtUSQL">
			<desc><![CDATA[EDI에 임시저장된 (Storage대상) FM ~ TO PERIOD DATE를 설정]]></desc>
			<sql><![CDATA[
UPDATE TES_EDI_SO_HDR H
SET 
H.FM_PRD_DT = (
            NVL(
            CASE
            WHEN H.TML_INV_TP_CD IS NOT NULL AND LENGTH(H.TML_INV_TP_CD) = 2 AND SUBSTR(H.TML_INV_TP_CD,1,1) = 'S'
            THEN 
                NVL(FM_PRD_DT, 
                    (   SELECT 
                        SUBSTR(MIN(INV_GATE_IN_TM_MSG),1,8) FM_PRD_DT
                        FROM TES_EDI_SO_CNTR_LIST L
                        WHERE L.TML_EDI_SO_OFC_CTY_CD = H.TML_EDI_SO_OFC_CTY_CD
                        AND   L.TML_EDI_SO_SEQ = H.TML_EDI_SO_SEQ
                        GROUP BY L.TML_EDI_SO_OFC_CTY_CD, L.TML_EDI_SO_SEQ  ))
            ELSE ''
            END,''))
,
H.TO_PRD_DT =             
            NVL(
            CASE
            WHEN H.TML_INV_TP_CD IS NOT NULL AND LENGTH(H.TML_INV_TP_CD) = 2 AND SUBSTR(H.TML_INV_TP_CD,1,1) = 'S'
            THEN 
                NVL(TO_PRD_DT, 
                    (   SELECT 
                        SUBSTR(DECODE(STO_DYS_IND_CD,'IO',NVL(MAX(INV_GATE_OUT_TM_MSG),MAX(INV_GATE_IN_TM_MSG)),MAX(INV_GATE_IN_TM_MSG)),1,8) TO_PRD_DT
                        FROM TES_EDI_SO_CNTR_LIST L
                        WHERE L.TML_EDI_SO_OFC_CTY_CD = H.TML_EDI_SO_OFC_CTY_CD
                        AND   L.TML_EDI_SO_SEQ = H.TML_EDI_SO_SEQ
                        GROUP BY L.TML_EDI_SO_OFC_CTY_CD, L.TML_EDI_SO_SEQ  ))
            ELSE ''
            END,'')
WHERE H.TML_EDI_SO_OFC_CTY_CD = @[tml_edi_so_ofc_cty_cd]
AND   H.TML_EDI_SO_SEQ = @[tml_edi_so_seq]
AND   H.TML_SO_OFC_CTY_CD IS NULL
AND   H.TML_SO_SEQ IS NULL
AND   NVL(H.DELT_FLG,'N') <> 'Y'
			]]></sql>
			<params>
				<param name="tml_edi_so_ofc_cty_cd" type="12" value="" out="N"/>
				<param name="tml_edi_so_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
