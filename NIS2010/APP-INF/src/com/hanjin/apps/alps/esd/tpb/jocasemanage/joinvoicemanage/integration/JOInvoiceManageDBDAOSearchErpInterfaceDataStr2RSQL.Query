<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="JOInvoiceManageDBDAOSearchErpInterfaceDataStr2RSQL">
			<desc><![CDATA[SearchErpInterfaceDataStr2]]></desc>
			<sql><![CDATA[
SELECT  ----- GENERAL BILLING CASE
    @[ar_if_no] AS AR_IF_NO,
    DTL.N3PTY_INV_RVIS_DTL_SEQ AS CHG_SEQ,
    DECODE(DTL.N3PTY_BIL_TP_CD, 'JO','XXX', '3'||DTL.N3PTY_BIL_TP_CD) AS N3PTY_INV_CHG_TP_CD,   /* LIKE 3CC (GENERAL), 'XXX' ('JO' CASE) */
    NVL(DTL.INV_DTL_AMT,0) - NVL(DTL.REV_AMT,0) AS CHG_AMT,
    COMMCODE_PKG.GET_COMDTL_NAME_FNC('CD01394',DECODE(DTL.N3PTY_BIL_TP_CD, 'JO','XXX', '3'||DTL.N3PTY_BIL_TP_CD)) AS CHG_FULL_NM,  /* ADDED CHARGE TYPE CODE NAME ... */
    HDR.CURR_CD AS CHG_CURR_CD,
    DECODE(DTL.N3PTY_BIL_TP_CD, 'JO','954117',NULL) AS REV_ACCT_CD,
    DECODE(OTS.N3PTY_EXPN_TP_CD, 'TES','954111', 'TRS','954113', 'MNR','954113',NULL) AS ACCT_CD,   /* ACCT_CD DECISION */
    NULL AS INV_IF_FLG,
    NULL AS INV_IF_NO,
    TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') AS INV_IF_DT,
    INV.OFC_CD AS INV_IF_OFC_CD,
    NULL AS CRE_USR_ID,
    TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') AS CRE_DT,
    NULL AS UPD_USR_ID,
    TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') AS UPD_DT,
	@[user_ofc_cd] USER_OFC_CD, @[user_id] USER_ID
FROM TPB_OTS_GRP OTS, TPB_INVOICE INV, TPB_INV_RVIS HDR, TPB_INV_RVIS_DTL DTL
WHERE INV.N3PTY_INV_NO = HDR.N3PTY_INV_NO
    AND INV.N3PTY_INV_NO = DTL.N3PTY_INV_NO
    AND INV.N3PTY_INV_NO = OTS.N3PTY_INV_NO
    AND HDR.N3PTY_INV_RVIS_SEQ = DTL.N3PTY_INV_RVIS_SEQ
    AND DTL.N3PTY_NO = OTS.N3PTY_NO
    AND OTS.N3PTY_DELT_TP_CD = 'N'
    AND INV.N3PTY_DELT_TP_CD = 'N'
    AND HDR.N3PTY_DELT_TP_CD = 'N'
    AND DTL.N3PTY_DELT_TP_CD = 'N'
    AND HDR.N3PTY_INV_NO = @[s_n3pty_inv_no]
    AND HDR.N3PTY_INV_RVIS_SEQ = @[s_n3pty_inv_his_seq]
----- ----- -----
UNION ALL -------
----- ----- -----   
SELECT  ----- 'JO' BILLING CASE - REVENUE
    @[ar_if_no] AS AR_IF_NO,
    ( SELECT MAX(N3PTY_INV_RVIS_DTL_SEQ) FROM TPB_INV_RVIS_DTL AA WHERE AA.N3PTY_INV_NO = HDR.N3PTY_INV_NO AND AA.N3PTY_INV_RVIS_SEQ = HDR.N3PTY_INV_RVIS_SEQ ) + ROWNUM AS CHG_SEQ,
    '3CY' AS N3PTY_INV_CHG_TP_CD,                              /* 3CY (CASE 'JO' REVENUE) */
    NVL(DTL.REV_AMT,0) AS CHG_AMT,
    COMMCODE_PKG.GET_COMDTL_NAME_FNC('CD01394','3CY') AS CHG_FULL_NM,   /* ADDED CHARGE TYPE CODE NAME ... */
    HDR.CURR_CD AS CHG_CURR_CD,
    DECODE(DTL.N3PTY_BIL_TP_CD, 'JO','954117',NULL) AS REV_ACCT_CD,
    DECODE(OTS.N3PTY_EXPN_TP_CD, 'TES','512181', 'TRS','512181', 'MNR','512181',NULL) AS ACCT_CD,   /* ACCT_CD DECISION */
    NULL AS INV_IF_FLG,
    NULL AS INV_IF_NO,
    TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') AS INV_IF_DT,
    INV.OFC_CD AS INV_IF_OFC_CD,  
    NULL AS CRE_USR_ID,
    TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') AS CRE_DT,
    NULL AS UPD_USR_ID,
    TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') AS UPD_DT,
	@[user_ofc_cd] USER_OFC_CD, @[user_id] USER_ID
FROM TPB_OTS_GRP OTS, TPB_INVOICE INV, TPB_INV_RVIS HDR, TPB_INV_RVIS_DTL DTL
WHERE INV.N3PTY_INV_NO = HDR.N3PTY_INV_NO
    AND INV.N3PTY_INV_NO = DTL.N3PTY_INV_NO
    AND INV.N3PTY_INV_NO = OTS.N3PTY_INV_NO
    AND HDR.N3PTY_INV_RVIS_SEQ = DTL.N3PTY_INV_RVIS_SEQ
    AND DTL.N3PTY_NO = OTS.N3PTY_NO
    AND OTS.N3PTY_DELT_TP_CD = 'N'
    AND INV.N3PTY_DELT_TP_CD = 'N'
    AND HDR.N3PTY_DELT_TP_CD = 'N'
    AND DTL.N3PTY_DELT_TP_CD = 'N'
    AND HDR.N3PTY_INV_NO = @[s_n3pty_inv_no]
    AND HDR.N3PTY_INV_RVIS_SEQ = @[s_n3pty_inv_his_seq]
    AND DTL.N3PTY_BIL_TP_CD = 'JO'                          /* ONLY JO */
    AND ( DTL.REV_AMT IS NOT NULL AND DTL.REV_AMT != 0.0 )   /* REV_AMT IS NOT NULL AND NOT 0.0 ... */
----- ----- -----
UNION ALL -------
----- ----- -----
SELECT ----- TAX CASE
    @[ar_if_no] AS AR_IF_NO,
    ( SELECT MAX(N3PTY_INV_RVIS_DTL_SEQ) FROM TPB_INV_RVIS_DTL AA WHERE AA.N3PTY_INV_NO = HDR.N3PTY_INV_NO AND AA.N3PTY_INV_RVIS_SEQ = HDR.N3PTY_INV_RVIS_SEQ )    --- CHG_SEQ -- START 
    + ( SELECT COUNT(0) CNT
        FROM TPB_OTS_GRP OTS1, TPB_INVOICE INV1, TPB_INV_RVIS HDR1, TPB_INV_RVIS_DTL DTL1
        WHERE INV1.N3PTY_INV_NO = HDR1.N3PTY_INV_NO
            AND INV1.N3PTY_INV_NO = DTL1.N3PTY_INV_NO
            AND INV1.N3PTY_INV_NO = OTS1.N3PTY_INV_NO
            AND HDR1.N3PTY_INV_RVIS_SEQ = DTL1.N3PTY_INV_RVIS_SEQ
            AND DTL1.N3PTY_NO = OTS1.N3PTY_NO
            AND OTS1.N3PTY_DELT_TP_CD = 'N'
            AND INV1.N3PTY_DELT_TP_CD = 'N'
            AND HDR1.N3PTY_DELT_TP_CD = 'N'
            AND DTL1.N3PTY_DELT_TP_CD = 'N'
            AND HDR1.N3PTY_INV_NO = HDR.N3PTY_INV_NO
            AND HDR1.N3PTY_INV_RVIS_SEQ = HDR.N3PTY_INV_RVIS_SEQ
            AND DTL1.N3PTY_BIL_TP_CD = 'JO'                             /* ONLY JO */
            AND ( DTL1.REV_AMT IS NOT NULL AND DTL1.REV_AMT != 0.0 )   /* REV_AMT IS NOT NULL AND NOT 01.0 1.1.1. */
      )
    + ROWNUM AS CHG_SEQ,                                               --- CHG_SEQ -- END
    'TVA' AS AR_INV_CHG_TP_CD,                                         /* VAT CASE ... TVA */
    NVL(HDR.VAT_AMT,0) AS CHG_AMT,
    COMMCODE_PKG.GET_COMDTL_NAME_FNC('CD01394','TVA') AS CHG_FULL_NM,   /* ADDED CHARGE TYPE CODE NAME */
    HDR.CURR_CD AS CHG_CURR_CD,
    DECODE(DTL.N3PTY_BIL_TP_CD, 'JO','954117', NULL) AS REV_ACCT_CD,
    '954117' AS ACCT_CD,      /* TVA CASE, '954117' */
    NULL AS INV_IF_FLG,
    NULL AS INV_IF_NO,
    TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') AS INV_IF_DT,
    INV.OFC_CD AS INV_IF_OFC_CD,
    NULL AS CRE_USR_ID,
    TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') AS CRE_DT,
    NULL AS UPD_USR_ID,
    TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') AS UPD_DT,
	@[user_ofc_cd] USER_OFC_CD, @[user_id] USER_ID
FROM TPB_OTS_GRP OTS, TPB_INVOICE INV, TPB_INV_RVIS HDR, TPB_INV_RVIS_DTL DTL
WHERE INV.N3PTY_INV_NO = HDR.N3PTY_INV_NO
    AND INV.N3PTY_INV_NO = DTL.N3PTY_INV_NO
    AND INV.N3PTY_INV_NO = OTS.N3PTY_INV_NO
    AND HDR.N3PTY_INV_RVIS_SEQ = DTL.N3PTY_INV_RVIS_SEQ
    AND DTL.N3PTY_NO = OTS.N3PTY_NO
    AND OTS.N3PTY_DELT_TP_CD = 'N'
    AND INV.N3PTY_DELT_TP_CD = 'N'
    AND HDR.N3PTY_DELT_TP_CD = 'N'
    AND DTL.N3PTY_DELT_TP_CD = 'N'
    AND HDR.N3PTY_INV_NO = @[s_n3pty_inv_no]
    AND HDR.N3PTY_INV_RVIS_SEQ = @[s_n3pty_inv_his_seq]
    AND ( HDR.VAT_AMT IS NOT NULL AND HDR.VAT_AMT > 0.0 )     /* VAT_AMT IS VALID */
    AND DTL.N3PTY_INV_RVIS_DTL_SEQ = 1                        /* 한 행만... */			]]></sql>
			<params>
				<param name="ar_if_no" type="12" value="" out="N"/>
				<param name="user_ofc_cd" type="12" value="" out="N"/>
				<param name="user_id" type="12" value="" out="N"/>
				<param name="s_n3pty_inv_no" type="12" value="" out="N"/>
				<param name="s_n3pty_inv_his_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
