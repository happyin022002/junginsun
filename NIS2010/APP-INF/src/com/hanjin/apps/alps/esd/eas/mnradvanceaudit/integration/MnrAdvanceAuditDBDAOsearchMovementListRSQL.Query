<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="MnrAdvanceAuditDBDAOsearchMovementListRSQL">
			<desc><![CDATA[20160329 [ESD_EAS_0369] Futile Trip Container]]></desc>
			<sql><![CDATA[
SELECT   CTM.CNTR_NO
       , CTM.BKG_CGO_TP_CD
       , CTM.CNTR_TPSZ_CD
       , CTM.MVMT_STS_CD
       , CTM.CNMV_EVNT_DT
       , CTM.UPD_LOCL_DT
       , CTM.UPD_DT
       , CTM.CNMV_CYC_NO
       , CTM.FCNTR_FLG
       , CTM.VVD
       , CTM.BKG_NO
       , CTM.ORG_YD_CD
       , CTM.USR_NM
       , CTM.OFC_CD
       , CTM.CNMV_RMK
FROM     (
           SELECT   /*+ USE_NL(MOV, CTM) INDEX_ASC(CTM XFN1CTM_MOVEMENT) */
                    CTM.CNTR_NO
                  , CTM.BKG_CGO_TP_CD
                  , CTM.CNTR_TPSZ_CD
                  , CTM.MVMT_STS_CD
                  , CTM.CNMV_EVNT_DT
                  , CTM.UPD_LOCL_DT
                  , CTM.UPD_DT
                  , CTM.CNMV_CYC_NO
                  , DECODE(CTM.FCNTR_FLG,'Y','F','M') AS FCNTR_FLG
                  , CTM.TRNK_VSL_CD || CTM.TRNK_SKD_VOY_NO || CTM.TRNK_SKD_DIR_CD AS VVD
                  , CTM.BKG_NO
                  , CTM.ORG_YD_CD
                  , CTM.USR_NM
                  , CTM.OFC_CD
                  , CTM.CNMV_RMK
                  , ROW_NUMBER() OVER(PARTITION BY CTM.CNTR_NO ORDER BY CTM.CNMV_YR, CTM.CNMV_SEQ, CTM.CNMV_SPLIT_NO) RN
           FROM     CTM_MOVEMENT CTM
                  , (
                      SELECT   MOV.CNTR_NO
                             , MOV.CNMV_YR
                             , MOV.CNMV_ID_NO
                             , MOV.CNMV_SEQ
                             , MOV.CNMV_SPLIT_NO
                             , MOV.CNMV_CYC_NO
                      FROM     CTM_MOVEMENT MOV
                      WHERE    1 = 1
                      AND      MOV.CNMV_EVNT_DT BETWEEN TO_DATE(@[fdate], 'YYYY-MM-DD') AND TO_DATE(@[tdate], 'YYYY-MM-DD') + 0.99999
                      AND      MOV.MVMT_STS_CD = @[mvmt_sts_cd1] -- id 1번
                      AND      MOV.ORG_YD_CD = @[loc_cd] || @[yd_cd]
#if(${cntr_no} != '')
                      AND      MOV.CNTR_NO IN
                               (
	#foreach ($cntrNo IN ${cntrNos})
		#if($velocityCount < $cntrNos.size())
                                 '$cntrNo',
		#else
                                 '$cntrNo'
		#end
	#end
                               )
#end
#if(${cntr_tpsz_cd} != '')
                      AND      MOV.CNTR_TPSZ_CD IN
                               (
	#foreach ($tpszCd IN ${eqTpSzCds})
		#if($velocityCount < $eqTpSzCds.size())
                                 '$tpszCd',
		#else
                                 '$tpszCd'
		#end
	#end
                               )
#end
#if(${fcntr_flg} != '')
                      AND      ( MOV.FCNTR_FLG = @[fcntr_flg] OR MOV.FCNTR_FLG = (CASE WHEN @[fcntr_flg] = 'Y' THEN 'F' ELSE 'M' END) )
#end
                      AND      TO_CHAR(
                               (
                                 SELECT   XMLAGG(XMLELEMENT(A, M.MVMT_STS_CD || ',') ORDER BY M.CNMV_YR ASC, M.CNMV_SEQ ASC, M.CNMV_SPLIT_NO ASC).EXTRACT('//text()').GETCLOBVAL() STS_CD_LIST
                                 FROM     CTM_MOVEMENT M
                                 WHERE    1 = 1
                                 AND      M.CNTR_NO = MOV.CNTR_NO
                                 AND      M.CNMV_CYC_NO <= MOV.CNMV_CYC_NO + 2
                                 AND      M.CNMV_YR || TO_CHAR(M.CNMV_SEQ, '00000') || M.CNMV_SPLIT_NO >= MOV.CNMV_YR || TO_CHAR(MOV.CNMV_SEQ, '00000') || MOV.CNMV_SPLIT_NO
                               )
                               ) LIKE @[mvmt_sts_cd] || '%' -- id 전체
                    ) MOV
           WHERE    1 = 1
           AND      CTM.CNTR_NO = MOV.CNTR_NO
           AND      CTM.CNMV_CYC_NO <= MOV.CNMV_CYC_NO + 2
           AND      CTM.CNMV_YR || TO_CHAR(CTM.CNMV_SEQ, '00000') || CTM.CNMV_SPLIT_NO >= MOV.CNMV_YR || TO_CHAR(MOV.CNMV_SEQ, '00000') || MOV.CNMV_SPLIT_NO
         ) CTM
WHERE    1 = 1
AND      RN < @[id_cnt] --idCount			]]></sql>
			<params>
				<param name="fdate" type="12" value="" out="N"/>
				<param name="tdate" type="12" value="" out="N"/>
				<param name="mvmt_sts_cd1" type="12" value="" out="N"/>
				<param name="loc_cd" type="12" value="" out="N"/>
				<param name="yd_cd" type="12" value="" out="N"/>
				<param name="fcntr_flg" type="12" value="" out="N"/>
				<param name="mvmt_sts_cd" type="12" value="" out="N"/>
				<param name="id_cnt" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
