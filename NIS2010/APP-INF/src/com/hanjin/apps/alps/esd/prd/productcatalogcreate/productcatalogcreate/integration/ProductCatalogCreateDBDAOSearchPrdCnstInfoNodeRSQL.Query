<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ProductCatalogCreateDBDAOSearchPrdCnstInfoNodeRSQL">
			<desc><![CDATA[생성된 PC의 해당되는 prd_nod_cnst_mgmt를 조회한다.]]></desc>
			<sql><![CDATA[
SELECT DISTINCT NVL(CC.SVC_USE_FLG, 'Y') SVC_USE_FLG
    , CC.NOD_CD ntwk_ut_nm
    , CC.PCTL_CNST_ITM_NM ITM_NM
    , CC.PORT_PNT_CD CTRL_PNT_NM
    , VSL_SLAN_CD
    , VVD
    , CNTR_TP_CD
    , CMDT_CD
    , NOD_CNST_RMK CNST_RMK
    , CRE_OFC_CD
    , CRE_USR_ID
FROM (
	SELECT DECODE(C.NOD_CD,'ALL',D.ORG_NOD_CD,C.NOD_CD) NOD_CD, C.PORT_PNT_CD, C.SVC_USE_FLG, D.PCTL_NO, D.ORG_NOD_CD, D.PCTL_SEQ
-- 추가되는 칼럼 시작
	    , C.PCTL_CNST_ITM_NM
        , C.VSL_SLAN_CD
        , C.VSL_CD || C.SKD_VOY_NO || C.SKD_DIR_CD VVD
        , C.CNTR_TP_CD
        , C.CMDT_CD
        , C.NOD_CNST_RMK
        , C.CRE_OFC_CD
        , C.CRE_USR_ID
    FROM PRD_NOD_CNST_MGMT C
       , PRD_PROD_CTL_QTY Q
       , PRD_PROD_CTL_MST M
       , (SELECT PCTL_NO, PCTL_SEQ, ORG_NOD_CD, NOD_LNK_DIV_CD, PCTL_IO_BND_CD, MTY_YD_FLG, ARR_ST_DT, DEP_FSH_DT
                 , LEAD (VSL_SLAN_CD) OVER (PARTITION BY PCTL_NO ORDER BY PCTL_SEQ) POL_SLAN_CD
                 , LEAD (VSL_CD || SKD_VOY_NO || SKD_DIR_CD) OVER (PARTITION BY PCTL_NO ORDER BY PCTL_SEQ) POL_VVD
                 , LAG (VSL_SLAN_CD) OVER (PARTITION BY PCTL_NO ORDER BY PCTL_SEQ) POD_SLAN_CD
                 , LAG  (VSL_CD || SKD_VOY_NO || SKD_DIR_CD) OVER (PARTITION BY PCTL_NO ORDER BY PCTL_SEQ) POD_VVD
            FROM PRD_PROD_CTL_ROUT_DTL
            WHERE PCTL_NO = @[pctl_no]) D
       , MDM_VSL_SVC_LANE SL,MDM_VSL_SVC_LANE SD
	 WHERE M.PCTL_NO = D.PCTL_NO
	 AND D.PCTL_NO = Q.PCTL_NO
     AND D.ORG_NOD_CD LIKE DECODE(C.NOD_CD, 'ALL','%',C.NOD_CD||'%')
	 AND NVL(M.CMDT_CD,'X')  = NVL(C.CMDT_CD, NVL(M.CMDT_CD,'X'))
	 AND NVL(C.DELT_FLG, 'N') <> 'Y'
	 AND NVL(C.CNTR_TP_CD, Q.CNTR_TPSZ_CD)
		= DECODE(C.CNTR_TP_CD, NULL, Q.CNTR_TPSZ_CD, DECODE(SUBSTR(Q.CNTR_TPSZ_CD, 1, 1), 'T', 'T', 'O', 'S', 'F', 'S',
															--'D',DECODE(Q.CNTR_TPSZ_CD, 'D5', 'D5', 'D7', 'D7', Q.CNTR_TPSZ_CD),
															--'R',DECODE(Q.CNTR_TPSZ_CD, 'R2', 'R2', 'R5', 'R5', Q.CNTR_TPSZ_CD)))
															'D',Q.CNTR_TPSZ_CD,
															'R',Q.CNTR_TPSZ_CD) )
	 AND (
				TRUNC(TO_DATE(NVL(C.EFF_FM_DT,'19000101'),'yyyy/mm/dd hh24:mi:ss')) <= M.CRE_DT AND
				M.CRE_DT < TRUNC(TO_DATE(NVL(C.EFF_TO_DT,'25000101'),'yyyy/mm/dd hh24:mi:ss')+1)
	     )
	AND D.NOD_LNK_DIV_CD = 'N'
	AND SL.VSL_SLAN_CD(+) = D.POL_SLAN_CD
	AND SD.VSL_SLAN_CD(+) = D.POD_SLAN_CD
    AND (   D.POL_SLAN_CD || ',' || DECODE(SL.VSL_SVC_TP_CD, 'O', 'FDR') LIKE '%' || C.VSL_SLAN_CD || '%'
         OR D.POD_SLAN_CD || ',' || DECODE(SD.VSL_SVC_TP_CD, 'O', 'FDR') LIKE '%' || C.VSL_SLAN_CD || '%'
        )
    AND NVL(C.VSL_CD || C.SKD_VOY_NO || C.SKD_DIR_CD, '#') IN (D.POL_VVD, D.POD_VVD, DECODE(C.VSL_CD || C.SKD_VOY_NO || C.SKD_DIR_CD, NULL, '#'))
	ORDER BY DECODE(NVL(SVC_USE_FLG,'Y'),'N',1,2)
    ) CC
WHERE NVL(CC.port_pnt_cd, 'ALL') = 'ALL' 
OR    CC.port_pnt_cd IN (
          (SELECT CASE
              WHEN PCTL_SEQ  = (SELECT  MIN(PCTL_SEQ) FROM PRD_PROD_CTL_ROUT_DTL
                  WHERE  PCTL_NO = DD.pctl_no
                  AND PCTL_IO_BND_CD = 'O'
                  AND NOD_LNK_DIV_CD = 'N'
                  AND MTY_YD_FLG = 'N'  ) THEN 'POR'
              END
          FROM PRD_PROD_CTL_ROUT_DTL DD
          WHERE DD.pctl_no = CC.pctl_no
          AND Dd.NOD_LNK_DIV_CD = 'N'
          and dd.PCTL_SEQ = cc.PCTL_SEQ
          AND (DD.ORG_NOD_CD LIKE CC.NOD_CD||'%')
          ),
          (SELECT CASE
              WHEN PCTL_SEQ  = (SELECT  MAX(PCTL_SEQ) FROM PRD_PROD_CTL_ROUT_DTL
                  WHERE  PCTL_NO = DD.pctl_no
                  AND PCTL_IO_BND_CD = 'O'
                  AND NOD_LNK_DIV_CD = 'N'
                  AND MTY_YD_FLG = 'N'  ) THEN 'POL'
              END
          FROM PRD_PROD_CTL_ROUT_DTL DD
          WHERE DD.pctl_no = CC.pctl_no
          AND Dd.NOD_LNK_DIV_CD = 'N'
          and dd.PCTL_SEQ = cc.PCTL_SEQ
          AND (DD.ORG_NOD_CD LIKE CC.NOD_CD||'%')
          ),
          (SELECT CASE
              WHEN PCTL_SEQ  IN (SELECT  PCTL_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                  WHERE  PCTL_NO = DD.pctl_no
                  AND PCTL_IO_BND_CD = 'T'
                  AND NOD_LNK_DIV_CD = 'N'  ) THEN 'TS'
              END
          FROM PRD_PROD_CTL_ROUT_DTL DD
          WHERE DD.pctl_no = CC.pctl_no
          AND Dd.NOD_LNK_DIV_CD = 'N'
          and dd.PCTL_SEQ = cc.PCTL_SEQ
          AND (DD.ORG_NOD_CD LIKE CC.NOD_CD||'%')
          ),
          (SELECT CASE
              WHEN PCTL_SEQ  = (SELECT  MIN(PCTL_SEQ) FROM PRD_PROD_CTL_ROUT_DTL
                  WHERE  PCTL_NO = DD.pctl_no
                  AND PCTL_IO_BND_CD = 'I'
                  AND NOD_LNK_DIV_CD = 'N'
                  AND MTY_YD_FLG = 'N'  ) THEN 'POD'
              END
          FROM PRD_PROD_CTL_ROUT_DTL DD
          WHERE DD.pctl_no = CC.pctl_no
          AND Dd.NOD_LNK_DIV_CD = 'N'
          and dd.PCTL_SEQ = cc.PCTL_SEQ
          AND (DD.ORG_NOD_CD LIKE CC.NOD_CD||'%')
          ),
          (SELECT CASE
              WHEN PCTL_SEQ  = (SELECT  MAX(PCTL_SEQ) FROM PRD_PROD_CTL_ROUT_DTL
                  WHERE  PCTL_NO = DD.pctl_no
                  AND PCTL_IO_BND_CD = 'I'
                  AND NOD_LNK_DIV_CD = 'N'
                  AND MTY_YD_FLG = 'N'  ) THEN 'DEL'
              END
          FROM PRD_PROD_CTL_ROUT_DTL DD
          WHERE DD.pctl_no = CC.pctl_no
          AND Dd.NOD_LNK_DIV_CD = 'N'
          and dd.PCTL_SEQ = cc.PCTL_SEQ
          AND (DD.ORG_NOD_CD LIKE CC.NOD_CD||'%')
          )
      )
ORDER BY NVL(CC.SVC_USE_FLG, 'Y')			]]></sql>
			<params>
				<param name="pctl_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
