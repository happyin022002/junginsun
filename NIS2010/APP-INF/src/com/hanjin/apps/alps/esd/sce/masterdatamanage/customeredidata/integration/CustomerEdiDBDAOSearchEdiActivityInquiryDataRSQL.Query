<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CustomerEdiDBDAOSearchEdiActivityInquiryDataRSQL">
			<desc><![CDATA[SearchEdiActivityInquiryData]]></desc>
			<sql><![CDATA[
select 
              distinct act_cd
             ,edi_sts                        
             , edi_sub_sts_cd                            
             , seq
             ,to_char(estm_dt,'yyyy/mm/dd hh24:mi:ss')  estm_dt                   
             ,to_char(event_date,'yyyy/mm/dd hh24:mi:ss') event_dt                                                   
             ,nod_cd
             ,to_char(edi_snd_dt,'yyyy/mm/dd hh24:mi:ss')   event_date 
             ------------------------------------------------------------------------------------    
             ,to_char(edi_lcl_dt,'yyyy/mm/dd hh24:mi:ss')  edi_lcl_dt           --20071129 LocalTime    
             ------------------------------------------------------------------------------------    
             ,edi_snd_rmk
             ,snd_tp1
             ,snd_tp2
             ,upd_id       
         from                                                                                      
         (                                                                                         
     
         --1. actual 수신 모두 와 그에 따른 edi 전송 여부                                                       
         select distinct ACT_CD, decode(e.edi_snd_rmk, null, null, STND_EDI_STS_CD) edi_sts,                    
                    e.edi_sub_sts_cd,                     
                  NVL(e.edi_snd_knt, '1') seq,                                                                  
                  decode(e.MNL_FLG, 'N', d.ACT_DT, 'Y', e.ACT_DT, d.act_dt) event_date, estm_dt,                
                  decode(e.NOD_CD, NULL, d.nod_cd, e.nod_cd) nod_cd,                                            
                  e.cre_dt edi_snd_dt,                                                                          
                  ----------------------------------------------------------------------------                  
                  e.gmt_dt edi_lcl_dt,                                    --20071129 LocalTime                   
                  ----------------------------------------------------------------------------                          
                  e.edi_snd_rmk                                                                                 
                  ,                                                                                             
                  'Y' snd_tp1, 'N' snd_tp2, 'COP Update' upd_id                                                                 
          from sce_cop_dtl d, SCE_EDI_SND_RSLT E                                                                
          where d.cop_no = @[cop_no]                                                                                     
          and d.ACT_DT is not null                                                                              
          and e.EDI_GRP_CD(+) = @[edi_grp_cd]                                                                             
          and e.bkg_no(+) = @[bkg_no]                                                                                   
          and e.cntr_no(+) = @[cntr_no]                                                                          
          and d.STND_EDI_STS_CD = e.EDI_STS_CD(+)                                                               
         -- and d.nod_cd = e.nod_cd(+)                                                                            
          and e.mnl_flg(+) = 'N'                                                                                
                                                                                                                
         -- 2. maulal 및 dir 전송                                                                               
         union all                                                                                              
          select distinct NULL, EDI_STS_CD edi_sts,                                                             
                    e.edi_sub_sts_cd,                           
                  NVL(e.edi_snd_knt, '1') seq,                                                                  
                  ACT_DT event_date, null,                                                                           
                  nod_cd,                                                                                       
                  e.cre_dt edi_snd_dt,                                                                          
                  ----------------------------------------------------------------------------                  
                  e.gmt_dt edi_lcl_dt,                                    --20071129 LocalTime                  
                  ----------------------------------------------------------------------------                  
                  e.edi_snd_rmk,                                                                                
                  'N' snd_tp1, decode(e.mnl_flg, 'Y', 'Y', 'N')  snd_tp2  , decode(e.mnl_flg, 'Y', upd_usr_id, 'EXP')                                                      
          from SCE_EDI_SND_RSLT E                                                                               
          where e.EDI_GRP_CD = @[edi_grp_cd]                                                                                
          and e.bkg_no = @[bkg_no]                                                                                      
          and e.cntr_no = @[cntr_no]                                                                                     
          and e.mnl_flg in ('Y', 'D')                                                                           
                                                                                                                
          -- 3. COP, EDI 미 전용 Actual                                                                         
          union all                                                                                             
                                                                                                                                                                                 
         select case when r.ACT_STS_MAPG_CD = 'OC' then 'Origin Terminal/Yard Arrival'                                        
                when r.ACT_STS_MAPG_CD = 'IC' then 'Destination Terminal/Yard Arrival'                            
                when r.ACT_STS_MAPG_CD = 'OP' then 'MOTYDO'                                                       
                when r.ACT_STS_MAPG_CD = 'ID' then 'Destination Final Departure for Cargo Delivery'               
                when r.ACT_STS_MAPG_CD in ('EN', 'TN') and r.act_dt <= d.estm_dt then 'Origin Terminal/Yard Departure'     
                when r.ACT_STS_MAPG_CD in ('EN', 'TN') and r.act_dt > d.estm_dt then  'Destination Terminal/Yard Departure'
                when r.ACT_STS_MAPG_CD = 'AL' and r.act_dt <= d.estm_dt then 'O/B Rail Loading'                   
                when r.ACT_STS_MAPG_CD = 'AL' and r.act_dt > d.estm_dt then 'I/B Rail Loading'                    
                when r.ACT_STS_MAPG_CD = 'RL' and r.act_dt <= d.estm_dt then 'O/B Rail Departure'                  
                when r.ACT_STS_MAPG_CD = 'RL' and r.act_dt > d.estm_dt then 'I/B Rail Departure'                  
                when r.ACT_STS_MAPG_CD = 'AR' and r.act_dt <= d.estm_dt then 'O/B Rail Arrival'                   
                when r.ACT_STS_MAPG_CD = 'AR' and r.act_dt > d.estm_dt then 'I/B Rail Arrival'                    
                when r.ACT_STS_MAPG_CD = 'UR' and r.act_dt <= d.estm_dt then 'O/B Rail Unloading'                  
                when r.ACT_STS_MAPG_CD = 'UR' and r.act_dt > d.estm_dt then 'I/B Rail Unloading'                  
                else r.ACT_STS_MAPG_CD end                                                                        
               ,null edi_sts                                                                                      
               ,null edi_sub_sts_cd                                                                               
               ,null seq                                                                                          
               ,ACT_DT event_date                                                                                 
               ,null                                                                                              
               ,NOD_CD                                                                                            
               ,null                                                                                              
               ----------------------------------------------------------------------------                       
               ,null                                                   --20071129 LocalTime                        
               ----------------------------------------------------------------------------                       
               ,null                                                                                              
               ,'N' snd_tp1                                                                                       
               ,'N' snd_tp2                                                                                       
               ,'EXP'                                                                                             
         from  sce_act_rcv_if R                                                                                   
              ,(select estm_dt                                                                                             
                from   sce_cop_dtl                                                                                   
                where  cop_no = @[cop_no]                                                                               
                and    act_cd in ('FLVMLO',  'FLWMLO') ) d                                                                                                                                            
         where bkg_no = @[bkg_no]                                                                                                                                     
         and   cntr_no = @[cntr_no]                                                                                                                    
         and   ACT_UMCH_TP_CD = '30'                                                                                       
         and   nvl(edi_snd_rslt_flg, 'N') <> 'Y'        
                                                                                                                
          -- 4. EDI DOC 전송 data                                                                                
          union all                                                                                             
                                                                                                                
          select distinct NULL, EDI_STS_CD edi_sts,                                                             
                    e.edi_sub_sts_cd,                                   
                  NVL(e.edi_snd_knt, '1') seq,                                                                  
                  ACT_DT event_date, null,                                                                           
                  nod_cd,                                                                                       
                  e.cre_dt edi_snd_dt,                                                                          
                  ----------------------------------------------------------------------------                  
                  e.gmt_dt edi_lcl_dt,                                    --20071129 LocalTime                   
                  ----------------------------------------------------------------------------                  
                  e.edi_snd_rmk,                                                                                
                  'N' snd_tp1, 'N' snd_tp2, 'DOC'                                                               
          from SCE_EDI_SND_RSLT E, EDI_CGO_STND_STS S                                                           
          where e.EDI_GRP_CD = @[edi_grp_cd]                                                                                
          and e.bkg_no = @[bkg_no]                                                                                      
          and e.cntr_no = @[cntr_no]                                                                             
          and e.EDI_STS_CD = s.EDI_STND_STS_CD                                                                  
          and edi_sts_seq > 799                                                                            
                                                                                                                
          --5, Activity와 edi가 mapping되지 않는 sts                                                            
          union all                                                                                             
          select distinct NULL, EDI_STS_CD edi_sts,                                                             
                    e.edi_sub_sts_cd,                           
                  NVL(e.edi_snd_knt, '1') seq,                                                                  
                  ACT_DT event_date, null,                                                                           
                  nod_cd,                                                                                       
                  e.cre_dt edi_snd_dt,                                                                          
                  ----------------------------------------------------------------------------                  
                  e.gmt_dt edi_lcl_dt,                                    --20071129 LocalTime                   
                  ----------------------------------------------------------------------------                  
                  e.edi_snd_rmk,                                                                                
                  'Y' snd_tp1, 'N' snd_tp2, 'COP Update' upd_id                                                 
          from SCE_EDI_SND_RSLT E                                                                               
          where e.EDI_GRP_CD = @[edi_grp_cd]                                                                             
          and e.bkg_no = @[edi_bkg_no]                                                                                      
          and e.cntr_no = @[cntr_no]                                                                                     
          and e.mnl_flg = 'N'                                                                                   
          and edi_sts_cd in ('VET', 'VED')                                                                      
                                                                                                                
                                                                                           
         )    order by event_dt			]]></sql>
			<params>
				<param name="cop_no" type="12" value="" out="N"/>
				<param name="edi_grp_cd" type="12" value="" out="N"/>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="cntr_no" type="12" value="" out="N"/>
				<param name="edi_bkg_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
