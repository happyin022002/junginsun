<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="MarineTerminalInvoiceManageDBDAOCalculateTerminalInvoiceCostRSQL">
			<desc><![CDATA[CalculateTerminalInvoiceCost]]></desc>
			<sql><![CDATA[
SELECT /*+ opt_param('_complex_view_merging', 'false') */ 
		COST_CODE LGS_COST_CD,
	   CNTR_TPSZ_CD,
	   IO_BND_CD,
	   DECODE(DCGO_CLSS_CD,'','N',DCGO_CLSS_CD) DCGO_IND_CD,
	   RC_FLG,
	   TML_WRK_DY_CD,
	   IOC_CD,
	   LANE_CD,
	   LANE_CD LANE_CD2,
	   TML_TRNS_MOD_CD,
	   FM_TIER FM_TR_VOL_VAL,
	   TO_TIER TO_TR_VOL_VAL,
	   FM_TIER||' ~ '||TO_TIER TIER,
	   CALC_VOL_QTY,
	   RVIS_VOL_QTY,
	   VOL_TR_UT_CD,
	   CTRT_RT,
	   INV_AMT,
	   INV_AMT						CALC_AMT,
	   VSL_CD,
	   SKD_VOY_NO,
	   SKD_DIR_CD,
	   VSL_CD||SKD_VOY_NO||SKD_DIR_CD	VVD,
	   'TM'							CALC_COST_GRP_CD,
	   'A'							CALC_TP_CD,
	   ACCT_CD,
	   ATB_DT,
	   ''								CALC_RMK,
	   ''								TML_CRR_CD,
	   ''								N3PTY_FLG,
	   @[tml_so_ofc_cty_cd]								TML_SO_OFC_CTY_CD,
	   @[tml_so_seq]								TML_SO_SEQ,
	   0								TML_SO_DTL_SEQ,
	   CTY							TML_AGMT_OFC_CTY_CD,
	   SEQ							TML_AGMT_SEQ,
	   NO								TML_AGMT_VER_NO,
	   CURR_CHK,
	   CURR							CURR_CD,
	   '1'							INV_XCH_RT,
	   ACCM_CHK
FROM ( SELECT COST_CODE, CNTR_TPSZ_CD, CNTR_STY_CD, IO_BND_CD, DCGO_CLSS_CD, RC_FLG, AWK_CGO_FLG, TML_WRK_DY_CD, IOC_CD, LANE_CD, TML_TRNS_MOD_CD, FM_TIER, TO_TIER,
			  DECODE(ACCM_CHK,'Y',(TO_QTY - FM_QTY)+1,CAL_VOL) CALC_VOL_QTY, DECODE(ACCM_CHK,'Y',(TO_QTY - FM_QTY)+1,CAL_VOL) RVIS_VOL_QTY, VOL_TR_UT_CD, CTRT_RT,
			  CTRT_RT * DECODE(ACCM_CHK,'Y',(TO_QTY - FM_QTY)+1,CAL_VOL) INV_AMT, VSL_CD, SKD_VOY_NO, SKD_DIR_CD, ACCT_CD, ATB_DT, CTY, SEQ, NO,
			  DECODE(@[curr_cd],CURR,'Y','N') CURR_CHK, CURR, ACCM_CHK,
			  -- [CHM-201640588]자동계산시 Agreement Rate 값에 특정 Lane이 등록된 경우 lane을 우선해서 읽도록 로직 수정(2016.03.16 CAY D) 
			  RANK() OVER(PARTITION BY COST_CODE, CNTR_TPSZ_CD, CNTR_STY_CD, IO_BND_CD, DCGO_CLSS_CD ORDER BY RANK_CD) AS RANK_CD
	   FROM ( SELECT COST_CODE, Q.CNTR_TPSZ_CD, Q.CNTR_STY_CD, Q.IO_BND_CD, Q.DCGO_CLSS_CD, TML_WRK_DY_CD, Q.IOC_CD, Q.LANE_CD, Q.TML_TRNS_MOD_CD, Q.RC_FLG, Q.AWK_CGO_FLG, ACCM, CAL_VOL,
					 VSL_CD, SKD_VOY_NO, SKD_DIR_CD, ATB_DT, CTY, SEQ, NO, T.TML_AGMT_VOL_UT_CD VOL_TR_UT_CD,
					 DECODE(T.TML_AGMT_VOL_UT_CD,'C',C.AGMT_RT,T.AGMT_UT_RT) CTRT_RT, L.ACCT_CD,
					 NVL(T.FM_TR_VOL_VAL,1) FM_TIER, NVL(T.TO_TR_VOL_VAL,9999999) TO_TIER,
					 -- CHM-201538524 TES Accumulate Volume 계산인 경우 Tier 중복으로 처리되는 로직 부분을 수정 - (2015-10-16 YYS B) FM_QTY 부분만 원복
					 ( CASE WHEN CHK_FM_QTY >= NVL(T.FM_TR_VOL_VAL,1)
							THEN CHK_FM_QTY + 1
							ELSE NVL(T.FM_TR_VOL_VAL,1)
					   END )  FM_QTY,
					 -- CHM-201537921 TES Invoice Calculation로직 오류(CNTR Verify) - (2015-09-07 CAY D)
					 --( CASE WHEN NVL(CHK_FM_QTY, ACCM) >= NVL(T.FM_TR_VOL_VAL, 1) AND NVL(CHK_FM_QTY, ACCM) <> CHK_TO_QTY THEN NVL(CHK_FM_QTY, ACCM) + 1
					--		WHEN NVL(CHK_FM_QTY, ACCM) >= NVL(T.FM_TR_VOL_VAL, 1) THEN NVL(CHK_FM_QTY, ACCM)
					--		ELSE NVL(T.FM_TR_VOL_VAL, 1)
					--   END )  FM_QTY,
					 ( CASE WHEN CHK_TO_QTY <= NVL(T.TO_TR_VOL_VAL,9999999)
							THEN CHK_TO_QTY
							ELSE NVL(T.TO_TR_VOL_VAL,9999999)
					   END )  TO_QTY,
					   T.CURR_CD CURR,
					   ACCM_CHK,
					   TES_GET_MAS_RANK_FNC(NVL(T.LANE_CD,'N'),NVL(T.TML_TRNS_MOD_CD,'N')) RANK_CD
			  FROM ( SELECT COST_CODE, CNTR_TPSZ_CD, CNTR_STY_CD, IO_BND_CD, DCGO_CLSS_CD, TML_WRK_DY_CD, IOC_CD, LANE_CD, TML_TRNS_MOD_CD, RC_FLG, AWK_CGO_FLG, ACCM, CAL_VOL, CHK_TO_QTY,
							DECODE(ACCM+CAL_VOL,CHK_TO_QTY,ACCM, NVL(LAG(CHK_TO_QTY) OVER (PARTITION BY ACCM_CHK --COST_CODE, CNTR_TPSZ_CD, IO_BND_CD, DCGO_CLSS_CD,
									--TML_WRK_DY_CD, IOC_CD, LANE_CD, TML_TRNS_MOD_CD, ACCM, CAL_VOL, CHK_TO_QTY, VSL_CD, SKD_VOY_NO, SKD_DIR_CD, ATB_DT, CTY, SEQ, NO
									ORDER BY COST_CODE, CNTR_TPSZ_CD, IO_BND_CD, DCGO_CLSS_CD,TML_WRK_DY_CD, IOC_CD, LANE_CD, TML_TRNS_MOD_CD), ACCM)) CHK_FM_QTY,
							VSL_CD, SKD_VOY_NO, SKD_DIR_CD, ATB_DT, CTY, SEQ, NO, ACCM_CHK
					 FROM ( SELECT COST_CODE, CNTR_TPSZ_CD, CNTR_STY_CD, IO_BND_CD, DCGO_CLSS_CD, TML_WRK_DY_CD, IOC_CD, LANE_CD, TML_TRNS_MOD_CD, RC_FLG, AWK_CGO_FLG, ACCM, CAL_VOL,
							SUM(CAL_VOL) OVER (PARTITION BY ACCM_CHK--COST_CODE, CNTR_TPSZ_CD, IO_BND_CD, DCGO_CLSS_CD, TML_WRK_DY_CD, IOC_CD, LANE_CD, TML_TRNS_MOD_CD,
															 --ACCM, CAL_VOL, VSL_CD, SKD_VOY_NO, SKD_DIR_CD, ATB_DT, CTY, SEQ, NO
												ORDER BY COST_CODE, CNTR_TPSZ_CD, IO_BND_CD, DCGO_CLSS_CD, TML_WRK_DY_CD, IOC_CD, LANE_CD, TML_TRNS_MOD_CD
												RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW ) + ACCM CHK_TO_QTY,
							 VSL_CD, SKD_VOY_NO, SKD_DIR_CD, ATB_DT, CTY, SEQ, NO, ACCM_CHK
					  FROM   (
					  SELECT DISTINCT COST_CODE, CNTR_TPSZ_CD, CNTR_STY_CD, I.IO_BND_CD, I.DCGO_CLSS_CD,
							 DECODE(I.HO,0,I.TML_WRK_DY_CD,'HO') TML_WRK_DY_CD, TML_WRK_DY_CD TML_WRK_DY_CD2, I.IOC_CD, I.LANE_CD, --I.WRK_DT,
							 D.TML_TRNS_MOD_CD, --DECODE(D.TML_TRNS_MOD_CD,'S','S',I.TML_TRNS_MOD_CD) TML_TRNS_MOD_CD,
							 I.RC_FLG, I.AWK_CGO_FLG, DECODE(ACCM,'Y',TO_NUMBER(REPLACE(@[pay_vol_qty],',')),0) ACCM,
							 DECODE(ACCM,'Y',DECODE(ACCM_UOM,'T',TEU_CAL,CAL_VOL),DECODE(D.TML_AGMT_VOL_UT_CD,'T',TEU_CAL,CAL_VOL)) CAL_VOL,
							 VSL_CD, SKD_VOY_NO, SKD_DIR_CD, TO_CHAR(ATB_DT,'YYYYMMDD') ATB_DT, CTY, SEQ, NO, NVL(ACCM,'N') ACCM_CHK

-- TM 비용 Auto Calculation위해 추가한부분
					  FROM ( SELECT DECODE(L.LOCL_TS_IND_CD,
												  'T', DECODE(L.CNTR_STY_CD,
																   'F',DECODE(SUBSTR(C.COST_CODE,5,2),'TS',C.COST_CODE),
																	   DECODE(SUBSTR(C.COST_CODE,5,2),'TM',C.COST_CODE)),
													   DECODE(L.CNTR_STY_CD,
																   'F',DECODE(SUBSTR(C.COST_CODE,5,2),'FL',C.COST_CODE),
																	   DECODE(SUBSTR(C.COST_CODE,5,2),'MT',C.COST_CODE))) COST_CODE,
--		 TM 비용 Auto Calculation위해 삭제한부분
--		                      FROM ( SELECT DECODE(L.LOCL_TS_IND_CD,'T',DECODE(SUBSTR(C.COST_CODE,5,2),'TS',C.COST_CODE),
--		                                          DECODE(L.CNTR_STY_CD,'F',DECODE(SUBSTR(C.COST_CODE,5,2),'FL',C.COST_CODE),
--		                                          DECODE(SUBSTR(C.COST_CODE,5,2),'MT',C.COST_CODE))) COST_CODE,
										  CNTR_TPSZ_CD, CNTR_STY_CD, IO_BND_CD, L.DCGO_CLSS_CD, --L.WRK_DT,
										  DECODE(TO_CHAR(L.WRK_DT,'D'),7,'SA',1,'SU','WD') TML_WRK_DY_CD,
--		                                          DECODE(TO_CHAR(L.WRK_DT,'DY'),'SAT','SA','SUN','SU','WD') TML_WRK_DY_CD,
										  MAX(( SELECT COUNT(*)
											FROM   DMT_HOLIDAY
											WHERE  1=1
											AND	   TO_CHAR(HOL_DT,'YYYYMMDD')    =  TO_CHAR(L.WRK_DT,'YYYYMMDD')
											AND    CNT_CD    = SUBSTR(@[yd_cd],1,2)
											)) HO,
										  IOC_CD, LANE_CD, COUNT(DISTINCT CNTR_NO) CAL_VOL,
										  SUM(DECODE(L.CNTR_TPSZ_CD,'D7',1,'O7',1,0))*2.25+
										  SUM(DECODE(L.CNTR_TPSZ_CD,'D8',1,0))*2.4+
										  SUM(DECODE(L.CNTR_TPSZ_CD,'D9',1,0))*2.4+
										  SUM(DECODE(L.CNTR_TPSZ_CD,'DW',1,0))*2.65+
										  SUM(DECODE(L.CNTR_TPSZ_CD,'DX',1,0))*2.25+
										  SUM(DECODE(L.CNTR_TPSZ_CD,'D7',0,'D8',0,'D9',0,'DW',0,'DX',0,'O7',0,
											  DECODE(SUBSTR(L.CNTR_TPSZ_CD,2,1),2,1,0)))+
										  SUM(DECODE(L.CNTR_TPSZ_CD,'D7',0,'D8',0,'D9',0,'DW',0,'DX',0,'O7',0,
											  DECODE(SUBSTR(L.CNTR_TPSZ_CD,2,1),2,0,1*2))) TEU_CAL,
										  CTY, SEQ, NO, L.VSL_CD, L.SKD_VOY_NO, L.SKD_DIR_CD, L.ATB_DT,
										  DECODE(C.TML_TRNS_MOD_CD,'S','S',L.TML_TRNS_MOD_CD) TML_TRNS_MOD_CD, L.RC_FLG, L.AWK_CGO_FLG,
										  MAX(( SELECT 'Y'
											FROM   TES_TML_SO_ACCM_COST
											WHERE  VNDR_SEQ = @[vndr_seq]
											AND    ACCM_SEQ = @[accm_seq]
--		                                            AND    LGS_COST_CD = DECODE(L.LOCL_TS_IND_CD,'T',DECODE(SUBSTR(C.COST_CODE,5,2),'TS',C.COST_CODE),
--		                                               DECODE(L.CNTR_STY_CD,'F',DECODE(SUBSTR(C.COST_CODE,5,2),'FL',C.COST_CODE),
--		                                               DECODE(SUBSTR(C.COST_CODE,5,2),'MT',C.COST_CODE))) ) ACCM,
/* 2008-06-20 : 김기영 부장님의 요청으로 TS/TM 구분에도 F/M 기준으로 변경  */
											AND    LGS_COST_CD = DECODE(L.LOCL_TS_IND_CD,'T',DECODE(L.CNTR_STY_CD,'F',DECODE(SUBSTR(C.COST_CODE,5,2),'TS',C.COST_CODE),
																													  DECODE(SUBSTR(C.COST_CODE,5,2),'TM',C.COST_CODE)),
																							 DECODE(L.CNTR_STY_CD,'F',DECODE(SUBSTR(C.COST_CODE,5,2),'FL',C.COST_CODE),
																													  DECODE(SUBSTR(C.COST_CODE,5,2),'MT',C.COST_CODE)))) ) ACCM,
										  ( SELECT TML_ACCM_UT_CD
											FROM   TES_TML_SO_ACCM_MZD
											WHERE  VNDR_SEQ = @[vndr_seq]
											AND    ACCM_SEQ = @[accm_seq] ) ACCM_UOM
								   FROM   TES_TML_SO_CNTR_LIST L,
										  ( SELECT DISTINCT DECODE(1,0,C.LGS_COST_CD,DECODE(C.LGS_COST_CD,CD,TP,C.LGS_COST_CD)) COST_CODE,
												   CTY, SEQ, NO, NVL(D.TML_TRNS_MOD_CD,'S') TML_TRNS_MOD_CD
											FROM ( SELECT COUNT(T.LGS_COST_CD) CNT,
														  T.LGS_COST_CD TP,
														  T.THRP_LGS_COST_CD CD,
														  H.TML_AGMT_OFC_CTY_CD CTY,
														  H.TML_AGMT_SEQ SEQ,
														  H.TML_AGMT_VER_NO NO
												   FROM   TES_TML_AGMT_HDR H, TES_TML_AGMT_THRP_COST T
												   WHERE  H.YD_CD            = @[yd_cd]
												   AND    H.VNDR_SEQ         = @[vndr_seq]
												   AND    H.TML_AGMT_STS_CD = 'C'
												   AND    H.DELT_FLG        = 'N'
												   AND    TO_CHAR(H.EFF_FM_DT,'YYYYMMDD') <= REPLACE(@[atb_dt],'-')
												   AND    TO_CHAR(H.EFF_TO_DT,'YYYYMMDD') >= REPLACE(@[atb_dt],'-')
												   AND    H.TML_AGMT_VER_NO = ( SELECT MAX(M.TML_AGMT_VER_NO)
																				FROM   TES_TML_AGMT_HDR M
																				WHERE  M.YD_CD               = @[yd_cd]
																				AND    M.VNDR_SEQ            = @[vndr_seq]
																				AND    M.TML_AGMT_STS_CD     = 'C'
																				AND    M.DELT_FLG            = 'N'
																				AND    TO_CHAR(M.EFF_FM_DT,'YYYYMMDD') <= REPLACE(@[atb_dt],'-')
																				AND    TO_CHAR(M.EFF_TO_DT,'YYYYMMDD') >= REPLACE(@[atb_dt],'-'))
												   AND    H.TML_AGMT_OFC_CTY_CD = T.TML_AGMT_OFC_CTY_CD(+)
												   AND    H.TML_AGMT_SEQ        = T.TML_AGMT_SEQ(+)
												   AND    H.TML_AGMT_VER_NO     = T.TML_AGMT_VER_NO(+)
												   GROUP BY H.TML_AGMT_OFC_CTY_CD, H.TML_AGMT_SEQ, H.TML_AGMT_VER_NO,
															T.LGS_COST_CD, T.THRP_LGS_COST_CD ) A, TES_TML_SO_COST C, TES_TML_AGMT_DTL D
											WHERE  C.COST_CALC_MZD_CD = 'A'
											AND    C.TML_AGMT_MGMT_CD = 'A'
											AND    C.MRN_TML_FLG = 'Y'
											AND    C.STO_INV_FLG = 'N'
											AND    D.TML_AGMT_OFC_CTY_CD = A.CTY
											AND    D.TML_AGMT_SEQ = A.SEQ
											AND    D.TML_AGMT_VER_NO  = A.NO
--		                                            AND    D.LGS_COST_CD  = A.TP(+)
											AND    C.LGS_COST_CD = D.LGS_COST_CD
											AND    DECODE(A.CNT,0,DECODE(SUBSTR(C.LGS_COST_CD,1,2),'TP','N','Y'),'Y') = 'Y' ) C
								   WHERE  VRFY_RSLT_IND_CD = 'CO'
								   AND    L.TML_SO_OFC_CTY_CD = @[tml_so_ofc_cty_cd]
								   AND    L.TML_SO_SEQ        = @[tml_so_seq]
								   AND    L.VSL_CD            = SUBSTR(@[vvd],1,4)
								   AND    L.SKD_VOY_NO        = SUBSTR(@[vvd],5,4)
								   AND    L.SKD_DIR_CD        = SUBSTR(@[vvd],9,1)
								   AND    L.IO_BND_CD	        = @[io_bnd_cd]
								   AND    NVL(L.CNTR_STY_CD,'N') <> 'R'
								   AND    NVL(L.BB_CGO_FLG,'N')  <> 'Y'
								   AND    ( NVL(L.CNTR_STY_CD,'N') <> 'M' OR NVL(LOCL_TS_IND_CD,'N') <> 'T' )
--TM 비용 Auto Calculation을 위해 추가한 부분
								   AND    DECODE(LOCL_TS_IND_CD,'T', DECODE(CNTR_STY_CD,'F','TS','TM')
																 , DECODE(CNTR_STY_CD,'F','FL','MT')) = SUBSTR(C.COST_CODE,5,2)
--TM 비용 Auto Calculation을 위해 삭제한 부분
--		                                   AND    DECODE(LOCL_TS_IND_CD,'T','TS',DECODE(CNTR_STY_CD,'F','FL','MT')) = SUBSTR(C.COST_CODE,5,2)
								   AND    DECODE(NVL(C.TML_TRNS_MOD_CD,'S'),'S','N',C.TML_TRNS_MOD_CD) = DECODE(NVL(C.TML_TRNS_MOD_CD,'S'),'S','N',L.TML_TRNS_MOD_CD)
								   GROUP BY C.COST_CODE, CNTR_TPSZ_CD, CNTR_STY_CD, LOCL_TS_IND_CD, IO_BND_CD, L.DCGO_CLSS_CD,
											DECODE(TO_CHAR(L.WRK_DT,'D'),7,'SA',1,'SU','WD'), --L.WRK_DT,
--		                                            DECODE(TO_CHAR(L.WRK_DT,'DY'),'SAT','SA','SUN','SU','WD'), --L.WRK_DT,
											IOC_CD, LANE_CD, CTY, SEQ, NO, L.VSL_CD, L.SKD_VOY_NO, L.SKD_DIR_CD, L.ATB_DT,
											DECODE(C.TML_TRNS_MOD_CD,'S','S',L.TML_TRNS_MOD_CD), L.RC_FLG, L.AWK_CGO_FLG) I,
							TES_TML_AGMT_DTL D
					 WHERE  I.CTY = D.TML_AGMT_OFC_CTY_CD
					 AND    I.SEQ = D.TML_AGMT_SEQ
					 AND    I.NO  = D.TML_AGMT_VER_NO
					 AND    D.TML_AGMT_TP_CD       = 'T'
					 AND    D.AUTO_CALC_FLG        = 'Y'
					 AND    SUBSTR(I.COST_CODE,1,4) <> 'SVSS'
					 AND    I.COST_CODE = D.LGS_COST_CD(+)
					 AND    SUBSTR(I.COST_CODE,5,2) <> 'MT'
					 AND    NVL(D.THRP_COST_CD_FLG,'N') <> 'Y'
					 AND    NVL(D.IO_BND_CD,'N')  = DECODE(NVL(D.IO_BND_CD,'N'),'N','N','S','S',I.IO_BND_CD)
					 AND    NVL(D.IOC_CD,'N')  = DECODE(NVL(D.IOC_CD,'N'),'N','N','S','S',I.IOC_CD)
--		                     AND    NVL(D.LANE_CD,'N')  = DECODE(NVL(D.LANE_CD,'N'),'N','N','Sam','Sam',I.LANE_CD)
					 AND    NVL(D.LANE_CD,'N') = DECODE(NVL(D.LANE_CD,'N'),'N','N','Sam','Sam',
											( SELECT DECODE((SELECT NVL('X','N')
															 FROM   TES_TML_AGMT_DTL
															 WHERE  TML_AGMT_OFC_CTY_CD = I.CTY
															 AND    TML_AGMT_SEQ        = I.SEQ
															 AND    TML_AGMT_VER_NO     = I.NO
															 AND    LANE_CD = I.LANE_CD
															 AND    ROWNUM = 1),'X',I.LANE_CD,'OTH')
											  FROM DUAL ))
					 AND    NVL(D.TML_TRNS_MOD_CD,'S') = DECODE(NVL(D.TML_TRNS_MOD_CD,'S'),'S','S',I.TML_TRNS_MOD_CD)
					 AND    NVL(D.FM_TR_VOL_VAL,1) = 1 ) ) ) Q, TES_TML_AGMT_DTL T, TES_TML_AGMT_TP_SZ C, TES_LGS_COST L,
				   TES_TML_AGMT_APLY_DY A, TES_TML_AGMT_DG_CGO_CLSS G
			  WHERE  Q.CTY = T.TML_AGMT_OFC_CTY_CD
			  AND    Q.SEQ = T.TML_AGMT_SEQ
			  AND    Q.NO  = T.TML_AGMT_VER_NO
			  AND    T.TML_AGMT_TP_CD       = 'T'
			  AND    T.AUTO_CALC_FLG        = 'Y'
			  AND    SUBSTR(Q.COST_CODE,1,4) <> 'SVSS'
			  AND    Q.COST_CODE = T.LGS_COST_CD(+)
			  AND    SUBSTR(Q.COST_CODE,5,2) <> 'MT'
			  AND    NVL(T.THRP_COST_CD_FLG,'N') <> 'Y'
			  AND    NVL(T.IO_BND_CD,'N')  = DECODE(NVL(T.IO_BND_CD,'N'),'N','N','S','S',Q.IO_BND_CD)
			  AND    NVL(T.IOC_CD,'N')  = DECODE(NVL(T.IOC_CD,'N'),'N','N','S','S',Q.IOC_CD)
--		              AND    NVL(T.LANE_CD,'N')  = DECODE(NVL(T.LANE_CD,'N'),'N','N','Sam','Sam',Q.LANE_CD)
			  AND    NVL(T.LANE_CD,'N') = DECODE(NVL(T.LANE_CD,'N'),'N','N','Sam','Sam',
											( SELECT DECODE((SELECT NVL('X','N')
															 FROM   TES_TML_AGMT_DTL
															 WHERE  TML_AGMT_OFC_CTY_CD = Q.CTY
															 AND    TML_AGMT_SEQ        = Q.SEQ
															 AND    TML_AGMT_VER_NO     = Q.NO
															 AND    LANE_CD = Q.LANE_CD
															 AND    ROWNUM = 1),'X',Q.LANE_CD,'OTH')
											  FROM DUAL ))
			  AND    NVL(T.TML_TRNS_MOD_CD,'N') = DECODE(NVL(T.TML_TRNS_MOD_CD,'N'),'N','N','S','S',Q.TML_TRNS_MOD_CD)
--			  AND    ( NVL(T.FM_TR_VOL_VAL,1) >= CHK_FM_QTY
--			  OR     NVL(T.TO_TR_VOL_VAL,9999999) <= CHK_TO_QTY
--			  OR     NVL(T.TO_TR_VOL_VAL,9999999) >= CHK_TO_QTY )
				-- CHM-201537921 TES Invoice Calculation로직 오류(CNTR Verify) - (2015-09-07 CAY D)
				AND	DECODE(ACCM_CHK, 'Y', DECODE(CHK_FM_QTY, 0, 1, CHK_FM_QTY) - NVL(T.FM_TR_VOL_VAL, 1), DECODE(CHK_FM_QTY, 0, 1, CHK_FM_QTY) - ACCM - NVL(T.FM_TR_VOL_VAL, 1)) >= 0
				AND	NVL(T.TO_TR_VOL_VAL, 9999999) - CHK_TO_QTY >= 0
			  AND    T.TML_AGMT_OFC_CTY_CD = C.TML_AGMT_OFC_CTY_CD(+)
			  AND    T.TML_AGMT_SEQ = C.TML_AGMT_SEQ(+)
			  AND    T.TML_AGMT_VER_NO = C.TML_AGMT_VER_NO(+)
			  AND    T.TML_AGMT_DTL_SEQ = C.TML_AGMT_DTL_SEQ(+)
--Special Cargo 관련 적용   --- 2008.05.26
			  AND    DECODE(T.TML_AGMT_VOL_UT_CD,'C',C.CNTR_TPSZ_CD,'N') 
					   = DECODE(T.TML_AGMT_VOL_UT_CD,
										'C', DECODE(Q.CNTR_STY_CD,
														'F', DECODE(SUBSTR(Q.CNTR_TPSZ_CD,1,1),
															   'R',DECODE(Q.RC_FLG,'N',DECODE(Q.CNTR_STY_CD, 'M', Q.CNTR_TPSZ_CD,'D'||SUBSTR(Q.CNTR_TPSZ_CD,2,1)),Q.CNTR_TPSZ_CD),
															   'O',DECODE(Q.AWK_CGO_FLG,'N','D'||SUBSTR(Q.CNTR_TPSZ_CD,2,1),Q.CNTR_TPSZ_CD),
															   'F',DECODE(Q.AWK_CGO_FLG,'N','D'||SUBSTR(Q.CNTR_TPSZ_CD,2,1),Q.CNTR_TPSZ_CD),
															   'P',DECODE(Q.AWK_CGO_FLG,'N','D'||SUBSTR(Q.CNTR_TPSZ_CD,2,1),Q.CNTR_TPSZ_CD),
															   'A',DECODE(Q.AWK_CGO_FLG,'N','D'||SUBSTR(Q.CNTR_TPSZ_CD,2,1),Q.CNTR_TPSZ_CD),
															   'S',DECODE(Q.AWK_CGO_FLG,'N','D'||SUBSTR(Q.CNTR_TPSZ_CD,2,1),Q.CNTR_TPSZ_CD),
																Q.CNTR_TPSZ_CD), Q.CNTR_TPSZ_CD),'N')
-- Special Cargo 적용 전 원본..
--		              AND    DECODE(T.TML_AGMT_VOL_UT_CD,'C',C.CNTR_TPSZ_CD,'N')
--							   = DECODE(T.TML_AGMT_VOL_UT_CD,
--							   					'C',DECODE(Q.RC_FLG,'N',DECODE(SUBSTR(Q.CNTR_TPSZ_CD,1,1),'R','D'||SUBSTR(Q.CNTR_TPSZ_CD,2,1),Q.CNTR_TPSZ_CD),Q.CNTR_TPSZ_CD),'N')
			  AND    Q.COST_CODE = L.LGS_COST_CD(+)
			  AND    T.TML_AGMT_OFC_CTY_CD  = A.TML_AGMT_OFC_CTY_CD(+)
		  AND    T.TML_AGMT_SEQ         = A.TML_AGMT_SEQ(+)
		  AND    T.TML_AGMT_VER_NO      = A.TML_AGMT_VER_NO(+)
		  AND    T.TML_AGMT_DTL_SEQ     = A.TML_AGMT_DTL_SEQ(+)
		  AND    ( DECODE(T.TML_DY_APLY_TP_CD,'P',Q.TML_WRK_DY_CD,'S') = DECODE(T.TML_DY_APLY_TP_CD,'P',DECODE(A.WKDY_FLG,'Y','WD'),'S')
		  OR       DECODE(T.TML_DY_APLY_TP_CD,'P',Q.TML_WRK_DY_CD,'S') = DECODE(T.TML_DY_APLY_TP_CD,'P',DECODE(A.SAT_FLG,'Y','SA'),'S')
		  OR       DECODE(T.TML_DY_APLY_TP_CD,'P',Q.TML_WRK_DY_CD,'S') = DECODE(T.TML_DY_APLY_TP_CD,'P',DECODE(A.SUN_FLG,'Y','SU'),'S')
		  OR       DECODE(T.TML_DY_APLY_TP_CD,'P',Q.TML_WRK_DY_CD,'S') = DECODE(T.TML_DY_APLY_TP_CD,'P',DECODE(A.HOL_FLG,'Y','HO'),'S') )
		  AND    T.TML_AGMT_OFC_CTY_CD = G.TML_AGMT_OFC_CTY_CD(+)
		  AND    T.TML_AGMT_SEQ        = G.TML_AGMT_SEQ(+)
		  AND    T.TML_AGMT_VER_NO     = G.TML_AGMT_VER_NO(+)
		  AND    T.TML_AGMT_DTL_SEQ    = G.TML_AGMT_DTL_SEQ(+)
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'N','N',G.DCGO_APLY_TP_CD) = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'N','N','R')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'A',DECODE(Q.DCGO_CLSS_CD,'N','N',G.DCGO_SAM_CLSS_FLG),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'A',DECODE(Q.DCGO_CLSS_CD,'N','N','Y'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'A',DECODE(Q.DCGO_CLSS_CD,'N',G.DCGO_NON_CLSS_FLG,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'N',G.DCGO_NON_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'A',DECODE(Q.DCGO_CLSS_CD,'N','Y','N'),'S',DECODE(Q.DCGO_CLSS_CD,'N','Y','N'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'1',G.DCGO_N1ST_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'1','Y','N'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'2',G.DCGO_N2ND_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'2','Y','N'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'3',G.DCGO_N3RD_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'3','Y','N'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'4',G.DCGO_N4TH_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'4','Y','N'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'5',G.DCGO_N5TH_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'5','Y','N'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'6',G.DCGO_N6TH_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'6','Y','N'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'7',G.DCGO_N7TH_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'7','Y','N'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'8',G.DCGO_N8TH_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'8','Y','N'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'9',G.DCGO_N9TH_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'9','Y','N'),'N')  )
	   WHERE DECODE(ACCM_CHK,'Y',(TO_QTY - FM_QTY),0) >= 0
	   UNION ALL
	   SELECT COST_CODE, CNTR_TPSZ_CD, CNTR_STY_CD, IO_BND_CD, DCGO_CLSS_CD, RC_FLG, AWK_CGO_FLG, TML_WRK_DY_CD, IOC_CD, LANE_CD, TML_TRNS_MOD_CD, FM_TIER, TO_TIER,
			  DECODE(ACCM_CHK,'Y',(TO_QTY - FM_QTY)+1,CAL_VOL) CALC_VOL_QTY, DECODE(ACCM_CHK,'Y',(TO_QTY - FM_QTY)+1,CAL_VOL) RVIS_VOL_QTY, VOL_TR_UT_CD, CTRT_RT,
			  CTRT_RT * DECODE(ACCM_CHK,'Y',(TO_QTY - FM_QTY)+1,CAL_VOL) INV_AMT, VSL_CD, SKD_VOY_NO, SKD_DIR_CD, ACCT_CD, ATB_DT,
			  CTY, SEQ, NO, DECODE(@[curr_cd],CURR,'Y','N') CURR_CHK, CURR, ACCM_CHK,
			  -- [CHM-201640588]자동계산시 Agreement Rate 값에 특정 Lane이 등록된 경우 lane을 우선해서 읽도록 로직 수정(2016.03.16 CAY D) 
			  RANK() OVER(PARTITION BY COST_CODE, CNTR_TPSZ_CD, CNTR_STY_CD, IO_BND_CD, DCGO_CLSS_CD ORDER BY RANK_CD) AS RANK_CD
	   FROM ( SELECT COST_CODE, Q.CNTR_TPSZ_CD, Q.CNTR_STY_CD, Q.IO_BND_CD, Q.DCGO_CLSS_CD, TML_WRK_DY_CD, Q.IOC_CD, Q.LANE_CD, Q.TML_TRNS_MOD_CD, Q.RC_FLG, Q.AWK_CGO_FLG, ACCM, CAL_VOL,
					 VSL_CD, SKD_VOY_NO, SKD_DIR_CD, ATB_DT, CTY, SEQ, NO, T.TML_AGMT_VOL_UT_CD VOL_TR_UT_CD,
					 DECODE(T.TML_AGMT_VOL_UT_CD,'C',C.AGMT_RT,T.AGMT_UT_RT) CTRT_RT, L.ACCT_CD,
					 NVL(T.FM_TR_VOL_VAL,1) FM_TIER, NVL(T.TO_TR_VOL_VAL,9999999) TO_TIER,
					 -- CHM-201538524 TES Accumulate Volume 계산인 경우 Tier 중복으로 처리되는 로직 부분을 수정 - (2015-10-16 YYS B) FM_QTY 부분만 원복
					 ( CASE WHEN CHK_FM_QTY >= NVL(T.FM_TR_VOL_VAL,1)
							THEN CHK_FM_QTY + 1
							ELSE NVL(T.FM_TR_VOL_VAL,1)
					   END )  FM_QTY,
					 -- CHM-201537921 TES Invoice Calculation로직 오류(CNTR Verify) - (2015-09-07 CAY D)
					 --( CASE WHEN NVL(CHK_FM_QTY, ACCM) >= NVL(T.FM_TR_VOL_VAL, 1) AND NVL(CHK_FM_QTY, ACCM) <> CHK_TO_QTY THEN NVL(CHK_FM_QTY, ACCM) + 1
					--		WHEN NVL(CHK_FM_QTY, ACCM) >= NVL(T.FM_TR_VOL_VAL, 1) THEN NVL(CHK_FM_QTY, ACCM)
					--		ELSE NVL(T.FM_TR_VOL_VAL, 1)
					--   END )  FM_QTY,
					 ( CASE WHEN CHK_TO_QTY <= NVL(T.TO_TR_VOL_VAL,9999999)
							THEN CHK_TO_QTY
							ELSE NVL(T.TO_TR_VOL_VAL,9999999)
					   END )  TO_QTY,
					   T.CURR_CD CURR,
					   ACCM_CHK,
					   TES_GET_MAS_RANK_FNC(NVL(T.LANE_CD,'N'),NVL(T.TML_TRNS_MOD_CD,'N')) RANK_CD
			  FROM ( SELECT COST_CODE, CNTR_TPSZ_CD, CNTR_STY_CD, IO_BND_CD, DCGO_CLSS_CD, TML_WRK_DY_CD, IOC_CD, LANE_CD, TML_TRNS_MOD_CD, RC_FLG, AWK_CGO_FLG, ACCM, CAL_VOL, CHK_TO_QTY,
					  DECODE(ACCM+CAL_VOL,CHK_TO_QTY,ACCM, NVL(LAG(CHK_TO_QTY) OVER (PARTITION BY ACCM_CHK --COST_CODE, CNTR_TPSZ_CD, IO_BND_CD, DCGO_CLSS_CD, TML_WRK_DY_CD,
																							-- IOC_CD, LANE_CD, TML_TRNS_MOD_CD, ACCM, CAL_VOL, CHK_TO_QTY,
																							-- VSL_CD, SKD_VOY_NO, SKD_DIR_CD, ATB_DT, CTY, SEQ, NO
																				ORDER BY COST_CODE, CNTR_TPSZ_CD, IO_BND_CD, DCGO_CLSS_CD,
																			  TML_WRK_DY_CD, IOC_CD, LANE_CD, TML_TRNS_MOD_CD), ACCM)) CHK_FM_QTY,
					  VSL_CD, SKD_VOY_NO, SKD_DIR_CD, ATB_DT, CTY, SEQ, NO, ACCM_CHK
					 FROM ( SELECT COST_CODE, CNTR_TPSZ_CD, CNTR_STY_CD, IO_BND_CD, DCGO_CLSS_CD, TML_WRK_DY_CD, IOC_CD, LANE_CD, TML_TRNS_MOD_CD, RC_FLG, AWK_CGO_FLG, ACCM, CAL_VOL,
						   SUM(CAL_VOL) OVER (PARTITION BY ACCM_CHK --COST_CODE, CNTR_TPSZ_CD, IO_BND_CD, DCGO_CLSS_CD, TML_WRK_DY_CD, IOC_CD, LANE_CD, TML_TRNS_MOD_CD,
															 --ACCM, CAL_VOL, VSL_CD, SKD_VOY_NO, SKD_DIR_CD, ATB_DT, CTY, SEQ, NO
												ORDER BY COST_CODE, CNTR_TPSZ_CD, IO_BND_CD, DCGO_CLSS_CD, TML_WRK_DY_CD, IOC_CD, LANE_CD, TML_TRNS_MOD_CD
												RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW ) + ACCM CHK_TO_QTY,
							 VSL_CD, SKD_VOY_NO, SKD_DIR_CD, ATB_DT, CTY, SEQ, NO, ACCM_CHK
					  FROM   (
					  SELECT DISTINCT COST_CODE, CNTR_TPSZ_CD, CNTR_STY_CD, I.IO_BND_CD, I.DCGO_CLSS_CD,
							 DECODE(I.HO,0,I.TML_WRK_DY_CD,'HO') TML_WRK_DY_CD, TML_WRK_DY_CD TML_WRK_DY_CD2, I.IOC_CD, I.LANE_CD, --I.WRK_DT,
							 D.TML_TRNS_MOD_CD, --DECODE(D.TML_TRNS_MOD_CD,'S','S',I.TML_TRNS_MOD_CD) TML_TRNS_MOD_CD, I.RC_FLG,
							 I.RC_FLG, I.AWK_CGO_FLG, DECODE(ACCM,'Y',TO_NUMBER(REPLACE(@[pay_vol_qty],',')),0) ACCM,
							 DECODE(ACCM,'Y',DECODE(ACCM_UOM,'T',TEU_CAL,CAL_VOL),DECODE(D.TML_AGMT_VOL_UT_CD,'T',TEU_CAL,CAL_VOL)) CAL_VOL,
							 VSL_CD, SKD_VOY_NO, SKD_DIR_CD, TO_CHAR(ATB_DT,'YYYYMMDD') ATB_DT, CTY, SEQ, NO, NVL(ACCM,'N') ACCM_CHK
-- TM 비용 Auto Calculation위해 추가한부분
					  FROM ( SELECT DECODE(L.LOCL_TS_IND_CD,
												  'T', DECODE(L.CNTR_STY_CD,
																   'F',DECODE(SUBSTR(C.COST_CODE,5,2),'TS',C.COST_CODE),
																	   DECODE(SUBSTR(C.COST_CODE,5,2),'TM',C.COST_CODE)),
													   DECODE(L.CNTR_STY_CD,
																   'F',DECODE(SUBSTR(C.COST_CODE,5,2),'FL',C.COST_CODE),
																	   DECODE(SUBSTR(C.COST_CODE,5,2),'MT',C.COST_CODE))) COST_CODE,
--		 TM 비용 Auto Calculation위해 삭제한부분
--		                            FROM ( SELECT DECODE(L.LOCL_TS_IND_CD,'T',DECODE(SUBSTR(C.COST_CODE,5,2),'TS',C.COST_CODE),
--		                                          DECODE(L.CNTR_STY_CD,'F',DECODE(SUBSTR(C.COST_CODE,5,2),'FL',C.COST_CODE),
--		                                          DECODE(SUBSTR(C.COST_CODE,5,2),'MT',C.COST_CODE))) COST_CODE,
										  CNTR_TPSZ_CD, CNTR_STY_CD, IO_BND_CD, L.DCGO_CLSS_CD, --L.WRK_DT,
										  DECODE(TO_CHAR(L.WRK_DT,'D'),7,'SA',1,'SU','WD') TML_WRK_DY_CD,
--		                                          DECODE(TO_CHAR(L.WRK_DT,'DY'),'SAT','SA','SUN','SU','WD') TML_WRK_DY_CD,
										  MAX(( SELECT COUNT(*)
											FROM   DMT_HOLIDAY
											WHERE  1=1
											AND	   TO_CHAR(HOL_DT,'YYYYMMDD')    =  TO_CHAR(L.WRK_DT,'YYYYMMDD')
											AND    CNT_CD    = SUBSTR(@[yd_cd],1,2)
											)) HO,
										  IOC_CD, LANE_CD, COUNT(DISTINCT CNTR_NO) CAL_VOL,
										  SUM(DECODE(L.CNTR_TPSZ_CD,'D7',1,'O7',1,0))*2.25+
										  SUM(DECODE(L.CNTR_TPSZ_CD,'D8',1,0))*2.4+
										  SUM(DECODE(L.CNTR_TPSZ_CD,'D9',1,0))*2.4+
										  SUM(DECODE(L.CNTR_TPSZ_CD,'DW',1,0))*2.65+
										  SUM(DECODE(L.CNTR_TPSZ_CD,'DX',1,0))*2.25+
										  SUM(DECODE(L.CNTR_TPSZ_CD,'D7',0,'D8',0,'D9',0,'DW',0,'DX',0,'O7',0,
											  DECODE(SUBSTR(L.CNTR_TPSZ_CD,2,1),2,1,0)))+
										  SUM(DECODE(L.CNTR_TPSZ_CD,'D7',0,'D8',0,'D9',0,'DW',0,'DX',0,'O7',0,
											  DECODE(SUBSTR(L.CNTR_TPSZ_CD,2,1),2,0,1*2))) TEU_CAL,
										  CTY, SEQ, NO, L.VSL_CD, L.SKD_VOY_NO, L.SKD_DIR_CD, L.ATB_DT,
										  DECODE(C.TML_TRNS_MOD_CD,'S','S',L.TML_TRNS_MOD_CD) TML_TRNS_MOD_CD, L.RC_FLG, L.AWK_CGO_FLG,
										  MAX(( SELECT 'Y'
											FROM   TES_TML_SO_ACCM_COST
											WHERE  VNDR_SEQ = @[vndr_seq]
											AND    ACCM_SEQ = @[accm_seq]
--		                                            AND    LGS_COST_CD = DECODE(L.LOCL_TS_IND_CD,'T',DECODE(SUBSTR(C.COST_CODE,5,2),'TS',C.COST_CODE),
--		                                               DECODE(L.CNTR_STY_CD,'F',DECODE(SUBSTR(C.COST_CODE,5,2),'FL',C.COST_CODE),
--		                                               DECODE(SUBSTR(C.COST_CODE,5,2),'MT',C.COST_CODE))) ) ACCM,
/* 2008-06-20 : 김기영 부장님의 요청으로 TS/TM 구분에도 F/M 기준으로 변경  */
											AND    LGS_COST_CD = DECODE(L.LOCL_TS_IND_CD,'T',DECODE(L.CNTR_STY_CD,'F',DECODE(SUBSTR(C.COST_CODE,5,2),'TS',C.COST_CODE),
																													  DECODE(SUBSTR(C.COST_CODE,5,2),'TM',C.COST_CODE)),
																							 DECODE(L.CNTR_STY_CD,'F',DECODE(SUBSTR(C.COST_CODE,5,2),'FL',C.COST_CODE),
																													  DECODE(SUBSTR(C.COST_CODE,5,2),'MT',C.COST_CODE))) )) ACCM,
										  ( SELECT TML_ACCM_UT_CD
											FROM   TES_TML_SO_ACCM_MZD
											WHERE  VNDR_SEQ = @[vndr_seq]
											AND    ACCM_SEQ = @[accm_seq] ) ACCM_UOM
								   FROM   TES_TML_SO_CNTR_LIST L,
										  ( SELECT DISTINCT DECODE(1,0,C.LGS_COST_CD,DECODE(C.LGS_COST_CD,CD,TP,C.LGS_COST_CD)) COST_CODE,
												   CTY, SEQ, NO, NVL(D.TML_TRNS_MOD_CD,'S') TML_TRNS_MOD_CD
											FROM ( SELECT COUNT(T.LGS_COST_CD) CNT,
														  T.LGS_COST_CD TP,
														  T.THRP_LGS_COST_CD CD,
														  H.TML_AGMT_OFC_CTY_CD CTY,
														  H.TML_AGMT_SEQ SEQ,
														  H.TML_AGMT_VER_NO NO
												   FROM   TES_TML_AGMT_HDR H, TES_TML_AGMT_THRP_COST T
												   WHERE  H.YD_CD            = @[yd_cd]
												   AND    H.VNDR_SEQ         = @[vndr_seq]
												   AND    H.TML_AGMT_STS_CD = 'C'
												   AND    H.DELT_FLG        = 'N'
												   AND    TO_CHAR(H.EFF_FM_DT,'YYYYMMDD') <= REPLACE(@[atb_dt],'-')
												   AND    TO_CHAR(H.EFF_TO_DT,'YYYYMMDD') >= REPLACE(@[atb_dt],'-')
												   AND    H.TML_AGMT_VER_NO = ( SELECT MAX(M.TML_AGMT_VER_NO)
																				FROM   TES_TML_AGMT_HDR M
																				WHERE  M.YD_CD               = @[yd_cd]
																				AND    M.VNDR_SEQ            = @[vndr_seq]
																				AND    M.TML_AGMT_STS_CD     = 'C'
																				AND    M.DELT_FLG            = 'N'
																				AND    TO_CHAR(M.EFF_FM_DT,'YYYYMMDD') <= REPLACE(@[atb_dt],'-')
																				AND    TO_CHAR(M.EFF_TO_DT,'YYYYMMDD') >= REPLACE(@[atb_dt],'-'))
												   AND    H.TML_AGMT_OFC_CTY_CD = T.TML_AGMT_OFC_CTY_CD(+)
												   AND    H.TML_AGMT_SEQ        = T.TML_AGMT_SEQ(+)
												   AND    H.TML_AGMT_VER_NO     = T.TML_AGMT_VER_NO(+)
												   GROUP BY H.TML_AGMT_OFC_CTY_CD, H.TML_AGMT_SEQ, H.TML_AGMT_VER_NO,
															T.LGS_COST_CD, T.THRP_LGS_COST_CD ) A, TES_TML_SO_COST C, TES_TML_AGMT_DTL D
											WHERE  C.COST_CALC_MZD_CD = 'A'
											AND    C.TML_AGMT_MGMT_CD = 'A'
											AND    C.MRN_TML_FLG = 'Y'
											AND    C.STO_INV_FLG = 'N'
											AND    D.TML_AGMT_OFC_CTY_CD = A.CTY
											AND    D.TML_AGMT_SEQ = A.SEQ
											AND    D.TML_AGMT_VER_NO = A.NO
--		                                            AND    D.LGS_COST_CD  = A.TP(+)
											AND    C.LGS_COST_CD = D.LGS_COST_CD
											AND    DECODE(A.CNT,0,DECODE(SUBSTR(C.LGS_COST_CD,1,2),'TP','N','Y'),'Y') = 'Y' ) C
								   WHERE  VRFY_RSLT_IND_CD = 'CO'
								   AND    L.TML_SO_OFC_CTY_CD = @[tml_so_ofc_cty_cd]
								   AND    L.TML_SO_SEQ        = @[tml_so_seq]
								   AND    L.VSL_CD            = SUBSTR(@[vvd],1,4)
								   AND    L.SKD_VOY_NO        = SUBSTR(@[vvd],5,4)
								   AND    L.SKD_DIR_CD        = SUBSTR(@[vvd],9,1)
								   AND    L.IO_BND_CD	        = @[io_bnd_cd]
								   AND    NVL(L.CNTR_STY_CD,'N') <> 'R'
								   AND    NVL(L.BB_CGO_FLG,'N')  <> 'Y'
								   AND    ( NVL(L.CNTR_STY_CD,'N') <> 'M' OR NVL(LOCL_TS_IND_CD,'N') <> 'T' )
--TM 비용 Auto Calculation을 위해 추가한 부분
								   AND    DECODE(LOCL_TS_IND_CD,'T', DECODE(CNTR_STY_CD,'F','TS','TM')
																 , DECODE(CNTR_STY_CD,'F','FL','MT')) = SUBSTR(C.COST_CODE,5,2)
--TM 비용 Auto Calculation을 위해 삭제한 부분
--		                                   AND    DECODE(LOCL_TS_IND_CD,'T','TS',DECODE(CNTR_STY_CD,'F','FL','MT')) = SUBSTR(C.COST_CODE,5,2)
								   AND    DECODE(NVL(C.TML_TRNS_MOD_CD,'S'),'S','N',C.TML_TRNS_MOD_CD) = DECODE(NVL(C.TML_TRNS_MOD_CD,'S'),'S','N',L.TML_TRNS_MOD_CD)
								   GROUP BY C.COST_CODE, CNTR_TPSZ_CD, CNTR_STY_CD, LOCL_TS_IND_CD, IO_BND_CD, L.DCGO_CLSS_CD,
											DECODE(TO_CHAR(L.WRK_DT,'D'),7,'SA',1,'SU','WD'), --L.WRK_DT,
--		                                            DECODE(TO_CHAR(L.WRK_DT,'DY'),'SAT','SA','SUN','SU','WD'), --L.WRK_DT,
											IOC_CD, LANE_CD, CTY, SEQ, NO, L.VSL_CD, L.SKD_VOY_NO, L.SKD_DIR_CD,
											L.ATB_DT, DECODE(C.TML_TRNS_MOD_CD,'S','S',L.TML_TRNS_MOD_CD), L.RC_FLG, L.AWK_CGO_FLG) I,
							TES_TML_AGMT_DTL D
					 WHERE  I.CTY = D.TML_AGMT_OFC_CTY_CD
					 AND    I.SEQ = D.TML_AGMT_SEQ
					 AND    I.NO  = D.TML_AGMT_VER_NO
					 AND    D.TML_AGMT_TP_CD       = 'T'
					 AND    D.AUTO_CALC_FLG        = 'Y'
					 AND    SUBSTR(I.COST_CODE,1,4) = 'SVSS'
					 AND    I.COST_CODE = D.LGS_COST_CD(+)
					 AND    SUBSTR(I.COST_CODE,5,2) <> 'MT'
					 AND    NVL(D.THRP_COST_CD_FLG,'N') <> 'Y'
					 AND    NVL(D.IO_BND_CD,'N')  = DECODE(NVL(D.IO_BND_CD,'N'),'N','N','S','S',I.IO_BND_CD)
					 AND    NVL(D.IOC_CD,'N')  = DECODE(NVL(D.IOC_CD,'N'),'N','N','S','S',I.IOC_CD)
--		                     AND    NVL(D.LANE_CD,'N')  = DECODE(NVL(D.LANE_CD,'N'),'N','N','Sam','Sam',I.LANE_CD)
					 AND    NVL(D.LANE_CD,'N') = DECODE(NVL(D.LANE_CD,'N'),'N','N','Sam','Sam',
											( SELECT DECODE((SELECT NVL('X','N')
															 FROM   TES_TML_AGMT_DTL
															 WHERE  TML_AGMT_OFC_CTY_CD = I.CTY
															 AND    TML_AGMT_SEQ        = I.SEQ
															 AND    TML_AGMT_VER_NO     = I.NO
															 AND    LANE_CD = I.LANE_CD
															 AND    ROWNUM = 1),'X',I.LANE_CD,'OTH')
											  FROM DUAL ))
					 AND    NVL(D.TML_TRNS_MOD_CD,'S') = DECODE(NVL(D.TML_TRNS_MOD_CD,'S'),'S','S',I.TML_TRNS_MOD_CD)
					 AND    NVL(D.FM_TR_VOL_VAL,1) = 1 ) ) ) Q, TES_TML_AGMT_DTL T, TES_TML_AGMT_TP_SZ C, TES_LGS_COST L,
				   TES_TML_AGMT_APLY_DY A, TES_TML_AGMT_DG_CGO_CLSS G
			  WHERE  Q.CTY = T.TML_AGMT_OFC_CTY_CD
			  AND    Q.SEQ = T.TML_AGMT_SEQ
			  AND    Q.NO  = T.TML_AGMT_VER_NO
			  AND    T.TML_AGMT_TP_CD       = 'T'
			  AND    T.AUTO_CALC_FLG        = 'Y'
			  AND    SUBSTR(Q.COST_CODE,1,4) = 'SVSS'
			  AND    Q.COST_CODE = T.LGS_COST_CD(+)
			  AND    SUBSTR(Q.COST_CODE,5,2) <> 'MT'
			  AND    NVL(T.THRP_COST_CD_FLG,'N') <> 'Y'
			  AND    NVL(T.IO_BND_CD,'N')  = DECODE(NVL(T.IO_BND_CD,'N'),'N','N','S','S',Q.IO_BND_CD)
			  AND    NVL(T.IOC_CD,'N')  = DECODE(NVL(T.IOC_CD,'N'),'N','N','S','S',Q.IOC_CD)
--		              AND    NVL(T.LANE_CD,'N')  = DECODE(NVL(T.LANE_CD,'N'),'N','N','Sam','Sam',Q.LANE_CD)
			  AND    NVL(T.LANE_CD,'N') = DECODE(NVL(T.LANE_CD,'N'),'N','N','Sam','Sam',
											( SELECT DECODE((SELECT NVL('X','N')
															 FROM   TES_TML_AGMT_DTL
															 WHERE  TML_AGMT_OFC_CTY_CD = Q.CTY
															 AND    TML_AGMT_SEQ        = Q.SEQ
															 AND    TML_AGMT_VER_NO     = Q.NO
															 AND    LANE_CD = Q.LANE_CD
															 AND    ROWNUM = 1),'X',Q.LANE_CD,'OTH')
											  FROM DUAL ))
			  AND    NVL(T.TML_TRNS_MOD_CD,'N') = DECODE(NVL(T.TML_TRNS_MOD_CD,'N'),'N','N','S','S',Q.TML_TRNS_MOD_CD)
--			  AND    ( NVL(T.FM_TR_VOL_VAL,1) >= CHK_FM_QTY
--			  OR     NVL(T.TO_TR_VOL_VAL,9999999) <= CHK_TO_QTY
--			  OR     NVL(T.TO_TR_VOL_VAL,9999999) >= CHK_TO_QTY )
				-- CHM-201537921 TES Invoice Calculation로직 오류(CNTR Verify) - (2015-09-07 CAY D)
				AND	DECODE(ACCM_CHK, 'Y', DECODE(CHK_FM_QTY, 0, 1, CHK_FM_QTY) - NVL(T.FM_TR_VOL_VAL, 1), DECODE(CHK_FM_QTY, 0, 1, CHK_FM_QTY) - ACCM - NVL(T.FM_TR_VOL_VAL, 1)) >= 0
				AND	NVL(T.TO_TR_VOL_VAL, 9999999) - CHK_TO_QTY >= 0
			  AND    T.TML_AGMT_OFC_CTY_CD = C.TML_AGMT_OFC_CTY_CD(+)
			  AND    T.TML_AGMT_SEQ = C.TML_AGMT_SEQ(+)
			  AND    T.TML_AGMT_VER_NO = C.TML_AGMT_VER_NO(+)
			  AND    T.TML_AGMT_DTL_SEQ = C.TML_AGMT_DTL_SEQ(+)
			  AND    DECODE(T.TML_AGMT_VOL_UT_CD,'C',C.CNTR_TPSZ_CD,'N') 
					   = DECODE(T.TML_AGMT_VOL_UT_CD,
										'C', DECODE(Q.CNTR_STY_CD,
														'F', DECODE(SUBSTR(Q.CNTR_TPSZ_CD,1,1),
																   'R',DECODE(Q.RC_FLG,'N',DECODE(Q.CNTR_STY_CD, 'M', Q.CNTR_TPSZ_CD,'D'||SUBSTR(Q.CNTR_TPSZ_CD,2,1)),Q.CNTR_TPSZ_CD),
																   'O',DECODE(Q.AWK_CGO_FLG,'N','D'||SUBSTR(Q.CNTR_TPSZ_CD,2,1),Q.CNTR_TPSZ_CD),
																   'F',DECODE(Q.AWK_CGO_FLG,'N','D'||SUBSTR(Q.CNTR_TPSZ_CD,2,1),Q.CNTR_TPSZ_CD),
																   'P',DECODE(Q.AWK_CGO_FLG,'N','D'||SUBSTR(Q.CNTR_TPSZ_CD,2,1),Q.CNTR_TPSZ_CD),
																   'A',DECODE(Q.AWK_CGO_FLG,'N','D'||SUBSTR(Q.CNTR_TPSZ_CD,2,1),Q.CNTR_TPSZ_CD),
																   'S',DECODE(Q.AWK_CGO_FLG,'N','D'||SUBSTR(Q.CNTR_TPSZ_CD,2,1),Q.CNTR_TPSZ_CD),
																	Q.CNTR_TPSZ_CD),Q.CNTR_TPSZ_CD),'N')
--		              AND    DECODE(T.TML_AGMT_VOL_UT_CD,'C',C.CNTR_TPSZ_CD,'N') =
--						 		DECODE(T.TML_AGMT_VOL_UT_CD,
--						 					'C',DECODE(Q.RC_FLG,'N',DECODE(SUBSTR(Q.CNTR_TPSZ_CD,1,1),'R','D'||SUBSTR(Q.CNTR_TPSZ_CD,2,1),Q.CNTR_TPSZ_CD),Q.CNTR_TPSZ_CD),'N')
			  AND    Q.COST_CODE = L.LGS_COST_CD(+)
			  AND    T.TML_AGMT_OFC_CTY_CD  = A.TML_AGMT_OFC_CTY_CD(+)
		  AND    T.TML_AGMT_SEQ         = A.TML_AGMT_SEQ(+)
		  AND    T.TML_AGMT_VER_NO      = A.TML_AGMT_VER_NO(+)
		  AND    T.TML_AGMT_DTL_SEQ     = A.TML_AGMT_DTL_SEQ(+)
		  AND    ( DECODE(T.TML_DY_APLY_TP_CD,'P',Q.TML_WRK_DY_CD,'S') = DECODE(T.TML_DY_APLY_TP_CD,'P',DECODE(A.WKDY_FLG,'Y','WD'),'S')
		  OR       DECODE(T.TML_DY_APLY_TP_CD,'P',Q.TML_WRK_DY_CD,'S') = DECODE(T.TML_DY_APLY_TP_CD,'P',DECODE(A.SAT_FLG,'Y','SA'),'S')
		  OR       DECODE(T.TML_DY_APLY_TP_CD,'P',Q.TML_WRK_DY_CD,'S') = DECODE(T.TML_DY_APLY_TP_CD,'P',DECODE(A.SUN_FLG,'Y','SU'),'S')
		  OR       DECODE(T.TML_DY_APLY_TP_CD,'P',Q.TML_WRK_DY_CD,'S') = DECODE(T.TML_DY_APLY_TP_CD,'P',DECODE(A.HOL_FLG,'Y','HO'),'S') )
		  AND    T.TML_AGMT_OFC_CTY_CD = G.TML_AGMT_OFC_CTY_CD(+)
		  AND    T.TML_AGMT_SEQ        = G.TML_AGMT_SEQ(+)
		  AND    T.TML_AGMT_VER_NO     = G.TML_AGMT_VER_NO(+)
		  AND    T.TML_AGMT_DTL_SEQ    = G.TML_AGMT_DTL_SEQ(+)
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'N','N',G.DCGO_APLY_TP_CD) = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'N','N','R')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'A',DECODE(Q.DCGO_CLSS_CD,'N','N',G.DCGO_SAM_CLSS_FLG),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'A',DECODE(Q.DCGO_CLSS_CD,'N','N','Y'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'A',DECODE(Q.DCGO_CLSS_CD,'N',G.DCGO_NON_CLSS_FLG,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'N',G.DCGO_NON_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'A',DECODE(Q.DCGO_CLSS_CD,'N','Y','N'),'S',DECODE(Q.DCGO_CLSS_CD,'N','Y','N'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'1',G.DCGO_N1ST_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'1','Y','N'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'2',G.DCGO_N2ND_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'2','Y','N'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'3',G.DCGO_N3RD_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'3','Y','N'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'4',G.DCGO_N4TH_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'4','Y','N'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'5',G.DCGO_N5TH_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'5','Y','N'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'6',G.DCGO_N6TH_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'6','Y','N'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'7',G.DCGO_N7TH_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'7','Y','N'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'8',G.DCGO_N8TH_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'8','Y','N'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'9',G.DCGO_N9TH_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'9','Y','N'),'N')  )
	   WHERE DECODE(ACCM_CHK,'Y',(TO_QTY - FM_QTY),0) >= 0
	   UNION ALL
	   SELECT COST_CODE, CNTR_TPSZ_CD, CNTR_STY_CD, IO_BND_CD, DCGO_CLSS_CD, RC_FLG, AWK_CGO_FLG, TML_WRK_DY_CD, IOC_CD, LANE_CD, TML_TRNS_MOD_CD, FM_TIER, TO_TIER,
			  DECODE(ACCM_CHK,'Y',(TO_QTY - FM_QTY)+1,CAL_VOL) CALC_VOL_QTY, DECODE(ACCM_CHK,'Y',(TO_QTY - FM_QTY)+1,CAL_VOL) RVIS_VOL_QTY, VOL_TR_UT_CD, CTRT_RT,
			  CTRT_RT * DECODE(ACCM_CHK,'Y',(TO_QTY - FM_QTY)+1,CAL_VOL) INV_AMT, VSL_CD, SKD_VOY_NO, SKD_DIR_CD, ACCT_CD, ATB_DT,
			  CTY, SEQ, NO, DECODE(@[curr_cd],CURR,'Y','N') CURR_CHK, CURR, ACCM_CHK,
			  -- [CHM-201640588]자동계산시 Agreement Rate 값에 특정 Lane이 등록된 경우 lane을 우선해서 읽도록 로직 수정(2016.03.16 CAY D) 
			  RANK() OVER(PARTITION BY COST_CODE, CNTR_TPSZ_CD, CNTR_STY_CD, IO_BND_CD, DCGO_CLSS_CD ORDER BY RANK_CD) AS RANK_CD
	   FROM ( SELECT COST_CODE, Q.CNTR_TPSZ_CD, Q.CNTR_STY_CD, Q.IO_BND_CD, Q.DCGO_CLSS_CD, TML_WRK_DY_CD, Q.IOC_CD, Q.LANE_CD, Q.TML_TRNS_MOD_CD, Q.RC_FLG, Q.AWK_CGO_FLG, ACCM, CAL_VOL,
					 VSL_CD, SKD_VOY_NO, SKD_DIR_CD, ATB_DT, CTY, SEQ, NO, T.TML_AGMT_VOL_UT_CD VOL_TR_UT_CD,
					 DECODE(T.TML_AGMT_VOL_UT_CD,'C',C.AGMT_RT,T.AGMT_UT_RT) CTRT_RT, L.ACCT_CD,
					 NVL(T.FM_TR_VOL_VAL,1) FM_TIER, NVL(T.TO_TR_VOL_VAL,9999999) TO_TIER,
					 -- CHM-201538524 TES Accumulate Volume 계산인 경우 Tier 중복으로 처리되는 로직 부분을 수정 - (2015-10-16 YYS B) FM_QTY 부분만 원복
					 ( CASE WHEN CHK_FM_QTY >= NVL(T.FM_TR_VOL_VAL,1)
							THEN CHK_FM_QTY + 1
							ELSE NVL(T.FM_TR_VOL_VAL,1)
					   END )  FM_QTY,
					 -- CHM-201537921 TES Invoice Calculation로직 오류(CNTR Verify) - (2015-09-07 CAY D)
					 --( CASE WHEN NVL(CHK_FM_QTY, ACCM) >= NVL(T.FM_TR_VOL_VAL, 1) AND NVL(CHK_FM_QTY, ACCM) <> CHK_TO_QTY THEN NVL(CHK_FM_QTY, ACCM) + 1
					--		WHEN NVL(CHK_FM_QTY, ACCM) >= NVL(T.FM_TR_VOL_VAL, 1) THEN NVL(CHK_FM_QTY, ACCM)
					--		ELSE NVL(T.FM_TR_VOL_VAL, 1)
					--   END )  FM_QTY,
					 ( CASE WHEN CHK_TO_QTY <= NVL(T.TO_TR_VOL_VAL,9999999)
							THEN CHK_TO_QTY
							ELSE NVL(T.TO_TR_VOL_VAL,9999999)
					   END )  TO_QTY,
					   T.CURR_CD CURR,
					   ACCM_CHK,
					   TES_GET_MAS_RANK_FNC(NVL(T.LANE_CD,'N'),NVL(T.TML_TRNS_MOD_CD,'N')) RANK_CD
			  FROM ( SELECT COST_CODE, CNTR_TPSZ_CD, CNTR_STY_CD, IO_BND_CD, DCGO_CLSS_CD, TML_WRK_DY_CD, IOC_CD, LANE_CD, TML_TRNS_MOD_CD, RC_FLG, AWK_CGO_FLG, ACCM, CAL_VOL, CHK_TO_QTY,
					  DECODE(ACCM+CAL_VOL,CHK_TO_QTY,ACCM, NVL(LAG(CHK_TO_QTY) OVER (PARTITION BY ACCM_CHK --COST_CODE, CNTR_TPSZ_CD, IO_BND_CD, DCGO_CLSS_CD, TML_WRK_DY_CD,
																							-- IOC_CD, LANE_CD, TML_TRNS_MOD_CD, ACCM, CAL_VOL, CHK_TO_QTY,
																							-- VSL_CD, SKD_VOY_NO, SKD_DIR_CD, ATB_DT, CTY, SEQ, NO
																				ORDER BY COST_CODE, CNTR_TPSZ_CD, IO_BND_CD, DCGO_CLSS_CD,
																			  TML_WRK_DY_CD, IOC_CD, LANE_CD, TML_TRNS_MOD_CD), ACCM)) CHK_FM_QTY,
					  VSL_CD, SKD_VOY_NO, SKD_DIR_CD, ATB_DT, CTY, SEQ, NO, ACCM_CHK
					 FROM ( SELECT COST_CODE, CNTR_TPSZ_CD, CNTR_STY_CD, IO_BND_CD, DCGO_CLSS_CD, TML_WRK_DY_CD, IOC_CD, LANE_CD, TML_TRNS_MOD_CD, RC_FLG, AWK_CGO_FLG, ACCM, CAL_VOL,
						   SUM(CAL_VOL) OVER (PARTITION BY ACCM_CHK --COST_CODE, CNTR_TPSZ_CD, IO_BND_CD, DCGO_CLSS_CD, TML_WRK_DY_CD, IOC_CD, LANE_CD, TML_TRNS_MOD_CD,
															 --ACCM, CAL_VOL, VSL_CD, SKD_VOY_NO, SKD_DIR_CD, ATB_DT, CTY, SEQ, NO
												ORDER BY COST_CODE, CNTR_TPSZ_CD, IO_BND_CD, DCGO_CLSS_CD, TML_WRK_DY_CD, IOC_CD, LANE_CD, TML_TRNS_MOD_CD
												RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW ) + ACCM CHK_TO_QTY,
							 VSL_CD, SKD_VOY_NO, SKD_DIR_CD, ATB_DT, CTY, SEQ, NO, ACCM_CHK
					  FROM   (
					  SELECT DISTINCT COST_CODE, CNTR_TPSZ_CD, CNTR_STY_CD, I.IO_BND_CD, I.DCGO_CLSS_CD,
							 DECODE(I.HO,0,I.TML_WRK_DY_CD,'HO') TML_WRK_DY_CD, TML_WRK_DY_CD TML_WRK_DY_CD2, I.IOC_CD, I.LANE_CD, --I.WRK_DT,
							 D.TML_TRNS_MOD_CD,--DECODE(D.TML_TRNS_MOD_CD,'S','S',I.TML_TRNS_MOD_CD) TML_TRNS_MOD_CD, I.RC_FLG,
							 I.RC_FLG, I.AWK_CGO_FLG, DECODE(ACCM,'Y',TO_NUMBER(REPLACE(@[pay_vol_qty],',')),0) ACCM,
							 DECODE(ACCM,'Y',DECODE(ACCM_UOM,'T',TEU_CAL,CAL_VOL),DECODE(D.TML_AGMT_VOL_UT_CD,'T',TEU_CAL,CAL_VOL)) CAL_VOL,
							 VSL_CD, SKD_VOY_NO, SKD_DIR_CD, TO_CHAR(ATB_DT,'YYYYMMDD') ATB_DT, CTY, SEQ, NO, NVL(ACCM,'N') ACCM_CHK
-- TM 비용 Auto Calculation위해 추가한부분
					  FROM ( SELECT DECODE(L.LOCL_TS_IND_CD,
												  'T', DECODE(L.CNTR_STY_CD,
																   'F',DECODE(SUBSTR(C.COST_CODE,5,2),'TS',C.COST_CODE),
																	   DECODE(SUBSTR(C.COST_CODE,5,2),'TM',C.COST_CODE)),
													   DECODE(L.CNTR_STY_CD,
																   'F',DECODE(SUBSTR(C.COST_CODE,5,2),'FL',C.COST_CODE),
																	   DECODE(SUBSTR(C.COST_CODE,5,2),'MT',C.COST_CODE))) COST_CODE,
--		 TM 비용 Auto Calculation위해 삭제한부분
--		                      FROM ( SELECT DECODE(L.LOCL_TS_IND_CD,'T',DECODE(SUBSTR(C.COST_CODE,5,2),'TS',C.COST_CODE),
--		                                          DECODE(L.CNTR_STY_CD,'F',DECODE(SUBSTR(C.COST_CODE,5,2),'FL',C.COST_CODE),
--		                                          DECODE(SUBSTR(C.COST_CODE,5,2),'MT',C.COST_CODE))) COST_CODE,
										  CNTR_TPSZ_CD, CNTR_STY_CD, IO_BND_CD, L.DCGO_CLSS_CD, --L.WRK_DT,
										  DECODE(TO_CHAR(L.WRK_DT,'D'),7,'SA',1,'SU','WD') TML_WRK_DY_CD,
--		                                          DECODE(TO_CHAR(L.WRK_DT,'DY'),'SAT','SA','SUN','SU','WD') TML_WRK_DY_CD,
										  MAX(( SELECT COUNT(*)
											FROM   DMT_HOLIDAY
											WHERE  1=1
											AND	   TO_CHAR(HOL_DT,'YYYYMMDD')    =  TO_CHAR(L.WRK_DT,'YYYYMMDD')
											AND    CNT_CD    = SUBSTR(@[yd_cd],1,2)
											)) HO,
										  IOC_CD, LANE_CD, COUNT(DISTINCT CNTR_NO) CAL_VOL,
										  SUM(DECODE(L.CNTR_TPSZ_CD,'D7',1,'O7',1,0))*2.25+
										  SUM(DECODE(L.CNTR_TPSZ_CD,'D8',1,0))*2.4+
										  SUM(DECODE(L.CNTR_TPSZ_CD,'D9',1,0))*2.4+
										  SUM(DECODE(L.CNTR_TPSZ_CD,'DW',1,0))*2.65+
										  SUM(DECODE(L.CNTR_TPSZ_CD,'DX',1,0))*2.25+
										  SUM(DECODE(L.CNTR_TPSZ_CD,'D7',0,'D8',0,'D9',0,'DW',0,'DX',0,'O7',0,
											  DECODE(SUBSTR(L.CNTR_TPSZ_CD,2,1),2,1,0)))+
										  SUM(DECODE(L.CNTR_TPSZ_CD,'D7',0,'D8',0,'D9',0,'DW',0,'DX',0,'O7',0,
											  DECODE(SUBSTR(L.CNTR_TPSZ_CD,2,1),2,0,1*2))) TEU_CAL,
										  CTY, SEQ, NO, L.VSL_CD, L.SKD_VOY_NO, L.SKD_DIR_CD, L.ATB_DT,
										  DECODE(C.TML_TRNS_MOD_CD,'S','S',L.TML_TRNS_MOD_CD) TML_TRNS_MOD_CD, L.RC_FLG, L.AWK_CGO_FLG,
										  MAX(( SELECT 'Y'
											FROM   TES_TML_SO_ACCM_COST
											WHERE  VNDR_SEQ = @[vndr_seq]
											AND    ACCM_SEQ = @[accm_seq]
--		                                            AND    LGS_COST_CD = DECODE(L.LOCL_TS_IND_CD,'T',DECODE(SUBSTR(C.COST_CODE,5,2),'TS',C.COST_CODE),
--		                                               DECODE(L.CNTR_STY_CD,'F',DECODE(SUBSTR(C.COST_CODE,5,2),'FL',C.COST_CODE),
--		                                               DECODE(SUBSTR(C.COST_CODE,5,2),'MT',C.COST_CODE))) ) ACCM,
/* 2008-06-20 : 김기영 부장님의 요청으로 TS/TM 구분에도 F/M 기준으로 변경  */
											AND    LGS_COST_CD = DECODE(L.LOCL_TS_IND_CD,'T',DECODE(L.CNTR_STY_CD,'F',DECODE(SUBSTR(C.COST_CODE,5,2),'TS',C.COST_CODE),
																													  DECODE(SUBSTR(C.COST_CODE,5,2),'TM',C.COST_CODE)),
																							 DECODE(L.CNTR_STY_CD,'F',DECODE(SUBSTR(C.COST_CODE,5,2),'FL',C.COST_CODE),
																													  DECODE(SUBSTR(C.COST_CODE,5,2),'MT',C.COST_CODE))) )) ACCM,
										  ( SELECT TML_ACCM_UT_CD
											FROM   TES_TML_SO_ACCM_MZD
											WHERE  VNDR_SEQ = @[vndr_seq]
											AND    ACCM_SEQ = @[accm_seq] ) ACCM_UOM
								   FROM   TES_TML_SO_CNTR_LIST L,
										  ( SELECT DISTINCT DECODE(1,0,C.LGS_COST_CD,DECODE(C.LGS_COST_CD,CD,TP,C.LGS_COST_CD)) COST_CODE,
												   CTY, SEQ, NO, NVL(D.TML_TRNS_MOD_CD,'S') TML_TRNS_MOD_CD
											FROM ( SELECT COUNT(T.LGS_COST_CD) CNT,
														  T.LGS_COST_CD TP,
														  T.THRP_LGS_COST_CD CD,
														  H.TML_AGMT_OFC_CTY_CD CTY,
														  H.TML_AGMT_SEQ SEQ,
														  H.TML_AGMT_VER_NO NO
												   FROM   TES_TML_AGMT_HDR H, TES_TML_AGMT_THRP_COST T
												   WHERE  H.YD_CD            = @[yd_cd]
												   AND    H.VNDR_SEQ         = @[vndr_seq]
												   AND    H.TML_AGMT_STS_CD = 'C'
												   AND    H.DELT_FLG        = 'N'
												   AND    TO_CHAR(H.EFF_FM_DT,'YYYYMMDD') <= REPLACE(@[atb_dt],'-')
												   AND    TO_CHAR(H.EFF_TO_DT,'YYYYMMDD') >= REPLACE(@[atb_dt],'-')
												   AND    H.TML_AGMT_VER_NO = ( SELECT MAX(M.TML_AGMT_VER_NO)
																				FROM   TES_TML_AGMT_HDR M
																				WHERE  M.YD_CD               = @[yd_cd]
																				AND    M.VNDR_SEQ            = @[vndr_seq]
																				AND    M.TML_AGMT_STS_CD     = 'C'
																				AND    M.DELT_FLG            = 'N'
																				AND    TO_CHAR(M.EFF_FM_DT,'YYYYMMDD') <= REPLACE(@[atb_dt],'-')
																				AND    TO_CHAR(M.EFF_TO_DT,'YYYYMMDD') >= REPLACE(@[atb_dt],'-'))
												   AND    H.TML_AGMT_OFC_CTY_CD = T.TML_AGMT_OFC_CTY_CD(+)
												   AND    H.TML_AGMT_SEQ        = T.TML_AGMT_SEQ(+)
												   AND    H.TML_AGMT_VER_NO     = T.TML_AGMT_VER_NO(+)
												   GROUP BY H.TML_AGMT_OFC_CTY_CD, H.TML_AGMT_SEQ, H.TML_AGMT_VER_NO,
															T.LGS_COST_CD, T.THRP_LGS_COST_CD ) A, TES_TML_SO_COST C, TES_TML_AGMT_DTL D
											WHERE  C.COST_CALC_MZD_CD = 'A'
											AND    C.TML_AGMT_MGMT_CD = 'A'
											AND    C.MRN_TML_FLG = 'Y'
											AND    C.STO_INV_FLG = 'N'
											AND    D.TML_AGMT_OFC_CTY_CD = A.CTY
											AND    D.TML_AGMT_SEQ = A.SEQ
											AND    D.TML_AGMT_VER_NO = A.NO
--		                                            AND    D.LGS_COST_CD  = A.TP(+)
											AND    C.LGS_COST_CD = D.LGS_COST_CD
											AND    DECODE(A.CNT,0,DECODE(SUBSTR(C.LGS_COST_CD,1,2),'TP','N','Y'),'Y') = 'Y' ) C
								   WHERE  VRFY_RSLT_IND_CD = 'CO'
								   AND    L.TML_SO_OFC_CTY_CD = @[tml_so_ofc_cty_cd]
								   AND    L.TML_SO_SEQ        = @[tml_so_seq]
								   AND    L.VSL_CD            = SUBSTR(@[vvd],1,4)
								   AND    L.SKD_VOY_NO        = SUBSTR(@[vvd],5,4)
								   AND    L.SKD_DIR_CD        = SUBSTR(@[vvd],9,1)
								   AND    L.IO_BND_CD	        = @[io_bnd_cd]
								   AND    NVL(L.CNTR_STY_CD,'N') <> 'R'
								   AND    NVL(L.BB_CGO_FLG,'N')  <> 'Y'

--		TM 비용 Auto Calculation을 위해 삭제한 부분
--		                                   AND    ( NVL(L.CNTR_STY_CD,'N') <> 'M' OR NVL(LOCL_TS_IND_CD,'N') <> 'T' )
--TM 비용 Auto Calculation을 위해 추가한 부분
								   AND    DECODE(LOCL_TS_IND_CD,'T', DECODE(CNTR_STY_CD,'F','TS','TM')
																 , DECODE(CNTR_STY_CD,'F','FL','MT')) = SUBSTR(C.COST_CODE,5,2)
--TM 비용 Auto Calculation을 위해 삭제한 부분
--		                                   AND    DECODE(LOCL_TS_IND_CD,'T','TS',DECODE(CNTR_STY_CD,'F','FL','MT')) = SUBSTR(C.COST_CODE,5,2)
								   AND    DECODE(NVL(C.TML_TRNS_MOD_CD,'S'),'S','N',C.TML_TRNS_MOD_CD) = DECODE(NVL(C.TML_TRNS_MOD_CD,'S'),'S','N',L.TML_TRNS_MOD_CD)
								   GROUP BY C.COST_CODE, CNTR_TPSZ_CD, CNTR_STY_CD, LOCL_TS_IND_CD, IO_BND_CD, L.DCGO_CLSS_CD,
											DECODE(TO_CHAR(L.WRK_DT,'D'),7,'SA',1,'SU','WD'), --L.WRK_DT,
--		                                            DECODE(TO_CHAR(L.WRK_DT,'DY'),'SAT','SA','SUN','SU','WD'), --L.WRK_DT,
											IOC_CD, LANE_CD, CTY, SEQ, NO, L.VSL_CD, L.SKD_VOY_NO, L.SKD_DIR_CD,
											L.ATB_DT, DECODE(C.TML_TRNS_MOD_CD,'S','S',L.TML_TRNS_MOD_CD), L.RC_FLG, L.AWK_CGO_FLG) I,
							TES_TML_AGMT_DTL D
					 WHERE  I.CTY = D.TML_AGMT_OFC_CTY_CD
					 AND    I.SEQ = D.TML_AGMT_SEQ
					 AND    I.NO  = D.TML_AGMT_VER_NO
					 AND    D.TML_AGMT_TP_CD       = 'T'
					 AND    D.AUTO_CALC_FLG        = 'Y'
--		TM 비용 Auto Calculation을 위해 추가한 부분
					 AND    (SUBSTR(I.COST_CODE,1,4)||'MT' = DECODE(D.THRP_COST_CD_FLG,'Y',D.THRP_LGS_COST_CD,D.LGS_COST_CD)
							or SUBSTR(I.COST_CODE,1,4)||'TM' = DECODE(D.THRP_COST_CD_FLG,'Y',D.THRP_LGS_COST_CD,D.LGS_COST_CD)    )
--		TM 비용 Auto Calculation을 위해 삭제한 부분
--		                     AND    SUBSTR(I.COST_CODE,1,4)||'MT' = DECODE(D.THRP_COST_CD_FLG,'Y',D.THRP_LGS_COST_CD,D.LGS_COST_CD)
					 AND    I.COST_CODE = D.LGS_COST_CD(+)
					 AND    NVL(D.THRP_COST_CD_FLG,'N') <> 'Y'
					 AND    NVL(D.IO_BND_CD,'N')  = DECODE(NVL(D.IO_BND_CD,'N'),'N','N','S','S',I.IO_BND_CD)
					 AND    NVL(D.IOC_CD,'N')  = DECODE(NVL(D.IOC_CD,'N'),'N','N','S','S',I.IOC_CD)

--		                     AND    NVL(D.LANE_CD,'N')  = DECODE(NVL(D.LANE_CD,'N'),'N','N','Sam','Sam',I.LANE_CD)
					 AND    NVL(D.LANE_CD,'N') = DECODE(NVL(D.LANE_CD,'N'),'N','N','Sam','Sam',
											( SELECT DECODE((SELECT NVL('X','N')
															 FROM   TES_TML_AGMT_DTL
															 WHERE  TML_AGMT_OFC_CTY_CD = I.CTY
															 AND    TML_AGMT_SEQ        = I.SEQ
															 AND    TML_AGMT_VER_NO     = I.NO
															 AND    LANE_CD = I.LANE_CD
															 AND    ROWNUM = 1),'X',I.LANE_CD,'OTH')
											  FROM DUAL ))
					 AND    NVL(D.TML_TRNS_MOD_CD,'S') = DECODE(NVL(D.TML_TRNS_MOD_CD,'S'),'S','S',I.TML_TRNS_MOD_CD)
					 AND    NVL(D.FM_TR_VOL_VAL,1) = 1 ) ) ) Q, TES_TML_AGMT_DTL T, TES_TML_AGMT_TP_SZ C, TES_LGS_COST L,
				   TES_TML_AGMT_APLY_DY A, TES_TML_AGMT_DG_CGO_CLSS G
			  WHERE  Q.CTY = T.TML_AGMT_OFC_CTY_CD
			  AND    Q.SEQ = T.TML_AGMT_SEQ
			  AND    Q.NO  = T.TML_AGMT_VER_NO
			  AND    T.TML_AGMT_TP_CD       = 'T'
			  AND    T.AUTO_CALC_FLG        = 'Y'
			  AND    ( SUBSTR(Q.COST_CODE,1,4)||'MT' = DECODE(T.THRP_COST_CD_FLG,'Y',T.THRP_LGS_COST_CD,T.LGS_COST_CD)
					 OR SUBSTR(Q.COST_CODE,1,4)||'TM' = DECODE(T.THRP_COST_CD_FLG,'Y',T.THRP_LGS_COST_CD,T.LGS_COST_CD))
--		              AND    SUBSTR(Q.COST_CODE,1,4)||'MT' = DECODE(T.THRP_COST_CD_FLG,'Y',T.THRP_LGS_COST_CD,T.LGS_COST_CD)
			  AND    Q.COST_CODE = T.LGS_COST_CD(+)
			  AND    NVL(T.THRP_COST_CD_FLG,'N') <> 'Y'
			  AND    NVL(T.IO_BND_CD,'N')  = DECODE(NVL(T.IO_BND_CD,'N'),'N','N','S','S',Q.IO_BND_CD)
			  AND    NVL(T.IOC_CD,'N')  = DECODE(NVL(T.IOC_CD,'N'),'N','N','S','S',Q.IOC_CD)
--		              AND    NVL(T.LANE_CD,'N')  = DECODE(NVL(T.LANE_CD,'N'),'N','N','Sam','Sam',Q.LANE_CD)
			  AND    NVL(T.LANE_CD,'N') = DECODE(NVL(T.LANE_CD,'N'),'N','N','Sam','Sam',
											( SELECT DECODE((SELECT NVL('X','N')
															 FROM   TES_TML_AGMT_DTL
															 WHERE  TML_AGMT_OFC_CTY_CD = Q.CTY
															 AND    TML_AGMT_SEQ        = Q.SEQ
															 AND    TML_AGMT_VER_NO     = Q.NO
															 AND    LANE_CD = Q.LANE_CD
															 AND    ROWNUM = 1),'X',Q.LANE_CD,'OTH')
											  FROM DUAL ))
			  AND    NVL(T.TML_TRNS_MOD_CD,'N') = DECODE(NVL(T.TML_TRNS_MOD_CD,'N'),'N','N','S','S',Q.TML_TRNS_MOD_CD)
--			  AND    ( NVL(T.FM_TR_VOL_VAL,1) >= CHK_FM_QTY
--			  OR     NVL(T.TO_TR_VOL_VAL,9999999) <= CHK_TO_QTY
--			  OR     NVL(T.TO_TR_VOL_VAL,9999999) >= CHK_TO_QTY )
				-- CHM-201537921 TES Invoice Calculation로직 오류(CNTR Verify) - (2015-09-07 CAY D)
				AND	DECODE(ACCM_CHK, 'Y', DECODE(CHK_FM_QTY, 0, 1, CHK_FM_QTY) - NVL(T.FM_TR_VOL_VAL, 1), DECODE(CHK_FM_QTY, 0, 1, CHK_FM_QTY) - ACCM - NVL(T.FM_TR_VOL_VAL, 1)) >= 0
				AND	NVL(T.TO_TR_VOL_VAL, 9999999) - CHK_TO_QTY >= 0

			  AND    T.TML_AGMT_OFC_CTY_CD = C.TML_AGMT_OFC_CTY_CD(+)
			  AND    T.TML_AGMT_SEQ = C.TML_AGMT_SEQ(+)
			  AND    T.TML_AGMT_VER_NO = C.TML_AGMT_VER_NO(+)
			  AND    T.TML_AGMT_DTL_SEQ = C.TML_AGMT_DTL_SEQ(+)
			  AND    DECODE(T.TML_AGMT_VOL_UT_CD,'C',C.CNTR_TPSZ_CD,'N') 
					   = DECODE(T.TML_AGMT_VOL_UT_CD,
										'C',DECODE(Q.CNTR_STY_CD,
														'F', DECODE(SUBSTR(Q.CNTR_TPSZ_CD,1,1),
																   'R',DECODE(Q.RC_FLG,'N',DECODE(Q.CNTR_STY_CD, 'M', Q.CNTR_TPSZ_CD,'D'||SUBSTR(Q.CNTR_TPSZ_CD,2,1)),Q.CNTR_TPSZ_CD),
																   'O',DECODE(Q.AWK_CGO_FLG,'N','D'||SUBSTR(Q.CNTR_TPSZ_CD,2,1),Q.CNTR_TPSZ_CD),
																   'F',DECODE(Q.AWK_CGO_FLG,'N','D'||SUBSTR(Q.CNTR_TPSZ_CD,2,1),Q.CNTR_TPSZ_CD),
																   'P',DECODE(Q.AWK_CGO_FLG,'N','D'||SUBSTR(Q.CNTR_TPSZ_CD,2,1),Q.CNTR_TPSZ_CD),
																   'A',DECODE(Q.AWK_CGO_FLG,'N','D'||SUBSTR(Q.CNTR_TPSZ_CD,2,1),Q.CNTR_TPSZ_CD),
																   'S',DECODE(Q.AWK_CGO_FLG,'N','D'||SUBSTR(Q.CNTR_TPSZ_CD,2,1),Q.CNTR_TPSZ_CD),
																	Q.CNTR_TPSZ_CD),Q.CNTR_TPSZ_CD),'N')
--		              AND    DECODE(T.TML_AGMT_VOL_UT_CD,'C',C.CNTR_TPSZ_CD,'N') =
--						 			DECODE(T.TML_AGMT_VOL_UT_CD,
--						 						'C',DECODE(Q.RC_FLG,'N',DECODE(SUBSTR(Q.CNTR_TPSZ_CD,1,1),'R','D'||SUBSTR(Q.CNTR_TPSZ_CD,2,1),Q.CNTR_TPSZ_CD),Q.CNTR_TPSZ_CD),'N')
			  AND    Q.COST_CODE = L.LGS_COST_CD(+)
			  AND    T.TML_AGMT_OFC_CTY_CD  = A.TML_AGMT_OFC_CTY_CD(+)
		  AND    T.TML_AGMT_SEQ         = A.TML_AGMT_SEQ(+)
		  AND    T.TML_AGMT_VER_NO      = A.TML_AGMT_VER_NO(+)
		  AND    T.TML_AGMT_DTL_SEQ     = A.TML_AGMT_DTL_SEQ(+)
		  AND    ( DECODE(T.TML_DY_APLY_TP_CD,'P',Q.TML_WRK_DY_CD,'S') = DECODE(T.TML_DY_APLY_TP_CD,'P',DECODE(A.WKDY_FLG,'Y','WD'),'S')
		  OR       DECODE(T.TML_DY_APLY_TP_CD,'P',Q.TML_WRK_DY_CD,'S') = DECODE(T.TML_DY_APLY_TP_CD,'P',DECODE(A.SAT_FLG,'Y','SA'),'S')
		  OR       DECODE(T.TML_DY_APLY_TP_CD,'P',Q.TML_WRK_DY_CD,'S') = DECODE(T.TML_DY_APLY_TP_CD,'P',DECODE(A.SUN_FLG,'Y','SU'),'S')
		  OR       DECODE(T.TML_DY_APLY_TP_CD,'P',Q.TML_WRK_DY_CD,'S') = DECODE(T.TML_DY_APLY_TP_CD,'P',DECODE(A.HOL_FLG,'Y','HO'),'S') )
		  AND    T.TML_AGMT_OFC_CTY_CD = G.TML_AGMT_OFC_CTY_CD(+)
		  AND    T.TML_AGMT_SEQ        = G.TML_AGMT_SEQ(+)
		  AND    T.TML_AGMT_VER_NO     = G.TML_AGMT_VER_NO(+)
		  AND    T.TML_AGMT_DTL_SEQ    = G.TML_AGMT_DTL_SEQ(+)
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'N','N',G.DCGO_APLY_TP_CD) = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'N','N','R')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'A',DECODE(Q.DCGO_CLSS_CD,'N','N',G.DCGO_SAM_CLSS_FLG),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'A',DECODE(Q.DCGO_CLSS_CD,'N','N','Y'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'A',DECODE(Q.DCGO_CLSS_CD,'N',G.DCGO_NON_CLSS_FLG,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'N',G.DCGO_NON_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'A',DECODE(Q.DCGO_CLSS_CD,'N','Y','N'),'S',DECODE(Q.DCGO_CLSS_CD,'N','Y','N'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'1',G.DCGO_N1ST_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'1','Y','N'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'2',G.DCGO_N2ND_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'2','Y','N'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'3',G.DCGO_N3RD_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'3','Y','N'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'4',G.DCGO_N4TH_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'4','Y','N'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'5',G.DCGO_N5TH_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'5','Y','N'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'6',G.DCGO_N6TH_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'6','Y','N'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'7',G.DCGO_N7TH_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'7','Y','N'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'8',G.DCGO_N8TH_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'8','Y','N'),'N')
		  AND    DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'9',G.DCGO_N9TH_CLSS_FLG,'N'),'N')
				 = DECODE(NVL(T.DCGO_APLY_TP_CD,'N'),'S',DECODE(Q.DCGO_CLSS_CD,'9','Y','N'),'N')  )
	   WHERE DECODE(ACCM_CHK,'Y',(TO_QTY - FM_QTY),0) >= 0 )
WHERE RANK_CD = 1
ORDER BY  COST_CODE, VVD, CNTR_TPSZ_CD, TIER			]]></sql>
			<params>
				<param name="tml_so_ofc_cty_cd" type="12" value="" out="N"/>
				<param name="tml_so_seq" type="12" value="" out="N"/>
				<param name="curr_cd" type="12" value="" out="N"/>
				<param name="pay_vol_qty" type="12" value="" out="N"/>
				<param name="yd_cd" type="12" value="" out="N"/>
				<param name="vndr_seq" type="12" value="" out="N"/>
				<param name="accm_seq" type="12" value="" out="N"/>
				<param name="atb_dt" type="12" value="" out="N"/>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="io_bnd_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
