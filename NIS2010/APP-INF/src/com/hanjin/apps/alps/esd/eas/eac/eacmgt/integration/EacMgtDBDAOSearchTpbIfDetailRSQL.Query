<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="EacMgtDBDAOSearchTpbIfDetailRSQL">
			<desc><![CDATA[TPB Inquiry by EAC 내역 조회]]></desc>
			<sql><![CDATA[
SELECT U.EAC_NO -- EAC No
      ,CASE WHEN MAX(U.AUDR_OFC_CD) = 'SELADG' THEN 'SELADG'
            ELSE TRS_COMMON_PKG.TRS_GET_RHQ_OFC_CD(MAX(U.AUDR_OFC_CD))
       END AS RHQ_OFC_CD -- RHQ
      ,MAX(U.AUDR_OFC_CD) AUDR_OFC_CD -- Audit Office
      ,COMMCODE_PKG.GET_COMDTL_NAME_FNC('CD03341',MAX(U.EAC_APRO_TP_CD)) AS EAC_APRO_TP_NM
      ,TO_CHAR(MAX(U.EAC_INP_DT),'YYYY-MM-DD') EAC_INP_DT -- Entered date
      ,TO_CHAR(TO_DATE(MAX(U.EAC_YRMON)||'01','YYYY-MM-DD'),'YYYY-MM')EAC_YRMON  -- Audit month
      ,COMMCODE_PKG.GET_COMDTL_NAME_FNC('CD03352',MAX(U.EAC_EXPN_TP_CD)) AS EAC_EXPN_TP_NM -- Expense type
      ,COMMCODE_PKG.GET_COMDTL_NAME_FNC('CD00587',MAX(U.EAC_TP_CD)) AS EAC_TP_NM -- EAC Type - Main
      ,CASE WHEN MAX(U.EAC_TP_CD) = 'I' -- Internal Error
            THEN COMMCODE_PKG.GET_COMDTL_NAME_FNC('CD03340',MAX(U.EAC_BIL_TP_CD))
            WHEN MAX(U.EAC_TP_CD) = 'M' -- Misbilling
            THEN COMMCODE_PKG.GET_COMDTL_NAME_FNC('CD03339',MAX(U.EAC_BIL_TP_CD))
            WHEN MAX(U.EAC_TP_CD) = 'T' -- Missing 3rd Party Billing
            THEN MAX((SELECT N3PTY_BIL_TP_NM FROM TPB_N3RD_PTY_BIL_TP X WHERE X.N3PTY_BIL_TP_CD = U.EAC_BIL_TP_CD))
       END EAC_BIL_TP_NM -- EAC Type Sub
      ,MAX(U.RESPB_OFC_CD) RESPB_OFC_CD -- Responsible office
      ,COMMCODE_PKG.GET_COMDTL_NAME_FNC('CD00583', MAX(W.VNDR_CUST_DIV_CD)) AS VNDR_CUST_DIV_NM -- 3rd party - Type
      ,CASE WHEN MAX(W.VNDR_CUST_DIV_CD) = 'V' THEN MAX(W.VNDR_SEQ)||''
            WHEN MAX(W.VNDR_CUST_DIV_CD) = 'C' THEN MAX(W.CUST_CNT_CD||W.CUST_SEQ)
            WHEN MAX(W.VNDR_CUST_DIV_CD) = 'S' THEN MAX(W.N3PTY_OFC_CD)
       END N3PTY_SRC_CD -- 3rd party - code
      ,CASE WHEN MAX(W.VNDR_CUST_DIV_CD) = 'V' THEN MAX((SELECT X.VNDR_LGL_ENG_NM FROM MDM_VENDOR X WHERE X.VNDR_SEQ = W.VNDR_SEQ))
            WHEN MAX(W.VNDR_CUST_DIV_CD) = 'C' THEN MAX((SELECT X.CUST_LGL_ENG_NM FROM MDM_CUSTOMER X WHERE X.CUST_CNT_CD = W.CUST_CNT_CD AND X.CUST_SEQ = W.CUST_SEQ))
            WHEN MAX(W.VNDR_CUST_DIV_CD) = 'S' THEN MAX(W.N3PTY_OFC_CD)
       END N3PTY_SRC_NM -- 3rd party - name
      ,MAX(U.EAC_COST_DESC) EAC_COST_DESC -- Cost Code
      ,MAX(U.VNDR_SEQ) VNDR_SEQ -- S/P Code
      ,MAX((SELECT X.VNDR_LGL_ENG_NM FROM MDM_VENDOR X WHERE X.VNDR_SEQ = U.VNDR_SEQ)) AS VNDR_NM -- Service Provider Name
      ,MAX(U.N3PTY_SRC_NO) N3PTY_SRC_NO -- Invoice no
      ,MAX(U.INV_AUD_USD_AMT) INV_AUD_USD_AMT -- Audit Amount(US$)
      ,MAX(W.N3PTY_NO) N3PTY_NO -- TPB No
      ,MAX(X.OFC_CD) TPB_OFC_CD -- TPB office
      ,CASE WHEN MAX(V.EQ_KND_CD) = 'V' THEN 'VVD'
            ELSE COMMCODE_PKG.GET_COMDTL_NAME_FNC('CD01132', MAX(V.EQ_KND_CD))
       END EQ_KND_NM
      ,MAX(V.EQ_NO) EQ_NO -- EQ No
      ,MAX(V.BKG_NO) BKG_NO -- BKG No
      ,MAX(V.BL_NO) BL_NO -- B/L No
      ,MAX(V.VVD_CD) VVD_CD -- VVD
      ,MAX(V.CFM_CURR_CD) CFM_CURR_CD -- TPB I/F Amount - Cur
      ,MAX(V.CFM_AMT) CFM_AMT -- TPB I/F Amount - Amount
      ,MAX(Y.STL_TO_CLT_CNG_OFC_CD) TPB_ROC_OFC_CD -- ROC Office
      ,MAX(CASE WHEN Z.OTS_STS_CD IN ('R','T','J') THEN COMMCODE_PKG.GET_COMDTL_NAME_FNC('CD02799',X.OTS_STS_DTL_CD)
                ELSE COMMCODE_PKG.GET_COMDTL_NAME_FNC('CD00588',Z.OTS_STS_CD)
           END) AS OTS_STS_NM -- TPB status
      ,MAX(U.CURR_CD) CURR_CD -- Invoice Amount - Cur
      ,MAX(U.INV_AUD_AMT) INV_AUD_AMT -- Invoice Amount - Amount
  FROM TPB_OTS_GRP X
      ,TPB_ADJ_STS Y
      ,TPB_OTS_GRP_STS Z
      ,TPB_OTS_DTL V
      ,EAS_EXPN_AUD_CS_N3RD_PTY W
      ,EAS_EXPN_AUD_CS_MGMT U
 WHERE X.N3PTY_NO = Y.N3PTY_NO(+)
   AND Y.STL_STS_LST_FLG(+) = 'Y' 
   AND Y.N3PTY_STL_TP_CD(+) = 'O'
   AND X.N3PTY_NO = Z.N3PTY_NO
   AND Z.OTS_STS_LST_FLG = 'Y'   
   AND X.N3PTY_NO = V.N3PTY_NO
   AND X.N3PTY_NO = W.N3PTY_NO
   AND W.EAC_NO = U.EAC_NO

#if (${s_rhq_ofc_cd} != '')
   AND CASE WHEN U.AUDR_OFC_CD = 'SELADG' THEN 'SELADG'
            ELSE TRS_COMMON_PKG.TRS_GET_RHQ_OFC_CD(U.AUDR_OFC_CD)
       END = @[s_rhq_ofc_cd] -- RHQ
#end
#if(${s_audr_ofc_cd} != '')
   AND U.AUDR_OFC_CD = @[s_audr_ofc_cd] -- Audit Office
#end
   AND U.EAC_YRMON BETWEEN REPLACE(@[s_eac_yrmon_fr],'-','') AND REPLACE(@[s_eac_yrmon_to],'-','') -- Audit month

#if(${s_ots_sts_cd} != '')
   #if(${s_ots_sts_dtl_cd} == '') -- TPB Status - main
      #if(${s_ots_sts_cd} == 'T')
         AND X.OTS_STS_CD IN ('O', 'I', 'Y', 'R', 'J')
      #elseif(${s_ots_sts_cd} == 'P')
         AND X.OTS_STS_CD IN ('E', 'L', 'D', 'S')
      #end
   #else
      AND X.OTS_STS_CD = @[s_ots_sts_dtl_cd] -- TPB Status - sub
   #end
#end 

#if(${s_eac_expn_tp_cd} != '')
   AND U.EAC_EXPN_TP_CD = @[s_eac_expn_tp_cd] -- Expense Type
#end      
#if(${s_eac_tp_cd} != '')
   AND U.EAC_TP_CD = @[s_eac_tp_cd] -- EAC Type
#end   
#if(${s_vndr_cust_div_cd} != '')
   AND W.VNDR_CUST_DIV_CD = @[s_vndr_cust_div_cd] -- 3rd Party 구분
#end
#if(${s_n3tpy_src_cd} != '')
   AND CASE WHEN W.VNDR_CUST_DIV_CD = 'V' THEN W.VNDR_SEQ||''
            WHEN W.VNDR_CUST_DIV_CD = 'C' THEN W.CUST_CNT_CD||W.CUST_SEQ
            WHEN W.VNDR_CUST_DIV_CD = 'S' THEN W.N3PTY_OFC_CD
       END = @[s_n3tpy_src_cd] -- 3rd Party 코드
#end
 GROUP BY X.N3PTY_NO, U.EAC_NO, V.EQ_NO			]]></sql>
			<params>
				<param name="s_rhq_ofc_cd" type="12" value="" out="N"/>
				<param name="s_audr_ofc_cd" type="12" value="" out="N"/>
				<param name="s_eac_yrmon_fr" type="12" value="" out="N"/>
				<param name="s_eac_yrmon_to" type="12" value="" out="N"/>
				<param name="s_ots_sts_dtl_cd" type="12" value="" out="N"/>
				<param name="s_eac_expn_tp_cd" type="12" value="" out="N"/>
				<param name="s_eac_tp_cd" type="12" value="" out="N"/>
				<param name="s_vndr_cust_div_cd" type="12" value="" out="N"/>
				<param name="s_n3tpy_src_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
