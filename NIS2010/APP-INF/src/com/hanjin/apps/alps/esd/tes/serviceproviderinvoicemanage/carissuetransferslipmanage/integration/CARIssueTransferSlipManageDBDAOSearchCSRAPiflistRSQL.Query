<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CARIssueTransferSlipManageDBDAOSearchCSRAPiflistRSQL">
			<desc><![CDATA[SearchCSRAPiflist]]></desc>
			<sql><![CDATA[
SELECT B.IF_DT, B.CSR_NO, (SELECT DECODE(VNDR_CNT_CD,'KR',VNDR_LOCL_LANG_NM,VNDR_LGL_ENG_NM) FROM MDM_VENDOR WHERE VNDR_SEQ = B.VNDR_NO) INV_DESC,
		B.CSR_CURR_CD, B.CSR_AMT, TO_CHAR(B.DUE_DT,'YYYY-MM-DD') DUE_DT, B.IF_STATUS,
		B.ATTR_CTNT2, B.IF_ERR_RSN, B.VNDR_NO, B.VNDR_TERM_NM, B.AFT_ACT_FLG,
		TO_CHAR(MAX(B.ISS_DT),'YYYY-MM-DD') ISS_DT, TO_CHAR(MAX(B.RCV_DT),'YYYY-MM-DD') RCV_DT, COUNT(B.CSR_NO) NO_OF_INV,
		B.IF_FLG, B.RCV_ERR_FLG, B.APRO_RQST_NO, B.PAY_GRP_LU_CD, B.COST_OFC_CD,
		B.ACCT_XCH_RT_YRMON, B.CSR_USD_AMT, NVL(B.CSR_APRO_TP_CD,'AL') CSR_APRO_TP_CD, B.CRE_USR_ID,
		( CASE WHEN B.GW_AGMT_DOC_CFM_CD IS NOT NULL
           		THEN ( CASE WHEN B.GW_AGMT_DOC_CFM_CD = 'P' THEN 'Y'
                       WHEN B.GW_AGMT_DOC_CFM_CD = 'Y' THEN 'Y'
                       ELSE 'N'
                  END )
         	ELSE NVL(B.AGMT_DOC_CFM_CD,'N')
    		END ) AGMT_DOC_CFM_CD, 
		NVL(B.AGMT_FILE_CFM_CD,'N') AGMT_FILE_CFM_CD,   
        (CASE WHEN
        	NVL(( SELECT COUNT(F.ATCH_FILE_ID)
        		FROM COM_AP_FILE_UPLD F
        		WHERE 1=1
        		AND F.AP_FILE_DIV_CD = 'C'
        		AND F.CSR_NO = B.CSR_NO 
        		AND F.CSR_FILE_UPLD_TP_CD = 'FU'
				AND NVL(F.DELT_FLG,'N') <> 'Y'
        	),0) > 0 THEN 'Y'    
    	  ELSE 'N'
          END ) FILE_UPLD_FLG,
		--[CHM-201539621]Split01-결재시스템 선택 가능토록 화면 수정 (2016.01.22  CSR 결재 유형 변경 오피스 확인 컬럼 추가) 	
		(SELECT AP_COM_CHK_ALPS2GW_FNC(B.CSR_NO, @[ofc_cd]) FROM DUAL) AS CN_OFC_CHK 
 FROM (
	 SELECT
		 TO_CHAR(A.IF_DT,'YYYY-MM-DD') IF_DT,
		 A.CSR_NO, H.COST_OFC_CD,
		 A.CSR_CURR_CD,
		 A.CSR_AMT,
		 CASE
		 WHEN A.VNDR_TERM_NM IS NOT NULL AND SUBSTR(A.VNDR_TERM_NM,0,1)='O' THEN TO_DATE(A.INV_TERM_DT,'YYYY-MM-DD')+0
		 ELSE TO_DATE(A.INV_TERM_DT,'YYYY-MM-DD')+TO_NUMBER(A.VNDR_TERM_NM)
		 END  DUE_DT,
		 CASE
		 WHEN A.AFT_ACT_FLG = 'X' OR A.AFT_ACT_FLG = 'N' THEN 'Canceled'
		 WHEN A.RCV_ERR_FLG = 'E' THEN 'A/P Rejected'
		 WHEN A.IF_FLG = 'E' THEN 'I/F Error'
		 WHEN A.IF_FLG = 'Y' AND A.RCV_ERR_FLG IS NULL THEN 'I/F Success'
		 WHEN H.TML_INV_RJCT_STS_CD IN ('RJ') AND A.AFT_ACT_FLG IS NULL THEN 'Disapproved'
         WHEN A.IF_FLG IS NULL AND A.APRO_FLG = 'N' AND A.RQST_APRO_STEP_FLG = 'Y' THEN 'Requesting Approval'
		 WHEN A.IF_FLG IS NULL THEN DECODE(A.APRO_FLG,'Y','Sending','Approval Requested')
		 ELSE 'ALL'
		 END IF_STATUS,
		 A.ATTR_CTNT2,
		 A.IF_ERR_RSN,
		 A.VNDR_NO,
		 A.VNDR_TERM_NM,
		 A.AFT_ACT_FLG,
		 H.ISS_DT, C.APRO_RQST_NO,
		 H.RCV_DT, A.IF_FLG, A.RCV_ERR_FLG, H.TML_INV_STS_CD, H.TML_INV_RJCT_STS_CD, A.PAY_GRP_LU_CD,
		 A.ACCT_XCH_RT_YRMON, A.CSR_USD_AMT, A.CSR_APRO_TP_CD, A.CRE_USR_ID, 
		 A.AGMT_DOC_CFM_CD, A.GW_AGMT_DOC_CFM_CD, A.AGMT_FILE_CFM_CD
	 FROM TES_TML_SO_HDR H, COM_APRO_CSR_DTL C, COM_APRO_RQST_HDR R, AP_INV_HDR A
	 WHERE 1=1
	 AND H.CSR_NO = C.CSR_NO
	 AND C.APRO_RQST_NO = R.APRO_RQST_NO
	 AND H.CSR_NO = A.CSR_NO
	 AND H.INV_OFC_CD = @[ofc_cd]
	 AND NVL(H.DELT_FLG,'N') <> 'Y'
	 AND A.SRC_CTNT = 'SO_TERMINAL'
     AND NVL(A.CSR_APRO_TP_CD,'AL') = 'AL'
     AND NVL(A.RQST_APRO_STEP_FLG,'N') <> 'Y'
#if (${search_csr_no} == '') 
	#if (${dt_status} != '' and ${dt_status}=='AR')  --Approval Requested
			 AND ( R.RQST_ST_DT BETWEEN TO_DATE(@[fm_eff_dt],'YYYY-MM-DD') AND TO_DATE(@[to_eff_dt],'YYYY-MM-DD') + 0.99999421 )
	#elseif(${dt_status} != '' and ${dt_status}=='RA')  --Requesting Approval
			 AND ( A.CSR_APRO_STEP_ASGN_RQST_DT BETWEEN TO_DATE(@[fm_eff_dt],'YYYY-MM-DD') AND TO_DATE(@[to_eff_dt],'YYYY-MM-DD') + 0.99999421 )
	#elseif (${dt_status} != '' and ${dt_status}=='AV') --Approved or Disapproved
			 AND (( R.APSTS_CD IN ('C','R') AND R.RQST_END_DT BETWEEN TO_DATE(@[fm_eff_dt],'YYYY-MM-DD') AND TO_DATE(@[to_eff_dt],'YYYY-MM-DD') + 0.99999421 )
			  OR  ( H.TML_INV_RJCT_STS_CD = 'RJ' AND H.INV_RJCT_DT BETWEEN TO_DATE(@[fm_eff_dt],'YYYY-MM-DD') AND TO_DATE(@[to_eff_dt],'YYYY-MM-DD') + 0.99999421 ))
	#elseif(${dt_status} != '' and ${dt_status}=='IU') --I/F Status Updated
			 AND ( A.IF_DT BETWEEN TO_DATE(@[fm_eff_dt],'YYYY-MM-DD') AND TO_DATE(@[to_eff_dt],'YYYY-MM-DD') + 0.99999421 )
	#else
	#end
#else 
#end
#if (${if_status} != '' and ${if_status}=='RA') 
		 --AND A.IF_FLG IS NULL AND A.APRO_FLG = 'N' AND A.RQST_APRO_STEP_FLG = 'Y'
		 AND 1=2
#elseif (${if_status} != '' and ${if_status}=='AR') --Approval Requested
		 AND A.IF_FLG IS NULL AND A.APRO_FLG = 'N' AND A.RQST_APRO_STEP_FLG IS NULL AND R.APSTS_CD = 'P' 
#elseif (${if_status} != '' and ${if_status}=='SD') 
		 AND A.IF_FLG IS NULL AND A.APRO_FLG = 'Y'
#elseif (${if_status} != '' and ${if_status}=='SC') 
		 AND A.IF_FLG = 'Y' AND A.RCV_ERR_FLG IS NULL
#elseif (${if_status} != '' and ${if_status}=='IE') 
		 AND A.IF_FLG = 'E'
#elseif (${if_status} != '' and ${if_status}=='RJ') 
		 AND A.RCV_ERR_FLG = 'E'
#elseif (${if_status} != '' and ${if_status}=='DA') 
		 AND H.TML_INV_RJCT_STS_CD = 'RJ' AND A.AFT_ACT_FLG IS NULL
#else 
#end
#if (${search_csr_no} != '') 
		 AND A.CSR_NO LIKE '%'||@[search_csr_no]||'%'
#else 
#end
     UNION ALL
	 SELECT
		 TO_CHAR(A.IF_DT,'YYYY-MM-DD') IF_DT,
		 A.CSR_NO, H.COST_OFC_CD,
		 A.CSR_CURR_CD,
		 A.CSR_AMT,
		 CASE
		 WHEN A.VNDR_TERM_NM IS NOT NULL AND SUBSTR(A.VNDR_TERM_NM,0,1)='O' THEN TO_DATE(A.INV_TERM_DT,'YYYY-MM-DD')+0
		 ELSE TO_DATE(A.INV_TERM_DT,'YYYY-MM-DD')+TO_NUMBER(A.VNDR_TERM_NM)
		 END  DUE_DT,
		 CASE
         WHEN A.AFT_ACT_FLG = 'X' OR A.AFT_ACT_FLG = 'N' THEN 'Canceled'
		 WHEN A.RCV_ERR_FLG = 'E' THEN 'A/P Rejected'
		 WHEN A.IF_FLG = 'E' THEN 'I/F Error'
		 WHEN A.IF_FLG = 'Y' AND A.RCV_ERR_FLG IS NULL THEN 'I/F Success'
		 WHEN H.TML_INV_RJCT_STS_CD IN ('RJ') AND A.AFT_ACT_FLG IS NULL THEN 'Disapproved'
         WHEN A.IF_FLG IS NULL AND A.APRO_FLG = 'N' AND A.RQST_APRO_STEP_FLG = 'Y' THEN 'Requesting Approval'
		 WHEN A.IF_FLG IS NULL THEN DECODE(A.APRO_FLG,'Y','Sending','Approval Requested')
		 ELSE 'ALL'
		 END IF_STATUS,
		 A.ATTR_CTNT2,
		 A.IF_ERR_RSN,
		 A.VNDR_NO,
		 A.VNDR_TERM_NM,
		 A.AFT_ACT_FLG,
		 H.ISS_DT, '' APRO_RQST_NO,
		 H.RCV_DT, A.IF_FLG, A.RCV_ERR_FLG, H.TML_INV_STS_CD, H.TML_INV_RJCT_STS_CD, A.PAY_GRP_LU_CD,
		 A.ACCT_XCH_RT_YRMON, A.CSR_USD_AMT, A.CSR_APRO_TP_CD, A.CRE_USR_ID,
		 A.AGMT_DOC_CFM_CD, A.GW_AGMT_DOC_CFM_CD, A.AGMT_FILE_CFM_CD
	 FROM TES_TML_SO_HDR H, AP_INV_HDR A
	 WHERE 1=1
	 AND H.CSR_NO = A.CSR_NO
	 AND H.INV_OFC_CD = @[ofc_cd]
	 AND NVL(H.DELT_FLG,'N') <> 'Y'
	 AND A.SRC_CTNT = 'SO_TERMINAL'
     AND NVL(A.CSR_APRO_TP_CD,'AL') = 'GW'
     AND NVL(A.RQST_APRO_STEP_FLG,'N') <> 'Y'
#if (${search_csr_no} == '') 
	#if (${dt_status} != '' and ${dt_status}=='AR')  --Approval Requested
			 AND ( A.CSR_APRO_STEP_ASGN_DT BETWEEN TO_DATE(@[fm_eff_dt],'YYYY-MM-DD') AND TO_DATE(@[to_eff_dt],'YYYY-MM-DD') + 0.99999421 )
	#elseif(${dt_status} != '' and ${dt_status}=='RA')  --Requesting Approval
			 AND ( A.CSR_APRO_STEP_ASGN_RQST_DT BETWEEN TO_DATE(@[fm_eff_dt],'YYYY-MM-DD') AND TO_DATE(@[to_eff_dt],'YYYY-MM-DD') + 0.99999421 )
	#elseif (${dt_status} != '' and ${dt_status}=='AV') --Approved or Disapproved
			 AND ( A.CSR_APRO_TP_CD IS NOT NULL AND 
                   ((( A.CSR_APRO_CMPL_DT BETWEEN TO_DATE(@[fm_eff_dt],'YYYY-MM-DD') AND TO_DATE(@[to_eff_dt],'YYYY-MM-DD') + 0.99999421 )
					OR ( A.CSR_RJCT_DT BETWEEN TO_DATE(@[fm_eff_dt],'YYYY-MM-DD') AND TO_DATE(@[to_eff_dt],'YYYY-MM-DD') + 0.99999421 ))
                    OR  
                    ( H.TML_INV_RJCT_STS_CD = 'RJ' AND 
                      H.INV_RJCT_DT BETWEEN TO_DATE(@[fm_eff_dt],'YYYY-MM-DD') AND TO_DATE(@[to_eff_dt],'YYYY-MM-DD') + 0.99999421 )) )
	#elseif(${dt_status} != '' and ${dt_status}=='IU') --I/F Status Updated
			 AND ( A.IF_DT BETWEEN TO_DATE(@[fm_eff_dt],'YYYY-MM-DD') AND TO_DATE(@[to_eff_dt],'YYYY-MM-DD') + 0.99999421 )
	#else
	#end
#else 
#end
#if (${if_status} != '' and ${if_status}=='RA') 
		 AND 1=2
#elseif (${if_status} != '' and ${if_status}=='AR') 
		 AND A.IF_FLG IS NULL AND A.APRO_FLG = 'N' AND A.RQST_APRO_STEP_FLG IS NULL AND CSR_RJCT_DT IS NULL
#elseif (${if_status} != '' and ${if_status}=='SD') 
		 AND A.IF_FLG IS NULL AND A.APRO_FLG = 'Y'
#elseif (${if_status} != '' and ${if_status}=='SC') 
		 AND A.IF_FLG = 'Y' AND A.RCV_ERR_FLG IS NULL
#elseif (${if_status} != '' and ${if_status}=='IE') 
		 AND A.IF_FLG = 'E'
#elseif (${if_status} != '' and ${if_status}=='RJ') 
		 AND A.RCV_ERR_FLG = 'E'
#elseif (${if_status} != '' and ${if_status}=='DA') 
		 AND H.TML_INV_RJCT_STS_CD = 'RJ' AND A.AFT_ACT_FLG IS NULL
#else 
#end
#if (${search_csr_no} != '') 
		 AND A.CSR_NO LIKE '%'||@[search_csr_no]||'%'
#else 
#end
     UNION ALL
	 SELECT
		 TO_CHAR(A.IF_DT,'YYYY-MM-DD') IF_DT,
		 A.CSR_NO, H.COST_OFC_CD,
		 A.CSR_CURR_CD,
		 A.CSR_AMT,
		 CASE
		 WHEN A.VNDR_TERM_NM IS NOT NULL AND SUBSTR(A.VNDR_TERM_NM,0,1)='O' THEN TO_DATE(A.INV_TERM_DT,'YYYY-MM-DD')+0
		 ELSE TO_DATE(A.INV_TERM_DT,'YYYY-MM-DD')+TO_NUMBER(A.VNDR_TERM_NM)
		 END  DUE_DT,
		 CASE
         WHEN A.AFT_ACT_FLG = 'X' OR A.AFT_ACT_FLG = 'N' THEN 'Canceled'
		 WHEN A.RCV_ERR_FLG = 'E' THEN 'A/P Rejected'
		 WHEN A.IF_FLG = 'E' THEN 'I/F Error'
		 WHEN A.IF_FLG = 'Y' AND A.RCV_ERR_FLG IS NULL THEN 'I/F Success'
		 WHEN H.TML_INV_RJCT_STS_CD IN ('RJ') AND A.AFT_ACT_FLG IS NULL THEN 'Disapproved'
         WHEN A.IF_FLG IS NULL AND A.APRO_FLG = 'N' AND A.RQST_APRO_STEP_FLG = 'Y' THEN 'Requesting Approval'
		 WHEN A.IF_FLG IS NULL THEN DECODE(A.APRO_FLG,'Y','Sending','Approval Requested')
		 ELSE 'ALL'
		 END IF_STATUS,
		 A.ATTR_CTNT2,
		 A.IF_ERR_RSN,
		 A.VNDR_NO,
		 A.VNDR_TERM_NM,
		 A.AFT_ACT_FLG,
		 H.ISS_DT, '' APRO_RQST_NO,
		 H.RCV_DT, A.IF_FLG, A.RCV_ERR_FLG, H.TML_INV_STS_CD, H.TML_INV_RJCT_STS_CD, A.PAY_GRP_LU_CD,
		 A.ACCT_XCH_RT_YRMON, A.CSR_USD_AMT, A.CSR_APRO_TP_CD, A.CRE_USR_ID,
		 A.AGMT_DOC_CFM_CD, A.GW_AGMT_DOC_CFM_CD, A.AGMT_FILE_CFM_CD
	 FROM TES_TML_SO_HDR H, AP_INV_HDR A
	 WHERE 1=1
	 AND H.CSR_NO = A.CSR_NO
	 AND H.INV_OFC_CD = @[ofc_cd]
	 AND NVL(H.DELT_FLG,'N') <> 'Y'
	 AND A.SRC_CTNT = 'SO_TERMINAL'    
	 AND NVL(A.RQST_APRO_STEP_FLG,'N') = 'Y' 
#if (${search_csr_no} == '') 
	#if(${dt_status} != '' and ${dt_status}=='RA')  --Requesting Approval
			 AND ( A.CSR_APRO_STEP_ASGN_DT IS NULL AND 
                  (A.CSR_APRO_STEP_ASGN_RQST_DT BETWEEN TO_DATE(@[fm_eff_dt],'YYYY-MM-DD') AND TO_DATE(@[to_eff_dt],'YYYY-MM-DD') + 0.99999421 ))
	#else
			 AND 1=2
	#end
#else 
#end
#if (${if_status} != '' and ${if_status}=='RA') 
		 AND A.IF_FLG IS NULL AND A.APRO_FLG = 'N' 
#elseif (${if_status} == 'AL')
		 AND 1=1
#else 
		 AND 1=2
#end
#if (${search_csr_no} != '') 
		 AND A.CSR_NO LIKE '%'||@[search_csr_no]||'%'
#else  
#end
 ) B
WHERE 1=1
#if (${search_tp_cd} == 'AL') 
	AND NVL(B.CSR_APRO_TP_CD,'AL') = 'AL' 
#elseif (${search_tp_cd} == 'GW') 
	AND NVL(B.CSR_APRO_TP_CD,'AL') = 'GW' 
#end
 GROUP BY B.IF_DT, B.CSR_NO, B.CSR_CURR_CD, B.CSR_AMT,
		B.DUE_DT, B.IF_STATUS, B.ATTR_CTNT2, B.IF_ERR_RSN, B.VNDR_NO,
		B.VNDR_TERM_NM, B.AFT_ACT_FLG, B.IF_FLG, B.RCV_ERR_FLG, B.APRO_RQST_NO, B.PAY_GRP_LU_CD, B.COST_OFC_CD,
		B.ACCT_XCH_RT_YRMON, B.CSR_USD_AMT, B.CSR_APRO_TP_CD, B.CRE_USR_ID,
 		B.AGMT_DOC_CFM_CD, B.GW_AGMT_DOC_CFM_CD, B.AGMT_FILE_CFM_CD
 ORDER BY B.CSR_NO ASC			]]></sql>
			<params>
				<param name="ofc_cd" type="12" value="" out="N"/>
				<param name="fm_eff_dt" type="12" value="" out="N"/>
				<param name="to_eff_dt" type="12" value="" out="N"/>
				<param name="search_csr_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
