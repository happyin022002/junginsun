<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TESeBillingManageBizType004DBDAOConvertEDIInvoice2TmlVVDListCSQL">
			<desc><![CDATA[EDI data에서 VVD를 추출하여 정규 Invoice로 옮기기]]></desc>
			<sql><![CDATA[

INSERT INTO TES_TML_SO_VVD_LIST(
	TML_SO_OFC_CTY_CD
	, TML_SO_SEQ
	, TML_SO_VVD_LIST_SEQ
	, VSL_CD
	, SKD_VOY_NO
	, SKD_DIR_CD
	, IO_BND_CD
	, ATB_DT
	, CRE_USR_ID
	, CRE_DT
	, UPD_USR_ID
	, UPD_DT
	, LOCL_CRE_DT
	, LOCL_UPD_DT
	)
	SELECT  @[tml_edi_so_ofc_cty_cd]
			, @[tml_so_seq]
			, ROWNUM
			, VSL_CD
			, SKD_VOY_NO
			, SKD_DIR_CD
			, IO_BND_CD
			, ATB_DT
			, @[cre_usr_id]
			, SYSDATE
			, @[cre_usr_id]
			, SYSDATE
			, GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC(@[locl_cre_dt])
			, GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC(@[locl_cre_dt])
	FROM	(
			SELECT  SUBSTR(A.VVD_CD,1,4) VSL_CD
			        , SUBSTR(A.VVD_CD,5,4) SKD_VOY_NO
			        , SUBSTR(A.VVD_CD,9) SKD_DIR_CD
			        , DECODE(A.IO_IND_CD,'B','I',A.IO_IND_CD) IO_BND_CD
			        , V.VPS_ETB_DT ATB_DT
			        , A.VNDR_SEQ
			FROM    VSK_VSL_PORT_SKD V
					, (SELECT H.TML_INV_TP_CD
							, H.YD_CD
							, H.IO_IND_CD
							, H.IB_VVD_CD VVD_CD
							, H.VNDR_SEQ
						FROM	TES_EDI_SO_HDR H
						WHERE	1	= 1
						AND H.TML_EDI_SO_OFC_CTY_CD = @[tml_edi_so_ofc_cty_cd]
						AND H.TML_EDI_SO_SEQ = @[tml_edi_so_seq]
						AND H.TML_INV_TP_CD LIKE 'M%'
						AND NVL(H.DELT_FLG,'N') <> 'Y'
						AND H.VNDR_SEQ IN ('158002','114776')
						AND H.IB_VVD_CD IS NOT NULL
					    AND LENGTH(H.IB_VVD_CD)=9
						UNION ALL
						SELECT H.TML_INV_TP_CD
							, H.YD_CD
							, H.IO_IND_CD
							, H.OB_VVD_CD VVD_CD
							, H.VNDR_SEQ
						FROM TES_EDI_SO_HDR H
						WHERE 1=1
						AND H.TML_EDI_SO_OFC_CTY_CD = @[tml_edi_so_ofc_cty_cd]
						AND H.TML_EDI_SO_SEQ = @[tml_edi_so_seq]
						AND H.TML_INV_TP_CD LIKE 'M%'
						AND H.VNDR_SEQ IN ('158002','114776')
						AND NVL(H.DELT_FLG,'N') <> 'Y'
						AND H.OB_VVD_CD IS NOT NULL
					    AND LENGTH(H.OB_VVD_CD)=9
						AND H.IB_VVD_CD <> H.OB_VVD_CD)  A
			WHERE 1=1
			AND V.VPS_PORT_CD = SUBSTR(A.YD_CD,1,5)
			AND V.VSL_CD <> 'CNTC'
			AND SUBSTR(A.VVD_CD,1,4) <> 'CNTC'
			AND V.VSL_CD = SUBSTR(A.VVD_CD,1,4)
			AND V.SKD_VOY_NO = SUBSTR(A.VVD_CD,5,4)
			AND V.SKD_DIR_CD = SUBSTR(A.VVD_CD,9)
			UNION ALL
			SELECT  SUBSTR(A.VVD_CD,1,4) VSL_CD,
					SUBSTR(A.VVD_CD,5,4) SKD_VOY_NO,
					SUBSTR(A.VVD_CD,9) SKD_DIR_CD,
					DECODE(A.IO_IND_CD,'B','I',A.IO_IND_CD) IO_BND_CD,
					LAST_DAY(TO_DATE(SUBSTR(A.VVD_CD,5,4),'YYMM')) ATB_DT,
					A.VNDR_SEQ
			FROM   (SELECT H.TML_INV_TP_CD
					, H.YD_CD
					, H.IO_IND_CD
					, H.IB_VVD_CD VVD_CD
					, H.VNDR_SEQ
			        FROM TES_EDI_SO_HDR H
			        WHERE 1=1
			        AND H.TML_EDI_SO_OFC_CTY_CD = @[tml_edi_so_ofc_cty_cd]
			        AND H.TML_EDI_SO_SEQ = @[tml_edi_so_seq]
			        AND H.TML_INV_TP_CD LIKE 'M%'
			        AND H.VNDR_SEQ IN ('158002','114776')
			        AND NVL(H.DELT_FLG,'N') <> 'Y'
			        AND H.IB_VVD_CD IS NOT NULL
					AND LENGTH(H.IB_VVD_CD)=9
			        AND SUBSTR(H.IB_VVD_CD,1,4) = 'CNTC'
			        UNION ALL
			        SELECT H.TML_INV_TP_CD
					, H.YD_CD
					, H.IO_IND_CD
					, H.OB_VVD_CD VVD_CD
					, H.VNDR_SEQ
			        FROM TES_EDI_SO_HDR H
			        WHERE 1=1
			        AND H.TML_EDI_SO_OFC_CTY_CD = @[tml_edi_so_ofc_cty_cd]
			        AND H.TML_EDI_SO_SEQ = @[tml_edi_so_seq]
			        AND H.TML_INV_TP_CD LIKE 'M%'
			        AND H.VNDR_SEQ IN ('158002','114776')
			        AND NVL(H.DELT_FLG,'N') <> 'Y'
			        AND H.OB_VVD_CD IS NOT NULL
					AND LENGTH(H.OB_VVD_CD)=9
			        AND H.IB_VVD_CD <> H.OB_VVD_CD
			        AND SUBSTR(H.OB_VVD_CD,1,4) = 'CNTC') A
			WHERE SUBSTR(A.TML_INV_TP_CD,1,1) = 'M'
			UNION ALL
			SELECT  SUBSTR(A.VVD_CD,1,4) VSL_CD,
			        SUBSTR(A.VVD_CD,5,4) SKD_VOY_NO,
			        SUBSTR(A.VVD_CD,9) SKD_DIR_CD,
			        DECODE(A.IO_IND_CD,'B','O',A.IO_IND_CD) IO_BND_CD,
			        V.VPS_ETB_DT ATB_DT,
			        A.VNDR_SEQ
			FROM    VSK_VSL_PORT_SKD V,
			       (SELECT H.TML_INV_TP_CD
					, H.YD_CD
					, H.IO_IND_CD
					, H.IB_VVD_CD VVD_CD
					, H.VNDR_SEQ
			        FROM TES_EDI_SO_HDR H
			        WHERE 1=1
			        AND H.TML_EDI_SO_OFC_CTY_CD = @[tml_edi_so_ofc_cty_cd]
			        AND H.TML_EDI_SO_SEQ = @[tml_edi_so_seq]
			        AND H.TML_INV_TP_CD LIKE 'M%'
			        AND H.VNDR_SEQ IN ('158002','114776')
			        AND NVL(H.DELT_FLG,'N') <> 'Y'
			        AND H.IB_VVD_CD IS NOT NULL
					AND LENGTH(H.IB_VVD_CD)=9
			        UNION ALL
			        SELECT H.TML_INV_TP_CD
					, H.YD_CD
					, H.IO_IND_CD
					, H.OB_VVD_CD VVD_CD
					, H.VNDR_SEQ
			        FROM TES_EDI_SO_HDR H
			        WHERE 1=1
			        AND H.TML_EDI_SO_OFC_CTY_CD = @[tml_edi_so_ofc_cty_cd]
			        AND H.TML_EDI_SO_SEQ = @[tml_edi_so_seq]
			        AND H.TML_INV_TP_CD LIKE 'M%'
			        AND H.VNDR_SEQ IN ('158002','114776')
			        AND NVL(H.DELT_FLG,'N') <> 'Y'
			        AND H.OB_VVD_CD IS NOT NULL
					AND LENGTH(H.OB_VVD_CD)=9
			        AND H.IB_VVD_CD <> H.OB_VVD_CD)  A
			WHERE 1=1
			AND V.VPS_PORT_CD = SUBSTR(A.YD_CD,1,5)
			AND V.VSL_CD <> 'CNTC'
			AND SUBSTR(A.VVD_CD,1,4) <> 'CNTC'
			AND V.VSL_CD = SUBSTR(A.VVD_CD,1,4)
			AND V.SKD_VOY_NO = SUBSTR(A.VVD_CD,5,4)
			AND V.SKD_DIR_CD = SUBSTR(A.VVD_CD,9)
			AND A.IO_IND_CD IS NOT NULL AND A.IO_IND_CD = 'B'
			UNION ALL
			SELECT  SUBSTR(A.VVD_CD,1,4) VSL_CD,
			        SUBSTR(A.VVD_CD,5,4) SKD_VOY_NO,
			        SUBSTR(A.VVD_CD,9) SKD_DIR_CD,
			        DECODE(A.IO_IND_CD,'B','O',A.IO_IND_CD) IO_BND_CD,
			        LAST_DAY(TO_DATE(SUBSTR(A.VVD_CD,5,4),'YYMM')) ATB_DT,
			        A.VNDR_SEQ
			FROM   (SELECT H.TML_INV_TP_CD
					, H.YD_CD
					, H.IO_IND_CD
					, H.IB_VVD_CD VVD_CD
					, H.VNDR_SEQ
			        FROM TES_EDI_SO_HDR H
			        WHERE 1=1
			        AND H.TML_EDI_SO_OFC_CTY_CD = @[tml_edi_so_ofc_cty_cd]
			        AND H.TML_EDI_SO_SEQ = @[tml_edi_so_seq]
			        AND H.TML_INV_TP_CD LIKE 'M%'
			        AND H.VNDR_SEQ IN ('158002','114776')
			        AND NVL(H.DELT_FLG,'N') <> 'Y'
			        AND H.IB_VVD_CD IS NOT NULL
					AND LENGTH(H.IB_VVD_CD)=9
			        AND SUBSTR(H.IB_VVD_CD,1,4) = 'CNTC'
			        UNION ALL
			        SELECT H.TML_INV_TP_CD
					, H.YD_CD
					, H.IO_IND_CD
					, H.OB_VVD_CD VVD_CD
					, H.VNDR_SEQ
			        FROM TES_EDI_SO_HDR H
			        WHERE 1=1
			        AND H.TML_EDI_SO_OFC_CTY_CD = @[tml_edi_so_ofc_cty_cd]
			        AND H.TML_EDI_SO_SEQ = @[tml_edi_so_seq]
			        AND H.TML_INV_TP_CD LIKE 'M%'
			        AND H.VNDR_SEQ IN ('158002','114776')
			        AND NVL(H.DELT_FLG,'N') <> 'Y'
			        AND H.OB_VVD_CD IS NOT NULL
					AND LENGTH(H.OB_VVD_CD)=9
			        AND H.IB_VVD_CD <> H.OB_VVD_CD
			        AND SUBSTR(H.OB_VVD_CD,1,4) = 'CNTC') A
			WHERE SUBSTR(A.TML_INV_TP_CD,1,1) = 'M'
			AND A.IO_IND_CD IS NOT NULL AND A.IO_IND_CD = 'B'
			UNION ALL
     SELECT  A.VSL_CD VSL_CD,
             A.SKD_VOY_NO SKD_VOY_NO,
             A.SKD_DIR_CD SKD_DIR_CD,
             A.IO_BND_CD IO_BND_CD,
--		/**  [CHM-200901475] 20091029: 부신신항의 VVD구하기에서 VSK_VSL_PORT_SKD의 Calling port indicator가 복수인 경우 VVD가 복수로 생성되어 Group화 처리되어 ATB DATE는 MIN값으로 대체  **/
             MIN(V.VPS_ETB_DT) ATB_DT,
             A.VNDR_SEQ
     FROM    VSK_VSL_PORT_SKD V,
            (SELECT H.TML_INV_TP_CD
			, H.YD_CD
			, H.VNDR_SEQ
			, D.VSL_CD
			, D.SKD_VOY_NO
			, D.SKD_DIR_CD
			, D.IO_BND_CD
             FROM	TES_EDI_SO_HDR H
			, TES_EDI_SO_DTL D
             WHERE 1=1
             AND H.TML_EDI_SO_OFC_CTY_CD = D.TML_EDI_SO_OFC_CTY_CD
             AND H.TML_EDI_SO_SEQ = D.TML_EDI_SO_SEQ
             AND H.TML_EDI_SO_OFC_CTY_CD = @[tml_edi_so_ofc_cty_cd]
             AND H.TML_EDI_SO_SEQ = @[tml_edi_so_seq]
             AND NVL(H.DELT_FLG,'N') <> 'Y'
             AND H.VNDR_SEQ IN ('180020','186666','176307')
             AND H.TML_INV_TP_CD IN ('TM')
             AND D.VSL_CD IS NOT NULL AND D.VSL_CD <> 'CNTC'
             UNION
             SELECT H.TML_INV_TP_CD
			, H.YD_CD
			, H.VNDR_SEQ
			, D.VSL_CD
			, D.SKD_VOY_NO
			, D.SKD_DIR_CD
			, D.IO_BND_CD
             FROM TES_EDI_SO_HDR H
		, TES_EDI_SO_CNTR_LIST D
             WHERE 1=1
             AND H.TML_EDI_SO_OFC_CTY_CD = D.TML_EDI_SO_OFC_CTY_CD
             AND H.TML_EDI_SO_SEQ = D.TML_EDI_SO_SEQ
             AND H.TML_EDI_SO_OFC_CTY_CD = @[tml_edi_so_ofc_cty_cd]
             AND H.TML_EDI_SO_SEQ = @[tml_edi_so_seq]
             AND NVL(H.DELT_FLG,'N') <> 'Y'
             AND H.VNDR_SEQ IN ('180020','186666','176307')
             AND H.TML_INV_TP_CD IN ('TM')
             AND D.VSL_CD IS NOT NULL AND D.VSL_CD <> 'CNTC'
             )  A
     WHERE 1=1
     AND V.VPS_PORT_CD = SUBSTR(A.YD_CD,1,5)
     AND V.VSL_CD <> 'CNTC'
     AND V.VSL_CD = A.VSL_CD
     AND V.SKD_VOY_NO = A.SKD_VOY_NO
     AND V.SKD_DIR_CD = A.SKD_DIR_CD
--		/**  [CHM-200901475] 20091029: 부신신항의 VVD구하기에서 VSK_VSL_PORT_SKD의 Calling port indicator가 복수인 경우 VVD가 복수로 생성되어 Group화 처리  **/
     GROUP BY A.VSL_CD
		, A.SKD_VOY_NO
		, A.SKD_DIR_CD
		, A.IO_BND_CD
		, A.VNDR_SEQ
     UNION ALL
     SELECT  A.VSL_CD VSL_CD,
             A.SKD_VOY_NO SKD_VOY_NO,
             A.SKD_DIR_CD SKD_DIR_CD,
             A.IO_BND_CD IO_BND_CD,
             LAST_DAY(TO_DATE(A.SKD_VOY_NO,'YYMM')) ATB_DT,
             A.VNDR_SEQ
     FROM   (SELECT H.TML_INV_TP_CD
			, H.YD_CD
			, H.VNDR_SEQ
			, D.VSL_CD
			, D.SKD_VOY_NO
			, D.SKD_DIR_CD
			, D.IO_BND_CD
             FROM TES_EDI_SO_HDR H
		, TES_EDI_SO_DTL D
             WHERE 1=1
             AND H.TML_EDI_SO_OFC_CTY_CD = D.TML_EDI_SO_OFC_CTY_CD
             AND H.TML_EDI_SO_SEQ = D.TML_EDI_SO_SEQ
             AND H.TML_EDI_SO_OFC_CTY_CD = @[tml_edi_so_ofc_cty_cd]
             AND H.TML_EDI_SO_SEQ = @[tml_edi_so_seq]
             AND NVL(H.DELT_FLG,'N') <> 'Y'
             AND H.VNDR_SEQ IN ('180020','186666','176307')
             AND H.TML_INV_TP_CD IN ('TM')
             AND D.VSL_CD IS NOT NULL AND D.VSL_CD = 'CNTC'
             UNION ALL
             SELECT H.TML_INV_TP_CD
		     , H.YD_CD
		     , H.VNDR_SEQ
		     , D.VSL_CD
		     , D.SKD_VOY_NO
		     , D.SKD_DIR_CD
		     , D.IO_BND_CD
             FROM TES_EDI_SO_HDR H
			, TES_EDI_SO_CNTR_LIST D
             WHERE 1=1
--		// Table Join 조건이 누락되어서 조건 추가 ( 2009-11-20 )
--		// EDI INVOICE전환시 VVD LIST 조회 조건 로직 수정
			AND H.TML_EDI_SO_OFC_CTY_CD	= D.TML_EDI_SO_OFC_CTY_CD
			AND H.TML_EDI_SO_SEQ			= D.TML_EDI_SO_SEQ
             AND H.TML_EDI_SO_OFC_CTY_CD = @[tml_edi_so_ofc_cty_cd]
             AND H.TML_EDI_SO_SEQ = @[tml_edi_so_seq]
             AND NVL(H.DELT_FLG,'N') <> 'Y'
             AND H.VNDR_SEQ IN ('180020','186666','176307')
             AND H.TML_INV_TP_CD IN ('TM')
             AND D.VSL_CD IS NOT NULL AND D.VSL_CD = 'CNTC') A
--	20091211 쿼리추가
	GROUP BY A.VSL_CD
		, A.SKD_VOY_NO
		, A.SKD_DIR_CD
		, A.IO_BND_CD
		, A.VNDR_SEQ
)			]]></sql>
			<params>
				<param name="tml_edi_so_ofc_cty_cd" type="12" value="" out="N"/>
				<param name="tml_so_seq" type="12" value="" out="N"/>
				<param name="cre_usr_id" type="12" value="" out="N"/>
				<param name="locl_cre_dt" type="12" value="" out="N"/>
				<param name="tml_edi_so_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
