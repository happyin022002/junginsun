<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TrnsModCompDBDAOsearchTrnsModCompRSQL">
			<desc><![CDATA[Inland Transmode Comparison 를 조회한다.]]></desc>
			<sql><![CDATA[
SELECT CASE WHEN Y.SO_TRNS_MOD = Y.CHG_TRNS_MOD THEN 'Match'
       ELSE 'Mismatch'
       END COMP_RESULT
      ,CASE WHEN NVL(Y.SO_TOT_AMT, 0) = 0 OR (CHG_CD IS NULL AND RAT_UT_CD IS NULL) THEN 'Unqualified'
       ELSE
        CASE WHEN NVL(Y.CHG_RT_USD, 0) > NVL(Y.SO_TOT_AMT_USD, 0) THEN 'Profit'
         WHEN NVL(Y.CHG_RT_USD, 0) = NVL(Y.SO_TOT_AMT_USD, 0) THEN 'Same'
         WHEN NVL(Y.CHG_RT_USD, 0) < NVL(Y.SO_TOT_AMT_USD, 0) THEN 'Loss'
        ELSE 'Unqualified' END
       END INLAND_PNL
      , Y.SO_NO, Y.TRSP_BND_CD, Y.TRSP_COST_DTL_MOD_CD, Y.FM_NOD_CD, Y.VIA_NOD_CD, Y.TO_NOD_CD, Y.DOR_NOD_CD
      , Y.SO_OFC_CD, Y.SO_CRE_DT, Y.WO_OFC_CD, Y.WO_NO, Y.WO_ISS_DT, Y.EQ_NO, Y.EQ_TPSZ_CD, Y.BKG_NO, Y.SO_TRNS_MOD
      , Y.SO_CURR_CD, Y.SO_TOT_AMT, Y.SO_TOT_AMT_USD, Y.SO_BKG_SUM_USD, Y.TRO_TRNS_MOD, Y.TRO_OFC_CD, Y.TRO_CNFM
      , Y.CHG_CD, Y.CHG_TRNS_MOD, Y.CHG_CURR_CD, DECODE(Y.CHG_CD, NULL, '', TO_CHAR(Y.CHG_UT_AMT, '999,999,999,999.99')) CHG_UT_AMT
      , DECODE(Y.CHG_CD, NULL, '', TO_CHAR(Y.CHG_RT_USD, '999,999,999,999.99')) CHG_RT_USD, TO_CHAR(Y.RAT_AS_QTY, '999,999,999,999.999') RAT_AS_QTY, Y.RAT_UT_CD
      , DECODE(Y.CHG_CD, NULL, '', TO_CHAR(Y.CHG_AMT, '999,999,999,999.99')) CHG_AMT
      , DECODE(Y.CHG_CD, NULL, '', TO_CHAR(Y.CHG_AMT_USD, '999,999,999,999.99')) CHG_AMT_USD, Y.ROW_CNT, Y.INCL_OFT_FLG, Y.AUTO_RAT_CD, Y.IHC_SUM_USD, Y.RFA_NO, Y.SC_NO, Y.TAA_NO, Y.CNG_RSN_DESC
FROM
(
SELECT X.SO_NO,X.TRSP_BND_CD,X.TRSP_COST_DTL_MOD_CD,X.FM_NOD_CD,X.VIA_NOD_CD,X.TO_NOD_CD,X.DOR_NOD_CD,X.SO_OFC_CD,X.SO_CRE_DT
      ,X.WO_OFC_CD,X.WO_NO,X.WO_ISS_DT,X.EQ_NO,X.EQ_TPSZ_CD,X.BKG_NO,X.SO_TRNS_MOD,X.SO_CURR_CD,X.SO_TOT_AMT,X.SO_TOT_AMT_USD
      ,SUM(X.SO_TOT_AMT_USD) OVER (PARTITION BY X.BKG_NO, X.TRSP_BND_CD, X.CHG_CD, X.CHG_CURR_CD, X.CHG_UT_AMT, X.RAT_AS_QTY, X.RAT_UT_CD, X.CHG_AMT, X.INCL_OFT_FLG, X.AUTO_RAT_CD) SO_BKG_SUM_USD
      ,X.TRO_TRNS_MOD,X.TRO_OFC_CD,X.TRO_CNFM,X.CHG_CD,X.CHG_TRNS_MOD,X.CHG_CURR_CD,X.CHG_UT_AMT,X.CHG_RT_USD
      ,X.RAT_AS_QTY,X.RAT_UT_CD,X.CHG_AMT,X.CHG_AMT_USD,X.ROW_CNT,X.INCL_OFT_FLG,X.AUTO_RAT_CD
      ,DECODE(X.CHG_CD,NULL,'',
              SUM(X.CHG_AMT_USD) OVER (PARTITION BY X.SO_NO, X.TRSP_BND_CD)) IHC_SUM_USD
      ,X.RFA_NO,X.SC_NO,X.TAA_NO,X.CNG_RSN_DESC
      ,X.EQ_TP1
      ,ROW_NUMBER() OVER (PARTITION BY X.SO_NO ORDER BY X.SO_NO, X.EQ_TP1 desc) RON
      ,LENGTH(X.EQ_TP1) AS LEN_TP1
FROM (
SELECT SO.TRSP_SO_OFC_CTY_CD||SO.TRSP_SO_SEQ AS SO_NO
      ,SO.TRSP_BND_CD
      ,SO.TRSP_COST_DTL_MOD_CD
      ,SO.FM_NOD_CD
      ,SO.VIA_NOD_CD
      ,SO.TO_NOD_CD
      ,SO.DOR_NOD_CD
      ,SO.CRE_OFC_CD AS SO_OFC_CD
      ,TO_CHAR(SO.LOCL_CRE_DT,'YYYY-MM-DD') AS SO_CRE_DT
      ,WO.CRE_OFC_CD AS WO_OFC_CD
      ,SO.TRSP_WO_OFC_CTY_CD||SO.TRSP_WO_SEQ AS WO_NO
      ,TO_CHAR(WO.LOCL_CRE_DT,'YYYY-MM-DD') AS WO_ISS_DT
      ,SO.EQ_NO
      ,SO.EQ_TPSZ_CD
      ,SO.BKG_NO
      ,SO.TRSP_CRR_MOD_CD AS SO_TRNS_MOD
      ,SO.CURR_CD AS SO_CURR_CD
      ,SO.BZC_AMT + NVL (SO.FUEL_SCG_AMT, 0)+ NVL (SO.SCG_VAT_AMT, 0) + NVL (SO.NEGO_AMT, 0) + NVL (SO.ETC_ADD_AMT, 0)+NVL (SO.HJL_HNDL_AMT, 0) AS SO_TOT_AMT      
      ,ROUND ((NVL (SO.BZC_AMT, 0) + NVL (SO.FUEL_SCG_AMT, 0) + NVL (SO.NEGO_AMT, 0) + NVL (SO.ETC_ADD_AMT, 0) + NVL (SO.HJL_HNDL_AMT, 0) + NVL (SO.SCG_VAT_AMT, 0)) / 
						 CASE WHEN NVL(SO.CURR_CD,'USD') = 'USD' THEN 1
						 ELSE	
                         (SELECT USD_LOCL_XCH_RT
                            FROM GL_MON_XCH_RT XCH
             		         WHERE XCH.ACCT_XCH_RT_LVL = 1 
			                   AND XCH.CURR_CD           = SO.CURR_CD
			                   AND XCH.ACCT_XCH_RT_YRMON = NVL(TO_CHAR(WO.LOCL_CRE_DT,'YYYYMM'),TO_CHAR (SO.LOCL_CRE_DT, 'YYYYMM')))
					     END
							   , 2) SO_TOT_AMT_USD
      ,DECODE (SO.TRSP_COST_DTL_MOD_CD,'DR'
               ,(SELECT DECODE(SO.TRSP_BND_CD,'O', DECODE(TRO.BKG_TRSP_MZD_CD,'T','TD','R','RD','B','WD','A','TR','U','TW','E','TF')
                              ,'I',DECODE(TRO.BKG_TRSP_MZD_CD,'T','TD','R','RD','B','WD','A','RT','U','WT','E','FT'))
                   FROM BKG_EUR_TRO TRO
                  WHERE TRO.BKG_NO = SO.BKG_NO AND TRO.IO_BND_CD = SO.TRSP_BND_CD AND TRO.TRO_SEQ = SO.TRO_SEQ)
               ,'') TRO_TRNS_MOD
      ,DECODE(SO.TRSP_COST_DTL_MOD_CD,'DR'
               ,(SELECT CFM_OFC_CD FROM BKG_EUR_TRO TRO WHERE TRO.BKG_NO = SO.BKG_NO AND TRO.IO_BND_CD = SO.TRSP_BND_CD AND TRO.TRO_SEQ = SO.TRO_SEQ)
               ,'') TRO_OFC_CD
      ,DECODE(SO.TRSP_COST_DTL_MOD_CD,'DR'
               , DECODE (NVL (SO.TRO_SEQ, ''),'', 'No','Yes')
               ,'') TRO_CNFM
      ,DECODE(SO.TRSP_BND_CD,'O'
               ,DECODE(BKG.ORG_TRNS_MOD_CD,'T','TD','R','RD','B','WD','A','TR','U','TW','E','TF','F','F','FT','FT')
               ,'I',DECODE(BKG.DEST_TRNS_MOD_CD,'T','TD','R','RD','B','WD','A','RT','U','WT','E','FT','F','F','FT','FT')
               ,'') CHG_TRNS_MOD
      ,CH.CHG_CD
      ,CH.CURR_CD AS CHG_CURR_CD
      ,CH.CHG_UT_AMT
      ,ROUND ((NVL (CH.CHG_UT_AMT, 0)) / 
						 CASE WHEN NVL(CH.CURR_CD,'USD') = 'USD' THEN 1
						 ELSE	
                         (SELECT USD_LOCL_XCH_RT
                            FROM GL_MON_XCH_RT XCH
             		         WHERE XCH.ACCT_XCH_RT_LVL = 1 
			                   AND XCH.CURR_CD           = CH.CURR_CD
			                   AND XCH.ACCT_XCH_RT_YRMON = NVL(TO_CHAR(WO.LOCL_CRE_DT,'YYYYMM'),TO_CHAR (SO.LOCL_CRE_DT, 'YYYYMM')))
					     END
							   , 2) CHG_RT_USD
      ,CH.RAT_AS_QTY
      ,CH.RAT_UT_CD
      ,CH.CHG_AMT
      ,ROUND ((NVL (CH.CHG_AMT, 0)) / 
						 CASE WHEN NVL(CH.CURR_CD,'USD') = 'USD' THEN 1
						 ELSE	
                         (SELECT USD_LOCL_XCH_RT
                            FROM GL_MON_XCH_RT XCH
             		         WHERE XCH.ACCT_XCH_RT_LVL = 1 
			                   AND XCH.CURR_CD           = CH.CURR_CD
			                   AND XCH.ACCT_XCH_RT_YRMON = NVL(TO_CHAR(WO.LOCL_CRE_DT,'YYYYMM'),TO_CHAR (SO.LOCL_CRE_DT, 'YYYYMM')))
					     END
							   , 2) CHG_AMT_USD
      ,DECODE(CH.CHG_CD,NULL,'',
              COUNT(*) OVER (PARTITION BY SO.TRSP_SO_OFC_CTY_CD, SO.TRSP_SO_SEQ, CH.CHG_CD, CH.CURR_CD, CH.CHG_UT_AMT, CH.RAT_AS_QTY, CH.RAT_UT_CD, CH.CHG_AMT, CH.FRT_INCL_XCLD_DIV_CD, CH.AUTO_RAT_CD)) ROW_CNT
      ,CH.FRT_INCL_XCLD_DIV_CD AS INCL_OFT_FLG
      ,CH.AUTO_RAT_CD
      ,BKG.RFA_NO
      ,BKG.SC_NO
      ,BKG.TAA_NO
      ,SO.CNG_RSN_DESC
      ,RANK() OVER (PARTITION BY SO.TRSP_SO_OFC_CTY_CD, SO.TRSP_SO_SEQ ORDER BY DECODE(SUBSTR(CH.CHG_CD,2,2),'IH',1,'AR',2)) RANKING 
      ,DECODE(SO.EQ_TPSZ_CD, CH.RAT_UT_CD, SO.EQ_TPSZ_CD, (SELECT CNTR_SZ_CD FROM PRI_RAT_UT WHERE RAT_UT_CD = SO.EQ_TPSZ_CD)) AS EQ_TP1
  FROM BKG_BOOKING BKG INNER JOIN TRS_TRSP_SVC_ORD SO
       ON SO.BKG_NO = BKG.BKG_NO
       LEFT OUTER JOIN TRS_TRSP_WRK_ORD WO
       ON SO.TRSP_WO_OFC_CTY_CD = WO.TRSP_WO_OFC_CTY_CD AND SO.TRSP_WO_SEQ = WO.TRSP_WO_SEQ
       LEFT OUTER JOIN BKG_CHG_RT CH
       ON SO.BKG_NO = CH.BKG_NO 
       AND (SELECT CNTR_SZ_CD FROM PRI_RAT_UT WHERE RAT_UT_CD = SO.EQ_TPSZ_CD) = (SELECT CNTR_SZ_CD FROM PRI_RAT_UT WHERE RAT_UT_CD = CH.RAT_UT_CD)
       AND CH.CHG_CD IN ('OIH','DIH','OAR','DAR')
       AND SUBSTR(CH.CHG_CD,1,1) = DECODE(SO.TRSP_BND_CD, 'O', 'O', 'I', 'D')
 WHERE 1=1
   AND SO.DELT_FLG = 'N'
   AND SO.TRSP_COST_DTL_MOD_CD IN ('CY','DR')
   AND SO.TRSP_BND_CD IN ('I','O')
#if(${from_date} != '' && ${to_date} != '')
   AND SO.LOCL_CRE_DT BETWEEN TO_DATE(REPLACE(@[from_date],'-',''), 'rrrrmmddhh24') AND TO_DATE(REPLACE(@[to_date],'-',''),'rrrrmmddhh24')+0.99999999
#end
#if(${input_office} != '')
   AND SO.CRE_OFC_CD IN (SELECT COLUMN_VALUE FROM TABLE(BKG_SPLIT_FNC(@[input_office], ',')))
#end
#if(${io_bound} == 'A')
   AND SO.TRSP_BND_CD IN ('I','O')
#elseif(${io_bound} == 'I')
   AND SO.TRSP_BND_CD = 'I'
#elseif(${io_bound} == 'O')
   AND SO.TRSP_BND_CD = 'O'
#end
#if(${sel_wo} == 'I')
   AND SO.TRSP_SO_STS_CD NOT IN ('C','R')
#elseif(${sel_wo} == 'N')
   AND SO.TRSP_SO_STS_CD IN ('C','R')
#end
#if(${sel_so_wo} == 'so')
	#if(${so_wo_no} != '')
   AND SO.TRSP_SO_OFC_CTY_CD = SUBSTR(@[so_wo_no], 1, 3) AND SO.TRSP_SO_SEQ = SUBSTR(@[so_wo_no], 4)
    #end
#elseif(${sel_so_wo} == 'wo')
	#if(${so_wo_no} != '')
   AND SO.TRSP_WO_OFC_CTY_CD = SUBSTR(@[so_wo_no], 1, 3) AND SO.TRSP_WO_SEQ = SUBSTR(@[so_wo_no], 4)
    #end
#end
#if(${sel_ctrt_no} != '')
   AND NVL(NVL(RFA_NO,SC_NO),TAA_NO) = @[sel_ctrt_no]
#end
#if(${sel_bkg_no} != '')
   AND SO.BKG_NO = @[sel_bkg_no]
#end
#if(${sel_cntr_no} != '')
   AND SO.EQ_NO = @[sel_cntr_no]
#end
#if(${search_fm_node} != '')
   AND SO.FM_NOD_CD LIKE @[search_fm_node]||'%'
#end
#if(${search_via_node} != '')
   AND SO.VIA_NOD_CD LIKE @[search_via_node]||'%'
#end
#if(${search_to_node} != '')
   AND SO.TO_NOD_CD LIKE @[search_to_node]||'%'
#end
#if(${search_door_node} != '')
   AND SO.DOR_NOD_CD LIKE @[search_door_node]||'%'
#end
#if ( ${sel_so_trns_mod} != '' )
   AND SO.TRSP_CRR_MOD_CD IN (SELECT INTG_CD_VAL_CTNT
                                FROM COM_INTG_CD_DTL
                               WHERE INTG_CD_ID = 'CD00794'
                                 AND (INSTR(@[sel_so_trns_mod], INTG_CD_VAL_CTNT) > 0
                                  OR @[sel_so_trns_mod] = 'ALL'
                                     )
                              )
#end
) X
 WHERE 1=1
   AND RANKING =1
#if ( ${sel_bkg_trns_mod} != '' )
   AND X.CHG_TRNS_MOD IN (SELECT INTG_CD_VAL_CTNT
                                FROM COM_INTG_CD_DTL
                               WHERE INTG_CD_ID = 'CD00794'
                                 AND (INSTR(@[sel_bkg_trns_mod], INTG_CD_VAL_CTNT) > 0
                                  OR @[sel_bkg_trns_mod] = 'ALL'
                                     )
                              )
#end
GROUP BY 
       X.SO_NO
      ,X.TRSP_BND_CD
      ,X.TRSP_COST_DTL_MOD_CD
      ,X.FM_NOD_CD
      ,X.VIA_NOD_CD
      ,X.TO_NOD_CD
      ,X.DOR_NOD_CD
      ,X.SO_OFC_CD
      ,X.SO_CRE_DT
      ,X.WO_OFC_CD
      ,X.WO_NO
      ,X.WO_ISS_DT
      ,X.EQ_NO
      ,X.EQ_TPSZ_CD
      ,X.BKG_NO
      ,X.SO_TRNS_MOD
      ,X.SO_CURR_CD
      ,X.SO_TOT_AMT
      ,X.SO_TOT_AMT_USD
      ,X.TRO_TRNS_MOD
      ,X.TRO_OFC_CD
      ,X.TRO_CNFM
      ,X.CHG_CD
      ,X.CHG_TRNS_MOD
      ,X.CHG_CURR_CD
      ,X.CHG_UT_AMT
      ,X.CHG_RT_USD
      ,X.RAT_AS_QTY
      ,X.RAT_UT_CD
      ,X.CHG_AMT
      ,X.CHG_AMT_USD
      ,X.ROW_CNT
      ,X.INCL_OFT_FLG
      ,X.AUTO_RAT_CD
      ,X.RFA_NO
      ,X.SC_NO
      ,X.TAA_NO
      ,X.CNG_RSN_DESC
      ,X.EQ_TP1
ORDER BY X.SO_OFC_CD
        ,X.BKG_NO
        ,X.SO_NO
) Y
 WHERE 1=1
   AND (Y.RON = 1 OR Y.LEN_TP1 = 2)
#if(${sel_result} == 'M')
   AND Y.SO_TRNS_MOD = Y.CHG_TRNS_MOD
#elseif(${sel_result} == 'I')
   AND Y.SO_TRNS_MOD <> Y.CHG_TRNS_MOD
#end
#if(${sel_pnl} == 'P')
   AND NVL(Y.CHG_RT_USD, 0) > NVL(Y.SO_TOT_AMT_USD, 0)
#elseif(${sel_pnl} == 'S')
   AND NVL(Y.CHG_RT_USD, 0) = NVL(Y.SO_TOT_AMT_USD, 0)
#elseif(${sel_pnl} == 'L')
   AND NVL(Y.CHG_RT_USD, 0) < NVL(Y.SO_TOT_AMT_USD, 0)
#elseif(${sel_pnl} == 'U')
   AND NVL(Y.SO_TOT_AMT, 0) = 0
#end
ORDER BY Y.BKG_NO, Y.SO_NO, Y.RON			]]></sql>
			<params>
				<param name="from_date" type="12" value="" out="N"/>
				<param name="to_date" type="12" value="" out="N"/>
				<param name="input_office" type="12" value="" out="N"/>
				<param name="so_wo_no" type="12" value="" out="N"/>
				<param name="sel_ctrt_no" type="12" value="" out="N"/>
				<param name="sel_bkg_no" type="12" value="" out="N"/>
				<param name="sel_cntr_no" type="12" value="" out="N"/>
				<param name="search_fm_node" type="12" value="" out="N"/>
				<param name="search_via_node" type="12" value="" out="N"/>
				<param name="search_to_node" type="12" value="" out="N"/>
				<param name="search_door_node" type="12" value="" out="N"/>
				<param name="sel_so_trns_mod" type="12" value="" out="N"/>
				<param name="sel_bkg_trns_mod" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
