<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TrsAdvanceAuditDBDAOsearchTrsPreAudListRSQL">
			<desc><![CDATA[searchTrsPreAudList 조회쿼리]]></desc>
			<sql><![CDATA[
SELECT '' CHK
      ,'' SEL_AUD_CD
      ,'' IBFLAG
      , AUTO_AUD_STS_CD
      , EXPN_AUD_STS_CD
      , RHQ_OFC_CD
      , INV_OFC_CD
      , TRSP_SO_TP_CD
      , INV_VNDR_SEQ
      , INV_NO
      , HJL_INV_NO
      , HJL_INV_VNDR_SEQ
      , NVL2(HJL_INV_VNDR_SEQ, HJL_INV_VNDR_SEQ, INV_VNDR_SEQ) DIS_INV_VNDR_SEQ
      , (SELECT X.VNDR_LGL_ENG_NM
           FROM MDM_VENDOR X
          WHERE X.VNDR_SEQ = NVL2(HJL_INV_VNDR_SEQ, HJL_INV_VNDR_SEQ, INV_VNDR_SEQ)
        ) DIS_INV_VNDR_NM
      , INV_ISS_DT
      , INV_AUD_STS_CD
      , CSR_NO
      , CURR_CD
      , WO_AMT
      , INV_AMT
      , CURR_CNG_FLG
      , INV_DIFF_AMT
      , INV_DIFF_AMT_FLG
      , INV_DIFF_PCT
      , NO_AGMT_FLG
      , NO_OPTM_ROUT_FLG
      , EXCEED_AVG_DIFF_AMT
      , EXCEED_AVG_FLG
      , INV_ISS_USR_NM
      , AUD_CFM_USR_NM
      , PAY_TERM_CD
	  , CASE WHEN CSR_NO IS NULL THEN TO_CHAR(TO_DATE(INV_ISS_DT, 'YYYY-MM-DD') + DECODE(PAY_TERM_CD, 'O60', 0, PAY_TERM_CD), 'YYYY-MM-DD')
		     ELSE INV_TERM_DT
        END PAY_DUE_DT
      , PAY_DT
      , EAC_IF_FLG
      , AUTO_AUD_CFM_DT
      , EXPN_AUD_RSLT_RMK
      , EXPN_AUD_RSLT_USR_ID
      , EXPN_AUD_RSLT_USR_NM
      , INV_CFM_DT
      , ATCH_FILE_LNK_ID
      , EXPN_AUD_RSLT_CD
      , (SELECT X.USR_NM FROM COM_USER X WHERE X.USR_ID = AA.AUTO_AUD_CFM_USR_ID) AUD_CFM_USR_NM
      , (SELECT MAX(BAT_PROG_STS_CD)
           FROM EAS_AUTO_AUD_BAT X
          WHERE SUB_SYS_CD = 'TRS'
            AND X.INV_NO        = AA.INV_NO
            AND X.INV_VNDR_SEQ  = AA.INV_VNDR_SEQ
            AND X.TRSP_SO_TP_CD = AA.TRSP_SO_TP_CD
            AND X.CRE_DT > SYSDATE - 1
        ) BAT_PROG_STS_CD
        , INV_AUD_CURR_CD
        , INV_AUD_DIFF_AMT
        , INV_AUD_USD_DIFF_AMT
  FROM (
        SELECT A.AUTO_EXPN_AUD_STS_CD AS AUTO_AUD_STS_CD
              ,A.EXPN_AUD_STS_CD
              ,A.RHQ_CD AS RHQ_OFC_CD
              ,A.INV_OFC_CD
              ,A.TRSP_SO_TP_CD
              ,A.INV_VNDR_SEQ
              ,A.INV_NO
              ,A.HJL_INV_NO
              ,A.HJL_INV_VNDR_SEQ
              ,TO_CHAR(A.INV_ISS_DT, 'YYYY-MM-DD') INV_ISS_DT
              ,(CASE WHEN B.TRSP_INV_AUD_STS_CD = 'CF' THEN 'C' -- Invoice Confirmed	
                     WHEN (C.IF_FLG IS NULL AND C.RQST_APRO_STEP_FLG = 'Y') OR (B.TRSP_INV_AUD_STS_CD = 'RA') THEN 'L' -- Requesting Approval
                     WHEN B.TRSP_INV_AUD_STS_CD = 'AR' THEN 'A' -- Approval Requested	
                     WHEN C.IF_ERR_RSN = 'Sending...' THEN 'S' -- Sending	
                     WHEN B.TRSP_INV_AUD_STS_CD = 'DA' THEN 'R' -- Disapproved	
                     WHEN B.TRSP_INV_AUD_STS_CD = 'IE' THEN 'E' -- I/F Error	
                     WHEN C.RCV_ERR_FLG = 'E' THEN 'J'-- A/P Rejected             	
                     WHEN B.TRSP_INV_AUD_STS_CD = 'IF' THEN 'P' -- I/F Success	
                     WHEN B.TRSP_INV_AUD_STS_CD = 'PD' THEN 'D' -- Paid	
                END) INV_AUD_STS_CD	
              ,B.CSR_NO
              ,A.CURR_CD
              ,A.WO_AMT
              ,A.INV_AMT
              ,A.CURR_CNG_FLG
              ,A.INV_DIFF_AMT
              ,A.INV_DIFF_FLG AS INV_DIFF_AMT_FLG
              ,A.INV_DIFF_RTO AS INV_DIFF_PCT
              ,A.AGMT_APLY_FLG AS NO_AGMT_FLG
              ,A.OPTM_ROUT_FLG AS NO_OPTM_ROUT_FLG
              ,A.AVG_OVR_DIFF_AMT AS EXCEED_AVG_DIFF_AMT
              ,A.AVG_OVR_DIFF_FLG AS EXCEED_AVG_FLG
              ,CASE WHEN A.HJL_INV_NO IS NOT NULL THEN 'ETS'
                    ELSE (SELECT X.USR_NM FROM COM_USER X WHERE X.USR_ID = A.INV_ISS_USR_ID)	
               END INV_ISS_USR_NM
              ,'' AUD_CFM_USR_NM
              ,A.GEN_PAY_TERM_CD AS PAY_TERM_CD
              ,TO_CHAR(TO_DATE(C.INV_TERM_DT, 'YYYY-MM-DD'), 'YYYY-MM-DD') INV_TERM_DT
              ,TO_CHAR(B.PAY_DT, 'YYYY-MM-DD') PAY_DT
              ,(SELECT 'Y'
                 FROM EAS_TRSP_AUD_CHK X	
                WHERE X.INV_NO        = A.INV_NO	
                  AND X.INV_VNDR_SEQ  = A.INV_VNDR_SEQ	
                  AND X.TRSP_SO_TP_CD = A.TRSP_SO_TP_CD	
                  AND ROWNUM = 1	
               ) EAC_IF_FLG
              ,DECODE(A.EXPN_AUD_STS_CD, NULL, '', TO_CHAR(A.AUTO_AUD_CFM_DT, 'YYYY-MM-DD')) AUTO_AUD_CFM_DT
              ,A.EXPN_AUD_RSLT_RMK
              ,A.EXPN_AUD_RSLT_USR_ID
              ,(SELECT X.USR_NM FROM COM_USER X WHERE X.USR_ID = A.EXPN_AUD_RSLT_USR_ID) EXPN_AUD_RSLT_USR_NM
              ,TO_CHAR(A.INV_CFM_DT, 'YYYY-MM-DD') INV_CFM_DT
              ,A.ATCH_FILE_LNK_ID
              ,A.EXPN_AUD_RSLT_CD
              ,A.AUTO_AUD_CFM_USR_ID
                , A.AUD_CURR_CD AS INV_AUD_CURR_CD
                , A.AUD_DIFF_AMT AS INV_AUD_DIFF_AMT
                , A.AUD_USD_DIFF_AMT AS INV_AUD_USD_DIFF_AMT
          FROM EAS_TRSP_AUD A
              ,TRS_TRSP_INV_WRK B
              ,AP_INV_HDR C
         WHERE A.INV_NO       = B.INV_NO	
           AND A.INV_VNDR_SEQ = B.INV_VNDR_SEQ
           AND B.CSR_NO       = C.CSR_NO(+)
           AND A.INV_CFM_DT BETWEEN TO_DATE(@[s_fm_dt], 'YYYY-MM-DD') AND TO_DATE(@[s_to_dt], 'YYYY-MM-DD') + 0.99999
           AND B.TRSP_INV_AUD_STS_CD <> 'RJ'
           AND C.RCV_ERR_FLG(+) <> 'E'
           -- RHQ로 조회	
           #if(${s_rhq_ofc_cd} != '')
           AND A.RHQ_CD = @[s_rhq_ofc_cd]
           #end
           -- Office로 조회
           #if(${s_ofc_cd} != '')
           AND A.INV_OFC_CD = @[s_ofc_cd]
           #end
           -- Service Order Type으로 조회
	 	   #if (${s_trsp_so_tp_cd}!= '')	
           AND A.TRSP_SO_TP_CD = @[s_trsp_so_tp_cd] 
           #end
           -- Cost Mode로 조회
           #if(${s_trsp_cost_dtl_mod_cd}!= '')
             AND EXISTS (SELECT 1	
		                   FROM TRS_TRSP_SVC_ORD X	
		                  WHERE X.INV_NO       = A.INV_NO	
		                    AND X.INV_VNDR_SEQ = A.INV_VNDR_SEQ	
		                    AND X.TRSP_SO_TP_CD = A.TRSP_SO_TP_CD	
		                    AND X.TRSP_COST_DTL_MOD_CD = @[s_trsp_cost_dtl_mod_cd]
                        )
           #end
           -- Trans Mode로 조회
           #if (${s_trsp_crr_mod_cd}!= '')
           AND EXISTS (SELECT 1	
                         FROM TRS_TRSP_SVC_ORD X	
                        WHERE X.INV_NO       = A.INV_NO	
                          AND X.INV_VNDR_SEQ = A.INV_VNDR_SEQ	
                          AND X.TRSP_SO_TP_CD = A.TRSP_SO_TP_CD	
                          AND X.TRSP_CRR_MOD_CD = @[s_trsp_crr_mod_cd]
                      )	
	       #end
           -- CSR No로 조회	
           #if (${s_csr_no}!= '')
             AND B.CSR_NO IN (
             #foreach( ${key} IN ${csrNos}) 
                #if($velocityCount < $csrNos.size()) 
                '${key}',
                #else 
                '${key}'
                #end 
             #end
             )
           #end
           -- S/P Code로 조회	
           #if (${s_inv_vndr_seq}!= '')
           AND CASE WHEN A.HJL_INV_VNDR_SEQ IS NOT NULL THEN A.HJL_INV_VNDR_SEQ
                    ELSE A.INV_VNDR_SEQ
               END = @[s_inv_vndr_seq]	
           #end
           -- Invoice No로 조회 	
           #if (${s_inv_no}!= '')
             AND A.INV_NO IN (
             #foreach( ${key} IN ${invNos}) 
                #if($velocityCount < $invNos.size()) 
                '${key}',
                #else 
                '${key}'
                #end 
             #end
             )
           #end
	       -- Auto Audit Status로 조회시  
	       #if (${s_auto_aud_sts_cd}!= '')
	         AND A.AUTO_EXPN_AUD_STS_CD = @[s_auto_aud_sts_cd]
	       #end
           -- Audit Status로 조회시	
           #if(${s_expn_aud_sts_cd} == 'N')	
             AND A.EXPN_AUD_STS_CD IS NULL	
           #elseif(${s_expn_aud_sts_cd} == 'D') 	
             AND A.EXPN_AUD_STS_CD IS NOT NULL	
           #elseif(${s_expn_aud_sts_cd} == 'P' || ${s_expn_aud_sts_cd} == 'E' || ${s_expn_aud_sts_cd} == 'A')	
             AND A.EXPN_AUD_STS_CD = @[s_expn_aud_sts_cd]
           #end
           -- Diffrence로 조회시
           #if(${s_aud_itm_cd} == 'DA')  	
             AND (A.INV_DIFF_FLG = 'Y' OR A.AGMT_APLY_FLG = 'N' OR A.AVG_OVR_DIFF_FLG = 'Y' OR A.OPTM_ROUT_FLG = 'N')
           #elseif(${s_aud_itm_cd} == 'DF')
             AND A.INV_DIFF_FLG = 'Y'
           #elseif(${s_aud_itm_cd} == 'NT')
             AND A.AGMT_APLY_FLG = 'N'
           #elseif (${s_aud_itm_cd} == 'EX')
             AND A.AVG_OVR_DIFF_FLG = 'Y'
           #elseif (${s_aud_itm_cd} == 'OT')
             AND A.OPTM_ROUT_FLG = 'N'
           #end
        UNION ALL
        SELECT A.AUTO_EXPN_AUD_STS_CD AS AUTO_AUD_STS_CD
              ,A.EXPN_AUD_STS_CD
              ,A.RHQ_CD AS RHQ_OFC_CD
              ,A.INV_OFC_CD
              ,A.TRSP_SO_TP_CD
              ,A.INV_VNDR_SEQ
              ,A.INV_NO
              ,A.HJL_INV_NO
              ,A.HJL_INV_VNDR_SEQ
              ,TO_CHAR(A.INV_ISS_DT, 'YYYY-MM-DD') INV_ISS_DT
              ,(CASE WHEN B.TRSP_INV_AUD_STS_CD = 'CF' THEN 'C' -- Invoice Confirmed	
                     WHEN (C.IF_FLG IS NULL AND C.RQST_APRO_STEP_FLG = 'Y') OR (B.TRSP_INV_AUD_STS_CD = 'RA') THEN 'L' -- Requesting Approval
                     WHEN B.TRSP_INV_AUD_STS_CD = 'AR' THEN 'A' -- Approval Requested	
                     WHEN C.IF_ERR_RSN = 'Sending...' THEN 'S' -- Sending	
                     WHEN B.TRSP_INV_AUD_STS_CD = 'DA' THEN 'R' -- Disapproved	
                     WHEN B.TRSP_INV_AUD_STS_CD = 'IE' THEN 'E' -- I/F Error	
                     WHEN C.RCV_ERR_FLG = 'E' THEN 'J'-- A/P Rejected             	
                     WHEN B.TRSP_INV_AUD_STS_CD = 'IF' THEN 'P' -- I/F Success	
                     WHEN B.TRSP_INV_AUD_STS_CD = 'PD' THEN 'D' -- Paid	
                END) INV_AUD_STS_CD	
              ,B.CSR_NO
              ,A.CURR_CD
              ,A.WO_AMT
              ,A.INV_AMT
              ,A.CURR_CNG_FLG
              ,A.INV_DIFF_AMT
              ,A.INV_DIFF_FLG AS INV_DIFF_AMT_FLG
              ,A.INV_DIFF_RTO AS INV_DIFF_PCT
              ,A.AGMT_APLY_FLG AS NO_AGMT_FLG
              ,A.OPTM_ROUT_FLG AS NO_OPTM_ROUT_FLG
              ,A.AVG_OVR_DIFF_AMT AS EXCEED_AVG_DIFF_AMT
              ,A.AVG_OVR_DIFF_FLG AS EXCEED_AVG_FLG
              ,CASE WHEN A.HJL_INV_NO IS NOT NULL THEN 'ETS'
                    ELSE (SELECT X.USR_NM FROM COM_USER X WHERE X.USR_ID = A.INV_ISS_USR_ID)	
               END INV_ISS_USR_NM
              ,'' AUD_CFM_USR_NM
              ,A.GEN_PAY_TERM_CD AS PAY_TERM_CD
              ,TO_CHAR(TO_DATE(C.INV_TERM_DT, 'YYYY-MM-DD'), 'YYYY-MM-DD') INV_TERM_DT
              ,TO_CHAR(B.PAY_DT, 'YYYY-MM-DD') PAY_DT
              ,(SELECT 'Y'
                 FROM EAS_TRSP_AUD_CHK X	
                WHERE X.INV_NO        = A.INV_NO	
                  AND X.INV_VNDR_SEQ  = A.INV_VNDR_SEQ	
                  AND X.TRSP_SO_TP_CD = A.TRSP_SO_TP_CD	
                  AND ROWNUM = 1	
               ) EAC_IF_FLG
              ,DECODE(A.EXPN_AUD_STS_CD, NULL, '', TO_CHAR(A.AUTO_AUD_CFM_DT, 'YYYY-MM-DD')) AUTO_AUD_CFM_DT
              ,A.EXPN_AUD_RSLT_RMK
              ,A.EXPN_AUD_RSLT_USR_ID
              ,(SELECT X.USR_NM FROM COM_USER X WHERE X.USR_ID = A.EXPN_AUD_RSLT_USR_ID) EXPN_AUD_RSLT_USR_NM
              ,TO_CHAR(A.INV_CFM_DT, 'YYYY-MM-DD') INV_CFM_DT
              ,A.ATCH_FILE_LNK_ID
              ,A.EXPN_AUD_RSLT_CD
              ,A.AUTO_AUD_CFM_USR_ID
                , A.AUD_CURR_CD AS INV_AUD_CURR_CD
                , A.AUD_DIFF_AMT AS INV_AUD_DIFF_AMT
                , A.AUD_USD_DIFF_AMT AS INV_AUD_USD_DIFF_AMT
          FROM EAS_TRSP_AUD A
              ,TRS_TRSP_RAIL_INV_WRK B
              ,AP_INV_HDR C
         WHERE A.INV_NO       = B.INV_NO	
           AND A.INV_VNDR_SEQ = B.INV_VNDR_SEQ
           AND B.CSR_NO       = C.CSR_NO(+)
           AND A.INV_CFM_DT BETWEEN TO_DATE(@[s_fm_dt], 'YYYY-MM-DD') AND TO_DATE(@[s_to_dt], 'YYYY-MM-DD') + 0.99999
           AND B.TRSP_INV_AUD_STS_CD <> 'RJ'
           AND C.RCV_ERR_FLG(+) <> 'E'
           -- RHQ로 조회	
           #if(${s_rhq_ofc_cd} != '')
           AND A.RHQ_CD = @[s_rhq_ofc_cd]
           #end
           -- Office로 조회
           #if(${s_ofc_cd} != '')
           AND A.INV_OFC_CD = @[s_ofc_cd]
           #end
	 	   -- Service Order Type으로 조회 (ALL 또는 R일 경우만 조회된다.)	
           #if (${s_trsp_so_tp_cd} == 'R' || ${s_trsp_crr_mod_cd} == '' )	
           AND 1=1	
           #else 	
           AND 1=2	
           #end
           -- Cost Mode로 조회
           #if(${s_trsp_cost_dtl_mod_cd}!= '')
             AND EXISTS (SELECT 1	
                           FROM TRS_TRSP_RAIL_INV_WRK X	
                               ,TRS_TRSP_RAIL_INV_DTL Y	
                               ,TRS_TRSP_RAIL_BIL_ORD Z	
                          WHERE X.INV_NO       = Y.INV_NO	
                            AND X.INV_VNDR_SEQ = Y.INV_VNDR_SEQ	
                            AND Y.TRSP_SO_OFC_CTY_CD = Z.TRSP_SO_OFC_CTY_CD	
                            AND Y.TRSP_SO_SEQ        = Z.TRSP_SO_SEQ	
                            AND X.INV_NO       = A.INV_NO	
                            AND X.INV_VNDR_SEQ = A.INV_VNDR_SEQ	
                            AND Z.TRSP_COST_DTL_MOD_CD = @[s_trsp_cost_dtl_mod_cd]
                        )
           #end 
           -- Trans Mode로 조회
           #if(${s_trsp_crr_mod_cd} == 'RD' || ${s_trsp_crr_mod_cd} == '' )	
           AND 1=1	
           #else 	
           AND 1=2	
           #end
           -- CSR No로 조회	
           #if (${s_csr_no}!= '')
             AND B.CSR_NO IN (
             #foreach( ${key} IN ${csrNos}) 
                #if($velocityCount < $csrNos.size()) 
                '${key}',
                #else 
                '${key}'
                #end 
             #end
             )
           #end
           -- S/P Code로 조회	
           #if (${s_inv_vndr_seq}!= '')
           AND A.INV_VNDR_SEQ = @[s_inv_vndr_seq]	
           #end
           -- Invoice No로 조회 	
           #if (${s_inv_no}!= '')
             AND A.INV_NO IN (
             #foreach( ${key} IN ${invNos}) 
                #if($velocityCount < $invNos.size()) 
                '${key}',
                #else 
                '${key}'
                #end 
             #end
             )
           #end
	       -- Auto Audit Status로 조회시  
	       #if (${s_auto_aud_sts_cd}!= '')
	         AND A.AUTO_EXPN_AUD_STS_CD = @[s_auto_aud_sts_cd]
	       #end
           -- Audit Status로 조회시	
           #if(${s_expn_aud_sts_cd} == 'N')	
             AND A.EXPN_AUD_STS_CD IS NULL	
           #elseif(${s_expn_aud_sts_cd} == 'D') 	
             AND A.EXPN_AUD_STS_CD IS NOT NULL	
           #elseif(${s_expn_aud_sts_cd} == 'P' || ${s_expn_aud_sts_cd} == 'E' || ${s_expn_aud_sts_cd} == 'A')	
             AND A.EXPN_AUD_STS_CD = @[s_expn_aud_sts_cd]
           #end
           -- Diffrence로 조회시
           #if(${s_aud_itm_cd} == 'DA')
             AND (A.INV_DIFF_FLG = 'Y' OR A.AGMT_APLY_FLG = 'N' OR A.AVG_OVR_DIFF_FLG = 'Y' OR A.OPTM_ROUT_FLG = 'N')
           #elseif(${s_aud_itm_cd} == 'DF')
             AND A.INV_DIFF_FLG = 'Y'
           #elseif(${s_aud_itm_cd} == 'NT')
             AND A.AGMT_APLY_FLG = 'N'
           #elseif (${s_aud_itm_cd} == 'EX')
             AND A.AVG_OVR_DIFF_FLG = 'Y'
           #elseif (${s_aud_itm_cd} == 'OT')
             AND A.OPTM_ROUT_FLG = 'N'
           #end
) AA
WHERE 1=1
-- CSR Status로 조회
#if (${s_csr_sts_cd}!= '')
  AND AA.INV_AUD_STS_CD = @[s_csr_sts_cd]
#end

-- Audit Status로 조회시
#if(${s_expn_aud_sts_cd} == 'I')	
  AND AA.EAC_IF_FLG = 'Y'
#end			]]></sql>
			<params>
				<param name="s_fm_dt" type="12" value="" out="N"/>
				<param name="s_to_dt" type="12" value="" out="N"/>
				<param name="s_rhq_ofc_cd" type="12" value="" out="N"/>
				<param name="s_ofc_cd" type="12" value="" out="N"/>
				<param name="s_trsp_so_tp_cd" type="12" value="" out="N"/>
				<param name="s_trsp_cost_dtl_mod_cd" type="12" value="" out="N"/>
				<param name="s_trsp_crr_mod_cd" type="12" value="" out="N"/>
				<param name="s_inv_vndr_seq" type="12" value="" out="N"/>
				<param name="s_auto_aud_sts_cd" type="12" value="" out="N"/>
				<param name="s_expn_aud_sts_cd" type="12" value="" out="N"/>
				<param name="s_csr_sts_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
