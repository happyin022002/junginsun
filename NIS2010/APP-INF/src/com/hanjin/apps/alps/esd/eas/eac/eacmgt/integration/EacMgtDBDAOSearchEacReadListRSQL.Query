<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="EacMgtDBDAOSearchEacReadListRSQL">
			<desc><![CDATA[EAC 등록 자료를 리스트로 조회한다.]]></desc>
			<sql><![CDATA[
SELECT A.EAC_NO -- EAC No.
      ,CASE WHEN A.AUDR_OFC_CD = 'SELADG' THEN A.AUDR_OFC_CD
            ELSE TRS_COMMON_PKG.TRS_GET_RHQ_OFC_CD(A.AUDR_OFC_CD)
       END AS RHQ_OFC_CD -- RHQ
      ,AUDR_OFC_CD -- Audit Office
      ,(SELECT INTG_CD_VAL_DP_DESC FROM COM_INTG_CD_DTL X WHERE X.INTG_CD_ID = 'CD03341' AND X.INTG_CD_VAL_CTNT = A.EAC_APRO_TP_CD) EAC_APRO_TP_NM -- Type
      ,TO_CHAR(A.EAC_INP_DT, 'YYYY-MM-DD') EAC_INP_DT  -- Entered Date
      ,TO_CHAR(TO_DATE(A.EAC_YRMON,'YYYYMM'),'YYYY-MM') AS EAC_YRMON      -- Audit Month
      ,(SELECT INTG_CD_VAL_DESC FROM COM_INTG_CD_DTL X WHERE X.INTG_CD_ID = 'CD03352' AND X.INTG_CD_VAL_CTNT = A.EAC_EXPN_TP_CD) EAC_EXPN_TP_NM -- Expense Type
      ,(SELECT INTG_CD_VAL_DP_DESC FROM COM_INTG_CD_DTL X WHERE X.INTG_CD_ID = 'CD00587' AND X.INTG_CD_VAL_CTNT = A.EAC_TP_CD) EAC_TP_NM -- EAC Type Main
      ,CASE WHEN A.EAC_TP_CD = 'I' -- Internal Error
            THEN (SELECT INTG_CD_VAL_DP_DESC FROM COM_INTG_CD_DTL X WHERE X.INTG_CD_ID = 'CD03340' AND X.INTG_CD_VAL_CTNT = A.EAC_BIL_TP_CD)
            WHEN A.EAC_TP_CD = 'M' -- Misbilling
            THEN (SELECT INTG_CD_VAL_DP_DESC FROM COM_INTG_CD_DTL X WHERE X.INTG_CD_ID = 'CD03339' AND X.INTG_CD_VAL_CTNT = A.EAC_BIL_TP_CD)
            WHEN A.EAC_TP_CD = 'T' -- Missing 3rd Party Billing
            THEN (SELECT N3PTY_BIL_TP_NM FROM TPB_N3RD_PTY_BIL_TP X WHERE X.N3PTY_BIL_TP_CD = A.EAC_BIL_TP_CD)
       END EAC_BIL_TP_NM -- EAC Type Sub
      ,A.RESPB_OFC_CD    -- Responsible Office
      ,A.VNDR_SEQ        -- Service Provider Code
      ,(SELECT X.VNDR_LGL_ENG_NM FROM MDM_VENDOR X WHERE X.VNDR_SEQ = A.VNDR_SEQ) AS VNDR_NM -- Service Provider Name
      ,A.EAC_COST_DESC   -- Cost/Account Code
      ,A.VVD_CD_CTNT     -- VVD
      ,B.BKG_NO          -- Booking No
      ,A.YD_CD           -- Location
      ,A.WO_NO_CTNT      -- W/O NO.
      ,A.N3PTY_SRC_NO    -- Invoice No.
      ,TO_CHAR(A.N3PTY_SRC_DT, 'YYYY-MM-DD') N3PTY_SRC_DT  -- Invoice Date
      ,A.CURR_CD         -- Cur.
      ,A.INV_AMT         -- Invoice Amount
      ,A.INV_CNG_AMT     -- Should be Amount
      ,A.INV_AUD_USD_AMT -- Audit Amount(US$)
      ,A.STL_AMT         -- Settled Amount(US$)     
      ,REPLACE(REPLACE(A.EAC_DESC, CHR(13)||CHR(10), ' '), CHR(34), '') EAC_DESC -- Details (Reason)
      ,REPLACE(REPLACE(A.EAC_INTER_RMK, CHR(13)||CHR(10), ' '), CHR(34), '') EAC_INTER_RMK   -- Internal note
      ,(SELECT INTG_CD_VAL_DP_DESC FROM COM_INTG_CD_DTL X WHERE X.INTG_CD_ID = 'CD03338' AND X.INTG_CD_VAL_CTNT = A.EAC_RSN_CD) AS EAC_RSN_NM -- Action type
      ,REPLACE(REPLACE(A.EAC_RSN_DESC, CHR(13)||CHR(10), ' '), CHR(34), '') EAC_RSN_DESC    -- Action taken
      ,A.EXPN_EVID_DESC  -- Relevant Evidence No.
      ,(SELECT EAC_USR_NM FROM EAS_EXPN_AUD_CS_PSON_CFG X WHERE X.EAC_USR_ID = A.AUDR_USR_ID) AUDR_USR_NM -- Auditor
      ,CASE WHEN A.EAC_STS_CD = 'IS' AND A.EAC_SYS_IF_CD IS NOT NULL AND A.CRE_DT = A.UPD_DT
            THEN A.EAC_SYS_IF_CD || ' I/F'
            ELSE (SELECT INTG_CD_VAL_DP_DESC FROM COM_INTG_CD_DTL X WHERE X.INTG_CD_ID = 'CD03337' AND X.INTG_CD_VAL_CTNT = A.EAC_STS_CD) 
       END AS EAC_STS_NM -- Status
      ,NVL((SELECT TO_CHAR(X.LOCL_CRE_DT,'YYYY-MM-DD')
              FROM EAS_EXPN_AUD_CS_APRO_STEP X
             WHERE X.EAC_NO     = A.EAC_NO
               AND X.EAC_STS_CD = A.EAC_STS_CD
               AND ROWNUM = 1), TO_CHAR(TPB_GET_LCL_DATE_FNC(A.UPD_DT, A.AUDR_OFC_CD), 'YYYY-MM-DD')) AS LOCL_CRE_DT -- Status  Date
      ,(SELECT INTG_CD_VAL_DP_DESC FROM COM_INTG_CD_DTL X WHERE X.INTG_CD_ID = 'CD03342' AND X.INTG_CD_VAL_CTNT = A.EAC_CMPL_CD) AS EAC_CMPL_NM -- Completion
      ,TO_CHAR(A.EAC_CMPL_DT, 'YYYY-MM-DD') EAC_CMPL_DT  -- Completion Date
      ,(SELECT REPLACE(REPLACE(EAC_APRO_RSN, CHR(13)||CHR(10), ' '), CHR(34), '')
          FROM EAS_EXPN_AUD_CS_APRO_STEP X
         WHERE X.EAC_NO = A.EAC_NO
           AND X.EAC_STS_CD IN ('RR', 'HR') -- EAC_STS_CD으로 컬럼명 변경 요청함
           AND ROWNUM = 1
       ) AS RJCT_DESC -- Reason of unapproval
      ,(SELECT Y.USR_NM
          FROM EAS_EXPN_AUD_CS_APRO_STEP X
              ,COM_USER Y
         WHERE X.APRO_USR_ID = Y.USR_ID
           AND X.EAC_NO = A.EAC_NO
           AND X.EAC_STS_CD IN ('RR', 'HR')
           AND ROWNUM = 1) RJCT_USR_NM
      ,B.N3PTY_NO -- TPB No.
      ,C.OTS_STS_NM AS N3PTY_STS_NM
      ,C.TPB_INV_AMT AS N3PTY_AMT
      ,DECODE(A.EAC_SYS_IF_CD,'','N','Y') AS EAC_SYS_IF_CD
      ,A.KPI_OFC_CD
      ,(SELECT Y.USR_NM
          FROM EAS_EXPN_AUD_CS_APRO_STEP X
              ,COM_USER Y
         WHERE X.APRO_USR_ID = Y.USR_ID
           AND X.EAC_NO = A.EAC_NO
           AND X.EAC_STS_CD = 'RC'
           AND ROWNUM = 1) RHQ_CNFM_USR_NM
      ,(SELECT Y.USR_NM
          FROM EAS_EXPN_AUD_CS_APRO_STEP X
              ,COM_USER Y
         WHERE X.APRO_USR_ID = Y.USR_ID
           AND X.EAC_NO = A.EAC_NO
           AND X.EAC_STS_CD IN ('HC','HR')
           AND ROWNUM = 1) HQ_CNFM_USR_NM
      ,(SELECT Y.USR_NM
          FROM EAS_EXPN_AUD_CS_APRO_STEP X
              ,COM_USER Y
         WHERE X.APRO_USR_ID = Y.USR_ID
           AND X.EAC_NO = A.EAC_NO
           AND X.EAC_STS_CD = 'SC'
           AND ROWNUM = 1) DELT_USR_NM
      ,CASE WHEN A.DELT_FLG = 'Y' AND (SELECT COUNT(*) 
                                         FROM EAS_EXPN_AUD_CS_APRO_STEP X 
                                        WHERE X.EAC_NO = A.EAC_NO 
                                          AND X.APRO_OFC_CD = 'SELADG') > 0 THEN (SELECT Y.USR_NM
                                                                                    FROM COM_USER Y
                                                                                   WHERE Y.USR_ID = A.UPD_USR_ID)  --HQ에서 삭제한 케이스
            ELSE (SELECT Y.USR_NM
                   FROM COM_USER Y
                  WHERE Y.USR_ID = A.EAC_CMPL_USR_ID)  
        END AS CMPL_USR_NM
  FROM EAS_EXPN_AUD_CS_MGMT     A
      ,EAS_EXPN_AUD_CS_N3RD_PTY B
      ,(SELECT MAX(NVL(Y.STL_TO_CLT_CNG_OFC_CD, X.OFC_CD)) TPB_OFC_CD -- ROC office
             , MAX(CASE WHEN Z.OTS_STS_CD IN ('R','T','J') THEN COMMCODE_PKG.GET_COMDTL_NAME_FNC('CD02799',X.OTS_STS_DTL_CD)
                         ELSE COMMCODE_PKG.GET_COMDTL_NAME_FNC('CD00588',Z.OTS_STS_CD)
                     END) AS OTS_STS_NM -- TPB status
               , SUM(TPB_GET_USD_AMT_FNC(D.CFM_AMT, D.CFM_CURR_CD,TPB_GET_LCL_DATE_FNC(D.CFM_DT,D.CFM_OFC_CD))) AS TPB_INV_AMT -- Recovery(US$)
            , X.N3PTY_NO
            , E.EAC_NO
        FROM TPB_OTS_GRP X
           , TPB_ADJ_STS Y
           , TPB_OTS_GRP_STS Z
           , TPB_OTS_DTL D
           , EAS_EXPN_AUD_CS_N3RD_PTY E
       WHERE X.N3PTY_NO = Y.N3PTY_NO(+)
         AND Y.STL_STS_LST_FLG(+) = 'Y' 
         AND Y.N3PTY_STL_TP_CD(+) = 'O'
         AND X.N3PTY_NO = Z.N3PTY_NO
         AND Z.OTS_STS_LST_FLG = 'Y'   
         AND X.N3PTY_NO = D.N3PTY_NO
         AND X.N3PTY_NO = E.N3PTY_NO 
         GROUP BY X.N3PTY_NO, E.EAC_NO
         ) C
 WHERE A.EAC_NO = B.EAC_NO(+)
   AND A.EAC_NO = C.EAC_NO(+)
#if(${s_rhq_ofc_cd} == 'SELADG')
   AND A.AUDR_OFC_CD = @[s_rhq_ofc_cd]
#elseif(${s_rhq_ofc_cd} == '')   

#else
   AND TRS_COMMON_PKG.TRS_GET_RHQ_OFC_CD(AUDR_OFC_CD) = @[s_rhq_ofc_cd] -- RHQ
#end

#if(${s_ofc_cd} != '') 
   AND A.AUDR_OFC_CD = @[s_ofc_cd] -- Audit Office
#end
   AND A.EAC_YRMON BETWEEN replace(@[s_eac_yrmon_fm],'-','') AND  replace(@[s_eac_yrmon_to],'-','') -- Audit Month -- 필수
#if(${s_eac_expn_tp_cd} != '') 
   AND A.EAC_EXPN_TP_CD = @[s_eac_expn_tp_cd] -- Expense Type 
#end

#if(${s_eac_tp_cd} != '') 
   AND A.EAC_TP_CD = @[s_eac_tp_cd] -- EAC Type Main
#end

#if(${s_eac_bil_tp_cd} != '') 
   AND A.EAC_BIL_TP_CD = @[s_eac_bil_tp_cd] -- EAC Type Sub
#end

#if(${s_inv_aud_usd_amt} != '') 
   AND A.INV_AUD_USD_AMT >= replace(@[s_inv_aud_usd_amt],',','') -- Amount(US$)
#end

#if(${s_vndr_seq} != '') 
   AND A.VNDR_SEQ = @[s_vndr_seq] -- S/P Code
#end

#if(${s_keyword} != '') 
   AND UPPER(A.EAC_DESC || A.EAC_INTER_RMK || A.EAC_RSN_DESC || A.EAC_NO || A.N3PTY_SRC_NO || A.VVD_CD_CTNT || A.WO_NO_CTNT || A.YD_CD || B.BKG_NO || A.EXPN_EVID_DESC || B.N3PTY_NO) LIKE UPPER('%'||@[s_keyword] ||'%') -- Keyword   
#end
#if(${s_eac_sts_cd} != '') 
   AND A.EAC_STS_CD = @[s_eac_sts_cd] -- Status
#end			]]></sql>
			<params>
				<param name="s_rhq_ofc_cd" type="12" value="" out="N"/>
				<param name="s_ofc_cd" type="12" value="" out="N"/>
				<param name="s_eac_yrmon_fm" type="12" value="" out="N"/>
				<param name="s_eac_yrmon_to" type="12" value="" out="N"/>
				<param name="s_eac_expn_tp_cd" type="12" value="" out="N"/>
				<param name="s_eac_tp_cd" type="12" value="" out="N"/>
				<param name="s_eac_bil_tp_cd" type="12" value="" out="N"/>
				<param name="s_inv_aud_usd_amt" type="12" value="" out="N"/>
				<param name="s_vndr_seq" type="12" value="" out="N"/>
				<param name="s_keyword" type="12" value="" out="N"/>
				<param name="s_eac_sts_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
