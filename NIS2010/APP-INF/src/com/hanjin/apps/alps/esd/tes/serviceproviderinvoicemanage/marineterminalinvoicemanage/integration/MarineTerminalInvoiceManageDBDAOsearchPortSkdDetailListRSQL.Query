<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="MarineTerminalInvoiceManageDBDAOsearchPortSkdDetailListRSQL">
			<desc><![CDATA[searchPortSkdDetailList]]></desc>
			<sql><![CDATA[
SELECT VX.*,
       TES_GET_CNTR_CHK_FNC(@[atb_dt], @[yd_cd], @[vvd], VX.RVIS_CNTR_NO, @[io_bnd_cd]) AS CNTR_CHK
  FROM (SELECT C.CNTR_NO AS RVIS_CNTR_NO,
               C.SZTP AS RVIS_CNTR_TPSZ_CD,
               C.POL,
               C.OPR_CD,
               C.PRECELL,
               C.POSITION,
               NVL(C.SHIFT_TYPE, '') || NVL(C.SHIFT_RSN, '') AS SHIFT_RSN,
               C.ACCOUNT,
               C.PARTY,
               C.RESPB_CNTR_NO,
               (SELECT DECODE ( SIGN ( COUNT(1) ), 1, 'File Attached', NULL )
                  FROM OPF_TDR_ATCH_FILE F
                 WHERE C.VSL_CD = F.VSL_CD
                   AND C.VOY_NO = F.SKD_VOY_NO
                   AND C.DIR_CD = F.SKD_DIR_CD
                   AND C.PORT_CD = F.VPS_PORT_CD
                   AND C.CALL_IND = F.CLPT_IND_SEQ
                   AND C.STATUS = F.CNTR_HNDL_KND_CD
                   AND C.CNTR_NO = F.CNTR_NO ) AS FILE_ATCH,
               C.FE,
               V.YD_CD,
               V.CLPT_IND_SEQ,
               V.VSL_CD,
               V.SKD_VOY_NO,
               V.SKD_DIR_CD,
               TURN_PORT_FLG,
               V.TURN_SKD_DIR_CD,
               V.TURN_SKD_VOY_NO,
               C.SHIFT_TYPE,
               MAX(DECODE(V.SKD_VOY_NO, SUBSTR(@[vvd], 5, 4), DECODE(TURN_PORT_FLG, 'Y', V.TURN_SKD_VOY_NO, ''), '')) OVER() AS MAX_TURN_SKD_VOY_NO,
               MAX(DECODE(V.SKD_VOY_NO, SUBSTR(@[vvd], 5, 4), DECODE(TURN_PORT_FLG, 'Y', V.TURN_SKD_DIR_CD, ''), '')) OVER() AS MAX_TURN_SKD_DIR_CD
          FROM VSK_VSL_PORT_SKD V,
               TDR_HEADER H,
               TDR_CNTR_DETAIL C
         WHERE 1=1
           AND V.VSL_CD = SUBSTR(@[vvd], 1, 4)
           AND V.YD_CD = @[yd_cd]
           AND C.ACCOUNT = 'SML'
#if (${lgs_cost_cd} != 'SVRHCC' )
           AND C.SHIFT_TYPE = 'Q'
#else 
           AND C.SHIFT_TYPE = 'B'
#end
#if (${yn} != 'A' )
           AND NVL(C.FE, 'E') = @[yn]
#end
           AND V.VSL_CD = H.VSL_CD
           AND V.SKD_VOY_NO = H.VOY_NO
           AND V.SKD_DIR_CD = H.DIR_CD
           AND V.VPS_PORT_CD = H.PORT_CD
           AND V.CLPT_IND_SEQ = H.CALL_IND
           AND H.VSL_CD = C.VSL_CD
           AND H.VOY_NO = C.VOY_NO
           AND H.DIR_CD = C.DIR_CD
           AND H.PORT_CD = C.PORT_CD
           AND H.CALL_IND = C.CALL_IND
           AND C.STATUS = 'ST'
           AND TRIM(C.PRECELL) IS NOT NULL
-- Status로 조회시 (MULTI 리스트로 파라메터 받아 loop문에서 처리)
#if ($param_tpsz_cd.size() > 0)
      AND C.SZTP IN (
	#foreach($key in ${param_tpsz_cd}) 
		#if($velocityCount < $param_tpsz_cd.size()) 
			'$key', 
		#else 
			'$key' 
		#end 
	#end
	)
#end
 	) VX
 WHERE 1=1
   AND ( (VX.SKD_VOY_NO = SUBSTR(@[vvd], 5, 4) AND VX.SKD_DIR_CD = SUBSTR(@[vvd], 9, 1) )
            OR (VX.SKD_VOY_NO = VX.MAX_TURN_SKD_VOY_NO AND VX.SKD_DIR_CD = VX.MAX_TURN_SKD_DIR_CD))			]]></sql>
			<params>
				<param name="atb_dt" type="12" value="2014-10-07" out="N"/>
				<param name="yd_cd" type="12" value="NGLOSY3" out="N"/>
				<param name="vvd" type="12" value="AEEM0005E" out="N"/>
				<param name="io_bnd_cd" type="12" value="O" out="N"/>
				<param name="yn" type="12" value="A" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
