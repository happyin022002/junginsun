<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="COPSearchDBDAOSearchSOCostInfoRSQL">
			<desc><![CDATA[SearchSOCostInfo]]></desc>
			<sql><![CDATA[
SELECT aa.*, aa.so_ofc||aa.so_seq so_num
  FROM
     ( SELECT a.cop_no
			, a.trsp_so_sts_cd                             
            , a.cost_act_grp_seq
            , a.ctrl_ofc_cd     
			, decode(a.trsp_so_sts_cd, 'N', '', 'D', '', 'P', '', e.trsp_so_ofc_cty_cd) so_ofc                     
            , d.cost_act_grp_nm cost_act_grp_nm                            
            , c.vndr_abbr_nm vndr_abbr_nm
            , c1.vndr_abbr_nm vndr_abbr_nm_act	-- ADD CHM-201327095                                
            , commcode_pkg.get_comdtl_name_fnc('CD00275', a.trsp_so_sts_cd) trsp_so_sts                        
            , decode(a.trsp_so_sts_cd, 'N', '', 'D', '', 'P', '', e.trsp_so_seq) so_seq                       
            , 
			  CASE WHEN A.TRSP_SO_STS_CD IN ('N', 'D', 'P') THEN ' - ' ELSE (
			      CASE WHEN e.trsp_bnd_cd = 'O' 
    	               THEN e.fm_nod_cd||' - ' ||DECODE(NVL(e.dor_nod_cd, ''), '', '', e.dor_nod_cd||' - ')
        	                ||DECODE(NVL(e.via_nod_cd, ''), '', '', e.via_nod_cd||' - ')||e.to_nod_cd 
            	       ELSE e.fm_nod_cd||' - ' ||DECODE(NVL(e.via_nod_cd, ''), '', '', e.via_nod_cd||' - ')
                	        ||DECODE(NVL(e.dor_nod_cd, ''), '', '', e.dor_nod_cd||' - ')||e.to_nod_cd 
	              END 
			  ) END AS fm_to                          
            , CASE WHEN a.trsp_so_sts_cd ='N' then to_char(a.SO_CNDDT_DELT_DT, 'YYYYMMDD HH24:MI:SS')
                   ELSE TO_CHAR(e.locl_cre_dt, 'YYYYMMDD HH24:MI:SS') 
              END AS so_dt
			, CASE WHEN a.trsp_so_sts_cd ='N' THEN (select g.usr_nm from com_user g where a.SO_CNDDT_DELT_USR_ID = g.usr_id) ELSE (select g.usr_nm from com_user g where e.cre_usr_id = g.usr_id) END user_nm                                                        
--          , CASE WHEN a.trsp_so_sts_cd ='N' THEN a.delt_usr_id ELSE e.cre_usr_id END user_id                             
            , b.intl_phn_no||'-'||b.phn_no sp_h_no                   
            , e.inter_rmk    so_rmk1                                
            , e.inv_rmk   so_rmk2                                     
            , e.spcl_instr_rmk   so_rmk3                                          
            , e.trsp_wo_ofc_cty_cd||e.trsp_wo_seq wo_no                     
            , to_char(f.locl_cre_dt, 'YYYYMMDD HH24:MI:SS') wo_dt  
			, row_number() over (partition by a.cop_no, a.cost_act_grp_seq order by
                CASE WHEN a.trsp_so_sts_cd ='N' then to_char(a.delt_dt, 'YYYYMMDD HH24:MI:SS')
                     ELSE TO_CHAR(e.locl_cre_dt, 'YYYYMMDD HH24:MI:SS') 
                END desc ) mx_knt                     
        FROM  sce_pln_so_list a,   
              mdm_vndr_cntc_pnt b,                       
              mdm_vendor  c,
              mdm_vendor  c1,	-- ADD CHM-201327095
              prd_cost_act_grp d                          
              ,trs_trsp_svc_ord e                          
              ,trs_trsp_wrk_ord f                            
       WHERE  a.cost_act_grp_cd = d.cost_act_grp_cd --and a.cost_act_grp_cd <> 'DMLK'                     
         AND  a.n1st_vndr_seq = c.vndr_seq (+) --and cost_act_grp_tp_cd = 'L'                    
         AND  a.n1st_vndr_seq = b.vndr_seq (+)
         AND  e.vndr_seq = c1.vndr_seq(+)	-- ADD CHM-201327095
         AND  b.prmry_chk_flg (+)               = 'Y'                               
         AND  b.phn_no (+)     IS NOT NULL                    
         AND  a.cop_no = @[cop_no]    

         AND  a.cop_no = e.cop_no(+)  
		 AND a.cost_act_grp_seq = e.cost_act_grp_seq (+)                      
         AND  NVL(a.trsp_so_sts_cd, 'U') != 'U'                 
         AND  e.trsp_wo_ofc_cty_cd = f.trsp_wo_ofc_cty_cd(+)                   
         AND  e.trsp_wo_seq = f.trsp_wo_seq(+)       
         AND E.DELT_FLG(+) = 'N'
         AND  NOT EXISTS                   
                       (
                         SELECT 'X' 
                           FROM sce_pln_so_list                  
                          WHERE cop_no = a.cop_no                  
                            AND ctrl_ofc_cd = 'PHXSA'                   
                            AND trsp_mod_cd ='RD'                  
                            AND ctrl_ofc_cd = a.ctrl_ofc_cd 
                            AND trsp_mod_cd = a.trsp_mod_cd                  
                       )                      
       UNION                         
      SELECT a.cop_no
			, a.trsp_so_sts_cd                          
            , a.cost_act_grp_seq
            , a.ctrl_ofc_cd           
			, decode(a.trsp_so_sts_cd, 'N', '', 'D', '', 'P', '', e.trsp_so_ofc_cty_cd) so_ofc                             
            , MAX(d.cost_act_grp_nm) cost_act_grp_nm                                        
            , MAX(c.vndr_abbr_nm) vndr_abbr_nm
            , MAX(DECODE(f.sub_rail_seq, 1, c1.vndr_abbr_nm)) vndr_abbr_nm_act	-- ADD CHM-201327095
            , MAX(commcode_pkg.get_comdtl_name_fnc('CD00275', a.trsp_so_sts_cd)) trsp_so_sts                    
            , MAX(decode(a.trsp_so_sts_cd, 'N', '', 'D', '', 'P', '', e.trsp_so_seq)) so_seq                       
			, CASE WHEN MAX(A.TRSP_SO_STS_CD) IN ('N', 'D', 'P') THEN ' - ' ELSE (
	            MAX(decode(f.sub_rail_seq, 1, f.fm_nod_cd))|| ' - '|| MAX(DECODE(f.sub_rail_seq, 1, f.to_nod_cd))
    	          || MAX(decode(f.sub_rail_seq, 2, ' - '||f.to_nod_cd))|| MAX(DECODE(f.sub_rail_seq, 3, ' - '||f.to_nod_cd))    

 				) END AS fm_to                     
            , CASE WHEN MAX(a.trsp_so_sts_cd) ='N' THEN TO_CHAR(max(a.SO_CNDDT_DELT_DT), 'YYYYMMDD HH24:MI:SS')  -- correction SO_CNDDT_DELT_DT
                   ELSE MAX(TO_CHAR(e.locl_cre_dt, 'YYYYMMDD HH24:MI:SS')) END so_dt                       
            , CASE WHEN MAX(a.trsp_so_sts_cd) ='N' THEN MAX((select g.usr_nm from com_user g where a.SO_CNDDT_DELT_USR_ID = g.usr_id)) ELSE MAX((select g.usr_nm from com_user g where e.cre_usr_id = g.usr_id)) END user_nm    -- correction SO_CNDDT_DELT_USR_ID                             
--			, CASE WHEN MAX(a.trsp_so_sts_cd) ='N' THEN MAX(a.delt_usr_id) ELSE MAX(e.cre_usr_id) END user_id                                  
            , MAX(b.intl_phn_no||'-'||b.phn_no) sp_h_no                   
            , MAX('')                           so_rmk1                   
            , MAX('')                        so_rmk2                      
            , MAX('')                         so_rmk3                    
            , MAX('') wo_no                          
            , MAX(TO_CHAR(e.wo_iss_dt, 'YYYYMMDD HH24:MI:SS')) wo_dt
			, row_number() over (partition by a.cop_no, a.cost_act_grp_seq order by
                CASE WHEN MAX(a.trsp_so_sts_cd) ='N' then to_char(max(a.delt_dt), 'YYYYMMDD HH24:MI:SS')
                     ELSE MAX(TO_CHAR(e.locl_cre_dt, 'YYYYMMDD HH24:MI:SS')) 
                END desc ) mx_knt                       
         FROM sce_pln_so_list a                      
            , mdm_vndr_cntc_pnt b                     
            , mdm_vendor  c
            , mdm_vendor  c1	-- ADD CHM-201327095
            , prd_cost_act_grp d                        
            , trs_trsp_rail_bil_ord e                   
            , trs_trsp_rail_bil_vndr_set f                                       
        WHERE a.cost_act_grp_cd = d.cost_act_grp_cd --and a.cost_act_grp_cd <> 'DMLK'                    
          AND a.n1st_vndr_seq = c.vndr_seq (+) --and cost_act_grp_tp_cd = 'L'
          AND f.vndr_seq = c1.vndr_seq (+)	-- ADD CHM-201327095
          AND a.cop_no = @[cop_no]                              
          AND NVL(a.trsp_so_sts_cd, 'U') != 'U'
          AND a.n1st_vndr_seq = b.vndr_seq (+)                                 
          AND b.prmry_chk_flg (+)               = 'Y'                            
          AND b.phn_no (+)      IS NOT NULL 
          AND a.cop_no = e.cop_no(+)      
		  AND a.cost_act_grp_seq = e.cost_act_grp_seq (+)                                             
          AND e.trsp_so_ofc_cty_cd =f.trsp_so_ofc_cty_cd(+)                    
          AND e.trsp_so_seq = f.trsp_so_seq(+)                        
          AND a.ctrl_ofc_cd = 'PHXSA'                   
          AND a.trsp_mod_cd ='RD'                  
      GROUP BY a.cop_no, a.ctrl_ofc_cd,a.cost_act_grp_seq, a.trsp_so_sts_cd, e.trsp_so_ofc_cty_cd   ) aa 
	WHERE mx_knt = 1                       
    ORDER BY 1,3			]]></sql>
			<params>
				<param name="cop_no" type="12" value="CCHI9415112885" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
