<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="SpecialCargoQuotationManageDBDAOsearchLoadUnloadShuttleExtCostRSQL">
			<desc><![CDATA[searchLoadUnloadShuttleExtCost]]></desc>
			<sql><![CDATA[
SELECT
K.*
FROM (
SELECT
DENSE_RANK() OVER (PARTITION BY T.FM_LOC_CD, T.FM_NOD_YD_NO ,T.TO_LOC_CD, T.TO_NOD_YD_NO, T.TRSP_AWK_CGO_TRF_TP_CD, T.IO_GA_CD, T.TRSP_CRR_MOD_CD, T.COND_NO  ORDER BY T.FM_LOC_CD, T.FM_NOD_YD_NO, T.TO_LOC_CD, T.TO_NOD_YD_NO, T.TRSP_AWK_CGO_TRF_TP_CD, T.IO_GA_CD, T.TRSP_CRR_MOD_CD, T.COND_NO, T.TRSP_AWK_TRF_VER_NO DESC) RN,
T.* 
FROM (
    SELECT 
 	 SUBSTR(AD.FM_YD_CD,1,5) FM_LOC_CD
 	, SUBSTR(AD.FM_YD_CD,6,2) FM_NOD_YD_NO
 	, SUBSTR(AD.TO_YD_CD,1,5) TO_LOC_CD
 	, SUBSTR(AD.TO_YD_CD,6,2) TO_NOD_YD_NO
    , X.TRSP_AWK_CGO_TRF_TP_CD
 	, X.IO_GA_CD
 	, X.TRSP_CRR_MOD_CD
 	, X.COND_NO
	,(SELECT C.COND_DESC
	  FROM TES_TRF_COND C
	  WHERE 1=1
	  AND C.COND_NO = X.COND_NO) COND_DESC	
 	, X.TRSP_AWK_TRF_VER_NO
    , X.MAN_LOCL_CURR_CD
    , X.MAN_LOCL_AMT_20FT
    , X.MAN_LOCL_AMT_40FT
    , X.MAN_USD_AMT_20FT
    , X.MAN_USD_AMT_40FT
    , X.AUTO_USD_AMT_20FT
    , X.AUTO_USD_AMT_40FT
	, X.SUM_USD_AMT_20FT
    , X.SUM_USD_AMT_40FT
    , AD.CALC_RMK
    , AD.LST_UPD_USR_ID
    , TO_CHAR(AD.LST_UPD_DT,'YYYY-MM-DD') LST_UPD_DT
    , X.SPCL_CGO_REF_SEQ
    , CASE
    WHEN Y.FM_YD_CD IS NOT NULL
    THEN 'Y'
    ELSE 'N'
    END CHK_SPCL_CGO_REF_SEQ
    FROM TRS_AWK_CGO_TRF_HDR AD, (
        SELECT 
            /** HDR + DTL **/
            T.FM_YD_CD, T.TO_YD_CD, T.TRSP_AWK_CGO_TRF_TP_CD, T.IO_GA_CD, T.TRSP_CRR_MOD_CD, T.COND_NO, MAX(T.TRSP_AWK_TRF_VER_NO) TRSP_AWK_TRF_VER_NO, 
			'' SPCL_CGO_REF_SEQ,
            /** UNIT COST MANUAL (LOCL CURR) **/
            MAX(
            CASE
            WHEN T.TRSP_AWK_UC_CALC_TP_CD = 'M'
            THEN T.LOCL_CURR_CD
            END) MAN_LOCL_CURR_CD, 
            MAX(
            CASE
            WHEN T.TRSP_AWK_UC_CALC_TP_CD = 'M'
            THEN DECODE(T.CNTR_SZ_CD,'2',T.LOCL_CURR_AMT,'')
            END) MAN_LOCL_AMT_20FT,
            MAX(
            CASE
            WHEN T.TRSP_AWK_UC_CALC_TP_CD = 'M'
            THEN DECODE(T.CNTR_SZ_CD,'4',T.LOCL_CURR_AMT,'')
            END) MAN_LOCL_AMT_40FT,
            /** UNIT COST MANUAL (USD) **/
            MAX(
            CASE
            WHEN T.TRSP_AWK_UC_CALC_TP_CD = 'M'
            THEN DECODE(T.CNTR_SZ_CD,'2',T.USD_AMT,'')
            END) MAN_USD_AMT_20FT,
            MAX(
            CASE
            WHEN T.TRSP_AWK_UC_CALC_TP_CD = 'M'
            THEN DECODE(T.CNTR_SZ_CD,'4',T.USD_AMT,'')
            END) MAN_USD_AMT_40FT,
            /** UNIT COST AUTO (USD) **/
            MAX(
            CASE
            WHEN T.TRSP_AWK_UC_CALC_TP_CD = 'A'
            THEN DECODE(T.CNTR_SZ_CD,'2',T.USD_AMT,'')
            END) AUTO_USD_AMT_20FT,
            MAX(
            CASE
            WHEN T.TRSP_AWK_UC_CALC_TP_CD = 'A'
            THEN DECODE(T.CNTR_SZ_CD,'4',T.USD_AMT,'')
            END) AUTO_USD_AMT_40FT,
			/** TOTAL HANDLING COST (USD) **/
            MAX(
            CASE
            WHEN T.TRSP_AWK_UC_CALC_TP_CD = 'S'
            THEN DECODE(T.CNTR_SZ_CD,'2',T.USD_AMT,'')
            END) SUM_USD_AMT_20FT,
            MAX(
            CASE
            WHEN T.TRSP_AWK_UC_CALC_TP_CD = 'S'
            THEN DECODE(T.CNTR_SZ_CD,'4',T.USD_AMT,'')
            END) SUM_USD_AMT_40FT
        FROM TRS_AWK_CGO_TRF_HDR D, TRS_AWK_CGO_TRF_TP_SZ T
        WHERE 1=1
        AND D.FM_YD_CD = T.FM_YD_CD
        AND D.TO_YD_CD  = T.TO_YD_CD 
        AND D.TRSP_AWK_CGO_TRF_TP_CD = T.TRSP_AWK_CGO_TRF_TP_CD
        AND D.IO_GA_CD = T.IO_GA_CD
        AND D.TRSP_CRR_MOD_CD = T.TRSP_CRR_MOD_CD
        AND D.COND_NO = T.COND_NO
        AND D.TRSP_AWK_TRF_VER_NO = T.TRSP_AWK_TRF_VER_NO
        AND (D.FM_YD_CD, D.TO_YD_CD, D.TRSP_AWK_CGO_TRF_TP_CD, D.IO_GA_CD, D.TRSP_CRR_MOD_CD, D.COND_NO, D.TRSP_AWK_TRF_VER_NO) IN (
            SELECT 
            DISTINCT TD.FM_YD_CD, TD.TO_YD_CD, TD.TRSP_AWK_CGO_TRF_TP_CD, TD.IO_GA_CD, TD.TRSP_CRR_MOD_CD, TD.COND_NO, TD.TRSP_AWK_TRF_VER_NO
            FROM TRS_AWK_CGO_TRF_HDR TS, TRS_AWK_CGO_TRF_TP_SZ TD
            WHERE 1=1
            AND TS.FM_YD_CD = TD.FM_YD_CD
            AND TS.TO_YD_CD = TD.TO_YD_CD
            AND TS.TRSP_AWK_CGO_TRF_TP_CD = TD.TRSP_AWK_CGO_TRF_TP_CD
            AND TS.IO_GA_CD = TD.IO_GA_CD
            AND TS.TRSP_CRR_MOD_CD = TD.TRSP_CRR_MOD_CD
            AND TS.COND_NO = TD.COND_NO
            AND TS.TRSP_AWK_TRF_VER_NO = TD.TRSP_AWK_TRF_VER_NO
            AND SUBSTR(TS.FM_YD_CD,1,5) IN (SELECT 
                                            DISTINCT SUBSTR(TS.FM_YD_CD,1,5) PORT
                                            FROM PRI_SCQ_AWK_ROUT_DTL PD, PRI_SCQ_AWK_ROUT PR, TRS_AWK_CGO_TRF_TP_SZ TS
                                            WHERE 1=1
                                            AND PD.SCQ_RQST_NO = PR.SCQ_RQST_NO
                                            AND PD.SCQ_VER_NO = PR.SCQ_VER_NO
                                            AND PD.ROUT_SEQ = PR.ROUT_SEQ
                                            AND DECODE(PR.ROUT_TP_CD,'L','B','P','B','N','S') = TS.TRSP_AWK_CGO_TRF_TP_CD
                                            AND TS.TRSP_AWK_CGO_TRF_TP_CD = 'S'  --S로 고정
                                            AND PD.SCQ_RQST_NO = @[scq_rqst_no]
                                            AND PD.SCQ_VER_NO = @[scq_ver_no]
                                            AND PD.ROUT_SEQ = @[rout_seq]
                                            AND PD.COST_TP_CD = @[cost_tp_cd]
                                            AND 'N' = NVL(@[tmp_yn],'X')
                                            AND PD.SPCL_CGO_REF_SEQ = TS.SPCL_CGO_REF_SEQ
											UNION ALL
											SELECT 
                                            DISTINCT SUBSTR(TS.FM_YD_CD,1,5) PORT
                                            FROM PRI_SCQ_AWK_ROUT_DTL_TMP PD, PRI_SCQ_AWK_ROUT_TMP PR, TRS_AWK_CGO_TRF_TP_SZ TS
                                            WHERE 1=1
                                            AND PD.SCQ_RQST_NO = PR.SCQ_RQST_NO
                                            AND PD.SCQ_VER_NO = PR.SCQ_VER_NO
                                            AND PD.ROUT_SEQ = PR.ROUT_SEQ
                                            AND DECODE(PR.ROUT_TP_CD,'L','B','P','B','N','S') = TS.TRSP_AWK_CGO_TRF_TP_CD
                                            AND TS.TRSP_AWK_CGO_TRF_TP_CD = 'S'  --S로 고정
                                            AND PD.SCQ_RQST_NO = @[scq_rqst_no]
                                            AND PD.SCQ_VER_NO = @[scq_ver_no]
                                            AND PD.ROUT_SEQ = @[rout_seq]
                                            AND PD.COST_TP_CD = @[cost_tp_cd]
                                            AND 'Y' = NVL(@[tmp_yn],'X')
                                            AND PD.SPCL_CGO_REF_SEQ = TS.SPCL_CGO_REF_SEQ  )                                    
        )
        GROUP BY T.FM_YD_CD, T.TO_YD_CD, T.TRSP_AWK_CGO_TRF_TP_CD, T.IO_GA_CD, T.TRSP_CRR_MOD_CD, T.COND_NO
    ) X
    , (
    SELECT 
    DISTINCT T.FM_YD_CD, T.TO_YD_CD, T.TRSP_AWK_CGO_TRF_TP_CD, T.IO_GA_CD, T.TRSP_CRR_MOD_CD, T.COND_NO, T.TRSP_AWK_TRF_VER_NO
    FROM TRS_AWK_CGO_TRF_TP_SZ T
    WHERE 1=1
    AND T.SPCL_CGO_REF_SEQ IN (
        SELECT 
        DISTINCT PD.SPCL_CGO_REF_SEQ
        FROM PRI_SCQ_AWK_ROUT_DTL PD
        WHERE 1=1
        AND PD.SCQ_RQST_NO = @[scq_rqst_no]
        AND PD.SCQ_VER_NO = @[scq_ver_no]
        AND PD.ROUT_SEQ = @[rout_seq]
        AND PD.COST_TP_CD = @[cost_tp_cd]
        AND 'N' = NVL(@[tmp_yn],'X')
        UNION ALL
        SELECT 
        DISTINCT PD.SPCL_CGO_REF_SEQ
        FROM PRI_SCQ_AWK_ROUT_DTL_TMP PD
        WHERE 1=1
            AND PD.SCQ_RQST_NO = @[scq_rqst_no]
            AND PD.SCQ_VER_NO = @[scq_ver_no]
            AND PD.ROUT_SEQ = @[rout_seq]
            AND PD.COST_TP_CD = @[cost_tp_cd]
            AND 'Y' = NVL(@[tmp_yn],'X')
        )    
    ) Y    
    WHERE 1=1
    AND AD.TRSP_AWK_CGO_TRF_TP_CD = 'S'  --S로 고정
    AND AD.FM_YD_CD = X.FM_YD_CD
    AND AD.TO_YD_CD = X.TO_YD_CD
    AND AD.TRSP_AWK_CGO_TRF_TP_CD = X.TRSP_AWK_CGO_TRF_TP_CD
    AND AD.IO_GA_CD = X.IO_GA_CD
    AND AD.TRSP_CRR_MOD_CD = X.TRSP_CRR_MOD_CD
    AND AD.COND_NO = X.COND_NO 
    AND AD.TRSP_AWK_TRF_VER_NO = X.TRSP_AWK_TRF_VER_NO
    AND X.FM_YD_CD = Y.FM_YD_CD(+)
    AND X.TO_YD_CD = Y.TO_YD_CD(+)
    AND X.TRSP_AWK_CGO_TRF_TP_CD = Y.TRSP_AWK_CGO_TRF_TP_CD(+)
    AND X.IO_GA_CD = Y.IO_GA_CD(+)
    AND X.TRSP_CRR_MOD_CD = Y.TRSP_CRR_MOD_CD(+)
    AND X.COND_NO = Y.COND_NO(+)
    AND X.TRSP_AWK_TRF_VER_NO = Y.TRSP_AWK_TRF_VER_NO(+)         
) T
) K
WHERE 1=1
AND (K.RN = 1 OR K.CHK_SPCL_CGO_REF_SEQ = 'Y')
ORDER BY K.FM_LOC_CD, K.FM_NOD_YD_NO ,K.TO_LOC_CD,K.TO_NOD_YD_NO, K.TRSP_AWK_CGO_TRF_TP_CD, K.IO_GA_CD, K.TRSP_CRR_MOD_CD, K.COND_NO, K.TRSP_AWK_TRF_VER_NO DESC			]]></sql>
			<params>
				<param name="scq_rqst_no" type="12" value="" out="N"/>
				<param name="scq_ver_no" type="12" value="" out="N"/>
				<param name="rout_seq" type="12" value="" out="N"/>
				<param name="cost_tp_cd" type="12" value="" out="N"/>
				<param name="tmp_yn" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
