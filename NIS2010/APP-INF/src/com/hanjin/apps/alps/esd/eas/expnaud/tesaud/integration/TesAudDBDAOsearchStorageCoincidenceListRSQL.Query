<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TesAudDBDAOsearchStorageCoincidenceListRSQL">
			<desc><![CDATA[Storage Calculation - Coincidence 조회]]></desc>
			<sql><![CDATA[
SELECT RHQ
     , COST_OFC_CD
     , INV_OFC_CD
     , YD_CD
     , VNDR_SEQ
     , VNDR_LGL_ENG_NM
     , INV_NO
	 , CRE_USR_NM
     , BB_CGO_FLG
     , WRK_DT
     , CLM_DT
     , RAIL_BIL_DT
     , DSCR_RSN
     , HNDL_RSLT_RMK
     , CNTR_RMK
     , CRE_USR_ID
     , CRE_DT
     , UPD_USR_ID
     , UPD_DT
     , TML_SO_OFC_CTY_CD
     , TML_SO_SEQ
     , TML_SO_CNTR_LIST_SEQ
     , VRFY_RSLT_IND_CD
     , MODI_FLG
     , DSCR_IND_CD
     , TML_RVIS_IND_FLG
     , IO_BND_CD
     , IOC_CD
     , LANE_CD
     , ATB_DT
     , CNTR_NO
     , CNTR_TPSZ_CD
     , CNTR_STY_CD
     , LOCL_TS_IND_CD
     , SAM_LOCL_TS_IND_CD
     , RCVDE_TERM_IND_CD
     , PRE_YD_CD
     , INV_GATE_IN_DT
     , GATE_IN_TD_DYS
     , INV_GATE_OUT_DT
     , GATE_OUT_TD_DYS
     , INV_STAY_DYS
     , MVMT_GATE_IN_DT
     , MVMT_GATE_OUT_DT
     , MVMT_STAY_DYS
     , STAY_DIFF_DYS
     , AWK_CGO_FLG
     , RC_FLG
     , DCGO_CLSS_CD
     , ROW_NUM
     , ROW_COUNT
     , '' INV_DATE_TYPE
	 , '' TML_INV_TP_CD
	 , '' FM_PRD_DT
     , '' TO_PRD_DT
     , '' TML_INV_STS_CD
     , '' PAGE_NO
  FROM (
		SELECT	  DECODE(O.OFC_CD, 'DURBA', O.AR_HD_QTR_OFC_CD, 'DARBA', O.AR_HD_QTR_OFC_CD, 'MBABA', O.AR_HD_QTR_OFC_CD, 'AISBA', O.AR_HD_QTR_OFC_CD, DECODE(L.CONTI_CD, 'F', 'HAMUR', 'E', 'HAMUR', 'M', 'NYCNA', 'A', O.AR_HD_QTR_OFC_CD)) AS RHQ
				, TES.COST_OFC_CD			-- Cost Office
				, TES.INV_OFC_CD			-- Inv Office
				, TES.YD_CD					-- Yard
				, TES.VNDR_SEQ				-- S/P
				, V.VNDR_LGL_ENG_NM			-- S/P NAME
				, TES.INV_NO				-- INV No.
				, TES.CRE_USR_NM
				, TES.BB_CGO_FLG			-- B/B
				, TES.WRK_DT
				, TES.CLM_DT
				, TES.RAIL_BIL_DT
				, TES.DSCR_RSN
				, TES.HNDL_RSLT_RMK
				, TES.CNTR_RMK				-- Remarks
				, TES.CRE_USR_ID
				, TES.CRE_DT
				, TES.UPD_USR_ID
				, TES.UPD_DT
				, TES.TML_SO_OFC_CTY_CD
				, TES.TML_SO_SEQ
				, TES.TML_SO_CNTR_LIST_SEQ
				, TES.VRFY_RSLT_IND_CD
				, TES.MODI_FLG
				, TES.DSCR_IND_CD			-- Verify Result
				, TES.TML_RVIS_IND_FLG
				, TES.IO_BND_CD				-- I/O
				, TES.IOC_CD
				, TES.LANE_CD
				, TES.ATB_DT
				, TES.CNTR_NO				-- CNTR No.
				, TES.CNTR_TPSZ_CD			-- Type/Size
				, TES.CNTR_STY_CD			-- FM
				, TES.LOCL_TS_IND_CD		-- T/S
				, TES.SAM_LOCL_TS_IND_CD
				, TES.RCVDE_TERM_IND_CD
				, TES.PRE_YD_CD
				, TES.INV_GATE_IN_DT		-- Gate In
				, TES.GATE_IN_TD_DYS
				, TES.INV_GATE_OUT_DT		-- Gate Out
				, TES.GATE_OUT_TD_DYS		
				, TES.INV_STAY_DYS			-- Stay Days
				, TES.MVMT_GATE_IN_DT		-- MVMT Gate In
				, TES.MVMT_GATE_OUT_DT		-- MVMT Gate Out
				, TES.MVMT_STAY_DYS			-- Mvmt Stay Days
				, TES.STAY_DIFF_DYS
				, TES.AWK_CGO_FLG
				, TES.RC_FLG
				, TES.DCGO_CLSS_CD			-- DG
		        , ROW_NUMBER() OVER (ORDER BY TES.INV_NO ASC) AS ROW_NUM
		        , COUNT(TES.INV_NO) OVER() ROW_COUNT
		FROM	(SELECT
						  H.INV_OFC_CD
						, H.COST_OFC_CD
						, H.YD_CD
						, H.VNDR_SEQ
						, H.INV_NO
						, L.BB_CGO_FLG
						, L.WRK_DT
						, L.CLM_DT
						, L.RAIL_BIL_DT
						, L.DSCR_RSN
						, L.HNDL_RSLT_RMK
						, L.CNTR_RMK
						, L.CRE_USR_ID
						, TO_CHAR(H.CRE_DT, 'YYYY-MM-DD') AS CRE_DT
						, L.UPD_USR_ID
						, TO_CHAR(H.UPD_DT, 'YYYY-MM-DD') AS UPD_DT
						, L.TML_SO_OFC_CTY_CD
						, L.TML_SO_SEQ
						, L.TML_SO_CNTR_LIST_SEQ
						, L.VRFY_RSLT_IND_CD
						, L.MODI_FLG
						, L.DSCR_IND_CD
						, L.TML_RVIS_IND_FLG
						, L.IO_BND_CD
						, L.IOC_CD
						, L.LANE_CD
						, L.ATB_DT
						, L.CNTR_NO
						, L.CNTR_TPSZ_CD
						, L.CNTR_STY_CD
						, L.LOCL_TS_IND_CD
						, L.SAM_LOCL_TS_IND_CD
						, L.RCVDE_TERM_IND_CD
						, L.PRE_YD_CD
						, TO_CHAR(MVMT_GATE_IN_DT, 'YYYY-MM-DD HH24:MI') AS MVMT_GATE_IN_DT
						, TO_CHAR(INV_GATE_IN_DT, 'YYYY-MM-DD HH24:MI') AS INV_GATE_IN_DT
						, L.GATE_IN_TD_DYS
						, TO_CHAR(MVMT_GATE_OUT_DT, 'YYYY-MM-DD HH24:MI') AS MVMT_GATE_OUT_DT
						, TO_CHAR(INV_GATE_OUT_DT, 'YYYY-MM-DD HH24:MI') AS INV_GATE_OUT_DT
						, L.GATE_OUT_TD_DYS
                        , TO_DATE(TO_CHAR(L.MVMT_GATE_OUT_DT, 'YYYYMMDD') , 'YYYYMMDD') - TO_DATE(TO_CHAR(L.MVMT_GATE_IN_DT, 'YYYYMMDD'), 'YYYYMMDD')+1 AS MVMT_STAY_DYS
						-- Storage Type 
						#if (${tml_inv_tp_cd} == 'OF')
						, L.INV_STAY_DYS 
						#else
						, L.INV_STAY_DYS + 1 AS INV_STAY_DYS
						#end
						, L.STAY_DIFF_DYS
						, L.AWK_CGO_FLG
						, L.RC_FLG
						, L.DCGO_CLSS_CD
						, (SELECT USR_NM FROM COM_USER WHERE USR_ID = H.CRE_USR_ID) CRE_USR_NM
				FROM	TES_TML_SO_HDR H
						, TES_TML_SO_CNTR_LIST L
						, AP_INV_HDR A
						, COM_APRO_CSR_DTL C
						, COM_APRO_RQST_HDR R
				WHERE	1	= 1
				AND		H.TML_SO_OFC_CTY_CD	= L.TML_SO_OFC_CTY_CD
				AND		H.TML_SO_SEQ		= L.TML_SO_SEQ
				AND		L.VRFY_RSLT_IND_CD	= 'CO'
				AND		H.TML_INV_TP_CD		= @[tml_inv_tp_cd]
				--// CHM-201642099 TES Intensive Audit 검색 조건 code 추가 (2016-06-16)
				AND		H.CSR_NO			= A.CSR_NO(+)
				AND		H.CSR_NO			= C.CSR_NO(+)
				AND		C.APRO_RQST_NO		= R.APRO_RQST_NO(+)
				#if (${inv_date_type} == 'I') 	-- ISSUED DATE
				AND		H.ISS_DT BETWEEN TO_DATE(@[fm_prd_dt],'YYYY-MM-DD') AND TO_DATE(@[to_prd_dt],'YYYY-MM-DD') + 0.99999
				#elseif (${inv_date_type} == 'R')	-- RECEIVED DATE
				AND		H.RCV_DT BETWEEN TO_DATE(@[fm_prd_dt],'YYYY-MM-DD') AND TO_DATE(@[to_prd_dt],'YYYY-MM-DD') + 0.99999
				#elseif (${inv_date_type} == 'P')	-- INVOICE UPDATE DATE
				AND		H.LOCL_UPD_DT BETWEEN TO_DATE(@[fm_prd_dt],'YYYY-MM-DD') AND TO_DATE(@[to_prd_dt],'YYYY-MM-DD') + 0.99999
				#elseif (${inv_date_type} == 'A')	-- ARRROVAL REQUESTED DATE
				AND		( (R.RQST_ST_DT BETWEEN TO_DATE(@[fm_prd_dt], 'YYYY-MM-DD') AND TO_DATE(@[to_prd_dt], 'YYYY-MM-DD') + 0.99999 )
				OR		( A.CSR_APRO_STEP_ASGN_DT BETWEEN TO_DATE(@[fm_prd_dt], 'YYYY-MM-DD') AND TO_DATE(@[to_prd_dt], 'YYYY-MM-DD') + 0.99999 ) )
				#elseif (${inv_date_type} == 'C')	-- CONFIRMED DATE
				AND		H.INV_CFM_DT BETWEEN TO_DATE(@[fm_prd_dt],'YYYY-MM-DD') AND TO_DATE(@[to_prd_dt],'YYYY-MM-DD') + 0.99999
				#elseif (${inv_date_type} == 'U')	-- I/F STATUS UPDATED
				AND		( A.IF_DT BETWEEN TO_DATE(@[fm_prd_dt], 'YYYY-MM-DD') AND TO_DATE(@[to_prd_dt], 'YYYY-MM-DD') + 0.99999 )
				#end
		        #if ( ${yd_cd} != '' )
				AND		H.YD_CD		 		= @[yd_cd]
		        #end

		        #if (${io_bnd_cd} != 'A' ) 
		        AND		L.IO_BND_CD		 	= @[io_bnd_cd] 	
		        #end

				#if ( ${vndr_seq} != '' )
				AND		H.VNDR_SEQ			= @[vndr_seq]
		        #end
				#if ( ${cost_ofc_cd} != '' )
				AND		H.COST_OFC_CD		= @[cost_ofc_cd]
		        #end
				#if ( ${inv_ofc_cd} != '' )
				AND		H.INV_OFC_CD		= @[inv_ofc_cd]
		        #end
				#if ( ${tml_inv_sts_cd} != '' )
				AND		H.TML_INV_STS_CD	= @[tml_inv_sts_cd]
		        #end
		        #if ( ${vrfy_rslt_ind_cd} != '' ) 
                AND 	L.DSCR_IND_CD <> 'CO' 
                AND 	L.DSCR_IND_CD IS NOT NULL
		        #end

				) TES
				, MDM_ORGANIZATION O
				, MDM_LOCATION L
				, MDM_VENDOR V
		WHERE	1	= 1
		AND		TES.INV_OFC_CD	= O.OFC_CD(+)
		AND		O.LOC_CD     	= L.LOC_CD(+)
		AND		TES.VNDR_SEQ	= V.VNDR_SEQ(+)
		ORDER BY DECODE(O.OFC_CD, 'DURBA', O.AR_HD_QTR_OFC_CD, 'DARBA', O.AR_HD_QTR_OFC_CD, 'MBABA', O.AR_HD_QTR_OFC_CD, 'AISBA', O.AR_HD_QTR_OFC_CD, DECODE(L.CONTI_CD, 'F', 'HAMUR', 'E', 'HAMUR', 'M', 'NYCNA', 'A', O.AR_HD_QTR_OFC_CD))
		, INV_OFC_CD, COST_OFC_CD, YD_CD, VNDR_SEQ, INV_NO
)

  WHERE    ROW_NUM >= (@[pagerows] * (@[page_no] - 1) + 1)
  AND    ROW_NUM <= (@[pagerows] * @[page_no])			]]></sql>
			<params>
				<param name="tml_inv_tp_cd" type="12" value="" out="N"/>
				<param name="fm_prd_dt" type="12" value="" out="N"/>
				<param name="to_prd_dt" type="12" value="" out="N"/>
				<param name="yd_cd" type="12" value="" out="N"/>
				<param name="io_bnd_cd" type="12" value="" out="N"/>
				<param name="vndr_seq" type="12" value="" out="N"/>
				<param name="cost_ofc_cd" type="12" value="" out="N"/>
				<param name="inv_ofc_cd" type="12" value="" out="N"/>
				<param name="tml_inv_sts_cd" type="12" value="" out="N"/>
				<param name="pagerows" type="12" value="" out="N"/>
				<param name="page_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
