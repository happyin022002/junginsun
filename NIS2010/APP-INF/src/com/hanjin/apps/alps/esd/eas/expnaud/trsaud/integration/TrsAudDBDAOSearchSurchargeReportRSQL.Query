<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TrsAudDBDAOSearchSurchargeReportRSQL">
			<desc><![CDATA[Surcharge Report 데이타를 조회]]></desc>
			<sql><![CDATA[
SELECT YR_MON
      ,SO_NO
      ,WO_NO
      ,INV_NO
      ,BKG_NO
      ,EQ_NO
      ,EQ_TPSZ_CD
      ,CGO_TP_CD
      ,COST_NM
      ,CURR_CD 
      ,SCG_AMT
      ,SCG_USD_AMT
      ,INV_CURR_CD
      ,INV_SCG_AMT
      ,INV_USD_SCG_AMT
      ,TRSP_CRR_MOD_CD
      ,FM_NOD_CD
      ,VIA_NOD_CD
      ,TO_NOD_CD
      ,DOR_NOD_CD
      ,TRSP_BND_CD
      ,OTR_RMK
      ,TRSP_PURP_RSN
      ,INTER_RMK
      ,INV_OTR_RMK
      ,INV_RMK
      ,RHQ_OFC_CD
      ,SO_OFC_CD
      ,SO_USR_NM
      ,(SELECT 'Y'
          FROM TPB_OTS_GRP X
              ,TPB_OTS_DTL Y
         WHERE X.N3PTY_NO           = Y.N3PTY_NO 
           AND Y.N3PTY_EXPN_TP_CD   = 'TRS'
           AND Y.N3PTY_DELT_TP_CD IN ('N')
           AND Y.BKG_NO = AA.BKG_NO
           AND Y.EQ_NO  = AA.EQ_NO
           AND ROWNUM = 1
       ) N3PTY_BIL_FLG
      ,WO_VNDR_SEQ
      ,WO_VNDR_NM
      ,INV_VNDR_SEQ
      ,INV_VNDR_NM
      ,SC_NO
      ,RFA_NO
      ,SHIPPER
      ,CONSIGNEE
      ,LGS_COST_CD
      ,EAC_IF_FLG
      ,(SELECT CASE WHEN X.DCGO_FLG = 'Y' THEN 'DG'
                    WHEN X.BB_CGO_FLG = 'Y' THEN 'BB'
                    WHEN X.AWK_CGO_FLG= 'Y' THEN 'AK'
                    WHEN X.RC_FLG = 'Y' THEN 'RF'
                    WHEN X.RD_CGO_FLG = 'Y' THEN 'RD' END
          FROM BKG_CONTAINER X 
         WHERE X.BKG_NO  = AA.BKG_NO
           AND X.CNTR_NO = AA.EQ_NO
       ) CNTR_SPE
      ,NEGO_RMK
      ,SPCL_INSTR_RMK
  FROM (
        SELECT CASE WHEN @[s_dt_tp_cd] = 'W' THEN TO_CHAR(C.LOCL_CRE_DT, 'YYYYMM')
                    WHEN @[s_dt_tp_cd] = 'I' THEN TO_CHAR(D.INV_CFM_DT, 'YYYYMM')            
               END YR_MON
              ,A.TRSP_SO_OFC_CTY_CD||A.TRSP_SO_SEQ AS SO_NO
              ,A.TRSP_WO_OFC_CTY_CD||A.TRSP_WO_SEQ AS WO_NO
              ,A.INV_NO
              ,A.BKG_NO
              ,A.EQ_NO
              ,A.EQ_TPSZ_CD
              ,A.CGO_TP_CD
              ,(SELECT X.LGS_COST_FULL_NM FROM TES_LGS_COST X WHERE X.LGS_COST_CD = B.LGS_COST_CD) AS COST_NM
              ,A.CURR_CD
              ,B.SCG_AMT -- W/O SURCHARGE
              ,ROUND (B.SCG_AMT / 
                     CASE WHEN NVL(A.CURR_CD,'USD') = 'USD' THEN 1
                          ELSE 
                          (SELECT USD_LOCL_XCH_RT
                             FROM GL_MON_XCH_RT XCH
                            WHERE XCH.ACCT_XCH_RT_LVL = 1 
                              AND XCH.CURR_CD           = A.CURR_CD
                              AND XCH.ACCT_XCH_RT_YRMON = NVL(TO_CHAR(C.LOCL_CRE_DT,'YYYYMM'),TO_CHAR (A.LOCL_CRE_DT, 'YYYYMM')))
                           END
                     , 2) SCG_USD_AMT
              ,A.INV_CURR_CD
              ,B.INV_SCG_AMT
              ,ROUND (B.INV_SCG_AMT / 
                     CASE WHEN NVL(A.CURR_CD,'USD') = 'USD' THEN 1
                          ELSE 
                          (SELECT USD_LOCL_XCH_RT
                             FROM GL_MON_XCH_RT XCH
                            WHERE XCH.ACCT_XCH_RT_LVL = 1 
                              AND XCH.CURR_CD           = A.INV_CURR_CD
                              AND XCH.ACCT_XCH_RT_YRMON = TO_CHAR(D.LOCL_CRE_DT,'YYYYMM'))
                           END
                     , 2) INV_USD_SCG_AMT
              ,A.TRSP_CRR_MOD_CD
              ,A.FM_NOD_CD
              ,A.VIA_NOD_CD
              ,A.TO_NOD_CD
              ,A.DOR_NOD_CD
              ,A.TRSP_BND_CD      
              ,B.OTR_RMK             -- W/O Surcharge - Other Surcharge Remark
              ,A.TRSP_PURP_RSN         -- W/O Surcharge - Remark
              ,A.INTER_RMK             -- W/O Surcharge - Internal Remark
              ,B.INV_OTR_RMK         -- Invoice Surcharge - Other Surcharge Remark
              ,A.INV_RMK             -- Invoice Surcharge - Inv Remark
              ,TRS_COMMON_PKG.TRS_GET_RHQ_OFC_CD(A.CRE_OFC_CD) RHQ_OFC_CD
              ,A.CRE_OFC_CD AS SO_OFC_CD
              ,(SELECT X.USR_NM FROM COM_USER X WHERE X.USR_ID = C.CRE_USR_ID) AS SO_USR_NM
              ,WVDR.VNDR_SEQ     AS WO_VNDR_SEQ
              ,WVDR.VNDR_LGL_ENG_NM AS WO_VNDR_NM
              ,IVDR.VNDR_SEQ     AS INV_VNDR_SEQ
              ,IVDR.VNDR_LGL_ENG_NM AS INV_VNDR_NM 
              ,(SELECT BKG.SC_NO
                  FROM BKG_BOOKING BKG     
                 WHERE BKG.BKG_NO = A.BKG_NO) SC_NO
              ,(SELECT BKG.RFA_NO 
                  FROM BKG_BOOKING BKG     
                 WHERE BKG.BKG_NO = A.BKG_NO) RFA_NO
              ,(SELECT REPLACE (CUST_NM, CHR (13) || CHR (10),' ')
                  FROM BKG_CUSTOMER CUST
                 WHERE CUST.BKG_NO = A.BKG_NO
                   AND CUST.BKG_CUST_TP_CD = 'S' ) AS SHIPPER
              ,(SELECT REPLACE (CUST_NM, CHR (13) || CHR (10),' ')
                  FROM BKG_CUSTOMER CUST
                 WHERE CUST.BKG_NO = A.BKG_NO
                   AND CUST.BKG_CUST_TP_CD = 'C' ) AS CONSIGNEE
              ,B.LGS_COST_CD
              ,(SELECT 'Y'
                  FROM EAS_TRSP_COST_CHK X
                 WHERE X.TRSP_SO_OFC_CTY_CD = A.TRSP_SO_OFC_CTY_CD
                   AND X.TRSP_SO_SEQ        = A.TRSP_SO_SEQ
                   AND X.EAC_SYS_IF_CD      = 'TR2'
                   AND X.LGS_COST_CD        = B.LGS_COST_CD
               ) EAC_IF_FLG
              ,A.NEGO_RMK
              ,A.SPCL_INSTR_RMK
          FROM TRS_TRSP_SVC_ORD A  
              ,TRS_TRSP_SCG_DTL B
              ,TRS_TRSP_WRK_ORD C
              ,TRS_TRSP_INV_WRK D
              ,MDM_VENDOR WVDR
              ,MDM_VENDOR IVDR
         WHERE A.TRSP_SO_OFC_CTY_CD = B.TRSP_SO_OFC_CTY_CD
           AND A.TRSP_SO_SEQ        = B.TRSP_SO_SEQ
           AND A.TRSP_WO_OFC_CTY_CD = C.TRSP_WO_OFC_CTY_CD(+)
           AND A.TRSP_WO_SEQ        = C.TRSP_WO_SEQ(+)
           AND A.INV_NO             = D.INV_NO(+)
           AND A.INV_VNDR_SEQ       = D.INV_VNDR_SEQ(+)
           /*
           AND WVDR.VNDR_SEQ = CASE WHEN A.HJL_NO IS NOT NULL THEN (SELECT X.HJL_VNDR_SEQ FROM TRS_TRSP_HJL_SVC_ORD X WHERE X.TRSP_SO_OFC_CTY_CD = A.TRSP_SO_OFC_CTY_CD AND X.TRSP_SO_SEQ = A.TRSP_SO_SEQ)
                                    ELSE A.VNDR_SEQ
                               END
           AND IVDR.VNDR_SEQ = CASE WHEN A.HJL_NO IS NOT NULL THEN (SELECT X.HJL_INV_VNDR_SEQ FROM TRS_TRSP_HJL_SVC_ORD X WHERE X.TRSP_SO_OFC_CTY_CD = A.TRSP_SO_OFC_CTY_CD AND X.TRSP_SO_SEQ = A.TRSP_SO_SEQ)
                                    ELSE A.INV_VNDR_SEQ
                               END
           */
           AND WVDR.VNDR_SEQ = A.VNDR_SEQ
           AND IVDR.VNDR_SEQ(+) = A.INV_VNDR_SEQ

           #if (${s_ofc_tp_cd} == 'W' && ${s_dt_tp_cd} == 'W' && ${s_ofc_cd} == '')
                AND C.CRE_OFC_CD IN (SELECT OFC_CD 
                                       FROM MDM_ORGANIZATION
                                      WHERE DELT_FLG = 'N'
                                    CONNECT BY NOCYCLE PRIOR OFC_CD = PRNT_OFC_CD
                                      START WITH OFC_CD = @[s_rhq_ofc_cd]
                                    )
           #end

           #if ((${s_ofc_tp_cd} == 'I' || ${s_dt_tp_cd} == 'I') && ${s_ofc_cd} == '')
                AND 1=2
           #end 

           #if (${s_ofc_tp_cd} == 'W' && ${s_ofc_cd} != '')
                AND C.CRE_OFC_CD = @[s_ofc_cd]
           #elseif (${s_ofc_tp_cd} == 'I' && ${s_ofc_cd} != '')
                AND D.CRE_OFC_CD = @[s_ofc_cd]
           #end
           
           #if (${s_dt_tp_cd} == 'W')
                AND C.LOCL_CRE_DT BETWEEN TO_DATE (REPLACE(@[s_fm_dt],'-',''), 'rrrrmmdd') AND TO_DATE (REPLACE(@[s_to_dt],'-',''), 'rrrrmmdd') + 0.999999 -- s_dt_tp_cd = 'W' 일 경우 (Work order Date)
           #elseif (${s_dt_tp_cd} == 'I')
                AND D.INV_CFM_DT BETWEEN TO_DATE (REPLACE(@[s_fm_dt],'-',''), 'rrrrmmdd') AND TO_DATE (REPLACE(@[s_to_dt],'-',''), 'rrrrmmdd') + 0.999999 -- s_dt_tp_cd = 'I' 일 경우 (Invoice Date)
           #end
           
           #if (${s_trns_mod_cd} != '')
                AND A.TRSP_CRR_MOD_CD = @[s_trns_mod_cd]
           #end
           #if($s_scg_cd.size() > 0) 
                AND (
                    #foreach( ${key} in ${s_scg_cd}) 
                        #if($velocityCount == 1)
                              #if ($key.length() == 4)
                                SUBSTR(B.LGS_COST_CD, 3,4)= '$key'
                            #else
                                SUBSTR(B.LGS_COST_CD, 3,2)= '$key'
                            #end
                        #else
                            #if ($key.length() == 4)
                                OR SUBSTR(B.LGS_COST_CD, 3,4)= '$key'
                            #else
                                OR SUBSTR(B.LGS_COST_CD, 3,2)= '$key'
                            #end
                        #end 
                    #end
                   )
           #end

           #if (${s_cgo_tp_cd} != '')
                AND A.CGO_TP_CD = @[s_cgo_tp_cd]
           #end
           
           #if (${s_srch_opt_cd} == 'WP') 
                AND NVL(B.SCG_AMT,0) > 0
           #elseif (${s_srch_opt_cd} == 'WM')
                AND NVL(B.SCG_AMT,0) < 0
           #elseif (${s_srch_opt_cd} == 'WN')
                AND NVL(B.SCG_AMT,0) <> 0
           #elseif (${s_srch_opt_cd} == 'IP')                
                AND NVL(B.INV_SCG_AMT,0) > 0
           #elseif (${s_srch_opt_cd} == 'IM')                
                AND NVL(B.INV_SCG_AMT,0) < 0
           #elseif (${s_srch_opt_cd} == 'IN')
                AND NVL(B.INV_SCG_AMT,0) <> 0
           #elseif (${s_srch_opt_cd} == 'NR')
               #if (${s_ofc_tp_cd} == 'W')
                   AND ( TRIM(B.OTR_RMK) IS NULL AND TRIM(A.SPCL_INSTR_RMK) IS NULL AND TRIM(A.INTER_RMK) IS NULL AND TRIM(A.NEGO_RMK) IS NULL)
               #elseif (${s_ofc_tp_cd} == 'I')
                   AND ( TRIM(A.INV_RMK) IS NULL AND TRIM(B.INV_OTR_RMK) IS NULL )
               #end
           #end
        UNION ALL
        SELECT TO_CHAR(C.LOCL_CRE_DT, 'YYYYMM') YR_MON
              ,A.TRSP_SO_OFC_CTY_CD||A.TRSP_SO_SEQ AS SO_NO
              ,A.TRSP_WO_OFC_CTY_CD||A.TRSP_WO_SEQ AS WO_NO
              ,A.INV_NO
              ,A.BKG_NO
              ,A.EQ_NO
              ,A.EQ_TPSZ_CD
              ,A.CGO_TP_CD
              ,'Nego' AS COST_NM
              ,A.CURR_CD
              ,A.NEGO_AMT                     -- W/O SURCHARGE
              ,ROUND (A.NEGO_AMT / 
                     CASE WHEN NVL(A.CURR_CD,'USD') = 'USD' THEN 1
                          ELSE 
                          (SELECT USD_LOCL_XCH_RT
                             FROM GL_MON_XCH_RT XCH
                            WHERE XCH.ACCT_XCH_RT_LVL = 1 
                              AND XCH.CURR_CD           = A.CURR_CD
                              AND XCH.ACCT_XCH_RT_YRMON = NVL(TO_CHAR(C.LOCL_CRE_DT,'YYYYMM'),TO_CHAR (A.LOCL_CRE_DT, 'YYYYMM')))
                           END
                     , 2) SCG_USD_AMT
              ,'' INV_CURR_CD
              ,NULL INV_SCG_AMT
              ,NULL INV_USD_SCG_AMT
              ,A.TRSP_CRR_MOD_CD
              ,A.FM_NOD_CD
              ,A.VIA_NOD_CD
              ,A.TO_NOD_CD
              ,A.DOR_NOD_CD
              ,A.TRSP_BND_CD      
              ,NULL OTR_RMK                 -- W/O Surcharge - Other Surcharge Remark
              ,A.TRSP_PURP_RSN                 -- W/O Surcharge - Remark
              ,A.INTER_RMK                     -- W/O Surcharge - Internal Remark
              ,NULL INV_OTR_RMK             -- Invoice Surcharge - Other Surcharge Remark
              ,A.INV_RMK                     -- Invoice Surcharge - Inv Remark
              ,TRS_COMMON_PKG.TRS_GET_RHQ_OFC_CD(A.CRE_OFC_CD) RHQ_OFC_CD
              ,A.CRE_OFC_CD AS SO_OFC_CD
              ,(SELECT X.USR_NM FROM COM_USER X WHERE X.USR_ID = A.UPD_USR_ID) AS SO_USR_NM
              ,WVDR.VNDR_SEQ     AS WO_VNDR_SEQ
              ,WVDR.VNDR_ABBR_NM AS WO_VNDR_NM
              ,IVDR.VNDR_SEQ     AS INV_VNDR_SEQ
              ,IVDR.VNDR_ABBR_NM AS INV_VNDR_NM 
              ,(SELECT BKG.SC_NO
                  FROM BKG_BOOKING BKG     
                 WHERE BKG.BKG_NO = A.BKG_NO) SC_NO
              ,(SELECT BKG.RFA_NO 
                  FROM BKG_BOOKING BKG     
                 WHERE BKG.BKG_NO = A.BKG_NO) RFA_NO
              ,(SELECT REPLACE (CUST_NM, CHR (13) || CHR (10),' ')
                  FROM BKG_CUSTOMER CUST
                 WHERE CUST.BKG_NO = A.BKG_NO
                   AND CUST.BKG_CUST_TP_CD = 'S' ) AS SHIPPER
              ,(SELECT REPLACE (CUST_NM, CHR (13) || CHR (10),' ')
                  FROM BKG_CUSTOMER CUST
                 WHERE CUST.BKG_NO = A.BKG_NO
                   AND CUST.BKG_CUST_TP_CD = 'C' ) AS CONSIGNEE
              ,A.LGS_COST_CD
              ,(SELECT 'Y'
                  FROM EAS_TRSP_COST_CHK X
                 WHERE X.TRSP_SO_OFC_CTY_CD = A.TRSP_SO_OFC_CTY_CD
                   AND X.TRSP_SO_SEQ        = A.TRSP_SO_SEQ
                   AND X.EAC_SYS_IF_CD      = 'TR2'
                   AND X.LGS_COST_CD        = A.LGS_COST_CD
               ) EAC_IF_FLG
              ,A.NEGO_RMK
              ,A.SPCL_INSTR_RMK
          FROM TRS_TRSP_SVC_ORD A  
              ,TRS_TRSP_WRK_ORD C
              ,TRS_TRSP_INV_WRK D
              ,MDM_VENDOR WVDR
              ,MDM_VENDOR IVDR
         WHERE A.TRSP_WO_OFC_CTY_CD = C.TRSP_WO_OFC_CTY_CD(+)
           AND A.TRSP_WO_SEQ        = C.TRSP_WO_SEQ(+)
           AND A.INV_NO             = D.INV_NO(+)
           AND A.INV_VNDR_SEQ       = D.INV_VNDR_SEQ(+)
           /*
           AND WVDR.VNDR_SEQ = CASE WHEN A.HJL_NO IS NOT NULL THEN (SELECT X.HJL_VNDR_SEQ FROM TRS_TRSP_HJL_SVC_ORD X WHERE X.TRSP_SO_OFC_CTY_CD = A.TRSP_SO_OFC_CTY_CD AND X.TRSP_SO_SEQ = A.TRSP_SO_SEQ)
                                    ELSE A.VNDR_SEQ
                               END
           AND IVDR.VNDR_SEQ = CASE WHEN A.HJL_NO IS NOT NULL THEN (SELECT X.HJL_INV_VNDR_SEQ FROM TRS_TRSP_HJL_SVC_ORD X WHERE X.TRSP_SO_OFC_CTY_CD = A.TRSP_SO_OFC_CTY_CD AND X.TRSP_SO_SEQ = A.TRSP_SO_SEQ)
                                    ELSE A.INV_VNDR_SEQ
                               END
           */
           AND WVDR.VNDR_SEQ = A.VNDR_SEQ
           AND IVDR.VNDR_SEQ(+) = A.INV_VNDR_SEQ

           #if (${s_ofc_tp_cd} == 'W' && ${s_dt_tp_cd} == 'W' && ${s_ofc_cd} == '')
                AND C.CRE_OFC_CD IN (SELECT OFC_CD 
                                       FROM MDM_ORGANIZATION
                                      WHERE DELT_FLG = 'N'
                                    CONNECT BY NOCYCLE PRIOR OFC_CD = PRNT_OFC_CD
                                      START WITH OFC_CD = @[s_rhq_ofc_cd]
                                    )
           #end

           #if ((${s_ofc_tp_cd} == 'I' || ${s_dt_tp_cd} == 'I') && ${s_ofc_cd} == '')
                AND 1=2
           #end 

           #if (${s_ofc_tp_cd} == 'W' && ${s_ofc_cd} != '')
                AND C.CRE_OFC_CD = @[s_ofc_cd]
           #elseif (${s_ofc_tp_cd} == 'I' && ${s_ofc_cd} != '')
                AND D.CRE_OFC_CD = @[s_ofc_cd]
           #end
  
           #if (${s_dt_tp_cd} == 'W')
                AND C.LOCL_CRE_DT BETWEEN TO_DATE (REPLACE(@[s_fm_dt],'-',''), 'rrrrmmdd') AND TO_DATE (REPLACE(@[s_to_dt],'-',''), 'rrrrmmdd') + 0.999999 -- s_dt_tp_cd = 'W' 일 경우 (Work order Date)
           #elseif (${s_dt_tp_cd} == 'I')
                AND D.INV_CFM_DT BETWEEN TO_DATE (REPLACE(@[s_fm_dt],'-',''), 'rrrrmmdd') AND TO_DATE (REPLACE(@[s_to_dt],'-',''), 'rrrrmmdd') + 0.999999 -- s_dt_tp_cd = 'I' 일 경우 (Invoice Date)
           #end

           AND NVL(A.NEGO_AMT,0) <> 0
           
           #if (${s_trns_mod_cd} != '')
                AND A.TRSP_CRR_MOD_CD = @[s_trns_mod_cd]
           #end
           #if($s_scg_cd.size() > 0) 
                AND (
                    #foreach( ${key} in ${s_scg_cd})
                        #if($velocityCount == 1)
                              #if ($key == 'NE')
                                'NE' = '$key'
                            #else
                                1=2
                            #end
                        #else
                            #if ($key == 'NE')
                                OR 'NE' = '$key'
                            #else
                                OR 1=2
                            #end
                        #end 
                    #end
                   )
           #end

           #if (${s_cgo_tp_cd} != '')
                AND A.CGO_TP_CD = @[s_cgo_tp_cd]
           #end
           
           #if (${s_srch_opt_cd} == 'WP') 
                AND NVL(A.NEGO_AMT,0) > 0
           #elseif (${s_srch_opt_cd} == 'WM')     
                AND NVL(A.NEGO_AMT,0) < 0
           #elseif (${s_srch_opt_cd} == 'WN')          
                AND NVL(A.NEGO_AMT,0) <> 0
           #elseif (${s_srch_opt_cd} == 'IP')                
                AND 1=2
           #elseif (${s_srch_opt_cd} == 'IM')                
                AND 1=2
           #elseif (${s_srch_opt_cd} == 'IN')
                AND 1=2
           #elseif (${s_srch_opt_cd} == 'NR')
               #if (${s_ofc_tp_cd} == 'W')
                   AND ( TRIM(A.SPCL_INSTR_RMK) IS NULL AND TRIM(A.INTER_RMK) IS NULL AND TRIM(A.NEGO_RMK) IS NULL)
               #elseif (${s_ofc_tp_cd} == 'I')
                   AND ( TRIM(A.INV_RMK) IS NULL )
               #end
           #end
) AA
WHERE 1=1
    #if (${s_eac_if} != '')
        #if (${s_eac_if} == 'Y')
           AND EAC_IF_FLG = @[s_eac_if]
        #else
           AND EAC_IF_FLG IS NULL
        #end
    #end			]]></sql>
			<params>
				<param name="s_dt_tp_cd" type="12" value="" out="N"/>
				<param name="s_rhq_ofc_cd" type="12" value="" out="N"/>
				<param name="s_ofc_cd" type="12" value="" out="N"/>
				<param name="s_fm_dt" type="12" value="" out="N"/>
				<param name="s_to_dt" type="12" value="" out="N"/>
				<param name="s_trns_mod_cd" type="12" value="" out="N"/>
				<param name="s_cgo_tp_cd" type="12" value="" out="N"/>
				<param name="s_eac_if" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
