<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TESeBillingManageBizType002DBDAOGetEDInvoiceToUpdateDtlVVDRSQL">
			<desc><![CDATA[정규 VVD가 없어서 CALL SIGN / LLOYD CD / BKG REF NO로 VVD Update해야 할 DTL 대상 조회]]></desc>
			<sql><![CDATA[
SELECT 
    Y.TML_EDI_SO_OFC_CTY_CD, Y.TML_EDI_SO_SEQ, Y.TML_EDI_SO_DTL_SEQ, 
    CASE
    WHEN Y.VVD IS NOT NULL AND LENGTH(Y.VVD) = 9
    THEN SUBSTR(Y.VVD,1,4)
    ELSE ''
    END VSL_CD,
    CASE
    WHEN Y.VVD IS NOT NULL AND LENGTH(Y.VVD) = 9
    THEN SUBSTR(Y.VVD,5,4)
    ELSE ''
    END SKD_VOY_NO,
    CASE
    WHEN Y.VVD IS NOT NULL AND LENGTH(Y.VVD) = 9
    THEN SUBSTR(Y.VVD,9)
    ELSE ''
    END SKD_DIR_CD,
    Y.VVD_SRC CALC_RMK
FROM (
SELECT
    X.TML_EDI_SO_OFC_CTY_CD, X.TML_EDI_SO_SEQ, X.TML_EDI_SO_DTL_SEQ, 
    CASE
    WHEN X.ORG_VVD IS NOT NULL AND LENGTH(X.ORG_VVD) = 9
    THEN X.ORG_VVD
    ELSE     
        CASE
        WHEN X.SKD_EDI_LOG_VVD IS NOT NULL AND LENGTH(X.SKD_EDI_LOG_VVD) = 9
        THEN X.SKD_EDI_LOG_VVD
        WHEN X.BKG_NO_VVD IS NOT NULL AND LENGTH(X.BKG_NO_VVD) = 9
        THEN X.BKG_NO_VVD
        WHEN X.BKG_CNTR_VVD IS NOT NULL AND LENGTH(X.BKG_CNTR_VVD) = 9
        THEN X.BKG_CNTR_VVD
        WHEN X.BKG_REF_VVD IS NOT NULL AND LENGTH(X.BKG_REF_VVD) = 9
        THEN X.BKG_REF_VVD
        WHEN X.MST_CNTR_VVD IS NOT NULL AND LENGTH(X.MST_CNTR_VVD) = 9
        THEN X.MST_CNTR_VVD
        WHEN X.PORT_SKD_VVD IS NOT NULL AND LENGTH(X.PORT_SKD_VVD) = 9
        THEN X.PORT_SKD_VVD
        END
    END VVD,
    CASE
    WHEN X.ORG_VVD IS NOT NULL AND LENGTH(X.ORG_VVD) = 9
    THEN 'ORG_VVD'
    ELSE     
        CASE
        WHEN X.SKD_EDI_LOG_VVD IS NOT NULL AND LENGTH(X.SKD_EDI_LOG_VVD) = 9
        THEN 'SKD_EDI_LOG_VVD'
        WHEN X.BKG_NO_VVD IS NOT NULL AND LENGTH(X.BKG_NO_VVD) = 9
        THEN 'BKG_NO_VVD'
        WHEN X.BKG_CNTR_VVD IS NOT NULL AND LENGTH(X.BKG_CNTR_VVD) = 9
        THEN 'BKG_CNTR_VVD'
        WHEN X.BKG_REF_VVD IS NOT NULL AND LENGTH(X.BKG_REF_VVD) = 9
        THEN 'BKG_REF_VVD'
        WHEN X.MST_CNTR_VVD IS NOT NULL AND LENGTH(X.MST_CNTR_VVD) = 9
        THEN 'MST_CNTR_VVD'
        WHEN X.PORT_SKD_VVD IS NOT NULL AND LENGTH(X.PORT_SKD_VVD) = 9
        THEN 'PORT_SKD_VVD'
        END
    END VVD_SRC    
FROM (
SELECT 
    D.TML_EDI_SO_OFC_CTY_CD, D.TML_EDI_SO_SEQ, D.TML_EDI_SO_DTL_SEQ, D.VSL_CD||D.SKD_VOY_NO||D.SKD_DIR_CD ORG_VVD, D.MDM_VSL_CD,
    (
        SELECT 
        V.VSL_CD||V.SKD_VOY_NO||V.SKD_DIR_CD VVD
        FROM VSK_ACT_PORT_SKD_EDI_LOG V
        WHERE 1=1
        AND V.RCV_DT >= TO_DATE('190001010000','YYYYMMDDHH24MI')
        AND V.RCV_SEQ >= 1
        AND V.YD_CD = D.YD_CD
        AND NVL(V.SCS_FLG,'N')='Y'    
        AND NVL(V.CALL_SGN_NO,'N') = NVL(D.CALL_SGN_NO,'N')
        AND NVL(V.LLOYD_NO,'N') = NVL(D.LLOYD_NO,'N')
        AND ROWNUM = 1
    ) SKD_EDI_LOG_VVD
    ,
    (
        SELECT 
        V.VSL_CD||V.SKD_VOY_NO||V.SKD_DIR_CD VVD
        FROM BKG_BOOKING B, BKG_VVD V
        WHERE 1=1
        AND B.BKG_NO = V.BKG_NO(+)
        AND B.BKG_NO = D.BKG_NO
        AND B.BKG_STS_CD IN ('F','W')
        AND DECODE(D.IO_BND_CD,'I',V.POD_CD,V.POL_CD) = SUBSTR(D.YD_CD,1, 5)
        AND CASE
            WHEN (D.CALL_SGN_NO IS NOT NULL OR D.LLOYD_NO IS NOT NULL OR D.VSL_NM IS NOT NULL)
            THEN NVL(V.VSL_CD,'X')
            ELSE 'X'
            END =
            CASE
            WHEN (D.CALL_SGN_NO IS NOT NULL OR D.LLOYD_NO IS NOT NULL OR D.VSL_NM IS NOT NULL)
            THEN NVL(D.MDM_VSL_CD,'X')
            ELSE 'N' --//VSL_CD를 정확히 못찾으면 버려야함
            END
        AND ROWNUM = 1
    ) BKG_NO_VVD
    ,
    (
        SELECT 
        V.VSL_CD||V.SKD_VOY_NO||V.SKD_DIR_CD VVD
        FROM BKG_BOOKING B, BKG_CONTAINER C, BKG_VVD V
        WHERE 1=1
        AND DECODE(D.IO_BND_CD,'I',V.POD_CD,V.POL_CD) = SUBSTR(D.YD_CD,1, 5)
        AND B.BKG_NO = C.BKG_NO(+)
        AND C.BKG_NO = V.BKG_NO(+)
        AND B.BKG_STS_CD IN ('F','W')
        AND C.CNTR_NO = D.CNTR_NO
        AND CASE
            WHEN (D.CALL_SGN_NO IS NOT NULL OR D.LLOYD_NO IS NOT NULL OR D.VSL_NM IS NOT NULL)
            THEN NVL(V.VSL_CD,'X')
            ELSE 'X'
            END =
            CASE
            WHEN (D.CALL_SGN_NO IS NOT NULL OR D.LLOYD_NO IS NOT NULL OR D.VSL_NM IS NOT NULL)
            THEN NVL(D.MDM_VSL_CD,'X')
            ELSE 'N' --//VSL_CD를 정확히 못찾으면 버려야함
            END
        AND ROWNUM = 1  
    ) BKG_CNTR_VVD
    ,    
    (
        SELECT 
        DISTINCT 
        V.VSL_CD||V.SKD_VOY_NO||V.SKD_DIR_CD VVD
        FROM BKG_REFERENCE R, BKG_VVD V
        WHERE R.BKG_NO = V.BKG_NO 
        AND R.CUST_REF_NO_CTNT = D.CUST_REF_NO_CTNT
        AND DECODE(D.IO_BND_CD,'I',V.POD_CD,V.POL_CD) = SUBSTR(D.YD_CD,1, 5)
        AND CASE
            WHEN (D.CALL_SGN_NO IS NOT NULL OR D.LLOYD_NO IS NOT NULL OR D.VSL_NM IS NOT NULL)
            THEN NVL(V.VSL_CD,'X')
            ELSE 'X'
            END =
            CASE
            WHEN (D.CALL_SGN_NO IS NOT NULL OR D.LLOYD_NO IS NOT NULL OR D.VSL_NM IS NOT NULL)
            THEN NVL(D.MDM_VSL_CD,'X')
            ELSE 'N' --//VSL_CD를 정확히 못찾으면 버려야함
            END
        AND ROWNUM = 1  
    ) BKG_REF_VVD
    ,    
    (
        SELECT M.VSL_CD||M.SKD_VOY_NO||M.SKD_DIR_CD VVD
        FROM MST_CONTAINER M
        WHERE 1=1
        AND M.CNTR_NO = D.CNTR_NO
        AND CASE
            WHEN (D.CALL_SGN_NO IS NOT NULL OR D.LLOYD_NO IS NOT NULL OR D.VSL_NM IS NOT NULL)
            THEN NVL(M.VSL_CD,'X')
            ELSE 'X'
            END =
            CASE
            WHEN (D.CALL_SGN_NO IS NOT NULL OR D.LLOYD_NO IS NOT NULL OR D.VSL_NM IS NOT NULL)
            THEN NVL(D.MDM_VSL_CD,'X')            
            ELSE 'X' --//VSL_CD를 정확히 못찾아도 CONTAINER NO.별로 유일함에 넘긴다.
            END
        AND ROWNUM = 1
    ) MST_CNTR_VVD
    ,
    (
        SELECT 
        P.VSL_CD||P.SKD_VOY_NO||P.SKD_DIR_CD VVD
        FROM VSK_VSL_PORT_SKD P
        WHERE 1=1
        AND P.YD_CD = D.YD_CD
        AND P.VPS_ETA_DT BETWEEN TO_DATE(D.ATA_DT,'YYYYMMDD') AND  TO_DATE(D.ATA_DT,'YYYYMMDD') + 0.99999
        AND CASE
            WHEN (D.CALL_SGN_NO IS NOT NULL OR D.LLOYD_NO IS NOT NULL OR D.VSL_NM IS NOT NULL)
            THEN NVL(P.VSL_CD,'X')
            ELSE 'X'
            END =
            CASE
            WHEN (D.CALL_SGN_NO IS NOT NULL OR D.LLOYD_NO IS NOT NULL OR D.VSL_NM IS NOT NULL)
            THEN NVL(D.MDM_VSL_CD,'X')            
            ELSE 'N' --//VSL_CD를 정확히 못찾으면 버려야함
            END
        AND ROWNUM = 1
    ) PORT_SKD_VVD
    , D.CNTR_NO, D.YD_CD, D.IO_BND_CD
FROM (
SELECT 
    H.YD_CD, D.*, 
    (SELECT DISTINCT V.VSL_CD FROM MDM_VSL_CNTR V 
    WHERE (V.CALL_SGN_NO=D.CALL_SGN_NO OR V.LLOYD_NO=D.LLOYD_NO OR UPPER(V.VSL_ENG_NM)=UPPER(D.VSL_NM))
    AND V.EAI_EVNT_DT = (
        SELECT MAX(V2.EAI_EVNT_DT)
        FROM MDM_VSL_CNTR V2 WHERE (V2.CALL_SGN_NO=D.CALL_SGN_NO OR V2.LLOYD_NO=D.LLOYD_NO OR UPPER(V2.VSL_ENG_NM)=UPPER(D.VSL_NM))
        AND NVL(V2.DELT_FLG,'N') <> 'Y')
    AND ROWNUM = 1) MDM_VSL_CD
FROM TES_EDI_SO_HDR H, TES_EDI_SO_DTL D
WHERE 1=1
AND H.TML_EDI_SO_OFC_CTY_CD = D.TML_EDI_SO_OFC_CTY_CD
AND H.TML_EDI_SO_SEQ = D.TML_EDI_SO_SEQ
AND NVL(H.DELT_FLG,'N') <> 'Y'
AND H.TML_INV_TP_CD = 'TM'
AND H.TML_SO_OFC_CTY_CD IS NULL
AND H.TML_SO_SEQ IS NULL
AND (  D.VSL_CD IS NULL OR D.SKD_VOY_NO IS NULL OR D.SKD_DIR_CD IS NULL OR NVL(LENGTH(D.VSL_CD||D.SKD_VOY_NO||D.SKD_DIR_CD),0) <> 9  )
AND H.TML_EDI_SO_OFC_CTY_CD = @[tml_edi_so_ofc_cty_cd]
AND H.TML_EDI_SO_SEQ = @[tml_edi_so_seq]
) D
) X
) Y			]]></sql>
			<params>
				<param name="tml_edi_so_ofc_cty_cd" type="12" value="" out="N"/>
				<param name="tml_edi_so_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
