<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TrsAudDBDAOSearchSurchargeRailReportRSQL">
			<desc><![CDATA[USA Rail Surcharge Report 데이타를 조회]]></desc>
			<sql><![CDATA[
SELECT YR_MON
      ,SO_NO
      ,SUB_RAIL_SEQ
      ,WO_NO
      ,INV_NO
      ,BKG_NO
      ,EQ_NO
      ,EQ_TPSZ_CD
      ,CGO_TP_CD
      ,(SELECT X.LGS_COST_FULL_NM FROM TES_LGS_COST X WHERE X.LGS_COST_CD = AAA.LGS_COST_CD) AS COST_NM
      ,CURR_CD
      ,SCG_AMT
      ,ROUND(SCG_AMT / XCH_RT, 2) AS SCG_USD_AMT
      ,INV_CURR_CD
      ,INV_SCG_AMT
      ,ROUND(INV_SCG_AMT / XCH_RT, 2) AS INV_USD_SCG_AMT
      ,TRSP_CRR_MOD_CD
      ,FM_NOD_CD
      ,VIA_NOD_CD
      ,TO_NOD_CD
      ,DOR_NOD_CD
      ,TRSP_BND_CD
      ,OTR_RMK
      ,TRSP_PURP_RSN
      ,INTER_RMK
      ,INV_OTR_RMK
      ,INV_RMK
      ,RHQ_OFC_CD
      ,SO_OFC_CD
      ,SO_USR_NM
      ,WO_VNDR_SEQ
      ,WO_VNDR_NM
      ,INV_VNDR_SEQ
      ,INV_VNDR_NM
      ,SC_NO
      ,RFA_NO
      ,SHIPPER
      ,CONSIGNEE
      ,LGS_COST_CD
      ,(SELECT 'Y'
          FROM EAS_TRSP_COST_CHK X
         WHERE X.TRSP_SO_OFC_CTY_CD = AAA.TRSP_SO_OFC_CTY_CD
           AND X.TRSP_SO_SEQ        = AAA.TRSP_SO_SEQ
           AND X.EAC_SYS_IF_CD      = 'TR2'
           AND X.LGS_COST_CD        = AAA.LGS_COST_CD
           AND X.SUB_RAIL_SEQ       = AAA.SUB_RAIL_SEQ
       ) EAC_IF_FLG
      ,NEGO_RMK
      ,SPCL_INSTR_RMK
      ,DIFF_BTWN_AMT
  FROM (
        SELECT AA.*
              ,BB.NUM
              ,NVL(CASE WHEN BB.NUM = 1 THEN AA.FUEL_SCG_AMT
                        WHEN BB.NUM = 2 THEN AA.OVR_WGT_SCG_AMT
                        WHEN BB.NUM = 3 THEN AA.HZD_MTRL_SCG_AMT
                        WHEN BB.NUM = 4 THEN AA.ETC_ADD_AMT
                   END,0) AS SCG_AMT
              ,NVL(CASE WHEN BB.NUM = 4 THEN AA.INV_ETC_ADD_AMT
                   END,0) AS INV_SCG_AMT
              ,CASE WHEN AA.CGO_TP_CD = 'F' AND BB.NUM = 1 THEN 'SCFURD'
                    WHEN AA.CGO_TP_CD = 'F' AND BB.NUM = 2 THEN 'SCOWAL'
                    WHEN AA.CGO_TP_CD = 'F' AND BB.NUM = 3 THEN 'SCHZAL'
                    WHEN AA.CGO_TP_CD = 'F' AND BB.NUM = 4 THEN 'SCOTAL'
                    WHEN AA.CGO_TP_CD = 'M' AND BB.NUM = 1 THEN 'SMFURD'
                    WHEN AA.CGO_TP_CD = 'M' AND BB.NUM = 2 THEN 'SMOWAL'
                    WHEN AA.CGO_TP_CD = 'M' AND BB.NUM = 3 THEN 'SMHZAL'
                    WHEN AA.CGO_TP_CD = 'M' AND BB.NUM = 4 THEN 'SMOTAL'
               END AS LGS_COST_CD
          FROM (
                SELECT CASE WHEN 'W' = 'W' THEN TO_CHAR(C.LOCL_CRE_DT, 'YYYYMM')
                            WHEN 'W' = 'I' THEN TO_CHAR(D.INV_CFM_DT, 'YYYYMM')           
                       END YR_MON
                      ,A.TRSP_SO_OFC_CTY_CD||A.TRSP_SO_SEQ AS SO_NO
                      ,NULL WO_NO
                      ,D.INV_NO
                      ,A.BKG_NO
                      ,A.EQ_NO
                      ,A.EQ_TPSZ_CD
                      ,A.CGO_TP_CD
                      ,B.CURR_CD
                      ,B.FUEL_SCG_AMT
                      ,B.OVR_WGT_SCG_AMT
                      ,B.HZD_MTRL_SCG_AMT
                      ,B.ETC_ADD_AMT
                      ,B.CURR_CD AS INV_CURR_CD
                      ,B.INV_ETC_ADD_AMT
                      ,B.TRSP_MOD_CD AS TRSP_CRR_MOD_CD
                      ,B.FM_NOD_CD
                      ,NULL VIA_NOD_CD
                      ,B.TO_NOD_CD
                      ,NULL DOR_NOD_CD
                      ,A.TRSP_BND_CD     
                      ,NULL OTR_RMK                -- W/O Surcharge - Other Surcharge Remark
                      ,NULL TRSP_PURP_RSN           -- W/O Surcharge - Remark
                      ,NULL INTER_RMK                -- W/O Surcharge - Internal Remark
                      ,NULL INV_OTR_RMK           -- Invoice Surcharge - Other Surcharge Remark
                      ,NULL INV_RMK                -- Invoice Surcharge - Inv Remark
                      ,TRS_COMMON_PKG.TRS_GET_RHQ_OFC_CD(A.CRE_OFC_CD) RHQ_OFC_CD
                      ,A.CRE_OFC_CD AS SO_OFC_CD
                      ,(SELECT X.USR_NM FROM COM_USER X WHERE X.USR_ID = C.CRE_USR_ID) AS SO_USR_NM
                      ,WVDR.VNDR_SEQ     AS WO_VNDR_SEQ
                      ,WVDR.VNDR_LGL_ENG_NM AS WO_VNDR_NM
                      ,WVDR.VNDR_SEQ     AS INV_VNDR_SEQ
                      ,WVDR.VNDR_LGL_ENG_NM AS INV_VNDR_NM
                      ,(SELECT BKG.SC_NO
                          FROM BKG_BOOKING BKG    
                         WHERE BKG.BKG_NO = A.BKG_NO) SC_NO
                      ,(SELECT BKG.RFA_NO
                          FROM BKG_BOOKING BKG    
                         WHERE BKG.BKG_NO = A.BKG_NO) RFA_NO
                      ,(SELECT REPLACE (CUST_NM, CHR (13) || CHR (10),' ')
                          FROM BKG_CUSTOMER CUST
                         WHERE CUST.BKG_NO = A.BKG_NO
                           AND CUST.BKG_CUST_TP_CD = 'S' ) AS SHIPPER
                      ,(SELECT REPLACE (CUST_NM, CHR (13) || CHR (10),' ')
                          FROM BKG_CUSTOMER CUST
                         WHERE CUST.BKG_NO = A.BKG_NO
                           AND CUST.BKG_CUST_TP_CD = 'C' ) AS CONSIGNEE
                      ,NULL NEGO_RMK
                      ,NULL SPCL_INSTR_RMK
                      ,B.SUB_RAIL_SEQ
                      ,A.TRSP_SO_OFC_CTY_CD
                      ,A.TRSP_SO_SEQ
                      ,(CASE WHEN NVL(B.CURR_CD,'USD') = 'USD' THEN 1
                             ELSE (SELECT USD_LOCL_XCH_RT
                                     FROM GL_MON_XCH_RT XCH
                                    WHERE XCH.ACCT_XCH_RT_LVL = 1
                                      AND XCH.CURR_CD           = B.CURR_CD
                                      AND XCH.ACCT_XCH_RT_YRMON = NVL(TO_CHAR(C.LOCL_CRE_DT,'YYYYMM'),TO_CHAR (A.LOCL_CRE_DT, 'YYYYMM')))
                        END) AS XCH_RT
                      ,(NVL(B.BZC_AMT,0) + NVL(B.FUEL_SCG_AMT,0) + NVL(B.OVR_WGT_SCG_AMT,0) + NVL(B.HZD_MTRL_SCG_AMT,0) + NVL(B.ETC_ADD_AMT,0)) - NVL(B.INV_BZC_AMT, 0) AS DIFF_BTWN_AMT
                    FROM TRS_TRSP_RAIL_BIL_ORD A
                        ,TRS_TRSP_RAIL_BIL_VNDR_SET B
                        ,TRS_TRSP_EDI_RAIL_ORD C
                        ,TRS_TRSP_RAIL_INV_WRK D
                        ,MDM_VENDOR WVDR
                   WHERE A.TRSP_SO_OFC_CTY_CD  = B.TRSP_SO_OFC_CTY_CD
                     AND A.TRSP_SO_SEQ         = B.TRSP_SO_SEQ 
                     AND A.TRSP_SO_OFC_CTY_CD  = C.TRSP_SO_OFC_CTY_CD
                     AND A.TRSP_SO_SEQ = C.TRSP_SO_SEQ
                     AND A.BIL_ISS_KNT = C.BIL_ISS_KNT
                     AND B.INV_NO       = D.INV_NO(+)
                     AND B.INV_VNDR_SEQ = D.INV_VNDR_SEQ(+)
                     AND B.VNDR_SEQ     = WVDR.VNDR_SEQ
                    
           #if (${s_ofc_tp_cd} == 'W' && ${s_dt_tp_cd} == 'W' && ${s_ofc_cd} == '')
                AND C.CRE_OFC_CD IN (SELECT OFC_CD 
                                       FROM MDM_ORGANIZATION
                                      WHERE DELT_FLG = 'N'
                                    CONNECT BY NOCYCLE PRIOR OFC_CD = PRNT_OFC_CD
                                      START WITH OFC_CD = @[s_rhq_ofc_cd]
                                    )
           #end

           #if ((${s_ofc_tp_cd} == 'I' || ${s_dt_tp_cd} == 'I') && ${s_ofc_cd} == '')
                AND 1=2
           #end 

           #if (${s_ofc_tp_cd} == 'W' && ${s_ofc_cd} != '')
                AND C.CRE_OFC_CD = @[s_ofc_cd]
           #elseif (${s_ofc_tp_cd} == 'I' && ${s_ofc_cd} != '')
                AND D.CRE_OFC_CD = @[s_ofc_cd]
           #end

           #if (${s_dt_tp_cd} == 'W')
                AND C.LOCL_CRE_DT BETWEEN TO_DATE (REPLACE(@[s_fm_dt],'-',''), 'rrrrmmdd') AND TO_DATE (REPLACE(@[s_to_dt],'-',''), 'rrrrmmdd') + 0.999999 -- s_dt_tp_cd = 'W' 일 경우 (Work order Date)
           #elseif (${s_dt_tp_cd} == 'I')
                AND D.INV_CFM_DT BETWEEN TO_DATE (REPLACE(@[s_fm_dt],'-',''), 'rrrrmmdd') AND TO_DATE (REPLACE(@[s_to_dt],'-',''), 'rrrrmmdd') + 0.999999 -- s_dt_tp_cd = 'I' 일 경우 (Invoice Date)
           #end

           #if (${s_cgo_tp_cd} != '')
                AND A.CGO_TP_CD = @[s_cgo_tp_cd]
           #end

                     --AND C.LOCL_CRE_DT BETWEEN TO_DATE (REPLACE('2015-05-05','-',''), 'rrrrmmdd') AND TO_DATE (REPLACE('2015-05-05','-',''), 'rrrrmmdd') + 0.3999999 -- s_dt_tp_cd = 'W' 일 경우 (Work order Date)
        ) AA
        ,(SELECT ROWNUM AS NUM
            FROM DUAL
         CONNECT BY LEVEL <= 4
        ) BB
) AAA
WHERE SCG_AMT + INV_SCG_AMT > 0
       #if($s_scg_cd.size() > 0) 
        	AND (
            	#foreach( ${key} in ${s_scg_cd}) 
                	#if($velocityCount == 1)
						#if ($key.length() == 4)
						SUBSTR(LGS_COST_CD, 3,4)= '$key'
            			#else
						SUBSTR(LGS_COST_CD, 3,2)= '$key'
            			#end
                    #else
                    	#if ($key.length() == 4)
						OR SUBSTR(LGS_COST_CD, 3,4)= '$key'
            			#else
						OR SUBSTR(LGS_COST_CD, 3,2)= '$key'
            			#end
                    #end 
                #end
       		)
       #end

       #if (${s_srch_opt_cd} == 'WP') 
            AND NVL(SCG_AMT,0) > 0
       #elseif (${s_srch_opt_cd} == 'WM')
            AND NVL(SCG_AMT,0) < 0
       #elseif (${s_srch_opt_cd} == 'WN')
            AND NVL(SCG_AMT,0) <> 0
       #elseif (${s_srch_opt_cd} == 'IP')                
            AND NVL(INV_SCG_AMT,0) > 0
       #elseif (${s_srch_opt_cd} == 'IM')                
            AND NVL(INV_SCG_AMT,0) < 0
       #elseif (${s_srch_opt_cd} == 'IN')
            AND NVL(INV_SCG_AMT,0) <> 0
       #end

ORDER BY SO_NO
        ,SUB_RAIL_SEQ
        ,NUM			]]></sql>
			<params>
				<param name="s_rhq_ofc_cd" type="12" value="" out="N"/>
				<param name="s_ofc_cd" type="12" value="" out="N"/>
				<param name="s_fm_dt" type="12" value="" out="N"/>
				<param name="s_to_dt" type="12" value="" out="N"/>
				<param name="s_cgo_tp_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
