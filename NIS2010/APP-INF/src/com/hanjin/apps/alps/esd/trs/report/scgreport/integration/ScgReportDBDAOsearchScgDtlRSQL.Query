<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ScgReportDBDAOsearchScgDtlRSQL">
			<desc><![CDATA[Surcharge Report에서 선택한 세부사항을 조회한다.]]></desc>
			<sql><![CDATA[
SELECT MONTH
      ,TRSP_SO_OFC_CTY_CD||TRSP_SO_SEQ SO_NO
      ,TRSP_WO_OFC_CTY_CD||TRSP_WO_SEQ WO_NO
      ,INV_NO
      ,BKG_NO
      ,EQ_NO
      ,EQ_TPSZ_CD
      ,CURR_CD
#if(${scg_type} == 'WO')
      ,MAX(DECODE(NUM, 1, LGS_COST_FULL_NM)) SCG1
      ,SUM(DECODE(NUM, 1, SCG_AMT)) AMT1
      ,MAX(DECODE(NUM, 2, LGS_COST_FULL_NM)) SCG2
      ,SUM(DECODE(NUM, 2, SCG_AMT)) AMT2
      ,MAX(DECODE(NUM, 3, LGS_COST_FULL_NM)) SCG3
      ,SUM(DECODE(NUM, 3, SCG_AMT)) AMT3
      ,MAX(DECODE(NUM, 4, 'Y','N')) MORE_THAN_3
      ,TRSP_CRR_MOD_CD
      ,FM_NOD_CD
      ,VIA_NOD_CD
      ,TO_NOD_CD
      ,DOR_NOD_CD
      ,MAX(OTR_RMK) RMK
#elseif(${scg_type} == 'INV')
      ,MAX(DECODE(NUM, 1, LGS_COST_FULL_NM)) SCG1
      ,SUM(DECODE(NUM, 1, INV_SCG_AMT)) AMT1
      ,MAX(DECODE(NUM, 2, LGS_COST_FULL_NM)) SCG2
      ,SUM(DECODE(NUM, 2, INV_SCG_AMT)) AMT2
      ,MAX(DECODE(NUM, 3, LGS_COST_FULL_NM)) SCG3
      ,SUM(DECODE(NUM, 3, INV_SCG_AMT)) AMT3
      ,MAX(DECODE(NUM, 4, 'Y','N')) MORE_THAN_3
      ,TRSP_CRR_MOD_CD
      ,FM_NOD_CD
      ,VIA_NOD_CD
      ,TO_NOD_CD
      ,DOR_NOD_CD
      ,MAX(INV_OTR_RMK) RMK
#end
      ,INV_RMK
      ,CRE_OFC_CD
      ,VNDR_SEQ
      ,VNDR_NM
      ,CTRT_NO
      ,REPLACE(SHIPPER, chr(34), '') AS SHIPPER
      ,REPLACE(CONSIGNEE, chr(34), '') AS CONSIGNEE
FROM
(
SELECT 
RANK () OVER (PARTITION BY A.TRSP_SO_OFC_CTY_CD,A.TRSP_SO_SEQ ORDER BY A.TRSP_SO_OFC_CTY_CD,A.TRSP_SO_SEQ,A.LGS_COST_CD) NUM
,A.TRSP_SO_OFC_CTY_CD,A.TRSP_SO_SEQ,C.TRSP_WO_OFC_CTY_CD,C.TRSP_WO_SEQ,C.INV_NO,C.BKG_NO,C.CURR_CD
,A.LGS_COST_CD, B.LGS_COST_FULL_NM, A.SCG_AMT,A.INV_SCG_AMT,A.OTR_RMK,A.INV_OTR_RMK
,C.TRSP_CRR_MOD_CD,C.FM_NOD_CD,C.VIA_NOD_CD,C.TO_NOD_CD,C.DOR_NOD_CD
#if(${sel_date} == 'inv')
,TO_CHAR(D.INV_CFM_DT,'YYYYMM') MONTH
#elseif(${sel_date} == 'wo')
,TO_CHAR(E.LOCL_CRE_DT,'YYYYMM') MONTH
#end
,C.EQ_NO,C.EQ_TPSZ_CD,C.INV_RMK,C.CRE_OFC_CD,C.VNDR_SEQ,(SELECT VNDR_LGL_ENG_NM FROM MDM_VENDOR WHERE VNDR_SEQ = C.VNDR_SEQ) VNDR_NM
,(SELECT NVL(SC_NO,RFA_NO) FROM BKG_BOOKING WHERE BKG_NO = C.BKG_NO) CTRT_NO
                ,(SELECT REPLACE (CUST_NM, CHR (13) || CHR (10),' ')
                    FROM BKG_CUSTOMER CUST
                   WHERE CUST.BKG_NO = C.BKG_NO
                     AND CUST.BKG_CUST_TP_CD = 'S' ) AS SHIPPER
                ,(SELECT REPLACE (CUST_NM, CHR (13) || CHR (10),' ')
                    FROM BKG_CUSTOMER CUST
                   WHERE CUST.BKG_NO = C.BKG_NO
                     AND CUST.BKG_CUST_TP_CD = 'C' ) AS CONSIGNEE
 FROM TRS_TRSP_SCG_DTL A, TES_LGS_COST B, TRS_TRSP_SVC_ORD C, TRS_TRSP_INV_WRK D
#if(${sel_date} == 'wo')
     ,TRS_TRSP_WRK_ORD E
#end
WHERE A.LGS_COST_CD = B.LGS_COST_CD
  AND A.TRSP_SO_OFC_CTY_CD = C.TRSP_SO_OFC_CTY_CD
  AND A.TRSP_SO_SEQ = C.TRSP_SO_SEQ
  AND C.INV_NO = D.INV_NO
  AND C.INV_VNDR_SEQ = D.INV_VNDR_SEQ
#if(${sel_date} == 'wo')
   AND C.TRSP_WO_OFC_CTY_CD = E.TRSP_WO_OFC_CTY_CD
   AND C.TRSP_WO_SEQ = E.TRSP_WO_SEQ
#end
  AND C.INV_NO IS NOT NULL
  AND C.TRSP_INV_ACT_STS_CD IS NOT NULL
  AND C.DELT_FLG = 'N' 
  AND D.DELT_FLG = 'N'
#if(${scg_type} == 'WO')
  AND A.SCG_AMT != 0
#elseif(${scg_type} == 'INV')
  AND A.INV_SCG_AMT != 0
#end
  AND A.LGS_COST_CD NOT IN ('SCOTAX','SMOTAX' ,'SCFURD' ,'SCFURT' ,'SCFUTD' ,'SCFUWD' ,'SCFUWR' ,'SCFUWT' ,'SMFURD' ,'SMFURT' ,'SMFUTD' ,'SMFUWD' ,'SMFUWR' ,'SMFUWT', 'SCHLOP', 'SCHLCF')
#if (${sel_op_tp} == 'SINGLE')
  AND C.CRE_OFC_CD = @[wo_ofc_cd]
#if(${sel_date} == 'inv')
  AND D.INV_CFM_DT BETWEEN TO_DATE(REPLACE(@[month],'-','')||'01', 'YYYYMMDD') AND LAST_DAY(TO_DATE(REPLACE(@[month],'-',''),'YYYYMM'))+0.99999999
#elseif(${sel_date} == 'wo')
  AND E.LOCL_CRE_DT BETWEEN TO_DATE(REPLACE(@[month],'-','')||'01', 'YYYYMMDD') AND LAST_DAY(TO_DATE(REPLACE(@[month],'-',''),'YYYYMM'))+0.99999999
#end
  AND D.CRE_OFC_CD = @[inv_ofc_cd]
#end  
#if (${sel_op_tp} != 'SINGLE')
  AND(
     #foreach( $multi_conditions in ${conditions}) 
         #if($velocityCount != 1) 
  OR
         #end
      $multi_conditions
     #end
 )

#end
)
T
GROUP BY MONTH
        ,TRSP_SO_OFC_CTY_CD
        ,TRSP_SO_SEQ
        ,TRSP_WO_OFC_CTY_CD
        ,TRSP_WO_SEQ
        ,INV_NO
        ,BKG_NO
        ,EQ_NO
        ,EQ_TPSZ_CD
        ,CURR_CD
        ,TRSP_CRR_MOD_CD
        ,FM_NOD_CD
        ,VIA_NOD_CD
        ,TO_NOD_CD
        ,DOR_NOD_CD
        ,INV_RMK
        ,CRE_OFC_CD
        ,VNDR_SEQ
        ,VNDR_NM
        ,CTRT_NO
        ,SHIPPER
        ,CONSIGNEE			]]></sql>
			<params>
				<param name="wo_ofc_cd" type="12" value="" out="N"/>
				<param name="month" type="12" value="" out="N"/>
				<param name="inv_ofc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
