<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CopDetailReceiveDBDAOSearchCopVvdInfoRSQL">
			<desc><![CDATA[SearchCopVvdInfo]]></desc>
			<sql><![CDATA[
SELECT S2.COP_NO, S2.COP_DTL_SEQ, S2.NOD_CD, S2.ACT_CD, S2.ESTM_GAP, S2.VL_ROW, S2.TRNK_COP 
FROM ( 
SELECT S1.COP_NO 
      ,MAX(DECODE(S1.SLT_FLG,'Y',S1.COP_DTL_SEQ)) COP_DTL_SEQ 
      ,MAX(DECODE(S1.SLT_FLG,'Y',S1.NOD_CD)) NOD_CD 
      ,MAX(DECODE(S1.SLT_FLG,'Y',S1.ACT_CD)) ACT_CD 
      ,MAX(DECODE(S1.SLT_FLG,'Y',S1.ESTM_GAP)) ESTM_GAP 
      ,MIN(S1.VL_ROW) VL_ROW 
      ,NVL(MIN(S1.TRNK_COP),'N') TRNK_COP 
FROM ( 
SELECT A.COP_NO 
     ,A.COP_DTL_SEQ 
     ,A.NOD_CD 
     ,A.ACT_CD 
     ,ROUND(TO_DATE(P_ACT_DT,'YYYY/MM/DD HH24:MI:SS') - A.ESTM_DT, 5) ESTM_GAP        
     ,A.COP_NO||A.COP_DTL_SEQ VL_ROW 
     ,(CASE WHEN SUBSTR(A.ACT_CD,5,1) = SUBSTR(@[in_act_sts_mapg_cd],3,1) THEN 'Y' ELSE 'N' END) SLT_FLG 
     ,(CASE WHEN SUBSTR(A.ACT_CD,5,1) = SUBSTR(@[in_act_sts_mapg_cd],3,1)  
            THEN (SELECT MIN(SC.COP_NO||SC.COP_DTL_SEQ)  
                  FROM   SCE_COP_DTL SC 
                  WHERE  SC.COP_NO = A.COP_NO 
                  AND    (SC.VSL_CD||SC.SKD_VOY_NO||SC.SKD_DIR_CD) = SUBSTR((SELECT MIN(SG.COP_DTL_SEQ||SG.VSL_CD||SG.SKD_VOY_NO||SG.SKD_DIR_CD)  
                                                                      FROM   SCE_COP_DTL SG 
                                                                      WHERE  SG.COP_NO      = A.COP_NO 
                                                                      AND    SUBSTR(SG.ACT_CD,3,1) = 'V' 
                                                                      AND    SG.COP_DTL_SEQ > (SELECT MAX(SSG.COP_DTL_SEQ) FROM SCE_COP_DTL SSG 
                                                                                               WHERE SSG.COP_NO    = B.COP_NO  
                                                                                               AND SUBSTR(SSG.ACT_CD,3,1) = 'V' 
                                                                                               AND (SSG.VSL_CD||SSG.SKD_VOY_NO||SSG.SKD_DIR_CD||SSG.VPS_PORT_CD) = (@[in_vsl_cd]||@[in_skd_voy_no]||@[in_skd_dir_cd]||@[in_vps_port_cd])) 
                                                                      ),5,9) 
                 )  
            END) TRNK_COP 
FROM   SCE_COP_DTL A, SCE_COP_HDR B 
WHERE  A.VSL_CD                = @[in_vsl_cd] 
AND    A.SKD_VOY_NO            = @[in_skd_voy_no] 
AND    A.SKD_DIR_CD            = @[in_skd_dir_cd] 
AND    SUBSTR(A.NOD_CD,1,5)    = @[in_vps_port_cd]
AND    NVL(A.CLPT_IND_SEQ,'1') = NVL(@[in_clpt_ind_seq],'1') 
AND    B.COP_NO                = A.COP_NO 
AND    B.COP_STS_CD            IN ('C','T') ) S1 
GROUP BY COP_NO ) S2 
WHERE SUBSTR(S2.ACT_CD,5,1) = SUBSTR(@[in_act_sts_mapg_cd],3,1) 			]]></sql>
			<params>
				<param name="in_act_sts_mapg_cd" type="12" value="" out="N"/>
				<param name="in_vsl_cd" type="12" value="" out="N"/>
				<param name="in_skd_voy_no" type="12" value="" out="N"/>
				<param name="in_skd_dir_cd" type="12" value="" out="N"/>
				<param name="in_vps_port_cd" type="12" value="" out="N"/>
				<param name="in_clpt_ind_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
