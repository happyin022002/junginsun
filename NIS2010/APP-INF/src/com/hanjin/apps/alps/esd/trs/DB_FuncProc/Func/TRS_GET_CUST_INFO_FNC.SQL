CREATE OR REPLACE FUNCTION TRS_GET_CUST_INFO_FNC (    V_BKG_NO in VARCHAR2) RETURN VARCHAR2AUTHID CURRENT_USER/*******************************************************************************   1. Object Name      : TRS_GET_CUST_INFO_FNC   2. Version          : 1.0   3. Create Date      : 2015.07.13   4. Sub System       : ALPS/TRS   5. Author           : SHIN DONG IL   6. Description      : BKG의 S/C, RFA No로 Customer code조회*******************************************************************************/IS     V_RETURN_CUST_CD    VARCHAR2(8)      := '' ;    V_CNRT_TP_CD        VARCHAR2(3)      := '' ;       V_SC_NO             VARCHAR2(20)     := '' ;       V_RFA_NO            VARCHAR2(11)     := '' ;       V_PROP_NO           VARCHAR2(10)     := '' ;       V_AMDT_SEQ          VARCHAR2(3)      := '' ;    V_CUST_CNT_CD       VARCHAR2(2)      := '' ;    V_CUST_SEQ          VARCHAR2(6)      := '' ;     BEGIN    /* SELECT S/C, RFA No */    BEGIN        SELECT SC_NO              ,RFA_NO              ,CASE WHEN SC_NO IS NOT NULL THEN 'SC'                    WHEN RFA_NO IS NOT NULL THEN  'RFA'                    ELSE ''                END AS CNRT_TP_CD              INTO V_SC_NO              ,V_RFA_NO              ,V_CNRT_TP_CD          FROM BKG_BOOKING         WHERE 1=1           AND BKG_NO  = V_BKG_NO        ;            EXCEPTION WHEN NO_DATA_FOUND THEN       V_RETURN_CUST_CD := '';    END;     /* END OF SELECT S/C, RFA No  */        /* SELECT PRI AMEND SEQUENCE */    IF V_CNRT_TP_CD = 'SC' THEN        BEGIN            SELECT MAIN.AMDT_SEQ              INTO V_AMDT_SEQ              FROM PRI_SP_HDR HDR                  ,PRI_SP_MN MAIN                  ,(SELECT APPL_DT                      FROM (SELECT 1 RANK, RT_APLY_DT APPL_DT                               FROM BKG_RT_HIS R                             WHERE BKG_NO     = V_BKG_NO                               AND CORR_NO    = 'TMP0000001'                               AND RT_APLY_DT IS NOT NULL                             UNION ALL                            SELECT 2 RANK, RT_APLY_DT APPL_DT --RATE APPLICABLE                              FROM BKG_RATE R                             WHERE BKG_NO     = V_BKG_NO                               AND RT_APLY_DT IS NOT NULL                             UNION ALL                            SELECT 3 RANK, SKD.VPS_ETD_DT APPL_DT --ONBOARD DATE                              FROM BKG_VVD_HIS VVD, VSK_VSL_PORT_SKD SKD, BKG_BKG_HIS BK                             WHERE BK.BKG_NO          = V_BKG_NO                               AND BK.CORR_NO 		  = 'TMP0000001'                               AND VVD.CORR_NO 		  = 'TMP0000001'                               AND BK.BKG_NO          = VVD.BKG_NO                               AND VVD.VSL_PRE_PST_CD IN ('S', 'T')                               AND VVD.POL_CD         = BK.POL_CD                               AND VVD.VSL_CD         = SKD.VSL_CD                               AND VVD.SKD_VOY_NO     = SKD.SKD_VOY_NO                               AND VVD.SKD_DIR_CD     = SKD.SKD_DIR_CD                               AND VVD.POL_CD         = SKD.VPS_PORT_CD                               AND VVD.POL_CLPT_IND_SEQ = SKD.CLPT_IND_SEQ                             UNION ALL                            SELECT 4 RANK, SKD.VPS_ETD_DT APPL_DT --ONBOARD DATE                              FROM BKG_VVD VVD, VSK_VSL_PORT_SKD SKD, BKG_BOOKING BK                             WHERE BK.BKG_NO          = V_BKG_NO                               AND BK.BKG_NO          = VVD.BKG_NO                               AND VVD.VSL_PRE_PST_CD IN ('S', 'T')                               AND VVD.POL_CD         = BK.POL_CD                               AND VVD.VSL_CD         = SKD.VSL_CD                               AND VVD.SKD_VOY_NO     = SKD.SKD_VOY_NO                               AND VVD.SKD_DIR_CD     = SKD.SKD_DIR_CD                               AND VVD.POL_CD         = SKD.VPS_PORT_CD                               AND VVD.POL_CLPT_IND_SEQ = SKD.CLPT_IND_SEQ                             UNION ALL                             SELECT 5 RANK, SYSDATE APPL_DT                              FROM DUAL)                          WHERE ROWNUM = 1) APPL               WHERE 1=1                 AND HDR.PROP_NO = MAIN.PROP_NO                 AND MAIN.EFF_DT - 0.0001 < APPL.APPL_DT                 AND MAIN.EXP_DT + 0.9999 > APPL.APPL_DT                 AND MAIN.PROP_STS_CD ='F'                 AND HDR.SC_NO = V_SC_NO;        EXCEPTION WHEN NO_DATA_FOUND THEN            V_AMDT_SEQ := '';        END;            ELSIF V_CNRT_TP_CD = 'RFA' THEN        BEGIN            SELECT MAIN.AMDT_SEQ              INTO V_AMDT_SEQ              FROM PRI_RP_HDR HDR                  ,PRI_RP_MN MAIN                  ,(SELECT APPL_DT                      FROM (SELECT 1 RANK, RT_APLY_DT APPL_DT                               FROM BKG_RT_HIS R                             WHERE BKG_NO     = V_BKG_NO                               AND CORR_NO    = 'TMP0000001'                               AND RT_APLY_DT IS NOT NULL                             UNION ALL                            SELECT 2 RANK, RT_APLY_DT APPL_DT --RATE APPLICABLE                              FROM BKG_RATE R                             WHERE BKG_NO     = V_BKG_NO                               AND RT_APLY_DT IS NOT NULL                             UNION ALL                            SELECT 3 RANK, SKD.VPS_ETD_DT APPL_DT --ONBOARD DATE                              FROM BKG_VVD_HIS VVD, VSK_VSL_PORT_SKD SKD, BKG_BKG_HIS BK                             WHERE BK.BKG_NO          = V_BKG_NO                               AND BK.CORR_NO 		  = 'TMP0000001'                               AND VVD.CORR_NO 		  = 'TMP0000001'                               AND BK.BKG_NO          = VVD.BKG_NO                               AND VVD.VSL_PRE_PST_CD IN ('S', 'T')                               AND VVD.POL_CD         = BK.POL_CD                               AND VVD.VSL_CD         = SKD.VSL_CD                               AND VVD.SKD_VOY_NO     = SKD.SKD_VOY_NO                               AND VVD.SKD_DIR_CD     = SKD.SKD_DIR_CD                               AND VVD.POL_CD         = SKD.VPS_PORT_CD                               AND VVD.POL_CLPT_IND_SEQ = SKD.CLPT_IND_SEQ                             UNION ALL                            SELECT 4 RANK, SKD.VPS_ETD_DT APPL_DT --ONBOARD DATE                              FROM BKG_VVD VVD, VSK_VSL_PORT_SKD SKD, BKG_BOOKING BK                             WHERE BK.BKG_NO          = V_BKG_NO                               AND BK.BKG_NO          = VVD.BKG_NO                               AND VVD.VSL_PRE_PST_CD IN ('S', 'T')                               AND VVD.POL_CD         = BK.POL_CD                               AND VVD.VSL_CD         = SKD.VSL_CD                               AND VVD.SKD_VOY_NO     = SKD.SKD_VOY_NO                               AND VVD.SKD_DIR_CD     = SKD.SKD_DIR_CD                               AND VVD.POL_CD         = SKD.VPS_PORT_CD                               AND VVD.POL_CLPT_IND_SEQ = SKD.CLPT_IND_SEQ                             UNION ALL                             SELECT 5 RANK, SYSDATE APPL_DT                              FROM DUAL)                          WHERE ROWNUM = 1) APPL               WHERE 1=1                 AND HDR.PROP_NO = MAIN.PROP_NO                 AND MAIN.EFF_DT - 0.0001 < APPL.APPL_DT                 AND MAIN.EXP_DT + 0.9999 > APPL.APPL_DT                 AND MAIN.PROP_STS_CD ='A'                 AND HDR.RFA_NO = V_RFA_NO;        EXCEPTION WHEN NO_DATA_FOUND THEN            V_AMDT_SEQ := '';             END;            END IF;         IF V_CNRT_TP_CD = 'SC' AND V_AMDT_SEQ IS NOT NULL THEN        BEGIN           SELECT CUST_CNT_CD                  ,CUST_SEQ             INTO V_CUST_CNT_CD                 ,V_CUST_SEQ             FROM PRI_SP_CTRT_PTY            WHERE PRC_CTRT_PTY_TP_CD = 'C'              AND PROP_NO = (SELECT PROP_NO                               FROM PRI_SP_HDR                              WHERE SC_NO = V_SC_NO)              AND AMDT_SEQ = V_AMDT_SEQ;        EXCEPTION WHEN NO_DATA_FOUND THEN            V_CUST_CNT_CD := '';            V_CUST_SEQ := '';         END;                  ELSIF V_CNRT_TP_CD = 'RFA' AND V_AMDT_SEQ IS NOT NULL  THEN        BEGIN           SELECT CTRT_CUST_CNT_CD                 ,CTRT_CUST_SEQ             INTO V_CUST_CNT_CD                 ,V_CUST_SEQ             FROM PRI_RP_MN            WHERE PROP_STS_CD = 'A'              AND PROP_NO = (SELECT PROP_NO                               FROM PRI_RP_HDR                              WHERE RFA_NO = V_RFA_NO)              AND AMDT_SEQ = V_AMDT_SEQ;        EXCEPTION WHEN NO_DATA_FOUND THEN            V_CUST_CNT_CD := '';            V_CUST_SEQ := '';             END;    END IF;        V_RETURN_CUST_CD := V_CUST_CNT_CD || V_CUST_SEQ;    RETURN V_RETURN_CUST_CD;END;