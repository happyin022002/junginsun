<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CustomerNominatedTruckerAproDAOSearchCntApprovalRSQL">
			<desc><![CDATA[CNT(Customer Nominated Trucker) Approval 조회]]></desc>
			<sql><![CDATA[
SELECT ROWNUM AS SEQ
      ,'' AS SEL
      ,PRC_CTRT_TP_CD
      ,PRC_CTRT_NO
      ,SLS_OFC_CD
      ,CTRT_CUST_SREP_CD 
      ,CTRT_CUST_SREP_NM
      ,CTRT_CUST_CNT_CD || LPAD(CTRT_CUST_SEQ, 6, 0) AS CTRT_CUST_CNT_CD
      ,CTRT_CUST_SEQ
      ,CTRT_CUST_NM      
      ,CTRT_EFF_DT
      ,CTRT_EXP_DT
      ,FNL_MQC_DESC
      ,VNDR_SEQ
      ,VNDR_NM
      ,USA_EDI_CD
      ,SUBSTR(FM_NODE,1,5) FM_NOD_CD
      ,SUBSTR(FM_NODE,6,2) FM_NOD_YARD
      ,SUBSTR(DOR_NODE,1,5) DOR_NOD_CD
      ,SUBSTR(DOR_NODE,6,2) DOR_NOD_YARD
      ,SUBSTR(TO_NODE,1,5) TO_NOD_CD
      ,SUBSTR(TO_NODE,6,2) TO_NOD_YARD
      ,DECODE(LENGTH(DOR_NODE), 7, (SELECT ZN_NM FROM MDM_ZONE B WHERE B.ZN_CD = DOR_NODE AND B.DELT_FLG = 'N'), (SELECT LOC_NM FROM MDM_LOCATION B WHERE B.LOC_CD = DOR_NODE AND B.DELT_FLG = 'N'))  AS MTY_PKUP_RTN_YD_NM
      ,CNTR_TPSZ_CD
      ,CUST_NOMI_TRKR_BZC_AMT
      ,CUST_NOMI_TRKR_FUEL_DIV_CD
      ,CUST_NOMI_TRKR_FUEL_RTO
      ,CUST_NOMI_TRKR_FUEL_AMT
      ,RGST_USR_ID
      ,RGST_OFC_CD
      ,COST_DESC
      ,APRO_HIS_DESC
      ,APRO_NO
      ,APRO_NO as APRO_NO2
      ,DISP_STS_CD
      ,CUST_NOMI_TRKR_SAV_DT
      ,CUST_NOMI_TRKR_RQST_DT
      ,CUST_NOMI_TRKR_RJCT_DT
      ,CUST_NOMI_TRKR_APRO_DT   
      ,APRO_OFC_CD
      ,APRO_USR_ID
      ,APRO_USR_NM
      ,CASE WHEN DISP_STS_CD IN ('01','02') THEN SUBSTR(RT, 1, INSTR(RT, '$', 1, 1) -1)
            ELSE HJS_TRKR_AGMT_NO
        END AS HJS_TRKR_AGMT_NO       
      ,CASE WHEN DISP_STS_CD IN ('01','02') THEN TO_NUMBER(SUBSTR(RT, INSTR(RT, '$', 1, 1) + 1, INSTR(RT, '$', 1, 2) - INSTR(RT, '$', 1, 1) - 1))
            ELSE HJS_TRKR_BZC_AMT
        END AS HJS_TRKR_BZC_AMT
      ,CASE WHEN DISP_STS_CD IN ('01','02') THEN TO_NUMBER(SUBSTR(RT, INSTR(RT, '$', 1, 2) + 1, INSTR(RT, '$', 1, 3) - INSTR(RT, '$', 1, 2) - 1))
            ELSE HJS_TRKR_FUEL_AMT
        END AS HJS_TRKR_FUEL_AMT
      ,CASE WHEN DISP_STS_CD IN ('01','02') THEN NVL2(SUBSTR(CNT_RT, 1, INSTR(CNT_RT, '$', 1, 1) -1), 'Y', 'N')
            ELSE NVL2(HJS_CUST_NOMI_TRKR_AGMT_NO, 'Y', 'N')
        END AS HJS_CUST_NOMI_TRKR_AGMT_NO_YN
      ,CASE WHEN DISP_STS_CD IN ('01','02') THEN SUBSTR(CNT_RT, 1, INSTR(CNT_RT, '$', 1, 1) -1)
            ELSE HJS_CUST_NOMI_TRKR_AGMT_NO
        END AS HJS_CUST_NOMI_TRKR_AGMT_NO
      ,CASE WHEN DISP_STS_CD IN ('01','02') THEN SUBSTR(CNT_RT, 1, INSTR(CNT_RT, '$', 1, 1) -1)
            ELSE HJS_CUST_NOMI_TRKR_AGMT_NO
        END AS HJS_TRKR_AGMT_NO
      ,IO_BND_CD
      ,CUST_NOMI_TRKR_IND_CD
      ,ATCH_FILE_LNK_ID AS EXPN_AUD_RSLT_RMK
      ,DECODE(NVL(ATCH_FILE_LNK_ID, '0'), '0', 'N', 'Y') AS ATTACH_FLAG
  FROM (
    SELECT A.PRC_CTRT_TP_CD
          ,A.PRC_CTRT_NO
          ,A.SLS_OFC_CD
          ,A.CTRT_CUST_SREP_CD 
          ,(SELECT X.SREP_NM FROM MDM_SLS_REP X WHERE X.SREP_CD = A.CTRT_CUST_SREP_CD) AS CTRT_CUST_SREP_NM
          ,A.CTRT_CUST_CNT_CD
          ,A.CTRT_CUST_SEQ
          ,(SELECT X.CUST_LGL_ENG_NM FROM MDM_CUSTOMER X WHERE X.CUST_CNT_CD = A.CTRT_CUST_CNT_CD AND X.CUST_SEQ = A.CTRT_CUST_SEQ) CTRT_CUST_NM      
          ,A.CTRT_EFF_DT
          ,A.CTRT_EXP_DT
          ,A.FNL_MQC_DESC
          ,A.VNDR_SEQ
          ,(SELECT X.VNDR_LGL_ENG_NM FROM MDM_VENDOR X WHERE X.VNDR_SEQ = A.VNDR_SEQ) VNDR_NM
          ,(SELECT X.USA_EDI_CD FROM MDM_VENDOR X WHERE X.VNDR_SEQ = A.VNDR_SEQ) USA_EDI_CD
          ,DECODE(IO_BND_CD, 'I', ORG_NOD_CD, 'O', MTY_PKUP_RTN_YD_CD)  FM_NODE
          ,DECODE(IO_BND_CD, 'I', DEST_NOD_CD, 'O', ORG_NOD_CD)         DOR_NODE
          ,DECODE(IO_BND_CD, 'I', MTY_PKUP_RTN_YD_CD, 'O', DEST_NOD_CD) TO_NODE
--          ,(SELECT X.YD_NM
--              FROM MDM_YARD X
--             WHERE YD_CD = A.MTY_PKUP_RTN_YD_CD)
--         ||(SELECT X.LSE_CO_YD_NM
--              FROM MDM_LSE_CO_YD X
--             WHERE LSE_CO_YD_CD = A.MTY_PKUP_RTN_YD_CD) AS MTY_PKUP_RTN_YD_NM
          ,A.CNTR_TPSZ_CD
          ,A.CUST_NOMI_TRKR_BZC_AMT
          ,A.CUST_NOMI_TRKR_FUEL_DIV_CD
          ,A.CUST_NOMI_TRKR_FUEL_RTO
          ,A.CUST_NOMI_TRKR_FUEL_AMT
          ,A.RGST_USR_ID
          ,A.RGST_OFC_CD
          ,A.HJS_TRKR_AGMT_NO
          ,A.HJS_TRKR_BZC_AMT
          ,A.HJS_TRKR_FUEL_AMT
          ,A.COST_DESC
          ,A.APRO_HIS_DESC
          ,A.APRO_NO
          ,A.DISP_STS_CD
          ,TO_CHAR(A.CUST_NOMI_TRKR_SAV_DT, 'YYYYMMDD')  AS CUST_NOMI_TRKR_SAV_DT
          ,TO_CHAR(A.CUST_NOMI_TRKR_RQST_DT, 'YYYYMMDD') AS CUST_NOMI_TRKR_RQST_DT
          ,TO_CHAR(A.CUST_NOMI_TRKR_RJCT_DT, 'YYYYMMDD') AS CUST_NOMI_TRKR_RJCT_DT
          ,TO_CHAR(A.CUST_NOMI_TRKR_APRO_DT, 'YYYYMMDD') AS CUST_NOMI_TRKR_APRO_DT
          ,A.APRO_OFC_CD
          ,A.APRO_USR_ID
          ,(SELECT X.USR_NM FROM COM_USER X WHERE X.USR_ID = A.APRO_USR_ID) APRO_USR_NM
          ,HJS_CUST_NOMI_TRKR_AGMT_NO          
          ,(SELECT TRS_GET_AGMT_TRKR_RATE_FNC(VNDR_SEQ,CNTR_TPSZ_CD,IO_BND_CD,'DR',NULL,NULL,
                   DECODE(IO_BND_CD, 'I', ORG_NOD_CD, 'O', MTY_PKUP_RTN_YD_CD), --FM_NODE
                   CASE WHEN LENGTH(DECODE(IO_BND_CD, 'I', DEST_NOD_CD, 'O', ORG_NOD_CD)) = 5       --DOOR_NODE
                        THEN DECODE(IO_BND_CD, 'I', DEST_NOD_CD, 'O', ORG_NOD_CD)||'01'
                        ELSE DECODE(IO_BND_CD, 'I', DEST_NOD_CD, 'O', ORG_NOD_CD)
                   END,
                   DECODE(IO_BND_CD, 'I', MTY_PKUP_RTN_YD_CD, 'O', DEST_NOD_CD) --TO_NODE
                   )
              FROM DUAL
           ) RT
          ,(SELECT TRS_GET_AGMT_TRKR_RATE_FNC(VNDR_SEQ,CNTR_TPSZ_CD,IO_BND_CD,'DR',NULL, NULL,
                   DECODE(IO_BND_CD, 'I', ORG_NOD_CD, 'O', MTY_PKUP_RTN_YD_CD), --FM_NODE
                   CASE WHEN LENGTH(DECODE(IO_BND_CD, 'I', DEST_NOD_CD, 'O', ORG_NOD_CD)) = 5       --DOOR_NODE
                        THEN DECODE(IO_BND_CD, 'I', DEST_NOD_CD, 'O', ORG_NOD_CD)||'01'
                        ELSE DECODE(IO_BND_CD, 'I', DEST_NOD_CD, 'O', ORG_NOD_CD)
                   END,
                   DECODE(IO_BND_CD, 'I', MTY_PKUP_RTN_YD_CD, 'O', DEST_NOD_CD) --TO_NODE
                   )
              FROM DUAL
           ) CNT_RT
         ,A.IO_BND_CD
         ,NVL(A.CUST_NOMI_TRKR_IND_CD,'CNT') CUST_NOMI_TRKR_IND_CD
         ,A.ATCH_FILE_LNK_ID
      FROM TRS_CUST_NOMI_TRKR A
     WHERE 1=1
--	 AND DISP_STS_CD != '00'
      #if (${s_dt_div_cd} == '00' && ${s_fm_dt} != '' && ${s_to_dt} != '' )
      AND A.CUST_NOMI_TRKR_SAV_DT  BETWEEN TO_DATE(@[s_fm_dt], 'YYYYMMDD') AND TO_DATE(@[s_to_dt], 'YYYYMMDD')+0.99999 -- Saved Date로 조회시
      #end
      
      #if (${s_dt_div_cd} == '01' && ${s_fm_dt} != '' && ${s_to_dt} != '' )
      AND A.CUST_NOMI_TRKR_RQST_DT BETWEEN TO_DATE(@[s_fm_dt], 'YYYYMMDD') AND TO_DATE(@[s_to_dt], 'YYYYMMDD')+0.99999 -- Requested Date로 조회시
      #end
      
      #if (${s_dt_div_cd} == '02' && ${s_fm_dt} != '' && ${s_to_dt} != '' )
      AND A.CUST_NOMI_TRKR_RJCT_DT BETWEEN TO_DATE(@[s_fm_dt], 'YYYYMMDD') AND TO_DATE(@[s_to_dt], 'YYYYMMDD')+0.99999 -- Rejected Date로 조회시
      #end
      
      #if (${s_dt_div_cd} == '03' && ${s_fm_dt} != '' && ${s_to_dt} != '' )
      AND A.CUST_NOMI_TRKR_APRO_DT BETWEEN TO_DATE(@[s_fm_dt], 'YYYYMMDD') AND TO_DATE(@[s_to_dt], 'YYYYMMDD')+0.99999  -- Approved Date로 조회시
      #end
      
      #if (${s_eff_dt} != '')
      AND TO_DATE(@[s_eff_dt], 'YYYYMMDD') BETWEEN A.CTRT_EFF_DT AND A.CTRT_EXP_DT    -- Effective Date로 조회시
      #end
      
      #if (${s_ctrt_no} != '')
      AND A.PRC_CTRT_NO = @[s_ctrt_no]       -- Contract No로 조회시
      #end
      
      -- Status로 조회시 (MULTI 리스트로 파라메터 받아 loop문에서 처리)
        #if ($s_disp_sts_cd.size() > 0)
              AND A.DISP_STS_CD IN (
        	#foreach($key in ${s_disp_sts_cd}) 
        
        		#if($velocityCount < $s_disp_sts_cd.size()) 
        			'$key', 
        		#else 
        			'$key' 
        		#end 
        
        	#end
        	)
        #end
      
      #if (${s_cust_seq} != '')
      AND (A.CTRT_CUST_CNT_CD, A.CTRT_CUST_SEQ) = ( ( SUBSTR(@[s_cust_seq],1,2), SUBSTR(@[s_cust_seq],3))  )       -- Customer로 조회시
      #end
      
      #if (${s_vndr_seq} != '')
      AND A.VNDR_SEQ = @[s_vndr_seq]  -- Trucker로 조회시
      #end

      #if (${s_cnt_tp_cd} != '')
      AND A.CUST_NOMI_TRKR_IND_CD = @[s_cnt_tp_cd]       -- CNT TYPE CODE로 조회시
      #end

      #if (${s_dor_nod_cd} != '')
      AND SUBSTR(DECODE(A.IO_BND_CD, 'I', A.DEST_NOD_CD, 'O', A.ORG_NOD_CD), 1, 5) = @[s_dor_nod_cd]
      #end
)			]]></sql>
			<params>
				<param name="s_fm_dt" type="12" value="" out="N"/>
				<param name="s_to_dt" type="12" value="" out="N"/>
				<param name="s_eff_dt" type="12" value="" out="N"/>
				<param name="s_ctrt_no" type="12" value="" out="N"/>
				<param name="s_cust_seq" type="12" value="" out="N"/>
				<param name="s_vndr_seq" type="12" value="" out="N"/>
				<param name="s_cnt_tp_cd" type="12" value="" out="N"/>
				<param name="s_dor_nod_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
