<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TESeBillingManageBizType003DBDAOUpdateEDInvoicePSADTLTmpUSQL">
			<desc><![CDATA[PSA DTL 후속 작업 : COST CODE MAPPING/YARD MAPPING/COST CODE로 INV유형 결정/VVD MAPPING 등]]></desc>
			<sql><![CDATA[
UPDATE TES_EDI_SO_PSA_DTL D
SET  D.LGS_COST_CD          = ( SELECT DISTINCT C.LGS_COST_CD
                                FROM TES_EDI_SO_COST C
                                WHERE C.VNDR_SEQ = @[psa_vndr_seq]
                                AND NVL(TRIM(C.PSA_CHG_CATE_CD),'X') = NVL(TRIM(D.PSA_CHG_CATE_CD),'X')
                                AND NVL(TRIM(C.PSA_CHG_CLSS_N1ST_CD),'X') = NVL(TRIM(D.PSA_CHG_CLSS_N1ST_CD),'X')
                                AND NVL(TRIM(C.PSA_CHG_CLSS_N2ND_CD),'X') = NVL(TRIM(D.PSA_CHG_CLSS_N2ND_CD),'X')
                                AND NVL(TRIM(C.PSA_CHG_TP_CD),'X') = NVL(TRIM(D.PSA_CHG_TP_CD),'X')
                                AND ROWNUM = 1 ),
     D.YD_CD                = ( SELECT DISTINCT C.YD_CD
                                FROM TES_EDI_SO_COST C
                                WHERE C.VNDR_SEQ = @[psa_vndr_seq]
                                AND NVL(TRIM(C.PSA_CHG_CATE_CD),'X') = NVL(TRIM(D.PSA_CHG_CATE_CD),'X')
                                AND NVL(TRIM(C.PSA_CHG_CLSS_N1ST_CD),'X') = NVL(TRIM(D.PSA_CHG_CLSS_N1ST_CD),'X')
                                AND NVL(TRIM(C.PSA_CHG_CLSS_N2ND_CD),'X') = NVL(TRIM(D.PSA_CHG_CLSS_N2ND_CD),'X')
                                AND NVL(TRIM(C.PSA_CHG_TP_CD),'X') = NVL(TRIM(D.PSA_CHG_TP_CD),'X')
                                AND ROWNUM = 1 ),
     D.TML_INV_TP_CD        = ( SELECT 
                                CASE
                                WHEN NVL(T.MRN_TML_FLG,'N') = 'Y'
                                THEN 'TM'
                                WHEN NVL(T.STO_INV_FLG,'N') = 'Y'
                                THEN 'ST'
                                WHEN NVL(T.FDCK_CY_TML_FLG,'N') = 'Y' OR NVL(T.FDCK_CY_STO_FLG,'N') = 'Y'
                                THEN 'OF'
                                WHEN NVL(T.ODCK_RAIL_CHG_FLG,'N') = 'Y'
                                THEN 'ON'
                                ELSE ''
                                END TML_INV_TP_CD
                                FROM TES_EDI_SO_COST C, TES_TML_SO_COST T
                                WHERE C.LGS_COST_CD = T.LGS_COST_CD
                                AND C.VNDR_SEQ = @[psa_vndr_seq]
                                AND C.VNDR_TRF_DESC = D.TRF_DESC 
                                AND ROWNUM = 1  ),
     D.OB_VVD_CD            = ( SELECT B.VSL_CD||B.SKD_VOY_NO||B.SKD_DIR_CD 
                                FROM BKG_CSTMS_PSA_VVD B 
                                WHERE B.PSA_VSL_NM = D.PSA_VSL_NM
                                AND B.PSA_VOY_DIR_CD = D.OB_PSA_VOY_DIR_CD
                                AND ROWNUM = 1 ),
     D.IB_VVD_CD            = ( SELECT B.VSL_CD||B.SKD_VOY_NO||B.SKD_DIR_CD 
                                FROM BKG_CSTMS_PSA_VVD B 
                                WHERE B.PSA_VSL_NM = D.PSA_VSL_NM
                                AND B.PSA_VOY_DIR_CD = D.IB_PSA_VOY_DIR_CD
                                AND ROWNUM = 1 )     
WHERE D.TML_EDI_SO_PSA_DTL_SEQ > 0 
AND D.TRF_DESC <> 'GST'
AND D.TML_INV_EDI_SEQ = @[tml_inv_edi_seq]			]]></sql>
			<params>
				<param name="psa_vndr_seq" type="12" value="" out="N"/>
				<param name="tml_inv_edi_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
