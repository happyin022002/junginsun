<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="WorkOrderSheetDBDAOsearchWorkOrderSheetListRSQL">
			<desc><![CDATA[searchWorkOrderSheetList]]></desc>
			<sql><![CDATA[
SELECT   CNTR_SEQ AS RNUM
        ,Equipment_Number
        ,Type_Size
        ,Rate
        ,Special_Cargo
        ,Weight
        ,Commodity_Description
        ,Inbond_Transit_Number
        ,Purchase_Order_No
        ,Booking_Number
        ,BL_NO
        ,Vessel
        ,next_port
        ,Shipper_Name
        ,Shipper_Telephone_Number
        ,Door_Service_Type
        --,Pickup_No
        ,Available_Date
        ,Last_Free_Date
        ,f
        ,o
        ,c
        ,CS_Clear_NO
        ,Expected_Departure_Time
        ,Expected_Arrival_Time
        ,Door_Arrival_Appointment_Time
        ,USA_Last_City
        ,BLCK_STWG
        ,DEL_CD
        ,Remark
        ,Predispatch
        ,Seal_No_1
        ,Seal_No_2
        ,Detain
        ,Bnum
        ,MIN(DECODE(MLT_STOP_DE_FLG,'Y',DECODE(multi.TRO_SUB_SEQ,1,'ADDR : '||DOR_ADDR||' ('||multi.LOC_CD||') / '||TO_CHAR(multi.ARR_DT,'YYYY-MM-DD HH24:MI')||CHR(10)),'')) AS MLT_STOP_1
        ,MIN(DECODE(MLT_STOP_DE_FLG,'Y',DECODE(multi.TRO_SUB_SEQ,2,'ADDR : '||DOR_ADDR||' ('||multi.LOC_CD||') / '||TO_CHAR(multi.ARR_DT,'YYYY-MM-DD HH24:MI')||CHR(10)),'')) AS MLT_STOP_2
        ,MIN(DECODE(MLT_STOP_DE_FLG,'Y',DECODE(multi.TRO_SUB_SEQ,3,'ADDR : '||DOR_ADDR||' ('||multi.LOC_CD||') / '||TO_CHAR(multi.ARR_DT,'YYYY-MM-DD HH24:MI')||CHR(10)),'')) AS MLT_STOP_3
        ,MIN(DECODE(MLT_STOP_DE_FLG,'Y',DECODE(multi.TRO_SUB_SEQ,4,'ADDR : '||DOR_ADDR||' ('||multi.LOC_CD||') / '||TO_CHAR(multi.ARR_DT,'YYYY-MM-DD HH24:MI')||CHR(10)),'')) AS MLT_STOP_4
        ,MIN(DECODE(MLT_STOP_DE_FLG,'Y',DECODE(multi.TRO_SUB_SEQ,5,'PLEASE, CONTACT P.I.C. FOR MORE...'),'')) AS MLT_STOP_5
        ,CNTR.bkg_no
		,TRO_LOD_REF_NO
		,Rail_Receiving_Date_FM
		,Rail_Receiving_Date_TO
		,CASE WHEN (f||o||c = 'YYY' OR f||o||c = 'YYW')
  	   	 	   AND Pickup_No IS NOT NULL
  	   	 	   AND Pickup_No <> ' '
			   AND Last_Free_Date IS NOT NULL 
			   AND Last_Free_Date <> ' ' THEN Pickup_No
--  	   	 AND ctmsts_id_cnt < 1 THEN Pickup_No WHEN (f||o||c = 'YYY'
--         	OR f||o||c = 'YYW')
--  	   	 AND Pickup_No IS NOT NULL
--  	   	 AND Pickup_No <> ' '
--  	   	 AND ctmsts_id_cnt >= 1 
		 	   ELSE '' 
		 END AS Pickup_No
--  	  	,CASE WHEN (f||o||c = 'YYY'
--      		OR f||o||c = 'YYW')
--  	   	 AND Pickup_No IS NOT NULL
--  	   	 AND Pickup_No <> ' '
--  	   	 AND ctmsts_id_cnt < 1 THEN Available_Date ELSE '' END AS Available_Date
--  	  	,CASE WHEN (f||o||c = 'YYY'
--     		OR f||o||c = 'YYW')
--  	   	 AND Pickup_No IS NOT NULL
--  	   	 AND Pickup_No <> ' '
--       	 AND ctmsts_id_cnt < 1 THEN Last_Free_Date ELSE '' END AS Last_Free_Date
FROM   (SELECT SO.EQ_NO AS Equipment_Number
              ,TPSZ.CNTR_TPSZ_RMK AS Type_Size
              ,SO.CURR_CD ||' '|| TO_CHAR(NVL(SO.BZC_AMT,0)+NVL(SO.ETC_ADD_AMT,0)+NVL(SO.FUEL_SCG_AMT,0)+NVL(SO.NEGO_AMT,0)+NVL(SO.TOLL_FEE_AMT,0)) AS Rate
              ,SPCL_CGO_CNTR_TP_CD AS Special_Cargo
              ,TPSZ.CNTR_TPSZ_TARE_WGT || ' / ' || SO.CNTR_WGT || ' '|| SO.WGT_MEAS_UT_CD AS Weight
              ,CMDT.CMDT_NM|| ' /'||TO_CHAR(BKG_CNTR.PCK_QTY) || ' ' ||BKG_CNTR.PCK_TP_CD AS Commodity_Description
              ,'' AS Inbond_Transit_Number
			  ,(SELECT PU.CUST_REF_NO_CTNT
         	      FROM BKG_REFERENCE PU
                 WHERE PU.BKG_NO = SO.BKG_NO
         	       AND PU.CNTR_NO = SO.EQ_NO 
         	       AND PU.BKG_REF_TP_CD = 'CTPO' ) AS Purchase_Order_No
              ,SO.BKG_NO AS Booking_Number
              ,BKG.BL_NO AS BL_NO
              ,VSL.VSL_ENG_NM||' '||SO.SKD_VOY_NO||SO.SKD_DIR_CD AS Vessel
              ,DECODE(SO.TRSP_NXT_PORT_CD,NULL,LOC2.LOC_NM||'('||SO.POD_CD||')',LOC1.LOC_NM||'('||SO.TRSP_NXT_PORT_CD||')') AS next_port
              ,CUST.CUST_LGL_ENG_NM AS Shipper_Name
              ,CUST_CNTC.PHN_NO AS Shipper_Telephone_Number
              ,(select	intg_cd_val_dp_desc	from com_intg_cd_dtl  where	intg_cd_id = 'CD00284' and	intg_cd_val_ctnt = SO.DOR_SVC_TP_CD) AS Door_Service_Type
              ,pu.pkup_no AS Pickup_No
			  ,to_char(pu.PKUP_AVAL_DT,'YYYY-MM-DD HH24:MI:SS') Available_Date
        	  ,to_char(pu.LST_FREE_DT,'YYYY-MM-DD HH24:MI:SS') Last_Free_Date
              ,nvl(US_CGO_RLSE.FRT_CLT_FLG,'N') f                                                                                       
              ,nvl(US_CGO_RLSE.OBL_RDEM_FLG,'N') o                                                                                   
              -- POD : 'CA',DEL : 'US'의 경우 Rail AMS 정보를 보여준다.                                                                                
              -- POD : 'CA',DEL : 'US'의 경우 Rail AMS 정보를 보여준다.                                                                                
              ,nvl(CASE WHEN (substr(BKG.pod_cd,0,2) = 'CA') and  (substr(BKG.del_cd,0,2) = 'US') THEN
            		  (
            		   select /*+ index_desc(x XPKBKG_CSTMS_ADV_CNTR_RSLT) */
            		          x.cstms_clr_cd
            		     from bkg_cstms_adv_cntr_rslt x
            		    where x.cnt_cd = 'US'  --상수값
                          and x.bl_no = SO.bl_no
            			  and (substr(x.cntr_no,0,length(x.cntr_no)-1) = substr(SO.eq_no,0,length(SO.eq_no)-1) OR x.cntr_no = substr(SO.eq_no,0,length(SO.eq_no)-1))
            			  and rownum < 2
            		   )
            	   ELSE US_CGO_RLSE.CSTMS_CLR_CD
            	   END,'N' ) as c
              ,SO.CSTMS_CLR_NO AS CS_Clear_NO
              ,TO_CHAR(SO.N1ST_NOD_PLN_DT
              ,'YYYY-MM-DD HH24:MI') AS Expected_Departure_Time
              ,TO_CHAR(SO.LST_NOD_PLN_DT,'YYYY-MM-DD HH24:MI') AS Expected_Arrival_Time
              ,TO_CHAR(SO.DOR_NOD_PLN_DT,'YYYY-MM-DD HH24:MI') AS Door_Arrival_Appointment_Time
              ,SO.LST_LOC_CD AS USA_Last_City
--            ,TRS_GET_BLCK_STWG_CD_FNC(so.bkg_no) AS BLCK_STWG
              ,BKG.BLCK_STWG_CD AS BLCK_STWG
              ,LOC3.LOC_NM||'('||SO.DEL_CD||')' AS DEL_CD
              ,SO.SPCL_INSTR_RMK AS Remark
              ,(select CNTR_SEAL_NO from BKG_CNTR_SEAL_NO where bkg_no = so.bkg_no and cntr_no = so.eq_no and CNTR_SEAL_SEQ = 1) Seal_No_1
              ,(select CNTR_SEAL_NO from BKG_CNTR_SEAL_NO where bkg_no = so.bkg_no and cntr_no = so.eq_no and CNTR_SEAL_SEQ = 2) Seal_No_2
              ,DECODE(WO.DTN_USE_FLG, 'Y','Detain', '') AS Detain
              ,DECODE(WO.PRE_DIS_USE_FLG, 'Y','Pre-Dispatched','') AS Predispatch
              ,SO.MLT_STOP_DE_FLG AS MLT_STOP_DE_FLG
              ,DECODE(WO.WO_BL_NO_ISS_FLG, 'Y','B-No Issue', '') AS Bnum
              ,SO.BKG_NO AS BKG_NO
			  ,SO.TRO_LOD_REF_NO
			  ,DECODE(SO.TRSP_COST_DTL_MOD_CD,'ER',NULL,'LS',NULL,'TS',NULL,'CF',NULL,'CN',NULL,DECODE(SO.TRSP_CRR_MOD_CD,'TD',DECODE(SO.TRSP_BND_CD,'O',TO_CHAR(COP.RAIL_RCV_COFF_FM_DT,'YYYY-MM-DD HH24:MI'),NULL),NULL)) AS Rail_Receiving_Date_FM
              ,DECODE(SO.TRSP_COST_DTL_MOD_CD,'ER',NULL,'LS',NULL,'TS',NULL,'CF',NULL,'CN',NULL,DECODE(SO.TRSP_CRR_MOD_CD,'TD',DECODE(SO.TRSP_BND_CD,'O',TO_CHAR(COP.RAIL_RCV_COFF_TO_DT,'YYYY-MM-DD HH24:MI'),NULL),NULL)) AS Rail_Receiving_Date_TO
              ,SO.TRO_SEQ AS TRO_SEQ
--			  ,(SELECT COUNT(MVMT_STS_CD)
--        		  FROM CTM_MOVEMENT
--        	     WHERE 1=1
--          		   AND CNTR_NO = SO.EQ_NO
--          		   AND BKG_NO = SO.BKG_NO
--          		   AND MVMT_STS_CD = 'ID') CTMSTS_ID_CNT
              ,ROWNUM AS CNTR_SEQ
        FROM   TRS_TRSP_WRK_ORD                          WO
              ,TRS_TRSP_SVC_ORD                          SO
              ,MDM_COMMODITY                             CMDT
              ,BKG_CGO_RLSE                              US_CGO_RLSE
              ,BKG_CONTAINER                             BKG_CNTR
              ,BKG_CUSTOMER                              BKG_CUST
              ,MDM_CUSTOMER                              CUST
              ,MDM_CUST_CNTC_PNT                         CUST_CNTC
              ,MDM_CNTR_TP_SZ                            TPSZ
              ,MDM_VSL_CNTR                              VSL
              ,MDM_LOCATION                              LOC
              ,MDM_LOCATION                              LOC1
              ,MDM_LOCATION                              LOC2
              ,MDM_LOCATION                              LOC3
              ,BKG_BOOKING			                     BKG
              ,SCE_COP_HDR                               COP
	   	      ,BKG_PKUP_NTC_PKUP_NO                      pu
       WHERE   WO.TRSP_WO_OFC_CTY_CD = SO.TRSP_WO_OFC_CTY_CD
         AND   WO.TRSP_WO_SEQ = SO.TRSP_WO_SEQ
         AND   SO.COP_NO = COP.COP_NO(+)
    #if ($wo_no.size() > 0) 
         AND (wo.trsp_wo_ofc_cty_cd,wo.trsp_wo_seq) in (
    	#foreach($wonoKey in ${wo_no})
    		#if($velocityCount < $wo_no.size()) 
    			(substr('$wonoKey',0,3),to_number(substr('$wonoKey',4,length('$wonoKey')))),
    		#else 
    			(substr('$wonoKey',0,3),to_number(substr('$wonoKey',4,length('$wonoKey'))))
    		#end 
    	#end 
      )
    #else 
    	 AND 1=2 
    #end 
    	 AND wo.wo_vndr_seq = @[wo_vndr_seq]
    #if (${trsp_so_cmb_srt_no} != '')
         AND wo.TRSP_SO_CMB_SRT_NO like @[trsp_so_cmb_srt_no]
    #end
         AND SO.CMDT_CD                          = CMDT.CMDT_CD(+)
         AND SO.BKG_NO                           = BKG_CNTR.BKG_NO(+)
         AND SO.EQ_NO                            = BKG_CNTR.CNTR_NO(+)
         AND SO.BKG_NO                           = BKG.BKG_NO(+)
         AND BKG.BL_NO                           = US_CGO_RLSE.BL_NO(+)
         AND SO.BKG_NO                           = BKG_CUST.BKG_NO(+)
         AND BKG_CUST.BKG_CUST_TP_CD(+)          = DECODE(SO.TRSP_BND_CD,'I','C','S')
         AND BKG_CUST.CUST_CNT_CD                = CUST.CUST_CNT_CD(+)
         AND BKG_CUST.CUST_SEQ                   = CUST.CUST_SEQ(+)
         AND CUST.CUST_CNT_CD                    = CUST_CNTC.CUST_CNT_CD(+)
         AND CUST.CUST_SEQ                       = CUST_CNTC.CUST_SEQ(+)
         AND CUST_CNTC.CUST_CNTC_PNT_SEQ(+)      = 1
         AND SO.TRSP_NXT_PORT_CD                 = LOC1.LOC_CD (+)
         AND SO.POD_CD                           = LOC2.LOC_CD (+)
         AND SO.DEL_CD                           = LOC3.LOC_CD (+)
         AND SO.VSL_CD                           = VSL.VSL_CD (+)
         AND SO.EQ_TPSZ_CD                       = TPSZ.CNTR_TPSZ_CD(+)
	     AND so.eq_no                            = pu.cntr_no(+)
	     AND so.bkg_no                           = pu.bkg_no(+)
	     AND pu.del_cd                           = LOC.loc_cd(+)
--         AND pu.ofc_cd                           = LOC.eq_ctrl_ofc_cd(+)
		 AND NVL(TO_DATE(pu.upd_dt, 'YYYY-MM-DD HH24:MI:SS'), TO_DATE('11111111 111111', 'YYYY-MM-DD HH24:MI:SS')) = NVL((
            SELECT TO_DATE(MAX(Y.UPD_DT), 'YYYY-MM-DD HH24:MI:SS')
            FROM BKG_PKUP_NTC_PKUP_NO Y
            WHERE Y.BKG_NO = pu.BKG_NO
              AND Y.CNTR_NO = pu.CNTR_NO
              AND Y.PKUP_YD_CD = pu.PKUP_YD_CD), TO_DATE('11111111 111111', 'YYYY-MM-DD HH24:MI:SS'))
      ) CNTR
     ,BKG_EUR_TRO_DTL multi
WHERE CNTR.BKG_NO = MULTI.BKG_NO(+)
  AND CNTR.TRO_SEQ = MULTI.TRO_SEQ(+)
GROUP BY  CNTR_SEQ
         ,Equipment_Number
         ,Type_Size
         ,Rate
         ,Special_Cargo
         ,Weight
         ,Commodity_Description
         ,Inbond_Transit_Number
         ,Purchase_Order_No
         ,Booking_Number
         ,BL_NO
         ,Vessel
         ,next_port
         ,Shipper_Name
         ,Shipper_Telephone_Number
         ,Door_Service_Type
         ,Pickup_No
         ,Available_Date
         ,Last_Free_Date
         ,f
         ,o
         ,c
         ,CS_Clear_NO
         ,Expected_Departure_Time
         ,Expected_Arrival_Time
         ,Door_Arrival_Appointment_Time
         ,USA_Last_City
         ,BLCK_STWG
         ,DEL_CD
         ,Remark
         ,Predispatch
         ,Seal_No_1
		 ,Seal_No_2
         ,Detain
         ,MLT_STOP_DE_FLG
         ,Bnum
         ,CNTR.bkg_no
         ,TRO_LOD_REF_NO
		 ,Rail_Receiving_Date_FM
		 ,Rail_Receiving_Date_TO
--		 ,CTMSTS_ID_CNT
ORDER BY CNTR_SEQ asc			]]></sql>
			<params>
				<param name="wo_vndr_seq" type="2" value="11111" out="N"/>
				<param name="trsp_so_cmb_srt_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
