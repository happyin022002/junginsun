<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="USARailPerformanceDBDAOSearchENISInvRailPerformanceByLaneVvdRSQL">
			<desc><![CDATA[searchENISInvRailPerformance SELECT by Lane VVD]]></desc>
			<sql><![CDATA[
#if( ${loc_on} == 'L' )
SELECT
'' INV_CFM_YRMON,
'' WEEK,
TRSP_INV_CO_IND_CD,
INV_VNDR_SEQ      ,
INV_VNDR_ENG_NM,
CGO_TP_CD  ,
TRSP_BND_CD,
#if( ${agmt_chk} == 'Y' )
AGMT_REF_NO,
#else
'' AGMT_REF_NO,
#end
SLAN_CD  ,
VVD      ,
FM_NOD_CD,
TO_NOD_CD,
INV_CURR_CD,
SUM(VOL_20)  VOL_20,
SUM(LOC_AMT_20)  LOC_AMT_20,
SUM(USD_AMT_20) USD_AMT_20,
SUM(VOL_40)  VOL_40,
SUM(LOC_AMT_40)  LOC_AMT_40,
SUM(USD_AMT_40) USD_AMT_40,
SUM(VOL_40HC)  VOL_40HC,
SUM(LOC_AMT_40HC) LOC_AMT_40HC,
SUM(USD_AMT_40HC) USD_AMT_40HC,
SUM(VOL_40_HC)  VOL_40_HC,
SUM(LOC_AMT_40_HC) LOC_AMT_40_HC,
SUM(USD_AMT_40_HC) USD_AMT_40_HC,
SUM(VOL_45) VOL_45,
SUM(LOC_AMT_45) LOC_AMT_45,
SUM(USD_AMT_45) USD_AMT_45,
SUM(TOT_VOL) TOT_VOL,
SUM(TOT_LOC_AMT) TOT_LOC_AMT,
SUM(TOT_USD_AMT) TOT_USD_AMT
FROM (
#end
SELECT
      INV_CFM_YRMON     ,
      WEEK WEEK,
      TRSP_INV_CO_IND_CD,
      INV_VNDR_SEQ      ,
      TRS_COMMON_PKG.GET_VNDR_FULL_NM_FNC(INV_VNDR_SEQ) INV_VNDR_ENG_NM,
      DECODE(CGO_TP_CD  , 'F', 'Full', 'M', 'Empty', CGO_TP_CD  ) CGO_TP_CD,
      DECODE(TRSP_BND_CD, 'I', 'In'  , 'O', 'Out'  , TRSP_BND_CD) TRSP_BND_CD,
#if( ${agmt_chk} == 'Y' )
	  AGMT_REF_NO,
#else
	  '' AGMT_REF_NO,
#end
	  SLAN_CD  ,
      VVD      ,
      FM_NOD_CD,
      TO_NOD_CD,
      INV_CURR_CD,
      SUM(CNTR_20_CNT)  VOL_20,
      SUM(CNTR_20_AMT)  LOC_AMT_20,
      ROUND(TRS_COMMON_PKG.GET_CONVERSION_USD_AMT_FNC(INV_CURR_CD,SUM(CNTR_20_AMT), INV_CFM_YRMON),2) USD_AMT_20,
      SUM(CNTR_40_CNT)  VOL_40,
      SUM(CNTR_40_AMT)  LOC_AMT_40,
      ROUND(TRS_COMMON_PKG.GET_CONVERSION_USD_AMT_FNC(INV_CURR_CD,SUM(CNTR_40_AMT), INV_CFM_YRMON),2) USD_AMT_40,
      SUM(CNTR_40HC_CNT)  VOL_40HC,
      SUM(CNTR_40HC_AMT)  LOC_AMT_40HC,
      ROUND(TRS_COMMON_PKG.GET_CONVERSION_USD_AMT_FNC(INV_CURR_CD,SUM(CNTR_40HC_AMT), INV_CFM_YRMON),2) USD_AMT_40HC,
      SUM(CNTR_40_CNT) + SUM(CNTR_40HC_CNT) VOL_40_HC,
      SUM(CNTR_40_AMT) + SUM(CNTR_40HC_AMT) LOC_AMT_40_HC,
      ROUND(TRS_COMMON_PKG.GET_CONVERSION_USD_AMT_FNC(INV_CURR_CD,SUM(CNTR_40_AMT), INV_CFM_YRMON),2) +
      ROUND(TRS_COMMON_PKG.GET_CONVERSION_USD_AMT_FNC(INV_CURR_CD,SUM(CNTR_40HC_AMT), INV_CFM_YRMON),2) USD_AMT_40_HC,
      SUM(CNTR_45_CNT) VOL_45,
      SUM(CNTR_45_AMT) LOC_AMT_45,
      ROUND(TRS_COMMON_PKG.GET_CONVERSION_USD_AMT_FNC(INV_CURR_CD,SUM(CNTR_45_AMT), INV_CFM_YRMON),2) USD_AMT_45,
      SUM(CNTR_20_CNT) + SUM(CNTR_40_CNT) + SUM(CNTR_40HC_CNT) + SUM(CNTR_45_CNT) TOT_VOL,
      SUM(CNTR_20_AMT) + SUM(CNTR_40_AMT) + SUM(CNTR_40HC_AMT) + SUM(CNTR_45_AMT) TOT_LOC_AMT,
      ROUND(TRS_COMMON_PKG.GET_CONVERSION_USD_AMT_FNC(INV_CURR_CD,SUM(CNTR_20_AMT), INV_CFM_YRMON),2) +
      ROUND(TRS_COMMON_PKG.GET_CONVERSION_USD_AMT_FNC(INV_CURR_CD,SUM(CNTR_45_AMT), INV_CFM_YRMON),2) +
	  ROUND(TRS_COMMON_PKG.GET_CONVERSION_USD_AMT_FNC(INV_CURR_CD,SUM(CNTR_40HC_AMT), INV_CFM_YRMON),2) +
      ROUND(TRS_COMMON_PKG.GET_CONVERSION_USD_AMT_FNC(INV_CURR_CD,SUM(CNTR_40_AMT), INV_CFM_YRMON),2) TOT_USD_AMT
FROM
     (
      SELECT /*+ USE_NL(XX YY) */ DISTINCT
            TO_CHAR(X.INV_CFM_DT, 'YYYYMM') INV_CFM_YRMON,
#if( ${f_chkprd} == 'M' )
            '' WEEK,
#elseif( ${f_chkprd} == 'W' )
			X.WEEK,
#end
            X.INV_VNDR_SEQ,
			Y.EQ_NO,
            NVL(Y.TRSP_INV_CO_IND_CD, 'None Rail Billing') COMPANY,
            XX.TRSP_BND_CD,
#if( ${agmt_chk} == 'Y' )
			AGMT_REF_NO,
#end
			XX.SLAN_CD,
            XX.VSL_CD||XX.SKD_VOY_NO||XX.SKD_DIR_CD VVD,
            Y.CGO_TP_CD,
            DECODE(@[loc_on], 'L', SUBSTR(Y.FM_NOD_CD,1,5), Y.FM_NOD_CD) FM_NOD_CD,
            DECODE(@[loc_on], 'L', SUBSTR(Y.TO_NOD_CD,1,5), Y.TO_NOD_CD) TO_NOD_CD,
            LOCTO.LOC_CD,
            LOCTO.EQ_CTRL_OFC_CD,
            LOCFM.LOC_CD,
            LOCFM.EQ_CTRL_OFC_CD,
            X.INV_CURR_CD,
            DECODE(Y.TRSP_INV_CO_IND_CD, null, DECODE(Y.TRSP_SO_OFC_CTY_CD, null, 'Invoice Only','SML'), 'NIS', 'SML',Y.TRSP_INV_CO_IND_CD) TRSP_INV_CO_IND_CD,
            DECODE(SUBSTR(Y.EQ_TPSZ_CD,2,1), '2', 1, 0)               CNTR_20_CNT,
            DECODE(SUBSTR(Y.EQ_TPSZ_CD,2,1), '2', Y.INV_BZC_AMT, 0)   CNTR_20_AMT,
            DECODE(SUBSTR(Y.EQ_TPSZ_CD,2,1), '4', 1, 0)               CNTR_40_CNT,
            DECODE(SUBSTR(Y.EQ_TPSZ_CD,2,1), '4', Y.INV_BZC_AMT, 0)   CNTR_40_AMT,
            DECODE(SUBSTR(Y.EQ_TPSZ_CD,2,1), '5', 1, 0)               CNTR_40HC_CNT,
            DECODE(SUBSTR(Y.EQ_TPSZ_CD,2,1), '5', Y.INV_BZC_AMT, 0)   CNTR_40HC_AMT,
            DECODE( Y.EQ_TPSZ_CD, 'D7', 1, 0)   CNTR_45_CNT,
            DECODE( Y.EQ_TPSZ_CD, 'D7', Y.INV_BZC_AMT ,0 )     CNTR_45_AMT
      FROM
#if( ${f_chkprd} == 'M' )
            TRS_TRSP_RAIL_INV_WRK       X,
#elseif( ${f_chkprd} == 'W' )
			  (SELECT INV_NO, INV_VNDR_SEQ, INV_CURR_CD,INV_CFM_DT
					--, TO_CHAR(TRUNC(INV_CFM_DT,'DY'),'WW') WEEK
                    ,B.COST_WK WEEK
				FROM TRS_TRSP_RAIL_INV_WRK A
                    ,MAS_WK_PRD B
                WHERE A.INV_CFM_DT BETWEEN TO_DATE(B.SLS_FM_DT,'YYYYMMDD') AND TO_DATE(B.SLS_TO_DT,'YYYYMMDD')+0.99999)   X,
#end

            TRS_TRSP_RAIL_INV_DTL    Y,
            TRS_TRSP_RAIL_BIL_ORD   XX,
            (SELECT LOC_CD, EQ_CTRL_OFC_CD FROM MDM_LOCATION ) LOCTO,
            (SELECT LOC_CD, EQ_CTRL_OFC_CD FROM MDM_LOCATION ) LOCFM,
			TRS_TRSP_RAIL_BIL_VNDR_SET VNDR,
			TRS_AGMT_HDR AH -- add Agmt. Ref. No. 
      WHERE 1 = 1
      AND   X.INV_NO             = Y.INV_NO
      AND   X.INV_VNDR_SEQ       = Y.INV_VNDR_SEQ
      AND   Y.TRSP_SO_OFC_CTY_CD = XX.TRSP_SO_OFC_CTY_CD (+)
      AND   Y.TRSP_SO_SEQ        = XX.TRSP_SO_SEQ        (+)
      AND   Y.PAY_FLG            = 'Y'
      AND   LOCTO.LOC_CD = SUBSTR(Y.TO_NOD_CD,1,5)
      AND   LOCFM.LOC_CD = SUBSTR(Y.FM_NOD_CD,1,5)
      AND   Y.TRSP_SO_OFC_CTY_CD = VNDR.TRSP_SO_OFC_CTY_CD(+) -- add Agmt. Ref. No. 
      AND   Y.TRSP_SO_SEQ       = VNDR.TRSP_SO_SEQ(+) -- add Agmt. Ref. No. 
      AND   VNDR.TRSP_AGMT_OFC_CTY_CD = AH.TRSP_AGMT_OFC_CTY_CD(+) -- add Agmt. Ref. No. 
      AND   VNDR.TRSP_AGMT_SEQ = AH.TRSP_AGMT_SEQ(+) -- add Agmt. Ref. No. 
#if ( ${agmt_ref_no} != '' )
	AND AH.AGMT_REF_NO = @[agmt_ref_no]
#end
#if ( ${vndr_seq} != '' )
      AND   X.INV_VNDR_SEQ = @[vndr_seq]
#end
#if ( ${cgo_tp_cd} != 'A' )
	#if ( ${cgo_tp_cd} != 'X')
      AND   Y.CGO_TP_CD = @[cgo_tp_cd]
	#else
      AND   (XX.TRSP_BND_CD = 'O'
             OR Y.CGO_TP_CD = 'M')
	#end
#end
#if ( ${io_bound} != 'A' )
	#if ( ${cgo_tp_cd} != 'X')
      AND   XX.TRSP_BND_CD = @[io_bound]
	#end
#end
#if ( ${ctrl_ofc} != '' )
      AND   DECODE(XX.TRSP_BND_CD , 'I',  LOCTO.EQ_CTRL_OFC_CD, 'O', LOCFM.EQ_CTRL_OFC_CD , LOCFM.EQ_CTRL_OFC_CD) =  @[ctrl_ofc]
#end
#if(${fm_node_length} == '7')
      AND   Y.FM_NOD_CD = @[input_fm_node]
#elseif (${fm_node_length} == '5')
      AND   Y.FM_NOD_CD LIKE @[input_fm_node] || '%'
#elseif (${fm_node_length} != '0')
      AND   Y.FM_NOD_CD LIKE @[input_fm_node] || '%'
#end
#if(${to_node_length} == '7')
	    AND   Y.TO_NOD_CD = @[input_to_node]
#elseif (${to_node_length} == '5')
	    AND   Y.TO_NOD_CD LIKE @[input_to_node] || '%'
#elseif (${to_node_length} != '0')
	    AND   Y.TO_NOD_CD LIKE @[input_to_node] || '%'
#end

#if ( ${fm_month} != '' && ${to_month} != '')
      AND X.INV_CFM_DT  BETWEEN TO_DATE(@[fm_month],'YYYYMMDD') AND TO_DATE(@[to_month],'YYYYMMDD')+0.99999
#end

#if ( ${comp_cd} != 'A' )
    #if ( ${comp_cd} == 'I' )
     AND   Y.CRNT_TRSP_RAIL_INV_AUD_CD = 'I'    
	#end
#end
#if ( ${cntr_tpsz} != '' )
      AND Y.EQ_TPSZ_CD IN (SELECT INTG_CD_VAL_CTNT
                             FROM COM_INTG_CD_DTL
                            WHERE INTG_CD_ID = 'CD01860'
                              AND (INSTR(@[cntr_tpsz], INTG_CD_VAL_CTNT) > 0
                               OR @[cntr_tpsz] = 'ALL'
                                  )
                          )
#end
      ORDER BY
              TO_CHAR(X.INV_CFM_DT, 'YYYYMM')   ASC,
#if( ${f_chkprd} == 'W' )
		      X.WEEK                            ASC,
#end
              Y.FM_NOD_CD                       ASC,
              Y.TO_NOD_CD                       ASC,
              Y.CGO_TP_CD                       ASC
     )
WHERE 1 = 1
#if ( ${comp_cd} != 'A' )
    #if ( ${comp_cd} == 'H' )
     AND   TRSP_INV_CO_IND_CD = 'HJS'
    #elseif ( ${comp_cd} == 'T' )
     AND   TRSP_INV_CO_IND_CD = 'DOM'
	#elseif ( ${comp_cd} == 'S' )
     AND   TRSP_INV_CO_IND_CD = 'SEN'
	#end
#end
GROUP BY
        INV_CFM_YRMON,
		WEEK,
        INV_VNDR_SEQ ,
        TRSP_BND_CD  ,
#if( ${agmt_chk} == 'Y' )
		AGMT_REF_NO,
#end
		SLAN_CD		 ,
        VVD          ,
        CGO_TP_CD    ,
        FM_NOD_CD    ,
        TO_NOD_CD    ,
        INV_CURR_CD  ,
        TRSP_INV_CO_IND_CD
ORDER BY
        INV_CFM_YRMON,
#if( ${f_chkprd} == 'W' )
		WEEK,
#end
        TRSP_INV_CO_IND_CD,
        INV_VNDR_SEQ ,
        TRSP_BND_CD  ,
        CGO_TP_CD    ,
        FM_NOD_CD    ,
        TO_NOD_CD
#if( ${loc_on} == 'L' )
)
GROUP BY
        INV_VNDR_SEQ ,
        TRSP_BND_CD  ,
#if( ${agmt_chk} == 'Y' )
		AGMT_REF_NO,
#end
		SLAN_CD		 ,
        VVD          ,
		INV_VNDR_ENG_NM,
        CGO_TP_CD    ,
        FM_NOD_CD    ,
        TO_NOD_CD    ,
        INV_CURR_CD  ,
        TRSP_INV_CO_IND_CD
ORDER BY
        TRSP_INV_CO_IND_CD,
        INV_VNDR_SEQ ,
        TRSP_BND_CD  ,
        CGO_TP_CD    ,
        FM_NOD_CD    ,
        TO_NOD_CD
#end			]]></sql>
			<params>
				<param name="loc_on" type="12" value="" out="N"/>
				<param name="agmt_ref_no" type="12" value="" out="N"/>
				<param name="vndr_seq" type="12" value="" out="N"/>
				<param name="cgo_tp_cd" type="12" value="" out="N"/>
				<param name="io_bound" type="12" value="" out="N"/>
				<param name="ctrl_ofc" type="12" value="" out="N"/>
				<param name="input_fm_node" type="12" value="" out="N"/>
				<param name="input_to_node" type="12" value="" out="N"/>
				<param name="fm_month" type="12" value="" out="N"/>
				<param name="to_month" type="12" value="" out="N"/>
				<param name="cntr_tpsz" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
