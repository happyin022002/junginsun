<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="SpecialCargoQuotationManageDBDAOsearchLoadUnloadExtCostRSQL">
			<desc><![CDATA[searchLoadUnloadExtCost]]></desc>
			<sql><![CDATA[
SELECT 
K.*
FROM (
SELECT 
DENSE_RANK() OVER (PARTITION BY P.YD_CD, P.TML_AWK_CGO_TRF_TP_CD, P.IO_BND_CD, P.IO_GA_CD, P.TML_AWK_TS_CD, P.COND_NO  ORDER BY P.YD_CD, P.TML_AWK_CGO_TRF_TP_CD, P.IO_BND_CD, P.IO_GA_CD, P.TML_AWK_TS_CD, P.COND_NO, P.TML_AWK_TRF_VER_NO DESC) RN,
P.*
FROM (
SELECT
AD.YD_CD ,
SUBSTR(AD.YD_CD, 1, 5) PORT_CD ,
SUBSTR(AD.YD_CD, 6) TML_CD ,
DECODE(AH.MN_YD_FLG, 'Y', '1', '0') MN_YD_FLG ,
X.TML_AWK_CGO_TRF_TP_CD ,
X.IO_BND_CD,
X.IO_GA_CD ,
X.TML_AWK_TS_CD ,
X.COND_NO ,
(SELECT C.COND_DESC
FROM TES_TRF_COND C
WHERE 1=1
AND C.COND_NO = X.COND_NO) COND_DESC,
X.TML_AWK_TRF_VER_NO ,
X.MAN_LOCL_CURR_CD ,
X.MAN_LOCL_AMT_20FT ,
X.MAN_LOCL_AMT_40FT ,
X.MAN_USD_AMT_20FT ,
X.MAN_USD_AMT_40FT ,
X.AUTO_USD_AMT_20FT ,
X.AUTO_USD_AMT_40FT ,
X.TTL_LOCL_CURR_CD ,
X.TTL_LOCL_AMT_20FT ,
X.TTL_LOCL_AMT_40FT ,
AD.APLY_RTO ,
X.FML_LOCL_CURR_CD ,
X.FML_LOCL_AMT_20FT ,
X.FML_LOCL_AMT_40FT ,
X.CALC_USD_AMT_20FT ,
X.CALC_USD_AMT_40FT ,
X.SUM_USD_AMT_20FT ,
X.SUM_USD_AMT_40FT ,
AD.CALC_RMK ,
AD.LST_UPD_USR_ID ,
TO_CHAR(AD.LST_UPD_DT, 'YYYY-MM-DD') LST_UPD_DT ,
X.SPCL_CGO_REF_SEQ,
CASE
WHEN Y.YD_CD IS NOT NULL
THEN 'Y'
ELSE 'N'
END CHK_SPCL_CGO_REF_SEQ
FROM TES_AWK_CGO_TRF_HDR AH, TES_AWK_CGO_TRF_DTL AD, (
SELECT
/** HDR + DTL **/
T.YD_CD,
T.TML_AWK_CGO_TRF_TP_CD,
T.IO_BND_CD,
T.IO_GA_CD,
T.TML_AWK_TS_CD,
T.COND_NO,
T.TML_AWK_TRF_VER_NO,
'' SPCL_CGO_REF_SEQ,
/** UNIT COST MANUAL (LOCL CURR) **/
MAX( CASE WHEN T.TML_AWK_UC_CALC_TP_CD = 'M' THEN T.LOCL_CURR_CD END) MAN_LOCL_CURR_CD,
MAX( CASE WHEN T.TML_AWK_UC_CALC_TP_CD = 'M' THEN DECODE(T.CNTR_SZ_CD, '2', T.LOCL_CURR_AMT, '') END) MAN_LOCL_AMT_20FT,
MAX( CASE WHEN T.TML_AWK_UC_CALC_TP_CD = 'M' THEN DECODE(T.CNTR_SZ_CD, '4', T.LOCL_CURR_AMT, '') END) MAN_LOCL_AMT_40FT,
/** UNIT COST MANUAL (USD) **/
MAX( CASE WHEN T.TML_AWK_UC_CALC_TP_CD = 'M' THEN DECODE(T.CNTR_SZ_CD, '2', T.USD_AMT, '') END) MAN_USD_AMT_20FT,
MAX( CASE WHEN T.TML_AWK_UC_CALC_TP_CD = 'M' THEN DECODE(T.CNTR_SZ_CD, '4', T.USD_AMT, '') END) MAN_USD_AMT_40FT,
/** UNIT COST AUTO (USD) **/
MAX( CASE WHEN T.TML_AWK_UC_CALC_TP_CD = 'A' THEN DECODE(T.CNTR_SZ_CD, '2', T.USD_AMT, '') END) AUTO_USD_AMT_20FT,
MAX( CASE WHEN T.TML_AWK_UC_CALC_TP_CD = 'A' THEN DECODE(T.CNTR_SZ_CD, '4', T.USD_AMT, '') END) AUTO_USD_AMT_40FT,
/** TOTAL (LOCL CURR) **/
MAX( CASE WHEN T.TML_AWK_UC_CALC_TP_CD = 'T' THEN T.LOCL_CURR_CD END) TTL_LOCL_CURR_CD,
MAX( CASE WHEN T.TML_AWK_UC_CALC_TP_CD = 'T' THEN DECODE(T.CNTR_SZ_CD, '2', T.LOCL_CURR_AMT, '') END) TTL_LOCL_AMT_20FT,
MAX( CASE WHEN T.TML_AWK_UC_CALC_TP_CD = 'T' THEN DECODE(T.CNTR_SZ_CD, '4', T.LOCL_CURR_AMT, '') END) TTL_LOCL_AMT_40FT,
/** FORMULA (LOCL CURR) **/
MAX( CASE WHEN T.TML_AWK_UC_CALC_TP_CD = 'F' THEN T.LOCL_CURR_CD END) FML_LOCL_CURR_CD,
MAX( CASE WHEN T.TML_AWK_UC_CALC_TP_CD = 'F' THEN DECODE(T.CNTR_SZ_CD, '2', T.LOCL_CURR_AMT, '') END) FML_LOCL_AMT_20FT,
MAX( CASE WHEN T.TML_AWK_UC_CALC_TP_CD = 'F' THEN DECODE(T.CNTR_SZ_CD, '4', T.LOCL_CURR_AMT, '') END) FML_LOCL_AMT_40FT,
/** APPLIED EXTRA COST (USD) **/
MAX( CASE WHEN T.TML_AWK_UC_CALC_TP_CD = 'C' THEN DECODE(T.CNTR_SZ_CD, '2', T.USD_AMT, '') END) CALC_USD_AMT_20FT,
MAX( CASE WHEN T.TML_AWK_UC_CALC_TP_CD = 'C' THEN DECODE(T.CNTR_SZ_CD, '4', T.USD_AMT, '') END) CALC_USD_AMT_40FT,
/** TOTAL HANDLING COST (USD) **/
MAX( CASE WHEN T.TML_AWK_UC_CALC_TP_CD = 'S' THEN DECODE(T.CNTR_SZ_CD, '2', T.USD_AMT, '') END) SUM_USD_AMT_20FT,
MAX( CASE WHEN T.TML_AWK_UC_CALC_TP_CD = 'S' THEN DECODE(T.CNTR_SZ_CD, '4', T.USD_AMT, '') END) SUM_USD_AMT_40FT
FROM TES_AWK_CGO_TRF_HDR H, TES_AWK_CGO_TRF_DTL D, TES_AWK_CGO_TRF_TP_SZ T
WHERE 1=1
AND H.YD_CD = D.YD_CD
AND NVL(H.DELT_FLG, 'N') <> 'Y'
AND D.YD_CD = T.YD_CD
AND D.TML_AWK_CGO_TRF_TP_CD = T.TML_AWK_CGO_TRF_TP_CD
AND D.IO_BND_CD = T.IO_BND_CD
AND D.IO_GA_CD = T.IO_GA_CD
AND D.TML_AWK_TS_CD = T.TML_AWK_TS_CD
AND D.COND_NO = T.COND_NO
AND D.TML_AWK_TRF_VER_NO = T.TML_AWK_TRF_VER_NO
AND (D.YD_CD, D.TML_AWK_CGO_TRF_TP_CD, D.IO_BND_CD, D.IO_GA_CD, D.TML_AWK_TS_CD, D.COND_NO, D.TML_AWK_TRF_VER_NO) IN (
SELECT
DISTINCT TD.YD_CD, TD.TML_AWK_CGO_TRF_TP_CD, TD.IO_BND_CD, TD.IO_GA_CD, TD.TML_AWK_TS_CD, TD.COND_NO, TD.TML_AWK_TRF_VER_NO
FROM TES_AWK_CGO_TRF_TP_SZ TS, TES_AWK_CGO_TRF_DTL TD
WHERE 1=1
AND TS.YD_CD = TD.YD_CD
AND TS.TML_AWK_CGO_TRF_TP_CD = TD.TML_AWK_CGO_TRF_TP_CD
AND TS.IO_BND_CD = TD.IO_BND_CD
AND TS.IO_GA_CD = TD.IO_GA_CD
AND TS.TML_AWK_TS_CD = TD.TML_AWK_TS_CD
AND TS.COND_NO = TD.COND_NO
AND TS.TML_AWK_TRF_VER_NO = TD.TML_AWK_TRF_VER_NO
AND SUBSTR(TS.YD_CD,1,5) IN  (  SELECT
DISTINCT SUBSTR(TS.YD_CD,1,5) PORT
FROM PRI_SCQ_AWK_YD_DTL PD, PRI_SCQ_AWK_ROUT PR, TES_AWK_CGO_TRF_TP_SZ TS
WHERE 1=1
AND PD.SCQ_RQST_NO = PR.SCQ_RQST_NO
AND PD.SCQ_VER_NO = PR.SCQ_VER_NO
AND PD.ROUT_SEQ = PR.ROUT_SEQ
AND DECODE(PR.ROUT_TP_CD,'L','B','P','B','N','T') = TS.TML_AWK_CGO_TRF_TP_CD
AND TS.TML_AWK_CGO_TRF_TP_CD = 'B' --B로 고정
AND PD.SCQ_RQST_NO = @[scq_rqst_no]
AND PD.SCQ_VER_NO = @[scq_ver_no]
AND PD.ROUT_SEQ = @[rout_seq]
AND PD.COST_TP_CD = @[cost_tp_cd]
AND PD.SPCL_CGO_REF_SEQ = TS.SPCL_CGO_REF_SEQ
AND 'N' = NVL(@[tmp_yn],'X')
UNION ALL
SELECT
DISTINCT SUBSTR(TS.YD_CD,1,5) PORT
FROM PRI_SCQ_AWK_YD_DTL_TMP PD, PRI_SCQ_AWK_ROUT_TMP PR, TES_AWK_CGO_TRF_TP_SZ TS
WHERE 1=1
AND PD.SCQ_RQST_NO = PR.SCQ_RQST_NO
AND PD.SCQ_VER_NO = PR.SCQ_VER_NO
AND PD.ROUT_SEQ = PR.ROUT_SEQ
AND DECODE(PR.ROUT_TP_CD,'L','B','P','B','N','T') = TS.TML_AWK_CGO_TRF_TP_CD
AND TS.TML_AWK_CGO_TRF_TP_CD = 'B'  --B로 고정
AND PD.SCQ_RQST_NO = @[scq_rqst_no]
AND PD.SCQ_VER_NO = @[scq_ver_no]
AND PD.ROUT_SEQ =  @[rout_seq]
AND PD.COST_TP_CD = @[cost_tp_cd]
AND 'Y' = NVL(@[tmp_yn],'X')
AND PD.SPCL_CGO_REF_SEQ = TS.SPCL_CGO_REF_SEQ  )
)
GROUP BY T.YD_CD, T.TML_AWK_CGO_TRF_TP_CD, T.IO_BND_CD, T.IO_GA_CD, T.TML_AWK_TS_CD, T.COND_NO, T.TML_AWK_TRF_VER_NO
) X
, (
SELECT 
DISTINCT T.YD_CD, T.TML_AWK_CGO_TRF_TP_CD, T.IO_BND_CD, T.IO_GA_CD, T.TML_AWK_TS_CD, T.COND_NO, T.TML_AWK_TRF_VER_NO
FROM TES_AWK_CGO_TRF_TP_SZ T
WHERE 1=1
AND T.SPCL_CGO_REF_SEQ IN (
    SELECT 
    DISTINCT PD.SPCL_CGO_REF_SEQ
    FROM PRI_SCQ_AWK_YD_DTL PD
    WHERE 1=1
    AND PD.SCQ_RQST_NO = @[scq_rqst_no]
    AND PD.SCQ_VER_NO = @[scq_ver_no]
    AND PD.ROUT_SEQ = @[rout_seq]
    AND PD.COST_TP_CD = @[cost_tp_cd]
    AND 'N' = NVL(@[tmp_yn],'X')
    UNION ALL
    SELECT 
    DISTINCT PD.SPCL_CGO_REF_SEQ
    FROM PRI_SCQ_AWK_YD_DTL_TMP PD
    WHERE 1=1
        AND PD.SCQ_RQST_NO = @[scq_rqst_no]
        AND PD.SCQ_VER_NO = @[scq_ver_no]
        AND PD.ROUT_SEQ = @[rout_seq]
        AND PD.COST_TP_CD = @[cost_tp_cd]
        AND 'Y' = NVL(@[tmp_yn],'X')
    )    
) Y
WHERE 1=1
AND AH.YD_CD = AD.YD_CD
AND NVL(AH.DELT_FLG, 'N') <> 'Y'
AND AD.TML_AWK_CGO_TRF_TP_CD = 'B'
AND AD.YD_CD = X.YD_CD
AND AD.TML_AWK_CGO_TRF_TP_CD = X.TML_AWK_CGO_TRF_TP_CD
AND AD.IO_BND_CD = X.IO_BND_CD
AND AD.IO_GA_CD = X.IO_GA_CD
AND AD.TML_AWK_TS_CD = X.TML_AWK_TS_CD
AND AD.COND_NO = X.COND_NO
AND AD.TML_AWK_TRF_VER_NO = X.TML_AWK_TRF_VER_NO
AND X.YD_CD = Y.YD_CD(+)
AND X.TML_AWK_CGO_TRF_TP_CD = Y.TML_AWK_CGO_TRF_TP_CD(+)
AND X.IO_BND_CD = Y.IO_BND_CD(+)
AND X.IO_GA_CD = Y.IO_GA_CD(+)
AND X.TML_AWK_TS_CD = Y.TML_AWK_TS_CD(+)
AND X.COND_NO = Y.COND_NO(+)
AND X.TML_AWK_TRF_VER_NO = Y.TML_AWK_TRF_VER_NO(+)
) P
) K      
WHERE 1=1
AND (K.RN = 1 OR K.CHK_SPCL_CGO_REF_SEQ = 'Y')
ORDER BY K.YD_CD, K.TML_AWK_CGO_TRF_TP_CD, K.IO_BND_CD, K.IO_GA_CD, K.TML_AWK_TS_CD, K.COND_NO, K.TML_AWK_TRF_VER_NO DESC, K.MAN_LOCL_CURR_CD 			]]></sql>
			<params>
				<param name="scq_rqst_no" type="12" value="" out="N"/>
				<param name="scq_ver_no" type="12" value="" out="N"/>
				<param name="rout_seq" type="12" value="" out="N"/>
				<param name="cost_tp_cd" type="12" value="" out="N"/>
				<param name="tmp_yn" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
