<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="Edi315SendDBDAOSearchCOPInfoRSQL">
			<desc><![CDATA[for searching for COP INFO]]></desc>
			<sql><![CDATA[
SELECT * 
FROM 
(
    SELECT 
      LOC_NM POR_NAME,
      LOC_CD POR_CODE,
      DECODE(CNT_CD, 'US', 'D', 'K') POR_AMSQUAL,
      LOC_AMS_PORT_CD POR_AMSPORT
    FROM MDM_LOCATION
    WHERE 1=1
    AND LOC_CD = @[e_por_loc]
)POR_LOC
,(
    SELECT 
      LO.LOC_NM POL_NAME,
      BVD.POL_CD POL_CODE,
      DECODE(LO.CNT_CD, 'US', 'D', 'K') POL_AMSQUAL,
      LO.LOC_AMS_PORT_CD POL_AMSPORT
    FROM MDM_LOCATION LO,
      VSK_VSL_PORT_SKD VPS,
      BKG_VVD BVD ,
      VSK_VSL_SKD SKD
    WHERE 1=1
      AND BVD.BKG_NO = @[e_bkg_no]
      AND BVD.POL_CD = @[e_pol_loc]
      AND SKD.VSL_CD(+) = BVD.VSL_CD
      AND SKD.SKD_VOY_NO(+) = BVD.SKD_VOY_NO
      AND SKD.SKD_DIR_CD(+) = BVD.SKD_DIR_CD
      AND VPS.VSL_CD(+) = BVD.VSL_CD
      AND VPS.SKD_VOY_NO(+) = BVD.SKD_VOY_NO
      AND VPS.SKD_DIR_CD(+) = BVD.SKD_DIR_CD
      AND VPS.VPS_PORT_CD(+) = @[e_pol_loc]
      AND NVL(VPS.SKD_CNG_STS_CD, ' ') <> 'S'
      AND LO.LOC_CD(+) = @[e_pol_loc] -- VPS.VPS_PORT_CD
      AND ROWNUM = 1 
)POL_LOC
,(
    SELECT 
      LO.LOC_NM POD_NAME,
      BVD.POD_CD POD_CODE,
      DECODE(LO.CNT_CD, 'US', 'D', 'K') POD_AMSQUAL,
      LO.LOC_AMS_PORT_CD POD_AMSPORT
    FROM MDM_LOCATION LO,
      VSK_VSL_PORT_SKD VPS,
      BKG_VVD BVD ,
      VSK_VSL_SKD SKD
    WHERE 1=1
      AND BVD.BKG_NO = @[e_bkg_no]
      AND BVD.POD_CD = @[e_pod_loc]
      AND VPS.VSL_CD(+) = BVD.VSL_CD
      AND VPS.SKD_VOY_NO(+) = BVD.SKD_VOY_NO
      AND VPS.SKD_DIR_CD(+) = BVD.SKD_DIR_CD
      AND VPS.VPS_PORT_CD(+) = @[e_pod_loc]
      AND NVL(VPS.SKD_CNG_STS_CD, ' ') <> 'S'
      AND LO.LOC_CD(+) = @[e_pod_loc] --VPS.VPS_PORT_CD
      AND ROWNUM = 1 
)POD_LOC
,(
    SELECT 
      LOC_NM DEL_NAME,
      LOC_CD DEL_CODE,
      DECODE(CNT_CD, 'US', 'D', 'K') DEL_AMSQUAL,
      LOC_AMS_PORT_CD DEL_AMSPORT
    FROM MDM_LOCATION
    WHERE 1=1
    AND LOC_CD = @[e_del_loc]
)DEL_LOC
,(
    SELECT TO_CHAR(E_T, 'YYYYMMDDHH24MI') POR_ETD,
      DECODE(NOD, NULL, '', DECODE(E_T, NULL, '', TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC(NOD, E_T, 'GMT'), 'YYYYMMDDHH24MI'))) POR_ETD_GMT ,
      TO_CHAR(A_T, 'YYYYMMDDHH24MI') POR_ATD,
      DECODE(NOD, NULL, '', DECODE(A_T, NULL, '', TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC(NOD, A_T, 'GMT'), 'YYYYMMDDHH24MI'))) POR_ATD_GMT 
    FROM (
        SELECT 
          A.E_T,
          A.A_T,
          A.NOD
        FROM (
            SELECT ROWNUM F_ROW,
              DECODE(B.RCV_TERM_CD, 'D', ESTM_DT + 4/24, ESTM_DT) E_T,
              CASE WHEN DECODE(B.RCV_TERM_CD, 'D', ACT_DT + 4/24, ACT_DT) IS NULL
              AND D.ACT_STS_CD = 'F' THEN DECODE(B.RCV_TERM_CD, 'D', ESTM_DT + 4/24, ESTM_DT) ELSE DECODE(B.RCV_TERM_CD, 'D', ACT_DT + 4/24, ACT_DT) END A_T ,
              SUBSTR(H.POR_NOD_CD, 0, 5) NOD,
              D.ACT_CD,
              D.COP_DTL_SEQ
            FROM SCE_COP_HDR H,
              SCE_COP_DTL D,
              BKG_BOOKING B
            WHERE 1=1
              AND H.COP_NO = @[e_cop_no]
              AND H.COP_NO = D.COP_NO
              AND H.BKG_NO = B.BKG_NO
              AND ( (B.RCV_TERM_CD = 'D'
                      AND D.ACT_CD = 'MOTZAD')
                  OR (B.RCV_TERM_CD <> 'D'
                      AND SUBSTR(D.ACT_CD, 5, 1) = 'D') )
            ORDER BY D.COP_DTL_SEQ ASC ) A
        WHERE F_ROW = 1 )  
)POR_DATE
,(
    SELECT 
      TO_CHAR(E_T1, 'YYYYMMDDHH24MI') POL_ETA,
      DECODE(NOD, NULL, '', DECODE(E_T1, NULL, '', TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC(NOD, E_T1, 'GMT'), 'YYYYMMDDHH24MI'))) POL_ETA_GMT ,
      TO_CHAR(A_T1, 'YYYYMMDDHH24MI') POL_ATA,
      DECODE(NOD, NULL, '', DECODE(A_T1, NULL, '', TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC(NOD, A_T1, 'GMT'), 'YYYYMMDDHH24MI'))) POL_ATA_GMT ,
      TO_CHAR(E_T2, 'YYYYMMDDHH24MI') POL_ETD,
      DECODE(NOD, NULL, '', DECODE(E_T2, NULL, '', TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC(NOD, E_T2, 'GMT'), 'YYYYMMDDHH24MI'))) POL_ETD_GMT ,
      TO_CHAR(A_T2, 'YYYYMMDDHH24MI') POL_ATD,
      DECODE(NOD, NULL, '', DECODE(A_T2, NULL, '', TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC(NOD, A_T2, 'GMT'), 'YYYYMMDDHH24MI'))) POL_ATD_GMT
    FROM (
        SELECT A.BEF_ESTM_DT E_T1 ,
          CASE WHEN A.BEF_ACT_DT IS NULL
          AND A.BEF_COP_STS = 'F' THEN A.BEF_ESTM_DT ELSE A.BEF_ACT_DT END A_T1 ,
          A.AFT_ESTM_DT E_T2 ,
          CASE WHEN A.AFT_ACT_CD IS NULL
          AND A.AFT_COP_STS = 'F' THEN A.AFT_ESTM_DT ELSE A.AFT_ACT_CD END A_T2 ,
          A.BEF_NOD_CD NOD
        FROM (
            SELECT BEF_ESTM_DT,
              BEF_ACT_DT,
              BEF_NOD_CD,
              BEF_COP_STS,
              AFT_ESTM_DT,
              AFT_ACT_CD,
              AFT_NOD_CD,
              AFT_COP_STS
            FROM (
                SELECT STND_EDI_STS_CD,
                  D.ESTM_DT ,
                  LAG(D.ESTM_DT, 1) --  POL TEMINAL ARRIVAL 
                  OVER (PARTITION BY D.COP_NO
                    ORDER BY D.COP_NO, D.COP_DTL_SEQ) BEF_ESTM_DT ,
                  LAG(D.ACT_DT, 1) OVER (PARTITION BY D.COP_NO
                    ORDER BY D.COP_NO, D.COP_DTL_SEQ) BEF_ACT_DT ,
                  LAG(SUBSTR(D.NOD_CD, 1, 5), 1) OVER (PARTITION BY D.COP_NO
                    ORDER BY D.COP_NO, D.COP_DTL_SEQ) BEF_NOD_CD ,
                  LAG(D.ACT_STS_CD, 1) OVER (PARTITION BY D.COP_NO
                    ORDER BY D.COP_NO, D.COP_DTL_SEQ) BEF_COP_STS ,
                  LEAD(D.ESTM_DT, 1) -- POL VESSLE DEPARTURE 
                  OVER (PARTITION BY D.COP_NO
                    ORDER BY D.COP_NO, D.COP_DTL_SEQ) AFT_ESTM_DT ,
                  LEAD(D.ACT_DT, 1) OVER (PARTITION BY D.COP_NO
                    ORDER BY D.COP_NO, D.COP_DTL_SEQ) AFT_ACT_CD ,
                  LEAD(SUBSTR(D.NOD_CD, 1, 5), 1) OVER (PARTITION BY D.COP_NO
                    ORDER BY D.COP_NO, D.COP_DTL_SEQ) AFT_NOD_CD ,
                  LEAD(D.ACT_STS_CD, 1) OVER (PARTITION BY D.COP_NO
                    ORDER BY D.COP_NO, D.COP_DTL_SEQ) AFT_COP_STS
                FROM SCE_COP_DTL D
                WHERE 1=1
                AND D.COP_NO = @[e_cop_no] 
                )
            WHERE STND_EDI_STS_CD = 'AEL' ) A )
)POL_DATE
,(
select                                                                                                                                                                                                                                                                                                                                         
     TO_CHAR(e_t1, 'YYYYMMDDHH24MI') POD_ETA                                                                                                                                                                                                                                                                                                       
    ,DECODE(nod, NULL, '',                                                                                                                                                                                                                                                                                                                       
                       DECODE(e_t1, NULL, '',                                                                                                                                                                                                                                                                                                   
                       TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC(nod, e_t1, 'GMT'),                                                                                                                                                                                                                                                                  
                                   'YYYYMMDDHH24MI'))) POD_ETA_GMT                                                                                                                                                                                                                                                                               
    ,TO_CHAR(a_t1, 'YYYYMMDDHH24MI') POD_ATA                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                
    ,DECODE(nod, NULL, '',                                                                                                                                                                                                                                                                                                                       
                       DECODE(a_t1, NULL, '',                                                                                                                                                                                                                                                                                                   
                       TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC(nod, a_t1, 'GMT'),                                                                                                                                                                                                                                                                  
                                   'YYYYMMDDHH24MI'))) POD_ATA_GMT                                                                                                                                                                                                                                                                              
    ,TO_CHAR(e_t2, 'YYYYMMDDHH24MI') POD_ETD                                                                                                                                                                                                                                                                                                      
    ,DECODE(nod, NULL, '',                                                                                                                                                                                                                                                                                                                       
                       DECODE(e_t2, NULL, '',                                                                                                                                                                                                                                                                                                   
                       TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC(nod, e_t2, 'GMT'),                                                                                                                                                                                                                                                                  
                                   'YYYYMMDDHH24MI'))) POD_ETD_GMT                                                                                                                                                                                                                                                                                 
    ,TO_CHAR(a_t2, 'YYYYMMDDHH24MI') POD_ATD                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                
    ,DECODE(nod, NULL, '',                                                                                                                                                                                                                                                                                                                       
                       DECODE(a_t2, NULL, '',                                                                                                                                                                                                                                                                                                   
                       TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC(nod, a_t2, 'GMT'),                                                                                                                                                                                                                                                                  
                                   'YYYYMMDDHH24MI'))) POD_ATD_GMT                                                                                                                                                                                                                                                                                 
from (                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                
                -- 2009.11.04 hkoh 추가 START                                                                                                                                                                                                                                                                                                   
        select   case when sub_act_cd = 'V' then a.bef_estm_dt0                                                                                                                                                                                                                                                                                 
                      when sub_act_cd = 'W' then a.bef_estm_dt                                                                                                                                                                                                                                                                                  
                 end  e_t1                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                
                ,case when sub_act_cd = 'V' then case when  a.bef_act_dt0 is null and a.bef_cop_sts0 = 'F' then a.bef_estm_dt0 else a.bef_act_dt0 end                                                                                                                                                                                           
                      when sub_act_cd = 'W' then case when  a.bef_act_dt  is null and a.bef_cop_sts  = 'F' then a.bef_estm_dt  else a.bef_act_dt  end                                                                                                                                                                                           
                 end  a_t1                                                                                                                                                                                                                                                                                                                      
                -- 2009.11.04 hkoh 추가 END. 하단 주석처리                                                                                                                                                                                                                                                                                      
                ,a.aft_estm_dt e_t2                                                                                                                                                                                                                                                                                                             
                ,case when a.aft_act_cd is null and a.aft_cop_sts = 'F' then a.aft_estm_dt                                                                                                                                                                                                                                                      
                    else a.aft_act_cd                                                                                                                                                                                                                                                                                                           
                    end a_t2                                                                                                                                                                                                                                                                                                                    
                ,a.bef_nod_cd nod                                                                                                                                                                                                                                                                                                               
            from                                                                                                                                                                                                                                                                                                                                
            (                                                                                                                                                                                                                                                                                                                                   
                select bef_estm_dt0, bef_act_dt0, bef_nod_cd0, bef_cop_sts0,                                                                                                                                                                                                                                                                    
                       bef_estm_dt,  bef_act_dt,  bef_nod_cd,  bef_cop_sts,                                                                                                                                                                                                                                                                     
                       aft_estm_dt,  aft_act_cd,  aft_nod_cd,  aft_cop_sts ,                                                                                                                                                                                                                                                                    
                       sub_act_cd                                                                                                                                                                                                                                                                                                               
                from (                                                                                                                                                                                                                                                                                                                          
                    select      stnd_edi_sts_cd, SUBSTR(act_cd,3,1) sub_act_cd , d.estm_dt                                                                                                                                                                                                                                                      
                                -- 2009.11.04 hkoh 추가 START                                                                                                                                                                                                                                                                                   
                                ,LAG(d.estm_dt, 2)              --  T/S Port Depature(Water)/ POD arraival (Vessel)                                                                                                                                                                                                                             
                                OVER (PARTITION BY d.cop_no                                                                                                                                                                                                                                                                                     
                                ORDER  BY d.cop_no, d.cop_dtl_seq) bef_estm_dt0                                                                                                                                                                                                                                                  
                                ,LAG(d.act_dt, 2)                                                                                                                                                                                                                                                                                               
                                OVER (PARTITION BY d.cop_no                                                                                                                                                                                                                                                                                     
                                ORDER  BY d.cop_no, d.cop_dtl_seq) bef_act_dt0                                                                                                                                                                                                                                                   
                                ,LAG(substr(d.nod_cd,1,5), 2)                                                                                                                                                                                                                                                                                   
                                OVER (PARTITION BY d.cop_no                                                                                                                                                                                                                                                                                     
                                ORDER  BY d.cop_no, d.cop_dtl_seq) bef_nod_cd0                                                                                                                                                                                                                                                   
                                ,LAG(d.act_sts_cd, 2)                                                                                                                                                                                                                                                                                           
                                OVER (PARTITION BY d.cop_no                                                                                                                                                                                                                                                                                     
                                ORDER  BY d.cop_no, d.cop_dtl_seq) bef_cop_sts0                                                                                                                                                                                                                                                  
                                -- 2009.11.04 hkoh 추가 END                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                
                                ,LAG(d.estm_dt, 1)              --  pod teminal arrival(Water)/ Berthing(Vessel)                                                                                                                                                                                                                                
                                OVER (PARTITION BY d.cop_no                                                                                                                                                                                                                                                                                     
                                ORDER  BY d.cop_no, d.cop_dtl_seq) bef_estm_dt                                                                                                                                                                                                                                                   
                                ,LAG(d.act_dt, 1)                                                                                                                                                                                                                                                                                               
                                OVER (PARTITION BY d.cop_no                                                                                                                                                                                                                                                                                     
                                ORDER  BY d.cop_no, d.cop_dtl_seq) bef_act_dt                                                                                                                                                                                                                                                    
                                ,LAG(substr(d.nod_cd,1,5), 1)                                                                                                                                                                                                                                                                                   
                                OVER (PARTITION BY d.cop_no                                                                                                                                                                                                                                                                                     
                                ORDER  BY d.cop_no, d.cop_dtl_seq) bef_nod_cd                                                                                                                                                                                                                                                    
                                ,LAG(d.act_sts_cd, 1)                                                                                                                                                                                                                                                                                           
                                OVER (PARTITION BY d.cop_no                                                                                                                                                                                                                                                                                     
                                ORDER  BY d.cop_no, d.cop_dtl_seq) bef_cop_sts                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                
                                ,LEAD(d.estm_dt, 1)             -- pod vessle departure                                                                                                                                                                                                                                                         
                                OVER (PARTITION BY d.cop_no                                                                                                                                                                                                                                                                                     
                                ORDER  BY d.cop_no, d.cop_dtl_seq) aft_estm_dt                                                                                                                                                                                                                                                   
                                ,LEAD(d.act_dt, 1)                                                                                                                                                                                                                                                                                              
                                OVER (PARTITION BY d.cop_no                                                                                                                                                                                                                                                                                     
                                ORDER  BY d.cop_no, d.cop_dtl_seq) aft_act_cd                                                                                                                                                                                                                                                    
                                ,LEAD(substr(d.nod_cd,1,5), 1)                                                                                                                                                                                                                                                                                  
                                OVER (PARTITION BY d.cop_no                                                                                                                                                                                                                                                                                     
                                ORDER  BY d.cop_no, d.cop_dtl_seq) aft_nod_cd                                                                                                                                                                                                                                                    
                                ,LEAD(d.act_sts_cd, 1)                                                                                                                                                                                                                                                                                          
                                OVER (PARTITION BY d.cop_no                                                                                                                                                                                                                                                                                     
                                ORDER  BY d.cop_no, d.cop_dtl_seq) aft_cop_sts                                                                                                                                                                                                                                                   
                    from    sce_cop_dtl d                                                                                                                                                                                                                                                                                                       
                    where   d.cop_no = @[e_cop_no]                                                                                                                                                                                                                                                                                                  
                    )                                                                                                                                                                                                                                                                                                                           
                where stnd_edi_sts_cd = 'UVD'    
				and rownum = 1                                                                                                                                                                                                                                                                                               
        ) a                                                                                                                                                                                                                                                                                                                                     
    )   
)POD_DATE
,(
    SELECT 
      TO_CHAR(E_T, 'YYYYMMDDHH24MI') DEL_ETA,
      DECODE(NOD, NULL, '', DECODE(E_T, NULL, '', TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC(NOD, E_T, 'GMT'), 'YYYYMMDDHH24MI'))) DEL_ETA_GMT ,
      TO_CHAR(A_T, 'YYYYMMDDHH24MI') DEL_ATA,
      DECODE(NOD, NULL, '', DECODE(A_T, NULL, '', TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC(NOD, A_T, 'GMT'), 'YYYYMMDDHH24MI'))) DEL_ATA_GMT,
      DEL_NOD
    FROM (
        SELECT ESTM_DT E_T,
          CASE WHEN ACT_DT IS NULL
          AND D.ACT_STS_CD = 'F' THEN ESTM_DT ELSE ACT_DT END A_T ,
          SUBSTR(H.DEL_NOD_CD, 0, 5) NOD ,
          D.NOD_CD DEL_NOD 
        FROM SCE_COP_HDR H,
          SCE_COP_DTL D
        WHERE 1=1
          AND H.COP_NO = @[e_cop_no]
          AND H.COP_NO = D.COP_NO
          AND H.DEL_NOD_CD = D.NOD_CD
          AND SUBSTR(D.ACT_CD, 5, 1) = 'A'
          AND ROWNUM = 1 )
)DEL_DATE			]]></sql>
			<params>
				<param name="e_por_loc" type="12" value="" out="N"/>
				<param name="e_bkg_no" type="12" value="" out="N"/>
				<param name="e_pol_loc" type="12" value="" out="N"/>
				<param name="e_pod_loc" type="12" value="" out="N"/>
				<param name="e_del_loc" type="12" value="" out="N"/>
				<param name="e_cop_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
