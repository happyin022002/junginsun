<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="WorkOrderPreviewDBDAOSearchWorkOrderPreviewIssueStatusRSQL">
			<desc><![CDATA[Search WorkOrder Preview Issue Status]]></desc>
			<sql><![CDATA[
SELECT a.wo_prv_grp_seq
		 ,a.wo_iss_no
		 ,a.wo_fmt_tp_cd
		 ,a.wo_iss_sts_cd
		 ,a.vndr_seq
		 ,a.trsp_wo_ofc_cty_cd
		 ,a.trsp_wo_seq
		 ,a.trsp_crr_mod_cd
		 ,COUNT(wo_iss_no) cnt
		 ,b.vndr_lgl_eng_nm
		 ,b.wo_edi_use_flg
		 ,c.conti_cd
		 ,d.trsp_cost_dtl_mod_cd
		 ,d.trsp_bnd_cd
		 ,a.fm_nod_cd
		 ,a.to_nod_cd
		 ,a.via_nod_cd
		 ,a.dor_nod_cd	
		 ,e.inter_use_flg
		 ,NVL(e.wo_rmk, f.wo_instr_rmk) wo_instr_rmk
		 ,DECODE(MAX(D.SPOT_BID_FLG), 'Y', '',MAX(decode(fx.wo_cc_seq, 1, fx.wo_fax_no))) fax1
		 ,DECODE(MAX(D.SPOT_BID_FLG), 'Y', '',MAX(decode(fx.wo_cc_seq, 2, fx.wo_fax_no))) fax2
		 ,DECODE(MAX(D.SPOT_BID_FLG), 'Y', '',MAX(decode(fx.wo_cc_seq, 3, fx.wo_fax_no))) fax3
,DECODE(MAX(D.SPOT_BID_FLG), 'Y', TRS_COM_SPOT_BID_PKG.GET_MODI_SPOT_BID_VNDR_EML(A.WO_PRV_GRP_SEQ, A.WO_ISS_NO)
,MAX(decode(el.wo_cc_seq, 1, el.wo_eml)) || DECODE(MAX(decode(el.wo_cc_seq, 2, el.wo_eml)),NULL,'',';') ||
 MAX(decode(el.wo_cc_seq, 2, el.wo_eml)) || DECODE(MAX(decode(el.wo_cc_seq, 3, el.wo_eml)),NULL,'',';') ||
 MAX(decode(el.wo_cc_seq, 3, el.wo_eml)) || DECODE(MAX(decode(el.wo_cc_seq, 4, el.wo_eml)),NULL,'',';') ||
 MAX(decode(el.wo_cc_seq, 4, el.wo_eml)) || DECODE(MAX(decode(el.wo_cc_seq, 5, el.wo_eml)),NULL,'',';') ||
 MAX(decode(el.wo_cc_seq, 5, el.wo_eml)) || DECODE(MAX(decode(el.wo_cc_seq, 6, el.wo_eml)),NULL,'',';') ||
 MAX(decode(el.wo_cc_seq, 6, el.wo_eml))) as eml1
		 ,edi.edi_rcvr_nm_use_flg
         ,d.SKD_DIR_CD
         ,(CASE WHEN (A.WO_ISS_STS_CD = 'I' OR A.WO_ISS_STS_CD = 'R' OR A.WO_ISS_STS_CD = 'C')  -- ISSUED 일경우 0이 아닌경우 Y
                THEN (CASE WHEN (NVL(MAX(A.NEGO_AMT), 0) != 0 OR NVL(MIN(A.NEGO_AMT), 0) != 0 ) THEN 'Y' ELSE 'N' END)
                ELSE 'N'
            END) NEGO_FLG
         ,(CASE WHEN (A.WO_ISS_STS_CD = 'I' OR A.WO_ISS_STS_CD = 'R' OR A.WO_ISS_STS_CD = 'C')
                THEN (CASE WHEN (SELECT MAX(CASE WHEN NVL(SDT.SCG_AMT, 0) != 0 THEN 1 ELSE 0 END) KEEP(DENSE_RANK FIRST ORDER BY IWOPT.WO_PRV_GRP_SEQ ASC)
                                   FROM TRS_TRSP_SCG_DTL_TMP SDT,
                                        TRS_TRSP_WRK_ORD_PRV_TMP IWOPT
                                  WHERE 1=1
                                    AND SDT.TRSP_AGMT_BFR_EXTD_FLG = 'N'
                                    AND SDT.LGS_COST_CD IN (SELECT LGS_COST_CD FROM TES_LGS_COST WHERE LGS_COST_SUBJ_CD IN ('SC', 'SM') AND (SUBSTR(LGS_COST_CD,3,2) <> 'FU' AND SUBSTR(LGS_COST_CD, 3, 4) <> 'OTAX'))
                                    AND IWOPT.WO_PRV_GRP_SEQ     = A.WO_PRV_GRP_SEQ
                                    AND IWOPT.VNDR_SEQ           = A.VNDR_SEQ
                                    AND IWOPT.WO_ISS_NO          = A.WO_ISS_NO
                                    AND SDT.WO_PRV_GRP_SEQ       = @[scg_grp_seq]  --7651257    -- 현재 SCG_DTL_TMP_SEQ
                                    AND IWOPT.TRSP_SO_OFC_CTY_CD = SDT.TRSP_SO_OFC_CTY_CD(+)
                                    AND IWOPT.TRSP_SO_SEQ        = SDT.TRSP_SO_SEQ(+)) != 0
                           THEN 'Y' 
                           ELSE 'N' END)
                ELSE 'N'
            END) ADDI_FLG
         , NVL(MAX(D.SPOT_BID_FLG), 'N') AS SPOT_BID_FLG
/*  CHM-201536387  NEGO, SURCHARGE  */
     FROM trs_trsp_wrk_ord_prv_tmp	a
		 ,mdm_vendor b
		 ,mdm_location c
		 ,trs_trsp_svc_ord d
		 ,trs_trsp_wrk_ord e
		 ,trs_trsp_wrk_ord_instr f
		 ,trs_trsp_wrk_ord_cc_fax fx
		 ,trs_trsp_wrk_ord_cc_eml el
		 ,trs_edi_usa_rcvr_dtl edi															
    WHERE wo_prv_grp_seq = @[wo_prv_grp_seq]
  	  AND a.vndr_seq = b.vndr_seq(+)
  	  AND SUBSTR(a.fm_nod_cd, 1, 5) = c.loc_cd
  	  AND a.trsp_so_ofc_cty_cd = d.trsp_so_ofc_cty_cd
  	  AND a.trsp_so_seq = d.trsp_so_seq
  	  AND a.trsp_wo_ofc_cty_cd = e.trsp_wo_ofc_cty_cd(+)
  	  AND a.trsp_wo_seq = e.trsp_wo_seq(+)						
   	  AND d.trsp_cost_dtl_mod_cd = f.trsp_cost_mod_cd(+)
  	  AND d.trsp_crr_mod_cd = f.trsp_crr_mod_cd(+)								
  	  AND d.trsp_bnd_cd = f.trsp_bnd_cd(+)									
  	  AND d.cre_ofc_cd = f.wo_instr_ofc_cd(+)
  	  AND a.vndr_seq = fx.vndr_seq(+)									
  	  AND a.vndr_seq = el.vndr_seq(+)
  	  AND a.vndr_seq = edi.vndr_seq(+)
  	  AND d.hjl_no is null
  	  AND e.hjl_no is null
  	  AND f.hjl_no is null
 GROUP BY a.wo_prv_grp_seq
		 ,a.wo_iss_no
		 ,a.wo_fmt_tp_cd
		 ,a.wo_iss_sts_cd
		 ,a.vndr_seq
		 ,a.trsp_crr_mod_cd
		 ,a.trsp_wo_ofc_cty_cd
		 ,a.trsp_wo_seq
		 ,b.vndr_lgl_eng_nm
		 ,b.wo_edi_use_flg
		 ,c.conti_cd
		 ,d.trsp_cost_dtl_mod_cd
		 ,d.trsp_bnd_cd
		 ,a.fm_nod_cd
		 ,a.to_nod_cd
		 ,a.via_nod_cd
		 ,a.dor_nod_cd
		 ,f.wo_instr_rmk
		 ,e.wo_rmk
		 ,e.inter_use_flg
		 ,edi.edi_rcvr_nm_use_flg
         ,d.SKD_DIR_CD
 ORDER BY wo_iss_no			]]></sql>
			<params>
				<param name="scg_grp_seq" type="12" value="7651308" out="N"/>
				<param name="wo_prv_grp_seq" type="12" value="4180425" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
