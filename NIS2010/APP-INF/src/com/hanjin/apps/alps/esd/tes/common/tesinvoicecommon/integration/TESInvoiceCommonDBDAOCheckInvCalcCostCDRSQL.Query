<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TESInvoiceCommonDBDAOCheckInvCalcCostCDRSQL">
			<desc><![CDATA[CheckInvCalcCostCD]]></desc>
			<sql><![CDATA[
SELECT
	 H.INV_NO, D.TML_CRR_CD, D.LGS_COST_CD,
	 CASE
	 WHEN (SELECT SUM(NVL(DECODE(D2.CALC_TP_CD,'A',1,0),0)) FROM TES_TML_SO_DTL D2
		   WHERE D2.TML_SO_OFC_CTY_CD = D.TML_SO_OFC_CTY_CD AND D2.TML_SO_SEQ = D.TML_SO_SEQ) > 0 THEN 'Y'  --하나라도 'AUTO'인 경우 무조건 통과
--		소급 적용 처리 기능 추가 ( 2009-06-17 이경한 과장)
	 WHEN NVL(H.RTRO_TML_INV_FLG, 'N' ) = 'Y' THEN 'Y' 		  --소급 적용 처리 값이 'Y'인 경우 통과
	 WHEN SUM(NVL(DECODE(D.CALC_TP_CD,'M',0,1),0)) = 0 THEN      --전부 'MANUAL'인 경우 TES_TML_SO_COST.CNTR_STY_CD가 전부 'M'일 경우 통과
		CASE
		WHEN (SELECT C.CNTR_STY_CD FROM TES_TML_SO_COST C WHERE C.LGS_COST_CD = D.LGS_COST_CD) <> 'M' THEN
			CASE
			WHEN (SELECT C.COST_CALC_MZD_CD FROM TES_TML_SO_COST C WHERE C.LGS_COST_CD = D.LGS_COST_CD) = 'A' THEN
				DECODE(D.TML_CRR_CD,NULL,'N','','N',DECODE(D.TML_CRR_CD,' ','N','SML','N','Y')) --LGS_COST_CD가 'A' MODE 일 경우 CRR_CD가 NULL,' ','SML'이외의 값이면 통과
			ELSE 'Y'
			END
		ELSE 'Y'
		END
	 WHEN COUNT(D.TML_SO_DTL_SEQ)=0 THEN 'NF'
	 ELSE 'N'
	 END CHK
 FROM TES_TML_SO_HDR H, TES_TML_SO_DTL D
 WHERE 1=1
 AND H.TML_SO_OFC_CTY_CD	= D.TML_SO_OFC_CTY_CD
 AND H.TML_SO_SEQ			= D.TML_SO_SEQ
 AND H.TML_SO_OFC_CTY_CD	= @[tml_so_ofc_cty_cd]
 AND H.TML_SO_SEQ			= @[tml_so_seq]
 AND NVL(H.DELT_FLG,'N') <> 'Y'
 AND SUBSTR(D.LGS_COST_CD,1,2) <> 'SR'
 AND D.LGS_COST_CD <> 'SVLDBB'
 GROUP BY D.TML_SO_OFC_CTY_CD, D.TML_SO_SEQ, H.INV_NO, D.LGS_COST_CD, D.TML_CRR_CD, H.RTRO_TML_INV_FLG			]]></sql>
			<params>
				<param name="tml_so_ofc_cty_cd" type="12" value="" out="N"/>
				<param name="tml_so_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
