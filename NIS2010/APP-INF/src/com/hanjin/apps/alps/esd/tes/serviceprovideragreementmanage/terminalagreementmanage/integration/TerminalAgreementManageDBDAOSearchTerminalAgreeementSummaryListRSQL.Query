<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TerminalAgreementManageDBDAOSearchTerminalAgreeementSummaryListRSQL">
			<desc><![CDATA[TerminalAgreementManage의 모든 목록을 가져온다]]></desc>
			<sql><![CDATA[
#if (${eff_agmt} == 'L')
SELECT	X.TML_AGMT_OFC_CTY_CD
		, X.TML_AGMT_SEQ 
		, X.AGMT_NO
		, X.TML_AGMT_VER_NO
		, X.VER_NO
		, X.YD_CD
		, X.VNDR_SEQ
		, X.YD_NM
		, X.VNDR_LGL_ENG_NM
		, X.EFF_FM_DT
		, X.EFF_TO_DT
		, X.AUTO_XTD_FLG
		, X.CTRT_OFC_CD
		, X.CURR_CD
		, X.CRE_DT
		, X.CRE_USR_ID
		, X.CRE_USR_NM
		, X.UPD_DT
		, X.UPD_USR_ID
		, X.UPD_USR_NM
		, X.DELT_FLG
		, X.TML_AGMT_STS_CD
		, X.CRE_OFC_CD
		, X.AGMT_APRO_DT
		, X.AGMT_CFM_DT
		, X.AGMT_CFM_FLG
		, X.AGMT_CFM_USR_NM
		, X.AGMT_CFM_USR_ID
		, X.GW_CONT_YN
		, X.AGMT_DOC_NO
		, X.AGMT_DOC_DESC
		, X.AGMT_DOC_EFF_FM_DT
		, X.AGMT_DOC_EFF_TO_DT
FROM	(
#end
			SELECT	A.TML_AGMT_OFC_CTY_CD
					, A.TML_AGMT_SEQ 
					, A.TML_AGMT_OFC_CTY_CD || LPAD( A.TML_AGMT_SEQ, 5, '0' ) AS AGMT_NO
					, A.TML_AGMT_VER_NO
					, CASE 		WHEN LENGTH(A.TML_AGMT_VER_NO) = 3
								THEN LPAD(SUBSTR( A.TML_AGMT_VER_NO, 0, 1 ), 2, '0') || '.' || SUBSTR( A.TML_AGMT_VER_NO, 2, 2 )
								ELSE SUBSTR( A.TML_AGMT_VER_NO, 0, 2 ) || '.' || SUBSTR( A.TML_AGMT_VER_NO, 3, 2 )
					  END VER_NO
					, A.YD_CD
					, LPAD(A.VNDR_SEQ, 6, '0') VNDR_SEQ
					, C.YD_NM
					, D.VNDR_LGL_ENG_NM
					, TO_CHAR(A.EFF_FM_DT, 'YYYY-MM-DD')	EFF_FM_DT
					, TO_CHAR(A.EFF_TO_DT, 'YYYY-MM-DD')	EFF_TO_DT
					, A.AUTO_XTD_FLG
					, A.CTRT_OFC_CD
					, B.CURR_CD
					, TO_CHAR(A.CRE_DT, 'YYYY-MM-DD')	CRE_DT
					, A.CRE_USR_ID
					, (SELECT USR_NM FROM COM_USER WHERE USR_ID = A.CRE_USR_ID) CRE_USR_NM
					, TO_CHAR(A.UPD_DT, 'YYYY-MM-DD')	UPD_DT
					, A.UPD_USR_ID
					, (SELECT USR_NM FROM COM_USER WHERE USR_ID = A.UPD_USR_ID) UPD_USR_NM
					, A.DELT_FLG
					, A.TML_AGMT_STS_CD
					, A.CRE_OFC_CD
					, TO_CHAR(A.AGMT_APRO_DT, 'YYYY-MM-DD') AGMT_APRO_DT
					, TO_CHAR(A.AGMT_CFM_DT, 'YYYY-MM-DD') AGMT_CFM_DT
					, A.AGMT_CFM_FLG
					, AGMT_CFM_USR_NM
					, AGMT_CFM_USR_ID
					-- 비용지급 전표 결재 기능 - 3차 추가(4347-09-25)
					, DECODE(A.AGMT_DOC_NO, NULL, 'N', 'Y') AS GW_CONT_YN
					, A.AGMT_DOC_NO
					, A.AGMT_DOC_DESC
					, A.AGMT_DOC_EFF_FM_DT
					, A.AGMT_DOC_EFF_TO_DT
					, RANK() OVER (PARTITION BY A.TML_AGMT_OFC_CTY_CD, A.TML_AGMT_SEQ, A.YD_CD, LPAD(A.VNDR_SEQ, 6, '0')
									ORDER BY A.TML_AGMT_VER_NO DESC) AS RANK_NO
			FROM	TES_TML_AGMT_HDR A, TES_TML_AGMT_DTL B, MDM_YARD C, MDM_VENDOR D
			WHERE	1	= 1
			#if (${yd_cd} != '')
			AND		A.YD_CD		= @[yd_cd]
			#end
			#if (${vndr_seq} != '')
			AND		A.VNDR_SEQ	= @[vndr_seq]
			#end
			#if (${eff_agmt} == 'C' || ${eff_agmt} == 'L')
			AND		GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC(@[ofc_cd]) BETWEEN A.EFF_FM_DT AND A.EFF_TO_DT
			#elseif (${eff_agmt} == 'P')
			AND		GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC(@[ofc_cd]) > EFF_TO_DT
			#end
			#if (${eff_on} != '')
			AND		@[eff_on] BETWEEN TO_CHAR(A.EFF_FM_DT, 'YYYY-MM-DD') AND TO_CHAR(A.EFF_TO_DT, 'YYYY-MM-DD')
			#end
			#if (${ctrt_ofc_cd} != '')
				#if($sub_ofc_cd1.size() > 0)
				AND     A.CTRT_OFC_CD IN (
				#foreach($sub_ofc_cd1_num IN ${sub_ofc_cd1})
					#if($velocityCount < $sub_ofc_cd1.size()) 
						'$sub_ofc_cd1_num', 
					#else 
						'$sub_ofc_cd1_num' 
					#end 
				#end
						)
				#else
				AND		A.CTRT_OFC_CD = @[ctrt_ofc_cd]
				#end
			#end
			#if (${delt_flg} != '')
			AND		A.DELT_FLG = @[delt_flg]
			#end
			#if (${tml_agmt_sts_cd} != '')
			AND		A.TML_AGMT_STS_CD = @[tml_agmt_sts_cd]
			#end

			#if (${cre_ofc_cd2} != '')
				#if($sub_ofc_cd2.size() > 0)
				AND     A.CRE_OFC_CD IN (
				#foreach($sub_ofc_cd2_num IN ${sub_ofc_cd2})
					#if($velocityCount < $sub_ofc_cd2.size()) 
						'$sub_ofc_cd2_num', 
					#else 
						'$sub_ofc_cd2_num' 
					#end 
				#end
						)
				#else
				AND		A.CRE_OFC_CD = @[cre_ofc_cd2]
				#end
			#end			

			AND		A.TML_AGMT_OFC_CTY_CD	= B.TML_AGMT_OFC_CTY_CD(+)
			AND		A.TML_AGMT_SEQ			= B.TML_AGMT_SEQ(+)
			AND		A.TML_AGMT_VER_NO		= B.TML_AGMT_VER_NO(+)
			AND		A.YD_CD					= C.YD_CD
			AND		A.VNDR_SEQ				= D.VNDR_SEQ
			AND     B.TMP_SAV_FLG IS NULL -- [CHM-201535964]Agreement Summary화면에서 Currency는 Creation화면의 Apply버튼으로 최종 확정된 분만 반영 
			GROUP BY
					A.TML_AGMT_OFC_CTY_CD
					, A.TML_AGMT_SEQ
					, A.TML_AGMT_VER_NO
					, A.YD_CD
					, LPAD(A.VNDR_SEQ, 6, '0')
					, C.YD_NM
					, D.VNDR_LGL_ENG_NM
					, TO_CHAR(A.EFF_FM_DT, 'YYYY-MM-DD')
					, TO_CHAR(A.EFF_TO_DT, 'YYYY-MM-DD')
					, A.AUTO_XTD_FLG
					, A.CTRT_OFC_CD
					, B.CURR_CD
					, TO_CHAR(A.CRE_DT, 'YYYY-MM-DD')
					, A.CRE_USR_ID
					, TO_CHAR(A.UPD_DT, 'YYYY-MM-DD')
					, A.UPD_USR_ID
					, A.DELT_FLG
					, A.TML_AGMT_STS_CD
					, A.CRE_OFC_CD
					, TO_CHAR(A.AGMT_APRO_DT, 'YYYY-MM-DD') 
					, TO_CHAR(A.AGMT_CFM_DT, 'YYYY-MM-DD') 
					, AGMT_CFM_USR_NM
					, AGMT_CFM_USR_ID
					, A.AGMT_CFM_FLG
					, DECODE(A.AGMT_DOC_NO, NULL, 'N', 'Y')
					, A.AGMT_DOC_NO
					, A.AGMT_DOC_DESC
					, A.AGMT_DOC_EFF_FM_DT
					, A.AGMT_DOC_EFF_TO_DT
			ORDER BY  A.TML_AGMT_OFC_CTY_CD
					, A.TML_AGMT_SEQ
					, A.TML_AGMT_VER_NO
#if (${eff_agmt} == 'L')
		) X
WHERE	RANK_NO = 1
#end			]]></sql>
			<params>
				<param name="yd_cd" type="12" value="" out="N"/>
				<param name="vndr_seq" type="2" value="" out="N"/>
				<param name="ofc_cd" type="12" value="" out="N"/>
				<param name="eff_on" type="12" value="" out="N"/>
				<param name="ctrt_ofc_cd" type="12" value="" out="N"/>
				<param name="delt_flg" type="12" value="" out="N"/>
				<param name="tml_agmt_sts_cd" type="12" value="" out="N"/>
				<param name="cre_ofc_cd2" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
