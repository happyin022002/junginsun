<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ActualCostCalcManageDBDAOGetActCostCALCRSQL">
			<desc><![CDATA[actual cost calc]]></desc>
			<sql><![CDATA[
SELECT 
X.FM_NOD_CD FM_YD_CD
, X.TO_NOD_CD TO_YD_CD
, @[act_cost_trf_tp_shuttle] TRSP_AWK_CGO_TRF_TP_CD
, X.IN_OUT_GAUAGE IO_GA_CD
, X.TRSP_CRR_MOD_CD TRSP_CRR_MOD_CD
, X.FT20 ACTUAL_2OFT_AMT
, X.FT40 ACTUAL_4OFT_AMT
FROM (

        SELECT (SELECT TO_CHAR(SYSDATE, 'YYYYMM') FROM DUAL) YEAR_MONTH
              ,FM_NOD_CD
              ,TO_NOD_CD
              ,IN_OUT_GAUAGE
              ,TRSP_CRR_MOD_CD
              ,'USD' CURR
              ,CASE WHEN SUM(DECODE(SUBSTR(EQ_TPSZ_CD, 2, 1), '2', 1, 0))=0 THEN 0
                                                                            ELSE ROUND(SUM(DECODE(SUBSTR(EQ_TPSZ_CD, 2, 1), '2', USD_AMT, 0))/SUM(DECODE(SUBSTR(EQ_TPSZ_CD, 2, 1), '2', 1, 0)),2) 
                    END FT20
              ,CASE WHEN SUM(DECODE(SUBSTR(EQ_TPSZ_CD, 2, 1), '2', 0, 1))=0 THEN 0
                                                                            ELSE ROUND(SUM(DECODE(SUBSTR(EQ_TPSZ_CD, 2, 1), '2', 0, USD_AMT))/SUM(DECODE(SUBSTR(EQ_TPSZ_CD, 2, 1), '2', 0, 1)),2) 
                    END FT40
              ,'SYSTEM'
              ,SYSDATE
              ,'SYSTEM'
              ,SYSDATE 
        FROM
        (
            SELECT A.FM_NOD_CD
                  ,A.TO_NOD_CD
                  ,A.TRSP_CRR_MOD_CD
                  ,A.EQ_TPSZ_CD
                  ,DECODE(C.IN_GA_FLG, 'Y' ,'I', 'N', 'O')  IN_OUT_GAUAGE
                  ,A.INV_CURR_CD
                  ,A.INV_BZC_AMT
                  ,A.INV_ETC_ADD_AMT
                  ,ROUND((NVL(A.INV_BZC_AMT,0)+NVL(A.INV_ETC_ADD_AMT,0)) / B.USD_LOCL_XCH_RT, 2) USD_AMT 
                  ,B.USD_LOCL_XCH_RT     
                  ,TO_CHAR(A.INV_CFM_DT, 'YYYYMM') INV_CFM_YR
                  ,A.BKG_NO
                  ,A.EQ_NO
            FROM
            (      
                -- FROM YARD-TO YARD동일 LOC (Shuttle, Truck)
                SELECT /*+ ORDERED USE_NL(B) INDEX(B XAK6TRS_TRSP_INV_WRK) */ A.BKG_NO
                      ,A.EQ_NO
                      ,A.CGO_TP_CD
                      ,A.TRSP_CRR_MOD_CD
                      ,A.FM_NOD_CD
                      ,A.TO_NOD_CD
                      ,A.INV_CURR_CD
                      ,A.INV_BZC_AMT
                      ,A.INV_ETC_ADD_AMT
                      ,C.AWK_CGO_FLG
                      ,B.INV_CFM_DT
                      ,A.EQ_TPSZ_CD
                      ,A.TRSP_BND_CD
                FROM TRS_TRSP_INV_WRK B 
                    ,TRS_TRSP_SVC_ORD A    
                    ,BKG_BOOKING C 
                WHERE 1=1
--                AND   B.INV_CFM_DT BETWEEN TO_DATE(:fm_dt, 'YYYYMMDD') AND TO_DATE(:to_dt, 'YYYYMMDD') -- FROM DATE, TO DATE
                AND   B.INV_CFM_DT BETWEEN SYSDATE-(3*30+365) AND SYSDATE-(3*30) -- FROM DATE, TO DATE
                AND   B.TRSP_INV_AUD_STS_CD = 'PD'
                AND   B.INV_NO       = A.INV_NO
                AND   B.INV_VNDR_SEQ = A.INV_VNDR_SEQ
                AND   A.TRSP_CRR_MOD_CD IN ('WD', 'TD')
                AND   A.CGO_TP_CD = 'F'  -- FULL CARGO
                AND   A.TRSP_COST_DTL_MOD_CD IN ('TS', 'LS') -- SHUTTLE 만 대상
                AND   A.EQ_KND_CD = 'U'  -- CONTAINER TYPE
                AND   A.DELT_FLG  = 'N'  -- 삭제 제외  
                AND   A.EQ_TPSZ_CD IN ('F2','F4','F5','A4','O2','O4','O5','O7','S2','S4')
                AND   SUBSTR(A.FM_NOD_CD,0,5) = SUBSTR(A.TO_NOD_CD,0,5)
                AND   C.BKG_NO       = A.BKG_NO  
                AND   C.AWK_CGO_FLG    = 'Y' -- BKG SPECIAL CARGO
                
                
                UNION ALL
                
                -- EQUALIZATION PORT 
                SELECT /*+ ORDERED USE_NL(B) INDEX(B XAK6TRS_TRSP_INV_WRK) */ A.BKG_NO
                      ,A.EQ_NO
                      ,A.CGO_TP_CD
                      ,A.TRSP_CRR_MOD_CD
                      ,A.FM_NOD_CD
                      ,A.TO_NOD_CD
                      ,A.INV_CURR_CD
                      ,A.INV_BZC_AMT
                      ,A.INV_ETC_ADD_AMT
                      ,C.AWK_CGO_FLG
                      ,B.INV_CFM_DT
                      ,A.EQ_TPSZ_CD
                      ,A.TRSP_BND_CD
                FROM TRS_TRSP_INV_WRK B 
                    ,TRS_TRSP_SVC_ORD A    
                    ,BKG_BOOKING C
                    ,BKG_EQLZ_PORT D
                WHERE 1=1
--                AND   B.INV_CFM_DT BETWEEN TO_DATE(:fm_dt, 'YYYYMMDD') AND TO_DATE(:to_dt, 'YYYYMMDD') -- FROM DATE, TO DATE
                AND   B.INV_CFM_DT BETWEEN SYSDATE-(3*30+365) AND SYSDATE-(3*30) -- FROM DATE, TO DATE
                AND   B.TRSP_INV_AUD_STS_CD = 'PD'
                AND   B.INV_NO       = A.INV_NO
                AND   B.INV_VNDR_SEQ = A.INV_VNDR_SEQ
                AND   A.TRSP_CRR_MOD_CD IN ('WD', 'TD')
                AND   A.CGO_TP_CD = 'F'  -- FULL CARGO
                AND   A.TRSP_COST_DTL_MOD_CD IN ('TS', 'LS') -- SHUTTLE 만 대상
                AND   A.EQ_KND_CD = 'U'  -- CONTAINER TYPE
                AND   A.DELT_FLG  = 'N'  -- 삭제 제외  
                AND   A.EQ_TPSZ_CD IN ('F2','F4','F5','A4','O2','O4','O5','O7','S2','S4')
                AND   SUBSTR(A.FM_NOD_CD,0,5) <> SUBSTR(A.TO_NOD_CD,0,5)
                AND   (( SUBSTR(A.FM_NOD_CD,0,5) = D.LOC_CD AND SUBSTR(A.TO_NOD_CD,0,5) = D.EQLZ_PORT_CD ) OR  ( SUBSTR(A.FM_NOD_CD,0,5) = D.EQLZ_PORT_CD AND SUBSTR(A.TO_NOD_CD,0,5) = D.LOC_CD ))
                AND   C.BKG_NO       = A.BKG_NO  
                AND   C.AWK_CGO_FLG    = 'Y' -- BKG SPECIAL CARGO
            
            ) A
            ,GL_MON_XCH_RT B
            ,BKG_AWK_CGO C
            WHERE B.ACCT_XCH_RT_LVL = 1
            AND   TO_CHAR(A.INV_CFM_DT, 'YYYYMM') = B.ACCT_XCH_RT_YRMON
            AND   A.INV_CURR_CD = B.CURR_CD
            AND   A.BKG_NO  = C.BKG_NO
            AND   A.EQ_NO = C.CNTR_NO
        )
        GROUP BY FM_NOD_CD
                ,TO_NOD_CD
                ,IN_OUT_GAUAGE
                ,TRSP_CRR_MOD_CD

) X			]]></sql>
			<params>
				<param name="act_cost_trf_tp_shuttle" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
