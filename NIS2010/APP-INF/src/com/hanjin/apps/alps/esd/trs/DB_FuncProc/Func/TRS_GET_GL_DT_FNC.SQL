CREATE OR REPLACE FUNCTION TRS_GET_GL_DT_FNC (    IN_CSR_NO          IN AP_INV_HDR.CSR_NO%TYPE,   IN_OFC_CD          IN AP_PERIOD.OFC_CD%TYPE,   IN_GL_DT           IN AP_PERIOD.EFF_YRMON%TYPE,   IN_SYS_DIV_CD      IN AP_PERIOD.SYS_DIV_CD%TYPE) RETURN VARCHAR2AUTHID CURRENT_USERIS/*************************************************************************   1.NAME       : poong-yeon Cho  2.CREATE DATE: 2008-09-16  3.DESCRIPTION:      - 용도: GL DATE 구하기      - 파라미터: CSR NO, OFC_CD, GL DATE, SYS 구분 CODE       - LOGIC        0. OFFICE CD 대신 CSR NO가 들어온경우는 CSR NO를 사용하여 OFFICE CD를 조회한다.                1. 주어진 AP 마감월에 OPEN된 OFFICE를 찾는다.            1-1. AP_PERIOD에서 주어진 OFFICE와 일치하는 OFC_CD를 조회한다.            1-2. 일치하는 OFC_CD가 없으면 OPEN된 가장 빠른달을 찾는다.        2. 1번조건으로 조회되는 대상이 없으면 MDM_ORGANIZATION 에서 해당 OFFICE의 AR_HD_QTR_OFC_CD와                 일치하는 AP_PERIOD의 OFC_CD를 조회한다.            2-1. AP_PERIOD에서 주어진 OFFICE와 일치하는 OFC_CD를 조회한다.            2-2. 일치하는 OFC_CD가 없으면 OPEN된 가장 빠른달을 찾는다.  4.REVISION HISTORY*************************************************************************/    V_OFC_CD    VARCHAR2(6);               /* GET OFFICE */    V_GL_MONTH  VARCHAR2(6);               /* GET GL DATE */    OUT_GL_DT   VARCHAR2(8);               /* OUTPUT GL DATE */BEGIN/*************************************************************************AP OFFICE CD*************************************************************************/    IF IN_CSR_NO IS NOT NULL THEN                SELECT             TJ_OFC_CD        INTO             V_OFC_CD        FROM            AP_INV_HDR        WHERE            CSR_NO = IN_CSR_NO;                ELSE            V_OFC_CD := IN_OFC_CD;            END IF;    /************************************************************************* GL DATE에서 MONTH까지 6자리만 분리*************************************************************************/      V_GL_MONTH := SUBSTR(IN_GL_DT, 1, 6);/************************************************************************* 1. AP_PERIOD에서 주어진 OFFICE와 일치하는 OFC_CD를 조회한다.*************************************************************************/    BEGIN            SELECT            IN_GL_DT        INTO            OUT_GL_DT        FROM            AP_PERIOD          AP        WHERE            AP.OFC_CD          = V_OFC_CD        AND AP.EFF_YRMON       = V_GL_MONTH        AND AP.SYS_DIV_CD      = IN_SYS_DIV_CD        AND AP.AR_AP_DIV_CD    = 'P'        AND AP.CLZ_STS_CD      = 'O';        EXCEPTION WHEN NO_DATA_FOUND THEN/************************************************************************* 2. 일치되는 대상이 없다면 가장 빠른달의 OFC_CD를 조회한다.*************************************************************************/                    BEGIN                            SELECT                    NVL2(MIN(EFF_YRMON), MIN(EFF_YRMON)||'01', NULL) GL_DT                INTO                    OUT_GL_DT                FROM                    AP_PERIOD          AP                WHERE                    AP.OFC_CD          = V_OFC_CD                AND AP.EFF_YRMON       >= V_GL_MONTH                AND AP.SYS_DIV_CD      = IN_SYS_DIV_CD                AND AP.AR_AP_DIV_CD    = 'P'                AND AP.CLZ_STS_CD      = 'O';                                IF OUT_GL_DT IS NULL THEN/************************************************************************* 3. 일치되는 대상이 없다면 HQ OFFICE로 조회한다.*************************************************************************/                    BEGIN                                            SELECT                            IN_GL_DT                        INTO                            OUT_GL_DT                        FROM                            AP_PERIOD          AP                        ,   MDM_ORGANIZATION   MDM                        WHERE                            MDM.OFC_CD         = V_OFC_CD                        AND AR_HD_QTR_OFC_CD   = AP.OFC_CD                        AND AP.SYS_DIV_CD      = IN_SYS_DIV_CD                        AND AP.EFF_YRMON       = V_GL_MONTH                        AND AP.AR_AP_DIV_CD    = 'P'                        AND AP.CLZ_STS_CD      = 'O';                                              EXCEPTION WHEN NO_DATA_FOUND THEN/*************************************************************************4. 일치되는 대상이 없다면 가장 빠른달의 HQ OFFICE를 조회한다.   CONCAT이 들어 있어 NO_DATA_FOUND가 발생하지 않는다.*************************************************************************/                                               BEGIN                                                    SELECT                                NVL2(MIN(EFF_YRMON), MIN(EFF_YRMON)||'01', NULL) GL_DT                            INTO                                OUT_GL_DT                            FROM                                AP_PERIOD          AP                            ,   MDM_ORGANIZATION   MDM                            WHERE                                MDM.OFC_CD         = V_OFC_CD                            AND AR_HD_QTR_OFC_CD   = AP.OFC_CD                            AND AP.SYS_DIV_CD      = IN_SYS_DIV_CD                            AND AP.EFF_YRMON       >= V_GL_MONTH                            AND AP.AR_AP_DIV_CD    = 'P'                            AND AP.CLZ_STS_CD      = 'O';                                                END;  /*** END OF 4 ***/                    END;  /*** END OF 3 ***/                                END IF;                            END;  /*** END OF 2 ***/                    END;  /*** END OF 1 ***/    RETURN OUT_GL_DT;    EXCEPTION        WHEN OTHERS THEN            RETURN '';      END TRS_GET_GL_DT_FNC;