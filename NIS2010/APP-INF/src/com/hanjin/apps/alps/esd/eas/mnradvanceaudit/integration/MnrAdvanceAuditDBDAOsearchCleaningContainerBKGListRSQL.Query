<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="MnrAdvanceAuditDBDAOsearchCleaningContainerBKGListRSQL">
			<desc><![CDATA[특수 컨테이너 클리닝 실시한 컨테이너 조회 및 BKG data 연동]]></desc>
			<sql><![CDATA[
SELECT   A.WO_NO
       , A.WO_USER
       , A.RHQ_COST_OFC_CD RHQ_OFC_CD
       , A.COST_OFC_CD OFC_CD
       , A.MNR_INP_DT
       , A.COST_DTL_CD
       , A.EQ_NO
       , A.EQ_TPSZ_CD
       , A.COST_DTL_NM
       , A.CURR_CD
       , A.COST_AMT
       , A.LOC_CD
       , A.YD_CD
       , A.LSTM_CD
       , A.OWNR_CO_CD
       , A.TOTAL
       , A.PRE_BKG_NO
       , B1.POD_NOD_CD POD_YARD
       , B1.CMDT_CD PRE_CMDT_CD
       , C1.CMDT_NM PRE_CMDT_NM
       , D1.CSTMS_DESC PRE_CSTMS_DESC
       , E1.DCGO_FLG AS PRE_DG
       , E1.AWK_CGO_FLG AS PRE_AK
       , E1.RC_FLG AS PRE_RF
       , E1.RD_CGO_FLG AS PRE_RD
       , DECODE(E1.RC_FLG, 'Y', (SELECT G.CDO_TEMP FROM BKG_RF_CGO G WHERE G.BKG_NO = A.PRE_BKG_NO AND ROWNUM = 1), '') PRE_CDO_TEMP
       , SUBSTR(DECODE(E1.DCGO_FLG, 'Y', ', DG', '') || DECODE(E1.AWK_CGO_FLG, 'Y', ', AK', '') || DECODE(E1.RC_FLG, 'Y', ', RF', '') || DECODE(E1.RD_CGO_FLG, 'Y', ', RD', ''), 2) PRE_SPECIAL
       , DECODE(E1.DCGO_FLG, 'Y', (SELECT G.IMDG_UN_NO FROM BKG_DG_CGO G WHERE G.BKG_NO = A.PRE_BKG_NO AND G.CNTR_CGO_SEQ = 1 AND ROWNUM = 1), '') PRE_UN_NO
       , A.POST_BKG_NO
       , B2.POL_NOD_CD POL_YARD
       , B2.CMDT_CD POST_CMDT_CD
       , C2.CMDT_NM POST_CMDT_NM
       , D2.CSTMS_DESC POST_CSTMS_DESC
       , E2.DCGO_FLG AS POST_DG
       , E2.AWK_CGO_FLG AS POST_AK
       , E2.RC_FLG AS POST_RF
       , E2.RD_CGO_FLG AS POST_RD
       , DECODE(E2.DCGO_FLG, 'Y', (SELECT G.IMDG_UN_NO FROM BKG_DG_CGO G WHERE G.BKG_NO = A.POST_BKG_NO AND G.CNTR_CGO_SEQ = 1 AND ROWNUM = 1), '') POST_UN_NO
       , DECODE(E2.RC_FLG, 'Y', (SELECT G.CDO_TEMP FROM BKG_RF_CGO G WHERE G.BKG_NO = A.POST_BKG_NO AND ROWNUM = 1), '') POST_CDO_TEMP
       , SUBSTR(DECODE(E2.DCGO_FLG, 'Y', ', DG', '') || DECODE(E2.AWK_CGO_FLG, 'Y', ', AK', '') || DECODE(E2.RC_FLG, 'Y', ', RF', '') || DECODE(E2.RD_CGO_FLG, 'Y', ', RD', ''), 2) POST_SPECIAL
FROM     (
           SELECT   WO_NO
			      , WO_USER
                  , RHQ_COST_OFC_CD
                  , COST_OFC_CD
                  , TO_CHAR(MNR_INP_DT, 'YYYY-MM-DD') MNR_INP_DT
                  , COST_DTL_CD
                  , EQ_NO
                  , EQ_TPSZ_CD
                  , COST_DTL_NM
                  , CURR_CD
                  , COST_AMT
                  , LOC_CD
                  , YD_CD
                  , LSTM_CD
                  , OWNR_CO_CD
                  , TOTAL
                  , PRE_BKG_NO
                  , (
                      WITH POST AS
                      (
                        SELECT   M.BKG_NO
                               , CNTR_NO
                               , CNMV_EVNT_DT
                        FROM     CTM_MOVEMENT M
                               , BKG_BOOKING K
                        WHERE    1 = 1
                        AND      M.BKG_NO = K.BKG_NO
                        AND      K.POL_NOD_CD LIKE @[s_cnt_cd] || '%'
                        AND      M.MVMT_STS_CD = 'OP'
                        AND      M.CNMV_EVNT_DT BETWEEN TO_DATE(@[s_start_dt]||'000000', 'YYYY-MM-DDHH24MISS') - 120 AND TO_DATE(@[s_end_dt]||'000000', 'YYYY-MM-DDHH24MISS') + 120
                        ORDER BY CNMV_EVNT_DT ASC
                      )
                      SELECT   BKG_NO
                      FROM     POST
                      WHERE    1 = 1
                      AND      POST.CNTR_NO = A.EQ_NO
                      AND      POST.CNMV_EVNT_DT > NVL(A.PRE_EVNT_DT, A.MNR_INP_DT)
                      AND      ROWNUM = 1
                    ) AS POST_BKG_NO
           FROM     (
                      SELECT   A.MNR_ORD_OFC_CTY_CD || A.MNR_ORD_SEQ AS WO_NO
				             , ( SELECT USR_NM FROM COM_USER WHERE USR_ID = A.CRE_USR_ID AND ROWNUM = 1 ) AS WO_USER
                             , MNR_COMMON_PKG.MNR_GET_RHQ_OFC_FNC(A.COST_OFC_CD) AS RHQ_COST_OFC_CD
                             , A.COST_OFC_CD
                             , A.MNR_INP_DT
                             , B.COST_DTL_CD
                             , B.EQ_NO
                             , B.EQ_TPSZ_CD
                             , ( SELECT MNR_CD_DP_DESC FROM MNR_GEN_CD G WHERE G.MNR_CD_ID = B.COST_DTL_CD AND G.PRNT_CD_ID = 'MRDRCL' ) AS COST_DTL_NM
                             , A.CURR_CD
                             , B.COST_AMT 
                             , SUBSTR(B.YD_CD, 1, 5) AS LOC_CD
                             , B.YD_CD
                             , C.LSTM_CD
                             , (
                                 SELECT   DECODE(INTG_CD_VAL_CTNT,'H','SM Line',INTG_CD_VAL_DP_DESC)
                                 FROM     COM_INTG_CD_DTL CD
                                 WHERE    1 = 1
                                 AND      INTG_CD_ID ='CD01047'
                                 AND      CD.INTG_CD_VAL_CTNT = C.OWNR_CO_CD
                               ) AS OWNR_CO_CD
                             , (
                                 WITH PRE AS
                                 (
                                   SELECT   M.BKG_NO
                                          , CNTR_NO
                                   FROM     CTM_MOVEMENT M
                                          , BKG_BOOKING K
                                   WHERE    1 = 1
                                   AND      M.BKG_NO = K.BKG_NO
                                   AND      K.POD_NOD_CD LIKE @[s_cnt_cd] || '%'
                                   AND      M.MVMT_STS_CD = 'IC'
                                   AND      M.CNMV_EVNT_DT BETWEEN TO_DATE(@[s_start_dt]||'000000', 'YYYY-MM-DDHH24MISS') - 120 AND TO_DATE(@[s_end_dt]||'000000', 'YYYY-MM-DDHH24MISS')
                                   ORDER BY CNMV_EVNT_DT DESC
                                 )
                                 SELECT   BKG_NO
                                 FROM     PRE
                                 WHERE    1 = 1
                                 AND      PRE.CNTR_NO = B.EQ_NO
                                 AND      ROWNUM = 1
                               ) AS PRE_BKG_NO
                             , (
                                 WITH PRE AS
                                 (
                                   SELECT   CNMV_EVNT_DT
                                          , CNTR_NO
                                   FROM     CTM_MOVEMENT M
                                          , BKG_BOOKING K
                                   WHERE    1 = 1
                                   AND      M.BKG_NO = K.BKG_NO
                                   AND      K.POD_NOD_CD LIKE @[s_cnt_cd] || '%'
                                   AND      M.MVMT_STS_CD = 'IC'
                                   AND      M.CNMV_EVNT_DT BETWEEN TO_DATE(@[s_start_dt]||'000000', 'YYYY-MM-DDHH24MISS') - 120 AND TO_DATE(@[s_end_dt]||'000000', 'YYYY-MM-DDHH24MISS')
                                   ORDER BY CNMV_EVNT_DT DESC
                                 )
                                 SELECT   CNMV_EVNT_DT
                                 FROM     PRE
                                 WHERE    1 = 1
                                 AND      PRE.CNTR_NO = B.EQ_NO
                                 AND      ROWNUM = 1
                               ) AS PRE_EVNT_DT
                             , ROW_NUMBER() OVER(ORDER BY A.MNR_INP_DT ASC) AS RNUM
                             , COUNT(MNR_INP_DT) OVER() AS TOTAL
                      FROM     MNR_ORD_HDR A
                             , MNR_ORD_DTL B
                             , MST_CONTAINER C
                      WHERE    1 = 1
                      AND      A.MNR_ORD_OFC_CTY_CD = B.MNR_ORD_OFC_CTY_CD
                      AND      A.MNR_ORD_SEQ = B.MNR_ORD_SEQ
                      AND      B.EQ_NO = C.CNTR_NO
                      AND      B.COST_CD = 'MRDRCL'
                      AND      A.MNR_INP_DT BETWEEN TO_DATE(@[s_start_dt]||'000000', 'YYYY-MM-DDHH24MISS') AND TO_DATE(@[s_end_dt]||'235959', 'YYYY-MM-DDHH24MISS')
                      AND      A.MNR_GRP_TP_CD = 'RPR'
                      AND      B.EQ_NO IS NOT NULL
                      AND      B.YD_CD LIKE @[s_cnt_cd] || '%'
#if(${s_loc_cd} != '')
                      AND      B.YD_CD LIKE @[s_loc_cd] || '%'
#end
#if(${s_yd_cd} != '')
                      AND      B.YD_CD = @[s_loc_cd] || @[s_yd_cd]
#end
#if(${s_eq_tpsz_cd} != '')
                      AND      B.EQ_TPSZ_CD IN
                               (
    #foreach ($tpszCd IN ${eqTpSzCds})
        #if($velocityCount < $eqTpSzCds.size())
                                  '$tpszCd',
        #else
                                  '$tpszCd'
        #end
    #end              
                               )
#end
#if(${s_eq_no} != '')
                      AND      B.EQ_NO IN
                               (
    #foreach ($eqNo IN ${eqNos})
        #if($velocityCount < $eqNos.size())
                                  '$eqNo',
        #else
                                  '$eqNo'
        #end
    #end              
                               )
#end
#if(${s_cost_dtl_cd} != '')
                      AND      B.COST_DTL_CD IN
                               (
    #foreach ($costDtlCd IN ${costDtlCds})
        #if($velocityCount < $costDtlCds.size())
                                  '$costDtlCd',
        #else
                                  '$costDtlCd'
        #end
    #end              
                               )
#end
                    ) A 
          WHERE     1 = 1
          AND       A.RNUM BETWEEN @[start_row] AND @[end_row]
         ) A
       , BKG_BOOKING B1
       , BKG_BOOKING B2
       , MDM_COMMODITY C1
       , MDM_COMMODITY C2
       , BKG_BL_DOC D1
       , BKG_BL_DOC D2
       , BKG_CONTAINER E1
       , BKG_CONTAINER E2
WHERE    1 = 1
AND      A.PRE_BKG_NO = B1.BKG_NO(+)
AND      A.POST_BKG_NO = B2.BKG_NO(+)
AND      B1.CMDT_CD = C1.CMDT_CD(+)
AND      B2.CMDT_CD = C2.CMDT_CD(+)
AND      B1.BKG_NO = D1.BKG_NO(+)
AND      B2.BKG_NO = D2.BKG_NO(+)
AND      A.EQ_NO = E1.CNTR_NO(+)
AND      A.PRE_BKG_NO = E1.BKG_NO(+)
AND      A.EQ_NO = E2.CNTR_NO(+)
AND      A.POST_BKG_NO = E2.BKG_NO(+)
#if(${s_cargo_type} != '')
    #if(${s_cargo_type} == 'AK')
AND      ( E1.AWK_CGO_FLG = 'Y' OR E2.AWK_CGO_FLG = 'Y' )
    #end
    #if(${s_cargo_type} == 'DG')
AND      ( E1.DCGO_FLG = 'Y' OR E2.DCGO_FLG = 'Y' )
    #end
    #if(${s_cargo_type} == 'DR')
AND      ( E1.RD_CGO_FLG = 'Y' OR E2.RD_CGO_FLG = 'Y')
    #end
    #if(${s_cargo_type} == 'RF')
AND      ( E1.RC_FLG = 'Y' OR E2.RC_FLG = 'Y' )
    #end
#end			]]></sql>
			<params>
				<param name="s_cnt_cd" type="12" value="" out="N"/>
				<param name="s_start_dt" type="12" value="" out="N"/>
				<param name="s_end_dt" type="12" value="" out="N"/>
				<param name="s_loc_cd" type="12" value="" out="N"/>
				<param name="s_yd_cd" type="12" value="" out="N"/>
				<param name="start_row" type="12" value="" out="N"/>
				<param name="end_row" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
