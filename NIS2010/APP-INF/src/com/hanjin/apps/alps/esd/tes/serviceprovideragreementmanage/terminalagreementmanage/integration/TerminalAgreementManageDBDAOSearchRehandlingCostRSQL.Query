<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TerminalAgreementManageDBDAOSearchRehandlingCostRSQL">
			<desc><![CDATA[요청된 Port에서 Re-handling될 화물의 Cost를 산출한다.]]></desc>
			<sql><![CDATA[
SELECT	@[bkg_no] AS bkg_no
		, @[chg_cd] AS chg_cd
        , @[rat_ut_cd] AS rat_ut_cd
		, @[rat_as_qty] AS rat_as_qty
		, @[cgo_cate_cd] AS cgo_cate_cd
		, @[cod_rqst_seq] AS cod_rqst_seq
		, @[cntr_cgo_tp_cd] AS cntr_cgo_tp_cd
		, RATE AS chg_ut_amt      
		, CURR_CD AS curr_cd      
		, RATE * @[rat_as_qty] AS chg_amt
FROM   ( SELECT D.CURR_CD CURR_CD,
                MAX(DECODE(DECODE(D.LGS_COST_CD,'SVRHCD',DECODE(D.TML_AGMT_VOL_UT_CD,'C',DECODE(C.CNTR_TPSZ_CD, @[rat_ut_cd],C.AGMT_RT,0),D.AGMT_UT_RT),0),0,
                           DECODE(DECODE(D.LGS_COST_CD,'TPNDTS',DECODE(NVL(D.IO_BND_CD,'N'),
                           'S',DECODE(D.TML_AGMT_VOL_UT_CD,'C',DECODE(C.CNTR_TPSZ_CD, @[rat_ut_cd],C.AGMT_RT,0),D.AGMT_UT_RT),
                           'O',DECODE(D.TML_AGMT_VOL_UT_CD,'C',DECODE(C.CNTR_TPSZ_CD, @[rat_ut_cd],C.AGMT_RT,0),D.AGMT_UT_RT),0),0),0,
                       DECODE(DECODE(D.LGS_COST_CD,DECODE(@[cntr_cgo_tp_cd],'F','TPNDFL','TPNDMT'),DECODE(NVL(D.IO_BND_CD,'N'),
                              'S',DECODE(D.TML_AGMT_VOL_UT_CD,'C',DECODE(C.CNTR_TPSZ_CD, @[rat_ut_cd],C.AGMT_RT,0),D.AGMT_UT_RT),
                              'O',DECODE(D.TML_AGMT_VOL_UT_CD,'C',DECODE(C.CNTR_TPSZ_CD, @[rat_ut_cd],C.AGMT_RT,0),D.AGMT_UT_RT),0),0),0,
                          DECODE(DECODE(D.LGS_COST_CD,'SVLDTS',DECODE(NVL(D.IO_BND_CD,'N'),
                                 'S',DECODE(D.TML_AGMT_VOL_UT_CD,'C',DECODE(C.CNTR_TPSZ_CD, @[rat_ut_cd],C.AGMT_RT,0),D.AGMT_UT_RT),
                                 'O',DECODE(D.TML_AGMT_VOL_UT_CD,'C',DECODE(C.CNTR_TPSZ_CD, @[rat_ut_cd],C.AGMT_RT,0),D.AGMT_UT_RT),0),0) + 
                              DECODE(D.LGS_COST_CD,'TMNDTS',DECODE(NVL(D.IO_BND_CD,'N'),
                                     'S',DECODE(D.TML_AGMT_VOL_UT_CD,'C',DECODE(C.CNTR_TPSZ_CD, @[rat_ut_cd],C.AGMT_RT,0),D.AGMT_UT_RT),
                                     'O',DECODE(D.TML_AGMT_VOL_UT_CD,'C',DECODE(C.CNTR_TPSZ_CD, @[rat_ut_cd],C.AGMT_RT,0),D.AGMT_UT_RT),0),0),0,
                                DECODE(DECODE(D.LGS_COST_CD,DECODE(@[cntr_cgo_tp_cd],'F','SVLDFL','SVLDMT'),DECODE(NVL(D.IO_BND_CD,'N'),
                                              'S',DECODE(D.TML_AGMT_VOL_UT_CD,'C',DECODE(C.CNTR_TPSZ_CD, @[rat_ut_cd],C.AGMT_RT,0),D.AGMT_UT_RT),
                                              'O',DECODE(D.TML_AGMT_VOL_UT_CD,'C',DECODE(C.CNTR_TPSZ_CD, @[rat_ut_cd],C.AGMT_RT,0),D.AGMT_UT_RT),0),0) + 
                                       DECODE(D.LGS_COST_CD,DECODE(@[cntr_cgo_tp_cd],'F','TMNDFL','TMNDMT'),DECODE(NVL(D.IO_BND_CD,'N'),
                                              'S',DECODE(D.TML_AGMT_VOL_UT_CD,'C',DECODE(C.CNTR_TPSZ_CD, @[rat_ut_cd],C.AGMT_RT,0),D.AGMT_UT_RT),
                                              'O',DECODE(D.TML_AGMT_VOL_UT_CD,'C',DECODE(C.CNTR_TPSZ_CD, @[rat_ut_cd],C.AGMT_RT,0),D.AGMT_UT_RT),0),0),0,0,
                                  DECODE(D.LGS_COST_CD,DECODE(@[cntr_cgo_tp_cd],'F','SVLDFL','SVLDMT'),DECODE(NVL(D.IO_BND_CD,'N'),
                                         'S',DECODE(D.TML_AGMT_VOL_UT_CD,'C',DECODE(C.CNTR_TPSZ_CD, @[rat_ut_cd],C.AGMT_RT,0),D.AGMT_UT_RT),
                                         'O',DECODE(D.TML_AGMT_VOL_UT_CD,'C',DECODE(C.CNTR_TPSZ_CD, @[rat_ut_cd],C.AGMT_RT,0),D.AGMT_UT_RT),0),0) + 
                                  DECODE(D.LGS_COST_CD,DECODE(@[cntr_cgo_tp_cd],'F','TMNDFL','TMNDMT'),DECODE(NVL(D.IO_BND_CD,'N'),
                                         'S',DECODE(D.TML_AGMT_VOL_UT_CD,'C',DECODE(C.CNTR_TPSZ_CD, @[rat_ut_cd],C.AGMT_RT,0),D.AGMT_UT_RT),
                                         'O',DECODE(D.TML_AGMT_VOL_UT_CD,'C',DECODE(C.CNTR_TPSZ_CD, @[rat_ut_cd],C.AGMT_RT,0),D.AGMT_UT_RT),0),0)),
                                     DECODE(D.LGS_COST_CD,'SVLDTS',DECODE(NVL(D.IO_BND_CD,'N'),
                                            'S',DECODE(D.TML_AGMT_VOL_UT_CD,'C',DECODE(C.CNTR_TPSZ_CD, @[rat_ut_cd],C.AGMT_RT,0),D.AGMT_UT_RT),
                                            'O',DECODE(D.TML_AGMT_VOL_UT_CD,'C',DECODE(C.CNTR_TPSZ_CD, @[rat_ut_cd],C.AGMT_RT,0),D.AGMT_UT_RT),0),0) + 
                                     DECODE(D.LGS_COST_CD,'TMNDTS',DECODE(NVL(D.IO_BND_CD,'N'),
                                            'S',DECODE(D.TML_AGMT_VOL_UT_CD,'C',DECODE(C.CNTR_TPSZ_CD, @[rat_ut_cd],C.AGMT_RT,0),D.AGMT_UT_RT),
                                            'O',DECODE(D.TML_AGMT_VOL_UT_CD,'C',DECODE(C.CNTR_TPSZ_CD, @[rat_ut_cd],C.AGMT_RT,0),D.AGMT_UT_RT),0),0)),
                                       DECODE(D.LGS_COST_CD,DECODE(@[cntr_cgo_tp_cd],'F','TPNDFL','TPNDMT'),DECODE(NVL(D.IO_BND_CD,'N'),
                                              'S',DECODE(D.TML_AGMT_VOL_UT_CD,'C',DECODE(C.CNTR_TPSZ_CD, @[rat_ut_cd],C.AGMT_RT,0),D.AGMT_UT_RT),
                                              'O',DECODE(D.TML_AGMT_VOL_UT_CD,'C',DECODE(C.CNTR_TPSZ_CD, @[rat_ut_cd],C.AGMT_RT,0),D.AGMT_UT_RT),0),0)),
                                         DECODE(D.LGS_COST_CD,'TPNDTS',DECODE(NVL(D.IO_BND_CD,'N'),
                                                'S',DECODE(D.TML_AGMT_VOL_UT_CD,'C',DECODE(C.CNTR_TPSZ_CD, @[rat_ut_cd],C.AGMT_RT,0),D.AGMT_UT_RT),
                                                'O',DECODE(D.TML_AGMT_VOL_UT_CD,'C',DECODE(C.CNTR_TPSZ_CD, @[rat_ut_cd],C.AGMT_RT,0),D.AGMT_UT_RT),0),0)),
                                           DECODE(D.LGS_COST_CD,'SVRHCD',DECODE(D.TML_AGMT_VOL_UT_CD,'C',DECODE(C.CNTR_TPSZ_CD, @[rat_ut_cd],C.AGMT_RT,0),D.AGMT_UT_RT),0))) RATE
		FROM   VSK_VSL_PORT_SKD   V, TES_TML_AGMT_HDR         H, TES_TML_AGMT_DTL   D,
			  TES_TML_AGMT_TP_SZ C, TES_TML_AGMT_DG_CGO_CLSS G, TES_TML_AGMT_APLY_DY A
		WHERE  V.VSL_CD          = SUBSTR( @[vvd], 1, 4 )		--'HNAT'          --:vsl_cd
		AND    V.SKD_VOY_NO      = SUBSTR( @[vvd], 5, 4 )	--'0057'          --:skd_voy_cd
		AND    V.SKD_DIR_CD      = SUBSTR( @[vvd], 9, 1 )	--'W'             --:skd_dir_cd
		AND    V.VPS_PORT_CD     = SUBSTR( @[cod_rhnd_port_cd], 1, 5 )		--'CNHKG'         --:cod_port(COD 요청 PORT)
		AND    V.YD_CD           = H.YD_CD
		AND    H.TML_AGMT_STS_CD = 'C'                                                               
		AND    H.TML_AGMT_VER_NO = ( SELECT MAX(M.TML_AGMT_VER_NO)
									FROM   TES_TML_AGMT_HDR M
									WHERE  M.YD_CD           = H.YD_CD
									AND    M.VNDR_SEQ        = H.VNDR_SEQ
									AND    M.TML_AGMT_STS_CD = 'C'
									AND    M.DELT_FLG        = 'N' )
		AND    H.TML_AGMT_OFC_CTY_CD = D.TML_AGMT_OFC_CTY_CD
		AND    H.TML_AGMT_SEQ        = D.TML_AGMT_SEQ
		AND    H.TML_AGMT_VER_NO     = D.TML_AGMT_VER_NO
		AND    D.LGS_COST_CD         IN ('SVRHCD','TPNDTS','SVLDTS','TMNDTS','TPNDFL','TPNDMT','SVLDFL','SVLDMT','TMNDFL','TMNDMT')
		AND    NVL(D.THRP_COST_CD_FLG,'N') <> 'Y'
		AND    TO_NUMBER(NVL(D.FM_TR_VOL_VAL,'1')) = 1 
		AND    NVL(D.LANE_CD,'N')    = DECODE(NVL(D.LANE_CD,'N'),'N','N','Sam','Sam','OTH','OTH','CMA')
		AND    NVL(D.IOC_CD,'N')     IN ('N','S','O')
		AND    NVL(D.IO_BND_CD,'N')  IN ('N','S','O')
		AND    NVL(D.TML_TRNS_MOD_CD,'N') = DECODE(NVL(D.TML_TRNS_MOD_CD,'N'),'N','N','S','S',D.TML_TRNS_MOD_CD)
		AND    D.TML_AGMT_OFC_CTY_CD = C.TML_AGMT_OFC_CTY_CD(+)                                                             
		AND    D.TML_AGMT_SEQ        = C.TML_AGMT_SEQ(+)                                                                           
		AND    D.TML_AGMT_VER_NO     = C.TML_AGMT_VER_NO(+)                                                                     
		AND    D.TML_AGMT_DTL_SEQ    = C.TML_AGMT_DTL_SEQ(+)
		AND    DECODE(D.TML_AGMT_VOL_UT_CD,'C',C.CNTR_TPSZ_CD,'N') = DECODE(D.TML_AGMT_VOL_UT_CD,'C', @[rat_ut_cd],'N')
		AND    D.TML_AGMT_OFC_CTY_CD = G.TML_AGMT_OFC_CTY_CD(+)
		AND    D.TML_AGMT_SEQ        = G.TML_AGMT_SEQ(+)
		AND    D.TML_AGMT_VER_NO     = G.TML_AGMT_VER_NO(+)
		AND    DECODE(NVL(D.DCGO_APLY_TP_CD,'N'),'N','N',D.TML_AGMT_DTL_SEQ)                                                                        
			  = DECODE(NVL(D.DCGO_APLY_TP_CD,'N'),'N','N',G.TML_AGMT_DTL_SEQ)
		AND    DECODE(NVL(D.DCGO_APLY_TP_CD,'N'),'N','N',G.DCGO_APLY_TP_CD) = DECODE(NVL(D.DCGO_APLY_TP_CD,'N'),'N','N','R')
		AND    DECODE(NVL(D.DCGO_APLY_TP_CD,'N'),'A',DECODE('N','N',G.DCGO_NON_CLSS_FLG,'N'),'S',DECODE('N','N',G.DCGO_NON_CLSS_FLG,'N'),'N')     
			  = DECODE(NVL(D.DCGO_APLY_TP_CD,'N'),'A',DECODE('N','N','Y','N'),'S',DECODE('N','N','Y','N'),'N')
		AND    D.TML_AGMT_OFC_CTY_CD  = A.TML_AGMT_OFC_CTY_CD(+)                                                                                    
		AND    D.TML_AGMT_SEQ         = A.TML_AGMT_SEQ(+)                                                                                           
		AND    D.TML_AGMT_VER_NO      = A.TML_AGMT_VER_NO(+)                                                                                        
		AND    D.TML_AGMT_DTL_SEQ     = A.TML_AGMT_DTL_SEQ(+)
		GROUP BY D.CURR_CD
		)
WHERE RATE <> 0			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="chg_cd" type="12" value="" out="N"/>
				<param name="rat_ut_cd" type="12" value="" out="N"/>
				<param name="rat_as_qty" type="12" value="" out="N"/>
				<param name="cgo_cate_cd" type="12" value="" out="N"/>
				<param name="cod_rqst_seq" type="12" value="" out="N"/>
				<param name="cntr_cgo_tp_cd" type="12" value="" out="N"/>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="cod_rhnd_port_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
