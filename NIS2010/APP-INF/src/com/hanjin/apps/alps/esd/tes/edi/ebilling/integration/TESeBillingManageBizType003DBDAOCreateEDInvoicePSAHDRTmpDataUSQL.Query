<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TESeBillingManageBizType003DBDAOCreateEDInvoicePSAHDRTmpDataUSQL">
			<desc><![CDATA[PSA HDR 밀어넣기 : DTL에서 (S/P + INV)별 HDR KEY값 추출 -> HDR저장 VNDR에 해당하는 MDM에서 OFC조회및UPDATE(OFC가 없을 경우 유효성 확인시 AJ처리됨)
	               기타 HDR 주요항목 저장 (INV TP/YD/CURR/COST OFC/TTL AMT.. 등)]]></desc>
			<sql><![CDATA[
INSERT INTO TES_EDI_SO_HDR (
    TML_EDI_SO_OFC_CTY_CD,
    TML_EDI_SO_SEQ,
    TML_INV_TP_CD,
    TML_INV_STS_CD,
    TML_INV_RJCT_STS_CD,
    INV_OFC_CD,
    COST_OFC_CD,
    VNDR_SEQ,
    YD_CD,
    INV_NO,
    CURR_CD,
    RCV_DT,
    ISS_DT,
    TTL_INV_AMT,
    DELT_FLG,
    STO_DYS_IND_CD,
    VLD_CHK_FLG,
    FLT_FILE_MSG_ID,
    TML_INV_EDI_SEQ,
    EDI_SNDR_ID,
    LOCL_CRE_DT,
    LOCL_UPD_DT,
    CRE_USR_ID,
    CRE_DT,
    UPD_USR_ID,
    UPD_DT    
)
SELECT 
    X.TML_EDI_SO_OFC_CTY_CD, 
    TES_EDI_SO_HDR_SEQ.NEXTVAL TML_EDI_SO_SEQ,
    DECODE(X.TML_INV_TP_CD_KNT,1,X.TML_INV_TP_CD,'') TML_INV_TP_CD,    
    'R' TML_INV_STS_CD,
    'AJ' TML_INV_RJCT_STS_CD,
    X.INV_OFC_CD,
    CASE
    WHEN DECODE(X.YD_CD_KNT,1,X.YD_CD,'') IS NOT NULL
    THEN NVL((SELECT Y.OFC_CD FROM MDM_YARD Y WHERE Y.YD_CD=DECODE(X.YD_CD_KNT,1,X.YD_CD,'') AND Y.DELT_FLG='N' AND ROWNUM=1),'')
    ELSE ''
    END COST_OFC_CD,
    @[psa_vndr_seq] VNDR_SEQ, 
    DECODE(X.YD_CD_KNT,1,X.YD_CD,'') YD_CD,
    X.INV_NO,
    DECODE(X.CURR_CD_KNT,1,X.CURR_CD,'') CURR_CD,
    TO_CHAR(SYSDATE,'YYYYMMDD') RCV_DT,
    DECODE(X.ISS_DT_KNT,1,X.ISS_DT,'') ISS_DT,
    X.TTL_INV_AMT,
    'N' DELT_FLG,
    CASE
    WHEN DECODE(X.TML_INV_TP_CD_KNT,1,X.TML_INV_TP_CD,'') IN ('ST','OF')
    THEN 'IO'
    ELSE ''
    END STO_DYS_IND_CD,
    'N' VLD_CHK_FLG,
    X.FLT_FILE_MSG_ID,
    X.TML_INV_EDI_SEQ,
    X.EDI_SNDR_ID,
    GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC(X.INV_OFC_CD) LOCL_CRE_DT,
    GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC(X.INV_OFC_CD) LOCL_UPD_DT,
    'ALPS_TES' CRE_USR_ID,
    SYSDATE CRE_DT,
    'ALPS_TES' UPD_USR_ID,
    SYSDATE UPD_DT
FROM (
    SELECT 
        CASE 
        WHEN (SELECT V.OFC_CD FROM MDM_VENDOR V WHERE V.VNDR_SEQ = @[psa_vndr_seq]) IS NOT NULL
        THEN SUBSTR((SELECT TRIM(V.OFC_CD) FROM MDM_VENDOR V WHERE V.VNDR_SEQ = @[psa_vndr_seq]),1,3)
        ELSE ''
        END TML_EDI_SO_OFC_CTY_CD,
        (SELECT TRIM(V.OFC_CD) FROM MDM_VENDOR V WHERE V.VNDR_SEQ = @[psa_vndr_seq]) INV_OFC_CD,
        TRIM(INV_NO) INV_NO,
        COUNT(DISTINCT TML_INV_TP_CD) TML_INV_TP_CD_KNT, 
        MAX(TML_INV_TP_CD) TML_INV_TP_CD,
        COUNT(DISTINCT YD_CD) YD_CD_KNT, 
        MAX(YD_CD) YD_CD,
        COUNT(DISTINCT ISS_DT) ISS_DT_KNT, 
        MAX(ISS_DT) ISS_DT, 
        COUNT(DISTINCT CURR_CD) CURR_CD_KNT, 
        MAX(CURR_CD) CURR_CD,
        SUM(P.INV_AMT) TTL_INV_AMT,
        MAX(P.FLT_FILE_MSG_ID) FLT_FILE_MSG_ID,
        MAX(P.TML_INV_EDI_SEQ) TML_INV_EDI_SEQ,
        MAX(P.EDI_SNDR_ID) EDI_SNDR_ID
    FROM TES_EDI_SO_PSA_DTL P
    WHERE 1=1
	AND P.TML_EDI_SO_PSA_DTL_SEQ > 0
    AND P.TML_INV_EDI_SEQ = @[tml_inv_edi_seq]
    AND P.TML_EDI_SO_OFC_CTY_CD IS NULL
    AND P.TML_EDI_SO_SEQ IS NULL
    AND P.TRF_DESC <> 'GST'
    GROUP BY P.INV_NO
) X
WHERE X.TML_EDI_SO_OFC_CTY_CD IS NOT NULL			]]></sql>
			<params>
			</params>
		</query>
	</querys>
</sqls>
