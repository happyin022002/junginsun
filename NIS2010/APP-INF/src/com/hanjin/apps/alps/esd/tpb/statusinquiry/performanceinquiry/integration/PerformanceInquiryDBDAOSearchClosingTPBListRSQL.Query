<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="PerformanceInquiryDBDAOSearchClosingTPBListRSQL">
			<desc><![CDATA[SearchClosingTPBList]]></desc>
			<sql><![CDATA[
#if (${s_status} == 'S')
/* 1. By Status */
SELECT   CASE WHEN O.RHQ IS NULL AND O.OFC IS NULL THEN 'TOTAL' ELSE O.RHQ END AS IF_RHQ_CD
       , CASE WHEN O.RHQ IS NULL AND O.OFC IS NULL THEN 'TOTAL'
              WHEN O.RHQ IS NOT NULL AND O.OFC IS NULL THEN 'SUBTOTAL'
              ELSE O.OFC
         END AS IF_OFC_CD
       , SUM(NVL(A.CNT,0)+NVL(B.CNT,0)+NVL(C.CNT,0)) AS CNT_ABC
       , SUM(NVL(A.AMT,0)) AS AMT_A
       , SUM(NVL(B.AMT,0)) AS AMT_B
       , SUM(NVL(C.AMT,0)) AS AMT_C
       , SUM(NVL(D.CNT,0)) CNT_D, SUM(NVL(D.AMT,0)) AS AMT_D
       , SUM(NVL(E.CNT,0)) CNT_E, SUM(NVL(E.AMT,0)) AS AMT_E
       , SUM(NVL(F.CNT,0)) CNT_F, SUM(NVL(F.AMT,0)) AS AMT_F
       , SUM(NVL(A.CNT,0)+NVL(B.CNT,0)+NVL(C.CNT,0)+NVL(D.CNT,0)+NVL(E.CNT,0)+NVL(F.CNT,0)) AS CNT_TOT
       , SUM(NVL(A.AMT,0)+NVL(B.AMT,0)+NVL(C.AMT,0)+NVL(D.AMT,0)+NVL(E.AMT,0)+NVL(F.AMT,0)) AS AMT_TOT
FROM     (
           SELECT   0 SEQ
                  , RHQ_CD AS RHQ
                  , OFC_CD AS OFC
           FROM     TPB_HNDL_OFC
           WHERE    1 = 1
           AND      N3PTY_OFC_TP_CD = 'T'
           AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '') 
           AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '') 
           AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '') 
           AND      OFC_CD = @[s_if_ofc_cd]
#end

         ) O
       , (
           -- Closed ERP I/F
           SELECT   NVL(M.RHQ,'(TOTAL)') AS RHQ
                  , NVL(M.OFC,'(TOTAL)') AS OFC
                  , SUM(DECODE(NVL(A.ADJ_AMT,0.0),0.0,1,0)) AS CNT
                  , SUM(TPB_GET_USD_AMT_FNC(A.CLT_AMT,A.CURR_CD,TPB_GET_LCL_DATE_FNC(A.CFM_DT,A.OFC_CD))) AS AMT 
           FROM     TPB_OTS_GRP A
                  , TPB_OTS_GRP_STS C
                  , (
                      SELECT   0 SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '') 
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '') 
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '') 
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                    ) M
           WHERE    1 = 1
           AND      A.N3PTY_NO = C.N3PTY_NO
           AND      A.OFC_CD = M.OFC
           AND      A.N3PTY_DELT_TP_CD = 'N'
           AND      A.N3PTY_BIL_TP_CD IN
                    (
#if (${s_exclude_jo} == 'X') /* excluding JO */
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD NOT IN ('JO') UNION ALL SELECT 'MX' AS N3PTY_BIL_TP_CD FROM DUAL
#elseif (${s_exclude_jo} == 'O') /* only JO */ 
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD IN ('JO')
#elseif (${s_exclude_jo} == 'A') /* ALL */
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE 1 = 1 UNION ALL SELECT 'MX' AS N3PTY_BIL_TP_CD FROM DUAL
#end
                    )
#if (${s_if_type} == 'S')
           AND      A.N3PTY_BIL_TP_CD IN ( SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_IF_TP_CD IN ('S','M') )
#else
           AND      A.N3PTY_BIL_TP_CD IN ( SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_IF_TP_CD = 'R' )
#end
           AND      C.OTS_STS_LST_FLG = 'Y'
           AND      C.OTS_STS_CD IN ('E','L','A')
           AND      C.OTS_STS_CRE_DT >= TPB_GET_SRCH_DATE_FNC(@[s_sdate],'YYYY-MM-DD',@[user_ofc_cd])  /* bind s_date, ofc */
           AND      C.OTS_STS_CRE_DT < TPB_GET_SRCH_DATE_FNC(@[s_edate],'YYYY-MM-DD',@[user_ofc_cd]) + 1 /* bind e_date, ofc */
           AND      A.N3PTY_INV_NO IS NOT NULL
#if (${s_exclude_roc} == 'Y') 
           AND      NOT EXISTS ( SELECT 0 FROM TPB_OTS_DTL S WHERE S.FM_CLT_CNG_OFC_N3PTY_NO = a.n3pty_no )
#end
           GROUP BY ROLLUP(M.RHQ, M.OFC)
           HAVING GROUPING(M.RHQ) = 1 OR GROUPING(M.OFC) = 0
         ) A
       , (
           -- Closed Discount
           SELECT   NVL(M.RHQ,'(TOTAL)') AS RHQ
                  , NVL(M.OFC,'(TOTAL)') AS OFC
                  , COUNT(0) CNT
                  , SUM(TPB_GET_USD_AMT_FNC(A.ADJ_AMT,A.CURR_CD,TPB_GET_LCL_DATE_FNC(A.CFM_DT,A.OFC_CD))) AS AMT
           FROM     TPB_OTS_GRP A
                  , TPB_OTS_GRP_STS C
                  , TPB_ADJ_STS E
                  , (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '') 
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '') 
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '') 
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                    ) M
           WHERE    1 = 1
           AND      A.N3PTY_NO = C.N3PTY_NO
           AND      A.N3PTY_NO = E.N3PTY_NO
           AND      A.OFC_CD = M.OFC
           AND      A.N3PTY_DELT_TP_CD IN ('N')
           AND      A.N3PTY_BIL_TP_CD IN
                    (
#if (${s_exclude_jo} == 'X') /* excluding JO */
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD NOT IN ('JO') UNION ALL SELECT 'MX' AS N3PTY_BIL_TP_CD FROM DUAL
#elseif (${s_exclude_jo} == 'O') /* only JO */ 
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD IN ('JO')
#elseif (${s_exclude_jo} == 'A') /* ALL */
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE 1 = 1 UNION ALL SELECT 'MX' AS N3PTY_BIL_TP_CD FROM DUAL
#end
                    )

#if (${s_if_type} == 'S')
           AND      A.N3PTY_BIL_TP_CD IN ( SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_IF_TP_CD IN ('S','M') )
#else
           AND      A.N3PTY_BIL_TP_CD IN ( SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_IF_TP_CD = 'R' )
#end
           AND      C.OTS_STS_LST_FLG = 'Y'
           AND      C.OTS_STS_CD IN ('E','L','A')
           AND      C.OTS_STS_CRE_DT >= TPB_GET_SRCH_DATE_FNC(@[s_sdate],'YYYY-MM-DD',@[user_ofc_cd])  /* bind s_date, ofc */
           AND      C.OTS_STS_CRE_DT < TPB_GET_SRCH_DATE_FNC(@[s_edate],'YYYY-MM-DD',@[user_ofc_cd]) + 1 /* bind e_date, ofc */
           AND      A.N3PTY_INV_NO IS NOT NULL
           AND      E.STL_STS_LST_FLG = 'Y'
           AND      E.N3PTY_STL_TP_CD = 'D'
#if (${s_exclude_roc} == 'Y')
           AND      NOT EXISTS ( SELECT 0 FROM TPB_OTS_DTL S WHERE S.FM_CLT_CNG_OFC_N3PTY_NO = A.N3PTY_NO )
#end
           GROUP BY ROLLUP(M.RHQ, M.OFC)
           HAVING   GROUPING(M.RHQ) = 1 OR GROUPING(M.OFC) = 0
         ) B
       , (
           -- Closed Currency Chage Adj.
           SELECT   NVL(M.RHQ,'(TOTAL)') AS RHQ
                  , NVL(M.OFC,'(TOTAL)') AS OFC
                  , COUNT(0) AS CNT
                  , SUM(TPB_GET_USD_AMT_FNC(A.ADJ_AMT,A.CURR_CD,TPB_GET_LCL_DATE_FNC(A.CFM_DT,A.OFC_CD))) AS AMT
           FROM     TPB_OTS_GRP A
                  , TPB_OTS_GRP_STS C
                  , TPB_ADJ_STS E
                  , (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '') 
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '') 
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '') 
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                    ) M
           WHERE    1 = 1
           AND      A.N3PTY_NO = C.N3PTY_NO
           AND      A.N3PTY_NO = E.N3PTY_NO
           AND      A.OFC_CD = M.OFC
           AND      A.N3PTY_DELT_TP_CD IN ('N')
           AND      A.N3PTY_BIL_TP_CD IN
                    (
#if (${s_exclude_jo} == 'X') /* excluding JO */
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD NOT IN ('JO') UNION ALL SELECT 'MX' AS N3PTY_BIL_TP_CD FROM DUAL
#elseif (${s_exclude_jo} == 'O') /* only JO */ 
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD IN ('JO')
#elseif (${s_exclude_jo} == 'A') /* ALL */
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE 1 = 1 UNION ALL SELECT 'MX' AS N3PTY_BIL_TP_CD FROM DUAL
#end
                    )

#if (${s_if_type} == 'S')
           AND      A.N3PTY_BIL_TP_CD IN ( SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_IF_TP_CD IN ('S','M') )
#else
           AND      A.N3PTY_BIL_TP_CD IN ( SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_IF_TP_CD = 'R' )
#end
           AND      C.OTS_STS_LST_FLG = 'Y'
           AND      C.OTS_STS_CD IN ('E','L','A')
           AND      C.OTS_STS_CRE_DT >= TPB_GET_SRCH_DATE_FNC(@[s_sdate],'YYYY-MM-DD',@[user_ofc_cd])  /* bind s_date, ofc */
           AND      C.OTS_STS_CRE_DT < TPB_GET_SRCH_DATE_FNC(@[s_edate],'YYYY-MM-DD',@[user_ofc_cd]) + 1 /* bind e_date, ofc */
           AND      A.N3PTY_INV_NO IS NOT NULL
           AND      E.STL_STS_LST_FLG = 'Y'
           AND      E.N3PTY_STL_TP_CD = 'C'
#if (${s_exclude_roc} == 'Y')
           AND      NOT EXISTS ( SELECT 0 FROM TPB_OTS_DTL S WHERE S.FM_CLT_CNG_OFC_N3PTY_NO = A.N3PTY_NO )
#end
           GROUP BY ROLLUP(M.RHQ, M.OFC)
           HAVING   GROUPING(M.RHQ) = 1 OR GROUPING(M.OFC) = 0
         ) C
       , (
           -- Closed Write-Off
           SELECT   NVL(M.RHQ,'(TOTAL)') AS RHQ
                  , NVL(M.OFC,'(TOTAL)') AS OFC
                  , COUNT(0) AS CNT
                  , SUM(TPB_GET_USD_AMT_FNC(A.ADJ_AMT,A.CURR_CD,TPB_GET_LCL_DATE_FNC(A.CFM_DT,A.OFC_CD))) AS AMT
            FROM    TPB_OTS_GRP A
                  , TPB_OTS_GRP_STS C
                  , TPB_ADJ_STS E
                  , (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '') 
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '') 
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '') 
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                    ) M
           WHERE    1 = 1
           AND      A.N3PTY_NO = C.N3PTY_NO
           AND      A.N3PTY_NO = E.N3PTY_NO
           AND      A.OFC_CD = M.OFC
           AND      A.N3PTY_DELT_TP_CD IN ('N')
           AND      A.N3PTY_BIL_TP_CD IN
                    (
#if (${s_exclude_jo} == 'X') /* excluding JO */
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD NOT IN ('JO') UNION ALL SELECT 'MX' N3PTY_BIL_TP_CD FROM DUAL
#elseif (${s_exclude_jo} == 'O') /* only JO */ 
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD IN ('JO')
#elseif (${s_exclude_jo} == 'A') /* ALL */
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE 1=1 UNION ALL SELECT 'MX' N3PTY_BIL_TP_CD FROM DUAL
#end
                    )

#if (${s_if_type} == 'S')
           AND      A.N3PTY_BIL_TP_CD IN ( SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_IF_TP_CD IN ('S','M') )
#else
           AND      A.N3PTY_BIL_TP_CD IN ( SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_IF_TP_CD = 'R' )
#end
           AND      C.OTS_STS_LST_FLG = 'Y'
           AND      C.OTS_STS_CD IN ('E','L','A')
           AND      C.OTS_STS_CRE_DT >= TPB_GET_SRCH_DATE_FNC(@[s_sdate],'YYYY-MM-DD',@[user_ofc_cd])  /* bind s_date, ofc */
           AND      C.OTS_STS_CRE_DT < TPB_GET_SRCH_DATE_FNC(@[s_edate],'YYYY-MM-DD',@[user_ofc_cd]) + 1 /* bind e_date, ofc */
           AND      E.STL_STS_LST_FLG = 'Y'
           AND      E.N3PTY_STL_TP_CD = 'W'
#if (${s_exclude_roc} == 'Y')
           AND      NOT EXISTS ( SELECT 0 FROM TPB_OTS_DTL S WHERE S.FM_CLT_CNG_OFC_N3PTY_NO = A.N3PTY_NO )
#end
           GROUP BY ROLLUP(M.RHQ, M.OFC)
           HAVING   GROUPING(M.RHQ) = 1 OR GROUPING(M.OFC) = 0
         ) D
       , (
           -- Process Close
           SELECT   NVL(M.RHQ,'(TOTAL)') AS RHQ
                  , NVL(M.OFC,'(TOTAL)') AS OFC
                  , COUNT(0) AS CNT
                  , SUM(TPB_GET_USD_AMT_FNC(A.OTS_AMT,A.CURR_CD,TPB_GET_LCL_DATE_FNC(A.CFM_DT,A.OFC_CD))) AS AMT
           FROM     TPB_OTS_GRP A
                  , TPB_OTS_GRP_STS C
                  , (
                      SELECT   0 SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
#if (${s_if_rhq_cd} != '') 
                      AND      RHQ_CD = @[s_if_rhq_cd]     /* bind */
#end
#if (${s_if_ctrl_cd} != '') 
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '') 
                      AND      OFC_CD = @[s_if_ofc_cd]     /* bind */
#end

                    ) M
           WHERE    1 = 1
           AND      A.N3PTY_NO = C.N3PTY_NO
           AND      A.OFC_CD = M.OFC
           AND      A.N3PTY_DELT_TP_CD IN ('C')
           AND      A.N3PTY_BIL_TP_CD IN
                    (
#if (${s_exclude_jo} == 'X') /* excluding JO */
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD NOT IN ('JO') UNION ALL SELECT 'MX' AS N3PTY_BIL_TP_CD FROM DUAL
#elseif (${s_exclude_jo} == 'O') /* only JO */ 
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD IN ('JO')
#elseif (${s_exclude_jo} == 'A') /* ALL */
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE 1=1 UNION ALL SELECT 'MX' AS N3PTY_BIL_TP_CD FROM DUAL
#end
                                      )

#if (${s_if_type} == 'S')
           AND      A.N3PTY_BIL_TP_CD IN ( SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_IF_TP_CD IN ('S','M') )
#else
           AND      A.N3PTY_BIL_TP_CD IN ( SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_IF_TP_CD = 'R' )
#end

           AND      C.OTS_STS_LST_FLG = 'Y'
           AND      C.OTS_STS_CRE_DT >= TPB_GET_SRCH_DATE_FNC(@[s_sdate],'YYYY-MM-DD',@[user_ofc_cd])  /* bind s_date, ofc */
           AND      C.OTS_STS_CRE_DT < TPB_GET_SRCH_DATE_FNC(@[s_edate],'YYYY-MM-DD',@[user_ofc_cd]) + 1 /* bind e_date, ofc */
           GROUP BY ROLLUP(M.RHQ, M.OFC)
           HAVING GROUPING(M.RHQ) = 1 OR GROUPING(M.OFC) = 0
         ) E
       , ( 
           -- Closed ROC
           SELECT   NVL(M.RHQ,'(TOTAL)') AS RHQ
                  , NVL(M.OFC,'(TOTAL)') AS OFC
                  , COUNT(0) AS CNT
                  , SUM(TPB_GET_USD_AMT_FNC(A.OTS_AMT,A.CURR_CD,TPB_GET_LCL_DATE_FNC(A.CFM_DT,A.OFC_CD))) AS AMT
           FROM     TPB_OTS_GRP A
                  , TPB_OTS_GRP_STS C
                  , TPB_ADJ_STS E
                  , (
                      SELECT   0 SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '') 
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '') 
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '') 
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                    ) M
           WHERE    1 = 1
           AND      A.N3PTY_NO = C.N3PTY_NO
           AND      A.N3PTY_NO = E.N3PTY_NO
           AND      A.OFC_CD = M.OFC
           AND      A.N3PTY_DELT_TP_CD IN ('N')
           AND      A.N3PTY_BIL_TP_CD IN
                    (
#if (${s_exclude_jo} == 'X') /* excluding JO */
                      SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd NOT IN ('JO') UNION ALL SELECT 'MX' n3pty_bil_tp_cd FROM DUAL
#elseif (${s_exclude_jo} == 'O') /* only JO */ 
                      SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd IN ('JO')
#elseif (${s_exclude_jo} == 'A') /* ALL */
                      SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE 1=1 UNION ALL SELECT 'MX' n3pty_bil_tp_cd FROM DUAL
#end
                    )

#if (${s_if_type} == 'S')
           AND      A.N3PTY_BIL_TP_CD IN ( SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_IF_TP_CD IN ('S','M') )
#else
           AND      A.N3PTY_BIL_TP_CD IN ( SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_IF_TP_CD = 'R' )
#end
           AND      C.OTS_STS_LST_FLG = 'Y'
           AND      C.OTS_STS_CD IN ('E','L','A')
           AND      E.CRE_DT >= TPB_GET_SRCH_DATE_FNC(@[s_sdate],'YYYY-MM-DD',@[user_ofc_cd])
           AND      E.CRE_DT < TPB_GET_SRCH_DATE_FNC(@[s_edate],'YYYY-MM-DD',@[user_ofc_cd]) + 1
           AND      E.STL_STS_LST_FLG = 'Y'
           AND      E.N3PTY_STL_TP_CD = 'O'
           AND      E.CRE_DT < TO_DATE('2008-11-10','YYYY-MM-DD')
#if (${s_exclude_roc} == 'Y')
           AND      NOT EXISTS ( SELECT 0 FROM TPB_OTS_DTL S WHERE S.FM_CLT_CNG_OFC_N3PTY_NO = A.N3PTY_NO )
#end
           GROUP BY ROLLUP(M.RHQ, M.OFC)
           HAVING   GROUPING(M.RHQ) = 1 OR GROUPING(M.OFC) = 0
         ) F
WHERE    1 = 1
AND      O.RHQ = A.RHQ(+)
AND      O.OFC = A.OFC(+)
AND      O.RHQ = B.RHQ(+)
AND      O.OFC = B.OFC(+)
AND      O.RHQ = C.RHQ(+)
AND      O.OFC = C.OFC(+)
AND      O.RHQ = D.RHQ(+)
AND      O.OFC = D.OFC(+)
AND      O.RHQ = E.RHQ(+)
AND      O.OFC = E.OFC(+)
AND      O.RHQ = F.RHQ(+)
AND      O.OFC = F.OFC(+)
GROUP BY GROUPING SETS ((O.RHQ, O.OFC), O.RHQ, ())
ORDER BY O.RHQ
       , O.OFC
#elseif (${s_status} == 'E')
-- 2. By Expense Type
SELECT   CASE WHEN O.RHQ IS NULL AND O.OFC IS NULL THEN 'TOTAL' ELSE O.RHQ END AS IF_RHQ_CD
       , CASE WHEN O.RHQ IS NULL AND O.OFC IS NULL THEN 'TOTAL'
              WHEN O.RHQ IS NOT NULL AND O.OFC IS NULL THEN 'SUBTOTAL'
              ELSE O.OFC
         END AS IF_OFC_CD
       , SUM(NVL(A.CNT,0)) ASCNT_A
       , SUM(NVL(A.AMT,0)) AS AMT_A
       , SUM(NVL(B.CNT,0)) AS CNT_B
       , SUM(NVL(B.AMT,0)) AS AMT_B
       , SUM(NVL(C.CNT,0)) AS CNT_C
       , SUM(NVL(C.AMT,0)) AS AMT_C
       , SUM(NVL(A.CNT,0) + NVL(B.CNT,0) + NVL(C.CNT,0)) AS CNT_TOT
       , SUM(NVL(A.AMT,0) + NVL(B.AMT,0) + NVL(C.AMT,0)) AS AMT_TOT
FROM     (
           SELECT   0 SEQ
                  , RHQ_CD AS RHQ
                  , OFC_CD AS OFC
           FROM     TPB_HNDL_OFC
           WHERE    1 = 1
           AND      N3PTY_OFC_TP_CD = 'T'
           AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '') 
           AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '') 
           AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '') 
           AND      OFC_CD = @[s_if_ofc_cd]
#end
         ) O
       , (
           -- TES
           SELECT   NVL(M.RHQ,'(TOTAL)') RHQ, NVL(M.OFC,'(TOTAL)') AS OFC
                  , COUNT(0) AS CNT
                  , SUM(TPB_GET_USD_AMT_FNC(D.INV_AMT,D.CURR_CD,TPB_GET_LCL_DATE_FNC(A.CFM_DT,A.OFC_CD))) AS AMT  
           FROM     TPB_OTS_GRP A
                  , TPB_OTS_GRP_STS C
                  , (
                      SELECT   0 SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '') 
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '') 
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '') 
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                    ) M
                  , (
                      SELECT   A.N3PTY_INV_NO
                             , INV_AMT
                             , CURR_CD          
                      FROM     TPB_INV_RVIS A
                             , (
                                 SELECT   N3PTY_INV_NO
                                        , MAX(N3PTY_INV_RVIS_SEQ) AS N3PTY_INV_RVIS_SEQ
                                 FROM     TPB_INV_RVIS
                                 GROUP BY N3PTY_INV_NO
                               ) B
                      WHERE    1 = 1
                      AND      A.N3PTY_INV_NO = B.N3PTY_INV_NO
                      AND      A.N3PTY_INV_RVIS_SEQ = B.N3PTY_INV_RVIS_SEQ
                    ) D
           WHERE    1 = 1
           AND      A.N3PTY_NO = C.N3PTY_NO
           AND      A.N3PTY_INV_NO = D.N3PTY_INV_NO
           AND      A.OFC_CD = M.OFC
           AND      A.N3PTY_DELT_TP_CD = 'N'
           AND      A.N3PTY_BIL_TP_CD IN
                    (
#if (${s_exclude_jo} == 'X') /* excluding JO */
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD NOT IN ('JO') UNION ALL SELECT 'MX' AS N3PTY_BIL_TP_CD FROM DUAL
#elseif (${s_exclude_jo} == 'O') /* only JO */ 
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD IN ('JO')
#elseif (${s_exclude_jo} == 'A') /* ALL */
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE 1=1 UNION ALL SELECT 'MX' AS N3PTY_BIL_TP_CD FROM DUAL
#end
                    )

#if (${s_if_type} == 'S')
           AND      A.N3PTY_BIL_TP_CD IN ( SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_IF_TP_CD IN ('S','M') )
#else
           AND      A.N3PTY_BIL_TP_CD IN ( SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_IF_TP_CD = 'R' )
#end
           AND      C.OTS_STS_LST_FLG = 'Y'
           AND      C.OTS_STS_CD IN ('E','L','A')
           AND      C.OTS_STS_CRE_DT >= TPB_GET_SRCH_DATE_FNC(@[s_sdate],'YYYY-MM-DD',@[user_ofc_cd])  /* bind s_date, ofc */
           AND      C.OTS_STS_CRE_DT < TPB_GET_SRCH_DATE_FNC(@[s_edate],'YYYY-MM-DD',@[user_ofc_cd]) + 1 /* bind e_date, ofc */
           AND      A.N3PTY_EXPN_TP_CD = 'TES'
#if (${s_exclude_roc} == 'Y') 
           AND      NOT EXISTS ( SELECT 0 FROM TPB_OTS_DTL s WHERE s.FM_CLT_CNG_OFC_N3PTY_NO = a.n3pty_no )
#end
           GROUP BY ROLLUP(M.RHQ, M.OFC)
           HAVING GROUPING(M.RHQ) = 1 OR GROUPING(M.OFC) = 0
         ) A
       , (
           -- TRS
           SELECT   NVL(M.RHQ,'(TOTAL)') AS RHQ
                  , NVL(M.OFC,'(TOTAL)') AS OFC
                  , COUNT(0) CNT
                  , SUM(TPB_GET_USD_AMT_FNC(D.INV_AMT,D.CURR_CD,TPB_GET_LCL_DATE_FNC(A.CFM_DT,A.OFC_CD))) AS AMT      
           FROM     TPB_OTS_GRP A
                  , TPB_OTS_GRP_STS C
                  , (
                      SELECT   0 SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '') 
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '') 
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '') 
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                    ) M
                  , (
                      SELECT   A.N3PTY_INV_NO
                             , INV_AMT
                             , CURR_CD                        
                      FROM     TPB_INV_RVIS A
                             , (
                                 SELECT   N3PTY_INV_NO
                                        , MAX(N3PTY_INV_RVIS_SEQ) AS N3PTY_INV_RVIS_SEQ
                                 FROM     TPB_INV_RVIS
                                 GROUP BY N3PTY_INV_NO
                               ) B
                      WHERE    1 = 1
                      AND      A.N3PTY_INV_NO = B.N3PTY_INV_NO
                      AND      A.N3PTY_INV_RVIS_SEQ = B.N3PTY_INV_RVIS_SEQ
                    ) D
           WHERE    1 = 1
           AND      A.N3PTY_NO = C.N3PTY_NO
           AND      A.N3PTY_INV_NO = D.N3PTY_INV_NO
           AND      A.OFC_CD = M.OFC
           AND      A.N3PTY_DELT_TP_CD = 'N'
           AND      A.N3PTY_BIL_TP_CD IN
                    (
#if (${s_exclude_jo} == 'X') /* excluding JO */
                      SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd NOT IN ('JO') UNION ALL SELECT 'MX' n3pty_bil_tp_cd FROM DUAL
#elseif (${s_exclude_jo} == 'O') /* only JO */ 
                      SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE n3pty_bil_tp_cd IN ('JO')
#elseif (${s_exclude_jo} == 'A') /* ALL */
                      SELECT n3pty_bil_tp_cd FROM tpb_n3rd_pty_bil_tp WHERE 1=1 UNION ALL SELECT 'MX' n3pty_bil_tp_cd FROM DUAL
#end
                    )

#if (${s_if_type} == 'S')
           AND      A.N3PTY_BIL_TP_CD IN ( SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_IF_TP_CD IN ('S','M') )
#else
           AND      A.N3PTY_BIL_TP_CD IN ( SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_IF_TP_CD = 'R' )
#end
           AND      C.OTS_STS_LST_FLG = 'Y'
           AND      C.OTS_STS_CD IN ('E','L','A')
           AND      C.OTS_STS_CRE_DT >= TPB_GET_SRCH_DATE_FNC(@[s_sdate],'YYYY-MM-DD',@[user_ofc_cd])  /* bind s_date, ofc */
           AND      C.OTS_STS_CRE_DT < TPB_GET_SRCH_DATE_FNC(@[s_edate],'YYYY-MM-DD',@[user_ofc_cd]) + 1 /* bind e_date, ofc */
           AND      A.N3PTY_EXPN_TP_CD = 'TRS'
#if (${s_exclude_roc} == 'Y') 
           AND      NOT EXISTS ( SELECT 0 FROM TPB_OTS_DTL s WHERE s.FM_CLT_CNG_OFC_N3PTY_NO = a.n3pty_no )
#end
           GROUP BY ROLLUP(M.RHQ, M.OFC)
           HAVING   GROUPING(M.RHQ) = 1 OR GROUPING(M.OFC) = 0
         ) b
       , (
           -- MNR
           SELECT   NVL(M.RHQ,'(TOTAL)') AS RHQ
                  , NVL(M.OFC,'(TOTAL)') AS OFC
                  , COUNT(0) AS CNT
                  , SUM(TPB_GET_USD_AMT_FNC(D.INV_AMT,D.CURR_CD,TPB_GET_LCL_DATE_FNC(A.CFM_DT,A.OFC_CD))) AS AMT              
           FROM     TPB_OTS_GRP A
                  , TPB_OTS_GRP_STS C
                  , (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '') 
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '') 
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '') 
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                    ) m
                  , (
                      SELECT   A.N3PTY_INV_NO
                             , INV_AMT
                             , CURR_CD                                                 
                      FROM     TPB_INV_RVIS A
                             , (
                                 SELECT   N3PTY_INV_NO
                                        , MAX(N3PTY_INV_RVIS_SEQ) AS N3PTY_INV_RVIS_SEQ
                                 FROM     TPB_INV_RVIS
                                 GROUP BY N3PTY_INV_NO
                               ) B
                      WHERE    1 = 1
                      AND      A.N3PTY_INV_NO = B.N3PTY_INV_NO
                      AND      A.N3PTY_INV_RVIS_SEQ = B.N3PTY_INV_RVIS_SEQ
                    ) D
           WHERE    1 = 1
           AND      A.N3PTY_NO = C.N3PTY_NO
           AND      A.N3PTY_INV_NO = D.N3PTY_INV_NO
           AND      A.OFC_CD = M.OFC
           AND      A.N3PTY_DELT_TP_CD = 'N'
           AND      A.N3PTY_BIL_TP_CD IN
                    (
#if (${s_exclude_jo} == 'X') /* excluding JO */
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD NOT IN ('JO') UNION ALL SELECT 'MX' AS N3PTY_BIL_TP_CD FROM DUAL
#elseif (${s_exclude_jo} == 'O') /* only JO */ 
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD IN ('JO')
#elseif (${s_exclude_jo} == 'A') /* ALL */
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE 1 = 1 UNION ALL SELECT 'MX' AS N3PTY_BIL_TP_CD FROM DUAL
#end
                    )

#if (${s_if_type} == 'S')
           AND      A.N3PTY_BIL_TP_CD IN ( SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_IF_TP_CD IN ('S','M') )
#else
           AND      A.N3PTY_BIL_TP_CD IN ( SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_IF_TP_CD = 'R' )
#end
           AND      C.OTS_STS_LST_FLG = 'Y'
           AND      C.OTS_STS_CD IN ('E','L','A')
           AND      C.OTS_STS_CRE_DT >= TPB_GET_SRCH_DATE_FNC(@[s_sdate],'YYYY-MM-DD',@[user_ofc_cd])  /* bind s_date, ofc */
           AND      C.OTS_STS_CRE_DT < TPB_GET_SRCH_DATE_FNC(@[s_edate],'YYYY-MM-DD',@[user_ofc_cd]) + 1 /* bind e_date, ofc */
           AND      A.N3PTY_EXPN_TP_CD = 'MNR'
#if (${s_exclude_roc} == 'Y') 
           AND      NOT EXISTS ( SELECT 0 FROM TPB_OTS_DTL S WHERE S.FM_CLT_CNG_OFC_N3PTY_NO = A.N3PTY_NO )
#end
           GROUP BY ROLLUP(M.RHQ, M.OFC)
           HAVING   GROUPING(M.RHQ) = 1 OR GROUPING(M.OFC) = 0
         ) C
WHERE    1 = 1
AND      O.RHQ = A.RHQ(+)
AND      O.OFC = A.OFC(+)
AND      O.RHQ = B.RHQ(+)
AND      O.OFC = B.OFC(+)
AND      O.RHQ = C.RHQ(+)
AND      O.OFC = C.OFC(+)
GROUP BY GROUPING SETS ((O.RHQ, O.OFC), O.RHQ, ())
ORDER BY O.RHQ
       , O.OFC   
#elseif (${s_status} == 'A')
-- 3. Aging
SELECT   CASE WHEN O.RHQ IS NULL AND O.OFC IS NULL THEN 'TOTAL' ELSE O.RHQ END  AS IF_RHQ_CD
       , CASE WHEN O.RHQ IS NULL AND O.OFC IS NULL THEN 'TOTAL'
              WHEN O.RHQ IS NOT NULL AND O.OFC IS NULL THEN 'SUBTOTAL'
              ELSE O.OFC
         END AS IF_OFC_CD
       , SUM(NVL(A.CNT, 0)) CNT_A
       , SUM(NVL(A.AMT, 0)) AMT_A
       , SUM(NVL(B.CNT, 0)) CNT_B
       , SUM(NVL(B.AMT, 0)) AMT_B
       , SUM(NVL(C.CNT, 0)) CNT_C
       , SUM(NVL(C.AMT, 0)) AMT_C
       , SUM(NVL(D.CNT, 0)) CNT_D
       , SUM(NVL(D.AMT, 0)) AMT_D
       , SUM(NVL(E.CNT, 0)) CNT_E
       , SUM(NVL(E.AMT, 0)) AMT_E
       , SUM(NVL(A.CNT, 0)+NVL(B.CNT, 0)+NVL(C.CNT, 0)+NVL(D.CNT, 0)+NVL(E.CNT, 0)) CNT_TOT
       , SUM(NVL(A.AMT, 0)+NVL(B.AMT, 0)+NVL(C.AMT, 0)+NVL(D.AMT, 0)+NVL(E.AMT, 0)) AMT_TOT
FROM     (
           SELECT   0 SEQ
                  , RHQ_CD AS RHQ
                  , OFC_CD AS OFC
           FROM     TPB_HNDL_OFC
           WHERE    1 = 1
           AND      N3PTY_OFC_TP_CD = 'T'
           AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '') 
           AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '') 
           AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '') 
           AND      OFC_CD = @[s_if_ofc_cd]
#end
         ) O
       , (
           -- in 30 days
           SELECT   NVL(m.rhq,'(TOTAL)') rhq, NVL(m.ofc,'(TOTAL)') AS ofc
                  , COUNT(0) AS cnt
                  , SUM(TPB_GET_USD_AMT_FNC(D.INV_AMT,D.curr_cd,TPB_GET_LCL_DATE_FNC(a.cfm_dt,a.ofc_cd))) AS amt             
           FROM     TPB_OTS_GRP a
                  , TPB_OTS_GRP_STS c
                  , (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '') 
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '') 
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '') 
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                    ) M
                  , (
                      SELECT   A.N3PTY_INV_NO
                             , INV_AMT
                             , CURR_CD                   
                      FROM     TPB_INV_RVIS A
                             , (
                                 SELECT   N3PTY_INV_NO
                                        , MAX(N3PTY_INV_RVIS_SEQ) AS N3PTY_INV_RVIS_SEQ
                                 FROM     TPB_INV_RVIS
                                 GROUP BY N3PTY_INV_NO
                               ) B
                      WHERE    1 = 1
                      AND      A.N3PTY_INV_NO = B.N3PTY_INV_NO
                      AND      A.N3PTY_INV_RVIS_SEQ = B.N3PTY_INV_RVIS_SEQ
                    ) D
           WHERE    1 = 1
           AND      A.N3PTY_NO = C.N3PTY_NO
           AND      A.N3PTY_INV_NO = D.N3PTY_INV_NO
           AND      A.OFC_CD = M.OFC
           AND      A.N3PTY_DELT_TP_CD = 'N'
           AND      A.N3PTY_BIL_TP_CD IN
                    (
#if (${s_exclude_jo} == 'X') /* excluding JO */
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD NOT IN ('JO') UNION ALL SELECT 'MX' AS N3PTY_BIL_TP_CD FROM DUAL
#elseif (${s_exclude_jo} == 'O') /* only JO */ 
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD IN ('JO')
#elseif (${s_exclude_jo} == 'A') /* ALL */
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE 1 = 1 UNION ALL SELECT 'MX' AS N3PTY_BIL_TP_CD FROM DUAL
#end
                    )

#if (${s_if_type} == 'S')
           AND      A.N3PTY_BIL_TP_CD IN ( SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_IF_TP_CD IN ('S','M') )
#else
           AND      A.N3PTY_BIL_TP_CD IN ( SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_IF_TP_CD = 'R' )
#end
           AND      C.OTS_STS_LST_FLG = 'Y'
           AND      C.OTS_STS_CD IN ('E','L','A')
           AND      C.OTS_STS_CRE_DT >= TPB_GET_SRCH_DATE_FNC(@[s_sdate],'YYYY-MM-DD',@[user_ofc_cd])  /* bind s_date, ofc */
           AND      C.OTS_STS_CRE_DT < TPB_GET_SRCH_DATE_FNC(@[s_edate],'YYYY-MM-DD',@[user_ofc_cd]) + 1 /* bind e_date, ofc */
           AND      A.CFM_DT <= SYSDATE - 0
           AND      A.CFM_DT > SYSDATE - 31
#if (${s_exclude_roc} == 'Y') 
           AND      NOT EXISTS ( SELECT 0 FROM TPB_OTS_DTL S WHERE S.FM_CLT_CNG_OFC_N3PTY_NO = A.N3PTY_NO )
#end
           GROUP BY ROLLUP(M.RHQ, M.OFC)
           HAVING   GROUPING(M.RHQ) = 1 OR GROUPING(M.OFC) = 0
         ) A
       , (
           -- 31~60 days
           SELECT   NVL(m.rhq,'(TOTAL)') rhq, NVL(m.ofc,'(TOTAL)') AS ofc
                  , COUNT(0) AS cnt
                  , SUM(TPB_GET_USD_AMT_FNC(D.INV_AMT,D.curr_cd,TPB_GET_LCL_DATE_FNC(a.cfm_dt,a.ofc_cd))) AS amt     
           FROM     TPB_OTS_GRP a
                  , TPB_OTS_GRP_STS c
                  , (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '') 
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '') 
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '') 
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                    ) M
                  , (
                      SELECT   A.N3PTY_INV_NO
                             , INV_AMT
                             , CURR_CD                  
                      FROM     TPB_INV_RVIS A
                             , (
                                 SELECT   N3PTY_INV_NO
                                        , MAX(N3PTY_INV_RVIS_SEQ) AS N3PTY_INV_RVIS_SEQ
                                 FROM     TPB_INV_RVIS
                                 GROUP BY N3PTY_INV_NO
                               ) B
                      WHERE    1 = 1
                      AND      A.N3PTY_INV_NO = B.N3PTY_INV_NO
                      AND      A.N3PTY_INV_RVIS_SEQ = B.N3PTY_INV_RVIS_SEQ
                    ) D
           WHERE    1 = 1
           AND      A.N3PTY_NO = C.N3PTY_NO
           AND      A.N3PTY_INV_NO = D.N3PTY_INV_NO
           AND      A.OFC_CD = M.OFC
           AND      A.N3PTY_DELT_TP_CD = 'N'
           AND      A.N3PTY_BIL_TP_CD IN
                    (
#if (${s_exclude_jo} == 'X') /* excluding JO */
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD NOT IN ('JO') UNION ALL SELECT 'MX' AS N3PTY_BIL_TP_CD FROM DUAL
#elseif (${s_exclude_jo} == 'O') /* only JO */ 
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD IN ('JO')
#elseif (${s_exclude_jo} == 'A') /* ALL */
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE 1=1 UNION ALL SELECT 'MX' AS N3PTY_BIL_TP_CD FROM DUAL
#end
                    )

#if (${s_if_type} == 'S')
           AND      A.N3PTY_BIL_TP_CD IN ( SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_IF_TP_CD IN ('S','M') )
#else
           AND      A.N3PTY_BIL_TP_CD IN ( SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_IF_TP_CD = 'R' )
#end
           AND      C.OTS_STS_LST_FLG = 'Y'
           AND      C.OTS_STS_CD IN ('E','L','A')
           AND      C.OTS_STS_CRE_DT >= TPB_GET_SRCH_DATE_FNC(@[s_sdate],'YYYY-MM-DD',@[user_ofc_cd])  /* bind s_date, ofc */
           AND      C.OTS_STS_CRE_DT < TPB_GET_SRCH_DATE_FNC(@[s_edate],'YYYY-MM-DD',@[user_ofc_cd]) + 1 /* bind e_date, ofc */
           AND      A.CFM_DT <= SYSDATE - 31
           AND      A.CFM_DT > SYSDATE - 61
#if (${s_exclude_roc} == 'Y') 
           AND      NOT EXISTS ( SELECT 0 FROM TPB_OTS_DTL S WHERE S.FM_CLT_CNG_OFC_N3PTY_NO = A.N3PTY_NO )
#end
           GROUP BY ROLLUP(M.RHQ, M.OFC)
           HAVING   GROUPING(M.RHQ) = 1 OR GROUPING(M.OFC) = 0
         ) b
       , (
           -- 61~90 days
           SELECT   NVL(M.RHQ,'(TOTAL)') AS RHQ
                  , NVL(M.OFC,'(TOTAL)') AS OFC
                  , COUNT(0) AS CNT
                  , SUM(TPB_GET_USD_AMT_FNC(D.INV_AMT,D.CURR_CD,TPB_GET_LCL_DATE_FNC(A.CFM_DT,A.OFC_CD))) AS AMT  
           FROM     TPB_OTS_GRP A
                  , TPB_OTS_GRP_STS C
                  , (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '') 
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '') 
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '') 
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                    ) m
                  , (
                      SELECT   A.N3PTY_INV_NO
                             , INV_AMT
                             , CURR_CD   
                      FROM     TPB_INV_RVIS A
                             , (
                                 SELECT   N3PTY_INV_NO
                                        , MAX(N3PTY_INV_RVIS_SEQ) AS N3PTY_INV_RVIS_SEQ
                                 FROM     TPB_INV_RVIS
                                 GROUP BY N3PTY_INV_NO
                               ) B
                      WHERE    1 = 1
                      AND      A.N3PTY_INV_NO = B.N3PTY_INV_NO
                      AND      A.N3PTY_INV_RVIS_SEQ = B.N3PTY_INV_RVIS_SEQ
                    ) D
           WHERE    1 = 1
           AND      A.N3PTY_NO = C.N3PTY_NO
           AND      A.N3PTY_INV_NO = D.N3PTY_INV_NO
           AND      A.OFC_CD = M.OFC
           AND      A.N3PTY_DELT_TP_CD = 'N'
           AND      A.N3PTY_BIL_TP_CD IN
                    (
#if (${s_exclude_jo} == 'X') /* excluding JO */
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD NOT IN ('JO') UNION ALL SELECT 'MX' AS N3PTY_BIL_TP_CD FROM DUAL
#elseif (${s_exclude_jo} == 'O') /* only JO */ 
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD IN ('JO')
#elseif (${s_exclude_jo} == 'A') /* ALL */
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE 1 = 1 UNION ALL SELECT 'MX' AS N3PTY_BIL_TP_CD FROM DUAL
#end
                    )

#if (${s_if_type} == 'S')
           AND      A.N3PTY_BIL_TP_CD IN ( SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_IF_TP_CD IN ('S','M') )
#else
           AND      A.N3PTY_BIL_TP_CD IN ( SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_IF_TP_CD = 'R' )
#end
           AND      C.OTS_STS_LST_FLG = 'Y'
           AND      C.OTS_STS_CD IN ('E','L','A')
           AND      C.OTS_STS_CRE_DT >= TPB_GET_SRCH_DATE_FNC(@[s_sdate],'YYYY-MM-DD',@[user_ofc_cd])  /* bind s_date, ofc */
           AND      C.OTS_STS_CRE_DT < TPB_GET_SRCH_DATE_FNC(@[s_edate],'YYYY-MM-DD',@[user_ofc_cd]) + 1 /* bind e_date, ofc */
           AND      A.CFM_DT <= SYSDATE - 61
           AND      A.CFM_DT > SYSDATE - 91
#if (${s_exclude_roc} == 'Y') 
           AND      NOT EXISTS ( SELECT 0 FROM TPB_OTS_DTL S WHERE S.FM_CLT_CNG_OFC_N3PTY_NO = A.N3PTY_NO )
#end
           GROUP BY ROLLUP(M.RHQ, M.OFC)
           HAVING   GROUPING(M.RHQ) = 1 OR GROUPING(M.OFC) = 0
         ) C
       , (
           -- 91~180 days
           SELECT   NVL(M.RHQ,'(TOTAL)') AS RHQ
                  , NVL(M.OFC,'(TOTAL)') AS OFC
                  , COUNT(0) AS CNT
                  , SUM(TPB_GET_USD_AMT_FNC(D.INV_AMT,D.CURR_CD,TPB_GET_LCL_DATE_FNC(A.CFM_DT,A.OFC_CD))) AS AMT
           FROM     TPB_OTS_GRP A, TPB_OTS_GRP_STS C,
                    (
                      SELECT   0 SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '') 
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '') 
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '') 
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                    ) M
                  , (
                      SELECT   A.N3PTY_INV_NO
                             , INV_AMT
                             , CURR_CD      
                      FROM     TPB_INV_RVIS A
                             , (
                                 SELECT   N3PTY_INV_NO
                                        , MAX(N3PTY_INV_RVIS_SEQ) AS N3PTY_INV_RVIS_SEQ
                                 FROM     TPB_INV_RVIS
                                 GROUP BY N3PTY_INV_NO
                               ) B
                      WHERE    1 = 1
                      AND      A.N3PTY_INV_NO = B.N3PTY_INV_NO
                      AND      A.N3PTY_INV_RVIS_SEQ = B.N3PTY_INV_RVIS_SEQ
                    ) D
           WHERE    1 = 1
           AND      A.N3PTY_NO = C.N3PTY_NO
           AND      A.N3PTY_INV_NO = D.N3PTY_INV_NO
           AND      A.OFC_CD = M.OFC
           AND      A.N3PTY_DELT_TP_CD = 'N'
           AND      A.N3PTY_BIL_TP_CD IN
                    (
#if (${s_exclude_jo} == 'X') /* excluding JO */
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD NOT IN ('JO') UNION ALL SELECT 'MX' AS N3PTY_BIL_TP_CD FROM DUAL
#elseif (${s_exclude_jo} == 'O') /* only JO */ 
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD IN ('JO')
#elseif (${s_exclude_jo} == 'A') /* ALL */
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE 1=1 UNION ALL SELECT 'MX' AS N3PTY_BIL_TP_CD FROM DUAL
#end
                    )

#if (${s_if_type} == 'S')
           AND      A.N3PTY_BIL_TP_CD IN ( SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_IF_TP_CD IN ('S','M') )
#else
           AND      A.N3PTY_BIL_TP_CD IN ( SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_IF_TP_CD = 'R' )
#end
           AND      C.OTS_STS_LST_FLG = 'Y'
           AND      C.OTS_STS_CD IN ('E','L','A')
           AND      C.OTS_STS_CRE_DT >= TPB_GET_SRCH_DATE_FNC(@[s_sdate],'YYYY-MM-DD',@[user_ofc_cd])  /* bind s_date, ofc */
           AND      C.OTS_STS_CRE_DT < TPB_GET_SRCH_DATE_FNC(@[s_edate],'YYYY-MM-DD',@[user_ofc_cd]) + 1 /* bind e_date, ofc */
           AND      A.CFM_DT <= SYSDATE - 91
           AND      A.CFM_DT > SYSDATE - 181
#if (${s_exclude_roc} == 'Y') 
           AND      NOT EXISTS ( SELECT 0 FROM TPB_OTS_DTL S WHERE S.FM_CLT_CNG_OFC_N3PTY_NO = A.N3PTY_NO )
#end
           GROUP BY ROLLUP(M.RHQ, M.OFC)
           HAVING   GROUPING(M.RHQ) = 1 OR GROUPING(M.OFC) = 0
         ) D
       , (
           -- over 180 days
           SELECT   NVL(M.RHQ,'(TOTAL)') AS RHQ
                  , NVL(M.OFC,'(TOTAL)') AS OFC
                  , COUNT(0) AS CNT
                  , SUM(TPB_GET_USD_AMT_FNC(D.INV_AMT,D.CURR_CD,TPB_GET_LCL_DATE_FNC(A.CFM_DT,A.OFC_CD))) AS AMT      
           FROM     TPB_OTS_GRP A
                  , TPB_OTS_GRP_STS C
                  , (
                      SELECT   0 AS SEQ
                             , RHQ_CD AS RHQ
                             , OFC_CD AS OFC
                      FROM     TPB_HNDL_OFC
                      WHERE    1 = 1
                      AND      N3PTY_OFC_TP_CD = 'T'
                      AND      NVL(DELT_FLG,'N') = 'N'
#if (${s_if_rhq_cd} != '') 
                      AND      RHQ_CD = @[s_if_rhq_cd]
#end
#if (${s_if_ctrl_cd} != '') 
                      AND      N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
#end
#if (${s_if_ofc_cd} != '') 
                      AND      OFC_CD = @[s_if_ofc_cd]
#end
                    ) M
                  , (
                      SELECT   A.N3PTY_INV_NO
                             , INV_AMT
                             , CURR_CD     
                      FROM     TPB_INV_RVIS A
                             , (
                                 SELECT   N3PTY_INV_NO
                                        , MAX(N3PTY_INV_RVIS_SEQ) AS N3PTY_INV_RVIS_SEQ
                                 FROM     TPB_INV_RVIS
                                 GROUP BY N3PTY_INV_NO
                               ) B
                      WHERE    1 = 1
                      AND      A.N3PTY_INV_NO = B.N3PTY_INV_NO
                      AND      A.N3PTY_INV_RVIS_SEQ = B.N3PTY_INV_RVIS_SEQ
                    ) D
           WHERE    1 = 1
           AND      A.N3PTY_NO = C.N3PTY_NO
           AND      A.N3PTY_INV_NO = D.N3PTY_INV_NO
           AND      A.OFC_CD = M.OFC
           AND      A.N3PTY_DELT_TP_CD = 'N'
           AND      A.N3PTY_BIL_TP_CD IN
                    (
#if (${s_exclude_jo} == 'X') /* excluding JO */
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD NOT IN ('JO') UNION ALL SELECT 'MX' AS N3PTY_BIL_TP_CD FROM DUAL
#elseif (${s_exclude_jo} == 'O') /* only JO */ 
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD IN ('JO')
#elseif (${s_exclude_jo} == 'A') /* ALL */
                      SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE 1=1 UNION ALL SELECT 'MX' AS N3PTY_BIL_TP_CD FROM DUAL
#end
                    )

#if (${s_if_type} == 'S')
           AND      A.N3PTY_BIL_TP_CD IN ( SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_IF_TP_CD IN ('S','M') )
#else
           AND      A.N3PTY_BIL_TP_CD IN ( SELECT N3PTY_BIL_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_IF_TP_CD = 'R' )
#end
           AND      C.OTS_STS_LST_FLG = 'Y'
           AND      C.OTS_STS_CD IN ('E','L','A')
           AND      C.OTS_STS_CRE_DT >= TPB_GET_SRCH_DATE_FNC(@[s_sdate],'YYYY-MM-DD',@[user_ofc_cd])  /* bind s_date, ofc */
           AND      C.OTS_STS_CRE_DT < TPB_GET_SRCH_DATE_FNC(@[s_edate],'YYYY-MM-DD',@[user_ofc_cd]) + 1 /* bind e_date, ofc */
           AND      A.CFM_DT <= SYSDATE - 181
#if (${s_exclude_roc} == 'Y') 
           AND      NOT EXISTS ( SELECT 0 FROM TPB_OTS_DTL S WHERE S.FM_CLT_CNG_OFC_N3PTY_NO = A.N3PTY_NO )
#end
           GROUP BY ROLLUP(M.RHQ, M.OFC)
           HAVING   GROUPING(M.RHQ) = 1 OR GROUPING(M.OFC) = 0
         ) E
WHERE    1 = 1
AND      O.RHQ = A.RHQ(+) AND O.OFC = A.OFC(+)
AND      O.RHQ = B.RHQ(+) AND O.OFC = B.OFC(+)
AND      O.RHQ = C.RHQ(+) AND O.OFC = C.OFC(+)
AND      O.RHQ = D.RHQ(+) AND O.OFC = D.OFC(+)
AND      O.RHQ = E.RHQ(+) AND O.OFC = E.OFC(+)
GROUP BY GROUPING SETS ((O.RHQ, O.OFC), O.RHQ, ())
ORDER BY O.RHQ, O.OFC  
#end			]]></sql>
			<params>
				<param name="s_if_rhq_cd" type="12" value="" out="N"/>
				<param name="s_if_ctrl_cd" type="12" value="" out="N"/>
				<param name="s_if_ofc_cd" type="12" value="" out="N"/>
				<param name="s_sdate" type="12" value="" out="N"/>
				<param name="user_ofc_cd" type="12" value="" out="N"/>
				<param name="s_edate" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
