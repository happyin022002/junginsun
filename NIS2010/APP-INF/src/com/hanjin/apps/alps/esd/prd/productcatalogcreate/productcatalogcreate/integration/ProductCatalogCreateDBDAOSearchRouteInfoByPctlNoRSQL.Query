<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ProductCatalogCreateDBDAOSearchRouteInfoByPctlNoRSQL">
			<desc><![CDATA[SearchRouteInfoByPctlNo]]></desc>
			<sql><![CDATA[
SELECT POR_CD,POL_CD,POD_CD,DEL_CD,CNST_FLG,
	(SELECT to_char(ARR_ST_DT,'yyyy-mm-dd') FROM PRD_PROD_CTL_ROUT_DTL P WHERE  P.PCTL_NO = D.PCTL_NO AND MTY_YD_FLG='Y' AND PCTL_IO_BND_CD='O'
	) MT_PU_DATE,
	(SELECT to_char(MAX(ARR_ST_DT),'yyyy-mm-dd') FROM PRD_PROD_CTL_ROUT_DTL P WHERE  P.PCTL_NO = D.PCTL_NO AND PCTL_IO_BND_CD='I' AND NOD_LNK_DIV_CD = 'N' AND MTY_YD_FLG = 'N'
	) EST_ARR_DATE,
	LTRIM (TO_CHAR (TRUNC (TTL_TZTM_HRS / 24, 0), '00'))  TRANSIT_DAY,
	TTL_EXPN_AMT,
	PCTL_NO,MTY_PKUP_YD_CD,
	( 
    	SELECT 
    	TO_CHAR(min(ARR_ST_DT), 'YYYY-MM-DD')
    	FROM PRD_PROD_CTL_ROUT_DTL 
    	WHERE  PCTL_NO = d.PCTL_NO
    	AND TRSP_MOD_CD IN ('WD','VD') 
    	AND PCTL_IO_BND_CD = 'T' 
    ) LOAD_DT , 
	(SELECT 'Y' chk FROM PRD_OCN_ROUT O ,
             (
                 SELECT B0.ROUT_ORG_NOD_CD, B0.ROUT_DEST_NOD_CD, B0.ROUT_SEQ
                 FROM (SELECT D.ROUT_ORG_NOD_CD, D.ROUT_DEST_NOD_CD, D.ROUT_SEQ, M.TTL_EXPN_AMT
        			 FROM PRD_PROD_CTL_ROUT_DTL D,PRD_PROD_CTL_MST M
        			 WHERE M.PCTL_NO = @[pctl_no]
        				 AND 'DEHAM' IN (M.N1ST_TS_PORT_CD, M.N2ND_TS_PORT_CD, M.N3RD_TS_PORT_CD)
        				 AND M.PCTL_NO = D.PCTL_NO
        				 AND D.PCTL_IO_BND_CD ='T'
        		 ) B0,
        		 (SELECT M.TTL_EXPN_AMT
        			 FROM PRD_PROD_CTL_ROUT_DTL D,PRD_PROD_CTL_MST M
        			 WHERE M.PCTL_NO LIKE SUBSTR(@[pctl_no],1,16)||'%'
        				 AND 'NLRTM' IN (M.N1ST_TS_PORT_CD, M.N2ND_TS_PORT_CD, M.N3RD_TS_PORT_CD)
        				 AND M.PCTL_NO = D.PCTL_NO
        				 AND D.PCTL_IO_BND_CD ='T'
        		 ) B1   		
        		 WHERE B0.TTL_EXPN_AMT > B1.TTL_EXPN_AMT
    		     AND ROWNUM = 1
    		 ) B
	WHERE 1=1
	AND O.ORG_LOC_CD = B.ROUT_ORG_NOD_CD
	AND O.DEST_LOC_CD = B.ROUT_DEST_NOD_CD
	AND O.ROUT_SEQ <> B.ROUT_SEQ
	AND O.UPD_IND_CD  in ( 'S','T','A','V','G')
	AND 'NLRTM' NOT IN (O.ORG_LOC_CD, O.DEST_LOC_CD)
	AND 'NLRTM' IN (O.N1ST_POD_CD, O.N2ND_POD_CD, O.N3RD_POD_CD)
	AND NVL(O.N1ST_LANE_CD, 'X') <> 'CME'
	AND CASE
			when N4TH_POD_CD is not null then N4TH_POD_CD
			when N3RD_POD_CD is not null then N3RD_POD_CD
			when N2ND_POD_CD is not null then N2ND_POD_CD
		END NOT LIKE 'NO%'
	AND CASE
			when N4TH_POD_CD is not null then N4TH_POD_CD
			when N3RD_POD_CD is not null then N3RD_POD_CD
			when N2ND_POD_CD is not null then N2ND_POD_CD
		END NOT LIKE 'FI%'
	AND CASE
			when N4TH_POD_CD is not null then N4TH_POD_CD
			when N3RD_POD_CD is not null then N3RD_POD_CD
			when N2ND_POD_CD is not null then N2ND_POD_CD
		END NOT LIKE 'PL%'
	AND CASE
			when N4TH_POD_CD is not null then N4TH_POD_CD
			when N3RD_POD_CD is not null then N3RD_POD_CD
			when N2ND_POD_CD is not null then N2ND_POD_CD
		END NOT IN ('DKAAR', 'DKCPH', 'EETLL', 'LTKLJ', 'RULED'
					, 'SEGOT', 'SEHEL', 'SEGVX', 'SEMMA', 'SENRK'
					, 'SESTO', 'SESDJ')
	AND rownum = 1) HAM_RTM
FROM PRD_PROD_CTL_MST D
WHERE PCTL_NO = @[pctl_no]
ORDER BY PCTL_NO			]]></sql>
			<params>
				<param name="pctl_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
