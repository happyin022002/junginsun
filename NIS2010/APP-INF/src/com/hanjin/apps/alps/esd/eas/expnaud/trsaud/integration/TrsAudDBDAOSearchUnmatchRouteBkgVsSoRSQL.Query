<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TrsAudDBDAOSearchUnmatchRouteBkgVsSoRSQL">
			<desc><![CDATA[Un-Match Route Between BKG vs. S/O 조회]]></desc>
			<sql><![CDATA[
SELECT SLAN_CD
     , VVD
     , BKG_NO
     , EQ_NO
     , EQ_TPSZ_CD
     , TRSP_BND_CD
     , BKG_RCVDE_TERM_CD
     , TRO_FLG
     , POR_NOD_CD
     , POL_NOD_CD
     , POD_NOD_CD
     , DEL_NOD_CD
     , SUBSTR(BKG_SCG_INFO, 1, INSTR(BKG_SCG_INFO, '^', 1, 1) - 1) AS BKG_CURR_CD
     , SUBSTR(BKG_SCG_INFO, INSTR(BKG_SCG_INFO, '^', 1, 1) + 1, INSTR(BKG_SCG_INFO, '^', 1, 2) - INSTR(BKG_SCG_INFO, '^', 1, 1) - 1) AS BKG_SCG_AMT
     , SUBSTR(BKG_SCG_INFO, INSTR(BKG_SCG_INFO, '^', 1, 2) + 1, INSTR(BKG_SCG_INFO, '^', 1, 3) - INSTR(BKG_SCG_INFO, '^', 1, 2) - 1) AS BKG_SCG_USD_AMT
     , FM_NOD_CD
     , VIA_NOD_CD
     , TO_NOD_CD
     , DOR_NOD_CD
     , TRSP_CRR_MOD_CD
	 , TRSP_COST_DTL_MOD_CD
     , SO_NO
     , WO_NO
     , WO_VNDR_SEQ
     , INV_NO
     , INV_VNDR_SEQ
     , CURR_CD
     , WO_AMT
     , INV_CURR_CD
     , INV_AMT
     , INV_USD_AMT
     , SO_USR_NM
     , INV_USR_NM
	 , TRSP_PURP_RSN
     , INTER_RMK
	 , CNG_RSN_DESC
     , SPCL_INSTR_RMK
     , EAC_IF_FLG
     , TRSP_SO_OFC_CTY_CD
     , TRSP_SO_SEQ     
  FROM (
        SELECT B.SLAN_CD
             , B.VSL_CD||B.SKD_VOY_NO||B.SKD_DIR_CD AS VVD
             , B.BKG_NO
             , A.EQ_NO
             , A.EQ_TPSZ_CD
             , A.TRSP_BND_CD
             , A.BKG_RCVDE_TERM_CD
             , (CASE WHEN A.TRO_SEQ IS NOT NULL THEN 'Y' ELSE '' END) TRO_FLG
             , B.POR_NOD_CD
             , B.POL_NOD_CD
             , B.POD_NOD_CD
             , B.DEL_NOD_CD
             , EAS_EXPN_AUD_PKG.GET_BKG_SCG_FNC(B.BKG_NO, A.TRSP_BND_CD, A.EQ_TPSZ_CD, TO_CHAR(B.POD_ETA_DT, 'YYYYMM')) BKG_SCG_INFO
             , A.FM_NOD_CD
             , A.VIA_NOD_CD
             , A.TO_NOD_CD
             , A.DOR_NOD_CD
             , A.TRSP_CRR_MOD_CD
			 , A.TRSP_COST_DTL_MOD_CD
             , A.TRSP_SO_OFC_CTY_CD||A.TRSP_SO_SEQ AS SO_NO
             , A.TRSP_WO_OFC_CTY_CD||A.TRSP_WO_SEQ AS WO_NO
             , A.VNDR_SEQ AS WO_VNDR_SEQ
             , A.INV_NO
             , A.INV_VNDR_SEQ
             , A.CURR_CD
             , A.BZC_AMT + NVL(A.NEGO_AMT,0) + NVL(A.ETC_ADD_AMT,0) + NVL(A.FUEL_SCG_AMT,0) + NVL(A.HJL_HNDL_AMT,0) + NVL(A.TOLL_FEE_AMT,0) AS WO_AMT     
             , A.INV_CURR_CD
             , A.INV_BZC_AMT + NVL(A.INV_ETC_ADD_AMT,0) AS INV_AMT
             , ROUND ((A.INV_BZC_AMT + NVL(A.INV_ETC_ADD_AMT,0)) / 
                     CASE WHEN NVL(A.INV_CURR_CD,'USD') = 'USD' THEN 1
                           ELSE (SELECT USD_LOCL_XCH_RT
                                   FROM GL_MON_XCH_RT XCH
                                  WHERE XCH.ACCT_XCH_RT_LVL = 1 
                                    AND XCH.CURR_CD           = A.INV_CURR_CD
                                    AND XCH.ACCT_XCH_RT_YRMON = TO_CHAR(C.LOCL_CRE_DT, 'YYYYMM') )
                     END
               , 2) INV_USD_AMT
             , (SELECT X.USR_NM FROM COM_USER X WHERE X.USR_ID = A.CRE_USR_ID) AS SO_USR_NM
             , (SELECT X.USR_NM FROM COM_USER X WHERE X.USR_ID = C.CRE_USR_ID) AS INV_USR_NM
			 , REPLACE(REPLACE(DECODE(A.TRSP_SO_TP_CD, 'S', A.SPL_ISS_RSN, A.TRSP_PURP_RSN), CHR(13)||CHR(10), ' '), chr(34), '') TRSP_PURP_RSN
             , A.INTER_RMK
		     , REPLACE(REPLACE(A.CNG_RSN_DESC, CHR(13)||CHR(10), ' '), chr(34), '') CNG_RSN_DESC
             , A.SPCL_INSTR_RMK             
             , A.TRSP_SO_OFC_CTY_CD
             , A.TRSP_SO_SEQ
             , (SELECT 'Y'
                  FROM EAS_TRSP_COST_CHK X
                 WHERE X.TRSP_SO_OFC_CTY_CD = A.TRSP_SO_OFC_CTY_CD
                   AND X.TRSP_SO_SEQ        = A.TRSP_SO_SEQ
                   AND X.EAC_SYS_IF_CD      = 'TR3'
                   AND X.LGS_COST_CD        = 'XXXXXX'
               ) EAC_IF_FLG
          FROM TRS_TRSP_SVC_ORD A
             , BKG_BOOKING      B
             , TRS_TRSP_INV_WRK C
         WHERE 1=1
           AND A.BKG_NO = B.BKG_NO
           AND A.INV_NO = C.INV_NO(+)
           AND A.INV_VNDR_SEQ = C.INV_VNDR_SEQ(+)
           AND A.TRSP_SO_TP_CD = 'Y'
           AND A.RPLN_UMCH_FLG = 'Y'
           AND A.TRSP_SO_STS_CD = 'I'
           AND A.DELT_FLG      = 'N'
           AND A.CRE_OFC_CD IN (SELECT OFC_CD
                                      FROM MDM_ORGANIZATION
                                     WHERE DELT_FLG = 'N'
                                   CONNECT BY NOCYCLE PRIOR OFC_CD = PRNT_OFC_CD
                                     START WITH OFC_CD = @[s_rhq_ofc_cd]
                               )
           #if (${s_ofc_cd} != '')
                AND A.CRE_OFC_CD = @[s_ofc_cd]
           #end

           AND A.LOCL_CRE_DT BETWEEN TO_DATE(REPLACE(@[s_fm_dt],'-',''), 'YYYYMMDD') AND TO_DATE(REPLACE(@[s_to_dt],'-',''), 'YYYYMMDD') + 0.999999
           
           #if (${s_bnd_cd} != '')
                AND A.TRSP_BND_CD = @[s_bnd_cd]
				#if (${s_bnd_cd} == 'I' && ${s_rcv_trm} != '')
					AND A.BKG_RCVDE_TERM_CD = @[s_rcv_trm]
				#elseif(${s_bnd_cd} == 'O' && ${s_dlvry_trm} != '' )
					AND A.BKG_RCVDE_TERM_CD = @[s_dlvry_trm]
				#end
           #end
           #if (${s_bkg_no} != '')
                AND A.BKG_NO = @[s_bkg_no]
           #end
           #if (${s_wo_sts_cd} == 'WI')
                AND A.TRSP_SO_STS_CD = 'I'
                AND A.INV_NO IS NULL
           #end
           #if (${s_wo_sts_cd} == 'SV' || ${s_wo_sts_cd} == 'CF' || ${s_wo_sts_cd} == 'RA' || ${s_wo_sts_cd} == 'IF' || ${s_wo_sts_cd} == 'PD')
                AND C.TRSP_INV_AUD_STS_CD = @[s_wo_sts_cd]
           #end
           #if (${s_cst_cd} != '')
                AND A.TRSP_COST_DTL_MOD_CD = @[s_cst_cd]
           #end

       ) AA
 WHERE  1=1
        #if (${s_xcld_oft_incl} == 'Y')
            AND BKG_SCG_INFO IS NOT NULL
        #end
        #if (${s_eac_if} != '')
            #if (${s_eac_if} == 'Y')
               AND EAC_IF_FLG = @[s_eac_if]
            #else
               AND EAC_IF_FLG IS NULL
            #end
        #end			]]></sql>
			<params>
				<param name="s_rhq_ofc_cd" type="12" value="" out="N"/>
				<param name="s_ofc_cd" type="12" value="" out="N"/>
				<param name="s_fm_dt" type="12" value="" out="N"/>
				<param name="s_to_dt" type="12" value="" out="N"/>
				<param name="s_bnd_cd" type="12" value="" out="N"/>
				<param name="s_rcv_trm" type="12" value="" out="N"/>
				<param name="s_dlvry_trm" type="12" value="" out="N"/>
				<param name="s_bkg_no" type="12" value="" out="N"/>
				<param name="s_wo_sts_cd" type="12" value="" out="N"/>
				<param name="s_cst_cd" type="12" value="" out="N"/>
				<param name="s_eac_if" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
