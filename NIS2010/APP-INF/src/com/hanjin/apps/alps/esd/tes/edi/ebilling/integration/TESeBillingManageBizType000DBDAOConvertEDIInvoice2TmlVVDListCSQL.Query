<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TESeBillingManageBizType000DBDAOConvertEDIInvoice2TmlVVDListCSQL">
			<desc><![CDATA[정규INVIOCE의 VVD로 변환]]></desc>
			<sql><![CDATA[
INSERT INTO TES_TML_SO_VVD_LIST(
        	TML_SO_OFC_CTY_CD
        	, TML_SO_SEQ
        	, TML_SO_VVD_LIST_SEQ
        	, VSL_CD
        	, SKD_VOY_NO
        	, SKD_DIR_CD
        	, IO_BND_CD
        	, ATB_DT
        	, CRE_USR_ID
        	, CRE_DT
        	, UPD_USR_ID
        	, UPD_DT
        	, LOCL_CRE_DT
        	, LOCL_UPD_DT
)
SELECT  @[tml_edi_so_ofc_cty_cd]
		, @[tml_so_seq]
		, ROWNUM
		, VSL_CD
		, SKD_VOY_NO
		, SKD_DIR_CD
		, IO_BND_CD
		, ATB_DT
		, @[cre_usr_id]
		, SYSDATE
		, @[cre_usr_id]
		, SYSDATE
		, GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC(INV_OFC_CD)
		, GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC(INV_OFC_CD)
FROM	(
SELECT  A.VSL_CD VSL_CD
        , A.SKD_VOY_NO SKD_VOY_NO
        , A.SKD_DIR_CD SKD_DIR_CD
        , A.IO_BND_CD IO_BND_CD
        , MAX(V.VPS_ETB_DT) ATB_DT
        , A.VNDR_SEQ
        , A.INV_OFC_CD
FROM    VSK_VSL_PORT_SKD V,
        (SELECT H.TML_INV_TP_CD
		, H.YD_CD
		, H.VNDR_SEQ
		, H.INV_OFC_CD
		, D.VSL_CD
		, D.SKD_VOY_NO
		, D.SKD_DIR_CD
		, D.IO_BND_CD
        FROM	TES_EDI_SO_HDR H, TES_EDI_SO_DTL D
        WHERE 1=1
        AND H.TML_EDI_SO_OFC_CTY_CD = D.TML_EDI_SO_OFC_CTY_CD
        AND H.TML_EDI_SO_SEQ = D.TML_EDI_SO_SEQ
        AND H.TML_EDI_SO_OFC_CTY_CD = @[tml_edi_so_ofc_cty_cd]
        AND H.TML_EDI_SO_SEQ = @[tml_edi_so_seq]
        AND NVL(H.DELT_FLG,'N') <> 'Y'
        AND H.TML_INV_TP_CD IN ('TM')
        AND D.VSL_CD IS NOT NULL AND D.VSL_CD <> 'CNTC'
        UNION
        SELECT H.TML_INV_TP_CD
		, H.YD_CD
		, H.VNDR_SEQ
		, H.INV_OFC_CD
		, D.VSL_CD
		, D.SKD_VOY_NO
		, D.SKD_DIR_CD
		, D.IO_BND_CD
        FROM TES_EDI_SO_HDR H, TES_EDI_SO_CNTR_LIST D
        WHERE 1=1
        AND H.TML_EDI_SO_OFC_CTY_CD = D.TML_EDI_SO_OFC_CTY_CD
        AND H.TML_EDI_SO_SEQ = D.TML_EDI_SO_SEQ
        AND H.TML_EDI_SO_OFC_CTY_CD = @[tml_edi_so_ofc_cty_cd]
        AND H.TML_EDI_SO_SEQ = @[tml_edi_so_seq]
        AND NVL(H.DELT_FLG,'N') <> 'Y'
        AND H.TML_INV_TP_CD IN ('TM')
        AND D.VSL_CD IS NOT NULL AND D.VSL_CD <> 'CNTC'
        )  A
WHERE 1=1
AND V.VPS_PORT_CD = SUBSTR(A.YD_CD,1,5)
AND V.VSL_CD <> 'CNTC'
AND V.VSL_CD = A.VSL_CD
AND V.SKD_VOY_NO = A.SKD_VOY_NO
AND V.SKD_DIR_CD = A.SKD_DIR_CD
GROUP BY A.VSL_CD
    , A.SKD_VOY_NO
    , A.SKD_DIR_CD
    , A.IO_BND_CD
    , A.VNDR_SEQ
    , A.INV_OFC_CD
UNION ALL
SELECT  A.VSL_CD VSL_CD
    , A.SKD_VOY_NO SKD_VOY_NO
    , A.SKD_DIR_CD SKD_DIR_CD
    , A.IO_BND_CD IO_BND_CD
    , LAST_DAY(TO_DATE(A.SKD_VOY_NO,'YYMM')) ATB_DT
    , A.VNDR_SEQ
    , A.INV_OFC_CD
FROM (SELECT H.TML_INV_TP_CD
        , H.YD_CD
        , H.VNDR_SEQ
        , H.INV_OFC_CD
        , D.VSL_CD
        , D.SKD_VOY_NO
        , D.SKD_DIR_CD
        , D.IO_BND_CD
    FROM TES_EDI_SO_HDR H, TES_EDI_SO_DTL D
    WHERE 1=1
    AND H.TML_EDI_SO_OFC_CTY_CD = D.TML_EDI_SO_OFC_CTY_CD
    AND H.TML_EDI_SO_SEQ = D.TML_EDI_SO_SEQ
    AND H.TML_EDI_SO_OFC_CTY_CD = @[tml_edi_so_ofc_cty_cd]
    AND H.TML_EDI_SO_SEQ = @[tml_edi_so_seq]
    AND NVL(H.DELT_FLG,'N') <> 'Y'
    AND H.TML_INV_TP_CD IN ('TM')
    AND D.VSL_CD IS NOT NULL AND D.VSL_CD = 'CNTC'
    UNION ALL
    SELECT H.TML_INV_TP_CD
        , H.YD_CD
        , H.VNDR_SEQ
        , H.INV_OFC_CD
        , D.VSL_CD
        , D.SKD_VOY_NO
        , D.SKD_DIR_CD
        , D.IO_BND_CD
    FROM TES_EDI_SO_HDR H, TES_EDI_SO_CNTR_LIST D
    WHERE 1=1
    AND H.TML_EDI_SO_OFC_CTY_CD	= D.TML_EDI_SO_OFC_CTY_CD
    AND H.TML_EDI_SO_SEQ			= D.TML_EDI_SO_SEQ
    AND H.TML_EDI_SO_OFC_CTY_CD = @[tml_edi_so_ofc_cty_cd]
    AND H.TML_EDI_SO_SEQ = @[tml_edi_so_seq]
    AND NVL(H.DELT_FLG,'N') <> 'Y'
    AND H.TML_INV_TP_CD IN ('TM')
    AND D.VSL_CD IS NOT NULL AND D.VSL_CD = 'CNTC') A
GROUP BY A.VSL_CD
	, A.SKD_VOY_NO
	, A.SKD_DIR_CD
	, A.IO_BND_CD
	, A.VNDR_SEQ
	, A.INV_OFC_CD
)			]]></sql>
			<params>
				<param name="tml_edi_so_ofc_cty_cd" type="12" value="" out="N"/>
				<param name="tml_so_seq" type="12" value="" out="N"/>
				<param name="cre_usr_id" type="12" value="" out="N"/>
				<param name="tml_edi_so_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
