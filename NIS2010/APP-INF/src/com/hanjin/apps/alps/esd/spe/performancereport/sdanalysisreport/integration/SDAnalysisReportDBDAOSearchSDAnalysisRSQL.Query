<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="SDAnalysisReportDBDAOSearchSDAnalysisRSQL">
			<desc><![CDATA[SD Analysis Report 데이터를 조회한다]]></desc>
			<sql><![CDATA[
SELECT B.EG_RHQ_CD
     , B.EG_OFC_CD
     , B.EV_SVC_CATE_CD
     , B.EG_ID
     , B.EG_NM
     , A.EV_YR
     , A.SP_SEQ
     , (SELECT VNDR_LGL_ENG_NM FROM MDM_VENDOR WHERE VNDR_SEQ = A.SP_SEQ) AS SP_NAME
     , PA_POINT
     , CASE WHEN PA_POINT< 80 THEN 'Poor'
            WHEN PA_POINT >= 80 AND PA_POINT<95   THEN 'Good' 
            WHEN PA_POINT >= 95 THEN 'Excellent' 
            ELSE '' END AS PA_GROUP
      , C.BZC_EV_GRD_CD
      , E.BZC_EV_GRD_NM AS BE_GROUP
      , E.BZC_EV_GRD_VAL AS BE_POINT
      , (SELECT INTG_CD_VAL_DP_DESC FROM COM_INTG_CD_DTL WHERE INTG_CD_ID ='CD03397'
            AND INTG_CD_VAL_CTNT=D.SP_DIFF_GRD_CD
         ) AS SD_GROUP
  FROM (SELECT EG_ID
             , SP_SEQ
             , EV_YR
             , SUM(PA_POINT) AS PA_POINT
         FROM (SELECT EG_ID
                    , SP_SEQ
                    , EV_YR
                    , ROUND(SUM(PA_POINT)/COUNT(1),2) AS PA_POINT
               FROM  (SELECT EG_ID
                           , SP_SEQ
                           , EV_YR
                           , SP_KPI_ID
                           , CASE WHEN KPI_WGT_RTO < ROUND((SUM(MON_SCORE)*KPI_WGT_RTO)/KPI_TGT_RTO,2) THEN KPI_WGT_RTO ELSE ROUND((SUM(MON_SCORE)*KPI_WGT_RTO)/KPI_TGT_RTO,2) END PA_POINT  
                        FROM (WITH PERF AS(SELECT A.EG_ID, A.SP_SEQ, A.EV_YR, A.SP_KPI_ID
                                                , CASE  WHEN C.SP_KPI_TP_CD != 'P' THEN B.KPI_TGT_RTO 
                                                        ELSE (SELECT ROUND(SUM(KPI_TGT_RTO)/COUNT(1),2) FROM SPE_EV_GRP_TML_PROD_TGT WHERE EG_ID = A.EG_ID AND SP_SEQ = A.SP_SEQ)
                                                  END AS KPI_TGT_RTO                 
                                                , B.KPI_WGT_RTO
                                                , JAN_RTO  
                                                , FEB_RTO  
                                                , MAR_RTO
                                                , APR_RTO 
                                                , MAY_RTO
                                                , JUN_RTO 
                                                , JUL_RTO  
                                                , AUG_RTO
                                                , SEP_RTO 
                                                , OCT_RTO
                                                , NOV_RTO
                                                , DEC_RTO 
                                             FROM SPE_EV_GRP_KPI_PERF A
                                                , SPE_EV_GRP_KPI_PERF_TGT B
                                                , SPE_SP_SVC_CATE_KPI C
                                            WHERE A.EG_ID = B.EG_ID
                                              AND A.SP_KPI_ID = B.SP_KPI_ID
                                              AND A.EV_YR = B.EV_YR
                                              AND A.SP_KPI_ID = C.SP_KPI_ID   
                                              AND C.DELT_FLG = 'N'   
                                              AND A.EV_YR BETWEEN @[ev_from_yr] AND @[ev_to_yr]
                                              )
                                              SELECT PERF.EG_ID
                                                   , PERF.SP_SEQ
                                                   , PERF.EV_YR
                                                   , PERF.SP_KPI_ID
                                                   , PERF.KPI_WGT_RTO
                                                   , PERF.KPI_TGT_RTO
                                                   , NUM AS MON
                                                   , CASE WHEN NUM =1 THEN JAN_RTO
                                                          WHEN NUM =2 THEN FEB_RTO
                                                          WHEN NUM =3 THEN MAR_RTO
                                                          WHEN NUM =4 THEN APR_RTO
                                                          WHEN NUM =5 THEN MAY_RTO
                                                          WHEN NUM =6 THEN JUN_RTO
                                                          WHEN NUM =7 THEN JUL_RTO
                                                          WHEN NUM =8 THEN AUG_RTO
                                                          WHEN NUM =9 THEN SEP_RTO
                                                          WHEN NUM =10 THEN OCT_RTO
                                                          WHEN NUM =11 THEN NOV_RTO
                                                          WHEN NUM =12 THEN DEC_RTO                 
                                                      END MON_SCORE
                                                FROM PERF
                                                   , (SELECT LEVEL NUM FROM DUAL
                                                      CONNECT BY LEVEL <= 12 
                                                     )
                             )
                        WHERE MON BETWEEN @[ev_from_mon] AND @[ev_to_mon]
                          AND MON_SCORE <> 0
                        GROUP BY KPI_WGT_RTO,KPI_TGT_RTO, EG_ID, SP_SEQ, EV_YR,SP_KPI_ID,MON
                     )
                     GROUP BY EG_ID, SP_SEQ, EV_YR, SP_KPI_ID                 
              )
              GROUP BY EG_ID, SP_SEQ, EV_YR
      ) A
     , SPE_EV_GRP B
     , SPE_SP_BZC_EV_GRP C
     , SPE_SP_DIFF_GRD D
     , SPE_BZC_EV_GRD E
 WHERE A.EG_ID = B.EG_ID
   AND A.EG_ID = C.EG_ID
   AND A.SP_SEQ = C.SP_SEQ
   AND A.EV_YR = C.EV_YR
   AND C.BZC_EV_GRD_CD = D.BZC_EV_GRD_CD 
   AND A.PA_POINT BETWEEN D.FM_SCRE_RTO AND D.TO_SCRE_RTO   
   AND C.BZC_EV_GRD_CD = E.BZC_EV_GRD_CD(+)
 #if(${s_eg_rhq_cd}!='')
   AND B.EG_RHQ_CD = @[s_eg_rhq_cd]
#end
#if(${s_eg_ofc_cd}!='')
   AND B.EG_OFC_CD = @[s_eg_ofc_cd]
#end
#if(${s_ev_svc_cate_cd}!='')
   AND B.EV_SVC_CATE_CD = @[s_ev_svc_cate_cd]
#end
#if(${s_sp_seq}!='')
   AND A.SP_SEQ = @[s_sp_seq]
#end
#if(${s_sd_gp}!='')
   AND D.SP_DIFF_GRD_CD = @[s_sd_gp]
#end
 
 
ORDER BY A.SP_SEQ, A.EV_YR, B.EG_ID, B.EG_RHQ_CD, B.EG_OFC_CD, B.EV_SVC_CATE_CD			]]></sql>
			<params>
				<param name="ev_from_yr" type="12" value="" out="N"/>
				<param name="ev_to_yr" type="12" value="" out="N"/>
				<param name="ev_from_mon" type="12" value="" out="N"/>
				<param name="ev_to_mon" type="12" value="" out="N"/>
				<param name="s_eg_rhq_cd" type="12" value="" out="N"/>
				<param name="s_eg_ofc_cd" type="12" value="" out="N"/>
				<param name="s_ev_svc_cate_cd" type="12" value="" out="N"/>
				<param name="s_sp_seq" type="12" value="" out="N"/>
				<param name="s_sd_gp" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
