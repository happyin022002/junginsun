<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="MnrAudDBDAOSearchHbarInquiryByBkgRSQL">
			<desc><![CDATA[H/Bar Inquiry by BKG 조회]]></desc>
			<sql><![CDATA[
SELECT CNTR_NO
      ,CNTR_TPSZ_CD
      ,BKG_NO
      ,POL_DT
      ,VVD
      ,SLAN_CD
      ,POR_YD_CD
      ,POL_YD_CD
      ,BKG_OFC_CD
      ,HNGR_FLG
      ,CRR_HNGR_SGL_BAR_QTY
      ,CRR_HNGR_DBL_BAR_QTY
      ,CRR_HNGR_TPL_BAR_QTY
      ,CRR_HNGR_QTY
      ,MER_HNGR_QTY
      ,BKG_GET_TOKEN_FNC(BKG_SCG_INFO,1) AS BKG_SCG_CUR_CD
      ,BKG_GET_TOKEN_FNC(BKG_SCG_INFO,2) AS BKG_SCG_AMT
      ,(CASE WHEN LENGTH(BKG_GET_TOKEN_FNC(BKG_SCG_INFO,3)) > 1 THEN 'Y' END) AS BKG_SCG_MIX_FLG
      ,BKG_GET_TOKEN_FNC(MNR_HGR_INFO,1) AS MNR_FLG_INP_DT
      ,BKG_GET_TOKEN_FNC(MNR_HGR_INFO,2) AS MNR_WO_NO
      ,BKG_GET_TOKEN_FNC(MNR_HGR_INFO,3) AS MNR_BAR_QTY
      ,BKG_GET_TOKEN_FNC(MNR_HGR_INFO,4) AS MNR_FLG_RMK
      ,EAC_IF_FLG
  FROM (
        SELECT D.CNTR_NO
              ,D.CNTR_TPSZ_CD
              ,B.BKG_NO
              ,TO_CHAR(C.VPS_ETD_DT, 'YYYY-MM-DD HH24:MI:SS') AS POL_DT
              ,B.VSL_CD||B.SKD_VOY_NO||B.SKD_DIR_CD AS VVD
              ,A.SLAN_CD
              ,B.POR_NOD_CD AS POR_YD_CD
              ,A.POL_YD_CD
              ,B.BKG_OFC_CD
              ,D.HNGR_FLG
              ,E.CRR_HNGR_SGL_BAR_QTY
              ,E.CRR_HNGR_DBL_BAR_QTY
              ,E.CRR_HNGR_TPL_BAR_QTY 
              ,E.CRR_HNGR_QTY
              ,E.MER_HNGR_QTY
              ,(SELECT WM_CONCAT(CURR_CD||','||CHG_UT_AMT)
                  FROM BKG_CHG_RT X
                 WHERE X.BKG_NO = B.BKG_NO
                   AND X.CHG_CD = 'GOH'
                   AND ((X.RAT_UT_CD = D.CNTR_TPSZ_CD) OR (CASE WHEN SUBSTR(D.CNTR_TPSZ_CD, 2,1) IN ('2', '3') THEN '20'
                                                                WHEN SUBSTR(D.CNTR_TPSZ_CD, 2,1) IN ('4', '5') THEN '40'
                                                                WHEN SUBSTR(D.CNTR_TPSZ_CD, 2,1) IN ('6', '7') THEN '45'
                                                           END
                                                          ) = X.RAT_UT_CD
                                                       OR (X.RAT_UT_CD = 'BX')
                       )
               ) BKG_SCG_INFO
              ,(SELECT /*+ INDEX_DESC(X XPKMNR_FLG_HIS) */
                       TO_CHAR(X.MNR_FLG_INP_DT, 'YYYY-MM-DD HH24:MI:SS')  ||','||
                       X.MNR_ORD_OFC_CTY_CD||X.MNR_ORD_SEQ ||','||
                       NVL(X.HNGR_BAR_AMD_QTY, 0) ||','||
                       X.MNR_FLG_RMK
                  FROM MNR_FLG_HIS X
                 WHERE X.EQ_NO = D.CNTR_NO
                   AND MNR_FLG_TP_CD = 'HGR'
                   AND MNR_STS_FLG   = 'Y'
                   AND SUBSTR(X.MNR_FLG_YD_CD, 1, 5) = SUBSTR(A.POL_YD_CD, 1, 5)
                   AND MNR_FLG_INP_DT BETWEEN C.VPS_ETD_DT - 15 AND C.VPS_ETD_DT + 15
                   AND ROWNUM = 1
               ) MNR_HGR_INFO
              ,(SELECT 'Y'
                  FROM EAS_BKG_CNTR_CHG_CHK EE
                 WHERE 1 = 1
                   AND EE.BKG_NO  = B.BKG_NO
                   AND EE.CNTR_NO = D.CNTR_NO
                   AND EE.EAC_SYS_IF_CD = 'MR1' ) EAC_IF_FLG
          FROM BKG_VVD A
              ,BKG_BOOKING B
              ,VSK_VSL_PORT_SKD C
              ,BKG_CONTAINER D
              ,BKG_QUANTITY  E
         WHERE 1=1
           AND A.BKG_NO     = B.BKG_NO
           AND A.POL_YD_CD  = B.POL_NOD_CD
           AND A.VSL_CD     = C.VSL_CD
           AND A.SKD_VOY_NO = C.SKD_VOY_NO
           AND A.SKD_DIR_CD = C.SKD_DIR_CD
           AND A.POL_CD     = C.VPS_PORT_CD
           AND A.POL_CLPT_IND_SEQ = C.CLPT_IND_SEQ   
           AND A.POL_YD_CD  = C.YD_CD
           AND A.BKG_NO     = D.BKG_NO
           AND D.BKG_NO     = E.BKG_NO
           AND D.CNTR_TPSZ_CD = E.CNTR_TPSZ_CD
           AND B.HNGR_FLG = 'Y'
           AND D.HNGR_FLG = 'Y'
           AND B.BKG_STS_CD <> 'X'
           AND C.VPS_PORT_CD = @[s_pol_loc_cd]
           AND C.YD_CD LIKE @[s_pol_loc_cd]||@[s_pol_yd_cd]||'%'
           #if (${s_fm_dt} != ''|| ${s_to_dt} != '')
           AND C.VPS_ETD_DT BETWEEN TO_DATE(REPLACE(@[s_fm_dt],'-',''), 'YYYYMMDD') AND TO_DATE(REPLACE(@[s_to_dt],'-',''), 'YYYYMMDD') + 0.99999
           #end
           #if (${s_vvd} != '')
                AND (B.VSL_CD, B.SKD_VOY_NO, B.SKD_DIR_CD) IN ( (SUBSTR(@[s_vvd],1,4), SUBSTR(@[s_vvd], 5,4), SUBSTR(@[s_vvd], 9,1)) )
           #end
           #if($s_bkg_no.size() > 0) 
                AND B.BKG_NO IN (
                    #foreach( ${key} in ${s_bkg_no}) 
                        #if($velocityCount == 1) 
                            '$key'
                        #else 
                            , '$key'
                        #end 
                    #end
                )
           #end
           #if (${s_cntr_tpsz_cd} != '') 
                AND D.CNTR_TPSZ_CD = @[s_cntr_tpsz_cd]
           #end
           #if($s_cntr_no.size() > 0) 
                AND D.CNTR_NO IN (
                    #foreach( ${key} in ${s_cntr_no}) 
                        #if($velocityCount == 1) 
                            '$key'
                        #else 
                            , '$key'
                        #end 
                    #end
                )
           #end
       ) AA
 WHERE  1=1
		#if ( ${s_bkg_chg_flg} == 'Y' )
        	AND BKG_GET_TOKEN_FNC(BKG_SCG_INFO,1) IS NOT NULL
		#elseif ( ${s_bkg_chg_flg} == 'N' )
			AND BKG_GET_TOKEN_FNC(BKG_SCG_INFO,1) IS NULL
		#end

		#if (${s_eac_if} != '')
     		#if (${s_eac_if} == 'Y')
         		AND EAC_IF_FLG IS NOT NULL
      		#else
         		AND EAC_IF_FLG IS NULL
      		#end
   		#end			]]></sql>
			<params>
				<param name="s_pol_loc_cd" type="12" value="" out="N"/>
				<param name="s_pol_yd_cd" type="12" value="" out="N"/>
				<param name="s_fm_dt" type="12" value="" out="N"/>
				<param name="s_to_dt" type="12" value="" out="N"/>
				<param name="s_vvd" type="12" value="" out="N"/>
				<param name="s_cntr_tpsz_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
