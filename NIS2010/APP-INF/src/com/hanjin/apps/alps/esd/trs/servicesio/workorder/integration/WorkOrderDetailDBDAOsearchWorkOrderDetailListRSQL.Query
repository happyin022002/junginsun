<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="WorkOrderDetailDBDAOsearchWorkOrderDetailListRSQL">
			<desc><![CDATA[Work Order Detail 정보 조회.]]></desc>
			<sql><![CDATA[
WITH s_dvsn as (
SELECT dvsn
  FROM
	(SELECT '1' dvsn
	  FROM
	    trs_trsp_wrk_ord wo,
	    trs_trsp_wrk_ord_rjct_his hs
	   WHERE 1 = 1
	     AND wo.trsp_wo_ofc_cty_cd = hs.trsp_wo_ofc_cty_cd
	     AND wo.trsp_wo_seq = hs.trsp_wo_seq
	     AND ((@[vndr_dvsn] = 'S' and wo.wo_vndr_seq IN ( SELECT vndr_seq
	                                FROM mdm_vendor
	                               WHERE prnt_vndr_seq = (SELECT prnt_vndr_seq
	                                                         FROM mdm_vendor
	                                                         WHERE 1=1
	                                                        AND vndr_seq = @[vndr_seq]
	                                                      )
	                           )
             ) OR @[vndr_dvsn] = 'M')
	     AND (wo.trsp_wo_ofc_cty_cd,wo.trsp_wo_seq) = ((@[trsp_wo_ofc_cty_cd],@[trsp_wo_seq]))
	union all 
	SELECT '2' from dual)
WHERE rownum < 2
)
SELECT
     eq_no
    ,trsp_wo_ofc_cty_cd||trsp_wo_seq trsp_wo_no
    ,trsp_so_ofc_cty_cd||trsp_so_seq trsp_so_no
    ,validity
    ,invoiced
    ,trsp_so_sts_cd
    ,eq_tpsz_cd
    ,eq_tpsz_nm
    ,iso_cd
    ,iso_nm
    ,apnt_dt
    ,de_dt
    ,wo_rjct_rsn
    ,bkg_no
    ,org_bkg_no
	,dor_nod_cd
	,trsp_bnd_cd
	,dor_pkup_cntr_no	-- pickup container
	,wo_amt
	,wo_cre_dt
	,to_char((SELECT GLOBALDATE_PKG.TIME_CONV_FNC('KRPUS', TO_DATE(cop_cre_dt, 'YYYYMMDDHH24MISS'), SUBSTR(dor_nod_cd, 1, 5))
        		FROM DUAL), 'YYYY-MM-DD HH24:MI') locl_cop_cre_dt
    ,cnmv_vdsts_dt
    ,spot_bid_no
FROM
(
    SELECT
         DISTINCT so.eq_no
        ,wo.trsp_wo_ofc_cty_cd
        ,wo.trsp_wo_seq
        ,so.trsp_so_ofc_cty_cd
        ,so.trsp_so_seq
        ,DECODE(NVL(so.trsp_inv_act_sts_cd,'N'), 'N','Normal','Invoiced') validity
        ,NVL(so.trsp_inv_act_sts_cd,'N') invoiced
        ,so.trsp_so_sts_cd
        ,so.eq_tpsz_cd
        ,(SELECT cntr_tpsz_rmk FROM mdm_cntr_tp_sz WHERE cntr_tpsz_cd = so.eq_tpsz_cd)        eq_tpsz_nm
        ,(SELECT cntr_tpsz_iso_cd FROM mdm_cntr_tp_sz WHERE cntr_tpsz_cd = so.eq_tpsz_cd)	  iso_cd
        ,(SELECT iso_cntr_tpsz_nm
    	   FROM mst_iso_cntr_tp_sz
    	  WHERE iso_cntr_tpsz_cd = (SELECT cntr_tpsz_iso_cd
    	                               FROM mdm_cntr_tp_sz
    	                             WHERE cntr_tpsz_cd = so.eq_tpsz_cd)) iso_nm
        ,to_char(so.apnt_dt, 'YYYY-MM-DD HH24:MI') apnt_dt
    	,to_char(so.de_dt, 'YYYY-MM-DD HH24:MI') de_dt
    	,'' wo_rjct_rsn
    	,so.bkg_no
    	,so.org_bkg_no
    	,so.dor_nod_cd
    	,so.trsp_bnd_cd
		,so.cop_no					-- for join SCE_COP_DTL and SCE_COP_HDR
		,so.dor_pkup_cntr_no		-- pickup container no
    	,nvl(so.bzc_amt,0)+nvl(so.nego_amt,0)+nvl(so.fuel_scg_amt,0)+nvl(so.ovr_wgt_scg_amt,0)+nvl(so.etc_add_amt,0)+nvl(so.toll_fee_amt,0) as wo_amt
		,to_char(wo.cre_dt,'YYYY-MM-DD HH24:MI') wo_cre_dt
		,(SELECT to_char(cre_dt, 'YYYYMMDDHH24MISS')
        	FROM sce_cop_hdr
           WHERE cop_no = so.cop_no ) cop_cre_dt
		,(SELECT max(to_char(CTM.CNMV_EVNT_DT, 'YYYYMMDDHH24MI')) CNMV_EVNT_DT
            FROM BKG_CONTAINER BCN ,
              CTM_MOVEMENT CTM
            WHERE 1=1
              AND BCN.BKG_NO = CTM.BKG_NO
              AND BCN.CNTR_NO = CTM.CNTR_NO
              AND CTM.CNMV_CYC_NO = BCN.CNMV_CYC_NO
              AND CTM.BKG_NO = so.bkg_no
              AND CTM.CNTR_NO = so.eq_no
              AND CTM.MVMT_STS_CD = 'VD') cnmv_vdsts_dt
		,so.spot_bid_no
     FROM s_dvsn a
          ,trs_trsp_wrk_ord wo
          ,trs_trsp_svc_ord so
    WHERE '1' = a.dvsn
       AND ((@[vndr_dvsn] = 'S' and wo.wo_vndr_seq IN ( SELECT vndr_seq
	                                FROM mdm_vendor
	                               WHERE prnt_vndr_seq = (SELECT prnt_vndr_seq
	                                                         FROM mdm_vendor
	                                                         WHERE 1=1
	                                                        AND vndr_seq = @[vndr_seq]
	                                                      )
	                           )
             ) OR @[vndr_dvsn] = 'M')
       AND so.trsp_wo_ofc_cty_cd = wo.trsp_wo_ofc_cty_cd
       AND so.trsp_wo_seq = wo.trsp_wo_seq
       AND ( wo.trsp_wo_ofc_cty_cd, wo.trsp_wo_seq ) in ((@[trsp_wo_ofc_cty_cd],@[trsp_wo_seq]))
    UNION ALL
     SELECT
		'' eq_no
		,wo.trsp_wo_ofc_cty_cd
		,wo.trsp_wo_seq
		,'' trsp_so_ofc_cty_cd
		,TO_NUMBER('', trsp_so_seq)
		,'Rejected' validity
		,'' invoiced
		,'' trsp_so_sts_cd
		,'' eq_tpsz_cd
		,'' eq_tpsz_nm
		,'' iso_cd
        ,'' iso_nm
		,'' apnt_dt
		,'' de_dt
		,hs.wo_rjct_rsn
		,'' bkg_no
		,'' org_bkg_no
		,'' cop_no
		,'' dor_nod_cd
		,'' trsp_bnd_cd
		,'' dor_pkup_cntr_no     -- Pickup Container No
    	,0 as wo_amt
		,to_char(wo.cre_dt,'YYYY-MM-DD HH24:MI') wo_cre_dt
		,'' cop_cre_dt
        ,'' cnmv_vdsts_dt
		,'' spot_bid_no
  FROM s_dvsn a
       ,trs_trsp_wrk_ord wo
       ,trs_trsp_wrk_ord_rjct_his hs
 WHERE '1' = a.dvsn
   AND wo.delt_flg = 'N'
   AND wo.trsp_wo_ofc_cty_cd = hs.trsp_wo_ofc_cty_cd
   AND wo.trsp_wo_seq = hs.trsp_wo_seq
   AND ((@[vndr_dvsn] = 'S' and wo.wo_vndr_seq IN ( SELECT vndr_seq
	                                FROM mdm_vendor
	                               WHERE prnt_vndr_seq = (SELECT prnt_vndr_seq
	                                                         FROM mdm_vendor
	                                                         WHERE 1=1
	                                                        AND vndr_seq = @[vndr_seq]
	                                                      )
	                           )
        ) OR @[vndr_dvsn] = 'M')
   AND ( wo.trsp_wo_ofc_cty_cd, wo.trsp_wo_seq ) IN ((@[trsp_wo_ofc_cty_cd],@[trsp_wo_seq]))
) a
union all
SELECT  eq_no
 	   ,trsp_wo_no
 	   ,trsp_so_no
	   ,validity
 	   ,invoiced
 	   ,trsp_so_sts_cd
 	   ,eq_tpsz_cd
 	   ,eq_tpsz_nm
 	   ,iso_cd
 	   ,iso_nm
 	   ,apnt_dt
 	   ,de_dt
 	   ,wo_rjct_rsn
 	   ,bkg_no
 	   ,org_bkg_no
	   ,dor_nod_cd
	   ,trsp_bnd_cd
	   ,dor_pkup_cntr_no		-- pickup container no
	   ,wo_amt
	   ,wo_cre_dt
	   ,to_char((SELECT GLOBALDATE_PKG.TIME_CONV_FNC('KRPUS', TO_DATE(cop_cre_dt, 'YYYYMMDDHH24MISS'), SUBSTR(dor_nod_cd, 1, 5))
       			   FROM DUAL), 'YYYY-MM-DD HH24:MI') locl_cop_cre_dt
	   ,cnmv_vdsts_dt
	   ,spot_bid_no
 FROM (
 	SELECT
		DISTINCT so.eq_no
		,so.trsp_so_ofc_cty_cd ||so.trsp_so_seq    trsp_so_no
		,wo.trsp_wo_ofc_cty_cd ||wo.trsp_wo_seq 	  trsp_wo_no
		,DECODE(nvl(so.trsp_inv_act_sts_cd,'N'), 'N','Normal','Invoiced') validity
		,DECODE (so.trsp_inv_act_sts_cd, null,'N','Y') invoiced
		,so.trsp_so_sts_cd
		,so.eq_tpsz_cd
		,(SELECT cntr_tpsz_rmk FROM mdm_cntr_tp_sz WHERE cntr_tpsz_cd = so.eq_tpsz_cd)       eq_tpsz_nm
		,(SELECT cntr_tpsz_iso_cd FROM mdm_cntr_tp_sz WHERE cntr_tpsz_cd = so.eq_tpsz_cd)	iso_cd
		,(SELECT iso_cntr_tpsz_nm
	       FROM mst_iso_cntr_tp_sz
		 WHERE iso_cntr_tpsz_cd = (SELECT cntr_tpsz_iso_cd
			                          FROM mdm_cntr_tp_sz
			                       WHERE cntr_tpsz_cd = so.eq_tpsz_cd)) iso_nm
		,to_char(so.apnt_dt, 'YYYY-MM-DD HH24:MI') apnt_dt
		,to_char(so.de_dt, 'YYYY-MM-DD HH24:MI') de_dt
		,'' wo_rjct_rsn
		,so.bkg_no
		,so.org_bkg_no
		,so.dor_nod_cd
		,so.trsp_bnd_cd
		,so.cop_no			        -- for join SCE_COP_DTL and SCE_COP_HDR
		,so.dor_pkup_cntr_no        -- Pickup Container No
    	,nvl(so.bzc_amt,0)+nvl(so.nego_amt,0)+nvl(so.fuel_scg_amt,0)+nvl(so.ovr_wgt_scg_amt,0)+nvl(so.etc_add_amt,0)+nvl(so.toll_fee_amt,0) as wo_amt
	    ,to_char(wo.cre_dt,'YYYY-MM-DD HH24:MI') wo_cre_dt
		,(SELECT to_char(cre_dt, 'YYYYMMDDHH24MISS')
        	FROM sce_cop_hdr
           WHERE cop_no = so.cop_no ) cop_cre_dt
		,(SELECT max(to_char(CTM.CNMV_EVNT_DT, 'YYYYMMDDHH24MI')) CNMV_EVNT_DT
            FROM BKG_CONTAINER BCN ,
              CTM_MOVEMENT CTM
            WHERE 1=1
              AND BCN.BKG_NO = CTM.BKG_NO
              AND BCN.CNTR_NO = CTM.CNTR_NO
              AND CTM.CNMV_CYC_NO = BCN.CNMV_CYC_NO
              AND CTM.BKG_NO = so.bkg_no
              AND CTM.CNTR_NO = so.eq_no
              AND CTM.MVMT_STS_CD = 'VD') cnmv_vdsts_dt
		,so.spot_bid_no
	  FROM s_dvsn a
	  	   ,trs_trsp_svc_ord so
	  	   ,trs_trsp_wrk_ord wo
	 WHERE '2' = a.dvsn
	   AND so.trsp_wo_ofc_cty_cd = wo.trsp_wo_ofc_cty_cd
	   AND so.trsp_wo_seq = wo.trsp_wo_seq
	   AND wo.delt_flg = 'N'
       AND ((@[vndr_dvsn] = 'S' and wo.wo_vndr_seq IN ( SELECT vndr_seq
	                                FROM mdm_vendor
	                               WHERE prnt_vndr_seq = (SELECT prnt_vndr_seq
	                                                         FROM mdm_vendor
	                                                         WHERE 1=1
	                                                        AND vndr_seq = @[vndr_seq]
	                                                      )
	                           )
        ) OR @[vndr_dvsn] = 'M')
	   AND ( wo.trsp_wo_ofc_cty_cd, wo.trsp_wo_seq ) IN ((@[trsp_wo_ofc_cty_cd],@[trsp_wo_seq]))
 ) a
 WHERE 1=1
 ORDER BY eq_no,
 		trsp_so_no,
 		trsp_wo_no,
 		validity,
 		invoiced,
 		trsp_so_sts_cd,
 		eq_tpsz_cd,
 		iso_cd,
 		apnt_dt,
 		de_dt			]]></sql>
			<params>
				<param name="vndr_dvsn" type="12" value="111" out="N"/>
				<param name="vndr_seq" type="2" value="111" out="N"/>
				<param name="trsp_wo_ofc_cty_cd" type="12" value="111" out="N"/>
				<param name="trsp_wo_seq" type="2" value="111111" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
