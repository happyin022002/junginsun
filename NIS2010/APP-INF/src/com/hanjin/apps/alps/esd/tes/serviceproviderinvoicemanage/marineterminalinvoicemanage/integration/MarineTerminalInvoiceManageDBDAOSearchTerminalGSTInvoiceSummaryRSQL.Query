<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="MarineTerminalInvoiceManageDBDAOSearchTerminalGSTInvoiceSummaryRSQL">
			<desc><![CDATA[SearchTerminalGSTInvoiceSummary]]></desc>
			<sql><![CDATA[
SELECT 
    IDA_SAC_CD,
    IDA_SAC_NM,
    IDA_PAY_TP_CD,
    INV_NO, 
    FILE_CHK, 
	VVD,
    TML_SO_OFC_CTY_CD,
    TML_SO_SEQ,
    INV_TP_CD,
    TML_INV_TP_CD,
    TML_INV_STS_CD,
    TML_INV_RJCT_STS_CD,
    LOCL_CRE_DT,
    INV_OFC_CD,
    INV_OFC_DEL_FLG,
	COST_OFC_CD,
    COST_OFC_DEL_FLG,
    YD_CD,
    YD_DEL_FLG,
    CURR_CD,
    ISS_DT,
    RCV_DT,
    HLD_FLG,
    VNDR_SEQ,
    VNDR_DEL_FLG, 
    SUM(INV_AMT) INV_AMT,
	NVL(SUM(INV_AMT), 0) + NVL(SUM(IDA_GST_AMT), 0) TOTAL_AMT,
	DELT_FLG,
    CSR_NO,
    CSR_STATUS,
    IDA_CGST_RTO,
    SUM(IDA_CGST_AMT) IDA_CGST_AMT,
    IDA_SGST_RTO,
    SUM(IDA_SGST_AMT) IDA_SGST_AMT,
    IDA_IGST_RTO,
    SUM(IDA_IGST_AMT) IDA_IGST_AMT,
    IDA_UGST_RTO,
    SUM(IDA_UGST_AMT) IDA_UGST_AMT,
    IDA_GST_RTO,
    SUM(IDA_GST_AMT) IDA_GST_AMT,
    VNDR_GST_NO,
    VNDR_STE_CD,
    CST_OFC_GST_NO,
    CST_OFC_STE_CD,
    VNDR_LGL_ENG_NM,
    AP_RVS_CNG_FLG,
	CRE_DT,
	INV_CFM_DT,
	CRE_USR_ID
FROM (
SELECT  	/*+ FIRST_ROWS */ H.INV_NO,  
		  NVL(
          CASE
          WHEN H.EDI_FLG = 'Y'
          THEN  (
                SELECT 
                    CASE
                    WHEN F.FILE_SEQ IS NOT NULL AND F.ORG_FILE_NM IS NOT NULL AND F.FILE_SAV_ID IS NOT NULL AND C.FILE_SAV_ID IS NOT NULL
                    THEN 'Y'
                    ELSE 'N'
                    END FILE_CHK
                FROM TES_EDI_SO_HDR E, TES_EDI_SO_FILE F, COM_UPLD_FILE C
                WHERE 1=1
                AND E.TML_SO_OFC_CTY_CD = H.TML_SO_OFC_CTY_CD
                AND E.TML_SO_SEQ = H.TML_SO_SEQ
                AND NVL(E.DELT_FLG,'N') <> 'Y'
                AND ((E.TML_EDI_SO_OFC_CTY_CD = F.TML_EDI_SO_OFC_CTY_CD AND E.TML_EDI_SO_SEQ = F.TML_EDI_SO_SEQ)
					OR
					 (E.TML_SO_OFC_CTY_CD = F.TML_SO_OFC_CTY_CD AND E.TML_SO_SEQ = F.TML_SO_SEQ))
                AND NVL(F.DELT_FLG,'N') <> 'Y'
                AND F.FILE_SAV_ID = C.FILE_SAV_ID
                AND NVL(C.DELT_FLG,'N') <> 'Y'
				AND ROWNUM = 1
                )
          ELSE 'N'
          END,'N') FILE_CHK, 
           CASE
           WHEN H.TML_INV_TP_CD IN ('TM')
           THEN TES_GET_VVD_LIST_FNC(H.TML_SO_OFC_CTY_CD,H.TML_SO_SEQ,'N')
           ELSE ''
           END VVD,
			H.TML_SO_OFC_CTY_CD, 
			H.TML_SO_SEQ, 
			DECODE(H.TML_INV_TP_CD,'TM','MR','ON','RC','OF','OC','ST','MS') INV_TP_CD, 
			H.TML_INV_TP_CD, 
			DECODE(H.TML_INV_STS_CD,'R','RC','C','CF','A','AR','P','AP','D','PD') TML_INV_STS_CD, 
			H.TML_INV_RJCT_STS_CD, 
--		/** ALPS에서 LOCL_CRE_DT를 운영할 때까지만 CRE_DT를 LOCAL시간으로 임의 설정 한다. **/
 			TO_CHAR(H.LOCL_CRE_DT,'YYYYMMDDHH24MISS') LOCL_CRE_DT,
		 	H.INV_OFC_CD, 
			(SELECT DELT_FLG FROM MDM_ORGANIZATION WHERE OFC_CD = H.INV_OFC_CD)  INV_OFC_DEL_FLG,
            H.COST_OFC_CD,
			(SELECT DELT_FLG FROM MDM_ORGANIZATION WHERE OFC_CD = H.COST_OFC_CD) COST_OFC_DEL_FLG,
			H.YD_CD,
			(SELECT DELT_FLG FROM MDM_YARD WHERE YD_CD = H.YD_CD)		YD_DEL_FLG,
			H.CURR_CD, 
			TO_CHAR(H.ISS_DT,'YYYYMMDD')		ISS_DT, 
			TO_CHAR(H.RCV_DT,'YYYYMMDD')		RCV_DT, 
			NVL(H.HLD_FLG,'N') HLD_FLG, 
			LPAD(H.VNDR_SEQ, 6, '0') 	VNDR_SEQ,
			(SELECT DELT_FLG FROM MDM_VENDOR WHERE VNDR_SEQ = H.VNDR_SEQ)	VNDR_DEL_FLG,
			D.INV_AMT,
            H.DELT_FLG,
			H.CSR_NO, 
			-- CHM-201537728 Invoice Summary화면에서 CSR I/F Status 미반영 로직 수정 요청 (조아영D 2015-08-28)
			CASE
				WHEN A.AFT_ACT_FLG = 'X' OR A.AFT_ACT_FLG = 'N' THEN 'Canceled'
				WHEN A.RCV_ERR_FLG = 'E' THEN 'Rejected'
				WHEN A.IF_FLG = 'E' THEN 'I/F Error'
				WHEN A.IF_FLG = 'Y' AND A.RCV_ERR_FLG IS NULL THEN 'I/F Success'
				WHEN H.TML_INV_STS_CD = 'R' THEN 'Processing'
				WHEN H.TML_INV_STS_CD = 'C' AND A.IF_FLG IS NULL THEN 'Processing'
				WHEN H.TML_INV_RJCT_STS_CD = 'RJ' AND A.AFT_ACT_FLG IS NULL THEN 'Disapproved'
				WHEN A.IF_FLG IS NULL AND A.APRO_FLG = 'N' AND A.RQST_APRO_STEP_FLG = 'Y' THEN 'Requesting Approval'
				WHEN A.IF_FLG IS NULL AND A.APRO_FLG <> 'Y' THEN 'Approval Requested'
				ELSE 'ALL'
			END CSR_STATUS, 
            D.IDA_CGST_RTO,
            D.IDA_CGST_AMT,
            D.IDA_SGST_RTO,
            D.IDA_SGST_AMT,
            D.IDA_IGST_RTO,
            D.IDA_IGST_AMT,
            D.IDA_UGST_RTO,
            D.IDA_UGST_AMT,
            D.IDA_GST_RTO,
            D.IDA_GST_AMT,
            D.IDA_SAC_CD,
            (SELECT IDA_SAC_NM FROM BKG_IDA_SAC_MST B WHERE B.IDA_SAC_CD = D.IDA_SAC_CD AND B.DELT_FLG='N' AND ROWNUM = 1) IDA_SAC_NM,
            D.IDA_PAY_TP_CD,
                (SELECT IDA_GST_RGST_NO FROM MDM_VENDOR MV WHERE MV.DELT_FLG = 'N' AND MV.VNDR_SEQ = H.VNDR_SEQ) AS VNDR_GST_NO,
                (SELECT MS.IDA_STE_CD 
                FROM MDM_VENDOR MV, MDM_LOCATION ML, MDM_STATE MS
                WHERE MV.LOC_CD = ML.LOC_CD
                AND MS.CNT_CD = MV.VNDR_CNT_CD
                AND MS.STE_CD = ML.STE_CD
                AND	MV.DELT_FLG = 'N'
                AND MV.VNDR_SEQ = H.VNDR_SEQ) AS VNDR_STE_CD,
                (SELECT Q.IDA_GST_RGST_NO
                    FROM MDM_ORGANIZATION P,
                         MDM_CUSTOMER Q
                    WHERE P.OFC_CD = H.COST_OFC_CD
                    AND P.REP_CUST_CNT_CD = Q.CUST_CNT_CD
                    AND P.REP_CUST_SEQ = Q.CUST_SEQ)        AS CST_OFC_GST_NO,
                (SELECT   R.IDA_STE_CD 
                    FROM     MDM_ORGANIZATION P 
                           , MDM_LOCATION Q 
                           , MDM_STATE R
                    WHERE    P.LOC_CD = Q.LOC_CD 
                    AND      Q.CNT_CD = R.CNT_CD 
                    AND      Q.STE_CD = R.STE_CD 
                    AND      P.OFC_CD = H.COST_OFC_CD)   AS CST_OFC_STE_CD,
                 (SELECT VNDR_LGL_ENG_NM FROM MDM_VENDOR WHERE VNDR_SEQ = H.VNDR_SEQ) AS VNDR_LGL_ENG_NM,
           	NVL(H.AP_RVS_CNG_FLG, 'N') AP_RVS_CNG_FLG,
			TO_CHAR(H.INV_CFM_DT, 'YYYYMMDD') AS INV_CFM_DT,				-- INVOICE CONFIRMED DATE
			H.CRE_USR_ID,
			TO_CHAR(H.CRE_DT,'YYYYMMDD')		CRE_DT
FROM 		TES_TML_SO_HDR H, AP_INV_HDR A, TES_TML_SO_DTL D--// CHM-201537539 Invoice IF Inquiry에서 조건 명칭 추가삭제변경 (조아영D 2015-08-25)
			, COM_APRO_CSR_DTL C, COM_APRO_RQST_HDR R
WHERE 		NVL(H.DELT_FLG, 'N') = 'N'
AND		H.CSR_NO = A.CSR_NO(+)
AND     H.TML_SO_OFC_CTY_CD = D.TML_SO_OFC_CTY_CD(+)
AND     H.TML_SO_SEQ = D.TML_SO_SEQ(+)
--// CHM-201537539 Invoice IF Inquiry에서 조건 명칭 추가삭제변경 (조아영D 2015-08-25)
AND		H.CSR_NO		= C.CSR_NO(+)
AND		C.APRO_RQST_NO	= R.APRO_RQST_NO(+)
AND  'Y' = (SELECT DECODE(COUNT(OFC_CD),0,'N','Y') IDA_OFC_CD FROM MDM_ORGANIZATION A, MDM_LOCATION B WHERE A.LOC_CD = B.LOC_CD
   AND B.CNT_CD = 'IN'
   AND A.DELT_FLG = 'N'
   AND B.DELT_FLG = 'N'
   AND (A.OFC_CD = H.INV_OFC_CD OR A.OFC_CD = H.COST_OFC_CD))
--// CHM-201537539 Invoice IF Inquiry에서 조건 명칭 추가삭제변경 (조아영D 2015-08-25)
#if (${inv_date_type} == 'I') 	-- ISSUED DATE
AND		H.ISS_DT BETWEEN TO_DATE(@[fm_prd_dt],'YYYY-MM-DD') AND TO_DATE(@[to_prd_dt],'YYYY-MM-DD')+0.99999
#elseif (${inv_date_type} == 'R')	-- RECEIVED DATE
AND		H.RCV_DT BETWEEN TO_DATE(@[fm_prd_dt],'YYYY-MM-DD') AND TO_DATE(@[to_prd_dt],'YYYY-MM-DD')+0.99999
#elseif (${inv_date_type} == 'P')	-- INVOICE UPDATE DATE
AND		H.LOCL_UPD_DT BETWEEN TO_DATE(@[fm_prd_dt],'YYYY-MM-DD') AND TO_DATE(@[to_prd_dt],'YYYY-MM-DD')+0.99999
#elseif (${inv_date_type} == 'C')	-- CONFIRMED DATE
AND		H.INV_CFM_DT BETWEEN TO_DATE(@[fm_prd_dt],'YYYY-MM-DD') AND TO_DATE(@[to_prd_dt],'YYYY-MM-DD')+0.99999
#elseif (${inv_date_type} == 'A')	-- ARRROVAL REQUESTED DATE
AND		( (R.RQST_ST_DT BETWEEN TO_DATE(@[fm_prd_dt], 'YYYY-MM-DD') AND TO_DATE(@[to_prd_dt], 'YYYY-MM-DD') + 0.99999 )
OR		( A.CSR_APRO_STEP_ASGN_DT BETWEEN TO_DATE(@[fm_prd_dt], 'YYYY-MM-DD') AND TO_DATE(@[to_prd_dt], 'YYYY-MM-DD') + 0.99999 ) )
#elseif (${inv_date_type} == 'U')	-- I/F STATUS UPDATED
AND		A.IF_DT BETWEEN TO_DATE(@[fm_prd_dt], 'YYYY-MM-DD') AND TO_DATE(@[to_prd_dt], 'YYYY-MM-DD') + 0.99999
#end

#if (${yd_cd} != '') 
and	h.yd_cd	 =	@[yd_cd]
#else
#end

#if (${inv_no} != '') 
and	h.inv_no	like	'%'||@[inv_no]||'%'
#else
#end

/**2013.02.26 log-in office가 HAMUOG, SELCOT에서만 조회되도록 하드코딩 추가...1년 후 삭제 예정 FDRCIV201301 ~ FDRCIV201312 **/
/**2013.06.03 log-in office가 HAMUOG, SELCOT에서만 조회되도록 하드코딩 추가...1년 후 삭제 예정..Rebate Invoice 처리 : 2012년 8월 ~ 2013년 12월..APP201208 ~ APP201312 **/
/**2013.06.03 log-in office가 HAMUOG, SELCOT에서만 조회되도록 하드코딩 추가...2014년 용..APP201401, APP201402, APP201403 **/
#if (${cre_ofc_cd} != 'HAMSEL') 
and	h.inv_no NOT IN ('FDRCIV201301','FDRCIV201302','FDRCIV201303','FDRCIV201304','FDRCIV201305','FDRCIV201306','FDRCIV201307','FDRCIV201308','FDRCIV201309','FDRCIV201310','FDRCIV201311','FDRCIV201312',
					 'APP201208','APP201209','APP201210','APP201211','APP201212','APP201301','APP201302','APP201303','APP201304','APP201305','APP201306','APP201307','APP201308','APP201309','APP201310','APP201311','APP201312',
					 'APP201401','APP201402','APP201403'
					 ,'BEST201401Q','BEST201402Q','BEST201403Q','BEST201404Q','BEST201501Q','BEST201502Q','BEST201503Q','BEST201504Q' --// 2014-06-18 추가
					 ,'UOM201406-001' --// 2014-07-08 추가
					 )
#else
#end

#if (${vndr_seq} != '') 
and	h.vndr_seq	=	@[vndr_seq]
#else
#end

#if (${cost_ofc_cd} != '')
	#if($sub_ofc_cd1.size() > 0)
		AND     h.cost_ofc_cd IN (
	#foreach($sub_ofc_cd1_num IN ${sub_ofc_cd1})
		#if($velocityCount < $sub_ofc_cd1.size()) 
			'$sub_ofc_cd1_num', 
		#else 
			'$sub_ofc_cd1_num' 
		#end 
	#end
	)
	#else
		AND		h.cost_ofc_cd = @[cost_ofc_cd]
	#end
#end

#if (${inv_ofc_cd} != '')
	#if($sub_ofc_cd2.size() > 0)
		AND     h.inv_ofc_cd IN (
	#foreach($sub_ofc_cd2_num IN ${sub_ofc_cd2})
		#if($velocityCount < $sub_ofc_cd2.size()) 
			'$sub_ofc_cd2_num', 
		#else 
			'$sub_ofc_cd2_num' 
		#end 
	#end
	)
	#else
		AND		h.inv_ofc_cd = @[inv_ofc_cd]
	#end
#end

#if (${tml_inv_sts_cd} != '') 
and	h.tml_inv_sts_cd	=	@[tml_inv_sts_cd]
#else
and	h.tml_inv_sts_cd in ('R','C','A','P','D')
#end

#if (${csr_no} != '') 
and	h.csr_no like	'%'||@[csr_no]||'%'	
#else
#end

#if (${tml_inv_rjct_sts_cd} != '') 
and	h.tml_inv_rjct_sts_cd = @[tml_inv_rjct_sts_cd]
#else
and	h.tml_inv_rjct_sts_cd in ('NL','RJ','RL')
#end

#if (${csr_status} == 'AR') 
AND	A.IF_FLG IS NULL
AND	H.CSR_NO IS NOT NULL
#elseif (${csr_status} == 'PC') 
AND	( H.TML_INV_STS_CD = 'R' OR (H.TML_INV_STS_CD = 'C' AND A.IF_FLG IS NULL) )
#elseif (${csr_status} == 'IE') 
AND	A.IF_FLG = 'E'
#elseif (${csr_status} == 'RJ') 
AND	A.RCV_ERR_FLG = 'E'
#elseif (${csr_status} == 'SC') 
AND	A.IF_FLG = 'Y'	AND A.RCV_ERR_FLG IS NULL
#elseif (${csr_status} == 'DA') 
AND	 H.TML_INV_STS_CD = 'A' AND H.TML_INV_RJCT_STS_CD = 'RJ'
#else 
#end

#if(${hld_flg} == 'Y') -- [CHM-201538036]Hold 검색조건 추가 (조아영D 2015.09.23)
AND NVL(H.HLD_FLG,'N') = 'Y'
#else
#end
)
GROUP BY 
    IDA_SAC_CD,
    IDA_SAC_NM,
    IDA_PAY_TP_CD,
    INV_NO, 
    FILE_CHK,
	VVD, 
    TML_SO_OFC_CTY_CD,
    TML_SO_SEQ,
    INV_TP_CD,
    TML_INV_TP_CD,
    TML_INV_STS_CD,
    TML_INV_RJCT_STS_CD,
    LOCL_CRE_DT,
    INV_OFC_CD,
    INV_OFC_DEL_FLG,
	COST_OFC_CD,
    COST_OFC_DEL_FLG,
    YD_CD,
    YD_DEL_FLG,
    CURR_CD,
    ISS_DT,
    RCV_DT,
    HLD_FLG,
    VNDR_SEQ,
    VNDR_DEL_FLG, 
	DELT_FLG,
    CSR_NO,
    CSR_STATUS,
    VNDR_GST_NO,
    VNDR_STE_CD,
    CST_OFC_GST_NO,
    CST_OFC_STE_CD,
    VNDR_LGL_ENG_NM,
    IDA_GST_RTO,
    IDA_CGST_RTO,
    IDA_SGST_RTO,
    IDA_IGST_RTO,
    IDA_UGST_RTO,
    AP_RVS_CNG_FLG,
    CRE_DT,
	INV_CFM_DT,
	CRE_USR_ID			]]></sql>
			<params>
				<param name="fm_prd_dt" type="12" value="" out="N"/>
				<param name="to_prd_dt" type="12" value="" out="N"/>
				<param name="yd_cd" type="12" value="" out="N"/>
				<param name="inv_no" type="12" value="" out="N"/>
				<param name="vndr_seq" type="12" value="" out="N"/>
				<param name="cost_ofc_cd" type="12" value="" out="N"/>
				<param name="inv_ofc_cd" type="12" value="" out="N"/>
				<param name="tml_inv_sts_cd" type="12" value="" out="N"/>
				<param name="csr_no" type="12" value="" out="N"/>
				<param name="tml_inv_rjct_sts_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
