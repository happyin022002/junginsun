<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="VskEmailSendDBDAOSearchVslSkdCtntRSQL">
			<desc><![CDATA[searchVslSkdEmlJob 에서 조회된 화주 (eml_grp_id) 와 특정 조건 별로 송신할 email 내역을 가져온다.]]></desc>
			<sql><![CDATA[
/* 삼성전자 MAILING SERVICE */
SELECT
    M.VVD,
    M.VESSEL_NAME,
    M.POL,
    M.LANE,
    DECODE(M.SKD_CNG_STS_CD, 'S', 'SKIP', M.VPS_ETB_DT) AS VPS_ETB_DT,
    M.VPS_ETD_DT,
    M.PF_ETB_DT,
    M.PF_ETD_DT,
    M.DELAY_BERTH,
    M.DELAY_DEP
FROM
(
SELECT DISTINCT
        T1.VSL_CD || T1.SKD_VOY_NO || T1.SKD_DIR_CD AS VVD
        , (SELECT VSL_ENG_NM FROM MDM_VSL_CNTR WHERE VSL_CD = T1.VSL_CD) AS VESSEL_NAME
        , T1.VPS_PORT_CD AS POL
        , T1.SLAN_CD AS LANE
        , TO_CHAR(T1.VPS_ETB_DT, 'YYYY-MM-DD HH24:MI') AS VPS_ETB_DT
        , TO_CHAR(T1.VPS_ETD_DT, 'YYYY-MM-DD HH24:MI') AS VPS_ETD_DT
        , TO_CHAR(T1.PF_ETB_DT, 'YYYY-MM-DD HH24:MI') AS PF_ETB_DT
        , TO_CHAR(T1.PF_ETD_DT, 'YYYY-MM-DD HH24:MI') AS PF_ETD_DT
        , ROUND(T1.VPS_ETB_DT - T1.PF_ETB_DT, 1) AS DELAY_BERTH
        , ROUND(T1.VPS_ETD_DT - T1.PF_ETD_DT, 1) AS DELAY_DEP
		, T1.SKD_CNG_STS_CD
FROM VSK_VSL_PORT_SKD T1, (
        SELECT
                SLAN_CD
                , VSL_CD
                , SKD_VOY_NO
                , SKD_DIR_CD
                , VPS_PORT_CD
                , CLPT_SEQ
				, SKD_CNG_STS_CD
                , LEAD(VPS_PORT_CD) OVER(PARTITION BY VSL_CD, SKD_VOY_NO, SKD_DIR_CD ORDER BY CLPT_SEQ) AS NXT_PORT_CD /* 이전포트 */
        FROM VSK_VSL_PORT_SKD 
        WHERE 1=1
        AND SLAN_CD = @[slanCd] -- SCE_VSL_SKD_EML 에서 가져온 LANE LIST 로 수정 요망
#if(${emlGrpId} != 'SAMSUNG_ELEC')
		AND VPS_PORT_CD = @[toPortCd]
#else
        AND TURN_PORT_IND_CD NOT IN ('D', 'V', 'F')
#end
		AND SKD_DIR_CD = 'E'
        AND VPS_ETB_DT >= NEXT_DAY(TO_DATE(TO_CHAR(SYSDATE, 'YYYYMMDD'), 'YYYYMMDD') , 1) - 7 -- 해당 주에 처음부터 계산하기 위해 NEXT_DAY 후 - 7일 함
        AND VPS_ETB_DT <= NEXT_DAY(TO_DATE(TO_CHAR(SYSDATE, 'YYYYMMDD'), 'YYYYMMDD') , 1) - 7 + @[vskdDurId] - (1/24/60/60) -- 해당 주에 처음부터 계산하기 위해 NEXT_DAY 후 - 7일 함
) T2, SCE_VSL_SKD_EML V
WHERE 1=1
AND T1.SLAN_CD = T2.SLAN_CD
AND T1.VSL_CD = T2.VSL_CD
AND T1.SKD_VOY_NO = T2.SKD_VOY_NO
AND T1.SKD_DIR_CD = T2.SKD_DIR_CD
AND T1.VPS_PORT_CD = T2.VPS_PORT_CD
AND (T2.SLAN_CD= v.vsl_slan_cd AND (T2.VPS_PORT_CD=V.TO_PORT_CD OR T2.NXT_PORT_CD=V.TO_PORT_CD)) 
) M
ORDER BY M.VPS_ETB_DT ASC -- ETB 순으로 정렬			]]></sql>
			<params>
				<param name="slanCd" type="12" value="" out="N"/>
				<param name="toPortCd" type="12" value="" out="N"/>
				<param name="vskdDurId" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
