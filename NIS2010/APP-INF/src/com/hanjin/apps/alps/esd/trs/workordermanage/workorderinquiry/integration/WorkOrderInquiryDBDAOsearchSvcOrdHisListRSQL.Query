<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="WorkOrderInquiryDBDAOsearchSvcOrdHisListRSQL">
			<desc><![CDATA[Service Order History]]></desc>
			<sql><![CDATA[
SELECT * FROM (
SELECT RANK() OVER(PARTITION BY SOH.TRSP_SO_OFC_CTY_CD, SOH.TRSP_SO_SEQ ORDER BY SOH.TRSP_SO_OFC_CTY_CD, SOH.TRSP_SO_SEQ, SOH.TRSP_HIS_SEQ DESC) WO_ISS_KNT_RANK,
       WOH.TRSP_WO_OFC_CTY_CD,
       WOH.TRSP_WO_SEQ,
       WOH.TRSP_WO_OFC_CTY_CD||WOH.TRSP_WO_SEQ AS TRSP_WO_NO,
       SOH.TRSP_SO_OFC_CTY_CD,
       SOH.TRSP_SO_SEQ,
       SOH.TRSP_SO_OFC_CTY_CD||SOH.TRSP_SO_SEQ AS TRSP_SO_NO,
       SO.CRE_OFC_CD,
       SO.EQ_NO,
       TO_CHAR ( SO.LOCL_CRE_DT, 'YYYY-MM-DD HH24:MI:SS') AS LOCL_CRE_DT,
       SO.DELT_FLG,
       SOH.UPD_USR_ID,
       (CASE WHEN SOH.RQST_SRC_SYS_CD = 'SPP' THEN 'SPP' ELSE (SELECT USR_NM FROM COM_USER D WHERE 1=1 AND USR_ID = SOH.UPD_USR_ID AND ROWNUM = 1) END) AS UPD_USR_NM,
       SO.TRSP_COST_DTL_MOD_CD,
       WOH.WO_ISS_KNT,
       SOH.RQST_SRC_SYS_CD,
       SOH.TRSP_RJCT_RSN_CD,
       (CASE WHEN SOH.RQST_SRC_SYS_CD = 'SPP' AND SOH.TRSP_RJCT_RSN_CD = 'R' THEN (SELECT WO_RJCT_RSN FROM TRS_TRSP_WRK_ORD_RJCT_HIS WHERE 1=1 AND TRSP_SO_OFC_CTY_CD = SOH.TRSP_SO_OFC_CTY_CD AND TRSP_SO_SEQ = SOH.TRSP_SO_SEQ AND ROWNUM = 1) ELSE COMMCODE_PKG.GET_COMDTL_NAME_FNC('CD00957',SOH.TRSP_RJCT_RSN_CD) END) TRSP_RJCT_RSN_NM,
--       COMMCODE_PKG.GET_COMDTL_NAME_FNC('CD00957',SOH.TRSP_RJCT_RSN_CD) AS TRSP_RJCT_RSN_NM,
       DECODE(SO.DTN_USE_FLG, 'Y', '1', '0') DTN_USE_FLG,
       DECODE(SO.WO_BL_NO_ISS_FLG, 'Y', '1', '0') WO_BL_NO_ISS_FLG,
       (SELECT BKG.BLCK_STWG_CD FROM BKG_BOOKING BKG WHERE BKG.BKG_NO = NVL(SO.BKG_NO,SO.BL_NO)) AS BLCK_STWG
  FROM TRS_TRSP_WRK_ORD_HIS WOH,
       TRS_TRSP_SO_HIS SOH,
       TRS_TRSP_SVC_ORD SO
 WHERE 1=1
   AND WOH.TRSP_WO_OFC_CTY_CD = SUBSTR(@[wo_no_a], 1, 3)
   AND WOH.TRSP_WO_SEQ = SUBSTR(@[wo_no_a], 4)
   AND WOH.WO_ISS_KNT <= @[wo_iss_knt]
   AND WOH.TRSP_WO_SEQ = SOH.TRSP_WO_SEQ
   AND WOH.TRSP_WO_OFC_CTY_CD = SOH.TRSP_WO_OFC_CTY_CD
   AND SOH.TRSP_SO_SEQ = SO.TRSP_SO_SEQ
   AND SOH.TRSP_SO_OFC_CTY_CD = SO.TRSP_SO_OFC_CTY_CD
   AND WOH.WO_ISS_KNT = NVL(SOH.WO_ISS_KNT, 1)
)
 WHERE 1=1
   AND WO_ISS_KNT_RANK = 1
 ORDER BY TRSP_WO_OFC_CTY_CD, TRSP_WO_SEQ, TRSP_SO_OFC_CTY_CD, TRSP_SO_SEQ			]]></sql>
			<params>
				<param name="wo_no_a" type="12" value="" out="N"/>
				<param name="wo_iss_knt" type="12" value="1" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
