<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="RailSoManageDBDAOSearch08RailSoManageRSQL">
			<desc><![CDATA[US Rail Empty SO 대상 조회 SQL]]></desc>
			<sql><![CDATA[
SELECT /*+ USE_NL(A,  LOC) */
        A.REPO_PLN_ID
	   ,A.PLN_YRWK
	   ,A.PLN_SEQ
	   ,A.SO_IF_DIV_CD
	   ,A.REF_ID
	   ,A.SO_RQST_DT
	   ,A.CNTR_TPSZ_CD EQ_TPSZ_CD
	   ,COUNT(A.REF_ID)  ALLOCATED
	   ,SUM( DECODE( SO.TRSP_SO_STS_CD ,'C',1,'R',1,0 )) CRET_QTY
	   ,COUNT(SO.WO_ISS_DT ) EDI_QTY
	   ,SUM( DECODE(SO.TRSP_SO_SEQ , NULL , 1, 0 )) REMAINING_QTY
	   ,SUM( DECODE(SO.TRSP_SO_SEQ , NULL , 1, 0 )) NEEDED_QTY
	   ,SUBSTR(A.FM_YD_CD,1,5) FM_LOC_CD
	   ,SUBSTR(A.FM_YD_CD,6,2) FM_NOD_CD
   	   ,A.FM_DT
	   ,SUBSTR(A.TO_YD_CD,1,5) TO_LOC_CD
	   ,SUBSTR(A.TO_YD_CD,6,2) TO_NOD_CD
       ,A.TO_DT
 	   ,A.TRSP_MOD_CD
	   ,A.VSL_LANE_CD SLAN_CD
	   ,A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD VVD_CD
	   ,A.REPO_PURP_RMK
	   ,TO_CHAR(GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC( 'PHXSA' ) ,'RRRRMMDD') CURR_DT 
	   ,A.TRSP_MOD_CD TRSP_CRR_MOD_CD
	   ,A.SO_IF_DIV_CD TRSP_COST_DTL_MOD_CD
   FROM EQR_REPO_EXE_SO_IF A
	   ,TRS_TRSP_RAIL_BIL_ORD SO
       ,MDM_LOCATION LOC 
  WHERE A.REPO_PLN_ID = SO.REPO_PLN_ID(+)	
    AND A.PLN_YRWK = SO.PLN_YRWK(+)
    AND A.REF_ID = SO.REF_ID(+)
    AND A.REF_SEQ = SO.REF_SEQ(+) 
    AND A.WO_RQST_FLG = 'Y'
    AND SUBSTR(A.FM_YD_CD, 1, 5) = LOC.LOC_CD 
    AND A.CO_CD = 'H'
    AND A.SO_IF_DIV_CD ='R'
    AND EXISTS (SELECT 1 FROM MDM_COUNTRY CNTY WHERE CNTY.CNT_CD != 'MX' AND LOC.CONTI_CD = 'M' AND A.TRSP_MOD_CD = 'R' AND LOC.CNT_CD = CNTY.CNT_CD)
#if(${splanFromDate} != '' && ${splanToDate} != '')
	AND A.SO_RQST_DT BETWEEN @[splanFromDate] AND @[splanToDate]
#end

#if(${sfromLocationCd} != '')
	AND A.FM_YD_CD LIKE @[sfromLocationCd]||'%'
#end

#if(${stoLocationCd} != '')
	AND A.TO_YD_CD LIKE @[stoLocationCd]||'%'
#end

#if(${selKind} == 'ER')
	AND A.SO_IF_DIV_CD IN ('T', 'R', 'W')
#elseif(${selKind} == 'CN')
	AND A.SO_IF_DIV_CD = 'O'
#elseif(${selKind} == 'CF')
	AND A.SO_IF_DIV_CD = 'F'
#end

#if($cntr.size() > 0)
	AND A.CNTR_NO IN (
	#foreach($key IN ${cntr})
		#if($velocityCount == 1)						
			'$key'
		#else
			,'$key'
		#end
	#end
	)
#end

#if(${cntrType} != 'ALL')
	AND SUBSTR(A.CNTR_TPSZ_CD, 1, 1) = @[cntrType]
#end

#if(${cntrSize} != 'ALL')
	AND SUBSTR(A.CNTR_TPSZ_CD, 2, 1) = @[cntrSize]
#end

#if($refId.size() > 0)
	AND A.REF_ID IN (
	#foreach($key IN ${refId})
		#if($velocityCount == 1)						
			'$key'
		#else
			,'$key'
		#end
	#end
	)
#end
    AND A.EQ_CTRL_OFC_CD = @[sctrlOfcCd] 
  GROUP BY A.REPO_PLN_ID
		  ,A.PLN_YRWK
	   	  ,A.PLN_SEQ
		  ,A.SO_IF_DIV_CD
	      ,A.REF_ID
	      ,A.SO_RQST_DT
	      ,A.CNTR_TPSZ_CD
		  ,A.FM_YD_CD
		  ,A.FM_DT
		  ,A.TO_YD_CD
		  ,A.TO_DT
		  ,A.TRSP_MOD_CD
     	  ,A.TRSP_MOD_CD
    	  ,A.VSL_LANE_CD
    	  ,A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD
    	  ,A.REPO_PURP_RMK
		  ,TO_CHAR(GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC( 'PHXSA' ) ,'RRRRMMDD')
  ORDER BY A.SO_IF_DIV_CD
		  ,A.SO_RQST_DT
		  ,A.REF_ID
		  ,A.CNTR_TPSZ_CD			]]></sql>
			<params>
				<param name="splanFromDate" type="12" value="" out="N"/>
				<param name="splanToDate" type="12" value="" out="N"/>
				<param name="sfromLocationCd" type="12" value="" out="N"/>
				<param name="stoLocationCd" type="12" value="" out="N"/>
				<param name="cntrType" type="12" value="" out="N"/>
				<param name="cntrSize" type="12" value="" out="N"/>
				<param name="sctrlOfcCd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
