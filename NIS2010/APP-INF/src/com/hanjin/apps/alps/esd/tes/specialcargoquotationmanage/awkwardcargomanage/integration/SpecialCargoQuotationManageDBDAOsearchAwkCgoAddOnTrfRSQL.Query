<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="SpecialCargoQuotationManageDBDAOsearchAwkCgoAddOnTrfRSQL">
			<desc><![CDATA[searchAwkCgoAddOnTrf]]></desc>
			<sql><![CDATA[
SELECT * FROM (
    SELECT 
    AH.FM_LOC_CD
    , AH.FM_NOD_YD_NO
    , AH.TO_LOC_CD  
    , AH.TO_NOD_YD_NO
    , AH.COND_NO
	,(SELECT C.COND_DESC
	  FROM TES_TRF_COND C
	  WHERE 1=1
	  AND C.COND_NO = X.COND_NO) COND_DESC
    , AH.TML_AWK_ADON_VER_NO
	, X.MAN_LOCL_CURR_CD
	, X.MAN_LOCL_AMT_20FT
	, X.MAN_LOCL_AMT_40FT
    , X.MAN_USD_AMT_20FT
    , X.MAN_USD_AMT_40FT
    , AH.VNDR_SEQ    
    , AH.VNDR_NM
    , AH.CALC_RMK        
    , AH.LST_UPD_USR_ID
    , TO_CHAR(AH.LST_UPD_DT,'YYYY-MM-DD') LST_UPD_DT
    , AH.CRE_USR_ID
    , (SELECT Y.OFC_CD FROM MDM_YARD Y WHERE Y.YD_CD LIKE AH.FM_LOC_CD AND ROWNUM = 1) CRE_USR_OFC_CD
    , UU.OFC_CD UPD_USR_OFC_CD
    ,
    CASE
    WHEN TES_OOG_GET_AUTH_YN_FNC(@[lg_ofc_cd], (SELECT Y.OFC_CD FROM MDM_YARD Y WHERE Y.YD_CD LIKE AH.FM_LOC_CD AND ROWNUM = 1)) IS NOT NULL AND TES_OOG_GET_AUTH_YN_FNC(@[lg_ofc_cd], (SELECT Y.OFC_CD FROM MDM_YARD Y WHERE Y.YD_CD LIKE AH.FM_LOC_CD AND ROWNUM = 1)) = 'Y' --// LOGIN OFC를 조건으로 걸기
    THEN 'Y'
    WHEN TES_OOG_GET_AUTH_YN_FNC(@[lg_ofc_cd], UU.OFC_CD) IS NOT NULL AND TES_OOG_GET_AUTH_YN_FNC(@[lg_ofc_cd], UU.OFC_CD) = 'Y' --// LOGIN OFC를 조건으로 걸기
    THEN 'Y'
    ELSE 'N'
    END CHK_AUTH_YN    
    ,
    CASE 
    WHEN X.SPCL_CGO_REF_SEQ IS NOT NULL 
    THEN X.SPCL_CGO_REF_SEQ
    WHEN X.SPCL_CGO_REF_SEQ_PM IS NOT NULL 
    THEN X.SPCL_CGO_REF_SEQ_PM
    ELSE TO_NUMBER('')
    END SPCL_CGO_REF_SEQ
    FROM TES_AWK_CGO_ADON_HDR AH, (
        SELECT 
            /** ADD-ON HDR **/
            T.FM_LOC_CD, T.FM_NOD_YD_NO, T.TO_LOC_CD, T.TO_NOD_YD_NO, T.COND_NO, MAX(T.TML_AWK_ADON_VER_NO) TML_AWK_ADON_VER_NO,
            /** UNIT COST MANUAL (LOCL CURR) **/
			MAX(LOCL_CURR_CD) MAN_LOCL_CURR_CD,
			MAX(DECODE(T.CNTR_SZ_CD,'2',T.LOCL_CURR_AMT,'')) MAN_LOCL_AMT_20FT,
			MAX(DECODE(T.CNTR_SZ_CD,'4',T.LOCL_CURR_AMT,'')) MAN_LOCL_AMT_40FT,
			/** UNIT COST MANUAL (USD) **/
            MAX(DECODE(T.CNTR_SZ_CD,'2',T.USD_AMT,'')) MAN_USD_AMT_20FT,
            MAX(DECODE(T.CNTR_SZ_CD,'4',T.USD_AMT,'')) MAN_USD_AMT_40FT,
            MAX(PD.SPCL_CGO_REF_SEQ) SPCL_CGO_REF_SEQ,
            MAX(PM.SPCL_CGO_REF_SEQ) SPCL_CGO_REF_SEQ_PM
        FROM TES_AWK_CGO_ADON_HDR D, TES_AWK_CGO_ADON_TP_SZ T, PRI_SCQ_AWK_ROUT_DTL PD, PRI_SCQ_AWK_ROUT_DTL_TMP PM
        WHERE 1=1
        AND D.FM_LOC_CD              = T.FM_LOC_CD          
        AND D.FM_NOD_YD_NO           = T.FM_NOD_YD_NO       
        AND D.TO_LOC_CD              = T.TO_LOC_CD          
        AND D.TO_NOD_YD_NO           = T.TO_NOD_YD_NO       
        AND D.COND_NO                = T.COND_NO            
        AND D.TML_AWK_ADON_VER_NO    = T.TML_AWK_ADON_VER_NO        
        AND D.TML_AWK_ADON_VER_NO = (
            SELECT MAX(XD.TML_AWK_ADON_VER_NO)
            FROM TES_AWK_CGO_ADON_HDR XD
            WHERE 1=1
            AND XD.FM_LOC_CD              = T.FM_LOC_CD          
            AND XD.FM_NOD_YD_NO           = T.FM_NOD_YD_NO       
            AND XD.TO_LOC_CD              = T.TO_LOC_CD          
            AND XD.TO_NOD_YD_NO           = T.TO_NOD_YD_NO       
            AND XD.COND_NO                = T.COND_NO            
        )
        AND T.SPCL_CGO_REF_SEQ = PD.SPCL_CGO_REF_SEQ(+)
        AND T.SPCL_CGO_REF_SEQ = PM.SPCL_CGO_REF_SEQ(+)
        GROUP BY T.FM_LOC_CD, T.FM_NOD_YD_NO, T.TO_LOC_CD, T.TO_NOD_YD_NO, T.COND_NO
    ) X
    , COM_USER CU, COM_USER UU
    WHERE 1=1
	#if(${fm_loc_cd} != '' )
	AND AH.FM_LOC_CD = @[fm_loc_cd] --// 조회조건: FM_LOC
	#end
	#if(${to_loc_cd} != '' )
	AND AH.TO_LOC_CD = @[to_loc_cd] --// 조회조건: TO_LOC
	#end
    AND AH.FM_LOC_CD 	= X.FM_LOC_CD
    AND AH.FM_NOD_YD_NO = X.FM_NOD_YD_NO
    AND AH.TO_LOC_CD 	= X.TO_LOC_CD
    AND AH.TO_NOD_YD_NO = X.TO_NOD_YD_NO
    AND AH.COND_NO 	= X.COND_NO
    AND AH.TML_AWK_ADON_VER_NO = (
        SELECT MAX(XD.TML_AWK_ADON_VER_NO)
        FROM TES_AWK_CGO_ADON_HDR XD
        WHERE 1=1
        AND XD.FM_LOC_CD              = AH.FM_LOC_CD          
        AND XD.FM_NOD_YD_NO           = AH.FM_NOD_YD_NO       
        AND XD.TO_LOC_CD              = AH.TO_LOC_CD          
        AND XD.TO_NOD_YD_NO           = AH.TO_NOD_YD_NO       
        AND XD.COND_NO                = AH.COND_NO            
    )
    AND AH.CRE_USR_ID = CU.USR_ID(+)
    AND NVL(CU.USE_FLG(+),'N') = 'Y'
    AND AH.LST_UPD_USR_ID = UU.USR_ID(+)
    AND NVL(UU.USE_FLG(+),'N') = 'Y'
) P
#if(${cond_no} != '' )
WHERE P.COND_NO = @[cond_no]
#end
ORDER BY P.FM_LOC_CD, P.FM_NOD_YD_NO, P.TO_LOC_CD, P.TO_NOD_YD_NO, P.COND_NO			]]></sql>
			<params>
				<param name="lg_ofc_cd" type="12" value="" out="N"/>
				<param name="fm_loc_cd" type="12" value="" out="N"/>
				<param name="to_loc_cd" type="12" value="" out="N"/>
				<param name="cond_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
