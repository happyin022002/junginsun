<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CustomerEdiDBDAOSearchEdiSummaryReportRSQL">
			<desc><![CDATA[SearchEdiSummaryReport]]></desc>
			<sql><![CDATA[
WITH IE AS ( /* EDI_GRP_CUST를 WITH절로 변경, 3회 조회됨 */
    SELECT *
    FROM EDI_GRP_CUST
    WHERE 1=1
#if(${cs_grp_id} != '')
    AND EDI_GRP_CD = @[cs_grp_id]
#end)
,   A AS (
    SELECT H.TRNK_VSL_CD||H.TRNK_SKD_VOY_NO||H.TRNK_SKD_DIR_CD VVD,
           H.BKG_NO,
           H.CNTR_NO,
           SUBSTR(H.POR_NOD_CD, 1, 5) POR_CD,
           SUBSTR(H.POL_NOD_CD, 1, 5) POL_CD,
           SUBSTR(H.POD_NOD_CD, 1, 5) POD_CD,
           SUBSTR(H.DEL_NOD_CD, 1, 5) DEL_CD,
           H.COP_NO,
           B.BL_NO BL_NO ,
           M.N1ST_TS_PORT_CD TS_PORT,
           H.COP_RAIL_CHK_CD RAIL,
           S.EDI_STND_STS_CD A_EDI_STS_CD,
           S.EDI_GRP_CD EDI_GRP_CD ,
           S.CUST_EDI_STS_CD CUST_EDI_STS_CD
    FROM 
      BKG_BOOKING B
    , SCE_COP_HDR H
    , PRD_PROD_CTL_MST M
    , EDI_GRP_CGO S
    WHERE 1=1
    AND (B.BKG_NO) IN ( 
                       SELECT  IB.BKG_NO
                       FROM    BKG_CUSTOMER IB, IE, BKG_BOOKING BB
                       WHERE   1=1
                       AND IB.CUST_CNT_CD       = IE.CUST_CNT_CD  
                       AND IB.CUST_SEQ          = IE.CUST_SEQ
                       AND IE.CGO_TRC_SVC_FLG   = 'Y'
                       AND IE.IB_SVC_FLG        = 'N'
                       AND NVL(IE.BKG_CUST_TP_DESC, IB.BKG_CUST_TP_CD) LIKE '%'||IB.BKG_CUST_TP_CD||'%'
					   AND IB.BKG_NO            = BB.BKG_NO
				#if(${fm_dt} !='' &&  ${to_dt} !='')
                       AND BB.BKG_CRE_DT BETWEEN TO_DATE(@[fm_dt], 'YYYYMMDD')-200 AND TO_DATE(@[to_dt], 'YYYYMMDD' )+0.9999 -- $EDI_EVNT_DT
				#end
                       UNION  
                       SELECT  IB.BKG_NO
                       FROM    BKG_BOOKING IB, IE  
                       WHERE   1=1
                       AND IE.SC_NO             = IB.SC_NO
                       AND IE.CGO_TRC_SVC_FLG   = 'Y'
                       AND IE.IB_SVC_FLG        = 'N'
                       AND IE.BKG_CTRT_DIV_CD   = '1'
				#if(${fm_dt} !='' &&  ${to_dt} !='')
                       AND IB.BKG_CRE_DT BETWEEN TO_DATE(@[fm_dt], 'YYYYMMDD')-200 AND TO_DATE(@[to_dt], 'YYYYMMDD' )+0.9999 -- $EDI_EVNT_DT
				#end
                       UNION
                       SELECT  IB.BKG_NO
                       FROM    BKG_BOOKING IB, IE  
                       WHERE   1=1
                       AND IE.CGO_TRC_SVC_FLG   = 'Y'
                       AND IE.IB_SVC_FLG        = 'N'
                       AND IE.SC_NO             = IB.RFA_NO
                       AND IE.BKG_CTRT_DIV_CD   = '2'
				#if(${fm_dt} !='' &&  ${to_dt} !='')
                       AND IB.BKG_CRE_DT BETWEEN TO_DATE(@[fm_dt], 'YYYYMMDD')-200 AND TO_DATE(@[to_dt], 'YYYYMMDD' )+0.9999 -- $EDI_EVNT_DT
				#end
                )
    AND B.BKG_STS_CD <> 'X'
    AND B.BKG_NO = H.BKG_NO
    AND H.CNTR_NO <> 'SMCU0000000'
    #if(${cs_grp_id} != '')
    AND S.EDI_GRP_CD = @[cs_grp_id]
    #end
    AND H.PCTL_NO = M.PCTL_NO
    #if(${bkg_no_} != '' )
    AND B.BKG_NO IN (#foreach($ele in ${bkg_no_})
                        #if($velocityCount == 1) 
                           '$ele'
                        #else
                           ,'$ele'
                        #end 
                     #end)
    #end
    #if(${cntr_no_} != '')
     AND H.CNTR_NO IN ( #foreach($ele in ${cntr_no_})
                          #if($velocityCount == 1) 
                              '$ele'
                          #else
                             ,'$ele'
                          #end
                        #end 
                         ,'')
    #end
    #if(${bl_no_} != '' )
    AND B.BL_NO IN ( #foreach($ele in ${bl_no_})
                              #if($velocityCount == 1) 
                                   '$ele'
                              #else
                                   ,'$ele'
                              #end 
                            #end ) 
    #end
    #if(${por} != '')
    AND B.POR_NOD_CD LIKE '${por}%'
    #end
#if((${poletddate1_hidden} =='') && (${poletddate2_hidden} =='') && (${podetadate1_hidden} =='') && (${podetadate2_hidden} ==''))
    #if(${pol} != '') 
    AND B.POL_NOD_CD LIKE '${pol}%'
    #end 
    #if(${pod} != '')
    AND B.POD_NOD_CD LIKE '${pod}%'
    #end
#end
    #if(${del} != '')
    AND B.DEL_NOD_CD LIKE '${del}%'
    #end 
    #if(${cop_status} == 'C')
    AND H.COP_STS_CD  = 'F'			            
    #elseif(${cop_status} == 'I')
    AND H.COP_STS_CD  = 'T'			            
    #end
    #if(${vvd} != '') 
    AND EXISTS (SELECT 'X' FROM BKG_VVD V WHERE B.BKG_NO = V.BKG_NO 
                                        AND VSL_CD|| SKD_VOY_NO || SKD_DIR_CD IN (#foreach($ele in ${vvd})
                                                                                    #if($velocityCount == 1) 
                                                                                        '$ele'
                                                                                    #else
                                                                                        ,'$ele'
                                                                                    #end 
                                                                                  #end 
                                                                                ,'') )
    #end
#if((${vvd} == '') && (${bkg_no_} == '') && (${bl_no_} == '') &&  (${cntr_no_} == ''))
  #if((${poletddate1_hidden} !='') || (${poletddate2_hidden} !='') || (${podetadate1_hidden} !='') || (${podetadate2_hidden} !=''))
 AND EXISTS (SELECT 'X' FROM (SELECT V.*
                                FROM BKG_VVD V
                                   , VSK_VSL_PORT_SKD P 
                               WHERE 1 = 1 
                                 AND (V.VSL_CD,V.SKD_VOY_NO, V.SKD_DIR_CD) IN ((P.VSL_CD,P.SKD_VOY_NO,P.SKD_DIR_CD))
                                 AND NVL(SKD_CNG_STS_CD, ' ') <> 'S' AND CLPT_IND_SEQ = '1' 
                     -- ETD
                     #if((${poletddate1_hidden} !='') || (${poletddate2_hidden} !=''))
                        AND VPS_ETD_DT BETWEEN TO_DATE(@[poletddate1_hidden], 'YYYYMMDD' ) AND TO_DATE(@[poletddate2_hidden], 'YYYYMMDD' ) + 0.9999
                        #if(${pol} != '')
                        AND VPS_PORT_CD LIKE  '${pol}%'
                        AND V.POL_CD LIKE '${pol}%'
                        #end
                        AND NVL(TURN_PORT_IND_CD, ' ') NOT IN ('V', 'D', 'F')
						#if(${etd_eta} == 'F_ETD')
						AND V.VSL_PRE_PST_CD IN ('S','T')
						#else
						AND V.VSL_PRE_PST_CD = 'T'
						#end
						AND VPS_PORT_CD = V.POL_CD --// [2014-02-19] 추가
                    #end 
                     -- ETA 
                    #if((${podetadate1_hidden} !='') || (${podetadate2_hidden} !=''))  
                        AND VPS_ETA_DT BETWEEN TO_DATE(@[podetadate1_hidden], 'YYYYMMDD' ) AND TO_DATE(@[podetadate2_hidden], 'YYYYMMDD' ) + 0.9999
                        #if(${pod} != '')
                        AND VPS_PORT_CD LIKE '${pod}%'
                        AND V.POD_CD LIKE '${pod}%'
                        #end
                        AND NVL(TURN_PORT_IND_CD, ' ') IN ('N', 'V', 'D', 'F')
						AND V.VSL_PRE_PST_CD = 'T'
						AND VPS_PORT_CD = V.POD_CD --// [2014-02-19] 추가
                    #end
				) TG
            WHERE 1 = 1
              AND B.BKG_NO = TG.BKG_NO
              #if(${etd_eta} == 'F_ETD')
              AND (TG.BKG_NO, TG.VSL_PRE_PST_CD, TG.VSL_CD, TG.SKD_VOY_NO, TG.SKD_DIR_CD, 1) IN (SELECT VD.BKG_NO
                                                         										  , VD.VSL_PRE_PST_CD                                                         
                                                         										  , VD.VSL_CD
                                                         										  , VD.SKD_VOY_NO
                                                         										  , VD.SKD_DIR_CD
                                                         										  , ROW_NUMBER() OVER ( PARTITION BY VD.BKG_NO ORDER BY VD.VSL_PRE_PST_CD, VD.VSL_SEQ ) ROW_NO
											                                                   FROM BKG_VVD VD
                                                  											  WHERE VD.BKG_NO = B.BKG_NO
                                                 											 )
              #end
            )
    #end
 #if((${fm_dt} !='') || (${to_dt} !=''))
 AND EXISTS (SELECT 'X' FROM SCE_EDI_HIS E, SCE_EDI_HIS_DTL F WHERE B.BKG_NO = E.BKG_NO AND H.CNTR_NO = E.CNTR_NO AND E.EDI_RCV_DT = F.EDI_RCV_DT(+) AND E.EDI_RCV_SEQ = F.EDI_RCV_SEQ(+)
                     #if((${fm_dt} !='') || (${to_dt} !=''))
                        AND E.EDI_EVNT_DT BETWEEN TO_DATE(@[fm_dt], 'YYYYMMDD' ) AND TO_DATE(@[to_dt], 'YYYYMMDD' ) + 0.9999
                        #if(${edi_sts} != '')
                        AND (E.EDI_STND_STS_CD IN (#foreach($ele in ${edi_sts})
                                                 #if($velocityCount == 1) 
                                                   '$ele'
                                                 #else
                                                  ,'$ele'
                                                 #end 
                                              #end  )
                            OR F.EDI_STND_STS_CD IN (#foreach($ele in ${edi_sts})
                                                 #if($velocityCount == 1) 
                                                   '$ele'
                                                 #else
                                                  ,'$ele'
                                                 #end 
                                              #end  ))
                        #end 
                     #end    
          )
   #end
 #end 
#if(${trs_mode_} != 'A')
      #if(${trs_mode_} == 'Y')
            AND DECODE(H.COP_RAIL_CHK_CD,'','XX',H.COP_RAIL_CHK_CD) IN ('OI', 'XI') -- TRANS MODE
      #else
            AND DECODE(H.COP_RAIL_CHK_CD,'','XX',H.COP_RAIL_CHK_CD) NOT IN ('OI', 'XI') -- TRANS MODE
      #end

#end     
#if(${edi_sts} != '')                        
   AND S.EDI_STND_STS_CD IN (#foreach($ele in ${edi_sts})
                                                 #if($velocityCount == 1) 
                                                   '$ele'
                                                 #else
                                                  ,'$ele'
                                                 #end 
                                              #end )
#end 
   )  -- WITH END

SELECT '' FLAG,
  M.VVD,
  M.BKG_NO,
  M.BL_NO ,
  M.CNTR_NO,
  M.POR_CD,
  M.POL_CD,
  M.POD_CD,
  M.DEL_CD,
  M.COP_NO ,
  M.TS_PORT
 #if(${edi_sts} !='')     
  #foreach($ele1 in ${edi_sts})	
	, m.${ele1}_1					
	, m.${ele1}_2	
	, m.${ele1}_3
  #end  	
#end
FROM(
    SELECT '' ,
      L.VVD,
      L.BKG_NO,
      L.BL_NO ,
      L.CNTR_NO,
      L.POR_CD,
      L.POL_CD,
      L.POD_CD,
      L.DEL_CD,
      L.COP_NO ,
      L.TS_PORT,
      L.RAIL ,
      ROWNUM NO 
#if(${edi_sts} !='') 
  #foreach($ele1 in ${edi_sts})	 
	, l.${ele1}_1					
	, l.${ele1}_2	
	, l.${ele1}_3
  #end  
#end
    FROM(
        SELECT '' ,
          VVD,
          BKG_NO ,
          BL_NO ,
          CNTR_NO,
          POR_CD,
          POL_CD,
          POD_CD,
          DEL_CD,
          COP_NO ,
          TS_PORT,
          RAIL 
#if(${edi_sts} !='')                 
  #foreach($ele1 in ${edi_sts})	                                                        
    ,MAX(CASE WHEN A_EDI_STS_CD = '$ele1'                                                                     
                THEN TO_CHAR(ACT_DT,'YYYYMMDD')                                                                                
                ELSE NULL                                                                                  
                END) ${ele1}_1                                                                                     
    ,MAX(CASE WHEN A_EDI_STS_CD = '$ele1'                                                                     
                THEN TO_CHAR(ACT_DT,'HH24:MI')                                                                                
                ELSE NULL                                                                                  
                END) ${ele1}_2                                                                                    
    ,MAX(CASE WHEN A_EDI_STS_CD = '$ele1'                                                                     
                THEN CUST_EDI_STS_CD                                                                               
                ELSE NULL                                                                                  
                END) ${ele1}_3
  #end  
#end  
         FROM (
            SELECT RSLT.VVD,
              RSLT.BKG_NO,
              RSLT.CNTR_NO,
              RSLT.POR_CD,
              RSLT.POL_CD,
              RSLT.POD_CD,
              RSLT.DEL_CD ,
              RSLT.A_EDI_STS_CD ,
              RSLT.ACT_DT ,
              RSLT.COP_NO,
              RSLT.BL_NO,
              RSLT.EDI_GRP_CD,
              RSLT.TS_PORT,
              RSLT.RAIL ,
              RSLT.EDI_SND_KNT KNT,
              RSLT.MAX_EDI_SND_KNT M_KNT,
              RSLT.CUST_EDI_STS_CD ,
              ROWNUM NO
            FROM (
                SELECT /*+ USE_NL(A D) */ A.VVD,
                      A.BKG_NO,
                      A.CNTR_NO,
                      A.POR_CD,
                      A.POL_CD,
                      A.POD_CD,
                      A.DEL_CD ,
                      A.A_EDI_STS_CD ,
                      D.ACT_DT ,
                      A.COP_NO,
                      A.BL_NO,
                      A.EDI_GRP_CD,
                      A.TS_PORT,
                      A.RAIL ,
                      D.EDI_SND_KNT,
                      A.CUST_EDI_STS_CD ,
                  MAX(D.EDI_SND_KNT) OVER ( PARTITION BY D.BKG_NO, D.CNTR_NO, D.EDI_STS_CD) MAX_EDI_SND_KNT
                FROM SCE_EDI_SND_RSLT D, A
                WHERE 1=1
                  #if(${cs_grp_id} != '')
                  AND D.EDI_GRP_CD(+) = @[cs_grp_id]
                  #end
                  AND A.EDI_GRP_CD = D.EDI_GRP_CD(+)
                  AND A.BKG_NO = D.BKG_NO(+)
                  AND A.CNTR_NO = D.CNTR_NO(+)
                  AND A.A_EDI_STS_CD = D.EDI_STS_CD(+)
                  AND A.CUST_EDI_STS_CD = D.EDI_SUB_STS_CD(+)
                  #if(${bkg_no_} != '' )
                  AND (A.BKG_NO) IN (#foreach($ele in ${bkg_no_})
                                      #if($velocityCount == 1) 
                                         '$ele'
                                      #else
                                        ,'$ele'
                                      #end 
                                    #end  )
                  #end
                  #if(${cntr_no_} != '')
                  AND A.CNTR_NO IN (  #foreach($ele in ${cntr_no_})
                                        #if($velocityCount == 1) 
                                            '$ele'
                                        #else
                                            ,'$ele'
                                        #end
                                     #end 
                                      ,'' )
                  #end 
                  #if(${edi_sts} != '')
                  AND (A.A_EDI_STS_CD IN (#foreach($ele in ${edi_sts})
                                                 #if($velocityCount == 1) 
                                                   '$ele'
                                                 #else
                                                  ,'$ele'
                                                 #end 
                                              #end  )
                   OR A.A_EDI_STS_CD IS NULL)
                 #end 
                ) RSLT
            )
        WHERE 1 = 1
          AND KNT = M_KNT
          OR KNT IS NULL
        GROUP BY VVD, BKG_NO, CNTR_NO, POR_CD, POL_CD, POD_CD, DEL_CD , COP_NO, BL_NO, TS_PORT, RAIL
        ORDER BY VVD, BKG_NO, CNTR_NO ) L ) M
--WHERE NO BETWEEN ${v_startpart} AND ${v_endpart}			]]></sql>
			<params>
				<param name="cs_grp_id" type="12" value="" out="N"/>
				<param name="fm_dt" type="12" value="" out="N"/>
				<param name="to_dt" type="12" value="" out="N"/>
				<param name="poletddate1_hidden" type="12" value="" out="N"/>
				<param name="poletddate2_hidden" type="12" value="" out="N"/>
				<param name="podetadate1_hidden" type="12" value="" out="N"/>
				<param name="podetadate2_hidden" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
