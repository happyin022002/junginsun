<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TESCommonDBDAOSearchCntrBkgNoRSQL">
			<desc><![CDATA[* 2011.08.08 윤태승 [CHM-201111118-1] MR Invoice Creation & Correction 의 Manual input 보완
* 2011.11.21 윤태승 [CHM-201111118-1] MR Invoice Creation & Correction 의 Manual input 보완]]></desc>
			<sql><![CDATA[
SELECT NVL(
(SELECT 
    CASE
    WHEN NVL(COUNT(C.CNTR_NO) OVER (), 0) > 0
    THEN 'Y'
    ELSE 'N'
    END 
    || '|' || C.CNTR_TPSZ_CD || '|' ||
    CASE
    WHEN NVL(COUNT(C.CNTR_NO) OVER (), 0) > 0
    THEN (
            SELECT 
            CASE
            WHEN X.BKG_NO IS NOT NULL THEN X.BKG_NO
            WHEN Y.BKG_NO IS NOT NULL THEN Y.BKG_NO
            WHEN C.BKG_NO IS NOT NULL THEN C.BKG_NO
            ELSE ''
            END BKG_NO
            FROM MST_CONTAINER C, 
            (
                    SELECT DISTINCT X.BKG_NO, X.CNTR_NO FROM (
                    SELECT 
                        L.BKG_NO, L.CNTR_NO, DENSE_RANK() OVER (PARTITION BY L.CNTR_NO ORDER BY L.WORK_DT_DIFF ASC) DIFF_RANK 
                    FROM (
                        SELECT 
                        ABS(V.VPS_ETB_DT - TO_DATE(REPLACE(@[atb_dt],'-',''),'YYYYMMDD')) WORK_DT_DIFF,
                        DECODE(B.BKG_CGO_TP_CD,'F','F','B','F','R','R','M') FM, B.POL_CD POL,
                        B.BKG_STS_CD, BV.BKG_NO, BV.VSL_CD||BV.SKD_VOY_NO||BV.SKD_DIR_CD VVD, C.CNTR_NO, G.ORG_NOD_CD, 
                        V.VPS_ETB_DT, M.CNTR_TPSZ_CD, H.COP_NO, G.PCTL_NO, G.PCTL_SEQ,
                        MIN(( SELECT MAX(PCTL_SEQ)
                        	  FROM   SCE_COP_HDR HD, PRD_PROD_CTL_ROUT_DTL GD
                        	  WHERE  H.CNTR_NO  = HD.CNTR_NO
                        	  AND    HD.PCTL_NO = GD.PCTL_NO
                        	  AND    H.BKG_NO   = HD.BKG_NO
                        	  AND    GD.NOD_LNK_DIV_CD = 'L'
                        	  AND    GD.PCTL_SEQ < G.PCTL_SEQ )) R_SEQ,
                        MAX(( SELECT MIN(PCTL_SEQ)
                        	  FROM   SCE_COP_HDR OD, PRD_PROD_CTL_ROUT_DTL OG
                        	  WHERE  OD.CNTR_NO = H.CNTR_NO
                        	  AND    OD.BKG_NO  = H.BKG_NO
                        	  AND    OD.PCTL_NO = OG.PCTL_NO
                        	  AND    OG.NOD_LNK_DIV_CD = 'L'
                        	  AND    OG.PCTL_SEQ > G.PCTL_SEQ )) O_SEQ
                        FROM BKG_BOOKING B, BKG_VVD BV, BKG_CONTAINER C, 
                             SCE_COP_HDR H, PRD_PROD_CTL_ROUT_DTL G, VSK_VSL_PORT_SKD V, MST_CONTAINER M
                        WHERE 1=1
                        AND    B.BKG_NO  = BV.BKG_NO
                        AND    B.BKG_STS_CD IN ('F','W')
                        AND    BV.BKG_NO = C.BKG_NO
                        AND    C.CNTR_NO = H.CNTR_NO
                        AND    BV.BKG_NO = H.BKG_NO
                        AND    H.COP_STS_CD <> 'X'
                        AND    H.PCTL_NO = G.PCTL_NO(+)
                        AND    G.NOD_LNK_DIV_CD(+) = 'N'
                        AND    SUBSTR(G.ORG_NOD_CD,1,5) = SUBSTR(@[yd_cd],1,5)
                        AND    BV.SKD_VOY_NO    = V.SKD_VOY_NO
                        AND    BV.SKD_VOY_NO    = V.SKD_VOY_NO
                        AND    BV.SKD_DIR_CD    = V.SKD_DIR_CD
                        AND    LENGTH(@[vvd]) = 9 
                        AND    SUBSTR(@[vvd],1,4) <> 'CNTC'
                        AND    V.VSL_CD         = SUBSTR(@[vvd],1,4)
                        AND    V.SKD_VOY_NO     = SUBSTR(@[vvd],5,4)
                        AND    V.SKD_DIR_CD     = SUBSTR(@[vvd],9,1)
                        AND    C.CNTR_NO        = M.CNTR_NO(+)
                        AND    C.CNTR_NO        = @[cntr_no]
                        GROUP BY B.BKG_CGO_TP_CD, B.BKG_STS_CD, B.POL_CD, BV.BKG_NO, BV.VSL_CD||BV.SKD_VOY_NO||BV.SKD_DIR_CD, C.CNTR_NO, 
                            G.ORG_NOD_CD, V.VPS_ETB_DT, M.CNTR_TPSZ_CD, H.COP_NO, G.PCTL_NO, G.PCTL_SEQ
                        ) L, PRD_PROD_CTL_ROUT_DTL R, PRD_PROD_CTL_ROUT_DTL O
                    WHERE 1=1
                    AND    L.PCTL_NO           = R.PCTL_NO(+)
                    AND    R.NOD_LNK_DIV_CD(+) = 'L'
                    AND    L.R_SEQ             = R.PCTL_SEQ(+)
                    AND    L.PCTL_NO           = O.PCTL_NO(+)
                    AND    O.NOD_LNK_DIV_CD(+) = 'L'
                    AND    L.O_SEQ             = O.PCTL_SEQ(+) 
                    AND    NVL(@[io_bnd_cd],'N')    = DECODE(L.FM,'M',DECODE(SUBSTR(@[yd_cd],1,5),L.POL,'O','I'),
                                                    DECODE(NVL(R.TRSP_MOD_CD,'N')||NVL(O.TRSP_MOD_CD,'N'),
                                                    		'WDTD','I',     'WDRD','I',     'VDTD','I',
                                                    		'VDRD','I',     'RDWD','O',     'RDVD','O',
                                                    		'TDWD','O',     'TDVD','O',     'WDN','I',
                                                    		'VDN','I',      'NVD','O',      'NWD','O',
                                                    		'WDVD',DECODE(L.VVD,R.VSL_CD||R.SKD_VOY_NO||R.SKD_DIR_CD,'I','O'),
                                                    		'VDWD',DECODE(L.VVD,R.VSL_CD||R.SKD_VOY_NO||R.SKD_DIR_CD,'I','O'),
                                                    		'WDWD',DECODE(L.VVD,R.VSL_CD||R.SKD_VOY_NO||R.SKD_DIR_CD,'I','O'),
                                                    		'VDVD',DECODE(L.VVD,R.VSL_CD||R.SKD_VOY_NO||R.SKD_DIR_CD,'I','O')))   
                    ) X 
                    WHERE DIFF_RANK = 1
                    AND    ROWNUM = 1
                    UNION ALL
                    SELECT DISTINCT B.BKG_NO, M.CNTR_NO
                    FROM   CTM_MOVEMENT M, BKG_BOOKING B
                    WHERE  M.BKG_NO      = B.BKG_NO(+)
                    AND    M.ORG_YD_CD   = @[yd_cd]
                    AND    M.CNTR_NO     = @[cntr_no]
                    AND    M.CNMV_EVNT_DT > TO_DATE(REPLACE(@[atb_dt],'-',''),'YYYYMMDD') - 7
                    AND    M.CNMV_EVNT_DT < TO_DATE(REPLACE(@[atb_dt],'-',''),'YYYYMMDD') + 7
                    AND    M.MVMT_STS_CD = DECODE(@[io_bnd_cd],'I','VD','VL')
                    AND    M.FCNTR_FLG = 'Y' -- FULL CNTR
                    AND    B.BKG_STS_CD IN ('F','W')
                    AND    LENGTH(@[vvd]) = 9 
                    AND    SUBSTR(@[vvd],1,4) = 'CNTC'
                    AND    ROWNUM = 1    
            ) X,
            (
                    SELECT  DISTINCT B.BKG_NO, C.CNTR_NO
                    FROM	BKG_BOOKING B, BKG_CONTAINER C
                    WHERE	B.BKG_NO   = C.BKG_NO
                    AND		C.CNTR_NO  = NVL(@[cntr_no],'')
                    AND		B.BKG_STS_CD IN ('F','W') 
                    AND     C.CRE_DT BETWEEN TO_DATE(REPLACE(@[atb_dt],'-',''),'YYYYMMDD') - 7 AND TO_DATE(REPLACE(@[atb_dt],'-',''),'YYYYMMDD') + 7
                    AND     ROWNUM = 1    
            ) Y
            WHERE 1=1
            AND C.CNTR_NO = X.CNTR_NO(+)
            AND C.CNTR_NO = Y.CNTR_NO(+)
            AND C.CNTR_NO = @[cntr_no]    
    ) 
    WHEN C.BKG_NO IS NOT NULL THEN C.BKG_NO       
    ELSE ''
    END CNTR_CHK
FROM MST_CONTAINER C
WHERE C.CNTR_NO = @[cntr_no])
,'N') CNTR_CHK FROM DUAL			]]></sql>
			<params>
				<param name="atb_dt" type="12" value="" out="N"/>
				<param name="yd_cd" type="12" value="" out="N"/>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="cntr_no" type="12" value="" out="N"/>
				<param name="io_bnd_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
