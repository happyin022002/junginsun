<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CanalTransitFeeInvoiceBCDBDAOsearchCanalTzFeeInvDtlByVvdOwnerAccountRSQL">
			<desc><![CDATA[OA 계정만 가져오기]]></desc>
			<sql><![CDATA[
SELECT   RQST_AMT AS CREDITS,
            T1.VNDR_SEQ, 
            T1.PSO_BZTP_CD,
            T1.VSL_CD,
            T1.SKD_VOY_NO,
            T1.SKD_DIR_CD,
            T1.YD_CD,
            T1.CALL_SEQ,
            ( SELECT SUM(RQST_AMT)
                FROM PSO_CNL_TZ_FEE A, PSO_CNL_TZ_FEE_DTL B
               WHERE A.VSL_CD         = substr(@[vvd], 1, 4)
                 AND A.SKD_VOY_NO     = substr(@[vvd], 5, 4)
                 AND A.SKD_DIR_CD     = substr(@[vvd], 9, 1)
                 AND A.YD_CD          = @[yd_cd]
                 AND A.CALL_SEQ       < @[call_seq]                   
                 AND A.CNL_TZ_BZTP_CD = 'I'
                 AND A.VSL_CD         =  B.VSL_CD
                 AND A.SKD_VOY_NO     =  B.SKD_VOY_NO
                 AND A.SKD_DIR_CD     =  B.SKD_DIR_CD
                 AND A.YD_CD          =  B.YD_CD
                 AND A.PSO_BZTP_CD    = '5'
                 AND A.PSO_BZTP_CD    = B.PSO_BZTP_CD
                 AND B.LGS_COST_CD    LIKE 'CNOW%' ) LAST_INV,
               REPLACE(( SELECT WM_CONCAT ( C.INV_NO ||' '|| B.LGS_COST_CD ||' '||B.RQST_AMT ||' '|| B.DIFF_RMK)
                FROM PSO_CNL_TZ_FEE A, PSO_CNL_TZ_FEE_DTL B, PSO_CHARGE C
               WHERE A.VSL_CD         =  substr(@[vvd], 1, 4)
                 AND A.SKD_VOY_NO     =  substr(@[vvd], 5, 4)
                 AND A.SKD_DIR_CD     =  substr(@[vvd], 9, 1)
                 AND A.YD_CD          =  @[yd_cd]
                 AND A.CALL_SEQ       <  @[call_seq]
                 AND A.CNL_TZ_BZTP_CD = 'I'
                 AND A.VSL_CD         =  B.VSL_CD
                 AND A.SKD_VOY_NO     =  B.SKD_VOY_NO
                 AND A.SKD_DIR_CD     =  B.SKD_DIR_CD
                 AND A.YD_CD          =  B.YD_CD
                 AND A.PSO_BZTP_CD    = '5'
                 AND A.PSO_BZTP_CD    = B.PSO_BZTP_CD
                 AND A.ISS_CTY_CD     = C.ISS_CTY_CD
                 AND A.SO_SEQ         = C.SO_SEQ 
                 AND B.LGS_COST_CD    LIKE 'CNOW%'  ),',','\\n')  INV_DESC,
            C1.LGS_COST_CD,
            C1.LGS_COST_FULL_NM,
            T2.DIFF_RMK,
            RQST_AMT AS CALC_AMT,
            T2.YD_CHG_NO,
            T2.YD_CHG_VER_SEQ,
            T1.VSL_CD||T1.SKD_VOY_NO||T1.SKD_DIR_CD VVD,
           ( SELECT COUNT(*)
            FROM PSO_CNL_TZ_ATCH_FILE X
           WHERE X.VSL_CD         = substr(@[vvd], 1, 4)
             AND X.SKD_VOY_NO     = substr(@[vvd], 5, 4)
             AND X.SKD_DIR_CD     = substr(@[vvd], 9, 1)
             AND X.YD_CD          = @[yd_cd]
             AND X.CALL_SEQ       =  T1.CALL_SEQ
	         AND X.LGS_COST_CD     = T2.LGS_COST_CD
              AND X.LGS_COST_CD    IS NOT NULL
           ) AS ATCH_FILE_NO,
           ( SELECT COUNT(*)
              FROM PSO_CNL_TZ_ATCH_FILE X
             WHERE X.VSL_CD          = substr(@[vvd], 1, 4)
                AND X.SKD_VOY_NO     = substr(@[vvd], 5, 4)
                AND X.SKD_DIR_CD     = substr(@[vvd], 9, 1)
                AND X.YD_CD          = @[yd_cd]
                AND X.CALL_SEQ       = T1.CALL_SEQ
                AND X.LGS_COST_CD    IS NULL
             ) AS INV_ATCH_FILE_NO
    FROM PSO_CNL_TZ_FEE T1,
         PSO_CNL_TZ_FEE_DTL T2,
         TES_LGS_COST C1
  WHERE T1.PSO_BZTP_CD       = T2.PSO_BZTP_CD
     AND T1.VSL_CD           = T2.VSL_CD
     AND T1.SKD_VOY_NO       = T2.SKD_VOY_NO
     AND T1.SKD_DIR_CD       = T2.SKD_DIR_CD
     AND T1.YD_CD            = T2.YD_CD
     AND T1.CALL_SEQ         = T2.CALL_SEQ
     AND T2.LGS_COST_CD      = C1.LGS_COST_CD
     AND T1.PSO_BZTP_CD      = '5'
     AND T1.YD_CD            = @[yd_cd]
     AND T1.CNL_TZ_BZTP_CD   = 'I'
     AND T1.NTC_YRMON        = @[rev_yrmon]
     AND T1.VSL_CD           = substr(@[vvd], 1, 4)
     AND T1.SKD_VOY_NO       = substr(@[vvd], 5, 4)
     AND T1.SKD_DIR_CD       = substr(@[vvd], 9, 1)
     AND T2.LGS_COST_CD      LIKE 'CNOW%'
ORDER BY lgs_cost_cd			]]></sql>
			<params>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="yd_cd" type="12" value="" out="N"/>
				<param name="call_seq" type="12" value="" out="N"/>
				<param name="rev_yrmon" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
