<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ActualScheduleMgtDBDAOCheckPreCallingPortInfoRSQL">
			<desc><![CDATA[특정 포트에 입력될 ATA(Actual Time of Arrival)에 대해
그 이전 포트의 ATD(Actual Time of Departure)와 비교하여
ATA가 이후 시간인지 체크한다.
---------------------------------------------------------------------------
Ticket ID : CHM-201112897-01
개발자 : 진마리아
Title : [VOP-VSK] Terminal EDI 변경 요청건
Desc. :
1. Actual SKD 수신 시 수행하는 이전 포트와의 SKD 연속성 검증 로직에서 이전 포트가 Skip 인 경우는 그 이전 포트와 검증하도록 변경
2. Voyage No, Direction Code가 ALPS VVD와 일치하지 않아 Actual SKD 을 이용하여 VVD를 찾는 경우, Call Sign No., IMU No. 를 이용하여 Vessel Code를 찾도록 로직 변경
]]></desc>
			<sql><![CDATA[
SELECT 		CASE 	WHEN TO_DATE(@[act_arr_dt], 'YYYYMMDDHH24MI') - PRE_ETD_DT > 0 THEN 'Y'
         			ELSE 'N'
       		END 	AS CHK_FLG
FROM   		(
			SELECT 		NVL((	SELECT 	S1.VPS_ETD_DT
                        		FROM   	VSK_VSL_PORT_SKD 	S1
                        		WHERE  	VSL_CD 				= T1.VSL_CD
                        		AND    	SKD_VOY_NO 			= CASE	WHEN T1.SEQ = '1' THEN T1.TURN_SKD_VOY_NO
                                              						ELSE T1.SKD_VOY_NO
                                              				  END
                        		AND    	SKD_DIR_CD 			= CASE	WHEN T1.SEQ = '1' THEN T1.TURN_SKD_DIR_CD
                                              						ELSE T1.SKD_DIR_CD
                                              				  END
                        		AND    	CLPT_SEQ 			= CASE	WHEN T1.SEQ = '1' THEN (SELECT MAX(CLPT_SEQ)
                                                                    						FROM   VSK_VSL_PORT_SKD
                                                                    						WHERE  VSL_CD					= T1.VSL_CD
                                                                    						AND    SKD_VOY_NO 				= T1.TURN_SKD_VOY_NO
                                                                    						AND    SKD_DIR_CD 				= T1.TURN_SKD_DIR_CD
                                                                    						AND    TURN_PORT_IND_CD 		NOT IN ('D', 'V', 'F')
                                                                    						AND    NVL(SKD_CNG_STS_CD, 'X') <> 'S'
																							)
                                            						ELSE T1.PRE_CLPT_SEQ
                                            				  END )
							, TO_DATE('19000101', 'YYYYMMDD')
						) 	  AS PRE_ETD_DT
        	FROM   		(	  SELECT 	ROW_NUMBER()	OVER(PARTITION BY VSL_CD ORDER BY CLPT_SEQ) SEQ
									,	LAG(CLPT_SEQ) 	OVER(PARTITION BY VSL_CD ORDER BY CLPT_SEQ) PRE_CLPT_SEQ
                       				, 	T1.*
                			  FROM   	VSK_VSL_PORT_SKD T1
                			  WHERE  	VSL_CD 				  	 = @[vsl_cd]
                			  AND    	SKD_VOY_NO 			  	 = @[skd_voy_no]
                			  AND    	SKD_DIR_CD 			  	 = @[skd_dir_cd]
                			  AND    	NVL(SKD_CNG_STS_CD, 'X') <> 'S'
						) T1
			WHERE  		VSL_CD 			= @[vsl_cd]
			AND    		SKD_VOY_NO 		= @[skd_voy_no]
			AND    		SKD_DIR_CD 		= @[skd_dir_cd]
			AND    		VPS_PORT_CD 	= @[vps_port_cd]
			AND    		CLPT_IND_SEQ 	= @[clpt_ind_seq] 
			)			]]></sql>
			<params>
				<param name="act_arr_dt" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="vps_port_cd" type="12" value="" out="N"/>
				<param name="clpt_ind_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
