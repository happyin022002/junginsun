<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="OptimizeddistancemgtDBDAOSearchOptimizedDistanceRSQL">
			<desc><![CDATA[해당 Port에 따른 Optimized Distance 정보를 조회합니다.]]></desc>
			<sql><![CDATA[
SELECT   H.FM_YD_CD
      ,  H.FM_YD_GRP_ID AS FM_YD_GRP_CD
	  ,  H.FM_YD_CD     AS SHEET_FM_PORT_CD  
	  ,  H.FM_YD_GRP_ID AS SHEET_FM_YD_GRP_CD
	  ,  H.TO_YD_CD     AS SHEET_TO_PORT_CD
      ,  H.TO_YD_GRP_ID AS SHEET_TO_YD_GRP_CD
	  ,  H.TO_YD_GRP_ID AS PRE_SHEET_TO_YD_GRP_CD
	  ,  H.FM_YD_GRP_ID AS PRE_SHEET_FM_YD_GRP_CD
      ,  D.GMT_TD_HRS
      ,  D.STND_DIST  
      ,  H.OPMZ_DIST  
      ,  (
            SELECT   AVG(DISTINCT O.PORT_TO_PORT_MLG_DIST)
            FROM      (
                      SELECT  MM.VSL_CD, MM.SKD_VOY_NO, MM.SKD_DIR_CD, MM.DEP_PORT_CD, MM.ARR_PORT_CD, MM.PORT_TO_PORT_MLG_DIST, H.FM_YD_GRP_ID, H.TO_YD_GRP_ID
                             , MM.FM_YD_GRP_ID_2, MM.TO_YD_GRP_ID_2
                             , DECODE(H.FM_YD_GRP_ID,'All', 'All', 'A', FM_YD_GRP_ID_2, 'B', FM_YD_GRP_ID_2) AS FM_YD_GRP_ID_3      
                             , DECODE(H.TO_YD_GRP_ID, 'All', 'All', 'A', TO_YD_GRP_ID_2, 'B',TO_YD_GRP_ID_2) AS TO_YD_GRP_ID_3
                       FROM(       
                               SELECT    P.VSL_CD, P.SKD_VOY_NO, P.SKD_DIR_CD, P.DEP_PORT_CD, P.ARR_PORT_CD, P.PORT_TO_PORT_MLG_DIST
                                          , H.FM_YD_GRP_ID, H.TO_YD_GRP_ID
                                          , FM_PC.YD_GRP_ID AS FM_YD_GRP_ID_2
                                          , TO_PC.YD_GRP_ID AS TO_YD_GRP_ID_2
                                          
                                FROM      VSK_PASG_PLN_RPT P 
                                        , MDM_VSL_CNTR     VC
                                        ,( SELECT   PS.VSL_CD
                                                    ,PS.SKD_VOY_NO
                                                    ,PS.SKD_DIR_CD
                                                    ,PS.VPS_PORT_CD
                                                    ,PS.YD_CD
                                                    ,NVL(YG.YD_GRP_ID,'All') as YD_GRP_ID
                                           FROM     VSK_VSL_PORT_SKD PS
                                                    , VSK_YD_GRP       YG
                                           WHERE PS.YD_CD = YG.YD_CD (+) ) FM_PC        
                                        ,( SELECT   PS.VSL_CD 
                                                    ,PS.SKD_VOY_NO
                                                    ,PS.SKD_DIR_CD
                                                    ,PS.VPS_PORT_CD
                                                    ,PS.YD_CD
                                                    ,NVL(YG.YD_GRP_ID,'All') as  YD_GRP_ID
                                           FROM     VSK_VSL_PORT_SKD PS
                                                    , VSK_YD_GRP       YG
                                           WHERE PS.YD_CD = YG.YD_CD(+) ) TO_PC
                                           ,VSK_PORT_OPMZ_DIST       H
                                WHERE 1=1
                                AND P.VSL_CD            = VC.VSL_CD
                                AND P.VSL_CD            = FM_PC.VSL_CD (+)
                                AND P.SKD_VOY_NO        = FM_PC.SKD_VOY_NO (+)
                                AND P.SKD_DIR_CD        = FM_PC.SKD_DIR_CD  (+)
                                AND P.DEP_PORT_CD       = FM_PC.VPS_PORT_CD (+)
                                AND P.VSL_CD            = TO_PC.VSL_CD      (+)
                                AND P.SKD_VOY_NO        = TO_PC.SKD_VOY_NO (+)
                                AND P.SKD_DIR_CD        = TO_PC.SKD_DIR_CD  (+)
                                AND P.ARR_PORT_CD       = TO_PC.VPS_PORT_CD (+)
                                AND P.DEP_PORT_CD       = SUBSTR(H.FM_YD_CD,1,5) 
                                AND P.ARR_PORT_CD       = SUBSTR(H.TO_YD_CD,1,5)
                                AND P.PORT_TO_PORT_MLG_DIST BETWEEN H.RNG_MIN_DIST AND DECODE(H.RNG_MAX_DIST,NULL,99999,0,99999,H.RNG_MAX_DIST)
                                AND P.PASG_PLN_DT BETWEEN TO_DATE(@[fm_date],'YYYY-MM-DD') AND TO_DATE(@[to_date],'YYYY-MM-DD')+0.99999
                                ) MM    
                                ,VSK_PORT_OPMZ_DIST       H                
                        WHERE   1=1
                        AND     MM.DEP_PORT_CD       = H.FM_YD_CD
                        AND     MM.ARR_PORT_CD       = H.TO_YD_CD
                        ) O
            WHERE   1=1
            AND     O.DEP_PORT_CD       = H.FM_YD_CD
            AND     O.ARR_PORT_CD       = H.TO_YD_CD
            AND     O.FM_YD_GRP_ID_3    = H.FM_YD_GRP_ID
            AND     O.TO_YD_GRP_ID_3    = H.TO_YD_GRP_ID

		  ) AS VMS_AVG_DIST 
      ,  (
            SELECT   MIN(DISTINCT O.PORT_TO_PORT_MLG_DIST)
            FROM      (
                      SELECT  MM.VSL_CD, MM.SKD_VOY_NO, MM.SKD_DIR_CD, MM.DEP_PORT_CD, MM.ARR_PORT_CD, MM.PORT_TO_PORT_MLG_DIST, H.FM_YD_GRP_ID, H.TO_YD_GRP_ID
                             , MM.FM_YD_GRP_ID_2, MM.TO_YD_GRP_ID_2
                             , DECODE(H.FM_YD_GRP_ID,'All', 'All', 'A', FM_YD_GRP_ID_2, 'B', FM_YD_GRP_ID_2) AS FM_YD_GRP_ID_3      
                             , DECODE(H.TO_YD_GRP_ID, 'All', 'All', 'A', TO_YD_GRP_ID_2, 'B',TO_YD_GRP_ID_2) AS TO_YD_GRP_ID_3
                       FROM(       
                               SELECT    P.VSL_CD, P.SKD_VOY_NO, P.SKD_DIR_CD, P.DEP_PORT_CD, P.ARR_PORT_CD, P.PORT_TO_PORT_MLG_DIST
                                          , H.FM_YD_GRP_ID, H.TO_YD_GRP_ID
                                          , FM_PC.YD_GRP_ID AS FM_YD_GRP_ID_2
                                          , TO_PC.YD_GRP_ID AS TO_YD_GRP_ID_2
                                          
                                FROM      VSK_PASG_PLN_RPT P 
                                        , MDM_VSL_CNTR     VC
                                        ,( SELECT   PS.VSL_CD
                                                    ,PS.SKD_VOY_NO
                                                    ,PS.SKD_DIR_CD
                                                    ,PS.VPS_PORT_CD
                                                    ,PS.YD_CD
                                                    ,NVL(YG.YD_GRP_ID,'All') as YD_GRP_ID
                                           FROM     VSK_VSL_PORT_SKD PS
                                                    , VSK_YD_GRP       YG
                                           WHERE PS.YD_CD = YG.YD_CD (+) ) FM_PC        
                                        ,( SELECT   PS.VSL_CD 
                                                    ,PS.SKD_VOY_NO
                                                    ,PS.SKD_DIR_CD
                                                    ,PS.VPS_PORT_CD
                                                    ,PS.YD_CD
                                                    ,NVL(YG.YD_GRP_ID,'All') as  YD_GRP_ID
                                           FROM     VSK_VSL_PORT_SKD PS
                                                    , VSK_YD_GRP       YG
                                           WHERE PS.YD_CD = YG.YD_CD(+) ) TO_PC
                                           ,VSK_PORT_OPMZ_DIST       H
                                WHERE 1=1
                                AND P.VSL_CD            = VC.VSL_CD
                                AND P.VSL_CD            = FM_PC.VSL_CD (+)
                                AND P.SKD_VOY_NO        = FM_PC.SKD_VOY_NO (+)
                                AND P.SKD_DIR_CD        = FM_PC.SKD_DIR_CD  (+)
                                AND P.DEP_PORT_CD       = FM_PC.VPS_PORT_CD (+)
                                AND P.VSL_CD            = TO_PC.VSL_CD      (+)
                                AND P.SKD_VOY_NO        = TO_PC.SKD_VOY_NO (+)
                                AND P.SKD_DIR_CD        = TO_PC.SKD_DIR_CD  (+)
                                AND P.ARR_PORT_CD       = TO_PC.VPS_PORT_CD (+)
                                AND P.DEP_PORT_CD       = SUBSTR(H.FM_YD_CD,1,5) 
                                AND P.ARR_PORT_CD       = SUBSTR(H.TO_YD_CD,1,5)
                                AND P.PORT_TO_PORT_MLG_DIST BETWEEN H.RNG_MIN_DIST AND DECODE(H.RNG_MAX_DIST,NULL,99999,0,99999,H.RNG_MAX_DIST)
                                AND P.PASG_PLN_DT BETWEEN TO_DATE(@[fm_date],'YYYY-MM-DD') AND TO_DATE(@[to_date],'YYYY-MM-DD')+0.99999
                                ) MM    
                                ,VSK_PORT_OPMZ_DIST       H                
                        WHERE   1=1
                        AND     MM.DEP_PORT_CD       = H.FM_YD_CD
                        AND     MM.ARR_PORT_CD       = H.TO_YD_CD
                        ) O
            WHERE   1=1
            AND     O.DEP_PORT_CD       = H.FM_YD_CD
            AND     O.ARR_PORT_CD       = H.TO_YD_CD
            AND     O.FM_YD_GRP_ID_3    = H.FM_YD_GRP_ID
            AND     O.TO_YD_GRP_ID_3    = H.TO_YD_GRP_ID
		) AS VMS_SHTG_DIST
      ,  H.RNG_MAX_DIST
      ,  H.RNG_MIN_DIST
      ,  H.UPD_USR_ID
      ,  TO_CHAR (H.UPD_DT, 'YYYY-MM-DD HH24:MI') AS UPD_DT
      ,  H.FILE_NM
      ,  H.FILE_SAV_ID 
FROM     VSK_PORT_OPMZ_DIST       H
      ,  VSK_PORT_DIST            D
#if (${vsl_slan_cd} != '')
      ,  (
            SELECT  D.VSL_SLAN_CD
            , D.PF_SVC_TP_CD
            , D.SKD_DIR_CD
            , T4.VSL_SLAN_DIR_SEQ
            , D.PORT_ROTN_SEQ
            , D.PORT_CD AS FM_PORT_CD
            , LEAD(D.PORT_CD  ) OVER (PARTITION BY D.VSL_SLAN_CD ORDER BY T4.VSL_SLAN_DIR_SEQ, D.PORT_ROTN_SEQ)        AS TO_PORT_CD
            FROM    VSK_PF_SKD M
                    , VSK_PF_SKD_DTL D
                    , MDM_VSL_SVC_LANE_DIR T4
                    , MDM_VSL_SVC_LANE T5
            WHERE   1=1
            AND     M.VSL_SLAN_CD = D.VSL_SLAN_CD
            AND     M.PF_SVC_TP_CD = D.PF_SVC_TP_CD
            AND     M.SLAN_STND_FLG = 'Y'
            AND     D.VSL_SLAN_CD      = T4.VSL_SLAN_CD
            AND     D.SKD_DIR_CD    = T4.VSL_SLAN_DIR_CD
            AND     D.VSL_SLAN_CD      = T5.VSL_SLAN_CD
        
        --AND     D.TURN_PORT_IND_CD NOT IN ('D', 'V', 'F')
        AND     M.VSL_SLAN_CD = @[vsl_slan_cd]
        ORDER BY    D.VSL_SLAN_CD, T4.VSL_SLAN_DIR_SEQ, D.PORT_ROTN_SEQ   
        ) X
#end      
WHERE    1=1
AND      SUBSTR(H.FM_YD_CD,1,5) = D.FM_LOC_CD (+)
AND      SUBSTR(H.TO_YD_CD,1,5) = D.TO_LOC_CD (+)

#if (${vsl_slan_cd} == '' && ${fm_port_cd} != '')
AND      H.FM_YD_CD LIKE @[fm_port_cd]||'%'
#end

#if (${vsl_slan_cd} != '')
AND      D.FM_LOC_CD    = X.FM_PORT_CD (+)
AND      D.TO_LOC_CD    = X.TO_PORT_CD (+)
AND      X.VSL_SLAN_CD = @[vsl_slan_cd]
ORDER BY X.VSL_SLAN_DIR_SEQ, X.PORT_ROTN_SEQ
#end

#if (${vsl_slan_cd} == '' && ${to_port_cd} != '')
AND      H.TO_YD_CD LIKE @[to_port_cd]||'%'
#end

#if (${vsl_slan_cd} == '' && ${fm_yd_grp_cd} != 'All')
AND      H.FM_YD_GRP_ID = @[fm_yd_grp_cd]
#end

#if (${vsl_slan_cd} == '' && ${to_yd_grp_cd} != ''&& ${to_yd_grp_cd} != 'All')
AND      H.TO_YD_GRP_ID = @[to_yd_grp_cd]
#end			]]></sql>
			<params>
				<param name="fm_date" type="12" value="" out="N"/>
				<param name="to_date" type="12" value="" out="N"/>
				<param name="vsl_slan_cd" type="12" value="" out="N"/>
				<param name="fm_port_cd" type="12" value="" out="N"/>
				<param name="to_port_cd" type="12" value="" out="N"/>
				<param name="fm_yd_grp_cd" type="12" value="" out="N"/>
				<param name="to_yd_grp_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
