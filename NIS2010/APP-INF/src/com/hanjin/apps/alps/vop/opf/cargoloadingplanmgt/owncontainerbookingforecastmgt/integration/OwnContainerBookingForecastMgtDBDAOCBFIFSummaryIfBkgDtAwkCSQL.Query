<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="OwnContainerBookingForecastMgtDBDAOCBFIFSummaryIfBkgDtAwkCSQL">
			<desc><![CDATA[OwnContainerBookingForecastMgtDBDAOCBFIFSummaryIfBkgDtAwk]]></desc>
			<sql><![CDATA[
INSERT INTO OPF_CGO_BKG_FCAST_SPCL_SMRY ( VSL_CD
                                        , SKD_VOY_NO
                                        , SKD_DIR_CD
                                        , YD_CD
                                        , POL_CLPT_IND_SEQ
                                        , CRR_CD
                                        , POD_CD
                                        , BLCK_STWG_CD
                                        , CBF_SPCL_SMRY_SEQ
                                        , CNTR_TPSZ_CD
                                        , AWK_CGO_FLG
                                        , FWRD_OVR_DIM_LEN
                                        , BKWD_OVR_DIM_LEN
                                        , LF_SD_OVR_DIM_LEN
                                        , RT_SD_OVR_DIM_LEN
                                        , HGT_OVR_DIM_LEN
                                        , STWG_CD
                                        , CRN_PST_STS_CD
                                        , CNTR_QTY
                                        , CRE_USR_ID
                                        , CRE_DT
                                        , UPD_USR_ID
                                        , UPD_DT
                                        , PRCT_FLG
                                        )
  SELECT  @[vsl_cd]
        , @[skd_voy_no]
        , @[skd_dir_cd]
        , @[pol_cd]
        , @[pol_clpt_ind_seq]
        , 'SML'
        , POD_CD
        , SUBSTR(MLB,3,5)
        , CBF_SPCL_SMRY_SEQ + ROWNUM
        , CNTR_TPSZ_CD
        , 'Y'
        , OVR_FWD
        , OVR_AFT
        , OVR_LFT
        , OVR_RGT
        , OVR_HGT
        , STWG_CD
        , CRN_PST_STS_CD
        , CNTR_QTY
        , @[cre_usr_id]
        , SYSDATE
        , @[upd_usr_id]
        , SYSDATE
        , PRCT_FLG
   FROM (
    SELECT Y.POD_CD,Y.MLB,Y.CNTR_TPSZ_CD, Y.OVR_FWD, Y.OVR_AFT, Y.OVR_LFT,Y.OVR_RGT,Y.OVR_HGT, Y.STWG_CD, Y.CRN_PST_STS_CD, SUM(CNTR_VOL_QTY) CNTR_QTY,
      ( SELECT NVL(MAX(CBF_SPCL_SMRY_SEQ),0)
                    FROM OPF_CGO_BKG_FCAST_SPCL_SMRY
                    WHERE VSL_CD   = @[vsl_cd]
                    AND SKD_VOY_NO = @[skd_voy_no]
                    AND SKD_DIR_CD = @[skd_dir_cd]
                    AND YD_CD      = @[pol_cd]
                    AND POL_CLPT_IND_SEQ = @[pol_clpt_ind_seq] ) AS CBF_SPCL_SMRY_SEQ, Y.PRCT_FLG
           FROM ( 
              SELECT DISTINCT X.BKG_NO, X.CNTR_NO, X.POD_CD, X.MLB, X.CNTR_TPSZ_CD, X.OVR_FWD, X.OVR_AFT, X.OVR_LFT,X.OVR_RGT,X.OVR_HGT, X.STWG_CD, 
                     X.CRN_PST_STS_CD, X.PRCT_FLG, CNTR_CHK, CNTR_VOL_QTY
              FROM 
               ( SELECT NVL(BKG.BKG_NO,' ')       BKG_NO,
                        NVL(AWK.CNTR_NO,' ')       CNTR_NO,
                        NVL(VVD.POD_CD,' ')       POD_CD,
                       OPF_BLCK_STWG_CD(VVD.VSL_CD||VVD.SKD_VOY_NO||VVD.SKD_DIR_CD, VVD.POL_YD_CD, VVD.POL_CLPT_IND_SEQ, BKG.BKG_NO) AS MLB,
                       NVL(QTY.CNTR_TPSZ_CD,' ') CNTR_TPSZ_CD,
                       AWK.OVR_FWRD_LEN      OVR_FWD,
                       AWK.OVR_BKWD_LEN      OVR_AFT,
                       AWK.OVR_LF_LEN        OVR_LFT,
                       AWK.OVR_RT_LEN        OVR_RGT,
                       AWK.OVR_HGT           OVR_HGT,
                       NVL(BKG.STWG_CD,' ')                                                       STWG_CD,
                       VVD.VSL_CD,
                       VVD.SKD_VOY_NO,
                       VVD.SKD_DIR_CD,
                       AWK.CRN_PST_STS_CD,
                       BKG.PRCT_FLG,
                       CASE WHEN AWK.CNTR_NO IS NULL THEN  ROWNUM 
                            ELSE 9999
                       END AS CNTR_CHK, 
                       AWK.CNTR_VOL_QTY 
                FROM   BKG_VVD VVD, 
                       BKG_BOOKING BKG, 
                       BKG_QUANTITY QTY, 
                       BKG_AWK_CGO  AWK
                 WHERE VVD.VSL_CD                          = @[vsl_cd]                                                                                                 
                   AND VVD.SKD_VOY_NO                      = @[skd_voy_no]                                                                                            
         	       AND VVD.SKD_DIR_CD                      = @[skd_dir_cd]
                   AND VVD.POL_YD_CD                       = @[pol_cd]
                   AND VVD.POL_CLPT_IND_SEQ                = @[pol_clpt_ind_seq]                                                                              
         	         AND VVD.BKG_NO                          = BKG.BKG_NO   
					#if(${bkg_sts_cd} != 'All')
					AND BKG.BKG_STS_CD = @[bkg_sts_cd]
					#end
                   AND BKG.BKG_STS_CD      <> 'X'
                   AND BKG.BKG_NO          = QTY.BKG_NO(+)
                   AND SUBSTR(QTY.CNTR_TPSZ_CD,1,1) <> 'Q'
                   AND QTY.BKG_NO          = AWK.BKG_NO
                   AND BKG.AWK_CGO_FLG     = 'Y'
                   AND NVL(BKG.STWG_CD,'XX')  <> 'ODFT'
                   AND QTY.CNTR_TPSZ_CD    = AWK.CNTR_TPSZ_CD 
                   AND SUBSTR(QTY.CNTR_TPSZ_CD,1,1) <> 'D'
                   AND NOT EXISTS ( SELECT '*'
                                      FROM BKG_DG_CGO
                                     WHERE BKG_NO = BKG.BKG_NO
                                       AND NVL(CNTR_NO,'') = NVL(AWK.CNTR_NO,'')
                                       AND CNTR_TPSZ_CD    = QTY.CNTR_TPSZ_CD ) ) X
         ) Y
         GROUP BY Y.POD_CD,Y.MLB, Y.CNTR_TPSZ_CD, Y.OVR_FWD, Y.OVR_AFT, Y.OVR_LFT,Y.OVR_RGT,Y.OVR_HGT, Y.STWG_CD,Y.CRN_PST_STS_CD, Y.PRCT_FLG
         ORDER BY Y.MLB )			]]></sql>
			<params>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pol_clpt_ind_seq" type="12" value="" out="N"/>
				<param name="cre_usr_id" type="12" value="" out="N"/>
				<param name="upd_usr_id" type="12" value="" out="N"/>
				<param name="bkg_sts_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
