<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="OwnDangerousCargoApprovalDBDAOScgNonDcgoChemicalRequestListRSQL">
			<desc><![CDATA[NON-DG CHEMICAL]]></desc>
			<sql><![CDATA[
SELECT 
	E.BKG_NO
	, E.BKG_NO_POP
	, E.NON_DCGO_RQST_SEQ
	, E.CNTR_NO
	, E.VSL_CD
	, E.SKD_VOY_NO
	, E.SKD_DIR_CD
	, E.VVD
	, E.SLAN_CD
	, E.CSTMS_DESC
	, E.CNTR_MF_GDS_DESC
	, E.CMDT_DESC
	, E.XTER_RMK
	, E.INTER_RMK
	, E.SPCL_CGO_APRO_CD
	, E.ODEK_FLG
	, E.EML_SND_NO
	, E.EML_SND_NO_POP
	, E.RQST_USR_ID
	, E.RQST_OFC_CD
	, E.RQST_DT
	, E.RQST_GDT
	, E.EML_CTNT
	, E.CRE_USR_ID
	, E.CRE_DT
	, E.UPD_USR_ID
	, E.UPD_DT
	, E.NON_DCGO_KW_SEQ
	, E.NON_DCGO_KW_NM
	, E.POL_CD
	, E.USR_EML
	, E.BKG_DCGO_FLG
	, E.CNTR_DCGO_FLG
	, E.STWG_CD
	, E.POL_ETA_DT
	, E.NEW_CUST_APRO_CMDT_NM
	, E.NEW_CUST_APRO_RMK
	, E.NON_DG_CHEM_FLG
    , E.CMDT_NM
FROM
	(SELECT 
		A.BKG_NO
		, A.BKG_NO AS BKG_NO_POP
		, A.NON_DCGO_RQST_SEQ
		, A.CNTR_NO
		, A.VSL_CD
		, A.SKD_VOY_NO
		, A.SKD_DIR_CD
		, A.VSL_CD|| A.SKD_VOY_NO|| A.SKD_DIR_CD AS VVD
		, A.SLAN_CD
		, A.CSTMS_DESC
		, A.CNTR_MF_GDS_DESC
		, A.CMDT_DESC
		, A.XTER_RMK
		, A.INTER_RMK
		, DECODE(A.SPCL_CGO_APRO_CD,'P','Pass','H','Hold','X','Undeclared') AS SPCL_CGO_APRO_CD
		, DECODE(A.ODEK_FLG,'O','ONDECK','N/A') AS ODEK_FLG
		, DECODE(NVL(A.EML_SND_NO,'N'),'N','N','Y') AS EML_SND_NO
		, 'Send' AS EML_SND_NO_POP
		, A.RQST_USR_ID
		, A.RQST_OFC_CD
		, A.RQST_DT
		, TO_CHAR(A.RQST_GDT,'YYYY-MM-DDHH24:MI:SS') AS RQST_GDT
		, A.EML_CTNT
		, A.CRE_USR_ID
		, A.CRE_DT
		, A.UPD_USR_ID
		, A.UPD_DT
		, '' AS NON_DCGO_KW_SEQ -- 의미 없음 삭제해도됨
		, '' AS NON_DCGO_KW_NM -- 의미 없음
		, B.POL_CD
		, (SELECT USR_EML FROM COM_USER WHERE USR_ID = B.DOC_USR_ID) AS USR_EML
		, B.DCGO_FLG AS BKG_DCGO_FLG
		, NVL((SELECT DCGO_FLG FROM BKG_CONTAINER WHERE BKG_NO = A.BKG_NO AND CNTR_NO = A.CNTR_NO),'N') AS CNTR_DCGO_FLG
		, B.STWG_CD
		,(SELECT TO_CHAR(C.VPS_ETA_DT,'YYYY-MM-DD HH24:MI:SS')
	FROM VSK_VSL_PORT_SKD C
    WHERE 1=1
	    AND C.VSL_CD = A.VSL_CD
	    AND C.SKD_VOY_NO = A.SKD_VOY_NO
	    AND C.SKD_DIR_CD = A.SKD_DIR_CD
	    AND C.VPS_PORT_CD = B.POL_CD
	    AND C.CLPT_IND_SEQ = '1'
	) AS POL_ETA_DT
	, A.NEW_CUST_APRO_CMDT_NM
	, A.NEW_CUST_APRO_RMK
	, A.NON_DG_CHEM_FLG
    , NVL((SELECT CMDT.CMDT_NM FROM MDM_COMMODITY CMDT WHERE B.CMDT_CD = CMDT.CMDT_CD),'') AS CMDT_NM
	FROM SCG_NON_DG_CGO_KW_RQST A LEFT JOIN BKG_BOOKING B
	ON A.BKG_NO = B.BKG_NO
	WHERE A.NON_DG_CHEM_FLG = 'Y'
		AND B.BKG_STS_CD <> 'X'
		-- non_dg_cgo_status START
		#if (${non_dg_cgo_status} == 'R') 
		    AND A.SPCL_CGO_APRO_CD IS NULL
		#else
		    AND A.SPCL_CGO_APRO_CD = @[non_dg_cgo_status]
		#end
		-- non_dg_cgo_status END
		-- SLAN_CD 조건 사용안함 - 로직유지
		#if ($slan_cd.size() > 0) 
		    AND A.SLAN_CD IN ( 
		        #foreach($key IN ${slan_cd}) 
		            #if($velocityCount < $slan_cd.size()) 
		                '$key', 
		            #else 
		                '$key' 
		            #end 
		        #end 
		        )
		#end
		-- RQST_OFC_CD 조건 사용
	    #if ($rqst_ofc_cd.size() > 0) 
			AND	A.RQST_OFC_CD IN ( 
		    	#foreach($key IN ${rqst_ofc_cd}) 
                    #if($velocityCount < $rqst_ofc_cd.size()) 
                        '$key', 
                    #else 
                        '$key' 
                    #end 
                #end 
                )
	    #end

		-- rgn_shp_opr_cd START
		#if (${rgn_shp_opr_cd} != 'ALL') 
		    AND (
		         @[rgn_shp_opr_cd] = 
            (
                SELECT RGN_SHP_OPR_CD FROM SCG_RGN_SHP_OPR_PORT
                WHERE   B.POL_CD = LOC_CD 
                AND     DELT_FLG = 'N'
                AND		RGN_SHP_OPR_CD = @[rgn_shp_opr_cd]
            )
            OR
              @[rgn_shp_opr_cd] = 
            (
                SELECT RGN_SHP_OPR_CD  FROM    SCG_RGN_SHP_OPR_CD
                 WHERE  (  SELECT OFC_N3RD_LVL_CD
                             FROM DMT_OFC_LVL_V
                            WHERE OFC_N8TH_LVL_CD = (SELECT  EQ_CTRL_OFC_CD FROM MDM_LOCATION
                                                      WHERE  NVL(DELT_FLG, 'N') = 'N'
                                                        AND  LOC_CD  =   B.POL_CD)
                    )   IN (RGN_SHP_OPR_RHQ_CD1, RGN_SHP_OPR_RHQ_CD2, RGN_SHP_OPR_RHQ_CD3, RGN_SHP_OPR_RHQ_CD4, RGN_SHP_OPR_RHQ_CD5, RGN_SHP_OPR_RHQ_CD6)
                AND RGN_SHP_OPR_CD 	= @[rgn_shp_opr_cd]
                UNION
                SELECT RGN_SHP_OPR_CD   FROM    SCG_RGN_SHP_OPR_CD
                WHERE   (
						SELECT	DECODE(SYS_AREA_GRP_ID, 'SWA', 'SINRS', 'EUR', 'HAMRU', 'USA', 'NYCRA', 'KOR', 'SHARC', 'CHN', 'SHARC')
                        FROM	COM_SYS_AREA_GRP_ID C, MDM_LOCATION D
                        WHERE	C.CO_IND_CD = 'H'
                            AND C.CNT_CD = SUBSTR(D.LOC_CD, 1, 2)
                            AND EQ_CTRL_OFC_CD IS NULL
                        AND   NVL(DELT_FLG, 'N') = 'N'
                        AND NVL(CALL_PORT_FLG, 'N') = 'Y'
                        AND     D.LOC_CD  =   B.POL_CD)
                IN (RGN_SHP_OPR_RHQ_CD1, RGN_SHP_OPR_RHQ_CD2, RGN_SHP_OPR_RHQ_CD3, RGN_SHP_OPR_RHQ_CD4, RGN_SHP_OPR_RHQ_CD5, RGN_SHP_OPR_RHQ_CD6)
                AND RGN_SHP_OPR_CD 	= @[rgn_shp_opr_cd]
            )
           )
		#end
		-- rgn_shp_opr_cd END
		AND TO_CHAR(A.RQST_DT,'YYYY-MM-DD') BETWEEN @[rqst_fr_dt] AND @[rqst_to_dt]
	) E
	WHERE 1=1
	-- dg_flg START
	#if (${dg_flg} == '') 
   		#if (${non_dg_cgo_status} != 'H' && ${non_dg_cgo_status} != 'X' )  -- 'U','X'인 경우는 BOOKING에 D/G여도 보여줌
     		AND (E.BKG_DCGO_FLG <> 'Y'  OR (  E.BKG_DCGO_FLG = 'Y' 
            									AND 'Y' = ( CASE WHEN ( SELECT COUNT(1) 
                                                        FROM SCG_NON_DG_CGO_KW_RQST_DTL X, SCG_NON_DG_CGO_KW Y
                                                       WHERE X.NON_DCGO_KW_SEQ      = Y.NON_DCGO_KW_SEQ
                                                         AND X.BKG_NO               = E.BKG_NO
                                                         AND X.NON_DCGO_RQST_SEQ    = E.NON_DCGO_RQST_SEQ
                                                         AND Y.NON_DCGO_CATE_GRP_CD = 'A' ) = 0 THEN 'N' 
                                               ELSE 'Y'
                                           END ) 
                ))
    	#end
	#elseif(${dg_flg} == 'N') 
		AND E.BKG_DCGO_FLG <> 'Y'
	#elseif(${dg_flg} == 'D') 
		#if (${non_dg_cgo_status} == 'H' || ${non_dg_cgo_status} == 'X')
		    AND E.BKG_DCGO_FLG = 'Y' 
		#else
		    AND E.BKG_DCGO_FLG = 'Y' 
		    AND 'Y' = ( CASE WHEN ( SELECT COUNT(1) 
                              FROM SCG_NON_DG_CGO_KW_RQST_DTL X, SCG_NON_DG_CGO_KW Y
                             WHERE X.NON_DCGO_KW_SEQ      = Y.NON_DCGO_KW_SEQ
                               AND X.BKG_NO               = E.BKG_NO
                               AND X.NON_DCGO_RQST_SEQ    = E.NON_DCGO_RQST_SEQ
                               AND Y.NON_DCGO_CATE_GRP_CD = 'A' ) = 0 THEN 'N'
                     ELSE 'Y'
                 END )
		#end
	#end
	-- dg_flg END
ORDER BY E.BKG_NO, E.NON_DCGO_RQST_SEQ			]]></sql>
			<params>
				<param name="non_dg_cgo_status" type="12" value="" out="N"/>
				<param name="rgn_shp_opr_cd" type="12" value="" out="N"/>
				<param name="rqst_fr_dt" type="12" value="" out="N"/>
				<param name="rqst_to_dt" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
