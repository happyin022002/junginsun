<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BudgetPortChargeMgtBCDBDAOSearchEstCreByMonRSQL">
			<desc><![CDATA[기준월에 해당하는 추정 대상 항차를 조회한다.
===============================================================
CHM-201215463-01 진마리아 Retrieve시 비용 생성 여부 관계없이 대상 항차를 전부 조회하도록 변경]]></desc>
			<sql><![CDATA[
SELECT V.REV_YRMON
               ,V.VSL_CD || V.SKD_VOY_NO || V.SKD_DIR_CD VVD
			   ,V.VSL_CD
               ,V.SKD_VOY_NO
               ,V.SKD_DIR_CD
               ,V.REV_DIR_CD
               ,V.RLANE_CD
               ,ESTM_VVD_TP_CD
               ,MAX(E.CRE_USR_ID) AS CRE_USR_ID
               ,DECODE(TO_CHAR(MAX(E.CRE_DT), 'YYYY-MM-DD'),
                       '1977-05-16',
                       '2010-04-03 20:00',
                       TO_CHAR(MAX(E.CRE_DT), 'YYYY-MM-DD HH24:MI')) CRE_DT
				, V.ESTM_IOC_DIV_CD      
--FROM   GL_ESTM_REV_VVD V
FROM    (SELECT EXE_YRMON, REV_YRMON, VSL_CD, SKD_VOY_NO, SKD_DIR_CD, REV_DIR_CD, ESTM_VVD_TP_CD, MAX(ESTM_IOC_DIV_CD) AS ESTM_IOC_DIV_CD, MAX(RLANE_CD) AS RLANE_CD
        FROM   GL_ESTM_REV_VVD V
        WHERE  1=1
        AND    V.EXE_YRMON = @[rev_yrmon]
		AND    V.REV_YRMON = @[rev_yrmon]
        AND (REV_YRMON, VSL_CD, SKD_VOY_NO, SKD_DIR_CD, REV_DIR_CD) NOT IN (SELECT REV_YRMON, VSL_CD, SKD_VOY_NO, SKD_DIR_CD, REV_DIR_CD
                                                                                        FROM   GL_ESTM_REV_VVD V
                                                                                        WHERE  1=1
                                                                                        AND    V.EXE_YRMON = @[rev_yrmon]
																						AND    V.REV_YRMON = @[rev_yrmon]
                                                                                        AND ESTM_IOC_DIV_CD = 'OO'
                                                                                        )
        GROUP BY EXE_YRMON, REV_YRMON, VSL_CD, SKD_VOY_NO, SKD_DIR_CD, REV_DIR_CD, ESTM_VVD_TP_CD
        UNION ALL
        SELECT EXE_YRMON, REV_YRMON, VSL_CD, SKD_VOY_NO, SKD_DIR_CD, REV_DIR_CD, ESTM_VVD_TP_CD, ESTM_IOC_DIV_CD, RLANE_CD
        FROM   GL_ESTM_REV_VVD V
        WHERE  1=1
        AND    V.EXE_YRMON = @[rev_yrmon]
		AND    V.REV_YRMON = @[rev_yrmon]
        AND (REV_YRMON, VSL_CD, SKD_VOY_NO, SKD_DIR_CD, REV_DIR_CD) IN (SELECT REV_YRMON, VSL_CD, SKD_VOY_NO, SKD_DIR_CD, REV_DIR_CD
                                                                                        FROM   GL_ESTM_REV_VVD V
                                                                                        WHERE  1=1
                                                                                        AND    V.EXE_YRMON = @[rev_yrmon]
																						AND    V.REV_YRMON = @[rev_yrmon]
                                                                                        AND ESTM_IOC_DIV_CD = 'OO'
                                                                                        )
        AND ESTM_IOC_DIV_CD = 'OO'
        ) V
      ,PSO_TGT_YD_EXPN E
      ,VSK_VSL_SKD     S
      ,MDM_VSL_CNTR    M
WHERE  E.PSO_BZTP_CD(+) = '2'
AND    V.EXE_YRMON = @[rev_yrmon]
AND    V.REV_YRMON = @[rev_yrmon]
AND    V.VSL_CD = E.VSL_CD(+)
AND    V.SKD_VOY_NO = E.SKD_VOY_NO(+)
AND    V.SKD_DIR_CD = E.SKD_DIR_CD(+)
AND    V.VSL_CD = S.VSL_CD
AND    V.SKD_VOY_NO = S.SKD_VOY_NO
AND    V.SKD_DIR_CD = S.SKD_DIR_CD
AND    V.VSL_CD = M.VSL_CD
AND    NVL(S.ACT_CRR_CD,M.CRR_CD) = 'SML'
#if (${vsl_slan_cd} != '') 
AND    E.RLANE_CD LIKE @[vsl_slan_cd] || '%'
#end
Group BY V.REV_YRMON
		,V.VSL_CD
        ,V.SKD_VOY_NO
        ,V.SKD_DIR_CD
        ,V.REV_DIR_CD
        ,V.RLANE_CD
        ,ESTM_VVD_TP_CD
		, V.ESTM_IOC_DIV_CD      
ORDER  BY REV_YRMON
         ,V.VSL_CD
         ,V.SKD_VOY_NO
         ,V.SKD_DIR_CD			]]></sql>
			<params>
				<param name="rev_yrmon" type="12" value="" out="N"/>
				<param name="vsl_slan_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
