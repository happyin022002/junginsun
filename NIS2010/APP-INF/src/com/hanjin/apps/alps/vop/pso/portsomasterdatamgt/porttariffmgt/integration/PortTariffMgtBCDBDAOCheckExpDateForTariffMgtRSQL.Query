<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="PortTariffMgtBCDBDAOCheckExpDateForTariffMgtRSQL">
			<desc><![CDATA[Tariff Value Management 입력시 EXP_DT 체크

------------------------------------------------
History
2011.10.31 진마리아 선처리(SRM-201121014) [VOP-PSO] Tariff Value Management 화면 로직 변경]]></desc>
			<sql><![CDATA[
SELECT DECODE(COUNT(*), 0, 'O', 'X') FLAG -- 불가(X)인 건이 있는지 확인
FROM   (
        SELECT DECODE(X.YD_CHG_NO, @[yd_chg_no],
                      CASE WHEN TO_DATE(@[exp_dt], 'YYYY-MM-DD') <  X.EFF_DT THEN 'X'    -- 입력된 EXP_DT가 EFF_DT 보다 작은 경우 불가(X), 즉 TO_DT < FM_DT
                           WHEN TO_DATE(@[exp_dt], 'YYYY-MM-DD') > NVL(LAG(X.EFF_DT) OVER(ORDER BY X.EFF_DT DESC), TO_DATE('9999-12-31','YYYY-MM-DD')) THEN 'X' -- 입력된 EXP_DT가 다음 버전 EFF_DT보다 클 경우 불가(X)
                           ELSE 'O'
                      END
                      , 'O' 
                     ) FLAG
        FROM   (SELECT DISTINCT A.YD_CHG_NO
                               ,A.EFF_DT                       
                               ,A.EXP_DT                       
                               ,C.UPD_MNU_NO
                FROM   PSO_YD_CHG     A
                      ,PSO_YD_CHG_XPR B
                      ,PSO_CHG_XPR    C
                WHERE  1 = 1
                AND    A.YD_CD = @[port_cd] || @[yd_cd]                  
                AND    A.VNDR_SEQ = @[vndr_seq]                            
                AND    A.LGS_COST_CD = @[cost_cd]                      
                AND    A.YD_CHG_NO = B.YD_CHG_NO
                AND    A.YD_CHG_VER_SEQ = B.YD_CHG_VER_SEQ
                AND    C.CHG_XPR_NO = B.CHG_XPR_NO
                AND    B.PSO_CHG_TP_CD = 'B'
                ORDER  BY 2 DESC
               ) X          
        ORDER  BY X.EFF_DT DESC   
       )
WHERE   FLAG = 'X'			]]></sql>
			<params>
				<param name="yd_chg_no" type="12" value="" out="N"/>
				<param name="exp_dt" type="12" value="" out="N"/>
				<param name="port_cd" type="12" value="" out="N"/>
				<param name="yd_cd" type="12" value="" out="N"/>
				<param name="vndr_seq" type="12" value="" out="N"/>
				<param name="cost_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
