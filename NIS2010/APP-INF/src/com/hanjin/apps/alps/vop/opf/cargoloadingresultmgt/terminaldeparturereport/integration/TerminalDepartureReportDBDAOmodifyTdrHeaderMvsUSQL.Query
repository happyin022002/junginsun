<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TerminalDepartureReportDBDAOmodifyTdrHeaderMvsUSQL">
			<desc><![CDATA[DESC Enter..
Ticket ID : CHM-201007765-01
개발자 : 박희동(2010-12-20)
수정내용 : UPD_SYS_CD 컬럼추가...N으로 setting,
               MVS 저장하는 방식 변경]]></desc>
			<sql><![CDATA[
UPDATE  TDR_HEADER A 
   SET  A.MVS     = (
                     SELECT SUM (MOVES)
                       FROM (SELECT NVL(SUM (S.QTY), 0) AS MOVES
                               FROM TDR_SUMMARY  S,
                                    TDR_HEADER   H
                              WHERE S.VSL_CD   = H.VSL_CD
                                AND S.VOY_NO   = H.VOY_NO
                                AND S.DIR_CD   = H.DIR_CD
                                AND S.PORT_CD  = H.PORT_CD
                                AND S.CALL_IND = H.CALL_IND
                                AND S.VSL_CD   = @[vsl_cd]
                                AND S.VOY_NO   = @[voy_no]
                                AND S.DIR_CD   = @[dir_cd]
                                AND S.PORT_CD  = @[port_cd]
                                AND S.CALL_IND = @[call_ind]
                                AND S.STATUS IN ('DS', 'DT', 'LM', 'LI', 'LT') 
                                AND (H.UPDATE_SYS='I' OR S.CNTR_TYPE NOT IN ('D', 'A', 'R') )
                             UNION ALL
                             SELECT NVL(SUM (DECODE (D.STATUS, 'ST', DECODE (D.SHIFT_TYPE, 'Q', 2, 1))),0)
                                  + NVL(SUM (DECODE (D.STATUS, 'MI', DECODE (SUBSTR (D.MISHANDLE_CHK, 1, 1),'O', 1,-1))),0)  AS MOVES
                               FROM TDR_CNTR_DETAIL   D
                              WHERE D.VSL_CD   = @[vsl_cd]
                                AND D.VOY_NO   = @[voy_no]
                                AND D.DIR_CD   = @[dir_cd]
                                AND D.PORT_CD  = @[port_cd]
                                AND D.CALL_IND = @[call_ind]
                                AND (   (D.STATUS = 'ST' AND LENGTH (TRIM (PRECELL)) > 0)
                                     OR (D.STATUS = 'MI' AND D.MISHANDLE_CHK IN ('OD', 'OL', 'SD', 'SL'))
                                    )
                             )
                      )                     
,       A.GROSS_TML = @[gross_tml]
,       A.NET_TML   = @[net_tml]
,       A.GROSS_GC  = @[gross_gc]
,       A.NET_GC    = @[net_gc]
,       A.UPDATE_TIME = SYSDATE
,       A.UPDATE_USER = @[update_user]
,       A.UPD_SYS_CD  = 'N'
 WHERE  A.VSL_CD  = @[vsl_cd]
   AND  A.VOY_NO  = @[voy_no]
   AND  A.DIR_CD  = @[dir_cd]
   AND  A.PORT_CD = @[port_cd]
   AND  A.CALL_IND= @[call_ind]
--   AND  A.UPDATE_SYS = 'N'			]]></sql>
			<params>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="voy_no" type="12" value="" out="N"/>
				<param name="dir_cd" type="12" value="" out="N"/>
				<param name="port_cd" type="12" value="" out="N"/>
				<param name="call_ind" type="12" value="" out="N"/>
				<param name="gross_tml" type="12" value="" out="N"/>
				<param name="net_tml" type="12" value="" out="N"/>
				<param name="gross_gc" type="12" value="" out="N"/>
				<param name="net_gc" type="12" value="" out="N"/>
				<param name="update_user" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
