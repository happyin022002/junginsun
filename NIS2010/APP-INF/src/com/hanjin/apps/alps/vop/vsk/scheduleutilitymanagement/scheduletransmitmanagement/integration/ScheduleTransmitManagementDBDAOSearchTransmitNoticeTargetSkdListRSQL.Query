<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ScheduleTransmitManagementDBDAOSearchTransmitNoticeTargetSkdListRSQL">
			<desc><![CDATA[ETA Sending(Auto-fax) 대상 및 Pre-Stowage Notice 대상 Schedule을 조회합니다.]]></desc>
			<sql><![CDATA[
SELECT		
			XX.VPS_PORT_CD
		,	XX.YD_CD
		,	XX.YD_NM
		,	XX.SLAN_CD
		,	XX.VVD
		,	XX.VSL_CD
		,	XX.SKD_VOY_NO
		,	XX.SKD_DIR_CD
		,	XX.VSL_ENG_NM
		,	XX.ACT_CRR_CD
		,	XX.VPS_ETA_DT
		,	XX.VPS_ETB_DT
		,	XX.VPS_ETD_DT
		,	XX.CLPT_IND_SEQ
		,	XX.VPS_PORT_CD
		,	XX.PORT_NM
		,	XX.TRSM_HIS_SEQ
		,	XX.TRSM_MZD_CD
		,	XX.TRSM_OWNR_CD
		,	XX.NTC_ETA_DT
		,	XX.NTC_ETB_DT
		,	XX.NTC_ETD_DT
		,	XX.TRSM_RSN
		,	XX.VSL_FAX_NO
		,	XX.VSL_TLX_NO
		,	XX.VSL_EML
		,	XX.DFLT_FAX_IMST_CD
		,	XX.DFLT_TLX_IMST_CD
		,	XX.VSL_FAX_TRSM_EML
		,	XX.VSL_TLX_TRSM_EML
		,	XX.TRSM_LOCL_DT
		,	XX.SKD_TRSM_STS_CD
		,	XX.SKD_TRSM_STS_CD
		,	XX.RPM_ADJ_DT
		,	XX.ORG_RPM_PWR
		,	XX.CRNT_RPM_PWR
		,	XX.ESVC_VNDR_SEQ
		,	XX.CRE_USR_ID
		,	XX.LOCL_CRE_DT
		,	XX.UPD_USR_ID
		,	XX.LOCL_UPD_DT
		,	XX.AUTO_FAX_POP  
		,	XX.CONTI_CD
	    ,   VSK_GET_LANE_PIC_EML_FNC(XX.SLAN_CD, XX.VPS_PORT_CD)   AS LANE_PIC_EML
		,	XX.TRSM_PURP_CD
FROM     (
          --====================================================================================
			SELECT T2.VPS_PORT_CD
			    , T2.YD_CD
			    , (SELECT YD_NM FROM MDM_YARD WHERE YD_CD = T2.YD_CD) YD_NM
			    , T1.VSL_SLAN_CD SLAN_CD
			    , T2.VSL_CD||T2.SKD_VOY_NO||T2.SKD_DIR_CD VVD
			    , T2.VSL_CD
			    , T2.SKD_VOY_NO
			    , T2.SKD_DIR_CD
			    , T3.VSL_ENG_NM
			    , NVL(T1.ACT_CRR_CD, T3.CRR_CD) ACT_CRR_CD
			    , TO_CHAR(T2.VPS_ETA_DT, 'YYYY-MM-DD HH24:MI') VPS_ETA_DT
			    , TO_CHAR(T2.VPS_ETB_DT, 'YYYY-MM-DD HH24:MI') VPS_ETB_DT
			    , TO_CHAR(T2.VPS_ETD_DT, 'YYYY-MM-DD HH24:MI') VPS_ETD_DT
			    , T2.CLPT_IND_SEQ
			
			    , (CASE WHEN TO_NUMBER(T2.CLPT_IND_SEQ)=1 THEN T2.VPS_PORT_CD
			      ELSE T2.VPS_PORT_CD||'('||T2.CLPT_IND_SEQ||')'
			      END) PORT_NM
			    , T4.TRSM_HIS_SEQ
			    , T4.TRSM_MZD_CD
			    , T4.TRSM_OWNR_CD
			    , TO_CHAR(T4.NTC_ETA_DT, 'YYYY-MM-DD HH24:MI') NTC_ETA_DT
			    , TO_CHAR(T4.NTC_ETB_DT, 'YYYY-MM-DD HH24:MI') NTC_ETB_DT
			    , TO_CHAR(T4.NTC_ETD_DT, 'YYYY-MM-DD HH24:MI') NTC_ETD_DT
			
			    , T4.TRSM_RSN
			    , VSK_REMOVE_NONE_NUMERIC_FNC(T3.FAX_NO, 'FAX_TELEX') VSL_FAX_NO
			    , VSK_REMOVE_NONE_NUMERIC_FNC(T3.TLX_NO, 'FAX_TELEX') VSL_TLX_NO
			    , T3.VSL_EML
			    , CASE WHEN (T5.LON_UT_CD='E' AND T5.LOC_LON<25) OR (T5.LON_UT_CD='W' AND T5.LOC_LON<=35) THEN '871' -- AOR-E 대서양 동부
			           WHEN (T5.LON_UT_CD='E' AND T5.LOC_LON>=120) OR (T5.LON_UT_CD='W' AND T5.LOC_LON>115) THEN '872' -- POR 태평양
			           WHEN T5.LON_UT_CD='E' AND T5.LOC_LON>=25 AND T5.LOC_LON<120 THEN '873' -- IOR 인도양
			           WHEN T5.LON_UT_CD='W' AND T5.LOC_LON>35 AND T5.LOC_LON<=115 THEN '874' -- AOR-W 대서양 서부
			           ELSE '870'
			      END AS DFLT_FAX_IMST_CD
			    , CASE WHEN (T5.LON_UT_CD='E' AND T5.LOC_LON<25) OR (T5.LON_UT_CD='W' AND T5.LOC_LON<=35) THEN '0581'
			           WHEN (T5.LON_UT_CD='E' AND T5.LOC_LON>=120) OR (T5.LON_UT_CD='W' AND T5.LOC_LON>115) THEN '0582'
			           WHEN T5.LON_UT_CD='E' AND T5.LOC_LON>=25 AND T5.LOC_LON<120 THEN '0583'
			           WHEN T5.LON_UT_CD='W' AND T5.LOC_LON>35 AND T5.LOC_LON<=115 THEN '0584'
			           ELSE ''
			      END AS DFLT_TLX_IMST_CD
			    , T4.VSL_FAX_TRSM_EML
			    , T4.VSL_TLX_TRSM_EML
			    , TO_CHAR(T4.TRSM_LOCL_DT, 'YYYY-MM-DD HH24:MI') TRSM_LOCL_DT
			
			    --, DECODE(T4.SKD_TRSM_STS_CD, 'SN', 'Success', '') SKD_TRSM_STS_CD
			    , DECODE ( (SELECT	EML_PROC_STS_CD
			              	FROM	COM_EML_SND_INFO	EL
				          	WHERE	EL.EML_SND_NO		= T4.EML_SND_NO)
							, '1', 'Waiting'
							, '2', 'Processing'
							, '3', 'Success'
							, '4', 'Failed'
							, ''
						) 								AS SKD_TRSM_STS_CD
			    , TO_CHAR(T4.RPM_ADJ_DT, 'YYYY-MM-DD HH24:MI') AS RPM_ADJ_DT
			    , T4.ORG_RPM_PWR
			    , T4.CRNT_RPM_PWR
			    , T4.ESVC_VNDR_SEQ
			    , T4.CRE_USR_ID
			    , T4.LOCL_CRE_DT
			    , T4.UPD_USR_ID
			    , T4.LOCL_UPD_DT
			    , 0 auto_fax_pop
            	, T5.CONTI_CD
				, T4.TRSM_PURP_CD

			FROM  VSK_VSL_SKD               	T1
			    , VSK_VSL_PORT_SKD          	T2
			    , MDM_VSL_CNTR              	T3
			    , VSK_VSL_PORT_SKD_TRSM_HIS 	T4
			    , MDM_LOCATION              	T5
			WHERE 1 = 1
        	AND   T1.VSL_CD          			= T2.VSL_CD
        	AND   T1.SKD_VOY_NO      			= T2.SKD_VOY_NO
        	AND   T1.SKD_DIR_CD      			= T2.SKD_DIR_CD
        	AND   T1.VSL_CD          			= T3.VSL_CD
        	AND   T2.VPS_PORT_CD     			= T5.LOC_CD
        	AND   T2.VSL_CD          			= T4.VSL_CD(+)
        	AND   T2.SKD_VOY_NO      			= T4.SKD_VOY_NO(+)
        	AND   T2.SKD_DIR_CD      			= T4.SKD_DIR_CD(+)
        	AND   T2.VPS_PORT_CD     			= T4.VPS_PORT_CD(+)
        	AND   T2.CLPT_IND_SEQ    			= T4.CLPT_IND_SEQ(+)
        	AND   NVL(T4.TRSM_HIS_SEQ,0) 		>= (SELECT 	NVL(MAX(T.TRSM_HIS_SEQ),0) 
													FROM 	VSK_VSL_PORT_SKD_TRSM_HIS 	T
													WHERE 	T.VSL_CD 					= T2.VSL_CD
													AND 	T.SKD_VOY_NO 				= T2.SKD_VOY_NO
													AND 	T.SKD_DIR_CD 				= T2.SKD_DIR_CD
													AND 	T.VPS_PORT_CD 				= T2.VPS_PORT_CD
													AND 	T.CLPT_IND_SEQ 				= T2.CLPT_IND_SEQ
													AND		T.TRSM_PURP_CD				= @[trsm_purp_cd]
			                              		)
			AND NVL(T2.SKD_CNG_STS_CD,' ') 		<> 'S'
			AND T2.TURN_PORT_IND_CD 			IN ('Y','N')
			#if (${fm_eta_dt} != '' && ${to_eta_dt} != '') 
			AND T2.VPS_ETA_DT 					BETWEEN TO_DATE(@[fm_eta_dt],'YYYY-MM-DD') AND TO_DATE(@[to_eta_dt],'YYYY-MM-DD')+0.99999
			#end

			--AND NVL(T1.ACT_CRR_CD, T3.CRR_CD) 	= [act_crr_cd]
			AND NVL(T1.ACT_CRR_CD, T3.CRR_CD) 	= 'SML'

			#if (${vps_port_cd} != '') 
			AND T2.VPS_PORT_CD 					= @[vps_port_cd]
			#end
			#if (${slan_cd} != '') 
			AND T1.VSL_SLAN_CD 					= @[slan_cd]
			#end
			#if (${vsl_cd} != '')
			AND T1.VSL_CD 						= @[vsl_cd]
			#end
			#if (${skd_voy_no} != '')
			AND T1.SKD_VOY_NO 					= @[skd_voy_no]
			#end
			#if (${skd_dir_cd} != '')
			AND T1.SKD_DIR_CD 					= @[skd_dir_cd]
			#end

			AND T4.TRSM_PURP_CD	  (+)			= @[trsm_purp_cd]

          --====================================================================================  
          ) XX
WHERE     1 = 1           

ORDER BY  XX.VPS_PORT_CD
      ,   XX.VSL_CD
      ,   XX.SKD_VOY_NO
      ,   XX.SKD_DIR_CD			]]></sql>
			<params>
				<param name="trsm_purp_cd" type="12" value="" out="N"/>
				<param name="fm_eta_dt" type="12" value="" out="N"/>
				<param name="to_eta_dt" type="12" value="" out="N"/>
				<param name="vps_port_cd" type="12" value="" out="N"/>
				<param name="slan_cd" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
