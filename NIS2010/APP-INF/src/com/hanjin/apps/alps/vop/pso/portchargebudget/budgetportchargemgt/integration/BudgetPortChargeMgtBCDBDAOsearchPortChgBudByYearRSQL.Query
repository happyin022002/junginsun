<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BudgetPortChargeMgtBCDBDAOsearchPortChgBudByYearRSQL">
			<desc><![CDATA[년도별 사업 계획을 조회한다.
=====================================================================
2011.03.28 진마리아 [선처리(SRM-201114694)] 사업계획 항비 로직 수정 요청
2012.08.20 진마리아 CHM-201219078-01 사업계획 - 시나리오 연도 추가]]></desc>
			<sql><![CDATA[
/*PortChgBudByYear VO*/
SELECT T.EXPN_YRMON,
  T.VSl_SLAN_CD,
  MAX(CASE WHEN XPR_DESC LIKE '%info%null%' OR XPR_DESC LIKE '%no-rate%' OR XPR_DESC IS NULL THEN 'Y'
           ELSE 'N'
      END) ERR,	
  T.VSL_CD
  ||T.SKD_VOY_NO
  ||T.SKD_DIR_CD VVD,
  SUM(INV_USD_AMT) AMT
  ,'' txtsdate
  ,'' txtedate
  ,T.VSL_CLSS VSL_CLS
  ,max(T.VSL_CD) vsl_cd
  ,max(T.SKD_VOY_NO) skd_voy_no
  ,max(T.SKD_DIR_CD) skd_dir_cd
  ,decode(T.vsl_slan_cd, max((select x.vsl_slan_cd from vsk_bud_vsl_skd x where x.vsl_cd = T.vsl_cd 
                               and x.skd_voy_no = T.skd_voy_no and x.skd_dir_cd = T.skd_dir_cd)), null
          ,max((select x.vsl_slan_cd from vsk_bud_vsl_skd x where x.vsl_cd = T.vsl_cd and x.skd_voy_no = T.skd_voy_no
                and x.skd_dir_cd = T.skd_dir_cd))||' - Mismatched Lane Code with SKED') rmk
FROM
  ( SELECT DISTINCT T1.PSO_BZTP_CD,
    T1.EXPN_YRMON,
    T1.VSL_CD,
    T1.SKD_VOY_NO,
    T1.SKD_DIR_CD,
    T1.VSl_SLAN_CD,
    T2.YD_CD,
    C.LGS_COST_CD
    --,T1.VSL_CNTR_CLSS_CAPA CLSS : ?????
	,T1.CNTR_VSL_CLSS_CAPA VSL_CLSS
    ,C.VNDR_SEQ
    ,T1.BUD_SCNR_NO
  FROM PSO_TGT_VVD T1,
    PSO_TGT_YD_SKD T2,
    PSO_YD_CHG C
  WHERE T1.VSL_CD    = T2.VSL_CD
  AND T1.SKD_VOY_NO  = T2.SKD_VOY_NO
  AND T1.SKD_DIR_CD  = T2.SKD_DIR_CD
  AND T1.PSO_BZTP_CD = T2.PSO_BZTP_CD
  AND T1.BUD_SCNR_NO = T2.BUD_SCNR_NO
  AND T1.PSO_BZTP_CD = '1'--'5'
  AND T2.YD_CD       = C.YD_CD
  AND C.CPLS_FLG = 'Y'
  AND C.LST_FLG = 'Y'
--  AND TO_DATE(T1.EXPN_YRMON, 'YYYYMM') BETWEEN EFF_DT AND EXP_DT
  AND T1.EXPN_YRMON BETWEEN TO_CHAR(C.EFF_DT, 'YYYYMM') AND TO_CHAR(C.EXP_DT,'YYYYMM')  
#if(${txtsdate}!='')
  AND T1.EXPN_YRMON BETWEEN replace(@[txtsdate],'-','') AND replace(@[txtedate],'-','')
#end
  AND TO_CHAR(T1.CRE_DT,'YYYYMM') = (SELECT MAX(TO_CHAR(CRE_DT,'YYYYMM')) FROM PSO_TGT_VVD WHERE PSO_BZTP_CD='1')--BUD_SCNR_NO 조건 없이 가장 최근 생성된 VVD만을 대상으로 함
#if(${vsl_slan_cd}!='')
  AND T1.VSL_SLAN_CD = @[vsl_slan_cd]
#end 
#if(${vsl_cd}!='')
  AND T1.VSL_CD    = @[vsl_cd]
#end
#if(${skd_voy_no}!='')
  AND T1.SKD_VOY_NO  = @[skd_voy_no]
#end 
#if(${skd_dir_cd}!='')
 AND T1.SKD_DIR_CD  = @[skd_dir_cd]
#end 
  ) T ,
  PSO_TGT_YD_EXPN E
WHERE T.VSL_CD    = E.VSL_CD(+)
AND T.SKD_VOY_NO  = E.SKD_VOY_NO(+)
AND T.SKD_DIR_CD  = E.SKD_DIR_CD(+)
AND T.PSO_BZTP_CD = E.PSO_BZTP_CD(+)
AND T.YD_CD       = E.YD_CD(+)
AND T.LGS_COST_CD = E.LGS_COST_CD(+)
AND T.VNDR_SEQ    = E.VNDR_SEQ(+)
AND T.BUD_SCNR_NO = E.BUD_SCNR_NO(+)
GROUP BY T.EXPN_YRMON,
  T.VSl_SLAN_CD,
  T.VSL_CLSS,
  --T.YD_CD,
  T.VSL_CD
  ||T.SKD_VOY_NO
  ||T.SKD_DIR_CD
ORDER BY T.EXPN_YRMON,  T.VSl_SLAN_CD, T.VSL_CD||T.SKD_VOY_NO||T.SKD_DIR_CD, T.VSL_CLSS--, T.YD_CD			]]></sql>
			<params>
				<param name="txtsdate" type="12" value="" out="N"/>
				<param name="txtedate" type="12" value="" out="N"/>
				<param name="vsl_slan_cd" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
