<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ActualScheduleMgtDBDAOActPortSkdHisRSQL">
			<desc><![CDATA[Actual SKD 변경 이력을 조회한다.
-----------------------------------------------------------------------------------------
2010.12.23 진마리아 [CHM-201007578-01] ACTUAL SKD HISTORY 조회 로직 변경
2011.10.26 김민아 [CHM-201114112-01] VSL SKD History Inquiry 화면 로직 변경 : 페이징 처리
]]></desc>
			<sql><![CDATA[
SELECT  VVD
	   ,VSL_SLAN_CD
	   ,VPS_PORT_CD
	   ,OLD_ATA
	   ,OLD_ATB
	   ,OLD_ATD
	   ,OLD_CRE
	   ,OLD_USER_ID
	   ,NEW_ATA
	   ,NEW_ATB
	   ,NEW_ATD
	   ,NEW_CRE
	   ,NEW_USER_ID
	   ,CNG_SEQ
	   ,TOTAL_CNT
FROM    (
        SELECT	VVD
        		, VSL_SLAN_CD
        		, VPS_PORT_CD
        		, TO_CHAR(OLD_ATA, 'RRRRMMDDHH24MI') AS OLD_ATA
        		, TO_CHAR(OLD_ATB, 'RRRRMMDDHH24MI') AS OLD_ATB
        		, TO_CHAR(OLD_ATD, 'RRRRMMDDHH24MI') AS OLD_ATD
        		, TO_CHAR(OLD_CRE, 'RRRRMMDDHH24MI') AS OLD_CRE
        		, OLD_USER_ID
        		, TO_CHAR(NEW_ATA, 'RRRRMMDDHH24MI') AS NEW_ATA
        		, TO_CHAR(NEW_ATB, 'RRRRMMDDHH24MI') AS NEW_ATB
        		, TO_CHAR(NEW_ATD, 'RRRRMMDDHH24MI') AS NEW_ATD
        		, TO_CHAR(NEW_CRE, 'RRRRMMDDHH24MI') AS NEW_CRE
        		, NEW_USER_ID
        		, CNG_SEQ
        		, ROW_NUMBER() OVER(ORDER BY CNG_SEQ DESC) AS RNUM
        		, COUNT(1) OVER() AS TOTAL_CNT
        FROM	(
        			SELECT	ROW_NUMBER() OVER (PARTITION BY T1.VSL_CD, T1.SKD_VOY_NO, T1.SKD_DIR_CD, T1.VPS_PORT_CD, T1.CLPT_IND_SEQ ORDER BY T1.CRE_DT) AS SEQ
        				, T1.VSL_CD || T1.SKD_VOY_NO || T1.SKD_DIR_CD   AS VVD
        				, T2.VSL_SLAN_CD
        				, T1.VPS_PORT_CD
        				, LAG(T1.ACT_ARR_DT    ) OVER (PARTITION BY T1.VSL_CD, T1.SKD_VOY_NO, T1.SKD_DIR_CD, T1.VPS_PORT_CD, T1.CLPT_IND_SEQ ORDER BY T1.CRE_DT) AS OLD_ATA
        				, LAG(T1.ACT_BRTH_DT   ) OVER (PARTITION BY T1.VSL_CD, T1.SKD_VOY_NO, T1.SKD_DIR_CD, T1.VPS_PORT_CD, T1.CLPT_IND_SEQ ORDER BY T1.CRE_DT) AS OLD_ATB
        				, LAG(T1.ACT_DEP_DT    ) OVER (PARTITION BY T1.VSL_CD, T1.SKD_VOY_NO, T1.SKD_DIR_CD, T1.VPS_PORT_CD, T1.CLPT_IND_SEQ ORDER BY T1.CRE_DT) AS OLD_ATD
        				, LAG(GLOBALDATE_PKG.TIME_CONV_FNC('KRSEL', T1.CRE_DT, @[vps_port_cd])) OVER (PARTITION BY T1.VSL_CD, T1.SKD_VOY_NO, T1.SKD_DIR_CD, T1.VPS_PORT_CD, T1.CLPT_IND_SEQ ORDER BY T1.CRE_DT) AS OLD_CRE
        				, LAG(T1.CRE_USR_ID    ) OVER (PARTITION BY T1.VSL_CD, T1.SKD_VOY_NO, T1.SKD_DIR_CD, T1.VPS_PORT_CD, T1.CLPT_IND_SEQ ORDER BY T1.CRE_DT) AS OLD_USER_ID
        				, T1.ACT_ARR_DT         AS NEW_ATA
        				, T1.ACT_BRTH_DT        AS NEW_ATB
        				, T1.ACT_DEP_DT         AS NEW_ATD
        				, GLOBALDATE_PKG.TIME_CONV_FNC('KRSEL', T1.CRE_DT, @[vps_port_cd])             AS NEW_CRE
        				, T1.CRE_USR_ID         AS NEW_USER_ID
        				, T1.CNG_SEQ
        			FROM	VSK_ACT_PORT_SKD_HIS T1, VSK_VSL_SKD T2
        #if (${fm_dt} != '' && ${to_dt} != '')
        					,(	SELECT  GLOBALDATE_PKG.TIME_CONV_FNC('KRSEL', TO_DATE(@[fm_dt]||' 00:00', 'YYYY-MM-DD HH24:MI'), @[vps_port_cd]) AS FM_DT
        								, GLOBALDATE_PKG.TIME_CONV_FNC('KRSEL', TO_DATE(@[to_dt]||' 23:59:59', 'YYYY-MM-DD HH24:MI:SS'), @[vps_port_cd]) AS TO_DT
        						FROM	DUAL
        					) T3
        #end
        			WHERE	1		= 1
        			AND		T1.VSL_CD		= T2.VSL_CD
        			AND		T1.SKD_VOY_NO	= T2.SKD_VOY_NO
        			AND		T1.SKD_DIR_CD	= T2.SKD_DIR_CD
        #if (${vsl_cd} != '') 
        			AND		T1.VSL_CD		= @[vsl_cd]
        #end
        #if (${skd_voy_no} != '')
        			AND		T1.SKD_VOY_NO	= @[skd_voy_no]
        #end
        #if (${skd_dir_cd} != '')
        			AND		T1.SKD_DIR_CD	= @[skd_dir_cd]
        #end
        #if (${vsl_slan_cd} != '')
        			AND		T2.VSL_SLAN_CD	= @[vsl_slan_cd]
        #end
        			AND		T1.VPS_PORT_CD	= @[vps_port_cd]
        #if (${fm_dt} != '' && ${to_dt} != '')
        			AND		T1.CRE_DT	BETWEEN	T3.FM_DT 	AND		T3.TO_DT
        #end
        		)
        WHERE	NEW_USER_ID IS NOT NULL
        )
WHERE   1 = 1
AND     RNUM BETWEEN (@[page_no]-1)*@[pagerows]+1 AND @[page_no]*@[pagerows]
 			]]></sql>
			<params>
				<param name="vps_port_cd" type="12" value="" out="N"/>
				<param name="fm_dt" type="12" value="" out="N"/>
				<param name="to_dt" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="vsl_slan_cd" type="12" value="" out="N"/>
				<param name="page_no" type="12" value="" out="N"/>
				<param name="pagerows" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
