<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="VesselScheduleMgtDBDAOCheckVslSkdReversedPortInfoRSQL">
			<desc><![CDATA[Daily Berth Window의 ETA, ETB, ETD 수정시 기준 VVD Port와 이전 Port의 ETD 또는 이후 Port의 ETA의 시간 역전 Validation Check]]></desc>
			<sql><![CDATA[
SELECT  XX.PRE_VSL_CD 
        ,XX.PRE_SKD_VOY_NO
        ,XX.PRE_SKD_DIR_CD
        ,XX.PRE_VPS_PORT_CD
        ,XX.PRE_CLPT_IND_SEQ
        ,XX.PRE_ETD_DT 
                                          
        ,XX.VSL_CD                        
        ,XX.SKD_VOY_NO                    
        ,XX.SKD_DIR_CD                    
        ,XX.VPS_PORT_CD                   
        ,XX.CLPT_IND_SEQ                  
        ,XX.CLPT_SEQ                      
        ,TO_DATE(@[vps_eta_dt], 'YYYYMMDDHH24:MI')                    
        ,XX.VPS_ETB_DT                    
        ,TO_DATE(@[vps_etd_dt], 'YYYYMMDDHH24:MI')                    
                                            
        ,XX.NXT_VSL_CD
        ,XX.NXT_SKD_VOY_NO
        ,XX.NXT_SKD_DIR_CD
        ,XX.NXT_VPS_PORT_CD
        ,XX.NXT_CLPT_IND_SEQ                                                                                              
        ,XX.NXT_ETA_DT
        ,CASE WHEN  TO_DATE(@[vps_eta_dt], 'YYYYMMDDHH24:MI') - XX.PRE_ETD_DT <= 0 THEN 'Y'
              ELSE  'N'
         END  AS    PRE_RVS_EXIST_FLG
        ,CASE WHEN  XX.NXT_ETA_DT - TO_DATE(@[vps_etd_dt], 'YYYYMMDDHH24:MI') <= 0 THEN 'Y'
              ELSE  'N'
         END  AS    NXT_RVS_EXIST_FLG
                           
FROM    (          
        SELECT    LAG(T1.VSL_CD       , 1 , T1.VSL_CD      ) OVER(PARTITION BY T5.VSL_SVC_TP_CD, T1.VSL_CD ORDER BY T1.VPS_ETB_DT, T1.SKD_VOY_NO, T4.VSL_SLAN_DIR_SEQ, T1.CLPT_SEQ) AS PRE_VSL_CD
                , LAG(T1.SKD_VOY_NO   , 1 , T1.SKD_VOY_NO  ) OVER(PARTITION BY T5.VSL_SVC_TP_CD, T1.VSL_CD ORDER BY T1.VPS_ETB_DT, T1.SKD_VOY_NO, T4.VSL_SLAN_DIR_SEQ, T1.CLPT_SEQ) AS PRE_SKD_VOY_NO
                , LAG(T1.SKD_DIR_CD   , 1 , T1.SKD_DIR_CD  ) OVER(PARTITION BY T5.VSL_SVC_TP_CD, T1.VSL_CD ORDER BY T1.VPS_ETB_DT, T1.SKD_VOY_NO, T4.VSL_SLAN_DIR_SEQ, T1.CLPT_SEQ) AS PRE_SKD_DIR_CD
                , LAG(T1.VPS_PORT_CD  , 1 , T1.VPS_PORT_CD ) OVER(PARTITION BY T5.VSL_SVC_TP_CD, T1.VSL_CD ORDER BY T1.VPS_ETB_DT, T1.SKD_VOY_NO, T4.VSL_SLAN_DIR_SEQ, T1.CLPT_SEQ) AS PRE_VPS_PORT_CD
                , LAG(T1.CLPT_IND_SEQ , 1 , T1.CLPT_IND_SEQ) OVER(PARTITION BY T5.VSL_SVC_TP_CD, T1.VSL_CD ORDER BY T1.VPS_ETB_DT, T1.SKD_VOY_NO, T4.VSL_SLAN_DIR_SEQ, T1.CLPT_SEQ) AS PRE_CLPT_IND_SEQ
                , LAG(T1.VPS_ETD_DT   , 1 , TO_DATE('19000101', 'YYYYMMDD')  ) OVER(PARTITION BY T5.VSL_SVC_TP_CD, T1.VSL_CD ORDER BY T1.VPS_ETB_DT, T1.SKD_VOY_NO, T4.VSL_SLAN_DIR_SEQ, T1.CLPT_SEQ) AS PRE_ETD_DT 
                
                , T1.VSL_CD
                , T1.SKD_VOY_NO
                , T1.SKD_DIR_CD
                , T1.VPS_PORT_CD
                , T1.CLPT_IND_SEQ
                , T1.CLPT_SEQ          
                , T1.VPS_ETA_DT    
                , T1.VPS_ETB_DT
                , T1.VPS_ETD_DT
                
                , LEAD(T1.VSL_CD       , 1, T1.VSL_CD      ) OVER(PARTITION BY T5.VSL_SVC_TP_CD, T1.VSL_CD ORDER BY T1.VPS_ETB_DT, T1.SKD_VOY_NO, T4.VSL_SLAN_DIR_SEQ, T1.CLPT_SEQ) AS NXT_VSL_CD
                , LEAD(T1.SKD_VOY_NO   , 1, T1.SKD_VOY_NO  ) OVER(PARTITION BY T5.VSL_SVC_TP_CD, T1.VSL_CD ORDER BY T1.VPS_ETB_DT, T1.SKD_VOY_NO, T4.VSL_SLAN_DIR_SEQ, T1.CLPT_SEQ) AS NXT_SKD_VOY_NO
                , LEAD(T1.SKD_DIR_CD   , 1, T1.SKD_DIR_CD  ) OVER(PARTITION BY T5.VSL_SVC_TP_CD, T1.VSL_CD ORDER BY T1.VPS_ETB_DT, T1.SKD_VOY_NO, T4.VSL_SLAN_DIR_SEQ, T1.CLPT_SEQ) AS NXT_SKD_DIR_CD
                , LEAD(T1.VPS_PORT_CD  , 1, T1.VPS_PORT_CD ) OVER(PARTITION BY T5.VSL_SVC_TP_CD, T1.VSL_CD ORDER BY T1.VPS_ETB_DT, T1.SKD_VOY_NO, T4.VSL_SLAN_DIR_SEQ, T1.CLPT_SEQ) AS NXT_VPS_PORT_CD
                , LEAD(T1.CLPT_IND_SEQ , 1, T1.CLPT_IND_SEQ) OVER(PARTITION BY T5.VSL_SVC_TP_CD, T1.VSL_CD ORDER BY T1.VPS_ETB_DT, T1.SKD_VOY_NO, T4.VSL_SLAN_DIR_SEQ, T1.CLPT_SEQ) AS NXT_CLPT_IND_SEQ
                , LEAD(T1.VPS_ETA_DT   , 1, TO_DATE('29991231', 'YYYYMMDD')) OVER(PARTITION BY T5.VSL_SVC_TP_CD, T1.VSL_CD ORDER BY T1.VPS_ETB_DT, T1.SKD_VOY_NO, T4.VSL_SLAN_DIR_SEQ, T1.CLPT_SEQ) AS NXT_ETA_DT
        FROM    VSK_VSL_PORT_SKD T1
                ,(
                   SELECT  VSL_CD, SKD_VOY_NO, SKD_DIR_CD
                           , CASE WHEN TURN_PORT_IND_CD IN ('V', 'F') THEN 1 ELSE 3 END AS SEQ
                   FROM    VSK_VSL_PORT_SKD
                   WHERE   1=1
                   AND     VSL_CD                = @[vsl_cd]
                   AND     TURN_SKD_VOY_NO       = @[skd_voy_no]
                   AND     TURN_SKD_DIR_CD       = @[skd_dir_cd]
                   GROUP BY VSL_CD, SKD_VOY_NO, SKD_DIR_CD, CASE WHEN TURN_PORT_IND_CD IN ('V', 'F') THEN 1 ELSE 3 END
                   UNION ALL
                   SELECT  @[vsl_cd], @[skd_voy_no], @[skd_dir_cd], 2 SEQ
                   FROM DUAL
                ) T2
                , MDM_VSL_SVC_LANE_DIR T4
                , MDM_VSL_SVC_LANE T5
        WHERE   1=1
        AND     T1.VSL_CD       = T2.VSL_CD
        AND     T1.SKD_VOY_NO   = T2.SKD_VOY_NO
        AND     T1.SKD_DIR_CD   = T2.SKD_DIR_CD
        AND      NVL(T1.SKD_CNG_STS_CD, ' ') <> 'S'
        AND      NVL(T1.TURN_PORT_IND_CD, ' ') NOT IN ('D', 'V', 'F')
        AND      T1.SLAN_CD      = T4.VSL_SLAN_CD
        AND      T1.SKD_DIR_CD   = T4.VSL_SLAN_DIR_CD
        AND      T1.SLAN_CD      = T5.VSL_SLAN_CD
          ) XX
WHERE     1 = 1                
AND      XX.VSL_CD           = @[vsl_cd]
AND      XX.SKD_VOY_NO       = @[skd_voy_no]
AND      XX.SKD_DIR_CD       = @[skd_dir_cd]
AND      XX.VPS_PORT_CD      = @[vps_port_cd]
AND      XX.CLPT_IND_SEQ     = @[clpt_ind_seq]
AND      (TO_DATE(@[vps_eta_dt], 'YYYYMMDDHH24:MI') - XX.PRE_ETD_DT <= 0 
          OR 
		  XX.NXT_ETA_DT - TO_DATE(@[vps_etd_dt], 'YYYYMMDDHH24:MI') <= 0
          )			]]></sql>
			<params>
				<param name="vps_eta_dt" type="12" value="" out="N"/>
				<param name="vps_etd_dt" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="vps_port_cd" type="12" value="" out="N"/>
				<param name="clpt_ind_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
