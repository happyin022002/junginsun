<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BudgetPortChargeMgtDBDAOsearchBudEstDtlByMonCostRSQL">
			<desc><![CDATA[VVD별 Budget / Expense Plan Detail 비용을 조회한다.
======================================
History
2012.08.20 진마리아 CHM-201219078-01 사업계획 - 시나리오 연도 추가]]></desc>
			<sql><![CDATA[
SELECT mm yyyy_mm, vvd, 
decode(@[gubun], 0, lane, 1, loc) LANE, 
acct account_code, ACT_AMT BUDGET, EST_AMT ESTIMATE   
FROM 
(        
     SELECT mm, vvd, lane, loc, acct, SUM(DECODE(tp,'1',amt,0)) ACT_AMT,  SUM(DECODE(tp,'2',amt,0)) EST_AMT
    FROM
    (    
        select  '1' tp, t11.rev_yrmon mm, t10.vsl_cd||t10.skd_voy_no||t10.skd_dir_cd vvd, t10.vsl_slan_cd lane,cst.acct_cd acct, substr(t11.yd_cd,1,5) loc, SUM(inv_usd_amt) AMT
                from    pso_tgt_vvd t10, pso_tgt_yd_expn t11, mdm_vsl_cntr vsl, tes_lgs_cost cst     
                where   1 = 1
                and     t10.vsl_cd     = t11.vsl_cd
                and     t10.skd_voy_no = t11.skd_voy_no
                and     t10.skd_dir_cd = t11.skd_dir_cd
                and     t10.pso_bztp_cd = '1'
				and     t10.pso_bztp_cd = t11.pso_bztp_cd
                and     t10.BUD_SCNR_NO = t11.BUD_SCNR_NO
                and     t11.rev_yrmon between replace(@[cre_dt_fr],'-','') AND replace(@[cre_dt_to],'-','')
                AND     TO_CHAR(t10.CRE_DT,'YYYYMM') = (SELECT MAX(TO_CHAR(CRE_DT,'YYYYMM')) FROM PSO_TGT_VVD WHERE PSO_BZTP_CD='1')--BUD_SCNR_NO 조건 없이 가장 최근 생성된 VVD만을 대상으로 함
                and     t10.vsl_cd      = vsl.vsl_cd
                and     t11.lgs_cost_cd = cst.lgs_cost_cd
                and     cst.acct_cd     = @[acct_cd]
				#if(${vsl_cls}!='')
                and     vsl.CNTR_VSL_CLSS_CAPA  = @[vsl_cls]
				#end
				#if(${lane_cd}!='')
                and     t10.vsl_slan_cd = @[lane_cd]  
				#end
				#if(${loc_cd}!='')
                and     SUBSTR(t11.yd_cd,1,5)       = @[loc_cd] 
				#end
        group by  t11.rev_yrmon , t10.vsl_cd, t10.skd_voy_no, t10.skd_dir_cd, t10.vsl_slan_cd,cst.acct_cd,substr(t11.yd_cd,1,5)                    
         UNION ALL
        select  '2' tp,est.rev_yrmon mm, est.vsl_cd||est.skd_voy_no||est.skd_dir_cd vvd, vsk.vsl_slan_cd lane, est.acct_cd acct, est.loc_cd loc,  SUM(ESTM_AMT) AMT
                from    gl_estm_if_erp est, mdm_vsl_cntr vsl,  vsk_vsl_skd  vsk
                where   sys_src_id      = 'PSO'
                and     est.rev_yrmon between replace(@[cre_dt_fr],'-','') AND replace(@[cre_dt_to],'-','')
                and     est.vsl_cd      = vsl.vsl_cd
                and     vsk.vsl_cd      = est.vsl_cd
                and     vsk.skd_voy_no  = est.skd_voy_no
                and     vsk.skd_dir_cd  = est.skd_dir_cd
                and    est.acct_cd      = @[acct_cd]
				#if(${vsl_cls}!='')
                and     vsl.CNTR_VSL_CLSS_CAPA  = @[vsl_cls]
				#end
				#if(${lane_cd}!='')
                and     vsk.vsl_slan_cd = @[lane_cd]  
				#end
				#if(${loc_cd}!='')
                and     est.loc_cd      = @[loc_cd] 
				#end
          group by  est.rev_yrmon, est.vsl_cd, est.skd_voy_no, est.skd_dir_cd, vsk.vsl_slan_cd,est.acct_cd , est.loc_cd                 
    )
    GROUP BY mm, vvd, lane, loc, acct
)
ORDER BY mm, lane, loc, vvd			]]></sql>
			<params>
				<param name="gubun" type="12" value="" out="N"/>
				<param name="cre_dt_fr" type="12" value="" out="N"/>
				<param name="cre_dt_to" type="12" value="" out="N"/>
				<param name="acct_cd" type="12" value="" out="N"/>
				<param name="vsl_cls" type="12" value="" out="N"/>
				<param name="lane_cd" type="12" value="" out="N"/>
				<param name="loc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
