<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BudgetPortChargeMgtBCDBDAOsearchEstTgtVvdByMonRSQL">
			<desc><![CDATA[Estimate Expense Creation을 하기 위해 이미 생성한 추정 대상 VVD를 Revenue Month 나 노선 별로 조회한다.

=======================================
history
2012.06.21 진마리아 CHM-201218370-01 추정 관련 로직 변경 (팬드럼 노선)]]></desc>
			<sql><![CDATA[
/*
SELECT
     '' TXTSDATE
    ,'' TXTEDATE
    ,'' REV_YRMON
    ,'' LANE
    ,'' CHK
    ,'' VVD
    ,'' HVVD
    ,'' VSL_CD
    ,'' SKD_VOY_NO
    ,'' SKD_DIR_CD
    ,'' CLPT_IND_SEQ
    ,'' TURN_PORT_FLG
    ,'' TURN_PORT_IND_CD
    ,'' CLPT_SEQ
    ,'' TURN_SKD_VOY_NO
    ,'' TURN_SKD_DIR_CD
    ,'' TURN_CLPT_IND_SEQ
    ,'' VIR_TURN_PORT_FLG
    ,'' VIR_TURN_PORT_IND_CD
    ,'' TMNL_CODE
    ,'' TXTCOLOR
FROM DUAL
*/
SELECT  X.*   FROM    
 (   SELECT  Z.*, CASE WHEN Z.txtColor2 IN ('Pink') THEN 
                          ( SELECT  MAX(  CASE WHEN X.CPLS_FLG = 'Y' AND ( Y.XPR_DESC LIKE '%null%' OR  Y.XPR_DESC LIKE '%no-rate%'  )  THEN  'Pink'
                                               WHEN Y.XPR_DESC IS NULL THEN  'Blue'
                                               ELSE NULL
                                          END )
                              FROM PSO_YD_CHG X, PSO_TGT_YD_EXPN Y
                             WHERE X.YD_CD  = Y.YD_CD 
                               AND Y.VSL_CD = Z.VSL_CD
                               AND Y.SKD_VOY_NO  = Z.SKD_VOY_NO
                               AND Y.SKD_DIR_CD  = Z.SKD_DIR_CD
                               AND Y.PSO_BZTP_CD ='2'
                               AND X.YD_CD       = Z.TMNL_CODE
                               AND X.LST_FLG     = 'Y'
                               AND Y.REV_YRMON BETWEEN TO_CHAR (X.EFF_DT, 'YYYYMM') AND TO_CHAR (X.EXP_DT, 'YYYYMM')
                               AND Z.REV_YRMON BETWEEN TO_CHAR (X.EFF_DT, 'YYYYMM') AND TO_CHAR (X.EXP_DT, 'YYYYMM')
                               AND Y.REV_YRMON BETWEEN TO_CHAR (X.EFF_DT, 'YYYYMM') AND TO_CHAR (X.EXP_DT, 'YYYYMM')
                               AND X.VNDR_SEQ = Y.VNDR_SEQ
                               AND X.LGS_COST_CD = Y.LGS_COST_CD  )
  
                         ELSE  Z.txtColor2
                         END AS txtColor
  
  
  FROM  
  (
        SELECT    ''                                              AS txtsDate
                , ''                                              AS txteDate
                , T1.REV_YRMON
                , SUBSTR(T1.LANE,1,3)                             AS LANE
                , ''                                              AS CHK
                , T1.VSL_CD || T1.SKD_VOY_NO || T1.SKD_DIR_CD     AS VVD
                , T1.VSL_CD || T1.SKD_VOY_NO || T1.SKD_DIR_CD     AS HVVD
                , MAX(T1.VSL_CD)                                  AS VSL_CD
                , MAX(T1.SKD_VOY_NO)                              AS SKD_VOY_NO
                , MAX(T1.SKD_DIR_CD)                              AS SKD_DIR_CD
                , MAX(T1.CLPT_IND_SEQ)                            AS CLPT_IND_SEQ
                , MAX(T1.TURN_PORT_FLG)                           AS TURN_PORT_FLG
                , MAX(T1.TURN_PORT_IND_CD)                        AS TURN_PORT_IND_CD
                , MAX(T1.CLPT_SEQ)                                AS CLPT_SEQ
                , MAX(T1.TURN_SKD_VOY_NO)                         AS TURN_SKD_VOY_NO
                , MAX(T1.TURN_SKD_DIR_CD)                         AS TURN_SKD_DIR_CD
                , MAX(T1.TURN_CLPT_IND_SEQ)                       AS TURN_CLPT_IND_SEQ
                , MAX(T1.VIR_TURN_PORT_FLG)                       AS VIR_TURN_PORT_FLG
                , MAX(T1.VIR_TURN_PORT_IND_CD)                    AS VIR_TURN_PORT_IND_CD
                , T1.YD_CD                                        AS TMNL_CODE
                , DECODE (T1.YD_CD,
                         NULL, 'Red',
                         DECODE (LENGTH (T1.YD_CD),
                                 5, 'Red',
                                 DECODE(    (   SELECT  1
                                                FROM    PSO_YD_CHG X
                                                WHERE   X.YD_CD     = T1.YD_CD
                                                AND     T1.REV_YRMON BETWEEN TO_CHAR (X.EFF_DT, 'YYYYMM') AND TO_CHAR (X.EXP_DT, 'YYYYMM')
                                                AND     LST_FLG     = 'Y'
                                                AND     ROWNUM      <= 1 
                                            )
                                          , NULL, 'Red', 
                                 MAX(CASE WHEN T2.XPR_DESC LIKE '%null%' OR T2.XPR_DESC LIKE '%no-rate%' THEN 'Pink'
                                          WHEN T2.XPR_DESC IS NULL THEN 'Blue' END)
                )))                                                AS txtColor2
        FROM    (
                SELECT  DISTINCT '2'                       AS PSO_BZTP_CD
                        , AV.VSL_CD
                        , AV.SKD_VOY_NO
                        , VP.SKD_DIR_CD
                        , NVL (VP.YD_CD, VP.VPS_PORT_CD)   AS YD_CD
                        , RV.REV_YRMON
                        , VP.SLAN_CD                       AS LANE
                        , VP.CLPT_SEQ
                        , VP.CLPT_IND_SEQ
                        , VP.TURN_PORT_FLG
                        , VP.TURN_PORT_IND_CD
                        , VP.TURN_SKD_VOY_NO
                        , VP.TURN_SKD_DIR_CD
                        , VP.TURN_CLPT_IND_SEQ
                        , (
                        SELECT  TURN_PORT_FLG
                        FROM    VSK_VSL_PORT_SKD
                        WHERE   VSL_CD          =VP.VSL_CD
                        AND     SKD_VOY_NO      =VP.TURN_SKD_VOY_NO
                        AND     SKD_DIR_CD      =VP.TURN_SKD_DIR_CD
                        AND     VPS_PORT_CD     =VP.VPS_PORT_CD
                        AND     CLPT_IND_SEQ    =VP.TURN_CLPT_IND_SEQ
                        )                                 AS VIR_TURN_PORT_FLG
                        , (
                        SELECT  TURN_PORT_IND_CD
                        FROM    VSK_VSL_PORT_SKD
                        WHERE   VSL_CD          =VP.VSL_CD
                        AND     SKD_VOY_NO      =VP.TURN_SKD_VOY_NO
                        AND     SKD_DIR_CD      =VP.TURN_SKD_DIR_CD
                        AND     VPS_PORT_CD     =VP.VPS_PORT_CD
                        AND     CLPT_IND_SEQ    =VP.TURN_CLPT_IND_SEQ
                        )                                 AS VIR_TURN_PORT_IND_CD
                FROM    AR_MST_REV_VVD     AV,
                        MDM_VSL_CNTR       VS,
                        VSK_VSL_SKD        VV,
                        VSK_VSL_PORT_SKD   VP,
                        GL_ESTM_REV_VVD    RV
                WHERE   1=1
                AND     RV.EXE_YRMON > ' '
                AND     RV.REV_YRMON > ' '
                AND     RV.REV_YRMON BETWEEN REPLACE(@[txtsdate], '-','') AND REPLACE(@[txtedate], '-','')
                AND     RV.RLANE_CD  IN (  CASE WHEN VV.VSL_SLAN_CD = (SELECT S.SLAN_CD FROM PSO_PORT_EXPN_DIV S WHERE S.SLAN_CD = VV.VSL_SLAN_CD AND ROWNUM = 1) THEN
                                            (
                                            SELECT  S.RLANE_CD
                                            FROM    PSO_PORT_EXPN_DIV S
                                            WHERE   1=1
                                            AND     S.SLAN_CD       = VV.VSL_SLAN_CD
                                            AND     S.SKD_DIR_CD    = VV.SKD_DIR_CD
                                            AND     S.RLANE_CD      = RV.RLANE_CD
                                            AND     S.LOC_CD        = VP.VPS_PORT_CD
                                            AND     ROWNUM          = 1
                                            )
                                        ELSE
                                            (
                                            SELECT  PSO_GET_REV_LANE_FNC(VP.VSL_CD , VP.SKD_VOY_NO , VP.SKD_DIR_CD , substr(VP.YD_CD , 1, 5 ))
                                            FROM    DUAL
                                            )
                                        END
                                     )
                AND     RTRIM (VS.CNTR_VSL_CLSS_CAPA) IS NOT NULL
                AND     NVL(VV.ACT_CRR_CD,VS.CRR_CD) = 'SML'
                AND     AV.VSL_CD       = VS.VSL_CD
                AND     AV.VSL_CD       = VV.VSL_CD
                AND     AV.SKD_VOY_NO   = VV.SKD_VOY_NO
                AND     AV.SKD_DIR_CD   = VV.SKD_DIR_CD
                AND     AV.VSL_CD       = VP.VSL_CD
                AND     AV.SKD_VOY_NO   = VP.SKD_VOY_NO
                AND     AV.SKD_DIR_CD   = VP.SKD_DIR_CD
                AND     AV.VSL_CD       = RV.VSL_CD
                AND     AV.SKD_VOY_NO   = RV.SKD_VOY_NO
                AND     AV.SKD_DIR_CD   = RV.SKD_DIR_CD
                AND     AV.RLANE_DIR_CD = RV.REV_DIR_CD
                AND     'S'            <> NVL(VP.SKD_CNG_STS_CD, 'X')
                     -- ADDED 2010.05.07
#if(${vvd}!='')
                AND     RV.VSL_CD       = substr(@[vvd], 1, 4)
                AND     RV.SKD_VOY_NO   = substr(@[vvd], 5, 4)
                AND     RV.SKD_DIR_CD   = substr(@[vvd], 9)
#end
                AND     AV.REV_YRMON    = RV.REV_YRMON
                AND     VP.SLAN_CD      = NVL2(@[lane], @[lane], VP.SLAN_CD)
                ) T1,
                PSO_TGT_YD_EXPN T2
        WHERE   T1.PSO_BZTP_CD  = T2.PSO_BZTP_CD(+)
        AND     T1.VSL_CD       = T2.VSL_CD     (+)
        AND     T1.SKD_VOY_NO   = T2.SKD_VOY_NO (+)
        AND     T1.SKD_DIR_CD   = T2.SKD_DIR_CD (+)
        AND     T1.YD_CD        = T2.YD_CD      (+)
        GROUP BY  T1.REV_YRMON, T1.LANE, T1.VSL_CD || T1.SKD_VOY_NO || T1.SKD_DIR_CD, T1.YD_CD 
    )  Z
        ) X
WHERE   1=1
#if(${mismatched}!='')
AND     X.TXTCOLOR IN ('Blue', 'Red', 'Pink')
#end
ORDER BY   X.REV_YRMON, X.LANE, X.VVD,  X.CLPT_SEQ			]]></sql>
			<params>
				<param name="txtsdate" type="12" value="" out="N"/>
				<param name="txtedate" type="12" value="" out="N"/>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="lane" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
