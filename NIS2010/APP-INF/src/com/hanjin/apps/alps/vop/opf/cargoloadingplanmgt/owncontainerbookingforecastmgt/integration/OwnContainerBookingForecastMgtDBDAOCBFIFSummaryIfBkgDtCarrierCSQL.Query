<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="OwnContainerBookingForecastMgtDBDAOCBFIFSummaryIfBkgDtCarrierCSQL">
			<desc><![CDATA[OwnContainerBookingForecastMgtDBDAOCBFIFSummaryIfBkgDtCarrier]]></desc>
			<sql><![CDATA[
INSERT INTO OPF_CGO_BKG_FCAST_SMRY	(VSL_CD
                                    , SKD_VOY_NO
                                    , SKD_DIR_CD
                                    , YD_CD
                                    , POL_CLPT_IND_SEQ
                                    , CRR_CD
                                    , POD_CD
                                    , BLCK_STWG_CD
									, CBF_IND_FLG
                                    , BKG_20FT_QTY
                                    , BKG_40FT_QTY
                                    , BKG_40FT_HC_QTY
                                    , BKG_45FT_HC_QTY
                                    , CRE_USR_ID
                                    , CRE_DT
                                    , UPD_USR_ID
                                    , UPD_DT
                                    )
SELECT  @[vsl_cd]
        , @[skd_voy_no]
        , @[skd_dir_cd]
        , @[pol_cd]
        , @[pol_clpt_ind_seq]
        , 'SML'
        , POD_CD
        , SUBSTR(MLB,3,5)
        , @[cbf_ind_flg],
         SUM(DECODE(Y.CNTR_SZ_CD,'2',FULL_QTY,'3',FULL_QTY)) +  SUM(DECODE(Y.CNTR_SZ_CD,'2',MTY_QTY,'3',MTY_QTY)),
         SUM(DECODE(Y.CNTR_SZ_CD,'4',FULL_QTY)) + SUM(DECODE(Y.CNTR_SZ_CD,'4',MTY_QTY)),
         SUM(DECODE(Y.CNTR_TPSZ_CD,'R8',FULL_QTY,'R9',FULL_QTY,DECODE(Y.CNTR_SZ_CD,'5',FULL_QTY))) +  SUM(DECODE(Y.CNTR_TPSZ_CD,'R8',MTY_QTY,'R9',MTY_QTY, DECODE(Y.CNTR_SZ_CD,'5',MTY_QTY))),
         SUM(DECODE(Y.CNTR_TPSZ_CD,'R8',0,'R9',0, DECODE(Y.CNTR_SZ_CD,'6',FULL_QTY,'7',FULL_QTY,'8',FULL_QTY,'9',FULL_QTY,'W',FULL_QTY,'X',FULL_QTY)))+
         SUM(DECODE(Y.CNTR_TPSZ_CD,'R8',0,'R9',0, DECODE(Y.CNTR_SZ_CD,'6',MTY_QTY,'7',MTY_QTY,'8',MTY_QTY,'9',MTY_QTY,'W',MTY_QTY,'X',MTY_QTY)))
        , @[cre_usr_id]
        , SYSDATE
        , @[upd_usr_id]
        , SYSDATE        
 FROM (
   WITH EQ_CNTR AS
   (  SELECT BKG.BKG_NO ,  
             DECODE(BKG.RD_CGO_FLG,'Y',DECODE(SUBSTR(QTY.CNTR_TPSZ_CD,1,1),'R',SUBSTR(QTY.EQ_SUBST_CNTR_TPSZ_CD,1,1)||SUBSTR(QTY.CNTR_TPSZ_CD,2,1),QTY.CNTR_TPSZ_CD),QTY.CNTR_TPSZ_CD) CNTR_TPSZ_CD , QTY.OP_CNTR_QTY QTY , --QTY.OP_CNTR_QTY - NVL(QTY.EQ_SUBST_CGO_QTY,0) QTY , 
             OPF_BLCK_STWG_CD(VVD.VSL_CD||VVD.SKD_VOY_NO||VVD.SKD_DIR_CD, VVD.POL_YD_CD, VVD.POL_CLPT_IND_SEQ, BKG.BKG_NO) AS MLB , VVD.POD_CD
        FROM BKG_VVD       VVD, 
             BKG_BOOKING   BKG,
             BKG_QUANTITY  QTY
       WHERE VVD.VSL_CD                          = @[vsl_cd]        
         AND VVD.SKD_VOY_NO                      = @[skd_voy_no]    
         AND VVD.SKD_DIR_CD                      = @[skd_dir_cd]    
         AND VVD.POL_YD_CD||VVD.POL_CLPT_IND_SEQ = @[yd_cd]          
         AND VVD.BKG_NO                          = BKG.BKG_NO
        #if(${bkg_sts_cd} != 'All')
         AND BKG.BKG_STS_CD = @[bkg_sts_cd]
        #end
         AND BKG.BKG_STS_CD  <> 'X'
         AND BKG.BKG_NO        = QTY.BKG_NO  
         AND BKG.BKG_CGO_TP_CD ='F'  -- FULL 
         AND QTY.CNTR_TPSZ_CD NOT LIKE 'Q%' 
         ) 
    SELECT X.POD_CD, X.MLB, X.CNTR_TPSZ_CD, SUM(X.QTY) FULL_QTY, 0 MTY_QTY
      FROM  EQ_CNTR  X
     GROUP BY X.POD_CD,  X.MLB, X.CNTR_TPSZ_CD
  UNION ALL 
  SELECT X.POD_CD, X.MLB, X.CNTR_TPSZ_CD, 0 FULL_QTY, ALL_QTY - NVL(BN_QTY,0) MTY_QTY
    FROM (
          SELECT VVD.POD_CD, QTY.CNTR_TPSZ_CD , SUM(OP_CNTR_QTY) ALL_QTY ,
                 OPF_BLCK_STWG_CD(VVD.VSL_CD||VVD.SKD_VOY_NO||VVD.SKD_DIR_CD, VVD.POL_YD_CD, VVD.POL_CLPT_IND_SEQ, BKG.BKG_NO) AS MLB 
            FROM BKG_VVD       VVD, 
                 BKG_BOOKING   BKG,
                 BKG_QUANTITY  QTY,
                 MDM_CNTR_SZ   MCZ
           WHERE VVD.VSL_CD                          = @[vsl_cd]  --HNCH0112W KRPUSHN1
             AND VVD.SKD_VOY_NO                      = @[skd_voy_no]
             AND VVD.SKD_DIR_CD                      = @[skd_dir_cd]
             AND VVD.POL_YD_CD||VVD.POL_CLPT_IND_SEQ = @[yd_cd] 
             AND VVD.BKG_NO                          = BKG.BKG_NO
         	#if(${bkg_sts_cd} != 'All')
          	AND BKG.BKG_STS_CD = @[bkg_sts_cd]
         	#end
             AND BKG.BKG_STS_CD                      <> 'X'
             AND BKG.BKG_NO                          = QTY.BKG_NO  
             AND BKG.BKG_CGO_TP_CD                   <> 'F'
             AND QTY.CNTR_TPSZ_CD                    NOT LIKE 'Q%'
             AND SUBSTR(QTY.CNTR_TPSZ_CD,2,1)        = MCZ.CNTR_SZ_CD
         GROUP BY VVD.POD_CD, QTY.CNTR_TPSZ_CD,   
                   OPF_BLCK_STWG_CD(VVD.VSL_CD||VVD.SKD_VOY_NO||VVD.SKD_DIR_CD, VVD.POL_YD_CD, VVD.POL_CLPT_IND_SEQ, BKG.BKG_NO)) X , (
                    SELECT OPF_BLCK_STWG_CD(VVD.VSL_CD||VVD.SKD_VOY_NO||VVD.SKD_DIR_CD, VVD.POL_YD_CD, VVD.POL_CLPT_IND_SEQ, BKG.BKG_NO) AS MLB, 
                           BC.CNTR_TPSZ_CD, COUNT(1) BN_QTY
                      FROM BKG_VVD       VVD, 
               BKG_BOOKING   BKG,
               BKG_CONTAINER BC      
        WHERE VVD.VSL_CD                          = @[vsl_cd]
          AND VVD.SKD_VOY_NO                      = @[skd_voy_no]
          AND VVD.SKD_DIR_CD                      = @[skd_dir_cd]
          AND VVD.POL_YD_CD||VVD.POL_CLPT_IND_SEQ = @[yd_cd] 
          AND VVD.BKG_NO                          = BKG.BKG_NO
         #if(${bkg_sts_cd} != 'All')
          AND BKG.BKG_STS_CD = @[bkg_sts_cd]
         #end
          AND BKG.BKG_STS_CD  <> 'X'
          AND BKG.BKG_CGO_TP_CD <> 'F'
          AND BKG.BKG_NO = BC.BKG_NO
          AND NVL(BC.MCNTR_BDL_NO,0) <> 0
          AND BC.BDL_BTM_FLG ='N'
        GROUP BY BC.CNTR_TPSZ_CD, 
                 OPF_BLCK_STWG_CD(VVD.VSL_CD||VVD.SKD_VOY_NO||VVD.SKD_DIR_CD, VVD.POL_YD_CD, VVD.POL_CLPT_IND_SEQ, BKG.BKG_NO)
                    ) Y
    WHERE X.MLB = Y.MLB(+)
    AND X.CNTR_TPSZ_CD = Y.CNTR_TPSZ_CD (+)    
        ) X, MDM_CNTR_TP_SZ  Y
   WHERE X.CNTR_TPSZ_CD = Y.CNTR_TPSZ_CD
   GROUP BY  X.MLB, X.POD_CD
   ORDER BY 1			]]></sql>
			<params>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pol_clpt_ind_seq" type="12" value="" out="N"/>
				<param name="cbf_ind_flg" type="12" value="" out="N"/>
				<param name="cre_usr_id" type="12" value="" out="N"/>
				<param name="upd_usr_id" type="12" value="" out="N"/>
				<param name="yd_cd" type="12" value="" out="N"/>
				<param name="bkg_sts_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
