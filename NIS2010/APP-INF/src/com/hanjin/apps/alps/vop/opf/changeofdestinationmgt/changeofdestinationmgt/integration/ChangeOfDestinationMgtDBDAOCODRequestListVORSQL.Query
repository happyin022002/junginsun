<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ChangeOfDestinationMgtDBDAOCODRequestListVORSQL">
			<desc><![CDATA[COD Approval 정보를 조회합니다.
History-------------------------------------
2010.07.26 LHJ [Ticket-ID:CHM-201004935] COD application 조회 기능 추가 요청 및 에러 수정건
2012.10.08 진마리아 CHM-201220208-01 COD APPROVAL 관련 요청 사항 (ETA,경과 시간 표시)]]></desc>
			<sql><![CDATA[
SELECT A.VSL_SLAN_CD
       , A.VVD
       , A.BKG_NO
       , A.COD_RQST_RSN_CD
       , A.OLD_POL
       , A.OLD_POD
       , A.OLD_DEL
       , A.NEW_POL
       , A.NEW_POD
       , A.NEW_DEL
       , COUNT(C.CNTR_NO) CNTR_QTY
       , A.COD_RQST_OFC_CD
       , A.COD_STS_CD
       , A.CHG_AMT
       , A.DIFF_RMK
       , A.BL_NO
       , A.COD_RQST_SEQ
       , A.COD_RHND_PORT_CD
       , A.ACT_DEPT_YN
       , A.POD_ETA_DT
       , A.COD_EMAIL_SEND_YN
       , A.NEW_VSL_CD
       , A.NEW_SKD_VOY_NO
       , A.NEW_SKD_DIR_CD
       , A.COD_RHND_PORT_YD_CD
       , (SELECT   MIN(TO_CHAR(PS.VPS_ETA_DT,'YYYY-MM-DD HH24:MI'))
          FROM     VSK_VSL_PORT_SKD   PS
          WHERE    PS.VSL_CD          = A.NEW_VSL_CD
          AND      PS.SKD_VOY_NO      = A.NEW_SKD_VOY_NO
          AND      PS.SKD_DIR_CD      = A.NEW_SKD_DIR_CD
          AND      PS.VPS_PORT_CD     = A.COD_RHND_PORT_CD
          AND      PS.YD_CD           = A.COD_RHND_PORT_YD_CD
          )                           AS RHND_PORD_ETA_DT
       
       , CASE WHEN MIN(A.FIRST_REACT_DATE) IS NULL THEN
                   CASE WHEN LENGTH(ROUND(SYSDATE - A.REQ_DT,0)) > 3  THEN '999.9'
                        ELSE TO_CHAR(SYSDATE - A.REQ_DT,'FM000.0')
                        END
              WHEN LENGTH(ROUND(MIN(A.FIRST_REACT_DATE) - A.REQ_DT,0)) > 3  THEN '999.9' 
              ELSE TO_CHAR(MIN(A.FIRST_REACT_DATE) - A.REQ_DT,'FM000.0')
              END       AS ELAPSED_DAY
		 
       , TO_CHAR(A.REQ_DT,'YYYY-MM-DD HH24:MI')     AS REQUESTED_DATE 
		, TO_CHAR(MIN(A.FIRST_REACT_DATE),'YYYY-MM-DD HH24:MI')   AS FIRST_REACT_DATE
		, MIN(A.APRV_RJCT_ID)       AS APRV_RJCT_ID  
FROM   (SELECT I.VSL_SLAN_CD
               , I.VVD
               , I.BKG_NO
               , I.COD_RQST_RSN_CD
               , I.OLD_POL
               , I.OLD_POD
               , I.OLD_DEL
               , I.NEW_POL
               , I.NEW_POD
               , I.NEW_DEL
               , I.COD_RQST_OFC_CD
               , I.COD_STS_CD
               , ( SELECT SUM(CHG_AMT)
                   FROM   BKG_COD_COST C
                   WHERE  I.BKG_NO = C.BKG_NO
                   AND    I.COD_RQST_SEQ = C.COD_RQST_SEQ ) CHG_AMT
               , I.DIFF_RMK
               , I.BL_NO
               , I.COD_RQST_SEQ
               , I.COD_RHND_PORT_CD
               , I.ACT_DEPT_YN
               , I.POD_ETA_DT
               , I.COD_EMAIL_SEND_YN
               , I.NEW_VSL_CD
               , I.NEW_SKD_VOY_NO
               , I.NEW_SKD_DIR_CD
               , I.COD_RHND_PORT_YD_CD
								    /* REQUESTED_DATE */
				,   (SELECT   MIN(HIS.CRE_DT)                                       
								    FROM     BKG_COD_HIS          HIS
								    WHERE    HIS.BKG_NO           = I.BKG_NO
								    AND      HIS.COD_RQST_SEQ     = I.COD_RQST_SEQ
								    AND      HIS.COD_STS_CD       = 'R'
								    )    AS REQ_DT
								    /* FIRST_REACT_DATE */
				,   (SELECT   MIN(HIS.CRE_DT)                                       
								    FROM     BKG_COD_HIS          HIS
								    WHERE    HIS.BKG_NO           = I.BKG_NO
								    AND      HIS.COD_RQST_SEQ     = I.COD_RQST_SEQ
								    AND      HIS.COD_STS_CD       <> 'R'
								    )                             AS FIRST_REACT_DATE   	    
				,   (SELECT   HIS.CRE_USR_ID                                       
								    FROM     BKG_COD_HIS          HIS
								    WHERE    HIS.BKG_NO           = I.BKG_NO
								    AND      HIS.COD_RQST_SEQ     = I.COD_RQST_SEQ
								    AND      HIS.COD_STS_CD       IN ('Y','N')
								    AND      HIS.COD_HIS_SEQ      = (SELECT    MAX(HIST.COD_HIS_SEQ)
								                                     FROM      BKG_COD_HIS        HIST
								                                     WHERE     HIST.BKG_NO        = HIS.BKG_NO
								                                     AND       HIST.COD_RQST_SEQ  = HIS.COD_RQST_SEQ
								                                     AND       HIST.COD_STS_CD    IN ('Y','N')
								                                    )
						)                             AS APRV_RJCT_ID
        FROM   (
                 SELECT VS.VSL_SLAN_CD
                        , BC.OLD_VSL_CD||BC.OLD_SKD_VOY_NO||BC.OLD_SKD_DIR_CD VVD
                        , BC.BKG_NO
                        , BC.COD_RQST_RSN_CD
                        , SUBSTR(BC.OLD_POL_YD_CD, 1, 5) OLD_POL
                        , SUBSTR(BC.OLD_POD_YD_CD, 1, 5) OLD_POD
                        , SUBSTR(BC.OLD_DEL_YD_CD, 1, 5) OLD_DEL
                        , SUBSTR(BC.NEW_POL_YD_CD, 1, 5) NEW_POL
                        , SUBSTR(BC.NEW_POD_YD_CD, 1, 5) NEW_POD
                        , SUBSTR(BC.NEW_DEL_YD_CD, 1, 5) NEW_DEL
                        , BC.COD_RQST_OFC_CD
                        , BC.COD_STS_CD
                        , BC.DIFF_RMK
                        , BB.BL_NO
                        , MAX(BC.COD_RQST_SEQ) COD_RQST_SEQ
                        , BC.COD_RHND_PORT_CD
                        , DECODE(BC.COD_STS_CD, 'R', DECODE(VAPS.ACT_DEP_DT, NULL, 'Y', 'N'), 'Y') ACT_DEPT_YN
                        , BB.POD_ETA_DT
                        , CASE WHEN BB.POD_ETA_DT > SYSDATE THEN 'Y' ELSE 'N'
                          END COD_EMAIL_SEND_YN
                        , BC.NEW_VSL_CD
                        , BC.NEW_SKD_VOY_NO
                        , BC.NEW_SKD_DIR_CD
                        , BC.COD_RHND_PORT_YD_CD
						, BC.CRE_DT     -- REQ_DT 로 변경
                 FROM   BKG_COD BC ,
                        VSK_VSL_SKD VS ,
                        BKG_COD_CNTR BCN ,
                        BKG_BOOKING BB ,
                        VSK_ACT_PORT_SKD VAPS
                 WHERE  BC.OLD_VSL_CD     = VS.VSL_CD(+)
                 AND    BC.OLD_SKD_VOY_NO = VS.SKD_VOY_NO(+)
                 AND    BC.OLD_SKD_DIR_CD = VS.SKD_DIR_CD(+)
                 AND    BC.OLD_VSL_CD     = VAPS.VSL_CD(+)
                 AND    BC.OLD_SKD_VOY_NO = VAPS.SKD_VOY_NO(+)
                 AND    BC.OLD_SKD_DIR_CD = VAPS.SKD_DIR_CD(+)
                 AND    SUBSTR(BC.OLD_POD_YD_CD, 1, 5) = VAPS.VPS_PORT_CD(+)
                 AND    BC.RGN_CD         = @[rso]
                 #if (${slan_cd} != '')
                 AND    VS.VSL_SLAN_CD    = @[slan_cd]
                 #end
                 #if (${vsl_cd} != '')
                 AND    ( BC.OLD_VSL_CD     = @[vsl_cd] )
                 #end
                 #if (${skd_voy_no} != '')
                 AND    ( BC.OLD_SKD_VOY_NO = @[skd_voy_no] )
                 #end
                 #if (${skd_dir_cd} != '')
                 AND    ( BC.OLD_SKD_DIR_CD = @[skd_dir_cd] )
                 #end
                 #if (${cod_sts_cd} != '')
                 AND    BC.COD_STS_CD     = @[cod_sts_cd]
                 #end
                 #if (${cod_rqst_rsn_cd} != 'All')
                 AND    BC.COD_RQST_RSN_CD     = @[cod_rqst_rsn_cd]
                 #end
                 #if (${bkg_no} != '')
                 AND    BC.BKG_NO     = @[bkg_no]
                 #end
                 AND    DECODE(BC.COD_MNL_FLG, 'Y', 'Y', 'N') = 'N'
                 AND    BCN.COD_SLCT_FLG = 'Y'
                 AND    BC.COD_STS_CD != 'M'
                 AND    BC.BKG_NO = BCN.BKG_NO
                 AND    BC.COD_RQST_SEQ = BCN.COD_RQST_SEQ
                 AND    BC.BKG_NO = BB.BKG_NO
                 AND    BC.COD_STS_CD IS NOT NULL
                 #if (${fr_dt} != '' && ${to_dt} != '')
			     AND    BC.CRE_DT BETWEEN  TO_DATE(@[fr_dt],'YYYY-MM-DD') AND TO_DATE(@[to_dt],'YYYY-MM-DD')+1
			     #end  
                 GROUP BY VS.VSL_SLAN_CD
                          , BC.OLD_VSL_CD||BC.OLD_SKD_VOY_NO||BC.OLD_SKD_DIR_CD
                          , BC.BKG_NO
                          , BC.COD_RQST_RSN_CD
                          , BC.OLD_POL_YD_CD
                          , BC.OLD_POD_YD_CD
                          , BC.OLD_DEL_YD_CD
                          , BC.NEW_POL_YD_CD
                          , BC.NEW_POD_YD_CD
                          , BC.NEW_DEL_YD_CD
                          , BC.COD_RQST_OFC_CD
                          , BC.COD_STS_CD
                          , BC.DIFF_RMK
                          , BB.BL_NO
                          , BC.COD_RHND_PORT_CD
                          , DECODE(BC.COD_STS_CD, 'R', DECODE(VAPS.ACT_DEP_DT, NULL, 'Y', 'N'), 'Y')
                          , BB.POD_ETA_DT
                          , BC.NEW_VSL_CD
                          , BC.NEW_SKD_VOY_NO
                          , BC.NEW_SKD_DIR_CD
                          , BC.COD_RHND_PORT_YD_CD 
						  , BC.CRE_DT 

               ) I
       ) A,
       BKG_COD_CNTR C
WHERE  A.BKG_NO = C.BKG_NO
AND    A.COD_RQST_SEQ = C.COD_RQST_SEQ
 /* COD Request 3일이내 데이터만 조회처리 */
--AND    SYSDATE - GLOBALDATE_PKG.TIME_CONV_FNC(A.OLD_POL,A.COD_ISS_DT,'KRPUS') <= 3
GROUP BY A.VSL_SLAN_CD
         , A.VVD
         , A.BKG_NO
         , A.COD_RQST_RSN_CD
         , A.OLD_POL
         , A.OLD_POD
         , A.OLD_DEL
         , A.NEW_POL
         , A.NEW_POD
         , A.NEW_DEL
         , A.COD_RQST_OFC_CD
         , A.COD_STS_CD
         , A.CHG_AMT
         , A.DIFF_RMK
         , A.BL_NO
         , A.COD_RQST_SEQ
         , A.COD_RHND_PORT_CD
         , A.ACT_DEPT_YN
         , A.POD_ETA_DT
         , A.COD_EMAIL_SEND_YN
         , A.NEW_VSL_CD
         , A.NEW_SKD_VOY_NO
         , A.NEW_SKD_DIR_CD
         , A.COD_RHND_PORT_YD_CD 
		 , A.REQ_DT
ORDER BY A.VSL_SLAN_CD, A.VVD, A.BKG_NO, A.COD_RQST_RSN_CD			]]></sql>
			<params>
				<param name="rso" type="12" value="" out="N"/>
				<param name="slan_cd" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="cod_sts_cd" type="12" value="" out="N"/>
				<param name="cod_rqst_rsn_cd" type="12" value="" out="N"/>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="fr_dt" type="12" value="" out="N"/>
				<param name="to_dt" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
