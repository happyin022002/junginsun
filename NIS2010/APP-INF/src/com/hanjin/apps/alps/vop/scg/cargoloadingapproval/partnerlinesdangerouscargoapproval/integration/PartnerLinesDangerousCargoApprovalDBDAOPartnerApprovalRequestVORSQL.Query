<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="PartnerLinesDangerousCargoApprovalDBDAOPartnerApprovalRequestVORSQL">
			<desc><![CDATA[SPCL CGO APVL for Partner Lines 의 Request 조회
--------------------------------------------------------------------------------------------
2012.01.11 김민아 [CHM-201115273-01] [VOP-SCG] SPCL CGO APVL for Partner Lines - AWK 보완]]></desc>
			<sql><![CDATA[
SELECT 
    RQS.DG_FLG 
,   RQS.AWK_FLG 
,   RQS.RGN_SHP_OPR_CD 
,   RQS.VSL_CD
,   RQS.SKD_VOY_NO
,	RQS.SKD_DIR_CD
,	RQS.SLAN_CD
,   RQS.CRR_CD
,	CGO.CGO_OPR_CD
,	RQS.POL_CD||RQS.POL_CLPT_IND_SEQ AS POL_CD
,   RQS.POL_CLPT_IND_SEQ
,	TO_CHAR(RQS.ETA_DT, 'YYYY-MM-DD HH24:MI') ETA_DT
,	RQS.POD_CD||RQS.POD_CLPT_IND_SEQ AS POD_CD
,   RQS.POD_CLPT_IND_SEQ
,	RQS.BKG_REF_NO
,	RQS.SPCL_CGO_RQST_SEQ
,	CGO.SPCL_CNTR_SEQ
,	CGO.SPCL_CGO_SEQ
,	CGO.AUTH_STS_CD
,	DECODE(CGO.APRO_REF_NO,'0','',CGO.APRO_REF_NO) APRO_REF_NO
,	CGO.CNTR_TPSZ_CD
,	DECODE(CGO.CMDT_DESC,'0','',CGO.CMDT_DESC) CMDT_DESC
,	CGO.TTL_DIM_LEN
,	CGO.TTL_DIM_WDT
,	CGO.TTL_DIM_HGT
,	CGO.FWRD_OVR_DIM_LEN
,	CGO.BKWD_OVR_DIM_LEN
,	CGO.LF_SD_OVR_DIM_LEN
,	CGO.RT_SD_OVR_DIM_LEN
,	CGO.HGT_OVR_DIM_LEN
,	DECODE(CGO.IMDG_UN_NO,'0','',CGO.IMDG_UN_NO) IMDG_UN_NO
,	DECODE(CGO.IMDG_UN_NO_SEQ,'0','',CGO.IMDG_UN_NO_SEQ) IMDG_UN_NO_SEQ
,	CGO.IMDG_CLSS_CD
,   DECODE(CGO.N1ST_IMDG_SUBS_RSK_LBL_CD,'0','',CGO.N1ST_IMDG_SUBS_RSK_LBL_CD) N1ST_IMDG_SUBS_RSK_LBL_CD
,   DECODE(CGO.N2ND_IMDG_SUBS_RSK_LBL_CD,'0','',CGO.N2ND_IMDG_SUBS_RSK_LBL_CD) N2ND_IMDG_SUBS_RSK_LBL_CD
,   DECODE(CGO.N3RD_IMDG_SUBS_RSK_LBL_CD,'0','',CGO.N3RD_IMDG_SUBS_RSK_LBL_CD) N3RD_IMDG_SUBS_RSK_LBL_CD
,   DECODE(CGO.N4TH_IMDG_SUBS_RSK_LBL_CD,'0','',CGO.N4TH_IMDG_SUBS_RSK_LBL_CD) N4TH_IMDG_SUBS_RSK_LBL_CD
,	(DECODE(CGO.N1ST_IMDG_SUBS_RSK_LBL_CD,'0','',CGO.N1ST_IMDG_SUBS_RSK_LBL_CD)||DECODE(NVL(CGO.N2ND_IMDG_SUBS_RSK_LBL_CD,''),'','','0','','/')
   ||DECODE(CGO.N2ND_IMDG_SUBS_RSK_LBL_CD,'0','',CGO.N2ND_IMDG_SUBS_RSK_LBL_CD)||DECODE(NVL(CGO.N3RD_IMDG_SUBS_RSK_LBL_CD,''),'','','0','','/')
   ||DECODE(CGO.N3RD_IMDG_SUBS_RSK_LBL_CD,'0','',CGO.N3RD_IMDG_SUBS_RSK_LBL_CD)||DECODE(NVL(CGO.N4TH_IMDG_SUBS_RSK_LBL_CD,''),'','','0','','/')
   ||DECODE(CGO.N4TH_IMDG_SUBS_RSK_LBL_CD,'0','',CGO.N4TH_IMDG_SUBS_RSK_LBL_CD)) IMDG_SUBS_RSK_LBL_CD
,	CGO.MRN_POLUT_FLG
,   DECODE(CGO.IMDG_PCK_GRP_CD,'1','I','2','II','3','III','') IMDG_PCK_GRP_CD
,	CGO.IMDG_LMT_QTY_FLG
,	CGO.IMDG_EXPT_QTY_FLG
,   DECODE(CGO.FLSH_PNT_CDO_TEMP,'0','',CGO.FLSH_PNT_CDO_TEMP) FLSH_PNT_CDO_TEMP
,	CGO.GRS_WGT
,	CGO.NET_WGT
,	CGO.GRS_CAPA_QTY
,	CGO.VOID_SLT_QTY
,   DECODE(CGO.PSA_NO,'0','',CGO.PSA_NO) PSA_NO
,	TO_CHAR(CGO.CGO_RQST_DT,'YYYY-MM-DD') CGO_RQST_DT -- TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC('KRPUS',CGO.CGO_RQST_DT,'GMT'),'YYYY-MM-DD') 
,	DECODE(CGO.AUTH_STS_CD,'R','',TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC('KRPUS',CGO.AUTH_DT,'GMT'),'YYYY-MM-DD HH24:MI:SS')) AUTH_DT
,	RQS.CRE_USR_ID
,	RQS.UPD_USR_ID
,	RQS.UPD_DT
,   DECODE(RQS.DG_FLG,'Y','DG','AK') SCG_FLG
,   CGO.AUTH_STS_CD AUTH_FLG
,	RQS.SLAN_CD SLAN_CD1
,   RQS.BKG_REF_NO BOOKING_NO
,   CGO.STS_CT
,   '' FROM_ETA_DT
,   '' TO_ETA_DT

,   DECODE(CGO.CNTR_REF_NO,'0','',CGO.CNTR_REF_NO) CNTR_REF_NO
,   DECODE(CGO.WGT_UT_CD,'0','KGS',CGO.WGT_UT_CD)  WGT_UT_CD
,   DECODE(CGO.WGT_UT_CD,'0','KGS',CGO.WGT_UT_CD)  WGT_UT_CD2
,   CGO.PRP_SHP_NM        PRP_SHP_NM
,   CGO.HZD_DESC          HZD_DESC
,   CGO.DCGO_STS_CD       DCGO_STS_CD
,   DECODE(CGO.EMER_CNTC_PHN_NO,'0','',CGO.EMER_CNTC_PHN_NO) EMER_CNTC_PHN_NO
,   DECODE(CGO.EMER_CNTC_PSON_NM,'0','',CGO.EMER_CNTC_PSON_NM)  EMER_CNTC_PSON_NM
,   DECODE(CGO.CERTI_NO,'0','',CGO.CERTI_NO)                    CERTI_NO
,   DECODE(CGO.DIFF_RMK,'0','',CGO.DIFF_RMK)                    DIFF_RMK

,   DECODE(CGO.OUT_N1ST_IMDG_PCK_QTY,'0','',CGO.OUT_N1ST_IMDG_PCK_QTY)                                   AS OUT_N1ST_IMDG_PCK_QTY
,   DECODE(CGO.OUT_N1ST_IMDG_PCK_CD,'0','',CGO.OUT_N1ST_IMDG_PCK_CD)                                     AS OUT_N1ST_IMDG_PCK_CD
,   (SELECT PK1.IMDG_PCK_DESC FROM SCG_IMDG_PCK_CD PK1 WHERE PK1.IMDG_PCK_CD = CGO.OUT_N1ST_IMDG_PCK_CD) AS OUT_N1ST_IMDG_PCK_DESC
,	DECODE(CGO.OUT_N2ND_IMDG_PCK_QTY,'0','',CGO.OUT_N2ND_IMDG_PCK_QTY)                                   AS OUT_N2ND_IMDG_PCK_QTY
,	DECODE(CGO.OUT_N2ND_IMDG_PCK_CD,'0','',CGO.OUT_N2ND_IMDG_PCK_CD)                                     AS OUT_N2ND_IMDG_PCK_CD
,   (SELECT PK2.IMDG_PCK_DESC FROM SCG_IMDG_PCK_CD PK2 WHERE PK2.IMDG_PCK_CD = CGO.OUT_N2ND_IMDG_PCK_CD) AS OUT_N2ND_IMDG_PCK_DESC
,	DECODE(CGO.IN_N1ST_IMDG_PCK_QTY,'0','',CGO.IN_N1ST_IMDG_PCK_QTY)                                     AS IN_N1ST_IMDG_PCK_QTY
,	DECODE(CGO.IN_N1ST_IMDG_PCK_CD,'0','',CGO.IN_N1ST_IMDG_PCK_CD)                                       AS IN_N1ST_IMDG_PCK_CD
,   (SELECT PK3.IMDG_PCK_DESC FROM SCG_IMDG_PCK_CD PK3 WHERE PK3.IMDG_PCK_CD = CGO.IN_N1ST_IMDG_PCK_CD)  AS IN_N1ST_IMDG_PCK_DESC
,	DECODE(CGO.IN_N2ND_IMDG_PCK_QTY,'0','',CGO.IN_N2ND_IMDG_PCK_QTY)                                     AS IN_N2ND_IMDG_PCK_QTY
,	DECODE(CGO.IN_N2ND_IMDG_PCK_CD,'0','',CGO.IN_N2ND_IMDG_PCK_CD)                                       AS IN_N2ND_IMDG_PCK_CD
,   (SELECT PK4.IMDG_PCK_DESC FROM SCG_IMDG_PCK_CD PK4 WHERE PK4.IMDG_PCK_CD = CGO.IN_N2ND_IMDG_PCK_CD)  AS IN_N2ND_IMDG_PCK_DESC
,	CGO.MAX_IN_PCK_QTY                                                                                   AS MAX_IN_PCK_QTY
,	CGO.MAX_IN_PCK_TP_CD                                                                                 AS MAX_IN_PCK_TP_CD
,   SUN.HCDG_PCK_RSTR_DESC                                                                               AS HCDG_PCK_RSTR_DESC     
,   SUN.HCDG_INTMD_BC_RSTR_DESC                                                                          AS HCDG_INTMD_BC_RSTR_DESC
,   SUN.HCDG_TNK_RSTR_DESC                                                                               AS HCDG_TNK_RSTR_DESC     
,   SUN.IMDG_LMT_QTY                                                                                     AS IMDG_LMT_QTY   
,   SUN.IMDG_EXPT_QTY_CD                                                                                 AS IMDG_EXPT_QTY_CD  

,	DECODE(CGO.EMS_NO,'0','',CGO.EMS_NO)                                       AS EMS_NO
,	DECODE(CGO.CTRL_TEMP_CTNT,'0','',CGO.CTRL_TEMP_CTNT)                       AS CTRL_TEMP_CTNT
,	DECODE(CGO.EMER_RSPN_GID_NO,'0','',CGO.EMER_RSPN_GID_NO)                   AS EMER_RSPN_GID_NO
,	DECODE(CGO.EMER_RSPN_GID_CHR_NO,'0','',CGO.EMER_RSPN_GID_CHR_NO)           AS EMER_RSPN_GID_CHR_NO
,	DECODE(CGO.EMER_TEMP_CTNT,'0','',CGO.EMER_TEMP_CTNT)                       AS EMER_TEMP_CTNT

,	CGO.CNEE_DTL_DESC                              AS CNEE_DTL_DESC
,	CGO.NET_EXPLO_WGT                              AS NET_EXPLO_WGT
,	CGO.RADA_SKD_NO                                AS RADA_SKD_NO
,	CGO.RADA_AMT                                   AS RADA_AMT
,	CGO.RADA_UT_CD                                 AS RADA_UT_CD  
,	CGO.RADA_TRSP_NO                               AS RADA_TRSP_NO
,	CGO.SPCL_CGO_CATE_CD                           AS SPCL_CGO_CATE_CD
,	CGO.AUTH_OFC_CD                                AS AUTH_OFC_CD
,	CGO.AUTH_USR_ID                                AS AUTH_USR_ID
,	CGO.IMDG_CO_GRP_CD                             AS IMDG_CO_GRP_CD
,	CGO.MEAS_QTY                                   AS MEAS_QTY
,	CGO.MEAS_TP_CD                                 AS MEAS_TP_CD
,	CGO.PCK_QTY                                    AS PCK_QTY
,	CGO.PCK_TP_CD                                  AS PCK_TP_CD
,	CGO.CLOD_FLG                                   AS CLOD_FLG
,	CGO.SPCL_STWG_RQST_DESC                        AS SPCL_STWG_RQST_DESC
,	CGO.CGO_LCL_FLG                                AS CGO_LCL_FLG
,   SUN.IMDG_LMT_QTY_MEAS_UT_CD                    AS IMDG_LMT_QTY_MEAS_UT_CD
,   SUN.IMDG_COMP_GRP_CD                           AS IMDG_COMP_GRP_CD
,   SUN.HCDG_FLG                                   AS HCDG_FLG
,   SUN.IMDG_SUBS_RSK_LBL_RMK                      AS IMDG_SUBS_RSK_LBL_RMK
,   (
     SELECT SP.IMDG_SPCL_PROVI_NO 
       FROM SCG_IMDG_UN_NO_SPCL_PROVI SP 
      WHERE SP.IMDG_UN_NO     = CGO.IMDG_UN_NO
        AND SP.IMDG_UN_NO_SEQ = CGO.IMDG_UN_NO_SEQ 
        AND SP.IMDG_SPCL_PROVI_NO = 274
     ) AS IMDG_SPCL_PROVI_NO 
,   SCG_GET_MPA1_NET_FNC(RQS.VSL_CD, RQS.SKD_VOY_NO, RQS.SKD_DIR_CD, RQS.POL_CD, RQS.POD_CD, CGO.IMDG_CLSS_CD) AS NET_WGT_SUM
,   CGO.IMDG_SEGR_GRP_NO
#if (${scg_flg} == 'AWK' || ${scg_flg} == 'SCG_AWK')
,   CASE WHEN CGO.APRO_REF_NO <> '0' THEN  'Dear partner,'||'`'||'`'||
                                           'Approval Ref No : '||CGO.APRO_REF_NO||'`'||
                                                   'VVD : '||(SELECT VSL_ENG_NM FROM MDM_VSL_CNTR WHERE VSL_CD = RQS.VSL_CD)||' '||RQS.SKD_VOY_NO||RQS.SKD_DIR_CD||'`'||
                                                   'POL/POD : '||RQS.POL_CD||'/'||RQS.POD_CD||'`'||
                                                   'ETA POL : '||TO_CHAR(RQS.ETA_DT, 'YYYY-MM-DD')||'`'||
                                                   'CNTR :'||CGO.CNTR_TPSZ_CD||' x '||
                                                   ( SELECT MAX(SPCL_CNTR_SEQ) 
                                                       FROM SCG_PRNR_APRO_RQST_CGO A
                                                      WHERE RQS.CRR_CD            = A.CRR_CD
                                                        AND RQS.BKG_REF_NO        = A.BKG_REF_NO
                                                        AND RQS.SPCL_CGO_RQST_SEQ = A.SPCL_CGO_RQST_SEQ
                                                        AND RQS.CRR_CD            = A.CRR_CD )||'`'||'`'||
                                                    'Acceptable to load it on subject VVD.'||'`'||
                                                    'Approval subject to safe lashing/stuffing and feasibility to handle in terminal.'||'`'||
                                                    'Void : TEU'
              END AS EMAIL_INFO
#else
,   CASE WHEN CGO.APRO_REF_NO <> '0' THEN  'Dear partner,'||'`'||'`'||
                                           'Approval Ref No : '||CGO.APRO_REF_NO||'`'||
                                                   'VVD : '||(SELECT VSL_ENG_NM FROM MDM_VSL_CNTR WHERE VSL_CD = RQS.VSL_CD)||' '||RQS.SKD_VOY_NO||RQS.SKD_DIR_CD||'`'||
                                                   'POL/POD : '||RQS.POL_CD||'/'||RQS.POD_CD||'`'||
                                                   'ETA POL : '||TO_CHAR(RQS.ETA_DT, 'YYYY-MM-DD')||'`'||
                                                   'CNTR :'||CGO.CNTR_TPSZ_CD||' x '||
                                                   ( SELECT MAX(SPCL_CNTR_SEQ) 
                                                       FROM SCG_PRNR_APRO_RQST_CGO A
                                                      WHERE RQS.CRR_CD            = A.CRR_CD
                                                        AND RQS.BKG_REF_NO        = A.BKG_REF_NO
                                                        AND RQS.SPCL_CGO_RQST_SEQ = A.SPCL_CGO_RQST_SEQ
                                                        AND RQS.CRR_CD            = A.CRR_CD )||'`'||'`'||
                                                    'Acceptable to load it on subject VVD.'||'`'||
                                                    'Approval subject to meet IMDG code, carrier/local regulation and no waste.'||'`'|| 
                                                    'But temperature control should not be required during transportation.'
              END AS EMAIL_INFO
#end
			  
FROM SCG_PRNR_APRO_RQST      RQS
   , (
     SELECT T.*
          , AVG(DECODE(T.AUTH_STS_CD,'Y',1,'N',2,-999)) OVER(PARTITION BY T.CRR_CD, T.BKG_REF_NO, T.SPCL_CGO_RQST_SEQ) STS_CT
       FROM SCG_PRNR_APRO_RQST_CGO T
     ) CGO
   , SCG_IMDG_UN_NO          SUN
WHERE 1=1
#if (${rgn_shp_opr_cd} != '')
  AND RQS.RGN_SHP_OPR_CD    = @[rgn_shp_opr_cd]
#end
#if (${vsl_cd} != '')
  AND RQS.VSL_CD            = @[vsl_cd]
#end
#if (${skd_voy_no} != '')
  AND RQS.SKD_VOY_NO        = @[skd_voy_no]
#end
#if (${skd_dir_cd} != '')
  AND RQS.SKD_DIR_CD        = @[skd_dir_cd]
#end

#if (${scg_flg} == 'DG1' || ${scg_flg} == 'SCG_DG') 
  AND RQS.DG_FLG            = 'Y'
  AND RQS.AWK_FLG           = 'N'
#elseif (${scg_flg} == 'AWK' || ${scg_flg} == 'SCG_AWK' || ${scg_flg} == 'SCG_45') 
  AND RQS.DG_FLG            = 'N'
  AND RQS.AWK_FLG           = 'Y'
#if (${scg_flg} == 'SCG_AWK') 
  AND CGO.CNTR_TPSZ_CD <> 'D7'
#end
#if (${scg_flg} == 'SCG_45') 
  AND CGO.CNTR_TPSZ_CD = 'D7'
#end
#end

  AND RQS.CRR_CD            = CGO.CRR_CD
  AND RQS.BKG_REF_NO        = CGO.BKG_REF_NO
  AND RQS.SPCL_CGO_RQST_SEQ = CGO.SPCL_CGO_RQST_SEQ
  AND CGO.IMDG_UN_NO        = SUN.IMDG_UN_NO(+)
  AND CGO.IMDG_UN_NO_SEQ    = SUN.IMDG_UN_NO_SEQ(+)
  AND RQS.BKG_REF_NO        LIKE @[bkg_ref_no]||'%'

#if (${auth_flg} == 'Y') 
  AND (CGO.STS_CT = 1 OR CGO.AUTH_STS_CD = 'Y')
#elseif (${auth_flg} == 'N') 
  AND (CGO.STS_CT > 1 OR CGO.AUTH_STS_CD = 'N')
#elseif (${auth_flg} == 'YN') 
  AND (CGO.STS_CT >= 1 OR CGO.AUTH_STS_CD = 'Y' OR CGO.AUTH_STS_CD = 'N')
#else

#if (${auth_sts_cd}=='Y')
 AND (CGO.STS_CT >= 1 OR CGO.AUTH_STS_CD = 'Y' OR CGO.AUTH_STS_CD = 'N')
#elseif (${auth_sts_cd}=='R')
 AND CGO.AUTH_STS_CD = @[auth_sts_cd]
#else
-- AND (CGO.AUTH_STS_CD = 'R' OR ((CGO.AUTH_STS_CD = 'Y' OR CGO.AUTH_STS_CD = 'N') AND CGO.STS_CT < 1))
#end

#end

#if (${slan_cd1} != '')
  AND RQS.SLAN_CD = @[slan_cd1]
#end

#if (${pol_cd} != '')
  AND RQS.POL_CD = @[pol_cd]
#end
#if (${pod_cd} != '')
  AND RQS.POD_CD = @[pod_cd]
#end

#if (${cgo_opr_cd} != '')
  AND CGO.CGO_OPR_CD = @[cgo_opr_cd]
#end

#if (${booking_no} != '') 
  AND RQS.BKG_REF_NO = @[booking_no]
#end

#if (${apro_ref_no} != '') 
  AND CGO.APRO_REF_NO = @[apro_ref_no]
#end

#if (${imdg_un_no} != '') 
  AND CGO.IMDG_UN_NO = @[imdg_un_no]
#end
#if (${imdg_un_no_seq} != '') 
  AND CGO.IMDG_UN_NO_SEQ = @[imdg_un_no_seq]
#end
#if (${imdg_clss_cd} != '') 
  AND CGO.IMDG_CLSS_CD = @[imdg_clss_cd]
#end

#if (${prp_shp_nm} != '') 
  AND CGO.PRP_SHP_NM LIKE '%'||@[prp_shp_nm]||'%'
#end

#if (${from_eta_dt} != '' && ${to_eta_dt} != '') 
  AND CGO.CGO_RQST_DT BETWEEN TO_DATE(@[from_eta_dt],'YYYY-MM-DD') AND TO_DATE(@[to_eta_dt],'YYYY-MM-DD')+0.99999
#end

ORDER BY
    RQS.ETA_DT
,   CGO.CGO_OPR_CD
,   RQS.VSL_CD
,   RQS.SKD_VOY_NO
,	RQS.SKD_DIR_CD
,	RQS.POL_CD
,	RQS.POD_CD
,	RQS.BKG_REF_NO
,	RQS.SPCL_CGO_RQST_SEQ
,   CGO.CGO_RQST_DT
,   CGO.SPCL_CNTR_SEQ
,	CGO.SPCL_CGO_SEQ			]]></sql>
			<params>
				<param name="rgn_shp_opr_cd" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="bkg_ref_no" type="12" value="" out="N"/>
				<param name="auth_sts_cd" type="12" value="" out="N"/>
				<param name="slan_cd1" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="cgo_opr_cd" type="12" value="" out="N"/>
				<param name="booking_no" type="12" value="" out="N"/>
				<param name="apro_ref_no" type="12" value="" out="N"/>
				<param name="imdg_un_no" type="12" value="" out="N"/>
				<param name="imdg_un_no_seq" type="12" value="" out="N"/>
				<param name="imdg_clss_cd" type="12" value="" out="N"/>
				<param name="prp_shp_nm" type="12" value="" out="N"/>
				<param name="from_eta_dt" type="12" value="" out="N"/>
				<param name="to_eta_dt" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
