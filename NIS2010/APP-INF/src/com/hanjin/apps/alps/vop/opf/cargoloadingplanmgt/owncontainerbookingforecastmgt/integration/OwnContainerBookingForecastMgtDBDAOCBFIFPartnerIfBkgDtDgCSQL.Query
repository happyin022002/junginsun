<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="OwnContainerBookingForecastMgtDBDAOCBFIFPartnerIfBkgDtDgCSQL">
			<desc><![CDATA[Partner CLL의 DG 정보 입력]]></desc>
			<sql><![CDATA[
INSERT INTO OPF_CGO_BKG_FCAST_SPCL_SMRY (
 VSL_CD
,SKD_VOY_NO
,SKD_DIR_CD
,YD_CD
,POL_CLPT_IND_SEQ
,CRR_CD
,POD_CD
,BLCK_STWG_CD
,CBF_SPCL_SMRY_SEQ
,CNTR_TPSZ_CD
,DCGO_FLG
,IMDG_UN_NO
,IMDG_CLSS_CD
,MRN_POLUT_FLG
,CNTR_QTY
,AWK_CGO_FLG             
,FWRD_OVR_DIM_LEN        
,BKWD_OVR_DIM_LEN 
,HGT_OVR_DIM_LEN
,LF_SD_OVR_DIM_LEN      
,RT_SD_OVR_DIM_LEN
,CRE_USR_ID
,CRE_DT
,UPD_USR_ID
,UPD_DT
,BKG_NO
)
WITH DG_CGO AS (
    SELECT ROW_NUMBER() OVER(PARTITION BY CNTR_NO ORDER BY POD_CD,CNTR_NO, IMDG_UN_NO, IMDG_CLSS_CD, MRN_POLUT_FLG) NSEQ, 
           COUNT(1) OVER(PARTITION BY CNTR_NO ) CNT, 
           X.*
      FROM (
         SELECT DISTINCT Y.CNTR_NO, Y.CNTR_TPSZ_CD, Y.IMDG_UN_NO,       Y.IMDG_CLSS_CD, Y.MRN_POLUT_FLG, 
                              Y.POD_CD,  Y.YD_CD,        Y.POL_CLPT_IND_SEQ, Y.CRR_CD,       Y.AWK_CGO_FLG,
                              Y.FWRD_OVR_DIM_LEN,        Y.BKWD_OVR_DIM_LEN, Y.HGT_OVR_DIM_LEN,
                              Y.LF_SD_OVR_DIM_LEN,       Y.RT_SD_OVR_DIM_LEN
          FROM (     SELECT  MAX(A.EDI_RCV_DT) AS EDI_RCV_DT ,   MAX(A.EDI_SND_ID) AS EDI_SND_ID 
                       FROM OPF_PRNR_EDI_CGO_BKG_FCAST A
                      WHERE A.VSL_CD     = @[vsl_cd]
                        AND A.SKD_VOY_NO = @[skd_voy_no]
                        AND A.SKD_DIR_CD = @[skd_dir_cd]
                        AND A.YD_CD            = @[pol_cd]
				        AND A.POL_CLPT_IND_SEQ = @[pol_clpt_ind_seq]
				        AND A.UPLD_DT IS NULL
                        AND NOT EXISTS (    SELECT DISTINCT EDI_RCV_DT, EDI_SND_ID FROM OPF_PRNR_EDI_CGO_BKG_FCAST
                                             WHERE EDI_RCV_DT       = A.EDI_RCV_DT
                                               AND EDI_SND_ID       = A.EDI_SND_ID
                                               AND ( CRR_CD IS NULL OR POD_CD IS NULL OR CNTR_TPSZ_CD IS NULL ) ) ) X, OPF_PRNR_EDI_CGO_BKG_FCAST Y
             WHERE X.EDI_RCV_DT = Y.EDI_RCV_DT
               AND X.EDI_SND_ID = Y.EDI_SND_ID
               AND Y.DCGO_FLG   = 'Y'  ) X )
 SELECT
 @[vsl_cd]
,@[skd_voy_no]
,@[skd_dir_cd]
,@[pol_cd]
,Z.POL_CLPT_IND_SEQ
,Z.CRR_CD
,Z.POD_CD
,SUBSTR(Z.POD_CD,3,3)
, CBF_SPCL_SMRY_SEQ+ ROWNUM
,Z.CNTR_TPSZ_CD
,'Y'
,Z.IMDG_UN_NO
,Z.IMDG_CLSS_CD
,Z.MRN_POLUT_FLG
,Z.CNT
,Z.AWK_CGO_FLG             
,Z.FWRD_OVR_DIM_LEN        
,Z.BKWD_OVR_DIM_LEN 
,Z.HGT_OVR_DIM_LEN
,Z.LF_SD_OVR_DIM_LEN      
,Z.RT_SD_OVR_DIM_LEN
,@[cre_usr_id]
,SYSDATE
,@[upd_usr_id]
,SYSDATE
,Z.BKG_NO
  FROM  (  
  SELECT 'NO',                      A.CRR_CD,                  A.POD_CD,           A.YD_CD,         A.POL_CLPT_IND_SEQ, 
         A.AWK_CGO_FLG,             A.FWRD_OVR_DIM_LEN,        A.BKWD_OVR_DIM_LEN, A.HGT_OVR_DIM_LEN,
         A.LF_SD_OVR_DIM_LEN,       A.RT_SD_OVR_DIM_LEN,
         A.CNTR_TPSZ_CD, A.IMDG_UN_NO, A.IMDG_CLSS_CD, A.MRN_POLUT_FLG,  COUNT(1) AS CNT, NULL AS BKG_NO ,
		 ( SELECT NVL(MAX(CBF_SPCL_SMRY_SEQ),0)
                    FROM OPF_CGO_BKG_FCAST_SPCL_SMRY
                   WHERE VSL_CD     =  @[vsl_cd]
                     AND SKD_VOY_NO =  @[skd_voy_no]
                     AND SKD_DIR_CD =  @[skd_dir_cd]
                     AND YD_CD      =  @[pol_cd]
                     AND POL_CLPT_IND_SEQ = @[pol_clpt_ind_seq] ) AS CBF_SPCL_SMRY_SEQ 
   FROM DG_CGO A 
  WHERE A.CNT = 1  -- NO_CO_LOAD
  GROUP BY A.CRR_CD,       A.POD_CD,     A.YD_CD,        A.POL_CLPT_IND_SEQ, 
           A.AWK_CGO_FLG,   A.FWRD_OVR_DIM_LEN,        A.BKWD_OVR_DIM_LEN, A.HGT_OVR_DIM_LEN,
                              A.LF_SD_OVR_DIM_LEN,       A.RT_SD_OVR_DIM_LEN,
           A.CNTR_TPSZ_CD, A.IMDG_UN_NO, A.IMDG_CLSS_CD, A.MRN_POLUT_FLG
 UNION 
 SELECT 'CO', A.CRR_CD,  A.POD_CD,     A.YD_CD,        A.POL_CLPT_IND_SEQ, 
  A.AWK_CGO_FLG,   A.FWRD_OVR_DIM_LEN,        A.BKWD_OVR_DIM_LEN, A.HGT_OVR_DIM_LEN,
                              A.LF_SD_OVR_DIM_LEN,       A.RT_SD_OVR_DIM_LEN,
         A.CNTR_TPSZ_CD, A.IMDG_UN_NO, A.IMDG_CLSS_CD, A.MRN_POLUT_FLG,  1 AS CNT 
        , ( SELECT MIN(EDI_BL_NO)
              FROM OPF_PRNR_EDI_CGO_BKG_FCAST
                    WHERE VSL_CD     =  @[vsl_cd]
                      AND SKD_VOY_NO =  @[skd_voy_no]
                      AND SKD_DIR_CD =  @[skd_dir_cd]
                      AND YD_CD      =  @[pol_cd]
                      AND CRR_CD     = A.CRR_CD
                      AND POL_CLPT_IND_SEQ = @[pol_clpt_ind_seq] 
                      AND CNTR_NO    =  A.CNTR_NO )
         ,( SELECT NVL(MAX(CBF_SPCL_SMRY_SEQ),0)
                    FROM OPF_CGO_BKG_FCAST_SPCL_SMRY
                    WHERE VSL_CD     =  @[vsl_cd]
                      AND SKD_VOY_NO =  @[skd_voy_no]
                      AND SKD_DIR_CD =  @[skd_dir_cd]
                      AND YD_CD      =  @[pol_cd]
                      AND POL_CLPT_IND_SEQ = @[pol_clpt_ind_seq] ) AS CBF_SPCL_SMRY_SEQ 
   FROM DG_CGO A 
  WHERE A.CNT <> 1  -- CO_LOAD
    AND A.NSEQ = 1 ) Z			]]></sql>
			<params>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pol_clpt_ind_seq" type="12" value="" out="N"/>
				<param name="cre_usr_id" type="12" value="" out="N"/>
				<param name="upd_usr_id" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
