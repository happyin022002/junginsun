<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="OwnContainerBookingForecastMgtDBDAOCBFIFSummaryIfBkgDtDgDtlCSQL">
			<desc><![CDATA[OwnContainerBookingForecastMgtDBDAOCBFIFSummaryIfBkgDtDgDtl]]></desc>
			<sql><![CDATA[
--HJGO0013W 때문에 길어짐
INSERT INTO OPF_CGO_BKG_FCAST_DG_DTL ( VSL_CD,
                                          SKD_VOY_NO,
                                          SKD_DIR_CD,
                                          YD_CD,
                                          POL_CLPT_IND_SEQ,
                                          CRR_CD,
                                          POD_CD,
                                          BLCK_STWG_CD,
                                          CBF_SMRY_SEQ,
                                          CBF_SMRY_DCGO_SEQ,
                                          CNTR_TPSZ_CD,
                                          IMDG_UN_NO,
                                          IMDG_CLSS_CD,
                                          MRN_POLUT_FLG,
                                          IMDG_LMT_QTY_FLG,
                                          IMDG_SUBS_RSK_LBL_CD,
                                          CRE_USR_ID,
                                          CRE_DT,
                                          UPD_USR_ID,
                                          UPD_DT )
 SELECT 
        VSL_CD
        , SKD_VOY_NO
        , SKD_DIR_CD
        , YD_CD
        , POL_CLPT_IND_SEQ
        , CRR_CD
        , POD_CD
        , BLCK_STWG_CD
        , CBF_SPCL_SMRY_SEQ
        , CBF_SMRY_DCGO_SEQ + ROWNUM
        , CNTR_TPSZ_CD 
        , IMDG_UN_NO
        , IMDG_CLSS_CD
        , MRN_POLUT_FLG
        , IMDG_LMT_QTY_FLG
        , IMDG_SUBS_RSK_LBL_CD1
        ,@[cre_usr_id]
        , SYSDATE
        ,@[upd_usr_id]
        , SYSDATE        
FROM    ( 
 WITH DG_BKG AS (  
     SELECT DISTINCT C.CNTR_NO, B.BKG_NO, D.CBF_SPCL_SMRY_SEQ, D.DG_CNTR_SEQ, D.POL_CLPT_IND_SEQ , D.YD_CD,
                     D.CRR_CD,  D.POD_CD, D.BLCK_STWG_CD, D.CNTR_TPSZ_CD, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD
       FROM BKG_VVD A, BKG_BOOKING B, BKG_DG_CGO C, OPF_CGO_BKG_FCAST_SPCL_SMRY D
      WHERE A.VSL_CD     = D.VSL_CD
        AND A.SKD_VOY_NO = D.SKD_VOY_NO
        AND A.SKD_DIR_CD = D.SKD_DIR_CD
        AND D.YD_CD      = A.POL_YD_CD
        AND A.POL_CLPT_IND_SEQ  = D.POL_CLPT_IND_SEQ
        AND A.VSL_CD     = @[vsl_cd]
        AND A.SKD_VOY_NO = @[skd_voy_no]
        AND A.SKD_DIR_CD = @[skd_dir_cd]
        AND A.POL_YD_CD  = @[pol_cd]
        AND A.POL_CLPT_IND_SEQ =  @[pol_clpt_ind_seq]
        AND D.CRR_CD           ='SML'
        AND D.DCGO_FLG         ='Y'
        AND A.BKG_NO     = B.BKG_NO
        AND B.BKG_NO     = C.BKG_NO 
        AND B.BKG_NO     = D.BKG_NO),
    SPLIT_BKG AS (
       SELECT B.FM_BKG_NO,B.BKG_NO, B.BKG_CRE_TP_CD ,B.SPLIT_FLG, A.CNTR_TPSZ_CD, A.IMDG_UN_NO, A.IMDG_CLSS_CD , A.CBF_SPCL_SMRY_SEQ,
               A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.BLCK_STWG_CD, A.POD_CD, A.CRR_CD,
               A.DG_CNTR_SEQ, A.POL_CLPT_IND_SEQ , A.YD_CD
         FROM OPF_CGO_BKG_FCAST_SPCL_SMRY A, BKG_BOOKING B
        WHERE A.BKG_NO = B.BKG_NO
          AND A.VSL_CD     =  @[vsl_cd]
          AND A.SKD_VOY_NO =  @[skd_voy_no]
          AND A.SKD_DIR_CD =  @[skd_dir_cd]
          AND A.YD_CD  =      @[pol_cd]
          AND A.POL_CLPT_IND_SEQ =  @[pol_clpt_ind_seq]
          AND A.CRR_CD           ='SML'
          AND A.DCGO_FLG         ='Y' 
          AND B.SPLIT_FLG        ='Y'
          AND NOT EXISTS ( SELECT * FROM BKG_DG_CGO WHERE BKG_NO = A.BKG_NO ) )

 SELECT DISTINCT Z.VSL_CD, Z.SKD_VOY_NO, Z.SKD_DIR_CD, Z.YD_CD, Z.POL_CLPT_IND_SEQ, Z.CRR_CD,
                         Z.POD_CD,Z.BLCK_STWG_CD, Z.CBF_SPCL_SMRY_SEQ,  
                          ( SELECT NVL(MAX(CBF_SMRY_DCGO_SEQ),0) 
                             FROM  OPF_CGO_BKG_FCAST_DG_DTL
                            WHERE  VSL_CD      =  @[vsl_cd]
                              AND  SKD_VOY_NO  =  @[skd_voy_no]
                              AND  SKD_DIR_CD  =  @[skd_dir_cd]
                              AND  YD_CD       =  @[pol_cd]
                              AND  POL_CLPT_IND_SEQ =  @[pol_clpt_ind_seq] ) AS CBF_SMRY_DCGO_SEQ,
                            Z.CNTR_TPSZ_CD ,  Z.IMDG_UN_NO,Z.IMDG_CLSS_CD,
                            Z.MRN_POLUT_FLG, Z.IMDG_LMT_QTY_FLG, Z.IMDG_SUBS_RSK_LBL_CD1
 FROM ( 
SELECT DISTINCT X.BKG_NO,X.CNTR_NO, X.CBF_SPCL_SMRY_SEQ, X.DG_CNTR_SEQ, X.POL_CLPT_IND_SEQ ,X.YD_CD,
                         X.CRR_CD, X.POD_CD, X.BLCK_STWG_CD,X.CNTR_TPSZ_CD, X.IMDG_UN_NO, X.IMDG_CLSS_CD,
                         X.MRN_POLUT_FLG,X.IMDG_LMT_QTY_FLG, X.IMDG_SUBS_RSK_LBL_CD1 , X.VSL_CD, X.SKD_VOY_NO, X.SKD_DIR_CD
    FROM (
     
         SELECT  DISTINCT B.BKG_NO, C.CNTR_NO, D.CBF_SPCL_SMRY_SEQ, D.DG_CNTR_SEQ, D.POL_CLPT_IND_SEQ ,D.YD_CD,
                         D.CRR_CD, D.POD_CD, D.BLCK_STWG_CD, D.CNTR_TPSZ_CD, C.IMDG_UN_NO, C.IMDG_CLSS_CD,
                         C.MRN_POLUT_FLG,C.IMDG_LMT_QTY_FLG, C.IMDG_SUBS_RSK_LBL_CD1 , D.VSL_CD, D.SKD_VOY_NO, D.SKD_DIR_CD  
                   FROM  BKG_VVD A,BKG_BOOKING B, BKG_DG_CGO C, DG_BKG D
                  WHERE A.VSL_CD     = @[vsl_cd]
                    AND A.SKD_VOY_NO = @[skd_voy_no]
                    AND A.SKD_DIR_CD = @[skd_dir_cd]
                    AND A.POL_YD_CD        =  @[pol_cd]
                    AND A.POL_CLPT_IND_SEQ =  @[pol_clpt_ind_seq]
                    AND A.VSL_CD     = D.VSL_CD
                    AND A.SKD_VOY_NO = D.SKD_VOY_NO
                    AND A.SKD_DIR_CD = D.SKD_DIR_CD
                    AND A.POL_YD_CD  = D.YD_CD
                    AND A.POL_CLPT_IND_SEQ = D.POL_CLPT_IND_SEQ
                    AND A.BKG_NO     = C.BKG_NO
                    AND B.BKG_NO     = C.BKG_NO
                    AND D.CNTR_NO    = C.CNTR_NO 
                    AND D.CNTR_NO IS NOT NULL 
                    AND C.CNTR_NO IS NOT NULL 
                    AND D.DG_CNTR_SEQ = C.DG_CNTR_SEQ
              ) X, BKG_DG_CGO Y
                 WHERE  X.BKG_NO           = Y.BKG_NO
                   AND  X.CNTR_NO          = Y.CNTR_NO 
                   AND  X.DG_CNTR_SEQ      = Y.DG_CNTR_SEQ  
      UNION 
       SELECT DISTINCT X.BKG_NO,X.CNTR_NO, X.CBF_SPCL_SMRY_SEQ, X.DG_CNTR_SEQ, X.POL_CLPT_IND_SEQ ,X.YD_CD,
                         X.CRR_CD, X.POD_CD, X.BLCK_STWG_CD,X.CNTR_TPSZ_CD, X.IMDG_UN_NO, X.IMDG_CLSS_CD,
                         X.MRN_POLUT_FLG,X.IMDG_LMT_QTY_FLG, X.IMDG_SUBS_RSK_LBL_CD1 , X.VSL_CD, X.SKD_VOY_NO, X.SKD_DIR_CD
        FROM (   SELECT  DISTINCT B.BKG_NO, C.CNTR_NO, D.CBF_SPCL_SMRY_SEQ, D.DG_CNTR_SEQ, D.POL_CLPT_IND_SEQ ,D.YD_CD,
                         D.CRR_CD, D.POD_CD, D.BLCK_STWG_CD, D.CNTR_TPSZ_CD, C.IMDG_UN_NO, C.IMDG_CLSS_CD,
                         C.MRN_POLUT_FLG,C.IMDG_LMT_QTY_FLG, C.IMDG_SUBS_RSK_LBL_CD1 , D.VSL_CD, D.SKD_VOY_NO, D.SKD_DIR_CD  
                   FROM  BKG_VVD A,BKG_BOOKING B, BKG_DG_CGO C, DG_BKG D
                  WHERE A.VSL_CD     = @[vsl_cd]       
                    AND A.SKD_VOY_NO = @[skd_voy_no]   
                    AND A.SKD_DIR_CD = @[skd_dir_cd]   
                    AND A.POL_YD_CD        =  @[pol_cd]
                    AND A.POL_CLPT_IND_SEQ =  @[pol_clpt_ind_seq]
                    AND A.VSL_CD     = D.VSL_CD
                    AND A.SKD_VOY_NO = D.SKD_VOY_NO
                    AND A.SKD_DIR_CD = D.SKD_DIR_CD
                    AND A.POL_YD_CD  = D.YD_CD
                    AND A.POL_CLPT_IND_SEQ = D.POL_CLPT_IND_SEQ
                    AND A.BKG_NO     = C.BKG_NO
                    AND B.BKG_NO     = C.BKG_NO
                    AND B.BKG_NO     = D.BKG_NO
                    AND D.CNTR_NO IS  NULL 
                    AND C.CNTR_NO IS  NULL 
                    AND C.CNTR_TPSZ_CD = D.CNTR_TPSZ_CD
                    AND D.DG_CNTR_SEQ  = C.DG_CNTR_SEQ
              ) X, BKG_DG_CGO Y
         WHERE  X.BKG_NO           = Y.BKG_NO
           AND  X.CNTR_TPSZ_CD     = Y.CNTR_TPSZ_CD  
           AND  X.DG_CNTR_SEQ      = Y.DG_CNTR_SEQ
 UNION 
      SELECT  DISTINCT XX.BKG_NO, XX.CNTR_NO, XX.CBF_SPCL_SMRY_SEQ, XX.DG_CNTR_SEQ, XX.POL_CLPT_IND_SEQ ,XX.YD_CD,
                         XX.CRR_CD, XX.POD_CD, XX.BLCK_STWG_CD, XX.CNTR_TPSZ_CD, XX.IMDG_UN_NO, XX.IMDG_CLSS_CD,
                         XX.MRN_POLUT_FLG,XX.IMDG_LMT_QTY_FLG, XX.IMDG_SUBS_RSK_LBL_CD1 , XX.VSL_CD, XX.SKD_VOY_NO,XX.SKD_DIR_CD  
        FROM (   SELECT BB.BKG_NO, BB.CNTR_NO, BB.CNTR_TPSZ_CD, BB.IMDG_UN_NO, BB.IMDG_CLSS_CD, BB.IMDG_SUBS_RSK_LBL_CD1,
                        BB.IMDG_LMT_QTY_FLG, BB.IMDG_EXPT_QTY_FLG, BB.MRN_POLUT_FLG,
                        AA.CBF_SPCL_SMRY_SEQ,AA.VSL_CD, AA.SKD_VOY_NO, AA.SKD_DIR_CD, AA.BLCK_STWG_CD, AA.POD_CD, AA.CRR_CD,
                        AA.DG_CNTR_SEQ, AA.POL_CLPT_IND_SEQ , AA.YD_CD
                 FROM (   SELECT Y.BKG_NO, X.CNTR_TPSZ_CD , X.CBF_SPCL_SMRY_SEQ ,X.IMDG_UN_NO, X.IMDG_CLSS_CD ,X.VSL_CD, X.SKD_VOY_NO, 
                                 X.SKD_DIR_CD, X.BLCK_STWG_CD, X.POD_CD, X.CRR_CD,X.DG_CNTR_SEQ, X.POL_CLPT_IND_SEQ , X.YD_CD
                            FROM SPLIT_BKG X, BKG_BOOKING Y
                           WHERE ( X.BKG_NO = Y.FM_BKG_NO OR X.BKG_NO = Y.BKG_NO)
                       ) AA, BKG_DG_CGO BB
       WHERE AA.BKG_NO = BB.BKG_NO
         AND AA.CNTR_TPSZ_CD = BB.CNTR_TPSZ_CD ) XX, 
         (  SELECT BB.BKG_NO, BB.CNTR_NO, BB.CNTR_TPSZ_CD, BB.IMDG_UN_NO, BB.IMDG_CLSS_CD, BB.IMDG_SUBS_RSK_LBL_CD1,
                   BB.IMDG_LMT_QTY_FLG, BB.IMDG_EXPT_QTY_FLG, AA.CBF_SPCL_SMRY_SEQ
             FROM (   SELECT Y.BKG_NO, X.CNTR_TPSZ_CD , X.CBF_SPCL_SMRY_SEQ ,X.IMDG_UN_NO, X.IMDG_CLSS_CD  
                        FROM SPLIT_BKG X, BKG_BOOKING Y
                       WHERE ( X.BKG_NO = Y.FM_BKG_NO OR X.BKG_NO = Y.BKG_NO) ) AA, BKG_DG_CGO BB
            WHERE AA.BKG_NO = BB.BKG_NO
              AND AA.CNTR_TPSZ_CD = BB.CNTR_TPSZ_CD 
              AND AA.IMDG_UN_NO   = BB.IMDG_UN_NO
              AND AA.IMDG_CLSS_CD = BB.IMDG_CLSS_CD ) YY
    WHERE XX.CNTR_NO = YY.CNTR_NO
 ) Z )			]]></sql>
			<params>
				<param name="cre_usr_id" type="12" value="" out="N"/>
				<param name="upd_usr_id" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pol_clpt_ind_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
