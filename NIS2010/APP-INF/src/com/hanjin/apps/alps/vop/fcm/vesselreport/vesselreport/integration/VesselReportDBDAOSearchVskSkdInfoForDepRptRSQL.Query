<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="VesselReportDBDAOSearchVskSkdInfoForDepRptRSQL">
			<desc><![CDATA[Departure Report PK 로 Vessel Schedule 참고 정보 조회]]></desc>
			<sql><![CDATA[
WITH VSL_SKD_TMP AS (
    -- Last Port Schedule 를 추출하기 위한 쿼리
    SELECT
        T1.VSL_CD
        ,T1.SKD_VOY_NO
        ,T1.SKD_DIR_CD
        ,T1.VPS_PORT_CD
        ,T1.CLPT_IND_SEQ
		,LAG(T1.VSL_CD) OVER (PARTITION BY T1.VSL_CD ORDER BY T1.SKD_VOY_NO, T2.VSL_SLAN_DIR_SEQ, T1.CLPT_SEQ) AS LAST_VSL_CD
		,LAG(T1.SKD_VOY_NO) OVER (PARTITION BY T1.VSL_CD ORDER BY T1.SKD_VOY_NO, T2.VSL_SLAN_DIR_SEQ, T1.CLPT_SEQ) AS LAST_SKD_VOY_NO
		,LAG(T1.SKD_DIR_CD) OVER (PARTITION BY T1.VSL_CD ORDER BY T1.SKD_VOY_NO, T2.VSL_SLAN_DIR_SEQ, T1.CLPT_SEQ) AS LAST_SKD_DIR_CD
        ,LAG(T1.VPS_PORT_CD) OVER (PARTITION BY T1.VSL_CD ORDER BY T1.SKD_VOY_NO, T2.VSL_SLAN_DIR_SEQ, T1.CLPT_SEQ) AS LAST_PORT_CD
        ,LAG(T1.CLPT_IND_SEQ) OVER (PARTITION BY T1.VSL_CD ORDER BY T1.SKD_VOY_NO, T2.VSL_SLAN_DIR_SEQ, T1.CLPT_SEQ) AS LAST_CLPT_IND_SEQ
    FROM VSK_VSL_PORT_SKD T1, MDM_VSL_SVC_LANE_DIR T2
    WHERE T1.SLAN_CD = T2.VSL_SLAN_CD
    AND T1.SKD_DIR_CD = T2.VSL_SLAN_DIR_CD
    AND T1.TURN_PORT_IND_CD IN ('Y','N')
    AND NVL(T1.SKD_CNG_STS_CD, 'X')<>'S'
    AND T1.VSL_CD IN (
        SELECT
        T1.VSL_CD
        FROM MDM_VSL_CNTR T1, FCM_VSL_CNTR_RGST T2
        WHERE T1.VSL_CD=T2.VSL_CD
        AND T1.DELT_FLG='N'
        AND T1.CRR_CD='SML'
    )
    AND T1.VSL_CD = @[vsl_cd]
)

SELECT
	VSL_CD
    ,SKD_VOY_NO
    ,SKD_DIR_CD
    ,VPS_PORT_CD
    ,DECODE(CLPT_IND_SEQ, '1', 'F', '2', 'S', '3', 'T') AS CLPT_IND_SEQ
	,LAST_VSL_CD
	,LAST_SKD_VOY_NO
	,LAST_SKD_DIR_CD
    ,LAST_PORT_CD
    ,DECODE(LAST_CLPT_IND_SEQ, '1', 'F', '2', 'S', '3', 'T') AS LAST_CLPT_IND_SEQ
FROM VSL_SKD_TMP
WHERE VSL_CD = @[vsl_cd]
AND SKD_VOY_NO = SUBSTR(@[voy_dir_cd], 1, 4)
AND SKD_DIR_CD = SUBSTR(@[voy_dir_cd], 5, 1)
AND VPS_PORT_CD = @[dep_port_cd]
#if( ${clpt_ind_seq} != '' )
AND CLPT_IND_SEQ = DECODE(@[clpt_ind_seq], 'F', '1', 'S', '2', 'T', '3')
#end			]]></sql>
			<params>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="voy_dir_cd" type="12" value="" out="N"/>
				<param name="dep_port_cd" type="12" value="" out="N"/>
				<param name="clpt_ind_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
