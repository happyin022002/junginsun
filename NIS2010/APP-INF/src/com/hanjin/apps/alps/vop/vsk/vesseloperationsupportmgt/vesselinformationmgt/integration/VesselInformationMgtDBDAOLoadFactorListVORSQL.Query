<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="VesselInformationMgtDBDAOLoadFactorListVORSQL">
			<desc><![CDATA[Load Factor List 를 조회한다.]]></desc>
			<sql><![CDATA[
SELECT    X.VSL_SLAN_CD
       ,  X.PF_SKD_TP_CD
       ,  D.VSL_SLAN_DIR_CD
       ,  D.VSL_SLAN_DIR_SEQ
       ,  X.VSL_CD
          -------------------------------------------------------------              
       ,  CASE WHEN COUNT(1) = 0 THEN 0
               ELSE SUM(NVL(H.BSA_CAPA,0)) / COUNT(1)
          END  AS AVG_BSA_CAPA_QTY
          -------------------------------------------------------------
       ,  CASE WHEN COUNT(1) = 0 THEN 0
               ELSE SUM(NVL(R.TTL_CNTR_OBRD_TEU,0)) / COUNT(1)
          END  AS AVG_TTL_LOAD_TEU_QTY
       ,  CASE WHEN SUM(NVL(R.TTL_CNTR_OBRD_TEU,0)) = 0 THEN 0
               ELSE SUM(NVL(H.BSA_CAPA,0)) / SUM(NVL(R.TTL_CNTR_OBRD_TEU,0)) 
          END  AS AVG_LOAD_FACT_RATIO
       ,  CASE WHEN COUNT(1) = 0 THEN 0
               ELSE SUM(NVL(R.DEP_BLST_WGT,0)) / COUNT(1)
          END  AS AVG_LAST_PORT_BLST_QTY
       ,  CASE WHEN COUNT(1) = 0 THEN 0
               ELSE SUM(NVL(R.DEP_MID_DRFT_HGT,0)) / COUNT(1) 
          END  AS AVG_LAST_PORT_DRFT_QTY
          -------------------------------------------------------------
FROM      BSA_VVD_MST     H
       ,  (
          --=============================================================================
          --=============================================================================
          SELECT    XX.*
          FROM      (
                    --===================================================================
                    SELECT      X.*
                    FROM        (
                                ---------------------------------------------------------------------
                                SELECT    VS.*
                                      ,   RANK() OVER (PARTITION BY PS.VSL_CD, PS.SKD_VOY_NO, PS.SKD_DIR_CD ORDER BY PS.CLPT_SEQ DESC) LAST_PORT_ORDER
                                      ,   PS.VPS_PORT_CD            AS LAST_PORT_CD
                                FROM      VSK_VSL_SKD               VS
                                      ,   VSK_VSL_PORT_SKD          PS
                                WHERE     1 = 1                 
                                AND       VS.VSL_CD                 = PS.VSL_CD
                                AND       VS.SKD_VOY_NO             = PS.SKD_VOY_NO
                                AND       VS.SKD_DIR_CD             = PS.SKD_DIR_CD
                                AND       NVL(PS.SKD_CNG_STS_CD,'*')<> 'S'
                                AND       PS.TURN_PORT_IND_CD       IN ('Y','N')
                                AND       VS.VSL_CD                 = @[vsl_cd]
								AND       VS.PF_SKD_TP_CD           = VSK_VESSEL_SCHEDULE_PKG.GET_PF_SVC_TP_FOR_CUR_VSL_FNC(@[vsl_cd])
                                AND       VS.N1ST_PORT_BRTH_DT      > SYSDATE
                                
                                ---------------------------------------------------------------------                    
                                ) X
                    WHERE       1 = 1
                    AND         X.LAST_PORT_ORDER = 1
                    ORDER BY    X.N1ST_PORT_BRTH_DT      ASC
                    --===================================================================                    
                    ) XX
          WHERE     ROWNUM    = 1
          UNION ALL
          SELECT    XX.*
          FROM      (
                    --===================================================================
                    SELECT      X.*
                    FROM        (
                                ---------------------------------------------------------------------
                                SELECT    VS.*
                                      ,   RANK() OVER (PARTITION BY PS.VSL_CD, PS.SKD_VOY_NO, PS.SKD_DIR_CD ORDER BY PS.CLPT_SEQ DESC) LAST_PORT_ORDER
                                      ,   PS.VPS_PORT_CD            AS LAST_PORT_CD
                                FROM      VSK_VSL_SKD               VS
                                      ,   VSK_VSL_PORT_SKD          PS
                                WHERE     1 = 1                 
                                AND       VS.VSL_CD                 = PS.VSL_CD
                                AND       VS.SKD_VOY_NO             = PS.SKD_VOY_NO
                                AND       VS.SKD_DIR_CD             = PS.SKD_DIR_CD
                                AND       NVL(PS.SKD_CNG_STS_CD,'*')<> 'S'
                                AND       PS.TURN_PORT_IND_CD       IN ('Y','N')
                                AND       VS.VSL_CD                 = @[vsl_cd]
								AND       VS.PF_SKD_TP_CD           = VSK_VESSEL_SCHEDULE_PKG.GET_PF_SVC_TP_FOR_CUR_VSL_FNC(@[vsl_cd])
                                AND       VS.N1ST_PORT_BRTH_DT      <= SYSDATE
                                
                                ---------------------------------------------------------------------                    
                                ) X
                    WHERE       1 = 1
                    AND         X.LAST_PORT_ORDER = 1
                    ORDER BY    X.N1ST_PORT_BRTH_DT      DESC
                    --===================================================================                    
                    ) XX
          WHERE     ROWNUM      <= 5
          --=============================================================================
          --=============================================================================          
          ) X
       ,  MDM_VSL_SVC_LANE_DIR  D
       ,  FCM_DEP_RPT           R
WHERE     1 = 1
AND       X.VSL_SLAN_CD         = D.VSL_SLAN_CD
AND       X.SKD_DIR_CD          = D.VSL_SLAN_DIR_CD
AND       X.VSL_CD              = H.VSL_CD         (+)
AND       X.SKD_VOY_NO          = H.SKD_VOY_NO     (+)
AND       X.SKD_DIR_CD          = H.SKD_DIR_CD     (+)    
AND       X.VSL_CD              = R.VSL_CD         (+)
AND       X.SKD_VOY_NO          = R.SKD_VOY_NO     (+)
AND       X.SKD_DIR_CD          = R.SKD_DIR_CD     (+)
AND       X.LAST_PORT_CD        = R.DEP_PORT_CD    (+)
GROUP BY  X.VSL_SLAN_CD
       ,  X.PF_SKD_TP_CD
       ,  D.VSL_SLAN_DIR_CD       
       ,  D.VSL_SLAN_DIR_SEQ
       ,  X.VSL_CD
ORDER BY  D.VSL_SLAN_DIR_SEQ    ASC			]]></sql>
			<params>
				<param name="vsl_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
