<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="OwnContainerBookingForecastMgtDBDAOCBFIFSummaryIfBkgDtMtyCSQL">
			<desc><![CDATA[OwnContainerBookingForecastMgtDBDAOCBFIFSummaryIfBkgDtMty]]></desc>
			<sql><![CDATA[
INSERT INTO OPF_CGO_BKG_FCAST_SPCL_SMRY (VSL_CD
                                        , SKD_VOY_NO
                                        , SKD_DIR_CD
                                        , YD_CD
                                        , POL_CLPT_IND_SEQ
                                        , CRR_CD
                                        , POD_CD
                                        , BLCK_STWG_CD
                                        , CBF_SPCL_SMRY_SEQ
                                        , CNTR_TPSZ_CD
                                        , MTY_BKG_FLG
                                        , CNTR_QTY
                                        , CRE_USR_ID
                                        , CRE_DT
                                        , UPD_USR_ID
                                        , UPD_DT
                                        , BKG_REV_MCGO_FLG
                                        )

   SELECT @[vsl_cd]
        , @[skd_voy_no]
        , @[skd_dir_cd]
        , @[pol_cd]
        , @[pol_clpt_ind_seq]
        , 'SML'
        , POD_CD
        , SUBSTR(MLB,3,5)
        , CBF_SPCL_SMRY_SEQ + ROWNUM
        , CNTR_TPSZ_CD
        , 'Y'
        , CNTR_QTY
        , @[cre_usr_id]
        , SYSDATE
        , @[upd_usr_id]
        , SYSDATE
        , DECODE(BKG_CGO_TP_CD,'R','Y',NULL)
   FROM (
SELECT Z.POD_CD, Z.MLB, Z.CNTR_TPSZ_CD, Z.CNTR_QTY, Z.CBF_SPCL_SMRY_SEQ, Z.BKG_CGO_TP_CD
 FROM ( 
    SELECT X.POD_CD, X.MLB, X.CNTR_TPSZ_CD,  ALL_QTY - NVL(BN_QTY,0) CNTR_QTY, X.BKG_CGO_TP_CD,
         (     SELECT NVL(MAX(CBF_SPCL_SMRY_SEQ),0)
                    FROM OPF_CGO_BKG_FCAST_SPCL_SMRY
                   WHERE VSL_CD     = @[vsl_cd]
                     AND SKD_VOY_NO = @[skd_voy_no]
                     AND SKD_DIR_CD = @[skd_dir_cd]
                     AND YD_CD      = @[pol_cd]
                     AND POL_CLPT_IND_SEQ = @[pol_clpt_ind_seq] ) AS CBF_SPCL_SMRY_SEQ
    FROM (
          SELECT VVD.POD_CD, QTY.CNTR_TPSZ_CD , SUM(OP_CNTR_QTY) ALL_QTY , BKG.BKG_CGO_TP_CD,
                 OPF_BLCK_STWG_CD(VVD.VSL_CD||VVD.SKD_VOY_NO||VVD.SKD_DIR_CD, VVD.POL_YD_CD, VVD.POL_CLPT_IND_SEQ, BKG.BKG_NO) AS MLB 
            FROM BKG_VVD       VVD, 
                 BKG_BOOKING   BKG,
                 BKG_QUANTITY  QTY,
                 MDM_CNTR_SZ   MCZ                                  
           WHERE VVD.VSL_CD                          =  @[vsl_cd]   
             AND VVD.SKD_VOY_NO                      =  @[skd_voy_no]
             AND VVD.SKD_DIR_CD                      =  @[skd_dir_cd]
             AND VVD.POL_YD_CD                       =  @[pol_cd]   
             AND VVD.POL_CLPT_IND_SEQ                =  @[pol_clpt_ind_seq] 
             AND VVD.BKG_NO                          = BKG.BKG_NO
			#if(${bkg_sts_cd} != 'All')
			AND BKG.BKG_STS_CD = @[bkg_sts_cd]
			#end
             AND BKG.BKG_STS_CD                      <> 'X'
             AND BKG.BKG_NO                          = QTY.BKG_NO  
             AND ( BKG.BKG_CGO_TP_CD                  = 'P' OR ( BKG.BKG_CGO_TP_CD = 'R' AND BKG.DCGO_FLG = 'N'))
             AND QTY.CNTR_TPSZ_CD                    NOT LIKE 'Q%'
             AND SUBSTR(QTY.CNTR_TPSZ_CD,2,1)        = MCZ.CNTR_SZ_CD
         GROUP BY VVD.POD_CD, QTY.CNTR_TPSZ_CD,  BKG.BKG_CGO_TP_CD, 
                   OPF_BLCK_STWG_CD(VVD.VSL_CD||VVD.SKD_VOY_NO||VVD.SKD_DIR_CD, VVD.POL_YD_CD, VVD.POL_CLPT_IND_SEQ, BKG.BKG_NO)) X , (
                               SELECT  OPF_BLCK_STWG_CD(VVD.VSL_CD||VVD.SKD_VOY_NO||VVD.SKD_DIR_CD, VVD.POL_YD_CD, VVD.POL_CLPT_IND_SEQ, BKG.BKG_NO) AS MLB, 
                                       BC.CNTR_TPSZ_CD, COUNT(1) BN_QTY
                                 FROM BKG_VVD       VVD, 
               BKG_BOOKING   BKG,
               BKG_CONTAINER BC      
        WHERE VVD.VSL_CD                          = @[vsl_cd]        
          AND VVD.SKD_VOY_NO                      = @[skd_voy_no]    
          AND VVD.SKD_DIR_CD                      = @[skd_dir_cd]    
          AND VVD.POL_YD_CD                       = @[pol_cd]    
          AND VVD.POL_CLPT_IND_SEQ                =  @[pol_clpt_ind_seq]     
          AND VVD.BKG_NO                          = BKG.BKG_NO
			#if(${bkg_sts_cd} != 'All')
			AND BKG.BKG_STS_CD = @[bkg_sts_cd]
			#end
          AND BKG.BKG_STS_CD  <> 'X'
          AND BKG.BKG_CGO_TP_CD <> 'F'
          AND BKG.BKG_NO = BC.BKG_NO
          AND ((BC.BDL_BTM_FLG ='Y')  OR ( BC.BDL_BTM_FLG ='N' AND MCNTR_BDL_NO IS NOT NULL))
        GROUP BY BC.CNTR_TPSZ_CD, OPF_BLCK_STWG_CD(VVD.VSL_CD||VVD.SKD_VOY_NO||VVD.SKD_DIR_CD, VVD.POL_YD_CD, VVD.POL_CLPT_IND_SEQ, BKG.BKG_NO)
        ) Y  
           WHERE X.MLB = Y.MLB(+)
             AND X.CNTR_TPSZ_CD = Y.CNTR_TPSZ_CD (+)  
      ) Z   
          WHERE Z.CNTR_QTY <> 0   )			]]></sql>
			<params>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pol_clpt_ind_seq" type="12" value="" out="N"/>
				<param name="cre_usr_id" type="12" value="" out="N"/>
				<param name="upd_usr_id" type="12" value="" out="N"/>
				<param name="bkg_sts_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
