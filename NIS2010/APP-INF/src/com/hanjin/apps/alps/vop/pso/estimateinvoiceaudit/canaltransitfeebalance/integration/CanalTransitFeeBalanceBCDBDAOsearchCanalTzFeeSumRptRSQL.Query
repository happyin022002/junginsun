<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CanalTransitFeeBalanceBCDBDAOsearchCanalTzFeeSumRptRSQL">
			<desc><![CDATA[searchCanalTzFeeSumRpt]]></desc>
			<sql><![CDATA[
select pay_to,lane,vvd,trns_dt,py_due_dt,adv_py_sts,adv_py_rev_mon,inv_sts,inv_rev_mon,msa,rslt
,'' revyrmon
,'' port_cd
, vndr_seq
,'' vsl_slan_cd
from ( 
 SELECT   GRP,
         (select nvl(x.vndr_abbr_nm, x.vndr_seq) from mdm_vendor x where x.vndr_seq = z.VNDR_SEQ) pay_to,
         lane,
         vvd,
         TRANSITDATE trns_dt,
          (select x.due_dt from pso_charge x where x.ISS_CTY_CD = z.ISS_CTY_CD and x.SO_SEQ = x.SO_SEQ) py_due_dt,
         decode( msa, null,decode(ADVANCEPAYMENTSTATUS, 'C', 1, 'R', 5, null, decode(vvd, null, null, 5)), null) adv_py_sts,
         ADVANCEPAYMENTREVMONTH adv_py_rev_mon,
         decode( msa, null,decode(INVOICESTATUS, 'C', 1, 'R', 5, null, decode(vvd, null, null, 5)), null) inv_sts,
         INVOICEREVMONTH inv_rev_mon,
         decode(MSA, 'C', 1, 'R', 5, null, decode( msa, null, decode(vvd, null, 5, null))) msa,
         DIFF_RMK rslt,
         CNT
         ,'' revyrmon
        ,'' port_cd
        ,vndr_seq vndr_seq
        ,'' vsl_slan_cd
  FROM   (  SELECT   GROUPING (vndr_seq) grp,
                     vndr_seq,
                     vvd,
                     DECODE (GROUPING (vvd), 0, MAX (PSO_BZTP_CD)) PSO_BZTP_CD,
                     DECODE (GROUPING (vvd), 0, MAX (lane)) lane,
                     DECODE (GROUPING (vvd), 0, MAX (TRANSITDATE)) TRANSITDATE,
                     DECODE (GROUPING (vvd), 0, MAX (ADVANCEPAYMENTSTATUS))
                        ADVANCEPAYMENTSTATUS,
                     DECODE (GROUPING (vvd), 0, MAX (ADVANCEPAYMENTREVMONTH))
                        ADVANCEPAYMENTREVMONTH,
                     DECODE (GROUPING (vvd), 0, MAX (INVOICESTATUS))
                        INVOICESTATUS,
                     DECODE (GROUPING (vvd), 0, MAX (INVOICEREVMONTH))
                        INVOICEREVMONTH,
                     DECODE (
                        GROUPING (vvd),
                        1,
                        (SELECT   x.PSO_MSA_STS_CD
                           FROM   pso_msa x
                          WHERE   x.REV_YRMON = @[revyrmon]
                                  AND x.vndr_seq = y.vndr_seq)
                     )
                        msa,
                     DECODE (GROUPING (vvd), 0, MAX (DIFF_RMK)) DIFF_RMK,
                     DECODE (GROUPING (vvd), 0, MAX (ISS_CTY_CD)) ISS_CTY_CD,
                     DECODE (GROUPING (vvd), 0, MAX (SO_SEQ)) SO_SEQ,  
                     DECODE (GROUPING (vvd), 0, MAX (CNT)) CNT
              FROM   (SELECT   1 flg,
                               a.PSO_BZTP_CD,
                               NVL (
                                  b.vndr_seq,
                                  (SELECT   CNL_AGN_VNDR_SEQ
                                     FROM   mdm_vsl_svc_lane
                                    WHERE   VSL_SLAN_CD =
                                               (SELECT   VSL_SLAN_CD
                                                  FROM   vsk_vsl_skd z
                                                 WHERE   z.VSL_CD = a.VSL_CD
                                                         AND z.SKD_VOY_NO =
                                                               a.SKD_VOY_NO
                                                         AND z.SKD_DIR_CD =
                                                               a.SKD_DIR_CD))
                               )
                                  VNDR_SEQ,
                               (SELECT   z.VSL_SLAN_CD
                                  FROM   vsk_vsl_skd z
                                 WHERE       z.VSL_CD = a.VSL_CD
                                         AND z.SKD_VOY_NO = a.SKD_VOY_NO
                                         AND z.SKD_DIR_CD = a.SKD_DIR_CD)
                                  lane,
                               a.VSL_CD || a.SKD_VOY_NO || a.SKD_DIR_CD vvd,
                               (SELECT   VPS_ETB_DT
                                  FROM   VSK_VSL_PORT_SKD z
                                 WHERE       z.VSL_CD = a.VSL_CD
                                         AND z.SKD_VOY_NO = a.SKD_VOY_NO 
                                         AND z.SKD_DIR_CD = a.SKD_DIR_CD 
                                         AND YD_CD = b.YD_CD     
                                         AND CALL_YD_IND_SEQ = '1')
                                  transitDate,
                               DECODE (b.CNL_TZ_BZTP_CD,
                                       'E', b.CNL_TZ_PROC_STS_CD,
                                       '')
                                  advancePaymentStatus,
                               DECODE (b.CNL_TZ_BZTP_CD, 'E', b.REV_YRMON, '')
                                  advancePaymentRevMonth,
                               DECODE (b.CNL_TZ_BZTP_CD,
                                       'I', b.CNL_TZ_PROC_STS_CD,
                                       '')
                                  InvoiceStatus,
                               DECODE (b.CNL_TZ_BZTP_CD, 'I', b.REV_YRMON, '')
                                  InvoiceRevMonth,
                               '' MSA,
                               b.DIFF_RMK,
                               b.ISS_CTY_CD,
                               b.SO_SEQ,  
                               -1 cnt
                        FROM   pso_tgt_vvd a, pso_cnl_tz_fee b
                       WHERE       a.EXPN_YRMON = @[revyrmon]
                               AND a.PSO_BZTP_CD = 5 
                               AND a.PSO_BZTP_CD = b.PSO_BZTP_CD(+)
                               AND a.VSL_CD = b.VSL_CD(+)
                               AND a.SKD_VOY_NO = b.SKD_VOY_NO(+)
                               AND a.SKD_DIR_CD = b.SKD_DIR_CD(+)
                      UNION ALL
                        SELECT   2,
                                 a.PSO_BZTP_CD,
                                 b.VNDR_SEQ,
                                 (SELECT   z.VSL_SLAN_CD
                                    FROM   vsk_vsl_skd z
                                   WHERE       z.VSL_CD = a.VSL_CD
                                           AND z.SKD_VOY_NO = a.SKD_VOY_NO
                                           AND z.SKD_DIR_CD = a.SKD_DIR_CD)
                                    lane,
                                 a.VSL_CD || a.SKD_VOY_NO || a.SKD_DIR_CD vvd,
                                 (SELECT   VPS_ETB_DT
                                    FROM   VSK_VSL_PORT_SKD z
                                   WHERE       z.VSL_CD = a.VSL_CD
                                           AND z.SKD_VOY_NO = a.SKD_VOY_NO
                                           AND z.SKD_DIR_CD = a.SKD_DIR_CD 
                                           AND YD_CD = b.YD_CD  
                                           AND CALL_YD_IND_SEQ = '1')
                                    transitDate,
                                 MIN(DECODE (b.CNL_TZ_BZTP_CD,
                                             'E', b.CNL_TZ_PROC_STS_CD,
                                             ''))
                                    advancePaymentStatus,
                                 MIN(DECODE (b.CNL_TZ_BZTP_CD,
                                             'E', b.REV_YRMON,
                                             ''))
                                    advancePaymentRevMonth,
                                 MAX(DECODE (b.CNL_TZ_BZTP_CD,
                                             'I', b.CNL_TZ_PROC_STS_CD,
                                             ''))
                                    InvoiceStatus,
                                 MAX(DECODE (b.CNL_TZ_BZTP_CD,
                                             'I', b.REV_YRMON,
                                             ''))
                                    InvoiceRevMonth,
                                 '' MSA,
                                 'Mismatch' DIFF_RMK,
                                  max(b.ISS_CTY_CD) ISS_CTY_CD, 
                                  max(b.SO_SEQ) SO_SEQ,                                 
                                 COUNT ( * ) CNT
                          FROM   pso_tgt_vvd a, pso_cnl_tz_fee b
                         WHERE   b.NTC_YRMON BETWEEN TO_CHAR (
                                                        ADD_MONTHS (
                                                           TO_DATE (@[revyrmon],
                                                                    'yyyymm'),
                                                           -6
                                                        ),
                                                        'yyyymm'
                                                     )
                                                 AND  TO_CHAR (
                                                         ADD_MONTHS (
                                                            TO_DATE (@[revyrmon],
                                                                     'yyyymm'),
                                                            -1
                                                         ),
                                                         'yyyymm'
                                                      )
                                 AND b.CNL_TZ_PROC_STS_CD = 'C'
                                 AND a.PSO_BZTP_CD = b.PSO_BZTP_CD
                                 AND a.VSL_CD = b.VSL_CD
                                 AND a.SKD_VOY_NO = b.SKD_VOY_NO
                                 AND a.SKD_DIR_CD = b.SKD_DIR_CD
                      GROUP BY   a.PSO_BZTP_CD,
                                 a.VSL_CD,
                                 a.SKD_VOY_NO,
                                 a.SKD_DIR_CD,
                                 b.VNDR_SEQ,
                                 b.YD_CD) y
          GROUP BY   ROLLUP (vndr_seq, vvd)) z
 WHERE   z.grp = 0
)
where 1 = 1
#if( ${revyrmon}!='')
AND @[revyrmon] = @[revyrmon]
#end
#if( ${port_cd}!='')
AND @[port_cd] = @[port_cd]
#end
#if( ${vndr_seq}!='')
AND vndr_seq in (SELECT   REGEXP_SUBSTR (inlist,
                                        '[^|]+',
                                        1,
                                        b.rn)
                  FROM   (SELECT    @[vndr_seq] inlist FROM DUAL) a,
                         (SELECT   ROWNUM rn
                            FROM   dict
                           WHERE   ROWNUM <= 571) b
                 WHERE   b.rn <=
                              LENGTH ( @[vndr_seq] )
                            - LENGTH (REPLACE ( @[vndr_seq], '|', ''))
                            + 1)
#end
#if( ${vsl_slan_cd}!='')
AND @[vsl_slan_cd] = @[vsl_slan_cd]
#end
 order by pay_to, lane, vvd			]]></sql>
			<params>
				<param name="revyrmon" type="12" value="" out="N"/>
				<param name="port_cd" type="12" value="" out="N"/>
				<param name="vndr_seq" type="12" value="" out="N"/>
				<param name="vsl_slan_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
