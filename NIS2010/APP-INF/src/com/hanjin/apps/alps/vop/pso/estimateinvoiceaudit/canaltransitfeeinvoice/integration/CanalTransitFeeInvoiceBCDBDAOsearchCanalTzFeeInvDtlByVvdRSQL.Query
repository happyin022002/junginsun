<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CanalTransitFeeInvoiceBCDBDAOsearchCanalTzFeeInvDtlByVvdRSQL">
			<desc><![CDATA[Canal의 Invoice 정보를 조회합니다.

History
2012.04.09 진마리아 CHM-201217036-01 SPP-Port SO/ Actual Invoice 화면 변경 및 기능, 로직 추가]]></desc>
			<sql><![CDATA[
SELECT CREDITS,
       VNDR_SEQ,
       PSO_BZTP_CD,
       VSL_CD,
       SKD_VOY_NO,
       SKD_DIR_CD,
       YD_CD,
       CALL_SEQ,
       DECODE(flg, 2, null, DSP_COST_CD ) LGS_COST_CD,
       DECODE(flg, 2, 'TTL Amount:', LGS_COST_FULL_NM) LGS_COST_FULL_NM,
       LAST_INV,
       RQST_AMT,
       BALANCE,
       DIFF_RMK,
       CALC_AMT,
       T2.YD_CHG_NO,
       T2.YD_CHG_VER_SEQ,
       DFLT_XPR_DESC,
       SYS_XPR_DESC,
       DFLT_SYS_XPR_DESC,
       INV_NO,
       INV_RGST_NO,
       SUZ_NET_TONG_WGT,
       LOCL_XCH_RT,
       TR_VOL_VAL,
       SCG_RT_AMT,
       FLG,
       VSL_CD||SKD_VOY_NO||SKD_DIR_CD VVD,
       (SELECT X.CNTR_PNM_CAPA
          FROM MDM_VSL_CNTR X
         WHERE X.VSL_CD = substr(@[vvd], 1, 4)
        ) CNTR_PNM_CAPA,
       (SELECT COUNT(*)
          FROM PSO_CNL_TZ_ATCH_FILE X
         WHERE X.VSL_CD      = substr(@[vvd], 1, 4)
           AND X.SKD_VOY_NO  = substr(@[vvd], 5, 4)
           AND X.SKD_DIR_CD  = substr(@[vvd], 9, 1)
           AND X.YD_CD       = @[yd_cd]
           AND X.CALL_SEQ    = T1.CALL_SEQ
	       AND X.LGS_COST_CD = T1.LGS_COST_CD
	       AND X.LGS_COST_CD IS NOT NULL
        )ATCH_FILE_NO,
       (SELECT COUNT(*)
          FROM PSO_CNL_TZ_ATCH_FILE X
         WHERE X.VSL_CD      = substr(@[vvd], 1, 4)
           AND X.SKD_VOY_NO  = substr(@[vvd], 5, 4)
           AND X.SKD_DIR_CD  = substr(@[vvd], 9, 1)
           AND X.YD_CD       = @[yd_cd]
           AND X.CALL_SEQ    = T1.CALL_SEQ
           AND X.LGS_COST_CD IS NULL
        ) INV_ATCH_FILE_NO
FROM (
      SELECT CREDITS,
             VNDR_SEQ,
             PSO_BZTP_CD,
             VSL_CD,
             SKD_VOY_NO,
             SKD_DIR_CD,
             YD_CD,
             CALL_SEQ,
             DECODE (grp2, 1, DECODE (grp, 1, 'ZZZZZZTTL', acct_cd), lgs_cost_cd) LGS_COST_CD,
             (
               SELECT x.lgs_cost_full_nm
               FROM TES_LGS_COST x
               WHERE x.lgs_cost_cd = DECODE ( grp2, 1, DECODE (grp, 1, 'ZZZZZZTTL', z.acct_cd), z.lgs_cost_cd )
             ) LGS_COST_FULL_NM,
             DECODE (grp2, 1, DECODE (grp, 1, 'TTL', acct_cd), lgs_cost_cd) dsp_cost_cd,
             LAST_INV,
             debits RQST_AMT,
             DECODE ( grp2, 1, nvl(debits, 0) - nvl(credits, 0), debits-credits) BALANCE,
             DIFF_RMK,
             CALC_AMT,
             YD_CHG_NO,
             YD_CHG_VER_SEQ,
             DECODE (grp + grp2, 0, foml_desc) DFLT_XPR_DESC,
             DECODE (grp + grp2, 0, xpr_desc) SYS_XPR_DESC,
             DECODE (grp + grp2, 0, xpr_desc) DFLT_SYS_XPR_DESC,
             (
               SELECT X.INV_NO
               FROM  PSO_CHARGE X
               WHERE X.ISS_CTY_CD = Z.ISS_CTY_CD
                 AND X.SO_SEQ = Z.SO_SEQ) INV_NO,
             (
               SELECT X.INV_RGST_NO
               FROM PSO_CHARGE X
               WHERE X.ISS_CTY_CD = Z.ISS_CTY_CD
                 AND X.SO_SEQ = Z.SO_SEQ) INV_RGST_NO,
             SUZ_NET_TONG_WGT,
             LOCL_XCH_RT,
             TR_VOL_VAL,
             SCG_RT_AMT,
             grp + grp2 flg
      FROM (
          SELECT MAX (LGS_COST_CD) LGS_COST_CD,
                   SUBSTR (LGS_COST_CD, 1, 4) acct_cd,
                   SUM (CALC_AMT) calc_amt,
                   SUM (debits) debits,
                   SUM (credits) credits,
                   GROUPING (SUBSTR (LGS_COST_CD, 1, 4)) grp,
                   GROUPING (LGS_COST_CD) grp2,
                   MAX (LGS_COST_FULL_NM) LGS_COST_FULL_NM,
                   MAX (DIFF_RMK) DIFF_RMK,
                   MAX (foml_desc) foml_desc,
                   MAX (xpr_desc) xpr_desc,
                   MAX (VNDR_SEQ) VNDR_SEQ,
                   MAX (PSO_BZTP_CD) PSO_BZTP_CD,
                   MAX (VSL_CD) VSL_CD,
                   MAX (SKD_VOY_NO) SKD_VOY_NO,
                   MAX (SKD_DIR_CD) SKD_DIR_CD,
                   MAX (YD_CD) YD_CD,
                   MAX (CALL_SEQ) CALL_SEQ,
                   MAX (YD_CHG_NO) YD_CHG_NO,
                   MAX (YD_CHG_VER_SEQ) YD_CHG_VER_SEQ,
                   MAX (ISS_CTY_CD) ISS_CTY_CD,
                   MAX (SO_SEQ) SO_SEQ,
                   MAX (SUZ_NET_TONG_WGT) SUZ_NET_TONG_WGT,
                   MAX (LOCL_XCH_RT) LOCL_XCH_RT,
                   MAX (TR_VOL_VAL) TR_VOL_VAL,
                   MAX (SCG_RT_AMT) SCG_RT_AMT,
                   SUM (LAST_INV) LAST_INV
            FROM (
                  SELECT CNL_TZ_BZTP_CD,
                         C1.LGS_COST_CD,
                         NULL DEBITS,
                         RQST_AMT AS CREDITS,
                         CALC_AMT,
                         C1.LGS_COST_FULL_NM,
                         T2.DIFF_RMK,
                         T2.FOML_DESC,
                         T2.XPR_DESC,
                         T1.VNDR_SEQ,
                         T1.PSO_BZTP_CD,
                         T1.VSL_CD,
                         T1.SKD_VOY_NO,
                         T1.SKD_DIR_CD,
                         T1.YD_CD,
                         T1.CALL_SEQ,
                         T2.YD_CHG_NO,
                         T2.YD_CHG_VER_SEQ,
                         T1.ISS_CTY_CD,
                         T1.SO_SEQ,
                         T1.SUZ_NET_TONG_WGT,
                         T1.LOCL_XCH_RT,
                         T1.TR_VOL_VAL,
                         T1.SCG_RT_AMT,
                         (
               SELECT SUM (Y.RQST_AMT)
               FROM PSO_CNL_TZ_FEE X,
                 PSO_CNL_TZ_FEE_DTL Y
               WHERE X.CNL_TZ_BZTP_CD     = 'I'
                 AND X.CNL_TZ_PROC_STS_CD = 'A'
                 AND X.REV_YRMON BETWEEN TO_CHAR ( ADD_MONTHS ( TO_DATE (@[rev_yrmon], 'yyyymm'), -6 ), 'yyyymm' ) AND TO_CHAR ( ADD_MONTHS ( TO_DATE (@[rev_yrmon], 'yyyymm' ), -1 ), 'yyyymm' )
                 AND X.PSO_BZTP_CD = T1.PSO_BZTP_CD
                 AND T1.VSL_CD     = X.VSL_CD
                 AND T1.SKD_VOY_NO = X.SKD_VOY_NO
                 AND T1.SKD_DIR_CD = X.SKD_DIR_CD
                 AND T1.CALL_SEQ <> X.CALL_SEQ
                 AND T1.YD_CD      = X.YD_CD
                 AND Y.PSO_BZTP_CD = X.PSO_BZTP_CD
                 AND Y.VSL_CD      = X.VSL_CD
                 AND Y.SKD_VOY_NO  = X.SKD_VOY_NO
                 AND Y.SKD_DIR_CD  = X.SKD_DIR_CD
                 AND Y.CALL_SEQ    = X.CALL_SEQ
                 AND Y.YD_CD       = X.YD_CD
                 AND Y.LGS_COST_CD = T2.LGS_COST_CD
             ) LAST_INV 
                  FROM PSO_CNL_TZ_FEE T1,
                       PSO_CNL_TZ_FEE_DTL T2,
                       TES_LGS_COST C1
                  WHERE T1.PSO_BZTP_CD = T2.PSO_BZTP_CD
                  AND T1.VSL_CD        = T2.VSL_CD
                  AND T1.SKD_VOY_NO    = T2.SKD_VOY_NO
                  AND T1.SKD_DIR_CD    = T2.SKD_DIR_CD
                  AND T1.YD_CD         = T2.YD_CD
                  AND T1.CALL_SEQ      = T2.CALL_SEQ
                  AND T2.LGS_COST_CD   = C1.LGS_COST_CD
                  AND T1.PSO_BZTP_CD   = '5'
                  AND T1.YD_CD         = @[yd_cd]
                  AND T1.CNL_TZ_BZTP_CD  = 'I'
                  AND T1.NTC_YRMON     = @[rev_yrmon]
                  AND T1.VSL_CD        = substr(@[vvd], 1, 4)
                  AND T1.SKD_VOY_NO    = substr(@[vvd], 5, 4)
                  AND T1.SKD_DIR_CD    = substr(@[vvd], 9)
                  AND T2.LGS_COST_CD NOT LIKE 'CNOW%'
                  )
            GROUP BY ROLLUP (SUBSTR (LGS_COST_CD, 1, 4), LGS_COST_CD)
           ) z
      WHERE NOT ( z.calc_amt IS NULL
      AND z.grp2 = 0
      AND z.credits IS NULL)
     ) T1,
     ( SELECT LGS_COST_CD,
              MAX (YD_CHG_NO) YD_CHG_NO,
              MAX (YD_CHG_VER_SEQ) YD_CHG_VER_SEQ
       FROM PSO_YD_CHG
       WHERE YD_CD  = @[yd_cd]
       AND VNDR_SEQ = @[vndr_seq]
       AND TO_DATE (@[rev_yrmon], 'yyyymm') BETWEEN EFF_DT AND EXP_DT
       GROUP BY LGS_COST_CD
     ) T2
WHERE T1.LGS_COST_CD = T2.LGS_COST_CD(+)
  AND @[sts] <> 10
  AND flg IN (0,2)
UNION ALL

SELECT CREDITS,
       VNDR_SEQ,
       PSO_BZTP_CD,
       VSL_CD,
       SKD_VOY_NO,
       SKD_DIR_CD,
       YD_CD,
       CALL_SEQ,
       DECODE(flg, 2, null, DSP_COST_CD ) LGS_COST_CD,
       DECODE(flg, 2, 'TTL Amount:', LGS_COST_FULL_NM) LGS_COST_FULL_NM,
       LAST_INV,
       RQST_AMT,
       BALANCE,
       DIFF_RMK,
       CALC_AMT,
       YD_CHG_NO,
       YD_CHG_VER_SEQ,
       DFLT_XPR_DESC,
       SYS_XPR_DESC,
       DFLT_SYS_XPR_DESC,
       INV_NO,
       INV_RGST_NO,
       SUZ_NET_TONG_WGT,
       LOCL_XCH_RT,
       TR_VOL_VAL,
       SCG_RT_AMT,
       FLG,
       VSL_CD||SKD_VOY_NO||SKD_DIR_CD VVD,
       (SELECT X.CNTR_PNM_CAPA
             FROM MDM_VSL_CNTR X
            WHERE X.VSL_CD = substr(@[vvd], 1, 4)
       ) CNTR_PNM_CAPA,
       (SELECT COUNT(*)
          FROM PSO_CNL_TZ_ATCH_FILE X
         WHERE X.VSL_CD     = substr(@[vvd], 1, 4)
           AND X.SKD_VOY_NO = substr(@[vvd], 5, 4)
           AND X.SKD_DIR_CD = substr(@[vvd], 9, 1)
           AND X.YD_CD      = @[yd_cd]
           AND X.CALL_SEQ   =  T1.CALL_SEQ
	       AND X.LGS_COST_CD = T1.LGS_COST_CD
	       AND X.LGS_COST_CD IS NOT NULL
       )ATCH_FILE_NO,
       (SELECT COUNT(*)
          FROM PSO_CNL_TZ_ATCH_FILE X
         WHERE X.VSL_CD     = substr(@[vvd], 1, 4)
           AND X.SKD_VOY_NO = substr(@[vvd], 5, 4)
           AND X.SKD_DIR_CD = substr(@[vvd], 9, 1)
           AND X.YD_CD      = @[yd_cd]
           AND X.CALL_SEQ   = T1.CALL_SEQ
           AND X.LGS_COST_CD IS NULL
       ) INV_ATCH_FILE_NO
FROM (
      SELECT CREDITS,
             VNDR_SEQ,
             PSO_BZTP_CD,
             VSL_CD,
             SKD_VOY_NO,
             SKD_DIR_CD,
             YD_CD,
             CALL_SEQ,
             DECODE (grp2, 1, DECODE (grp, 1, 'ZZZZZZTTL', acct_cd), lgs_cost_cd) LGS_COST_CD,
             (
               SELECT x.lgs_cost_full_nm
               FROM TES_LGS_COST x
               WHERE x.lgs_cost_cd = DECODE ( grp2, 1, DECODE (grp, 1, 'ZZZZZZTTL', z.acct_cd), z.lgs_cost_cd )
             ) LGS_COST_FULL_NM,
             DECODE (grp2, 1, DECODE (grp, 1, 'TTL', acct_cd), lgs_cost_cd) dsp_cost_cd,
             LAST_INV,
             debits RQST_AMT,
             DECODE ( grp2, 1, nvl(debits, 0) - nvl(credits, 0), debits-credits) BALANCE,
             DIFF_RMK,
             CALC_AMT,
             YD_CHG_NO,
             YD_CHG_VER_SEQ,
             DECODE (grp + grp2, 0, foml_desc) DFLT_XPR_DESC,
             DECODE (grp + grp2, 0, xpr_desc) SYS_XPR_DESC,
             DECODE (grp + grp2, 0, xpr_desc) DFLT_SYS_XPR_DESC,
             (
               SELECT X.INV_NO
               FROM PSO_CHARGE X
               WHERE X.ISS_CTY_CD = Z.ISS_CTY_CD
                 AND X.SO_SEQ = Z.SO_SEQ
             ) INV_NO,
             (
               SELECT X.INV_RGST_NO
               FROM PSO_CHARGE X
               WHERE X.ISS_CTY_CD = Z.ISS_CTY_CD
                 AND X.SO_SEQ      = Z.SO_SEQ
             ) INV_RGST_NO,
             SUZ_NET_TONG_WGT,
             LOCL_XCH_RT,
             TR_VOL_VAL,
             SCG_RT_AMT,
             grp + grp2 flg
      FROM (
          SELECT MAX (LGS_COST_CD) LGS_COST_CD,
                   SUBSTR (LGS_COST_CD, 1, 4) ACCT_CD,
                   SUM (CALC_AMT) CALC_AMT,
                   SUM (DEBITS) DEBITS,
                   SUM (CREDITS) CREDITS,
                   GROUPING (SUBSTR (LGS_COST_CD, 1, 4)) GRP,
                   GROUPING (LGS_COST_CD) GRP2,
                   MAX (LGS_COST_FULL_NM) LGS_COST_FULL_NM,
                   MAX (DIFF_RMK) DIFF_RMK,
                   MAX (FOML_DESC) FOML_DESC,
                   MAX (XPR_DESC) XPR_DESC,
                   MAX (VNDR_SEQ) VNDR_SEQ,
                   MAX (PSO_BZTP_CD) PSO_BZTP_CD,
                   MAX (VSL_CD) VSL_CD,
                   MAX (SKD_VOY_NO) SKD_VOY_NO,
                   MAX (SKD_DIR_CD) SKD_DIR_CD,
                   MAX (YD_CD) YD_CD,
                   MAX (CALL_SEQ) CALL_SEQ,
                   MAX (YD_CHG_NO) YD_CHG_NO,
                   MAX (YD_CHG_VER_SEQ) YD_CHG_VER_SEQ,
                   MAX (ISS_CTY_CD) ISS_CTY_CD,
                   MAX (SO_SEQ) SO_SEQ,
                   MAX (SUZ_NET_TONG_WGT) SUZ_NET_TONG_WGT,
                   MAX (LOCL_XCH_RT) LOCL_XCH_RT,
                   MAX (TR_VOL_VAL) TR_VOL_VAL,
                   MAX (SCG_RT_AMT) SCG_RT_AMT,
                   SUM (LAST_INV) LAST_INV
            FROM (
                SELECT CNL_TZ_BZTP_CD,
                         C1.LGS_COST_CD,
                         NULL DEBITS,
                         RQST_AMT AS CREDITS,
                         CALC_AMT,
                         C1.LGS_COST_FULL_NM,
                         T2.DIFF_RMK,
                         T2.FOML_DESC,
                         T2.XPR_DESC,
                         T1.VNDR_SEQ,
                         T1.PSO_BZTP_CD,
                         T1.VSL_CD,
                         T1.SKD_VOY_NO,
                         T1.SKD_DIR_CD,
                         T1.YD_CD,
                         T1.CALL_SEQ,
                         T2.YD_CHG_NO,
                         T2.YD_CHG_VER_SEQ,
                         T1.ISS_CTY_CD,
                         T1.SO_SEQ,
                         T1.SUZ_NET_TONG_WGT,
                         T1.LOCL_XCH_RT,
                         T1.TR_VOL_VAL,
                         T1.SCG_RT_AMT,
                           (
                        SELECT SUM (Y.RQST_AMT)
                        FROM PSO_CNL_TZ_FEE X,
                          PSO_CNL_TZ_FEE_DTL Y
                        WHERE X.CNL_TZ_BZTP_CD      = 'I'
                          AND X.CNL_TZ_PROC_STS_CD = 'A'
                          AND X.REV_YRMON BETWEEN TO_CHAR ( ADD_MONTHS ( TO_DATE (@[rev_yrmon], 'yyyymm'), -6 ), 'yyyymm' ) AND TO_CHAR ( ADD_MONTHS ( TO_DATE ( @[rev_yrmon], 'yyyymm' ), -1 ), 'yyyymm' )
                          AND X.PSO_BZTP_CD  = T1.PSO_BZTP_CD
                          AND T1.VSL_CD      = X.VSL_CD
                          AND T1.SKD_VOY_NO  = X.SKD_VOY_NO
                          AND T1.SKD_DIR_CD  = X.SKD_DIR_CD
                          AND T1.CALL_SEQ <> X.CALL_SEQ
                          AND T1.YD_CD       = X.YD_CD
                          AND Y.PSO_BZTP_CD  = X.PSO_BZTP_CD
                          AND Y.VSL_CD       = X.VSL_CD
                          AND Y.SKD_VOY_NO   = X.SKD_VOY_NO
                          AND Y.SKD_DIR_CD   = X.SKD_DIR_CD
                          AND Y.CALL_SEQ     = X.CALL_SEQ
                          AND Y.YD_CD        = X.YD_CD
                          AND Y.LGS_COST_CD  = T2.LGS_COST_CD
                      ) LAST_INV 
                  FROM PSO_CNL_TZ_FEE T1,
                          PSO_CNL_TZ_FEE_DTL T2,
                          TES_LGS_COST C1
                  WHERE T1.PSO_BZTP_CD      = T2.PSO_BZTP_CD
                  AND T1.VSL_CD             = T2.VSL_CD
                  AND T1.SKD_VOY_NO         = T2.SKD_VOY_NO
                  AND T1.SKD_DIR_CD         = T2.SKD_DIR_CD
                  AND T1.YD_CD              = T2.YD_CD
                  AND T1.CALL_SEQ           = T2.CALL_SEQ
                  AND T2.LGS_COST_CD        = C1.LGS_COST_CD
                  AND T1.PSO_BZTP_CD        = '5'
                  AND T1.YD_CD              = @[yd_cd]
                  AND T1.CNL_TZ_BZTP_CD     = 'I'
                  AND T1.NTC_YRMON          = @[rev_yrmon]
                  AND T1.VSL_CD             = substr(@[vvd], 1, 4)
                  AND T1.SKD_VOY_NO         = substr(@[vvd], 5, 4)
                  AND T1.SKD_DIR_CD         = substr(@[vvd], 9)
                  AND T2.LGS_COST_CD NOT LIKE 'CNOW%'
                 )
            GROUP BY ROLLUP (SUBSTR (LGS_COST_CD, 1, 4), LGS_COST_CD)
          ) z
      WHERE NOT ( z.calc_amt IS NULL
      AND z.grp2 = 0
      AND z.credits IS NULL)
    ) T1
WHERE @[sts] = 10
  AND flg IN (0,2)
ORDER BY lgs_cost_cd, flg DESC			]]></sql>
			<params>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="yd_cd" type="12" value="" out="N"/>
				<param name="rev_yrmon" type="12" value="" out="N"/>
				<param name="vndr_seq" type="12" value="" out="N"/>
				<param name="sts" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
