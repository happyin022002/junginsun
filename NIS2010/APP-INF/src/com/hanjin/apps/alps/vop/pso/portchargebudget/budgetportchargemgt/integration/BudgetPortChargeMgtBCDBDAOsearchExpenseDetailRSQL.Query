<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BudgetPortChargeMgtBCDBDAOsearchExpenseDetailRSQL">
			<desc><![CDATA[선택한 VVD 별 Expense Detail 정보를 표시한다.
=======================================
History
2012.08.20 진마리아 CHM-201219078-01 사업계획 - 시나리오 연도 추가
2012.10.11 진마리아 CHM-201220567-01 BUD용 SKD 바라보도록 수정
2014.03.28  SKY       CHM-201429463  Budget & R/Forecast Adjustment 조회시 Compulsory 체크 로직 삽입
2015.03.18  CHM-201534913 DISPLAY항목 추가 및 조회 조건에 테이블 추가]]></desc>
			<sql><![CDATA[
-- ExpnDtl VO
SELECT @[rev_yrmon] EXPN_YRMON,
       T.VSl_SLAN_CD ,
       T.VSL_CD||T.SKD_VOY_NO||T.SKD_DIR_CD VVD,
       T.YD_CD ,
       T.ACCT_CD,
       T.LGS_COST_CD,
       decode(IO_BND_CD, 'I', 'IN', 'O', 'OUT', 'IN/OUT') IO_BND_CD, /*2009.11.18 modified*/
       INV_USD_AMT,
       T.VSL_CD ,
       T.SKD_VOY_NO,
       T.SKD_DIR_CD,
       '' sdt,
       '' edt,
       '' match_flag,
       '' rev_yrmon,
       LOCL_CURR_CD,
       INV_LOCL_AMT,
       '' pso_bztp_cd,
       DECODE(Z.SKD_CNG_STS_CD, 'S', 'Skip', NULL) SKD_CNG_STS_CD,
       E.XPR_DESC,
       E.FOML_DESC,
       T.VNDR_SEQ,
       V.VNDR_LGL_ENG_NM VNDR_NM,
       T.CPLS_FLG
FROM
  ( 
    SELECT DISTINCT T1.PSO_BZTP_CD,
    T1.EXPN_YRMON,
    T1.VSL_CD,
    T1.SKD_VOY_NO,
    T1.SKD_DIR_CD,
    T1.VSl_SLAN_CD,
    C.YD_CD,
    A.ACCT_CD,
    C.LGS_COST_CD, --,T1.VSL_CNTR_CLSS_CAPA CLSS : 추가 예정임
    C.VNDR_SEQ,
    T1.BUD_SCNR_NO,
    C.CPLS_FLG
  FROM PSO_TGT_VVD T1,
    PSO_YD_CHG C,
    TES_LGS_COST A,
    PSO_TGT_YD_EXPN T2
  WHERE T1.PSO_BZTP_CD = decode(@[pso_bztp_cd], '1', '1', '2', '2') --2009.12.07 fix 
    AND C.LGS_COST_CD  = A.LGS_COST_CD
    AND T1.EXPN_YRMON BETWEEN TO_CHAR(C.EFF_DT, 'YYYYMM') AND TO_CHAR(C.EXP_DT,'YYYYMM')
  #if(${pso_bztp_cd} == '1')
  AND TO_CHAR(T1.CRE_DT,'YYYYMM') = (SELECT MAX(TO_CHAR(CRE_DT,'YYYYMM')) FROM PSO_TGT_VVD WHERE PSO_BZTP_CD='1')--BUD_SCNR_NO 조건 없이 가장 최근 생성된 VVD만을 대상으로 함
#end
  AND C.LST_FLG    = 'Y'
  AND T1.VSL_CD     = @[vsl_cd]
  AND T1.SKD_VOY_NO = @[skd_voy_no]
  AND T1.SKD_DIR_CD = @[skd_dir_cd]
#if(${pso_bztp_cd} == '2')
  AND C.YD_CD = @[yd_cd]
#end
  AND T1.PSO_BZTP_CD = T2.PSO_BZTP_CD
  AND T2.LGS_COST_CD = A.LGS_COST_CD
  AND T1.VSL_CD      = T2.VSL_CD
  AND T1.SKD_VOY_NO  = T2.SKD_VOY_NO
  AND T1.SKD_DIR_CD  = T2.SKD_DIR_CD
  AND C.YD_CD        = T2.YD_CD
  ) T 
      ,PSO_TGT_YD_EXPN  E
      ,MDM_VENDOR       V
#if(${pso_bztp_cd} == '1')
      ,VSK_BUD_VSL_PORT_SKD Z
#else 
      ,VSK_VSL_PORT_SKD Z
#end
WHERE T.VSL_CD    = E.VSL_CD(+)
AND T.SKD_VOY_NO  = E.SKD_VOY_NO(+)
AND T.SKD_DIR_CD  = E.SKD_DIR_CD(+)
AND T.PSO_BZTP_CD = E.PSO_BZTP_CD(+)
AND T.YD_CD       = E.YD_CD(+)
AND T.LGS_COST_CD = E.LGS_COST_CD(+)
AND T.BUD_SCNR_NO = E.BUD_SCNR_NO(+)
AND E.REV_YRMON(+) = @[rev_yrmon]

AND    T.VSL_CD = Z.VSL_CD
AND    T.SKD_VOY_NO = Z.SKD_VOY_NO
AND    T.SKD_DIR_CD = Z.SKD_DIR_CD
AND    T.YD_CD = Z.YD_CD

AND    T.VNDR_SEQ = V.VNDR_SEQ
AND    T.VNDR_SEQ = E.VNDR_SEQ(+) -- 과거 데이타에는 Vendor 가 0 으로 되어 있어서 해당 데이타 조회를 위해 Outer 조인함
#if(${match_flag} == 'unmatch')
  AND     NVL(INV_USD_AMT,0)  = 0           -- Mismatch
#end 
#if(${match_flag} == 'match')
  AND     NVL(INV_USD_AMT,0)  > 0           -- Match
#end
ORDER BY T.EXPN_YRMON,
  T.VSl_SLAN_CD ,
  T.VSL_CD||T.SKD_VOY_NO||T.SKD_DIR_CD ,
  Z.CLPT_SEQ ,
  T.YD_CD ,
  T.ACCT_CD,
  T.LGS_COST_CD,
  IO_BND_CD desc			]]></sql>
			<params>
				<param name="rev_yrmon" type="12" value="" out="N"/>
				<param name="pso_bztp_cd" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="yd_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
