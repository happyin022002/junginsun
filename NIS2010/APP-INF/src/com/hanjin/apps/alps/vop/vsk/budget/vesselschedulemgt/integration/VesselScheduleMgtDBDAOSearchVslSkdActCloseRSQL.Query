<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="VesselScheduleMgtDBDAOSearchVslSkdActCloseRSQL">
			<desc><![CDATA[Active & Closing VVD 리스트를 조회한다.

* History
* 2011.02.22 진마리아 CHM-201108456-01 사업계획용 스케줄 정보 노출 대응을 위한 시스템 업데이트건]]></desc>
			<sql><![CDATA[
SELECT  VSL_SLAN_CD
	, PF_SKD_TP_CD
	, VSL_CD
	, VSL_ENG_NM
	, SKD_VOY_NO
	, SKD_DIR_CD
	, SKD_STS_CD
	, VIR_SKD_STS_CD
	, TURN_SKD_VOY_NO
	, TURN_SKD_DIR_CD
	, CRE_DT
	, N1ST_PORT_BRTH_DT
	, SKD_STS_MNL_FLG
	, CRE_USR_ID
	, UPD_USR_ID
	, CUR_CRR_CD
FROM (
		SELECT  T1.VSL_SLAN_CD
    		, T1.PF_SKD_TP_CD
			, T1.VSL_CD
			, T2.VSL_ENG_NM
			, T1.SKD_VOY_NO
			, T1.SKD_DIR_CD
			, T1.SKD_STS_CD
			, T1.SKD_STS_CD AS VIR_SKD_STS_CD
			, T4.TURN_SKD_VOY_NO                              AS TURN_SKD_VOY_NO
			, T4.TURN_SKD_DIR_CD                              AS TURN_SKD_DIR_CD
			, TO_CHAR(T1.CRE_DT, 'YYYY-MM-DD')                AS CRE_DT
			, TO_CHAR(T1.N1ST_PORT_BRTH_DT, 'YYYY-MM-DD')     AS N1ST_PORT_BRTH_DT
			, T1.SKD_STS_MNL_FLG
			, T1.CRE_USR_ID
			, T1.UPD_USR_ID
			, T2.CRR_CD AS CUR_CRR_CD
		FROM    VSK_BUD_VSL_SKD  T1
		, MDM_VSL_CNTR       T2
		, MDM_VSL_SVC_LANE   T3
		, VSK_BUD_VSL_PORT_SKD   T4
		WHERE   1             = 1                
		AND     T1.VSL_CD     = T4.VSL_CD     (+)
		AND     T1.SKD_VOY_NO = T4.SKD_VOY_NO (+)
		AND     T1.SKD_DIR_CD = T4.SKD_DIR_CD (+)
		AND     T3.VSL_TP_CD  = 'C' /*컨테이너선*/
		AND     T4.ROWID      = NVL((SELECT /*+ INDEX_ASC(S XAK4VSK_VSL_PORT_SKD) */
										S.ROWID /* 일부 SKIP된  PORT일 경우 : SKIP이 아닌 첫번째을 대상으로 함. */
									FROM   VSK_BUD_VSL_PORT_SKD S
									WHERE  1 = 1
									AND    S.VSL_CD        = T1.VSL_CD
									AND    S.SKD_VOY_NO    = T1.SKD_VOY_NO
									AND    S.SKD_DIR_CD    = T1.SKD_DIR_CD
									AND    'S'            != NVL(S.SKD_CNG_STS_CD, ' ')
									AND    ROWNUM          = 1
									),
									(SELECT /*+ INDEX_ASC(S XAK4VSK_VSL_PORT_SKD) */
										S.ROWID /* 모두 SKIP된 PORT일 경우 : DELETE 기능 사용을 위해 조회해야 함. */
									FROM   VSK_BUD_VSL_PORT_SKD S
									WHERE  1 = 1
									AND    S.VSL_CD        = T1.VSL_CD
									AND    S.SKD_VOY_NO    = T1.SKD_VOY_NO
									AND    S.SKD_DIR_CD    = T1.SKD_DIR_CD
									AND    ROWNUM          = 1
									))
		AND     T1.VSL_SLAN_CD     = T3.VSL_SLAN_CD
#if (${vsl_svc_tp_cd} == 'T') 
		AND     T3.VSL_SVC_TP_CD  != 'O'
#elseif (${vsl_svc_tp_cd} == 'F') 
		AND     T3.VSL_SVC_TP_CD   = 'O'
#end
#if (${vsl_slan_cd} != '') 
                AND     T1.VSL_SLAN_CD     = @[vsl_slan_cd]
#end
#if (${vsl_cd} != '') 
		AND     T1.VSL_CD          LIKE @[vsl_cd] || '%'
#end
		AND     T1.VSL_CD          = T2.VSL_CD
#if (${skd_sts_cd} == 'CLO')
		AND     (T1.SKD_STS_CD    = 'CLO' AND T1.SKD_STS_MNL_FLG = 'N') /* AUTO CLOSE */
#elseif (${skd_sts_cd} == 'RDY')
		AND     (T1.SKD_STS_CD    = 'RDY') /* Ready */
#elseif (${skd_sts_cd} == 'ACT')
		AND     (T1.SKD_STS_CD    = 'ACT' OR T1.SKD_STS_MNL_FLG = 'Y') /* Activate 면서 AUTO CLOSE가 아닌것 */
#end
		AND     T1.RUSE_PROHI_FLG  = 'N' /* DELETE OR CLOSE 기능을 위한 조회이므로 재무VVD는 조회하지 않음 */
		AND     T1.N1ST_PORT_BRTH_DT != TO_DATE('0001/01/01', 'YYYY/MM/DD') /* 껍데기 VVD 선별, 나중에 삭제 */
	)
ORDER BY N1ST_PORT_BRTH_DT			]]></sql>
			<params>
				<param name="vsl_slan_cd" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
