<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="OwnContainerBookingForecastMgtDBDAOCBFIFSummaryIfBkgDtBbCSQL">
			<desc><![CDATA[OwnContainerBookingForecastMgtDBDAOCBFIFSummaryIfBkgDtBb]]></desc>
			<sql><![CDATA[
INSERT INTO OPF_CGO_BKG_FCAST_SPCL_SMRY (VSL_CD
                                        , SKD_VOY_NO
                                        , SKD_DIR_CD
                                        , YD_CD
                                        , POL_CLPT_IND_SEQ
                                        , CRR_CD
                                        , POD_CD
                                        , BLCK_STWG_CD
                                        , CBF_SPCL_SMRY_SEQ
                                        , CNTR_TPSZ_CD
                                        , BB_CGO_FLG
                                        , CNTR_QTY
                                        , USD_BKG_TTL_QTY
                                        , VOID_20FT_QTY
                                        , CRE_USR_ID
                                        , CRE_DT
                                        , UPD_USR_ID
                                        , UPD_DT
                                        , PRCT_FLG
                                        , STWG_CD
                                        , CBF_RMK
                                        )
   SELECT @[vsl_cd]
        , @[skd_voy_no]
        , @[skd_dir_cd]
        , @[pol_cd]
        , @[pol_clpt_ind_seq]
        , 'SML'
        , POD_CD
        , SUBSTR(MLB,3,5)
        , CBF_SPCL_SMRY_SEQ + ROWNUM
        , CNTR_TPSZ_CD
        , 'Y'
        , USED_QTY
        , CARGO_QTY
        , VOID_QTY
        , @[cre_usr_id]
        , SYSDATE
        , @[upd_usr_id]
        , SYSDATE
        , PRCT_FLG
        , STWG_CD
        , CBF_RMK
   FROM (
        SELECT POD_CD, MLB , CNTR_TPSZ_CD, USED_QTY, VOID_QTY, CARGO_QTY, 
        (     SELECT NVL(MAX(CBF_SPCL_SMRY_SEQ),0)
                    FROM OPF_CGO_BKG_FCAST_SPCL_SMRY
                   WHERE VSL_CD     = @[vsl_cd]
                     AND SKD_VOY_NO = @[skd_voy_no]
                     AND SKD_DIR_CD = @[skd_dir_cd]
                     AND YD_CD      = @[pol_cd]
                     AND POL_CLPT_IND_SEQ = @[pol_clpt_ind_seq] ) AS CBF_SPCL_SMRY_SEQ,
               PRCT_FLG, STWG_CD, CBF_RMK
  FROM (
  SELECT POD_CD, MLB , CNTR_TPSZ_CD,PRCT_FLG, STWG_CD, CBF_RMK, SUM(QTY) USED_QTY, SUM(OVR_VOID_SLT_QTY) VOID_QTY, SUM(CARGO_QTY) CARGO_QTY
            FROM (
              SELECT  BKG.BKG_NO, QTY.CNTR_TPSZ_CD , BQD.OP_CNTR_QTY QTY ,VVD.POD_CD,
                      OPF_BLCK_STWG_CD(VVD.VSL_CD||VVD.SKD_VOY_NO||VVD.SKD_DIR_CD, VVD.POL_YD_CD, VVD.POL_CLPT_IND_SEQ, BKG.BKG_NO) AS MLB ,
                    ( SELECT COUNT(1) FROM BKG_BB_CGO WHERE BKG_NO = BKG.BKG_NO ) CARGO_QTY,
                      OVR_VOID_SLT_QTY ,
                      BKG.PRCT_FLG, BKG.STWG_CD,
                      REPLACE((SELECT DECODE(MIN(RCV_TERM_CD),'Y','CY','D','DOOR','S','CFS','T','Tackle','I','Free In','M','Mixed') FROM BKG_BB_CGO WHERE BKG_NO=BKG.BKG_NO)||','||
                        (SELECT COUNT(1) RCNT FROM BKG_BB_CGO WHERE BKG_NO=BKG.BKG_NO)||' PKG'||','||
                        (SELECT WM_CONCAT('L'||DIM_LEN||'x'||'W'||DIM_WDT||'x'||'H'||DIM_HGT||'*'||DECODE(WGT_UT_CD,'LBS',GRS_WGT||'Tons',ROUND(GRS_WGT/1000,2)||'Tons')) INFO FROM BKG_BB_CGO WHERE BKG_NO=BKG.BKG_NO ),'*',',') CBF_RMK
        FROM BKG_VVD       VVD, 
             BKG_BOOKING   BKG,
             BKG_QUANTITY  QTY,
             BKG_QTY_DTL   BQD
       WHERE VVD.VSL_CD                          =  @[vsl_cd]
         AND VVD.SKD_VOY_NO                      =  @[skd_voy_no]
         AND VVD.SKD_DIR_CD                      =  @[skd_dir_cd]
         AND VVD.POL_YD_CD                       =  @[pol_cd]
         AND VVD.POL_CLPT_IND_SEQ                =  @[pol_clpt_ind_seq]
         AND VVD.BKG_NO                          = BKG.BKG_NO
		#if(${bkg_sts_cd} != 'All')
		AND BKG.BKG_STS_CD = @[bkg_sts_cd]
		#end
         AND BKG.BKG_STS_CD  <> 'X'
         AND BKG.BKG_NO        = QTY.BKG_NO  
         AND QTY.CNTR_TPSZ_CD NOT LIKE 'Q%' 
         AND BQD.BKG_NO  = BKG.BKG_NO
         AND BQD.BB_CGO_FLG = 'Y'
         AND BQD.CNTR_TPSZ_CD = QTY.CNTR_TPSZ_CD
        ) X  
        GROUP BY POD_CD, MLB , CNTR_TPSZ_CD ,PRCT_FLG, STWG_CD, CBF_RMK ) Y )			]]></sql>
			<params>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pol_clpt_ind_seq" type="12" value="" out="N"/>
				<param name="cre_usr_id" type="12" value="" out="N"/>
				<param name="upd_usr_id" type="12" value="" out="N"/>
				<param name="bkg_sts_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
