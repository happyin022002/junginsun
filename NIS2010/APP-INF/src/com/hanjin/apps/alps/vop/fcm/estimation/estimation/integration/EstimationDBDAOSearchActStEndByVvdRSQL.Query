<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="EstimationDBDAOSearchActStEndByVvdRSQL">
			<desc><![CDATA[Search actual start, end info by VVD.]]></desc>
			<sql><![CDATA[
SELECT  MAX(VSL_CD) VSL_CD
       ,MAX(SKD_VOY_NO) SKD_VOY_NO
       ,MAX(SKD_DIR_CD) SKD_DIR_CD
       ,MAX(ST_PORT_CD) ST_PORT_CD
       ,MAX(ST_CLPT_IND_SEQ) ST_CLPT_IND_SEQ
       ,TO_CHAR(MAX(ST_ETB_DT), 'YYYYMMDD') AS ST_ETB_DT
       ,MAX(END_SKD_VOY_NO) END_SKD_VOY_NO
       ,MAX(END_SKD_DIR_CD) END_SKD_DIR_CD
       ,MAX(END_PORT_CD) END_PORT_CD
       ,MAX(END_CLPT_IND_SEQ) END_CLPT_IND_SEQ
       ,TO_CHAR(MAX(END_ETB_DT), 'YYYYMMDD') AS END_ETB_DT
FROM (
    SELECT VVD_SEQ
           ,DECODE(VVD_SEQ, 1, VSL_CD, '') VSL_CD
           ,DECODE(START_SEQ, 1, SKD_VOY_NO, '') SKD_VOY_NO
           ,DECODE(START_SEQ, 1, SKD_DIR_CD, '') SKD_DIR_CD
           ,DECODE(START_SEQ, 1, VPS_PORT_CD, '') ST_PORT_CD
           ,DECODE(START_SEQ, 1, CLPT_IND_SEQ, '') ST_CLPT_IND_SEQ
           ,DECODE(START_SEQ, 1, VPS_ETB_DT, '') ST_ETB_DT
           ,DECODE(END_SEQ, 1, SKD_VOY_NO, '') END_SKD_VOY_NO
           ,DECODE(END_SEQ, 1, SKD_DIR_CD, '') END_SKD_DIR_CD
           ,DECODE(END_SEQ, 1, VPS_PORT_CD, '') END_PORT_CD
           ,DECODE(END_SEQ, 1, CLPT_IND_SEQ, '') END_CLPT_IND_SEQ
           ,DECODE(END_SEQ, 1, VPS_ETB_DT, '') END_ETB_DT
    FROM (
        -- >>>> TARGET VVD
        WITH SKD AS (
            SELECT @[vsl_cd] VSL_CD
                 , @[skd_voy_no] SKD_VOY_NO
                 , @[skd_dir_cd] SKD_DIR_CD
            FROM DUAL
        )
        -- <<<< TARGET VVD
        SELECT
        T1.*,
        ROW_NUMBER() OVER(ORDER BY VVD_SEQ, PORT_SEQ) START_SEQ,
        ROW_NUMBER() OVER(ORDER BY VVD_SEQ DESC, PORT_SEQ DESC) END_SEQ
        FROM (
            SELECT 1 VVD_SEQ
                   , T1.VSL_CD
                   , T1.SKD_VOY_NO
                   , T1.SKD_DIR_CD
                   , T1.VPS_PORT_CD
                   , T1.CLPT_IND_SEQ
                   , T1.CLPT_SEQ
                   , T1.VPS_ETA_DT
                   , T1.VPS_ETB_DT
                   , T1.VPS_ETD_DT
                   , ROW_NUMBER() OVER(PARTITION BY T1.VSL_CD, T1.SKD_VOY_NO, T1.SKD_DIR_CD ORDER BY T1.CLPT_SEQ) PORT_SEQ
            FROM SKD, VSK_VSL_PORT_SKD T1
            WHERE 1=1
            AND SKD.VSL_CD=T1.VSL_CD
            AND SKD.SKD_VOY_NO=T1.SKD_VOY_NO
            AND SKD.SKD_DIR_CD=T1.SKD_DIR_CD
            AND NVL(T1.SKD_CNG_STS_CD, 'X')<>'S'
            UNION ALL
            SELECT 2 VVD_SEQ
                   , T1.VSL_CD
                   , T1.SKD_VOY_NO
                   , T1.SKD_DIR_CD
                   , T1.VPS_PORT_CD
                   , T1.CLPT_IND_SEQ
                   , T1.CLPT_SEQ
                   , T1.VPS_ETA_DT
                   , T1.VPS_ETB_DT
                   , T1.VPS_ETD_DT
                   , ROW_NUMBER() OVER(PARTITION BY T1.VSL_CD, T1.SKD_VOY_NO, T1.SKD_DIR_CD ORDER BY T1.CLPT_SEQ DESC) PORT_SEQ
            FROM 
            (
                SELECT T1.VSL_CD, T1.TURN_SKD_VOY_NO SKD_VOY_NO, T1.TURN_SKD_DIR_CD SKD_DIR_CD
                FROM SKD, VSK_VSL_PORT_SKD T1
                WHERE 1=1
                AND SKD.VSL_CD=T1.VSL_CD
                AND SKD.SKD_VOY_NO=T1.SKD_VOY_NO
                AND SKD.SKD_DIR_CD=T1.SKD_DIR_CD
                AND T1.TURN_PORT_IND_CD IN ('D', 'V', 'F')
                AND NVL(T1.SKD_CNG_STS_CD, 'X')<>'S'
                GROUP BY T1.VSL_CD, T1.TURN_SKD_VOY_NO, T1.TURN_SKD_DIR_CD
            )
            SKD, VSK_VSL_PORT_SKD T1
            WHERE 1=1
            AND SKD.VSL_CD=T1.VSL_CD
            AND SKD.SKD_VOY_NO=T1.SKD_VOY_NO
            AND SKD.SKD_DIR_CD=T1.SKD_DIR_CD
            AND NVL(T1.SKD_CNG_STS_CD, 'X')<>'S'

            ORDER BY VVD_SEQ, PORT_SEQ
        )T1
    )
    WHERE 1=1
    AND START_SEQ=1 OR END_SEQ=1
)			]]></sql>
			<params>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
