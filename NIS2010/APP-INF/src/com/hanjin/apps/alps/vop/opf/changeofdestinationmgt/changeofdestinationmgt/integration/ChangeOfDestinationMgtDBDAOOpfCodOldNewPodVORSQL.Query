<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ChangeOfDestinationMgtDBDAOOpfCodOldNewPodVORSQL">
			<desc><![CDATA[COD Detail - Calculation 시 Old POD, New POD, CNTR TP/SZ 조회 쿼리

History
2015.03.06 이병훈 [CHM-201534196] COD charges DVC 비용 관련 로직 수정]]></desc>
			<sql><![CDATA[
-- OLD_POD CLPT_SEQ & NEW_POD CLPT_SEQ 추출
SELECT
    (
        SELECT MIN(CLPT_SEQ)
        FROM VSK_VSL_PORT_SKD
        WHERE VSL_CD = OLDVVD.VSL_CD
        AND SKD_VOY_NO = OLDVVD.SKD_VOY_NO
        AND SKD_DIR_CD = OLDVVD.SKD_DIR_CD
        AND VPS_PORT_CD = SUBSTR(OLDVVD.POD_YD_CD, 1, 5)
        AND NVL(SKD_CNG_STS_CD,' ') <> 'S'
    ) AS OLD_POD_CLPT_SEQ
    ,(
        SELECT MIN(CLPT_SEQ)
        FROM VSK_VSL_PORT_SKD
        WHERE VSL_CD = NEWVVD.VSL_CD
        AND SKD_VOY_NO = NEWVVD.SKD_VOY_NO
        AND SKD_DIR_CD = NEWVVD.SKD_DIR_CD
        AND VPS_PORT_CD = SUBSTR(NEWVVD.POD_YD_CD, 1, 5)
        AND NVL(SKD_CNG_STS_CD,' ') <> 'S'
    ) AS NEW_POD_CLPT_SEQ
    ,NULL AS CNTR_TPSZ_CD
    ,NULL AS CNTR_QTY
FROM BKG_COD COD, BKG_COD_VVD OLDVVD, BKG_COD_VVD NEWVVD
WHERE COD.BKG_NO = @[bkg_no]
    AND COD.COD_RQST_SEQ = @[cod_rqst_seq]
    AND COD.BKG_NO = OLDVVD.BKG_NO
    AND COD.COD_RQST_SEQ = OLDVVD.COD_RQST_SEQ
    AND COD.BKG_NO = NEWVVD.BKG_NO
    AND COD.COD_RQST_SEQ = NEWVVD.COD_RQST_SEQ
    AND OLDVVD.VVD_OP_CD = 'O'
    AND NEWVVD.VVD_OP_CD = 'N'
    AND OLDVVD.VSL_CD||OLDVVD.SKD_VOY_NO||OLDVVD.SKD_DIR_CD = NEWVVD.VSL_CD||NEWVVD.SKD_VOY_NO||NEWVVD.SKD_DIR_CD
    AND OLDVVD.POD_YD_CD <> NEWVVD.POD_YD_CD
    
UNION ALL

-- CNTR_TPSZ_CD & CNTR_QTY 추출
SELECT
    NULL AS OLD_POD_ETA
    ,NULL AS NEW_POD_ETA
    ,CNTR_TPSZ_CD
    ,COUNT(*) CNTR_QTY
FROM BKG_COD_CNTR
WHERE BKG_NO = @[bkg_no]
    AND COD_RQST_SEQ(+) = @[cod_rqst_seq]
	AND COD_SLCT_FLG = 'Y'
GROUP BY CNTR_TPSZ_CD			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="cod_rqst_seq" type="2" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
