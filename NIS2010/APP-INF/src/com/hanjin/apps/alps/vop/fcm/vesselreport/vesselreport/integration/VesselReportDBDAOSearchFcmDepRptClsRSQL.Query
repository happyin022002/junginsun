<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="VesselReportDBDAOSearchFcmDepRptClsRSQL">
			<desc><![CDATA[FCM DEPARTURE REPORT Cleansing 을 위한 데이터 조회]]></desc>
			<sql><![CDATA[
WITH FCM_DEP_RPT_TMP AS (
    SELECT 
        VSL_CD
        ,SKD_VOY_NO
        ,SKD_DIR_CD
        ,VSL_SLAN_CD
        ,DEP_PORT_CD
        ,CLPT_IND_SEQ
        ,REF_NO
        ,GMT_TD_HRS
        ,NXT_PORT_CD
        ,DEP_STS_CD
        ,RMN_DIST
        ,RMN_AVG_SPD
        ,NVL2(NXT_PORT_ETA_DT,TO_CHAR(NXT_PORT_ETA_DT, 'YYYYMMDDHH24MI'),'') AS NXT_PORT_ETA_DT
        ,NVL2(SB_ENG_DT,TO_CHAR(SB_ENG_DT, 'YYYYMMDDHH24MI'),'') AS SB_ENG_DT
        ,NVL2(PLT_IN_DT,TO_CHAR(PLT_IN_DT, 'YYYYMMDDHH24MI'),'') AS PLT_IN_DT
        ,NVL2(BFR_BRTH_ANK_DRP_DT,TO_CHAR(BFR_BRTH_ANK_DRP_DT, 'YYYYMMDDHH24MI'),'') AS BFR_BRTH_ANK_DRP_DT
        ,NVL2(BFR_BRTH_ANK_OFF_DT,TO_CHAR(BFR_BRTH_ANK_OFF_DT, 'YYYYMMDDHH24MI'),'') AS BFR_BRTH_ANK_OFF_DT
        ,NVL2(VPS_ETB_DT,TO_CHAR(VPS_ETB_DT, 'YYYYMMDDHH24MI'),'') AS VPS_ETB_DT
        ,NVL2(CGO_WRK_ST_DT,TO_CHAR(CGO_WRK_ST_DT, 'YYYYMMDDHH24MI'),'') AS CGO_WRK_ST_DT
        ,NVL2(CGO_WRK_END_DT,TO_CHAR(CGO_WRK_END_DT, 'YYYYMMDDHH24MI'),'') AS CGO_WRK_END_DT
        ,NVL2(VPS_ETD_DT,TO_CHAR(VPS_ETD_DT, 'YYYYMMDDHH24MI'),'') AS VPS_ETD_DT
        ,NVL2(AFT_UNBRTH_ANK_DRP_DT,TO_CHAR(AFT_UNBRTH_ANK_DRP_DT, 'YYYYMMDDHH24MI'),'') AS AFT_UNBRTH_ANK_DRP_DT
        ,NVL2(AFT_UNBRTH_ANK_OFF_DT,TO_CHAR(AFT_UNBRTH_ANK_OFF_DT, 'YYYYMMDDHH24MI'),'') AS AFT_UNBRTH_ANK_OFF_DT
        ,NVL2(PLT_OUT_DT,TO_CHAR(PLT_OUT_DT, 'YYYYMMDDHH24MI'),'') AS PLT_OUT_DT
        ,NVL2(RUP_DT,TO_CHAR(RUP_DT, 'YYYYMMDDHH24MI'),'') AS RUP_DT
        ,MNVR_IN_ML_DIST
        ,MNVR_OUT_ML_DIST
        ,NVGT_ML_DIST
        ,ENG_ML_DIST
        ,AVG_SPD
        ,AVG_RPM_PWR
        ,RUN_HRS_IN_HV_WE
        ,SEA_DET_RSN_CD1
        ,SEA_DET_RSN_HRS1
        ,SEA_DET_RSN_CD2
        ,SEA_DET_RSN_HRS2
        ,SEA_DET_RSN_CD3
        ,SEA_DET_RSN_HRS3
        ,PORT_DET_RSN_CD1
        ,PORT_DET_RSN_HRS1
        ,PORT_DET_RSN_CD2
        ,PORT_DET_RSN_HRS2
        ,PORT_DET_RSN_CD3
        ,PORT_DET_RSN_HRS3
        ,ARR_FWDDR_HGT
        ,ARR_MID_DRFT_HGT
        ,ARR_AFTDR_HGT
        ,ARR_GM_HGT
        ,ARR_FOIL_WGT
        ,ARR_DOIL_WGT
        ,ARR_FRSH_WTR_WGT
        ,ARR_BLST_WGT
        ,ARR_LOW_SULP_FOIL_WGT
        ,ARR_LOW_SULP_DOIL_WGT
        ,DEP_FWDDR_HGT
        ,DEP_MID_DRFT_HGT
        ,DEP_AFTDR_HGT
        ,DEP_GM_HGT
        ,DEP_FOIL_WGT
        ,DEP_DOIL_WGT
        ,DEP_FRSH_WTR_WGT
        ,DEP_BLST_WGT
        ,DEP_LOW_SULP_FOIL_WGT
        ,DEP_LOW_SULP_DOIL_WGT
        ,NXT_FWDDR_HGT
        ,NXT_MID_DRFT_HGT
        ,NXT_AFTDR_HGT
        ,NXT_GM_HGT
        ,NXT_FOIL_WGT
        ,NXT_DOIL_WGT
        ,NXT_FRSH_WTR_WGT
        ,NXT_BLST_WGT
        ,NXT_LOW_SULP_FOIL_WGT
        ,NXT_LOW_SULP_DOIL_WGT
        ,SEA_MN_FOIL_CSM_QTY
        ,SEA_GNR_FOIL_CSM_QTY
        ,SEA_BLR_FOIL_CSM_QTY
        ,SEA_MN_DOIL_CSM_QTY
        ,SEA_GNR_DOIL_CSM_QTY
        ,SEA_BLR_DOIL_CSM_QTY
        ,SEA_MN_LOW_SULP_FOIL_CSM_QTY
        ,SEA_GNR_LOW_SULP_FOIL_CSM_QTY
        ,SEA_BLR_LOW_SULP_FOIL_CSM_QTY
        ,SEA_MN_LOW_SULP_DOIL_CSM_QTY
        ,SEA_GNR_LOW_SULP_DOIL_CSM_QTY
        ,SEA_BLR_LOW_SULP_DOIL_CSM_QTY
        ,PORT_MN_FOIL_CSM_QTY
        ,PORT_GNR_FOIL_CSM_QTY
        ,PORT_BLR_FOIL_CSM_QTY
        ,PORT_MN_DOIL_CSM_QTY
        ,PORT_GNR_DOIL_CSM_QTY
        ,PORT_BLR_DOIL_CSM_QTY
        ,PORT_MN_LOW_SULP_FOIL_CSM_QTY
        ,PORT_GNR_LOW_SULP_FOIL_CSM_QTY
        ,PORT_BLR_LOW_SULP_FOIL_CSM_QTY
        ,PORT_MN_LOW_SULP_DOIL_CSM_QTY
        ,PORT_GNR_LOW_SULP_DOIL_CSM_QTY
        ,PORT_BLR_LOW_SULP_DOIL_CSM_QTY
        ,SPL_FOIL_BDR_WGT
        ,SPL_FOIL_ACT_WGT
        ,SPL_FOIL_SULP_WGT
        ,SPL_FOIL_BRG_WGT1
        ,SPL_FOIL_BRG_WGT2
        ,SPL_DOIL_BDR_WGT
        ,SPL_DOIL_ACT_WGT
        ,SPL_DOIL_SULP_WGT
        ,SPL_DOIL_BRG_WGT1
        ,SPL_DOIL_BRG_WGT2
        ,SPL_FRSH_WTR_ACT_WGT
        ,SPL_LOW_SULP_FOIL_BDR_WGT
        ,SPL_LOW_SULP_FOIL_ACT_WGT
        ,SPL_LOW_SULP_FOIL_SULP_WGT
        ,SPL_LOW_SULP_FOIL_BRG_WGT1
        ,SPL_LOW_SULP_FOIL_BRG_WGT2
        ,SPL_LOW_SULP_DOIL_BDR_WGT
        ,SPL_LOW_SULP_DOIL_ACT_WGT
        ,SPL_LOW_SULP_DOIL_SULP_WGT
        ,SPL_LOW_SULP_DOIL_BRG_WGT1
        ,SPL_LOW_SULP_DOIL_BRG_WGT2
        ,SEA_DNST
        ,FULL_CNTR_OBRD_TEU
        ,MTY_CNTR_OBRD_TEU
        ,TTL_CNTR_OBRD_TEU
        ,RF_CNTR_DCHG_KNT
        ,RF_CNTR_LOD_KNT
        ,RF_CNTR_OBRD_KNT
        ,DEP_CGO_WGT
        ,DEP_DPL_WGT
        ,BLK_LOD_DCHG_STS_CD
        ,BLK_CGO_TP_CD1
        ,BLK_CGO_TP_CD2
        ,BLK_CGO_TP_CD3
        ,BLK_CGO_TP_CD4
        ,BLK_CGO_TP_CD5
        ,BLK_HLD_LOAD_QTY1
        ,BLK_HLD_LOAD_QTY2
        ,BLK_HLD_LOAD_QTY3
        ,BLK_HLD_LOAD_QTY4
        ,BLK_HLD_LOAD_QTY5
        ,BLK_HLD_LOAD_QTY6
        ,BLK_HLD_LOAD_QTY7
        ,BLK_HLD_LOAD_QTY8
        ,BLK_HLD_LOAD_QTY9
        ,BLK_DEP_CGO_TTL_WGT
        ,TTL_SLG_WGT
        ,FO_SLG_WGT
        ,INCNR_SLG_WGT
        ,DPL_SLG_WGT
        ,DPL_SLG_SP
        ,RMN_SDG_WGT
        ,FOIL_PURF_DCHG_ITVAL
        ,DEP_RMK
        ,ARR_LAT
        ,ARR_LON
        ,ARR_SAIL_HRS
        ,ARR_NVGT_ML
        ,ARR_ENG_ML
        ,ARR_RPM_PWR
        ,ARR_MN_FOIL_CSM_QTY
        ,ARR_MN_LOW_SULP_FOIL_CSM_QTY
        ,ARR_GNR_FOIL_CSM_QTY
        ,ARR_GNR_LOW_SULP_FOIL_CSM_QTY
        ,ARR_BLR_FOIL_CSM_QTY
        ,ARR_BLR_LOW_SULP_FOIL_CSM_QTY
        ,ARR_DOIL_CSM_QTY
        ,ARR_LOW_SULP_DOIL_CSM_QTY
        ,DEP_LAT
        ,DEP_LON
        ,DEP_RPM_PWR
        ,DEP_RPM_MAX_PWR
        ,DEP_RPM_MIN_PWR
        ,DEP_RPM_UUSD_FM
        ,DEP_RPM_UUSD_TO
        ,DEP_ARR_PLT_MGN_HRS
        ,DEP_ARR_PLT_MGN_MNTS
        ,DEP_RSN_FOR_MGN_TM
        ,CAP_NM
        ,CF_ENG_NM
        ,CRE_USR_ID
        ,CRE_DT
        ,UPD_USR_ID
        ,UPD_DT
    FROM FCM_DEP_RPT
    WHERE VSL_CD = @[vsl_cd]
    AND SKD_VOY_NO = @[skd_voy_no]
    AND SKD_DIR_CD = @[skd_dir_cd]
    AND DEP_PORT_CD = @[dep_port_cd]
    AND CLPT_IND_SEQ = @[clpt_ind_seq]
)
, 
VSK_SKD_TMP AS (
    -- Last Port Schedule 를 추출하기 위한 쿼리
    SELECT
        T1.VSL_CD
        ,T1.SKD_VOY_NO
        ,T1.SKD_DIR_CD
        ,T1.VPS_PORT_CD
        ,T1.CLPT_IND_SEQ
		,LAG(T1.VSL_CD) OVER (PARTITION BY T1.VSL_CD ORDER BY T1.SKD_VOY_NO, T2.VSL_SLAN_DIR_SEQ, T1.CLPT_SEQ) AS LST_VSL_CD
		,LAG(T1.SKD_VOY_NO) OVER (PARTITION BY T1.VSL_CD ORDER BY T1.SKD_VOY_NO, T2.VSL_SLAN_DIR_SEQ, T1.CLPT_SEQ) AS LST_SKD_VOY_NO
		,LAG(T1.SKD_DIR_CD) OVER (PARTITION BY T1.VSL_CD ORDER BY T1.SKD_VOY_NO, T2.VSL_SLAN_DIR_SEQ, T1.CLPT_SEQ) AS LST_SKD_DIR_CD
        ,LAG(T1.VPS_PORT_CD) OVER (PARTITION BY T1.VSL_CD ORDER BY T1.SKD_VOY_NO, T2.VSL_SLAN_DIR_SEQ, T1.CLPT_SEQ) AS LST_DEP_PORT_CD
        ,LAG(T1.CLPT_IND_SEQ) OVER (PARTITION BY T1.VSL_CD ORDER BY T1.SKD_VOY_NO, T2.VSL_SLAN_DIR_SEQ, T1.CLPT_SEQ) AS LST_CLPT_IND_SEQ
    FROM VSK_VSL_PORT_SKD T1, MDM_VSL_SVC_LANE_DIR T2
    WHERE T1.SLAN_CD = T2.VSL_SLAN_CD
    AND T1.SKD_DIR_CD = T2.VSL_SLAN_DIR_CD
    AND T1.TURN_PORT_IND_CD IN ('Y','N')
    AND NVL(T1.SKD_CNG_STS_CD, 'X')<>'S'
    AND T1.VSL_CD IN (
        SELECT VSL_CD FROM FCM_DEP_RPT_TMP
    )
)
,
FCM_DEP_RPT_CLS_TMP AS (
    SELECT
        T2.LST_VSL_CD,
        T2.LST_SKD_VOY_NO,
        T2.LST_SKD_DIR_CD,
        T2.LST_DEP_PORT_CD,
        T2.LST_CLPT_IND_SEQ,
        T1.* 
    FROM FCM_DEP_RPT_TMP T1, VSK_SKD_TMP T2
    WHERE T1.VSL_CD = T2.VSL_CD
    AND T1.SKD_VOY_NO = T2.SKD_VOY_NO
    AND T1.SKD_DIR_CD = T2.SKD_DIR_CD
    AND T1.DEP_PORT_CD = T2.VPS_PORT_CD
    AND T1.CLPT_IND_SEQ = T2.CLPT_IND_SEQ
)
, 
FCM_DEP_RPT_CLS_T AS (
    -- Last Port 의 정보 추출 
    SELECT 
    (
        SELECT 
            T2.DEP_FOIL_WGT || '|' 
            || T2.DEP_LOW_SULP_FOIL_WGT || '|' 
            || T2.DEP_DOIL_WGT || '|' 
            || T2.DEP_LOW_SULP_DOIL_WGT || '|' 
            || T2.RF_CNTR_OBRD_KNT || '|'  
            || NVL2(T2.RUP_DT,TO_CHAR(T2.RUP_DT, 'YYYYMMDDHH24MI'),'') || '|' AS LST_DAT
        FROM FCM_DEP_RPT T2 
        WHERE T2.VSL_CD = T1.LST_VSL_CD 
        AND T2.SKD_VOY_NO = T1.LST_SKD_VOY_NO 
        AND T2.SKD_DIR_CD = T1.LST_SKD_DIR_CD
        AND T2.DEP_PORT_CD = T1.LST_DEP_PORT_CD
        AND T2.CLPT_IND_SEQ = T1.LST_CLPT_IND_SEQ
    ) AS LST_DAT
    ,T1.* 
    FROM FCM_DEP_RPT_CLS_TMP T1
)

SELECT 
    (
        SELECT CNTR_DZN_CAPA
        FROM MDM_VSL_CNTR
        WHERE VSL_CD = T1.VSL_CD
        AND ROWNUM = 1 
    ) AS CNTR_DZN_CAPA
    ,SUBSTR(T1.LST_DAT, 1, INSTR(T1.LST_DAT, '|', 1, 1) - 1) AS LST_DEP_FOIL_CTNT
    ,SUBSTR(T1.LST_DAT, INSTR(T1.LST_DAT, '|', 1, 1)+1, INSTR(T1.LST_DAT, '|', 1, 2) - INSTR(T1.LST_DAT, '|', 1, 1)-1) AS LST_DEP_LOW_SULP_FOIL_CTNT
    ,SUBSTR(T1.LST_DAT, INSTR(T1.LST_DAT, '|', 1, 2)+1, INSTR(T1.LST_DAT, '|', 1, 3) - INSTR(T1.LST_DAT, '|', 1, 2)-1) AS LST_DEP_DOIL_CTNT
    ,SUBSTR(T1.LST_DAT, INSTR(T1.LST_DAT, '|', 1, 3)+1, INSTR(T1.LST_DAT, '|', 1, 4) - INSTR(T1.LST_DAT, '|', 1, 3)-1) AS LST_DEP_LOW_SULP_DOIL_CTNT
    ,SUBSTR(T1.LST_DAT, INSTR(T1.LST_DAT, '|', 1, 4)+1, INSTR(T1.LST_DAT, '|', 1, 5) - INSTR(T1.LST_DAT, '|', 1, 4)-1) AS LST_RF_CNTR_OBRD_KNT_CTNT
    ,SUBSTR(T1.LST_DAT, INSTR(T1.LST_DAT, '|', 1, 5)+1, INSTR(T1.LST_DAT, '|', 1, 6) - INSTR(T1.LST_DAT, '|', 1, 5)-1) AS LST_PORT_RUP_DT
    ,T1.* 
FROM FCM_DEP_RPT_CLS_T T1			]]></sql>
			<params>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="dep_port_cd" type="12" value="" out="N"/>
				<param name="clpt_ind_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
