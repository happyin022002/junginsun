<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="VesselScheduleMgtDBDAOModifyVskVslPortSkdByActualUSQL">
			<desc><![CDATA[DESC Enter..

20140227 임예지 [CHM-201429074] ATA, ATB, ATD 개별 삭제뒤 SAVE시 PORT_SKD_STS_CD UPDATE 로직 변경]]></desc>
			<sql><![CDATA[
UPDATE  VSK_VSL_PORT_SKD T1
SET     PORT_SKD_STS_CD = ( 
		CASE WHEN (SELECT   X.TURN_PORT_IND_CD
  			       FROM     VSK_VSL_PORT_SKD   X
  			       WHERE    1 = 1
  			       AND      X.VSL_CD           = @[vsl_cd]
  			       AND      X.SKD_VOY_NO       = @[skd_voy_no]
   				   AND      X.SKD_DIR_CD       = @[skd_dir_cd]
           		   AND      X.VPS_PORT_CD      = @[vps_port_cd]
          		   AND      X.CLPT_IND_SEQ     = @[clpt_ind_seq]
           ) IN ('Y','N') THEN (SELECT   AK.PORT_SKD_STS_CD
                                FROM     VSK_ACT_PORT_SKD   AK
                                WHERE    1 = 1
                                AND      AK.VSL_CD          = @[vsl_cd]
                                AND      AK.SKD_VOY_NO      = @[skd_voy_no]
                                AND      AK.SKD_DIR_CD      = @[skd_dir_cd]
                                AND      AK.VPS_PORT_CD     = @[vps_port_cd]
                                AND      AK.CLPT_IND_SEQ    = @[clpt_ind_seq]
     	                        )
     	   ELSE
                               (SELECT   AK.PORT_SKD_STS_CD
                                FROM     VSK_VSL_PORT_SKD   X
                                      ,  VSK_ACT_PORT_SKD   AK
                                WHERE    1 = 1
                                AND      X.VSL_CD           = AK.VSL_CD
                                AND      X.TURN_SKD_VOY_NO  = AK.SKD_VOY_NO
                                AND      X.TURN_SKD_DIR_CD  = AK.SKD_DIR_CD
                                AND      X.VPS_PORT_CD      = AK.VPS_PORT_CD
                                AND      X.TURN_CLPT_IND_SEQ= AK.CLPT_IND_SEQ
								AND      X.VSL_CD           = @[vsl_cd]
  			       				AND      X.SKD_VOY_NO       = @[skd_voy_no]
   				   				AND      X.SKD_DIR_CD       = @[skd_dir_cd]
           		   				AND      X.VPS_PORT_CD      = @[vps_port_cd]
          		   				AND      X.CLPT_IND_SEQ     = @[clpt_ind_seq]
                                )
		END), 

    	YD_CD           = NVL(@[yd_cd], YD_CD),
        CALL_YD_IND_SEQ = (
                            SELECT  DECODE(COUNT(*), 0, 1, COUNT(*))		/* YD_CD 가 변경이 되면 0이 발생할 수 있음. */
                            FROM    VSK_VSL_PORT_SKD T2
                            WHERE   T2.VSL_CD       = T1.VSL_CD
                            AND     T2.SKD_VOY_NO   = T1.SKD_VOY_NO
                            AND     T2.SKD_DIR_CD   = T1.SKD_DIR_CD
                            AND     T2.CLPT_SEQ     <= (SELECT  CLPT_SEQ
                                                      FROM    VSK_VSL_PORT_SKD T3
                                                      WHERE   T2.VSL_CD    = T3.VSL_CD
                                                      AND     SKD_VOY_NO   = @[skd_voy_no]
                                                      AND     SKD_DIR_CD   = @[skd_dir_cd]
                                                      AND     VPS_PORT_CD  = @[vps_port_cd]
                                                      AND     CLPT_IND_SEQ = @[clpt_ind_seq]
                                                     )
                           AND      T2.YD_CD        = @[yd_cd]
                           ),
        VPS_ETA_DT      = NVL(TO_DATE(@[vps_eta_dt], 'YYYYMMDDHH24MI'), VPS_ETA_DT),
        VPS_ETB_DT      = NVL(TO_DATE(@[vps_etb_dt], 'YYYYMMDDHH24MI'), VPS_ETB_DT),
        VPS_ETD_DT      = NVL(TO_DATE(@[vps_etd_dt], 'YYYYMMDDHH24MI'), VPS_ETD_DT),
        UPD_USR_ID      = @[upd_usr_id],
        UPD_DT          = SYSDATE,
		ACT_INP_FLG		= NVL(@[act_inp_flg], ACT_INP_FLG)
WHERE   VSL_CD       = @[vsl_cd]
AND     SKD_VOY_NO   = @[skd_voy_no]
AND     SKD_DIR_CD   = @[skd_dir_cd]
AND     VPS_PORT_CD  = @[vps_port_cd]
AND     CLPT_IND_SEQ = @[clpt_ind_seq]			]]></sql>
			<params>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="vps_port_cd" type="12" value="" out="N"/>
				<param name="clpt_ind_seq" type="12" value="" out="N"/>
				<param name="yd_cd" type="12" value="" out="N"/>
				<param name="vps_eta_dt" type="12" value="" out="N"/>
				<param name="vps_etb_dt" type="12" value="" out="N"/>
				<param name="vps_etd_dt" type="12" value="" out="N"/>
				<param name="upd_usr_id" type="12" value="" out="N"/>
				<param name="act_inp_flg" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
