<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="VesselScheduleMgtDBDAOSearchCstSimDifferenceRSQL">
			<desc><![CDATA[DESC Enter..]]></desc>
			<sql><![CDATA[
SELECT	'Only Simulation data exists : (' || T.VSL_CD ||'/'|| T.SKD_VOY_NO ||'/'|| T.SKD_DIR_CD ||'/'|| T.VPS_PORT_CD ||'/'|| T.CLPT_IND_SEQ ||'/'|| T.CLPT_SEQ || ')' AS CHK_CST_SIM
FROM	VSK_SWAP_CST_PORT T
WHERE	1 = 1
AND		T.SIM_DT	= TO_DATE(@[sim_dt],'YYYY-MM-DD')
AND		T.SIM_NO	= LTRIM(TO_CHAR(TO_NUMBER(@[sim_no])))
AND		NOT EXISTS	( 	SELECT	'X'
						FROM	VSK_VSL_PORT_SKD S
						WHERE	T.VSL_CD		= S.VSL_CD
						AND		T.SKD_VOY_NO	= S.SKD_VOY_NO
						AND		T.SKD_DIR_CD	= S.SKD_DIR_CD
						AND		T.VPS_PORT_CD	= S.VPS_PORT_CD
						AND		T.CLPT_IND_SEQ	= S.CLPT_IND_SEQ
					)
UNION ALL

SELECT	'Only Coastal data exists : (' || T02.VSL_CD ||'/'|| T02.SKD_VOY_NO ||'/'|| T02.SKD_DIR_CD ||'/'|| T02.VPS_PORT_CD ||'/'|| T02.CLPT_IND_SEQ ||'/'|| T02.CLPT_SEQ || ')'
FROM	(
		SELECT	LAST_VALUE(RNK) OVER (ORDER BY ROWNUM ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)  AS LAST_ROW
				, T01.*
		FROM	(
				SELECT	DENSE_RANK() OVER (PARTITION BY T1.VSL_CD ORDER BY  N1ST_PORT_BRTH_DT) AS RNK
						, T1.SIM_DT, T1.SIM_NO, T2.VSL_CD, T2.SKD_VOY_NO, T2.SKD_DIR_CD, T2.VPS_PORT_CD, T2.CLPT_IND_SEQ, T2.CLPT_SEQ
						, T2.TURN_PORT_FLG, T2.TURN_PORT_IND_CD, T2.TURN_SKD_VOY_NO, T2.TURN_SKD_DIR_CD, T2.TURN_CLPT_IND_SEQ
				FROM	VSK_SWAP_CST_VVD T1, VSK_VSL_PORT_SKD T2
				WHERE	1 = 1
				AND		T1.SIM_DT		= TO_DATE(@[sim_dt],'YYYY-MM-DD')
				AND		T1.SIM_NO		= LTRIM(TO_CHAR(TO_NUMBER(@[sim_no])))
				AND		T1.VSL_CD		= T2.VSL_CD
				AND		T1.SKD_VOY_NO	= T2.SKD_VOY_NO
				AND		T1.SKD_DIR_CD	= T2.SKD_DIR_CD
				ORDER BY DENSE_RANK() OVER (PARTITION BY T1.VSL_CD ORDER BY  N1ST_PORT_BRTH_DT), T2.CLPT_SEQ
				) T01
		) T02
WHERE	1 = 
		CASE
		WHEN (LAST_ROW != RNK) AND NVL(TURN_PORT_IND_CD, ' ') IN ('N',      'Y') THEN 1 /* 마지막 VVD가 아니면서, 일반 PORT일 경우    : 조회 됨  */
		WHEN (LAST_ROW  = RNK) AND NVL(TURN_PORT_IND_CD, ' ') IN ('N',      'Y') THEN 1 /* 마지막 VVD가 이면서  , 일반 PORT일 경우    : 조회 됨  */
		WHEN (LAST_ROW  = RNK) AND NVL(TURN_PORT_IND_CD, ' ') IN ('D', 'V', 'F') THEN 1	/* 마지막 VVD가 이면서  , VIRTUAL PORT일 경우 : 조회 됨  */	
		ELSE 0 END																		/* 마지막 VVD가 아니면서, VIRTUAL PORT일 경우 : 조회 안됨*/
AND		NOT EXISTS	( 	SELECT	'X'
						FROM	VSK_SWAP_CST_PORT S
						WHERE	1	= 1
						AND		T02.SIM_DT			= S.SIM_DT
						AND		T02.SIM_NO			= S.SIM_NO
						AND		T02.VSL_CD			= S.VSL_CD
						AND		T02.SKD_VOY_NO		= S.SKD_VOY_NO
						AND		T02.SKD_DIR_CD		= S.SKD_DIR_CD
						AND		T02.VPS_PORT_CD		= S.VPS_PORT_CD
						AND		T02.CLPT_IND_SEQ	= S.CLPT_IND_SEQ
					)			]]></sql>
			<params>
				<param name="sim_dt" type="12" value="" out="N"/>
				<param name="sim_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
