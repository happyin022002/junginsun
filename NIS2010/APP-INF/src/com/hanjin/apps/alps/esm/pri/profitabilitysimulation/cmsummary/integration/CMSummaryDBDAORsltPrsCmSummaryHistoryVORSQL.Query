<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CMSummaryDBDAORsltPrsCmSummaryHistoryVORSQL">
			<desc><![CDATA[   ]]></desc>
			<sql><![CDATA[
WITH VW_SC_MAIN_NEW_SET AS (
	SELECT	HDR.SC_NO, MN.PROP_OFC_CD
		,(SELECT M_ORG.OFC_ENG_NM FROM MDM_ORGANIZATION M_ORG WHERE MN.PROP_OFC_CD = M_ORG.OFC_CD) AS PROP_OFC_NM--  AS PROP_OFC_NM -- REQUEST OFFICE
		, PTY.CUST_CNT_CD
		, PTY.CUST_SEQ
		, MN.PROP_NO
		, MN.AMDT_SEQ
		, DECODE(MN.AMDT_SEQ,0,MN.PROP_NO,HDR.SC_NO || '-' || TO_CHAR(MN.AMDT_SEQ,'FM000')) AS CONTRACT_NO
		, DUR.CTRT_EFF_DT, DUR.CTRT_EXP_DT
		, PTY.CTRT_PTY_NM -- CTRT_PTY_NM								-- CUSTOMER NAME
		, (
			CASE WHEN MQ.CNTR_LOD_UT_CD = 'F' AND @[frm_pfmc_unit] = 'TEU' THEN
			MQ.PROP_MQC_QTY * 2
			WHEN MQ.CNTR_LOD_UT_CD = 'T' AND @[frm_pfmc_unit] = 'FEU' THEN
			MQ.PROP_MQC_QTY /2
			ELSE MQ.PROP_MQC_QTY
			END
		) PROP_MQC_QTY  -- PROP_MQC_QTY								-- MQC( TARGET VVD )
		, SCP_MN.SVC_SCP_CD
		, CTP.PRC_CTRT_CUST_TP_CD AS CUST_TP_CD
		,MN.PROP_APRO_OFC_CD AS PROP_APRO_OFC_CD
		,MN.RESPB_SREP_CD AS RESPB_SREP_CD
		
	FROM	PRI_SP_MN MN
		, PRI_SP_HDR HDR
		, PRI_SP_CTRT_PTY PTY
		, PRI_SP_MQC MQ
		, PRI_SP_SCP_DUR DUR
		, PRI_SP_SCP_MN SCP_MN
		, PRI_SP_CTRT_CUST_TP CTP
	WHERE	MN.PROP_NO   = HDR.PROP_NO
		AND MN.PROP_NO = PTY.PROP_NO
		AND MN.AMDT_SEQ = PTY.AMDT_SEQ
		AND PTY.PRC_CTRT_PTY_TP_CD = 'C'
		AND MN.PROP_NO = MQ.PROP_NO
		AND MN.AMDT_SEQ = MQ.AMDT_SEQ
		AND MN.PROP_NO = DUR.PROP_NO
		AND MN.AMDT_SEQ = DUR.AMDT_SEQ
		AND MN.PROP_NO = SCP_MN.PROP_NO
		AND MN.AMDT_SEQ = SCP_MN.AMDT_SEQ
		AND MN.PROP_NO = CTP.PROP_NO
		AND MN.AMDT_SEQ = CTP.AMDT_SEQ
		AND CTP.PRC_CTRT_PTY_TP_CD = 'C'
		AND SCP_MN.SVC_SCP_CD = DUR.SVC_SCP_CD
	#if(${frm_contract_type} == 'B' || ${frm_contract_type} == 'S')
		AND 1=1
	#else
		AND 1=0
	#end
		  
	#if(${frm_customer_type} == 'B')
				AND CTP.PRC_CTRT_CUST_TP_CD IN ('I','A','O')
	#elseif(${frm_customer_type} == 'N')
				AND CTP.PRC_CTRT_CUST_TP_CD IN ('N')
	#else 
			AND CTP.PRC_CTRT_CUST_TP_CD IN ('I','A','O','N')
	#end

	#if(${frm_prop_ofc_cd} != '')
				AND MN.PROP_OFC_CD = @[frm_prop_ofc_cd]
	#end

	#if(${frm_prop_srep_cd} != '')
				AND MN.RESPB_SREP_CD = @[frm_prop_srep_cd]
	#end

	#if(${frm_prop_apro_ofc_cd} != '')
				AND MN.PROP_APRO_OFC_CD = @[frm_prop_apro_ofc_cd]
	#end



	#if(${frm_ctrt_eff_dt} != '' )
		AND DUR.CTRT_EFF_DT >= TO_DATE(@[frm_ctrt_eff_dt],'YYYY-MM-DD')
	#end
	#if ( ${frm_ctrt_exp_dt} != '' )
		AND DUR.CTRT_EXP_DT  <= TO_DATE(@[frm_ctrt_exp_dt],'YYYY-MM-DD') 
	#end

	#if(${frm_svc_scp_cd} != '' )
				AND SCP_MN.SVC_SCP_CD = @[frm_svc_scp_cd]
	#end
			-- STATUS
	#if (${frm_status} == 'Q') 
				AND  MN.PROP_STS_CD IN ( 'I', 'Q', 'R' ) /* REQUESTED */
	#elseif(${frm_status} == 'A') 
				AND  MN.PROP_STS_CD IN ( 'A' ,'F') /* APPROVED */
	#end


	#if( $cust_list.size() != 0 ) 
		AND (PTY.CUST_CNT_CD , PTY.CUST_SEQ) IN (
		#foreach( ${key} in ${cust_list}) 
			#if($velocityCount != 1 ) 
				UNION ALL
			#end
			SELECT 
					substr('$key',1,2),substr('$key',3)
			FROM DUAL
		#end
		)
	#end 


)
,
VW_RFA_MAIN_NEW_SET AS (
	SELECT	/*+ USE_HASH(MN HDR DUR SCP_MN M_ORG CUST ) */  MN.PROP_OFC_CD
		,(SELECT M_ORG.OFC_ENG_NM FROM MDM_ORGANIZATION M_ORG WHERE MN.PROP_OFC_CD = M_ORG.OFC_CD) AS PROP_OFC_NM
		, MN.CTRT_CUST_CNT_CD AS CUST_CNT_CD
		, MN.CTRT_CUST_SEQ AS CUST_SEQ
		, MN.PROP_NO
		, MN.AMDT_SEQ
		, DUR.CTRT_EFF_DT, DUR.CTRT_EXP_DT
		, DECODE(MN.AMDT_SEQ,0,MN.PROP_NO,HDR.RFA_NO || '-' || TO_CHAR(MN.AMDT_SEQ,'FM000')) AS CONTRACT_NO


		,(SELECT CUST.CUST_LGL_ENG_NM
		  FROM MDM_CUSTOMER CUST
		  WHERE CUST_CNT_CD = MN.CTRT_CUST_CNT_CD
			 AND CUST.CUST_SEQ = MN.CTRT_CUST_SEQ ) AS CTRT_PTY_NM




		, (
			CASE WHEN MN.CNTR_LOD_UT_CD = 'F' AND @[frm_pfmc_unit] = 'TEU' THEN
			MN.TGT_MVC_QTY * 2
			WHEN MN.CNTR_LOD_UT_CD = 'T' AND @[frm_pfmc_unit] = 'FEU' THEN
			MN.TGT_MVC_QTY /2
			ELSE MN.TGT_MVC_QTY
			END
		) PROP_MQC_QTY  -- PROP_MQC_QTY								-- MQC( TARGET VVD )
		, SCP_MN.SVC_SCP_CD
		, MN.PRC_CTRT_CUST_TP_CD AS CUST_TP_CD
		,MN.PROP_APRO_OFC_CD AS PROP_APRO_OFC_CD
		,MN.RESPB_SREP_CD AS RESPB_SREP_CD
                ,HDR.RFA_NO
	FROM	PRI_RP_MN MN
		, PRI_RP_HDR HDR
		, PRI_RP_SCP_DUR DUR
		, PRI_RP_SCP_MN SCP_MN
	WHERE	MN.PROP_NO   = HDR.PROP_NO
		AND MN.AMDT_SEQ = 0
		AND MN.PROP_NO = DUR.PROP_NO
		AND MN.AMDT_SEQ = DUR.AMDT_SEQ
		AND MN.PROP_NO = SCP_MN.PROP_NO
		AND MN.AMDT_SEQ = SCP_MN.AMDT_SEQ
		AND SCP_MN.SVC_SCP_CD = DUR.SVC_SCP_CD
	#if(${frm_contract_type} == 'B' || ${frm_contract_type} == 'R')
		AND 1=1
	#else
		AND 1=0
	#end
	#if(${frm_customer_type} == 'B')
				AND MN.PRC_CTRT_CUST_TP_CD IN ('I','A','O')
	#elseif(${frm_customer_type} == 'N')
				AND MN.PRC_CTRT_CUST_TP_CD IN ('N')
	#else 
			AND MN.PRC_CTRT_CUST_TP_CD IN ('I','A','O','N')
	#end

	#if(${frm_prop_ofc_cd} != '')
				AND MN.PROP_OFC_CD = @[frm_prop_ofc_cd]
	#end

	#if(${frm_prop_srep_cd} != '')
				AND MN.RESPB_SREP_CD = @[frm_prop_srep_cd]
	#end

	#if(${frm_prop_apro_ofc_cd} != '')
				AND MN.PROP_APRO_OFC_CD = @[frm_prop_apro_ofc_cd]
	#end



	#if(${frm_ctrt_eff_dt} != '' )
		AND DUR.CTRT_EFF_DT >= TO_DATE(@[frm_ctrt_eff_dt],'YYYY-MM-DD')
	#end
	#if ( ${frm_ctrt_exp_dt} != '' )
		AND DUR.CTRT_EXP_DT  <= TO_DATE(@[frm_ctrt_exp_dt],'YYYY-MM-DD') 
	#end

	#if(${frm_svc_scp_cd} != '' )
				AND SCP_MN.SVC_SCP_CD = @[frm_svc_scp_cd]
				AND DUR.SVC_SCP_CD = @[frm_svc_scp_cd]
	#end
			-- STATUS
	#if (${frm_status} == 'Q') 
				AND  MN.PROP_STS_CD IN ( 'I', 'Q', 'R' ) /* REQUESTED */
	#elseif(${frm_status} == 'A') 
				AND  MN.PROP_STS_CD IN ( 'A' ) /* APPROVED */
	#end


	#if( $cust_list.size() != 0 ) 
		AND (MN.CTRT_CUST_CNT_CD ,MN.CTRT_CUST_SEQ) IN (
		#foreach( ${key} in ${cust_list}) 
			#if($velocityCount != 1 ) 
				UNION ALL
			#end
			SELECT 
					substr('$key',1,2),substr('$key',3)
			FROM DUAL
		#end
		)
	#end 


)
SELECT SC_NO
	, CONTRACT_NM
	, CONTRACT_BASIS
	, SORT_KEY
	, PROP_OFC_NM
	, PROP_NO
	, AMDT_SEQ
	, CONTRACT_NO
	, CUST_CNT_CD || TO_CHAR(CUST_SEQ,'FM000000') || ' - ' || CTRT_PTY_NM AS CUST_NM
	, CUST_CNT_CD
	, CUST_SEQ
	, TO_CHAR(CTRT_EFF_DT,'YYYY-MM-DD') || '~' || TO_CHAR( CTRT_EXP_DT,'YYYY-MM-DD') AS DURATION
	, CTRT_PTY_NM
	, PROP_MQC_QTY	 
	, LOAD          
	, CM_OFFICE	 
	, CM_TRADE 
	, OP 
	, CMPB_OFFICE 
	, CMPB_TRADE	 
	, OPB	
	, dense_rank() over(  order by  CONTRACT_NM DESC,PROP_NO  ) as seq
	, (
		SELECT INTG_CD_VAL_DP_DESC 
		FROM COM_INTG_CD_DTL  
		WHERE INTG_CD_ID = 'CD01714'
			AND INTG_CD_VAL_CTNT = CUST_TP_CD
	  ) AS CUST_TP_CD         
	, SUBSTR(REPLACE(MAX(TO_CHAR(AMDT_SEQ,'FM000') || RESPB_SREP_CD) OVER ( PARTITION BY PROP_NO   ),'-',''),4) AS RESPB_SREP_CD     
	, SUBSTR(REPLACE(MAX(TO_CHAR(AMDT_SEQ,'FM000') || PROP_APRO_OFC_CD) OVER ( PARTITION BY PROP_NO   ),'-',''),4) AS PROP_APRO_OFC_CD
	, SUBSTR(REPLACE(MAX(TO_CHAR(AMDT_SEQ,'FM000') || PROP_OFC_CD) OVER ( PARTITION BY PROP_NO   ),'-',''),4) AS PROP_OFC_CD
FROM (	
	SELECT SC_NO
		, 'SC' AS CONTRACT_NM
		, DECODE(AMDT_SEQ,0,'Proposal','Amendment') AS CONTRACT_BASIS
		, DECODE(AMDT_SEQ,0,2,3) AS SORT_KEY
		, PROP_OFC_CD
		, PROP_OFC_NM
		, PROP_NO
		, AMDT_SEQ
		, CONTRACT_NO
		, CUST_CNT_CD
		, CUST_SEQ
		, CTRT_EFF_DT
		, CTRT_EXP_DT
		, CTRT_PTY_NM	 
		, PROP_MQC_QTY	 
		, LOAD          
		, CM_OFFICE	 
		, CM_TRADE 
		, OP 
		, CMPB_OFFICE 
		, CMPB_TRADE	 
		, OPB	 
		, CUST_TP_CD           
		, PROP_APRO_OFC_CD
		, RESPB_SREP_CD   
	FROM (
                SELECT	SC_NO
                        , PROP_OFC_CD
                        , PROP_OFC_NM
                        , PROP_NO
                        , AMDT_SEQ
                        , CONTRACT_NO
                        , CUST_CNT_CD
                        , CUST_SEQ
                        , CTRT_EFF_DT
                        , CTRT_EXP_DT
                        , CTRT_PTY_NM						-- CUSTOMER NAME
                        , CUST_TP_CD           
                        , PROP_APRO_OFC_CD
                        , RESPB_SREP_CD      
                        , PROP_MQC_QTY						-- MQC( TARGET VVD )
                        , DECODE(AMDT_SEQ,0,LOAD,AMDT_LOAD) AS LOAD              -- LOAD(NEW)
                        , DECODE(AMDT_SEQ,0,CM_OFFICE,AMDT_CM_OFFICE) AS CM_OFFICE	-- OFFICE PROPIT/CM
                        , DECODE(AMDT_SEQ,0,CM_TRADE,AMDT_CM_TRADE) AS CM_TRADE	-- TRADE PROPIT/CM
                        , DECODE(AMDT_SEQ,0,OP,AMDT_OP) AS OP	-- OP(NEW)
                        , DECODE(AMDT_SEQ,0,CMPB_OFFICE,AMDT_CMPB_OFFICE) AS CMPB_OFFICE	-- OFFICE PROPIT/CMPB
                        , DECODE(AMDT_SEQ,0,CMPB_TRADE,AMDT_CMPB_TRADE) AS CMPB_TRADE	-- TRADE PROPIT/CMPB
                        , DECODE(AMDT_SEQ,0,OPB,AMDT_OPB) AS OPB	-- OPB(NEW)
                FROM (
                        SELECT
                                SC_NO
                                , PROP_OFC_CD
                                , MAX(PROP_OFC_NM) AS PROP_OFC_NM -- REQUEST OFFICE
                                , PROP_NO
                                , AMDT_SEQ
                                , CONTRACT_NO
                                , CUST_CNT_CD
                                , CUST_SEQ
                                , CTRT_EFF_DT, CTRT_EXP_DT
                                , MAX(CTRT_PTY_NM) AS CTRT_PTY_NM								-- CUSTOMER NAME
                                , MAX(PROP_MQC_QTY) AS PROP_MQC_QTY								-- MQC( TARGET VVD )
                                , MAX(CUST_TP_CD  ) AS CUST_TP_CD
                                , MAX(PROP_APRO_OFC_CD ) AS PROP_APRO_OFC_CD
                                , MAX(RESPB_SREP_CD ) AS RESPB_SREP_CD

                                , SUM(PRS_ESTM_LOD_QTY) AS LOAD-- LOAD(NEW)
                                , SUM(ESTM_RESPB_CM_AMT) AS CM_OFFICE	   -- Office Profit -- CM(NEW)
                                , SUM(ESTM_PFIT_CM_AMT) AS CM_TRADE	   -- Trade Profit -- CM(NEW)
                                , SUM(ESTM_RESPB_OP_AMT) AS OP	    --OP(NEW)
                                , DECODE( SUM(PRS_ESTM_LOD_QTY), 0 , 0, SUM(ESTM_RESPB_CM_AMT) / SUM(PRS_ESTM_LOD_QTY)) AS CMPB_OFFICE	-- OFFICE PROPIT/CMPB
                                , DECODE( SUM(PRS_ESTM_LOD_QTY), 0 , 0, SUM(ESTM_PFIT_CM_AMT) /  SUM(PRS_ESTM_LOD_QTY)) AS CMPB_TRADE	-- TRADE PROPIT/CM
                                , DECODE( SUM(PRS_ESTM_LOD_QTY), 0 , 0, SUM(ESTM_RESPB_OP_AMT) / SUM(PRS_ESTM_LOD_QTY)) AS OPB	 --OPB(NEW)
                                , SUM(PRS_AMDT_LOD_QTY) AS AMDT_LOAD-- LOAD(NEW)
                                , SUM(AMDT_RESPB_CM_AMT) AS AMDT_CM_OFFICE	   -- Office Profit -- CM(NEW)
                                , SUM(AMDT_PFIT_CM_AMT) AS AMDT_CM_TRADE	   -- Trade Profit -- CM(NEW)
                                , SUM(AMDT_RESPB_OP_AMT) AS AMDT_OP	    --OP(NEW)
                                , DECODE( SUM(AMDT_RESPB_OP_AMT), 0 ,0, SUM(AMDT_RESPB_CM_AMT) / SUM(PRS_AMDT_LOD_QTY)) AS AMDT_CMPB_OFFICE	-- OFFICE PROPIT/CMPB
                                , DECODE( SUM(AMDT_RESPB_OP_AMT), 0 ,0, SUM(AMDT_PFIT_CM_AMT) / SUM(PRS_AMDT_LOD_QTY)) AS AMDT_CMPB_TRADE	-- TRADE PROPIT/CM
                                , DECODE( SUM(AMDT_RESPB_OP_AMT), 0 ,0, SUM(AMDT_RESPB_OP_AMT) / SUM(PRS_AMDT_LOD_QTY)) AS AMDT_OPB	 --OPB(NEW)


                        FROM (
                                SELECT 
                                          MN_SET.SC_NO
                                        , MN_SET.PROP_OFC_CD
                                        , MN_SET.PROP_OFC_NM --  AS PROP_OFC_NM -- REQUEST OFFICE
                                        , MN_SET.CUST_CNT_CD
                                        , MN_SET.CUST_SEQ
                                        , MN_SET.PROP_NO
                                        , MN_SET.AMDT_SEQ
                                        , MN_SET.CONTRACT_NO
                                        , MN_SET.CTRT_EFF_DT
                                        , MN_SET.CTRT_EXP_DT
                                        , MN_SET.CTRT_PTY_NM -- CUSTOMER NAME
                                        , MN_SET.CUST_TP_CD  
                                        , MN_SET.PROP_APRO_OFC_CD 
                                        , MN_SET.RESPB_SREP_CD 
                                        , MN_SET.PROP_MQC_QTY  -- PROP_MQC_QTY								-- MQC( TARGET VVD )
                                        , MN.PRS_ESTM_LOD_QTY -- LOAD(NEW)
                                        , MN.ESTM_RESPB_CM_AMT  -- AS CM_NEW_OFFICE
                                        , MN.ESTM_PFIT_CM_AMT    --  CM_NEW_OP_TRADE
                                        , MN.ESTM_RESPB_OP_AMT    --  CM_NEW_OP_TRADE
                                        , MN.PRS_AMDT_LOD_QTY
                                        , MN.AMDT_RESPB_CM_AMT  -- AS CM_NEW_OFFICE
                                        , MN.AMDT_PFIT_CM_AMT    --  CM_NEW_OP_TRADE
                                        , MN.AMDT_RESPB_OP_AMT    --  CM_NEW_OP_TRADE
                                FROM VW_SC_MAIN_NEW_SET MN_SET
                                     , (
                                        SELECT	MN.SC_NO
                                                , MN.PROP_OFC_CD
                                                , MN.PROP_OFC_NM --  AS PROP_OFC_NM -- REQUEST OFFICE
                                                , MN.CUST_CNT_CD
                                                , MN.CUST_SEQ
                                                , MN.PROP_NO
                                                , MN.AMDT_SEQ
                                                , MN.SVC_SCP_CD
                                                , MN.CONTRACT_NO
                                                , MN.CTRT_EFF_DT, MN.CTRT_EXP_DT
                                                , MN.CTRT_PTY_NM -- CUSTOMER NAME
                                                , MN.CUST_TP_CD  
                                                , MN.PROP_APRO_OFC_CD 
                                                , MN.RESPB_SREP_CD 
                                                , MN.PROP_MQC_QTY  -- PROP_MQC_QTY								-- MQC( TARGET VVD )
                                                , CMDT_ROUT.PRS_ESTM_LOD_QTY  / DECODE(@[frm_pfmc_unit],'FEU',2,'TEU',1) AS PRS_ESTM_LOD_QTY -- LOAD(NEW)
                                                , CASE WHEN SUBSTR(CMDT_ROUT.PRS_RAT_UT_CD,2,1) = '2' OR SUBSTR(CMDT_ROUT.PRS_RAT_UT_CD,1,1) = '2'
                                                        THEN CMDT_ROUT.PRS_ESTM_LOD_QTY * CMDT_ROUT.PRS_ESTM_RESPB_CMPB_AMT
                                                        ELSE
                                                        CMDT_ROUT.PRS_ESTM_LOD_QTY * CMDT_ROUT.PRS_ESTM_RESPB_CMPB_AMT  / 2
                                                END  AS ESTM_RESPB_CM_AMT  -- AS CM_NEW_OFFICE
                                                , CASE WHEN SUBSTR(CMDT_ROUT.PRS_RAT_UT_CD,2,1) = '2' OR SUBSTR(CMDT_ROUT.PRS_RAT_UT_CD,1,1) = '2'
                                                        THEN CMDT_ROUT.PRS_ESTM_LOD_QTY * CMDT_ROUT.PRS_ESTM_PFIT_CMPB_AMT
                                                        ELSE
                                                        CMDT_ROUT.PRS_ESTM_LOD_QTY * CMDT_ROUT.PRS_ESTM_PFIT_CMPB_AMT  / 2
                                                END  AS ESTM_PFIT_CM_AMT    --  CM_NEW_OP_TRADE
                                                , CASE WHEN SUBSTR(CMDT_ROUT.PRS_RAT_UT_CD,2,1) = '2' OR SUBSTR(CMDT_ROUT.PRS_RAT_UT_CD,1,1) = '2'
                                                        THEN CMDT_ROUT.PRS_ESTM_LOD_QTY * CMDT_ROUT.PRS_ESTM_RESPB_OPB_AMT
                                                        ELSE
                                                        CMDT_ROUT.PRS_ESTM_LOD_QTY * CMDT_ROUT.PRS_ESTM_RESPB_OPB_AMT  / 2
                                                END  AS ESTM_RESPB_OP_AMT    --  CM_NEW_OP_TRADE

                                                , (CMDT_ROUT.PRS_RMN_LOD_QTY+CMDT_ROUT.PRS_CRNT_LOD_QTY)  / DECODE(@[frm_pfmc_unit],'FEU',2,'TEU',1) AS PRS_AMDT_LOD_QTY -- LOAD(NEW)
                                                , (CMDT_ROUT.PRS_RMN_LOD_QTY * CMDT_ROUT.PRS_RMN_RESPB_CMPB_AMT +  CMDT_ROUT.PRS_CRNT_LOD_QTY * CMDT_ROUT.PRS_CRNT_RESPB_CMPB_AMT)  AS AMDT_RESPB_CM_AMT  -- AS CM_NEW_OFFICE
                                                , (CMDT_ROUT.PRS_RMN_LOD_QTY * CMDT_ROUT.PRS_RMN_PFIT_CMPB_AMT + CMDT_ROUT.PRS_CRNT_LOD_QTY * CMDT_ROUT.PRS_CRNT_PFIT_CMPB_AMT) AS AMDT_PFIT_CM_AMT    --  CM_NEW_OP_TRADE
                                                , (CMDT_ROUT.PRS_RMN_LOD_QTY * CMDT_ROUT.PRS_CRNT_RESPB_OPB_AMT + CMDT_ROUT.PRS_CRNT_LOD_QTY * CMDT_ROUT.PRS_CRNT_RESPB_OPB_AMT) AS AMDT_RESPB_OP_AMT    --  CM_NEW_OP_TRADE

                                        FROM	VW_SC_MAIN_NEW_SET MN
                                                , PRI_SP_SCP_RT_CMDT_ROUT CMDT_ROUT
                                        WHERE	 MN.PROP_NO = CMDT_ROUT.PROP_NO
                                                AND MN.AMDT_SEQ = CMDT_ROUT.AMDT_SEQ
                                                AND MN.SVC_SCP_CD = CMDT_ROUT.SVC_SCP_CD
                                                #if(${frm_contract_type} == 'B' || ${frm_contract_type} == 'S')
                                                        AND 1=1
                                                #else
                                                        AND 1=0
                                                #end
                                                -- BY CARGO TYPE
                                                #if (${crg_tp_str} != '' )
                                                        AND CMDT_ROUT.PRS_CGO_TP_CD IN ( ${crg_tp_str} )
                                                #end
                                    ) MN
                                WHERE MN_SET.PROP_NO = MN.PROP_NO(+)
                                     AND  MN_SET.AMDT_SEQ = MN.AMDT_SEQ(+)
                                     AND  MN_SET.SVC_SCP_CD = MN.SVC_SCP_CD(+)
                        )
                        GROUP BY SC_NO,PROP_OFC_CD,CUST_CNT_CD,CUST_SEQ, PROP_NO, AMDT_SEQ, CTRT_EFF_DT, CTRT_EXP_DT,CONTRACT_NO
                )
        )  
	UNION ALL 
	SELECT SC_NO
		, 'SC' AS CONTRACT_NM
		, 'Quotation' AS CONTRACT_BASIS
		, 1 AS SORT_KEY
		, PROP_OFC_CD
		, PROP_OFC_NM
		, PROP_NO
		, -1 AS AMDT_SEQ
		, CONTRACT_NO
		, CUST_CNT_CD
		, CUST_SEQ
		, EFF_DT
		, EXP_DT
		, CTRT_PTY_NM	 
		, PROP_MQC_QTY	 
		, LOAD          
		, CM_OFFICE	 
		, CM_TRADE 
		, OP 
		, CMPB_OFFICE 
		, CMPB_TRADE	 
		, OPB	 
		, CUST_TP_CD           
		, PROP_APRO_OFC_CD
		, RESPB_SREP_CD      
	FROM (
                SELECT
                        SC_NO
                        , PROP_OFC_CD
                        , MAX(PROP_OFC_NM) AS PROP_OFC_NM -- REQUEST OFFICE
                        , PROP_NO
                        , AMDT_SEQ
                        , CONTRACT_NO
                        , CUST_CNT_CD
                        , CUST_SEQ
                        , EFF_DT, EXP_DT
                        , MAX(CTRT_PTY_NM) AS CTRT_PTY_NM								-- CUSTOMER NAME
                        , MAX(ESTM_MQC_QTY) AS PROP_MQC_QTY								-- MQC( TARGET VVD )
                        , MAX(CUST_TP_CD ) AS CUST_TP_CD
                        , MAX(PROP_APRO_OFC_CD) AS PROP_APRO_OFC_CD
                        , MAX(QTTN_SREP_CD ) AS RESPB_SREP_CD

                        , SUM(PRS_ESTM_LOD_QTY) AS LOAD-- LOAD(NEW)
                        , SUM(ESTM_RESPB_CM_AMT) AS CM_OFFICE	   -- Office Profit -- CM(NEW)
                        , SUM(ESTM_PFIT_CM_AMT) AS CM_TRADE	   -- Trade Profit -- CM(NEW)
                        , SUM(ESTM_RESPB_OP_AMT) AS OP	    --OP(NEW)
                        , DECODE(SUM(PRS_ESTM_LOD_QTY),0,0,SUM(ESTM_RESPB_CM_AMT) / SUM(PRS_ESTM_LOD_QTY)) AS CMPB_OFFICE	-- OFFICE PROPIT/CMPB
                        , DECODE(SUM(PRS_ESTM_LOD_QTY),0,0,SUM(ESTM_PFIT_CM_AMT) / SUM(PRS_ESTM_LOD_QTY)) AS CMPB_TRADE	-- TRADE PROPIT/CM
                        , DECODE(SUM(PRS_ESTM_LOD_QTY),0,0,SUM(ESTM_RESPB_OP_AMT) / SUM(PRS_ESTM_LOD_QTY)) AS OPB	 --OPB(NEW)
                FROM (
                        SELECT SC_SET.SC_NO
                                , HDR.QTTN_OFC_CD AS PROP_OFC_CD
				,(SELECT M_ORG.OFC_ENG_NM FROM MDM_ORGANIZATION M_ORG WHERE HDR.QTTN_OFC_CD = M_ORG.OFC_CD) AS PROP_OFC_NM -- REQUEST OFFICE
                                , MN.CUST_CNT_CD
                                , MN.CUST_SEQ
                                , MN.PROP_NO
                                , -1 AS AMDT_SEQ
                                , MN.QTTN_NO || MN.QTTN_VER_NO AS CONTRACT_NO
                                , MN.EFF_DT, MN.EXP_DT
                                ,(  SELECT CUST.CUST_LGL_ENG_NM
                                    FROM MDM_CUSTOMER CUST
                                    WHERE MN.CUST_CNT_CD = CUST.CUST_CNT_CD
                                       AND MN.CUST_SEQ = CUST.CUST_SEQ ) AS CTRT_PTY_NM
                                , (
                                        CASE WHEN MN.CNTR_LOD_UT_CD = 'F' AND @[frm_pfmc_unit] = 'TEU' THEN
                                                MN.ESTM_MQC_QTY * 2
                                        WHEN MN.CNTR_LOD_UT_CD = 'T' AND @[frm_pfmc_unit] = 'FEU' THEN
                                                MN.ESTM_MQC_QTY /2
                                        ELSE MN.ESTM_MQC_QTY
                                        END
                                ) ESTM_MQC_QTY  -- PROP_MQC_QTY								-- MQC( TARGET VVD )
                                , MN.SVC_SCP_CD
                                , ( MN.PRC_CUST_TP_CD) AS CUST_TP_CD
                                ,'' AS PROP_APRO_OFC_CD
                                ,(MN.QTTN_SREP_CD) AS QTTN_SREP_CD

                                ---
                                , MN_DT.PRS_ESTM_LOD_QTY -- LOAD(NEW)
                                , MN_DT.ESTM_RESPB_CM_AMT  -- AS CM_NEW_OFFICE
                                , MN_DT.ESTM_PFIT_CM_AMT    --  CM_NEW_OP_TRADE
                                , MN_DT.ESTM_RESPB_OP_AMT    --  CM_NEW_OP_TRADE
                        FROM PRI_SQ_MN MN
                             , PRI_SQ_HDR HDR
                             , ( SELECT DISTINCT PROP_NO,SC_NO FROM VW_SC_MAIN_NEW_SET ) SC_SET
                             , (
                                SELECT	SC_SET.SC_NO, MN.QTTN_NO, MN.QTTN_VER_NO
                                        , CMDT_ROUT.PRS_ESTM_LOD_QTY  / DECODE(@[frm_pfmc_unit],'FEU',2,'TEU',1) AS PRS_ESTM_LOD_QTY -- LOAD(NEW)
                                        , CASE WHEN SUBSTR(CMDT_ROUT.PRS_RAT_UT_CD,2,1) = '2' OR SUBSTR(CMDT_ROUT.PRS_RAT_UT_CD,1,1) = '2'
                                                THEN CMDT_ROUT.PRS_ESTM_LOD_QTY * CMDT_ROUT.PRS_ESTM_RESPB_CMPB_AMT
                                                ELSE
                                                CMDT_ROUT.PRS_ESTM_LOD_QTY * CMDT_ROUT.PRS_ESTM_RESPB_CMPB_AMT  / 2
                                        END  AS ESTM_RESPB_CM_AMT  -- AS CM_NEW_OFFICE
                                        , CASE WHEN SUBSTR(CMDT_ROUT.PRS_RAT_UT_CD,2,1) = '2' OR SUBSTR(CMDT_ROUT.PRS_RAT_UT_CD,1,1) = '2'
                                                THEN CMDT_ROUT.PRS_ESTM_LOD_QTY * CMDT_ROUT.PRS_ESTM_PFIT_CMPB_AMT
                                                ELSE
                                                CMDT_ROUT.PRS_ESTM_LOD_QTY * CMDT_ROUT.PRS_ESTM_PFIT_CMPB_AMT  / 2
                                        END  AS ESTM_PFIT_CM_AMT    --  CM_NEW_OP_TRADE
                                        , CASE WHEN SUBSTR(CMDT_ROUT.PRS_RAT_UT_CD,2,1) = '2' OR SUBSTR(CMDT_ROUT.PRS_RAT_UT_CD,1,1) = '2'
                                                THEN CMDT_ROUT.PRS_ESTM_LOD_QTY * CMDT_ROUT.PRS_ESTM_RESPB_OPB_AMT
                                                ELSE
                                                CMDT_ROUT.PRS_ESTM_LOD_QTY * CMDT_ROUT.PRS_ESTM_RESPB_OPB_AMT  / 2
                                        END  AS ESTM_RESPB_OP_AMT    --  CM_NEW_OP_TRADE
                                FROM	PRI_SQ_MN MN
                                        ,( SELECT DISTINCT PROP_NO,SC_NO FROM VW_SC_MAIN_NEW_SET ) SC_SET
                                        , PRI_SQ_RT_CMDT_ROUT CMDT_ROUT
                                WHERE	
                                          MN.PROP_NO = SC_SET.PROP_NO
                                        AND MN.SVC_SCP_CD = @[frm_svc_scp_cd]

                                        AND MN.QTTN_NO = CMDT_ROUT.QTTN_NO
                                        AND MN.QTTN_VER_NO = CMDT_ROUT.QTTN_VER_NO
                                        #if(${frm_contract_type} == 'B' || ${frm_contract_type} == 'S')
                                                AND 1=1
                                        #else
                                                AND 1=0
                                        #end
                                        -- BY CARGO TYPE
                                        #if (${crg_tp_str} != '' )
                                             AND CMDT_ROUT.PRS_CGO_TP_CD IN ( ${crg_tp_str} )
                                        #end
                            ) MN_DT
                        WHERE  MN.PROP_NO = SC_SET.PROP_NO
                               AND MN.QTTN_NO   = HDR.QTTN_NO
                               AND MN.QTTN_NO = MN_DT.QTTN_NO(+)
                               AND MN.QTTN_VER_NO = MN_DT.QTTN_VER_NO(+)
                )
                GROUP BY SC_NO,PROP_OFC_CD,CUST_CNT_CD,CUST_SEQ, PROP_NO, AMDT_SEQ, EFF_DT, EXP_DT,CONTRACT_NO
        )  
        ----------------------------------------------------------------------------------------------------------------------------------
        -- RFA 시작
        ----------------------------------------------------------------------------------------------------------------------------------
        UNION ALL
	SELECT RFA_NO
		, 'RFA' AS CONTRACT_NM
		, DECODE(AMDT_SEQ,0,'Proposal','Amendment') AS CONTRACT_BASIS
		, DECODE(AMDT_SEQ,0,2,3) AS SORT_KEY
		, PROP_OFC_CD
		, PROP_OFC_NM
		, PROP_NO
		, AMDT_SEQ
		, CONTRACT_NO
		, CUST_CNT_CD
		, CUST_SEQ
		, CTRT_EFF_DT
		, CTRT_EXP_DT
		, CTRT_PTY_NM	 
		, PROP_MQC_QTY	 
		, LOAD          
		, CM_OFFICE	 
		, CM_TRADE 
		, OP 
		, CMPB_OFFICE 
		, CMPB_TRADE	 
		, OPB	 
		, CUST_TP_CD           
		, PROP_APRO_OFC_CD
		, RESPB_SREP_CD   
	FROM (
		 SELECT
			PROP_OFC_CD
			, MAX(PROP_OFC_NM) AS PROP_OFC_NM -- REQUEST OFFICE
			, PROP_NO
			, AMDT_SEQ
			, CUST_CNT_CD
			, CUST_SEQ
			, CTRT_EFF_DT, CTRT_EXP_DT
			, MAX(CTRT_PTY_NM) AS CTRT_PTY_NM								-- CUSTOMER NAME
			, MAX(PROP_MQC_QTY) AS PROP_MQC_QTY								-- MQC( TARGET VVD )


                        , SUM(PRS_ESTM_LOD_QTY) AS LOAD-- LOAD(NEW)
                        , SUM(ESTM_RESPB_CM_AMT) AS CM_OFFICE	   -- Office Profit -- CM(NEW)
                        , SUM(ESTM_PFIT_CM_AMT) AS CM_TRADE	   -- Trade Profit -- CM(NEW)
                        , SUM(ESTM_RESPB_OP_AMT) AS OP	    --OP(NEW)
                        , DECODE( SUM(PRS_ESTM_LOD_QTY), 0 , 0, SUM(ESTM_RESPB_CM_AMT) / SUM(PRS_ESTM_LOD_QTY)) AS CMPB_OFFICE	-- OFFICE PROPIT/CMPB
                        , DECODE( SUM(PRS_ESTM_LOD_QTY), 0 , 0, SUM(ESTM_PFIT_CM_AMT) /  SUM(PRS_ESTM_LOD_QTY)) AS CMPB_TRADE	-- TRADE PROPIT/CM
                        , DECODE( SUM(PRS_ESTM_LOD_QTY), 0 , 0, SUM(ESTM_RESPB_OP_AMT) / SUM(PRS_ESTM_LOD_QTY)) AS OPB	 --OPB(NEW)
                        , SUM(PRS_AMDT_LOD_QTY) AS AMDT_LOAD-- LOAD(NEW)
                        , SUM(AMDT_RESPB_CM_AMT) AS AMDT_CM_OFFICE	   -- Office Profit -- CM(NEW)
                        , SUM(AMDT_PFIT_CM_AMT) AS AMDT_CM_TRADE	   -- Trade Profit -- CM(NEW)
                        , SUM(AMDT_RESPB_OP_AMT) AS AMDT_OP	    --OP(NEW)
                        , DECODE( SUM(AMDT_RESPB_OP_AMT), 0 ,0, SUM(AMDT_RESPB_CM_AMT) / SUM(PRS_AMDT_LOD_QTY)) AS AMDT_CMPB_OFFICE	-- OFFICE PROPIT/CMPB
                        , DECODE( SUM(AMDT_RESPB_OP_AMT), 0 ,0, SUM(AMDT_PFIT_CM_AMT) / SUM(PRS_AMDT_LOD_QTY)) AS AMDT_CMPB_TRADE	-- TRADE PROPIT/CM
                        , DECODE( SUM(AMDT_RESPB_OP_AMT), 0 ,0, SUM(AMDT_RESPB_OP_AMT) / SUM(PRS_AMDT_LOD_QTY)) AS AMDT_OPB	 --OPB(NEW)

                        , CONTRACT_NO
                         , MAX(CUST_TP_CD ) AS CUST_TP_CD
                        , MAX(PROP_APRO_OFC_CD ) AS PROP_APRO_OFC_CD
                        , MAX(RESPB_SREP_CD ) AS RESPB_SREP_CD
						, RFA_NO
		FROM (
                        SELECT MN_SET.PROP_OFC_CD
                                , MN_SET.PROP_OFC_NM --  AS PROP_OFC_NM -- REQUEST OFFICE
                                , MN_SET.CUST_CNT_CD
                                , MN_SET.CUST_SEQ
                                , MN_SET.PROP_NO
                                , MN_SET.AMDT_SEQ
                                , MN_SET.CTRT_EFF_DT, MN.CTRT_EXP_DT
                                , MN_SET.CTRT_PTY_NM -- CTRT_PTY_NM								-- CUSTOMER NAME
                                , MN_SET.PROP_MQC_QTY  -- PROP_MQC_QTY								-- MQC( TARGET VVD )
                                , MN_SET.CONTRACT_NO
                                , MN_SET.CUST_TP_CD
                                , MN_SET.PROP_APRO_OFC_CD
                                , MN_SET.RESPB_SREP_CD
                                , MN_SET.RFA_NO
                                , MN_SET.SVC_SCP_CD
                                , MN.PRS_ESTM_LOD_QTY -- LOAD(NEW)
                                , MN.ESTM_RESPB_CM_AMT  -- AS CM_NEW_OFFICE
                                , MN.ESTM_PFIT_CM_AMT    --  CM_NEW_OP_TRADE
                                , MN.ESTM_RESPB_OP_AMT    --  CM_NEW_OP_TRADE
                                , MN.PRS_AMDT_LOD_QTY
                                , MN.AMDT_RESPB_CM_AMT  -- AS CM_NEW_OFFICE
                                , MN.AMDT_PFIT_CM_AMT    --  CM_NEW_OP_TRADE
                                , MN.AMDT_RESPB_OP_AMT    --  CM_NEW_OP_TRADE
                        FROM VW_RFA_MAIN_NEW_SET MN_SET
                             ,(
                                SELECT	MN.PROP_OFC_CD
                                        , MN.PROP_OFC_NM --  AS PROP_OFC_NM -- REQUEST OFFICE
                                        , MN.CUST_CNT_CD
                                        , MN.CUST_SEQ
                                        , MN.PROP_NO
                                        , MN.AMDT_SEQ
                                        , MN.CTRT_EFF_DT, MN.CTRT_EXP_DT
                                        , MN.CTRT_PTY_NM -- CTRT_PTY_NM								-- CUSTOMER NAME
                                        , MN.PROP_MQC_QTY  -- PROP_MQC_QTY								-- MQC( TARGET VVD )
                                        , CMDT_ROUT.PRS_ESTM_LOD_QTY  / DECODE(@[frm_pfmc_unit],'FEU',2,'TEU',1) AS PRS_ESTM_LOD_QTY -- LOAD(NEW)

                                        , CASE WHEN SUBSTR(CMDT_ROUT.PRS_RAT_UT_CD,2,1) = '2' OR SUBSTR(CMDT_ROUT.PRS_RAT_UT_CD,1,1) = '2'
                                        THEN CMDT_ROUT.PRS_ESTM_LOD_QTY * CMDT_ROUT.PRS_ESTM_RESPB_CMPB_AMT
                                        ELSE
                                        CMDT_ROUT.PRS_ESTM_LOD_QTY * CMDT_ROUT.PRS_ESTM_RESPB_CMPB_AMT  / 2
                                        END  AS ESTM_RESPB_CM_AMT  -- AS CM_NEW_OFFICE
                                        , CASE WHEN SUBSTR(CMDT_ROUT.PRS_RAT_UT_CD,2,1) = '2' OR SUBSTR(CMDT_ROUT.PRS_RAT_UT_CD,1,1) = '2'
                                        THEN CMDT_ROUT.PRS_ESTM_LOD_QTY * CMDT_ROUT.PRS_ESTM_PFIT_CMPB_AMT
                                        ELSE
                                        CMDT_ROUT.PRS_ESTM_LOD_QTY * CMDT_ROUT.PRS_ESTM_PFIT_CMPB_AMT  / 2
                                        END  AS ESTM_PFIT_CM_AMT    --  CM_NEW_OP_TRADE
                                        , CASE WHEN SUBSTR(CMDT_ROUT.PRS_RAT_UT_CD,2,1) = '2' OR SUBSTR(CMDT_ROUT.PRS_RAT_UT_CD,1,1) = '2'
                                        THEN CMDT_ROUT.PRS_ESTM_LOD_QTY * CMDT_ROUT.PRS_ESTM_RESPB_OPB_AMT
                                        ELSE
                                        CMDT_ROUT.PRS_ESTM_LOD_QTY * CMDT_ROUT.PRS_ESTM_RESPB_OPB_AMT  / 2
                                        END  AS ESTM_RESPB_OP_AMT    --  CM_NEW_OP_TRADE

                                        
                                        , (CMDT_ROUT.PRS_RMN_LOD_QTY+CMDT_ROUT.PRS_CRNT_LOD_QTY)  / DECODE('TEU','FEU',2,'TEU',1) AS PRS_AMDT_LOD_QTY -- LOAD(NEW)
                                        ,  (CMDT_ROUT.PRS_RMN_LOD_QTY * CMDT_ROUT.PRS_RMN_RESPB_CMPB_AMT +  CMDT_ROUT.PRS_CRNT_LOD_QTY * CMDT_ROUT.PRS_CRNT_RESPB_CMPB_AMT)  AS AMDT_RESPB_CM_AMT  -- AS CM_NEW_OFFICE
                                        ,  (CMDT_ROUT.PRS_RMN_LOD_QTY * CMDT_ROUT.PRS_RMN_PFIT_CMPB_AMT + CMDT_ROUT.PRS_CRNT_LOD_QTY * CMDT_ROUT.PRS_CRNT_PFIT_CMPB_AMT)  AS AMDT_PFIT_CM_AMT    --  CM_NEW_OP_TRADE
                                        ,  (CMDT_ROUT.PRS_RMN_LOD_QTY * CMDT_ROUT.PRS_CRNT_RESPB_OPB_AMT + CMDT_ROUT.PRS_CRNT_LOD_QTY * CMDT_ROUT.PRS_CRNT_RESPB_OPB_AMT)  AS AMDT_RESPB_OP_AMT    --  CM_NEW_OP_TRADE
                                        , MN.CONTRACT_NO
                                        , MN.CUST_TP_CD
                                        , MN.PROP_APRO_OFC_CD
                                        , MN.RESPB_SREP_CD
                                        , MN.RFA_NO
                                        , MN.SVC_SCP_CD
                                FROM	VW_RFA_MAIN_NEW_SET MN
                                        , PRI_RP_SCP_RT_CMDT_ROUT CMDT_ROUT
                                WHERE	 MN.PROP_NO = CMDT_ROUT.PROP_NO
                                        AND MN.AMDT_SEQ = CMDT_ROUT.AMDT_SEQ
                                        AND MN.SVC_SCP_CD = CMDT_ROUT.SVC_SCP_CD
                                        #if(${frm_contract_type} == 'B' || ${frm_contract_type} == 'R')
                                                AND 1=1
                                        #else
                                                AND 1=0
                                        #end
                                        -- BY CARGO TYPE
                                        #if (${crg_tp_str} != '' )
                                                AND CMDT_ROUT.PRS_CGO_TP_CD IN ( ${crg_tp_str} )
                                        #end
                              ) MN
                              WHERE MN_SET.PROP_NO = MN.PROP_NO(+)
                                  AND   MN_SET.AMDT_SEQ = MN.AMDT_SEQ(+)
                                  AND  MN_SET.SVC_SCP_CD = MN.SVC_SCP_CD(+)


		)
		GROUP BY RFA_NO,PROP_OFC_CD,CUST_CNT_CD,CUST_SEQ, PROP_NO, AMDT_SEQ, CTRT_EFF_DT, CTRT_EXP_DT,CONTRACT_NO 
        )  
	UNION ALL 
	SELECT RFA_NO
		, 'RFA' AS CONTRACT_NM
		, 'Quotation' AS CONTRACT_BASIS
		, 1 AS SORT_KEY
		, PROP_OFC_CD
		, PROP_OFC_NM
		, PROP_NO
		, -1 AS AMDT_SEQ
		, CONTRACT_NO
		, CUST_CNT_CD
		, CUST_SEQ
		, EFF_DT
		, EXP_DT
		, CTRT_PTY_NM	 
		, PROP_MQC_QTY	 
		, LOAD          
		, CM_OFFICE	 
		, CM_TRADE 
		, OP 
		, CMPB_OFFICE 
		, CMPB_TRADE	 
		, OPB	 
		, CUST_TP_CD           
		, PROP_APRO_OFC_CD
		, RESPB_SREP_CD      
	FROM (
                SELECT
                        RFA_NO
                        , PROP_OFC_CD
                        , MAX(PROP_OFC_NM) AS PROP_OFC_NM -- REQUEST OFFICE
                        , PROP_NO
                        , AMDT_SEQ
                        , CONTRACT_NO
                        , CUST_CNT_CD
                        , CUST_SEQ
                        , EFF_DT, EXP_DT
                        , MAX(CTRT_PTY_NM) AS CTRT_PTY_NM								-- CUSTOMER NAME
                        , MAX(ESTM_MQC_QTY) AS PROP_MQC_QTY								-- MQC( TARGET VVD )
                        , MAX(CUST_TP_CD ) AS CUST_TP_CD
                        , MAX(PROP_APRO_OFC_CD) AS PROP_APRO_OFC_CD
                        , MAX(QTTN_SREP_CD ) AS RESPB_SREP_CD

                        , SUM(PRS_ESTM_LOD_QTY) AS LOAD-- LOAD(NEW)
                        , SUM(ESTM_RESPB_CM_AMT) AS CM_OFFICE	   -- Office Profit -- CM(NEW)
                        , SUM(ESTM_PFIT_CM_AMT) AS CM_TRADE	   -- Trade Profit -- CM(NEW)
                        , SUM(ESTM_RESPB_OP_AMT) AS OP	    --OP(NEW)
                        , DECODE(SUM(PRS_ESTM_LOD_QTY),0,0,SUM(ESTM_RESPB_CM_AMT) / SUM(PRS_ESTM_LOD_QTY)) AS CMPB_OFFICE	-- OFFICE PROPIT/CMPB
                        , DECODE(SUM(PRS_ESTM_LOD_QTY),0,0,SUM(ESTM_PFIT_CM_AMT) / SUM(PRS_ESTM_LOD_QTY)) AS CMPB_TRADE	-- TRADE PROPIT/CM
                        , DECODE(SUM(PRS_ESTM_LOD_QTY),0,0,SUM(ESTM_RESPB_OP_AMT) / SUM(PRS_ESTM_LOD_QTY)) AS OPB	 --OPB(NEW)
                FROM (
                        SELECT 
                                SC_SET.RFA_NO
                                , HDR.QTTN_OFC_CD AS PROP_OFC_CD
				, (SELECT M_ORG.OFC_ENG_NM FROM MDM_ORGANIZATION M_ORG WHERE HDR.QTTN_OFC_CD = M_ORG.OFC_CD) AS PROP_OFC_NM
                                , MN.CUST_CNT_CD
                                , MN.CUST_SEQ
                                , MN.PROP_NO
                                , -1 AS AMDT_SEQ
                                , MN.QTTN_NO || MN.QTTN_VER_NO AS CONTRACT_NO
                                , MN.EFF_DT, MN.EXP_DT					
				,(   SELECT CUST.CUST_LGL_ENG_NM
                                     FROM MDM_CUSTOMER CUST
                                     WHERE MN.CUST_CNT_CD = CUST.CUST_CNT_CD
                                         AND MN.CUST_SEQ = CUST.CUST_SEQ ) AS CTRT_PTY_NM  -- CUSTOMER NAME


                                , (
                                        CASE WHEN MN.CNTR_LOD_UT_CD = 'F' AND @[frm_pfmc_unit] = 'TEU' THEN
                                                MN.ESTM_MQC_QTY * 2
                                        WHEN MN.CNTR_LOD_UT_CD = 'T' AND @[frm_pfmc_unit] = 'FEU' THEN
                                                MN.ESTM_MQC_QTY /2
                                        ELSE MN.ESTM_MQC_QTY
                                        END
                                ) ESTM_MQC_QTY  -- PROP_MQC_QTY								-- MQC( TARGET VVD )
                                , MN.SVC_SCP_CD
                                , ( MN.PRC_CUST_TP_CD) AS CUST_TP_CD
                                ,'' AS PROP_APRO_OFC_CD
                                ,(MN.QTTN_SREP_CD) AS QTTN_SREP_CD
                                , MN_DT.PRS_ESTM_LOD_QTY -- LOAD(NEW)
                                , MN_DT.ESTM_RESPB_CM_AMT  -- AS CM_NEW_OFFICE
                                , MN_DT.ESTM_PFIT_CM_AMT    --  CM_NEW_OP_TRADE
                                , MN_DT.ESTM_RESPB_OP_AMT    --  CM_NEW_OP_TRADE
                        FROM PRI_RQ_MN MN
                              , PRI_RQ_HDR HDR
                              ,( SELECT DISTINCT PROP_NO,RFA_NO FROM VW_RFA_MAIN_NEW_SET ) SC_SET
                              ,(
                                SELECT	MN.QTTN_NO,MN.QTTN_VER_NO
                                        , CMDT_ROUT.PRS_ESTM_LOD_QTY  / DECODE(@[frm_pfmc_unit],'FEU',2,'TEU',1) AS PRS_ESTM_LOD_QTY -- LOAD(NEW)
                                        , CASE WHEN SUBSTR(CMDT_ROUT.PRS_RAT_UT_CD,2,1) = '2' OR SUBSTR(CMDT_ROUT.PRS_RAT_UT_CD,1,1) = '2'
                                                THEN CMDT_ROUT.PRS_ESTM_LOD_QTY * CMDT_ROUT.PRS_ESTM_RESPB_CMPB_AMT
                                                ELSE
                                                CMDT_ROUT.PRS_ESTM_LOD_QTY * CMDT_ROUT.PRS_ESTM_RESPB_CMPB_AMT  / 2
                                        END  AS ESTM_RESPB_CM_AMT  -- AS CM_NEW_OFFICE
                                        , CASE WHEN SUBSTR(CMDT_ROUT.PRS_RAT_UT_CD,2,1) = '2' OR SUBSTR(CMDT_ROUT.PRS_RAT_UT_CD,1,1) = '2'
                                                THEN CMDT_ROUT.PRS_ESTM_LOD_QTY * CMDT_ROUT.PRS_ESTM_PFIT_CMPB_AMT
                                                ELSE
                                                CMDT_ROUT.PRS_ESTM_LOD_QTY * CMDT_ROUT.PRS_ESTM_PFIT_CMPB_AMT  / 2
                                        END  AS ESTM_PFIT_CM_AMT    --  CM_NEW_OP_TRADE
                                        , CASE WHEN SUBSTR(CMDT_ROUT.PRS_RAT_UT_CD,2,1) = '2' OR SUBSTR(CMDT_ROUT.PRS_RAT_UT_CD,1,1) = '2'
                                                THEN CMDT_ROUT.PRS_ESTM_LOD_QTY * CMDT_ROUT.PRS_ESTM_RESPB_OPB_AMT
                                                ELSE
                                                CMDT_ROUT.PRS_ESTM_LOD_QTY * CMDT_ROUT.PRS_ESTM_RESPB_OPB_AMT  / 2
                                        END  AS ESTM_RESPB_OP_AMT    --  CM_NEW_OP_TRADE
                                FROM	PRI_RQ_MN MN
                                        ,( SELECT DISTINCT PROP_NO,RFA_NO FROM VW_RFA_MAIN_NEW_SET ) SC_SET
                                        , PRI_RQ_RT_CMDT_ROUT CMDT_ROUT
                                WHERE	 MN.PROP_NO = SC_SET.PROP_NO
                                        AND MN.QTTN_NO = CMDT_ROUT.QTTN_NO
                                        AND MN.QTTN_VER_NO = CMDT_ROUT.QTTN_VER_NO
                                        #if(${frm_contract_type} == 'B' || ${frm_contract_type} == 'R')
                                                AND 1=1
                                        #else
                                                AND 1=0
                                        #end
                                        -- BY CARGO TYPE
                                        #if (${crg_tp_str} != '' )
                                             AND CMDT_ROUT.PRS_CGO_TP_CD IN ( ${crg_tp_str} )
                                        #end
                              ) MN_DT       
                        WHERE MN.QTTN_NO   = HDR.QTTN_NO
                                AND MN.PROP_NO = SC_SET.PROP_NO
                                AND MN.QTTN_NO = MN_DT.QTTN_NO(+)
                                AND MN.QTTN_VER_NO = MN_DT.QTTN_VER_NO(+)
                )
                GROUP BY RFA_NO,PROP_OFC_CD,CUST_CNT_CD,CUST_SEQ, PROP_NO, AMDT_SEQ, EFF_DT, EXP_DT,CONTRACT_NO
        )  
)
ORDER BY CONTRACT_NM DESC,PROP_NO , SORT_KEY,AMDT_SEQ			]]></sql>
			<params>
				<param name="frm_pfmc_unit" type="12" value="" out="N"/>
				<param name="frm_prop_ofc_cd" type="12" value="" out="N"/>
				<param name="frm_prop_srep_cd" type="12" value="" out="N"/>
				<param name="frm_prop_apro_ofc_cd" type="12" value="" out="N"/>
				<param name="frm_ctrt_eff_dt" type="12" value="" out="N"/>
				<param name="frm_ctrt_exp_dt" type="12" value="" out="N"/>
				<param name="frm_svc_scp_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
