<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="SCRateQuotationDBDAOPriSqRtScgCostDetailVOCSQL">
			<desc><![CDATA[pri_sq_rt를 일괄 조정한다.
2013.04.25 [CHM-201324203] 전윤주 Contract date 비교하여 surcharge calculate 하는 로직 추가
2015.03.09 전지예 [CHM-201534137] Percent Base CHG Creation 보완
2015.06.30 최성환 [CHM-201536493] Split03-주간 MAS Open에 따른 타모듈 프로그램 적용 요청]]></desc>
			<sql><![CDATA[
MERGE INTO PRI_SQ_RT_SCG A
USING (
WITH
BQ AS   
(
SELECT BQ_SEQ       ,
    CTRT_TP_CD     ,
    QTTN_NO       ,
    QTTN_VER_NO      ,
    SVC_SCP_CD     ,
    GEN_SPCL_RT_TP_CD  ,
    CMDT_HDR_SEQ    ,
    ROUT_SEQ      ,
    RT_SEQ       ,
    CURR_CD		,
    QTTN_RT_AMT   ,
    DIR_CALL_FLG    ,
    CTRT_CNTR_TPSZ_CD  ,
    CTRT_CNTR_SZ_CD   ,
    PRC_CGO_TP_CD    ,
    POR_CD       ,
    POR_STE_CD     ,
    POR_RGN_CD     ,
    POR_CNT_CD     ,
    POR_CONTI_CD    ,
    POL_CD       ,
    POL_STE_CD     ,
    POL_RGN_CD     ,
    POL_CNT_CD     ,
    POL_CONTI_CD    ,
    POD_CD       ,
    POD_STE_CD     ,
    POD_RGN_CD     ,
    POD_CNT_CD     ,
    POD_CONTI_CD    ,
    DEL_CD       ,
    DEL_STE_CD     ,
    DEL_RGN_CD     ,
    DEL_CNT_CD     ,
    DEL_CONTI_CD    ,
    RCV_TERM_CD     ,
    DE_TERM_CD     ,
    N1ST_FINC_VVD_CD  ,
    N2ND_FINC_VVD_CD  ,
    N3RD_FINC_VVD_CD  ,
    N4TH_FINC_VVD_CD  ,
    N1ST_RLANE_CD    ,
    N2ND_RLANE_CD    ,
    N3RD_RLANE_CD    ,
    N4TH_RLANE_CD    ,
    N1ST_POL_CONTI_CD          ,
    N2ND_POL_CONTI_CD          ,
    N3RD_POL_CONTI_CD          ,
    N4TH_POL_CONTI_CD          ,

    N1ST_POD_CONTI_CD          ,
    N2ND_POD_CONTI_CD          ,
    N3RD_POD_CONTI_CD          ,
    N4TH_POD_CONTI_CD          ,

    N1ST_POL_CD          ,
    N2ND_POL_CD          ,
    N3RD_POL_CD          ,
    N4TH_POL_CD          ,

    N1ST_POD_CD          ,
    N2ND_POD_CD          ,
    N3RD_POD_CD          ,
    N4TH_POD_CD          ,

    N1ST_TS_PORT_CD   ,
    N2ND_TS_PORT_CD   ,
    N3RD_TS_PORT_CD   ,
    CML_ZN_CD      ,
    USA_SVC_MOD_CD   ,

    CASE
    WHEN ORG_TRNS_MOD_CD = 'TD' THEN 'T'
    WHEN ORG_TRNS_MOD_CD = 'RD' THEN 'R'
    WHEN ORG_TRNS_MOD_CD = 'WD' THEN  DECODE(POR_CD, POL_CD,'F', 'B')
    WHEN ORG_TRNS_MOD_CD = 'TR' THEN 'A'
    WHEN ORG_TRNS_MOD_CD = 'TW' THEN  DECODE(POR_CD, POL_CD,'E', 'U')
    END ORG_TRNS_MOD_CD ,

    CASE
    WHEN DEST_TRNS_MOD_CD = 'TD' THEN 'T'
    WHEN DEST_TRNS_MOD_CD = 'RD' THEN 'R'
    WHEN DEST_TRNS_MOD_CD = 'WD' THEN  DECODE(DEL_CD, POD_CD,'F', 'B')
    WHEN DEST_TRNS_MOD_CD = 'TR' THEN 'A'
    WHEN DEST_TRNS_MOD_CD = 'TW' THEN  DECODE(DEL_CD, POD_CD,'E', 'U')
    END DEST_TRNS_MOD_CD ,

    PRD_RD_CNT,
    CUST_TP_CD

FROM  (
    SELECT ROWNUM BQ_SEQ     ,

        'S' CTRT_TP_CD    ,
        RT.QTTN_NO      ,
        RT.QTTN_VER_NO      ,
        MN.SVC_SCP_CD     ,
        RT.GEN_SPCL_RT_TP_CD ,
        RT.CMDT_HDR_SEQ    ,
        RT.ROUT_SEQ      ,
        RT.RT_SEQ       ,
        RT.CURR_CD		,
        RT.QTTN_RT_AMT  ,

        RD.DIR_CALL_FLG    ,

        CASE
        WHEN RT.RAT_UT_CD = '20' THEN 'D2'
        WHEN RT.RAT_UT_CD = '40' THEN 'D4'
        WHEN RT.RAT_UT_CD = 'HC' THEN 'D5'
        WHEN RT.RAT_UT_CD = '45' THEN 'D7'
        WHEN RT.RAT_UT_CD = 'BL' THEN 'F4'
        ELSE RT.RAT_UT_CD
        END CTRT_CNTR_TPSZ_CD ,

        ( SELECT A.CNTR_SZ_CD FROM PRI_RAT_UT A WHERE A.RAT_UT_CD = CASE
                                         WHEN RT.RAT_UT_CD = '20' THEN 'D2'
                                         WHEN RT.RAT_UT_CD = '40' THEN 'D4'
                                         WHEN RT.RAT_UT_CD = 'HC' THEN 'D5'
                                         WHEN RT.RAT_UT_CD = '45' THEN 'D7'
                                         WHEN RT.RAT_UT_CD = 'BL' THEN 'F4'
                                         ELSE RT.RAT_UT_CD
                                         END ) CTRT_CNTR_SZ_CD ,

        RT.PRC_CGO_TP_CD  ,

        RC.POR_CD              ,
        L1.CNT_CD||L1.STE_CD POR_STE_CD  ,
        L1.RGN_CD       POR_RGN_CD  ,
        L1.CNT_CD       POR_CNT_CD  ,
        L1.CONTI_CD      POR_CONTI_CD ,
        RC.POL_CD              ,
        L2.CNT_CD||L2.STE_CD POL_STE_CD  ,
        L2.RGN_CD       POL_RGN_CD  ,
        L2.CNT_CD       POL_CNT_CD  ,
        L2.CONTI_CD      POL_CONTI_CD ,
        RC.POD_CD              ,
        L3.CNT_CD||L3.STE_CD POD_STE_CD  ,
        L3.RGN_CD       POD_RGN_CD  ,
        L3.CNT_CD       POD_CNT_CD  ,
        L3.CONTI_CD      POD_CONTI_CD ,
        RC.DEL_CD              ,
        L4.CNT_CD||L4.STE_CD DEL_STE_CD  ,
        L4.RGN_CD       DEL_RGN_CD  ,
        L4.CNT_CD       DEL_CNT_CD  ,
        L4.CONTI_CD      DEL_CONTI_CD ,

		/* T : Tackle, I : Free In, N : Liner In, S : CFS */
        DECODE( RC.BKG_RCV_TERM_CD, 'T', 'Y', 'I', 'Y', 'N', 'Y', 'S', 'Y', RC.BKG_RCV_TERM_CD ) RCV_TERM_CD   ,
		/* T : Tackle, O : Free Out, U : Liner Out, S : CFS */
        DECODE( RC.BKG_DE_TERM_CD, 'T', 'Y', 'O', 'Y', 'U', 'Y', 'S', 'Y', RC.BKG_DE_TERM_CD ) DE_TERM_CD   ,

        RC.N1ST_FINC_VVD_CD         ,
        RC.N2ND_FINC_VVD_CD         ,
        RC.N3RD_FINC_VVD_CD         ,
        RC.N4TH_FINC_VVD_CD         ,

        RC.N1ST_RLANE_CD          ,
        RC.N2ND_RLANE_CD          ,
        RC.N3RD_RLANE_CD          ,
        RC.N4TH_RLANE_CD          ,

        (SELECT A.CONTI_CD FROM MDM_LOCATION A WHERE A.LOC_CD = RC.POL_CD)  				AS N1ST_POL_CONTI_CD          ,
        (SELECT A.CONTI_CD FROM MDM_LOCATION A WHERE A.LOC_CD = RC.N1ST_TS_PORT_CD) 		AS N2ND_POL_CONTI_CD          ,
        (SELECT A.CONTI_CD FROM MDM_LOCATION A WHERE A.LOC_CD = RC.N2ND_TS_PORT_CD) 		AS N3RD_POL_CONTI_CD          ,
        (SELECT A.CONTI_CD FROM MDM_LOCATION A WHERE A.LOC_CD = RC.N3RD_TS_PORT_CD) 		AS N4TH_POL_CONTI_CD          ,

        (SELECT A.CONTI_CD FROM MDM_LOCATION A WHERE A.LOC_CD = NVL(RC.N1ST_TS_PORT_CD, RC.POD_CD)) 				AS N1ST_POD_CONTI_CD          ,
        (SELECT A.CONTI_CD FROM MDM_LOCATION A WHERE A.LOC_CD = NVL(RC.N2ND_TS_PORT_CD, DECODE(RC.N1ST_TS_PORT_CD, NULL, NULL, RC.POD_CD))) AS N2ND_POD_CONTI_CD          ,
        (SELECT A.CONTI_CD FROM MDM_LOCATION A WHERE A.LOC_CD = NVL(RC.N3RD_TS_PORT_CD, DECODE(RC.N2ND_TS_PORT_CD, NULL, NULL, RC.POD_CD))) AS N3RD_POD_CONTI_CD          ,
        (SELECT A.CONTI_CD FROM MDM_LOCATION A WHERE A.LOC_CD = DECODE(RC.N3RD_TS_PORT_CD, NULL, NULL, RC.POD_CD)) AS N4TH_POD_CONTI_CD          ,

        RC.POL_CD  				AS N1ST_POL_CD          ,
        RC.N1ST_TS_PORT_CD 		AS N2ND_POL_CD          ,
        RC.N2ND_TS_PORT_CD 		AS N3RD_POL_CD          ,
        RC.N3RD_TS_PORT_CD 		AS N4TH_POL_CD          ,

        NVL(RC.N1ST_TS_PORT_CD, RC.POD_CD) 				                            AS N1ST_POD_CD          ,
        NVL(RC.N2ND_TS_PORT_CD, DECODE(RC.N1ST_TS_PORT_CD, NULL, NULL, RC.POD_CD))  AS N2ND_POD_CD          ,
        NVL(RC.N3RD_TS_PORT_CD, DECODE(RC.N2ND_TS_PORT_CD, NULL, NULL, RC.POD_CD))  AS N3RD_POD_CD          ,
        DECODE(RC.N3RD_TS_PORT_CD, NULL, NULL, RC.POD_CD)                           AS N4TH_POD_CD          ,

        RC.N1ST_TS_PORT_CD         ,
        RC.N2ND_TS_PORT_CD         ,
        RC.N3RD_TS_PORT_CD         ,

        CASE
        WHEN L4.CML_ZN_FLG = 'Y' AND L3.RGN_CD IN ( 'UAG', 'UAN', 'UAS' ) THEN 'CZ'
        ELSE 'NN'
        END CML_ZN_CD   ,
        CASE
        WHEN L3.CNT_CD IN ( 'US', 'CA' ) AND RC.POD_CD = RC.DEL_CD AND RC.BKG_DE_TERM_CD NOT IN ( 'D', 'H' ) THEN 'PO'
        WHEN L3.CNT_CD IN ( 'US', 'CA' ) THEN NVL(( SELECT SUBSTR(SVC_MOD_CD, 1, 2) FROM MAS_USA_SVC_MOD A WHERE A.ORG_RGN_CD = L3.RGN_CD AND A.DEST_RGN_CD = L4.RGN_CD ), 'OT')
        WHEN L2.CNT_CD IN ( 'US', 'CA' ) AND RC.POL_CD = RC.POR_CD AND RC.BKG_RCV_TERM_CD NOT IN ( 'D', 'H' ) THEN 'PO'
        WHEN L2.CNT_CD IN ( 'US', 'CA' ) THEN NVL(( SELECT SUBSTR(SVC_MOD_CD, 1, 2) FROM MAS_USA_SVC_MOD A WHERE A.ORG_RGN_CD = L2.RGN_CD AND A.DEST_RGN_CD = L1.RGN_CD ), 'OT')
        END  USA_SVC_MOD_CD , -- PO, LO, IP, ML, OT

        ( SELECT SUBSTR(AC.ACT_GRP_CD, 3, 2) FROM PRI_PRS_USD_ROUT_ACT_COST AC WHERE AC.ROUT_CS_NO = RC.ROUT_CS_NO AND AC.ROUT_CS_SRC_DT = RC.ROUT_CS_SRC_DT AND AC.N1ST_NOD_CD LIKE RC.POR_CD||'%' AND ROWNUM = 1 ) ORG_TRNS_MOD_CD ,
        ( SELECT SUBSTR(AC.ACT_GRP_CD, 3, 2) FROM PRI_PRS_USD_ROUT_ACT_COST AC WHERE AC.ROUT_CS_NO = RC.ROUT_CS_NO AND AC.ROUT_CS_SRC_DT = RC.ROUT_CS_SRC_DT AND COALESCE(AC.N4TH_NOD_CD, AC.N3RD_NOD_CD, AC.N2ND_NOD_CD) LIKE RC.DEL_CD||'%' AND ROWNUM = 1 ) DEST_TRNS_MOD_CD ,

        NVL(RC.TRSP_RAIL_DIR_KNT, 0)	PRD_RD_CNT,	-- PRD에서  rail direct 갯수 
		PRC_CUST_TP_CD AS CUST_TP_CD
    FROM  PRI_SQ_MN               MN  ,
          PRI_SQ_RT               RT  ,
          PRI_SQ_RT_CMDT_ROUT     RD  ,
          PRI_SQ_RT_USD_ROUT_CS   RR  ,
          PRI_PRS_USD_ROUT_CS_INFO    RC ,
          MDM_LOCATION        L1 ,
          MDM_LOCATION        L2 ,
          MDM_LOCATION        L3 ,
          MDM_LOCATION        L4

    WHERE MN.QTTN_NO              = RT.QTTN_NO
    AND   MN.QTTN_VER_NO          = RT.QTTN_VER_NO
    AND   RD.QTTN_NO              = RT.QTTN_NO
    AND   RD.QTTN_VER_NO          = RT.QTTN_VER_NO
    AND   RD.GEN_SPCL_RT_TP_CD    = RT.GEN_SPCL_RT_TP_CD
    AND   RD.CMDT_HDR_SEQ         = RT.CMDT_HDR_SEQ
    AND   RD.ROUT_SEQ             = RT.ROUT_SEQ
    AND   RR.QTTN_NO              = RT.QTTN_NO
    AND   RR.QTTN_VER_NO          = RT.QTTN_VER_NO
    AND   RR.GEN_SPCL_RT_TP_CD    = RT.GEN_SPCL_RT_TP_CD
    AND   RR.CMDT_HDR_SEQ         = RT.CMDT_HDR_SEQ
    AND   RR.ROUT_SEQ             = RT.ROUT_SEQ
    AND   RR.RT_SEQ               = RT.RT_SEQ
    AND   RR.USD_ROUT_CS_SEL_FLG  = 'Y'
    AND   RC.ROUT_CS_NO           = RR.ROUT_CS_NO
    AND   RC.ROUT_CS_SRC_DT       = RR.ROUT_CS_SRC_DT
    AND   L1.LOC_CD        = RC.POR_CD
    AND   L2.LOC_CD        = RC.POL_CD
    AND   L3.LOC_CD        = RC.POD_CD
    AND   L4.LOC_CD        = RC.DEL_CD
    AND   RT.QTTN_NO       = @[qttn_no]
    AND   RT.QTTN_VER_NO      = @[qttn_ver_no]
    AND   RT.GEN_SPCL_RT_TP_CD  = @[gen_spcl_rt_tp_cd]
    AND   RT.CMDT_HDR_SEQ = @[cmdt_hdr_seq]
    AND   RT.ROUT_SEQ = @[rout_seq]
    AND   RT.RT_SEQ = @[rt_seq]
    )
) ,

S3 AS
(
/*******************************************************************************************
< TARIFF SURCHARGE >
*******************************************************************************************/
SELECT BQ_SEQ       ,
    SEL_TP_CD      ,
    SEL_TP_PRIO     ,
    CHG_CD       ,
    FLT_PCT_TP_CD    ,
    PCT_BSE_CD     ,
    RT_APPL_TP_CD    ,
    RT_OP_CD      ,
    CURR_CD             ,
    FRT_RT_AMT     ,
    RAT_UT_CD      ,
    PRC_CGO_TP_CD    
FROM  (
    SELECT BQ.BQ_SEQ         ,
        'S'  SEL_TP_CD      ,
        3    SEL_TP_PRIO     ,

        ROW_NUMBER() OVER ( PARTITION BY BQ.BQ_SEQ, SP.CHG_CD
                  ORDER BY
                    DECODE(SR.POR_TP_CD, 'L', 600, 'G', 500, 'T', 400, 'R', 300, 'C', 200, 0)
                    + DECODE(SR.POL_TP_CD, 'L', 600, 'G', 500, 'T', 400, 'R', 300, 'C', 200, 0)
                    + DECODE(SR.POD_TP_CD, 'L', 600, 'G', 500, 'T', 400, 'R', 300, 'C', 200, 0)
                    + DECODE(SR.DEL_TP_CD, 'L', 600, 'G', 500, 'T', 400, 'R', 300, 'C', 200, 0)
                    + DECODE(SR.RAT_UT_CD, '20', 5, '40', 5, 'HC', 5, '53', 5, 'BL', 4, 'BX', 4, 'PC', 4, 'CM', 4, 'MT', 4, 'RM', 4, NULL, 4, 6)
                    + DECODE(SR.PRC_CGO_TP_CD    , NULL, 0, 1)
                    + DECODE(SR.USA_SVC_MOD_CD   , NULL, 0, 1)
                    + DECODE(SR.ORG_TRSP_MOD_CD   , NULL, 0, 1)
                    + DECODE(SR.DEST_TRSP_MOD_CD  , NULL, 0, 1)
                    + DECODE(SR.PRC_RCV_TERM_CD   , NULL, 0, 1)
                    + DECODE(SR.PRC_DE_TERM_CD   , NULL, 0, 1)
                    + DECODE(SR.VSL_SLAN_CD     , NULL, 0, 1)
                    + DECODE(SR.TS_PORT_CD     , NULL, 0, 1)
                    + DECODE(SR.SUB_TRD_CD     , NULL, 0, 1) DESC,
                    NVL(SR.CTRT_DT, TO_DATE('19000101','YYYYMMDD')) DESC
                 ) ROW_NUMBER ,

        SP.CHG_CD         ,

        SP.FLT_PCT_TP_CD     ,
        SP.PCT_BSE_CD       ,

        NULL RT_APPL_TP_CD    ,
        NULL RT_OP_CD      ,

        SR.CURR_CD        ,

        SR.SCG_AMT AS FRT_RT_AMT ,
        SR.RAT_UT_CD       ,
        SR.PRC_CGO_TP_CD     

    FROM  BQ         ,
        PRI_SCG_PRF  SP  ,
        MDM_CHARGE  MC  ,
        PRI_SCG_RT  SR  
    WHERE  SP.SVC_SCP_CD        = BQ.SVC_SCP_CD
    AND   MC.CHG_CD          = SP.CHG_CD
    AND   MC.AUTO_RAT_FLG       = 'Y'
    AND   SR.SVC_SCP_CD        = SP.SVC_SCP_CD
    AND   SR.CHG_CD          = SP.CHG_CD
    AND   TO_DATE(SYSDATE)      BETWEEN SR.EFF_DT AND SR.EXP_DT + 0.99999  /* 0.99999 는 23시 59분 59초를 의미 */
    AND   SR.WDR_FLG         = 'N'
    AND   SR.DELT_FLG         = 'N'
    AND   (
          SR.PRC_RCV_TERM_CD = BQ.RCV_TERM_CD
        OR (
            ( SP.RCV_DE_TERM_USE_FLG = 'N' OR SR.PRC_RCV_TERM_CD IS NULL )
          AND BQ.RCV_TERM_CD IN ( DECODE(MC.NA_RD_TERM_FLG, 'Y', BQ.RCV_TERM_CD), DECODE(MC.CY_RD_TERM_FLG, 'Y', 'Y'), DECODE(MC.DOR_RD_TERM_FLG, 'Y', 'D'), DECODE(MC.CFS_RD_TERM_FLG, 'Y', 'S'), DECODE(MC.TKL_TML_FLG, 'Y', 'T') )
          )
        )

    AND   (
          SR.PRC_DE_TERM_CD  = BQ.DE_TERM_CD
        OR (
            ( SP.RCV_DE_TERM_USE_FLG = 'N' OR SR.PRC_DE_TERM_CD IS NULL )
          AND BQ.DE_TERM_CD  IN ( DECODE(MC.NA_RD_TERM_FLG, 'Y', BQ.DE_TERM_CD), DECODE(MC.CY_RD_TERM_FLG, 'Y', 'Y'), DECODE(MC.DOR_RD_TERM_FLG, 'Y', 'D'), DECODE(MC.CFS_RD_TERM_FLG, 'Y', 'S'), DECODE(MC.TKL_TML_FLG, 'Y', 'T') )
          )
        )


    /* POR */
    AND   (
          SP.POR_USE_FLG = 'N'
        OR SR.POR_DEF_CD  IS NULL
        OR  SR.POR_DEF_CD  = DECODE(SR.POR_TP_CD, 'L', BQ.POR_CD, 'T', BQ.POR_STE_CD, 'R', BQ.POR_RGN_CD, 'C', BQ.POR_CNT_CD)
        OR (
            SR.POR_TP_CD = 'G'
          AND EXISTS (
                SELECT 'X'
                FROM  PRI_SCG_GRP_LOC   GL ,
                    PRI_SCG_GRP_LOC_DTL GD
                WHERE  GD.SVC_SCP_CD   = GL.SVC_SCP_CD
                AND   GD.CHG_CD     = GL.CHG_CD
                AND   GD.GRP_LOC_SEQ  = GL.GRP_LOC_SEQ
                AND   GL.SVC_SCP_CD   = SR.SVC_SCP_CD
                AND   GL.CHG_CD     = SR.CHG_CD
                AND   GL.SCG_GRP_LOC_CD = SR.POR_DEF_CD
                AND   GD.DTL_LOC_DEF_CD = DECODE(GD.DTL_LOC_TP_CD, 'L', BQ.POR_CD, 'T', BQ.POR_STE_CD, 'R', BQ.POR_RGN_CD, 'C', BQ.POR_CNT_CD)
                )
          )
        )
    /* POL */
    AND   (
          SP.POL_USE_FLG = 'N'
        OR SR.POL_DEF_CD  IS NULL
        OR  SR.POL_DEF_CD  = DECODE(SR.POL_TP_CD, 'L', BQ.POL_CD, 'T', BQ.POL_STE_CD, 'R', BQ.POL_RGN_CD, 'C', BQ.POL_CNT_CD)
        OR (
            SR.POL_TP_CD = 'G'
          AND EXISTS (
                SELECT 'X'
                FROM  PRI_SCG_GRP_LOC   GL ,
                    PRI_SCG_GRP_LOC_DTL GD
                WHERE  GD.SVC_SCP_CD   = GL.SVC_SCP_CD
                AND   GD.CHG_CD     = GL.CHG_CD
                AND   GD.GRP_LOC_SEQ  = GL.GRP_LOC_SEQ
                AND   GL.SVC_SCP_CD   = SR.SVC_SCP_CD
                AND   GL.CHG_CD     = SR.CHG_CD
                AND   GL.SCG_GRP_LOC_CD = SR.POL_DEF_CD
                AND   GD.DTL_LOC_DEF_CD = DECODE(GD.DTL_LOC_TP_CD, 'L', BQ.POL_CD, 'T', BQ.POL_STE_CD, 'R', BQ.POL_RGN_CD, 'C', BQ.POL_CNT_CD)
                )
          )
        )
    /* POD */
    AND   (
          SP.POD_USE_FLG = 'N'
        OR SR.POD_DEF_CD  IS NULL
        OR  SR.POD_DEF_CD  = DECODE(SR.POD_TP_CD, 'L', BQ.POD_CD, 'T', BQ.POD_STE_CD, 'R', BQ.POD_RGN_CD, 'C', BQ.POD_CNT_CD)
        OR (
            SR.POD_TP_CD = 'G'
          AND EXISTS (
                SELECT 'X'
                FROM  PRI_SCG_GRP_LOC   GL ,
                    PRI_SCG_GRP_LOC_DTL GD
                WHERE  GD.SVC_SCP_CD   = GL.SVC_SCP_CD
                AND   GD.CHG_CD     = GL.CHG_CD
                AND   GD.GRP_LOC_SEQ  = GL.GRP_LOC_SEQ
                AND   GL.SVC_SCP_CD   = SR.SVC_SCP_CD
                AND   GL.CHG_CD     = SR.CHG_CD
                AND   GL.SCG_GRP_LOC_CD = SR.POD_DEF_CD
                AND   GD.DTL_LOC_DEF_CD = DECODE(GD.DTL_LOC_TP_CD, 'L', BQ.POD_CD, 'T', BQ.POD_STE_CD, 'R', BQ.POD_RGN_CD, 'C', BQ.POD_CNT_CD)
                )
          )
        )
    /* DEL */
    AND   (
          SP.DEL_USE_FLG = 'N'
        OR SR.DEL_DEF_CD  IS NULL
        OR  SR.DEL_DEF_CD  = DECODE(SR.DEL_TP_CD, 'L', BQ.DEL_CD, 'T', BQ.DEL_STE_CD, 'R', BQ.DEL_RGN_CD, 'C', BQ.DEL_CNT_CD)
        OR (
            SR.DEL_TP_CD = 'G'
          AND EXISTS (
                SELECT 'X'
                FROM  PRI_SCG_GRP_LOC   GL ,
                    PRI_SCG_GRP_LOC_DTL GD
                WHERE  GD.SVC_SCP_CD   = GL.SVC_SCP_CD
                AND   GD.CHG_CD     = GL.CHG_CD
                AND   GD.GRP_LOC_SEQ  = GL.GRP_LOC_SEQ
                AND   GL.SVC_SCP_CD   = SR.SVC_SCP_CD
                AND   GL.CHG_CD     = SR.CHG_CD
                AND   GL.SCG_GRP_LOC_CD = SR.DEL_DEF_CD
                AND   GD.DTL_LOC_DEF_CD = DECODE(GD.DTL_LOC_TP_CD, 'L', BQ.DEL_CD, 'T', BQ.DEL_STE_CD, 'R', BQ.DEL_RGN_CD, 'C', BQ.DEL_CNT_CD)
                )
          )
        )
	/* SUB TRADE */
    AND   (
          SP.SUB_TRD_USE_FLG = 'N'
        OR SR.SUB_TRD_CD    IS NULL
        OR SR.SUB_TRD_CD    IN
          (
          SELECT DL.SUB_TRD_CD
          FROM   MDM_DTL_REV_LANE  DL
          WHERE (DL.RLANE_CD, DL.VSL_SLAN_DIR_CD, DL.FM_CONTI_CD, DL.TO_CONTI_CD ) IN 
          		(SELECT BQ.N1ST_RLANE_CD, SUBSTR(BQ.N1ST_FINC_VVD_CD, 9,1), BQ.N1ST_POL_CONTI_CD, BQ.N1ST_POD_CONTI_CD  FROM DUAL  
          		 UNION ALL
          		 SELECT BQ.N2ND_RLANE_CD, SUBSTR(BQ.N2ND_FINC_VVD_CD, 9,1), BQ.N2ND_POL_CONTI_CD, BQ.N2ND_POD_CONTI_CD  FROM DUAL
          		 UNION ALL
          		 SELECT BQ.N3RD_RLANE_CD, SUBSTR(BQ.N3RD_FINC_VVD_CD, 9,1), BQ.N3RD_POL_CONTI_CD, BQ.N3RD_POD_CONTI_CD  FROM DUAL
          		 UNION ALL
          		 SELECT BQ.N4TH_RLANE_CD, SUBSTR(BQ.N4TH_FINC_VVD_CD, 9,1), BQ.N4TH_POL_CONTI_CD, BQ.N4TH_POD_CONTI_CD  FROM DUAL
          		 ) 
          AND   DL.DELT_FLG     = 'N'
          )
        )

    /* LANE */
    AND   (
          SP.SLAN_USE_FLG = 'N'
        OR SR.VSL_SLAN_CD IS NULL
        OR SR.VSL_SLAN_CD IN ( BQ.N1ST_RLANE_CD, BQ.N2ND_RLANE_CD, BQ.N3RD_RLANE_CD, BQ.N4TH_RLANE_CD )
        )

    /* T/S PORT */
    AND   (
          SP.TS_PORT_USE_FLG = 'N'
        OR SR.TS_PORT_CD    IS NULL
        OR SR.TS_PORT_CD    IN ( BQ.N1ST_TS_PORT_CD, BQ.N2ND_TS_PORT_CD, BQ.N3RD_TS_PORT_CD )
        )

    /* ORG TRANS MODE */
    AND   (
          SP.TRNS_MOD_USE_FLG = 'N'
        OR SR.ORG_TRSP_MOD_CD IS NULL
        OR SR.ORG_TRSP_MOD_CD = BQ.ORG_TRNS_MOD_CD
        )
    /* DEST TRANS MODE */
    AND   (
          SP.TRNS_MOD_USE_FLG = 'N'
        OR SR.DEST_TRSP_MOD_CD IS NULL
        OR SR.DEST_TRSP_MOD_CD = BQ.DEST_TRNS_MOD_CD
        )
    /* USA SVC MODE */
    AND   (
          SP.USA_SVC_MOD_USE_FLG = 'N'
        OR SR.USA_SVC_MOD_CD    IS NULL
        OR SR.USA_SVC_MOD_CD    = DECODE(SR.USA_SVC_MOD_CD, 'CZ', BQ.CML_ZN_CD, BQ.USA_SVC_MOD_CD )
        )

/*******************************************************************************************
< CANAL >
P : PAPAC
S : EGSUC
*******************************************************************************************/
    AND (
          SP.CNL_TZ_FLG  = 'N'
        OR SR.CNL_TZ_CD  IS NULL
        OR EXISTS (
              SELECT 'X'
              FROM   VSK_VSL_PORT_SKD S1 ,
                  VSK_VSL_PORT_SKD S2 ,
                  VSK_VSL_PORT_SKD S3
              WHERE S1.VSL_CD    = SUBSTR(BQ.N1ST_FINC_VVD_CD,1,4)
              AND   S1.SKD_VOY_NO  = SUBSTR(BQ.N1ST_FINC_VVD_CD,5,4)
              AND   S1.SKD_DIR_CD  = SUBSTR(BQ.N1ST_FINC_VVD_CD,9,1)
              AND   S1.VPS_PORT_CD = BQ.N1ST_POL_CD
--              AND   S1.CLPT_IND_SEQ = BV.POL_CLPT_IND_SEQ
              AND   S2.VSL_CD    = SUBSTR(BQ.N1ST_FINC_VVD_CD,1,4)
              AND   S2.SKD_VOY_NO  = SUBSTR(BQ.N1ST_FINC_VVD_CD,5,4)
              AND   S2.SKD_DIR_CD  = SUBSTR(BQ.N1ST_FINC_VVD_CD,9,1)
              AND   S2.VPS_PORT_CD = BQ.N1ST_POD_CD
--              AND   S2.CLPT_IND_SEQ = BV.POD_CLPT_IND_SEQ
              AND   S3.VSL_CD    = SUBSTR(BQ.N1ST_FINC_VVD_CD,1,4)
              AND   S3.SKD_VOY_NO  = SUBSTR(BQ.N1ST_FINC_VVD_CD,5,4)
              AND   S3.SKD_DIR_CD  = SUBSTR(BQ.N1ST_FINC_VVD_CD,9,1)
              AND   S3.VPS_PORT_CD = DECODE(SR.CNL_TZ_CD, 'P', 'PAPAC', 'S', 'EGSUC')
              AND   S3.CLPT_SEQ   BETWEEN S1.CLPT_SEQ AND S2.CLPT_SEQ 
            UNION ALL
              SELECT 'X'
              FROM   VSK_VSL_PORT_SKD S1 ,
                  VSK_VSL_PORT_SKD S2 ,
                  VSK_VSL_PORT_SKD S3
              WHERE S1.VSL_CD    = SUBSTR(BQ.N2ND_FINC_VVD_CD,1,4)
              AND   S1.SKD_VOY_NO  = SUBSTR(BQ.N2ND_FINC_VVD_CD,5,4)
              AND   S1.SKD_DIR_CD  = SUBSTR(BQ.N2ND_FINC_VVD_CD,9,1)
              AND   S1.VPS_PORT_CD = BQ.N2ND_POL_CD
--              AND   S1.CLPT_IND_SEQ = BV.POL_CLPT_IND_SEQ
              AND   S2.VSL_CD    = SUBSTR(BQ.N2ND_FINC_VVD_CD,1,4)
              AND   S2.SKD_VOY_NO  = SUBSTR(BQ.N2ND_FINC_VVD_CD,5,4)
              AND   S2.SKD_DIR_CD  = SUBSTR(BQ.N2ND_FINC_VVD_CD,9,1)
              AND   S2.VPS_PORT_CD = BQ.N2ND_POD_CD
--              AND   S2.CLPT_IND_SEQ = BV.POD_CLPT_IND_SEQ
              AND   S3.VSL_CD    = SUBSTR(BQ.N2ND_FINC_VVD_CD,1,4)
              AND   S3.SKD_VOY_NO  = SUBSTR(BQ.N2ND_FINC_VVD_CD,5,4)
              AND   S3.SKD_DIR_CD  = SUBSTR(BQ.N2ND_FINC_VVD_CD,9,1)
              AND   S3.VPS_PORT_CD = DECODE(SR.CNL_TZ_CD, 'P', 'PAPAC', 'S', 'EGSUC')
              AND   S3.CLPT_SEQ   BETWEEN S1.CLPT_SEQ AND S2.CLPT_SEQ                                         
            UNION ALL
              SELECT 'X'
              FROM   VSK_VSL_PORT_SKD S1 ,
                  VSK_VSL_PORT_SKD S2 ,
                  VSK_VSL_PORT_SKD S3
              WHERE S1.VSL_CD    = SUBSTR(BQ.N3RD_FINC_VVD_CD,1,4)
              AND   S1.SKD_VOY_NO  = SUBSTR(BQ.N3RD_FINC_VVD_CD,5,4)
              AND   S1.SKD_DIR_CD  = SUBSTR(BQ.N3RD_FINC_VVD_CD,9,1)
              AND   S1.VPS_PORT_CD = BQ.N3RD_POL_CD
--              AND   S1.CLPT_IND_SEQ = BV.POL_CLPT_IND_SEQ
              AND   S2.VSL_CD    = SUBSTR(BQ.N3RD_FINC_VVD_CD,1,4)
              AND   S2.SKD_VOY_NO  = SUBSTR(BQ.N3RD_FINC_VVD_CD,5,4)
              AND   S2.SKD_DIR_CD  = SUBSTR(BQ.N3RD_FINC_VVD_CD,9,1)
              AND   S2.VPS_PORT_CD = BQ.N3RD_POD_CD
--              AND   S2.CLPT_IND_SEQ = BV.POD_CLPT_IND_SEQ
              AND   S3.VSL_CD    = SUBSTR(BQ.N3RD_FINC_VVD_CD,1,4)
              AND   S3.SKD_VOY_NO  = SUBSTR(BQ.N3RD_FINC_VVD_CD,5,4)
              AND   S3.SKD_DIR_CD  = SUBSTR(BQ.N3RD_FINC_VVD_CD,9,1)
              AND   S3.VPS_PORT_CD = DECODE(SR.CNL_TZ_CD, 'P', 'PAPAC', 'S', 'EGSUC')
              AND   S3.CLPT_SEQ   BETWEEN S1.CLPT_SEQ AND S2.CLPT_SEQ                                         
            UNION ALL
              SELECT 'X'
              FROM   VSK_VSL_PORT_SKD S1 ,
                  VSK_VSL_PORT_SKD S2 ,
                  VSK_VSL_PORT_SKD S3
              WHERE S1.VSL_CD    = SUBSTR(BQ.N4TH_FINC_VVD_CD,1,4)
              AND   S1.SKD_VOY_NO  = SUBSTR(BQ.N4TH_FINC_VVD_CD,5,4)
              AND   S1.SKD_DIR_CD  = SUBSTR(BQ.N4TH_FINC_VVD_CD,9,1)
              AND   S1.VPS_PORT_CD = BQ.N4TH_POL_CD
--              AND   S1.CLPT_IND_SEQ = BV.POL_CLPT_IND_SEQ
              AND   S2.VSL_CD    = SUBSTR(BQ.N4TH_FINC_VVD_CD,1,4)
              AND   S2.SKD_VOY_NO  = SUBSTR(BQ.N4TH_FINC_VVD_CD,5,4)
              AND   S2.SKD_DIR_CD  = SUBSTR(BQ.N4TH_FINC_VVD_CD,9,1)
              AND   S2.VPS_PORT_CD = BQ.N4TH_POD_CD
--              AND   S2.CLPT_IND_SEQ = BV.POD_CLPT_IND_SEQ
              AND   S3.VSL_CD    = SUBSTR(BQ.N4TH_FINC_VVD_CD,1,4)
              AND   S3.SKD_VOY_NO  = SUBSTR(BQ.N4TH_FINC_VVD_CD,5,4)
              AND   S3.SKD_DIR_CD  = SUBSTR(BQ.N4TH_FINC_VVD_CD,9,1)
              AND   S3.VPS_PORT_CD = DECODE(SR.CNL_TZ_CD, 'P', 'PAPAC', 'S', 'EGSUC')
              AND   S3.CLPT_SEQ   BETWEEN S1.CLPT_SEQ AND S2.CLPT_SEQ                                         
        )
    ) 

    /* CARGO TYPE */
    AND   (
          SR.PRC_CGO_TP_CD IS NULL
        OR SR.PRC_CGO_TP_CD = BQ.PRC_CGO_TP_CD
        )

     /* CONTRACT DATE [CHM-201324203] */
     AND     (
            SP.CTRT_DT_USE_FLG = 'N'
           OR  SR.CTRT_DT IS NULL
           OR  SR.CTRT_DT <= (SELECT EFF_DT 
                               FROM PRI_SQ_MN
                              WHERE QTTN_NO = BQ.QTTN_NO
                                AND QTTN_VER_NO = BQ.QTTN_VER_NO)
             )

    /* RATING UNIT */
    AND   (
          SR.RAT_UT_CD IN ( 'BL', 'BX', 'PC', 'RM' )
        OR SR.RAT_UT_CD = BQ.CTRT_CNTR_TPSZ_CD
            OR (
                SR.RAT_UT_CD IN ( '20', '40', 'HC', '45', '53' )
              AND ( SELECT A.CNTR_SZ_CD FROM PRI_RAT_UT A WHERE A.RAT_UT_CD = SR.RAT_UT_CD ) = BQ.CTRT_CNTR_SZ_CD
               )
          )
    )        
WHERE  ROW_NUMBER = 1
),

GS AS
(
SELECT BQ.BQ_SEQ       ,
    BQ.QTTN_NO      ,
    BQ.QTTN_VER_NO      ,
    BQ.SVC_SCP_CD     ,
    BQ.GEN_SPCL_RT_TP_CD ,
    BQ.CMDT_HDR_SEQ    ,
    BQ.ROUT_SEQ      ,
    BQ.RT_SEQ       ,
    S3.CHG_CD       ,
    S3.FLT_PCT_TP_CD   ,
    S3.PCT_BSE_CD     ,
    S3.CURR_CD      ,
    CASE
    WHEN S3.RAT_UT_CD = 'PC' THEN 0 -- 나중에 구해야 한다.
    ELSE S3.FRT_RT_AMT
    END         AS CHG_UT_AMT    ,
    CASE
    WHEN S3.RAT_UT_CD = 'BL' THEN 1
    WHEN S3.RAT_UT_CD = 'PC' THEN S3.FRT_RT_AMT
    WHEN S3.RAT_UT_CD = 'RM' THEN BQ.PRD_RD_CNT
    ELSE 1
    END         AS RAT_AS_QTY    ,
    S3.RAT_UT_CD     ,
    0 CHG_AMT       ,
    BQ.PRC_CGO_TP_CD CGO_TP_CD ,
    BQ.RCV_TERM_CD    ,
    BQ.DE_TERM_CD	,
    BQ.POR_CNT_CD   ,
    BQ.DEL_CNT_CD

FROM  BQ ,
      S3
WHERE S3.BQ_SEQ  = BQ.BQ_SEQ
  AND S3.CHG_CD NOT IN ( DECODE(BQ.CUST_TP_CD, 'N', 'XXX', 'NMS' )) /* CUSTOMER TYPE 이 NVOCC 인 경우만 NMS 존재 */
) ,
FN AS
(
/*******************************************************************************************
GENERAL SURCHARGE
*******************************************************************************************/

SELECT BQ_SEQ       ,
    QTTN_NO       ,
    QTTN_VER_NO    ,
    SVC_SCP_CD     ,
    GEN_SPCL_RT_TP_CD  ,
    CMDT_HDR_SEQ    ,
    ROUT_SEQ      ,
    RT_SEQ       ,
    CHG_CD       ,
    FLT_PCT_TP_CD    ,
    PCT_BSE_CD     ,
    CURR_CD       ,
    CHG_UT_AMT     ,
    RAT_AS_QTY     ,
    RAT_UT_CD      ,
    CHG_UT_AMT * RAT_AS_QTY CHG_AMT ,
    CGO_TP_CD      ,
    RCV_TERM_CD     ,
    DE_TERM_CD      ,
    POR_CNT_CD      ,
    DEL_CNT_CD
FROM  GS
WHERE  CHG_CD  NOT IN ( 'ACT' )

UNION ALL

/*******************************************************************************************
ACT
*******************************************************************************************/

SELECT GS.BQ_SEQ        ,
    GS.QTTN_NO       ,
    GS.QTTN_VER_NO   ,
    GS.SVC_SCP_CD      ,
    GS.GEN_SPCL_RT_TP_CD  ,
    GS.CMDT_HDR_SEQ     ,
    GS.ROUT_SEQ       ,
    GS.RT_SEQ        ,
    GS.CHG_CD        ,
    GS.FLT_PCT_TP_CD    ,
    GS.PCT_BSE_CD      ,
    GS.CURR_CD       ,
    GS.CHG_UT_AMT      ,
    GS.RAT_AS_QTY      ,
    GS.RAT_UT_CD      ,
    GS.CHG_UT_AMT * GS.RAT_AS_QTY CHG_AMT ,
    GS.CGO_TP_CD      ,
    GS.RCV_TERM_CD     ,
    GS.DE_TERM_CD		,
    GS.POR_CNT_CD      ,
    GS.DEL_CNT_CD
FROM  BQ ,
    GS
WHERE GS.BQ_SEQ = BQ.BQ_SEQ
AND   GS.CHG_CD = 'ACT'
AND     (
        (
          BQ.SVC_SCP_CD    = 'TPE'
        AND BQ.POD_CD      IN ( 'USLGB', 'USLAX' )
        AND BQ.POD_CD      <> BQ.DEL_CD
        AND BQ.DEST_TRNS_MOD_CD IN ( 'R', 'A' )
        )
    OR   (
          BQ.SVC_SCP_CD    = 'TPW'
        AND BQ.POL_CD      IN ( 'USLGB', 'USLAX' )
        AND BQ.POL_CD      <> BQ.POR_CD
        AND BQ.ORG_TRNS_MOD_CD IN ( 'R', 'A' )
        )
    OR   (
          BQ.SVC_SCP_CD    <> 'TPE'
        AND BQ.DEL_CNT_CD    = 'US'
        AND BQ.POD_CD      IN ( 'USNYC', 'USSAV', 'USCHS', 'USORF', 'USBOS' )
        AND EXISTS (
              SELECT 'X'
              FROM  PRD_INLND_ROUT_MST IR
              WHERE  IR.ROUT_ORG_NOD_CD    LIKE BQ.POD_CD||'%'
              AND   IR.ROUT_DEST_NOD_CD  LIKE BQ.DEL_CD||'%'
              AND   IR.PCTL_IO_BND_CD   = 'I'
              AND   IR.HUB_NOD_CD     LIKE 'USLGB'||'%'
              AND   IR.INLND_ROUT_BKG_FLG = 'Y'
              AND   NVL(IR.DELT_FLG, 'N') = 'N'
              )
        AND BQ.DEST_TRNS_MOD_CD IN ( 'R', 'A' )
        )
    OR   (
          BQ.SVC_SCP_CD    <> 'TPW'
        AND BQ.POR_CNT_CD    = 'US'
        AND BQ.POL_CD      IN ( 'USNYC', 'USSAV', 'USCHS', 'USORF', 'USBOS' )
        AND EXISTS (
              SELECT 'X'
              FROM  PRD_INLND_ROUT_MST IR
              WHERE  IR.ROUT_ORG_NOD_CD    LIKE BQ.POR_CD||'%'
              AND   IR.ROUT_DEST_NOD_CD  LIKE BQ.POL_CD||'%'
              AND   IR.PCTL_IO_BND_CD   = 'O'
              AND   IR.HUB_NOD_CD     LIKE 'USLGB'||'%'
              AND   IR.INLND_ROUT_BKG_FLG = 'Y'
              AND   NVL(IR.DELT_FLG, 'N') = 'N'
              )
        AND BQ.ORG_TRNS_MOD_CD IN ( 'R', 'A' )
        )
    )

)

SELECT FN.QTTN_NO   AS QTTN_NO,
    FN.QTTN_VER_NO  AS QTTN_VER_NO,
    FN.GEN_SPCL_RT_TP_CD AS GEN_SPCL_RT_TP_CD,
    FN.CMDT_HDR_SEQ AS CMDT_HDR_SEQ,
    FN.ROUT_SEQ     AS ROUT_SEQ,
    FN.RT_SEQ       AS RT_SEQ,
    FN.CHG_CD       AS CHG_CD,
    FN.RAT_UT_CD    AS RAT_UT_CD,
    NVL(FN.CURR_CD, 'USD')      AS CURR_CD,
    NVL(CASE
    WHEN FN.RAT_UT_CD = 'PC' THEN NVL(F1.CHG_AMT, 0) * FN.RAT_AS_QTY / 100
    ELSE FN.CHG_AMT END, 0)             AS TRF_SCG_AMT  ,
    NVL(CASE
    WHEN FN.RAT_UT_CD = 'PC' THEN NVL(F1.CHG_AMT, 0) * FN.RAT_AS_QTY / 100
    ELSE FN.CHG_AMT END, 0)             AS ADJ_SCG_AMT  ,
    NVL(CASE
    WHEN FN.RAT_UT_CD = 'PC' THEN NVL(F1.CHG_AMT, 0) * FN.RAT_AS_QTY / 100
    ELSE FN.CHG_AMT
    END, 0) / DECODE(NVL(USD_LOCL_XCH_RT,0), 0, 1, USD_LOCL_XCH_RT) AS ADJ_SCG_USD_AMT 
FROM  FN ,
  (
    SELECT BQ_SEQ  ,
        CHG_CD    ,
        SUM(CHG_AMT) CHG_AMT
    FROM  (
        SELECT F1.BQ_SEQ ,
            F1.CHG_CD    ,
            F2.CHG_AMT CHG_AMT
        FROM  FN F1 ,
            FN F2
        WHERE  F2.BQ_SEQ = F1.BQ_SEQ
        AND   F2.CHG_CD    IN ( SELECT CHG_CD FROM PRI_SCG_PCT_BSE_CHG A WHERE A.PCT_BSE_CD = F1.PCT_BSE_CD AND SYSDATE BETWEEN EFF_DT AND EXP_DT )
        AND   F2.CURR_CD   = F1.CURR_CD
        AND   (
              F1.CHG_CD  <> 'VTT'
            OR	F2.CHG_CD	NOT IN ( DECODE(F1.POR_CNT_CD, 'VN', 'DTH', 'XXX'), DECODE(F1.POR_CNT_CD, 'VN', 'DDC', 'XXX'), DECODE(F1.DEL_CNT_CD, 'VN', 'OTH', 'XXX'), DECODE(F1.DEL_CNT_CD, 'VN', 'ORC', 'XXX') )
            )
        AND   F2.RAT_UT_CD  <> 'PC'
        AND   F1.RAT_UT_CD  = 'PC'
        UNION ALL
        SELECT F1.BQ_SEQ ,
            F1.CHG_CD    ,
            F2.QTTN_RT_AMT CHG_AMT
        FROM  FN F1 ,
              BQ F2
        WHERE  F2.BQ_SEQ = F1.BQ_SEQ
        AND   'OFT'   IN ( SELECT CHG_CD FROM PRI_SCG_PCT_BSE_CHG A WHERE A.PCT_BSE_CD = F1.PCT_BSE_CD AND SYSDATE BETWEEN EFF_DT AND EXP_DT )
        AND   F2.CURR_CD   = F1.CURR_CD
        AND   F2.CTRT_CNTR_TPSZ_CD <> 'PC'
        AND   F1.RAT_UT_CD     = 'PC'
        )
    GROUP BY
        BQ_SEQ  ,
        CHG_CD
    ) F1,
    (SELECT USD_LOCL_XCH_RT AS USD_LOCL_XCH_RT, CURR_CD FROM GL_MON_XCH_RT
      WHERE ACCT_XCH_RT_YRMON = LEAST(TO_CHAR(SYSDATE, 'YYYYMM'), ( SELECT MAX(ACCT_XCH_RT_YRMON) FROM GL_MON_XCH_RT )) 
        AND ACCT_XCH_RT_LVL  = '1' ) XR    
WHERE  F1.BQ_SEQ(+) = FN.BQ_SEQ
AND   F1.CHG_CD(+)  = FN.CHG_CD
AND   XR.CURR_CD(+) = FN.CURR_CD 
AND   FN.CHG_CD NOT IN ( 'GRI', 'GOH', 'WHF', 'GST', 'AST', 'VDT', 'VTT', 'WSC' )
AND  (CASE WHEN FN.SVC_SCP_CD IN ( 'ACW','MXW','TAE','TPW' ) AND FN.CHG_CD = 'CAF' THEN 'N'
           WHEN FN.SVC_SCP_CD IN ( 'ASE','ASW','TAE','TAW','TPE','TPW' ) AND FN.CHG_CD = 'CUC' THEN 'N'
           WHEN FN.SVC_SCP_CD IN ( 'TPE','MXE','ACE' ) AND FN.CHG_CD = 'DDC' THEN 'N' 
           WHEN FN.SVC_SCP_CD IN ( 'TPE','MXE','ACE' ) AND FN.CHG_CD = 'EPS' THEN 'N'
           WHEN FN.SVC_SCP_CD IN ( 'TPE','MXE','ACE' ) AND FN.CHG_CD = 'ERC' THEN 'N'
           ELSE 'Y' END ) = 'Y'

) B
ON (    A.QTTN_NO = B.QTTN_NO
    AND A.QTTN_VER_NO = B.QTTN_VER_NO
    AND A.GEN_SPCL_RT_TP_CD = B.GEN_SPCL_RT_TP_CD
    AND A.CMDT_HDR_SEQ = B.CMDT_HDR_SEQ
    AND A.ROUT_SEQ = B.ROUT_SEQ
    AND A.RT_SEQ = B.RT_SEQ
    AND A.CHG_CD = B.CHG_CD     )  
WHEN MATCHED THEN
UPDATE SET A.TRF_SCG_AMT =  B.TRF_SCG_AMT,
		   A.UPD_USR_ID = @[upd_usr_id],
		   A.UPD_DT = SYSDATE
    
WHEN NOT MATCHED THEN

INSERT 
    (A.QTTN_NO, A.QTTN_VER_NO, A.GEN_SPCL_RT_TP_CD, A.CMDT_HDR_SEQ, A.ROUT_SEQ, A.RT_SEQ,
    A.CHG_CD, A.BKG_RAT_UT_CD, A.CURR_CD, A.TRF_SCG_AMT, A.ADJ_SCG_AMT, A.ADJ_SCG_USD_AMT, A.TRF_SCG_RMK, 
    A.TRF_ADJ_TP_CD, A.ADJ_FLG, A.CRE_USR_ID, A.CRE_DT, A.UPD_USR_ID, A.UPD_DT )
VALUES 
    (B.QTTN_NO, B.QTTN_VER_NO, B.GEN_SPCL_RT_TP_CD, B.CMDT_HDR_SEQ, B.ROUT_SEQ, B.RT_SEQ,
    B.CHG_CD, B.RAT_UT_CD, B.CURR_CD, B.TRF_SCG_AMT, B.ADJ_SCG_AMT, B.ADJ_SCG_USD_AMT, NULL,
    'T', 'N', @[upd_usr_id], SYSDATE, @[upd_usr_id], SYSDATE )			]]></sql>
			<params>
				<param name="qttn_no" type="12" value="" out="N"/>
				<param name="qttn_ver_no" type="12" value="" out="N"/>
				<param name="gen_spcl_rt_tp_cd" type="12" value="" out="N"/>
				<param name="cmdt_hdr_seq" type="2" value="" out="N"/>
				<param name="rout_seq" type="12" value="" out="N"/>
				<param name="rt_seq" type="12" value="" out="N"/>
				<param name="upd_usr_id" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
