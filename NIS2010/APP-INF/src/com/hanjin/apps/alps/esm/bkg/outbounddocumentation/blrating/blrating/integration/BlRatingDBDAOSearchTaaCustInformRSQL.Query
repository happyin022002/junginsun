<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BlRatingDBDAOSearchTaaCustInformRSQL">
			<desc><![CDATA[BlRatingDBDAOSearchTaaCustInform - TAA Customer 정보 조회]]></desc>
			<sql><![CDATA[
#if (${ca_flg} == 'Y') 
SELECT 
	BKG_NO ,
	MAX(DECODE(BKG_CUST_TP_CD,'S',CUST_CNT_CD,'')) S_CUST_CNT_CD,
	MAX(DECODE(BKG_CUST_TP_CD,'S',CUST_SEQ,'')) S_CUST_SEQ,
	MAX(DECODE(BKG_CUST_TP_CD,'S',CUST_NM,'')) S_CUST_NM,
	MAX(DECODE(BKG_CUST_TP_CD,'C',CUST_CNT_CD,'')) C_CUST_CNT_CD,
	MAX(DECODE(BKG_CUST_TP_CD,'C',CUST_SEQ,'')) C_CUST_SEQ,
	MAX(DECODE(BKG_CUST_TP_CD,'C',CUST_NM,'')) C_CUST_NM,
	MAX(DECODE(BKG_CUST_TP_CD,'N',CUST_CNT_CD,'')) N_CUST_CNT_CD,
	MAX(DECODE(BKG_CUST_TP_CD,'N',CUST_SEQ,'')) N_CUST_SEQ,
	MAX(DECODE(BKG_CUST_TP_CD,'N',CUST_NM,'')) N_CUST_NM,
	MAX(DECODE(BKG_CUST_TP_CD,'A',CUST_CNT_CD,'')) A_CUST_CNT_CD,
	MAX(DECODE(BKG_CUST_TP_CD,'A',CUST_SEQ,'')) A_CUST_SEQ,
	MAX(DECODE(BKG_CUST_TP_CD,'A',CUST_NM,'')) A_CUST_NM,
	MAX(DECODE(BKG_CUST_TP_CD,'P',CUST_CNT_CD,'')) P_CUST_CNT_CD,
	MAX(DECODE(BKG_CUST_TP_CD,'P',CUST_SEQ,'')) P_CUST_SEQ,
	MAX(DECODE(BKG_CUST_TP_CD,'P',CUST_NM,'')) P_CUST_NM
FROM (
	SELECT 
		BKG_NO
		,BKG_CUST_TP_CD
		,CUST_CNT_CD
		,CUST_SEQ
		,CUST_NM
	FROM 
		BKG_CUST_HIS 
	WHERE 
		BKG_NO= @[bkg_no]
		AND BKG_CUST_TP_CD IN ('S','C','N','A')
		AND CORR_NO ='TMP0000001'
	UNION ALL 
	SELECT
		@[bkg_no] AS BKG_NO,
		'P' BKG_CUST_TP_CD,
		MN.CTRT_CUST_CNT_CD CUST_CNT_CD ,MN.CTRT_CUST_SEQ CUST_SEQ,
        (SELECT CUST_LGL_ENG_NM FROM MDM_CUSTOMER 
         WHERE CUST_CNT_CD = MN.CTRT_CUST_CNT_CD
           AND CUST_SEQ = MN.CTRT_CUST_SEQ) CUST_NM
	 FROM PRI_TAA_MN MN, PRI_TAA_HDR HDR
	 WHERE 1=1
	   AND HDR.TAA_NO =@[taa_no] -- KEY가 TAA NO 가 아니네? 
	   AND MN.TAA_PROP_NO = HDR.TAA_PROP_NO
	   AND MN.CFM_FLG = 'Y'
	   AND MN.AMDT_SEQ = (SELECT MAX(K.AMDT_SEQ) 
    	                  FROM PRI_TAA_MN K, PRI_TAA_HDR HD
        	              WHERE 1=1
            	            AND HD.TAA_NO =@[taa_no] -- KEY가 TAA NO 가 아니네? 
                	        AND K.TAA_PROP_NO = HD.TAA_PROP_NO
                    	    AND MN.CFM_FLG = 'Y' )
	)
GROUP BY BKG_NO
#else
SELECT 
	BKG_NO ,
	MAX(DECODE(BKG_CUST_TP_CD,'S',CUST_CNT_CD,'')) S_CUST_CNT_CD,
	MAX(DECODE(BKG_CUST_TP_CD,'S',CUST_SEQ,'')) S_CUST_SEQ,
	MAX(DECODE(BKG_CUST_TP_CD,'S',CUST_NM,'')) S_CUST_NM,
	MAX(DECODE(BKG_CUST_TP_CD,'C',CUST_CNT_CD,'')) C_CUST_CNT_CD,
	MAX(DECODE(BKG_CUST_TP_CD,'C',CUST_SEQ,'')) C_CUST_SEQ,
	MAX(DECODE(BKG_CUST_TP_CD,'C',CUST_NM,'')) C_CUST_NM,
	MAX(DECODE(BKG_CUST_TP_CD,'N',CUST_CNT_CD,'')) N_CUST_CNT_CD,
	MAX(DECODE(BKG_CUST_TP_CD,'N',CUST_SEQ,'')) N_CUST_SEQ,
	MAX(DECODE(BKG_CUST_TP_CD,'N',CUST_NM,'')) N_CUST_NM,
	MAX(DECODE(BKG_CUST_TP_CD,'A',CUST_CNT_CD,'')) A_CUST_CNT_CD,
	MAX(DECODE(BKG_CUST_TP_CD,'A',CUST_SEQ,'')) A_CUST_SEQ,
	MAX(DECODE(BKG_CUST_TP_CD,'A',CUST_NM,'')) A_CUST_NM,
	MAX(DECODE(BKG_CUST_TP_CD,'P',CUST_CNT_CD,'')) P_CUST_CNT_CD,
	MAX(DECODE(BKG_CUST_TP_CD,'P',CUST_SEQ,'')) P_CUST_SEQ,
	MAX(DECODE(BKG_CUST_TP_CD,'P',CUST_NM,'')) P_CUST_NM
FROM (
	SELECT 
		BKG_NO
		,BKG_CUST_TP_CD
		,CUST_CNT_CD
		,CUST_SEQ
		,CUST_NM
	FROM 
		BKG_CUSTOMER
	WHERE 
		BKG_NO= @[bkg_no]
		AND BKG_CUST_TP_CD IN ('S','C','N','A')
	UNION ALL 
	SELECT
		@[bkg_no] AS BKG_NO,
		'P' BKG_CUST_TP_CD,
		MN.CTRT_CUST_CNT_CD CUST_CNT_CD ,MN.CTRT_CUST_SEQ CUST_SEQ,
        (SELECT CUST_LGL_ENG_NM FROM MDM_CUSTOMER 
         WHERE CUST_CNT_CD = MN.CTRT_CUST_CNT_CD
           AND CUST_SEQ = MN.CTRT_CUST_SEQ) CUST_NM
	 FROM PRI_TAA_MN MN, PRI_TAA_HDR HDR
	 WHERE 1=1
	   AND HDR.TAA_NO =@[taa_no] -- KEY가 TAA NO 가 아니네? 
	   AND MN.TAA_PROP_NO = HDR.TAA_PROP_NO
	   AND MN.CFM_FLG = 'Y'
	   AND MN.AMDT_SEQ = (SELECT MAX(K.AMDT_SEQ) 
    	                  FROM PRI_TAA_MN K, PRI_TAA_HDR HD
        	              WHERE 1=1
            	            AND HD.TAA_NO =@[taa_no] -- KEY가 TAA NO 가 아니네? 
                	        AND K.TAA_PROP_NO = HD.TAA_PROP_NO
                    	    AND MN.CFM_FLG = 'Y' )
	)
GROUP BY BKG_NO
#end			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="taa_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
