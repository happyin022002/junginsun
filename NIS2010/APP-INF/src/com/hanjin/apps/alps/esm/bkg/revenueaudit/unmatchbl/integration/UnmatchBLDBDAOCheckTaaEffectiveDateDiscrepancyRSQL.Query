<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="UnmatchBLDBDAOCheckTaaEffectiveDateDiscrepancyRSQL">
			<desc><![CDATA[checkTaaEffectiveDateDiscrepancy]]></desc>
			<sql><![CDATA[
WITH
TA AS
(
/*******************************************************************************************
계약 정보 조회
*******************************************************************************************/

SELECT  TM.TAA_PROP_NO  PROP_NO ,
        TM.AMDT_SEQ             ,
        TM.SVC_SCP_CD
FROM    BKG_BOOKING     BK  ,
        MDM_LOCATION    L1  ,
        MDM_LOCATION    L4  ,
        PRI_TAA_HDR     TH  ,
        PRI_TAA_MN      TM
WHERE   L1.LOC_CD       = BK.POR_CD
AND     L4.LOC_CD       = BK.DEL_CD
AND     TH.TAA_NO       = BK.TAA_NO
AND     TM.TAA_PROP_NO  = TH.TAA_PROP_NO
AND     TM.SVC_SCP_CD   IN (BK.SVC_SCP_CD, DECODE(BK.SVC_SCP_CD, 'ACE','TPE','MXE','TPE'))
AND     TM.CFM_FLG      = 'Y'       -- CONFIRMED TAA
AND     ( SELECT BKG_REV_APLY_DT_PKG.BKG_GET_REV_APLY_DT_FNC(@[bkg_no], @[ca_flg]) FROM DUAL )
        BETWEEN TM.EFF_DT AND TM.EXP_DT
AND     BK.BKG_NO       = @[bkg_no]
AND     @[ca_flg]       = 'N'

UNION ALL

SELECT  TM.TAA_PROP_NO  PROP_NO ,
        TM.AMDT_SEQ             ,
        TM.SVC_SCP_CD
FROM    BKG_BKG_HIS     BK  ,
        MDM_LOCATION    L1  ,
        MDM_LOCATION    L4  ,
        PRI_TAA_HDR     TH  ,
        PRI_TAA_MN      TM
WHERE   L1.LOC_CD       = BK.POR_CD
AND     L4.LOC_CD       = BK.DEL_CD
AND     TH.TAA_NO       = BK.TAA_NO
AND     TM.TAA_PROP_NO  = TH.TAA_PROP_NO
AND     TM.SVC_SCP_CD   IN (BK.SVC_SCP_CD, DECODE(BK.SVC_SCP_CD, 'ACE','TPE','MXE','TPE'))
AND     TM.CFM_FLG      = 'Y'       -- CONFIRMED TAA
AND     ( SELECT BKG_REV_APLY_DT_PKG.BKG_GET_REV_APLY_DT_FNC(@[bkg_no], @[ca_flg]) FROM DUAL )
        BETWEEN TM.EFF_DT AND TM.EXP_DT
AND     BK.BKG_NO       = @[bkg_no]
AND     BK.CORR_NO      = 'TMP0000001'  -- CORRECTION 중인 DATA 를 나타내는 고정된 상수값
AND     @[ca_flg]       = 'Y'
) ,
BK AS
(
/*******************************************************************************************
BKG 정보 조회
*******************************************************************************************/

SELECT  BK.TAA_NO      ,
        BK.SVC_SCP_CD  ,
        BKG_REV_APLY_DT_PKG.BKG_GET_REV_APLY_TP_FNC (@[bkg_no], @[ca_flg])  REV_APLY_TP_CD  ,
        BKG_REV_APLY_DT_PKG.BKG_GET_RT_APLY_DT_FNC  (@[bkg_no], @[ca_flg])  RT_APLY_DT      ,
        BKG_REV_APLY_DT_PKG.BKG_GET_CGO_RCV_DT_FNC  (@[bkg_no], @[ca_flg])  CGO_RCV_DT      ,
        BKG_REV_APLY_DT_PKG.BKG_GET_ETD_DT_FNC      (@[bkg_no], @[ca_flg])  POL_ETD_DT      ,
        BKG_REV_APLY_DT_PKG.BKG_GET_ETB_DT_FNC      (@[bkg_no], @[ca_flg])  POL_ETB_DT
FROM    BKG_BOOKING BK
WHERE   BK.BKG_NO   = @[bkg_no]
AND     @[ca_flg]   = 'N'

UNION ALL

SELECT  BK.TAA_NO      ,
        BK.SVC_SCP_CD  ,
        BKG_REV_APLY_DT_PKG.BKG_GET_REV_APLY_TP_FNC (@[bkg_no], @[ca_flg])  REV_APLY_TP_CD  ,
        BKG_REV_APLY_DT_PKG.BKG_GET_RT_APLY_DT_FNC  (@[bkg_no], @[ca_flg])  RT_APLY_DT      ,
        BKG_REV_APLY_DT_PKG.BKG_GET_CGO_RCV_DT_FNC  (@[bkg_no], @[ca_flg])  CGO_RCV_DT      ,
        BKG_REV_APLY_DT_PKG.BKG_GET_ETD_DT_FNC      (@[bkg_no], @[ca_flg])  POL_ETD_DT      ,
        BKG_REV_APLY_DT_PKG.BKG_GET_ETB_DT_FNC      (@[bkg_no], @[ca_flg])  POL_ETB_DT
FROM    BKG_BKG_HIS BK
WHERE   BK.BKG_NO   = @[bkg_no]
AND     BK.CORR_NO  = 'TMP0000001'  -- CORRECTION 중인 DATA 를 나타내는 고정된 상수값
AND     @[ca_flg]   = 'Y'
) ,
C1 AS
(
SELECT  '[CRD][' || TO_CHAR(BK.CGO_RCV_DT, 'YYYY-MM-DD') || ']' BKG_ITM_LOG   ,
        '[Effective Date][' || TO_CHAR(SD.CTRT_EFF_DT, 'YYYY-MM-DD') || ']' || CHR(10) || '[Expiration Date][' || TO_CHAR(SD.CTRT_EXP_DT, 'YYYY-MM-DD') || ']'  CTRT_ITM_LOG
FROM    BK  ,
        (
        /* TAA Duration */
        SELECT  TM.EFF_DT CTRT_EFF_DT ,
                TM.EXP_DT CTRT_EXP_DT
        FROM    TA  ,
                PRI_TAA_MN  TM
        WHERE   TM.TAA_PROP_NO  = TA.PROP_NO
        AND     TM.AMDT_SEQ     = TA.AMDT_SEQ
        AND     TM.SVC_SCP_CD   = TA.SVC_SCP_CD
        ) SD
WHERE   CASE
        WHEN  NVL(BK.CGO_RCV_DT, SD.CTRT_EFF_DT) BETWEEN SD.CTRT_EFF_DT AND SD.CTRT_EXP_DT
          THEN  'Y'
        ELSE  'N'
        END
        = 'N'

UNION ALL

SELECT  '[CRD][' || TO_CHAR(BK.CGO_RCV_DT, 'YYYY-MM-DD') || ']' BKG_ITM_LOG   ,
        '[Effective Date][' || TO_CHAR(SD.CTRT_EFF_DT, 'YYYY-MM-DD') || ']' || CHR(10) || '[Expiration Date][' || TO_CHAR(SD.CTRT_EXP_DT, 'YYYY-MM-DD') || ']'  CTRT_ITM_LOG
FROM    BK  ,
        (
        SELECT  TM.EFF_DT CTRT_EFF_DT ,
                TM.EXP_DT CTRT_EXP_DT ,
                ROW_NUMBER() OVER ( ORDER BY TM.AMDT_SEQ DESC )  ROW_NUMBER
        FROM    BK  ,
                PRI_TAA_HDR     TH  ,
                PRI_TAA_MN      TM
        WHERE   TH.TAA_NO       = BK.TAA_NO
        AND     TM.TAA_PROP_NO  = TH.TAA_PROP_NO
        AND     TM.SVC_SCP_CD   = BK.SVC_SCP_CD
        ) SD
WHERE   NOT EXISTS  ( SELECT 'X' FROM TA )
AND     SD.ROW_NUMBER = 1
) ,
C2 AS
(
SELECT  '[CRD][' || TO_CHAR(BK.CGO_RCV_DT, 'YYYY-MM-DD') || ']' || CHR(10) || '[Application Date][' || TO_CHAR(BK.RT_APLY_DT, 'YYYY-MM-DD') || ']'  BKG_ITM_LOG   ,
        NULL  CTRT_ITM_LOG
FROM    BK
WHERE   CASE
        WHEN  NVL(BK.CGO_RCV_DT, BK.RT_APLY_DT) = BK.RT_APLY_DT
          THEN  'Y'
        ELSE  'N'
        END
        = 'N'
)
SELECT  'A1'   UMCH_TP_CD      ,
        C1.BKG_ITM_LOG BKG_ITM_LOG     ,
        C1.CTRT_ITM_LOG CTRT_ITM_LOG    ,
        'U'   MTCH_UMCH_TP_CD ,
        ( SELECT UMCH_TP_DESC FROM BKG_REV_UMCH_TP WHERE UMCH_TP_CD = 'A1' ) UMCH_TP_DESC  ,
        ( SELECT INTG_CD_VAL_DP_DESC FROM COM_INTG_CD_DTL WHERE INTG_CD_ID = 'CD02456' AND INTG_CD_VAL_CTNT = 'U' ) MTCH_UMCH_TP_DESC
FROM    C1
        LEFT OUTER JOIN C2 ON 1 = 1

/*******************************************************************************************
CO-BIZ은 대상에서 제외한다.
*******************************************************************************************/
WHERE  (
        SELECT  NVL(RT_BL_TP_CD, 'N')
        FROM    BKG_RATE
        WHERE   BKG_NO        = @[bkg_no]
        AND     @[ca_flg]     = 'N'
        UNION ALL
        SELECT  NVL(RT_BL_TP_CD, 'N')
        FROM    BKG_RT_HIS
        WHERE   BKG_NO        = @[bkg_no]
        AND     CORR_NO       = 'TMP0000001'  -- CORRECTION 중인 DATA 를 나타내는 고정된 상수값
        AND     @[ca_flg]     = 'Y'
        )
        NOT IN ( 'B' )			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="ca_flg" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
