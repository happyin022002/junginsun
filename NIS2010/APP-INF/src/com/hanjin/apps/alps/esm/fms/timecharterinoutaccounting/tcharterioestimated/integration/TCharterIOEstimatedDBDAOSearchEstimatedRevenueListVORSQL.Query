<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TCharterIOEstimatedDBDAOSearchEstimatedRevenueListVORSQL">
			<desc><![CDATA[   ]]></desc>
			<sql><![CDATA[
-- 첫번째 UNION ALL (TI 조회)  
SELECT 'I' ibflag,
		@[to_duration] EXE_YRMON, A.REV_YRMON, A.REV_YRMON||A.FLET_CTRT_TP_CD SUBSUMCOL,
       A.FLET_CTRT_TP_CD,
       A.RLANE_CD, A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD||A.REV_DIR_CD VVD_CD,
       A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD,
       A.VST_DT, A.VED_DT,
       B.HIRE_AMT,
       SUM(B.EST_AMT) EST_AMT,
       SUM(NVL(C.ACT_AMT,0)+NVL(D.AMOUNT,0)) ACT_AMT,
       CASE WHEN NVL(E.FLET_ACCL_AMT, 0) = 0
          THEN 
              CASE WHEN SUM(B.EST_AMT) - SUM(NVL(C.ACT_AMT,0)+NVL(D.AMOUNT,0))  < 0
                THEN 0  
                ELSE SUM(B.EST_AMT) - SUM(NVL(C.ACT_AMT,0)+NVL(D.AMOUNT,0))   
              END
          ELSE E.ACCL_AMT
        END ACC_AMT,
        
       TO_CHAR(E.FLET_ACCL_AMT) FLET_ACCL_AMT

FROM
		(SELECT DISTINCT A.REV_YRMON,
		        B.FLET_CTRT_NO, B.FLET_CTRT_TP_CD,
		        A.RLANE_CD, A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD||A.REV_DIR_CD VVD_CD,
		        A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD,
		        A.VST_DT, A.VED_DT
		FROM 	FMS_VVD A,
				(SELECT VSL_CD, FLET_CTRT_NO, FLET_CTRT_TP_CD 
                   FROM FMS_CONTRACT
				  WHERE FLET_CTRT_TP_CD = 'TI' 
                    AND FLET_CTRT_TP_CD LIKE @[flet_ctrt_tp_cd]||'%' 
                    AND FLET_CTRT_FACT_CD = 'ACT'
				 UNION ALL
				 SELECT FI.VSL_CD, FC.FLET_CTRT_NO, FLET_CTRT_TP_CD 
                   FROM FMS_CONTRACT FC, FMS_ID_VSL FI
				  WHERE FC.FLET_CTRT_NO = FI.FLET_CTRT_NO 
                    AND FC.FLET_CTRT_TP_CD = 'TI' 
                    AND FC.FLET_CTRT_TP_CD LIKE @[flet_ctrt_tp_cd]||'%' 
                    AND FC.FLET_CTRT_FACT_CD = 'ACT') B
		WHERE 	A.VSL_CD = B.VSL_CD
		  AND 	A.REV_YRMON BETWEEN @[fr_duration] AND @[to_duration]
		) A,
			(SELECT VSL_CD, SKD_VOY_NO, SKD_DIR_CD, REV_DIR_CD, REV_YRMON,
					FLET_CTRT_NO,  MIN(HIRE_EFF_DT) HIRE_EFF_DT,MAX(HIRE_EXP_DT) HIRE_EXP_DT,
					MIN(HIRE_N1ST_AMT + HIRE_N2ND_AMT) HIRE_AMT,
					SUM(DAYS*(HIRE_N1ST_AMT + HIRE_N2ND_AMT)) EST_AMT
			 FROM (
                SELECT  A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD, A.REV_YRMON, A.FLET_CTRT_NO, A.HIRE_EFF_DT,
                               CASE WHEN A.RN = 1 AND A.CNT > 1 THEN A.HIRE_EXP_DT -1 ELSE A.HIRE_EXP_DT END AS HIRE_EXP_DT,
                               CASE WHEN A.RN = 1 AND A.CNT > 1 THEN A.HIRE_EXP_DT -1 ELSE A.HIRE_EXP_DT END - A.HIRE_EFF_DT + 1 AS DAYS,
                               A.HIRE_N1ST_AMT, A.HIRE_N2ND_AMT
                FROM (
					SELECT  A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD, A.REV_YRMON,
							C.FLET_CTRT_NO,
							CASE WHEN A.VST_DT >= TO_CHAR(C.EFF_DT,'YYYYMMDD') THEN TO_DATE(A.VST_DT, 'YYYYMMDD') ELSE TRUNC(C.EFF_DT) END HIRE_EFF_DT,
							CASE WHEN A.VED_DT > TO_CHAR(C.EXP_DT,'YYYYMMDD') THEN TRUNC(C.EXP_DT)-1 ELSE TO_DATE(A.VED_DT, 'YYYYMMDD') END HIRE_EXP_DT,
                            ROW_NUMBER() OVER (PARTITION BY A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD, A.REV_YRMON, C.FLET_CTRT_NO, CASE WHEN A.VED_DT > TO_CHAR(C.EXP_DT,'YYYYMMDD') THEN TRUNC(C.EXP_DT)-1 ELSE TO_DATE(A.VED_DT, 'YYYYMMDD') END ORDER BY CASE WHEN A.VST_DT >= TO_CHAR(C.EFF_DT,'YYYYMMDD') THEN TO_DATE(A.VST_DT, 'YYYYMMDD') ELSE TRUNC(C.EFF_DT) END) AS RN,
                                COUNT(1) OVER(PARTITION BY A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD, A.REV_YRMON, C.FLET_CTRT_NO, CASE WHEN A.VED_DT > TO_CHAR(C.EXP_DT,'YYYYMMDD') THEN TRUNC(C.EXP_DT)-1 ELSE TO_DATE(A.VED_DT, 'YYYYMMDD') END) AS CNT,
						    CASE WHEN SUBSTR(TO_CHAR(FIRST_VALUE(C.EXP_DT) OVER(PARTITION BY C.FLET_CTRT_NO, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD ORDER BY C.EXP_DT),'YYYYMMDDHH24MISS'),9,4) = '0000' AND C.HIR_CURR_N2ND_CD IS NULL THEN
									  NVL(C.HIR_RT_N1ST_AMT/DECODE(C.HIR_CURR_N1ST_CD, 'USD', 1, (SELECT NVL(EX1.USD_LOCL_XCH_RT,1) FROM GL_MON_XCH_RT EX1
																									WHERE C.HIR_CURR_N1ST_CD = EX1.CURR_CD AND EX1.ACCT_XCH_RT_YRMON = A.REV_YRMON AND EX1.ACCT_XCH_RT_LVL = '3')),0)
								 ELSE
									  FIRST_VALUE(NVL(C.HIR_RT_N1ST_AMT/DECODE(C.HIR_CURR_N1ST_CD, 'USD', 1, (SELECT NVL(EX1.USD_LOCL_XCH_RT,1) FROM GL_MON_XCH_RT EX1
																											   WHERE C.HIR_CURR_N1ST_CD = EX1.CURR_CD AND EX1.ACCT_XCH_RT_YRMON = A.REV_YRMON AND EX1.ACCT_XCH_RT_LVL = '3')),0))
																			OVER(PARTITION BY C.FLET_CTRT_NO, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD, C.EXP_DT ORDER BY C.EXP_DT DESC)
							 END HIRE_N1ST_AMT,
							CASE WHEN SUBSTR(TO_CHAR(FIRST_VALUE(C.EXP_DT) OVER(PARTITION BY C.FLET_CTRT_NO, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD ORDER BY C.EXP_DT),'YYYYMMDDHH24MISS'),9,4) = '0000' AND C.HIR_CURR_N2ND_CD IS NULL THEN
									  NVL(C.HIR_RT_N2ND_AMT/DECODE(C.HIR_CURR_N2ND_CD, 'USD', 1, (SELECT NVL(EX1.USD_LOCL_XCH_RT,1) FROM GL_MON_XCH_RT EX1
																									WHERE C.HIR_CURR_N2ND_CD = EX1.CURR_CD AND EX1.ACCT_XCH_RT_YRMON = A.REV_YRMON AND EX1.ACCT_XCH_RT_LVL = '3')),0)
								 ELSE
									  FIRST_VALUE(NVL(C.HIR_RT_N2ND_AMT/DECODE(C.HIR_CURR_N2ND_CD, 'USD', 1, (SELECT NVL(EX1.USD_LOCL_XCH_RT,1) FROM GL_MON_XCH_RT EX1
																											   WHERE C.HIR_CURR_N2ND_CD = EX1.CURR_CD AND EX1.ACCT_XCH_RT_YRMON = A.REV_YRMON AND EX1.ACCT_XCH_RT_LVL = '3')),0))
																			OVER(PARTITION BY C.FLET_CTRT_NO, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD, C.EXP_DT ORDER BY C.EXP_DT DESC)
							 END HIRE_N2ND_AMT
					FROM 	FMS_VVD A, (SELECT VSL_CD, FLET_CTRT_NO, FLET_CTRT_TP_CD FROM FMS_CONTRACT
										WHERE FLET_CTRT_TP_CD = 'TI' AND FLET_CTRT_TP_CD LIKE @[flet_ctrt_tp_cd]||'%' AND FLET_CTRT_FACT_CD = 'ACT'
										UNION ALL
										SELECT FI.VSL_CD, FC.FLET_CTRT_NO, FLET_CTRT_TP_CD FROM FMS_CONTRACT FC, FMS_ID_VSL FI
										WHERE FC.FLET_CTRT_NO = FI.FLET_CTRT_NO AND FC.FLET_CTRT_TP_CD = 'TI' AND FC.FLET_CTRT_TP_CD LIKE @[flet_ctrt_tp_cd]||'%' AND FC.FLET_CTRT_FACT_CD = 'ACT') B,
							FMS_HIRE C
					WHERE 	A.VSL_CD = B.VSL_CD
					  AND 	B.FLET_CTRT_NO = C.FLET_CTRT_NO
					  --AND 	A.VST_DT <= TO_CHAR(C.EXP_DT,'YYYYMMDD') 
					  AND   A.VST_DT <= TO_CHAR(DECODE(DECODE(TO_NUMBER(SUBSTR(TO_CHAR(C.EXP_DT, 'YYYYMMDDHH24MI'), 9)), 0, 'A', 'B'), 'A', C.EXP_DT - 1, C.EXP_DT),'YYYYMMDD')
					  AND 	A.VED_DT >= TO_CHAR(C.EFF_DT,'YYYYMMDD')
					  AND 	A.REV_YRMON BETWEEN @[fr_duration] AND @[to_duration]
              ) A
            )
            WHERE DAYS > 0  -- 추가
			GROUP BY VSL_CD, SKD_VOY_NO, SKD_DIR_CD, REV_DIR_CD, REV_YRMON, FLET_CTRT_NO
			) B,
            (SELECT A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD, A.REV_YRMON,
            		B.FLET_CTRT_NO,
					SUM(FS.CSR_AMT/DECODE(FS.CSR_CURR_CD, 'USD', 1, (SELECT NVL(EX1.USD_LOCL_XCH_RT,1)
                                                                       FROM GL_MON_XCH_RT EX1
																	  WHERE FS.CSR_CURR_CD = EX1.CURR_CD AND EX1.ACCT_XCH_RT_YRMON =  SUBSTR(FC.EFF_DT,1,6)  AND EX1.ACCT_XCH_RT_LVL = '3'))) ACT_AMT,
					MIN(FS.VVD_EFF_DT) SLP_EFF_DT, MAX(FS.VVD_EXP_DT) SLP_EXP_DT
			   FROM FMS_VVD A, (SELECT VSL_CD, FLET_CTRT_NO 
                                  FROM FMS_CONTRACT
								 WHERE FLET_CTRT_TP_CD = 'TI' 
                                   AND FLET_CTRT_TP_CD LIKE @[flet_ctrt_tp_cd]||'%' 
                                   AND FLET_CTRT_FACT_CD = 'ACT'
								 UNION ALL
								 SELECT FI.VSL_CD, FC.FLET_CTRT_NO 
                                   FROM FMS_CONTRACT FC, FMS_ID_VSL FI
								  WHERE FC.FLET_CTRT_NO = FI.FLET_CTRT_NO 
                                    AND FC.FLET_CTRT_TP_CD = 'TI' 
                                    AND FC.FLET_CTRT_TP_CD LIKE @[flet_ctrt_tp_cd]||'%' 
                                    AND FC.FLET_CTRT_FACT_CD = 'ACT') B,
				 	FMS_CONSULTATION FC, FMS_CSUL_SLP FS
			WHERE 	A.VSL_CD = B.VSL_CD
			  AND 	B.FLET_CTRT_NO = FC.FLET_CTRT_NO
			  AND 	A.VST_DT <= TO_CHAR(FS.VVD_EXP_DT,'YYYYMMDD')
			  AND 	A.VED_DT >= TO_CHAR(FS.VVD_EFF_DT,'YYYYMMDD')
			  AND 	A.REV_YRMON BETWEEN @[fr_duration] AND @[to_duration]
			  AND 	FC.SLP_TP_CD = FS.SLP_TP_CD
			  AND 	FC.SLP_FUNC_CD = FS.SLP_FUNC_CD
			  AND 	FC.SLP_OFC_CD = FS.SLP_OFC_CD
			  AND 	FC.SLP_ISS_DT = FS.SLP_ISS_DT
			  AND 	FC.SLP_SER_NO = FS.SLP_SER_NO
			  AND 	A.VSL_CD = FS.VSL_CD
			  AND 	A.SKD_VOY_NO = FS.SKD_VOY_NO
			  AND 	A.SKD_DIR_CD = FS.SKD_DIR_CD
			  AND 	A.REV_DIR_CD = FS.REV_DIR_CD
			  AND 	FS.ACCT_CD = '510911'
			  AND 	FC.APRO_FLG = 'Y'
              AND   FC.CXL_FLG = 'N'
              AND   SUBSTR(FC.EFF_DT,1,6) BETWEEN @[fr_duration] AND @[to_duration]
			  AND 	NVL(FS.FLET_SRC_TP_CD,'%') LIKE DECODE(FS.SLP_FUNC_CD,'P','99','%')
			GROUP BY A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD, A.REV_YRMON, B.FLET_CTRT_NO) C,
			(SELECT VSL_CD,SKD_VOY_NO,SKD_DIR_CD,REV_DIR_CD, SUM(CSR_AMT) AMOUNT
			   FROM FMS_ESTM_IF
			  WHERE ACCT_CD = '510911'
			  GROUP BY VSL_CD,SKD_VOY_NO,SKD_DIR_CD,REV_DIR_CD) D, GL_ESTM_IF_ERP E
WHERE A.VSL_CD = B.VSL_CD
  AND A.SKD_VOY_NO = B.SKD_VOY_NO
  AND A.SKD_DIR_CD = B.SKD_DIR_CD
  AND A.REV_DIR_CD = B.REV_DIR_CD
  AND A.REV_YRMON = B.REV_YRMON
  AND A.FLET_CTRT_NO = B.FLET_CTRT_NO
  AND A.VSL_CD = C.VSL_CD(+)
  AND A.SKD_VOY_NO = C.SKD_VOY_NO(+)
  AND A.SKD_DIR_CD = C.SKD_DIR_CD(+)
  AND A.REV_DIR_CD = C.REV_DIR_CD(+)
  AND A.REV_YRMON = C.REV_YRMON(+)
  AND A.FLET_CTRT_NO = C.FLET_CTRT_NO(+)
  AND A.VSL_CD = D.VSL_CD(+)
  AND A.SKD_VOY_NO = D.SKD_VOY_NO(+)
  AND A.SKD_DIR_CD = D.SKD_DIR_CD(+)
  AND A.REV_DIR_CD = D.REV_DIR_CD(+)

  AND E.EXE_YRMON(+) =  TO_CHAR(ADD_MONTHS(TO_DATE(@[to_duration], 'YYYYMM'), -1), 'YYYYMM')
  AND E.SYS_SRC_ID(+) = 'CDA'
  AND A.VSL_CD     = E.VSL_CD(+)
  AND A.SKD_VOY_NO = E.SKD_VOY_NO(+)
  AND A.SKD_DIR_CD = E.SKD_DIR_CD(+)
  AND A.REV_DIR_CD = E.REV_DIR_CD(+)
  AND A.REV_YRMON  = E.REV_YRMON(+)
  AND E.ACCT_CD(+) = '510911'
  AND A.FLET_CTRT_TP_CD    = DECODE(E.ACCT_CD(+), '510911', 'TI', 'TO')
  AND E.ACCL_AMT(+) = 0
  AND E.FLET_ACCL_AMT(+) IS NOT NULL

GROUP BY A.REV_YRMON,
         A.FLET_CTRT_TP_CD,
         A.RLANE_CD,
         A.VSL_CD, 
		 A.SKD_VOY_NO, 
         A.SKD_DIR_CD, 
         A.REV_DIR_CD,
         A.VST_DT, 
         A.VED_DT,
         B.HIRE_AMT,
      E.ACCL_AMT,
      E.FLET_ACCL_AMT

-- 두번째 UNION ALL (TO 조회)
UNION ALL
SELECT 'I' ibflag,
		@[to_duration] EXE_YRMON, A.REV_YRMON, A.REV_YRMON||A.FLET_CTRT_TP_CD SUBSUMCOL,
       A.FLET_CTRT_TP_CD,
       A.RLANE_CD, A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD||A.REV_DIR_CD VVD_CD,
       A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD,
       A.VST_DT, A.VED_DT,
       B.HIRE_AMT,
       SUM(C.ACT_APPR_YAMT + C.ACT_APPR_NAMT) EST_AMT,
       SUM(C.ACT_APPR_YAMT) ACT_AMT,
       SUM(C.ACT_APPR_NAMT) ACC_AMT

	 ,  '' FLET_ACCL_AMT

FROM
		(SELECT DISTINCT A.REV_YRMON,
		       B.FLET_CTRT_NO, B.FLET_CTRT_TP_CD,
		       A.RLANE_CD, A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD||A.REV_DIR_CD VVD_CD,
		       A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD,
		       A.VST_DT, A.VED_DT
		FROM FMS_VVD A,
					(SELECT VSL_CD, FLET_CTRT_NO, FLET_CTRT_TP_CD 
                       FROM FMS_CONTRACT
					  WHERE FLET_CTRT_TP_CD = 'TO' 
                        AND FLET_CTRT_TP_CD LIKE @[flet_ctrt_tp_cd]||'%' 
                        AND FLET_CTRT_FACT_CD = 'ACT'
					 UNION ALL
					 SELECT FI.VSL_CD, FC.FLET_CTRT_NO, FLET_CTRT_TP_CD 
                       FROM FMS_CONTRACT FC, FMS_ID_VSL FI
					  WHERE FC.FLET_CTRT_NO = FI.FLET_CTRT_NO 
                        AND FC.FLET_CTRT_TP_CD = 'TO' 
                        AND FC.FLET_CTRT_TP_CD LIKE @[flet_ctrt_tp_cd]||'%' 
                        AND FC.FLET_CTRT_FACT_CD = 'ACT') B
		WHERE A.VSL_CD = B.VSL_CD
		  AND A.REV_YRMON BETWEEN @[fr_duration] AND @[to_duration]
		) A,
		(SELECT VSL_CD, SKD_VOY_NO, SKD_DIR_CD, REV_DIR_CD, REV_YRMON,
				FLET_CTRT_NO,
				MIN(HIRE_N1ST_AMT + HIRE_N2ND_AMT) HIRE_AMT
		 FROM (
				SELECT A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD, A.REV_YRMON,
						C.FLET_CTRT_NO,
						CASE WHEN SUBSTR(TO_CHAR(FIRST_VALUE(C.EXP_DT) OVER(PARTITION BY C.FLET_CTRT_NO, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD ORDER BY C.EXP_DT),'YYYYMMDDHH24MISS'),9,4) = '0000' AND C.HIR_CURR_N2ND_CD IS NULL THEN
								  NVL(C.HIR_RT_N1ST_AMT/DECODE(C.HIR_CURR_N1ST_CD, 'USD', 1, (SELECT NVL(EX1.USD_LOCL_XCH_RT,1) FROM GL_MON_XCH_RT EX1
																								WHERE C.HIR_CURR_N1ST_CD = EX1.CURR_CD AND EX1.ACCT_XCH_RT_YRMON = A.REV_YRMON AND EX1.ACCT_XCH_RT_LVL = '3')),0)
							 ELSE
								  FIRST_VALUE(NVL(C.HIR_RT_N1ST_AMT/DECODE(C.HIR_CURR_N1ST_CD, 'USD', 1, (SELECT NVL(EX1.USD_LOCL_XCH_RT,1) FROM GL_MON_XCH_RT EX1
																										   WHERE C.HIR_CURR_N1ST_CD = EX1.CURR_CD AND EX1.ACCT_XCH_RT_YRMON = A.REV_YRMON AND EX1.ACCT_XCH_RT_LVL = '3')),0))
																		OVER(PARTITION BY C.FLET_CTRT_NO, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD, C.EXP_DT ORDER BY C.EXP_DT DESC)
						 END HIRE_N1ST_AMT,
						CASE WHEN SUBSTR(TO_CHAR(FIRST_VALUE(C.EXP_DT) OVER(PARTITION BY C.FLET_CTRT_NO, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD ORDER BY C.EXP_DT),'YYYYMMDDHH24MISS'),9,4) = '0000' AND C.HIR_CURR_N2ND_CD IS NULL THEN
								  NVL(C.HIR_RT_N2ND_AMT/DECODE(C.HIR_CURR_N2ND_CD, 'USD', 1, (SELECT NVL(EX1.USD_LOCL_XCH_RT,1) FROM GL_MON_XCH_RT EX1
																								WHERE C.HIR_CURR_N2ND_CD = EX1.CURR_CD AND EX1.ACCT_XCH_RT_YRMON = A.REV_YRMON AND EX1.ACCT_XCH_RT_LVL = '3')),0)
							 ELSE
								  FIRST_VALUE(NVL(C.HIR_RT_N2ND_AMT/DECODE(C.HIR_CURR_N2ND_CD, 'USD', 1, (SELECT NVL(EX1.USD_LOCL_XCH_RT,1) FROM GL_MON_XCH_RT EX1
																										   WHERE C.HIR_CURR_N2ND_CD = EX1.CURR_CD AND EX1.ACCT_XCH_RT_YRMON = A.REV_YRMON AND EX1.ACCT_XCH_RT_LVL = '3')),0))
																		OVER(PARTITION BY C.FLET_CTRT_NO, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD, C.EXP_DT ORDER BY C.EXP_DT DESC)
						 END HIRE_N2ND_AMT
				FROM 	FMS_VVD A, (SELECT VSL_CD, FLET_CTRT_NO, FLET_CTRT_TP_CD 
                                      FROM FMS_CONTRACT
									 WHERE FLET_CTRT_TP_CD = 'TO' 
                                       AND FLET_CTRT_TP_CD LIKE @[flet_ctrt_tp_cd]||'%' 
                                       AND FLET_CTRT_FACT_CD = 'ACT'
									UNION ALL
									SELECT FI.VSL_CD, FC.FLET_CTRT_NO, FLET_CTRT_TP_CD 
                                      FROM FMS_CONTRACT FC, FMS_ID_VSL FI
									 WHERE FC.FLET_CTRT_NO = FI.FLET_CTRT_NO 
                                       AND FC.FLET_CTRT_TP_CD = 'TO' 
                                       AND FC.FLET_CTRT_TP_CD LIKE @[flet_ctrt_tp_cd]||'%' 
                                       AND FC.FLET_CTRT_FACT_CD = 'ACT') B,
						FMS_HIRE C
				WHERE 	A.VSL_CD = B.VSL_CD
				  AND 	B.FLET_CTRT_NO = C.FLET_CTRT_NO
				  --AND   A.VST_DT <= TO_CHAR(C.EXP_DT,'YYYYMMDD')
				  AND   A.VST_DT <= TO_CHAR(DECODE(DECODE(TO_NUMBER(SUBSTR(TO_CHAR(C.EXP_DT, 'YYYYMMDDHH24MI'), 9)), 0, 'A', 'B'), 'A', C.EXP_DT - 1, C.EXP_DT),'YYYYMMDD')
				  AND   A.VED_DT >= TO_CHAR(C.EFF_DT,'YYYYMMDD')
				  AND   A.REV_YRMON BETWEEN @[fr_duration] AND @[to_duration])
		GROUP BY VSL_CD, 
                 SKD_VOY_NO, 
                 SKD_DIR_CD, 
                 REV_DIR_CD, 
                 REV_YRMON,
				 FLET_CTRT_NO
		) B,
        (SELECT VSL_CD, SKD_VOY_NO, SKD_DIR_CD, REV_DIR_CD, REV_YRMON,
        	    FLET_CTRT_NO,
                INV_YAMT
                + (SELECT NVL(SUM(DECODE(FCH.APRO_FLG,'Y',FCD.CSR_AMT,0)/DECODE(FCD.CSR_CURR_CD, 'USD', 1, (SELECT NVL(EX1.USD_LOCL_XCH_RT,1) FROM GL_MON_XCH_RT EX1
																					WHERE FCD.CSR_CURR_CD = EX1.CURR_CD AND EX1.ACCT_XCH_RT_YRMON = AA.REV_YRMON AND EX1.ACCT_XCH_RT_LVL = '3'))), 0)
				   FROM FMS_CONSULTATION FCH, FMS_CSUL_SLP FCD
                   WHERE AA.SLP_TP_CD = FCD.ORG_SLP_TP_CD
                   AND AA.SLP_FUNC_CD = FCD.ORG_SLP_FUNC_CD
                   AND AA.SLP_OFC_CD = FCD.ORG_SLP_OFC_CD
                   AND AA.SLP_ISS_DT = FCD.ORG_ISS_DT
                   AND AA.SLP_SER_NO = FCD.ORG_SLP_SER_NO
                   AND FCD.SLP_TP_CD = FCH.SLP_TP_CD
                   AND FCD.SLP_FUNC_CD = FCH.SLP_FUNC_CD
                   AND FCD.SLP_OFC_CD = FCH.SLP_OFC_CD
                   AND FCD.SLP_ISS_DT = FCH.SLP_ISS_DT
                   AND FCD.SLP_SER_NO = FCH.SLP_SER_NO
                   AND FCD.ACCT_CD = '110811') ACT_APPR_YAMT,  
                INV_NAMT
                + (SELECT NVL(SUM(DECODE(FCH.APRO_FLG,'N',FCD.CSR_AMT,0)/DECODE(FCD.CSR_CURR_CD, 'USD', 1, (SELECT NVL(EX1.USD_LOCL_XCH_RT,1) FROM GL_MON_XCH_RT EX1
																					WHERE FCD.CSR_CURR_CD = EX1.CURR_CD AND EX1.ACCT_XCH_RT_YRMON = AA.REV_YRMON AND EX1.ACCT_XCH_RT_LVL = '3'))), 0)                                                               
		           FROM FMS_CONSULTATION FCH, FMS_CSUL_SLP FCD
                   WHERE AA.SLP_TP_CD = FCD.ORG_SLP_TP_CD
                   AND AA.SLP_FUNC_CD = FCD.ORG_SLP_FUNC_CD
                   AND AA.SLP_OFC_CD = FCD.ORG_SLP_OFC_CD
                   AND AA.SLP_ISS_DT = FCD.ORG_ISS_DT
                   AND AA.SLP_SER_NO = FCD.ORG_SLP_SER_NO
                   AND FCD.SLP_TP_CD = FCH.SLP_TP_CD
                   AND FCD.SLP_FUNC_CD = FCH.SLP_FUNC_CD
                   AND FCD.SLP_OFC_CD = FCH.SLP_OFC_CD
                   AND FCD.SLP_ISS_DT = FCH.SLP_ISS_DT
                   AND FCD.SLP_SER_NO = FCH.SLP_SER_NO
                   AND FCD.ACCT_CD = '110811') ACT_APPR_NAMT
         FROM (     
		 SELECT FC.SLP_TP_CD, FC.SLP_FUNC_CD, FC.SLP_OFC_CD, FC.SLP_ISS_DT, FC.SLP_SER_NO,
				A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD, A.REV_YRMON,
        		B.FLET_CTRT_NO,
				SUM(DECODE(FC.APRO_FLG,'Y',FS.INV_AMT,0)/DECODE(FS.CURR_CD, 'USD', 1, (SELECT NVL(EX1.USD_LOCL_XCH_RT,1) FROM GL_MON_XCH_RT EX1
																					WHERE FS.CURR_CD = EX1.CURR_CD AND EX1.ACCT_XCH_RT_YRMON = A.REV_YRMON AND EX1.ACCT_XCH_RT_LVL = '3'))) INV_YAMT,
				SUM(DECODE(FC.APRO_FLG,'N',FS.INV_AMT,0)/DECODE(FS.CURR_CD, 'USD', 1, (SELECT NVL(EX1.USD_LOCL_XCH_RT,1) FROM GL_MON_XCH_RT EX1
																					WHERE FS.CURR_CD = EX1.CURR_CD AND EX1.ACCT_XCH_RT_YRMON = A.REV_YRMON AND EX1.ACCT_XCH_RT_LVL = '3'))) INV_NAMT
		FROM FMS_VVD A, (SELECT VSL_CD, FLET_CTRT_NO 
                           FROM FMS_CONTRACT
						  WHERE FLET_CTRT_TP_CD = 'TO' 
                            AND FLET_CTRT_TP_CD LIKE @[flet_ctrt_tp_cd]||'%' 
                            AND FLET_CTRT_FACT_CD = 'ACT'
						 UNION ALL
						 SELECT FI.VSL_CD, FC.FLET_CTRT_NO 
                           FROM FMS_CONTRACT FC, FMS_ID_VSL FI
						  WHERE FC.FLET_CTRT_NO = FI.FLET_CTRT_NO 
                            AND FC.FLET_CTRT_TP_CD = 'TO' 
                            AND FC.FLET_CTRT_TP_CD LIKE @[flet_ctrt_tp_cd]||'%' 
                            AND FC.FLET_CTRT_FACT_CD = 'ACT') B,
			  FMS_CONSULTATION FC, FMS_INV_DTL FS
		WHERE A.VSL_CD = B.VSL_CD
		  AND B.FLET_CTRT_NO = FC.FLET_CTRT_NO
		  AND A.VST_DT <= TO_CHAR(FS.EXP_DT,'YYYYMMDD')
		  AND A.VED_DT >= TO_CHAR(FS.EFF_DT,'YYYYMMDD')
		  AND A.REV_YRMON BETWEEN @[fr_duration] AND @[to_duration]
		  AND FC.SLP_TP_CD = FS.SLP_TP_CD
		  AND FC.SLP_FUNC_CD = FS.SLP_FUNC_CD
		  AND FC.SLP_OFC_CD = FS.SLP_OFC_CD
		  AND FC.SLP_ISS_DT = FS.SLP_ISS_DT
		  AND FC.SLP_SER_NO = FS.SLP_SER_NO
		  AND A.VSL_CD = FS.VSL_CD
		  AND A.SKD_VOY_NO = FS.SKD_VOY_NO
		  AND A.SKD_DIR_CD = FS.SKD_DIR_CD
		  AND A.REV_DIR_CD = FS.REV_DIR_CD
		  AND FS.FLET_ISS_TP_CD = 'PRE'
          --AND FS.ACCT_CD = '510911'
		GROUP BY A.VSL_CD, 
				 A.SKD_VOY_NO, 
                 A.SKD_DIR_CD, 
                 A.REV_DIR_CD, 
                 A.REV_YRMON, 
                 B.FLET_CTRT_NO,
                 FC.SLP_TP_CD,
                 FC.SLP_FUNC_CD,
                 FC.SLP_OFC_CD,
                 FC.SLP_ISS_DT,
                 FC.SLP_SER_NO) AA ) C
WHERE 	A.VSL_CD = B.VSL_CD
  AND 	A.SKD_VOY_NO = B.SKD_VOY_NO
  AND 	A.SKD_DIR_CD = B.SKD_DIR_CD
  AND 	A.REV_DIR_CD = B.REV_DIR_CD
  AND 	A.REV_YRMON = B.REV_YRMON
  AND 	A.FLET_CTRT_NO = B.FLET_CTRT_NO
  AND 	A.VSL_CD = C.VSL_CD
  AND 	A.SKD_VOY_NO = C.SKD_VOY_NO
  AND 	A.SKD_DIR_CD = C.SKD_DIR_CD
  AND 	A.REV_DIR_CD = C.REV_DIR_CD
  AND 	A.REV_YRMON = C.REV_YRMON
  AND 	A.FLET_CTRT_NO = C.FLET_CTRT_NO
GROUP BY A.REV_YRMON,
         A.FLET_CTRT_TP_CD,
         A.RLANE_CD,
         A.VSL_CD, 
         A.SKD_VOY_NO, 
         A.SKD_DIR_CD, 
         A.REV_DIR_CD,
         A.VST_DT, 
         A.VED_DT,
         B.HIRE_AMT
-- 세번째 UNION ALL (Off-Hire 조회)
UNION ALL
SELECT 'I' ibflag,
		@[to_duration] EXE_YRMON, A.REV_YRMON, A.REV_YRMON||A.FLET_CTRT_TP_CD SUBSUMCOL,
       A.FLET_CTRT_TP_CD,
       A.RLANE_CD, A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD||A.REV_DIR_CD VVD_CD,
       A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD,
       TO_CHAR(C.VVD_EFF_DT,'YYYYMMDD') VST_DT, TO_CHAR(C.VVD_EXP_DT,'YYYYMMDD') VED_DT,
       B.HIRE_AMT,
       C.ACT_AMT + C.ACT_APPR_NAMT EST_AMT,
	   (C.ACT_AMT) ACT_AMT,
       -1*(C.ACT_APPR_NAMT) ACC_AMT

	 ,  '' FLET_ACCL_AMT

FROM
		(SELECT DISTINCT A.REV_YRMON,
		       B.FLET_CTRT_NO, B.FLET_CTRT_TP_CD,
		       A.RLANE_CD, A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD||A.REV_DIR_CD VVD_CD,
		       A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD,
		       A.VST_DT, A.VED_DT
		FROM FMS_VVD A,
			(SELECT VSL_CD, FLET_CTRT_NO, FLET_CTRT_TP_CD 
               FROM FMS_CONTRACT
			  WHERE FLET_CTRT_TP_CD <> 'OW' 
                AND FLET_CTRT_TP_CD LIKE @[flet_ctrt_tp_cd]||'%' 
                AND FLET_CTRT_FACT_CD = 'ACT'
			 UNION ALL
			 SELECT FI.VSL_CD, FC.FLET_CTRT_NO, FLET_CTRT_TP_CD 
               FROM FMS_CONTRACT FC, FMS_ID_VSL FI
			  WHERE FC.FLET_CTRT_NO = FI.FLET_CTRT_NO 
                AND FC.FLET_CTRT_TP_CD <> 'OW' 
                AND FC.FLET_CTRT_TP_CD LIKE @[flet_ctrt_tp_cd]||'%' 
                AND FC.FLET_CTRT_FACT_CD = 'ACT') B
		WHERE A.VSL_CD = B.VSL_CD
		  AND A.REV_YRMON BETWEEN @[fr_duration] AND @[to_duration]
		) A,
		(SELECT VSL_CD, SKD_VOY_NO, SKD_DIR_CD, REV_DIR_CD, REV_YRMON,
				FLET_CTRT_NO,
				MIN(HIRE_N1ST_AMT + HIRE_N2ND_AMT) HIRE_AMT
		 FROM (
				SELECT A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD, A.REV_YRMON,
						C.FLET_CTRT_NO,
						CASE WHEN SUBSTR(TO_CHAR(FIRST_VALUE(C.EXP_DT) OVER(PARTITION BY C.FLET_CTRT_NO, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD ORDER BY C.EXP_DT),'YYYYMMDDHH24MISS'),9,4) = '0000' AND C.HIR_CURR_N2ND_CD IS NULL THEN
								  NVL(C.HIR_RT_N1ST_AMT/DECODE(C.HIR_CURR_N1ST_CD, 'USD', 1, (SELECT NVL(EX1.USD_LOCL_XCH_RT,1) FROM GL_MON_XCH_RT EX1
																								WHERE C.HIR_CURR_N1ST_CD = EX1.CURR_CD AND EX1.ACCT_XCH_RT_YRMON = A.REV_YRMON AND EX1.ACCT_XCH_RT_LVL = '3')),0)
							 ELSE
								  FIRST_VALUE(NVL(C.HIR_RT_N1ST_AMT/DECODE(C.HIR_CURR_N1ST_CD, 'USD', 1, (SELECT NVL(EX1.USD_LOCL_XCH_RT,1) FROM GL_MON_XCH_RT EX1
																										   WHERE C.HIR_CURR_N1ST_CD = EX1.CURR_CD AND EX1.ACCT_XCH_RT_YRMON = A.REV_YRMON AND EX1.ACCT_XCH_RT_LVL = '3')),0))
																		OVER(PARTITION BY C.FLET_CTRT_NO, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD, C.EXP_DT ORDER BY C.EXP_DT DESC)
						 END HIRE_N1ST_AMT,
						CASE WHEN SUBSTR(TO_CHAR(FIRST_VALUE(C.EXP_DT) OVER(PARTITION BY C.FLET_CTRT_NO, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD ORDER BY C.EXP_DT),'YYYYMMDDHH24MISS'),9,4) = '0000' AND C.HIR_CURR_N2ND_CD IS NULL THEN
								  NVL(C.HIR_RT_N2ND_AMT/DECODE(C.HIR_CURR_N2ND_CD, 'USD', 1, (SELECT NVL(EX1.USD_LOCL_XCH_RT,1) FROM GL_MON_XCH_RT EX1
																								WHERE C.HIR_CURR_N2ND_CD = EX1.CURR_CD AND EX1.ACCT_XCH_RT_YRMON = A.REV_YRMON AND EX1.ACCT_XCH_RT_LVL = '3')),0)
							 ELSE
								  FIRST_VALUE(NVL(C.HIR_RT_N2ND_AMT/DECODE(C.HIR_CURR_N2ND_CD, 'USD', 1, (SELECT NVL(EX1.USD_LOCL_XCH_RT,1) FROM GL_MON_XCH_RT EX1
																										   WHERE C.HIR_CURR_N2ND_CD = EX1.CURR_CD AND EX1.ACCT_XCH_RT_YRMON = A.REV_YRMON AND EX1.ACCT_XCH_RT_LVL = '3')),0))
																		OVER(PARTITION BY C.FLET_CTRT_NO, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD, C.EXP_DT ORDER BY C.EXP_DT DESC)
						 END HIRE_N2ND_AMT
				FROM 	FMS_VVD A, (SELECT VSL_CD, FLET_CTRT_NO, FLET_CTRT_TP_CD 
                                      FROM FMS_CONTRACT
									 WHERE FLET_CTRT_TP_CD <> 'OW' 
                                       AND FLET_CTRT_TP_CD LIKE @[flet_ctrt_tp_cd]||'%' 
                                       AND FLET_CTRT_FACT_CD = 'ACT'
									UNION ALL
									SELECT FI.VSL_CD, FC.FLET_CTRT_NO, FLET_CTRT_TP_CD 
                                      FROM FMS_CONTRACT FC, FMS_ID_VSL FI
									 WHERE FC.FLET_CTRT_NO = FI.FLET_CTRT_NO 
                                       AND FC.FLET_CTRT_TP_CD <> 'OW' 
                                       AND FC.FLET_CTRT_TP_CD LIKE @[flet_ctrt_tp_cd]||'%' 
                                       AND FC.FLET_CTRT_FACT_CD = 'ACT') B,
						FMS_HIRE C
				WHERE 	A.VSL_CD = B.VSL_CD
				  AND 	B.FLET_CTRT_NO = C.FLET_CTRT_NO
				  --AND   A.VST_DT <= TO_CHAR(C.EXP_DT,'YYYYMMDD')
				  AND   A.VST_DT <= TO_CHAR(DECODE(DECODE(TO_NUMBER(SUBSTR(TO_CHAR(C.EXP_DT, 'YYYYMMDDHH24MI'), 9)), 0, 'A', 'B'), 'A', C.EXP_DT - 1, C.EXP_DT),'YYYYMMDD')
				  AND   A.VED_DT >= TO_CHAR(C.EFF_DT,'YYYYMMDD')
				  AND   A.REV_YRMON BETWEEN @[fr_duration] AND @[to_duration])
		GROUP BY VSL_CD, SKD_VOY_NO, SKD_DIR_CD, REV_DIR_CD, REV_YRMON, FLET_CTRT_NO
		) B,
        (SELECT A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD, A.REV_YRMON, fc.slp_tp_cd||fc.slp_func_cd||fc.slp_ofc_cd||fc.slp_iss_dt||fc.slp_ser_no CSR_NO,
        		B.FLET_CTRT_NO, FS.VVD_EFF_DT, FS.VVD_EXP_DT,
                DECODE(FC.APRO_FLG,'Y',FS.CSR_AMT,0)/DECODE(FS.CSR_CURR_CD, 'USD', 1, (SELECT NVL(EX1.USD_LOCL_XCH_RT,1) FROM GL_MON_XCH_RT EX1
                                  WHERE FS.CSR_CURR_CD = EX1.CURR_CD AND EX1.ACCT_XCH_RT_YRMON = SUBSTR(FC.EFF_DT,1,6) AND EX1.ACCT_XCH_RT_LVL = '3')) ACT_AMT,
                DECODE(FC.APRO_FLG,'Y',0,FS.CSR_AMT)/DECODE(FS.CSR_CURR_CD, 'USD', 1, (SELECT NVL(EX1.USD_LOCL_XCH_RT,1) FROM GL_MON_XCH_RT EX1
							      WHERE FS.CSR_CURR_CD = EX1.CURR_CD AND EX1.ACCT_XCH_RT_YRMON = A.REV_YRMON AND EX1.ACCT_XCH_RT_LVL = '3')) ACT_APPR_NAMT
		 FROM   FMS_VVD A, (SELECT VSL_CD, FLET_CTRT_NO 
                              FROM FMS_CONTRACT
							 WHERE FLET_CTRT_TP_CD <> 'OW' 
                               AND FLET_CTRT_TP_CD LIKE @[flet_ctrt_tp_cd]||'%' 
                               AND FLET_CTRT_FACT_CD = 'ACT'
							 UNION ALL
							 SELECT FI.VSL_CD, FC.FLET_CTRT_NO 
                               FROM FMS_CONTRACT FC, FMS_ID_VSL FI
							  WHERE FC.FLET_CTRT_NO = FI.FLET_CTRT_NO 
                                AND FC.FLET_CTRT_TP_CD <> 'OW' 
                                AND FC.FLET_CTRT_TP_CD LIKE @[flet_ctrt_tp_cd]||'%' 
                                AND FC.FLET_CTRT_FACT_CD = 'ACT') B,
				FMS_CONSULTATION FC, FMS_CSUL_SLP FS
		WHERE 	A.VSL_CD = B.VSL_CD
		  AND 	B.FLET_CTRT_NO = FC.FLET_CTRT_NO
		  AND 	A.VST_DT <= TO_CHAR(FS.VVD_EXP_DT,'YYYYMMDD')
		  AND 	A.VED_DT >= TO_CHAR(FS.VVD_EFF_DT,'YYYYMMDD')
		  AND 	A.REV_YRMON BETWEEN @[fr_duration] AND @[to_duration]
		  AND 	FC.SLP_TP_CD = FS.SLP_TP_CD
		  AND 	FC.SLP_FUNC_CD = FS.SLP_FUNC_CD
		  AND 	FC.SLP_OFC_CD = FS.SLP_OFC_CD
		  AND 	FC.SLP_ISS_DT = FS.SLP_ISS_DT
		  AND 	FC.SLP_SER_NO = FS.SLP_SER_NO
		  AND 	A.VSL_CD = FS.VSL_CD
		  AND 	A.SKD_VOY_NO = FS.SKD_VOY_NO
		  AND 	A.SKD_DIR_CD = FS.SKD_DIR_CD
		  AND 	A.REV_DIR_CD = FS.REV_DIR_CD
		  AND 	FS.SLP_FUNC_CD = 'P'
          AND 	FC.APRO_FLG = 'Y'
          AND   FC.CXL_FLG = 'N'
          AND   SUBSTR(FC.EFF_DT,1,6) BETWEEN @[fr_duration] AND @[to_duration]
		  AND 	FS.ACCT_CD = '510911'
          AND   FS.FLET_SRC_TP_CD = '02') C
WHERE 	A.VSL_CD = B.VSL_CD
  AND 	A.SKD_VOY_NO = B.SKD_VOY_NO
  AND 	A.SKD_DIR_CD = B.SKD_DIR_CD
  AND 	A.REV_DIR_CD = B.REV_DIR_CD
  AND 	A.REV_YRMON = B.REV_YRMON
  AND 	A.FLET_CTRT_NO = B.FLET_CTRT_NO
  AND 	A.VSL_CD = C.VSL_CD
  AND 	A.SKD_VOY_NO = C.SKD_VOY_NO
  AND 	A.SKD_DIR_CD = C.SKD_DIR_CD
  AND 	A.REV_DIR_CD = C.REV_DIR_CD
  AND 	A.REV_YRMON = C.REV_YRMON
  AND 	A.FLET_CTRT_NO = C.FLET_CTRT_NO

-- 마지막 Manual Slip (98) Payment Slip (99) UNION ALL (TI 조회) 
UNION ALL
SELECT 'I' ibflag,
	    	@[to_duration] EXE_YRMON, A.REV_YRMON, A.REV_YRMON||A.FLET_CTRT_TP_CD SUBSUMCOL,
        A.FLET_CTRT_TP_CD,
        A.RLANE_CD, A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD||A.REV_DIR_CD VVD_CD,
        A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD,
        A.VST_DT, A.VED_DT,
        B.HIRE_AMT,
        A.ACT_AMT EST_AMT,
        A.ACT_AMT ACT_AMT,
        0 ACC_AMT

		,  '' FLET_ACCL_AMT

FROM
(  
      SELECT A.REV_YRMON, A.VST_DT, A.VED_DT, A.RLANE_CD,
            		         B.FLET_CTRT_NO, B.FLET_CTRT_TP_CD,
            		        A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD,
      					      FS.CSR_AMT/DECODE(FS.CSR_CURR_CD, 'USD', 1, (SELECT NVL(EX1.USD_LOCL_XCH_RT,1)
                                                                                                       FROM GL_MON_XCH_RT EX1
      																	                                                              WHERE FS.CSR_CURR_CD = EX1.CURR_CD 
                                                                                                      AND EX1.ACCT_XCH_RT_YRMON =  SUBSTR(FC.EFF_DT,1,6) 
                                                                                                       AND EX1.ACCT_XCH_RT_LVL = '3' )) ACT_AMT

      FROM FMS_VVD A, (SELECT VSL_CD, FLET_CTRT_NO, FLET_CTRT_TP_CD
                                              FROM FMS_CONTRACT
                            								 WHERE FLET_CTRT_TP_CD = 'TI' 
                                                 AND FLET_CTRT_TP_CD LIKE @[flet_ctrt_tp_cd]||'%' 
                                                 AND FLET_CTRT_FACT_CD = 'ACT'
                      								 UNION ALL
                      								 SELECT FI.VSL_CD, FC.FLET_CTRT_NO , FLET_CTRT_TP_CD
                                          FROM FMS_CONTRACT FC, FMS_ID_VSL FI
                      								  WHERE FC.FLET_CTRT_NO = FI.FLET_CTRT_NO 
                                            AND FC.FLET_CTRT_TP_CD = 'TI' 
                                            AND FC.FLET_CTRT_TP_CD LIKE @[flet_ctrt_tp_cd]||'%' 
                                            AND FC.FLET_CTRT_FACT_CD = 'ACT'
                                  ) B,
      				    	     FMS_CONSULTATION FC, FMS_CSUL_SLP FS
      WHERE 	A.VSL_CD = B.VSL_CD
         AND 	A.REV_YRMON BETWEEN @[fr_duration] AND @[to_duration]
         AND 	FC.SLP_TP_CD = FS.SLP_TP_CD
         AND 	FC.SLP_FUNC_CD = FS.SLP_FUNC_CD
         AND 	FC.SLP_OFC_CD = FS.SLP_OFC_CD
         AND 	FC.SLP_ISS_DT = FS.SLP_ISS_DT
         AND 	FC.SLP_SER_NO = FS.SLP_SER_NO
         AND 	A.VSL_CD = FS.VSL_CD
         AND 	A.SKD_VOY_NO = FS.SKD_VOY_NO
         AND 	A.SKD_DIR_CD = FS.SKD_DIR_CD
         AND 	A.REV_DIR_CD = FS.REV_DIR_CD
         AND 	FS.ACCT_CD = '510911'
         AND 	FC.APRO_FLG = 'Y'
        AND   FC.CXL_FLG = 'N'
        AND   SUBSTR(FC.EFF_DT,1,6) BETWEEN @[fr_duration] AND @[to_duration]
         AND  FS.FLET_SRC_TP_CD IN  ('98', '99')
       ) A,
   
   (SELECT VSL_CD, SKD_VOY_NO, SKD_DIR_CD, REV_DIR_CD, REV_YRMON,
				FLET_CTRT_NO,
				MIN(HIRE_N1ST_AMT + HIRE_N2ND_AMT) HIRE_AMT
		 FROM (
				SELECT A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD, A.REV_YRMON,
						C.FLET_CTRT_NO,
						CASE WHEN SUBSTR(TO_CHAR(FIRST_VALUE(C.EXP_DT) OVER(PARTITION BY C.FLET_CTRT_NO, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD ORDER BY C.EXP_DT),'YYYYMMDDHH24MISS'),9,4) = '0000' AND C.HIR_CURR_N2ND_CD IS NULL THEN
								  NVL(C.HIR_RT_N1ST_AMT/DECODE(C.HIR_CURR_N1ST_CD, 'USD', 1, (SELECT NVL(EX1.USD_LOCL_XCH_RT,1) FROM GL_MON_XCH_RT EX1
																								WHERE C.HIR_CURR_N1ST_CD = EX1.CURR_CD AND EX1.ACCT_XCH_RT_YRMON = A.REV_YRMON AND EX1.ACCT_XCH_RT_LVL = '3')),0)
							 ELSE
								  FIRST_VALUE(NVL(C.HIR_RT_N1ST_AMT/DECODE(C.HIR_CURR_N1ST_CD, 'USD', 1, (SELECT NVL(EX1.USD_LOCL_XCH_RT,1) FROM GL_MON_XCH_RT EX1
																										   WHERE C.HIR_CURR_N1ST_CD = EX1.CURR_CD AND EX1.ACCT_XCH_RT_YRMON = A.REV_YRMON AND EX1.ACCT_XCH_RT_LVL = '3')),0))
																		OVER(PARTITION BY C.FLET_CTRT_NO, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD, C.EXP_DT ORDER BY C.EXP_DT DESC)
						 END HIRE_N1ST_AMT,
						CASE WHEN SUBSTR(TO_CHAR(FIRST_VALUE(C.EXP_DT) OVER(PARTITION BY C.FLET_CTRT_NO, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD ORDER BY C.EXP_DT),'YYYYMMDDHH24MISS'),9,4) = '0000' AND C.HIR_CURR_N2ND_CD IS NULL THEN
								  NVL(C.HIR_RT_N2ND_AMT/DECODE(C.HIR_CURR_N2ND_CD, 'USD', 1, (SELECT NVL(EX1.USD_LOCL_XCH_RT,1) FROM GL_MON_XCH_RT EX1
																								WHERE C.HIR_CURR_N2ND_CD = EX1.CURR_CD AND EX1.ACCT_XCH_RT_YRMON = A.REV_YRMON AND EX1.ACCT_XCH_RT_LVL = '3')),0)
							 ELSE
								  FIRST_VALUE(NVL(C.HIR_RT_N2ND_AMT/DECODE(C.HIR_CURR_N2ND_CD, 'USD', 1, (SELECT NVL(EX1.USD_LOCL_XCH_RT,1) FROM GL_MON_XCH_RT EX1
																										   WHERE C.HIR_CURR_N2ND_CD = EX1.CURR_CD AND EX1.ACCT_XCH_RT_YRMON = A.REV_YRMON AND EX1.ACCT_XCH_RT_LVL = '3')),0))
																		OVER(PARTITION BY C.FLET_CTRT_NO, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD, C.EXP_DT ORDER BY C.EXP_DT DESC)
						 END HIRE_N2ND_AMT
				FROM 	FMS_VVD A, (SELECT VSL_CD, FLET_CTRT_NO, FLET_CTRT_TP_CD 
                                      FROM FMS_CONTRACT
									 WHERE FLET_CTRT_TP_CD <> 'OW' 
                                       AND FLET_CTRT_TP_CD LIKE @[flet_ctrt_tp_cd]||'%' 
                                       AND FLET_CTRT_FACT_CD = 'ACT'
									UNION ALL
									SELECT FI.VSL_CD, FC.FLET_CTRT_NO, FLET_CTRT_TP_CD 
                                      FROM FMS_CONTRACT FC, FMS_ID_VSL FI
									 WHERE FC.FLET_CTRT_NO = FI.FLET_CTRT_NO 
                                       AND FC.FLET_CTRT_TP_CD <> 'OW' 
                                       AND FC.FLET_CTRT_TP_CD LIKE @[flet_ctrt_tp_cd]||'%' 
                                       AND FC.FLET_CTRT_FACT_CD = 'ACT') B,
						FMS_HIRE C, FMS_CSUL_SLP FS
				WHERE 	A.VSL_CD = B.VSL_CD
			    AND 	 C.FLET_CTRT_NO = B.FLET_CTRT_NO
				  --AND   A.VST_DT <= TO_CHAR(C.EXP_DT,'YYYYMMDD')
				AND   A.VST_DT <= TO_CHAR(DECODE(DECODE(TO_NUMBER(SUBSTR(TO_CHAR(C.EXP_DT, 'YYYYMMDDHH24MI'), 9)), 0, 'A', 'B'), 'A', C.EXP_DT - 1, C.EXP_DT),'YYYYMMDD')
				  AND   A.VED_DT >= TO_CHAR(C.EFF_DT,'YYYYMMDD')
				  AND   A.REV_YRMON BETWEEN @[fr_duration] AND @[to_duration]
          AND 	A.VSL_CD = FS.VSL_CD
          AND 	A.SKD_VOY_NO = FS.SKD_VOY_NO
          AND 	A.SKD_DIR_CD = FS.SKD_DIR_CD
          AND 	A.REV_DIR_CD = FS.REV_DIR_CD
          AND 	FS.ACCT_CD = '510911'
          AND  FS.FLET_SRC_TP_CD IN  ('98', '99') )
		GROUP BY VSL_CD, SKD_VOY_NO, SKD_DIR_CD, REV_DIR_CD, REV_YRMON, FLET_CTRT_NO
		) B

WHERE   A.VSL_CD = B.VSL_CD
  AND 	A.SKD_VOY_NO = B.SKD_VOY_NO
  AND 	A.SKD_DIR_CD = B.SKD_DIR_CD
  AND 	A.REV_DIR_CD = B.REV_DIR_CD
  AND 	A.REV_YRMON = B.REV_YRMON
  AND 	A.FLET_CTRT_NO = B.FLET_CTRT_NO

ORDER BY REV_YRMON, FLET_CTRT_TP_CD			]]></sql>
			<params>
				<param name="to_duration" type="12" value="" out="N"/>
				<param name="flet_ctrt_tp_cd" type="12" value="" out="N"/>
				<param name="fr_duration" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
