<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ConstraintMasterDBDAOSpaceAllocationControlOptionUSQL">
			<desc><![CDATA[노선별 등록된 Control Option 을 항차별 Control Option으로 매핑
[CHM-201322502-01] SPC 프로젝트 - 성수기 선복운영 개선을 위한 T/F추진
[CHM-201431081] 차상영 SPC Allocation Control Option 추가 보완
2015.07.03 이혜민 [CHM-201536633] Control Option management 보완요청 (Fixed Rate관련)
2015.07.09 김성욱 [CHM-201536750] Revenue Management System 추가 보완 개발 요청 / F'cast L/F From wk 추가
ConstraintMasterDBDAOSpaceAllocationControlOptionUSQL.Query 패키지 이동으로 신규 생성
2015.07.24 Arie [CHM-201537010] Control Option Management 및 VVD별 EDIT기능 보완  - Sync/Desync 빼고 Yield Group, Fixed Edit 추가
2015.07.30 Arie MasterTable 조건 삭제(control option 저장화면에서)
2015.08.17 CHM-201537550 SB BKG management 및 Control Option Registration 보완 요청(7.30내용 포함)]]></desc>
			<sql><![CDATA[
MERGE INTO SPC_ALOC_CTRL_OPT O
USING (
	SELECT DISTINCT
		M.TRD_CD          ,
		M.SUB_TRD_CD      ,
		M.RLANE_CD        ,
		M.VSL_CD          ,
		M.SKD_VOY_NO      ,
		M.DIR_CD          ,
		A.CTRL_PORT_FLG   ,
		A.CTRL_WGT_FLG    ,
		A.CTRL_40FT_HC_FLG,
		A.CTRL_45FT_HC_FLG,
		A.CTRL_53FT_FLG   ,
		A.CTRL_RF_FLG     ,
		A.CTRL_LVL_CD     ,
		NVL((SELECT O.ACCT_GRP_CTRL_FLG
                      FROM SPC_ALOC_LANE_CTRL_OPT O
                     WHERE SUBSTR(M.SLS_YRMON, 1, 4)||M.COST_WK BETWEEN O.APLY_FM_YRWK AND O.APLY_TO_YRWK
                       AND M.TRD_CD     = O.TRD_CD
                       AND M.SUB_TRD_CD = O.SUB_TRD_CD
                       AND M.RLANE_CD   = O.RLANE_CD
                       AND M.DIR_CD     = O.DIR_CD
                       AND M.DELT_FLG   = 'N'), 'N') AS ACCT_GRP_CTRL_FLG,
		A.CTRL_D2_FLG,
		A.CTRL_D4_FLG,
		A.CTRL_RD_FLG,
		A.CTRL_ECC_FLG,
		A.CTRL_ECC_GRP_FLG,
--		A.CTRL_LOC_FLG,
		A.CTRL_USA_SVC_MOD_FLG,
		A.CTRL_ACCT_FLG,
		A.CTRL_DEST_LVL_CD,
        A.CTRL_FX_RT_FLG,
		-- BKG Control 관련
		A.BKG_CTRL_ACCT_GRP_APLY_FLG
		, A.BKG_CTRL_ACCT_GRP_FCAST_FLG
		, A.BKG_CTRL_ACCT_GRP_RTO
		, A.BKG_CTRL_ALOC_APLY_FLG
		, A.BKG_CTRL_ALOC_FCAST_FLG
		, A.BKG_CTRL_ALOC_FCAST_RTO 
        , A.BKG_CTRL_FCAST_FM_YRWK
		, A.BKG_CTRL_ALOC_TP_CD 
        , A.BKG_CTRL_ACCT_GRP_TP_CD
	FROM 	SPC_ALOC_LANE_CTRL_OPT A,
            MAS_MON_VVD            M
	WHERE 	SUBSTR(M.SLS_YRMON, 1, 4)||M.COST_WK >= TO_CHAR(SYSDATE, 'YYYYWW')
	AND 	M.TRD_CD     = A.TRD_CD
	AND 	M.SUB_TRD_CD = A.SUB_TRD_CD
	AND 	M.RLANE_CD   = A.RLANE_CD
	AND 	M.DIR_CD     = A.DIR_CD
	AND 	M.DELT_FLG   = 'N'
	AND 	M.TRD_CD     = @[trd_cd]
	AND 	M.SUB_TRD_CD = @[sub_trd_cd]
	AND 	M.RLANE_CD   = @[rlane_cd]
	AND 	M.DIR_CD     = @[dir_cd]
      ) L
   ON (
		O.RLANE_CD   = L.RLANE_CD
	AND 	O.DIR_CD     = L.DIR_CD
	AND 	O.VSL_CD     = L.VSL_cD
	AND 	O.SKD_VOY_NO = L.SKD_VOY_NO
	AND 	O.SKD_DIR_CD = L.DIR_CD
        -- 2014.08.19 변경 
        -- AND NVL(O.MNL_FLG,'N') = 'N'
      )
WHEN MATCHED THEN
	UPDATE SET  
	O.CTRL_PORT_FLG     	= DECODE(NVL(O.MNL_FLG,'N'), 'Y', O.CTRL_PORT_FLG, L.CTRL_PORT_FLG)   ,
	O.CTRL_WGT_FLG      	= DECODE(NVL(O.MNL_FLG,'N'), 'Y', O.CTRL_WGT_FLG, L.CTRL_WGT_FLG)     ,
	O.CTRL_40FT_HC_FLG  	= DECODE(NVL(O.MNL_FLG,'N'), 'Y', O.CTRL_40FT_HC_FLG, L.CTRL_40FT_HC_FLG) ,
	O.CTRL_45FT_HC_FLG  	= DECODE(NVL(O.MNL_FLG,'N'), 'Y', O.CTRL_45FT_HC_FLG, L.CTRL_45FT_HC_FLG) ,
	O.CTRL_53FT_FLG     	= DECODE(NVL(O.MNL_FLG,'N'), 'Y', O.CTRL_53FT_FLG, L.CTRL_53FT_FLG)   ,
	O.CTRL_RF_FLG       	= DECODE(NVL(O.MNL_FLG,'N'), 'Y', O.CTRL_RF_FLG, L.CTRL_RF_FLG)     ,
	O.CTRL_LVL_CD       	= DECODE(NVL(O.MNL_FLG,'N'), 'Y', O.CTRL_LVL_CD, L.CTRL_LVL_CD)     ,
	O.ACCT_GRP_CTRL_FLG 	= DECODE(NVL(O.MNL_FLG,'N'), 'Y', O.ACCT_GRP_CTRL_FLG, L.ACCT_GRP_CTRL_FLG),
	O.CTRL_D2_FLG       	= DECODE(NVL(O.MNL_FLG,'N'), 'Y', O.CTRL_D2_FLG, L.CTRL_D2_FLG),
	O.CTRL_D4_FLG       	= DECODE(NVL(O.MNL_FLG,'N'), 'Y', O.CTRL_D4_FLG, L.CTRL_D4_FLG),
	O.CTRL_RD_FLG       	= DECODE(NVL(O.MNL_FLG,'N'), 'Y', O.CTRL_RD_FLG, L.CTRL_RD_FLG),
	O.CTRL_ECC_FLG      	= DECODE(NVL(O.MNL_FLG,'N'), 'Y', O.CTRL_ECC_FLG, L.CTRL_ECC_FLG),
	--O.CTRL_LOC_FLG      	= DECODE(NVL(O.MNL_FLG,'N'), 'Y', O.CTRL_LOC_FLG, L.CTRL_LOC_FLG),
	O.CTRL_USA_SVC_MOD_FLG  = DECODE(NVL(O.MNL_FLG,'N'), 'Y', O.CTRL_USA_SVC_MOD_FLG, L.CTRL_USA_SVC_MOD_FLG),
	O.CTRL_ACCT_FLG     	= DECODE(NVL(O.MNL_FLG,'N'), 'Y', O.CTRL_ACCT_FLG , L.CTRL_ACCT_FLG),
	O.CTRL_FX_RT_FLG        = DECODE(NVL(O.MNL_FLG,'N'), 'Y', O.CTRL_FX_RT_FLG, L.CTRL_FX_RT_FLG),
	--화면에 보이지 않는 값 Lane을 따라감
	O.CTRL_DEST_LVL_CD  	= L.CTRL_DEST_LVL_CD,
	O.CTRL_ECC_GRP_FLG      = L.CTRL_ECC_GRP_FLG,
	O.UPD_USR_ID        	= 'SPC_SYSTEM',
	O.UPD_DT            	= SYSDATE,
	O.RAPLY_CFM_FLG                 = @[rd_flg],  --2015.04.01 김성욱, Control Option의 BKG Control의 byAlloc, bySMP, byMaster 의 조건이 완화 된 경우 세팅
	--BKG Control 관련항목은 무조건 Lane을 따라감
	O.BKG_CTRL_ACCT_GRP_APLY_FLG    = L.BKG_CTRL_ACCT_GRP_APLY_FLG,
	O.BKG_CTRL_ACCT_GRP_FCAST_FLG   = L.BKG_CTRL_ACCT_GRP_FCAST_FLG,
	O.BKG_CTRL_ACCT_GRP_RTO         = L.BKG_CTRL_ACCT_GRP_RTO,
	O.BKG_CTRL_ALOC_APLY_FLG        = L.BKG_CTRL_ALOC_APLY_FLG,
	O.BKG_CTRL_ALOC_FCAST_FLG       = L.BKG_CTRL_ALOC_FCAST_FLG,
	O.BKG_CTRL_ALOC_FCAST_RTO       = L.BKG_CTRL_ALOC_FCAST_RTO
	,O.BKG_CTRL_ALOC_TP_CD        = L.BKG_CTRL_ALOC_TP_CD
    ,O.BKG_CTRL_ACCT_GRP_TP_CD    = L.BKG_CTRL_ACCT_GRP_TP_CD
WHEN NOT MATCHED THEN
    INSERT (
	RLANE_CD         ,
	DIR_CD           ,
	VSL_CD           ,
	SKD_VOY_NO       ,
	SKD_DIR_CD       ,
	REP_TRD_CD       ,
	REP_SUB_TRD_CD   ,
	CTRL_PORT_FLG    ,
	CTRL_WGT_FLG     ,
	CTRL_SPC_FLG     ,
	CTRL_40FT_HC_FLG ,
	CTRL_45FT_HC_FLG ,
	CTRL_53FT_FLG    ,
	ACCT_GRP_CTRL_FLG,
	CTRL_RF_FLG      ,
	CTRL_TS_FLG      ,
	CTRL_LVL_CD      ,
	CRE_USR_ID       ,
	CRE_DT           ,
	UPD_USR_ID       ,
	UPD_DT           ,
	CTRL_D2_FLG      ,
	CTRL_D4_FLG      ,
	CTRL_RD_FLG      ,
	CTRL_ECC_FLG     ,
--	CTRL_LOC_FLG     ,
	CTRL_ECC_GRP_FLG ,
	CTRL_USA_SVC_MOD_FLG,
	CTRL_ACCT_FLG	 ,
	CTRL_DEST_LVL_CD ,
    CTRL_FX_RT_FLG   ,    
	-- BKG Control 관련
     BKG_CTRL_ACCT_GRP_APLY_FLG
     , BKG_CTRL_ACCT_GRP_FCAST_FLG
     , BKG_CTRL_ACCT_GRP_RTO
     , BKG_CTRL_ALOC_APLY_FLG
     , BKG_CTRL_ALOC_FCAST_FLG
     , BKG_CTRL_ALOC_FCAST_RTO  
     , BKG_CTRL_FCAST_FM_YRWK
     , BKG_CTRL_ALOC_TP_CD
     , BKG_CTRL_ACCT_GRP_TP_CD
	)
    VALUES (
	L.RLANE_CD     ,
	L.DIR_CD       ,
	L.VSL_CD       ,
	L.SKD_VOY_NO   ,
	L.DIR_CD       ,
	L.TRD_CD       ,
	L.SUB_TRD_CD   ,
	L.CTRL_PORT_FLG,
	L.CTRL_WGT_FLG ,
	'N',
	L.CTRL_40FT_HC_FLG ,
	L.CTRL_45FT_HC_FLG ,
	L.CTRL_53FT_FLG    ,
	L.ACCT_GRP_CTRL_FLG,
	L.CTRL_RF_FLG      ,
	'N',
	L.CTRL_LVL_CD,
	'SPC_SYSTEM' ,
	SYSDATE      ,
	'SPC_SYSTEM' ,
	SYSDATE      ,
	L.CTRL_D2_FLG      ,
	L.CTRL_D4_FLG      ,
	L.CTRL_RD_FLG      ,
	L.CTRL_ECC_FLG     ,
--	L.CTRL_LOC_FLG     ,
	L.CTRL_ECC_GRP_FLG ,
	L.CTRL_USA_SVC_MOD_FLG,
	L.CTRL_ACCT_FLG	   ,
	L.CTRL_DEST_LVL_CD ,
    L.CTRL_FX_RT_FLG   ,
	-- BKG Control 관련
     L.BKG_CTRL_ACCT_GRP_APLY_FLG
     , L.BKG_CTRL_ACCT_GRP_FCAST_FLG
     , L.BKG_CTRL_ACCT_GRP_RTO
     , L.BKG_CTRL_ALOC_APLY_FLG
     , L.BKG_CTRL_ALOC_FCAST_FLG
     , L.BKG_CTRL_ALOC_FCAST_RTO
     , L.BKG_CTRL_FCAST_FM_YRWK
     , L.BKG_CTRL_ALOC_TP_CD
     , L.BKG_CTRL_ACCT_GRP_TP_CD
	)			]]></sql>
			<params>
				<param name="trd_cd" type="12" value="" out="N"/>
				<param name="sub_trd_cd" type="12" value="" out="N"/>
				<param name="rlane_cd" type="12" value="" out="N"/>
				<param name="dir_cd" type="12" value="" out="N"/>
				<param name="rd_flg" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
