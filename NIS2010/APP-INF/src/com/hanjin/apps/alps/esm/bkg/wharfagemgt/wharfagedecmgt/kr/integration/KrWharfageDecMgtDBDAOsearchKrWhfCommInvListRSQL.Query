<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="KrWharfageDecMgtDBDAOsearchKrWhfCommInvListRSQL">
			<desc><![CDATA[searchKrWhfCommInvList]]></desc>
			<sql><![CDATA[
SELECT
DISTINCT A.VSL_NM
,A.VSL_CD AS VSL_CD
,A.SKD_VOY_NO||A.SKD_DIR_CD AS HCNT
,A.CALL_SGN_NO
,A.ARR_YR||'-'||A.ARR_TMS_NO AS ICHCNT
,'1' AS ONGUBUN
,DECODE(A.WHF_BND_CD,'II','1','2') AS WHF_BND_CD 
,A.SAIL_DT
,'0' AS BKRCISNOT
,SUBSTR(B.WHF_NTC_NO,7,6) AS WHF_NTC_NO
,MAX(SUBSTR(B.WHF_DECL_NO,15)) AS WHF_DECL_NO
,DECODE(A.WHF_CUST_KND_CD,'U','단수','C','복수') CUST_KIND_CD
,MAX( NVL(A.NTC_AMT,0) )AS NTC_AMT 
,A.PAY_DT
,MAX( A.COMM_AMT ) AS COMM_AMT 
FROM BKG_KR_WHF_RT B, BKG_KR_WHF_VOL A
WHERE 1=1
#if (${whf_ntc_flg} == 'Y')
AND A.WHF_NTC_DT BETWEEN @[whf_ntc_dt1] AND @[whf_ntc_dt2]
#else
AND A.WHF_PAY_DT BETWEEN @[whf_ntc_dt1] AND @[whf_ntc_dt2]
#end
-- AS-IS 최신 변경 사항 반영 - 20091014 - DJMIN
-- 단수, 복수 상관없이 전체를 조회 - 20090910 - YCKIM
--AND NVL(A.WHF_CUST_KND_CD,'C') = 'C'
AND A.VSL_CD        = B.VSL_CD 
AND A.SKD_VOY_NO    = B.SKD_VOY_NO 
AND A.SKD_DIR_CD    = B.SKD_DIR_CD
AND A.PORT_NM     LIKE  
						CASE 
                            WHEN NVL(@[port_nm],'A') = '신항' OR NVL(@[port_nm],'A') = '북항' OR NVL(@[port_nm],'A') = '감천항' THEN @[port_nm]||'%'
                            WHEN NVL(@[port_nm],'A') = 'A' THEN A.PORT_NM
                            ELSE A.PORT_NM
                        END                            

AND A.PORT_CD     = DECODE(NVL(@[port_cd],'A') , 'A' ,A.PORT_CD ,@[port_cd] ) --'KRPUS'
AND A.WHF_BND_CD IN (DECODE(@[whf_bnd_cd],'O','OO','II'),DECODE(@[whf_bnd_cd],'I','II','OO'))
AND B.PORT_CD     = DECODE(NVL(@[port_cd],'A') , 'A' ,A.PORT_CD ,@[port_cd] ) --'KRPUS'
AND B.WHF_NTC_NO IS NOT NULL
AND A.WHF_BND_CD  = B.WHF_BND_CD      
AND (B.WHF_BND_CD, B.CHG_RT_SEQ)      = (
          SELECT D.WHF_BND_CD, MAX(D.CHG_RT_SEQ)
          FROM BKG_KR_WHF_RT D, BKG_KR_WHF_BL BL
          WHERE D.BL_NO       = B.BL_NO
          AND D.VSL_CD        = B.VSL_CD
          AND D.SKD_VOY_NO    = B.SKD_VOY_NO
          AND D.SKD_DIR_CD    = B.SKD_DIR_CD
          AND D.BL_NO       = BL.BL_NO
          AND D.VSL_CD      = BL.VSL_CD
          AND D.SKD_VOY_NO  = BL.SKD_VOY_NO
          AND D.SKD_DIR_CD  = BL.SKD_DIR_CD
          AND D.WHF_BND_CD  = BL.WHF_BND_CD
          AND D.PORT_CD     = DECODE(SUBSTR(BL.WHF_BND_CD,1,1),'I',BL.WHF_POD_CD,BL.WHF_POL_CD) 
          AND D.PORT_CD     = DECODE(NVL(@[port_cd],'A') , 'A' ,A.PORT_CD ,@[port_cd] )--'KRPUS'
          AND D.WHF_BND_CD IN (DECODE(@[whf_bnd_cd],'O','OO','II'),DECODE(@[whf_bnd_cd],'I','II','OO'))
          AND D.WHF_NTC_NO IS NOT NULL
          AND BL.WHF_BL_STS_CD <> 'D'
          GROUP BY D.WHF_BND_CD
                  )
GROUP BY A.VSL_NM,A.VSL_CD,A.SKD_VOY_NO||A.SKD_DIR_CD, 
         A.CALL_SGN_NO, A.ARR_YR||'-'||A.ARR_TMS_NO, 
   DECODE(A.WHF_BND_CD,'II','1','2'), A.SAIL_DT,
   SUBSTR(B.WHF_NTC_NO,7,6),  A.WHF_CUST_KND_CD,A.PAY_DT
-- AS-IS 최신 변경 사항 반영 - 20091014 - DJMIN
-- 납부금액이 '0' 이상만 조회도록 함. - 20090910 - YCKIM
HAVING MAX( NVL(A.NTC_AMT,0) ) > 0
ORDER BY 1, 2			]]></sql>
			<params>
				<param name="whf_ntc_dt1" type="12" value="" out="N"/>
				<param name="whf_ntc_dt2" type="12" value="" out="N"/>
				<param name="port_nm" type="12" value="" out="N"/>
				<param name="port_cd" type="12" value="" out="N"/>
				<param name="whf_bnd_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
