<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="RFARateProposalDBDAOPriRpScpRtAmdBasicVOCSQL">
			<desc><![CDATA[Master RFA에서 가져온 Rate 데이터를 Basic Rate에 넣는다.
Basic이 가지고 있는 Route만 수행한다.]]></desc>
			<sql><![CDATA[
INSERT INTO PRI_RP_SCP_RT(
    PROP_NO,
    AMDT_SEQ,
    SVC_SCP_CD,
    CMDT_HDR_SEQ,
    ROUT_SEQ,
    RT_SEQ,
    RAT_UT_CD,
    PRC_CGO_TP_CD,
    CURR_CD,
    PROP_FRT_RT_AMT,
    COFFR_FRT_RT_AMT,
    FNL_FRT_RT_AMT,
    BZC_OFRT_RT_AMT,
    ORG_ARB_AMT,
    RAIL_HUB_LOC_CD,
    DEST_ARB_AMT,
    DOR_TRKA_AMT,
    PRS_SCG_AMT,
    PRS_RESPB_CM_UC_AMT,
    PRS_PFIT_CM_UC_AMT,
    PRS_RESPB_OPFIT_UC_AMT,
    PRS_RESPB_CMPB_AMT,
    PRS_PFIT_CMPB_AMT,
    PRS_RESPB_OPB_AMT,
    PRS_GID_CMPB_AMT,
    PRS_UPD_DT,
    VSL_SLAN_CD,
    GRI_APPL_TP_CD,
    GRI_APPL_AMT,
    PRC_PROG_STS_CD,
    SRC_INFO_CD,
    ACPT_USR_ID,
    ACPT_OFC_CD,
    ACPT_DT,
    CRE_USR_ID,
    CRE_DT,
    UPD_USR_ID,
    UPD_DT,
    N1ST_CMNC_AMDT_SEQ,
    FIC_PROP_RT_AMT,
    FIC_COFFR_RT_AMT,
    FIC_FNL_RT_AMT,
    FIC_GLINE_RT_AMT,
    FIC_GLINE_UPD_DT,
    OPTM_TRSP_MOD_FLG,
    FIC_RT_USE_STS_CD,
    FIC_DEST_RT_USE_STS_CD,
    FIC_DEST_PROP_RT_AMT,
    FIC_DEST_COFFR_RT_AMT, 
    FIC_DEST_FNL_RT_AMT, 
    FIC_DEST_GLINE_RT_AMT, 
    FIC_DEST_GLINE_UPD_DT, 
    DEST_OPTM_TRSP_MOD_FLG,
    FIC_ORG_RT_USE_STS_CD, 
    FIC_ORG_PROP_RT_AMT, 
    FIC_ORG_COFFR_RT_AMT,
    FIC_ORG_FNL_RT_AMT,  
    FIC_ORG_GLINE_RT_AMT,
    FIC_ORG_GLINE_UPD_DT,
    ORG_OPTM_TRSP_MOD_FLG,
    MST_RFA_ROUT_ID
)
WITH MASTER_RFA_INFO AS (
    SELECT MN.PROP_NO, MAX(MN.AMDT_SEQ) AS AMDT_SEQ, SVC_SCP_CD
       FROM PRI_RP_MN MN, PRI_RP_SCP_RT_CMDT_ROUT ROUT
      WHERE MN.PROP_NO = (SELECT PROP_NO FROM PRI_RP_HDR WHERE RFA_NO = @[mst_rfa_no]) -- Mst RFA No
        AND MN.PROP_NO = ROUT.PROP_NO
        AND MN.AMDT_SEQ = ROUT.AMDT_SEQ
        AND PROP_STS_CD = 'A'
      GROUP BY MN.PROP_NO, SVC_SCP_CD
),
BASIC_RFA_INFO AS (
	SELECT PROP_NO, AMDT_SEQ, SVC_SCP_CD, CMDT_HDR_SEQ, ROUT_SEQ, MST_ROUT_ID
	  FROM PRI_RP_SCP_RT_CMDT_ROUT
	 WHERE PROP_NO = @[prop_no]
	   AND AMDT_SEQ =  @[amdt_seq]
)
SELECT
    B.PROP_NO                 ,
    B.AMDT_SEQ+1              ,
    B.SVC_SCP_CD              ,
    B.CMDT_HDR_SEQ            ,
    B.ROUT_SEQ                ,
    B.RT_SEQ                  ,
    B.RAT_UT_CD               ,
    B.PRC_CGO_TP_CD           ,
    M.CURR_CD                 ,
    M.PROP_FRT_RT_AMT         ,
    M.COFFR_FRT_RT_AMT        ,
    M.FNL_FRT_RT_AMT          ,
    M.BZC_OFRT_RT_AMT         ,
    M.ORG_ARB_AMT             ,
    M.RAIL_HUB_LOC_CD         ,
    M.DEST_ARB_AMT            ,
    M.DOR_TRKA_AMT            ,
    M.PRS_SCG_AMT             ,
    M.PRS_RESPB_CM_UC_AMT     ,
    M.PRS_PFIT_CM_UC_AMT      ,
    M.PRS_RESPB_OPFIT_UC_AMT  ,
    M.PRS_RESPB_CMPB_AMT      ,
    M.PRS_PFIT_CMPB_AMT       ,
    M.PRS_RESPB_OPB_AMT       ,
    M.PRS_GID_CMPB_AMT        ,
    M.PRS_UPD_DT              ,
    M.VSL_SLAN_CD             ,
    'N'                     ,
    0                       ,
    DECODE(M.SRC_INFO_CD, 'AM', 'I', 'AD', 'I', M.PRC_PROG_STS_CD),
    M.SRC_INFO_CD             ,
    B.ACPT_USR_ID             ,
    B.ACPT_OFC_CD             ,
    B.ACPT_DT                 ,
    @[cre_usr_id]           ,
    SYSDATE                 ,
    @[upd_usr_id]           ,
    SYSDATE                 ,
    CASE WHEN M.SRC_INFO_CD IN ('AM', 'AD') AND M.N1ST_CMNC_AMDT_SEQ > TO_NUMBER(SUBSTR(B.MST_RFA_ROUT_ID, INSTR(B.MST_RFA_ROUT_ID,'_')+1,3))   THEN B.AMDT_SEQ+1 
         ELSE B.AMDT_SEQ 
    END AS N1ST_CMNC_AMDT_SEQ ,
    M.FIC_PROP_RT_AMT         ,
    M.FIC_COFFR_RT_AMT        ,
    M.FIC_FNL_RT_AMT          ,
    M.FIC_GLINE_RT_AMT        ,
    M.FIC_GLINE_UPD_DT        ,
    M.OPTM_TRSP_MOD_FLG       ,
    M.FIC_RT_USE_STS_CD       ,
    M.FIC_DEST_RT_USE_STS_CD  ,
    M.FIC_DEST_PROP_RT_AMT    ,
    M.FIC_DEST_COFFR_RT_AMT   , 
    M.FIC_DEST_FNL_RT_AMT     , 
    M.FIC_DEST_GLINE_RT_AMT   , 
    M.FIC_DEST_GLINE_UPD_DT   , 
    M.DEST_OPTM_TRSP_MOD_FLG  ,
    M.FIC_ORG_RT_USE_STS_CD   , 
    M.FIC_ORG_PROP_RT_AMT     , 
    M.FIC_ORG_COFFR_RT_AMT    ,
    M.FIC_ORG_FNL_RT_AMT      ,  
    M.FIC_ORG_GLINE_RT_AMT    ,
    M.FIC_ORG_GLINE_UPD_DT    ,
    M.ORG_OPTM_TRSP_MOD_FLG   ,
    @[mst_rfa_no] ||'_'|| LPAD(M.AMDT_SEQ, 3, '0') ||'_'|| LPAD(BSC_INFO.MST_ROUT_ID, 3, '0')
  FROM MASTER_RFA_INFO MST_INFO,
       PRI_RP_SCP_RT M,-- Master
       BASIC_RFA_INFO BSC_INFO,
       PRI_RP_SCP_RT B -- Basic
 WHERE 
   -- Master
       M.PROP_NO = MST_INFO.PROP_NO
   AND M.AMDT_SEQ = MST_INFO.AMDT_SEQ
   AND M.SVC_SCP_CD = MST_INFO.SVC_SCP_CD
   -- Basic
   AND B.PROP_NO = BSC_INFO.PROP_NO
   AND B.AMDT_SEQ = BSC_INFO.AMDT_SEQ
   AND B.SVC_SCP_CD = BSC_INFO.SVC_SCP_CD
   AND B.CMDT_HDR_SEQ = BSC_INFO.CMDT_HDR_SEQ
   AND B.ROUT_SEQ = BSC_INFO.ROUT_SEQ
   -- Join
   AND B.SVC_SCP_CD = M.SVC_SCP_CD
   AND B.CMDT_HDR_SEQ = M.CMDT_HDR_SEQ
   AND BSC_INFO.MST_ROUT_ID = M.ROUT_SEQ
   AND B.RT_SEQ = M.RT_SEQ			]]></sql>
			<params>
				<param name="mst_rfa_no" type="12" value="" out="N"/>
				<param name="prop_no" type="12" value="" out="N"/>
				<param name="amdt_seq" type="12" value="" out="N"/>
				<param name="cre_usr_id" type="12" value="" out="N"/>
				<param name="upd_usr_id" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
