<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="StatusReportDBDAOCntrStowageintVORSQL">
			<desc><![CDATA[   ]]></desc>
			<sql><![CDATA[
------------------------------------------------------------------------------                                                         
--****************************************************************************                                                         
------------------------------------------------------------------------------                                                         
WITH TEMP_T AS (                                                                                                                       
#if (${bkg_cgo_ty_cd} == 'U')                                                                                                          
                                                                                                                                       
#if (${bkg_ofc_cd} != '')                                                                                                              
-------------------------------------------------------------------------------------                                                  
--1.UNMATCH	                                                                                                                       
  --1-1.OFFICE에 값 존재시                                                                                                             
-------------------------------------------------------------------------------------                                                  
	                                                                                                                               
	SELECT /*+ USE_MERGE (BAY, ST) INDEX(BAY XPKBAY_PLAN_LDS) */  DISTINCT                                                                 
              NVL(BAY.CNTR_REF_NO,'') CNTR_NO				--Container No                                                 
         ,    NVL(ST.CNTR_TPSZ_CD,'') CNTRTS_CD		--T/P                                                                          
         ,    'No' FLG								--Load                                                 
         ,    NVL(BKG_NO,'') BKG_NO					--BKG No                                                       
         ,    NVL(BL_NO,'') BL_NO					--B/L No                                                       
         ,    NVL(ST.POL_CD,'') BK_POL				--B/L POL                                                              
         ,    NVL(ST.POD_CD,'') BK_POD				--B/L POD                                                              
         ,    NVL(BAY.POL_CD,'') BAY_POL			--STWG POL                                                             
         ,    NVL(BAY.POD_CD,'') BAY_POD			--STWG POD                                                             
         ,    '' STWG								--Stowage                                              
         ,    DECODE(NVL(CGO_TP,'M'),'M',NVL(LODG_DCHG_IND_CD,''),NVL(CGO_TP,'')) CGO_TP  --Stowage                                    
         ,    DG	--Special Container                                                                                            
         ,    BB                                                                                                                       
         ,    AK                                                                                                                       
         ,    RF                                                                                                                       
         ,    PC                                                                                                                       
		 ,	  '' VVD_CD			--VVD                                                                          
		 ,    '' POL_CD			--POL                                                                                  
	     ,	  '' BOUND_TYPE		--공통 code(Inbound인경우는 POD_CD,OutBound인경우는 POL_CD가 입력된 Port Code임)               
		 ,    '' STWG_STATUS	--Current,Previous                                                                             
         ,    '' BKG_OFC_CD     --B/OFC                                                                                                
         ,    '' BKG_CGO_TY_CD  --STWG & Doc (UNMATCH,MATCH)                                                                           
		 ,	  '' SP_CNTR_TY_CD  --Special CNTR(DG,AK,BB...)	                                                               
		 ,     decode((select  count(*) from bkg_container c,bkg_booking b                                                     
                where c.bkg_no      = b.bkg_no                                                                                         
                and   c.cntr_no     = st.cntr_no                                                                                       
                and   b.vsl_cd      = st.bt_vsl_cd                                                                                     
                and   b.skd_voy_no  = st.bt_skd_voy_no                                                                                 
                and   b.skd_dir_cd  = st.bt_skd_dir_cd                                                                                 
                and   b.pol_cd      = st.pol_cd                                                                                        
                and   b.pod_cd      = st.pod_cd                                                                                        
                AND   BKG_STS_CD IN ('F','A','W','S')                                                                                  
                ),1,'N','Y') HBL                                                                                                       
       FROM   (SELECT /*+ INDEX(BB XPKBAY_PLAN_LDS ) */                                                                                
                      POL_CD                                                                                                           
               ,      POD_CD                                                                                                           
               ,      CNTR_REF_NO   --BPS_CNTR_NO                                                                                      
               ,      VSL_CD                                                                                                           
               ,      SKD_VOY_NO                                                                                                       
               ,      SKD_DIR_CD                                                                                                       
               ,      COD_PORT_CD  --VPS_LOC_CD                                                                                        
               ,      LODG_DCHG_IND_CD                                                                                                 
               FROM   OPF_BAY_PLN_LDIS                                                                                                 
               WHERE  1=1                                                                                                              
#if (${vvd_cd} != '')                                                                                                                  
		  		AND (VSL_CD, SKD_VOY_NO, SKD_DIR_CD,LODG_VSL_CD,LODG_VOY_NO,LODG_DIR_CD) IN (                          
          		                                                                                                               
                         SELECT SKD.VSL_CD,SKD.SKD_VOY_NO,SKD.SKD_DIR_CD,SKD.VSL_CD,SKD.SKD_VOY_NO,SKD.SKD_DIR_CD                      
                         FROM   VSK_VSL_PORT_SKD SKD                                                                                   
                         WHERE  VSL_CD =SUBSTR(@[vvd_cd],1,4)                                                                          
                         AND    SKD_VOY_NO =SUBSTR(@[vvd_cd],5,4)                                                                      
                         AND    SKD_DIR_CD = SUBSTR(@[vvd_cd],9,1)                                                                     
                         AND    VPS_PORT_CD =@[pol_cd])	                                                                               
#end	                                                                                                                               
#if (${bound_type} == 'I')                                                                                                             
	AND    POD_CD LIKE '%' || @[pol_cd] || '%'                                                                                     
#else                                                                                                                                  
	AND    POL_CD LIKE '%' || @[pol_cd] || '%'                                                                                     
#end                                                                                                                                   
#if (${stwg_status} != 'C')                                                                                                            
	                                                                                                                               
				AND LODG_DCHG_IND_CD  = DECODE(@[bound_type],'I','D','L')  --IN ('L','D')                              
#else                                                                                                                                  
				AND LODG_DCHG_IND_CD = 'C'                                                                             
#end                                                                                                                                   
				AND CRR_CD ='SML'                                                                                      
               ) BAY,                                                                                                                  
               (SELECT /*+ USE_NL(BKG_VVD,B,BKG_CNTR) */                                                                               
                      B.BKG_NO                                                                                                         
                ,     BKG_VVD.VSL_CD                                                                                                   
                ,     B.POL_CD                                                                                                         
                ,     B.POD_CD                                                                                                         
                ,     BKG_CNTR.CNTR_NO                                                                                                 
                ,     BKG_CNTR.CNTR_TPSZ_CD                                                                                            
                ,     B.BL_NO --||B.BL_NO_TP||B.BL_NO_CHK|| B.BL_NO_TP BL_NO                                                           
                ,     B.BKG_CGO_TP_CD  CGO_TP                                                                                          
				,     DECODE(BKG_CNTR.DCGO_FLG,'Y','DG','') DG                                                         
                ,     DECODE(BKG_CNTR.BB_CGO_FLG,'Y','BB','') BB                                                                       
                ,     DECODE(BKG_CNTR.AWK_CGO_FLG,'Y','AK','') AK                                                                      
                ,     DECODE(BKG_CNTR.RC_FLG,'Y','RF','') RF                                                                       
                ,     DECODE(B.PRCT_FLG,'Y','PC','') PC                                                                                  
				,     B.VSL_CD bt_vsl_cd                                                                               
				,     B.SKD_VOY_NO bt_skd_voy_no                                                                       
				,     B.SKD_DIR_CD bt_skd_dir_cd                                                                       
                                                                                                                                       
                FROM   BKG_CONTAINER BKG_CNTR, BKG_BOOKING B,BKG_VVD                                                                   
                WHERE  BKG_VVD.BKG_NO   = B.BKG_NO                                                                                     
                AND    B.BKG_NO             = BKG_CNTR.BKG_NO                                                                          
                                                                                                                                       
#if (${vvd_cd} != '')                                                                                                                  
		  		AND (BKG_VVD.VSL_CD, BKG_VVD.SKD_VOY_NO, BKG_VVD.SKD_DIR_CD) IN (                                      
          		                                                                                                               
                         SELECT SKD.VSL_CD,SKD.SKD_VOY_NO,SKD.SKD_DIR_CD                                                               
                         FROM   VSK_VSL_PORT_SKD SKD                                                                                   
                         WHERE  VSL_CD =SUBSTR(@[vvd_cd],1,4)                                                                          
                         AND    SKD_VOY_NO =SUBSTR(@[vvd_cd],5,4)                                                                      
                         AND    SKD_DIR_CD = SUBSTR(@[vvd_cd],9,1)                                                                     
                         AND    VPS_PORT_CD =@[pol_cd])	                                                                               
#end                                                                                                                                   
                                                                                                                                       
#if (${sp_cntr_ty_cd} != '')                                                                                                           
				AND    CASE WHEN @[sp_cntr_ty_cd]= 'DG' THEN BKG_CNTR.DCGO_FLG                                         
            				WHEN @[sp_cntr_ty_cd]= 'BB' THEN BKG_CNTR.BB_CGO_FLG                                           
           	 				WHEN @[sp_cntr_ty_cd]= 'AK' THEN BKG_CNTR.AWK_CGO_FLG                                  
							WHEN @[sp_cntr_ty_cd]= 'RF' THEN BKG_CNTR.RC_FLG                           
            				WHEN @[sp_cntr_ty_cd]= 'PC' THEN B.PRCT_FLG ELSE 'Y' END = 'Y'                                 
#end                                                                                                                                   
                                                                                                                                       
#if (${bound_type} == 'I')                                                                                                             
	     		AND    BKG_VVD.POD_CD LIKE '%' || @[pol_cd] || '%'                                                             
#else                                                                                                                                  
	     		AND    BKG_VVD.POL_CD LIKE '%' || @[pol_cd] || '%'                                                             
#end                                                                                                                                   
                                                                                                                                       
#if (${bkg_ofc_cd} != '')                                                                                                              
                AND    B.BKG_OFC_CD  LIKE '%' || @[bkg_ofc_cd] || '%'                                                                  
#end                                                                                                                                   
                AND    B.BKG_STS_CD IN ('A','F','W','S') ) ST                                                                          
         WHERE CNTR_NO = CNTR_REF_NO(+)                                                                                                
         AND   CNTR_REF_NO IS NULL                                                                                                     
                                                                                                                                       
#else                                                                                                                                  
-----------------------------------------------------------------------------------                                                    
--1.UNMATCH	                                                                                                                       
  --1-2.OFFICE에 값 없을시                                                                                                             
-------------------------------------------------------------------------------------                                                  
	SELECT /*+ use_hash(bay st) INDEX(bay)*/ /* @@ 힌트적용  2014.11.24 튜닝 */
#if (${bound_type} == 'I')   
						/*+ INDEX(bay XAK5OPF_BAY_PLN_LDIS) */  /* 2014.11.24 튜닝 힌트 추가*/                                                                              
#end	
			  DISTINCT                                             
              NVL(BAY.CNTR_REF_NO,'') CNTR_NO                                                                                          
      ,       NVL(ST.CNTR_TPSZ_CD,'') CNTRTS_CD                                                                                        
      ,       'Yes' FLG                                                                                                                  
      ,       '' BKG_NO                                                                                                                
      ,       NVL(BL_NO,'') BL_NO                                                                                                      
      ,       NVL(ST.POL_CD,'') BK_POL                                                                                                 
      ,       NVL(ST.POD_CD,'') BK_POD                                                                                                 
      ,       NVL(BAY.POL_CD,'') BAY_POL                                                                                               
      ,       NVL(BAY.POD_CD,'') BAY_POD                                                                                               
      ,       NVL(BAY.VSL_BAY_NO||BAY.VSL_ROW_NO||BAY.VSL_TR_NO,'') STWG                                                               
      ,       DECODE(NVL(CGO_TP,'M'),'M',NVL(BAY.LODG_DCHG_IND_CD,''),NVL(CGO_TP,'')) CGO_TP                                           
      ,       DG                                                                                                                       
      ,       BB                                                                                                                       
      ,       AK                                                                                                                       
      ,       RF                                                                                                                       
      ,       PC                                                                                                                       
      ,	  	  '' VVD_CD			--VVD                                                                                  
	  ,       '' POL_CD			--POL                                                                                  
	  ,	      '' BOUND_TYPE		--공통 code(Inbound인경우는 POD_CD,OutBound인경우는 POL_CD가 입력된 Port Code임)       
	  ,       '' STWG_STATUS	--Current,Previous                                                                             
      ,       '' BKG_OFC_CD     --B/OFC                                                                                                
      ,       '' BKG_CGO_TY_CD  --STWG & Doc (UNMATCH,MATCH)                                                                           
	  ,	      '' SP_CNTR_TY_CD  --Special CNTR(DG,AK,BB...)                                                                    
	  ,     decode((select  count(*) from bkg_container c,bkg_booking b                                                            
                where c.bkg_no      = b.bkg_no                                                                                         
                and   c.cntr_no     = st.cntr_no                                                                                       
                and   b.vsl_cd      = st.bt_vsl_cd                                                                                     
                and   b.skd_voy_no  = st.bt_skd_voy_no                                                                                 
                and   b.skd_dir_cd  = st.bt_skd_dir_cd                                                                                 
                and   b.pol_cd      = st.pol_cd                                                                                        
                and   b.pod_cd      = st.pod_cd                                                                                        
                AND   BKG_STS_CD IN ('F','A','W','S')                                                                                  
                ),1,'N','Y') HBL                                                                                                       
                                                                                                                                       
         FROM OPF_BAY_PLN_LDIS BAY                                                                                                     
         ,    (SELECT /*+ USE_NL(BKG_VVD,B,BKG_CNTR) */                                                                                
                      B.POL_CD                                                                                                         
               ,      B.POD_CD                                                                                                         
			   ,	  BKG_VVD.VSL_CD                                                                                       
			   , 	  BKG_VVD.SKD_VOY_NO                                                                                   
               , 	  BKG_VVD.SKD_DIR_CD	                                                                                       
               ,      BKG_CNTR.CNTR_NO                                                                                                 
               ,      BKG_CNTR.CNTR_TPSZ_CD                                                                                            
               ,      B.BL_NO  --||B.BL_NO_TP||B.BL_NO_CHK|| B.BL_NO_TP BL_NO                                                          
               ,      B.BKG_CGO_TP_CD  CGO_TP                                                                                          
               ,      DECODE(BKG_CNTR.DCGO_FLG,'Y','DG','') DG                                                                         
               ,      DECODE(BKG_CNTR.BB_CGO_FLG,'Y','BB','') BB                                                                       
               ,      DECODE(BKG_CNTR.AWK_CGO_FLG,'Y','AK','') AK                                                                      
               ,      DECODE(BKG_CNTR.RC_FLG,'Y','RF','') RF                                                                       
               ,      DECODE(B.PRCT_FLG,'Y','PC','') PC                                                                                   
			   ,     B.VSL_CD bt_vsl_cd                                                                                    
 			   ,     B.SKD_VOY_NO bt_skd_voy_no                                                                            
			   ,     B.SKD_DIR_CD bt_skd_dir_cd                                                                            
              	                                                                                                                       
               FROM   BKG_CONTAINER BKG_CNTR, BKG_BOOKING B,BKG_VVD                                                                    
               WHERE  BKG_VVD.BKG_NO = B.BKG_NO                                                                                        
               AND    B.BKG_NO = BKG_CNTR.BKG_NO                                                                                       
#if (${vvd_cd} != '')                                                                                                                  
		  		AND (BKG_VVD.VSL_CD, BKG_VVD.SKD_VOY_NO, BKG_VVD.SKD_DIR_CD) IN (                                      
          		                                                                                                               
                         SELECT SKD.VSL_CD,SKD.SKD_VOY_NO,SKD.SKD_DIR_CD                                                               
                         FROM   VSK_VSL_PORT_SKD SKD                                                                                   
                         WHERE  VSL_CD =SUBSTR(@[vvd_cd],1,4)                                                                          
                         AND    SKD_VOY_NO =SUBSTR(@[vvd_cd],5,4)                                                                      
                         AND    SKD_DIR_CD = SUBSTR(@[vvd_cd],9,1)                                                                     
                         AND    VPS_PORT_CD =@[pol_cd] 
						 AND    NVL(SKD_CNG_STS_CD,'X') <> 'S'
                         UNION ALL
                         SELECT SKD.VSL_CD,SKD.SKD_VOY_NO,SKD.SKD_DIR_CD                     
                         FROM   VSK_VSL_PORT_SKD SKD   
                         WHERE  VSL_CD =SUBSTR(@[vvd_cd],1,4)                                                                          
                         AND    TURN_SKD_VOY_NO =SUBSTR(@[vvd_cd],5,4)                                                                      
                         AND    TURN_SKD_DIR_CD = SUBSTR(@[vvd_cd],9,1)                                                                     
                         AND    VPS_PORT_CD =@[pol_cd] 
                         AND    NVL(SKD_CNG_STS_CD,'X') <> 'S' 
						)	                                                                              
#end			   	                                                                                                       
                                                                                                                                       
#if (${bound_type} == 'I')                                                                                                             
	     		AND BKG_VVD.POD_CD LIKE '%' || @[pol_cd] || '%'                                                                
#else                                                                                                                                  
	     		AND BKG_VVD.POL_CD LIKE '%' || @[pol_cd] || '%'                                                                
#end	                                                                                                                               
                AND    B.BKG_STS_CD IN ('F','W','A','S')                                                                               
               /*AND    (NVL(B.BKG_NO_GEN_IND,'M') = 'M') */ ) ST                                                                      
         WHERE BAY.CNTR_REF_NO   = CNTR_NO(+)                                                                                          
#if (${vvd_cd} != '')                                                                                                                  
		 AND   BAY.VSL_CD = ST.VSL_CD(+)                                                                                          
         AND   BAY.SKD_VOY_NO = ST.SKD_VOY_NO(+)                                                                                          
         AND   BAY.SKD_DIR_CD = ST.SKD_DIR_CD(+)                                                                                          
         AND   ((BAY.VSL_CD, BAY.SKD_VOY_NO, BAY.SKD_DIR_CD) IN (                       
                                                                                                                                       
			SELECT SKD.VSL_CD,SKD.SKD_VOY_NO,SKD.SKD_DIR_CD
			FROM   VSK_VSL_PORT_SKD SKD                                                                                    
            WHERE  VSL_CD =SUBSTR(@[vvd_cd],1,4)                                                                                       
            AND    SKD_VOY_NO =SUBSTR(@[vvd_cd],5,4)                                                                                   
            AND    SKD_DIR_CD = SUBSTR(@[vvd_cd],9,1)                                                                                  
            AND    VPS_PORT_CD =@[pol_cd]
			UNION ALL
            SELECT SKD.VSL_CD,SKD.SKD_VOY_NO,SKD.SKD_DIR_CD                 
            FROM   VSK_VSL_PORT_SKD SKD   
            WHERE  VSL_CD =SUBSTR(@[vvd_cd],1,4)                                                                          
            AND    TURN_SKD_VOY_NO =SUBSTR(@[vvd_cd],5,4)                                                                      
            AND    TURN_SKD_DIR_CD = SUBSTR(@[vvd_cd],9,1)                                                                     
            AND    VPS_PORT_CD =@[pol_cd]
            AND    NVL(SKD_CNG_STS_CD,'X') <> 'S'  

			)   
			OR    
			(BAY.LODG_VSL_CD,BAY.LODG_VOY_NO,BAY.LODG_DIR_CD) IN (                       
            SELECT SKD.VSL_CD,SKD.SKD_VOY_NO,SKD.SKD_DIR_CD                       
			FROM   VSK_VSL_PORT_SKD SKD                                                                                    
            WHERE  VSL_CD =SUBSTR(@[vvd_cd],1,4)                                                                                       
            AND    SKD_VOY_NO =SUBSTR(@[vvd_cd],5,4)                                                                                   
            AND    SKD_DIR_CD = SUBSTR(@[vvd_cd],9,1)                                                                                  
            AND    VPS_PORT_CD =@[pol_cd]
			UNION ALL
            SELECT SKD.VSL_CD,SKD.SKD_VOY_NO,SKD.SKD_DIR_CD                 
            FROM   VSK_VSL_PORT_SKD SKD   
            WHERE  VSL_CD =SUBSTR(@[vvd_cd],1,4)                                                                          
            AND    TURN_SKD_VOY_NO =SUBSTR(@[vvd_cd],5,4)                                                                      
            AND    TURN_SKD_DIR_CD = SUBSTR(@[vvd_cd],9,1)                                                                     
            AND    VPS_PORT_CD =@[pol_cd]
            AND    NVL(SKD_CNG_STS_CD,'X') <> 'S'  
            ))                                                                  
#end		                                                                                                                       
#if (${bound_type} == 'I')                                                                                                             
	     AND    BAY.POD_CD LIKE '%' || @[pol_cd] || '%'                                                                            
#else                                                                                                                                  
	     AND    BAY.POL_CD LIKE '%' || @[pol_cd] || '%'                                                                            
#end                                                                                                                                   
                                                                                                                                       
#if (${sp_cntr_ty_cd} != '')                                                                                                           
		 AND    CASE WHEN @[sp_cntr_ty_cd]= 'DG' THEN ST.DG                                                                    
            		 WHEN @[sp_cntr_ty_cd]= 'BB' THEN ST.BB                                                                        
           	 		 WHEN @[sp_cntr_ty_cd]= 'AK' THEN ST.AK                                                                
					 WHEN @[sp_cntr_ty_cd]= 'RF' THEN ST.RF                                                        
            		 WHEN @[sp_cntr_ty_cd]= 'PC' THEN ST.PC ELSE 'Y' END = 'Y'                                                     
#end                                                                                                                                   
                                                                                                                                       
         AND   CNTR_NO IS  NULL                                                                                                        
                                                                                                                                       
#if (${lodg_dchg_ind_cd} != '')                                                                                                        
		 AND   DECODE(NVL(CGO_TP,'M'),'M',NVL(BAY.LODG_DCHG_IND_CD,''),NVL(CGO_TP,'')) = @[lodg_dchg_ind_cd]                   
#end                                                                                                                                   
#if (${stwg_status} != 'C')                                                                                                            
		AND BAY.LODG_DCHG_IND_CD  IN ('L','D')                                                                                 
#else                                                                                                                                  
		AND BAY.LODG_DCHG_IND_CD = 'C'                                                                                         
#end                                                                                                                                   
		AND BAY.CRR_CD ='SML'                                                                                                  
                                                                                                                                       
       UNION ALL                                                                                                                       
       SELECT /*+ USE_MERGE (BAY, ST) INDEX(BAY XPKBAY_PLAN_LDS ) */                                                                   
              NVL(CNTR_NO,'') CNTR_NO                                                                                                  
       ,      NVL(ST.CNTR_TPSZ_CD,'') CNTRTS_CD                                                                                        
       ,      'No' FLG                                                                                                                  
       ,      NVL(BKG_NO,'') BKG_NO                                                                                                    
       ,      NVL(BL_NO,'') BL_NO                                                                                                      
       ,      NVL(ST.POL_CD,'') BK_POL                                                                                                 
       ,      NVL(ST.POD_CD,'') BK_POD                                                                                                 
       ,      NVL(BAY.POL_CD,'') BAY_POL                                                                                               
       ,      NVL(BAY.POD_CD,'') BAY_POD                                                                                               
       ,      '' STWG                                                                                                                  
       ,      DECODE(NVL(CGO_TP,'M'),'M',NVL(LODG_DCHG_IND_CD,' '),NVL(CGO_TP,' ')) CGO_TP                                             
       ,      DG                                                                                                                       
       ,      BB                                                                                                                       
       ,      AK                                                                                                                       
       ,      RF                                                                                                                       
       ,      PC                                                                                                                       
	  ,	  	  '' VVD_CD			--VVD                                                                          
	  ,       '' POL_CD			--POL                                                                                  
	  ,	      '' BOUND_TYPE		--공통 code(Inbound인경우는 POD_CD,OutBound인경우는 POL_CD가 입력된 Port Code임)       
      ,    	  '' STWG_STATUS	--Current,Previous                                                                             
      ,       '' BKG_OFC_CD     --B/OFC                                                                                                
      ,       '' BKG_CGO_TY_CD  --STWG & Doc (UNMATCH,MATCH)                                                                           
	  ,	      '' SP_CNTR_TY_CD  --Special CNTR(DG,AK,BB...)                                                                    
	  ,     decode((select  count(*) from bkg_container c,bkg_booking b                                                            
                where c.bkg_no      = b.bkg_no                                                                                         
                and   c.cntr_no     = st.cntr_no                                                                                       
                and   b.vsl_cd      = st.bt_vsl_cd                                                                                     
                and   b.skd_voy_no  = st.bt_skd_voy_no                                                                                 
                and   b.skd_dir_cd  = st.bt_skd_dir_cd                                                                                 
                and   b.pol_cd      = st.pol_cd                                                                                        
                and   b.pod_cd      = st.pod_cd                                                                                        
                AND   BKG_STS_CD IN ('F','A','W','S')                                                                                  
                ),1,'N','Y') HBL                                                                                                       
                                                                                                                                       
       FROM   (SELECT /*+ INDEX(BB XPKBAY_PLAN_LDS ) */                                                                                
                      POL_CD                                                                                                           
               ,      POD_CD                                                                                                           
               ,      CNTR_REF_NO   --BPS_CNTR_NO                                                                                      
               ,      VSL_CD                                                                                                           
               ,      SKD_VOY_NO                                                                                                       
               ,      SKD_DIR_CD                                                                                                       
               ,      COD_PORT_CD  --VPS_LOC_CD                                                                                        
               ,      LODG_DCHG_IND_CD                                                                                                 
               FROM   OPF_BAY_PLN_LDIS                                                                                                 
               WHERE  1=1                                                                                                              
#if (${vvd_cd} != '')                                                                                                                  
			   #if (${vvd_cd} != '')                                                                                       
		  		AND ((VSL_CD, SKD_VOY_NO, SKD_DIR_CD) IN (                          
          		                                                                                                               
                         SELECT SKD.VSL_CD,SKD.SKD_VOY_NO,SKD.SKD_DIR_CD                    
                         FROM   VSK_VSL_PORT_SKD SKD                                                                                   
                         WHERE  VSL_CD =SUBSTR(@[vvd_cd],1,4)                                                                          
                         AND    SKD_VOY_NO =SUBSTR(@[vvd_cd],5,4)                                                                      
                         AND    SKD_DIR_CD = SUBSTR(@[vvd_cd],9,1)                                                                     
                         AND    VPS_PORT_CD =@[pol_cd]
						 AND    NVL(SKD_CNG_STS_CD,'X') <> 'S'
                         UNION ALL
                         SELECT SKD.VSL_CD,SKD.SKD_VOY_NO,SKD.SKD_DIR_CD                     
                         FROM   VSK_VSL_PORT_SKD SKD   
                         WHERE  VSL_CD =SUBSTR(@[vvd_cd],1,4)                                                                          
                         AND    TURN_SKD_VOY_NO =SUBSTR(@[vvd_cd],5,4)                                                                      
                         AND    TURN_SKD_DIR_CD = SUBSTR(@[vvd_cd],9,1)                                                                     
                         AND    VPS_PORT_CD =@[pol_cd]
                         AND    NVL(SKD_CNG_STS_CD,'X') <> 'S'

						)	
			 	OR (LODG_VSL_CD,LODG_VOY_NO,LODG_DIR_CD) IN (                          
          		                                                                                                               
                         SELECT SKD.VSL_CD,SKD.SKD_VOY_NO,SKD.SKD_DIR_CD                     
                         FROM   VSK_VSL_PORT_SKD SKD                                                                                   
                         WHERE  VSL_CD =SUBSTR(@[vvd_cd],1,4)                                                                          
                         AND    SKD_VOY_NO =SUBSTR(@[vvd_cd],5,4)                                                                      
                         AND    SKD_DIR_CD = SUBSTR(@[vvd_cd],9,1)                                                                     
                         AND    VPS_PORT_CD =@[pol_cd]
						 AND    NVL(SKD_CNG_STS_CD,'X') <> 'S'
                         UNION ALL
                         SELECT SKD.VSL_CD,SKD.SKD_VOY_NO,SKD.SKD_DIR_CD                     
                         FROM   VSK_VSL_PORT_SKD SKD   
                         WHERE  VSL_CD =SUBSTR(@[vvd_cd],1,4)                                                                          
                         AND    TURN_SKD_VOY_NO =SUBSTR(@[vvd_cd],5,4)                                                                      
                         AND    TURN_SKD_DIR_CD = SUBSTR(@[vvd_cd],9,1)                                                                     
                         AND    VPS_PORT_CD =@[pol_cd]
                         AND    NVL(SKD_CNG_STS_CD,'X') <> 'S'

						))                                                                               
#end                                                                                                                                   
#end                                                                                                                                   
#if (${bound_type} == 'I')                                                                                                             
	     		AND POD_CD LIKE '%' || @[pol_cd] || '%'                                                                        
#else                                                                                                                                  
	     		AND POL_CD LIKE '%' || @[pol_cd] || '%'                                                                        
#end                                                                                                                                   
#if (${stwg_status} != 'C')                                                                                                            
				AND LODG_DCHG_IND_CD  IN ('L','D')                                                                     
#else                                                                                                                                  
				AND LODG_DCHG_IND_CD = 'C'                                                                             
#end                                                                                                                                   
				AND CRR_CD ='SML'                                                                                      
               ) BAY ,                                                                                                                 
               (SELECT /*+ USE_NL(BKG_VVD,B,BKG_CNTR) */                                                                               
                      B.BKG_NO                                                                                                         
                ,     BKG_VVD.VSL_CD                                                                                                   
                ,     B.POL_CD                                                                                                         
                ,     B.POD_CD                                                                                                         
                ,     BKG_CNTR.CNTR_NO                                                                                                 
                ,     BKG_CNTR.CNTR_TPSZ_CD                                                                                            
                ,     B.BL_NO  --||B.BL_NO_TP||B.BL_NO_CHK|| B.BL_NO_TP BL_NO                                                          
                ,     B.BKG_CGO_TP_CD  CGO_TP                                                                                          
                ,     DECODE(BKG_CNTR.DCGO_FLG,'Y','DG','') DG                                                                         
                ,     DECODE(BKG_CNTR.BB_CGO_FLG,'Y','BB','') BB                                                                       
                ,     DECODE(BKG_CNTR.AWK_CGO_FLG,'Y','AK','') AK                                                                      
                ,     DECODE(BKG_CNTR.RC_FLG,'Y','RF','') RF                                                                       
                ,     DECODE(B.PRCT_FLG,'Y','PC','') PC                                                                                                       
				,     B.VSL_CD bt_vsl_cd                                                                               
				,     B.SKD_VOY_NO bt_skd_voy_no                                                                       
				,     B.SKD_DIR_CD bt_skd_dir_cd                                                                       
                                                                                                                                       
                FROM   BKG_CONTAINER BKG_CNTR                                                                                          
                ,      BKG_BOOKING B                                                                                                   
                ,      BKG_VVD                                                                                                         
                WHERE  BKG_VVD.BKG_NO = B.BKG_NO                                                                                       
                AND    B.BKG_NO = BKG_CNTR.BKG_NO                                                                                      
#if (${vvd_cd} != '')                                                                                                                  
		  		AND (BKG_VVD.VSL_CD, BKG_VVD.SKD_VOY_NO, BKG_VVD.SKD_DIR_CD) IN (                                      
          		                                                                                                               
                         SELECT SKD.VSL_CD,SKD.SKD_VOY_NO,SKD.SKD_DIR_CD                                                               
                         FROM   VSK_VSL_PORT_SKD SKD                                                                                   
                         WHERE  VSL_CD =SUBSTR(@[vvd_cd],1,4)                                                                          
                         AND    SKD_VOY_NO =SUBSTR(@[vvd_cd],5,4)                                                                      
                         AND    SKD_DIR_CD = SUBSTR(@[vvd_cd],9,1)                                                                     
                         AND    VPS_PORT_CD =@[pol_cd]
						 AND    NVL(SKD_CNG_STS_CD,'X') <> 'S'
						 UNION ALL
                         SELECT SKD.VSL_CD,SKD.SKD_VOY_NO,SKD.SKD_DIR_CD                     
                         FROM   VSK_VSL_PORT_SKD SKD   
                         WHERE  VSL_CD =SUBSTR(@[vvd_cd],1,4)                                                                          
                         AND    TURN_SKD_VOY_NO =SUBSTR(@[vvd_cd],5,4)                                                                      
                         AND    TURN_SKD_DIR_CD = SUBSTR(@[vvd_cd],9,1)                                                                     
                         AND    VPS_PORT_CD =@[pol_cd]
                         AND    NVL(SKD_CNG_STS_CD,'X') <> 'S'
						)	                                                                               
#end  	                                                                                                                               
#if (${sp_cntr_ty_cd} != '')                                                                                                           
				AND    CASE WHEN @[sp_cntr_ty_cd]= 'DG' THEN BKG_CNTR.DCGO_FLG                                         
            				WHEN @[sp_cntr_ty_cd]= 'BB' THEN BKG_CNTR.BB_CGO_FLG                                           
           	 				WHEN @[sp_cntr_ty_cd]= 'AK' THEN BKG_CNTR.AWK_CGO_FLG                                  
							WHEN @[sp_cntr_ty_cd]= 'RF' THEN BKG_CNTR.RC_FLG                           
            				WHEN @[sp_cntr_ty_cd]= 'PC' THEN B.PRCT_FLG ELSE 'Y' END = 'Y'                                 
#end                                                                                                                                   
                                                                                                                                       
                                                                                                                                       
#if (${bound_type} == 'I')                                                                                                             
	     		AND BKG_VVD.POD_CD LIKE '%' || @[pol_cd] || '%'                                                                
#else                                                                                                                                  
	     		AND BKG_VVD.POL_CD LIKE '%' || @[pol_cd] || '%'                                                                
#end                                                                                                                                   
                AND B.BKG_STS_CD IN ( 'A','F','W','S')) ST                                                                             
       WHERE    CNTR_NO    = CNTR_REF_NO(+)                                                                                            
       AND      CNTR_REF_NO IS  NULL                                                                                                   
#if (${cgo_tp} != '' && ${cgo_tp} != 'ALL')                                                                                            
		 AND   DECODE(NVL(CGO_TP,'M'),'M',NVL(LODG_DCHG_IND_CD,''),NVL(CGO_TP,'')) = @[cgo_tp]                                 
#end                                                                                                                                   
                                                                                                                                       
                                                                                                                                       
#end                                                                                                                                   
                                                                                                                                       
#else                                                                                                                                  
-----------------------------------------------------------------------------------                                                    
--2.MATCH                                                                                                                              
-------------------------------------------------------------------------------------                                                  
   SELECT /*+ USE_MERGE (BAY_PLAN_LDS, ST)INDEX(BAY_PLAN_LDS XPKBAY_PLAN_LDS ) */   DISTINCT                                                   
           NVL(BAY.CNTR_REF_NO,'') CNTR_NO                                                                                             
   ,       NVL(ST.CNTR_TPSZ_CD,'') CNTRTS_CD                                                                                           
   ,       'Yes' FLG                                                                                                                     
   ,       BKG_NO                                                                                                                      
   ,       NVL(BL_NO,'') BL_NO                                                                                                         
   ,       NVL(ST.POL_CD,'') BK_POL                                                                                                    
   ,       NVL(ST.POD_CD,'') BK_POD                                                                                                    
   ,       NVL(BAY.POL_CD,'') BAY_POL                                                                                                  
   ,       NVL(BAY.POD_CD,'') BAY_POD                                                                                                  
   ,       NVL(BAY.VSL_BAY_NO||BAY.VSL_ROW_NO||BAY.VSL_TR_NO,'') STWG                                                                  
   ,       DECODE(NVL(CGO_TP,'M'),'M',NVL(LODG_DCHG_IND_CD,''),NVL(CGO_TP,'')) CGO_TP                                                  
   ,       DG                                                                                                                          
   ,       BB                                                                                                                          
   ,       AK                                                                                                                          
   ,       RF 
   ,       PC                                                                                                                         
   ,	   '' VVD_CD			--VVD                                                                                          
   ,       '' POL_CD			--POL                                                                                          
   ,	   '' BOUND_TYPE		--공통 code(Inbound인경우는 POD_CD,OutBound인경우는 POL_CD가 입력된 Port Code임)               
   ,       '' STWG_STATUS	--Current,Previous                                                                                     
   ,       '' BKG_OFC_CD     	--B/OFC                                                                                                
   ,       '' BKG_CGO_TY_CD  	--STWG & Doc (UNMATCH,MATCH)                                                                           
   ,	   '' SP_CNTR_TY_CD 	--Special CNTR(DG,AK,BB...)                                                                            
   ,     decode((select  count(*) from bkg_container c,bkg_booking b                                                                   
                where c.bkg_no      = b.bkg_no                                                                                         
                and   c.cntr_no     = st.cntr_no                                                                                       
                and   b.vsl_cd      = st.bt_vsl_cd                                                                                     
                and   b.skd_voy_no  = st.bt_skd_voy_no                                                                                 
                and   b.skd_dir_cd  = st.bt_skd_dir_cd                                                                                 
                and   b.pol_cd      = st.pol_cd                                                                                        
                and   b.pod_cd      = st.pod_cd                                                                                        
                AND   BKG_STS_CD IN ('F','A','W','S')                                                                                  
                ),1,'N','Y') HBL	                                                                                               
    FROM OPF_BAY_PLN_LDIS BAY ,                                                                                                        
         (SELECT /*+ USE_NL(BKG_VVD,B,BKG_CNTR) */                                                                                     
                      B.BKG_NO                                                                                                         
          ,           BKG_VVD.VSL_CD                                                                                                   
		  ,			  BKG_VVD.SKD_VOY_NO                                                                           
          ,			  BKG_VVD.SKD_DIR_CD                                                                                   
          ,           B.POL_CD                                                                                                         
          ,           B.POD_CD                                                                                                         
          ,           BKG_CNTR.CNTR_NO                                                                                                 
          ,           BKG_CNTR.CNTR_TPSZ_CD                                                                                            
          ,           B.BL_NO            --||B.BL_NO_TP||B.BL_NO_CHK|| B.BL_NO_TP BL_NO                                                
          ,           B.BKG_CGO_TP_CD  CGO_TP                                                                                          
          ,     	  DECODE(BKG_CNTR.DCGO_FLG,'Y','DG','') DG                                                                     
          ,     	  DECODE(BKG_CNTR.BB_CGO_FLG,'Y','BB','') BB                                                                   
          ,           DECODE(BKG_CNTR.AWK_CGO_FLG,'Y','AK','') AK                                                                      
          ,           DECODE(BKG_CNTR.RC_FLG,'Y','RF','') RF  
		  ,      	  DECODE(B.PRCT_FLG,'Y','PC','') PC                                                                        
		  ,     	  B.VSL_CD bt_vsl_cd                                                                                   
		  ,     	  B.SKD_VOY_NO bt_skd_voy_no                                                                           
		  ,     	  B.SKD_DIR_CD bt_skd_dir_cd   	                                                                       
          FROM   BKG_CONTAINER BKG_CNTR                                                                                                
          ,      BKG_BOOKING B                                                                                                         
          ,      BKG_VVD                                                                                                               
          WHERE  BKG_VVD.BKG_NO = B.BKG_NO                                                                                             
          AND    B.BKG_NO = BKG_CNTR.BKG_NO                                                                                            
                                                                                                                                       
#if (${vvd_cd} != '')                                                                                                                  
		  AND (BKG_VVD.VSL_CD, BKG_VVD.SKD_VOY_NO, BKG_VVD.SKD_DIR_CD) IN (                                                    
				                                                                                                       
                 SELECT SKD.VSL_CD,SKD.SKD_VOY_NO,SKD.SKD_DIR_CD                                                                       
                 FROM   VSK_VSL_PORT_SKD SKD                                                                                           
                 WHERE  VSL_CD =SUBSTR(@[vvd_cd],1,4)                                                                                  
                 AND    SKD_VOY_NO =SUBSTR(@[vvd_cd],5,4)                                                                              
                 AND    SKD_DIR_CD = SUBSTR(@[vvd_cd],9,1)                                                                             
                 AND    VPS_PORT_CD =@[pol_cd])	                                                                                       
#end                                                                                                                                   
                                                                                                                                       
#if (${sp_cntr_ty_cd} != '')                                                                                                           
		  AND    CASE WHEN @[sp_cntr_ty_cd]= 'DG' THEN BKG_CNTR.DCGO_FLG                                                       
            		  WHEN @[sp_cntr_ty_cd]= 'BB' THEN BKG_CNTR.BB_CGO_FLG                                                         
           	 		  WHEN @[sp_cntr_ty_cd]= 'AK' THEN BKG_CNTR.AWK_CGO_FLG                                                
					  WHEN @[sp_cntr_ty_cd]= 'RF' THEN BKG_CNTR.RC_FLG                                         
            		  WHEN @[sp_cntr_ty_cd]= 'PC' THEN B.PRCT_FLG ELSE 'Y' END = 'Y'                                               
#end                                                                                                                                   
	                                                                                                                               
                                                                                                                                       
#if (${bound_type} == 'I')                                                                                                             
	     		AND BKG_VVD.POD_CD LIKE '%' || @[pol_cd] || '%'                                                                
#else                                                                                                                                  
	     		AND BKG_VVD.POL_CD LIKE '%' || @[pol_cd] || '%'                                                                
#end                                                                                                                                   
#if (${bkg_ofc_cd} != '')                                                                                                              
          AND    B.BKG_OFC_CD  LIKE '%' || @[bkg_ofc_cd] || '%'                                                                        
#end                                                                                                                                   
          AND    B.BKG_STS_CD IN ('F','A','W','S')) ST                                                                                 
    WHERE BAY.CNTR_REF_NO   = CNTR_NO                                                                                                  
                                                                                                                                       
#if (${vvd_cd} != '')                                                                                                                  
    AND   BAY.VSL_CD = ST.VSL_CD                                                                                                       
    AND   BAY.SKD_VOY_NO = ST.SKD_VOY_NO                                                                                               
    AND   BAY.SKD_DIR_CD = ST.SKD_DIR_CD                                                                                               
	AND   ((BAY.VSL_CD, BAY.SKD_VOY_NO, BAY.SKD_DIR_CD) IN (                        
                                                                                                                                       
			SELECT SKD.VSL_CD,SKD.SKD_VOY_NO,SKD.SKD_DIR_CD                       
			FROM   VSK_VSL_PORT_SKD SKD                                                                                    
            WHERE  VSL_CD =SUBSTR(@[vvd_cd],1,4)                                                                                       
            AND    SKD_VOY_NO =SUBSTR(@[vvd_cd],5,4)                                                                                   
            AND    SKD_DIR_CD = SUBSTR(@[vvd_cd],9,1)                                                                                  
            AND    VPS_PORT_CD =@[pol_cd])	  
	OR   (BAY.LODG_VSL_CD,BAY.LODG_VOY_NO,BAY.LODG_DIR_CD) IN (                        
                                                                                                                                       
			SELECT SKD.VSL_CD,SKD.SKD_VOY_NO,SKD.SKD_DIR_CD
			FROM   VSK_VSL_PORT_SKD SKD                                                                                    
            WHERE  VSL_CD =SUBSTR(@[vvd_cd],1,4)                                                                                       
            AND    SKD_VOY_NO =SUBSTR(@[vvd_cd],5,4)                                                                                   
            AND    SKD_DIR_CD = SUBSTR(@[vvd_cd],9,1)                                                                                  
            AND    VPS_PORT_CD =@[pol_cd]
		))                                                                                     
                                                                                                                                       
#end                                                                                                                                   
#if (${bound_type} == 'I')                                                                                                             
	 AND    BAY.POD_CD LIKE '%' || @[pol_cd] || '%'                                                                                
#else                                                                                                                                  
	 AND    BAY.POL_CD LIKE '%' || @[pol_cd] || '%'                                                                                
#end                                                                                                                                   
                                                                                                                                       
#if (${cgo_tp} != '' && ${cgo_tp} != 'ALL')                                                                                            
		 AND   DECODE(NVL(CGO_TP,'M'),'M',NVL(LODG_DCHG_IND_CD,''),NVL(CGO_TP,'')) = @[cgo_tp]                                 
#end                                                                                                                                   
                                                                                                                                       
	AND BAY.CRR_CD ='SML'                                                                                                          
#if (${stwg_status} != 'C')                                                                                                            
	AND BAY.LODG_DCHG_IND_CD  IN ('L','D')                                                                                         
#else                                                                                                                                  
	AND BAY.LODG_DCHG_IND_CD = 'C'                                                                                                 
#end                                                                                                                                   
                                                                                                                                       
                                                                                                                                       
#end                                                                                                                                   
                                                                                                                                       
------------------------------------------------------------------------------                                                         
--****************************************************************************                                                         
------------------------------------------------------------------------------                                                         
)                                                                                                                                      

SELECT 	 DENSE_RANK() OVER ( ORDER BY  CNTR_NO) SEQ
,   CNTR_NO
,	CNTRTS_CD
,	FLG
,	X.BKG_NO
,	X.BL_NO
,   Y.COD_RQST_RSN_CD
,  (SELECT INTG_CD_VAL_DESC
      FROM COM_INTG_CD_DTL
     WHERE INTG_CD_ID = 'CD02153'
       AND INTG_CD_VAL_CTNT = Y.COD_RQST_RSN_CD
    ) AS COD_RQST_RSN_NM
,	X.BK_POL
,	X.BK_POD
,	BAY_POL
,	BAY_POD
,	STWG
,	CGO_TP
,	DG
,	BB
,	AK
,	RF
,	PC
,	VVD_CD
,	POL_CD
,	BOUND_TYPE
,	STWG_STATUS
,	BKG_OFC_CD
,	BKG_CGO_TY_CD
,	SP_CNTR_TY_CD
,	HBL
FROM   TEMP_T X , BKG_COD Y
WHERE X.BKG_NO = Y.BKG_NO(+)
ORDER  BY CNTR_NO,BKG_NO			]]></sql>
			<params>
				<param name="vvd_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="bound_type" type="12" value="" out="N"/>
				<param name="sp_cntr_ty_cd" type="12" value="" out="N"/>
				<param name="bkg_ofc_cd" type="12" value="" out="N"/>
				<param name="lodg_dchg_ind_cd" type="12" value="" out="N"/>
				<param name="cgo_tp" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
