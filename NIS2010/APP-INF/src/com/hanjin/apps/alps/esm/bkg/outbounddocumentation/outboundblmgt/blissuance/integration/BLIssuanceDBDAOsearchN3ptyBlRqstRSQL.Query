<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BLIssuanceDBDAOsearchN3ptyBlRqstRSQL">
			<desc><![CDATA[BLIssuanceDBDAOsearchN3ptyBlRqstRSQL]]></desc>
			<sql><![CDATA[
SELECT *
  FROM 
(
    select RQST.BKG_NO
          ,RQST.POL_CD
          ,RQST.N3PTY_OFC_CD
          ,RQST.PAYR_CUST_CNT_CD
          ,RQST.PAYR_CUST_SEQ
          ,RQST.PAYR_CUST_CNT_CD||LPAD(RQST.PAYR_CUST_SEQ,6,'0') AS PAYR_CUST_CD
		  ,(SELECT CUST_LGL_ENG_NM FROM MDM_CUSTOMER MDM WHERE RQST.PAYR_CUST_CNT_CD = MDM.CUST_CNT_CD AND RQST.PAYR_CUST_SEQ = MDM.CUST_SEQ AND DELT_FLG = 'N') PAYR_CUST_NM
          ,RQST.SHPR_CNTC_PHN_NO 
          ,RQST.N3PTY_BL_STS_CD
          ,NVL(DECODE((SELECT RT.FRT_TERM_CD FROM BKG_CHG_RT RT WHERE RT.BKG_NO = RQST.BKG_NO AND RT.N3PTY_RCV_OFC_CD = RQST.N3PTY_OFC_CD AND RT.CHG_CD = 'OFT' AND RT.FRT_INCL_XCLD_DIV_CD='N' AND ROWNUM = 1),'P',ISS.ORG_N3PTY_PPD_CD,ISS.DEST_N3PTY_CLT_CD),'N') AS N3PTY_PAY_STS
          ,TO_CHAR(NVL(RQST.N3PTY_BL_STS_RQST_DT,RQST.cre_Dt),'YYYY-MM-DD HH24:MI:SS') AS RQST_DT
          ,TO_CHAR(RQST.N3PTY_BL_STS_UPD_DT,'YYYY-MM-DD HH24:MI:SS') as ACT_DT
          ,RQST.N3PTY_BL_STS_RQST_USR_ID AS USR_ID
          ,RQST.BL_RMK
          ,DECODE((SELECT COUNT(*) 
             FROM BKG_N3RD_PTY_BL_FILE_STO STO
            WHERE STO.BKG_NO = RQST.BKG_NO
              AND STO.POL_CD = RQST.POL_CD
              AND STO.N3PTY_OFC_CD = RQST.N3PTY_OFC_CD
              AND STO.PAYR_CUST_CNT_CD = RQST.PAYR_CUST_CNT_CD
              AND STO.PAYR_CUST_SEQ = RQST.PAYR_CUST_SEQ
              AND STO.OBL_ISS_OFC_CD = RQST.OBL_ISS_OFC_CD
              AND STO.N3PTY_BL_CHG_TTL_AMT = RQST.N3PTY_BL_CHG_TTL_AMT
              AND STO.FRT_TERM_CD = RQST.FRT_TERM_CD
           ),0,'N','Y') AS BL_ATCH
          ,BKG.VSL_CD||BKG.SKD_VOY_NO||BKG.SKD_DIR_CD AS VVD
          ,TO_CHAR(VPS_ETD_DT, 'YYYY-MM-DD') ETD_DT
          ,CASE WHEN (SELECT USR_EML FROM COM_USER WHERE USR_ID = RQST.CRE_USR_ID AND USE_FLG = 'Y') = (SELECT USR_EML FROM COM_USER WHERE USR_ID = BKG.DOC_USR_ID  AND USE_FLG = 'Y') THEN (SELECT USR_EML FROM COM_USER WHERE USR_ID = RQST.CRE_USR_ID AND USE_FLG = 'Y')
                ELSE (SELECT USR_EML FROM COM_USER WHERE USR_ID = RQST.CRE_USR_ID AND USE_FLG = 'Y')||';'||(SELECT USR_EML FROM COM_USER WHERE USR_ID = BKG.DOC_USR_ID  AND USE_FLG = 'Y')
                END AS USR_EML
          ,RQST.N3PTY_BL_STS_CD AS OLD_N3PTY_BL_STS_CD
          ,BKG.OB_SLS_OFC_CD AS POL_OFC_CD
          ,BKG.BKG_OFC_CD
          ,RQST.CRE_USR_ID AS BKG_USR_ID
          ,RQST.FRT_TERM_CD
          ,RQST.N3PTY_BL_CHG_TTL_AMT
          ,RQST.OBL_ISS_OFC_CD AS BL_ISS_OFC_CD
          ,CASE WHEN RQST.N3PTY_OFC_CD = OFC.OFC_N7TH_LVL_CD THEN 'Y'
                WHEN RQST.N3PTY_OFC_CD = OFC.OFC_N6TH_LVL_CD THEN 'Y'
                WHEN RQST.N3PTY_OFC_CD = OFC.OFC_N5TH_LVL_CD THEN 'Y'
                WHEN RQST.N3PTY_OFC_CD = OFC.OFC_N4TH_LVL_CD THEN 'Y'
                WHEN RQST.N3PTY_OFC_CD = OFC.OFC_N3RD_LVL_CD THEN 'Y'
                WHEN RQST.N3PTY_OFC_CD = OFC.OFC_CD THEN 'Y'
           ELSE 'N'
           END AS accss_ofc_cd
         ,ROW_NUMBER() OVER (PARTITION BY RQST.BKG_NO ORDER BY RQST.N3PTY_BL_STS_RQST_DT DESC) ROW_ID
         ,BKG.POD_CD
      from BKG_N3RD_PTY_BL_BIL_RQST RQST
          ,BKG_BL_ISS ISS
          ,BKG_BOOKING BKG
         ,(SELECT VVD.BKG_NO,VSK.VPS_ETA_DT VPS_ETA_DT ,VSK.VPS_ETD_DT VPS_ETD_DT, VSK.SLAN_CD SLAN_CD, VSK.YD_CD YD_CD,VSK.SKD_DIR_CD SKD_DIR_CD  
             FROM BKG_VVD VVD, VSK_VSL_PORT_SKD VSK
           WHERE 1=1
             AND VVD.VSL_CD = VSK.VSL_CD
             AND VVD.SKD_VOY_NO = VSK.SKD_VOY_NO
             AND VVD.SKD_DIR_CD = VSK.SKD_DIR_CD
             AND VVD.POL_CD = VSK.VPS_PORT_CD
             AND VVD.POL_CLPT_IND_SEQ = VSK.CLPT_IND_SEQ
             AND VVD.VSL_PRE_PST_CD||VVD.VSL_SEQ = ( SELECT MIN(VSL_PRE_PST_CD||VSL_SEQ) FROM BKG_VVD VVD2 WHERE VVD2.BKG_NO = VVD.BKG_NO)) VVD  
          ,(SELECT OFC_N7TH_LVL_CD,OFC_N6TH_LVL_CD,OFC_N5TH_LVL_CD,OFC_N4TH_LVL_CD,OFC_N3RD_LVL_CD,OFC_CD
              FROM(
                    SELECT OFC_N7TH_LVL_CD,OFC_N6TH_LVL_CD,OFC_N5TH_LVL_CD,OFC_N4TH_LVL_CD,OFC_N3RD_LVL_CD,OFC_CD 
                             FROM BKG_OFC_LVL_V
                             WHERE OFC_CD = @[accss_ofc_cd]
                            union all
                            SELECT '' AS OFC_N7TH_LVL_CD
                                  ,'' AS OFC_N6TH_LVL_CD
                                  ,'' AS OFC_N5TH_LVL_CD
                                  ,'' AS OFC_N4TH_LVL_CD
                                  ,'' AS OFC_N3RD_LVL_CD
                                  ,@[accss_ofc_cd] AS OFC_CD
                              FROM DUAL
                  )
            WHERE ROWNUM = 1) OFC
     WHERE BKG.BKG_NO = ISS.BKG_NO
       AND BKG.BKG_NO = RQST.BKG_NO
       AND BKG.BKG_NO = VVD.BKG_NO
    #if (${bkg_no} == '') 
    #if (${rqst_from_dt} != '') 
       AND RQST.CRE_DT >= TO_DATE(@[rqst_from_dt], 'YYYY-MM-DD')
    #end
    #if (${rqst_to_dt} != '') 
       AND RQST.CRE_DT < TO_DATE(@[rqst_to_dt], 'YYYY-MM-DD') + 1
    #end
    #end
    #if (${n3pty_ofc_cd} != '') 
       AND RQST.N3PTY_OFC_CD = @[n3pty_ofc_cd]
    #end
    #if (${pol_cd} != '') 
       AND RQST.POL_CD = @[pol_cd]
    #end
    #if (${pod_cd} != '') 
       AND BKG.POD_CD = @[pod_cd]
    #end
    #if (${bkg_no} != '') 
       AND RQST.BKG_NO = @[bkg_no]
    #end
    #if (${n3pty_bl_sts_cd} != 'All' && ${n3pty_bl_sts_cd} != '') 
       AND RQST.N3PTY_BL_STS_CD = @[n3pty_bl_sts_cd]
    #end
    #if (${pol_ofc_cd} != '') 
       AND BKG.OB_SLS_OFC_CD = @[pol_ofc_cd]
    #end
    #if (${sc_no} != '') 
       AND BKG.SC_NO = @[sc_no]
    #end
    #if (${rfa_no} != '') 
       AND BKG.RFA_NO = @[rfa_no]
    #end
    #if (${bl_iss_ofc_cd} != '') 
       AND ISS.OBL_ISS_OFC_CD = @[bl_iss_ofc_cd]
    #end
    #if (${rqst_bl_tp_cd} != 'All' && ${rqst_bl_tp_cd} != '') 
        AND NVL(BKG.BL_TP_CD,DECODE(ISS.OBL_SRND_FLG,'Y','S',DECODE(ISS.OBL_RLSE_FLG,'Y','O',''))) = @[rqst_bl_tp_cd]
    #end
    #if (${shpr_cd} != '')
        AND RQST.PAYR_CUST_CNT_CD = @[payr_cust_cnt_cd]
        AND RQST.PAYR_CUST_SEQ = @[payr_cust_seq]
    #end
    #if (${vvd} != '')
        AND EXISTS (SELECT 'Y' FROM BKG_VVD WHERE BKG_NO = RQST.BKG_NO AND VSL_CD||SKD_VOY_NO||SKD_DIR_CD = @[vvd])
    #end
    #if (${set_qry_where} != '') 
        ${set_qry_where} )
    #end
)
WHERE 1=1
#if (${bkg_no} == '') 
  AND ROW_ID = 1
#end
ORDER BY BKG_NO,RQST_DT			]]></sql>
			<params>
				<param name="accss_ofc_cd" type="12" value=" " out="N"/>
				<param name="rqst_from_dt" type="12" value="" out="N"/>
				<param name="rqst_to_dt" type="12" value="" out="N"/>
				<param name="n3pty_ofc_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="n3pty_bl_sts_cd" type="12" value="" out="N"/>
				<param name="pol_ofc_cd" type="12" value="" out="N"/>
				<param name="sc_no" type="12" value="" out="N"/>
				<param name="rfa_no" type="12" value="" out="N"/>
				<param name="bl_iss_ofc_cd" type="12" value="" out="N"/>
				<param name="rqst_bl_tp_cd" type="12" value="" out="N"/>
				<param name="payr_cust_cnt_cd" type="12" value="" out="N"/>
				<param name="payr_cust_seq" type="12" value="" out="N"/>
				<param name="vvd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
