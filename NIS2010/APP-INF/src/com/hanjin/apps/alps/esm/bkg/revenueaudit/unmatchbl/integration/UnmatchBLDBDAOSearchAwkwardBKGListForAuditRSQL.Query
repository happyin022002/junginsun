<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="UnmatchBLDBDAOSearchAwkwardBKGListForAuditRSQL">
			<desc><![CDATA[AK BKG List For Audit]]></desc>
			<sql><![CDATA[
WITH
BK AS (
SELECT ( SELECT OFC_CD FROM MDM_ORGANIZATION WHERE OFC_TP_CD = 'HQ' CONNECT BY PRIOR PRNT_OFC_CD = OFC_CD START WITH OFC_CD = BK.BKG_OFC_CD ) BKG_RHQ_CD,
       BK.BKG_OFC_CD,
       BK.BKG_NO,
       TO_CHAR(BK.BKG_CRE_DT, 'YYYY-MM-DD') BKG_CRE_DT,
       TO_CHAR(BR.RT_APLY_DT, 'YYYY-MM-DD') RT_APLY_DT,
       (SELECT TO_CHAR(MIN(V.VPS_ETD_DT),'YYYY-MM-DD') 
        FROM VSK_VSL_PORT_SKD V, BKG_VVD BV
        WHERE BV.BKG_NO = BK.BKG_NO
        AND BK.POL_CD = BV.POL_CD
        AND V.VSL_CD = BV.VSL_CD
        AND V.SKD_VOY_NO = BV.SKD_VOY_NO
        AND V.SKD_DIR_CD = BV.SKD_DIR_CD
        AND V.VPS_PORT_CD = BV.POL_CD
        AND V.CLPT_IND_SEQ = BV.POL_CLPT_IND_SEQ
       ) POL_ETD,
       BK.VSL_CD||BK.SKD_VOY_NO||BK.SKD_DIR_CD T_VVD,
       (SELECT INTG_CD_VAL_DP_DESC
        FROM COM_INTG_CD_DTL
        WHERE INTG_CD_ID ='CD01716'
        AND INTG_CD_VAL_CTNT = BR.BKG_CTRT_TP_CD) BKG_CTRT_TP_CD  ,
       CASE WHEN BR.BKG_CTRT_TP_CD = 'R' THEN BK.RFA_NO
            WHEN BR.BKG_CTRT_TP_CD = 'S' THEN BK.SC_NO
            WHEN BR.BKG_CTRT_TP_CD = 'T' THEN BK.TAA_NO
       END CTRT_NO,
       BK.CMDT_CD,
       (SELECT CMDT_NM FROM MDM_COMMODITY WHERE CMDT_CD = BK.CMDT_CD) CMDT_NM,
       BK.SVC_SCP_CD,
       BK.POR_CD,
       BK.POL_CD,
       BK.POD_CD,
       BK.DEL_CD,
       BK.RCV_TERM_CD,
       BK.DE_TERM_CD,
       (SELECT M.CUST_LGL_ENG_NM FROM MDM_CUSTOMER M, BKG_CUSTOMER SH WHERE SH.BKG_NO = BK.BKG_NO AND SH.BKG_CUST_TP_CD = 'S' AND M.CUST_CNT_CD = SH.CUST_CNT_CD AND M.CUST_SEQ = SH.CUST_SEQ) SHPR_NM,
       (SELECT M.CUST_LGL_ENG_NM FROM MDM_CUSTOMER M, BKG_CUSTOMER CN WHERE CN.BKG_NO = BK.BKG_NO AND CN.BKG_CUST_TP_CD = 'C' AND M.CUST_CNT_CD = CN.CUST_CNT_CD AND M.CUST_SEQ = CN.CUST_SEQ) CNEE_NM,
       (SELECT M.CUST_LGL_ENG_NM FROM MDM_CUSTOMER M, BKG_CUSTOMER FF WHERE FF.BKG_NO = BK.BKG_NO AND FF.BKG_CUST_TP_CD = 'F' AND M.CUST_CNT_CD = FF.CUST_CNT_CD AND M.CUST_SEQ = FF.CUST_SEQ) FWDR_NM,
       (SELECT CUST_LGL_ENG_NM FROM MDM_CUSTOMER WHERE CUST_CNT_CD = BK.CTRT_CUST_CNT_CD AND CUST_SEQ = BK.CTRT_CUST_SEQ) CTRT_CUST_NM,
       (SELECT DECODE(BL.BDR_FLG, 'Y', 'Yes', 'No') FROM BKG_BL_DOC BL WHERE BK.BKG_NO=BL.BKG_NO)  BDR_FLG ,
       DECODE(BK.SPLIT_FLG, 'Y', 'Split', 'Non-Split') SPLIT_FLG,
       NVL(( SELECT 'Charged' FROM BKG_CHG_RT RT WHERE BK.BKG_NO=BK.BKG_NO AND ROWNUM=1 ),'Non-Charged') CHARGE_FLG,
       (SELECT INTG_CD_VAL_DP_DESC FROM COM_INTG_CD_DTL WHERE INTG_CD_ID = 'CD01639'AND INTG_CD_VAL_CTNT = BR.RT_BL_TP_CD) RT_BL_TP_CD,
       NVL((SELECT  MAX(RDN_NO) RDN_NO
            FROM    BKG_REV_DR_NOTE
            WHERE   BKG_NO = BK.BKG_NO), ' ') AS RDN_NO ,
       NVL((SELECT INTG_CD_VAL_DESC
              FROM COM_INTG_CD_DTL, BKG_REV_DR_NOTE A
	         WHERE 1=1
	           AND INTG_CD_ID = 'CD01568'
	           AND INTG_CD_VAL_CTNT = A.RDN_STS_CD
	           AND A.BKG_NO = BK.BKG_NO
	           AND (A.RDN_NO, RVIS_SEQ ) IN  (SELECT RDN_NO, RVIS_SEQ FROM BKG_REV_DR_NOTE K
                                               WHERE K.BKG_NO = BK.BKG_NO
                                                 AND K.CRE_DT = (SELECT MAX(CRE_DT) FROM BKG_REV_DR_NOTE P
                                                                  WHERE 1=1
                                                                    AND P.BKG_NO = K.BKG_NO
                                                                    AND ROWNUM = 1)
                                               )
                ),' ') RDN_STS_NM
FROM BKG_BOOKING BK, BKG_RATE BR,
#if (${bkg_no} != '') 
    (SELECT	OFC_CD 
     FROM	MDM_ORGANIZATION A
     START WITH	A.OFC_CD = 'SELHO'
     CONNECT BY	PRIOR A.OFC_CD	= A.PRNT_OFC_CD  
     ) OG
WHERE BK.BKG_NO = @[bkg_no]

#else
    (SELECT	OFC_CD 
     FROM	MDM_ORGANIZATION A
 #if (${bkg_ofc_cd} != '') 
     WHERE	OFC_CD = @[bkg_ofc_cd]
 #end
     START WITH	A.OFC_CD = @[bkg_rhq_cd]
     CONNECT BY	PRIOR A.OFC_CD	= A.PRNT_OFC_CD  
     ) OG
 #if (${search_date} == 'ETD')
    ,(SELECT DISTINCT B.BKG_NO
      FROM BKG_BOOKING B, BKG_VVD BV, VSK_VSL_PORT_SKD V
      WHERE B.BKG_NO = BV.BKG_NO
      AND B.POL_CD = BV.POL_CD
      AND V.VSL_CD = BV.VSL_CD
      AND V.SKD_VOY_NO = BV.SKD_VOY_NO
      AND V.SKD_DIR_CD = BV.SKD_DIR_CD
      AND V.VPS_PORT_CD = BV.POL_CD
      AND V.CLPT_IND_SEQ = BV.POL_CLPT_IND_SEQ
      AND V.VPS_ETD_DT BETWEEN TO_DATE(@[fm_dt],'YYYY-MM-DD') AND TO_DATE(@[to_dt],'YYYY-MM-DD') + 0.99999
      ) V
WHERE BK.BKG_NO = V.BKG_NO
 #elseif (${search_date} == 'APPL')
WHERE BR.RT_APLY_DT BETWEEN TO_DATE(@[fm_dt],'YYYY-MM-DD') AND TO_DATE(@[to_dt],'YYYY-MM-DD') + 0.99999
 #else
WHERE BK.BKG_CRE_DT BETWEEN TO_DATE(@[fm_dt],'YYYY-MM-DD') AND TO_DATE(@[to_dt],'YYYY-MM-DD') + 0.99999
 #end
 #if (${svc_scp_cd} != '') 
AND BK.SVC_SCP_CD   = @[svc_scp_cd]
 #end
 #if (${t_vvd} != '') 
AND BK.VSL_CD = SUBSTR(@[t_vvd], 1, 4)
AND BK.SKD_VOY_NO = SUBSTR(@[t_vvd], 5, 4)
AND BK.SKD_DIR_CD = SUBSTR(@[t_vvd], 9, 1)
 #end
 #if (${bkg_ctrt_tp_cd} != '') 
AND     CASE
             WHEN    BK.TAA_NO IS NOT NULL THEN  'T'
             WHEN    BK.RFA_NO IS NOT NULL THEN  'R'
             ELSE    'S'
        END                     = @[bkg_ctrt_tp_cd]
 #end

 #if (${ctrt_no} != '') 
AND     CASE
             WHEN    BK.TAA_NO IS NOT NULL THEN  BK.TAA_NO
             WHEN    BK.RFA_NO IS NOT NULL THEN  BK.RFA_NO
             ELSE    BK.SC_NO
        END                     LIKE @[ctrt_no] || '%'
 #end


 #if (${por_cd} != '') 
AND BK.POR_CD   = @[por_cd]
 #end
 #if (${pol_cd} != '') 
AND BK.POL_CD   = @[pol_cd]
 #end
 #if (${pod_cd} != '') 
AND BK.POD_CD   = @[pod_cd]
 #end
 #if (${del_cd} != '') 
AND BK.DEL_CD   = @[del_cd]
 #end
#end

AND BK.BKG_STS_CD <> 'X'
AND BK.BKG_CGO_TP_CD = 'F'
AND BK.AWK_CGO_FLG = 'Y'
AND NVL(BK.BL_NO_TP, 'N') <> '9'
AND NVL(BR.RT_BL_TP_CD, 'N') NOT IN ( 'C', 'B' )
AND BK.BKG_NO = BR.BKG_NO
AND OG.OFC_CD = BK.BKG_OFC_CD
)
,
BQ AS(
SELECT BK.BKG_NO, 
       BQ.CNTR_TPSZ_CD,  
       CASE WHEN QD.CNTR_TPSZ_CD LIKE 'R%' AND QD.DRY_CGO_FLG = 'Y' THEN QD.CNTR_TPSZ_CD   -- RD 인 경우만 예외처리  
            ELSE NVL(QD.EQ_SUBST_CNTR_TPSZ_CD, QD.CNTR_TPSZ_CD)
       END CTRT_CNTR_TPSZ_CD,
       QD.CNTR_TPSZ_CD AK_CNTR_TPSZ_CD,
       SUM(BQ.OP_CNTR_QTY) OP_CNTR_QTY, 
       SUM(QD.OP_CNTR_QTY) AK_CNTR_QTY,
       (SELECT SUM(OVR_VOID_SLT_QTY) FROM BKG_AWK_CGO WHERE BKG_NO = BK.BKG_NO AND CNTR_TPSZ_CD = BQ.CNTR_TPSZ_CD) VOID_SLT_QTY
FROM BK, BKG_QUANTITY BQ, BKG_QTY_DTL QD
WHERE BK.BKG_NO = BQ.BKG_NO
AND BQ.BKG_NO = QD.BKG_NO
AND BQ.CNTR_TPSZ_CD = QD.CNTR_TPSZ_CD
AND QD.AWK_CGO_FLG = 'Y'
#if (${cntr_tpsz_cd} != '')
AND BQ.CNTR_TPSZ_CD IN ( #foreach(${key} in ${cntr_tpsz_cd_list} ) #if($velocityCount != 1) , #end '$key' #end )  -- MULTI
#end
GROUP BY BK.BKG_NO, BQ.CNTR_TPSZ_CD, QD.CNTR_TPSZ_CD,
        CASE WHEN QD.CNTR_TPSZ_CD LIKE 'R%' AND QD.DRY_CGO_FLG = 'Y' THEN QD.CNTR_TPSZ_CD   -- RD 인 경우만 예외처리  
            ELSE NVL(QD.EQ_SUBST_CNTR_TPSZ_CD, QD.CNTR_TPSZ_CD)
        END
),
BR AS(
SELECT RT.BKG_NO, RT.CHG_CD, RT.CURR_CD, RT.RAT_UT_CD, RT.CHG_UT_AMT, RT.RAT_AS_QTY, RT.CHG_AMT, RT.FRT_TERM_CD, RT.AUTO_RAT_CD
FROM BKG_CHG_RT RT
WHERE RT.BKG_NO IN (SELECT BKG_NO FROM BK)
AND RT.CHG_CD = 'OFT'
)
SELECT DISTINCT BK.BKG_RHQ_CD, BK.BKG_OFC_CD, BK.BKG_NO, BK.BKG_CRE_DT, BK.RT_APLY_DT, BK.POL_ETD, BK.T_VVD, 
       BK.BKG_CTRT_TP_CD, BK.CTRT_NO, BK.CMDT_CD, BK.CMDT_NM, 
       BK.SVC_SCP_CD, BK.POR_CD, BK.POL_CD, BK.POD_CD, BK.DEL_CD,
       BK.RCV_TERM_CD, BK.DE_TERM_CD,BK.SHPR_NM, BK.CNEE_NM, BK.FWDR_NM, BK.CTRT_CUST_NM, 
       BK.BDR_FLG, BK.SPLIT_FLG, BK.CHARGE_FLG, BK.RT_BL_TP_CD, BK.RDN_NO, BK.RDN_STS_NM,
       BQ.CNTR_TPSZ_CD, BQ.OP_CNTR_QTY,BQ.AK_CNTR_TPSZ_CD, BQ.AK_CNTR_QTY, BQ.VOID_SLT_QTY,
       BR.CHG_CD, BR.CURR_CD, BR.CHG_UT_AMT, BR.RAT_UT_CD, BR.RAT_AS_QTY, BR.CHG_AMT, BR.FRT_TERM_CD, BR.AUTO_RAT_CD,
       COUNT(DISTINCT BK.BKG_NO) OVER () AS  BL_CNT
FROM BK, BQ, BR
WHERE BK.BKG_NO = BQ.BKG_NO
AND BQ.BKG_NO = BR.BKG_NO(+)
AND BQ.CTRT_CNTR_TPSZ_CD = BR.RAT_UT_CD(+)
#if (${bdr_flg} != '') 
AND BK.BDR_FLG   = @[bdr_flg]
#end
#if (${charge_flg} == 'C')
AND CHARGE_FLG='Charged'
#elseif(${charge_flg} == 'N')
AND CHARGE_FLG='Non-Charged'
#end
ORDER BY BKG_RHQ_CD, BKG_OFC_CD, BK.BKG_NO, BQ.CNTR_TPSZ_CD			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="bkg_ofc_cd" type="12" value="" out="N"/>
				<param name="bkg_rhq_cd" type="12" value="" out="N"/>
				<param name="fm_dt" type="12" value="" out="N"/>
				<param name="to_dt" type="12" value="" out="N"/>
				<param name="svc_scp_cd" type="12" value="" out="N"/>
				<param name="t_vvd" type="12" value="" out="N"/>
				<param name="bkg_ctrt_tp_cd" type="12" value="" out="N"/>
				<param name="ctrt_no" type="12" value="" out="N"/>
				<param name="por_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="del_cd" type="12" value="" out="N"/>
				<param name="bdr_flg" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
