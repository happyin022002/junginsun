<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="GeneralBookingReceiptDBDAOSearch1stVvdEtaRSQL">
			<desc><![CDATA[   ]]></desc>
			<sql><![CDATA[
SELECT TO_CHAR(N1ST_ETA, 'yyyy-mm-dd hh:mi') n1st_eta
      ,TO_CHAR(N1ST_ETA, 'yyyy-mm-dd') 		 n1st_eta_day
      ,TO_CHAR(N1ST_ETA, 'hh:mi') 			 n1st_eta_time
	  ,TO_CHAR(DEL_ETA,  'yyyy-mm-dd hh:mi') del_eta
      ,TO_CHAR(DEL_ETA,  'yyyy-mm-dd') 		 del_eta_day
      ,TO_CHAR(DEL_ETA,  'hh:mi') 			 del_eta_time
  FROM (SELECT CASE WHEN POD_CD = 'USLAX' AND DEL_CD ='USLGB'  THEN NVL(ESTM_DT_F, ESTM_DT_E)
                    WHEN POD_CD = 'USLGB' AND DEL_CD ='USLAX'  THEN NVL(ESTM_DT_F, ESTM_DT_E)
                    WHEN DE_TERM_CD <>'D' AND POD_CD = DEL_CD  THEN NVL(ESTM_DT_D, ESTM_DT_E)
                    WHEN DE_TERM_CD <>'D' AND POD_CD <>DEL_CD  THEN NVL(ESTM_DT_B, NVL(ESTM_DT_G, ESTM_DT_E))
                    WHEN DE_TERM_CD = 'D'                      THEN NVL(ESTM_DT_A, NVL(ESTM_DT_C, ESTM_DT_E))
                    ELSE ESTM_DT_E END DEL_ETA
          FROM (SELECT MAX(BK.BKG_NO) BKG_NO
                     , MAX(BK.POD_CD) POD_CD
                     , MAX(BK.DEL_CD) DEL_CD             
                     , MAX(BK.DE_TERM_CD) DE_TERM_CD
                     , MAX(to_date(ESTM_DT_A,'YYYYMMDD HH24MISS')) AS ESTM_DT_A --Activity 가 ‘Arrival’인 항목 목록 중 가장 마지막 시간  --전체 Acitivity가 Arraival 및 아래 로직조건상 가장 마직막 시간 
                     , MAX(to_date(ESTM_DT_B,'YYYYMMDD HH24MISS')) AS ESTM_DT_B --ESTM_DT_A 의 한 단계 이전 발생 값 --ESTM_DT_A와 같은조건에서 ESTM_DT_A 값의 다음 Acitivity중 가장 마직막 시간
                     , MAX(to_date(ESTM_DT_C,'YYYYMMDD HH24MISS')) AS ESTM_DT_C --Location 조건 제외 후 ESTM_DT_A 값 --'MITYAD', 'FITZAD'를 뺀 마지막 이전 Acitivity
                     , MAX(to_date(ESTM_DT_D,'YYYYMMDD HH24MISS')) AS ESTM_DT_D --Vessel Arrival at POD 값
                     , MAX(to_date(ESTM_DT_E,'YYYYMMDD HH24MISS')) AS ESTM_DT_E --Feeder Unloading at POD 값
                     , MAX(to_date(ESTM_DT_F,'YYYYMMDD HH24MISS')) AS ESTM_DT_F --POD/DEL이 USLAX/USLGB인 경우의 값
                     , MAX(to_date(ESTM_DT_G,'YYYYMMDD HH24MISS')) AS ESTM_DT_G --Location 조건 제외 후 ESTM_DT_B 값
                  FROM BKG_BOOKING BK 
                     , (SELECT to_char(ESTM_DT,'YYYYMMDD HH24MISS') ESTM_DT_A, '' ESTM_DT_B, '' ESTM_DT_C, '' ESTM_DT_D, '' ESTM_DT_E, '' ESTM_DT_F, '' ESTM_DT_G 
                          FROM (SELECT BK.BKG_NO, D.ACT_CD, ESTM_DT
                                  FROM BKG_BOOKING BK
                                     , SCE_COP_HDR H
                                     , SCE_COP_DTL D
                                 WHERE BK.BKG_NO = @[bkg_no] 
                                   AND BK.BKG_NO = H.BKG_NO
                                   AND D.COP_NO  = H.COP_NO
                                   AND H.COP_STS_CD <> 'X'
                                   AND D.NOD_CD	= H.DEL_NOD_CD
                                   AND D.ACT_CD <> 'MITYAD' --Activity Name : I/B Empty Container Returned
                                   AND D.ACT_CD <> 'FITZAD' --Activity Name : Truck Full Container Door Delivery
                                   AND (D.ACT_CD IN ('FITMDO', 'FITRDO') OR SUBSTR(D.ACT_CD, 5, 1) IN('A')) --Activity Name : Truck Gate Out from T/S Terminal, Truck Gate Out from I/B Rail Ramp
                                 ORDER BY ESTM_DT DESC)
                         WHERE ROWNUM IN (1)
                         UNION ALL  
                        SELECT '' ESTM_DT_A, to_char(ESTM_DT,'YYYYMMDD HH24MISS') ESTM_DT_B, '' ESTM_DT_C, '' ESTM_DT_D, '' ESTM_DT_E, '' ESTM_DT_F, '' ESTM_DT_G
                          FROM (SELECT ROWNUM SEQ_NO, ACT_CD, ESTM_DT
                                  FROM (SELECT BK.BKG_NO, D.ACT_CD, ESTM_DT
                                          FROM BKG_BOOKING BK
                                             , SCE_COP_HDR H
                                             , SCE_COP_DTL D
                                         WHERE BK.BKG_NO = @[bkg_no] 
                                           AND BK.BKG_NO = H.BKG_NO
                                           AND D.COP_NO	= H.COP_NO
                                           AND H.COP_STS_CD <> 'X'
                                           AND D.NOD_CD	= H.DEL_NOD_CD
                                           AND D.ACT_CD <> 'MITYAD' --Activity Name : I/B Empty Container Returned
                                           AND D.ACT_CD <> 'FITZAD' --Activity Name : Truck Full Container Door Delivery
                                         ORDER BY ESTM_DT DESC)
                                )     
                         WHERE SEQ_NO IN (SELECT COUNT(1)+1 FROM SCE_COP_HDR WHERE BKG_NO = @[bkg_no] AND COP_STS_CD <> 'X')
                         UNION ALL  
                        SELECT '' ESTM_DT_A, '' ESTM_DT_B, to_char(ESTM_DT,'YYYYMMDD HH24MISS') ESTM_DT_C, '' ESTM_DT_D, '' ESTM_DT_E, '' ESTM_DT_F, '' ESTM_DT_G   
                          FROM (SELECT BK.BKG_NO, D.ACT_CD, ESTM_DT
                                  FROM BKG_BOOKING BK
                                     , SCE_COP_HDR H
                                     , SCE_COP_DTL D
                                 WHERE BK.BKG_NO = @[bkg_no] 
                                   AND BK.BKG_NO = H.BKG_NO
                                   AND D.COP_NO  = H.COP_NO
                                   AND H.COP_STS_CD <> 'X'
                                   AND D.ACT_CD <> 'MITYAD' --Activity Name : I/B Empty Container Returned
                                   AND D.ACT_CD <> 'FITZAD' --Activity Name : Truck Full Container Door Delivery
                                   AND (D.ACT_CD IN ('FITMDO', 'FITRDO') OR SUBSTR(D.ACT_CD, 5, 1) IN('A')) --Activity Name : Truck Gate Out from T/S Terminal, Truck Gate Out from I/B Rail Ramp
                                 ORDER BY ESTM_DT DESC)
                         WHERE ROWNUM IN (1)
                         UNION ALL   
                        SELECT '' ESTM_DT_A, '' ESTM_DT_B, '' ESTM_DT_C, to_char(ESTM_DT,'YYYYMMDD HH24MISS') ESTM_DT_D, '' ESTM_DT_E, '' ESTM_DT_F, '' ESTM_DT_G  
                          FROM (SELECT BK.BKG_NO, D.ACT_CD, ESTM_DT
                                  FROM BKG_BOOKING BK
                                     , SCE_COP_HDR H
                                     , SCE_COP_DTL D
                                 WHERE BK.BKG_NO = @[bkg_no] 
                                   AND BK.BKG_NO = H.BKG_NO
                                   AND D.COP_NO	= H.COP_NO
                                   AND H.COP_STS_CD <> 'X'
                                   AND D.NOD_CD	= H.POD_NOD_CD
                                   AND D.ACT_CD IN ('FUVMAD') --Activity Name : Vessel Arrival at POD
                                 ORDER BY ESTM_DT DESC)
                         WHERE ROWNUM IN (1)
                         UNION ALL   
                        SELECT '' ESTM_DT_A, '' ESTM_DT_B, '' ESTM_DT_C, '' ESTM_DT_D, to_char(ESTM_DT,'YYYYMMDD HH24MISS') ESTM_DT_E, '' ESTM_DT_F, '' ESTM_DT_G  
                          FROM (SELECT BK.BKG_NO, D.ACT_CD, ESTM_DT
                                  FROM BKG_BOOKING BK
                                     , SCE_COP_HDR H
                                     , SCE_COP_DTL D
                                 WHERE BK.BKG_NO = @[bkg_no] 
                                   AND BK.BKG_NO = H.BKG_NO
                                   AND D.COP_NO	= H.COP_NO
                                   AND H.COP_STS_CD <> 'X'
                                   AND D.NOD_CD = H.POD_NOD_CD
                                   AND D.ACT_CD IN ('FUWMUD') --Activity Name : Feeder Unloading at POD
                                 ORDER BY ESTM_DT DESC)
                         WHERE ROWNUM IN (1)
                         UNION ALL   
                        SELECT '' ESTM_DT_A, '' ESTM_DT_B, '' ESTM_DT_C, '' ESTM_DT_D, '' ESTM_DT_E, to_char(ESTM_DT,'YYYYMMDD HH24MISS') ESTM_DT_F, '' ESTM_DT_G 
                          FROM (SELECT D.ACT_CD, ESTM_DT
                                 FROM BKG_BOOKING BK
                                    , SCE_COP_HDR H
                                    , SCE_COP_DTL D
                                WHERE BK.BKG_NO = @[bkg_no] 
                                  AND BK.BKG_NO = H.BKG_NO
                                  AND D.COP_NO	= H.COP_NO
                                  AND H.COP_STS_CD <> 'X'
                                  AND D.NOD_CD	= H.POD_NOD_CD
                                  AND D.ACT_CD <> 'MITYAD' --Activity Name : I/B Empty Container Returned
                                  AND D.ACT_CD <> 'FITZAD' --Activity Name : Truck Full Container Door Delivery
                                  AND SUBSTR(D.ACT_CD, 5, 1) IN('U')
                                ORDER BY ESTM_DT DESC)
                         WHERE ROWNUM IN (1)
                         UNION ALL  
                        SELECT '' ESTM_DT_A, '' ESTM_DT_B, '' ESTM_DT_C, '' ESTM_DT_D, '' ESTM_DT_E, '' ESTM_DT_F, to_char(ESTM_DT,'YYYYMMDD HH24MISS') ESTM_DT_G
                          FROM (SELECT ROWNUM SEQ_NO, ACT_CD, ESTM_DT
                                  FROM (SELECT BK.BKG_NO, D.ACT_CD, ESTM_DT
                                          FROM BKG_BOOKING BK
                                             , SCE_COP_HDR H
                                             , SCE_COP_DTL D
                                         WHERE BK.BKG_NO = @[bkg_no] 
                                           AND BK.BKG_NO = H.BKG_NO
                                           AND D.COP_NO	= H.COP_NO
                                           AND D.ACT_CD <> 'MITYAD' --Activity Name : I/B Empty Container Returned
                                           AND D.ACT_CD <> 'FITZAD' --Activity Name : Truck Full Container Door Delivery
                                         ORDER BY ESTM_DT DESC)
                                )     
                         WHERE SEQ_NO IN (SELECT COUNT(1)+1 FROM SCE_COP_HDR WHERE BKG_NO = @[bkg_no] AND COP_STS_CD <> 'X')
                       ) ETA_LIST
                 WHERE BK.BKG_NO =@[bkg_no]
	            ) ) DEL_ETA
	  ,(SELECT VPS_ETA_DT N1ST_ETA
		  FROM VSK_VSL_PORT_SKD
		 WHERE VPS_PORT_CD  = @[pol_cd]
		   AND CLPT_IND_SEQ = NVL((SELECT VVD.POL_CLPT_IND_SEQ
									 FROM BKG_VVD VVD
								    WHERE VVD.BKG_NO = @[bkg_no]
									  AND VVD.POL_CD = @[pol_cd]
								      AND VVD.VSL_CD       = substr(@[bkg_vvd_cd], 1, 4)
								      AND VVD.SKD_VOY_NO   = substr(@[bkg_vvd_cd], 5, 4)
								      AND VVD.SKD_DIR_CD   = substr(@[bkg_vvd_cd], 9, 1)
								      AND ROWNUM = 1), '1')
		   AND VSL_CD       = substr(@[bkg_vvd_cd], 1, 4)
		   AND SKD_VOY_NO   = substr(@[bkg_vvd_cd], 5, 4)
		   AND SKD_DIR_CD   = substr(@[bkg_vvd_cd], 9, 1)) N1ST_ETA			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="SEL900009500" out="N"/>
				<param name="pol_cd" type="12" value="KRPUS" out="N"/>
				<param name="bkg_vvd_cd" type="12" value="HNPT0085E" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
