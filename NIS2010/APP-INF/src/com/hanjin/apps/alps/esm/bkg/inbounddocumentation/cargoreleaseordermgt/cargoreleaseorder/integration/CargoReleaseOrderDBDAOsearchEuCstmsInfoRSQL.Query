<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CargoReleaseOrderDBDAOsearchEuCstmsInfoRSQL">
			<desc><![CDATA[POD에 따라서 Default값은CRN(ROCS), SSR(ANCS), UVI(FXT)에 Assign된 값
POD가 NLRTM인 경우, ROCS의 CRN List에서 해당 B/L에 Assign된 CRN No를 가져옴
POD가 BEANR인 경우, ANCS의 SSR Creation에서 해당 B/L에 Assign된 SSR No를 가져옴
POD가 GBFXT인 경우, EU Customs EDI에서 해당 B/L에 Assign된 UVI No를 가져옴]]></desc>
			<sql><![CDATA[
SELECT NVL(DREF.CSTMS_REF_NM, 'Customs Ref. No') as cstms_ref_nm    
      ,NVL(DREF.CSTMS_REF_CTNT, DECODE(SUBSTR(SUB.POD_CD, 1,2),'NL',CRN_NO ,
                                                  'BE',SSR_NO,
                                                  'GB',UVI_NO,
                                                  'ES',MF_NO,
                                                  'PT',MF_NO,'')) as cstms_ref_ctnt                                                 
      ,NVL(DREF.CSTMS_ASGN_NM,'Customs Ref. No') as cstms_asgn_nm
      ,NVL(DREF.CSTMS_ASGN_CTNT,DECODE(SUBSTR(SUB.POD_CD, 1,2) ,'BE',ARTICLE_NO 
                                                               ,'ES',REF_GDS_ITM_NM
							       ,'PT',REF_GDS_ITM_NM,'')) as cstms_asgn_ctnt
      ,SUB.CRN_RCV_FLG
FROM (
    SELECT  BKGM.BKG_NO                      AS BKG_NO
           ,BKGM.POD_CD                      AS POD_CD
           ,RBL.VSL_CALL_REF_NO              AS CRN_NO      -- CRN No
           ,RBL.IB_FILE_SEQ                  AS FILER       -- Filer
           ,AVVD.SVC_RQST_NO                 AS SSR_NO      -- SSR NO
           ,LPAD(NVL(ABL.VVD_SEQ,'') ,4,'0') AS ARTICLE_NO  -- Articl No
           ,DYD.CVY_REF_NO                   AS UVI_NO      -- UVI NO
           
           ,ECRN.MF_NO                       AS MF_NO
           ,ECRN.REF_GDS_ITM_NM              AS REF_GDS_ITM_NM
           ,(SELECT DECODE(COUNT(*),0,'N','Y')
	       FROM BKG_CSTMS_EUR_CRN_RCV
	     WHERE BL_NO=@[bkg_no]
         AND   CNT_CD = SUBSTR(BKGM.POD_CD,1,2)
	     AND   MSG_FUNC_ID <> 'F' )      AS CRN_RCV_FLG	 
    FROM BKG_BOOKING BKGM
        ,BKG_VVD BVVD
        ,BKG_CSTMS_RTM_BL RBL
        ,BKG_CSTMS_ANR_BL ABL
        ,BKG_CSTMS_ANR_VVD AVVD 
        ,BKG_VSL_DCHG_YD DYD
        ,BKG_CSTMS_EUR_CRN_RCV ECRN
    WHERE BKGM.BKG_NO = @[bkg_no]
      AND BKGM.BKG_NO = BVVD.BKG_NO
      AND BKGM.POD_CD = BVVD.POD_CD
      AND BVVD.VSL_PRE_PST_CD IN ('T', 'U')
      /* NLRTM */
      AND RBL.BKG_NO(+)  =  BKGM.BKG_NO
      /*ANRBS */
      AND ABL.BKG_NO(+) = BVVD.BKG_NO
      AND AVVD.VSL_CD(+)= BVVD.VSL_CD
      AND AVVD.SKD_VOY_NO(+) = BVVD.SKD_VOY_NO
      AND AVVD.SKD_DIR_CD(+) = BVVD.SKD_DIR_CD
      /* GBFXT */
      AND DYD.VSL_CD(+) = BVVD.VSL_CD
      AND DYD.SKD_VOY_NO(+) =BVVD.SKD_VOY_NO
      AND DYD.SKD_DIR_CD(+) = BVVD.SKD_DIR_CD
      AND DYD.PORT_CD(+) =BVVD.POD_CD
      AND DYD.CLPT_IND_SEQ(+) = 1 
      
      
      AND ECRN.BL_NO(+)       = BKGM.BL_NO
      AND ECRN.CNT_CD (+)     = SUBSTR(BKGM.POD_CD, 1,2)
      AND ECRN.MSG_FUNC_ID(+) ='F'
             
             
) SUB,  BKG_DO_REF DREF
WHERE SUB.BKG_NO = DREF.BKG_NO(+)			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
