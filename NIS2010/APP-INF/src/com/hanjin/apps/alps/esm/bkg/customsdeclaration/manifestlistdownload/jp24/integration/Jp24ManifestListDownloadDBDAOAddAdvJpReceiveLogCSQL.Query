<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="Jp24ManifestListDownloadDBDAOAddAdvJpReceiveLogCSQL">
			<desc><![CDATA[2015.03.09 - 
전송 후 수신 되기 이전에 다시 전송 하는 경우 발생
따라서 SAMR, SCMR일 경우 수신된 데이터(가장 최근)가  00000-0000-0000 이고
ERROR 메세지 수신 할 경우 INSERT 하지 않음

]]></desc>
			<sql><![CDATA[
MERGE INTO BKG_CSTMS_ADV_JP_RCV_LOG RCV_LOG
USING ( 
    SELECT @[bkg_no]            AS BKG_NO, 
		   @[jp_msg_tp_id]      AS JP_MSG_TP_ID,
		   @[rcv_key_dat_ctnt]  AS RCV_KEY_DAT_CTNT
	FROM DUAL 
) TM
ON ( RCV_LOG.BKG_NO             = TM.BKG_NO                                                 			AND 
	 RCV_LOG.JP_MSG_TP_ID       = DECODE(TM.JP_MSG_TP_ID,'SAMR','SAMR','SCMR','SCMR','XXX') 			AND
	 RCV_LOG.RCV_KEY_DAT_CTNT   = DECODE(TM.RCV_KEY_DAT_CTNT,'00000-0000-0000','XXX','00000-0000-0000') AND
     RCV_LOG.RCV_DT             = ( SELECT  MAX(RCV_DT)
                                    FROM    BKG_CSTMS_ADV_JP_RCV_LOG
                                    WHERE   BKG_NO          = TM.BKG_NO
                                    AND     JP_MSG_TP_ID    = TM.JP_MSG_TP_ID )
)
WHEN MATCHED THEN
    UPDATE 	
    SET		 UPD_DT = SYSDATE
WHEN NOT MATCHED THEN
INSERT (JP_MSG_TP_ID,
        RCV_DT,
        MSG_RCV_NO,
        RCV_SEQ,
        JP_SVC_ID,
        RCV_KEY_DAT_CTNT,
        JP_BAT_NO,
        VSL_CD,
        SKD_VOY_NO,
        SKD_DIR_CD,
        POL_CD,
        POD_CD,
        POR_CD,
        BKG_NO,
        EDI_RCV_MSG_CTNT,
        CRE_USR_ID,
        CRE_DT,
        UPD_USR_ID,
        UPD_DT)

VALUES (@[jp_msg_tp_id],
        SYSDATE,
        SUBSTR(LTRIM(TO_CHAR(BKG_CSTM_EDI_SEQ.NEXTVAL, '000009'), ' '), 2)||TO_CHAR(SYSDATE, 'yyyyMMddHH24miss'),
        @[rcv_seq],
        @[jp_svc_id],
        @[rcv_key_dat_ctnt],
        @[jp_bat_no],
        @[vsl_cd],
        @[skd_voy_no],
        @[skd_dir_cd],
        @[pol_cd],
        @[pod_cd],
        @[por_cd],
        @[bkg_no],
        @[edi_rcv_msg_ctnt],
        @[usr_id],
        SYSDATE,
        @[usr_id],
        SYSDATE)			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="jp_msg_tp_id" type="12" value="" out="N"/>
				<param name="rcv_key_dat_ctnt" type="12" value="" out="N"/>
				<param name="rcv_seq" type="12" value="" out="N"/>
				<param name="jp_svc_id" type="12" value="" out="N"/>
				<param name="jp_bat_no" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="por_cd" type="12" value="" out="N"/>
				<param name="edi_rcv_msg_ctnt" type="12" value="" out="N"/>
				<param name="usr_id" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
