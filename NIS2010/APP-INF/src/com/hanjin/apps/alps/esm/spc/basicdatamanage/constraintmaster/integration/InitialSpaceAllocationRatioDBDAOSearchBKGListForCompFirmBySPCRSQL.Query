<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="InitialSpaceAllocationRatioDBDAOSearchBKGListForCompFirmBySPCRSQL">
			<desc><![CDATA[2015.02.11 Kim Soung Wook.
Compulsory Firm COPY , 0116화면 조회 QUERY]]></desc>
			<sql><![CDATA[
SELECT DISTINCT BKG_NO
      ,BKG_STS_CD
      ,STANDBY_TYPE
      ,STANDBY_REASON
      ,ALOC_SVC_CD
      ,ALOC_STS_CD
	  ,CFM_RQST_FLG
	  ,CNDDT_CFM_FLG
	  ,CFM_USR_ID
	  ,CFM_DT
#if($c_name.size() != 0)
#foreach(${list} in ${c_name})
      , ${list}
#end
#end
      ,FEU
      ,TEU
  FROM (
        SELECT
            BK.BKG_NO
            , BK.BKG_STS_CD
--            , SBDTL.LST_SB_RSN_TP_CD AS STANDBY_TYPE   -- HISTORY TABLE
--            , SBDTL.LST_SB_RSN       AS STANDBY_REASON -- HISTORY TABLE
			, SSB.CFM_USR_ID
			, SSB.CFM_DT
            , BK.ALOC_SVC_CD
            , BK.ALOC_STS_CD
            , BK.BL_NO
            , BK.SLS_RHQ_CD
            , BK.BKG_ALOC_TP_CD
            , COA.SUB_TRD_CD
            , BK.SLAN_CD               TRNK_SLAN_CD
            , BK.SKD_DIR_CD            TRNK_DIR_CD
            , BK.POL_CD                TRNK_POL
            , BK.POD_CD                TRNK_POD
            , BK.POR_CD                POR_LOC_CD
            , BK.POR_NOD_CD            POR_NOD_CD
            , (SELECT SCC_CD FROM MDM_LOCATION LOC WHERE LOC.LOC_CD = BK.POR_CD) POR_SCC_CD
            , BK.POL_CD                POL_LOC_CD
            , BK.POL_NOD_CD            POL_NOD_CD
            , NVL((SELECT VSL_SLAN_CD FROM VSK_VSL_SKD SKD WHERE SKD.VSL_CD = VVD.VSL_CD AND SKD.SKD_VOY_NO = VVD.SKD_VOY_NO AND SKD.SKD_DIR_CD = VVD.SKD_DIR_CD), 'X') TS_SLAN_CD
            , NVL(VVD.SKD_DIR_CD, 'X') TS_DIR_CD
            , NVL(VVD.POL_CD,     'X') TS_POL_CD
            , NVL(VVD.POD_CD,     'X') TS_POD_CD
            , BK.POD_CD                POD_LOC_CD
            , BK.POD_NOD_CD            POD_NOD_CD
            , BK.DEL_CD                DEL_LOC_CD
            , BK.DEL_NOD_CD            DEL_NOD_CD
            , (SELECT SCC_CD FROM MDM_LOCATION LOC WHERE LOC.LOC_CD = BK.DEL_CD) DEL_SCC_CD
            , BK.VSL_CD || BK.SKD_VOY_NO || BK.SKD_DIR_CD VVD
            , BK.OB_SLS_OFC_CD
            , DECODE(BK.DCGO_FLG,'Y','DG', DECODE(BK.RD_CGO_FLG, 'Y', 'RD',''), '') DGRD
            , BK.SC_NO
            , BK.RFA_NO
            , BK.CTRT_CUST_CNT_CD || NVL(LPAD(BK.CTRT_CUST_SEQ,6,'0'),'')     C_CUST
            , BK.AGMT_ACT_CNT_CD  || NVL(LPAD(BK.AGMT_ACT_CUST_SEQ,6,'0'),'') A_CUST
            , SHPR.CUST_CNT_CD    || NVL(LPAD(SHPR.CUST_SEQ,6,'0'),'')        SHRP
            , CNEE.CUST_CNT_CD    || NVL(LPAD(CNEE.CUST_SEQ,6,'0'),'')        CNEE
            , FWDR.CUST_CNT_CD    || NVL(LPAD(FWDR.CUST_SEQ,6,'0'),'')        FWDR
            , BK.CMDT_CD
            ,(SELECT CMDT.CMDT_NM FROM MDM_COMMODITY CMDT WHERE BK.CMDT_CD = CMDT.CMDT_CD) CMDT_DESC
            , QTY.CNTR_TPSZ_CD
--            ,(DECODE(SUBSTR(QTY.CNTR_TPSZ_CD, 2, 1), '2', QTY.OP_CNTR_QTY, 0)) FEU
--            ,(DECODE(SUBSTR(QTY.CNTR_TPSZ_CD, 2, 1), '2', 0, QTY.OP_CNTR_QTY)) TEU
			,( SELECT SUM( DECODE(SUBSTR(CNTR_TPSZ_CD, 2, 1), '2', OP_CNTR_QTY, 0) ) FROM BKG_QUANTITY 
				WHERE BKG_NO = BK.BKG_NO 
#if (${tp_sz} == '1')
                AND CNTR_TPSZ_CD = QTY.CNTR_TPSZ_CD
#end
			)AS TEU
			, (
                SELECT SUM( DECODE(SUBSTR(CNTR_TPSZ_CD, 2, 1), '2', 0, OP_CNTR_QTY) ) FROM BKG_QUANTITY 
				WHERE BKG_NO = BK.BKG_NO
#if (${tp_sz} == '1')
                AND CNTR_TPSZ_CD = QTY.CNTR_TPSZ_CD
#end
             ) AS FEU
--                AND CNTR_TPSZ_CD = QTY.CNTR_TPSZ_CD
--          , ROUND(DECODE(BL.WGT_UT_CD, 'KGS', BL.ACT_WGT, BL.ACT_WGT * 0.45) / 1000) TON --아래 BL 관련 주석 같이 풀어야함
			, SSB.CFM_RQST_FLG
			, SSB.CNDDT_CFM_FLG
            , (SELECT WM_CONCAT(LST_SB_RSN_TP_CD)    
                 FROM SPC_SB_BKG_DTL 
                WHERE BKG_NO = SSB.BKG_NO
#if (${lst_sb_rsn_tp_cd} != '')
			      AND LST_SB_RSN_TP_CD = @[lst_sb_rsn_tp_cd]
#end
              ) AS STANDBY_TYPE
            , (SELECT WM_CONCAT(LST_SB_RSN || '||')  
                 FROM SPC_SB_BKG_DTL 
                WHERE BKG_NO = SSB.BKG_NO
#if (${lst_sb_rsn_tp_cd} != '')
			      AND LST_SB_RSN_TP_CD = @[lst_sb_rsn_tp_cd]
#end
               ) AS STANDBY_REASON

        FROM COA_MON_VVD COA
            , BKG_BOOKING BK
            , BKG_VVD VVD
            , BKG_QUANTITY QTY
            , BKG_CUSTOMER SHPR
            , BKG_CUSTOMER CNEE
            , BKG_CUSTOMER FWDR
        --  , BKG_BL_DOC BL --BL관련 주석
            , SPC_SB_BKG SSB
--			, SPC_SB_BKG_DTL SBDTL
        WHERE 1=1
            AND COA.VSL_CD     = BK.VSL_CD
            AND COA.SKD_VOY_NO = BK.SKD_VOY_NO
            AND COA.DIR_CD     = BK.SKD_DIR_CD
            AND BK.BKG_NO      = VVD.BKG_NO
            AND BK.BKG_NO      = QTY.BKG_NO
            AND BK.BKG_NO      = CNEE.BKG_NO(+)
            AND BK.BKG_NO      = SHPR.BKG_NO
            AND 'S'            = SHPR.BKG_CUST_TP_CD
            AND 'C'            = CNEE.BKG_CUST_TP_CD(+) -- S: SHIPPER[물품을 보내는자(송하인)], C:CONSIGNEE[물건을 받는자(수하인)], F:FORWARDER[운송취급인.운송주선인 이라고 하며, 화물을 인수하여 수하인에게 인도할 때까지 일체의 업무를 주선하는 사람]
            AND BK.BKG_NO      = FWDR.BKG_NO(+)
            AND 'F'            = FWDR.BKG_CUST_TP_CD(+)
            AND BK.BKG_CGO_TP_CD <> 'P'
        --  AND BK.BKG_STS_CD  = 'W' --Default 로 W 값만 가져오게 되어 있음.
        --  AND BK.BKG_NO       = BL.BKG_NO --BL관련 주석
            AND BK.BKG_STS_CD IN ('F','W') --Default 로 W 값만 가져오게 되어 있음.
            AND SSB.BKG_NO(+) = BK.BKG_NO
--			AND SSB.BKG_NO = SBDTL.BKG_NO
            AND COA.DELT_FLG   = 'N'
#if (${bkg_vvd_cd} != '')
            AND COA.VSL_CD     = SUBSTR(@[bkg_vvd_cd],1,4)--'COGN0009W'
            AND COA.SKD_VOY_NO = SUBSTR(@[bkg_vvd_cd],5,4)
            AND COA.DIR_CD     = SUBSTR(@[bkg_vvd_cd],-1)
#end
#if(${f_level} != '1')
            AND SPC_SCR_OFC_CONV_FNC(BK.OB_SLS_OFC_CD) IN (  SELECT OFC_CD 
                                                               FROM SPC_OFC_LVL 
                                                              WHERE DECODE(@[f_level], '2', n2nd_prnt_ofc_cd, '3', n4th_prnt_ofc_cd) = @[usr_ofc_cd]
                                                           )
#end
#if (${aloc_sts_cd} != '')
	#if (${aloc_sts_cd} == 'S')
			AND BK.ALOC_STS_CD IN ( 'S' , 'A' )
	#else
            AND BK.ALOC_STS_CD = @[aloc_sts_cd]
	#end
#else
            AND BK.ALOC_STS_CD IN ( 'S' , 'A' )
#end
#if (${trd_cd} != '')
            AND COA.TRD_CD = @[trd_cd]
#end
#if (${sub_trd_cd} != '')
            AND COA.SUB_TRD_CD = @[sub_trd_cd]
#end
#if (${dir_cd} != '')
            AND COA.DIR_CD = @[dir_cd]
#end
#if (${rlane_cd} != '')
            AND COA.RLANE_CD = @[rlane_cd]
#end
#if (${ob_sls_ofc_cd} != '')
            AND BK.OB_SLS_OFC_CD IN (SELECT OFC_CD 
                                       FROM SPC_OFC_LVL
                                       WHERE SUBSTR(COA.SLS_YRMON,1,4)||COA.COST_WK BETWEEN OFC_APLY_FM_YRWK AND OFC_APLY_TO_YRWK
                                         AND N4TH_PRNT_OFC_CD = @[ob_sls_ofc_cd]
                                     )
#end
#if (${bkg_vvd_cd} == '' && ${yr_mon_wk} != '')
--            AND SUBSTR(COA.SLS_YRMON,1,4)||COA.COST_WK IN
--                (
--                SELECT /*+ INDEX(D COST_YR, COST_WK)*/ D.COST_YR||D.COST_WK
--                FROM COA_WK_PRD D
--                WHERE D.COST_YR||D.COST_WK >= @ [yr_mon_wk] --'201501'
--                    AND ROWNUM <= TO_NUMBER(@ [duration]) --('5')
--                )
			AND 1=1
#end
        )
#if (${lst_sb_rsn_tp_cd} != '')
 WHERE NVL(STANDBY_TYPE,' ') = @[lst_sb_rsn_tp_cd]
#end
--GROUP BY BKG_NO
--      ,BKG_STS_CD
--      ,STANDBY_TYPE
--      ,STANDBY_REASON
--      ,ALOC_SVC_CD
--      ,ALOC_STS_CD
--	  ,CFM_RQST_FLG
--	  ,CNDDT_CFM_FLG
--	  ,CFM_USR_ID
--	  ,CFM_DT
#if($c_name.size() != 0)
#foreach(${list} in ${c_name})
      ,${list}
#end
#end
ORDER BY BKG_NO			]]></sql>
			<params>
				<param name="lst_sb_rsn_tp_cd" type="12" value="" out="N"/>
				<param name="bkg_vvd_cd" type="12" value="" out="N"/>
				<param name="f_level" type="12" value="" out="N"/>
				<param name="usr_ofc_cd" type="12" value="" out="N"/>
				<param name="aloc_sts_cd" type="12" value="" out="N"/>
				<param name="trd_cd" type="12" value="" out="N"/>
				<param name="sub_trd_cd" type="12" value="" out="N"/>
				<param name="dir_cd" type="12" value="" out="N"/>
				<param name="rlane_cd" type="12" value="" out="N"/>
				<param name="ob_sls_ofc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
