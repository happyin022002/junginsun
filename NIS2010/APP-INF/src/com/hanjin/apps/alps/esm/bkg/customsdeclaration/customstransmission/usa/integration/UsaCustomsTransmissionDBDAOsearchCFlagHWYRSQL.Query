<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="UsaCustomsTransmissionDBDAOsearchCFlagHWYRSQL">
			<desc><![CDATA[C-Flag 조회 H->W->Y(P)]]></desc>
			<sql><![CDATA[
SELECT CASE WHEN (TB.HOLD_QTY - TB.REMV_QTY) > 0 THEN 'H'
            WHEN TB.PCK_QTY  = TB.W_QTY THEN 'W'
            WHEN TB.PCK_QTY  = TB.Y_ENT_QTY AND TB.PCK_QTY = TB.Y_RLS_QTY THEN 'Y'
            WHEN Y_TOT_FLG = 'Y' AND TB.PCK_QTY  = TB.Y_TOT_QTY THEN 'Y'
            ELSE 'N'
       END C_FLAG
  FROM ( 
		SELECT NVL(SUM(DECODE(CD.CSTMS_DIV_ID, 'CARGO_RLS_H_CD', RS.CNTR_QTY)),0) HOLD_QTY
		      ,NVL(SUM(DECODE(CD.CSTMS_DIV_ID, 'CARGO_RLS_R_CD', RS.CNTR_QTY)),0) REMV_QTY
		      ,SUM(DECODE(CD.CSTMS_DIV_ID, 'CARGO_RLS_Y_CD', DECODE(CD.ATTR_CTNT1, 'ENTR', DECODE(CD.ATTR_CTNT2, 'PLUS', 1, 'MINUS', -1, 0) * RS.CNTR_QTY))) Y_ENT_QTY
		      ,SUM(DECODE(CD.CSTMS_DIV_ID, 'CARGO_RLS_Y_CD', DECODE(CD.ATTR_CTNT1, 'RLSE', DECODE(CD.ATTR_CTNT2, 'PLUS', 1, 'MINUS', -1, 0) * RS.CNTR_QTY))) Y_RLS_QTY
		      ,SUM(DECODE(CD.CSTMS_DIV_ID, 'CARGO_RLS_W_CD', DECODE(CD.ATTR_CTNT2, 'PLUS', 1, 'MINUS', -1, 0) * RS.CNTR_QTY)) W_QTY
              ,NVL(MAX(DECODE(@[icr_code], '54', DECODE(BL.MF_STS_CD, 'D', 0, BL.PCK_QTY), BL.PCK_QTY)),0) AS PCK_QTY
              ,MAX(Y.Y_TOT_FLG) Y_TOT_FLG 
              ,MAX(Y.Y_TOT_QTY) Y_TOT_QTY
		  FROM BKG_CSTMS_ADV_RSLT RS
		      ,BKG_CSTMS_CD_CONV_CTNT CD
              ,BKG_CSTMS_ADV_BL BL
              ,(
                SELECT CASE WHEN SUM(FLAG) > 1 THEN 'Y' ELSE 'N' END AS Y_TOT_FLG
                      ,SUM(CNTR_QTY) Y_TOT_QTY
                  FROM (
                        SELECT DECODE(MAX(RS.DSPO_CD),NULL, 0, 1) AS FLAG
                              ,SUM(DECODE(BL.PCK_QTY, RS.CNTR_QTY, 0, RS.CNTR_QTY)) AS CNTR_QTY
                          FROM BKG_CSTMS_ADV_RSLT RS
                              ,BKG_CSTMS_ADV_BL BL
                         WHERE BL.CNT_CD = 'US'
                           AND BL.BL_NO = @[bl_no]
                           AND BL.CNT_CD = RS.CNT_CD
                           AND BL.BL_NO = RS.BL_NO
                           AND RS.DSPO_CD = '1C'
                           AND NVL(RS.RSND_FLG,'N') <> 'Y'
                           AND RS.BL_NVOCC_TP_CD = 'M'
                        UNION ALL
                        SELECT 0 AS FLAG
                              ,(SUM(RS.CNTR_QTY) * -1) AS CNTR_QTY
                          FROM BKG_CSTMS_ADV_RSLT RS
                         WHERE RS.CNT_CD = 'US'
                           AND RS.BL_NO = @[bl_no]
                           AND RS.DSPO_CD = '4A'
                           AND NVL(RS.RSND_FLG,'N') <> 'Y'
                           AND RS.BL_NVOCC_TP_CD = 'M'
                           AND RS.CSTMS_SEQ > 
                               (SELECT MIN(CSTMS_SEQ) FROM BKG_CSTMS_ADV_RSLT WHERE CNT_CD = 'US' AND BL_NO = @[bl_no] AND DSPO_CD = '1C')
                        UNION ALL
                        SELECT DECODE(MAX(RS.DSPO_CD),NULL, 0, 1) AS FLAG
                              ,SUM(DECODE(BL.PCK_QTY, RS.CNTR_QTY, 0, RS.CNTR_QTY)) AS CNTR_QTY
                          FROM BKG_CSTMS_ADV_RSLT RS
                              ,BKG_CSTMS_ADV_BL BL
                         WHERE BL.CNT_CD = 'US'
                           AND BL.BL_NO = @[bl_no]
                           AND BL.CNT_CD = RS.CNT_CD
                           AND BL.BL_NO = RS.BL_NO
                           AND RS.DSPO_CD = '1W'
                           AND NVL(RS.RSND_FLG,'N') <> 'Y'
                           AND RS.BL_NVOCC_TP_CD = 'M'
                        UNION ALL
                        SELECT DECODE(MAX(RS.DSPO_CD),NULL, 0, 1) AS FLAG
                              ,SUM(DECODE(BL.PCK_QTY, RS.CNTR_QTY, 0, DECODE(SUBSTR(RS.ENTR_NO, 1, 3), 'V5N', 0, RS.CNTR_QTY))) AS CNTR_QTY
                          FROM BKG_CSTMS_ADV_RSLT RS
                              ,BKG_CSTMS_ADV_BL BL
                         WHERE BL.CNT_CD = 'US'
                           AND BL.BL_NO = @[bl_no]
                           AND BL.CNT_CD = RS.CNT_CD
                           AND BL.BL_NO = RS.BL_NO
                           AND RS.DSPO_CD = '1J'
                           AND NVL(RS.RSND_FLG,'N') <> 'Y'
                           AND RS.BL_NVOCC_TP_CD = 'M'
                       )
                ) Y
		 WHERE RS.CNT_CD   = 'US'
		   AND RS.BL_NO    = @[bl_no]
           AND RS.CNT_CD   = BL.CNT_CD
           AND RS.BL_NO    = BL.BL_NO
		   AND RS.CNT_CD   = CD.CNT_CD(+)
		   AND RS.DSPO_CD  = CD.ATTR_CTNT3(+)
		   AND NVL(RS.RSND_FLG,'N') <> 'Y'
		   AND RS.BL_NVOCC_TP_CD = 'M'
#if (${cstms_seq} != '') 
           AND RS.CSTMS_SEQ NOT IN (${cstms_seq})
#end
       ) TB			]]></sql>
			<params>
				<param name="icr_code" type="12" value="" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
