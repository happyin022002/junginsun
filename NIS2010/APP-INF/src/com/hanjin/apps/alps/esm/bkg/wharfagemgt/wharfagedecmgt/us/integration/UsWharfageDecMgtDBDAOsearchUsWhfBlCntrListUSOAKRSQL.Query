<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="UsWharfageDecMgtDBDAOsearchUsWhfBlCntrListUSOAKRSQL">
			<desc><![CDATA[searchUsWhfBlCntrListUSOAK]]></desc>
			<sql><![CDATA[
WITH BKG_INFO AS (
SELECT  B.BL_NO
       ,C.CNTR_NO
  FROM  (
         SELECT B.BL_NO, B.BKG_NO
           FROM BKG_BOOKING B
          WHERE B.BL_NO = @[bl_no]
            AND B.BKG_STS_CD IN ('F','W')
        ) B
       ,BKG_CONTAINER C
 WHERE  B.BKG_NO = C.BKG_NO
MINUS
SELECT  B.BL_NO
       ,C.CNTR_NO
  FROM  BKG_USA_WHF_BL B
       ,BKG_USA_WHF_CNTR C
 WHERE  B.VSL_CD = C.VSL_CD
   AND  B.SKD_VOY_NO = C.SKD_VOY_NO
   AND  B.SKD_DIR_CD = C.SKD_DIR_CD
   AND  B.PORT_CD = C.PORT_CD
   AND  B.IO_BND_CD = C.IO_BND_CD
   AND  B.BL_NO = C.BL_NO
   AND  B.VSL_CD = SUBSTR(@[vvd], 1,4)
   AND  B.SKD_VOY_NO = SUBSTR(@[vvd], 5,4)
   AND  B.SKD_DIR_CD = SUBSTR(@[vvd], 9,1)
   AND  B.IO_BND_CD = @[bound]
   AND  B.PORT_CD = @[port]
   AND  B.BL_NO = @[bl_no]
)
SELECT 
    TB.BL_NO
,   TB.CNTR_NO
,   TB.FULL_MTY_CD
,   TB.CSTMS_DESC
,   TB.USA_WHF_EXPT_FLG
,   TB.ORG_DEST_LOC_CD
,   TB.USA_WHF_TRSP_TP_CD
,   DECODE(@[bound], 'I', TB.DE_TERM_CD, TB.RCV_TERM_CD) AS TERM
,   DECODE(TB.USA_WHF_RAT_UT_CD, '20F', TB.CNTR_VOL_QTY) FT20
,   DECODE(TB.USA_WHF_RAT_UT_CD, '40F', TB.CNTR_VOL_QTY) FT40
,   DECODE(TB.USA_WHF_RAT_UT_CD, '45F', TB.CNTR_VOL_QTY) FT45
,   TB.VSL_CD
,   TB.SKD_VOY_NO
,   TB.SKD_DIR_CD
,   TB.PORT_CD
,   TB.CNTR_TPSZ_CD
,   TB.USA_WHF_RAT_UT_CD
,   TB.CNTR_VOL_QTY
,   TB.RCV_TERM_CD
,   TB.DE_TERM_CD
,   RT.WHF_UT_PRC
,   TB.RAT_AS_QTY
,   TB.STE_CD
  FROM (
    SELECT A.BL_NO
          ,D.CNTR_NO
          ,CASE WHEN A.BKG_CGO_TP_CD = 'F' THEN 'F'
                WHEN A.BKG_CGO_TP_CD IN ('P','R') THEN 'M'
                ELSE '' 
                END FULL_MTY_CD
          ,C.CSTMS_DESC
          ,'N' AS USA_WHF_EXPT_FLG
          ,DECODE(@[bound], 'I', A.DEL_CD, A.POR_CD) AS ORG_DEST_LOC_CD
          ,BKG_GET_USOAK_WHF_TRSP_TP_FNC(A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.BL_NO, @[bound]) AS USA_WHF_TRSP_TP_CD
          ,D.RCV_TERM_CD
          ,D.DE_TERM_CD
          ,A.VSL_CD
          ,A.SKD_VOY_NO
          ,A.SKD_DIR_CD
          ,DECODE(@[bound], 'I', A.POD_CD, A.POL_CD) AS PORT_CD
          ,D.CNTR_TPSZ_CD
          ,CASE SUBSTR(D.CNTR_TPSZ_CD, 2, 1)
           WHEN '2' THEN '20F'
           WHEN '4' THEN '40F'
           WHEN '5' THEN '40F'
           ELSE '45F'
            END AS USA_WHF_RAT_UT_CD
          ,D.CNTR_VOL_QTY
          ,D.CNTR_VOL_QTY AS RAT_AS_QTY
          ,M.STE_CD
      FROM BKG_BOOKING A
          ,BKG_CUSTOMER B
          ,BKG_BL_DOC C
          ,BKG_CONTAINER D
          ,BKG_INFO BKG
          ,MDM_LOCATION M
     WHERE A.BKG_NO = B.BKG_NO
       AND A.BKG_NO = C.BKG_NO
       AND B.BKG_CUST_TP_CD = 'C'
       AND A.BKG_NO = D.BKG_NO
       AND A.BL_NO = BKG.BL_NO
       AND D.CNTR_NO = BKG.CNTR_NO
#if (${bound} == 'I')
       AND A.DEL_CD = M.LOC_CD(+)
#else
       AND A.POR_CD = M.LOC_CD(+)
#end
    ) TB
    ,
   (
     SELECT USA_WHF_RAT_UT_CD
           ,FULL_MTY_CD
           ,USA_WHF_TRSP_TP_CD
           ,USA_WHF_EXPT_FLG
           ,WHF_UT_PRC
       FROM BKG_USA_WHF_RT_DTL DTL
           ,(SELECT MAX(EFF_DT) AS EFF_DT
               FROM BKG_USA_WHF_RT
              WHERE PORT_CD = @[port]
                AND IO_BND_CD = @[bound]
            ) MAX_RT
      WHERE PORT_CD = @[port]
        AND IO_BND_CD = @[bound]
        AND DTL.EFF_DT = MAX_RT.EFF_DT
       ) RT
 WHERE  TB.USA_WHF_RAT_UT_CD = RT.USA_WHF_RAT_UT_CD(+)
   AND  TB.FULL_MTY_CD = RT.FULL_MTY_CD(+)
   AND  TB.USA_WHF_TRSP_TP_CD = RT.USA_WHF_TRSP_TP_CD(+)
   AND  TB.USA_WHF_EXPT_FLG = RT.USA_WHF_EXPT_FLG(+)			]]></sql>
			<params>
				<param name="bl_no" type="12" value="" out="N"/>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="bound" type="12" value="" out="N"/>
				<param name="port" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
