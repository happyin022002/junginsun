<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="SpaceControlInquiryDBDAOSearchSpaceControlInquiryListRSQL">
			<desc><![CDATA[Allocation History
Lee Sang-Yong : [프로젝트] Ticket ID : CHM-201004171 53ft 추가
[CHM-201322502-01] SPC 프로젝트 - 성수기 선복운영 개선을 위한 T/F추진
2014.08.12 [CHM-201431081] SPC Allocation Control Option 추가 보완 요청건]]></desc>
			<sql><![CDATA[
SELECT ALOC_GDT,
       USER_NM ,
       SLS_OFC_CD,
       USA_BKG_MOD_CD,
       CUST_ACCT,
       CUST_LGL_ENG_NM,
       POL_YD_CD,
       POD_YD_CD,
       DEST_LOC_CD,
       ALOC_LOD_QTY    ,
       ALOC_40FT_HC_QTY,
       ALOC_45FT_HC_QTY,
       ALOC_53FT_QTY   ,
       ALOC_RF_QTY     ,
       ALOC_TTL_WGT    ,
       FCAST_TTL_TEU_QTY,
       FCAST_TTL_QTY      ,
       FCAST_40FT_HC_QTY  ,
       FCAST_45FT_HC_QTY  ,
       FCAST_53FT_QTY     ,
       FCAST_RF_QTY       ,
       FCAST_TTL_WGT      ,
       USD_BKG_TTL_QTY    ,
       USD_BKG_20FT_QTY   ,
       USD_BKG_40FT_QTY   ,
       USD_BKG_40FT_HC_QTY,
       USD_BKG_45FT_HC_QTY,
       USD_BKG_53FT_QTY   ,
       USD_BKG_RF_QTY     ,
       USD_BKG_TTL_WGT    ,
       ASGN_20FT_DRY_QTY,
       ASGN_40FT_DRY_QTY,
       ASGN_RD_QTY,
       BKG_AVAL_20FT_DRY_QTY,
       BKG_AVAL_40FT_DRY_QTY,
       BKG_AVAL_RD_QTY,
       FCAST_20FT_DRY_QTY,
       FCAST_40FT_DRY_QTY,
       FCAST_RD_QTY,
       USD_BKG_20FT_DRY_QTY,
       USD_BKG_40FT_DRY_QTY,
       USD_BKG_RD_QTY,
       ALOC_20FT_DRY_QTY,
       ALOC_40FT_DRY_QTY,
       ALOC_RD_QTY,
#if(${table} == 'SPC_ALOC_CUST_HIS')
       ACCT_GRP ,
#end       
       CTRT_FCAST_TTL_TEU_QTY,
       CTRT_FCAST_TTL_QTY    ,
       CTRT_FCAST_40FT_HC_QTY,
       CTRT_FCAST_45FT_HC_QTY,
       CTRT_FCAST_53FT_QTY   ,
       CTRT_FCAST_RF_QTY     ,
       CTRT_FCAST_TTL_WGT    ,
       LVL 
  FROM (

        SELECT DISTINCT
               TO_CHAR(A.ALOC_GDT, 'YYYY-MM-DD HH24:MI:SS')          AS ALOC_GDT,
               DECODE(B.USR_NM, '', '*'||A.ALOC_USR_ID, B.USR_NM) AS USER_NM ,
               A.SLS_OFC_CD AS SLS_OFC_CD,
               DECODE(A.POL_YD_CD, '0000000', '+', A.POL_YD_CD)   AS POL_YD_CD,
        	   DECODE(A.POD_YD_CD, '0000000', DECODE(A.POL_YD_CD, '0000000', '+', DECODE(A.POD_YD_CD, '0000000', '+', A.POD_YD_CD)), A.POD_YD_CD) AS POD_YD_CD,
        	   --DECODE(A.DEST_LOC_CD, '00000', DECODE(A.POD_YD_CD, '0000000', '+', DECODE(A.DEST_LOC_CD, '00000', '+', A.DEST_LOC_CD)), A.DEST_LOC_CD) AS DEST_LOC_CD,
               A.ALOC_LOD_QTY          AS ALOC_LOD_QTY    ,
               A.ALOC_40FT_HC_QTY      AS ALOC_40FT_HC_QTY,
               A.ALOC_45FT_HC_QTY      AS ALOC_45FT_HC_QTY,
               NVL(A.ALOC_53FT_QTY, 0) AS ALOC_53FT_QTY   ,
               A.ALOC_RF_QTY           AS ALOC_RF_QTY     ,
               A.ALOC_TTL_WGT          AS ALOC_TTL_WGT    ,
               NVL(A.FCAST_TTL_QTY, 0) + NVL(A.FCAST_40FT_HC_QTY, 0) * 2 + NVL(A.FCAST_45FT_HC_QTY, 0) * 2 + NVL(A.FCAST_53FT_QTY, 0) * 2 AS FCAST_TTL_TEU_QTY,
               A.FCAST_TTL_QTY            AS FCAST_TTL_QTY      ,
               A.FCAST_40FT_HC_QTY        AS FCAST_40FT_HC_QTY  ,
               A.FCAST_45FT_HC_QTY        AS FCAST_45FT_HC_QTY  ,
               NVL(A.FCAST_53FT_QTY, 0)   AS FCAST_53FT_QTY     ,
               A.FCAST_RF_QTY             AS FCAST_RF_QTY       ,
               A.FCAST_TTL_WGT            AS FCAST_TTL_WGT      ,
               A.USD_BKG_TTL_QTY          AS USD_BKG_TTL_QTY    ,
               A.USD_BKG_20FT_QTY         AS USD_BKG_20FT_QTY   ,
               A.USD_BKG_40FT_QTY         AS USD_BKG_40FT_QTY   ,
               A.USD_BKG_40FT_HC_QTY      AS USD_BKG_40FT_HC_QTY,
               A.USD_BKG_45FT_HC_QTY      AS USD_BKG_45FT_HC_QTY,
               NVL(A.USD_BKG_53FT_QTY, 0) AS USD_BKG_53FT_QTY   ,
               A.USD_BKG_RF_QTY           AS USD_BKG_RF_QTY     ,
               A.USD_BKG_TTL_WGT          AS USD_BKG_TTL_WGT    ,
               
               --2014.08.07 컬럼추가
               DECODE(A.CTRT_NO||A.CUST_CNT_CD||LPAD(A.CUST_SEQ, 6,'0'), '000000000', '+', 'X00000000', '+', 
                       DECODE(A.CTRT_NO||A.CUST_CNT_CD||LPAD(A.CUST_SEQ, 6,'0'), 'XXX999999', 'XXX999999', 
                              DECODE(A.CUST_CNT_CD||LPAD(A.CUST_SEQ, 6,'0'), 'XX999999', A.CTRT_NO, A.CUST_CNT_CD||LPAD(A.CUST_SEQ, 6,'0'))   
                              )
                      ) AS CUST_ACCT,  
               CASE WHEN A.CTRT_NO||A.CUST_CNT_CD = 'XXX' THEN
                     'OTHERS'
                    WHEN A.CUST_CNT_CD <> 'XX' THEN
                    (
                      SELECT CUST_LGL_ENG_NM
                        FROM MDM_CUSTOMER
                       WHERE CUST_CNT_CD = A.CUST_CNT_CD
                         AND CUST_SEQ    = A.CUST_SEQ
                     )
                    ELSE
                     A.CTRT_NO
               END AS CUST_LGL_ENG_NM,
               DECODE(USA_BKG_MOD_CD, '00000', '+', USA_BKG_MOD_CD)   AS USA_BKG_MOD_CD,
               DECODE(DEST_LOC_CD, '00000', '+', DECODE(DEST_LOC_CD,'XXXXX','OTHERS',DEST_LOC_CD))   AS DEST_LOC_CD,
               
               NVL(ASGN_20FT_DRY_QTY, 0)          AS ASGN_20FT_DRY_QTY,
               NVL(ASGN_40FT_DRY_QTY, 0)          AS ASGN_40FT_DRY_QTY,
               NVL(ASGN_RD_QTY, 0)                AS ASGN_RD_QTY,
               NVL(BKG_AVAL_20FT_DRY_QTY, 0)      AS BKG_AVAL_20FT_DRY_QTY,
               NVL(BKG_AVAL_40FT_DRY_QTY, 0)      AS BKG_AVAL_40FT_DRY_QTY,
               NVL(BKG_AVAL_RD_QTY, 0)            AS BKG_AVAL_RD_QTY,
               NVL(FCAST_20FT_DRY_QTY, 0)         AS FCAST_20FT_DRY_QTY,
               NVL(FCAST_40FT_DRY_QTY, 0)         AS FCAST_40FT_DRY_QTY,
               NVL(FCAST_RD_QTY, 0)               AS FCAST_RD_QTY,
               NVL(USD_BKG_20FT_DRY_QTY, 0)       AS USD_BKG_20FT_DRY_QTY,
               NVL(USD_BKG_40FT_DRY_QTY, 0)       AS USD_BKG_40FT_DRY_QTY,
               NVL(USD_BKG_RD_QTY, 0)             AS USD_BKG_RD_QTY,
               NVL(ALOC_20FT_DRY_QTY, 0)          AS ALOC_20FT_DRY_QTY,
               NVL(ALOC_40FT_DRY_QTY, 0)          AS ALOC_40FT_DRY_QTY,
               NVL(ALOC_RD_QTY, 0)                AS ALOC_RD_QTY,
#if(${table} == 'SPC_ALOC_CUST_HIS')
               NVL(A.CUST_CTRL_CD, 'C')   AS ACCT_GRP           ,
#end
               NVL(A.CTRT_FCAST_TTL_QTY, 0) + NVL(A.CTRT_FCAST_40FT_HC_QTY, 0) * 2 + NVL(A.CTRT_FCAST_45FT_HC_QTY, 0) * 2 + NVL(A.CTRT_FCAST_53FT_QTY, 0) * 2 AS CTRT_FCAST_TTL_TEU_QTY,
               NVL(A.CTRT_FCAST_TTL_QTY    , 0) AS CTRT_FCAST_TTL_QTY    ,
               NVL(A.CTRT_FCAST_40FT_HC_QTY, 0) AS CTRT_FCAST_40FT_HC_QTY,
               NVL(A.CTRT_FCAST_45FT_HC_QTY, 0) AS CTRT_FCAST_45FT_HC_QTY,
               NVL(A.CTRT_FCAST_53FT_QTY   , 0) AS CTRT_FCAST_53FT_QTY   ,
               NVL(A.CTRT_FCAST_RF_QTY     , 0) AS CTRT_FCAST_RF_QTY     ,
               NVL(A.CTRT_FCAST_TTL_WGT    , 0) AS CTRT_FCAST_TTL_WGT    ,
               CASE WHEN USA_BKG_MOD_CD = '00000' THEN 
                    1
                    ELSE CASE WHEN CTRT_NO||CUST_CNT_CD||LPAD(CUST_SEQ, 6,'0') IN ('000000000', 'X00000000') THEN
                         2
                         ELSE CASE WHEN POL_YD_CD = '0000000' AND TO_CHAR(A.ALOC_GDT, 'YYYYMMDD') >= '20140825' THEN                            
                              3
                              WHEN POL_YD_CD = '0000000' AND TO_CHAR(A.ALOC_GDT, 'YYYYMMDD') < '20140825' THEN
                                   1
                                   ELSE CASE WHEN POD_YD_CD = '0000000' AND TO_CHAR(A.ALOC_GDT, 'YYYYMMDD') >= '20140825' THEN                           
                                       4
                                       WHEN POD_YD_CD = '0000000' AND TO_CHAR(A.ALOC_GDT, 'YYYYMMDD') < '20140825' THEN 
                                            4                               
                                       ELSE CASE WHEN DEST_LOC_CD = '00000' AND TO_CHAR(A.ALOC_GDT, 'YYYYMMDD') >= '20140825' THEN
                                            5  
                                       WHEN DEST_LOC_CD != '00000' AND TO_CHAR(A.ALOC_GDT, 'YYYYMMDD') < '20140825' THEN
                                            5                             
                                       ELSE
                                            6
                               END
                           END
                       END
                   END
               END AS LVL
--               DECODE(A.POL_YD_CD, '0000000', DECODE(A.POD_YD_CD, '0000000', 1, 2), DECODE(A.POD_YD_CD, '0000000', 2, 3)) AS LVL 
          FROM ${table}     A,
               COM_USER     B
         WHERE A.VSL_CD       = @[vsl_cd]
           AND A.SKD_VOY_NO   = @[skd_voy_no]
           AND A.SKD_DIR_CD   = @[skd_dir_cd]

#if (${ioc} == 'NYCRA' || ${ioc} == 'HAMRU')
           AND A.SLS_OFC_CD   = @[ioc]
           AND A.IOC_TS_CD    = @[ioc_ts_cd]
           AND A.MNL_ALOC_RMK = @[mnl_aloc_rmk]
#else
           AND A.IOC_TS_CD    = @[ioc]
#end

#if (${cond1} == 'TRUE')
           AND A.SLS_OFC_CD   = @[sales_office]
           AND A.MNL_ALOC_RMK = @[mnl_aloc_rmk]
#end
    
#if (${cond2} == 'TRUE')
           AND A.SLS_OFC_CD   = @[sub_office]
           AND A.MNL_ALOC_RMK = @[mnl_aloc_rmk]
#end

#if (${cond3} == 'TRUE')
           AND A.SLS_OFC_CD   = @[sub_office]
           AND A.MNL_ALOC_RMK = @[mnl_aloc_rmk]
#end

           AND A.ALOC_USR_ID  = B.USR_ID(+)
       )
 ORDER BY ALOC_GDT DESC,
#if(${table} == 'SPC_ALOC_CUST_HIS')
       ACCT_GRP       ,
#end
       USA_BKG_MOD_CD,
       CUST_ACCT,
       POL_YD_CD    ,
       POD_YD_CD    ,
       DEST_LOC_CD			]]></sql>
			<params>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="ioc" type="12" value="" out="N"/>
				<param name="ioc_ts_cd" type="12" value="" out="N"/>
				<param name="mnl_aloc_rmk" type="12" value="" out="N"/>
				<param name="sales_office" type="12" value="" out="N"/>
				<param name="sub_office" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
