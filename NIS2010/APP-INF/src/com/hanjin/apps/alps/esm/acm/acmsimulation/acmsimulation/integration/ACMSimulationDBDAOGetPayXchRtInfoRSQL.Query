<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ACMSimulationDBDAOGetPayXchRtInfoRSQL">
			<desc><![CDATA[GetPayXchRtInfo
ACM_AGN_AGMT_DTL.COMM_RT 가 0 보다 큰 경우에, 
ACM_OFC_INFO 에 지정된 xch_rt_div_lvl 에 따른 
환율을 적용 하여 ACM_AGN_COMM.PAY_CRNT_AMT 금액을 만든다.]]></desc>
			<sql><![CDATA[
#if (${xch_rt_div_lvl} == '1')

-- VVD EXCHANGE RATES
SELECT NVL(NVL(C_VVD_PAY_XCH_RT, R_VVD_PAY_XCH_RT), 0) AS PAY_XCH_RT
FROM (
  SELECT NVL((SELECT X.INV_XCH_RT
                    FROM INV_VVD_XCH_RT X
                    WHERE X.VSL_CD = @[vsl_cd]
                      AND X.SKD_VOY_NO = @[skd_voy_no]
                      AND X.SKD_DIR_CD = @[skd_dir_cd]
                      AND X.SVC_SCP_CD IN (NVL(@[svc_scp_cd], 'OTH'))
                      AND X.IO_BND_CD = @[io_bnd_cd]
                      AND X.PORT_CD = @[port]
                      AND X.LOCL_CURR_CD = @[ofc_curr_cd]
                      AND X.CHG_CURR_CD = 'USD'
             ),
             (SELECT X.INV_XCH_RT
              FROM INV_VVD_XCH_RT X
              WHERE X.VSL_CD = @[vsl_cd]
                AND X.SKD_VOY_NO = @[skd_voy_no]
                AND X.SKD_DIR_CD = @[skd_dir_cd]
                AND X.SVC_SCP_CD IN ('OTH')
                AND X.IO_BND_CD = @[io_bnd_cd]
                AND X.PORT_CD = @[port]
                AND X.LOCL_CURR_CD = @[ofc_curr_cd]
                AND X.CHG_CURR_CD = 'USD'
             )
            ) AS C_VVD_PAY_XCH_RT,
    NVL((SELECT X.INV_XCH_RT
         FROM INV_VVD_XCH_RT X,
           BKG_VVD V,
           MAS_RGST_BKG C
         WHERE X.VSL_CD = C.VSL_CD
           AND X.SKD_VOY_NO = C.SKD_VOY_NO
           AND X.SKD_DIR_CD = C.DIR_CD
           AND X.SVC_SCP_CD IN (NVL(@[svc_scp_cd], 'OTH'))
           AND V.BKG_NO = @[bkg_no]
           AND C.BKG_NO = V.BKG_NO
           AND X.VSL_CD = V.VSL_CD
           AND X.SKD_VOY_NO = V.SKD_VOY_NO
           AND X.SKD_DIR_CD = V.SKD_DIR_CD
           AND X.IO_BND_CD = @[io_bnd_cd]
           AND X.PORT_CD = CASE WHEN @[io_bnd_cd] = 'O' THEN V.POL_CD
                                             WHEN @[io_bnd_cd] = 'I' THEN V.POD_CD
                                      END
           AND X.LOCL_CURR_CD = @[ofc_curr_cd]
           AND X.CHG_CURR_CD  = 'USD'
           -- [CHM-201536641] 동일한 VVD가 Pre/Post/Trunk에 중복으로 되어 있는 경우, Trunk 기준으로 출력
           AND V.VSL_PRE_PST_CD = (SELECT VSL_PRE_PST_CD
                                   FROM (SELECT VVD.VSL_PRE_PST_CD,
                                           ROW_NUMBER() OVER(ORDER BY DECODE(VVD.VSL_PRE_PST_CD, 'T', 0, DECODE(@[io_bnd_cd], 'I', 'U', 'S'), 1, 2)) RN
                                         FROM BKG_VVD VVD,
                                           MAS_RGST_BKG BKG
                                         WHERE BKG.BKG_NO = @[bkg_no]
                                           AND BKG.BKG_NO = VVD.BKG_NO
                                           AND BKG.VSL_CD = VVD.VSL_CD
                                           AND BKG.SKD_VOY_NO = VVD.SKD_VOY_NO
                                           AND BKG.DIR_CD = VVD.SKD_DIR_CD
                                        )
                                   WHERE RN = 1
                                  )
        ),
        (SELECT X.INV_XCH_RT
         FROM INV_VVD_XCH_RT X,
           BKG_VVD V,
           MAS_RGST_BKG C
         WHERE X.VSL_CD = C.VSL_CD
           AND X.SKD_VOY_NO = C.SKD_VOY_NO
           AND X.SKD_DIR_CD = C.DIR_CD
           AND V.BKG_NO = @[bkg_no]
           AND C.BKG_NO = V.BKG_NO
           AND X.VSL_CD = V.VSL_CD
           AND X.SKD_VOY_NO = V.SKD_VOY_NO
           AND X.SKD_DIR_CD = V.SKD_DIR_CD
           AND X.SVC_SCP_CD IN ('OTH')
           AND X.IO_BND_CD = @[io_bnd_cd]
           AND X.PORT_CD = CASE WHEN @[io_bnd_cd] = 'O' THEN V.POL_CD
                                WHEN @[io_bnd_cd] = 'I' THEN V.POD_CD
                           END
           AND X.LOCL_CURR_CD = @[ofc_curr_cd]
           AND X.CHG_CURR_CD = 'USD'
           -- [CHM-201536641] 동일한 VVD가 Pre/Post/Trunk에 중복으로 되어 있는 경우, Trunk 기준으로 출력
           AND V.VSL_PRE_PST_CD = (SELECT VSL_PRE_PST_CD
                                              FROM (SELECT VVD.VSL_PRE_PST_CD,
												ROW_NUMBER() OVER(ORDER BY DECODE(VVD.VSL_PRE_PST_CD, 'T', 0, DECODE(@[io_bnd_cd], 'I', 'U', 'S'), 1, 2)) RN
											FROM BKG_VVD VVD,
                                           MAS_RGST_BKG BKG
											WHERE BKG.BKG_NO = @[bkg_no]
                                           AND BKG.BKG_NO = VVD.BKG_NO
                                           AND BKG.VSL_CD = VVD.VSL_CD
                                           AND BKG.SKD_VOY_NO = VVD.SKD_VOY_NO
                                           AND BKG.DIR_CD = VVD.SKD_DIR_CD
                                        )
                                   WHERE RN = 1
                                  )
        )
       ) AS R_VVD_PAY_XCH_RT
  FROM DUAL
)

#elseif (${xch_rt_div_lvl} == '2')

-- MONTHLY EXCHANGE RATE
SELECT NVL((SELECT USD_LOCL_XCH_RT
            FROM GL_MON_XCH_RT B
            WHERE CURR_CD = @[ofc_curr_cd]
              AND ACCT_XCH_RT_LVL   = '1'
              AND ACCT_XCH_RT_YRMON = (CASE WHEN SUBSTR(@[sa_dt], 1, 6) > TO_CHAR(SYSDATE, 'YYYYMM')
                                              THEN TO_CHAR(ADD_MONTHS(TO_DATE(SUBSTR(@[sa_dt], 1, 6), 'YYYYMM'), -1),'YYYYMM')
                                            ELSE SUBSTR(@[sa_dt], 1, 6)
                                       END
                                      ) 
           ), 0) AS PAY_XCH_RT
FROM DUAL

#elseif (${xch_rt_div_lvl} == '3')

-- DAILY EXCHANGE RATE
SELECT NVL((SELECT INV_XCH_RT
            FROM INV_CUST_AND_DLY_XCH_RT
            WHERE CUST_CNT_CD = 'XX'
              AND CUST_SEQ = 0
              AND IO_BND_CD = @[io_bnd_cd]
              AND FM_DT >= @[sa_dt]
              AND TO_DT <= @[sa_dt]
              AND CHG_CURR_CD = 'USD'
              AND LOCL_CURR_CD = @[ofc_curr_cd]
           ), 0
          ) AS PAY_XCH_RT
FROM DUAL

#elseif (${xch_rt_div_lvl} == '4')

-- OFFICE EXCHANGE RATE
SELECT NVL((SELECT FX_CURR_RT
            FROM MDM_ORGANIZATION
            WHERE OFC_CD = @[agn_cd]
           ), 0
          ) AS PAY_XCH_RT
FROM DUAL

#end			]]></sql>
			<params>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="svc_scp_cd" type="12" value="" out="N"/>
				<param name="io_bnd_cd" type="12" value="" out="N"/>
				<param name="port" type="12" value="" out="N"/>
				<param name="ofc_curr_cd" type="12" value="" out="N"/>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="sa_dt" type="12" value="" out="N"/>
				<param name="agn_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
