<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="GeneralBookingReceiptDBDAOSearchTrnkVvdByRlaneRSQL">
			<desc><![CDATA[입력한 vvd 중 trunk vvd를 coa 항차 기준으로 계산한다]]></desc>
			<sql><![CDATA[
WITH VVD AS (
SELECT N1ST_SLAN_CD
	, @[n1_pol] N1ST_POL_CD
    , @[n1_pod] N1ST_POD_CD
	, (SELECT CONTI_CD FROM MDM_LOCATION WHERE LOC_CD = @[n1_pol]) N1ST_ORG_CONTI_CD
	, (SELECT CONTI_CD FROM MDM_LOCATION WHERE LOC_CD = @[n1_pod]) N1ST_DEST_CONTI_CD
    , SUBSTR(@[n1_vvd], 9, 1) N1ST_SKD_DIR_CD
	, CASE WHEN (SELECT VSL_SVC_TP_CD FROM MDM_VSL_SVC_LANE WHERE VSL_SLAN_CD = N1ST_SLAN_CD) = 'O' THEN 'RBCCO'--OFF는 RBCCO
	       ELSE DECODE(N1ST_R_LANE, 'RBCCO', 'NOFDR', N1ST_R_LANE) END N1ST_R_LANE
	, NVL((SELECT MIN(rnk.RNK_SEQ)
	         FROM AR_ROUT_RNK rnk
            WHERE rnk.ZN_IOC_CD   like DECODE(N1ST_ORG_CONTI_CD, DECODE(N1ST_DEST_CONTI_CD,'F', DECODE(N1ST_R_LANE, 'WAFIE', 'E', 'RESIA', 'A', N1ST_DEST_CONTI_CD), N1ST_DEST_CONTI_CD), 'I'||N1ST_ORG_CONTI_CD, 'OO')||'%'
	          AND rnk.RLANE_CD    = DECODE(N1ST_R_LANE, 'RBCCO', 'X', N1ST_R_LANE)
	       ), 9999) N1ST_AR_RNK
	, N2ND_SLAN_CD
    , @[n2_pol] N2ND_POL_CD
    , @[n2_pod] N2ND_POD_CD
	, (SELECT CONTI_CD FROM MDM_LOCATION WHERE LOC_CD = @[n2_pol]) N2ND_ORG_CONTI_CD
	, (SELECT CONTI_CD FROM MDM_LOCATION WHERE LOC_CD = @[n2_pod]) N2ND_DEST_CONTI_CD
    , SUBSTR(@[n2_vvd], 9, 1) N2ND_SKD_DIR_CD
	, CASE WHEN (SELECT VSL_SVC_TP_CD FROM MDM_VSL_SVC_LANE WHERE VSL_SLAN_CD = N2ND_SLAN_CD) = 'O' THEN 'RBCCO'--OFF는 RBCCO
	       ELSE DECODE(N2ND_R_LANE, 'RBCCO', 'NOFDR', N2ND_R_LANE) END N2ND_R_LANE
	, NVL((SELECT MIN(rnk.RNK_SEQ)
	         FROM AR_ROUT_RNK rnk
	        WHERE rnk.SLAN_CD     = N2nd_SLAN_CD
	          AND rnk.ZN_IOC_CD   like DECODE(N2ND_ORG_CONTI_CD, DECODE(N2nd_DEST_CONTI_CD,'F', DECODE(N2nd_R_LANE, 'WAFIE', 'E', 'RESIA', 'A', N2nd_DEST_CONTI_CD), N2nd_DEST_CONTI_CD), 'I'||N2nd_ORG_CONTI_CD, 'OO')||'%'
	          AND rnk.RLANE_CD    = DECODE(N2ND_R_LANE, 'RBCCO', 'X', N2ND_R_LANE)
	      ), 9999) N2ND_AR_RNK
	, N3RD_SLAN_CD
    , @[n3_pol] N3RD_POL_CD
    , @[n3_pod] N3RD_POD_CD
	, (SELECT CONTI_CD FROM MDM_LOCATION WHERE LOC_CD = @[n3_pol]) N3RD_ORG_CONTI_CD
	, (SELECT CONTI_CD FROM MDM_LOCATION WHERE LOC_CD = @[n3_pod]) N3RD_DEST_CONTI_CD
    , SUBSTR(@[n3_vvd], 9, 1) N3RD_SKD_DIR_CD
	, CASE WHEN (SELECT VSL_SVC_TP_CD FROM MDM_VSL_SVC_LANE WHERE VSL_SLAN_CD = N3RD_SLAN_CD) = 'O' THEN 'RBCCO'--OFF는 RBCCO
	       ELSE DECODE(N3RD_R_LANE, 'RBCCO', 'NOFDR', N3RD_R_LANE) END N3RD_R_LANE
	, NVL((SELECT MIN(rnk.RNK_SEQ)
	         FROM AR_ROUT_RNK rnk
	        WHERE rnk.SLAN_CD     = N3rd_SLAN_CD
	          AND rnk.ZN_IOC_CD   like DECODE(N3rd_ORG_CONTI_CD, DECODE(N3rd_DEST_CONTI_CD,'F', DECODE(N3rd_R_LANE, 'WAFIE', 'E', 'RESIA', 'A', N3rd_DEST_CONTI_CD), N3rd_DEST_CONTI_CD), 'I'||N3rd_ORG_CONTI_CD, 'OO')||'%'
	          AND rnk.RLANE_CD    = DECODE(N3RD_R_LANE, 'RBCCO', 'X', N3RD_R_LANE)	
	      ), 9999) N3RD_AR_RNK
	, N4TH_SLAN_CD
    , @[n4_pol] N4TH_POL_CD
    , @[n4_pod] N4TH_POD_CD
	, (SELECT CONTI_CD FROM MDM_LOCATION WHERE LOC_CD = @[n4_pol]) N4TH_ORG_CONTI_CD
	, (SELECT CONTI_CD FROM MDM_LOCATION WHERE LOC_CD = @[n4_pod]) N4TH_DEST_CONTI_CD
    , SUBSTR(@[n4_vvd], 9, 1) N4TH_SKD_DIR_CD
	, CASE WHEN (SELECT VSL_SVC_TP_CD FROM MDM_VSL_SVC_LANE WHERE VSL_SLAN_CD = N4TH_SLAN_CD) = 'O' THEN 'RBCCO'--OFF는 RBCCO
	       ELSE DECODE(N4TH_R_LANE, 'RBCCO', 'NOFDR', N4TH_R_LANE) END N4TH_R_LANE
	, NVL((SELECT MIN(Rnk.RNK_SEQ)
	         FROM AR_ROUT_RNK rnk
	        WHERE rnk.SLAN_CD     = N4th_SLAN_CD
	          AND rnk.ZN_IOC_CD   like DECODE(N4th_ORG_CONTI_CD, DECODE(N4th_DEST_CONTI_CD,'F', DECODE(N4th_R_LANE, 'WAFIE', 'E', 'RESIA', 'A', N4th_DEST_CONTI_CD), N4th_DEST_CONTI_CD), 'I'||N4th_ORG_CONTI_CD, 'OO')||'%'
	          AND rnk.RLANE_CD    = DECODE(N4TH_R_LANE, 'RBCCO', 'X', N4TH_R_LANE)
			), 9999) N4TH_AR_RNK
	, (SELECT SEQ --MAX TRANSIT TIME - SEQ
	     FROM 
    	  (SELECT TZ_TM, SEQ
    	     FROM ( SELECT MAX(POD.VPS_ETA_DT) - MIN(POL.VPS_ETD_DT) TZ_TM, 1 SEQ
            	      FROM VSK_VSL_PORT_SKD POL, VSK_VSL_PORT_SKD POD
            	     WHERE POL.VSL_CD = SUBSTR(@[n1_vvd], 1, 4) AND POL.SKD_VOY_NO = SUBSTR(@[n1_vvd], 5, 4) AND POL.SKD_DIR_CD = SUBSTR(@[n1_vvd], 9, 1) AND POL.VPS_PORT_CD = @[n1_pol]
            	       AND POD.VSL_CD = SUBSTR(@[n1_vvd], 1, 4) AND POD.SKD_VOY_NO = SUBSTR(@[n1_vvd], 5, 4) AND POD.SKD_DIR_CD = SUBSTR(@[n1_vvd], 9, 1) AND POD.VPS_PORT_CD = @[n1_pod]
            	    UNION ALL 
            	    SELECT MAX(POD.VPS_ETA_DT) - MIN(POL.VPS_ETD_DT) TZ_TM, 2 SEQ
            	      FROM VSK_VSL_PORT_SKD POL, VSK_VSL_PORT_SKD POD
            	     WHERE POL.VSL_CD = SUBSTR(@[n2_vvd], 1, 4) AND POL.SKD_VOY_NO = SUBSTR(@[n2_vvd], 5, 4) AND POL.SKD_DIR_CD = SUBSTR(@[n2_vvd], 9, 1) AND POL.VPS_PORT_CD = @[n2_pol]
            	       AND POD.VSL_CD = SUBSTR(@[n2_vvd], 1, 4) AND POD.SKD_VOY_NO = SUBSTR(@[n2_vvd], 5, 4) AND POD.SKD_DIR_CD = SUBSTR(@[n2_vvd], 9, 1) AND POD.VPS_PORT_CD = @[n2_pod]
            	    UNION ALL
            	    SELECT MAX(POD.VPS_ETA_DT) - MIN(POL.VPS_ETD_DT) TZ_TM, 3 SEQ
            	      FROM VSK_VSL_PORT_SKD POL, VSK_VSL_PORT_SKD POD
            	     WHERE POL.VSL_CD = SUBSTR(@[n3_vvd], 1, 4) AND POL.SKD_VOY_NO = SUBSTR(@[n3_vvd], 5, 4) AND POL.SKD_DIR_CD = SUBSTR(@[n3_vvd], 9, 1) AND POL.VPS_PORT_CD = @[n3_pol]
            	       AND POD.VSL_CD = SUBSTR(@[n3_vvd], 1, 4) AND POD.SKD_VOY_NO = SUBSTR(@[n3_vvd], 5, 4) AND POD.SKD_DIR_CD = SUBSTR(@[n3_vvd], 9, 1) AND POD.VPS_PORT_CD = @[n3_pod]
            	    UNION ALL
            	    SELECT MAX(POD.VPS_ETA_DT) - MIN(POL.VPS_ETD_DT) TZ_TM, 4 SEQ
            	      FROM VSK_VSL_PORT_SKD POL, VSK_VSL_PORT_SKD POD
            	     WHERE POL.VSL_CD = SUBSTR(@[n4_vvd], 1, 4) AND POL.SKD_VOY_NO = SUBSTR(@[n4_vvd], 5, 4) AND POL.SKD_DIR_CD = SUBSTR(@[n4_vvd], 9, 1) AND POL.VPS_PORT_CD = @[n4_pol]
            	       AND POD.VSL_CD = SUBSTR(@[n4_vvd], 1, 4) AND POD.SKD_VOY_NO = SUBSTR(@[n4_vvd], 5, 4) AND POD.SKD_DIR_CD = SUBSTR(@[n4_vvd], 9, 1) AND POD.VPS_PORT_CD = @[n4_pod])
           WHERE TZ_TM IS NOT NULL
            ORDER BY TZ_TM DESC)
        WHERE ROWNUM = 1) MAX_TZ_SEQ
	
FROM (SELECT (SELECT VSL_SLAN_CD FROM VSK_VSL_SKD WHERE VSL_CD = SUBSTR(@[n1_vvd], 1, 4) AND SKD_VOY_NO = SUBSTR(@[n1_vvd], 5, 4) AND SKD_DIR_CD = SUBSTR(@[n1_vvd], 9, 1)) N1ST_SLAN_CD
           , (SELECT VSL_SLAN_CD FROM VSK_VSL_SKD WHERE VSL_CD = SUBSTR(@[n2_vvd], 1, 4) AND SKD_VOY_NO = SUBSTR(@[n2_vvd], 5, 4) AND SKD_DIR_CD = SUBSTR(@[n2_vvd], 9, 1)) N2ND_SLAN_CD
           , (SELECT VSL_SLAN_CD FROM VSK_VSL_SKD WHERE VSL_CD = SUBSTR(@[n3_vvd], 1, 4) AND SKD_VOY_NO = SUBSTR(@[n3_vvd], 5, 4) AND SKD_DIR_CD = SUBSTR(@[n3_vvd], 9, 1)) N3RD_SLAN_CD
           , (SELECT VSL_SLAN_CD FROM VSK_VSL_SKD WHERE VSL_CD = SUBSTR(@[n4_vvd], 1, 4) AND SKD_VOY_NO = SUBSTR(@[n4_vvd], 5, 4) AND SKD_DIR_CD = SUBSTR(@[n4_vvd], 9, 1)) N4TH_SLAN_CD
           , DECODE(NVL(@[n1_vvd], 'X'), 'X', NULL, MAS_SLANE_RLANE_CONV_FNC(@[n1_vvd]
					, (SELECT VSL_SLAN_CD FROM VSK_VSL_SKD WHERE VSL_CD = SUBSTR(@[n1_vvd], 1, 4) AND SKD_VOY_NO = SUBSTR(@[n1_vvd], 5, 4) AND SKD_DIR_CD = SUBSTR(@[n1_vvd], 9, 1))
					, SUBSTR(@[n1_pol], 1, 5)
					, SUBSTR(@[n1_pod], 1, 5))) N1ST_R_LANE
           , DECODE(NVL(@[n2_vvd], 'X'), 'X', NULL, MAS_SLANE_RLANE_CONV_FNC(@[n2_vvd]
					, (SELECT VSL_SLAN_CD FROM VSK_VSL_SKD WHERE VSL_CD = SUBSTR(@[n2_vvd], 1, 4) AND SKD_VOY_NO = SUBSTR(@[n2_vvd], 5, 4) AND SKD_DIR_CD = SUBSTR(@[n2_vvd], 9, 1))
					, SUBSTR(@[n2_pol], 1, 5)
					, SUBSTR(@[n2_pod], 1, 5))) N2ND_R_LANE
           , DECODE(NVL(@[n3_vvd], 'X'), 'X', NULL, MAS_SLANE_RLANE_CONV_FNC(@[n3_vvd]
					, (SELECT VSL_SLAN_CD FROM VSK_VSL_SKD WHERE VSL_CD = SUBSTR(@[n3_vvd], 1, 4) AND SKD_VOY_NO = SUBSTR(@[n3_vvd], 5, 4) AND SKD_DIR_CD = SUBSTR(@[n3_vvd], 9, 1))
					, SUBSTR(@[n3_pol], 1, 5)
					, SUBSTR(@[n3_pod], 1, 5))) N3RD_R_LANE
           , DECODE(NVL(@[n4_vvd], 'X'), 'X', NULL, MAS_SLANE_RLANE_CONV_FNC(@[n4_vvd]
					, (SELECT VSL_SLAN_CD FROM VSK_VSL_SKD WHERE VSL_CD = SUBSTR(@[n4_vvd], 1, 4) AND SKD_VOY_NO = SUBSTR(@[n4_vvd], 5, 4) AND SKD_DIR_CD = SUBSTR(@[n4_vvd], 9, 1))
					, SUBSTR(@[n4_pol], 1, 5)
					, SUBSTR(@[n4_pod], 1, 5))) N4TH_R_LANE
	       , (SELECT CONTI_CD FROM MDM_LOCATION WHERE LOC_CD = @[n1_pol]) N1ST_ORG_CONTI_CD
	       , (SELECT CONTI_CD FROM MDM_LOCATION WHERE LOC_CD = @[n2_pol]) N2ND_ORG_CONTI_CD
	       , (SELECT CONTI_CD FROM MDM_LOCATION WHERE LOC_CD = @[n3_pol]) N3RD_ORG_CONTI_CD
	       , (SELECT CONTI_CD FROM MDM_LOCATION WHERE LOC_CD = @[n4_pol]) N4TH_ORG_CONTI_CD
           , (SELECT CONTI_CD FROM MDM_LOCATION WHERE LOC_CD = @[n1_pod]) N1ST_DEST_CONTI_CD
           , (SELECT CONTI_CD FROM MDM_LOCATION WHERE LOC_CD = @[n2_pod]) N2ND_DEST_CONTI_CD
           , (SELECT CONTI_CD FROM MDM_LOCATION WHERE LOC_CD = @[n3_pod]) N3RD_DEST_CONTI_CD
           , (SELECT CONTI_CD FROM MDM_LOCATION WHERE LOC_CD = @[n4_pod]) N4TH_DEST_CONTI_CD
        FROM DUAL)
)    

SELECT CASE WHEN N1ST_R_LANE = 'NOFDR' OR N2ND_R_LANE = 'NOFDR' OR N3RD_R_LANE = 'NOFDR' OR N4TH_R_LANE = 'NOFDR' THEN MAX_TZ_SEQ
            WHEN N1ST_AR_RNK = 0       OR N2ND_AR_RNK = 0       OR N3RD_AR_RNK = 0       OR N4TH_AR_RNK = 0       THEN MAX_TZ_SEQ
            WHEN   (N1ST_SLAN_CD is not null and N1ST_R_LANE is not null and N1ST_R_LANE <> 'RBCCO' and N1ST_AR_RNK = 9999)
                OR (N2ND_SLAN_CD is not null and N2ND_R_LANE is not null and N2ND_R_LANE <> 'RBCCO' and N2ND_AR_RNK = 9999)
                OR (N3RD_SLAN_CD is not null and N3RD_R_LANE is not null and N3RD_R_LANE <> 'RBCCO' and N3RD_AR_RNK = 9999)
                or (N4TH_SLAN_CD is not null and N4TH_R_LANE is not null and N4TH_R_LANE <> 'RBCCO' and N4TH_AR_RNK = 9999) THEN MAX_TZ_SEQ
            WHEN EXISTS (SELECT '1' -- 아래 조건 값 있으면 MAS_RANK_INFO_COMP_FNC 사용
                     FROM BKG_HRD_CDG_CTNT
                    WHERE HRD_CDG_ID = 'BKG_VALIDATION'
                      AND ATTR_CTNT1 = 'MAS_RANK_INFO_COMP_FNC'
                      AND ATTR_CTNT2 = 'ON') 
                 THEN MAS_RANK_INFO_COMP_FNC( --NEW				        
                      N1ST_R_LANE
                    , N2ND_R_LANE
                    , N3RD_R_LANE
                    , N4TH_R_LANE
                    , DECODE(N1ST_ORG_CONTI_CD, DECODE(N1ST_DEST_CONTI_CD,'F', DECODE(N1ST_R_LANE, 'WAFIE', 'E', 'RESIA', 'A', N1ST_DEST_CONTI_CD), N1ST_DEST_CONTI_CD), 'I'||N1ST_ORG_CONTI_CD, 'OO')
                    , DECODE(N2ND_ORG_CONTI_CD, DECODE(N2ND_DEST_CONTI_CD,'F', DECODE(N2ND_R_LANE, 'WAFIE', 'E', 'RESIA', 'A', N2ND_DEST_CONTI_CD), N2ND_DEST_CONTI_CD), 'I'||N2ND_ORG_CONTI_CD, 'OO')
                    , DECODE(N3RD_ORG_CONTI_CD, DECODE(N3RD_DEST_CONTI_CD,'F', DECODE(N3RD_R_LANE, 'WAFIE', 'E', 'RESIA', 'A', N3RD_DEST_CONTI_CD), N3RD_DEST_CONTI_CD), 'I'||N3RD_ORG_CONTI_CD, 'OO')
                    , DECODE(N4TH_ORG_CONTI_CD, DECODE(N4TH_DEST_CONTI_CD,'F', DECODE(N4TH_R_LANE, 'WAFIE', 'E', 'RESIA', 'A', N4TH_DEST_CONTI_CD), N4TH_DEST_CONTI_CD), 'I'||N4TH_ORG_CONTI_CD, 'OO') 
                    , 'V' -- BKG: B /PCLT : P / VVD : V 
                    , '' --BKG_NO
                    , '' --PCTL_NO
                    , @[n1_vvd]
                    , @[n2_vvd]
                    , @[n3_vvd]
                    , @[n4_vvd] 
                    , @[n1_pol]||@[n1_pol_yd]
                    , @[n2_pol]||@[n2_pol_yd]
                    , @[n3_pol]||@[n3_pol_yd]
                    , @[n4_pol]||@[n4_pol_yd]
                    , @[n1_pod]||@[n1_pod_yd]
                    , @[n2_pod]||@[n2_pod_yd]
                    , @[n3_pod]||@[n3_pod_yd]
                    , @[n4_pod]||@[n4_pod_yd]
                    )
            ELSE MAS_RANK_INFO_FNC(	--OLD			        
                      N1ST_R_LANE
                    , N2ND_R_LANE
                    , N3RD_R_LANE
                    , N4TH_R_LANE
                	, DECODE(N1ST_ORG_CONTI_CD, DECODE(N1ST_DEST_CONTI_CD,'F', DECODE(N1ST_R_LANE, 'WAFIE', 'E', 'RESIA', 'A', N1ST_DEST_CONTI_CD), N1ST_DEST_CONTI_CD), 'I'||N1ST_ORG_CONTI_CD, 'OO')
                	, DECODE(N2ND_ORG_CONTI_CD, DECODE(N2ND_DEST_CONTI_CD,'F', DECODE(N2ND_R_LANE, 'WAFIE', 'E', 'RESIA', 'A', N2ND_DEST_CONTI_CD), N2ND_DEST_CONTI_CD), 'I'||N2ND_ORG_CONTI_CD, 'OO')
                	, DECODE(N3RD_ORG_CONTI_CD, DECODE(N3RD_DEST_CONTI_CD,'F', DECODE(N3RD_R_LANE, 'WAFIE', 'E', 'RESIA', 'A', N3RD_DEST_CONTI_CD), N3RD_DEST_CONTI_CD), 'I'||N3RD_ORG_CONTI_CD, 'OO')
                	, DECODE(N4TH_ORG_CONTI_CD, DECODE(N4TH_DEST_CONTI_CD,'F', DECODE(N4TH_R_LANE, 'WAFIE', 'E', 'RESIA', 'A', N4TH_DEST_CONTI_CD), N4TH_DEST_CONTI_CD), 'I'||N4TH_ORG_CONTI_CD, 'OO') 
                    , @[n1_vvd]
                    , @[n2_vvd]
                    , @[n3_vvd]
                    , @[n4_vvd]                    
                    ) end trunk_seq
  FROM VVD			]]></sql>
			<params>
				<param name="n1_pol" type="12" value="GBFXT" out="N"/>
				<param name="n1_pod" type="12" value="NLRTM" out="N"/>
				<param name="n1_vvd" type="12" value="HJNA0063E" out="N"/>
				<param name="n2_pol" type="12" value="NLRTM" out="N"/>
				<param name="n2_pod" type="12" value="KRPUS" out="N"/>
				<param name="n2_vvd" type="12" value="HJBH0012E" out="N"/>
				<param name="n3_pol" type="12" value="KRPUS" out="N"/>
				<param name="n3_pod" type="12" value="JPHKT" out="N"/>
				<param name="n3_vvd" type="12" value="KJNC8090E" out="N"/>
				<param name="n4_pol" type="12" value="" out="N"/>
				<param name="n4_pod" type="12" value="" out="N"/>
				<param name="n4_vvd" type="12" value="" out="N"/>
				<param name="n1_pol_yd" type="12" value="" out="N"/>
				<param name="n2_pol_yd" type="12" value="" out="N"/>
				<param name="n3_pol_yd" type="12" value="" out="N"/>
				<param name="n4_pol_yd" type="12" value="" out="N"/>
				<param name="n1_pod_yd" type="12" value="" out="N"/>
				<param name="n2_pod_yd" type="12" value="" out="N"/>
				<param name="n3_pod_yd" type="12" value="" out="N"/>
				<param name="n4_pod_yd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
