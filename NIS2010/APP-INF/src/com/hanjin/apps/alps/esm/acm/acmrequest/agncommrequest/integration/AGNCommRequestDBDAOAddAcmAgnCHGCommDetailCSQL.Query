<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="AGNCommRequestDBDAOAddAcmAgnCHGCommDetailCSQL">
			<desc><![CDATA[Add Acm Agn CHG Comm Detail]]></desc>
			<sql><![CDATA[
INSERT INTO ACM_AGN_COMM_DTL_CHG
(
    BKG_NO
  , AGN_CD
  , IO_BND_CD
  , AC_TP_CD
  , AC_SEQ
  , AC_CHG_SEQ
  , CHG_CD
  , CURR_CD
  , RAT_UT_CD
  , CHG_UT_AMT
  , CHG_AMT
  , CHG_COMM_RT
  , CHG_COMM_OTR_AMT
  , CHG_COMM_CURR_CD
  , COMM_AMT
  , PAY_COMM_AMT
  , CRE_USR_ID
  , CRE_DT
  , UPD_USR_ID
  , UPD_DT
)
#if(${chg_comm_div_cd} == 'M')
    #if(${chg_comm_rt} != '')
        SELECT @[bkg_no]
             , @[agn_cd]
             , @[io_bnd_cd]
             , @[ac_tp_cd]
             , @[max_ac_seq]
             , @[comm_chg_seq] + ROWNUM AS AC_CHG_SEQ
             , P.CHG_CD
             , P.CURR_CD
             , P.RAT_UT_CD
             , P.CHG_UT_AMT
             , P.CHG_AMT
             , @[chg_comm_rt]
             , @[chg_comm_otr_amt]
             , @[chg_comm_curr_cd]
             , NVL(ROUND(DECODE(P.CURR_CD, @[ofc_curr_cd], DECODE(@[pay_xch_rt], 0, 0, (P.CHG_AMT * @[chg_comm_rt] / 100) / @[pay_xch_rt]) 
                                                         , (P.CHG_AMT / DECODE(P.CURR_CD, 'USD', 1, NVL(Q.USD_LOCL_XCH_RT, 0))) * @[chg_comm_rt] / 100), 2), 0) AS COMM_AMT
             , NVL(ROUND(DECODE(P.CURR_CD, @[ofc_curr_cd], (P.CHG_AMT * @[chg_comm_rt] / 100) 
                                                         , ((P.CHG_AMT / DECODE(P.CURR_CD, 'USD', 1, NVL(Q.USD_LOCL_XCH_RT, 0))) * @[chg_comm_rt] / 100) * @[pay_xch_rt]), 2), 0) AS PAY_COMM_AMT
             , @[usr_id]
             , SYSDATE
             , @[usr_id]
             , SYSDATE
        FROM BKG_CHG_RT P, 
             GL_MON_XCH_RT Q
        WHERE P.BKG_NO = @[bkg_no]
        AND P.CHG_CD = @[comm_chg_cd] 
        AND P.FRT_INCL_XCLD_DIV_CD = 'N' 
        AND P.FRT_TERM_CD = DECODE(@[chg_comm_pay_term_cd], 'T', P.FRT_TERM_CD, '', P.FRT_TERM_CD, @[chg_comm_pay_term_cd])
        AND P.CURR_CD = Q.CURR_CD
        AND Q.ACCT_XCH_RT_YRMON = DECODE(SIGN(TO_NUMBER(TO_CHAR(SYSDATE, 'YYYYMM')) - TO_NUMBER(SUBSTR (@[sa_dt], 1, 6))), 1, SUBSTR (@[sa_dt], 1, 6),TO_CHAR(SYSDATE, 'YYYYMM')) 
        AND Q.ACCT_XCH_RT_LVL = '1'
    #elseif(${chg_comm_otr_amt} != '')
        SELECT @[bkg_no]
             , @[agn_cd]
             , @[io_bnd_cd]
             , @[ac_tp_cd]
             , @[max_ac_seq]
             , @[comm_chg_seq] + ROWNUM AS AC_CHG_SEQ
             , CHG_CD
             , CURR_CD
             , RAT_UT_CD
             , CHG_UT_AMT
             , CHG_AMT
             , @[chg_comm_rt]
             , @[chg_comm_otr_amt]
             , @[chg_comm_curr_cd]
             , NVL(ROUND(DECODE(@[chg_comm_curr_cd], @[ofc_curr_cd], DECODE(@[pay_xch_rt] ,0, 0, (@[chg_comm_otr_amt] / @[pay_xch_rt]))
                                                                   , (@[chg_comm_otr_amt] / DECODE(@[chg_comm_curr_cd], 'USD', 1, @[usd_xch_rt]))), 2), 0) AS COMM_AMT
             , NVL(ROUND(DECODE(@[chg_comm_curr_cd], @[ofc_curr_cd], @[chg_comm_otr_amt]
                                                                   , (@[chg_comm_otr_amt] / DECODE(@[chg_comm_curr_cd], 'USD', 1, @[usd_xch_rt])) * @[pay_xch_rt]), 2), 0) AS PAY_COMM_AMT  
             , @[usr_id]
             , SYSDATE
             , @[usr_id]
             , SYSDATE
        FROM BKG_CHG_RT
        WHERE BKG_NO = @[bkg_no] 
        AND CHG_CD = @[comm_chg_cd] 
        AND FRT_INCL_XCLD_DIV_CD = 'N' 
        AND FRT_TERM_CD = DECODE(@[chg_comm_pay_term_cd], 'T', FRT_TERM_CD, '', FRT_TERM_CD, @[chg_comm_pay_term_cd])
    #end
#elseif(${chg_comm_div_cd} == 'T')
    #if(${chg_comm_rt} != '')
        SELECT @[bkg_no]
             , @[agn_cd]
             , @[io_bnd_cd]
             , @[ac_tp_cd]
             , @[max_ac_seq]
             , @[comm_chg_seq] + ROWNUM AS AC_CHG_SEQ
             , CHG_CD
             , CURR_CD
             , RAT_UT_CD
             , CHG_UT_AMT
             , CHG_AMT
             , @[chg_comm_rt]
             , @[chg_comm_otr_amt]
             , @[chg_comm_curr_cd]
             , NVL(ROUND(DECODE(TRF_CURR_CD, @[ofc_curr_cd], DECODE(@[pay_xch_rt] ,0, 0, (DECODE(CHG_AMT, 0, TRF_CHG_AMT, CHG_AMT) * @[chg_comm_rt] / 100) / @[pay_xch_rt]) 
                                                         , (DECODE(CHG_AMT, 0, TRF_CHG_AMT, CHG_AMT) / DECODE(TRF_CURR_CD, 'USD', 1, NVL(USD_LOCL_XCH_RT, 0))) * @[chg_comm_rt] / 100), 2), 0) AS COMM_AMT
             , NVL(ROUND(DECODE(TRF_CURR_CD, @[ofc_curr_cd], (DECODE(CHG_AMT, 0, TRF_CHG_AMT, CHG_AMT) * @[chg_comm_rt] / 100)
                                                         , ((DECODE(CHG_AMT, 0, TRF_CHG_AMT, CHG_AMT) / DECODE(TRF_CURR_CD, 'USD', 1, NVL(USD_LOCL_XCH_RT, 0))) * @[chg_comm_rt] / 100) * @[pay_xch_rt]), 2), 0) AS PAY_COMM_AMT   
             , @[usr_id]
             , SYSDATE
             , @[usr_id]
             , SYSDATE
        FROM (
                SELECT P.CHG_CD
                     , P.CURR_CD AS TRF_CURR_CD
                     , P.CHG_AMT AS TRF_CHG_AMT
                     , Q.USD_LOCL_XCH_RT
                     , (SELECT CURR_CD 
                        FROM BKG_CHG_RT 
                        WHERE BKG_NO = P.BKG_NO
                        AND CHG_CD = P.CHG_CD
                        AND CURR_CD = P.CURR_CD
                        AND RAT_UT_CD = P.RAT_UT_CD
                        AND FRT_INCL_XCLD_DIV_CD = 'N' 
                        AND FRT_TERM_CD = P.FRT_TERM_CD
                        GROUP BY CURR_CD) AS CURR_CD
                     , (SELECT RAT_UT_CD 
                        FROM BKG_CHG_RT 
                        WHERE BKG_NO = P.BKG_NO
                        AND CHG_CD = P.CHG_CD
                        AND CURR_CD = P.CURR_CD
                        AND RAT_UT_CD = P.RAT_UT_CD
                        AND FRT_INCL_XCLD_DIV_CD = 'N' 
                        AND FRT_TERM_CD = P.FRT_TERM_CD
                        GROUP BY RAT_UT_CD) AS RAT_UT_CD
                     , (SELECT NVL(SUM(CHG_UT_AMT), 0) 
                        FROM BKG_CHG_RT 
                        WHERE BKG_NO = P.BKG_NO
                        AND CHG_CD = P.CHG_CD
                        AND CURR_CD = P.CURR_CD
                        AND RAT_UT_CD = P.RAT_UT_CD
                        AND FRT_INCL_XCLD_DIV_CD = 'N' 
                        AND FRT_TERM_CD = P.FRT_TERM_CD) AS CHG_UT_AMT
                     , (SELECT NVL(SUM(CHG_AMT), 0) 
                        FROM BKG_CHG_RT 
                        WHERE BKG_NO = P.BKG_NO
                        AND CHG_CD = P.CHG_CD
                        AND CURR_CD = P.CURR_CD
                        AND RAT_UT_CD = P.RAT_UT_CD
                        AND FRT_INCL_XCLD_DIV_CD = 'N' 
                        AND FRT_TERM_CD = P.FRT_TERM_CD) AS CHG_AMT
                FROM BKG_TRF_SCG_RT P, 
                     GL_MON_XCH_RT Q
                WHERE P.BKG_NO = @[bkg_no] 
                AND P.CHG_CD = @[comm_chg_cd] 
                AND P.FRT_INCL_XCLD_DIV_CD = 'N' 
                AND P.FRT_TERM_CD = DECODE(@[chg_comm_pay_term_cd], 'T', P.FRT_TERM_CD, '', P.FRT_TERM_CD, @[chg_comm_pay_term_cd])
                AND P.CURR_CD = Q.CURR_CD
                AND Q.ACCT_XCH_RT_YRMON = DECODE(SIGN(TO_NUMBER(TO_CHAR(SYSDATE, 'YYYYMM')) - TO_NUMBER(SUBSTR (@[sa_dt], 1, 6))), 1, SUBSTR (@[sa_dt], 1, 6),TO_CHAR(SYSDATE, 'YYYYMM')) 
                AND Q.ACCT_XCH_RT_LVL = '1'
        )
    #elseif(${chg_comm_otr_amt} != '')
        SELECT @[bkg_no]
             , @[agn_cd]
             , @[io_bnd_cd]
             , @[ac_tp_cd]
             , @[max_ac_seq]
             , @[comm_chg_seq] + ROWNUM AS AC_CHG_SEQ
             , @[comm_chg_cd] 
             , (SELECT CURR_CD 
                FROM BKG_CHG_RT 
                WHERE BKG_NO = P.BKG_NO
                AND CHG_CD = P.CHG_CD
                AND CURR_CD = P.CURR_CD
                AND RAT_UT_CD = P.RAT_UT_CD
                AND FRT_INCL_XCLD_DIV_CD = 'N' 
                AND FRT_TERM_CD = P.FRT_TERM_CD
                GROUP BY CURR_CD) AS CURR_CD
             , (SELECT RAT_UT_CD 
                FROM BKG_CHG_RT 
                WHERE BKG_NO = P.BKG_NO
                AND CHG_CD = P.CHG_CD
                AND CURR_CD = P.CURR_CD
                AND RAT_UT_CD = P.RAT_UT_CD
                AND FRT_INCL_XCLD_DIV_CD = 'N' 
                AND FRT_TERM_CD = P.FRT_TERM_CD
                GROUP BY RAT_UT_CD) AS RAT_UT_CD
             , (SELECT NVL(SUM(CHG_UT_AMT), 0) 
                FROM BKG_CHG_RT 
                WHERE BKG_NO = P.BKG_NO
                AND CHG_CD = P.CHG_CD
                AND CURR_CD = P.CURR_CD
                AND RAT_UT_CD = P.RAT_UT_CD
                AND FRT_INCL_XCLD_DIV_CD = 'N' 
                AND FRT_TERM_CD = P.FRT_TERM_CD) AS CHG_UT_AMT
             , (SELECT NVL(SUM(CHG_AMT), 0) 
                FROM BKG_CHG_RT 
                WHERE BKG_NO = P.BKG_NO
                AND CHG_CD = P.CHG_CD
                AND CURR_CD = P.CURR_CD
                AND RAT_UT_CD = P.RAT_UT_CD
                AND FRT_INCL_XCLD_DIV_CD = 'N' 
                AND FRT_TERM_CD = P.FRT_TERM_CD) AS CHG_AMT
             , @[chg_comm_rt]
             , @[chg_comm_otr_amt]
             , @[chg_comm_curr_cd]
             , NVL(ROUND(DECODE(@[chg_comm_curr_cd], @[ofc_curr_cd], DECODE(@[pay_xch_rt] ,0, 0, (@[chg_comm_otr_amt] / @[pay_xch_rt]))
                                                                   , (@[chg_comm_otr_amt] / DECODE(@[chg_comm_curr_cd], 'USD', 1, @[usd_xch_rt]))), 2), 0) AS COMM_AMT
             , NVL(ROUND(DECODE(@[chg_comm_curr_cd], @[ofc_curr_cd], @[chg_comm_otr_amt]
                                                                   , (@[chg_comm_otr_amt] / DECODE(@[chg_comm_curr_cd], 'USD', 1, @[usd_xch_rt])) * @[pay_xch_rt]), 2), 0) AS PAY_COMM_AMT      
             , @[usr_id]
             , SYSDATE
             , @[usr_id]
             , SYSDATE
        FROM BKG_TRF_SCG_RT P
        WHERE BKG_NO = @[bkg_no] 
        AND CHG_CD = @[comm_chg_cd] 
        AND FRT_INCL_XCLD_DIV_CD = 'N' 
        AND FRT_TERM_CD = DECODE(@[chg_comm_pay_term_cd], 'T', FRT_TERM_CD, '', FRT_TERM_CD, @[chg_comm_pay_term_cd])
		AND ROWNUM = 1
    #end
#elseif(${chg_comm_div_cd} == 'R')
    #if(${chg_comm_rt} != '')
        SELECT @[bkg_no]
             , @[agn_cd]
             , @[io_bnd_cd]
             , @[ac_tp_cd]
             , @[max_ac_seq]
             , @[comm_chg_seq] + ROWNUM AS AC_CHG_SEQ
             , Q.CHG_CD
             , (SELECT CURR_CD 
                FROM BKG_CHG_RT 
                WHERE BKG_NO = P.BKG_NO
                AND CHG_CD = Q.CHG_CD
                AND CURR_CD = Q.CURR_CD
                AND RAT_UT_CD = Q.PER_TP_CD
                AND FRT_INCL_XCLD_DIV_CD = 'N' 
                AND FRT_TERM_CD = DECODE(P.IO_BND_CD, 'O', 'P', 'C')
                GROUP BY CURR_CD) AS CURR_CD
             , (SELECT RAT_UT_CD 
                FROM BKG_CHG_RT 
                WHERE BKG_NO = P.BKG_NO
                AND CHG_CD = Q.CHG_CD
                AND CURR_CD = Q.CURR_CD
                AND RAT_UT_CD = Q.PER_TP_CD
                AND FRT_INCL_XCLD_DIV_CD = 'N' 
                AND FRT_TERM_CD = DECODE(P.IO_BND_CD, 'O', 'P', 'C')
                GROUP BY RAT_UT_CD) AS RAT_UT_CD
             , (SELECT NVL(SUM(CHG_UT_AMT), 0) 
                FROM BKG_CHG_RT 
                WHERE BKG_NO = P.BKG_NO
                AND CHG_CD = Q.CHG_CD
                AND CURR_CD = Q.CURR_CD
                AND RAT_UT_CD = Q.PER_TP_CD
                AND FRT_INCL_XCLD_DIV_CD = 'N' 
                AND FRT_TERM_CD = DECODE(P.IO_BND_CD, 'O', 'P', 'C')) AS CHG_UT_AMT
             , (SELECT NVL(SUM(CHG_AMT), 0) 
                FROM BKG_CHG_RT 
                WHERE BKG_NO = P.BKG_NO
                AND CHG_CD = Q.CHG_CD
                AND CURR_CD = Q.CURR_CD
                AND RAT_UT_CD = Q.PER_TP_CD
                AND FRT_INCL_XCLD_DIV_CD = 'N' 
                AND FRT_TERM_CD = DECODE(P.IO_BND_CD, 'O', 'P', 'C')) AS CHG_AMT
             , @[chg_comm_rt]
             , @[chg_comm_otr_amt]
             , @[chg_comm_curr_cd]
             , NVL(ROUND(DECODE(Q.CURR_CD, @[ofc_curr_cd], DECODE(@[pay_xch_rt] ,0, 0, (Q.CHG_AMT * @[chg_comm_rt] / 100) / @[pay_xch_rt]) 
                                                         , (Q.CHG_AMT / DECODE(Q.CURR_CD, 'USD', 1, NVL(R.USD_LOCL_XCH_RT, 0))) * @[chg_comm_rt] / 100), 2), 0) AS COMM_AMT
             , NVL(ROUND(DECODE(Q.CURR_CD, @[ofc_curr_cd], (Q.CHG_AMT * @[chg_comm_rt] / 100)
                                                         , ((Q.CHG_AMT / DECODE(Q.CURR_CD, 'USD', 1, NVL(R.USD_LOCL_XCH_RT, 0))) * @[chg_comm_rt] / 100) * @[pay_xch_rt]), 2), 0) AS PAY_COMM_AMT    
             , @[usr_id]
             , SYSDATE
             , @[usr_id]
             , SYSDATE
        FROM INV_AR_MN P, 
             INV_AR_CHG Q,
             GL_MON_XCH_RT R
        WHERE P.AR_IF_NO = Q.AR_IF_NO 
        AND P.BKG_NO = @[bkg_no] 
        AND Q.CHG_CD = @[comm_chg_cd] 
        AND P.REV_TP_CD = 'M' 
        AND P.IO_BND_CD = DECODE(@[chg_comm_pay_term_cd], 'T', P.IO_BND_CD, '', P.IO_BND_CD, DECODE(@[chg_comm_pay_term_cd], 'P', 'O', 'I'))
        AND Q.CURR_CD = R.CURR_CD
        AND R.ACCT_XCH_RT_YRMON = DECODE(SIGN(TO_NUMBER(TO_CHAR(SYSDATE, 'YYYYMM')) - TO_NUMBER(SUBSTR (@[sa_dt], 1, 6))), 1, SUBSTR (@[sa_dt], 1, 6),TO_CHAR(SYSDATE, 'YYYYMM')) 
        AND R.ACCT_XCH_RT_LVL = '1'
    #elseif(${chg_comm_otr_amt} != '')
        SELECT @[bkg_no]
             , @[agn_cd]
             , @[io_bnd_cd]
             , @[ac_tp_cd]
             , @[max_ac_seq]
             , @[comm_chg_seq] + ROWNUM AS AC_CHG_SEQ
             , Q.CHG_CD
             , Q.CURR_CD
             , Q.PER_TP_CD
             , Q.TRF_RT_AMT
             , Q.CHG_AMT
             , @[chg_comm_rt]
             , @[chg_comm_otr_amt]
             , @[chg_comm_curr_cd]
             , NVL(ROUND(DECODE(@[chg_comm_curr_cd], @[ofc_curr_cd], DECODE(@[pay_xch_rt] ,0, 0, (@[chg_comm_otr_amt] / @[pay_xch_rt]))
                                                                   , (@[chg_comm_otr_amt] / DECODE(@[chg_comm_curr_cd], 'USD', 1, @[usd_xch_rt]))), 2), 0) AS COMM_AMT
             , NVL(ROUND(DECODE(@[chg_comm_curr_cd], @[ofc_curr_cd], @[chg_comm_otr_amt]
                                                                   , (@[chg_comm_otr_amt] / DECODE(@[chg_comm_curr_cd], 'USD', 1, @[usd_xch_rt])) * @[pay_xch_rt]), 2), 0) AS PAY_COMM_AMT   
             , @[usr_id]
             , SYSDATE
             , @[usr_id]
             , SYSDATE
        FROM INV_AR_MN P, 
             INV_AR_CHG Q
        WHERE P.AR_IF_NO = Q.AR_IF_NO 
        AND P.BKG_NO = @[bkg_no] 
        AND Q.CHG_CD = @[comm_chg_cd] 
        AND P.REV_TP_CD = 'M' 
        AND P.IO_BND_CD = DECODE(@[chg_comm_pay_term_cd], 'T', P.IO_BND_CD, '', P.IO_BND_CD, DECODE(@[chg_comm_pay_term_cd], 'P', 'O', 'I'))
    #end
#end			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="agn_cd" type="12" value="" out="N"/>
				<param name="io_bnd_cd" type="12" value="" out="N"/>
				<param name="ac_tp_cd" type="12" value="" out="N"/>
				<param name="max_ac_seq" type="12" value="" out="N"/>
				<param name="comm_chg_seq" type="12" value="" out="N"/>
				<param name="chg_comm_rt" type="12" value="" out="N"/>
				<param name="chg_comm_otr_amt" type="12" value="" out="N"/>
				<param name="chg_comm_curr_cd" type="12" value="" out="N"/>
				<param name="ofc_curr_cd" type="12" value="" out="N"/>
				<param name="pay_xch_rt" type="12" value="" out="N"/>
				<param name="usr_id" type="12" value="" out="N"/>
				<param name="comm_chg_cd" type="12" value="" out="N"/>
				<param name="chg_comm_pay_term_cd" type="12" value="" out="N"/>
				<param name="sa_dt" type="12" value="" out="N"/>
				<param name="usd_xch_rt" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
