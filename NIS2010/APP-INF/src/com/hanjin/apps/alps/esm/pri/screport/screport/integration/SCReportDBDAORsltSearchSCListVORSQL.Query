<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="SCReportDBDAORsltSearchSCListVORSQL">
			<desc><![CDATA[S/C List Inquiry]]></desc>
			<sql><![CDATA[
SELECT  M.SC_NO                 ,
        M.PROP_NO               ,
        M.AMDT_SEQ              ,
        M.SVC_SCP_CD            ,
        M.CTRT_PTY_NM           ,
        M.REAL_CUST_NM          ,
        #if (${act_cust_nm} != '' or ${fx_rt_flg} == 'N')
        M.BLET_NO           	,
		M.GEN_SPCL_RT_TP_CD		,
		M.ACT_CUST_NM     ,
        #end
        M.PRC_CTRT_CUST_TP_CD   ,
        M.FNL_MQC_QTY           ,
        M.TTL_MQC_QTY           ,
        M.PROP_APRO_OFC_CD      ,
        M.PROP_OFC_CD  ,
        M.CTRT_OFC ,
        M.AREA_GRP ,
        M.CTRT_CUST_SREP_CD     , 
        M.CTRT_EFF_DT ,
        M.CTRT_EXP_DT ,
        M.FILE_DT     ,
        M.LGCY_IF_FLG ,
        M.CONV_CFM_FLG ,
        M.RF_FLG          , -- param
        M.GAMT_FLG        , -- param
        M.EFF_DT          , -- param
        M.EXP_DT          ,-- param
        M.CUST_NM         ,-- param
        NVL((SELECT 1
               FROM PRI_SP_SCP_NOTE_CTNT  A,PRI_SC_NOTE_CONV B
              WHERE A.PROP_NO          = M.PROP_NO
                AND A.AMDT_SEQ         = M.AMDT_SEQ
                AND A.SRC_INFO_CD      <> 'AD'
                AND A.NOTE_CONV_MAPG_ID = B.NOTE_CONV_MAPG_ID
                AND B.NOTE_CONV_CHG_CD = 'BUC'
                AND B.RT_APPL_TP_CD IN ('F','I') -- FIX AMOUNT,INCLUDE 
                AND ROWNUM = 1),0) BUC_IND,
        NVL((SELECT 1
               FROM PRI_SP_SCP_NOTE_CTNT  A,PRI_SC_NOTE_CONV B
              WHERE A.PROP_NO          = M.PROP_NO
                AND A.AMDT_SEQ         = M.AMDT_SEQ
                AND A.SRC_INFO_CD      <> 'AD'
                AND A.NOTE_CONV_MAPG_ID = B.NOTE_CONV_MAPG_ID
                AND B.NOTE_CONV_CHG_CD = 'PSC'
                AND B.RT_APPL_TP_CD ='N' -- NOT APPLICABLE
                AND ROWNUM = 1),0) PSC_INCL_IND,
        NVL((SELECT 1
               FROM PRI_SP_SCP_NOTE_CTNT  A,PRI_SC_NOTE_CONV B
              WHERE A.PROP_NO          = M.PROP_NO
                AND A.AMDT_SEQ         = M.AMDT_SEQ
                AND A.SRC_INFO_CD      <> 'AD'
                AND A.NOTE_CONV_MAPG_ID = B.NOTE_CONV_MAPG_ID
                AND B.NOTE_CONV_CHG_CD = 'PSC'
                AND B.RT_APPL_TP_CD <> 'N' -- NOT APPLICABLE
                AND ROWNUM = 1),0) PSC_EXPT_IND,
        M.CHSS_EXPT_FLG, 
        M.GRI_APPL_FLG, 
		#if (${fx_rt_flg} == 'N')
		FX_RT_FLG,
		#end
        M.NEW_SCG_FLG
		
       FROM( 
                SELECT  L.SC_NO               ,
                        L.PROP_NO             ,
                        L.AMDT_SEQ            ,
                        L.SVC_SCP_CD          ,
                        L.CTRT_PTY_NM         ,
                        #if (${act_cust_nm} != ''  or ${fx_rt_flg} == 'N')
                        SH.BLET_DP_SEQ    AS BLET_NO    , 
						SH.GEN_SPCL_RT_TP_CD  ,
						CUST_LGL_ENG_NM		 AS ACT_CUST_NM,
                        #end
                        REAL_CUST_NM          ,
                        PRC_CTRT_CUST_TP_CD   ,
                        FNL_MQC_QTY           ,
                        TTL_MQC_QTY           ,
                        PROP_APRO_OFC_CD      ,
                        PROP_OFC_CD           ,
                        CTRT_OFC              ,
                        AREA_GRP              ,
                        CTRT_CUST_SREP_CD     , 
                        CTRT_EFF_DT           ,
                        CTRT_EXP_DT           ,
                        FILE_DT               ,
                        LGCY_IF_FLG           ,
                        CONV_CFM_FLG          ,
                        RF_FLG                , -- param
                        GAMT_FLG              , -- param
                        EFF_DT                , -- param
                        EXP_DT                ,-- param
                        CUST_NM               ,-- param
                        CHSS_EXPT_FLG         , 
                        GRI_APPL_FLG          ,
						#if (${fx_rt_flg} == 'N') 
						SH.FX_RT_FLG,
						#end
						NEW_SCG_FLG           

        
FROM (
        SELECT  SC_NO                 ,
                PROP_NO               ,
                AMDT_SEQ              ,
                SVC_SCP_CD            ,
                CTRT_PTY_NM           ,
                REAL_CUST_NM          ,
                PRC_CTRT_CUST_TP_CD   ,
                FNL_MQC_QTY           ,
                TTL_MQC_QTY           ,
                PROP_APRO_OFC_CD      ,
                PROP_OFC_CD           ,
                PRI_SUB_OFC_MATCH ( 1, PROP_OFC_CD ) AS CTRT_OFC ,
                PRI_SUB_OFC_MATCH ( 2, PROP_OFC_CD ) AS AREA_GRP ,
                CTRT_CUST_SREP_CD     , 
                TO_CHAR(CTRT_EFF_DT, 'YYYY-MM-DD')    CTRT_EFF_DT ,
                TO_CHAR(CTRT_EXP_DT, 'YYYY-MM-DD')    CTRT_EXP_DT ,
                TO_CHAR(FILE_DT, 'YYYY-MM-DD')        FILE_DT     ,
                DECODE(LGCY_IF_FLG, 'Y', 'Yes', 'No') LGCY_IF_FLG ,
                DECODE(CONV_CFM_FLG, 'Y', 'Yes', 'No') CONV_CFM_FLG ,
                '' AS RF_FLG          , -- param
                '' AS GAMT_FLG        , -- param
                '' AS EFF_DT          , -- param
                '' AS EXP_DT          ,-- param
                '' AS CUST_NM         ,-- param
                CHSS_EXPT_FLG, 
                GRI_APPL_FLG, 
                NEW_SCG_FLG
        FROM    (
                SELECT  /*+ INDEX ( SS XAK1PRI_SP_SCP_MN ) */
                        SH.SC_NO      ,
                        SH.PROP_NO    ,
                        SM.AMDT_SEQ   ,
                        SS.SVC_SCP_CD ,
                        CP.CTRT_PTY_NM  CTRT_PTY_NM ,
                        (SELECT A.CUST_LGL_ENG_NM FROM MDM_CUSTOMER A WHERE A.CUST_CNT_CD = SM.REAL_CUST_CNT_CD AND A.CUST_SEQ = SM.REAL_CUST_SEQ) AS REAL_CUST_NM,
                        NVL2(SM.REAL_CUST_CNT_CD, SM.REAL_CUST_TP_CD, CT.PRC_CTRT_CUST_TP_CD) PRC_CTRT_CUST_TP_CD ,
                        DECODE(SC.CNTR_LOD_UT_CD, 'T', SC.FNL_MQC_QTY / 2, SC.FNL_MQC_QTY)    TTL_MQC_QTY         ,
                        DECODE(SQ.CNTR_LOD_UT_CD, 'T', SQ.FNL_MQC_QTY / 2, SQ.FNL_MQC_QTY)    FNL_MQC_QTY         ,
                        SM.PROP_APRO_OFC_CD     ,
                        SM.PROP_OFC_CD          ,
                        SM.RESPB_SREP_CD        CTRT_CUST_SREP_CD     ,
                        SD.CTRT_EFF_DT          ,
                        SD.CTRT_EXP_DT          ,
                        SM.FILE_DT              ,
                        SM.LGCY_IF_FLG          ,
                        SM.CONV_CFM_FLG          ,
                        #if (${act_cust_nm} != '')
                        NVL(( SELECT 1 FROM PRI_SP_SCP_RT_ACT_CUST SP, MDM_CUSTOMER MC
                          WHERE SP.PROP_NO = SS.PROP_NO
                                AND     SP.AMDT_SEQ = SS.AMDT_SEQ
                                AND     SP.SVC_SCP_CD = SS.SVC_SCP_CD
                                AND     SP.GEN_SPCL_RT_TP_CD = 'S'
                                AND     SP.CUST_CNT_CD = MC.CUST_CNT_CD
                                AND     SP.CUST_SEQ = MC.CUST_SEQ
                                AND     SP.SRC_INFO_CD  <>  'AD'
                                AND     MC.CUST_LGL_ENG_NM LIKE '%' || @[act_cust_nm] || '%'
                                AND     ROWNUM = 1), 0 ) ACT_CUST_IND ,
                        #end
                     SS.CHSS_EXPT_FLG, 
                     SS.GRI_APPL_FLG, 
                     SS.NEW_SCG_FLG,
                        ROW_NUMBER() OVER ( PARTITION BY SH.SC_NO, SS.SVC_SCP_CD ORDER BY SM.AMDT_SEQ DESC ) ROW_NUMBER
                FROM    PRI_SP_HDR          SH  ,
                        PRI_SP_MN           SM  ,
                        PRI_SP_CTRT_PTY     CP  ,
                        PRI_SP_CTRT_CUST_TP CT  ,
                        PRI_SP_SCP_MN       SS  ,
                        PRI_SP_SCP_DUR      SD  ,
                        PRI_SP_SCP_MQC      SQ  ,
                        PRI_SP_MQC          SC
                   #if (${afil_nm} != '')
                       ,PRI_SP_AFIL         SA
                       ,MDM_CUSTOMER        MC
                   #end
                WHERE   SM.PROP_NO            = SH.PROP_NO
                AND     SM.PROP_STS_CD        = 'F'
                AND     CP.PROP_NO            = SM.PROP_NO
                AND     CP.AMDT_SEQ           = SM.AMDT_SEQ
                AND     CP.PRC_CTRT_PTY_TP_CD = 'C'
                AND     CT.PROP_NO            = CP.PROP_NO
                AND     CT.AMDT_SEQ           = CP.AMDT_SEQ
                AND     CT.PRC_CTRT_PTY_TP_CD = CP.PRC_CTRT_PTY_TP_CD
                AND     SS.PROP_NO            = SM.PROP_NO
                AND     SS.AMDT_SEQ           = SM.AMDT_SEQ
                AND     SD.PROP_NO            = SS.PROP_NO
                AND     SD.AMDT_SEQ           = SS.AMDT_SEQ
                AND     SD.SVC_SCP_CD         = SS.SVC_SCP_CD
                AND     SQ.PROP_NO            = SS.PROP_NO
                AND     SQ.AMDT_SEQ           = SS.AMDT_SEQ
                AND     SQ.SVC_SCP_CD         = SS.SVC_SCP_CD
                AND     SC.PROP_NO            = SS.PROP_NO
                AND     SC.AMDT_SEQ           = SS.AMDT_SEQ
                #if (${afil_nm} != '')
                AND     SM.PROP_NO            = SA.PROP_NO
                AND     SM.AMDT_SEQ           = SA.AMDT_SEQ
                AND     SA.CUST_CNT_CD        = MC.CUST_CNT_CD(+)
                AND     SA.CUST_SEQ           = MC.CUST_SEQ(+)
                #end
                AND     SS.EFF_DT <= TO_DATE(@[exp_dt], 'YYYY-MM-DD')      -- S/C Effective Date (To)
                AND     SS.EXP_DT >= TO_DATE(@[eff_dt], 'YYYY-MM-DD')      -- S/C Effective Date (From)
                
                #if (${afil_nm} != '')
                AND     MC.CUST_LGL_ENG_NM LIKE '%' || @[afil_nm] || '%'
                #end

                #if (${sc_no} != '')
                AND     SH.SC_NO LIKE @[sc_no] || '%'         -- S/C No
                #end
                #if (${rf_flg} != '')
                AND     SM.RF_FLG = @[rf_flg]               -- S/C Type
                #end
                #if (${gamt_flg} != '')
                AND     SM.GAMT_FLG = @[gamt_flg]               -- S/C Type
                #end
        
                #if (${prc_ctrt_cust_tp_cd} != '')
                AND     NVL2(SM.REAL_CUST_CNT_CD, SM.REAL_CUST_TP_CD, CT.PRC_CTRT_CUST_TP_CD) = @[prc_ctrt_cust_tp_cd]     -- Customer Type
                #end
                #if (${prop_apro_ofc_cd} != '')
                AND     SM.PROP_APRO_OFC_CD   = @[prop_apro_ofc_cd]        -- Approval Office 
                #end
        
                #if (${svc_scp_cd} != '')
                AND    SS.SVC_SCP_CD    = @[svc_scp_cd] -- SVC Scope
                #end

                #if (${cust_nm} != '')
                AND    UPPER(CP.CTRT_PTY_NM) LIKE '%' || @[cust_nm] || '%'
                #end

                )
        WHERE   ROW_NUMBER    = 1
        #if (${act_cust_nm} != '')
          AND   ACT_CUST_IND = 1
        #end
		#if (${real_cust_nm} != '')
          AND   REAL_CUST_NM LIKE '%' || @[real_cust_nm] || '%'
        #end
) L
		        
        #if (${act_cust_nm} != '' or ${fx_rt_flg} == 'N')
            , PRI_SP_SCP_RT_ACT_CUST SP, MDM_CUSTOMER MC, PRI_SP_SCP_RT_CMDT_HDR SH
        WHERE 1=1
        AND     L.PROP_NO = SH.PROP_NO
        AND     L.AMDT_SEQ = SH.AMDT_SEQ
        AND     L.SVC_SCP_CD = SH.SVC_SCP_CD
        AND     SH.PROP_NO = SP.PROP_NO(+)
        AND     SH.AMDT_SEQ = SP.AMDT_SEQ(+)
        AND     SH.SVC_SCP_CD = SP.SVC_SCP_CD(+)
        AND     SH.GEN_SPCL_RT_TP_CD = SP.GEN_SPCL_RT_TP_CD(+)
        AND     SH.CMDT_HDR_SEQ = SP.CMDT_HDR_SEQ(+)
        AND     SP.CUST_CNT_CD = MC.CUST_CNT_CD(+)
        AND     SP.CUST_SEQ = MC.CUST_SEQ(+)
        AND     SP.SRC_INFO_CD(+)  <>  'AD'
		#if (${act_cust_nm} != '')
        AND     MC.CUST_LGL_ENG_NM LIKE '%' || @[act_cust_nm] || '%'
		#end
		#if (${fx_rt_flg} == 'N')
		AND     SH.FX_RT_FLG = 'Y'
		#end
        #end
        
		
) M        
        #if (${prop_ofc_cd} != '')
        WHERE     M.CTRT_OFC = @[prop_ofc_cd] -- Contract Office
        #end

ORDER BY
        M.SC_NO       ,
        M.AMDT_SEQ    ,
        M.SVC_SCP_CD			]]></sql>
			<params>
				<param name="act_cust_nm" type="12" value="inter" out="N"/>
				<param name="exp_dt" type="12" value="2012-05-23" out="N"/>
				<param name="eff_dt" type="12" value="2012-05-23" out="N"/>
				<param name="afil_nm" type="12" value="" out="N"/>
				<param name="sc_no" type="12" value="" out="N"/>
				<param name="rf_flg" type="12" value="" out="N"/>
				<param name="gamt_flg" type="12" value="" out="N"/>
				<param name="prc_ctrt_cust_tp_cd" type="12" value="" out="N"/>
				<param name="prop_apro_ofc_cd" type="12" value="" out="N"/>
				<param name="svc_scp_cd" type="12" value="" out="N"/>
				<param name="cust_nm" type="12" value="LO" out="N"/>
				<param name="real_cust_nm" type="12" value="" out="N"/>
				<param name="prop_ofc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
