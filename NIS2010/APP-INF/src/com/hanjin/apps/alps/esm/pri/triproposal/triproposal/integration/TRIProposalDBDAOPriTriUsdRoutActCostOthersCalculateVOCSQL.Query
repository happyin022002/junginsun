<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TRIProposalDBDAOPriTriUsdRoutActCostOthersCalculateVOCSQL">
			<desc><![CDATA[Calculate logic.]]></desc>
			<sql><![CDATA[
INSERT INTO PRI_PRS_USD_ROUT_ACT_COST
	(  ROUT_CS_NO			,       ROUT_CS_SRC_DT		,
       COST_ACT_GRP_SEQ     ,       CNTR_TPSZ_CD         ,
       COA_COST_SRC_CD      ,       STND_COST_CD         ,
       RA_ACCT_CD           ,       COST_UT_AMT_CD       ,
       COST_SRC_SYS_CD      ,       COST_ASS_BSE_CD      ,
       RAIL_SVC_TP_CD       ,       ACT_GRP_CD           ,
       COST_ACT_GRP_TP_CD   ,       VSL_SLAN_CD          ,
       CTRL_OFC_CD          ,       COST_OFC_CD          ,
       COST_IO_BND_CD       ,       N1ST_NOD_CD          ,
       N1ST_NOD_TP_CD       ,       N1ST_ESTM_DT         ,
       N2ND_NOD_CD          ,       N3RD_NOD_CD          ,
       N4TH_NOD_CD          ,       ROUT_TZ_MOD_CD       ,
       N1ST_POL_POD_DIST    ,       N1ST_DIST_UT_CD      ,
       N2ND_POL_POD_DIST    ,       N2ND_DIST_UT_CD      ,
       N3RD_POL_POD_DIST    ,       N3RD_DIST_UT_CD      ,
       N1ST_VNDR_SEQ        ,       N2ND_VNDR_SEQ        ,
       N3RD_VNDR_SEQ        ,       N4TH_VNDR_SEQ        ,
       CUST_NOMI_TRKR_FLG   ,       PRE_NOD_CD           ,
       PST_NOD_CD           ,       PRE_LNK_VNDR_SEQ     ,
       PST_LNK_VNDR_SEQ     ,       FCGO_TZ_DYS          ,
       FCGO_TZ_HRS          ,       MCGO_TZ_DYS          ,
       MCGO_TZ_HRS          ,       CNTR_QTY             ,
       COST_CATE_CD         ,       ESTM_UC_AMT          ,
       RESPB_UC_AMT         ,       LOCL_CURR_CD         ,
       TRSP_SVC_OFC_CD      ,       COST_ASGN_CALC_FLG   ,
       LGS_COST_CD_CHK_FLG  ,       THRP_RT_FLG          ,
       ACT_GRP_TML_FLG      ,       LGS_COST_AUTO_CD_FLG ,
       IOC_CD               ,       BFR_TRSP_MOD_CD       ,
       AFT_TRSP_MOD_CD      ,       CTRT_RTN_FLG         ,
       APLY_VNDR_SEQ        ,       SCC_CD               ,
       ECC_CD               ,       PARA_FM_SCC_CD       ,
       PARA_TO_SCC_CD       ,       PARA_FM_ECC_CD       ,
       PARA_TO_ECC_CD       ,       N1ST_RAIL_CRR_TP_CD  ,
       N2ND_RAIL_CRR_TP_CD  ,       N3RD_RAIL_CRR_TP_CD  ,
       ESTM_USD_UC_AMT      ,       RESPB_USD_UC_AMT     ,
       ESTM_USD_TTL_AMT     ,       RESPB_USD_TTL_AMT    ,
       WTR_DE_TERM_CD       ,       WTR_RCV_TERM_CD      ,
       INLND_ROUT_INCL_STTL_FLG,    N1ST_TRSP_AGMT_SEQ   ,
       N2ND_TRSP_AGMT_SEQ   ,       N3RD_TRSP_AGMT_SEQ   ,
       N1ST_TRSP_AGMT_OFC_CTY_CD,   N1ST_AGMT_REF_NO     ,
       N2ND_TRSP_AGMT_OFC_CTY_CD,   N2ND_AGMT_REF_NO     ,
       N3RD_TRSP_AGMT_OFC_CTY_CD,   N3RD_AGMT_REF_NO     ,
       COST_CALC_RMK		,       CRE_USR_ID           ,
       CRE_DT               ,       UPD_USR_ID           ,
       UPD_DT       		
)	
WITH VW_ROUT_CS_NO AS (
   SELECT ROUT_CS_NO
    FROM ( 
		 SELECT  /*+ ORDERED */DISTINCT ROUT.ROUT_CS_NO, DENSE_RANK() OVER( ORDER BY ROUT_CS_NO) NUM
		  FROM (
		       SELECT DISTINCT A.TRI_PROP_NO,
		       		  A.ROUT_PNT_LOC_CD AS LOC_CD, NVL(A.RCV_DE_TERM_CD, 'Y') TERM_CD
		         FROM PRI_TRI_RT_ROUT_PNT A
		        WHERE A.TRI_PROP_NO = @[tri_prop_no]
		          AND A.ORG_DEST_TP_CD = 'O'      
		       ) ORG, 
		       (
		       SELECT DISTINCT A.TRI_PROP_NO, 
		       		  A.ROUT_PNT_LOC_CD AS LOC_CD, NVL(A.RCV_DE_TERM_CD, 'Y') TERM_CD
		         FROM PRI_TRI_RT_ROUT_PNT A
		        WHERE A.TRI_PROP_NO = @[tri_prop_no]
		          AND A.ORG_DEST_TP_CD = 'D'
		       ) DST
			   , PRI_TRI_RT RT
		       , PRI_PRS_ROUT_CS ROUT
		 WHERE ORG.TRI_PROP_NO  = DST.TRI_PROP_NO    
		   AND ORG.TRI_PROP_NO      = RT.TRI_PROP_NO   
		   AND RT.PROP_STS_CD IN ( 'I', 'R') 
		   AND ROUT.ROUT_CS_CLSS_NO = @[rout_cs_clss_no]
		   AND ROUT.POR_CD      = ORG.LOC_CD
		   AND ROUT.DEL_CD      = DST.LOC_CD
		   AND ROUT.BKG_RCV_TERM_CD = ORG.TERM_CD  
		   AND ROUT.BKG_DE_TERM_CD  = DST.TERM_CD  
		   AND ROUT.RAT_UT_CD   = RT.RAT_UT_CD
		   AND ROUT.PRC_CGO_TP_CD = RT.PRC_CGO_TP_CD
		   AND ROUT.COST_ROUT_CS_FLG = 'Y'
           AND NOT EXISTS (
                   SELECT 1
                     FROM PRI_PRS_USD_ROUT_ACT_COST USED_ROUT_COST
                    WHERE ROUT_CS_SRC_DT = @[rout_cs_src_dt]
                      AND ROUT.ROUT_CS_NO  = USED_ROUT_COST.ROUT_CS_NO 
                      )
		)
 )   	
 
SELECT ROUT_CS_NO			,	    ${rout_cs_src_dt} as ROUT_CS_SRC_DT	,
       COST_ACT_GRP_SEQ     ,       CNTR_TPSZ_CD         ,
       COA_COST_SRC_CD      ,       STND_COST_CD         ,
       RA_ACCT_CD           ,       COST_UT_AMT_CD       ,
       COST_SRC_SYS_CD      ,       COST_ASS_BSE_CD      ,
       RAIL_SVC_TP_CD       ,       ACT_GRP_CD           ,
       COST_ACT_GRP_TP_CD   ,       VSL_SLAN_CD          ,
       CTRL_OFC_CD          ,       COST_OFC_CD          ,
       COST_IO_BND_CD       ,       N1ST_NOD_CD          ,
       N1ST_NOD_TP_CD       ,       N1ST_ESTM_DT			,
       N2ND_NOD_CD          ,       N3RD_NOD_CD          ,
       N4TH_NOD_CD          ,       ROUT_TZ_MOD_CD       ,
       N1ST_POL_POD_DIST    ,       N1ST_DIST_UT_CD      ,
       N2ND_POL_POD_DIST    ,       N2ND_DIST_UT_CD      ,
       N3RD_POL_POD_DIST    ,       N3RD_DIST_UT_CD      ,
       N1ST_VNDR_SEQ        ,       N2ND_VNDR_SEQ        ,
       N3RD_VNDR_SEQ        ,       N4TH_VNDR_SEQ        ,
       CUST_NOMI_TRKR_FLG   ,       PRE_NOD_CD           ,
       PST_NOD_CD           ,       PRE_LNK_VNDR_SEQ     ,
       PST_LNK_VNDR_SEQ     ,       FCGO_TZ_DYS          ,
       FCGO_TZ_HRS          ,       MCGO_TZ_DYS          ,
       MCGO_TZ_HRS          ,       CNTR_QTY             ,
       COST_CATE_CD         ,       ESTM_UC_AMT          ,
       RESPB_UC_AMT         ,       LOCL_CURR_CD         ,
       TRSP_SVC_OFC_CD      ,       COST_ASGN_CALC_FLG   ,
       LGS_COST_CD_CHK_FLG  ,       THRP_RT_FLG          ,
       ACT_GRP_TML_FLG      ,       LGS_COST_AUTO_CD_FLG ,
       IOC_CD               ,       BFR_TRSP_MOD_CD       ,
       AFT_TRSP_MOD_CD      ,       CTRT_RTN_FLG         ,
       APLY_VNDR_SEQ        ,       SCC_CD               ,
       ECC_CD               ,       PARA_FM_SCC_CD       ,
       PARA_TO_SCC_CD       ,       PARA_FM_ECC_CD       ,
       PARA_TO_ECC_CD       ,       N1ST_RAIL_CRR_TP_CD  ,
       N2ND_RAIL_CRR_TP_CD  ,       N3RD_RAIL_CRR_TP_CD  ,
       ESTM_USD_UC_AMT      ,       RESPB_USD_UC_AMT     ,
       ESTM_USD_TTL_AMT     ,       RESPB_USD_TTL_AMT    ,
       WTR_DE_TERM_CD       ,       WTR_RCV_TERM_CD      ,
       INLND_ROUT_INCL_STTL_FLG,    N1ST_TRSP_AGMT_SEQ   ,
       N2ND_TRSP_AGMT_SEQ   ,       N3RD_TRSP_AGMT_SEQ   ,
       N1ST_TRSP_AGMT_OFC_CTY_CD,   N1ST_AGMT_REF_NO     ,
       N2ND_TRSP_AGMT_OFC_CTY_CD,   N2ND_AGMT_REF_NO     ,
       N3RD_TRSP_AGMT_OFC_CTY_CD,   N3RD_AGMT_REF_NO     ,
	   '' 					,       'CALC'				,
       SYSDATE              ,       'CALC'				,
       SYSDATE              
  FROM PRI_PRS_ROUT_ACT_COST
 WHERE ROUT_CS_NO IN ( SELECT ROUT_CS_NO FROM VW_ROUT_CS_NO ) 
   AND ROUT_CS_CLSS_NO = @[rout_cs_clss_no]			]]></sql>
			<params>
				<param name="tri_prop_no" type="12" value="" out="N"/>
				<param name="rout_cs_clss_no" type="12" value="" out="N"/>
				<param name="rout_cs_src_dt" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
