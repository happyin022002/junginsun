<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="OwnersAccountDBDAOOwnersAccountListRSQL">
			<desc><![CDATA[Owner's Account 목록을 조회]]></desc>
			<sql><![CDATA[
SELECT A.OFFICE,
       A.CSR_NO,
       A.VNDR_SEQ,
       A.currency,
       A.amount,
       A.description,
       A.internal_meno,
       A.creation_dt,
       A.user_id,
       A.user_name,
       A.if_err_desc,
       CASE WHEN A.CSR_TOT_CNT <> A.CSR_PAIR_CNT AND A.CSR_PAIR_CNT > 0 THEN 'Partial Cancel'
            ELSE A.csr_status
            END csr_status,

       (SELECT V.VNDR_LGL_ENG_NM
        FROM MDM_VENDOR V
        WHERE V.VNDR_SEQ = A.VNDR_SEQ) supplier
      ,(
        SELECT AA.SLP_TP_CD||AA.SLP_FUNC_CD||AA.SLP_OFC_CD||AA.SLP_ISS_DT||AA.SLP_SER_NO FROM FMS_CONSULTATION AA
        WHERE AA.VAT_SLP_TP_CD||AA.VAT_SLP_FUNC_CD||AA.VAT_SLP_OFC_CD||AA.VAT_SLP_ISS_DT||AA.VAT_SLP_SER_NO = A.CSR_NO
      ) AS VAT_CSR_NO,
      A.ASA_NO
FROM 
(
  SELECT A.SLP_OFC_CD AS office,
       A.SLP_TP_CD||A.SLP_FUNC_CD||A.SLP_OFC_CD||A.SLP_ISS_DT||A.SLP_SER_NO CSR_NO,
       (SELECT B.VNDR_SEQ   
        FROM  FMS_CSUL_SLP B
        WHERE 1 = 1
          AND A.SLP_TP_CD = B.SLP_TP_CD
          AND A.SLP_FUNC_CD = B.SLP_FUNC_CD
          AND A.SLP_OFC_CD = B.SLP_OFC_CD
          AND A.SLP_ISS_DT = B.SLP_ISS_DT
          AND A.SLP_SER_NO = B.SLP_SER_NO
          AND ROWNUM = 1) VNDR_SEQ,   -- Supplier CODE
         
       A.CSR_CURR_CD 	AS currency,
       A.RQST_AMT 		AS amount,
       A.CSR_DESC 		AS description,
       A.OA_INTER_MM_DESC AS internal_meno, -- INTERNAL MEMO
       TO_CHAR(A.CRE_DT, 'YYYY-MM-DD') 	AS creation_dt,
       A.CRE_USR_ID						AS user_id, 
       (SELECT U.USR_NM
        FROM COM_USER U
        WHERE U.USR_ID = A.CRE_USR_ID)  AS user_name,
        
       (SELECT H.IF_ERR_RSN
        FROM AP_INV_HDR H
        WHERE H.CSR_NO = A.SLP_TP_CD||A.SLP_FUNC_CD||A.SLP_OFC_CD||A.SLP_ISS_DT||A.SLP_SER_NO) AS if_err_desc,
        
       NVL((SELECT CASE 
                 WHEN A.APRO_FLG = 'N' AND A.CXL_FLG = 'N' AND H.IF_FLG IS NULL AND NVL(H.CSR_APRO_TP_CD, 'AL') = 'AL' THEN 'Submitted'
                 WHEN A.APRO_FLG = 'N' AND A.CXL_FLG = 'N' AND H.IF_FLG IS NULL AND H.CSR_APRO_TP_CD = 'GW' AND H.RQST_APRO_STEP_FLG IS NULL THEN 'Submitted'
                 WHEN A.APRO_FLG = 'Y' AND H.IF_FLG = 'Y' THEN 'Approved'
                 WHEN A.APRO_FLG = 'N' AND A.CXL_FLG = 'Y' AND H.APRO_FLG = 'Y' THEN 'Reject'
                 WHEN A.APRO_FLG = 'Y' AND H.IF_FLG = 'E' AND H.APRO_FLG = 'Y' THEN 'I/F Error'
                 WHEN B.PAIR_SLP_FUNC_CD IS NOT NULL THEN 'Cancel'
                 ELSE ''
              END    
        FROM AP_INV_HDR H,
             FMS_CSUL_SLP B
        WHERE H.CSR_NO = A.SLP_TP_CD||A.SLP_FUNC_CD||A.SLP_OFC_CD||A.SLP_ISS_DT||A.SLP_SER_NO
          AND B.SLP_TP_CD   = SUBSTR(H.CSR_NO,1,2)
          AND B.SLP_FUNC_CD = SUBSTR(H.CSR_NO,3,1) 
          AND B.SLP_OFC_CD  = DECODE(LENGTH(H.CSR_NO), 19, SUBSTR(H.CSR_NO, 4, 5), SUBSTR(H.CSR_NO, 4, 6))
          AND B.SLP_ISS_DT  = DECODE(LENGTH(H.CSR_NO), 19, SUBSTR(H.CSR_NO, 9, 6), SUBSTR(H.CSR_NO, 10, 6))
          AND B.SLP_SER_NO  = DECODE(LENGTH(H.CSR_NO), 19, SUBSTR(H.CSR_NO, 15, 5), SUBSTR(H.CSR_NO, 16, 5))
          AND ROWNUM = 1
        ), 'Saved') AS csr_status,  -- CSR STATUS
        (SELECT COUNT(*)
              FROM FMS_CSUL_SLP C
              WHERE A.SLP_TP_CD||A.SLP_FUNC_CD||A.SLP_OFC_CD||A.SLP_ISS_DT||A.SLP_SER_NO
                     = C.SLP_TP_CD||C.SLP_FUNC_CD||C.SLP_OFC_CD||C.SLP_ISS_DT||C.SLP_SER_NO
                AND C.ACCT_CD = '962111'
        ) CSR_TOT_CNT,
       (SELECT COUNT(*)
              FROM FMS_CSUL_SLP D
              WHERE A.SLP_TP_CD||A.SLP_FUNC_CD||A.SLP_OFC_CD||A.SLP_ISS_DT||A.SLP_SER_NO
                   = D.SLP_TP_CD||D.SLP_FUNC_CD||D.SLP_OFC_CD||D.SLP_ISS_DT||D.SLP_SER_NO
                AND D.ACCT_CD = '962111'
                AND D.PAIR_SLP_TP_CD IS NOT NULL 
       ) CSR_PAIR_CNT,  
       A.ASA_NO
FROM FMS_CONSULTATION A
WHERE 1 = 1
  AND A.OA_INV_DT IS NOT NULL  -- O/A 962111 계정
  AND NOT EXISTS (SELECT 'OK'
                   FROM  AP_INV_HDR H
                   WHERE H.CSR_NO = A.SLP_TP_CD||A.SLP_FUNC_CD||A.SLP_OFC_CD||A.SLP_ISS_DT||A.SLP_SER_NO
                     AND H.APRO_FLG = 'N'
                     AND A.APRO_FLG = 'N'
                     AND A.CXL_FLG = 'Y')

#if (${date_gubun} == 'gl')
  AND A.EFF_DT BETWEEN REPLACE(@[pre_fr],'-','') AND REPLACE(@[pre_to],'-','')   -- G/L DATE
#else
  AND TO_CHAR(A.CRE_DT,'YYYYMMDD') BETWEEN REPLACE(@[pre_fr],'-','') AND REPLACE(@[pre_to],'-','') -- CREATION DATE
#end
#if (${office} != '')
#if (${off_cd} == 'SELADG')
   AND @[office] = (SELECT  DISTINCT OFC_CD
                        FROM  MDM_ORGANIZATION
                       WHERE  1 = 1
                         AND  OFC_KND_CD = '2'
                         AND  PRNT_OFC_CD = 'SELDC'
                      START WITH OFC_CD = A.SLP_OFC_CD
                      CONNECT BY PRIOR PRNT_OFC_CD = OFC_CD)
#else
   #if (${off_cd} == 'NYCRAG')
       AND A.SLP_OFC_CD = 'NYCRA'   -- OFFIICE  NYCRAG
   #else
       AND A.SLP_OFC_CD = @[office]   -- OFFIICE 
   #end
#end
    
#else
#if (${off_cd} != 'SELADG' && ${off_cd} != 'PUSMPG')    -- 2017.07.12 PUSMPG 추가
  AND EXISTS (
                SELECT 'OK' 
                FROM 
                (
                   #if (${off_cd} == 'NYCRAG')
                      SELECT DISTINCT 'NYCRA' AS OFFICE, ROWNUM AS RUM, OFC_CD   -- OFFIICE  NYCRAG
                   #else
                        SELECT DISTINCT @[off_cd] AS OFFICE, ROWNUM AS RUM, OFC_CD
                   #end

                    FROM MDM_ORGANIZATION
                    WHERE DELT_FLG = 'N'
                    CONNECT BY PRIOR OFC_CD = PRNT_OFC_CD

                   #if (${off_cd} == 'NYCRAG')
                      START WITH OFC_CD = DECODE('NYCRA','SELADG','XXXXX','NYCRA')     -- OFFIICE  NYCRAG
                   #else
                        START WITH OFC_CD = DECODE(@[off_cd],'SELADG','XXXXX',@[off_cd])  
                   #end
                ) A
                WHERE 1=1

               #if (${off_cd} == 'NYCRAG')
                    AND A.SLP_OFC_CD = 'NYCRA'   -- OFFIICE  NYCRAG
               #else
                     AND A.OFFICE = @[off_cd]
               #end

                AND A.SLP_OFC_CD = A.OFFICE
            )  
#end
#end

#if (${my_csr} == 'Y')
  AND A.CRE_USR_ID = @[usr_id]   -- MY CSR ONLY CHECK 시
#end
#if (${spcode} != '')  
  AND EXISTS (SELECT 'OK'   
                FROM  FMS_CSUL_SLP B
                WHERE 1 = 1
                  AND A.SLP_TP_CD = B.SLP_TP_CD
                  AND A.SLP_FUNC_CD = B.SLP_FUNC_CD
                  AND A.SLP_OFC_CD = B.SLP_OFC_CD
                  AND A.SLP_ISS_DT = B.SLP_ISS_DT
                  AND A.SLP_SER_NO = B.SLP_SER_NO
                  AND B.VNDR_SEQ = @[spcode])    -- SUPPLIER
#end          
#if (${vsl_cd} != '')  
  AND EXISTS (SELECT 'OK'   
                FROM  FMS_CSUL_SLP B
                WHERE 1 = 1
                  AND A.SLP_TP_CD = B.SLP_TP_CD
                  AND A.SLP_FUNC_CD = B.SLP_FUNC_CD
                  AND A.SLP_OFC_CD = B.SLP_OFC_CD
                  AND A.SLP_ISS_DT = B.SLP_ISS_DT
                  AND A.SLP_SER_NO = B.SLP_SER_NO
                  AND B.VSL_CD = @[vsl_cd])    -- VESSEL CODE     
#end          
#if (${loc_cd} != '')  
   AND EXISTS (SELECT 'OK'   
                FROM  FMS_CSUL_SLP B
                WHERE 1 = 1
                  AND A.SLP_TP_CD = B.SLP_TP_CD
                  AND A.SLP_FUNC_CD = B.SLP_FUNC_CD
                  AND A.SLP_OFC_CD = B.SLP_OFC_CD
                  AND A.SLP_ISS_DT = B.SLP_ISS_DT
                  AND A.SLP_SER_NO = B.SLP_SER_NO
                  AND B.OA_LOC_CD = @[loc_cd])    -- LOCATION
#end          
#if (${csr_no} != '')  
  AND A.SLP_TP_CD||A.SLP_FUNC_CD||A.SLP_OFC_CD||A.SLP_ISS_DT||A.SLP_SER_NO = @[csr_no] -- CSR NO
#end          
#if (${csr_status} != '')     	
  AND NVL((SELECT CASE 
                 WHEN B.PAIR_SLP_FUNC_CD IS NOT NULL THEN 'CN'					--Cancel
                 WHEN A.APRO_FLG = 'N' AND A.CXL_FLG = 'N' AND H.IF_FLG IS NULL AND NVL(H.CSR_APRO_TP_CD, 'AL') = 'AL' THEN 'SB'		--Submited
                  WHEN A.APRO_FLG = 'N' AND A.CXL_FLG = 'N' AND H.IF_FLG IS NULL AND H.CSR_APRO_TP_CD = 'GW' THEN 'SB'		--Submited
                 WHEN A.APRO_FLG = 'Y' AND H.IF_FLG = 'Y' THEN 'AP'			--Approved
                 WHEN A.APRO_FLG = 'N' AND A.CXL_FLG = 'Y' AND H.APRO_FLG = 'Y' THEN 'RJ'		--Reject
                 WHEN A.APRO_FLG = 'Y' AND H.IF_FLG = 'E' AND H.APRO_FLG = 'Y' THEN 'IE'			--I/F Error
                 ELSE ''
              END    
        FROM AP_INV_HDR H,
             FMS_CSUL_SLP B
        WHERE H.CSR_NO = A.SLP_TP_CD||A.SLP_FUNC_CD||A.SLP_OFC_CD||A.SLP_ISS_DT||A.SLP_SER_NO
          AND B.SLP_TP_CD   = SUBSTR(H.CSR_NO,1,2)
          AND B.SLP_FUNC_CD = SUBSTR(H.CSR_NO,3,1) 
          AND B.SLP_OFC_CD  = DECODE(LENGTH(H.CSR_NO), 19, SUBSTR(H.CSR_NO, 4, 5), SUBSTR(H.CSR_NO, 4, 6))
          AND B.SLP_ISS_DT  = DECODE(LENGTH(H.CSR_NO), 19, SUBSTR(H.CSR_NO, 9, 6), SUBSTR(H.CSR_NO, 10, 6))
          AND B.SLP_SER_NO  = DECODE(LENGTH(H.CSR_NO), 19, SUBSTR(H.CSR_NO, 15, 5), SUBSTR(H.CSR_NO, 16, 5))
          AND ROWNUM = 1
        ), 'SV') = @[csr_status]
#end
) A
ORDER BY 1, 2			]]></sql>
			<params>
				<param name="pre_fr" type="12" value="" out="N"/>
				<param name="pre_to" type="12" value="" out="N"/>
				<param name="office" type="12" value="" out="N"/>
				<param name="off_cd" type="12" value="" out="N"/>
				<param name="usr_id" type="12" value="" out="N"/>
				<param name="spcode" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="loc_cd" type="12" value="" out="N"/>
				<param name="csr_no" type="12" value="" out="N"/>
				<param name="csr_status" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
