<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="PerformanceReportDBDAOSearchDPCSTurnTimeSummaryRSQL">
			<desc><![CDATA[--------------------------------------------------------
History
2011.05.16 김상수 [CHM-201109394-01] DPCS 고도화 요청 : B/L Turn Time Report (ESM_BKG_0067) Summary Sheet추가 및 로직 변경으로 신규생성]]></desc>
			<sql><![CDATA[
#if (${period} == 'OTH')
SELECT RGN,
       RGN_CD,
       BKG_OFC_CD,
       TTL_BKG,
       INPUT_TTL_EVENT,
       INPUT_TTL_PIC,
       '00' AS INPUT_TTL_HOUR_DD,
       '00' AS INPUT_TTL_HOUR_HH,
       '00' AS INPUT_TTL_HOUR_MI,
       '00' AS INPUT_TTL_HOUR_SS,
       '00' AS INPUT_TTL_AVER_DD,
       '00' AS INPUT_TTL_AVER_HH,
       '00' AS INPUT_TTL_AVER_MI,
       '00' AS INPUT_TTL_AVER_SS,
       RATE_TTL_EVENT,
       RATE_TTL_PIC,
       '00' AS RATE_TTL_HOUR_DD,
       '00' AS RATE_TTL_HOUR_HH,
       '00' AS RATE_TTL_HOUR_MI,
       '00' AS RATE_TTL_HOUR_SS,
       '00' AS RATE_TTL_AVER_DD,
       '00' AS RATE_TTL_AVER_HH,
       '00' AS RATE_TTL_AVER_MI,
       '00' AS RATE_TTL_AVER_SS,
       QA_TTL_EVENT,
       QA_TTL_PIC,
       '00' AS QA_TTL_HOUR_DD,
       '00' AS QA_TTL_HOUR_HH,
       '00' AS QA_TTL_HOUR_MI,
       '00' AS QA_TTL_HOUR_SS,
       '00' AS QA_TTL_AVER_DD,
       '00' AS QA_TTL_AVER_HH,
       '00' AS QA_TTL_AVER_MI,
       '00' AS QA_TTL_AVER_SS,
       TOTAL_TTL_EVENT,
       TOTAL_TTL_PIC,
       '00' AS TOTAL_TTL_HOUR_DD,
       '00' AS TOTAL_TTL_HOUR_HH,
       '00' AS TOTAL_TTL_HOUR_MI,
       '00' AS TOTAL_TTL_HOUR_SS,
       '00' AS TOTAL_TTL_AVER_DD,
       '00' AS TOTAL_TTL_AVER_HH,
       '00' AS TOTAL_TTL_AVER_MI,
       '00' AS TOTAL_TTL_AVER_SS
 FROM
       (SELECT NVL((SELECT INTG_CD_VAL_DESC
                      FROM COM_INTG_CD_DTL
                     WHERE INTG_CD_ID = 'CD01603'
                       AND INTG_CD_VAL_CTNT = DECODE(RGN_CD, 'E', 'DE', 'J', 'JP', 'K', 'KR', 'N', 'US', 'S', 'PK', 'C','CN', 'XX')),
                   '('||BKG_OFC_CD||')') AS RGN,    -- RGN,
               RGN_CD,
               BKG_OFC_CD,
			   TTL_BKG,
               '0' AS INPUT_TTL_EVENT,
               '0' AS INPUT_TTL_PIC,
               '0' AS INPUT_TTL_HOUR,
               '0' AS RATE_TTL_EVENT,
               '0' AS RATE_TTL_PIC,
               '0' AS  RATE_TTL_HOUR,
               '0' AS QA_TTL_EVENT,
               '0' AS QA_TTL_PIC,
               '0' AS QA_TTL_HOUR,
               '0' AS TOTAL_TTL_EVENT,
               '0' AS TOTAL_TTL_PIC,
               '0' AS TOTAL_TTL_HOUR

          FROM
               (SELECT 
                       COUNT(DISTINCT(BKG.BKG_NO)) TTL_BKG,
                       (SELECT DISTINCT RGN_OFC_CD
                          FROM BKG_EML_ACCT_STUP
                         WHERE BKG_OFC_CD = BKG.BKG_OFC_CD
                           AND ROWNUM = 1) AS RGN_CD,    -- RGN_CD
                       BKG.BKG_OFC_CD    -- BKG Ofc.

                  FROM BKG_SR_CRNT_RQST SCR,
#if (${bkg_no} == '' && ${rgn_cd} != '')
                       BKG_EML_ACCT_STUP EAS,
#end
                       BKG_BOOKING BKG,
                       BKG_SR_HIS HIS

                 WHERE 1 = 1
#if (${bkg_no} == '')
     #if (${from_dt} != '' && ${to_dt} != '')
          #if (${period} == 'WRK')
                   /*    Working    */
                   AND SCR.SR_WRK_STS_DT BETWEEN TO_DATE(@[from_dt], 'YYYY-MM-DD')
                                             AND TO_DATE(@[to_dt], 'YYYY-MM-DD') + 0.99999
                   AND (SCR.BL_DOC_INP_FLG  <> 'Y' OR SCR.BL_RT_FLG <> 'Y' OR SCR.BL_AUD_FLG <> 'Y')
          #elseif (${period} == 'CPT')
                   /*    Complete    */
                   AND SCR.BL_AUD_DT BETWEEN TO_DATE(@[from_dt], 'YYYY-MM-DD')
                                         AND TO_DATE(@[to_dt], 'YYYY-MM-DD') +  0.99999
                   AND (SCR.BL_DOC_INP_FLG  = 'Y' AND SCR.BL_RT_FLG = 'Y' AND SCR.BL_AUD_FLG = 'Y')
		  #elseif (${period} == 'OTH')
				   /*	 Other		*/
                   AND SCR.SR_WRK_STS_DT BETWEEN TO_DATE(@[from_dt], 'YYYY-MM-DD')
                                         AND TO_DATE(@[to_dt], 'YYYY-MM-DD') +  0.99999
                   AND (SCR.BL_DOC_INP_FLG  = 'N' AND SCR.BL_RT_FLG = 'N' AND SCR.BL_AUD_FLG = 'N')
          #end
     #end
     #if (${dpcs_ofc_cd} != '')
                   AND SCR.DPCS_OFC_CD = @[dpcs_ofc_cd]
     #end
     #if (${vvd_cd} != '')
                   AND BKG.VSL_CD||BKG.SKD_VOY_NO||BKG.SKD_DIR_CD LIKE @[vvd_cd]||'%'
     #end
     #if (${pol_cd} != '')
                   AND BKG.POL_CD LIKE @[pol_cd]||'%'
     #end
     #if (${pod_cd} != '')
                   AND BKG.POD_CD LIKE @[pod_cd]||'%'
     #end
     #if (${bkg_ofc_cd} != '')
                   AND BKG.BKG_OFC_CD LIKE '%'||@[bkg_ofc_cd]||'%'
     #end
     #if (${rgn_cd} != '')
                   AND EAS.BKG_OFC_CD = BKG.BKG_OFC_CD
                   AND EAS.RGN_OFC_CD IN (${rgn_cd})
     #end
#else
                   AND SCR.BKG_NO LIKE @[bkg_no]||'%'
#end
                   AND SCR.SR_CRNT_STS_CD <> 'XX'
                   AND BKG.BKG_NO = SCR.BKG_NO
                   AND BKG.BKG_STS_CD <> 'X'
                   AND HIS.SR_KND_CD = SCR.SR_KND_CD
                   AND HIS.SR_NO = SCR.SR_NO
                   AND HIS.BKG_NO = SCR.BKG_NO
	 #if (${period} != 'OTH')
                   AND HIS.SR_STS_CD IN ('ID', 'RD', 'AD')
     #end
				  

                 GROUP BY BKG.BKG_OFC_CD
               )
       )

 ORDER BY RGN_CD,
          BKG_OFC_CD
#else
SELECT RGN,
       RGN_CD,
       BKG_OFC_CD,
       TTL_BKG,
       INPUT_TTL_EVENT,
       INPUT_TTL_PIC,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(INPUT_TTL_HOUR, 'DD'), '00') AS INPUT_TTL_HOUR_DD,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(INPUT_TTL_HOUR, 'HH'), '00') AS INPUT_TTL_HOUR_HH,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(INPUT_TTL_HOUR, 'MM'), '00') AS INPUT_TTL_HOUR_MI,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(INPUT_TTL_HOUR, 'SS'), '00') AS INPUT_TTL_HOUR_SS,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(INPUT_TTL_HOUR / TTL_BKG, 'DD'), '00') AS INPUT_TTL_AVER_DD,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(INPUT_TTL_HOUR / TTL_BKG, 'HH'), '00') AS INPUT_TTL_AVER_HH,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(INPUT_TTL_HOUR / TTL_BKG, 'MM'), '00') AS INPUT_TTL_AVER_MI,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(INPUT_TTL_HOUR / TTL_BKG, 'SS'), '00') AS INPUT_TTL_AVER_SS,
       RATE_TTL_EVENT,
       RATE_TTL_PIC,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(RATE_TTL_HOUR, 'DD'), '00') AS RATE_TTL_HOUR_DD,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(RATE_TTL_HOUR, 'HH'), '00') AS RATE_TTL_HOUR_HH,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(RATE_TTL_HOUR, 'MM'), '00') AS RATE_TTL_HOUR_MI,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(RATE_TTL_HOUR, 'SS'), '00') AS RATE_TTL_HOUR_SS,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(RATE_TTL_HOUR / TTL_BKG, 'DD'), '00') AS RATE_TTL_AVER_DD,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(RATE_TTL_HOUR / TTL_BKG, 'HH'), '00') AS RATE_TTL_AVER_HH,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(RATE_TTL_HOUR / TTL_BKG, 'MM'), '00') AS RATE_TTL_AVER_MI,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(RATE_TTL_HOUR / TTL_BKG, 'SS'), '00') AS RATE_TTL_AVER_SS,
       QA_TTL_EVENT,
       QA_TTL_PIC,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(QA_TTL_HOUR, 'DD'), '00') AS QA_TTL_HOUR_DD,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(QA_TTL_HOUR, 'HH'), '00') AS QA_TTL_HOUR_HH,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(QA_TTL_HOUR, 'MM'), '00') AS QA_TTL_HOUR_MI,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(QA_TTL_HOUR, 'SS'), '00') AS QA_TTL_HOUR_SS,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(QA_TTL_HOUR / TTL_BKG, 'DD'), '00') AS QA_TTL_AVER_DD,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(QA_TTL_HOUR / TTL_BKG, 'HH'), '00') AS QA_TTL_AVER_HH,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(QA_TTL_HOUR / TTL_BKG, 'MM'), '00') AS QA_TTL_AVER_MI,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(QA_TTL_HOUR / TTL_BKG, 'SS'), '00') AS QA_TTL_AVER_SS,
       TOTAL_TTL_EVENT,
       TOTAL_TTL_PIC,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(TOTAL_TTL_HOUR, 'DD'), '00') AS TOTAL_TTL_HOUR_DD,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(TOTAL_TTL_HOUR, 'HH'), '00') AS TOTAL_TTL_HOUR_HH,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(TOTAL_TTL_HOUR, 'MM'), '00') AS TOTAL_TTL_HOUR_MI,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(TOTAL_TTL_HOUR, 'SS'), '00') AS TOTAL_TTL_HOUR_SS,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(TOTAL_TTL_HOUR / TTL_BKG, 'DD'), '00') AS TOTAL_TTL_AVER_DD,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(TOTAL_TTL_HOUR / TTL_BKG, 'HH'), '00') AS TOTAL_TTL_AVER_HH,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(TOTAL_TTL_HOUR / TTL_BKG, 'MM'), '00') AS TOTAL_TTL_AVER_MI,
       NVL(BKG_GET_CONV_INTVAL_TIME_FNC(TOTAL_TTL_HOUR / TTL_BKG, 'SS'), '00') AS TOTAL_TTL_AVER_SS
  FROM
       (SELECT NVL((SELECT INTG_CD_VAL_DESC
                      FROM COM_INTG_CD_DTL
                     WHERE INTG_CD_ID = 'CD01603'
                       AND INTG_CD_VAL_CTNT = DECODE(RGN_CD, 'E', 'DE', 'J', 'JP', 'K', 'KR', 'N', 'US', 'S', 'PK', 'C', 'CN','XX')),
                   '('||BKG_OFC_CD||')') AS RGN,    -- RGN,
               RGN_CD,
               BKG_OFC_CD,
               SUM(DECODE(SR_STS_CD, 'ID', TTL_BKG, 0)) AS TTL_BKG,
               SUM(INPUT_TTL_EVENT) AS INPUT_TTL_EVENT,
               SUM(DECODE(SR_STS_CD, 'ID', USER_ID, 0)) AS INPUT_TTL_PIC,
               SUM(INPUT_TTL_HOUR) AS INPUT_TTL_HOUR,
               SUM(RATE_TTL_EVENT) AS RATE_TTL_EVENT,
               SUM(DECODE(SR_STS_CD, 'RD', USER_ID, 0)) AS RATE_TTL_PIC,
               SUM(RATE_TTL_HOUR) AS  RATE_TTL_HOUR,
               SUM(QA_TTL_EVENT) AS QA_TTL_EVENT,
               SUM(DECODE(SR_STS_CD, 'AD', USER_ID, 0)) AS QA_TTL_PIC,
               SUM(QA_TTL_HOUR) AS QA_TTL_HOUR,
               SUM(INPUT_TTL_EVENT) + SUM(RATE_TTL_EVENT) + SUM(QA_TTL_EVENT) AS TOTAL_TTL_EVENT,
               SUM(DECODE(SR_STS_CD, 'ID', USER_ID, 0)) + SUM(DECODE(SR_STS_CD, 'RD', USER_ID, 0)) + SUM(DECODE(SR_STS_CD, 'AD', USER_ID, 0)) AS TOTAL_TTL_PIC,
               SUM(INPUT_TTL_HOUR) + SUM(RATE_TTL_HOUR) + SUM(QA_TTL_HOUR) AS TOTAL_TTL_HOUR

          FROM
               (SELECT HIS.SR_STS_CD,
                       (SELECT DISTINCT RGN_OFC_CD
                          FROM BKG_EML_ACCT_STUP
                         WHERE BKG_OFC_CD = BKG.BKG_OFC_CD
                           AND ROWNUM = 1) AS RGN_CD,    -- RGN_CD
                       BKG.BKG_OFC_CD,    -- BKG Ofc.
                       COUNT(DISTINCT BKG.BKG_NO) TTL_BKG,
                       SUM(DECODE(SR_STS_CD, 'ID', 1, 0)) AS INPUT_TTL_EVENT,    -- INPUT_TTL_EVENT
                       COUNT(DISTINCT BKG.BKG_OFC_CD||SR_STS_CD||ATND_USR_ID) USER_ID,
                       SUM(DECODE(SR_STS_CD, 'ID', SR_PROC_HRS, 0)) AS INPUT_TTL_HOUR,   -- INPUT_TTL_HOUR
                       SUM(DECODE(SR_STS_CD, 'RD', 1, 0)) AS RATE_TTL_EVENT,   -- RATE_TTL_EVENT
                       SUM(DECODE(SR_STS_CD, 'RD', SR_PROC_HRS, 0)) AS RATE_TTL_HOUR,   -- RATE_TTL_HOUR
                       SUM(DECODE(SR_STS_CD, 'AD', 1, 0)) AS QA_TTL_EVENT,   -- QA_TTL_EVENT
                       SUM(DECODE(SR_STS_CD, 'AD', SR_PROC_HRS, 0)) AS QA_TTL_HOUR    -- QA_TTL_HOUR

                  FROM BKG_SR_CRNT_RQST SCR,
#if (${bkg_no} == '' && ${rgn_cd} != '')
                       BKG_EML_ACCT_STUP EAS,
#end
                       BKG_BOOKING BKG,
                       BKG_SR_HIS HIS

                 WHERE 1 = 1
#if (${bkg_no} == '')
     #if (${from_dt} != '' && ${to_dt} != '')
          #if (${period} == 'WRK')
                   /*    Working    */
                   AND SCR.SR_WRK_STS_DT BETWEEN TO_DATE(@[from_dt], 'YYYY-MM-DD')
                                             AND TO_DATE(@[to_dt], 'YYYY-MM-DD') + 0.99999
                   AND (SCR.BL_DOC_INP_FLG  <> 'Y' OR SCR.BL_RT_FLG <> 'Y' OR SCR.BL_AUD_FLG <> 'Y')
          #elseif (${period} == 'CPT')
                   /*    Complete    */
                   AND SCR.BL_AUD_DT BETWEEN TO_DATE(@[from_dt], 'YYYY-MM-DD')
                                         AND TO_DATE(@[to_dt], 'YYYY-MM-DD') +  0.99999
                   AND (SCR.BL_DOC_INP_FLG  = 'Y' AND SCR.BL_RT_FLG = 'Y' AND SCR.BL_AUD_FLG = 'Y')
		  #elseif (${period} == 'OTH')
				   /*	 Other		*/
                   AND SCR.SR_WRK_STS_DT BETWEEN TO_DATE(@[from_dt], 'YYYY-MM-DD')
                                         AND TO_DATE(@[to_dt], 'YYYY-MM-DD') +  0.99999
                   AND (SCR.BL_DOC_INP_FLG  = 'N' AND SCR.BL_RT_FLG = 'N' AND SCR.BL_AUD_FLG = 'N')
          #end
     #end
     #if (${dpcs_ofc_cd} != '')
                   AND SCR.DPCS_OFC_CD = @[dpcs_ofc_cd]
     #end
     #if (${vvd_cd} != '')
                   AND BKG.VSL_CD||BKG.SKD_VOY_NO||BKG.SKD_DIR_CD LIKE @[vvd_cd]||'%'
     #end
     #if (${pol_cd} != '')
                   AND BKG.POL_CD LIKE @[pol_cd]||'%'
     #end
     #if (${pod_cd} != '')
                   AND BKG.POD_CD LIKE @[pod_cd]||'%'
     #end
     #if (${bkg_ofc_cd} != '')
                   AND BKG.BKG_OFC_CD LIKE '%'||@[bkg_ofc_cd]||'%'
     #end
     #if (${rgn_cd} != '')
                   AND EAS.BKG_OFC_CD = BKG.BKG_OFC_CD
                   AND EAS.RGN_OFC_CD IN (${rgn_cd})
     #end
#else
                   AND SCR.BKG_NO LIKE @[bkg_no]||'%'
#end
                   AND SCR.SR_CRNT_STS_CD <> 'XX'
                   AND BKG.BKG_NO = SCR.BKG_NO
                   AND BKG.BKG_STS_CD <> 'X'
                   AND HIS.SR_KND_CD = SCR.SR_KND_CD
                   AND HIS.SR_NO = SCR.SR_NO
                   AND HIS.BKG_NO = SCR.BKG_NO
	 #if (${period} != 'OTH')
                   AND HIS.SR_STS_CD IN ('ID', 'RD', 'AD')
     #end
				  

                 GROUP BY BKG.BKG_OFC_CD,
                          HIS.SR_STS_CD
               )

         GROUP BY RGN_CD,
                  BKG_OFC_CD
       )

 ORDER BY RGN_CD,
          BKG_OFC_CD
#end			]]></sql>
			<params>
				<param name="from_dt" type="12" value="" out="N"/>
				<param name="to_dt" type="12" value="" out="N"/>
				<param name="dpcs_ofc_cd" type="12" value="" out="N"/>
				<param name="vvd_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="bkg_ofc_cd" type="12" value="" out="N"/>
				<param name="bkg_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
