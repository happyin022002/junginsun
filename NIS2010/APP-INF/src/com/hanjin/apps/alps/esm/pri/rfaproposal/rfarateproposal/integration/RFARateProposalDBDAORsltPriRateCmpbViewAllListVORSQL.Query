<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="RFARateProposalDBDAORsltPriRateCmpbViewAllListVORSQL">
			<desc><![CDATA[   ESM_PRI_6047]]></desc>
			<sql><![CDATA[
WITH VW_PRI_RP_SCP_RT_CMDT  AS (
	SELECT 	 CMDT.PROP_NO,CMDT.AMDT_SEQ
		,CMDT.SVC_SCP_CD 
		,CMDT.CMDT_HDR_SEQ 
		,SUBSTR(MAX(SYS_CONNECT_BY_PATH(PRC_CMDT_DEF_CD , '; ')),3) AS PRC_CMDT_DEF_CD 
		,SUBSTR(MAX(SYS_CONNECT_BY_PATH(REPLACE(PRC_CMDT_DEF_NM,';',':') , '; ')),3) AS PRC_CMDT_DEF_NM
	FROM (
		SELECT PROP_NO,AMDT_SEQ,SVC_SCP_CD
			,CMDT_HDR_SEQ
			,CMDT_SEQ,PRC_CMDT_DEF_CD
            ,DECODE(PRC_CMDT_TP_CD
                ,'G'
                ,(
                        SELECT PRC_GRP_CMDT_DESC
                        FROM PRI_RP_SCP_GRP_CMDT
                        WHERE PROP_NO = A.PROP_NO
                        AND AMDT_SEQ = A.AMDT_SEQ
                        AND SVC_SCP_CD = A.SVC_SCP_CD
                        AND PRC_GRP_CMDT_CD = A.PRC_CMDT_DEF_CD
                        AND ROWNUM = 1
                 )
                ,'R'
                ,(      SELECT REP_CMDT_NM
                        FROM MDM_REP_CMDT
                        WHERE REP_CMDT_CD = A.PRC_CMDT_DEF_CD
                        AND ROWNUM = 1
                  )
                ,'C'
                ,(
                        SELECT CMDT_NM
                        FROM MDM_COMMODITY
                        WHERE CMDT_CD = A.PRC_CMDT_DEF_CD
                        AND ROWNUM = 1
                 )
            ) AS PRC_CMDT_DEF_NM
			,ROW_NUMBER() OVER(PARTITION BY PROP_NO
							,AMDT_SEQ
							,SVC_SCP_CD 
							,CMDT_HDR_SEQ
						ORDER BY PRC_CMDT_TP_CD DESC,PROP_NO
							,AMDT_SEQ
							,SVC_SCP_CD 
							,CMDT_HDR_SEQ
							,CMDT_SEQ) AS RN
		FROM PRI_RP_SCP_RT_CMDT A
		WHERE PROP_NO = @[prop_no]
			AND AMDT_SEQ = @[amdt_seq]
			AND SVC_SCP_CD = @[svc_scp_cd]
	) CMDT
	START WITH RN = 1 
	CONNECT BY PRIOR CMDT.CMDT_HDR_SEQ = CMDT.CMDT_HDR_SEQ 
		AND PRIOR  CMDT.RN = CMDT.RN - 1
	GROUP BY CMDT.PROP_NO
		,CMDT.AMDT_SEQ
		,CMDT.SVC_SCP_CD
		,CMDT.CMDT_HDR_SEQ
)
,
VW_PRI_RP_SCP_RT_ACT_CUST  AS (
	SELECT 	 ACT_CUST.PROP_NO,ACT_CUST.AMDT_SEQ
		,ACT_CUST.SVC_SCP_CD 
		,ACT_CUST.CMDT_HDR_SEQ 
		,SUBSTR(MAX(SYS_CONNECT_BY_PATH(CUST_CD , '; ')),3) AS CUST_CD 
		,SUBSTR(MAX(SYS_CONNECT_BY_PATH(REPLACE(CUST_NM,';',':') , '; ')),3) AS CUST_NM
	FROM (
		SELECT PROP_NO,AMDT_SEQ,SVC_SCP_CD
			,CMDT_HDR_SEQ
			,ACT_CUST_SEQ
            ,CUST_CNT_CD || TO_CHAR(CUST_SEQ,'FM0000000') AS CUST_CD
	        ,(
                SELECT CUST_LGL_ENG_NM
                FROM MDM_CUSTOMER
                WHERE CUST_CNT_CD = A.CUST_CNT_CD
                AND CUST_SEQ = A.CUST_SEQ
                AND ROWNUM = 1
        	) AS CUST_NM
			,ROW_NUMBER() OVER(PARTITION BY PROP_NO
							,AMDT_SEQ
							,SVC_SCP_CD 
							,CMDT_HDR_SEQ
						ORDER BY PROP_NO
							,AMDT_SEQ
							,SVC_SCP_CD 
							,CMDT_HDR_SEQ
							,ACT_CUST_SEQ) AS RN
		FROM PRI_RP_SCP_RT_ACT_CUST A
		WHERE PROP_NO = @[prop_no]
			AND AMDT_SEQ = @[amdt_seq]
			AND SVC_SCP_CD = @[svc_scp_cd]
	) ACT_CUST
	START WITH RN = 1 
	CONNECT BY PRIOR ACT_CUST.CMDT_HDR_SEQ = ACT_CUST.CMDT_HDR_SEQ 
		AND PRIOR  ACT_CUST.RN = ACT_CUST.RN - 1
	GROUP BY ACT_CUST.PROP_NO
		,ACT_CUST.AMDT_SEQ
		,ACT_CUST.SVC_SCP_CD
		,ACT_CUST.CMDT_HDR_SEQ
),
VW_PRI_RP_SCP_RT_ROUT_PNT_ORI AS (
 	SELECT  ROUT_PNT.PROP_NO,ROUT_PNT.AMDT_SEQ
		,ROUT_PNT.SVC_SCP_CD 
		,ROUT_PNT.CMDT_HDR_SEQ, ROUT_PNT.ROUT_SEQ
		,ROUT_PNT.ORG_DEST_TP_CD
		, SUBSTR(MAX(SYS_CONNECT_BY_PATH(ROUT_PNT_LOC_DEF_CD || DECODE(TERM_NM,'','','(' || TERM_NM || ')') , '; ')),3) AS ROUT_PNT_LOC_DEF_CD 
	FROM (
		SELECT PROP_NO,AMDT_SEQ	,SVC_SCP_CD
			,CMDT_HDR_SEQ
			,ROUT_SEQ ,ROUT_PNT_LOC_DEF_CD
			,ORG_DEST_TP_CD
			,ROW_NUMBER() OVER(PARTITION BY PROP_NO
							,AMDT_SEQ
							,SVC_SCP_CD 
							,CMDT_HDR_SEQ
							,ROUT_SEQ
							,ORG_DEST_TP_CD
						ORDER BY PROP_NO
							,AMDT_SEQ
							,SVC_SCP_CD 
							,CMDT_HDR_SEQ
							,ROUT_PNT_SEQ) AS RN
			,(SELECT INTG_CD_VAL_DP_DESC FROM COM_INTG_CD_DTL CODE WHERE CODE.INTG_CD_ID = 'CD02070' AND INTG_CD_VAL_CTNT = RCV_DE_TERM_CD) as TERM_NM 
		FROM PRI_RP_SCP_RT_ROUT_PNT 
		WHERE PROP_NO = @[prop_no]
			AND AMDT_SEQ = @[amdt_seq]
			AND SVC_SCP_CD = @[svc_scp_cd]
			AND ORG_DEST_TP_CD = 'O'
			
	) ROUT_PNT
	START WITH RN = 1 
	CONNECT BY PRIOR ROUT_PNT.ROUT_SEQ = ROUT_PNT.ROUT_SEQ 
		AND PRIOR ROUT_PNT.ORG_DEST_TP_CD = ROUT_PNT.ORG_DEST_TP_CD 
		AND PRIOR  ROUT_PNT.RN = ROUT_PNT.RN - 1
	GROUP BY ROUT_PNT.PROP_NO
		,ROUT_PNT.AMDT_SEQ
		,ROUT_PNT.SVC_SCP_CD
		,ROUT_PNT.CMDT_HDR_SEQ
		,ROUT_PNT.ROUT_SEQ
		,ROUT_PNT.ORG_DEST_TP_CD
 ),
 VW_PRI_RP_SCP_RT_ROUT_PNT_DEST AS (
 	SELECT  ROUT_PNT.PROP_NO,ROUT_PNT.AMDT_SEQ
		,ROUT_PNT.SVC_SCP_CD 
		,ROUT_PNT.CMDT_HDR_SEQ, ROUT_PNT.ROUT_SEQ
		,ROUT_PNT.ORG_DEST_TP_CD
		, SUBSTR(MAX(SYS_CONNECT_BY_PATH(ROUT_PNT_LOC_DEF_CD || DECODE(TERM_NM,'','','(' || TERM_NM || ')') , '; ')),3) AS ROUT_PNT_LOC_DEF_CD 
	FROM (
		SELECT PROP_NO,AMDT_SEQ	,SVC_SCP_CD
			,CMDT_HDR_SEQ
			,ROUT_SEQ ,ROUT_PNT_LOC_DEF_CD
			,ORG_DEST_TP_CD
			,ROW_NUMBER() OVER(PARTITION BY PROP_NO
							,AMDT_SEQ
							,SVC_SCP_CD 
							,CMDT_HDR_SEQ
							,ROUT_SEQ
							,ORG_DEST_TP_CD
						ORDER BY PROP_NO
							,AMDT_SEQ
							,SVC_SCP_CD 
							,CMDT_HDR_SEQ
							,ROUT_PNT_SEQ) AS RN
			,(SELECT INTG_CD_VAL_DP_DESC FROM COM_INTG_CD_DTL CODE WHERE CODE.INTG_CD_ID = 'CD02070' AND INTG_CD_VAL_CTNT = RCV_DE_TERM_CD) as TERM_NM 
		FROM PRI_RP_SCP_RT_ROUT_PNT 
		WHERE PROP_NO = @[prop_no]
			AND AMDT_SEQ = @[amdt_seq]
			AND SVC_SCP_CD = @[svc_scp_cd]
			AND ORG_DEST_TP_CD = 'D'
	) ROUT_PNT
	START WITH RN = 1 
	CONNECT BY PRIOR ROUT_PNT.ROUT_SEQ = ROUT_PNT.ROUT_SEQ 
		AND PRIOR ROUT_PNT.ORG_DEST_TP_CD = ROUT_PNT.ORG_DEST_TP_CD 
		AND PRIOR  ROUT_PNT.RN = ROUT_PNT.RN - 1
	GROUP BY ROUT_PNT.PROP_NO
		,ROUT_PNT.AMDT_SEQ
		,ROUT_PNT.SVC_SCP_CD
		,ROUT_PNT.CMDT_HDR_SEQ
		,ROUT_PNT.ROUT_SEQ
		,ROUT_PNT.ORG_DEST_TP_CD
),
VW_PRI_RP_SCP_RT_ROUT_VIA_ORI AS (
	SELECT 	 ROUT_VIA.PROP_NO,ROUT_VIA.AMDT_SEQ
		,ROUT_VIA.SVC_SCP_CD 
		,ROUT_VIA.CMDT_HDR_SEQ, ROUT_VIA.ROUT_SEQ
		,ROUT_VIA.ORG_DEST_TP_CD
		,SUBSTR(MAX(SYS_CONNECT_BY_PATH(ROUT_VIA_PORT_DEF_CD , '; ')),3) AS ROUT_VIA_PORT_DEF_CD 
	FROM (
		SELECT PROP_NO,AMDT_SEQ,SVC_SCP_CD
			,CMDT_HDR_SEQ
			,ROUT_SEQ,ROUT_VIA_PORT_DEF_CD
			,ORG_DEST_TP_CD
			,ROW_NUMBER() OVER(PARTITION BY PROP_NO
							,AMDT_SEQ
							,SVC_SCP_CD 
							,CMDT_HDR_SEQ
							,ROUT_SEQ
							,ORG_DEST_TP_CD
						ORDER BY PROP_NO
							,AMDT_SEQ
							,SVC_SCP_CD 
							,CMDT_HDR_SEQ
							,ROUT_VIA_SEQ) AS RN
		FROM PRI_RP_SCP_RT_ROUT_VIA 
		WHERE PROP_NO = @[prop_no]
			AND AMDT_SEQ = @[amdt_seq]
			AND SVC_SCP_CD = @[svc_scp_cd]
			AND ORG_DEST_TP_CD = 'O'
	) ROUT_VIA
	START WITH RN = 1 
	CONNECT BY PRIOR ROUT_VIA.ROUT_SEQ = ROUT_VIA.ROUT_SEQ 
		AND PRIOR ROUT_VIA.ORG_DEST_TP_CD = ROUT_VIA.ORG_DEST_TP_CD 
		AND PRIOR  ROUT_VIA.RN = ROUT_VIA.RN - 1
	GROUP BY ROUT_VIA.PROP_NO
		,ROUT_VIA.AMDT_SEQ
		,ROUT_VIA.SVC_SCP_CD
		,ROUT_VIA.CMDT_HDR_SEQ
		,ROUT_VIA.ROUT_SEQ
		,ROUT_VIA.ORG_DEST_TP_CD

),
VW_PRI_RP_SCP_RT_ROUT_VIA_DEST AS (
	SELECT 	 ROUT_VIA.PROP_NO,ROUT_VIA.AMDT_SEQ
		,ROUT_VIA.SVC_SCP_CD 
		,ROUT_VIA.CMDT_HDR_SEQ, ROUT_VIA.ROUT_SEQ
		,ROUT_VIA.ORG_DEST_TP_CD
		,SUBSTR(MAX(SYS_CONNECT_BY_PATH(ROUT_VIA_PORT_DEF_CD , '; ')),3) AS ROUT_VIA_PORT_DEF_CD 
	FROM (
		SELECT PROP_NO,AMDT_SEQ,SVC_SCP_CD
			,CMDT_HDR_SEQ
			,ROUT_SEQ,ROUT_VIA_PORT_DEF_CD
			,ORG_DEST_TP_CD
			,ROW_NUMBER() OVER(PARTITION BY PROP_NO
							,AMDT_SEQ
							,SVC_SCP_CD 
							,CMDT_HDR_SEQ
							,ROUT_SEQ
							,ORG_DEST_TP_CD
						ORDER BY PROP_NO
							,AMDT_SEQ
							,SVC_SCP_CD 
							,CMDT_HDR_SEQ
							,ROUT_VIA_SEQ) AS RN
		FROM PRI_RP_SCP_RT_ROUT_VIA 
		WHERE PROP_NO = @[prop_no]
			AND AMDT_SEQ = @[amdt_seq]
			AND SVC_SCP_CD = @[svc_scp_cd]
			AND ORG_DEST_TP_CD = 'D'
	) ROUT_VIA
	START WITH RN = 1 
	CONNECT BY PRIOR ROUT_VIA.ROUT_SEQ = ROUT_VIA.ROUT_SEQ 
		AND PRIOR ROUT_VIA.ORG_DEST_TP_CD = ROUT_VIA.ORG_DEST_TP_CD 
		AND PRIOR  ROUT_VIA.RN = ROUT_VIA.RN - 1
	GROUP BY ROUT_VIA.PROP_NO
		,ROUT_VIA.AMDT_SEQ
		,ROUT_VIA.SVC_SCP_CD
		,ROUT_VIA.CMDT_HDR_SEQ
		,ROUT_VIA.ROUT_SEQ
		,ROUT_VIA.ORG_DEST_TP_CD

) ,
VW_PRI_ROUT AS (
	SELECT PROP_NO,AMDT_SEQ,SVC_SCP_CD,CMDT_HDR_SEQ,ROUT_SEQ
		,	MAX(DECODE(TP_CD,1,DEF_CD,NULL))  AS ORI_ROUT_PNT_LOC_DEF_CD
		,	MAX(DECODE(TP_CD,2,DEF_CD,NULL))  AS DST_ROUT_PNT_LOC_DEF_CD
		,	MAX(DECODE(TP_CD,3,DEF_CD,NULL))  AS ORI_ROUT_VIA_PORT_DEF_CD
		,	MAX(DECODE(TP_CD,4,DEF_CD,NULL))  AS DST_ROUT_VIA_PORT_DEF_CD
	FROM (
		SELECT 
			PROP_NO
			,AMDT_SEQ
			,SVC_SCP_CD
			,CMDT_HDR_SEQ
			,ROUT_SEQ
			,ORG_DEST_TP_CD
			,ROUT_PNT_LOC_DEF_CD AS DEF_CD
			, 1 AS TP_CD
		FROM 	VW_PRI_RP_SCP_RT_ROUT_PNT_ORI
		UNION ALL
		SELECT 
			PROP_NO
			,AMDT_SEQ
			,SVC_SCP_CD
			,CMDT_HDR_SEQ
			,ROUT_SEQ
			,ORG_DEST_TP_CD
			,ROUT_PNT_LOC_DEF_CD
			, 2 AS TP_CD
		FROM 	VW_PRI_RP_SCP_RT_ROUT_PNT_DEST
		UNION ALL
		SELECT 
			PROP_NO
			,AMDT_SEQ
			,SVC_SCP_CD
			,CMDT_HDR_SEQ
			,ROUT_SEQ
			,ORG_DEST_TP_CD
			,ROUT_VIA_PORT_DEF_CD
			, 3 AS TP_CD
		FROM 	VW_PRI_RP_SCP_RT_ROUT_VIA_ORI
		UNION ALL
		SELECT 
			PROP_NO
			,AMDT_SEQ
			,SVC_SCP_CD
			,CMDT_HDR_SEQ
			,ROUT_SEQ
			,ORG_DEST_TP_CD
			,ROUT_VIA_PORT_DEF_CD
			, 4 AS TP_CD
		FROM 	VW_PRI_RP_SCP_RT_ROUT_VIA_DEST
	)
	GROUP BY PROP_NO,AMDT_SEQ,SVC_SCP_CD,CMDT_HDR_SEQ,ROUT_SEQ
)

SELECT PROP_NO,AMDT_SEQ,SVC_SCP_CD,CMDT_HDR_SEQ,ROUT_SEQ,RT_SEQ
	,PRC_CMDT_DEF_CD
	,PRC_CMDT_DEF_NM
	,CUST_CD
	,CUST_NM
	,ORI_ROUT_PNT_LOC_DEF_CD
	,DST_ROUT_PNT_LOC_DEF_CD
	,ORI_ROUT_VIA_PORT_DEF_CD
	,DST_ROUT_VIA_PORT_DEF_CD
	,RAT_UT_CD, PRC_CGO_TP_CD
	,CURR_CD, PROP_FRT_RT_AMT
	, PRS_SCG_AMT, PRS_RESPB_CM_UC_AMT
	, PRS_RESPB_CMPB_AMT, PRS_GID_CMPB_AMT
	, DIFF
	, PRS_RESPB_OPFIT_UC_AMT,  PRS_RESPB_OPB_AMT
FROM (
	SELECT RT.PROP_NO,RT.AMDT_SEQ,RT.SVC_SCP_CD,RT.CMDT_HDR_SEQ,RT.ROUT_SEQ,RT.RT_SEQ
		,C.PRC_CMDT_DEF_CD
		,C.PRC_CMDT_DEF_NM
		,ACT_CUST.CUST_CD
		,ACT_CUST.CUST_NM
		,ROUT.ORI_ROUT_PNT_LOC_DEF_CD
		,ROUT.DST_ROUT_PNT_LOC_DEF_CD
		,ROUT.ORI_ROUT_VIA_PORT_DEF_CD
		,ROUT.DST_ROUT_VIA_PORT_DEF_CD
		,RT.RAT_UT_CD, RT.PRC_CGO_TP_CD
		,RT.CURR_CD, RT.PROP_FRT_RT_AMT
		, RT.PRS_SCG_AMT, RT.PRS_RESPB_CM_UC_AMT
		, RT.PRS_RESPB_CMPB_AMT, RT.PRS_GID_CMPB_AMT
		, PRS_RESPB_CMPB_AMT - RT.PRS_GID_CMPB_AMT AS DIFF
		, RT.PRS_RESPB_OPFIT_UC_AMT, RT. PRS_RESPB_OPB_AMT
	FROM PRI_RP_SCP_RT RT
		, VW_PRI_RP_SCP_RT_CMDT C
		, VW_PRI_RP_SCP_RT_ACT_CUST ACT_CUST
		, VW_PRI_ROUT ROUT
	WHERE RT.PROP_NO = C.PROP_NO
		AND RT.AMDT_SEQ = C.AMDT_SEQ
		AND RT.SVC_SCP_CD = C.SVC_SCP_CD
		AND RT.CMDT_HDR_SEQ = C.CMDT_HDR_SEQ
		AND RT.PROP_NO = ACT_CUST.PROP_NO(+)
		AND RT.AMDT_SEQ = ACT_CUST.AMDT_SEQ(+)
		AND RT.SVC_SCP_CD = ACT_CUST.SVC_SCP_CD(+)
		AND RT.CMDT_HDR_SEQ = ACT_CUST.CMDT_HDR_SEQ(+)
		AND RT.PROP_NO = ROUT.PROP_NO
		AND RT.AMDT_SEQ = ROUT.AMDT_SEQ
		AND RT.SVC_SCP_CD = ROUT.SVC_SCP_CD
		AND RT.CMDT_HDR_SEQ = ROUT.CMDT_HDR_SEQ
		AND RT.ROUT_SEQ = ROUT.ROUT_SEQ
		AND RT.PROP_NO = @[prop_no]
		AND RT.AMDT_SEQ = @[amdt_seq]
		AND RT.SVC_SCP_CD = @[svc_scp_cd]
)			]]></sql>
			<params>
				<param name="prop_no" type="12" value="" out="N"/>
				<param name="amdt_seq" type="2" value="" out="N"/>
				<param name="svc_scp_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
