<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="UsaCustomsReportDBDAOsearchTransmissionCheckListByVVDRSQL">
			<desc><![CDATA[dwkim, 0359 Manifest Status 조회용]]></desc>
			<sql><![CDATA[
SELECT DENSE_RANK() OVER(ORDER BY MBL_NO, ams_file_no) seq,
	gubun, ams_file_no, m_f, 
	filer, mbl_no, o_pol, 
	t_pol, t_pod, t_vvd, 
	sts, v_mi, mi, 
	vvd, sent_time, curr_stage, 
	update_dt, b_ofc, cntr_no, 
	mf_sts, user_action, t_vvd2, 
	t_pol2, filer2, 
	' ' tmp1, ' ' tmp2, ' ' tmp3
FROM (
	SELECT '00' gubun,
		B.BL_NO ams_file_no, 'M' m_f,
		B.USA_CSTMS_FILE_CD filer,
		B.BL_NO mbl_no,
		F.POL_CD o_pol,
		A2.POL_CD t_pol,
		A2.POD_CD t_pod,
		B.VSL_CD || B.SKD_VOY_NO || B.SKD_DIR_CD t_vvd, 
		B.BKG_STS_CD sts,
		DECODE(E.SND_DT, null, 'N', 'Y') v_mi, 
		DECODE(F.MF_SND_DT, null, 'N', 'Y') mi,
		F.VSL_CD || F.SKD_VOY_NO || F.SKD_DIR_CD vvd,               
		TO_CHAR(F.MF_SND_DT, 'YYYY-MM-DD HH24:MI') sent_time,
		F.CSTMS_MF_TP_CD curr_stage,
		DECODE(F.CSTMS_MF_TP_CD, 'MI', TO_CHAR(F.MF_SND_DT, 'YYYY-MM-DD HH24:MI'), 'AI', TO_CHAR(F.AMDT_SND_DT, 'YYYY-MM-DD HH24:MI')) update_dt,
		B.BKG_OFC_CD b_ofc,
		D.CNTR_NO cntr_no,
		CASE WHEN F.MF_SND_DT is NOT null AND F.AMDT_SND_DT is null THEN
			'Sent By MI'
		WHEN F.MF_SND_DT is NOT null AND F.AMDT_SND_DT is NOT null THEN
			'Sent By MI'
		WHEN F.MF_SND_DT is null AND F.AMDT_SND_DT is NOT null THEN
			'Added By AI'
		WHEN F.MF_SND_DT is null AND F.AMDT_SND_DT is null THEN
			'Un-Manifested'
		ELSE
			'Error'
		END mf_sts,
		CASE WHEN F.VSL_CD is null THEN 
			'ADD'
		WHEN F.VSL_CD || F.SKD_VOY_NO || F.SKD_DIR_CD || F.CSTMS_POL_CD || F.CSTMS_POD_CD
			<> B.VSL_CD || B.SKD_VOY_NO || B.SKD_DIR_CD || B.POL_CD || B.POD_CD THEN
			--'Roll Over'
			'None'
		ELSE
			'None'
		END user_action,
		'' t_vvd2, '' t_pol2, '' filer2
        ,A2.VSL_CD
        ,A2.SKD_VOY_NO
        ,A2.SKD_DIR_CD
	FROM BKG_VVD A, BKG_VVD A2, BKG_BOOKING B, BKG_BL_DOC C, BKG_CONTAINER D, BKG_CSTMS_ADV_SND_LOG E, BKG_CSTMS_ADV_BL F, MDM_LOCATION L2
	WHERE A.VSL_CD					= SUBSTR(@[vvd], 1, 4)
		AND A.SKD_VOY_NO			= SUBSTR(@[vvd], 5, 4)
		AND A.SKD_DIR_CD			= SUBSTR(@[vvd], 9, 1)
	#if (${pol} != '') 
		AND A.POL_CD				= @[pol]
	#end
		AND A.BKG_NO				= A2.BKG_NO
		AND A2.VSL_PRE_PST_CD		= 'T'
	#if (${pod} != '') 
		AND A2.POD_CD				= @[pod]
	#end
		--조회대상 query 수정 : 현재는 ASIA 향 B/L 까지 조회가 됩니다.
		-- a. POD가 US 이거나
		-- b. US T/S 이거나
		-- c. US FROB
		-- 10/09 하수석, 아래내용을 MDM_LOCATION.CONTI_CD = 'M'인 조건으로 수정함.(멕시코가 조회안되는 사유)
		--AND (A.POD_CD like 'US%' or A.POD_CD like 'CA%' or A2.POD_CD like 'US%' or A2.POD_CD like 'CA%')
		AND A2.POD_CD = L2.LOC_CD AND L2.CONTI_CD = 'M'
	#if (${trunkfirst} == 'S') 
		AND A.POL_CD				= B.POL_CD
	#else 
		AND A.VSL_PRE_PST_CD		= 'T'
	#end
		AND B.BKG_NO				= A.BKG_NO
		AND B.BKG_CGO_TP_CD 		IN ('R', 'F')
		AND B.BKG_STS_CD			<> 'X'
		--AND (B.BKG_STS_CD = 'X'  AND  ( F.MF_STS_CD <> 'D'  OR  F.AMDT_SND_DT IS NULL ))
	#if (${bofc} != '')
		AND B.BKG_OFC_CD			= @[bofc]
	#end
		AND C.BKG_NO				= B.BKG_NO
		AND D.BKG_NO(+)				= C.BKG_NO
		AND F.CNT_CD(+)				= 'US'
		AND F.BL_NO(+)				= B.BL_NO
		AND E.CNT_CD(+)				= 'US'
		AND E.VSL_CD(+)				= A.VSL_CD
		AND E.SKD_VOY_NO(+)			= A.SKD_VOY_NO
		AND E.SKD_DIR_CD(+)			= A.SKD_DIR_CD
		AND E.POL_CD(+)				= A.POL_CD
		AND E.POD_CD(+)				= A.POD_CD
		AND E.TRSM_MSG_TP_ID(+)		= 'MI'
		AND E.IO_BND_CD(+)			= 'I'
		AND E.DELT_FLG(+)			= 'N'
	UNION ALL
	SELECT TO_CHAR(G.HBL_SEQ),
		G.CNTR_MF_NO ams_file_no, 'H',
		--B.USA_CSTMS_FILE_CD filer,
		--2009/10/07 H.B/L Filer 는 null 이어야 함 BY jung
		'0' filer,
		B.BL_NO mbl_no,
		B.POL_CD o_pol,
		A2.POL_CD t_pol,
		A2.POD_CD t_pod,
		B.VSL_CD || B.SKD_VOY_NO || B.SKD_DIR_CD t_vvd, 
		B.BKG_STS_CD sts,
		DECODE(E.SND_DT, null, 'N', 'Y') v_mi, 
		DECODE(F.MF_SND_DT, null, 'N', 'Y') mi,
		F.VSL_CD || F.SKD_VOY_NO || F.SKD_DIR_CD vvd,               
		TO_CHAR(F.MF_SND_DT, 'YYYY-MM-DD HH24:MI') sent_time,
		F.CSTMS_MF_TP_CD curr_stage,
		DECODE(F.CSTMS_MF_TP_CD, 'MI', TO_CHAR(F.MF_SND_DT, 'YYYY-MM-DD HH24:MI'), 'AI', TO_CHAR(F.AMDT_SND_DT, 'YYYY-MM-DD HH24:MI')) update_dt,
		B.BKG_OFC_CD b_ofc,
		D.CNTR_NO cntr_no,
		CASE WHEN F.MF_SND_DT is NOT null AND F.AMDT_SND_DT is null THEN
			'Sent By MI'
		WHEN F.MF_SND_DT is NOT null AND F.AMDT_SND_DT is NOT null THEN
			'Sent By MI'
		WHEN F.MF_SND_DT is null AND F.AMDT_SND_DT is NOT null THEN
			'Added By AI'
		WHEN F.MF_SND_DT is null AND F.AMDT_SND_DT is null THEN
			'Un-Manifested'
		ELSE
			'Error'
		END mf_sts,
		CASE WHEN F.VSL_CD is null THEN 
			'ADD'
		WHEN F.VSL_CD || F.SKD_VOY_NO || F.SKD_DIR_CD || F.CSTMS_POL_CD || F.CSTMS_POD_CD
			<> A.VSL_CD || A.SKD_VOY_NO || A.SKD_DIR_CD || A.POL_CD || A.POD_CD THEN
			'Roll Over'
		ELSE
			'None'
		END user_action,
		'' t_vvd2, '' t_pol2, '' filer2
        ,A2.VSL_CD
        ,A2.SKD_VOY_NO
        ,A2.SKD_DIR_CD
	FROM BKG_VVD A, BKG_VVD A2, BKG_BOOKING B, BKG_BL_DOC C, BKG_HBL G, BKG_CNTR_MF_DESC D, BKG_CSTMS_ADV_SND_LOG E, BKG_CSTMS_ADV_BL F, MDM_LOCATION L2
	WHERE A.VSL_CD					= SUBSTR(@[vvd], 1, 4)
		AND A.SKD_VOY_NO			= SUBSTR(@[vvd], 5, 4)
		AND A.SKD_DIR_CD			= SUBSTR(@[vvd], 9, 1)
	#if (${pol} != '') 
		AND A.POL_CD				= @[pol]
	#end
		AND A.BKG_NO				= A2.BKG_NO
		AND A2.VSL_PRE_PST_CD		= 'T'
	#if (${pod} != '') 
		AND A2.POD_CD				= @[pod]
	#end
		--조회대상 query 수정 : 현재는 ASIA 향 B/L 까지 조회가 됩니다.
		-- a. POD가 US 이거나
		-- b. US T/S 이거나
		-- c. US FROB
		-- 10/09 하수석, 아래내용을 MDM_LOCATION.CONTI_CD = 'M'인 조건으로 수정함.(멕시코가 조회안되는 사유)
		--AND (A.POD_CD like 'US%' or A.POD_CD like 'CA%' or A2.POD_CD like 'US%' or A2.POD_CD like 'CA%')
		AND A2.POD_CD = L2.LOC_CD AND L2.CONTI_CD = 'M'
	#if (${trunkfirst} == 'S') 
		AND A.POL_CD				= B.POL_CD
	#else 
		AND A.VSL_PRE_PST_CD		= 'T'
	#end
		AND B.BKG_NO				= A.BKG_NO
		AND B.BKG_CGO_TP_CD			IN ('R', 'F')
		AND B.BKG_STS_CD			<> 'X'
		--AND (B.BKG_STS_CD = 'X'  AND  ( F.MF_STS_CD <> 'D'  OR  F.AMDT_SND_DT IS NULL ))
	#if (${bofc} != '')
		AND B.BKG_OFC_CD			= @[bofc]
	#end
		AND C.BKG_NO				= B.BKG_NO
		--as-IS에서는 아래 조건이 사용되나, TO-BE에서 다운로드 화면과 조회수량이 차이가 나므로 아래 조건을 블록한다. 
	    -- 20100531 블록을 다시 활성화
		AND B.USA_CSTMS_FILE_CD 	= '1'
		AND G.BKG_NO				= C.BKG_NO
		AND F.CNT_CD(+)				= 'US'
		AND F.BL_NO(+)				= G.CNTR_MF_NO
		AND F.BKG_NO(+)				= G.BKG_NO
		AND E.CNT_CD(+)				= 'US'
		AND E.VSL_CD(+)				= A.VSL_CD
		AND E.SKD_VOY_NO(+)			= A.SKD_VOY_NO
		AND E.SKD_DIR_CD(+)			= A.SKD_DIR_CD
		AND E.POL_CD(+)				= A.POL_CD
		AND E.POD_CD(+)				= A.POD_CD
		AND E.TRSM_MSG_TP_ID(+)		= 'MI'
		AND E.IO_BND_CD(+)			= 'I'
		AND E.DELT_FLG(+)			= 'N'
		AND D.BKG_NO(+)				= G.BKG_NO
		AND D.CNTR_MF_NO(+)			= G.CNTR_MF_NO
) A
, VSK_VSL_PORT_SKD SKD
WHERE  1 = 1
  AND  A.VSL_CD = SKD.VSL_CD
  AND  A.SKD_VOY_NO = SKD.SKD_VOY_NO
  AND  A.SKD_DIR_CD = SKD.SKD_DIR_CD
  AND  A.T_POD      = SKD.VPS_PORT_CD
  AND  SKD.CLPT_IND_SEQ = 1
  AND  SKD.CLPT_SEQ >= @[min_seq]
#if (${allerror} != 'ALL') 
	AND VVD != T_VVD
#end
#if (${blmi} == 'Manifested') 
	AND (mf_sts = 'Sent By MI' OR mf_sts = 'Added By AI')
#elseif (${blmi} != '') 
	AND mf_sts = @[blmi]
#end

AND NOT EXISTS (
                    SELECT 'Y'
                    FROM BKG_BOOKING 
                    WHERE FM_BKG_NO = A.MBL_NO
                    AND BL_NO_TP = '9'
                )

ORDER BY mbl_no, gubun			]]></sql>
			<params>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="pol" type="12" value="" out="N"/>
				<param name="pod" type="12" value="" out="N"/>
				<param name="bofc" type="12" value="" out="N"/>
				<param name="min_seq" type="12" value="" out="N"/>
				<param name="blmi" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
