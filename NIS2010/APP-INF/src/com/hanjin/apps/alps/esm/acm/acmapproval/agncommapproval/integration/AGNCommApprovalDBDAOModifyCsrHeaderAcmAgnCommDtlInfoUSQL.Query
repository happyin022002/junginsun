<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="AGNCommApprovalDBDAOModifyCsrHeaderAcmAgnCommDtlInfoUSQL">
			<desc><![CDATA[ACM_AGN_COMM_DTL에 데이터를 업데이트한다.]]></desc>
			<sql><![CDATA[
UPDATE /*+ bypass_ujvc */
         (     SELECT
                      A.BKG_NO,
                      A.AGN_CD,
                      A.IO_BND_CD,
                      A.AC_TP_CD,
                      A.AC_SEQ,
                      B.IF_DTRB_AMT + A.IF_DTRB_AMT  AS A_IF_DTRB_AMT,
                      B.PAY_IF_DTRB_AMT + A.PAY_IF_DTRB_AMT AS A_PAY_IF_DTRB_AMT,
                      A.CNTR_TPSZ_CD,
                      @[upd_usr_id]       AS A_UPD_USR_ID,
                      SYSDATE             AS A_UPD_DT,
                      B.BKG_NO,
                      B.AGN_CD,
                      B.IO_BND_CD,
                      B.AC_TP_CD,
                      B.AC_SEQ,
                      B.IF_DTRB_AMT  AS B_IF_DTRB_AMT,
                      B.PAY_IF_DTRB_AMT AS B_PAY_IF_DTRB_AMT,
                      B.CNTR_TPSZ_CD,
                      B.UPD_USR_ID        AS B_UPD_USR_ID,
                      B.UPD_DT            AS B_UPD_DT
                 FROM
                    (     SELECT
                                 A.BKG_NO,
                                 A.AGN_CD,
                                 A.IO_BND_CD,
                                 A.AC_TP_CD,
                                 A.AC_SEQ,
                                 A.IF_AMT      - SUM (B.IF_DTRB_AMT)  AS IF_DTRB_AMT,
                                 A.PAY_IF_AMT  - SUM (B.PAY_IF_DTRB_AMT) AS PAY_IF_DTRB_AMT,
                               (     SELECT
                                            X.CNTR_TPSZ_CD
                                       FROM BKG_QUANTITY X
                                      WHERE X.BKG_NO = A.BKG_NO
                                        AND ROWNUM   = 1
                               ) AS CNTR_TPSZ_CD
                            FROM ACM_AGN_COMM        A,
                                 ACM_AGN_COMM_DTL    B
                           WHERE A.BKG_NO            = B.BKG_NO
                             AND A.AGN_CD            = B.AGN_CD
                             AND A.IO_BND_CD         = B.IO_BND_CD
                             AND A.AC_TP_CD          = B.AC_TP_CD
                             AND A.AC_SEQ            = B.AC_SEQ
                             AND A.AR_OFC_CD         = @[ar_ofc_cd]
                             AND A.AGN_CD            = @[agn_cd]
                             AND A.CRE_USR_ID       != 'COST'
                             AND A.IF_DT         IS NULL
                             AND A.AC_STS_CD  		 = 'AS'
							#if(${aud_no} != '')
                             AND AUD_NO              = @[aud_no]
							#end
                        GROUP BY A.BKG_NO,
                                 A.AGN_CD,
                                 A.IO_BND_CD,
                                 A.AC_TP_CD,
                                 A.AC_SEQ,
                                 A.IF_AMT,
                                 A.PAY_IF_AMT
                          HAVING A.IF_AMT - SUM (B.IF_DTRB_AMT)+1 <> 0
                              OR A.PAY_IF_AMT - SUM (B.PAY_IF_DTRB_AMT) <> 0
                    ) A,
                      ACM_AGN_COMM_DTL    B
                WHERE A.BKG_NO        = B.BKG_NO
                  AND A.AGN_CD        = B.AGN_CD
                  AND A.IO_BND_CD     = B.IO_BND_CD
                  AND A.AC_TP_CD      = B.AC_TP_CD
                  AND A.AC_SEQ        = B.AC_SEQ
                  AND A.CNTR_TPSZ_CD  = B.CNTR_TPSZ_CD
         )
       SET B_IF_DTRB_AMT  = A_IF_DTRB_AMT,
           B_PAY_IF_DTRB_AMT = A_PAY_IF_DTRB_AMT,
           B_UPD_USR_ID        = A_UPD_USR_ID,
           B_UPD_DT            = A_UPD_DT			]]></sql>
			<params>
				<param name="upd_usr_id" type="12" value="" out="N"/>
				<param name="ar_ofc_cd" type="12" value="" out="N"/>
				<param name="agn_cd" type="12" value="" out="N"/>
				<param name="aud_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
