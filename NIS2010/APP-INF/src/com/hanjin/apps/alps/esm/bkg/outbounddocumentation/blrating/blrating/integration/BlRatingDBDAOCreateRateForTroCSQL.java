/*=========================================================
*Copyright(c) 2015 CyberLogitec
*@FileName : BlRatingDBDAOCreateRateForTroCSQL.java
*@FileTitle : 
*Open Issues :
*Change history :
*@LastModifyDate : 2015.08.11
*@LastModifier : 
*@LastVersion : 1.0
* 2015.08.11 
* 1.0 Creation
=========================================================*/
package com.hanjin.apps.alps.esm.bkg.outbounddocumentation.blrating.blrating.integration;

import java.util.HashMap;
import org.apache.log4j.Logger;
import com.hanjin.framework.support.db.ISQLTemplate;

/**
 *
 * @author 
 * @see DAO 참조
 * @since J2EE 1.6
 */

public class BlRatingDBDAOCreateRateForTroCSQL implements ISQLTemplate{

	private StringBuffer query = new StringBuffer();
	
	Logger log =Logger.getLogger(this.getClass());
	
	/** Parameters definition in params/param elements */
	private HashMap<String,String[]> params = null;
	
	/**
	  * <pre>
	  * BlRatingDBDAOCreateRateForTroCSQL
	  * </pre>
	  */
	public BlRatingDBDAOCreateRateForTroCSQL(){
		setQuery();
		params = new HashMap<String,String[]>();
		String tmp = null;
		String[] arrTmp = null;
		tmp = java.sql.Types.VARCHAR + ",N";
		arrTmp = tmp.split(",");
		if(arrTmp.length !=2){
			throw new IllegalArgumentException();
		}
		params.put("bkg_no",new String[]{arrTmp[0],arrTmp[1]});

		tmp = java.sql.Types.VARCHAR + ",N";
		arrTmp = tmp.split(",");
		if(arrTmp.length !=2){
			throw new IllegalArgumentException();
		}
		params.put("user_id",new String[]{arrTmp[0],arrTmp[1]});

		query.append("/*").append("\n"); 
		query.append("Path : com.hanjin.apps.alps.esm.bkg.outbounddocumentation.blrating.blrating.integration").append("\n"); 
		query.append("FileName : BlRatingDBDAOCreateRateForTroCSQL").append("\n"); 
		query.append("*/").append("\n"); 
	}
	
	public String getSQL(){
		return query.toString();
	}
	
	public HashMap<String,String[]> getParams() {
		return params;
	}

	/**
	 * Query 생성
	 */
	public void setQuery(){
		query.append("#if (${ca_flg} == 'Y')" ).append("\n"); 
		query.append("MERGE INTO BKG_RT_HIS RATE" ).append("\n"); 
		query.append("USING (" ).append("\n"); 
		query.append("    SELECT " ).append("\n"); 
		query.append("		@[bkg_no] AS BKG_NO," ).append("\n"); 
		query.append("		CORR_NO," ).append("\n"); 
		query.append("		'N' AS RT_BL_TP_CD," ).append("\n"); 
		query.append("		'P' AS FRT_TERM_CD," ).append("\n"); 
		query.append("		(SELECT CASE WHEN TAA_NO IS NOT NULL THEN 'T'" ).append("\n"); 
		query.append("            WHEN RFA_NO IS NOT NULL THEN 'R'" ).append("\n"); 
		query.append("            WHEN SC_NO  IS NOT NULL THEN 'S'" ).append("\n"); 
		query.append("            ELSE ''" ).append("\n"); 
		query.append("            END BKG_CTRT_TP_CD FROM BKG_BKG_HIS" ).append("\n"); 
		query.append("		WHERE BKG_NO = @[bkg_no]" ).append("\n"); 
		query.append("		AND   CORR_NO ='TMP0000001') BKG_CTRT_TP_CD," ).append("\n"); 
		query.append("		NVL((SELECT C.OFC_CD FROM BKG_BKG_HIS K, BKG_CHN_AGN C" ).append("\n"); 
		query.append("		              WHERE K.BKG_NO = @[bkg_no]" ).append("\n"); 
		query.append("		                AND K.CHN_AGN_CD = C.CHN_AGN_CD" ).append("\n"); 
		query.append("		                AND K.CORR_NO ='TMP0000001'" ).append("\n"); 
		query.append("						AND ROWNUM = 1" ).append("\n"); 
		query.append("		            ),P.OFC_CD) PPD_RCV_OFC_CD," ).append("\n"); 
		query.append("		CASE " ).append("\n"); 
		query.append("		WHEN F.F_PPD_PAYR_CNT_CD IS NOT NULL AND NVL(F.F_PPD_PAYR_CUST_SEQ,'') <> '0' THEN F.F_PPD_PAYR_CNT_CD" ).append("\n"); 
		query.append("		ELSE P.CUST_CNT_CD" ).append("\n"); 
		query.append("		END PPD_PAYR_CNT_CD," ).append("\n"); 
		query.append("		CASE " ).append("\n"); 
		query.append("		WHEN F.F_PPD_PAYR_CNT_CD IS NOT NULL AND NVL(F.F_PPD_PAYR_CUST_SEQ,'') <> '0' THEN F.F_PPD_PAYR_CUST_SEQ" ).append("\n"); 
		query.append("        ELSE P.CUST_SEQ " ).append("\n"); 
		query.append("        END PPD_PAYR_CUST_SEQ," ).append("\n"); 
		query.append("		C.OFC_CD CLT_OFC_CD," ).append("\n"); 
		query.append("		C.CUST_CNT_CD CLT_PAYR_CNT_CD," ).append("\n"); 
		query.append("		C.CUST_SEQ CLT_PAYR_CUST_SEQ," ).append("\n"); 
		query.append("        @[user_id] AS CRE_USR_ID," ).append("\n"); 
		query.append("        sysdate AS CRE_DT," ).append("\n"); 
		query.append("        @[user_id] AS UPD_USR_ID," ).append("\n"); 
		query.append("        sysdate AS UPD_DT" ).append("\n"); 
		query.append("		FROM (" ).append("\n"); 
		query.append("				SELECT ROWNUM,A.* FROM " ).append("\n"); 
		query.append("				(" ).append("\n"); 
		query.append("					--PPD" ).append("\n"); 
		query.append("					--Credit Customer Information 상 Credit Control Office" ).append("\n"); 
		query.append("					--(추가) Sales Office 의 국가 Code 와 Credit Control Office의 국가 Code 가 불일치시 비신용 화주 Logic 으로 처리" ).append("\n"); 
		query.append("					SELECT BKG.BKG_NO BKG_NO, BKG.CORR_NO," ).append("\n"); 
		query.append("					        11 AS FLG," ).append("\n"); 
		query.append("					        'S' AS BKG_CUST_TP_CD," ).append("\n"); 
		query.append("						    CR_CLT_OFC_CD AS OFC_CD," ).append("\n"); 
		query.append("					        BCUST.CUST_CNT_CD CUST_CNT_CD," ).append("\n"); 
		query.append("					        BCUST.CUST_SEQ CUST_SEQ," ).append("\n"); 
		query.append("					        BCUST.CUST_LGL_ENG_NM CUST_NM" ).append("\n"); 
		query.append("					FROM   MDM_CR_CUST CUST," ).append("\n"); 
		query.append("					       BKG_BKG_HIS BKG," ).append("\n"); 
		query.append("					       (SELECT S.CUST_CNT_CD, S.CUST_SEQ, C.CUST_LGL_ENG_NM" ).append("\n"); 
		query.append("					        FROM BKG_CUST_HIS S, " ).append("\n"); 
		query.append("					             MDM_CUSTOMER C" ).append("\n"); 
		query.append("					        WHERE  S.BKG_NO = @[bkg_no]" ).append("\n"); 
		query.append("					          AND S.BKG_CUST_TP_CD = 'S'" ).append("\n"); 
		query.append("					          AND S.CUST_CNT_CD = C.CUST_CNT_CD" ).append("\n"); 
		query.append("					          AND S.CUST_SEQ = C.CUST_SEQ" ).append("\n"); 
		query.append("							  AND C.DELT_FLG ='N'" ).append("\n"); 
		query.append("							  AND NVL(C.NMD_CUST_FLG,'N') ='N'" ).append("\n"); 
		query.append("							  AND S.CORR_NO ='TMP0000001'" ).append("\n"); 
		query.append("					        ) BCUST," ).append("\n"); 
		query.append("					        MDM_ORGANIZATION OB_SLS_OFC," ).append("\n"); 
		query.append("							MDM_ORGANIZATION CR_CLT_OFC	" ).append("\n"); 
		query.append("					WHERE  BKG.BKG_NO = @[bkg_no]" ).append("\n"); 
		query.append("					AND    BKG.CORR_NO ='TMP0000001'" ).append("\n"); 
		query.append("					AND    (CUST.CUST_CNT_CD, CUST.CUST_SEQ) = (SELECT CUST_CNT_CD, CUST_SEQ" ).append("\n"); 
		query.append("					                                    FROM   BKG_BKG_HIS B, BKG_CUST_HIS S" ).append("\n"); 
		query.append("					                                    WHERE  B.BKG_NO = @[bkg_no] " ).append("\n"); 
		query.append("					                                    AND S.BKG_NO = B.BKG_NO " ).append("\n"); 
		query.append("					                                    AND S.BKG_CUST_TP_CD = 'S'" ).append("\n"); 
		query.append("					                                    AND B.CORR_NO ='TMP0000001'" ).append("\n"); 
		query.append("					                                    AND S.CORR_NO ='TMP0000001'" ).append("\n"); 
		query.append("					                                    )" ).append("\n"); 
		query.append("					AND    0 < CUST.OB_CR_TERM_DYS" ).append("\n"); 
		query.append("					AND    CUST.CR_ST_DT  <= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BKG_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO ='TMP0000001')" ).append("\n"); 
		query.append("					AND    CUST.CR_END_DT >= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BKG_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO ='TMP0000001')" ).append("\n"); 
		query.append("					AND    CUST.DELT_FLG ='N'" ).append("\n"); 
		query.append("					AND    OB_SLS_OFC.OFC_CD = BKG.OB_SLS_OFC_CD " ).append("\n"); 
		query.append("					AND    CR_CLT_OFC.OFC_CD = CUST.CR_CLT_OFC_CD " ).append("\n"); 
		query.append("					AND    OB_SLS_OFC.DELT_FLG ='N'" ).append("\n"); 
		query.append("					AND    CR_CLT_OFC.DELT_FLG ='N'" ).append("\n"); 
		query.append("					AND    OB_SLS_OFC.VNDR_CNT_CD = CR_CLT_OFC.VNDR_CNT_CD" ).append("\n"); 
		query.append("					UNION" ).append("\n"); 
		query.append("					--PPD OFFICE CODE2" ).append("\n"); 
		query.append("					--미주지역본부의 경우(해당 Office 가 미주산하Office), 만약 L.Office 가 NYCWP 이고 비신용화주의 경우,Shipper Location 의 Financial Control Office " ).append("\n"); 
		query.append("					--  >>> 변경 2014.06.25  미주지역본부의 경우, 만약 L.Office 가 NYCWP, NYCME, NYCMW인 경우, NYCRA로 설정 > NYCME, NYCMW제외" ).append("\n"); 
		query.append("                    --  >>> 변경 L.Office가 NYCME 와 NYCMW 인 경우에는 화주별 assign 된 Sales office 를 collection office 로 변경 " ).append("\n"); 
		query.append("					--L.Office 가 지역본부이면(OFC_TP_CD ='QT') POR 의 Finance Control Office" ).append("\n"); 
		query.append("					--BKG 상 L.Office(Customer 의 Sale Rep 의 소속 Office)" ).append("\n"); 
		query.append("                    --(한국 본사 Office)L.Office가 한국지역이고 그 L.Office의 AR HQ Office가 SELHO이면, 화주의 Sales office로 설정" ).append("\n"); 
		query.append("					SELECT B.BKG_NO BKG_NO, B.CORR_NO," ).append("\n"); 
		query.append("					        12 AS FLG," ).append("\n"); 
		query.append("					        'S' AS BKG_CUST_TP_CD," ).append("\n"); 
		query.append("					        CASE WHEN SUBSTR(O.LOC_CD,1,2) ='US' AND B.OB_SLS_OFC_CD IN ('NYCWP') THEN 'NYCRA'" ).append("\n"); 
		query.append("                                 WHEN SUBSTR(O.LOC_CD,1,2) ='US' AND B.OB_SLS_OFC_CD IN ('NYCME','NYCMW') THEN C.OFC_CD" ).append("\n"); 
		query.append("                                 WHEN SUBSTR(O.LOC_CD,1,2) ='HQ' AND O.AR_HD_QTR_OFC_CD='SELHO' THEN NVL(C.OFC_CD, B.OB_SLS_OFC_CD)" ).append("\n"); 
		query.append("								 WHEN O.OFC_TP_CD ='QT' THEN L.FINC_CTRL_OFC_CD" ).append("\n"); 
		query.append("                                 ELSE B.OB_SLS_OFC_CD" ).append("\n"); 
		query.append("                                 END OFC_CD," ).append("\n"); 
		query.append("					        C.CUST_CNT_CD," ).append("\n"); 
		query.append("					        C.CUST_SEQ," ).append("\n"); 
		query.append("					        C.CUST_LGL_ENG_NM AS CUST_NM" ).append("\n"); 
		query.append("					FROM    BKG_BKG_HIS B," ).append("\n"); 
		query.append("					        BKG_CUST_HIS S," ).append("\n"); 
		query.append("							MDM_ORGANIZATION O," ).append("\n"); 
		query.append("							MDM_LOCATION L, --POR FINANCE OFFICE" ).append("\n"); 
		query.append("							MDM_LOCATION H, --SHIPPER FINNACE OFFICE" ).append("\n"); 
		query.append("							MDM_CUSTOMER C" ).append("\n"); 
		query.append("					WHERE  B.BKG_NO = @[bkg_no]" ).append("\n"); 
		query.append("					AND    S.BKG_NO = B.BKG_NO" ).append("\n"); 
		query.append("					AND    B.CORR_NO ='TMP0000001'" ).append("\n"); 
		query.append("					AND    S.CORR_NO ='TMP0000001'" ).append("\n"); 
		query.append("					AND    S.BKG_CUST_TP_CD = 'S'" ).append("\n"); 
		query.append("					AND    S.CUST_CNT_CD = C.CUST_CNT_CD" ).append("\n"); 
		query.append("					AND    S.CUST_SEQ = C.CUST_SEQ" ).append("\n"); 
		query.append("					AND    C.DELT_FLG ='N'" ).append("\n"); 
		query.append("					AND    O.DELT_FLG ='N'" ).append("\n"); 
		query.append("					AND    L.DELT_FLG ='N'" ).append("\n"); 
		query.append("					AND    H.DELT_FLG ='N'" ).append("\n"); 
		query.append("					AND    O.OFC_CD = B.OB_SLS_OFC_CD" ).append("\n"); 
		query.append("					AND    C.LOC_CD = H.LOC_CD" ).append("\n"); 
		query.append("					AND    NVL(C.NMD_CUST_FLG,'N') ='N'	" ).append("\n"); 
		query.append("					AND    B.POR_CD = L.LOC_CD" ).append("\n"); 
		query.append("					ORDER BY FLG" ).append("\n"); 
		query.append("					) A" ).append("\n"); 
		query.append("					WHERE ROWNUM = 1" ).append("\n"); 
		query.append("					)P," ).append("\n"); 
		query.append("					(SELECT " ).append("\n"); 
		query.append("					BKG_NO," ).append("\n"); 
		query.append("					OFC_CD," ).append("\n"); 
		query.append("					CUST_CNT_CD," ).append("\n"); 
		query.append("					CUST_SEQ" ).append("\n"); 
		query.append("					FROM (" ).append("\n"); 
		query.append("					SELECT ROWNUM,A.* FROM " ).append("\n"); 
		query.append("					(" ).append("\n"); 
		query.append("					--CCT" ).append("\n"); 
		query.append("					SELECT  BKG.BKG_NO AS BKG_NO," ).append("\n"); 
		query.append("					        21 AS FLG," ).append("\n"); 
		query.append("					        'C' AS BKG_CUST_TP_CD," ).append("\n"); 
		query.append("					        CR_CLT_OFC_CD AS OFC_CD," ).append("\n"); 
		query.append("					        BCUST.CUST_CNT_CD AS CUST_CNT_CD," ).append("\n"); 
		query.append("					        BCUST.CUST_SEQ AS CUST_SEQ," ).append("\n"); 
		query.append("					        MCUST.CUST_LGL_ENG_NM AS CUST_NM" ).append("\n"); 
		query.append("					FROM    MDM_CR_CUST CUST," ).append("\n"); 
		query.append("					        BKG_BKG_HIS BKG," ).append("\n"); 
		query.append("					        BKG_CUST_HIS BCUST," ).append("\n"); 
		query.append("					        MDM_CUSTOMER MCUST" ).append("\n"); 
		query.append("					WHERE  BKG.BKG_NO = @[bkg_no]" ).append("\n"); 
		query.append("					AND    BKG.BKG_NO = BCUST.BKG_NO" ).append("\n"); 
		query.append("					AND    BCUST.BKG_CUST_TP_CD = 'C'" ).append("\n"); 
		query.append("					AND    CUST.CUST_CNT_CD = BCUST.CUST_CNT_CD" ).append("\n"); 
		query.append("					AND    CUST.CUST_SEQ = BCUST.CUST_SEQ" ).append("\n"); 
		query.append("					AND    BCUST.CUST_CNT_CD = MCUST.CUST_CNT_CD" ).append("\n"); 
		query.append("					AND    BCUST.CUST_SEQ = MCUST.CUST_SEQ    " ).append("\n"); 
		query.append("					AND    BKG.CORR_NO ='TMP0000001'" ).append("\n"); 
		query.append("					AND    BCUST.CORR_NO ='TMP0000001'" ).append("\n"); 
		query.append("					AND    IB_CR_TERM_DYS > 0" ).append("\n"); 
		query.append("					AND    CR_ST_DT  <= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BKG_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO ='TMP0000001')" ).append("\n"); 
		query.append("					AND    CR_END_DT >= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BKG_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO ='TMP0000001')" ).append("\n"); 
		query.append("					AND    MCUST.DELT_FLG ='N'" ).append("\n"); 
		query.append("					AND    NVL(MCUST.NMD_CUST_FLG,'N') ='N'" ).append("\n"); 
		query.append("					AND    CUST.DELT_FLG ='N'" ).append("\n"); 
		query.append("					UNION" ).append("\n"); 
		query.append("					--CCT OFFICE CODE2" ).append("\n"); 
		query.append("					SELECT B.BKG_NO BKG_NO," ).append("\n"); 
		query.append("					        22 AS FLG," ).append("\n"); 
		query.append("					        'C' AS BKG_CUST_TP_CD," ).append("\n"); 
		query.append("					        --C.OFC_CD AS OFC_CD, " ).append("\n"); 
		query.append("							-- DEL 에 해당되는 OFC 로 로직 변경 2010.12.14 신은영 차장님 요청" ).append("\n"); 
		query.append("							(SELECT  FINC_CTRL_OFC_CD" ).append("\n"); 
		query.append("					            FROM MDM_LOCATION" ).append("\n"); 
		query.append("					            WHERE LOC_CD = (SELECT DEL_CD" ).append("\n"); 
		query.append("					                            FROM  BKG_BKG_HIS" ).append("\n"); 
		query.append("					                            WHERE BKG_NO =@[bkg_no]" ).append("\n"); 
		query.append("					                            AND   CORR_NO ='TMP0000001'" ).append("\n"); 
		query.append("					                            )) AS OFC_CD," ).append("\n"); 
		query.append("					        S.CUST_CNT_CD  AS CUST_CNT_CD," ).append("\n"); 
		query.append("					        NVL(S.CUST_SEQ,'1') AS CUST_SEQ," ).append("\n"); 
		query.append("					        C.CUST_LGL_ENG_NM AS CUST_NM" ).append("\n"); 
		query.append("					FROM    BKG_BKG_HIS B, " ).append("\n"); 
		query.append("					        BKG_CUST_HIS S," ).append("\n"); 
		query.append("					        MDM_CUSTOMER C" ).append("\n"); 
		query.append("					WHERE  B.BKG_NO = @[bkg_no]" ).append("\n"); 
		query.append("					AND    S.BKG_NO = B.BKG_NO" ).append("\n"); 
		query.append("					AND    DECODE(B.CUST_TO_ORD_FLG,'Y','N','C') = S.BKG_CUST_TP_CD" ).append("\n"); 
		query.append("					AND    S.CUST_CNT_CD = C.CUST_CNT_CD" ).append("\n"); 
		query.append("					AND    S.CUST_SEQ = C.CUST_SEQ" ).append("\n"); 
		query.append("					AND    C.DELT_FLG = 'N'" ).append("\n"); 
		query.append("					AND	NVL(C.NMD_CUST_FLG,'N') ='N'" ).append("\n"); 
		query.append("					AND   B.CORR_NO ='TMP0000001'" ).append("\n"); 
		query.append("					AND   S.CORR_NO ='TMP0000001'" ).append("\n"); 
		query.append("					UNION" ).append("\n"); 
		query.append("					--REP CUSTOMER" ).append("\n"); 
		query.append("					SELECT BKG_NO," ).append("\n"); 
		query.append("					        31 AS FLG," ).append("\n"); 
		query.append("					        'R'AS BKG_CUST_TP_CD," ).append("\n"); 
		query.append("					        (SELECT  FINC_CTRL_OFC_CD" ).append("\n"); 
		query.append("					            FROM MDM_LOCATION" ).append("\n"); 
		query.append("					            WHERE LOC_CD = (SELECT DEL_CD" ).append("\n"); 
		query.append("					                            FROM  BKG_BKG_HIS" ).append("\n"); 
		query.append("					                            WHERE BKG_NO =@[bkg_no]" ).append("\n"); 
		query.append("					                            AND   CORR_NO ='TMP0000001')) AS OFC_CD," ).append("\n"); 
		query.append("					        REP_CUST_CNT_CD AS CUST_CNT_CD," ).append("\n"); 
		query.append("					        REP_CUST_SEQ AS CUST_SEQ," ).append("\n"); 
		query.append("					        MCUST.CUST_LGL_ENG_NM AS CUST_NM" ).append("\n"); 
		query.append("					FROM   MDM_ORGANIZATION OFC, " ).append("\n"); 
		query.append("					        BKG_BKG_HIS BKG," ).append("\n"); 
		query.append("					        MDM_CUSTOMER MCUST" ).append("\n"); 
		query.append("					WHERE  BKG.BKG_NO = @[bkg_no]" ).append("\n"); 
		query.append("					AND    REP_CUST_CNT_CD = MCUST.CUST_CNT_CD" ).append("\n"); 
		query.append("					AND    REP_CUST_SEQ = MCUST.CUST_SEQ" ).append("\n"); 
		query.append("					AND    MCUST.DELT_FLG ='N'" ).append("\n"); 
		query.append("					AND	NVL(MCUST.NMD_CUST_FLG,'N') ='N'" ).append("\n"); 
		query.append("					AND   BKG.CORR_NO ='TMP0000001'" ).append("\n"); 
		query.append("					AND    OFC.OFC_CD = NVL((SELECT CR_CLT_OFC_CD" ).append("\n"); 
		query.append("					                        FROM MDM_CR_CUST" ).append("\n"); 
		query.append("					                        WHERE (CUST_CNT_CD, CUST_SEQ) = (SELECT CUST_CNT_CD, CUST_SEQ" ).append("\n"); 
		query.append("					                                                            FROM   BKG_BKG_HIS B," ).append("\n"); 
		query.append("					                                                                    BKG_CUST_HIS C" ).append("\n"); 
		query.append("					                                                            WHERE  B.BKG_NO = @[bkg_no]" ).append("\n"); 
		query.append("					                                                            AND    C.BKG_NO = B.BKG_NO" ).append("\n"); 
		query.append("					                                                            AND    C.BKG_CUST_TP_CD = 'C'" ).append("\n"); 
		query.append("					                                                            AND    B.CORR_NO ='TMP0000001'" ).append("\n"); 
		query.append("					                                                            AND    C.CORR_NO ='TMP0000001'" ).append("\n"); 
		query.append("																				)" ).append("\n"); 
		query.append("					                        AND 0 < IB_CR_TERM_DYS" ).append("\n"); 
		query.append("											AND MCUST.DELT_FLG ='N'" ).append("\n"); 
		query.append("					                        AND CR_ST_DT  <= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BKG_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO ='TMP0000001')" ).append("\n"); 
		query.append("					                        AND CR_END_DT >= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BKG_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO ='TMP0000001'))," ).append("\n"); 
		query.append("					                    (SELECT  FINC_CTRL_OFC_CD" ).append("\n"); 
		query.append("					                        FROM MDM_LOCATION" ).append("\n"); 
		query.append("					                        WHERE LOC_CD = (SELECT DEL_CD" ).append("\n"); 
		query.append("					                                        FROM  BKG_BKG_HIS" ).append("\n"); 
		query.append("					                                        WHERE BKG_NO =@[bkg_no]" ).append("\n"); 
		query.append("					                                        AND   CORR_NO ='TMP0000001')" ).append("\n"); 
		query.append("					                    )" ).append("\n"); 
		query.append("					                    )" ).append("\n"); 
		query.append("					                    ORDER BY FLG" ).append("\n"); 
		query.append("					) A" ).append("\n"); 
		query.append("					WHERE " ).append("\n"); 
		query.append("					ROWNUM = 1)" ).append("\n"); 
		query.append("					) C," ).append("\n"); 
		query.append("				   (SELECT BK.BKG_NO," ).append("\n"); 
		query.append("					CASE WHEN (POR_L.CONTI_CD ='F' OR POR_L.CONTI_CD = 'E') AND(F.CUST_SEQ IS NOT NULL AND F.CUST_SEQ <> '0') AND EXISTS (SELECT 'Y' FROM MDM_LOCATION FL " ).append("\n"); 
		query.append("                                                                        WHERE  FL.CONTI_CD ='E' " ).append("\n"); 
		query.append("                                                                          AND  FL.DELT_FLG ='N'" ).append("\n"); 
		query.append("                                                                          AND  FL.CNT_CD = F.CUST_CNT_CD" ).append("\n"); 
		query.append("                                                                          AND ROWNUM =1 )" ).append("\n"); 
		query.append("                            THEN F.CUST_CNT_CD" ).append("\n"); 
		query.append("                   WHEN BK.BKG_OFC_CD IN (SELECT ATTR_CTNT1" ).append("\n"); 
		query.append("                                          FROM BKG_HRD_CDG_CTNT" ).append("\n"); 
		query.append("                                          WHERE HRD_CDG_ID = 'PPD_PAYER_EXCEPTION') " ).append("\n"); 
		query.append("                            THEN F.CUST_CNT_CD" ).append("\n"); 
		query.append("                   ELSE ''" ).append("\n"); 
		query.append("                   END F_PPD_PAYR_CNT_CD," ).append("\n"); 
		query.append("                   CASE WHEN (POR_L.CONTI_CD ='F' OR POR_L.CONTI_CD = 'E') AND(F.CUST_SEQ IS NOT NULL AND F.CUST_SEQ <> '0') AND EXISTS (SELECT 'Y' FROM MDM_LOCATION FL " ).append("\n"); 
		query.append("                                                                                WHERE  FL.CONTI_CD ='E' " ).append("\n"); 
		query.append("                                                                                  AND  FL.DELT_FLG ='N'" ).append("\n"); 
		query.append("                                                                                  AND  FL.CNT_CD = F.CUST_CNT_CD" ).append("\n"); 
		query.append("                                                                                  AND ROWNUM =1 )" ).append("\n"); 
		query.append("                            THEN F.CUST_SEQ" ).append("\n"); 
		query.append("                   WHEN BK.BKG_OFC_CD IN (SELECT ATTR_CTNT1" ).append("\n"); 
		query.append("                                          FROM BKG_HRD_CDG_CTNT" ).append("\n"); 
		query.append("                                          WHERE HRD_CDG_ID = 'PPD_PAYER_EXCEPTION') " ).append("\n"); 
		query.append("                            THEN F.CUST_SEQ" ).append("\n"); 
		query.append("                   ELSE 0" ).append("\n"); 
		query.append("                   END F_PPD_PAYR_CUST_SEQ" ).append("\n"); 
		query.append("				   FROM BKG_BKG_HIS BK,BKG_CUST_HIS F, MDM_LOCATION POR_L" ).append("\n"); 
		query.append("				   WHERE BK.BKG_NO =@[bkg_no]" ).append("\n"); 
		query.append("                     AND BK.BKG_STS_CD <>'X'" ).append("\n"); 
		query.append("                     AND BK.BKG_NO = F.BKG_NO" ).append("\n"); 
		query.append("                     AND F.BKG_CUST_TP_CD ='F'" ).append("\n"); 
		query.append("                     AND BK.POR_CD = POR_L.LOC_CD" ).append("\n"); 
		query.append("                     AND POR_L.DELT_FLG ='N'" ).append("\n"); 
		query.append("                     AND BK.CORR_NO ='TMP0000001'" ).append("\n"); 
		query.append("                     AND F.CORR_NO ='TMP0000001'" ).append("\n"); 
		query.append("				   ) F" ).append("\n"); 
		query.append("					WHERE P.BKG_NO = C.BKG_NO" ).append("\n"); 
		query.append("					  AND P.BKG_NO = F.BKG_NO(+)" ).append("\n"); 
		query.append("    ) T" ).append("\n"); 
		query.append("ON (T.BKG_NO = RATE.BKG_NO )" ).append("\n"); 
		query.append("WHEN MATCHED THEN" ).append("\n"); 
		query.append("    UPDATE SET" ).append("\n"); 
		query.append("      	PPD_RCV_OFC_CD = T.PPD_RCV_OFC_CD," ).append("\n"); 
		query.append("        PPD_PAYR_CNT_CD = T.PPD_PAYR_CNT_CD," ).append("\n"); 
		query.append("        PPD_PAYR_CUST_SEQ = T.PPD_PAYR_CUST_SEQ," ).append("\n"); 
		query.append("        CLT_OFC_CD = T.CLT_OFC_CD," ).append("\n"); 
		query.append("        CLT_PAYR_CNT_CD = T.CLT_PAYR_CNT_CD," ).append("\n"); 
		query.append("        CLT_PAYR_CUST_SEQ = T.CLT_PAYR_CUST_SEQ," ).append("\n"); 
		query.append("	    BKG_RT_WHF_EXPT_CD = NVL((SELECT 'I' " ).append("\n"); 
		query.append("								    FROM BKG_CUST_HIS C" ).append("\n"); 
		query.append("								   WHERE C.BKG_NO = T.BKG_NO" ).append("\n"); 
		query.append("									 AND C.CORR_NO = T.CORR_NO" ).append("\n"); 
		query.append("								     AND C.BKG_CUST_TP_CD = 'S'" ).append("\n"); 
		query.append("									 AND C.CUST_CNT_CD = 'KR'" ).append("\n"); 
		query.append("									 AND C.CUST_SEQ = 1771), null)," ).append("\n"); 
		query.append("        UPD_DT = SYSDATE," ).append("\n"); 
		query.append("		UPD_USR_ID = @[user_id]" ).append("\n"); 
		query.append("    WHERE BKG_NO =@[bkg_no]" ).append("\n"); 
		query.append("WHEN NOT MATCHED THEN" ).append("\n"); 
		query.append("    INSERT(" ).append("\n"); 
		query.append("        BKG_NO," ).append("\n"); 
		query.append("        CORR_NO," ).append("\n"); 
		query.append("		RT_BL_TP_CD," ).append("\n"); 
		query.append("		FRT_TERM_CD," ).append("\n"); 
		query.append("		BKG_CTRT_TP_CD," ).append("\n"); 
		query.append("		PPD_RCV_OFC_CD," ).append("\n"); 
		query.append("		PPD_PAYR_CNT_CD," ).append("\n"); 
		query.append("		PPD_PAYR_CUST_SEQ," ).append("\n"); 
		query.append("		CLT_OFC_CD," ).append("\n"); 
		query.append("		CLT_PAYR_CNT_CD," ).append("\n"); 
		query.append("		CLT_PAYR_CUST_SEQ," ).append("\n"); 
		query.append("		BKG_RT_WHF_EXPT_CD," ).append("\n"); 
		query.append("        CRE_USR_ID," ).append("\n"); 
		query.append("        CRE_DT," ).append("\n"); 
		query.append("        UPD_USR_ID," ).append("\n"); 
		query.append("        UPD_DT" ).append("\n"); 
		query.append("        )" ).append("\n"); 
		query.append("    VALUES ( " ).append("\n"); 
		query.append("		T.BKG_NO," ).append("\n"); 
		query.append("		'TMP0000001'," ).append("\n"); 
		query.append("		T.RT_BL_TP_CD," ).append("\n"); 
		query.append("		T.FRT_TERM_CD," ).append("\n"); 
		query.append("		T.BKG_CTRT_TP_CD," ).append("\n"); 
		query.append("		T.PPD_RCV_OFC_CD," ).append("\n"); 
		query.append("		T.PPD_PAYR_CNT_CD," ).append("\n"); 
		query.append("		T.PPD_PAYR_CUST_SEQ," ).append("\n"); 
		query.append("		T.CLT_OFC_CD," ).append("\n"); 
		query.append("		T.CLT_PAYR_CNT_CD," ).append("\n"); 
		query.append("		T.CLT_PAYR_CUST_SEQ," ).append("\n"); 
		query.append("		NVL((SELECT 'I' " ).append("\n"); 
		query.append("			   FROM BKG_CUST_HIS C" ).append("\n"); 
		query.append(" 			  WHERE C.BKG_NO = T.BKG_NO" ).append("\n"); 
		query.append("				AND C.CORR_NO = T.CORR_NO" ).append("\n"); 
		query.append("				AND C.BKG_CUST_TP_CD = 'S'" ).append("\n"); 
		query.append("				AND C.CUST_CNT_CD = 'KR'" ).append("\n"); 
		query.append("				AND C.CUST_SEQ = 1771), null)," ).append("\n"); 
		query.append("	    T.CRE_USR_ID," ).append("\n"); 
		query.append("	    T.CRE_DT," ).append("\n"); 
		query.append("	    T.UPD_USR_ID," ).append("\n"); 
		query.append("	    T.UPD_DT" ).append("\n"); 
		query.append("        )" ).append("\n"); 
		query.append("" ).append("\n"); 
		query.append("#else" ).append("\n"); 
		query.append("MERGE INTO BKG_RATE RATE" ).append("\n"); 
		query.append("USING (" ).append("\n"); 
		query.append("    SELECT " ).append("\n"); 
		query.append("		@[bkg_no] AS BKG_NO," ).append("\n"); 
		query.append("		'N' AS RT_BL_TP_CD," ).append("\n"); 
		query.append("		'P' AS FRT_TERM_CD," ).append("\n"); 
		query.append("		(SELECT CASE WHEN TAA_NO IS NOT NULL THEN 'T'" ).append("\n"); 
		query.append("            WHEN RFA_NO IS NOT NULL THEN 'R'" ).append("\n"); 
		query.append("            WHEN SC_NO  IS NOT NULL THEN 'S'" ).append("\n"); 
		query.append("            ELSE ''" ).append("\n"); 
		query.append("            END BKG_CTRT_TP_CD FROM BKG_BOOKING" ).append("\n"); 
		query.append("		WHERE BKG_NO = @[bkg_no]) BKG_CTRT_TP_CD," ).append("\n"); 
		query.append("		NVL((SELECT C.OFC_CD FROM BKG_BOOKING K, BKG_CHN_AGN C" ).append("\n"); 
		query.append("		              WHERE K.BKG_NO = @[bkg_no]" ).append("\n"); 
		query.append("		                AND K.CHN_AGN_CD = C.CHN_AGN_CD" ).append("\n"); 
		query.append("						AND ROWNUM = 1" ).append("\n"); 
		query.append("		            ),P.OFC_CD) PPD_RCV_OFC_CD," ).append("\n"); 
		query.append("		CASE " ).append("\n"); 
		query.append("		WHEN F.F_PPD_PAYR_CNT_CD IS NOT NULL AND NVL(F.F_PPD_PAYR_CUST_SEQ,'') <> '0' THEN F.F_PPD_PAYR_CNT_CD" ).append("\n"); 
		query.append("		ELSE P.CUST_CNT_CD" ).append("\n"); 
		query.append("		END PPD_PAYR_CNT_CD," ).append("\n"); 
		query.append("		CASE " ).append("\n"); 
		query.append("		WHEN F.F_PPD_PAYR_CNT_CD IS NOT NULL AND NVL(F.F_PPD_PAYR_CUST_SEQ,'') <> '0' THEN F.F_PPD_PAYR_CUST_SEQ" ).append("\n"); 
		query.append("        ELSE P.CUST_SEQ " ).append("\n"); 
		query.append("        END PPD_PAYR_CUST_SEQ," ).append("\n"); 
		query.append("		C.OFC_CD CLT_OFC_CD," ).append("\n"); 
		query.append("		C.CUST_CNT_CD CLT_PAYR_CNT_CD," ).append("\n"); 
		query.append("		C.CUST_SEQ CLT_PAYR_CUST_SEQ," ).append("\n"); 
		query.append("        @[user_id] AS CRE_USR_ID," ).append("\n"); 
		query.append("        sysdate AS CRE_DT," ).append("\n"); 
		query.append("        @[user_id] AS UPD_USR_ID," ).append("\n"); 
		query.append("        sysdate AS UPD_DT" ).append("\n"); 
		query.append("		FROM (" ).append("\n"); 
		query.append("				SELECT ROWNUM,A.* FROM " ).append("\n"); 
		query.append("				(" ).append("\n"); 
		query.append("					--PPD" ).append("\n"); 
		query.append("					--Credit Customer Information 상 Credit Control Office" ).append("\n"); 
		query.append("					--(추가) Sales Office 의 국가 Code 와 Credit Control Office의 국가 Code 가 불일치시 비신용 화주 Logic 으로 처리" ).append("\n"); 
		query.append("					SELECT BKG.BKG_NO BKG_NO," ).append("\n"); 
		query.append("					        11 AS FLG," ).append("\n"); 
		query.append("					        'S' AS BKG_CUST_TP_CD," ).append("\n"); 
		query.append("						 CR_CLT_OFC_CD AS OFC_CD," ).append("\n"); 
		query.append("					        BCUST.CUST_CNT_CD CUST_CNT_CD," ).append("\n"); 
		query.append("					        BCUST.CUST_SEQ CUST_SEQ," ).append("\n"); 
		query.append("					        BCUST.CUST_LGL_ENG_NM CUST_NM" ).append("\n"); 
		query.append("					FROM   MDM_CR_CUST CUST," ).append("\n"); 
		query.append("					       BKG_BOOKING BKG," ).append("\n"); 
		query.append("					       (SELECT S.CUST_CNT_CD, S.CUST_SEQ, C.CUST_LGL_ENG_NM" ).append("\n"); 
		query.append("					       FROM BKG_CUSTOMER S, " ).append("\n"); 
		query.append("					            MDM_CUSTOMER C" ).append("\n"); 
		query.append("					        WHERE  S.BKG_NO = @[bkg_no]" ).append("\n"); 
		query.append("					        AND S.BKG_CUST_TP_CD = 'S'" ).append("\n"); 
		query.append("					        AND S.CUST_CNT_CD = C.CUST_CNT_CD" ).append("\n"); 
		query.append("					        AND S.CUST_SEQ = C.CUST_SEQ" ).append("\n"); 
		query.append("						AND C.DELT_FLG ='N'" ).append("\n"); 
		query.append("						AND NVL(C.NMD_CUST_FLG,'N') ='N'" ).append("\n"); 
		query.append("					        ) BCUST," ).append("\n"); 
		query.append("					        MDM_ORGANIZATION OB_SLS_OFC," ).append("\n"); 
		query.append("							MDM_ORGANIZATION CR_CLT_OFC	" ).append("\n"); 
		query.append("					WHERE  BKG.BKG_NO = @[bkg_no]" ).append("\n"); 
		query.append("					AND    (CUST.CUST_CNT_CD, CUST.CUST_SEQ) = (SELECT CUST_CNT_CD, CUST_SEQ" ).append("\n"); 
		query.append("					                                    FROM   BKG_BOOKING B, BKG_CUSTOMER S" ).append("\n"); 
		query.append("					                                    WHERE  B.BKG_NO = @[bkg_no] " ).append("\n"); 
		query.append("					                                    AND S.BKG_NO = B.BKG_NO " ).append("\n"); 
		query.append("					                                    AND S.BKG_CUST_TP_CD = 'S')" ).append("\n"); 
		query.append("					AND    0 < CUST.OB_CR_TERM_DYS" ).append("\n"); 
		query.append("					AND    CUST.CR_ST_DT  <= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no])" ).append("\n"); 
		query.append("					AND    CUST.CR_END_DT >= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no])" ).append("\n"); 
		query.append("					AND    CUST.DELT_FLG ='N'" ).append("\n"); 
		query.append("					AND    OB_SLS_OFC.OFC_CD = BKG.OB_SLS_OFC_CD " ).append("\n"); 
		query.append("					AND    CR_CLT_OFC.OFC_CD = CUST.CR_CLT_OFC_CD " ).append("\n"); 
		query.append("					AND    OB_SLS_OFC.DELT_FLG ='N'" ).append("\n"); 
		query.append("					AND    CR_CLT_OFC.DELT_FLG ='N'" ).append("\n"); 
		query.append("					AND    OB_SLS_OFC.VNDR_CNT_CD = CR_CLT_OFC.VNDR_CNT_CD" ).append("\n"); 
		query.append("					UNION" ).append("\n"); 
		query.append("					--PPD OFFICE CODE2" ).append("\n"); 
		query.append("					--미주지역본부의 경우(해당 Office 가 미주산하Office), 만약 L.Office 가 NYCWP 이고 비신용화주의 경우,Shipper Location 의 Financial Control Office " ).append("\n"); 
		query.append("					--  >>> 변경 2014.06.25  미주지역본부의 경우, 만약 L.Office 가 NYCWP, NYCME, NYCMW인 경우, NYCRA로 설정 >> NYCME, NYCMW 제외" ).append("\n"); 
		query.append("                    --  >>> 변경 L.Office가 NYCME 와 NYCMW 인 경우에는 화주별 assign 된 Sales office 를 collection office 로 변경 " ).append("\n"); 
		query.append("					--L.Office 가 지역본부이면(OFC_TP_CD ='QT') POR 의 Finance Control Office" ).append("\n"); 
		query.append("					--BKG 상 L.Office(Customer 의 Sale Rep 의 소속 Office)" ).append("\n"); 
		query.append("					--(한국 본사 Office)L.Office가 한국지역이고 그 L.Office의 AR HQ Office가 SELHO이면, 화주의 Sales office로 설정" ).append("\n"); 
		query.append("					SELECT B.BKG_NO BKG_NO," ).append("\n"); 
		query.append("					        12 AS FLG," ).append("\n"); 
		query.append("					        'S' AS BKG_CUST_TP_CD," ).append("\n"); 
		query.append("					        CASE WHEN SUBSTR(O.LOC_CD,1,2) ='US' AND B.OB_SLS_OFC_CD IN ('NYCWP') THEN 'NYCRA'" ).append("\n"); 
		query.append("                                 WHEN SUBSTR(O.LOC_CD,1,2) ='US' AND B.OB_SLS_OFC_CD IN ('NYCME','NYCMW') THEN C.OFC_CD" ).append("\n"); 
		query.append("                                 WHEN SUBSTR(O.LOC_CD,1,2) ='HQ' AND O.AR_HD_QTR_OFC_CD='SELHO' THEN NVL(C.OFC_CD, B.OB_SLS_OFC_CD)" ).append("\n"); 
		query.append("								 WHEN O.OFC_TP_CD ='QT' THEN L.FINC_CTRL_OFC_CD" ).append("\n"); 
		query.append("                                 ELSE B.OB_SLS_OFC_CD" ).append("\n"); 
		query.append("                                 END OFC_CD," ).append("\n"); 
		query.append("					        C.CUST_CNT_CD," ).append("\n"); 
		query.append("					        C.CUST_SEQ," ).append("\n"); 
		query.append("					        C.CUST_LGL_ENG_NM AS CUST_NM" ).append("\n"); 
		query.append("					FROM    BKG_BOOKING B," ).append("\n"); 
		query.append("					        BKG_CUSTOMER S," ).append("\n"); 
		query.append("							MDM_ORGANIZATION O," ).append("\n"); 
		query.append("							MDM_LOCATION L, --POR FINANCE OFFICE" ).append("\n"); 
		query.append("							MDM_LOCATION H, --SHIPPER FINNACE OFFICE" ).append("\n"); 
		query.append("							MDM_CUSTOMER C" ).append("\n"); 
		query.append("					WHERE  B.BKG_NO = @[bkg_no]" ).append("\n"); 
		query.append("					AND    S.BKG_NO = B.BKG_NO" ).append("\n"); 
		query.append("					AND    S.BKG_CUST_TP_CD = 'S'" ).append("\n"); 
		query.append("					AND    S.CUST_CNT_CD = C.CUST_CNT_CD" ).append("\n"); 
		query.append("					AND    S.CUST_SEQ = C.CUST_SEQ" ).append("\n"); 
		query.append("					AND    C.DELT_FLG ='N'" ).append("\n"); 
		query.append("					AND    O.DELT_FLG ='N'" ).append("\n"); 
		query.append("					AND    L.DELT_FLG ='N'" ).append("\n"); 
		query.append("					AND    H.DELT_FLG ='N'" ).append("\n"); 
		query.append("					AND    O.OFC_CD = B.OB_SLS_OFC_CD" ).append("\n"); 
		query.append("					AND    C.LOC_CD = H.LOC_CD" ).append("\n"); 
		query.append("					AND    NVL(C.NMD_CUST_FLG,'N') ='N'	" ).append("\n"); 
		query.append("					AND    B.POR_CD = L.LOC_CD" ).append("\n"); 
		query.append("					ORDER BY FLG" ).append("\n"); 
		query.append("					) A" ).append("\n"); 
		query.append("					WHERE ROWNUM = 1" ).append("\n"); 
		query.append("					)P," ).append("\n"); 
		query.append("					(SELECT " ).append("\n"); 
		query.append("					BKG_NO," ).append("\n"); 
		query.append("					OFC_CD," ).append("\n"); 
		query.append("					CUST_CNT_CD," ).append("\n"); 
		query.append("					CUST_SEQ" ).append("\n"); 
		query.append("					FROM (" ).append("\n"); 
		query.append("					SELECT ROWNUM,A.* FROM " ).append("\n"); 
		query.append("					(" ).append("\n"); 
		query.append("					--CCT" ).append("\n"); 
		query.append("					SELECT  BKG.BKG_NO AS BKG_NO," ).append("\n"); 
		query.append("					        21 AS FLG," ).append("\n"); 
		query.append("					        'C' AS BKG_CUST_TP_CD," ).append("\n"); 
		query.append("					        CR_CLT_OFC_CD AS OFC_CD," ).append("\n"); 
		query.append("					        BCUST.CUST_CNT_CD AS CUST_CNT_CD," ).append("\n"); 
		query.append("					        BCUST.CUST_SEQ AS CUST_SEQ," ).append("\n"); 
		query.append("					        MCUST.CUST_LGL_ENG_NM AS CUST_NM" ).append("\n"); 
		query.append("					FROM    MDM_CR_CUST CUST," ).append("\n"); 
		query.append("					        BKG_BOOKING BKG," ).append("\n"); 
		query.append("					        BKG_CUSTOMER BCUST," ).append("\n"); 
		query.append("					        MDM_CUSTOMER MCUST" ).append("\n"); 
		query.append("					WHERE  BKG.BKG_NO = @[bkg_no]" ).append("\n"); 
		query.append("					AND    BKG.BKG_NO = BCUST.BKG_NO" ).append("\n"); 
		query.append("					AND    BCUST.BKG_CUST_TP_CD = 'C'" ).append("\n"); 
		query.append("					AND    CUST.CUST_CNT_CD = BCUST.CUST_CNT_CD" ).append("\n"); 
		query.append("					AND    CUST.CUST_SEQ = BCUST.CUST_SEQ" ).append("\n"); 
		query.append("					AND    BCUST.CUST_CNT_CD = MCUST.CUST_CNT_CD" ).append("\n"); 
		query.append("					AND    BCUST.CUST_SEQ = MCUST.CUST_SEQ    " ).append("\n"); 
		query.append("					AND    IB_CR_TERM_DYS > 0" ).append("\n"); 
		query.append("					AND    CR_ST_DT  <= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no])" ).append("\n"); 
		query.append("					AND    CR_END_DT >= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no])" ).append("\n"); 
		query.append("					AND    MCUST.DELT_FLG ='N'" ).append("\n"); 
		query.append("					AND    NVL(MCUST.NMD_CUST_FLG,'N') ='N'" ).append("\n"); 
		query.append("					AND    CUST.DELT_FLG ='N'" ).append("\n"); 
		query.append("					UNION" ).append("\n"); 
		query.append("					--CCT OFFICE CODE2" ).append("\n"); 
		query.append("					SELECT B.BKG_NO BKG_NO," ).append("\n"); 
		query.append("					        22 AS FLG," ).append("\n"); 
		query.append("					        'C' AS BKG_CUST_TP_CD," ).append("\n"); 
		query.append("					        --C.OFC_CD AS OFC_CD, " ).append("\n"); 
		query.append("							-- DEL 에 해당되는 OFC 로 로직 변경 2010.12.14 신은영 차장님 요청" ).append("\n"); 
		query.append("							(SELECT  FINC_CTRL_OFC_CD" ).append("\n"); 
		query.append("					            FROM MDM_LOCATION" ).append("\n"); 
		query.append("					            WHERE LOC_CD = (SELECT DEL_CD" ).append("\n"); 
		query.append("					                            FROM  BKG_BOOKING" ).append("\n"); 
		query.append("					                            WHERE BKG_NO =@[bkg_no])) AS OFC_CD," ).append("\n"); 
		query.append("					        S.CUST_CNT_CD  AS CUST_CNT_CD," ).append("\n"); 
		query.append("					        NVL(S.CUST_SEQ,'1') AS CUST_SEQ," ).append("\n"); 
		query.append("					        C.CUST_LGL_ENG_NM AS CUST_NM" ).append("\n"); 
		query.append("					FROM    BKG_BOOKING B, " ).append("\n"); 
		query.append("					        BKG_CUSTOMER S," ).append("\n"); 
		query.append("					        MDM_CUSTOMER C" ).append("\n"); 
		query.append("					WHERE  B.BKG_NO = @[bkg_no]" ).append("\n"); 
		query.append("					AND    S.BKG_NO = B.BKG_NO" ).append("\n"); 
		query.append("					AND    DECODE(B.CUST_TO_ORD_FLG,'Y','N','C') = S.BKG_CUST_TP_CD" ).append("\n"); 
		query.append("					AND    S.CUST_CNT_CD = C.CUST_CNT_CD" ).append("\n"); 
		query.append("					AND    S.CUST_SEQ = C.CUST_SEQ" ).append("\n"); 
		query.append("					AND    C.DELT_FLG = 'N'" ).append("\n"); 
		query.append("					AND	NVL(C.NMD_CUST_FLG,'N') ='N'" ).append("\n"); 
		query.append("					UNION" ).append("\n"); 
		query.append("					--REP CUSTOMER" ).append("\n"); 
		query.append("					SELECT BKG_NO," ).append("\n"); 
		query.append("					        31 AS FLG," ).append("\n"); 
		query.append("					        'R'AS BKG_CUST_TP_CD," ).append("\n"); 
		query.append("					        (SELECT  FINC_CTRL_OFC_CD" ).append("\n"); 
		query.append("					            FROM MDM_LOCATION" ).append("\n"); 
		query.append("					            WHERE LOC_CD = (SELECT DEL_CD" ).append("\n"); 
		query.append("					                            FROM  BKG_BOOKING" ).append("\n"); 
		query.append("					                            WHERE BKG_NO =@[bkg_no])) AS OFC_CD," ).append("\n"); 
		query.append("					        REP_CUST_CNT_CD AS CUST_CNT_CD," ).append("\n"); 
		query.append("					        REP_CUST_SEQ AS CUST_SEQ," ).append("\n"); 
		query.append("					        MCUST.CUST_LGL_ENG_NM AS CUST_NM" ).append("\n"); 
		query.append("					FROM   MDM_ORGANIZATION OFC, " ).append("\n"); 
		query.append("					        BKG_BOOKING BKG," ).append("\n"); 
		query.append("					        MDM_CUSTOMER MCUST" ).append("\n"); 
		query.append("					WHERE  BKG.BKG_NO = @[bkg_no]" ).append("\n"); 
		query.append("					AND    REP_CUST_CNT_CD = MCUST.CUST_CNT_CD" ).append("\n"); 
		query.append("					AND    REP_CUST_SEQ = MCUST.CUST_SEQ" ).append("\n"); 
		query.append("					AND    MCUST.DELT_FLG ='N'" ).append("\n"); 
		query.append("					AND	NVL(MCUST.NMD_CUST_FLG,'N') ='N'" ).append("\n"); 
		query.append("					AND    OFC.OFC_CD = NVL((SELECT CR_CLT_OFC_CD" ).append("\n"); 
		query.append("					                        FROM MDM_CR_CUST" ).append("\n"); 
		query.append("					                        WHERE (CUST_CNT_CD, CUST_SEQ) = (SELECT CUST_CNT_CD, CUST_SEQ" ).append("\n"); 
		query.append("					                                                            FROM   BKG_BOOKING B," ).append("\n"); 
		query.append("					                                                                    BKG_CUSTOMER C" ).append("\n"); 
		query.append("					                                                            WHERE  B.BKG_NO = @[bkg_no]" ).append("\n"); 
		query.append("					                                                            AND    C.BKG_NO = B.BKG_NO" ).append("\n"); 
		query.append("					                                                            AND    C.BKG_CUST_TP_CD = 'C'" ).append("\n"); 
		query.append("																				)" ).append("\n"); 
		query.append("					                        AND 0 < IB_CR_TERM_DYS" ).append("\n"); 
		query.append("											AND MCUST.DELT_FLG ='N'" ).append("\n"); 
		query.append("					                        AND CR_ST_DT  <= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no])" ).append("\n"); 
		query.append("					                        AND CR_END_DT >= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no]))," ).append("\n"); 
		query.append("					                    (SELECT  FINC_CTRL_OFC_CD" ).append("\n"); 
		query.append("					                        FROM MDM_LOCATION" ).append("\n"); 
		query.append("					                        WHERE LOC_CD = (SELECT DEL_CD" ).append("\n"); 
		query.append("					                                        FROM  BKG_BOOKING" ).append("\n"); 
		query.append("					                                        WHERE BKG_NO =@[bkg_no])" ).append("\n"); 
		query.append("					                    )" ).append("\n"); 
		query.append("					                    )" ).append("\n"); 
		query.append("					                    ORDER BY FLG" ).append("\n"); 
		query.append("					) A" ).append("\n"); 
		query.append("					WHERE " ).append("\n"); 
		query.append("					ROWNUM = 1)" ).append("\n"); 
		query.append("					) C," ).append("\n"); 
		query.append("				   (SELECT BK.BKG_NO," ).append("\n"); 
		query.append("					CASE WHEN (POR_L.CONTI_CD ='F' OR POR_L.CONTI_CD = 'E') AND(F.CUST_SEQ IS NOT NULL AND F.CUST_SEQ <> '0') AND EXISTS (SELECT 'Y' FROM MDM_LOCATION FL " ).append("\n"); 
		query.append("                                                                        WHERE  FL.CONTI_CD ='E' " ).append("\n"); 
		query.append("                                                                          AND  FL.DELT_FLG ='N'" ).append("\n"); 
		query.append("                                                                          AND  FL.CNT_CD = F.CUST_CNT_CD" ).append("\n"); 
		query.append("                                                                          AND ROWNUM =1 )" ).append("\n"); 
		query.append("                              THEN F.CUST_CNT_CD" ).append("\n"); 
		query.append("                   WHEN BK.BKG_OFC_CD IN (SELECT ATTR_CTNT1" ).append("\n"); 
		query.append("                                          FROM BKG_HRD_CDG_CTNT" ).append("\n"); 
		query.append("                                          WHERE HRD_CDG_ID = 'PPD_PAYER_EXCEPTION') " ).append("\n"); 
		query.append("                              THEN F.CUST_CNT_CD" ).append("\n"); 
		query.append("                   ELSE ''" ).append("\n"); 
		query.append("                   END F_PPD_PAYR_CNT_CD," ).append("\n"); 
		query.append("                   CASE WHEN (POR_L.CONTI_CD ='F' OR POR_L.CONTI_CD = 'E') AND(F.CUST_SEQ IS NOT NULL AND F.CUST_SEQ <> '0') AND EXISTS (SELECT 'Y' FROM MDM_LOCATION FL " ).append("\n"); 
		query.append("                                                                                WHERE  FL.CONTI_CD ='E' " ).append("\n"); 
		query.append("                                                                                  AND  FL.DELT_FLG ='N'" ).append("\n"); 
		query.append("                                                                                  AND  FL.CNT_CD = F.CUST_CNT_CD" ).append("\n"); 
		query.append("                                                                                  AND ROWNUM =1 )" ).append("\n"); 
		query.append("                              THEN F.CUST_SEQ" ).append("\n"); 
		query.append("                   WHEN BK.BKG_OFC_CD IN (SELECT ATTR_CTNT1" ).append("\n"); 
		query.append("                                          FROM BKG_HRD_CDG_CTNT" ).append("\n"); 
		query.append("                                          WHERE HRD_CDG_ID = 'PPD_PAYER_EXCEPTION') " ).append("\n"); 
		query.append("                              THEN F.CUST_SEQ" ).append("\n"); 
		query.append("                   ELSE 0" ).append("\n"); 
		query.append("                   END F_PPD_PAYR_CUST_SEQ" ).append("\n"); 
		query.append("				   FROM BKG_BOOKING BK,BKG_CUSTOMER F, MDM_LOCATION POR_L" ).append("\n"); 
		query.append("				   WHERE BK.BKG_NO =@[bkg_no]" ).append("\n"); 
		query.append("                     AND BK.BKG_STS_CD <>'X'" ).append("\n"); 
		query.append("                     AND BK.BKG_NO = F.BKG_NO" ).append("\n"); 
		query.append("                     AND F.BKG_CUST_TP_CD ='F'" ).append("\n"); 
		query.append("                     AND BK.POR_CD = POR_L.LOC_CD" ).append("\n"); 
		query.append("                     AND POR_L.DELT_FLG ='N'" ).append("\n"); 
		query.append("				   ) F" ).append("\n"); 
		query.append("					WHERE P.BKG_NO = C.BKG_NO" ).append("\n"); 
		query.append("					  AND P.BKG_NO = F.BKG_NO(+)" ).append("\n"); 
		query.append("    ) T" ).append("\n"); 
		query.append("ON (T.BKG_NO = RATE.BKG_NO )" ).append("\n"); 
		query.append("WHEN MATCHED THEN" ).append("\n"); 
		query.append("    UPDATE SET" ).append("\n"); 
		query.append("      	PPD_RCV_OFC_CD = T.PPD_RCV_OFC_CD," ).append("\n"); 
		query.append("        PPD_PAYR_CNT_CD = T.PPD_PAYR_CNT_CD," ).append("\n"); 
		query.append("        PPD_PAYR_CUST_SEQ = T.PPD_PAYR_CUST_SEQ," ).append("\n"); 
		query.append("        CLT_OFC_CD = T.CLT_OFC_CD," ).append("\n"); 
		query.append("        CLT_PAYR_CNT_CD = T.CLT_PAYR_CNT_CD," ).append("\n"); 
		query.append("        CLT_PAYR_CUST_SEQ = T.CLT_PAYR_CUST_SEQ," ).append("\n"); 
		query.append("	    BKG_RT_WHF_EXPT_CD = NVL((SELECT 'I' " ).append("\n"); 
		query.append("								    FROM BKG_CUSTOMER C" ).append("\n"); 
		query.append("								   WHERE C.BKG_NO = RATE.BKG_NO" ).append("\n"); 
		query.append("								     AND C.BKG_CUST_TP_CD = 'S'" ).append("\n"); 
		query.append("									 AND C.CUST_CNT_CD = 'KR'" ).append("\n"); 
		query.append("									 AND C.CUST_SEQ = 1771), null)," ).append("\n"); 
		query.append("        UPD_DT = SYSDATE," ).append("\n"); 
		query.append("		UPD_USR_ID = @[user_id]" ).append("\n"); 
		query.append("    WHERE BKG_NO = @[bkg_no]" ).append("\n"); 
		query.append("WHEN NOT MATCHED THEN" ).append("\n"); 
		query.append("    INSERT(" ).append("\n"); 
		query.append("        BKG_NO," ).append("\n"); 
		query.append("		RT_BL_TP_CD," ).append("\n"); 
		query.append("		FRT_TERM_CD," ).append("\n"); 
		query.append("		BKG_CTRT_TP_CD," ).append("\n"); 
		query.append("		PPD_RCV_OFC_CD," ).append("\n"); 
		query.append("		PPD_PAYR_CNT_CD," ).append("\n"); 
		query.append("		PPD_PAYR_CUST_SEQ," ).append("\n"); 
		query.append("		CLT_OFC_CD," ).append("\n"); 
		query.append("		CLT_PAYR_CNT_CD," ).append("\n"); 
		query.append("		CLT_PAYR_CUST_SEQ," ).append("\n"); 
		query.append("		BKG_RT_WHF_EXPT_CD," ).append("\n"); 
		query.append("        CRE_USR_ID," ).append("\n"); 
		query.append("        CRE_DT," ).append("\n"); 
		query.append("        UPD_USR_ID," ).append("\n"); 
		query.append("        UPD_DT" ).append("\n"); 
		query.append("        )" ).append("\n"); 
		query.append("    VALUES ( " ).append("\n"); 
		query.append("		T.BKG_NO," ).append("\n"); 
		query.append("		T.RT_BL_TP_CD," ).append("\n"); 
		query.append("		T.FRT_TERM_CD," ).append("\n"); 
		query.append("		T.BKG_CTRT_TP_CD," ).append("\n"); 
		query.append("		T.PPD_RCV_OFC_CD," ).append("\n"); 
		query.append("		T.PPD_PAYR_CNT_CD," ).append("\n"); 
		query.append("		T.PPD_PAYR_CUST_SEQ," ).append("\n"); 
		query.append("		T.CLT_OFC_CD," ).append("\n"); 
		query.append("		T.CLT_PAYR_CNT_CD," ).append("\n"); 
		query.append("		T.CLT_PAYR_CUST_SEQ," ).append("\n"); 
		query.append("		NVL((SELECT 'I' " ).append("\n"); 
		query.append("			   FROM BKG_CUSTOMER C" ).append("\n"); 
		query.append(" 			  WHERE C.BKG_NO = T.BKG_NO" ).append("\n"); 
		query.append("				AND C.BKG_CUST_TP_CD = 'S'" ).append("\n"); 
		query.append("				AND C.CUST_CNT_CD = 'KR'" ).append("\n"); 
		query.append("				AND C.CUST_SEQ = 1771), null)," ).append("\n"); 
		query.append("	    T.CRE_USR_ID," ).append("\n"); 
		query.append("	    T.CRE_DT," ).append("\n"); 
		query.append("	    T.UPD_USR_ID," ).append("\n"); 
		query.append("	    T.UPD_DT" ).append("\n"); 
		query.append("        )" ).append("\n"); 
		query.append("#end" ).append("\n"); 

	}
}