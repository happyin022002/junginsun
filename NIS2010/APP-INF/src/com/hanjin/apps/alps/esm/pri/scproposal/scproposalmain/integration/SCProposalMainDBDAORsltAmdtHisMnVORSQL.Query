<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="SCProposalMainDBDAORsltAmdtHisMnVORSQL">
			<desc><![CDATA[Amendment History Inquery list 조회]]></desc>
			<sql><![CDATA[
#if (${svc_scp_cd} == 'X' && (${term_type_cd} == '01' || ${term_type_cd} == '02' || ${term_type_cd} == '03' || ${term_type_cd} == '04' || ${term_type_cd} == '05' || ${term_type_cd} == '06' || ${term_type_cd} == '') )
SELECT MN.PROP_NO
      ,MN.AMDT_SEQ
      ,'' SVC_SCP_CD
      ,TO_CHAR (MN.FILE_DT, 'YYYY-MM-DD') FILE_DT
      ,TO_CHAR (MN.EFF_DT, 'YYYY-MM-DD') EFF_DT
      ,TO_CHAR (MN.EXP_DT, 'YYYY-MM-DD') EXP_DT
      ,TO_CHAR (MN.CRE_DT, 'YYYY-MM-DD') CRE_DT
	  ,DECODE(MN.CONV_CFM_FLG,'Y','1','0') CONV_CFM_FLG
	  ,(SELECT CONV_CFM_FLG FROM PRI_SP_MN WHERE PROP_NO = MN.PROP_NO AND AMDT_SEQ = MN.AMDT_SEQ - 1) PRE_CONV_CFM_FLG
	  ,MN.LGCY_IF_FLG
FROM   PRI_SP_MN MN
WHERE  MN.PROP_NO = @[prop_no]
AND    MN.AMDT_SEQ IN (SELECT AMDT_SEQ FROM PRI_SP_MN WHERE PROP_NO =@[prop_no] AND PROP_STS_CD ='F')
#if (${conv_flg} == '0')
AND    1 = CASE LGCY_IF_FLG 
		   WHEN 'N' THEN 

          (SELECT COUNT (1)
           FROM   PRI_SP_AMDT_SMRY
           WHERE  PROP_NO = MN.PROP_NO
           AND    AMDT_SEQ = MN.AMDT_SEQ
#if (${term_type_cd} != '')
#if (${term_type_cd} == '02')
		   AND    PROP_TERM_TP_CD IN ('02','03')
#elseif (${term_type_cd} == '03')
		   AND    PROP_TERM_TP_CD = '04'
#elseif (${term_type_cd} == '04')
		   AND    PROP_TERM_TP_CD = '07'
#else
		   AND    PROP_TERM_TP_CD = @[term_type_cd]	
#end
#end
           AND    AMDT_FLG = 'Y'
           AND    ROWNUM = 1) 
		
		  WHEN 'Y' THEN
	(
    SELECT SIGN(SUM(AMDT_FLG)) FROM 
        (
         SELECT '01' PROP_TERM_TP_CD
               ,COUNT(*) AMDT_FLG
			   ,AMDT_SEQ
         FROM   PRI_SP_DUR
         WHERE  PROP_NO =  @[prop_no]
		 GROUP BY AMDT_SEQ
         UNION ALL
         SELECT '02' PROP_TERM_TP_CD
               ,COUNT(*) AMDT_FLG
			   ,AMDT_SEQ
         FROM   PRI_SP_MQC
         WHERE  PROP_NO =  @[prop_no]
		 GROUP BY AMDT_SEQ
         UNION ALL
         SELECT '02' PROP_TERM_TP_CD
               ,COUNT(*) AMDT_FLG
			   ,AMDT_SEQ
         FROM   PRI_SP_SUB_MQC
         WHERE  PROP_NO =  @[prop_no]
		 GROUP BY AMDT_SEQ
         UNION ALL
         SELECT '04' PROP_TERM_TP_CD
               ,COUNT(*) AMDT_FLG
			   ,AMDT_SEQ
         FROM   PRI_SP_CTRT_PTY
         WHERE  PROP_NO =  @[prop_no]
		 GROUP BY AMDT_SEQ                                               
         UNION ALL
         SELECT '05' PROP_TERM_TP_CD
               ,COUNT(*) AMDT_FLG
			   ,AMDT_SEQ
         FROM   PRI_SP_AFIL
         WHERE  PROP_NO =  @[prop_no]
		 GROUP BY AMDT_SEQ
         UNION ALL
         SELECT '06' PROP_TERM_TP_CD
               ,COUNT(*) AMDT_FLG
			   ,AMDT_SEQ
         FROM   PRI_SP_BLPL
         WHERE  PROP_NO =  @[prop_no] 
		 GROUP BY AMDT_SEQ                  
         UNION ALL
         SELECT '07' PROP_TERM_TP_CD
               ,COUNT(*) AMDT_FLG
			   ,AMDT_SEQ
         FROM   PRI_SP_CTRT_CUST_TP
         WHERE  PROP_NO =  @[prop_no]
		 GROUP BY AMDT_SEQ
        )MN_TERM
	WHERE MN_TERM.AMDT_SEQ = MN.AMDT_SEQ
#if (${term_type_cd} != '')
#if (${term_type_cd} == '02')
		   AND    PROP_TERM_TP_CD IN ('02','03')
#elseif (${term_type_cd} == '03')
		   AND    PROP_TERM_TP_CD = '04'
#elseif (${term_type_cd} == '04')
		   AND    PROP_TERM_TP_CD = '07'
#else
		   AND    PROP_TERM_TP_CD = @[term_type_cd]	
#end
#end
)
		   END
#end
UNION ALL
#end
SELECT MN.PROP_NO
      ,MN.AMDT_SEQ
      ,SCP.SVC_SCP_CD
      ,TO_CHAR (MN.FILE_DT, 'YYYY-MM-DD') FILE_DT
      ,TO_CHAR (SCP.EFF_DT, 'YYYY-MM-DD') EFF_DT
      ,TO_CHAR (SCP.EXP_DT, 'YYYY-MM-DD') EXP_DT
      ,TO_CHAR (MN.CRE_DT, 'YYYY-MM-DD') CRE_DT
	  ,'2' CONV_CFM_FLG
	  ,'N' PRE_CONV_CFM_FLG
	  ,MN.LGCY_IF_FLG
FROM   PRI_SP_SCP_MN SCP
      ,PRI_SP_MN MN
WHERE  MN.PROP_NO = SCP.PROP_NO
AND    MN.AMDT_SEQ = SCP.AMDT_SEQ
AND    MN.PROP_NO = @[prop_no]
#if (${svc_scp_cd} != 'X')
AND    SCP.SVC_SCP_CD = @[svc_scp_cd]
#end
AND    MN.AMDT_SEQ IN (SELECT AMDT_SEQ FROM PRI_SP_MN WHERE PROP_NO =@[prop_no] AND PROP_STS_CD ='F')

AND    1 = CASE LGCY_IF_FLG 
		   WHEN 'N' THEN 
          (SELECT COUNT (1)
           FROM   PRI_SP_SCP_AMDT_SMRY
           WHERE  PROP_NO = SCP.PROP_NO
           AND    AMDT_SEQ = SCP.AMDT_SEQ
           AND    SVC_SCP_CD = SCP.SVC_SCP_CD
#if (${term_type_cd} != '')
#if (${term_type_cd} == '11')
		   AND    PROP_SCP_TERM_TP_CD IN ('41','42')
#elseif (${term_type_cd} == '12')
		   AND    PROP_SCP_TERM_TP_CD = ('13')
#elseif (${term_type_cd} == '13')
		   AND    PROP_SCP_TERM_TP_CD = ('14')
#elseif (${term_type_cd} == '14')
		   AND    PROP_SCP_TERM_TP_CD  IN ('51','52')
#elseif (${term_type_cd} == '15')
		   AND    PROP_SCP_TERM_TP_CD  IN ('71','72')
#elseif (${term_type_cd} == '16')
		   AND    PROP_SCP_TERM_TP_CD = ('32')
#elseif (${term_type_cd} == '17')
		   AND    PROP_SCP_TERM_TP_CD = ('15')
#elseif (${term_type_cd} == '18')
		   AND    PROP_SCP_TERM_TP_CD  IN ('61','62')
#elseif (${term_type_cd} == '19')
		   AND    PROP_SCP_TERM_TP_CD = ('16')
#elseif (${term_type_cd} == '01')
		   AND    PROP_SCP_TERM_TP_CD = ('11')
#elseif (${term_type_cd} == '02')
		   AND    PROP_SCP_TERM_TP_CD = ('12')
#else
		   AND    PROP_SCP_TERM_TP_CD = @[term_type_cd]	
#end
#end
#if (${conv_flg} == '0')
           AND    AMDT_FLG = 'Y'
#end
           AND    ROWNUM = 1)
		
		  WHEN 'Y' THEN
		(
		 SELECT SIGN(SUM(AMDT_FLG))
		 FROM(
         		SELECT '11' PROP_SCP_TERM_TP_CD
               		,COUNT(*) AMDT_FLG
               		,AMDT_SEQ
					,SVC_SCP_CD
         		FROM   PRI_SP_SCP_DUR
         		WHERE  PROP_NO = @[prop_no]
				 GROUP BY SVC_SCP_CD,AMDT_SEQ
         		UNION ALL
         		SELECT '12' PROP_SCP_TERM_TP_CD
               		,COUNT(*) AMDT_FLG
               		,AMDT_SEQ
					,SVC_SCP_CD
         		FROM   PRI_SP_SCP_MQC
         		WHERE  PROP_NO = @[prop_no]
				 GROUP BY SVC_SCP_CD,AMDT_SEQ
         		UNION ALL
         		SELECT '13' PROP_SCP_TERM_TP_CD
               		,COUNT(*) AMDT_FLG
               		,AMDT_SEQ
					,SVC_SCP_CD
         		FROM   PRI_SP_SCP_GRP_LOC_DTL
        		 WHERE  PROP_NO = @[prop_no]
				 GROUP BY SVC_SCP_CD,AMDT_SEQ
         		UNION ALL
         		SELECT '14' PROP_SCP_TERM_TP_CD
               		,COUNT(*) AMDT_FLG
               		,AMDT_SEQ
					,SVC_SCP_CD
        		 FROM   PRI_SP_SCP_GRP_CMDT_DTL
        		 WHERE  PROP_NO = @[prop_no]
				 GROUP BY SVC_SCP_CD,AMDT_SEQ
         		UNION ALL
         		SELECT '15' PROP_SCP_TERM_TP_CD
               		,COUNT(*) AMDT_FLG
               		,AMDT_SEQ
					,SVC_SCP_CD
         		FROM   PRI_SP_SCP_LODG_AGN
         		WHERE  PROP_NO = @[prop_no]
				 GROUP BY SVC_SCP_CD,AMDT_SEQ 
        		UNION ALL
        		SELECT  '16' PROP_SCP_TERM_TP_CD
          		     ,COUNT(*) AMDT_FLG
          		      ,AMDT_SEQ
					,SVC_SCP_CD
       		 	FROM    PRI_SP_SCP_GOH_CHG
      		 	WHERE   PROP_NO = @[prop_no]
				 GROUP BY SVC_SCP_CD,AMDT_SEQ  
         		UNION ALL                                                       
         		SELECT '32' PROP_SCP_TERM_TP_CD
               		  ,COUNT(*) AMDT_FLG
               		  ,AMDT_SEQ
					  ,SVC_SCP_CD
         		FROM   PRI_SP_SCP_NOTE
         		WHERE  PROP_NO = @[prop_no]
         		AND    NOTE_TP_CD = 'P'
				 GROUP BY SVC_SCP_CD,AMDT_SEQ
        		UNION ALL
        		SELECT  '41' PROP_SCP_TERM_TP_CD
                		,COUNT(*) AMDT_FLG
                		,AMDT_SEQ
						,SVC_SCP_CD
        		FROM    PRI_SP_SCP_ROUT_PNT
        		WHERE   PROP_NO = @[prop_no]
        		AND     ORG_DEST_TP_CD = 'O'
				 GROUP BY SVC_SCP_CD,AMDT_SEQ
        		UNION ALL
        		SELECT  '41' PROP_SCP_TERM_TP_CD
                		,COUNT(*) AMDT_FLG
                		,AMDT_SEQ
					,SVC_SCP_CD
        		FROM    PRI_SP_SCP_ROUT_PNT
        		WHERE   PROP_NO = @[prop_no]
        		AND     ORG_DEST_TP_CD = 'D'
				 GROUP BY SVC_SCP_CD,AMDT_SEQ
        		UNION ALL
         		SELECT '51' PROP_SCP_TERM_TP_CD
               		,COUNT(*) AMDT_FLG
               		,AMDT_SEQ
					,SVC_SCP_CD
         		FROM   PRI_SP_SCP_TRSP_ADD_CHG
         		WHERE  PROP_NO = @[prop_no]
         		AND    ADD_CHG_TP_CD = 'A'
         		AND    ORG_DEST_TP_CD = 'O'
				 GROUP BY SVC_SCP_CD,AMDT_SEQ
         		UNION ALL
         		SELECT '51' PROP_SCP_TERM_TP_CD
               		,COUNT(*) AMDT_FLG
               		,AMDT_SEQ
					,SVC_SCP_CD
         		FROM   PRI_SP_SCP_TRSP_ADD_CHG
         		WHERE  PROP_NO = @[prop_no]
         		AND    ADD_CHG_TP_CD = 'A'
         		AND    ORG_DEST_TP_CD = 'D'
				 GROUP BY SVC_SCP_CD,AMDT_SEQ
         		UNION ALL
         		SELECT '61' PROP_SCP_TERM_TP_CD
               		,COUNT(*) AMDT_FLG
               		,AMDT_SEQ
					,SVC_SCP_CD
         		FROM   PRI_SP_SCP_TRSP_ADD_CHG
         		WHERE  PROP_NO = @[prop_no]
         		AND    ADD_CHG_TP_CD = 'I'
         		AND    ORG_DEST_TP_CD = 'O'
				 GROUP BY SVC_SCP_CD,AMDT_SEQ
         		UNION ALL
         		SELECT '61' PROP_SCP_TERM_TP_CD
               		,COUNT(*) AMDT_FLG
               		,AMDT_SEQ
					,SVC_SCP_CD
         		FROM   PRI_SP_SCP_TRSP_ADD_CHG
         		WHERE  PROP_NO = @[prop_no]
         		AND    ADD_CHG_TP_CD = 'I'
         		AND    ORG_DEST_TP_CD = 'D'
				 GROUP BY SVC_SCP_CD,AMDT_SEQ
         		UNION ALL                             
         		SELECT '71' PROP_SCP_TERM_TP_CD
               		,COUNT(*) AMDT_FLG
               		,AMDT_SEQ
					,SVC_SCP_CD
         		FROM   PRI_SP_SCP_RT_CMDT_HDR
         		WHERE  PROP_NO = @[prop_no] 
         		AND    GEN_SPCL_RT_TP_CD = 'G'    
				 GROUP BY SVC_SCP_CD,AMDT_SEQ                        
         		UNION ALL                             
         		SELECT '71' PROP_SCP_TERM_TP_CD
               		,COUNT(*) AMDT_FLG
               		,AMDT_SEQ
					,SVC_SCP_CD
         		 FROM   PRI_SP_SCP_RT_CMDT_HDR
         		 WHERE  PROP_NO = @[prop_no]
         		 AND    GEN_SPCL_RT_TP_CD = 'S'                                    
				 GROUP BY SVC_SCP_CD,AMDT_SEQ
				 ) SCP_TERM
		   WHERE SCP_TERM.AMDT_SEQ = SCP.AMDT_SEQ
           AND   SCP_TERM.SVC_SCP_CD = SCP.SVC_SCP_CD
#if (${term_type_cd} != '')
#if (${term_type_cd} == '11')
		   AND    PROP_SCP_TERM_TP_CD IN ('41','42')
#elseif (${term_type_cd} == '12')
		   AND    PROP_SCP_TERM_TP_CD = ('13')
#elseif (${term_type_cd} == '13')
		   AND    PROP_SCP_TERM_TP_CD = ('14')
#elseif (${term_type_cd} == '14')
		   AND    PROP_SCP_TERM_TP_CD  IN ('51','52')
#elseif (${term_type_cd} == '15')
		   AND    PROP_SCP_TERM_TP_CD  IN ('71','72')
#elseif (${term_type_cd} == '16')
		   AND    PROP_SCP_TERM_TP_CD = ('32')
#elseif (${term_type_cd} == '17')
		   AND    PROP_SCP_TERM_TP_CD = ('15')
#elseif (${term_type_cd} == '18')
		   AND    PROP_SCP_TERM_TP_CD  IN ('61','62')
#elseif (${term_type_cd} == '19')
		   AND    PROP_SCP_TERM_TP_CD = ('16')
#elseif (${term_type_cd} == '01')
		   AND    PROP_SCP_TERM_TP_CD = ('11')
#elseif (${term_type_cd} == '02')
		   AND    PROP_SCP_TERM_TP_CD = ('12')
#else
		   AND    PROP_SCP_TERM_TP_CD = @[term_type_cd]	
#end
#end
		 )
		  END
#if (${svc_scp_cd} == 'X' )
UNION 
SELECT MN.PROP_NO
      ,MN.AMDT_SEQ
      ,'' SVC_SCP_CD
      ,TO_CHAR (MN.FILE_DT, 'YYYY-MM-DD') FILE_DT
      ,TO_CHAR (MN.EFF_DT, 'YYYY-MM-DD') EFF_DT
      ,TO_CHAR (MN.EXP_DT, 'YYYY-MM-DD') EXP_DT
      ,TO_CHAR (MN.CRE_DT, 'YYYY-MM-DD') CRE_DT
	  ,DECODE(MN.CONV_CFM_FLG,'Y','1','0') CONV_CFM_FLG
	  ,(SELECT CONV_CFM_FLG FROM PRI_SP_MN WHERE PROP_NO = MN.PROP_NO AND AMDT_SEQ = MN.AMDT_SEQ -1) PRE_CONV_CFM_FLG
	  ,MN.LGCY_IF_FLG
FROM   PRI_SP_MN MN
WHERE  MN.PROP_NO = @[prop_no]
AND    MN.AMDT_SEQ = 0
#end
UNION
SELECT MN.PROP_NO
      ,MN.AMDT_SEQ
      ,SCP.SVC_SCP_CD
      ,TO_CHAR (MN.FILE_DT, 'YYYY-MM-DD') FILE_DT
      ,TO_CHAR (SCP.EFF_DT, 'YYYY-MM-DD') EFF_DT
      ,TO_CHAR (SCP.EXP_DT, 'YYYY-MM-DD') EXP_DT
      ,TO_CHAR (MN.CRE_DT, 'YYYY-MM-DD') CRE_DT
	  ,'2' CONV_CFM_FLG
	  ,'N' PRE_CONV_CFM_FLG
	  ,MN.LGCY_IF_FLG
FROM   PRI_SP_SCP_MN SCP
      ,PRI_SP_MN MN
WHERE  MN.PROP_NO = SCP.PROP_NO
AND    MN.AMDT_SEQ = SCP.AMDT_SEQ
AND    MN.PROP_NO = @[prop_no]
AND    MN.AMDT_SEQ = 0
#if (${svc_scp_cd} != 'X')
AND    SCP.SVC_SCP_CD = @[svc_scp_cd]
#end
ORDER BY AMDT_SEQ DESC ,SVC_SCP_CD DESC			]]></sql>
			<params>
				<param name="prop_no" type="12" value="" out="N"/>
				<param name="term_type_cd" type="12" value="" out="N"/>
				<param name="svc_scp_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
