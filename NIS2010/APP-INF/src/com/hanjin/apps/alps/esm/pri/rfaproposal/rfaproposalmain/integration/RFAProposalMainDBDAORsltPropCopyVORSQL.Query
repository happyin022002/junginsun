<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="RFAProposalMainDBDAORsltPropCopyVORSQL">
			<desc><![CDATA[RFA Proposal Copy]]></desc>
			<sql><![CDATA[
WITH CMDT_HDR AS (
    SELECT A.PROP_NO
         , A.AMDT_SEQ
         , A.SVC_SCP_CD
         , A.CMDT_HDR_SEQ AS OLD_CMDT_HDR_SEQ
         , DENSE_RANK() OVER (PARTITION BY A.PROP_NO, A.AMDT_SEQ, A.SVC_SCP_CD
                              ORDER BY A.PROP_NO, A.AMDT_SEQ, A.SVC_SCP_CD, A.BLET_DP_SEQ, A.CMDT_HDR_SEQ) AS CMDT_HDR_SEQ
    FROM PRI_RP_SCP_RT_CMDT_HDR A
    WHERE A.PROP_NO = @[prop_no]
    AND   A.AMDT_SEQ = @[amdt_seq]
    AND   (
        EXISTS (
            SELECT 'X'
            FROM PRI_RP_SCP_RT_CMDT B
            WHERE B.PROP_NO = A.PROP_NO
            AND   B.AMDT_SEQ = A.AMDT_SEQ
            AND   B.SVC_SCP_CD = A.SVC_SCP_CD
            AND   B.CMDT_HDR_SEQ = A.CMDT_HDR_SEQ
            AND   B.SRC_INFO_CD <> 'AD'
        )
        OR EXISTS (
            SELECT 'X'
            FROM PRI_RP_SCP_RT_ACT_CUST C
            WHERE C.PROP_NO = A.PROP_NO
            AND   C.AMDT_SEQ = A.AMDT_SEQ
            AND   C.SVC_SCP_CD = A.SVC_SCP_CD
            AND   C.CMDT_HDR_SEQ = A.CMDT_HDR_SEQ
            AND   C.SRC_INFO_CD <> 'AD'
        )
        OR EXISTS (
            SELECT 'X'
            FROM PRI_RP_SCP_RT_CNOTE D
            WHERE D.PROP_NO = A.PROP_NO
            AND   D.AMDT_SEQ = A.AMDT_SEQ
            AND   D.SVC_SCP_CD = A.SVC_SCP_CD
            AND   D.CMDT_HDR_SEQ = A.CMDT_HDR_SEQ
            AND   D.SRC_INFO_CD <> 'AD'
        )
        OR EXISTS (
            SELECT 'X'
            FROM PRI_RP_SCP_RT_CMDT_ROUT E
            WHERE E.PROP_NO = A.PROP_NO
            AND   E.AMDT_SEQ = A.AMDT_SEQ
            AND   E.SVC_SCP_CD = A.SVC_SCP_CD
            AND   E.CMDT_HDR_SEQ = A.CMDT_HDR_SEQ
            AND   (
                EXISTS (
                    SELECT 'X'
                    FROM PRI_RP_SCP_RT_ROUT_PNT F
                    WHERE F.PROP_NO = E.PROP_NO
                    AND   F.AMDT_SEQ = E.AMDT_SEQ
                    AND   F.SVC_SCP_CD = E.SVC_SCP_CD
                    AND   F.CMDT_HDR_SEQ = E.CMDT_HDR_SEQ
                    AND   F.ROUT_SEQ = E.ROUT_SEQ
                    AND   F.SRC_INFO_CD <> 'AD'
                )
                OR EXISTS (
                    SELECT 'X'
                    FROM PRI_RP_SCP_RT_ROUT_VIA G
                    WHERE G.PROP_NO = E.PROP_NO
                    AND   G.AMDT_SEQ = E.AMDT_SEQ
                    AND   G.SVC_SCP_CD = E.SVC_SCP_CD
                    AND   G.CMDT_HDR_SEQ = E.CMDT_HDR_SEQ
                    AND   G.ROUT_SEQ = E.ROUT_SEQ
                    AND   G.SRC_INFO_CD <> 'AD'
                )
                OR EXISTS (
                    SELECT 'X'
                    FROM PRI_RP_SCP_RT_CMDT_RNOTE I
                    WHERE I.PROP_NO = E.PROP_NO
                    AND   I.AMDT_SEQ = E.AMDT_SEQ
                    AND   I.SVC_SCP_CD = E.SVC_SCP_CD
                    AND   I.CMDT_HDR_SEQ = E.CMDT_HDR_SEQ
                    AND   I.ROUT_SEQ = E.ROUT_SEQ
                    AND   I.SRC_INFO_CD <> 'AD'
                )
                OR EXISTS (
                    SELECT 'X'
                    FROM PRI_RP_SCP_RT J
                    WHERE J.PROP_NO = E.PROP_NO
                    AND   J.AMDT_SEQ = E.AMDT_SEQ
                    AND   J.SVC_SCP_CD = E.SVC_SCP_CD
                    AND   J.CMDT_HDR_SEQ = E.CMDT_HDR_SEQ
                    AND   J.ROUT_SEQ = E.ROUT_SEQ
                    AND   J.SRC_INFO_CD <> 'AD'
                )
            )
        )
    )
)
, CMDT_ROUT AS (
    SELECT L.PROP_NO
         , L.AMDT_SEQ
         , L.SVC_SCP_CD
         , K.OLD_CMDT_HDR_SEQ
         , K.CMDT_HDR_SEQ
         , L.ROUT_SEQ AS OLD_ROUT_SEQ
         , DENSE_RANK() OVER (PARTITION BY L.PROP_NO, L.AMDT_SEQ, L.SVC_SCP_CD, K.OLD_CMDT_HDR_SEQ
                              ORDER BY L.PROP_NO, L.AMDT_SEQ, L.SVC_SCP_CD, K.OLD_CMDT_HDR_SEQ, L.ROUT_SEQ) AS ROUT_SEQ
    FROM CMDT_HDR K
        ,PRI_RP_SCP_RT_CMDT_ROUT L
    WHERE L.PROP_NO = K.PROP_NO
    AND   L.AMDT_SEQ = K.AMDT_SEQ
    AND   L.SVC_SCP_CD = K.SVC_SCP_CD
    AND   L.CMDT_HDR_SEQ = K.OLD_CMDT_HDR_SEQ
    AND   (
        EXISTS (
            SELECT 'X'
            FROM PRI_RP_SCP_RT_ROUT_PNT F
            WHERE F.PROP_NO = L.PROP_NO
            AND   F.AMDT_SEQ = L.AMDT_SEQ
            AND   F.SVC_SCP_CD = L.SVC_SCP_CD
            AND   F.CMDT_HDR_SEQ = L.CMDT_HDR_SEQ
            AND   F.ROUT_SEQ = L.ROUT_SEQ
            AND   F.SRC_INFO_CD <> 'AD'
        )
        OR EXISTS (
            SELECT 'X'
            FROM PRI_RP_SCP_RT_ROUT_VIA G
            WHERE G.PROP_NO = L.PROP_NO
            AND   G.AMDT_SEQ = L.AMDT_SEQ
            AND   G.SVC_SCP_CD = L.SVC_SCP_CD
            AND   G.CMDT_HDR_SEQ = L.CMDT_HDR_SEQ
            AND   G.ROUT_SEQ = L.ROUT_SEQ
            AND   G.SRC_INFO_CD <> 'AD'
        )
        OR EXISTS (
            SELECT 'X'
            FROM PRI_RP_SCP_RT_CMDT_RNOTE I
            WHERE I.PROP_NO = L.PROP_NO
            AND   I.AMDT_SEQ = L.AMDT_SEQ
            AND   I.SVC_SCP_CD = L.SVC_SCP_CD
            AND   I.CMDT_HDR_SEQ = L.CMDT_HDR_SEQ
            AND   I.ROUT_SEQ = L.ROUT_SEQ
            AND   I.SRC_INFO_CD <> 'AD'
        )
        OR EXISTS (
            SELECT 'X'
            FROM PRI_RP_SCP_RT J
            WHERE J.PROP_NO = L.PROP_NO
            AND   J.AMDT_SEQ = L.AMDT_SEQ
            AND   J.SVC_SCP_CD = L.SVC_SCP_CD
            AND   J.CMDT_HDR_SEQ = L.CMDT_HDR_SEQ
            AND   J.ROUT_SEQ = L.ROUT_SEQ
            AND   J.SRC_INFO_CD <> 'AD'
        )
    )
)
, RATE_CMDT AS ( -- RATE COMMODITY
    SELECT B.PROP_NO
         , B.AMDT_SEQ
         , B.SVC_SCP_CD
         , B.PRC_CMDT_DEF_CD
    FROM CMDT_HDR A
        ,PRI_RP_SCP_RT_CMDT B
    WHERE B.PROP_NO = A.PROP_NO
    AND   B.AMDT_SEQ = A.AMDT_SEQ
    AND   B.SVC_SCP_CD = A.SVC_SCP_CD
    AND   B.CMDT_HDR_SEQ = A.OLD_CMDT_HDR_SEQ
    AND   B.SRC_INFO_CD <> 'AD'
)
, RATE_LOC_PNT AS ( -- RATE LOCATION POINT
    SELECT S.PROP_NO
         , S.AMDT_SEQ
         , S.SVC_SCP_CD
         , S.ROUT_PNT_LOC_DEF_CD
    FROM CMDT_ROUT R
        ,PRI_RP_SCP_RT_ROUT_PNT S
    WHERE S.PROP_NO = R.PROP_NO
    AND   S.AMDT_SEQ = R.AMDT_SEQ
    AND   S.SVC_SCP_CD = R.SVC_SCP_CD
    AND   S.CMDT_HDR_SEQ = R.OLD_CMDT_HDR_SEQ
    AND   S.ROUT_SEQ = R.OLD_ROUT_SEQ
    AND   S.SRC_INFO_CD <> 'AD' 
)
, RATE_LOC_VIA AS ( -- RATE LOCATION VIA
    SELECT S.PROP_NO
         , S.AMDT_SEQ
         , S.SVC_SCP_CD
         , S.ROUT_VIA_PORT_DEF_CD
    FROM CMDT_ROUT R
        ,PRI_RP_SCP_RT_ROUT_VIA S
    WHERE S.PROP_NO = R.PROP_NO
    AND   S.AMDT_SEQ = R.AMDT_SEQ
    AND   S.SVC_SCP_CD = R.SVC_SCP_CD
    AND   S.CMDT_HDR_SEQ = R.OLD_CMDT_HDR_SEQ
    AND   S.ROUT_SEQ = R.OLD_ROUT_SEQ
    AND   S.SRC_INFO_CD <> 'AD'
)
SELECT MN.PROP_NO
     , MN.AMDT_SEQ
     , MN.SVC_SCP_CD
     , SIGN(NVL(LO_CNT,0)+NVL(CO_CNT,0)
           +NVL(AO_CNT,0)+NVL(AD_CNT,0)
           +NVL(RT_CNT,0)+NVL(SN_CNT,0)) AS SCP_CHK
     , SIGN(NVL(LO_CNT,0)) AS LOCA_CHK
     , SIGN(NVL(CO_CNT,0)) AS CMDT_CHK
     , SIGN(NVL(AO_CNT,0)) AS AROR_CHK
     , SIGN(NVL(AD_CNT,0)) AS ARDE_CHK
     , SIGN(NVL(RT_CNT,0)) AS RATE_CHK
     , SIGN(NVL(SN_CNT,0)) AS SPNT_CHK
     , SIGN(NVL(RC.CNT,0)) AS RT_CMDT_CNT
     , SIGN(NVL(RP.CNT,0) + NVL(RV.CNT,0)) AS RT_LOC_CNT
     , SIGN(NVL(AL.AOL_CNT,0)) AS AO_LOC_CNT
     , SIGN(NVL(AL.ADL_CNT,0)) AS AD_LOC_CNT
     , '' AS RFA_NO
     , '' AS NEW_PROP_NO
     , 0 AS AFIL_CHK
     , '' AS CRE_USR_ID
     , '' AS UPD_USR_ID
     , '' AS OFC_CD
     , '' AS SREP_CD
     , '' AS ORG_DEST_TP_CD
     , '' AS ADD_CHG_TP_CD
     , '' AS NOTE_TP_CD
FROM (
    -- SCP_MAIN
    SELECT PROP_NO
         , AMDT_SEQ
         , SVC_SCP_CD
         , CRE_DT
    FROM PRI_RP_SCP_MN
    WHERE PROP_NO = @[prop_no]
    AND   AMDT_SEQ = @[amdt_seq]
) MN
LEFT OUTER JOIN
(
    -- LOCATION
    SELECT SVC_SCP_CD
          ,COUNT(GRP_LOC_SEQ) AS LO_CNT
    FROM PRI_RP_SCP_GRP_LOC
    WHERE PROP_NO = @[prop_no]
    AND   AMDT_SEQ = @[amdt_seq]
    GROUP BY SVC_SCP_CD
) LO
ON LO.SVC_SCP_CD = MN.SVC_SCP_CD
LEFT OUTER JOIN
(
    -- COMMODITY
    SELECT SVC_SCP_CD
          ,COUNT(GRP_CMDT_SEQ) AS CO_CNT
    FROM PRI_RP_SCP_GRP_CMDT
    WHERE PROP_NO = @[prop_no]
    AND   AMDT_SEQ = @[amdt_seq]
    GROUP BY SVC_SCP_CD
) CO
ON CO.SVC_SCP_CD = MN.SVC_SCP_CD
LEFT OUTER JOIN
(
    -- ARBITRARY ORIGIN
    SELECT SVC_SCP_CD
          ,COUNT(ADD_CHG_SEQ) AS AO_CNT
    FROM PRI_RP_SCP_TRSP_ADD_CHG
    WHERE PROP_NO = @[prop_no]
    AND   AMDT_SEQ = @[amdt_seq]
    AND   ADD_CHG_TP_CD = 'A'
    AND   ORG_DEST_TP_CD = 'O'
    GROUP BY SVC_SCP_CD
) AO
ON AO.SVC_SCP_CD = MN.SVC_SCP_CD
LEFT OUTER JOIN
(
    -- ARBITRARY DEST
    SELECT SVC_SCP_CD
          ,COUNT(ADD_CHG_SEQ) AS AD_CNT
    FROM PRI_RP_SCP_TRSP_ADD_CHG
    WHERE PROP_NO = @[prop_no]
    AND   AMDT_SEQ = @[amdt_seq]
    AND   ADD_CHG_TP_CD = 'A'
    AND   ORG_DEST_TP_CD = 'D'
    GROUP BY SVC_SCP_CD
) AD
ON AD.SVC_SCP_CD = MN.SVC_SCP_CD
LEFT OUTER JOIN
(
    -- RATE
    SELECT SVC_SCP_CD
          ,COUNT(RT_SEQ) AS RT_CNT
    FROM PRI_RP_SCP_RT
    WHERE PROP_NO = @[prop_no]
    AND   AMDT_SEQ = @[amdt_seq]
    GROUP BY SVC_SCP_CD
) RT
ON RT.SVC_SCP_CD = MN.SVC_SCP_CD
LEFT OUTER JOIN
(
    -- SPECIAL NOTE
    SELECT SVC_SCP_CD
          ,COUNT(NOTE_SEQ) AS SN_CNT
    FROM PRI_RP_SCP_NOTE
    WHERE PROP_NO = @[prop_no]
    AND   AMDT_SEQ = @[amdt_seq]
    AND   NOTE_TP_CD = 'P'
    GROUP BY SVC_SCP_CD
) SN
ON SN.SVC_SCP_CD = MN.SVC_SCP_CD
LEFT OUTER JOIN
( -- RATE COMMODITY EXIST COUNT
    SELECT B.PROP_NO
         , B.AMDT_SEQ
         , B.SVC_SCP_CD
         , COUNT(B.PROP_NO) AS CNT
    FROM RATE_CMDT A
        ,PRI_RP_SCP_GRP_CMDT B
    WHERE B.PROP_NO = A.PROP_NO
    AND   B.AMDT_SEQ = A.AMDT_SEQ
    AND   B.SVC_SCP_CD = A.SVC_SCP_CD
    AND   B.PRC_GRP_CMDT_CD = A.PRC_CMDT_DEF_CD
    GROUP BY B.PROP_NO, B.AMDT_SEQ, B.SVC_SCP_CD
) RC
ON RC.SVC_SCP_CD = MN.SVC_SCP_CD
LEFT OUTER JOIN
( -- RATE LOCATION POINT EXIST COUNT
    SELECT S.PROP_NO
         , S.AMDT_SEQ
         , S.SVC_SCP_CD
         , COUNT(S.PROP_NO) AS CNT
    FROM RATE_LOC_PNT R
        ,PRI_RP_SCP_GRP_LOC S
    WHERE S.PROP_NO = R.PROP_NO
    AND   S.AMDT_SEQ = R.AMDT_SEQ
    AND   S.SVC_SCP_CD = R.SVC_SCP_CD
    AND   S.PRC_GRP_LOC_CD = R.ROUT_PNT_LOC_DEF_CD
    GROUP BY S.PROP_NO, S.AMDT_SEQ, S.SVC_SCP_CD
) RP
ON RP.SVC_SCP_CD = MN.SVC_SCP_CD
LEFT OUTER JOIN
( -- RATE LOCATION VIA EXIST COUNT
    SELECT S.PROP_NO
         , S.AMDT_SEQ
         , S.SVC_SCP_CD
         , COUNT(S.PROP_NO) AS CNT
    FROM RATE_LOC_VIA R
        ,PRI_RP_SCP_GRP_LOC S
    WHERE S.PROP_NO = R.PROP_NO
    AND   S.AMDT_SEQ = R.AMDT_SEQ
    AND   S.SVC_SCP_CD = R.SVC_SCP_CD
    AND   S.PRC_GRP_LOC_CD = R.ROUT_VIA_PORT_DEF_CD
    GROUP BY S.PROP_NO, S.AMDT_SEQ, S.SVC_SCP_CD
) RV
ON RV.SVC_SCP_CD = MN.SVC_SCP_CD
LEFT OUTER JOIN
(   --- ARBITRARY LOC EXIST CHECK
    SELECT A.PROP_NO
         , A.AMDT_SEQ
         , A.SVC_SCP_CD
         , SUM(NVL((SELECT 1
		            FROM PRI_RP_SCP_GRP_LOC B
		            WHERE B.PROP_NO = A.PROP_NO
		            AND   B.AMDT_SEQ = A.AMDT_SEQ
		            AND   B.SVC_SCP_CD = A.SVC_SCP_CD
		            AND   B.PRC_GRP_LOC_CD = A.BSE_PORT_DEF_CD
					AND   A.ORG_DEST_TP_CD = 'O'
           ),0)) AS AOL_CNT
         , SUM(NVL((SELECT 1
		            FROM PRI_RP_SCP_GRP_LOC B
		            WHERE B.PROP_NO = A.PROP_NO
		            AND   B.AMDT_SEQ = A.AMDT_SEQ
		            AND   B.SVC_SCP_CD = A.SVC_SCP_CD
		            AND   B.PRC_GRP_LOC_CD = A.BSE_PORT_DEF_CD
					AND   A.ORG_DEST_TP_CD = 'D'
           ),0)) AS ADL_CNT
    FROM PRI_RP_SCP_TRSP_ADD_CHG A
    WHERE A.PROP_NO = @[prop_no]
    AND   A.AMDT_SEQ = @[amdt_seq]
    AND   A.ADD_CHG_TP_CD = 'A'
    GROUP BY A.PROP_NO, A.AMDT_SEQ, A.SVC_SCP_CD
) AL
ON AL.SVC_SCP_CD = MN.SVC_SCP_CD
ORDER BY MN.CRE_DT, MN.SVC_SCP_CD			]]></sql>
			<params>
				<param name="prop_no" type="12" value="" out="N"/>
				<param name="amdt_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
