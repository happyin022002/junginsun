<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="RFARateQuotationDBDAOPriRqRtAdjustUSQL">
			<desc><![CDATA[pri_rq_rt를 일괄 조정한다.
* 2011.06.29 김민아 [CHM-201111837] Split 20-R4J Rule Upgrade 관련 소스품질 향상을 위한 조치 건 : DUAL Table을 부적절하게 사용한 DBDAO의 SQL을 .Query로 이동   ]]></desc>
			<sql><![CDATA[
MERGE INTO PRI_RQ_RT A                         
USING (

	WITH VW_RATE_ADJUST_LIST AS (

#foreach( ${obj} in ${list_obj} )
    #if( $velocityCount != 1 )
        UNION ALL
    #end				
        SELECT  DECODE('$obj.getApplication()', NULL, 'NULL', '$obj.getApplication()') AS APPLICATION
               ,DECODE('$obj.getOriLocDefCd()', NULL, 'NULL', '$obj.getOriLocDefCd()') AS ORI_LOC_DEF_CD
               ,DECODE('$obj.getOriTermCd()', NULL, 'NULL', '$obj.getOriTermCd()') AS ORI_TERM_CD  
               ,DECODE('$obj.getDestLocDefCd()', NULL, 'NULL', '$obj.getDestLocDefCd()') AS DEST_LOC_DEF_CD  
               ,DECODE('$obj.getOriViaDefCd()', NULL, 'NULL', '$obj.getOriViaDefCd()') AS ORI_VIA_DEF_CD  
               ,DECODE('$obj.getDestViaDefCd()', NULL, 'NULL', '$obj.getDestViaDefCd()') AS DEST_VIA_DEF_CD  
               ,DECODE('$obj.getDestTermCd()', NULL, 'NULL', '$obj.getDestTermCd()') AS DEST_TERM_CD  
               ,DECODE('$obj.getQttnNo()', NULL, 'NULL', '$obj.getQttnNo()') AS QTTN_NO  
               ,DECODE('$obj.getQttnVerNo()', NULL, 'NULL', '$obj.getQttnVerNo()') AS QTTN_VER_NO  
               ,DECODE('$obj.getGenSpclRtTpCd()', NULL, 'NULL', '$obj.getGenSpclRtTpCd()') AS GEN_SPCL_RT_TP_CD  
               ,DECODE('$obj.getCmdtHdrSeq()', NULL, 'NULL', '$obj.getCmdtHdrSeq()') AS CMDT_HDR_SEQ  
               ,DECODE('$obj.getMatchingPnt()', NULL, 'NULL', '$obj.getMatchingPnt()') AS MATCHING_PNT  
               ,DECODE('$obj.getPer()', NULL, 'NULL', '$obj.getPer()') AS PER  
               ,DECODE('$obj.getCargo()', NULL, 'NULL', '$obj.getCargo()') AS CARGO 			
               ,DECODE('$obj.getCurrency()', NULL, 'NULL', '$obj.getCurrency()') AS CURRENCY  
               ,DECODE('$obj.getAmount()', NULL, 'NULL', '$obj.getAmount()') AS AMOUNT  
               ,DECODE('$obj.getPercent()', NULL, 'NULL', '$obj.getPercent()') AS PCNT  
               ,DECODE('$obj.getUpdUsrId()', NULL, 'NULL', '$obj.getUpdUsrId()') AS UPD_USR_ID 
               ,(SELECT  USD_LOCL_XCH_RT 
                   FROM  GL_MON_XCH_RT  
                  WHERE  ACCT_XCH_RT_YRMON = (SELECT  MAX(ACCT_XCH_RT_YRMON) 
                                                FROM  GL_MON_XCH_RT 
                                               WHERE  CURR_CD = '$obj.getCurrency()'
                                                 AND  ACCT_XCH_RT_LVL = '1') 
                    AND  CURR_CD = '$obj.getCurrency()' 
                    AND  ACCT_XCH_RT_LVL = '1' ) XCH_RATE 
          FROM DUAL
#end

	) ,
	VW_ORI_RQ_RT_ROUT_PNT AS (
		SELECT
			QTTN_NO
			, QTTN_VER_NO
			, CMDT_HDR_SEQ
			, ROUT_SEQ
			, ORG_DEST_TP_CD
			, ROUT_PNT_SEQ
			, ROUT_PNT_LOC_TP_CD
			, ROUT_PNT_LOC_DEF_CD
			, PRC_TRSP_MOD_CD
			, RCV_DE_TERM_CD
			, SRC_INFO_CD
		FROM PRI_RQ_RT_ROUT_PNT
		WHERE QTTN_NO = @[qttn_no]
		AND QTTN_VER_NO = @[qttn_ver_no]
		AND ORG_DEST_TP_CD = 'O'
	),
	VW_DEST_RQ_RT_ROUT_PNT AS (
		SELECT
			QTTN_NO
			, QTTN_VER_NO
			, CMDT_HDR_SEQ
			, ROUT_SEQ
			, ORG_DEST_TP_CD
			, ROUT_PNT_SEQ
			, ROUT_PNT_LOC_TP_CD
			, ROUT_PNT_LOC_DEF_CD
			, PRC_TRSP_MOD_CD
			, RCV_DE_TERM_CD
			, SRC_INFO_CD
		FROM PRI_RQ_RT_ROUT_PNT
		WHERE QTTN_NO = @[qttn_no]
		AND QTTN_VER_NO = @[qttn_ver_no]
		AND ORG_DEST_TP_CD = 'D'
	),
	VW_ORI_RQ_RT_ROUT_VIA AS (
		SELECT
			QTTN_NO
			, QTTN_VER_NO
			, CMDT_HDR_SEQ
			, ROUT_SEQ
			, ORG_DEST_TP_CD
			, ROUT_VIA_SEQ
			, ROUT_VIA_PORT_TP_CD
			, ROUT_VIA_PORT_DEF_CD
			, SRC_INFO_CD
		FROM PRI_RQ_RT_ROUT_VIA
		WHERE QTTN_NO = @[qttn_no]
		AND QTTN_VER_NO = @[qttn_ver_no]
		AND ORG_DEST_TP_CD = 'O'
	),
	VW_DEST_RQ_RT_ROUT_VIA AS (
		SELECT
			QTTN_NO
			, QTTN_VER_NO
			, CMDT_HDR_SEQ
			, ROUT_SEQ
			, ORG_DEST_TP_CD
			, ROUT_VIA_SEQ
			, ROUT_VIA_PORT_TP_CD
			, ROUT_VIA_PORT_DEF_CD
			, SRC_INFO_CD
		FROM PRI_RQ_RT_ROUT_VIA
		WHERE QTTN_NO = @[qttn_no]
		AND QTTN_VER_NO = @[qttn_ver_no]
		AND ORG_DEST_TP_CD = 'D'
	),
	VW_EXCLUDE_RT AS (
		SELECT DISTINCT
			RT.QTTN_NO
			, RT.QTTN_VER_NO
			, RT.CMDT_HDR_SEQ
			, RT.ROUT_SEQ
			, RT.RT_SEQ
		FROM	VW_RATE_ADJUST_LIST VW_RATE
			, PRI_RQ_RT_CMDT_ROUT MN
			, VW_ORI_RQ_RT_ROUT_PNT VM_ORI_PNT
			, VW_DEST_RQ_RT_ROUT_PNT VM_DEST_PNT
			, VW_ORI_RQ_RT_ROUT_VIA VM_ORI_VIA
			, VW_DEST_RQ_RT_ROUT_VIA VM_DEST_VIA
			, PRI_RQ_RT RT
		WHERE	
			  MN.QTTN_NO = RT.QTTN_NO
			AND MN.QTTN_VER_NO = RT.QTTN_VER_NO
			AND MN.CMDT_HDR_SEQ = RT.CMDT_HDR_SEQ
			AND MN.ROUT_SEQ = RT.ROUT_SEQ

			AND MN.QTTN_NO = VW_RATE.QTTN_NO
			AND MN.QTTN_VER_NO = VW_RATE.QTTN_VER_NO
			AND MN.CMDT_HDR_SEQ = VW_RATE.CMDT_HDR_SEQ

			AND MN.QTTN_NO = VM_ORI_PNT.QTTN_NO(+)
			AND MN.QTTN_VER_NO = VM_ORI_PNT.QTTN_VER_NO(+)
			AND MN.CMDT_HDR_SEQ = VM_ORI_PNT.CMDT_HDR_SEQ(+)
			AND MN.ROUT_SEQ = VM_ORI_PNT.ROUT_SEQ(+)

			AND MN.QTTN_NO = VM_DEST_PNT.QTTN_NO(+)
			AND MN.QTTN_VER_NO = VM_DEST_PNT.QTTN_VER_NO(+)
			AND MN.CMDT_HDR_SEQ = VM_DEST_PNT.CMDT_HDR_SEQ(+)
			AND MN.ROUT_SEQ = VM_DEST_PNT.ROUT_SEQ(+)
			AND MN.QTTN_NO = VM_ORI_VIA.QTTN_NO(+)
			AND MN.QTTN_VER_NO = VM_ORI_VIA.QTTN_VER_NO(+)
			AND MN.CMDT_HDR_SEQ = VM_ORI_VIA.CMDT_HDR_SEQ(+)
			AND MN.ROUT_SEQ = VM_ORI_VIA.ROUT_SEQ(+)
			AND MN.QTTN_NO = VM_DEST_VIA.QTTN_NO(+)
			AND MN.QTTN_VER_NO = VM_DEST_VIA.QTTN_VER_NO(+)
			AND MN.CMDT_HDR_SEQ = VM_DEST_VIA.CMDT_HDR_SEQ(+)
			AND MN.ROUT_SEQ = VM_DEST_VIA.ROUT_SEQ(+)


			AND VW_RATE.APPLICATION = 'E'
 
			AND VW_RATE.CARGO = DECODE(VW_RATE.CARGO,'NULL',VW_RATE.CARGO,RT.PRC_CGO_TP_CD)
			AND VW_RATE.PER = DECODE(VW_RATE.PER,'NULL',VW_RATE.PER,RT.RAT_UT_CD )

			AND VW_RATE.ORI_LOC_DEF_CD = DECODE(VW_RATE.ORI_LOC_DEF_CD,'NULL',VW_RATE.ORI_LOC_DEF_CD,VM_ORI_PNT.ROUT_PNT_LOC_DEF_CD)
			AND VW_RATE.ORI_TERM_CD = DECODE(VW_RATE.ORI_TERM_CD,'NULL',VW_RATE.ORI_TERM_CD,VM_ORI_PNT.RCV_DE_TERM_CD)

			AND VW_RATE.DEST_LOC_DEF_CD = DECODE(VW_RATE.DEST_LOC_DEF_CD,'NULL',VW_RATE.DEST_LOC_DEF_CD,VM_DEST_PNT.ROUT_PNT_LOC_DEF_CD)
			AND VW_RATE.DEST_TERM_CD = DECODE(VW_RATE.DEST_TERM_CD,'NULL',VW_RATE.DEST_TERM_CD,VM_DEST_PNT.RCV_DE_TERM_CD)

			AND VW_RATE.ORI_VIA_DEF_CD = DECODE(VW_RATE.ORI_VIA_DEF_CD,'NULL',VW_RATE.ORI_VIA_DEF_CD,VM_ORI_VIA.ROUT_VIA_PORT_DEF_CD)
			AND VW_RATE.DEST_VIA_DEF_CD = DECODE(VW_RATE.DEST_VIA_DEF_CD,'NULL',VW_RATE.DEST_VIA_DEF_CD,VM_DEST_VIA.ROUT_VIA_PORT_DEF_CD)


	)

	SELECT QTTN_NO
		, QTTN_VER_NO
		, CMDT_HDR_SEQ
		, ROUT_SEQ
		, RT_SEQ
		, RAT_UT_CD
		, PRC_CGO_TP_CD
		, CURR_CD
		, PRS_SCG_AMT
		, QTTN_RT_AMT
		, VAL
		, PCNT
		, MATCHING_PNT
		, RK
	FROM (
		SELECT 
			RT.QTTN_NO
			, RT.QTTN_VER_NO
			, RT.CMDT_HDR_SEQ
			, RT.ROUT_SEQ
			, RT.RT_SEQ
			, RT.RAT_UT_CD
			, RT.PRC_CGO_TP_CD
			, RT.CURR_CD
			, RT.PRS_SCG_AMT
			, RT.QTTN_RT_AMT
			, DECODE( @[rate_adjust],'AMT',RT.QTTN_RT_AMT + (VW_RATE.AMOUNT/VW_RATE.XCH_RATE), RT.QTTN_RT_AMT + (RT.QTTN_RT_AMT * (VW_RATE.PCNT/100)) ) VAL
			, VW_RATE.PCNT
			, VW_RATE.MATCHING_PNT
			, RANK() OVER(PARTITION BY RT.CMDT_HDR_SEQ,RT.ROUT_SEQ,RT.RT_SEQ ORDER BY VW_RATE.MATCHING_PNT DESC , VW_RATE.AMOUNT DESC,ROWNUM) RK
		FROM	VW_RATE_ADJUST_LIST VW_RATE
			, PRI_RQ_RT_CMDT_ROUT MN
			, VW_ORI_RQ_RT_ROUT_PNT VM_ORI_PNT
			, VW_DEST_RQ_RT_ROUT_PNT VM_DEST_PNT
			, VW_ORI_RQ_RT_ROUT_VIA VM_ORI_VIA
			, VW_DEST_RQ_RT_ROUT_VIA VM_DEST_VIA
			, PRI_RQ_RT RT
			
		WHERE	
			 MN.QTTN_NO = RT.QTTN_NO
			AND MN.QTTN_VER_NO = RT.QTTN_VER_NO
			AND MN.CMDT_HDR_SEQ = RT.CMDT_HDR_SEQ
			AND MN.ROUT_SEQ = RT.ROUT_SEQ
			and MN.QTTN_NO = @[qttn_no]
			AND MN.QTTN_VER_NO = @[qttn_ver_no]

			AND MN.QTTN_NO = VM_ORI_PNT.QTTN_NO(+)
			AND MN.QTTN_VER_NO = VM_ORI_PNT.QTTN_VER_NO(+)
			AND MN.CMDT_HDR_SEQ = VM_ORI_PNT.CMDT_HDR_SEQ(+)
			AND MN.ROUT_SEQ = VM_ORI_PNT.ROUT_SEQ(+)

			AND MN.QTTN_NO = VM_DEST_PNT.QTTN_NO(+)
			AND MN.QTTN_VER_NO = VM_DEST_PNT.QTTN_VER_NO(+)
			AND MN.CMDT_HDR_SEQ = VM_DEST_PNT.CMDT_HDR_SEQ(+)
			AND MN.ROUT_SEQ = VM_DEST_PNT.ROUT_SEQ(+)
			AND MN.QTTN_NO = VM_ORI_VIA.QTTN_NO(+)
			AND MN.QTTN_VER_NO = VM_ORI_VIA.QTTN_VER_NO(+)
			AND MN.CMDT_HDR_SEQ = VM_ORI_VIA.CMDT_HDR_SEQ(+)
			AND MN.ROUT_SEQ = VM_ORI_VIA.ROUT_SEQ(+)
			AND MN.QTTN_NO = VM_DEST_VIA.QTTN_NO(+)
			AND MN.QTTN_VER_NO = VM_DEST_VIA.QTTN_VER_NO(+)
			AND MN.CMDT_HDR_SEQ = VM_DEST_VIA.CMDT_HDR_SEQ(+)
			AND MN.ROUT_SEQ = VM_DEST_VIA.ROUT_SEQ(+)

			AND MN.QTTN_NO = VW_RATE.QTTN_NO
			AND MN.QTTN_VER_NO = VW_RATE.QTTN_VER_NO
			AND MN.CMDT_HDR_SEQ = VW_RATE.CMDT_HDR_SEQ

			AND VW_RATE.APPLICATION = 'I'
 
			AND VW_RATE.CARGO = DECODE(VW_RATE.CARGO,'NULL',VW_RATE.CARGO,RT.PRC_CGO_TP_CD)
			AND VW_RATE.PER = DECODE(VW_RATE.PER,'NULL',VW_RATE.PER,RT.RAT_UT_CD )

			AND VW_RATE.ORI_LOC_DEF_CD = DECODE(VW_RATE.ORI_LOC_DEF_CD,'NULL',VW_RATE.ORI_LOC_DEF_CD,VM_ORI_PNT.ROUT_PNT_LOC_DEF_CD)
			AND VW_RATE.ORI_TERM_CD = DECODE(VW_RATE.ORI_TERM_CD,'NULL',VW_RATE.ORI_TERM_CD,VM_ORI_PNT.RCV_DE_TERM_CD)

			AND VW_RATE.DEST_LOC_DEF_CD = DECODE(VW_RATE.DEST_LOC_DEF_CD,'NULL',VW_RATE.DEST_LOC_DEF_CD,VM_DEST_PNT.ROUT_PNT_LOC_DEF_CD)
			AND VW_RATE.DEST_TERM_CD = DECODE(VW_RATE.DEST_TERM_CD,'NULL',VW_RATE.DEST_TERM_CD,VM_DEST_PNT.RCV_DE_TERM_CD)

			AND VW_RATE.ORI_VIA_DEF_CD = DECODE(VW_RATE.ORI_VIA_DEF_CD,'NULL',VW_RATE.ORI_VIA_DEF_CD,VM_ORI_VIA.ROUT_VIA_PORT_DEF_CD)
			AND VW_RATE.DEST_VIA_DEF_CD = DECODE(VW_RATE.DEST_VIA_DEF_CD,'NULL',VW_RATE.DEST_VIA_DEF_CD,VM_DEST_VIA.ROUT_VIA_PORT_DEF_CD)
			AND EXISTS (SELECT 'T'
							    FROM PRI_RQ_RT_CMDT_HDR G
							   WHERE G.QTTN_NO = @[qttn_no]
								 AND G.QTTN_VER_NO = @[qttn_ver_no]
								 AND NVL(G.FIC_RT_TP_CD, 'G') = NVL(@[fic_rt_tp_cd], 'G'))
			AND NOT EXISTS (	SELECT 'F' 
						FROM VW_EXCLUDE_RT EX
						WHERE	 EX.QTTN_NO = RT.QTTN_NO
							AND EX.QTTN_VER_NO = RT.QTTN_VER_NO
							AND EX.CMDT_HDR_SEQ = RT.CMDT_HDR_SEQ
							AND EX.ROUT_SEQ = RT.ROUT_SEQ
							AND EX.RT_SEQ = RT.RT_SEQ
					)            
	)
	WHERE RK = 1
 ) B                                 
   ON (  
   A.QTTN_NO = B.QTTN_NO
AND A.QTTN_VER_NO = B.QTTN_VER_NO
AND A.CMDT_HDR_SEQ = B.CMDT_HDR_SEQ
AND A.ROUT_SEQ = B.ROUT_SEQ
AND A.RT_SEQ = B.RT_SEQ
   
   )
 WHEN MATCHED THEN                                       
     UPDATE SET        
				A.QTTN_RT_AMT = B.VAL
				,A.QTTN_RT_ADJ_TP_CD = 'A'
                ,A.UPD_DT      = SYSDATE			]]></sql>
			<params>
				<param name="qttn_no" type="12" value="" out="N"/>
				<param name="qttn_ver_no" type="12" value="" out="N"/>
				<param name="rate_adjust" type="12" value="" out="N"/>
				<param name="fic_rt_tp_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
