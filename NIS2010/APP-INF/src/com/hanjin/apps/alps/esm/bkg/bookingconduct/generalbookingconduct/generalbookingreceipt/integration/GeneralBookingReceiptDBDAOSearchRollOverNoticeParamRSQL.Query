<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="GeneralBookingReceiptDBDAOSearchRollOverNoticeParamRSQL">
			<desc><![CDATA[Roll Over Notice 발송 여부와 발송을 위한 항목을 조회 한다.]]></desc>
			<sql><![CDATA[
SELECT BK.BKG_NO 
     , (SELECT VSL_SLAN_CD FROM VSK_VSL_SKD 
         WHERE VSL_CD = PRE.PRE_VSL_CD AND SKD_VOY_NO = PRE.PRE_SKD_VOY_NO AND SKD_DIR_CD = PRE.PRE_SKD_DIR_CD AND ROWNUM = 1) PRE_LANE
     , (SELECT VSL_SLAN_CD FROM VSK_VSL_SKD 
         WHERE VSL_CD = PRE.NEW_VSL_CD AND SKD_VOY_NO = PRE.NEW_SKD_VOY_NO AND SKD_DIR_CD = PRE.NEW_SKD_DIR_CD AND ROWNUM = 1) NEW_LANE           
     , PRE.PRE_VSL_CD||PRE.PRE_SKD_VOY_NO||PRE.PRE_SKD_DIR_CD PRE_VVD
     , PRE.NEW_VSL_CD||PRE.NEW_SKD_VOY_NO||PRE.NEW_SKD_DIR_CD NEW_VVD
     , BK.BKG_OFC_CD
     , LTRIM(RTRIM(DECODE(OB_REP.SREP_EML, CTRT_REP.SREP_EML, OB_REP.SREP_EML, OB_REP.SREP_EML||';'||CTRT_REP.SREP_EML),';'),';') SREP_EML
     , NVL(BK.SC_NO, NVL(RFA_NO, TAA_NO))CTRT_NO
     , (SELECT MDM.CUST_LGL_ENG_NM 
          FROM BKG_CUSTOMER CUST
             , MDM_CUSTOMER MDM
         WHERE CUST.BKG_NO         = BK.BKG_NO
           AND CUST.BKG_CUST_TP_CD = 'S'
           AND MDM.CUST_CNT_CD     = CUST.CUST_CNT_CD
           AND MDM.CUST_SEQ        = CUST.CUST_SEQ
           AND MDM.DELT_FLG       <> 'Y'
           AND ROWNUM = 1)CUST_NM
  FROM BKG_BOOKING  BK
     , BKG_ROLL_OVR NEW
     , BKG_ROLL_OVR PRE
     , MDM_SLS_REP  OB_REP
     , MDM_SLS_REP  CTRT_REP
     
 WHERE BK.BKG_NO = @[bkg_no]
   AND NEW.BKG_NO = BK.BKG_NO
   AND PRE.BKG_NO = BK.BKG_NO
   AND NEW.ROLL_OVR_SEQ = (SELECT MAX(ROLL_OVR_SEQ) 
                             FROM BKG_ROLL_OVR 
                            WHERE BKG_NO = BK.BKG_NO)    
   AND PRE.ROLL_OVR_SEQ = (SELECT MAX(ROLL_OVR_SEQ) 
                             FROM BKG_ROLL_OVR 
                            WHERE BKG_NO = BK.BKG_NO
                              AND ROLL_OVR_SEQ <> NEW.ROLL_OVR_SEQ)     
   AND OB_REP.SREP_CD = OB_SREP_CD      
   AND CTRT_REP.SREP_CD = CTRT_SREP_CD                     
   AND GLOBALDATE_PKG.TIME_CONV_FNC('KRSEL',sysdate,BK.POL_CD) BETWEEN PRE.PRE_ETD_DT-5 AND PRE.PRE_ETD_DT
   AND PRE.PRE_ETD_DT < PRE.NEW_ETD_DT
   AND BK.NON_RT_STS_CD <> 'R'			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
