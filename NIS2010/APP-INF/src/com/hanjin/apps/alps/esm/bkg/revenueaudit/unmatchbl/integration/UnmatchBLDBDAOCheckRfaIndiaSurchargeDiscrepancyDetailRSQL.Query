<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="UnmatchBLDBDAOCheckRfaIndiaSurchargeDiscrepancyDetailRSQL">
			<desc><![CDATA[India에 대하여 RFA SurchargeDiscrepancy Detail 를 조회한다.]]></desc>
			<sql><![CDATA[
WITH
XR AS
(
/*******************************************************************************************
환율 정보 조회
*******************************************************************************************/

SELECT  CURR_CD         ,
        USD_LOCL_XCH_RT
FROM    GL_MON_XCH_RT
WHERE   ACCT_XCH_RT_YRMON = LEAST(( SELECT TO_CHAR(RT_APLY_DT, 'YYYYMM') FROM BKG_RATE WHERE BKG_NO = @[bkg_no] ), (SELECT MAX(ACCT_XCH_RT_YRMON) FROM GL_MON_XCH_RT ))
AND     ACCT_XCH_RT_LVL   = '1'
AND     @[ca_flg]         = 'N'

UNION ALL

SELECT  CURR_CD         ,
        USD_LOCL_XCH_RT
FROM    GL_MON_XCH_RT
WHERE   ACCT_XCH_RT_YRMON = LEAST(( SELECT TO_CHAR(RT_APLY_DT, 'YYYYMM') FROM BKG_RT_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO = 'TMP0000001' ), (SELECT MAX(ACCT_XCH_RT_YRMON) FROM GL_MON_XCH_RT ))
AND     ACCT_XCH_RT_LVL   = '1'
AND     @[ca_flg]         = 'Y'
) ,
BK AS
(
/*******************************************************************************************
B/L TYPE CODE 를 SELECT 한다.
*******************************************************************************************/

SELECT  (
        SELECT  NVL(RT_BL_TP_CD, 'N')
        FROM    BKG_RATE
        WHERE   BKG_NO        = @[bkg_no]
        AND     @[ca_flg]     = 'N'
        UNION ALL
        SELECT  NVL(RT_BL_TP_CD, 'N')
        FROM    BKG_RT_HIS
        WHERE   BKG_NO        = @[bkg_no]
        AND     CORR_NO       = 'TMP0000001'  -- CORRECTION 중인 DATA 를 나타내는 고정된 상수값
        AND     @[ca_flg]     = 'Y'
        ) RT_BL_TP_CD ,
        DECODE(
          (
          SELECT  SPLIT_RSN_CD
          FROM    BKG_BOOKING
          WHERE   BKG_NO        = ( SELECT FM_BKG_NO FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no] )
          AND     @[ca_flg]     = 'N'
          UNION ALL
          SELECT  SPLIT_RSN_CD
          FROM    BKG_BOOKING
          WHERE   BKG_NO        = ( SELECT FM_BKG_NO FROM BKG_BKG_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO = 'TMP0000001' )
          AND     @[ca_flg]     = 'Y'
          )
          , 'M', 'Y', 'N')  MEMO_BL_FLG ,
        (
        SELECT  MAX(BB_CGO_FLG)
        FROM    BKG_QTY_DTL
        WHERE   BKG_NO        = @[bkg_no]
        AND     @[ca_flg]     = 'N'
        HAVING  MAX(BB_CGO_FLG) IS NOT NULL
        UNION ALL
        SELECT  MAX(BB_CGO_FLG)
        FROM    BKG_QTY_DTL_HIS
        WHERE   BKG_NO        = @[bkg_no]
        AND     CORR_NO       = 'TMP0000001'  -- CORRECTION 중인 DATA 를 나타내는 고정된 상수값
        AND     @[ca_flg]     = 'Y'
        HAVING  MAX(BB_CGO_FLG) IS NOT NULL
        ) BB_CGO_FLG
FROM    DUAL
) ,
BR AS
(
/*******************************************************************************************
INCLUDE 를 제외한 BKG RATE DATA
COVERED B/L 일 경우는 'DHF', 'NMS', 'CMS', 'ODF' 만 심사 대상으로 처리함.
*******************************************************************************************/

SELECT  CHG_CD        ,
        CGO_CATE_CD   ,
        RCV_TERM_CD   ,
        DE_TERM_CD    ,
        RAT_AS_QTY    ,
        RAT_UT_CD     ,
        CURR_CD       ,
        CHG_UT_AMT    ,
        CHG_AMT       ,
        ( SELECT BR.CHG_AMT / XR.USD_LOCL_XCH_RT FROM XR WHERE XR.CURR_CD = BR.CURR_CD )  CHG_USD_AMT,
        SUM (( SELECT BR.CHG_AMT / XR.USD_LOCL_XCH_RT FROM XR WHERE XR.CURR_CD = BR.CURR_CD )) OVER (PARTITION BY CHG_CD, CHG_AMT) AS CHK_CHG_AMT
FROM    BKG_CHG_RT  BR
WHERE   BKG_NO        = @[bkg_no]
AND     NVL(FRT_INCL_XCLD_DIV_CD, 'N')  = 'N'
AND     (
            ( SELECT RT_BL_TP_CD FROM BK ) <> 'C'
        OR  CHG_CD  IN ( 'DHF', 'NMS', 'CMS', 'ODF' )
        )
AND     @[ca_flg]     = 'N'

UNION ALL

SELECT  CHG_CD        ,
        CGO_CATE_CD   ,
        RCV_TERM_CD   ,
        DE_TERM_CD    ,
        RAT_AS_QTY    ,
        RAT_UT_CD     ,
        CURR_CD       ,
        CHG_UT_AMT    ,
        CHG_AMT       ,
        ( SELECT BR.CHG_AMT / XR.USD_LOCL_XCH_RT FROM XR WHERE XR.CURR_CD = BR.CURR_CD )  CHG_USD_AMT,
        SUM (( SELECT BR.CHG_AMT / XR.USD_LOCL_XCH_RT FROM XR WHERE XR.CURR_CD = BR.CURR_CD )) OVER (PARTITION BY CHG_CD, CHG_AMT) AS CHK_CHG_AMT
FROM    BKG_CHG_RT_HIS  BR
WHERE   BKG_NO        = @[bkg_no]
AND     CORR_NO       = 'TMP0000001'
AND     NVL(FRT_INCL_XCLD_DIV_CD, 'N')  = 'N'
AND     (
            ( SELECT RT_BL_TP_CD FROM BK ) <> 'C'
        OR  CHG_CD  IN ( 'DHF', 'NMS', 'CMS', 'ODF' )
        )
AND     @[ca_flg]     = 'Y'
) ,
B1 AS
(
/*******************************************************************************************
BKG 의 OFT ( OFT, OAR, DAR )
BL RATING UNIT 을 고려하여 변환한다.
*******************************************************************************************/

SELECT  BR.*  ,
        ( SELECT BR.CHG_AMT / XR.USD_LOCL_XCH_RT FROM XR WHERE XR.CURR_CD = BR.CURR_CD )  CHG_USD_AMT,
        SUM (( SELECT BR.CHG_AMT / XR.USD_LOCL_XCH_RT FROM XR WHERE XR.CURR_CD = BR.CURR_CD )) OVER (PARTITION BY OFT_CMB_SEQ, CHG_CD, CHG_AMT) AS CHK_CHG_AMT
FROM    (
        SELECT  BR.OFT_CMB_SEQ  ,
                BR.CHG_CD       ,
                BR.CGO_CATE_CD  ,
                BR.RCV_TERM_CD  ,
                BR.DE_TERM_CD   ,
                CASE
                WHEN DECODE(CK.BL_FLG, 'Y', 'Y', 'N') = 'Y' THEN 1
                ELSE BR.RAT_AS_QTY
                END RAT_AS_QTY  ,
                CASE
                WHEN DECODE(CK.BL_FLG, 'Y', 'Y', 'N') = 'Y' THEN 'BL'
                ELSE BR.RAT_UT_CD
                END RAT_UT_CD   ,
                BR.CURR_CD      ,
                SUM(BR.CHG_AMT) CHG_AMT
        FROM    (
                SELECT  RA.OFT_CMB_SEQ  ,
                        BR.*
                FROM    BR    ,
                        (
                        SELECT  DISTINCT
                                OFT_CMB_SEQ
                        FROM    BKG_REV_AUD_CHG_TMP
                        ) RA
                WHERE   CHG_CD  IN ( 'OFT', 'OAR', 'DAR' )
                ) BR  ,
                (
                SELECT  OFT_CMB_SEQ ,
                        CHG_CD      ,
                        MAX(DECODE(RAT_UT_CD, 'BL', 'Y', 'N'))  BL_FLG
                FROM  BKG_REV_AUD_CHG_TMP
                WHERE   CHG_CD  IN ( 'OFT', 'OAR', 'DAR' )
                GROUP BY
                        OFT_CMB_SEQ ,
                        CHG_CD
                ) CK
        WHERE   CK.OFT_CMB_SEQ(+) = BR.OFT_CMB_SEQ
        AND     CK.CHG_CD(+)      = BR.CHG_CD
        GROUP BY
                BR.OFT_CMB_SEQ  ,
                BR.CHG_CD       ,
                BR.CGO_CATE_CD  ,
                BR.RCV_TERM_CD  ,
                BR.DE_TERM_CD   ,
                CASE
                WHEN DECODE(CK.BL_FLG, 'Y', 'Y', 'N') = 'Y' THEN 1
                ELSE BR.RAT_AS_QTY
                END             ,
                CASE
                WHEN DECODE(CK.BL_FLG, 'Y', 'Y', 'N') = 'Y' THEN 'BL'
                ELSE BR.RAT_UT_CD
                END             ,
                BR.CURR_CD
        ) BR
) ,
R1 AS
(
/*******************************************************************************************
AUDIT 의 OFT ( OFT, OAR, DAR )
BL RATING UNIT 을 고려하여 변환한다.
COVERED B/L 일 경우는 'DHF', 'NMS', 'CMS', 'ODF' 만 심사 대상으로 처리함.
*******************************************************************************************/

SELECT  RA.*  ,
        ( SELECT RA.CHG_AMT / XR.USD_LOCL_XCH_RT FROM XR WHERE XR.CURR_CD = RA.CURR_CD )  CHG_USD_AMT,
        SUM (( SELECT RA.CHG_AMT / XR.USD_LOCL_XCH_RT FROM XR WHERE XR.CURR_CD = RA.CURR_CD )) OVER (PARTITION BY OFT_CMB_SEQ, CHG_CD, CHG_AMT) AS CHK_CHG_AMT
FROM    (
        SELECT  RA.OFT_CMB_SEQ  ,
                RA.CHG_CD       ,
                RA.CGO_CATE_CD  ,
                RA.RCV_TERM_CD  ,
                RA.DE_TERM_CD   ,
                CASE
                WHEN DECODE(CK.BL_FLG, 'Y', 'Y', 'N') = 'Y' THEN 1
                ELSE RA.RAT_AS_QTY
                END RAT_AS_QTY  ,
                CASE
                WHEN DECODE(CK.BL_FLG, 'Y', 'Y', 'N') = 'Y' THEN 'BL'
                ELSE RA.RAT_UT_CD
                END RAT_UT_CD   ,
                RA.CURR_CD      ,
                SUM(RA.CHG_AMT) CHG_AMT
        FROM    BKG_REV_AUD_CHG_TMP RA  ,
                (
                SELECT  CHG_CD      ,
                        MAX(DECODE(RAT_UT_CD, 'BL', 'Y', 'N'))  BL_FLG
                FROM  BR
                GROUP BY
                        CHG_CD
                ) CK
        WHERE   CK.CHG_CD(+)      = RA.CHG_CD
        AND     RA.CHG_CD         IN ( 'OFT', 'OAR', 'DAR' )
        AND     (
                    ( SELECT RT_BL_TP_CD FROM BK ) <> 'C'
                OR  RA.CHG_CD IN ( 'DHF', 'NMS', 'CMS', 'ODF' )
                )
        GROUP BY
                RA.OFT_CMB_SEQ  ,
                RA.CHG_CD       ,
                RA.CGO_CATE_CD  ,
                RA.RCV_TERM_CD  ,
                RA.DE_TERM_CD   ,
                CASE
                WHEN DECODE(CK.BL_FLG, 'Y', 'Y', 'N') = 'Y' THEN 1
                ELSE RA.RAT_AS_QTY
                END             ,
                CASE
                WHEN DECODE(CK.BL_FLG, 'Y', 'Y', 'N') = 'Y' THEN 'BL'
                ELSE RA.RAT_UT_CD
                END             ,
                RA.CURR_CD
        ) RA
) ,
C1 AS
(
/*******************************************************************************************
OFT 가 일치하는 OFT_CMB_SEQ 를 SELECT 한다.
B1 와 R1 가 모두 값이 없으면 C1 이 값이 없어서 불일치하는 것으로 표현되므로,
UNION ALL 로 전체 OFT_CMB_SEQ 를 가져오는 부분을 추가하였음.
*******************************************************************************************/

(
SELECT  OFT_CMB_SEQ
FROM    (
        SELECT  R1.OFT_CMB_SEQ        ,
                SUM(DECODE(B1.CHG_CD, NULL, 1, 0))  UMCH_CNT
        FROM    (
                SELECT  OFT_CMB_SEQ   ,
                        CHG_CD        ,
                        CGO_CATE_CD   ,
                        RCV_TERM_CD   ,
                        DE_TERM_CD    ,
                        RAT_AS_QTY    ,
                        RAT_UT_CD     ,
                        CURR_CD       ,
                        CHG_AMT       ,
                        CHG_USD_AMT   ,
                        CHK_CHG_AMT
                FROM    R1
                WHERE   OFT_CMB_SEQ   NOT IN  (
                                              SELECT  DISTINCT
                                                      A.OFT_CMB_SEQ
                                              FROM    (
                                                      SELECT  OFT_CMB_SEQ   ,
                                                              CHG_CD        ,
                                                              COUNT(1)  CNT
                                                      FROM    R1
                                                      GROUP BY
                                                              OFT_CMB_SEQ ,
                                                              CHG_CD
                                                      ) A ,
                                                      (
                                                      SELECT  OFT_CMB_SEQ   ,
                                                              CHG_CD        ,
                                                              COUNT(1)  CNT
                                                      FROM    B1
                                                      GROUP BY
                                                              OFT_CMB_SEQ   ,
                                                              CHG_CD
                                                      ) B
                                              WHERE   B.OFT_CMB_SEQ(+)  = A.OFT_CMB_SEQ
                                              AND     B.CHG_CD(+)       = A.CHG_CD
                                              AND     B.CNT(+)          = A.CNT
                                              AND     B.CHG_CD          IS NULL
                                              )
                ) R1
                LEFT OUTER JOIN B1
                ON      B1.OFT_CMB_SEQ  = R1.OFT_CMB_SEQ
                AND     B1.CHG_CD       = R1.CHG_CD
                AND     B1.CHK_CHG_AMT  = R1.CHK_CHG_AMT
                AND     ABS(B1.CHG_USD_AMT - R1.CHG_USD_AMT) <= 5
        GROUP BY  R1.OFT_CMB_SEQ
        )
WHERE   UMCH_CNT  = 0

INTERSECT

SELECT  B1.OFT_CMB_SEQ
FROM    (
        SELECT  OFT_CMB_SEQ ,
                SUM(CHG_USD_AMT)  CHG_USD_AMT
        FROM    B1
        GROUP BY  OFT_CMB_SEQ
        ) B1  ,
        (
        SELECT  OFT_CMB_SEQ ,
                SUM(CHG_USD_AMT)  CHG_USD_AMT
        FROM    R1
        GROUP BY  OFT_CMB_SEQ
        ) R1
WHERE   R1.OFT_CMB_SEQ  = B1.OFT_CMB_SEQ
AND     ABS(B1.CHG_USD_AMT - R1.CHG_USD_AMT) <= 5
)

UNION ALL

SELECT  DISTINCT
        OFT_CMB_SEQ
FROM    BKG_REV_AUD_CHG_TMP A
WHERE ( SELECT COUNT(1) FROM B1 WHERE B1.OFT_CMB_SEQ = A.OFT_CMB_SEQ ) = 0
AND   ( SELECT COUNT(1) FROM R1 WHERE R1.OFT_CMB_SEQ = A.OFT_CMB_SEQ ) = 0
) ,
RA AS
(
/*******************************************************************************************
OFT 가 일치여부, 금액 등을 고려하여 비교대상이 되는 AUDIT DATA 를 SELECT 한다.
COVERED B/L 일 경우는 'DHF', 'NMS', 'CMS', 'ODF' 만 심사 대상으로 처리함.
*******************************************************************************************/

SELECT  CHG_CD        ,
        CGO_CATE_CD   ,
        RCV_TERM_CD   ,
        DE_TERM_CD    ,
        RAT_AS_QTY    ,
        RAT_UT_CD     ,
        CURR_CD       ,
        CHG_UT_AMT    ,
        CHG_AMT       ,
        ( SELECT RA.CHG_AMT / XR.USD_LOCL_XCH_RT FROM XR WHERE XR.CURR_CD = RA.CURR_CD )  CHG_USD_AMT,
        SUM (( SELECT RA.CHG_AMT / XR.USD_LOCL_XCH_RT FROM XR WHERE XR.CURR_CD = RA.CURR_CD )) OVER (PARTITION BY OFT_CMB_SEQ, CHG_CD, CHG_AMT) AS CHK_CHG_AMT
FROM    BKG_REV_AUD_CHG_TMP RA
WHERE   OFT_CMB_SEQ
        =
        (
        SELECT  OFT_CMB_SEQ
        FROM    (
                SELECT  OFT_CMB_SEQ   ,
                        ROW_NUMBER() OVER ( ORDER BY OFT_MTCH_PRIO, CHG_AMT, OFT_CMB_SEQ )  ROW_NUMBER
                FROM    (
                        SELECT  RA.OFT_CMB_SEQ    ,
                                CASE
                                WHEN OFT_CMB_SEQ  IN ( SELECT OFT_CMB_SEQ FROM C1 ) THEN 1
                                ELSE 2
                                END OFT_MTCH_PRIO ,
                                SUM(RA.RAT_AS_QTY * RA.CHG_UT_AMT / DECODE(RA.RAT_UT_CD, 'PC', 100, 1) / XR.USD_LOCL_XCH_RT)  CHG_AMT
                        FROM    BKG_REV_AUD_CHG_TMP RA  ,
                                XR
                        WHERE   XR.CURR_CD      = RA.CURR_CD
                        AND     (
                                    ( SELECT RT_BL_TP_CD FROM BK ) <> 'C'
                                OR  RA.CHG_CD IN ( 'DHF', 'NMS', 'CMS', 'ODF' )
                                )
                        GROUP BY
                                RA.OFT_CMB_SEQ
                        )
                )
        WHERE   ROW_NUMBER  = 1
        )
AND     (
            ( SELECT RT_BL_TP_CD FROM BK ) <> 'C'
        OR  CHG_CD  IN ( 'DHF', 'NMS', 'CMS', 'ODF' )
        )
) ,
BS AS
(
/*******************************************************************************************
BKG 의 OFT ( OFT, OAR, DAR ) 를 제외한 SURCHARGE
BL RATING UNIT 을 고려하여 변환한다.
*******************************************************************************************/

SELECT  BR.*  ,
        ( SELECT BR.CHG_AMT / XR.USD_LOCL_XCH_RT FROM XR WHERE XR.CURR_CD = BR.CURR_CD )  CHG_USD_AMT,
        SUM (( SELECT BR.CHG_AMT / XR.USD_LOCL_XCH_RT FROM XR WHERE XR.CURR_CD = BR.CURR_CD )) OVER (PARTITION BY OFT_CMB_SEQ, CHG_CD, CHG_AMT) AS CHK_CHG_AMT
FROM    (
        SELECT  BR.OFT_CMB_SEQ  ,
                BR.CHG_CD       ,
                BR.CGO_CATE_CD  ,
                BR.RCV_TERM_CD  ,
                BR.DE_TERM_CD   ,
                SUM(CASE
                WHEN DECODE(CK.BL_FLG, 'Y', 'Y', 'N') = 'Y' THEN 1
                WHEN BR.RAT_UT_CD = 'PC' THEN BR.CHG_UT_AMT
                ELSE BR.RAT_AS_QTY
                END) RAT_AS_QTY ,
                BR.RAT_UT_CD    ,
                BR.CURR_CD      ,
                SUM(BR.CHG_AMT) CHG_AMT
        FROM    (
                SELECT  RA.OFT_CMB_SEQ  ,
                        BR.*
                FROM    BR    ,
                        (
                        SELECT  DISTINCT
                                OFT_CMB_SEQ
                        FROM    BKG_REV_AUD_CHG_TMP
                        ) RA
                WHERE   CHG_CD  NOT IN ( 'OFT', 'OAR', 'DAR' )
                ) BR  ,
                (
                SELECT  OFT_CMB_SEQ ,
                        CHG_CD      ,
                        MAX(DECODE(RAT_UT_CD, 'BL', 'Y', 'N'))  BL_FLG
                FROM  BKG_REV_AUD_CHG_TMP
                GROUP BY
                        OFT_CMB_SEQ ,
                        CHG_CD
                ) CK,
                BKG_BOOKING B
        WHERE   CK.OFT_CMB_SEQ(+) = BR.OFT_CMB_SEQ
        AND     CK.CHG_CD(+)      = BR.CHG_CD
        AND     B.BKG_NO = @[bkg_no]
        GROUP BY
                BR.OFT_CMB_SEQ  ,
                BR.CHG_CD       ,
                BR.CGO_CATE_CD  ,
                BR.RCV_TERM_CD  ,
                BR.DE_TERM_CD   , 
                BR.RAT_UT_CD    ,
                BR.CURR_CD
        ) BR
) ,
RS AS
(
/*******************************************************************************************
AUDIT 의 OFT ( OFT, OAR, DAR ) 를 제외한 SURCHARGE
BL RATING UNIT 을 고려하여 변환한다.
COVERED B/L 일 경우는 'DHF', 'NMS', 'CMS', 'ODF' 만 심사 대상으로 처리함.
*******************************************************************************************/

SELECT  RA.*  ,
        ( SELECT RA.CHG_AMT / XR.USD_LOCL_XCH_RT FROM XR WHERE XR.CURR_CD = RA.CURR_CD )  CHG_USD_AMT,
        SUM (( SELECT RA.CHG_AMT / XR.USD_LOCL_XCH_RT FROM XR WHERE XR.CURR_CD = RA.CURR_CD )) OVER (PARTITION BY OFT_CMB_SEQ, CHG_CD, CHG_AMT) AS CHK_CHG_AMT
FROM    (
        SELECT  RA.OFT_CMB_SEQ  ,
                RA.CHG_CD       ,
                RA.CGO_CATE_CD  ,
                RA.RCV_TERM_CD  ,
                RA.DE_TERM_CD   ,
                SUM(CASE
                WHEN DECODE(CK.BL_FLG, 'Y', 'Y', 'N') = 'Y' THEN 1
                WHEN RA.RAT_UT_CD = 'PC' THEN RA.CHG_UT_AMT
                ELSE RA.RAT_AS_QTY
                END) RAT_AS_QTY ,
                RA.RAT_UT_CD    ,
                RA.CURR_CD      ,
                SUM(RA.CHG_AMT) CHG_AMT
        FROM    BKG_REV_AUD_CHG_TMP RA  ,
                BKG_BOOKING B,
                (
                SELECT  CHG_CD      ,
                        MAX(DECODE(RAT_UT_CD, 'BL', 'Y', 'N'))  BL_FLG
                FROM  BR
                GROUP BY
                        CHG_CD
                ) CK
        WHERE   CK.CHG_CD(+)      = RA.CHG_CD
        AND     RA.CHG_CD         NOT IN ( 'OFT', 'OAR', 'DAR' )
        AND     (
                    ( SELECT RT_BL_TP_CD FROM BK ) <> 'C'
                OR  RA.CHG_CD IN ( 'DHF', 'NMS', 'CMS', 'ODF' )
                )
        AND     B.BKG_NO = @[bkg_no]
        GROUP BY
                RA.OFT_CMB_SEQ  ,
                RA.CHG_CD       ,
                RA.CGO_CATE_CD  ,
                RA.RCV_TERM_CD  ,
                RA.DE_TERM_CD   ,
                RA.RAT_UT_CD    ,
                RA.CURR_CD
        ) RA
) ,
E1 AS
(
    SELECT  CHG_CD        ,
            CURR_CD       ,
            CHG_UT_AMT    ,
            RAT_AS_QTY    ,
            RAT_UT_CD     ,
            CGO_CATE_CD   ,
            RCV_TERM_CD   ,
            DE_TERM_CD    ,
            ROW_NUMBER() OVER ( ORDER BY DECODE(CHG_CD, 'OFT', 1, 'OAR', 2, 'DAR', 3, 4), RAT_UT_CD, CGO_CATE_CD )  ROW_NUMBER  ,
            COUNT(1) OVER () CNT
    FROM    RA
    WHERE   CHG_CD  NOT IN ( 'OFT', 'OAR', 'DAR' )
    AND     NOT EXISTS  (
                        SELECT  'X'
                        FROM    BR
                        WHERE   BR.CHG_CD       = RA.CHG_CD
                        AND     (    (
                                        RA.chg_cd in ('DIH','OIH')
                                    AND RA.CHG_UT_AMT = 0
                                    AND BR.CHG_USD_AMT > RA.CHG_USD_AMT
                                    )
                               OR   (  
                                        BR.CURR_CD      = RA.CURR_CD
                                    AND BR.CHG_UT_AMT   = RA.CHG_UT_AMT
                                    )
                               OR   (  
                                     ABS(BR.CHG_USD_AMT - RA.CHG_USD_AMT) <= 5
                                    )
                               )
                        AND     BR.CHK_CHG_AMT  = RA.CHK_CHG_AMT
                            OR  BR.CHG_CD       = RA.CHG_CD
                        AND     (    (
                                        RA.chg_cd in ('DIH','OIH')
                                    AND RA.CHG_UT_AMT = 0
                                    AND BR.CHG_USD_AMT > RA.CHG_USD_AMT
                                    )
                               OR   (  
                                        BR.CURR_CD      = RA.CURR_CD
                                    AND BR.CHG_UT_AMT   = RA.CHG_UT_AMT
                                    )
                               OR   (  
                                     ABS(BR.CHG_USD_AMT - RA.CHG_USD_AMT) <= 5
                                    )
                               )
                        AND     BR.CHK_CHG_AMT <> RA.CHK_CHG_AMT
                        AND     BR.RAT_UT_CD    = RA.RAT_UT_CD
                        AND     BR.CGO_CATE_CD  = RA.CGO_CATE_CD
                        AND     BR.RCV_TERM_CD  = RA.RCV_TERM_CD
                        AND     BR.DE_TERM_CD   = RA.DE_TERM_CD
                        UNION ALL
                        SELECT  'X'
                        FROM    RS, BS
                        WHERE   BS.CHG_CD       = RS.CHG_CD
                        AND     BS.CGO_CATE_CD  = RS.CGO_CATE_CD
                        AND     BS.RCV_TERM_CD  = RS.RCV_TERM_CD
                        AND     BS.DE_TERM_CD   = RS.DE_TERM_CD
                        AND     BS.RAT_AS_QTY   = RS.RAT_AS_QTY
                        AND     BS.CURR_CD      = RS.CURR_CD
                        AND     BS.CHG_AMT      = RS.CHG_AMT
                        AND     BS.RAT_UT_CD    = RS.RAT_UT_CD
                        --
                        AND     BS.CHG_CD       = RA.CHG_CD
                        AND     BS.CHG_USD_AMT  = RA.CHG_USD_AMT
                        AND     BS.CHK_CHG_AMT  = RA.CHK_CHG_AMT
                            OR  BS.CHG_CD       = RA.CHG_CD
                        AND     BS.CHG_USD_AMT  = RA.CHG_USD_AMT
                        AND     BS.CHK_CHG_AMT <> RA.CHK_CHG_AMT
                        AND     BS.RAT_UT_CD    = RA.RAT_UT_CD
                        AND     BS.CGO_CATE_CD  = RA.CGO_CATE_CD
                        AND     BS.RCV_TERM_CD  = RA.RCV_TERM_CD
                        AND     BS.DE_TERM_CD   = RA.DE_TERM_CD
                      )
     AND	CHG_CD	in (   SELECT H.ATTR_CTNT1
                            FROM BKG_BOOKING B, BKG_HRD_CDG_CTNT H
                            WHERE BKG_NO = @[bkg_no]
                            AND H.HRD_CDG_ID = 'SUR_AUDIT_EXPT'
                            AND ((
                                 SUBSTR(B.POD_CD,1,2) = H.ATTR_CTNT4
                                 AND H.ATTR_CTNT4 = @[cnt_cd]
                                 )
                             OR (
                                 SUBSTR(B.POL_CD,1,2) = H.ATTR_CTNT7
                                 AND H.ATTR_CTNT7 = @[cnt_cd]
                                 ))
                            AND H.ATTR_CTNT9 = 'Y'
                            AND @[ca_flg] = 'N'
                            UNION ALL
                            SELECT H.ATTR_CTNT1
                            FROM BKG_BKG_HIS, BKG_HRD_CDG_CTNT H
                            WHERE BKG_NO = @[bkg_no]
                            AND CORR_NO = 'TMP0000001'
                            AND H.HRD_CDG_ID = 'SUR_AUDIT_EXPT'
                            AND H.ATTR_CTNT9 = 'Y'
                            AND ((
                                 SUBSTR(POD_CD,1,2) = H.ATTR_CTNT4
                                 AND H.ATTR_CTNT4 = @[cnt_cd]
                                 )
                             OR (
                                 SUBSTR(POL_CD,1,2) = H.ATTR_CTNT7
                                 AND H.ATTR_CTNT7 = @[cnt_cd]
                                 ))
                            AND @[ca_flg] = 'Y'
                        )
    UNION ALL
    SELECT  CHG_CD        ,
            CURR_CD       ,
            CHG_UT_AMT    ,
            RAT_AS_QTY    ,
            RAT_UT_CD     ,
            CGO_CATE_CD   ,
            RCV_TERM_CD   ,
            DE_TERM_CD    ,
            ROW_NUMBER() OVER ( ORDER BY DECODE(CHG_CD, 'OFT', 1, 'OAR', 2, 'DAR', 3, 4), RAT_UT_CD, CGO_CATE_CD )  ROW_NUMBER  ,
            COUNT(1) OVER () CNT
    FROM    BR
    WHERE   CHG_CD  NOT IN ( 'OFT', 'OAR', 'DAR' )
    AND     NOT EXISTS  (
                        SELECT  'X'
                        FROM    RA
                        WHERE   BR.CHG_CD       = RA.CHG_CD
                        AND     (    (
                                        RA.chg_cd in ('DIH','OIH')
                                    AND RA.CHG_UT_AMT = 0
                                    AND BR.CHG_USD_AMT > RA.CHG_USD_AMT
                                    )
                               OR   (  
                                        BR.CURR_CD      = RA.CURR_CD
                                    AND BR.CHG_UT_AMT   = RA.CHG_UT_AMT
                                    )
                               OR   (  
                                     ABS(BR.CHG_USD_AMT - RA.CHG_USD_AMT) <= 5
                                    )
                               )
                        AND     BR.CHK_CHG_AMT  = RA.CHK_CHG_AMT
                            OR  BR.CHG_CD       = RA.CHG_CD
                        AND     (    (
                                        RA.chg_cd in ('DIH','OIH')
                                    AND RA.CHG_UT_AMT = 0
                                    AND BR.CHG_USD_AMT > RA.CHG_USD_AMT
                                    )
                               OR   (  
                                        BR.CURR_CD      = RA.CURR_CD
                                    AND BR.CHG_UT_AMT   = RA.CHG_UT_AMT
                                    )
                               OR   (  
                                     ABS(BR.CHG_USD_AMT - RA.CHG_USD_AMT) <= 5
                                    )
                               )
                        AND     BR.CHK_CHG_AMT <> RA.CHK_CHG_AMT
                        AND     BR.RAT_UT_CD    = RA.RAT_UT_CD
                        AND     BR.CGO_CATE_CD  = RA.CGO_CATE_CD
                        AND     BR.RCV_TERM_CD  = RA.RCV_TERM_CD
                        AND     BR.DE_TERM_CD   = RA.DE_TERM_CD
                        UNION ALL
                        SELECT  'X'
                        FROM    RS, BS
                        WHERE   BS.CHG_CD       = RS.CHG_CD
                        AND     BS.CGO_CATE_CD  = RS.CGO_CATE_CD
                        AND     BS.RCV_TERM_CD  = RS.RCV_TERM_CD
                        AND     BS.DE_TERM_CD   = RS.DE_TERM_CD
                        AND     BS.RAT_AS_QTY   = RS.RAT_AS_QTY
                        AND     BS.CURR_CD      = RS.CURR_CD
                        AND     BS.CHG_AMT      = RS.CHG_AMT
                        AND     BS.RAT_UT_CD    = RS.RAT_UT_CD
                        --
                        AND     BS.CHG_CD       = BR.CHG_CD
                        AND     BS.CHG_USD_AMT  = BR.CHG_USD_AMT
                        AND     BS.CHK_CHG_AMT  = BR.CHK_CHG_AMT
                            OR  BS.CHG_CD       = BR.CHG_CD
                        AND     BS.CHG_USD_AMT  = BR.CHG_USD_AMT
                        AND     BS.CHK_CHG_AMT <> BR.CHK_CHG_AMT
                        AND     BS.RAT_UT_CD    = BR.RAT_UT_CD
                        AND     BS.CGO_CATE_CD  = BR.CGO_CATE_CD
                        AND     BS.RCV_TERM_CD  = BR.RCV_TERM_CD
                        AND     BS.DE_TERM_CD   = BR.DE_TERM_CD
                      )
     AND	CHG_CD	in (   SELECT H.ATTR_CTNT1
                            FROM BKG_BOOKING B, BKG_HRD_CDG_CTNT H
                            WHERE BKG_NO = @[bkg_no]
                            AND H.HRD_CDG_ID = 'SUR_AUDIT_EXPT'
                            AND ((
                                 SUBSTR(B.POD_CD,1,2) = H.ATTR_CTNT4
                                 AND H.ATTR_CTNT4 = @[cnt_cd]
                                 )
                             OR (
                                 SUBSTR(B.POL_CD,1,2) = H.ATTR_CTNT7
                                 AND H.ATTR_CTNT7 = @[cnt_cd]
                                 ))
                            AND H.ATTR_CTNT9 = 'Y'
                            AND @[ca_flg] = 'N'
                            UNION ALL
                            SELECT H.ATTR_CTNT1
                            FROM BKG_BKG_HIS, BKG_HRD_CDG_CTNT H
                            WHERE BKG_NO = @[bkg_no]
                            AND CORR_NO = 'TMP0000001'
                            AND H.HRD_CDG_ID = 'SUR_AUDIT_EXPT'
                            AND H.ATTR_CTNT9 = 'Y'
                            AND ((
                                 SUBSTR(POD_CD,1,2) = H.ATTR_CTNT4
                                 AND H.ATTR_CTNT4 = @[cnt_cd]
                                 )
                             OR (
                                 SUBSTR(POL_CD,1,2) = H.ATTR_CTNT7
                                 AND H.ATTR_CTNT7 = @[cnt_cd]
                                 ))
                            AND @[ca_flg] = 'Y'
                        )
)

SELECT DECODE(NVL(SUM(DECODE(CHG_CD,'OIH',1,'DIH',1,0)),0),0,'Y','E') IHC_FLG
      ,DECODE(NVL(SUM(DECODE(CHG_CD,'OTH',1,'DTH',1,'NST',1,0)),0),0,'Y','E') THC_FLG
  FROM E1
/*******************************************************************************************
'D' ERROR 가 아닌 경우에만 'F' 를 표시한다.
*******************************************************************************************/

WHERE     EXISTS  (
            SELECT  'X'
            FROM    BKG_CHG_RT  CR
            WHERE   CR.BKG_NO   = @[bkg_no]
            AND     NVL(CR.FRT_INCL_XCLD_DIV_CD, 'N') = 'N'
            AND     ROWNUM      = 1
            AND     @[ca_flg]   = 'N'

            UNION ALL

            SELECT  'X'
            FROM    BKG_CHG_RT_HIS  CR
            WHERE   CR.BKG_NO   = @[bkg_no]
            AND     CR.CORR_NO  = 'TMP0000001'  -- CORRECTION 중인 DATA 를 나타내는 고정된 상수값
            AND     NVL(CR.FRT_INCL_XCLD_DIV_CD, 'N') = 'N'
            AND     ROWNUM      = 1
            AND     @[ca_flg]   = 'Y'
            )


/*******************************************************************************************
신규 BKG 만 대상으로 한다.
*******************************************************************************************/

AND     LENGTH(@[bkg_no]) = 12			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="ca_flg" type="12" value="" out="N"/>
				<param name="cnt_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
