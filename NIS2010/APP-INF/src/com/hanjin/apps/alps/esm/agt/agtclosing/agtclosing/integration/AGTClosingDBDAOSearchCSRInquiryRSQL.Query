<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="AGTClosingDBDAOSearchCSRInquiryRSQL">
			<desc><![CDATA[AGTClosingDBDAOSearchCSRInquiryRSQL]]></desc>
			<sql><![CDATA[
SELECT
           AGN.AGN_CD AGN_OFC_CD,
           AGN.CSR_NO,
           MAX (INH.INV_DESC)                                  AS INV_DESC,
           AGN.COMM_STND_COST_CD,
           SUM (AGN.ACT_IF_COMM_AMT)                           AS USD_AMT,
           SUM (AGN.ACT_IF_LOCL_COMM_AMT)                      AS LOCAL_AMT,
           INF.REV_VVD_CD,
      CASE AGN.XCH_RT_APLY_LVL
      WHEN '1'
      THEN VVD_XCH_RT
      WHEN '2'
      THEN MON_XCH_RT
      WHEN '3'
      THEN DLY_XCH_RT
      WHEN '4'
      THEN
         (
               SELECT
                      ORG.FX_CURR_RT
                           FROM MDM_ORGANIZATION ORG
                          WHERE ORG.OFC_CD = AGN.AGN_CD
         )
       END                                                     AS XCH_RT,
           AGN.CURR_CD,
      CASE
      WHEN MAX (IF_ERR_RSN) IS NOT NULL
      THEN MAX (IF_ERR_RSN)
      WHEN MAX (RCV_ERR_RSN) IS NOT NULL
      THEN MAX (RCV_ERR_RSN)
      WHEN MAX (AGN.COMM_PROC_STS_RSN) = 'Interface OK!'
      THEN 'Success'
      ELSE MAX (AGN.COMM_PROC_STS_RSN)
       END                                                     AS STATUS,
           TO_CHAR(MAX (INH.CRE_DT),'YYYYMMDD')                AS CRE_DT,
           TO_CHAR(MAX (INH.IF_DT),'YYYYMMDD')                 AS IF_DT,
           MAX (INH.PAY_DT)                                    AS PAY_DT,
           MAX (INH.CRE_USR_ID)                                AS CRE_USR_ID,
         (
               SELECT
                      SUBSTR
                    ( MAX
                    (
                      11 + APRO_RQST_SEQ
                   || RQR.APRO_USR_ID
                    )
                    , 3
                    )
                 FROM COM_APRO_RQST_ROUT RQR,
                      COM_APRO_CSR_DTL   CSD
                WHERE RQR.APRO_RQST_NO = CSD.APRO_RQST_NO
                  AND CSD.CSR_NO       = AGN.CSR_NO
         )                                                     AS APRO_USR_ID
      FROM AGT_AGN_COMM      AGN,
           AP_INV_HDR        INH,
           AGT_COMM_BKG_INFO INF,
         (
               SELECT
           ---------- SEARCH To Agent Code -----------------------------
           -- VARCHAR(5) : AAABB
                      @[agn_cd]
           AS AGN_CD,
           -------------------------------------------------------------
           
           ---------- SEARCH To CSR No. --------------------------------
           -- VARCHAR(20) : 08SAAAAAYYMMDD1NNNN '08SBKKBB10102810001'
					  NULL
           AS CSR_NO,
           -------------------------------------------------------------
           
           ---------- SEARCH To Rev. VVD -------------------------------
           -- VARCHAR(10) : VVVVYYYYSR 'HJPO0026WW'
                      @[s_r_vvd]
           AS REV_VVD_CD,
           -------------------------------------------------------------
           
           ---------- SEARCH To Create Date ----------------------------
           -- VARCHAR(8) : YYYYMMDD '20101028'
#if (${date_option} == 'C') 
                      TO_CHAR(TO_DATE(@[search_dt_fr],'YYYY-MM-DD'),'YYYYMMDD')
#else
					  ''
#end
           AS CRE_DT_FR,
#if (${date_option} == 'C') 
                      TO_CHAR(TO_DATE(@[search_dt_to],'YYYY-MM-DD'),'YYYYMMDD')
#else
					  ''
#end
           AS CRE_DT_TO,
           -------------------------------------------------------------
           
           ---------- SEARCH To Interface Date -------------------------
           -- VARCHAR(8) : YYYYMMDD '20101101'
#if (${date_option} == 'A') 
                      TO_CHAR(TO_DATE(@[search_dt_fr],'YYYY-MM-DD'),'YYYYMMDD')
#else
					  ''
#end
           AS IF_DT_FR,
#if (${date_option} == 'A') 
                      TO_CHAR(TO_DATE(@[search_dt_to],'YYYY-MM-DD'),'YYYYMMDD')
#else
					  ''
#end
           AS IF_DT_TO,
           -------------------------------------------------------------
           ---------- SEARCH To Date Radio Button-----------------------
           -- VARCHAR(1) : C - Created Date, I - Interfaced Date
                      @[date_option]
           AS DT_OPT,
           -------------------------------------------------------------
           ---------- SEARCH To Status Combo ---------------------------
           -- 1: Created           -- 2: Approved
           -- 3: Paid              -- 4: Cancelled
                      @[s_sts_cd]
           AS STATUS
           -------------------------------------------------------------
                 FROM DUAL
         ) INP
     WHERE AGN.CSR_NO   = INH.CSR_NO
       AND AGN.CSR_NO  IS NOT NULL
       AND AGN.BKG_NO   = INF.BKG_NO
       AND AGN.AGN_CD   = INP.AGN_CD
       AND INH.SRC_CTNT = 'COMMISSION'
#if (${multi_csr_no} != '') 
	   AND AGN.CSR_NO IN ${multi_csr_no}
#else
       AND
         (
         (
		AGN.CSR_NO = INP.CSR_NO
       AND INP.CSR_NO IS NOT NULL
         )
        OR
         (
           INP.CSR_NO IS NULL
       AND AGN.CSR_NO = AGN.CSR_NO
         )
         )
#end
       AND
         (
         (
           INP.REV_VVD_CD IS NOT NULL
       AND INF.REV_VVD_CD = INP.REV_VVD_CD
         )
        OR
         (
           INP.REV_VVD_CD IS NULL
       AND INF.REV_VVD_CD = INF.REV_VVD_CD
         )
         )
       AND
         (
         (
           INP.DT_OPT     = 'C'
       AND INP.CRE_DT_FR IS NOT NULL
       AND INH.CRE_DT
   BETWEEN TO_DATE (INP.CRE_DT_FR, 'YYYYMMDD')
       AND TO_DATE (INP.CRE_DT_TO || '235959', 'YYYYMMDDHH24MISS')
         )
        OR
         (
           INP.CRE_DT_FR IS NULL
       AND INH.CRE_DT = INH.CRE_DT
         )
         )
       AND
         (
         (
           INP.DT_OPT     = 'A'
       AND INP.IF_DT_FR IS NOT NULL
       AND INH.IF_DT
   BETWEEN TO_DATE (INP.IF_DT_FR, 'YYYYMMDD')
       AND TO_DATE (INP.IF_DT_TO || '235959', 'YYYYMMDDHH24MISS')
         )
       OR
         (
           INP.IF_DT_FR IS NULL
       AND INH.IF_DT = INH.IF_DT
         )
         )
       AND
         (
         (
           INP.STATUS = '1'
       AND INH.IF_DT IS NULL
       AND NVL (INH.IF_FLG, 'Y')      <> 'E'
         )
        OR
         (
           INP.STATUS = '2'
       AND INH.IF_DT IS NOT NULL
       AND NVL (INH.IF_FLG, 'Y')      <> 'E'
       AND NVL (INH.RCV_ERR_FLG, 'Y') <> 'E'
         )
        OR
         (
           INP.STATUS = '3'
       AND INH.IF_DT IS NOT NULL
       AND NVL (INH.IF_FLG, 'Y')      <> 'E'
       AND NVL (INH.RCV_ERR_FLG, 'Y') <> 'E'
       AND INH.PAY_DT IS NOT NULL
         )
        OR
         (
           INP.STATUS = '4'
       AND
         (
           NVL (INH.IF_FLG, 'Y')      = 'E'
        OR NVL (INH.RCV_ERR_FLG, 'Y') = 'E'
         )
         )
         )
  GROUP BY AGN.AGN_CD,
           AGN.CSR_NO,
           AGN.COMM_STND_COST_CD,
           INF.REV_VVD_CD,
           AGN.XCH_RT_APLY_LVL,
           VVD_XCH_RT,
           MON_XCH_RT,
           DLY_XCH_RT,
           AGN.CURR_CD			]]></sql>
			<params>
				<param name="agn_cd" type="12" value="" out="N"/>
				<param name="s_r_vvd" type="12" value="" out="N"/>
				<param name="search_dt_fr" type="12" value="" out="N"/>
				<param name="search_dt_to" type="12" value="" out="N"/>
				<param name="date_option" type="12" value="" out="N"/>
				<param name="s_sts_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
