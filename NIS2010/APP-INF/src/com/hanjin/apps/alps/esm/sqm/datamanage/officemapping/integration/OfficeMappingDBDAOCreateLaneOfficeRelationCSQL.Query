<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="OfficeMappingDBDAOCreateLaneOfficeRelationCSQL">
			<desc><![CDATA[Lane Office Relation Data 를 생성]]></desc>
			<sql><![CDATA[
INSERT INTO SQM_QTA_LANE_OFC (
       BSE_TP_CD
      ,BSE_YR
      ,BSE_QTR_CD
      ,OFC_VW_CD
      ,TRD_CD
      ,RLANE_CD
      ,DIR_CD
      ,RGN_OFC_CD
      ,RHQ_CD
      ,SUB_TRD_CD
      ,SQM_ACT_FLG
      ,ADD_FLG
      ,CRE_USR_ID
      ,CRE_DT
      ,UPD_USR_ID
      ,UPD_DT
)
SELECT A1.BSE_TP_CD
      ,A1.BSE_YR
      ,A1.BSE_QTR_CD
      ,A1.OFC_VW_CD
      ,A2.TRD_CD
      ,A2.RLANE_CD
      ,A2.DIR_CD
      ,A3.RGN_OFC_CD
      ,A3.RHQ_CD
      ,A2.SUB_TRD_CD
      ,NVL((SELECT T.SQM_ACT_FLG
              FROM SQM_QTA_LANE_OFC T
             WHERE T.BSE_YR||T.BSE_QTR_CD = ( SELECT /*+ INDEX_DESC(SQM_QTA_LANE_OFC XPKSQM_QTA_LANE_OFC) */
                                                     BSE_YR || BSE_QTR_CD
                                                FROM SQM_QTA_LANE_OFC
                                               WHERE BSE_TP_CD = 'Q'
                                                 AND BSE_YR || BSE_QTR_CD < @[f_bse_yr] || DECODE(@[f_bse_tp_cd], 'Y', '00', @[f_bse_qtr_cd])
                                                 AND ROWNUM = 1 )
               AND T.OFC_VW_CD  = A1.OFC_VW_CD
               AND T.TRD_CD     = A2.TRD_CD
               AND T.RLANE_CD   = A2.RLANE_CD
               AND T.DIR_CD     = A2.DIR_CD
               AND T.RGN_OFC_CD = A3.RGN_OFC_CD
               AND T.RHQ_CD     = A3.RHQ_CD      ), 'N') AS SQM_ACT_FLG
      ,'N' AS ADD_FLG
      ,@[f_usr_id] AS CRE_USR_ID
      ,SYSDATE     AS CRE_DT
      ,@[f_usr_id] AS UPD_USR_ID
      ,SYSDATE     AS UPD_DT
  FROM SQM_DAT_RLT       A1
      ,(
          SELECT DISTINCT
                 TRD_CD
                ,RLANE_CD
                ,SUB_TRD_CD
                ,NVL(LANE_DIR_CD, DECODE(CPY_NO, 0, 'E', 'W')) AS DIR_CD
                ,SQM_ACT_FLG
            FROM SQM_QTA_LANE_MGMT
                ,COM_CPY_NO
           WHERE SQM_ACT_FLG = 'Y'
             AND CPY_NO      < 2
      ) A2
      ,SQM_QTA_OFC       A3
      ,SQM_DIR_CONV      A4
 WHERE A1.BSE_TP_CD    = @[f_bse_tp_cd]
   AND A1.BSE_YR       = @[f_bse_yr]
   AND A1.BSE_QTR_CD   = DECODE(@[f_bse_tp_cd], 'Y', '00', @[f_bse_qtr_cd])
   AND A2.SQM_ACT_FLG  = 'Y'
   AND A1.TRD_CD       = A2.TRD_CD
   AND A1.RLANE_CD     = DECODE(UPPER(A1.RLANE_CD), 'ALL', A1.RLANE_CD, A2.RLANE_CD)
   AND A1.CONV_DIR_CD  = NVL(A4.CONV_DIR_CD, A2.DIR_CD)
   AND A1.RHQ_CD       = A3.RHQ_CD
   AND A4.BSE_TP_CD(+) = @[f_bse_tp_cd]
   AND A4.BSE_YR(+)    = @[f_bse_yr]
   AND A4.BSE_QTR_CD(+)= DECODE(@[f_bse_tp_cd], 'Y', '00', @[f_bse_qtr_cd])
   AND A2.TRD_CD       = A4.TRD_CD(+)
   AND A2.RLANE_CD     = A4.RLANE_CD(+)
   AND A2.DIR_CD       = A4.DIR_CD(+)
   AND A3.DELT_FLG     = 'N'			]]></sql>
			<params>
				<param name="f_bse_yr" type="12" value="" out="N"/>
				<param name="f_bse_tp_cd" type="12" value="" out="N"/>
				<param name="f_bse_qtr_cd" type="12" value="" out="N"/>
				<param name="f_usr_id" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
