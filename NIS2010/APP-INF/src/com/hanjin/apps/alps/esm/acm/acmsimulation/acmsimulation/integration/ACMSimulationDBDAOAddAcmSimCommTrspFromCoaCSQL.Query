<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ACMSimulationDBDAOAddAcmSimCommTrspFromCoaCSQL">
			<desc><![CDATA[COA 에서 TRSP 공제 비용 조회.]]></desc>
			<sql><![CDATA[
INSERT INTO ACM_SIM_COMM_TRSP
SELECT @[sim_no] AS SIM_NO,
  A.BKG_NO AS BKG_NO,
  @[agn_cd] AS AGN_CD,
  @[io_bnd_cd] AS IO_BND_CD,
  @[ac_tp_cd] AS AC_TP_CD,
  @[max_ac_seq] AS AC_SEQ,
  ROW_NUMBER() OVER(PARTITION BY A.BKG_NO ORDER BY SUBSTR(A.NOD_CD, 1, 5), SUBSTR(A.TO_NOD_CD, 1, 5)) AS AC_TRSP_SEQ,
  DECODE(A.ROUT_TZ_MOD_CD, 'WD', 'F', 'H') AS TRSP_MOD_CD,
  A.COA_COST_SRC_CD AS TRSP_DDCT_CD,
  SUBSTR(A.NOD_CD, 1, 5) FM_LOC_CD,
  SUBSTR(A.TO_NOD_CD, 1, 5) TO_LOC_CD,
  NVL(A.CNTR_QTY, 0) * NVL(A.ESTM_USD_UC_AMT, 0) AS TRSP_DDCT_AMT,
  @[usr_id],
  SYSDATE UPD_DT,
  @[usr_id],
  SYSDATE CRE_DT
FROM COA_BKG_COST_SRC_DTL A,
  (SELECT BND, LOC
   FROM (
      SELECT 'O' BND, SUBSTR(POR_CD, 1, 5) AS LOC FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no]
      UNION ALL
      SELECT 'O', SUBSTR(POL_CD, 1, 5) FROM BKG_VVD WHERE BKG_NO = @[bkg_no] AND VSL_PRE_PST_CD IN ('S', 'T')
      UNION ALL
      SELECT 'I', SUBSTR(DEL_CD, 1, 5) FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no]
      UNION ALL
      SELECT 'I', SUBSTR(POD_CD, 1, 5) FROM BKG_VVD WHERE BKG_NO = @[bkg_no] AND VSL_PRE_PST_CD IN ('T', 'U')
     )
   GROUP BY BND, LOC
  ) B
WHERE A.BKG_NO = @[bkg_no]
  AND A.STND_COST_CD IN (SELECT STND_COST_CD  -- '51301011', '51301021', '51301031', '51301041', '51301051', '51301061', '51301081'
                         FROM MAS_STND_ACCT_V
                         WHERE SGRP_COST_CD = 'CVTR'
                           AND MAS_COST_SRC_PRT_CD = 'CO'
                           AND STND_COST_CD <> CASE WHEN EXISTS(SELECT 1
                                                                FROM BKG_CHG_RT
                                                                WHERE BKG_NO = @[bkg_no]
                                                                  AND FRT_INCL_XCLD_DIV_CD = 'N'
                                                                  AND CHG_CD = 'IFC'
                                                                  AND CHG_AMT <> 0
                                                         )
                                                           OR EXISTS(SELECT 1
                                                                     FROM ACM_SIM_COMM_CHG
                                                                     WHERE BKG_NO = @[bkg_no]
                                                                       AND AGN_CD = @[agn_cd]
                                                                       AND IO_BND_CD = @[io_bnd_cd]
                                                                       AND AC_TP_CD = @[ac_tp_cd]
                                                                       AND AC_SEQ = @[max_ac_seq]
                                                                       AND CHG_CD = 'IFC'
                                                                       AND CHG_DDCT_AMT <> 0
                                                              )
                                                      THEN '51301091'
                                                    ELSE 'XXXXXXXX'
                                               END
                        )
  AND B.LOC IN (SUBSTR(NOD_CD, 1, 5), SUBSTR(TO_NOD_CD, 1, 5), SUBSTR(N2ND_NOD_CD, 1, 5), SUBSTR(N3RD_NOD_CD, 1, 5))
  AND A.ESTM_USD_UC_AMT <> 0
  AND B.BND IN (DECODE(@[hlg_ddct_org_flg], 'Y', 'O', 'X'),
                DECODE(@[hlg_ddct_dest_flg], 'Y', 'I', 'X'),
                DECODE(@[fdrg_ddct_org_flg], 'Y', 'O', 'X'),
                DECODE(@[fdrg_ddct_dest_flg], 'Y', 'I', 'X')
               )
  AND DECODE(A.ROUT_TZ_MOD_CD, 'WD', 'F', 'H') IN (DECODE(@[hlg_ddct_org_flg], 'Y', 'H', 'X'),
                                                   DECODE(@[hlg_ddct_dest_flg], 'Y', 'H', 'X'),
                                                   DECODE(@[fdrg_ddct_org_flg], 'Y', 'F', 'X'),
                                                   DECODE(@[fdrg_ddct_dest_flg], 'Y', 'F', 'X')
                                                  )
GROUP BY A.BKG_NO,
  A.COA_COST_SRC_CD,
  DECODE(A.ROUT_TZ_MOD_CD, 'WD', 'F', 'H'),
  SUBSTR(A.NOD_CD, 1, 5),
  SUBSTR(A.TO_NOD_CD, 1, 5),
  NVL(A.CNTR_QTY, 0),
  NVL(A.ESTM_USD_UC_AMT, 0),
  DECODE(A.N3RD_NOD_CD, '', 'N', 'Y'),
  DECODE(A.N3RD_NOD_CD, '', 'N', 'Y')			]]></sql>
			<params>
				<param name="sim_no" type="12" value="" out="N"/>
				<param name="agn_cd" type="12" value="" out="N"/>
				<param name="io_bnd_cd" type="12" value="" out="N"/>
				<param name="ac_tp_cd" type="12" value="" out="N"/>
				<param name="max_ac_seq" type="12" value="" out="N"/>
				<param name="usr_id" type="12" value="" out="N"/>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="hlg_ddct_org_flg" type="12" value="" out="N"/>
				<param name="hlg_ddct_dest_flg" type="12" value="" out="N"/>
				<param name="fdrg_ddct_org_flg" type="12" value="" out="N"/>
				<param name="fdrg_ddct_dest_flg" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
