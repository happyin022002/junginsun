<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="AgncommagmthistoryDBDAOSearchAgncommagmtDetailHistoryListRSQL">
			<desc><![CDATA[SearchAgncommagmtDetailHistoryList]]></desc>
			<sql><![CDATA[
SELECT 
B.AGN_AGMT_NO,
A.ITEM1, 
A.ITEM2, 
DECODE(A.SEQ,
1,DECODE(B.TPSZ,               DECODE(CUR_HIS_NO,PRE_HIS_NO,'',B.PRE_TPSZ),              '',B.TPSZ),
2,DECODE(B.FULL_MTY_CD,        DECODE(CUR_HIS_NO,PRE_HIS_NO,'',B.PRE_FULL_MTY_CD),       '',B.FULL_MTY_CD),
3,DECODE(B.FIX_BASE,           DECODE(CUR_HIS_NO,PRE_HIS_NO,'',B.PRE_FIX_BASE),          '',B.FIX_BASE),
4,DECODE(B.RATE_BASE,          DECODE(CUR_HIS_NO,PRE_HIS_NO,'',B.PRE_RATE_BASE),         '',B.RATE_BASE),
5,DECODE(B.OFC_SET_TP_CD,      DECODE(CUR_HIS_NO,PRE_HIS_NO,'',B.PRE_OFC_SET_TP_CD),     '',B.OFC_SET_TP_CD),
6,DECODE(B.OFC_CVRG_CD,        DECODE(CUR_HIS_NO,PRE_HIS_NO,'',B.PRE_OFC_CVRG_CD),       '',B.OFC_CVRG_CD),
7,DECODE(B.OFC_CD,             DECODE(CUR_HIS_NO,PRE_HIS_NO,'',B.PRE_OFC_CD),            '',B.OFC_CD),
8,DECODE(B.POR,                DECODE(CUR_HIS_NO,PRE_HIS_NO,'',B.PRE_POR),               '',B.POR),
9,DECODE(B.POL,                DECODE(CUR_HIS_NO,PRE_HIS_NO,'',B.PRE_POL),               '',B.POL),
10,DECODE(B.POD,               DECODE(CUR_HIS_NO,PRE_HIS_NO,'',B.PRE_POD),               '',B.POD),
11,DECODE(B.DEL,               DECODE(CUR_HIS_NO,PRE_HIS_NO,'',B.PRE_DEL),               '',B.DEL),
12,DECODE(B.REP_CHG_CD,        DECODE(CUR_HIS_NO,PRE_HIS_NO,'',B.PRE_REP_CHG_CD),        '',B.REP_CHG_CD),
13,DECODE(B.CHG_CD,            DECODE(CUR_HIS_NO,PRE_HIS_NO,'',B.PRE_CHG_CD),            '',B.CHG_CD),
14,DECODE(B.HLG_DDCT_ORG_FLG,  DECODE(CUR_HIS_NO,PRE_HIS_NO,'',B.PRE_HLG_DDCT_ORG_FLG),  '',B.HLG_DDCT_ORG_FLG),
15,DECODE(B.HLG_DDCT_DEST_FLG, DECODE(CUR_HIS_NO,PRE_HIS_NO,'',B.PRE_HLG_DDCT_DEST_FLG), '',B.HLG_DDCT_DEST_FLG),
16,DECODE(B.FDRG_DDCT_ORG_FLG, DECODE(CUR_HIS_NO,PRE_HIS_NO,'',B.PRE_FDRG_DDCT_ORG_FLG), '',B.FDRG_DDCT_ORG_FLG),
17,DECODE(B.FDRG_DDCT_DEST_FLG,DECODE(CUR_HIS_NO,PRE_HIS_NO,'',B.PRE_FDRG_DDCT_DEST_FLG),'',B.FDRG_DDCT_DEST_FLG)
) AS CURRENT_VALUE, 
DECODE(A.SEQ,
1,DECODE(B.TPSZ,               B.PRE_TPSZ,               '',B.PRE_TPSZ),
2,DECODE(B.FULL_MTY_CD,        B.PRE_FULL_MTY_CD,        '',B.PRE_FULL_MTY_CD),
3,DECODE(B.FIX_BASE,           B.PRE_FIX_BASE,           '',B.PRE_FIX_BASE),
4,DECODE(B.RATE_BASE,          B.PRE_RATE_BASE,          '',B.PRE_RATE_BASE),
5,DECODE(B.OFC_SET_TP_CD,      B.PRE_OFC_SET_TP_CD,      '',B.PRE_OFC_SET_TP_CD),
6,DECODE(B.OFC_CVRG_CD,        B.PRE_OFC_CVRG_CD,        '',B.PRE_OFC_CVRG_CD),
7,DECODE(B.OFC_CD,             B.PRE_OFC_CD,             '',B.PRE_OFC_CD),
8,DECODE(B.POR,                B.PRE_POR,                '',B.PRE_POR),
9,DECODE(B.POL,                B.PRE_POL,                '',B.PRE_POL),
10,DECODE(B.POD,               B.PRE_POD,                '',B.PRE_POD),
11,DECODE(B.DEL,               B.PRE_DEL,                '',B.PRE_DEL),
12,DECODE(B.REP_CHG_CD,        B.PRE_REP_CHG_CD,         '',B.PRE_REP_CHG_CD),
13,DECODE(B.CHG_CD,            B.PRE_CHG_CD,             '',B.PRE_CHG_CD),
14,DECODE(B.HLG_DDCT_ORG_FLG,  B.PRE_HLG_DDCT_ORG_FLG,   '',B.PRE_HLG_DDCT_ORG_FLG),
15,DECODE(B.HLG_DDCT_DEST_FLG, B.PRE_HLG_DDCT_DEST_FLG,  '',B.PRE_HLG_DDCT_DEST_FLG),
16,DECODE(B.FDRG_DDCT_ORG_FLG, B.PRE_FDRG_DDCT_ORG_FLG,  '',B.PRE_FDRG_DDCT_ORG_FLG),
17,DECODE(B.FDRG_DDCT_DEST_FLG,B.PRE_FDRG_DDCT_DEST_FLG, '',B.PRE_FDRG_DDCT_DEST_FLG)
) AS PREVIOUS_VALUE,
MASTER_INFO

FROM (
WITH N AS (
    SELECT AGMT_DTL_HIS_NO 
          ,LAG(AGMT_DTL_HIS_NO) OVER  ( ORDER BY AGMT_DTL_HIS_NO, CRE_DT) AS PRE_AGMT_DTL_HIS_NO
    FROM ACM_AGN_AGMT_DTL_HIS
   WHERE AGN_AGMT_NO = @[agn_agmt_no]
)



SELECT 
 CUR.AGN_AGMT_NO,CUR.AGMT_DTL_HIS_NO CUR_HIS_NO ,PRE.AGMT_DTL_HIS_NO PRE_HIS_NO
,ACM_JOIN_FNC(CURSOR(SELECT CNTR_TPSZ_CD FROM ACM_AGN_AGMT_DTL_CNTR_HIS CH WHERE CH.AGMT_DTL_HIS_NO = CUR.AGMT_DTL_HIS_NO )) AS TPSZ
,CUR.FULL_MTY_CD AS FULL_MTY_CD
,CUR.COMM_FX_AMT AS FIX_BASE
,(
 SELECT INTG_CD_VAL_DESC||'/' FROM COM_INTG_CD_DTL WHERE INTG_CD_ID = 'CD00600' AND INTG_CD_VAL_CTNT = CUR.COMM_PAY_TERM_CD) 
 ||DECODE(CUR.REV_DIV_CD,'N','Net/','Gross/')||CUR.COMM_RT                   AS RATE_BASE
,DECODE(CUR.OFC_SET_TP_CD,'B','BKG Office','A','AR Office','F','Fin Office') AS OFC_SET_TP_CD
,CUR.OFC_CVRG_CD AS OFC_CVRG_CD
,CUR.OFC_CD      AS OFC_CD
,(ACM_JOIN_FNC(CURSOR(SELECT ROUT_INFO_CD
                      FROM ACM_AGN_AGMT_DTL_ROUT_HIS POR
                     WHERE POR.AGMT_DTL_HIS_NO = CUR.AGMT_DTL_HIS_NO
                       AND ROUT_REF_DIV_CD = 'POR'
                       and rownum < 600
                    ORDER BY AGN_AGMT_ROUT_SEQ))
)  AS POR
,(ACM_JOIN_FNC(CURSOR(SELECT ROUT_INFO_CD
                      FROM ACM_AGN_AGMT_DTL_ROUT_HIS POL
                     WHERE POL.AGMT_DTL_HIS_NO = CUR.AGMT_DTL_HIS_NO
                       AND ROUT_REF_DIV_CD = 'POL'
                       and rownum < 600
                    ORDER BY AGN_AGMT_ROUT_SEQ))
)  AS POL
,(ACM_JOIN_FNC(CURSOR(SELECT ROUT_INFO_CD
                      FROM ACM_AGN_AGMT_DTL_ROUT_HIS POD
                     WHERE POD.AGMT_DTL_HIS_NO = CUR.AGMT_DTL_HIS_NO
                       AND ROUT_REF_DIV_CD = 'POD'
                       and rownum < 600
                    ORDER BY AGN_AGMT_ROUT_SEQ))
)  AS POD
,(ACM_JOIN_FNC(CURSOR(SELECT ROUT_INFO_CD
                      FROM ACM_AGN_AGMT_DTL_ROUT_HIS DEL
                     WHERE DEL.AGMT_DTL_HIS_NO = CUR.AGMT_DTL_HIS_NO
                       AND ROUT_REF_DIV_CD = 'DEL'
                       and rownum < 600
                    ORDER BY AGN_AGMT_ROUT_SEQ))
)  AS DEL
,(ACM_JOIN_FNC(CURSOR(SELECT CHG_CD
                      FROM ACM_AGN_AGMT_DTL_CHG_HIS R
                     WHERE R.AGMT_DTL_HIS_NO = CUR.AGMT_DTL_HIS_NO
                       AND CHG_DIV_CD = 'R'
                       and rownum < 600
                    ))
)  AS REP_CHG_CD
,(ACM_JOIN_FNC(CURSOR(SELECT CHG_CD
                      FROM ACM_AGN_AGMT_DTL_CHG_HIS C
                     WHERE C.AGMT_DTL_HIS_NO = CUR.AGMT_DTL_HIS_NO
                       AND CHG_DIV_CD = 'C' 
                       and rownum < 600
                    ))
)  AS CHG_CD
,CUR.HLG_DDCT_ORG_FLG
,CUR.HLG_DDCT_DEST_FLG
,CUR.FDRG_DDCT_ORG_FLG
,CUR.FDRG_DDCT_DEST_FLG
,CUR.AGN_AGMT_SEQ||'/'||DECODE(CUR.IO_BND_CD,'I','In','O','Out')||'/'||CUR.AC_TP_CD AS MASTER_INFO



,ACM_JOIN_FNC(CURSOR(SELECT CNTR_TPSZ_CD FROM ACM_AGN_AGMT_DTL_CNTR_HIS CH WHERE CH.AGMT_DTL_HIS_NO = PRE.AGMT_DTL_HIS_NO )) AS PRE_TPSZ
,PRE.FULL_MTY_CD AS PRE_FULL_MTY_CD
,PRE.COMM_FX_AMT AS PRE_FIX_BASE
,(
 SELECT INTG_CD_VAL_DESC||'/' FROM COM_INTG_CD_DTL WHERE INTG_CD_ID = 'CD00600' AND INTG_CD_VAL_CTNT = PRE.COMM_PAY_TERM_CD) 
 ||DECODE(PRE.REV_DIV_CD,'N','Net/','Gross/')||PRE.COMM_RT AS PRE_RATE_BASE
,DECODE(PRE.OFC_SET_TP_CD,'B','BKG Office','A','AR Office','F','Fin Office') AS PRE_OFC_SET_TP_CD
,PRE.OFC_CVRG_CD AS PRE_OFC_CVRG_CD
,PRE.OFC_CD AS PRE_OFC_CD
,(ACM_JOIN_FNC(CURSOR(SELECT ROUT_INFO_CD
                      FROM ACM_AGN_AGMT_DTL_ROUT_HIS POR
                     WHERE POR.AGMT_DTL_HIS_NO = PRE.AGMT_DTL_HIS_NO
                       AND ROUT_REF_DIV_CD = 'POR'
                       and rownum < 600
                    ORDER BY AGN_AGMT_ROUT_SEQ))
)  AS PRE_POR
,(ACM_JOIN_FNC(CURSOR(SELECT ROUT_INFO_CD
                      FROM ACM_AGN_AGMT_DTL_ROUT_HIS POL
                     WHERE POL.AGMT_DTL_HIS_NO = PRE.AGMT_DTL_HIS_NO
                       AND ROUT_REF_DIV_CD = 'POL'
                       and rownum < 600
                    ORDER BY AGN_AGMT_ROUT_SEQ))
)  AS PRE_POL
,(ACM_JOIN_FNC(CURSOR(SELECT ROUT_INFO_CD
                      FROM ACM_AGN_AGMT_DTL_ROUT_HIS POD
                     WHERE POD.AGMT_DTL_HIS_NO = PRE.AGMT_DTL_HIS_NO
                       AND ROUT_REF_DIV_CD = 'POD'
                       and rownum < 600
                    ORDER BY AGN_AGMT_ROUT_SEQ))
)  AS PRE_POD
,(ACM_JOIN_FNC(CURSOR(SELECT ROUT_INFO_CD
                      FROM ACM_AGN_AGMT_DTL_ROUT_HIS DEL
                     WHERE DEL.AGMT_DTL_HIS_NO = PRE.AGMT_DTL_HIS_NO
                       AND ROUT_REF_DIV_CD = 'DEL'
                       and rownum < 600
                    ORDER BY AGN_AGMT_ROUT_SEQ))
)  AS PRE_DEL
,(ACM_JOIN_FNC(CURSOR(SELECT CHG_CD
                      FROM ACM_AGN_AGMT_DTL_CHG_HIS R
                     WHERE R.AGMT_DTL_HIS_NO = PRE.AGMT_DTL_HIS_NO
                       AND CHG_DIV_CD = 'R'
                       and rownum < 600
                    ))
)  AS PRE_REP_CHG_CD
,(ACM_JOIN_FNC(CURSOR(SELECT CHG_CD
                      FROM ACM_AGN_AGMT_DTL_CHG_HIS C
                     WHERE C.AGMT_DTL_HIS_NO = PRE.AGMT_DTL_HIS_NO
                       AND CHG_DIV_CD = 'C' 
                       and rownum < 600
                    ))
)  AS PRE_CHG_CD
,PRE.HLG_DDCT_ORG_FLG   AS PRE_HLG_DDCT_ORG_FLG
,PRE.HLG_DDCT_DEST_FLG  AS PRE_HLG_DDCT_DEST_FLG
,PRE.FDRG_DDCT_ORG_FLG  AS PRE_FDRG_DDCT_ORG_FLG
,PRE.FDRG_DDCT_DEST_FLG AS PRE_FDRG_DDCT_DEST_FLG


FROM 
 ACM_AGN_AGMT_DTL_HIS CUR
,ACM_AGN_AGMT_DTL_HIS PRE
WHERE 1=1
AND CUR.AGMT_DTL_HIS_NO IN (SELECT AGMT_DTL_HIS_NO                           FROM N WHERE N.AGMT_DTL_HIS_NO = @[agmt_his_no])
AND PRE.AGMT_DTL_HIS_NO IN (SELECT NVL(PRE_AGMT_DTL_HIS_NO,AGMT_DTL_HIS_NO)  FROM N WHERE N.AGMT_DTL_HIS_NO = @[agmt_his_no])


)B,
(
SELECT 1 AS SEQ,  'Compensation Rate' AS ITEM1, 'TP/SZ' AS ITEM2 FROM DUAL UNION ALL
SELECT 2 AS SEQ,  'Compensation Rate' AS ITEM1, 'Full/MT'        FROM DUAL UNION ALL
SELECT 3 AS SEQ,  'Compensation Rate' AS ITEM1, 'Fixed Base'     FROM DUAL UNION ALL
SELECT 4 AS SEQ,  'Compensation Rate' AS ITEM1, 'Rate Base'      FROM DUAL UNION ALL
SELECT 5 AS SEQ,  'Office Setting'    AS ITEM1, 'Type'           FROM DUAL UNION ALL
SELECT 6 AS SEQ,  'Office Setting'    AS ITEM1, 'Covers'         FROM DUAL UNION ALL
SELECT 7 AS SEQ,  'Office Setting'    AS ITEM1, 'Office'         FROM DUAL UNION ALL
SELECT 8 AS SEQ,  'Route Setting'     AS ITEM1, 'POR'            FROM DUAL UNION ALL
SELECT 9 AS SEQ,  'Route Setting'     AS ITEM1, 'POL'            FROM DUAL UNION ALL
SELECT 10 AS SEQ, 'Route Setting'     AS ITEM1, 'POD'            FROM DUAL UNION ALL
SELECT 11 AS SEQ, 'Route Setting'     AS ITEM1, 'DEL'            FROM DUAL UNION ALL
SELECT 12 AS SEQ, 'CHG Deduction'     AS ITEM1, 'Rep'            FROM DUAL UNION ALL
SELECT 13 AS SEQ, 'CHG Deduction'     AS ITEM1,'Individual'      FROM DUAL UNION ALL
SELECT 14 AS SEQ, 'Haulage Deduction' AS ITEM1,'Origin Haul.'    FROM DUAL UNION ALL
SELECT 15 AS SEQ, 'Haulage Deduction' AS ITEM1, 'Dest Haul.'     FROM DUAL UNION ALL
SELECT 16 AS SEQ, 'Haulage Deduction' AS ITEM1, 'Origin FDRG'    FROM DUAL UNION ALL
SELECT 17 AS SEQ, 'Haulage Deduction' AS ITEM1, 'Dest FDRG'      FROM DUAL
) A			]]></sql>
			<params>
				<param name="agn_agmt_no" type="12" value="" out="N"/>
				<param name="agmt_his_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
