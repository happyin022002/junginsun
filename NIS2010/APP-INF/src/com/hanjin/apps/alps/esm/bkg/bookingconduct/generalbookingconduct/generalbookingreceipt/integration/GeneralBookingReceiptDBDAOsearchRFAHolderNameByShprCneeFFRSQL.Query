<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="GeneralBookingReceiptDBDAOsearchRFAHolderNameByShprCneeFFRSQL">
			<desc><![CDATA[RFA Holder Name이 shpr / cnee / freight forwarder 셋 중 어딘가에 있는지 체크.
(RFA Holder Name이 2/3 일치하면 있다고 봄.(그 중간에 엔터, 스페이스가 들어가 있으면 Space로 바꿔서 체크)]]></desc>
			<sql><![CDATA[
WITH RFA_HOLDER AS (
            SELECT (SELECT MDM.CUST_LGL_ENG_NM FROM MDM_CUSTOMER MDM WHERE MDM.CUST_CNT_CD = RM.CTRT_CUST_CNT_CD AND MDM.CUST_SEQ = RM.CTRT_CUST_SEQ ) AS RFA_HOLDER_NAME
            from PRI_RP_MN RM, PRI_RP_HDR RH, BKG_BOOKING BKG
            WHERE RM.PROP_NO = RH.PROP_NO
            AND RM.PROP_STS_CD  = 'A'
            AND  RH.RFA_NO = BKG.RFA_NO 
            AND BKG.BKG_NO = @[bkg_no]
            AND ROWNUM = 1
            )
SELECT RFA_HOLDER_NAME, EXISTS_RFA, DISPLAY
FROM (
	SELECT RFA_HOLDER_NAME, EXISTS_RFA, DISPLAY
	FROM 
	(SELECT SH.CUST_NM RFA_HOLDER_NAME, 'Y' EXISTS_RFA, '1' DISPLAY
	  FROM BKG_CUSTOMER SH,
	       RFA_HOLDER
	 WHERE SH.BKG_NO = @[bkg_no]
	  AND SH.BKG_CUST_TP_CD(+) = 'S'
	  AND REPLACE(REPLACE(SH.CUST_NM,CHR(13)||CHR(10),' '),' ','') LIKE '%' || SUBSTR(REPLACE(REPLACE(RFA_HOLDER.RFA_HOLDER_NAME,CHR(13)||CHR(10),' '),' ',''),1,LENGTH(REPLACE(REPLACE(RFA_HOLDER.RFA_HOLDER_NAME,CHR(13)||CHR(10),' '),' ',''))*(2/3)) || '%'
	UNION
	SELECT CN.CUST_NM RFA_HOLDER_NAME,  'Y' EXISTS_RFA, '2' DISPLAY
	  FROM BKG_CUSTOMER CN,
	       RFA_HOLDER
	 WHERE CN.BKG_NO = @[bkg_no]
	  AND CN.BKG_CUST_TP_CD(+) = 'C'
	  AND REPLACE(REPLACE(CN.CUST_NM,CHR(13)||CHR(10),' '),' ','') LIKE '%' || SUBSTR(REPLACE(REPLACE(RFA_HOLDER.RFA_HOLDER_NAME,CHR(13)||CHR(10),' '),' ',''),1,LENGTH(REPLACE(REPLACE(RFA_HOLDER.RFA_HOLDER_NAME,CHR(13)||CHR(10),' '),' ',''))*(2/3)) || '%'
	UNION
	SELECT FF.CUST_NM RFA_HOLDER_NAME,  'Y' EXISTS_RFA, '3' DISPLAY
	  FROM BKG_CUSTOMER FF,
	       RFA_HOLDER
	 WHERE FF.BKG_NO = @[bkg_no]
	  AND FF.BKG_CUST_TP_CD(+) = 'F'
	  AND REPLACE(REPLACE(FF.CUST_NM,CHR(13)||CHR(10),' '),' ','') LIKE '%' || SUBSTR(REPLACE(REPLACE(RFA_HOLDER.RFA_HOLDER_NAME,CHR(13)||CHR(10),' '),' ',''),1,LENGTH(REPLACE(REPLACE(RFA_HOLDER.RFA_HOLDER_NAME,CHR(13)||CHR(10),' '),' ',''))*(2/3)) || '%'
	UNION 
#if (${rate_flg}== 'Y')
	SELECT EX.CUST_NM RFA_HOLDER_NAME,  'Y' EXISTS_RFA, '4' DISPLAY
	  FROM BKG_CUSTOMER EX,
	       RFA_HOLDER
	 WHERE EX.BKG_NO = @[bkg_no]
	  AND EX.BKG_CUST_TP_CD(+) = 'E'
	  AND REPLACE(REPLACE(EX.CUST_NM,CHR(13)||CHR(10),' '),' ','') LIKE '%' || SUBSTR(REPLACE(REPLACE(RFA_HOLDER.RFA_HOLDER_NAME,CHR(13)||CHR(10),' '),' ',''),1,LENGTH(REPLACE(REPLACE(RFA_HOLDER.RFA_HOLDER_NAME,CHR(13)||CHR(10),' '),' ',''))*(2/3)) || '%'
    UNION  
#end
	SELECT RFA_HOLDER.RFA_HOLDER_NAME,  'N' EXISTS_RFA, '5' DISPLAY
	  FROM RFA_HOLDER
	) T
ORDER BY DISPLAY )
WHERE ROWNUM = 1			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
