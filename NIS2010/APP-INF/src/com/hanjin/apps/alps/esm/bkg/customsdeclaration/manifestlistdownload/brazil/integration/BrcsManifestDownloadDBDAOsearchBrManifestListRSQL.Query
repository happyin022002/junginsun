<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BrcsManifestDownloadDBDAOsearchBrManifestListRSQL">
			<desc><![CDATA[Brazil세관에서 대상 조회를 한다.
searchBrManifestList]]></desc>
			<sql><![CDATA[
SELECT  MAIN.BL_NO 
      , MAIN.BL_NO MERGE_BL_NO
      , MAIN.SEQ BL_GROUP
      , MAIN.BKG_NO
      , MAIN.BKG_CGO_TP_CD SEARCH_BKG_CGO_TP_CD
	  , MAIN.CUST_TO_ORD_FLG

      , REPLACE(MAIN.SHIPPER_CUST_NM, CHR(13)||CHR(10), ' ') SHIPPER_CUST_NM
      , MAIN.OB_SHPR_TAX_NO
      , MAIN.SHPR_TAX_NO
      
      , REPLACE(MAIN.CONSIGNEE_CUST_NM, CHR(13)||CHR(10), ' ') CONSIGNEE_CUST_NM
      , MAIN.OB_CNEE_TAX_NO
      , MAIN.CNEE_TAX_NO
      
      , REPLACE(MAIN.NOTIFY_CUST_NM, CHR(13)||CHR(10), ' ') NOTIFY_CUST_NM
      , MAIN.OB_NTFY_TAX_NO
      , MAIN.NTFY_TAX_NO

      , MAIN.BRZ_DECL_NO
      , MAIN.OB_BRZ_DECL_NO
      , MAIN.KEY_BL_NO
      , MAIN.IF_FLAG
      , MAIN.CNTR_NO
      , MAIN.PCK_QTY
      , MAIN.PCK_TP_CD
      , MAIN.WEIGHT
      , MAIN.WGT_UT_CD
      , MAIN.MEASURE
      , MAIN.MEAS_UT_CD
      , MAIN.BOOKING_CMDT_NM
      , MAIN.CNTR_MF_SEQ

      , MAIN.NCM_NO
      , DECODE(MAIN.NCM_NO,NULL,0,1) NCM_MULTI_POP
      , (
           SELECT  CASE WHEN COUNT(1) > 1 THEN 'Y' ELSE 'N' END
           FROM    BKG_CSTMS_BRZ_CNTR_MF_DTL
           WHERE   1 = 1
           AND     BL_NO = MAIN.BL_NO
           AND     CNTR_NO = MAIN.CNTR_NO
           AND     CNTR_MF_SEQ = MAIN.CNTR_MF_SEQ
        ) NCM_MULTI_FLG

      , CASE 
            WHEN IF_FLAG = 'Y' 
                THEN 
                    NVL(BKG_JOIN_FNC(CURSOR(
                                  SELECT  BRZ_CMDT_CD
                                  FROM    BKG_CSTMS_BRZ_CNTR_MF_DTL
                                  WHERE   1 = 1
                                  AND     BL_NO = MAIN.BL_NO
                                  AND     CNTR_NO = MAIN.CNTR_NO
                                  AND     CNTR_MF_SEQ = MAIN.CNTR_MF_SEQ
                               )
                        ),'')       
                ELSE 
                    NVL(BKG_JOIN_FNC(CURSOR(
                                  SELECT  NCM_NO
                                  FROM    BKG_CNTR_MF_DESC_DTL
                                  WHERE   1 = 1
                                  AND     BKG_NO = MAIN.BKG_NO
                                  AND     CNTR_NO = MAIN.CNTR_NO
                                  AND     CNTR_MF_SEQ = MAIN.CNTR_MF_SEQ
                               )
                        ),'')       
                
        END AS NCM_MULTI_NO

      , (  SELECT  Z.CMDT_DESC                                          
           FROM    BKG_CSTMS_CMDT Z                                      
           WHERE   Z.CNT_CD = 'BR'                                        
           AND     Z.MF_CMDT_CD = MAIN.NCM_NO
        ) CSTMS_DESC
#if (${bl_no} != '')
	  , VVD VVD_CD
	  , POL POL_CD
	  , POD POD_CD
#else
      , NVL(@[vvd_cd], '') VVD_CD
	  , NVL(@[pol_cd], '') POL_CD
	  , NVL(@[pod_cd], '') POD_CD
#end
      , OFT
      , CAP
      , DEL_CD
      , NVL(BR_DUV, ' ') BR_DUV
      , NVL(BR_MID, ' ') BR_MID
      , IB_TS_YN , OB_TS_YN
      , WPM
FROM    (
           SELECT  SUB1.BL_NO BL_NO 
                 , SUM(SUB1.C_BL_NO) OVER (ORDER BY BL_NO) SEQ 
                 , SUB1.BKG_NO BKG_NO 
 			     , SUB1.BKG_CGO_TP_CD
				 , SUB1.CUST_TO_ORD_FLG

                 , SUB1.SHIPPER_CUST_NM
                 , SUB1.CONSIGNEE_CUST_NM
				 , SUB1.NOTIFY_CUST_NM

                 , SUB1.SHPR_TAX_NO OB_SHPR_TAX_NO
                 , SUB1.CNEE_TAX_NO OB_CNEE_TAX_NO
                 , SUB1.NTFY_TAX_NO OB_NTFY_TAX_NO
				 , SUB1.BRZ_DECL_NO OB_BRZ_DECL_NO

                 , DECODE(SUB1.IF_FLAG,'Y',SUB1.NEW_SHPR_TAX_NO, SUB1.SHPR_TAX_NO) SHPR_TAX_NO
                 , DECODE(SUB1.IF_FLAG,'Y',SUB1.NEW_CNEE_TAX_NO, SUB1.CNEE_TAX_NO) CNEE_TAX_NO
                 , DECODE(SUB1.IF_FLAG,'Y',SUB1.NEW_NTFY_TAX_NO, SUB1.NTFY_TAX_NO) NTFY_TAX_NO

                 , DECODE(SUB1.IF_FLAG,'Y',SUB1.NEW_BRZ_DECL_NO, SUB1.BRZ_DECL_NO) BRZ_DECL_NO
                 , SUB1.KEY_BL_NO
                 , SUB1.IF_FLAG
                 , SUB1.CNTR_NO
                 , SUB1.PCK_QTY
                 , SUB1.PCK_TP_CD
                 , SUB1.WEIGHT
                 , SUB1.WGT_UT_CD
                 , SUB1.MEASURE
                 , SUB1.MEAS_UT_CD
                 , SUB1.BOOKING_CMDT_NM

                 , SUB1.NEW_SHPR_TAX_NO
                 , SUB1.NEW_CNEE_TAX_NO
                 , SUB1.NEW_NTFY_TAX_NO

                 , SUB1.NEW_BRZ_DECL_NO
                 , SUB1.DEL_CD
--                 , DECODE(SUB1.IF_FLAG,'Y',SUB1.NEW_CNTR_MF_SEQ, SUB1.CNTR_MF_SEQ) CNTR_MF_SEQ
--                 , DECODE(SUB1.IF_FLAG,'Y',SUB1.NEW_BRZ_CMDT_CD, SUB1.NCM_NO) NCM_NO
                 , NVL(DECODE(SUB1.IF_FLAG,'Y',SUB1.NEW_CNTR_MF_SEQ, SUB1.CNTR_MF_SEQ),SUB1.CNTR_MF_SEQ) CNTR_MF_SEQ
                 , DECODE(SUB1.IF_FLAG,'Y',SUB1.NEW_BRZ_CMDT_CD, SUB1.NCM_NO) NCM_NO
			     , DECODE(SUB1.OFT, 'Y', 'Y', 'N') OFT

       			 ,CASE WHEN @[io_type] = 'O' THEN DECODE(SUB1.OTH, 'Y', 'Y', 'N')
						ELSE DECODE(SUB1.DTH, 'Y', 'Y', 'N')
        		  END CAP

                 , SUB1.BRZ_CSTMS_DUV_NM BR_DUV
                 , SUB1.BRZ_CSTMS_MF_ID BR_MID
				 , VVD
				 , POL
				 , POD
                 , IB_TS_YN , OB_TS_YN
                 , WPM
           FROM    (
                      SELECT  B.BL_NO BL_NO
                            , DECODE(LAG(B.BL_NO) OVER ( ORDER BY B.BL_NO, B.CNTR_NO, B.CNTR_MF_SEQ) , B.BL_NO, 0, 1) C_BL_NO
                            , B.BKG_NO BKG_NO
                            , B.BL_NO KEY_BL_NO
    		                , B.BKG_CGO_TP_CD
							, B.CUST_TO_ORD_FLG
                            , (
                                 SELECT  CUST_NM
                                 FROM    BKG_CUSTOMER
                                 WHERE   BKG_NO = B.BKG_NO
                                 AND     BKG_CUST_TP_CD = 'S'
                              ) SHIPPER_CUST_NM
                            , (
                                 SELECT  CUST_NM
                                 FROM    BKG_CUSTOMER
                                 WHERE   BKG_NO = B.BKG_NO
                                 AND     BKG_CUST_TP_CD = 'C'
                              ) CONSIGNEE_CUST_NM
                            , (
                                 SELECT  CUST_NM
                                 FROM    BKG_CUSTOMER
                                 WHERE   BKG_NO = B.BKG_NO
                                 AND     BKG_CUST_TP_CD = 'N'
                              ) NOTIFY_CUST_NM

                            , B.CNTR_NO                                                     
                            , B.PCK_QTY                                                     
                            , B.PCK_TP_CD                                                  
                            , B.CNTR_MF_WGT WEIGHT    
                            , B.WGT_UT_CD                         
                            , B.MEAS_QTY MEASURE    
                            , B.MEAS_UT_CD
                            , B.NCM_NO                         
                            , ( SELECT CMDT_NM FROM MDM_COMMODITY WHERE CMDT_CD = B.CMDT_CD ) BOOKING_CMDT_NM 

                            , I.SHPR_TAX_NO
                            , I.CNEE_TAX_NO
                            , I.NTFY_TAX_NO
   
                            , I.BRZ_DECL_NO
                            , I.BRZ_CMDT_CD

                            , BL.SHPR_TAX_NO NEW_SHPR_TAX_NO  
                            , BL.CNEE_TAX_NO NEW_CNEE_TAX_NO   
                            , BL.NTFY_TAX_NO NEW_NTFY_TAX_NO   
                             
                            , BL.BRZ_DECL_NO NEW_BRZ_DECL_NO                                 
                            , BC.BRZ_CMDT_CD NEW_BRZ_CMDT_CD                                 
                            , B.CNTR_MF_SEQ CNTR_MF_SEQ                                    
                            , BC.CNTR_MF_SEQ NEW_CNTR_MF_SEQ                                    
                            , B.DEL_CD
                            , DECODE(NVL(BL.BL_NO, ''), '', 'N', 'Y') IF_FLAG 
                            , (
                                 SELECT  'Y' 
                                 FROM    BKG_CHG_RT
                                 WHERE   BKG_NO = B.BKG_NO
                                 AND     CHG_CD = 'OFT'
                                 AND     ROWNUM = 1
                              ) OFT
                            , (
                                 SELECT 'Y' 
                                 FROM BKG_CHG_RT
                                 WHERE BKG_NO = B.BKG_NO
                                 AND CHG_CD = 'OTH'
                                 AND ROWNUM = 1
                               ) OTH
                            , (
                                 SELECT 'Y' 
                                 FROM BKG_CHG_RT
                                 WHERE BKG_NO = B.BKG_NO
                                 AND CHG_CD = 'DTH'
                                 AND ROWNUM = 1
                               ) DTH
                            , BL.BRZ_CSTMS_DUV_NM
                            , BL.BRZ_CSTMS_MF_ID
							, B.VVD
							, B.POL
							, B.POD
                            , IB_TS_YN , OB_TS_YN
                            , WPM
                      FROM    (
                                 SELECT  B.BKG_CGO_TP_CD
                                       , B.BKG_NO
                                       , B.BL_NO,B.CMDT_CD
                                       , D.CNTR_MF_SEQ
                                       , C.CNTR_NO
        							   , B.CUST_TO_ORD_FLG
                                       , MAX(D.PCK_QTY) PCK_QTY
                                       , MAX( NVL(D.PCK_TP_CD, C.PCK_TP_CD) ) PCK_TP_CD
                                       , MAX(D.CNTR_MF_WGT) CNTR_MF_WGT
                                       , MAX(  NVL(D.WGT_UT_CD, C.WGT_UT_CD) ) WGT_UT_CD
                                       , MAX(D.MEAS_QTY) MEAS_QTY
                                       , MAX( NVL(D.MEAS_UT_CD, C.MEAS_UT_CD) ) MEAS_UT_CD
                                       , MAX(D.NCM_NO) NCM_NO
                                       , MAX(B.DEL_CD) DEL_CD
									   , MAX( V.VSL_CD||V.SKD_vOY_NO||V.SKD_dIR_cD) VVD
									   , MAX( V.POL_cD) POL
									   , MAX( V.POD_cD) POD
									   , MAX(CASE WHEN V.POD_CD != B.POD_CD THEN 'Y' ELSE 'N' END) IB_TS_YN
                                       , MAX(CASE WHEN V.POL_CD != B.POL_CD THEN 'Y' ELSE 'N' END) OB_TS_YN
                                       , MAX(CASE WHEN WPM_TRT_CD = 'A' THEN 'N/A' ELSE NVL(WPM_TRT_CD,' ') END) WPM
                                 FROM    BKG_BOOKING B
                                       , BKG_VVD V
                                       , BKG_CONTAINER C
                                       , BKG_CNTR_MF_DESC D
                                       , BKG_BOOKING E

                                 WHERE   1 = 1
    #if (${vvd_cd} != '') 
                                 AND     V.VSL_CD     = SUBSTR (@[vvd_cd], 1, 4)
                                 AND     V.SKD_VOY_NO = SUBSTR (@[vvd_cd], 5, 4)
                                 AND     V.SKD_DIR_CD = SUBSTR (@[vvd_cd], 9, 1)
    #end
                 
    #if (${pol_cd} != '') 
                                 AND     V.POL_CD        = @[pol_cd]                    
    #end 
        
    #if (${pod_cd} != '') 
                                 AND     V.POD_CD        = @[pod_cd]                 
    #end

    #if (${bl_no} != '') 
                                 AND     B.BL_NO        = @[bl_no]
								 AND	 DECODE( @[io_type], 'O', SUBSTR(V.POL_CD,1,2), SUBSTR(V.POD_CD,1,2) )  = 'BR'
    #end

                                 AND     B.BKG_NO = V.BKG_NO
                                 AND     B.BKG_NO = C.BKG_NO(+)
                                 AND     C.BKG_NO = D.BKG_NO(+) 
                                 AND     C.CNTR_NO = D.CNTR_NO(+)
                                 AND     B.FM_BKG_NO = E.BKG_NO(+)
				                 AND     (     B.BKG_STS_CD IN ('F','W')
     					                    OR (B.BKG_STS_CD = 'S' AND B.SPLIT_RSN_CD ='M')
   					                     )
				                 AND     NVL(E.SPLIT_RSN_CD,'XX') <> 'M'

    #if (${bkg_cgo_tp_cd} == 'F')
                                 AND     B.BKG_CGO_TP_CD IN ('F', 'R')
	#elseif (${bkg_cgo_tp_cd} == 'P') 
								 AND     B.BKG_CGO_TP_CD IN ('P')
    #end

    #if (${del_cd} != '') 
                                 AND     B.DEL_CD        = @[del_cd]                 
    #end

				                 AND     D.CNTR_MF_SEQ(+) > 0
				                 GROUP BY
                                         B.BKG_CGO_TP_CD
                                       , B.BKG_NO
                                       , B.BL_NO,B.CMDT_CD
									   , B.CUST_TO_ORD_FLG
                                       , D.CNTR_MF_SEQ
                                       , C.CNTR_NO

                              ) B

                            , (    
                                 SELECT  A.BKG_NO
                                       , A.IO_BND_CD
                                       , MAX(A.XPT_IMP_SEQ) XPT_IMP_SEQ

                                       ,MAX(A.SHPR_TAX_NO) SHPR_TAX_NO
                                       ,MAX(A.CNEE_TAX_NO) CNEE_TAX_NO
                                       ,MAX(A.NTFY_TAX_NO) NTFY_TAX_NO

                                       , MAX(A.BRZ_DECL_NO) BRZ_DECL_NO
                                       , MAX(A.BRZ_CMDT_CD) BRZ_CMDT_CD
                                 FROM    BKG_XPT_IMP_LIC A
                                       , BKG_BOOKING B
                                       , BKG_VVD V
                                       , BKG_BOOKING E
                                 WHERE   1 = 1
#if (${vvd_cd} != '') 
                                 AND     V.VSL_CD        = SUBSTR(@[vvd_cd], 1, 4)   
                                 AND     V.SKD_VOY_NO    = SUBSTR(@[vvd_cd], 5, 4)   
                                 AND     V.SKD_DIR_CD    = SUBSTR(@[vvd_cd], 9, 1)   
#end
    
#if (${pol_cd} != '') 
                                 AND     V.POL_CD        = @[pol_cd]                    
#end 
        
#if (${pod_cd} != '') 
                                 AND     V.POD_CD        = @[pod_cd]                 
#end

#if (${bl_no} != '') 
                                 AND     B.BL_NO        = @[bl_no]                 
#end

                                 AND     B.BKG_NO        = V.BKG_NO
                                 AND     B.FM_BKG_NO = E.BKG_NO(+)
			                     AND     (B.BKG_STS_CD IN ('F','W')
     					                     OR (B.BKG_STS_CD = 'S' AND B.SPLIT_RSN_CD ='M')
   					                      )
				                 AND     NVL(E.SPLIT_RSN_CD,'XX') <> 'M'
                                 AND     A.IO_BND_CD     = @[io_type]
                                 AND     A.BKG_NO        = V.BKG_NO 

#if (${bkg_cgo_tp_cd} == 'F') 
				                 AND      B.BKG_CGO_TP_CD IN ('F', 'R')
#elseif (${bkg_cgo_tp_cd} == 'P')
				                 AND      B.BKG_CGO_TP_CD = 'P'
#end

#if (${del_cd} != '') 
                                 AND     B.DEL_CD        = @[del_cd]                 
#end

                                 GROUP BY
                                         A.BKG_NO
                                       , A.IO_BND_CD
                              ) I
                            , BKG_CSTMS_BRZ_BL BL
                            , BKG_CSTMS_BRZ_CNTR_MF BC
                      WHERE   1 = 1
                      AND     B.BKG_NO            = I.BKG_NO(+)              
                      AND     B.BL_NO             = BL.BL_NO(+)    
                      AND     B.BL_NO          	= BC.BL_NO(+)                    
                      AND     B.CNTR_MF_SEQ       = BC.CNTR_MF_SEQ(+)            
                      AND     B.CNTR_NO           = BC.CNTR_NO(+) 
#if (${br_duv} != '')
                      AND     UPPER(BL.BRZ_CSTMS_DUV_NM) = @[br_duv]
#end

#if (${br_mid} != '')
                      AND     UPPER(BL.BRZ_CSTMS_MF_ID)  = @[br_mid] 
#end
                      ORDER BY
                              BL_NO
                            , CNTR_NO
                            , B.CNTR_MF_SEQ
                   ) SUB1
        ) MAIN

WHERE   1 = 1                                 
#if (${cnpj_no} != '')
AND     UPPER(CNEE_TAX_NO) = @[cnpj_no] 
#end        
#if (${error_type} == '2') 
    #if (${io_type} == 'O') 
AND     (   NVL(CNEE_TAX_NO, ' ') = ' '
         OR NVL(BRZ_DECL_NO, ' ') = ' '
         OR NVL(PCK_QTY, 0) = 0
         OR NVL(PCK_TP_CD, ' ') = ' '
         OR NVL(WEIGHT, 0) = 0
         OR NVL(MEASURE, 0) = 0
         OR NVL(NCM_NO, ' ') = ' '
        )
    #end
    
    #if (${io_type} == 'I') 
AND     (   
			NVL(SHPR_TAX_NO, ' ') = ' '         
         OR NVL(PCK_QTY, 0) = 0          
         OR NVL(PCK_TP_CD, ' ') = ' '        
         OR NVL(WEIGHT, 0) = 0           
         OR NVL(MEASURE, 0) = 0          
         OR NVL(NCM_NO, ' ') = ' '
        )     
    #end
#end			]]></sql>
			<params>
				<param name="vvd_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="io_type" type="12" value="" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
				<param name="del_cd" type="12" value="" out="N"/>
				<param name="br_duv" type="12" value="" out="N"/>
				<param name="br_mid" type="12" value="" out="N"/>
				<param name="cnpj_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
