<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BLDocumentationCMDBDAOContainerRSQL">
			<desc><![CDATA[update]]></desc>
			<sql><![CDATA[
#if (${ca_flg} == 'Y') 
WITH BKG1 AS(
			 SELECT * 
			 		FROM(
							 SELECT A.BKG_NO,
									A. VPS_ETD_DT,
							 		ROW_NUMBER() OVER (PARTITION BY CTM.CNTR_NO ORDER BY CTM.CNMV_CYC_NO DESC , CTM.CNMV_EVNT_DT) RNUM,
				                    CNTR.CNTR_NO,
				                    CTM.CNMV_EVNT_DT
			                 FROM (                    
				 					SELECT ETD.BKG_NO
					   					  ,ETD.VPS_ETD_DT
					   					  ,ETD.POL_CD
					   					  ,ETD.POR_CD
				 					FROM (
											SELECT VSK.VPS_ETD_DT, BK.BKG_NO, BK.POR_CD, BK.POL_CD
											FROM BKG_BKG_HIS BK, BKG_VVD_HIS VVD, VSK_VSL_PORT_SKD VSK
											WHERE 1=1
											AND BK.BKG_NO = @[bkg_no]
											AND BK.BKG_NO = VVD.BKG_NO
                      						AND BK.POL_CD = VVD.POL_CD
					                      	AND VVD.VSL_CD = VSK.VSL_CD
					                      	AND VVD.SKD_VOY_NO = VSK.SKD_VOY_NO
					                      	AND VVD.SKD_DIR_CD = VSK.SKD_DIR_CD
					                      	AND VVD.POL_CLPT_IND_SEQ = VSK.CLPT_IND_SEQ
					                      	AND VVD.POL_CD = VSK.VPS_PORT_CD
					                      	AND BK.CORR_NO ='TMP0000001'
					                        AND VVD.CORR_NO ='TMP0000001'
					                     	ORDER BY VVD.VSL_PRE_PST_CD, VVD.VSL_SEQ  
			      						 ) ETD
		  							WHERE ROWNUM = 1 ) A, CTM_MOVEMENT CTM, BKG_CNTR_HIS CNTR
			 				WHERE A.BKG_NO = CNTR.BKG_NO
			       			AND CTM.CNTR_NO = CNTR.CNTR_NO
			   				AND (CTM.ORG_YD_CD LIKE A.POR_CD||'%' OR CTM.ORG_YD_CD LIKE A.POL_CD||'%')
						    AND CTM.MVMT_STS_CD ='OC'
						    AND CTM.CNMV_EVNT_DT >= A.VPS_ETD_DT - 45
			       			AND CTM.CNMV_EVNT_DT <= A.VPS_ETD_DT  + 30
			       			AND CNTR.CORR_NO = 'TMP0000001'
							AND (SELECT /*+ INDEX_DESC(CTM, XUK1CTM_MOVEMENT) */ MVMT_STS_CD FROM CTM_MOVEMENT CTM WHERE CNTR_NO = CNTR.CNTR_NO  AND ROWNUM =1 ) NOT IN ('OP','MT')
							)
				WHERE 1=1
				  AND RNUM = 1
			 )
SELECT A.BKG_NO
,      A.CNTR_NO
,      A.CNTR_NO CNTR_NO_OLD
,      CNTR_TPSZ_CD
,      '' CNTR_SEAL_NO
,      ROW_NUMBER() OVER (ORDER BY A.CNTR_DP_SEQ, A.CNTR_NO) CNTR_DP_SEQ
,      PCK_QTY
,      PCK_TP_CD
,      CNTR_WGT
,      WGT_UT_CD
,      MEAS_QTY
,      MEAS_UT_CD
,      A.RCV_TERM_CD
,      A.DE_TERM_CD
,      A.CNTR_PRT_FLG
,      A.CNTR_VOL_QTY
,      EQ_SUBST_TPSZ_CD
,      A.ADV_SHTG_CD
,      (SELECT B.CNMV_STS_CD FROM MST_CONTAINER B
        WHERE B.CNTR_NO = A.CNTR_NO) CNMV_STS_CD
,      A.HNGR_FLG
,      A.DCGO_FLG
,      A.BB_CGO_FLG
,      A.AWK_CGO_FLG
,      A.RC_FLG
,      DECODE(SUBSTR(CNTR_TPSZ_CD, 1, 1), 'R', DECODE(A.RC_FLG, 'Y', 'N', 'Y'), NVL(A.RC_FLG, 'Y')) RD_CGO_FLG
,      A.SOC_FLG
,      A.ORG_YD_CD
,      (SELECT TO_CHAR(B.CNMV_DT, 'YYYYMMDDHH24MI') FROM MST_CONTAINER B
        WHERE B.CNTR_NO = A.CNTR_NO) CNMV_EVNT_DT
,      NVL2(A.CGO_RCV_DT, 'Y', 'N') AS CGO_RCV_DT_FLG
,      DECODE(CGO_RCV_DT, NULL,TO_CHAR(BKG1.CNMV_EVNT_DT,'YYYYMMDDHH24MI'),TO_CHAR(CGO_RCV_DT, 'YYYYMMDDHH24MI')) CGO_RCV_DT
,      PO_NO
,      DIFF_RMK
,      CNTR_CFM_FLG
,      DO_NO
,      (SELECT DECODE(COUNT(CNTR_MF_SEQ), '0', 'N', 'Y')
        FROM   BKG_CNTR_MF_DESC_HIS
        WHERE  BKG_NO = A.BKG_NO
           AND CORR_NO = 'TMP0000001'
           AND CNTR_NO = A.CNTR_NO) CM_FLG
,      (SELECT COUNT(SA.IMG_SEQ)
        FROM   BKG_IMG_STO SA, BKG_DG_CGO_HIS SB
        WHERE  SB.BKG_NO = SA.BKG_NO
           AND SB.DCGO_SEQ = SA.DCGO_SEQ
           AND SB.BKG_NO = A.BKG_NO
           AND SB.CORR_NO = 'TMP0000001'
           AND SB.CNTR_NO = A.CNTR_NO) DCGO_CNT
,      A.CRE_USR_ID
,      A.UPD_USR_ID
,      BK.POL_CD
,      A.ONE_WY_FREE_FLG
,      A.MF_CFM_FLG
,      A.LBP_FLG
,	   A.VGM_WGT 
,      A.VGM_WGT_UT_CD
,	   TO_CHAR(A.VGM_VRFY_DT,'YYYY-MM-DD') VGM_VRFY_DT
,	   TO_CHAR(A.VGM_DTMN_DT,'YYYY-MM-DD') VGM_DTMN_DT
,	   A.VGM_VRFY_SIG_CTNT
,      A.VGM_MZD_TP_CD
FROM   BKG_CNTR_HIS A, BKG_BKG_HIS BK, BKG1
WHERE  A.BKG_NO = @[bkg_no]
  AND  A.BKG_NO = BK.BKG_NO
  AND  A.BKG_NO = BKG1.BKG_NO(+)
  AND  A.CNTR_NO = BKG1.CNTR_NO(+)
  AND  A.CORR_NO = 'TMP0000001'
  AND  BK.CORR_NO = 'TMP0000001'
ORDER BY CNTR_DP_SEQ, CNTR_NO
#else 
WITH BKG1 AS(
			 SELECT * 
			 		FROM(
							 SELECT A.BKG_NO,
									A. VPS_ETD_DT,
							 		ROW_NUMBER() OVER (PARTITION BY CTM.CNTR_NO ORDER BY CTM.CNMV_CYC_NO DESC , CTM.CNMV_EVNT_DT) RNUM,
				                    CNTR.CNTR_NO,
				                    CTM.CNMV_EVNT_DT
			                 FROM (                    
				 					SELECT ETD.BKG_NO
					   					  ,ETD.VPS_ETD_DT
					   					  ,ETD.POL_CD
					   					  ,ETD.POR_CD
				 					FROM (
											SELECT VSK.VPS_ETD_DT, BK.BKG_NO, BK.POR_CD, BK.POL_CD
											FROM BKG_BOOKING BK, BKG_VVD VVD, VSK_VSL_PORT_SKD VSK
											WHERE 1=1
											AND BK.BKG_NO = @[bkg_no]
											AND BK.BKG_NO = VVD.BKG_NO
                      						AND BK.POL_CD = VVD.POL_CD
					                      	AND VVD.VSL_CD = VSK.VSL_CD
					                      	AND VVD.SKD_VOY_NO = VSK.SKD_VOY_NO
					                      	AND VVD.SKD_DIR_CD = VSK.SKD_DIR_CD
					                      	AND VVD.POL_CLPT_IND_SEQ = VSK.CLPT_IND_SEQ
					                      	AND VVD.POL_CD = VSK.VPS_PORT_CD
					                     	ORDER BY VVD.VSL_PRE_PST_CD, VVD.VSL_SEQ  
			      						 ) ETD
		  							WHERE ROWNUM = 1 ) A, CTM_MOVEMENT CTM, BKG_CONTAINER CNTR
			 				WHERE A.BKG_NO = CNTR.BKG_NO
			       			AND CTM.CNTR_NO = CNTR.CNTR_NO
			   				AND (CTM.ORG_YD_CD LIKE A.POR_CD||'%' OR CTM.ORG_YD_CD LIKE A.POL_CD||'%')
						    AND CTM.MVMT_STS_CD ='OC'
						    AND CTM.CNMV_EVNT_DT >= A.VPS_ETD_DT - 45
			       			AND CTM.CNMV_EVNT_DT <= A.VPS_ETD_DT  + 30
							AND (SELECT /*+ INDEX_DESC(CTM, XUK1CTM_MOVEMENT) */ MVMT_STS_CD FROM CTM_MOVEMENT CTM WHERE CNTR_NO = CNTR.CNTR_NO  AND ROWNUM =1 ) NOT IN ('OP','MT')
							)
				WHERE 1=1
				  AND RNUM = 1
			 )
SELECT A.BKG_NO
,      A.CNTR_NO
,      A.CNTR_NO CNTR_NO_OLD
,      CNTR_TPSZ_CD
,      '' CNTR_SEAL_NO
,      ROW_NUMBER() OVER (ORDER BY A.CNTR_DP_SEQ, A.CNTR_NO) CNTR_DP_SEQ
,      PCK_QTY
,      PCK_TP_CD
,      CNTR_WGT
,      WGT_UT_CD
,      MEAS_QTY
,      MEAS_UT_CD
,      A.RCV_TERM_CD
,      A.DE_TERM_CD
,      A.CNTR_PRT_FLG
,      A.CNTR_VOL_QTY
,      EQ_SUBST_TPSZ_CD
,      A.ADV_SHTG_CD
,      (SELECT B.CNMV_STS_CD FROM MST_CONTAINER B
        WHERE B.CNTR_NO = A.CNTR_NO) CNMV_STS_CD
,      A.HNGR_FLG
,      A.DCGO_FLG
,      A.BB_CGO_FLG
,      A.AWK_CGO_FLG
,      A.RC_FLG
,      DECODE(SUBSTR(CNTR_TPSZ_CD, 1, 1), 'R', DECODE(A.RC_FLG, 'Y', 'N', 'Y'), NVL(A.RC_FLG, 'Y')) RD_CGO_FLG
,      A.SOC_FLG
,      A.ORG_YD_CD
,      (SELECT TO_CHAR(B.CNMV_DT, 'YYYYMMDDHH24MI') FROM MST_CONTAINER B
        WHERE B.CNTR_NO = A.CNTR_NO) CNMV_EVNT_DT
,      NVL2(A.CGO_RCV_DT, 'Y', 'N') AS CGO_RCV_DT_FLG
,      DECODE(CGO_RCV_DT, NULL,TO_CHAR(BKG1.CNMV_EVNT_DT,'YYYYMMDDHH24MI'),TO_CHAR(CGO_RCV_DT, 'YYYYMMDDHH24MI')) CGO_RCV_DT
,      PO_NO
,      DIFF_RMK
,      CNTR_CFM_FLG
,      DO_NO
,      (SELECT DECODE(COUNT(CNTR_MF_SEQ), '0', 'N', 'Y')
        FROM   BKG_CNTR_MF_DESC
        WHERE  BKG_NO = A.BKG_NO
        AND    CNTR_NO = A.CNTR_NO) CM_FLG
,      (SELECT COUNT(SA.IMG_SEQ)
        FROM   BKG_IMG_STO SA, BKG_DG_CGO SB
        WHERE  SB.BKG_NO = SA.BKG_NO
        AND    SB.DCGO_SEQ = SA.DCGO_SEQ
        AND    SB.BKG_NO = A.BKG_NO
        AND    SB.CNTR_NO = A.CNTR_NO) DCGO_CNT
,      A.CRE_USR_ID
,      A.UPD_USR_ID
,	   BK.POL_CD
,      A.ONE_WY_FREE_FLG
,      A.MF_CFM_FLG
,      A.LBP_FLG
,	   A.VGM_WGT 
,      A.VGM_WGT_UT_CD
,	   TO_CHAR(A.VGM_VRFY_DT,'YYYY-MM-DD') VGM_VRFY_DT
,	   TO_CHAR(A.VGM_DTMN_DT,'YYYY-MM-DD') VGM_DTMN_DT
,      A.VGM_VRFY_SIG_CTNT
,      A.VGM_MZD_TP_CD
FROM   BKG_CONTAINER A, BKG_BOOKING BK, BKG1
WHERE  A.BKG_NO = @[bkg_no]
  AND  A.BKG_NO = BK.BKG_NO
  AND  A.BKG_NO = BKG1.BKG_NO(+)
  AND  A.CNTR_NO = BKG1.CNTR_NO(+)
ORDER BY CNTR_DP_SEQ, CNTR_NO
#end			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
