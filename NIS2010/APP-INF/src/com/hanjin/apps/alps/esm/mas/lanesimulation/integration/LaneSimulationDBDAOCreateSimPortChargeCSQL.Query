<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="LaneSimulationDBDAOCreateSimPortChargeCSQL">
			<desc><![CDATA[port charge 입력]]></desc>
			<sql><![CDATA[
INSERT INTO MAS_SIM_PORT_CHG (
     SIM_DT
    ,SIM_NO
    ,TML_CD
    ,VSL_CLSS_CAPA
    ,PORT_TRF_AMT
    ,CNL_FEE_AMT
    ,CRE_USR_ID
    ,CRE_DT
    ,UPD_USR_ID
    ,UPD_DT )
SELECT SIM_DT
		,SIM_NO
		,TML_CD
		,VSL_CLSS_CAPA
		,SUM(PORT_TRF_AMT1) AS PORT_TRF_AMT
		,SUM(CNL_FEE_AMT1) AS CNL_FEE_AMT
		,@[usr_id]
		,SYSDATE
		,@[usr_id]
		,SYSDATE
	FROM (
	   SELECT C1.SIM_DT ,
			  C1.SIM_NO ,
			  C1.TML_CD ,
			  C1.PORT_SEQ ,
			  C2.TML_CD TML_CD2 ,
			  C1.VSL_CLSS_CAPA ,
			  C2.PORT_USD_AMT PORT_TRF_AMT1 ,
			  C2.CNL_USD_AMT CNL_FEE_AMT1 ,
			  C2.COST_YRMON ,
			  -- PORT_CLSS_CAPA가 없을 경우 가장 비슷한 사이즈의 비용을 가져오도록 함
  
			  ABS(TO_NUMBER(C1.VSL_CLSS_CAPA)-TO_NUMBER(C1.VSL_CLSS_CAPA)) AA ,
			  ROW_NUMBER() OVER(PARTITION BY C1.SIM_DT, C1.SIM_NO, C1.PORT_SEQ, C1.VSL_CLSS_CAPA, SUBSTR(C2.TML_CD , 1, 5)
			    ORDER BY C2.COST_YRMON DESC , ABS(TO_NUMBER(C1.VSL_CLSS_CAPA)-TO_NUMBER(C2.VSL_CLSS_CAPA)) ASC , C2.VSL_CLSS_CAPA DESC) NUM
		FROM (
		   SELECT B1.SIM_DT ,
			      B1.SIM_NO ,
			      B1.TML_CD ,
			      B1.PORT_SEQ ,
			      B2.VSL_CLSS_CAPA ,
			      B3.SLAN_CD ,
			      B3.EXTD_LANE_FLG
		    FROM (
		       SELECT DISTINCT SIM_DT ,
			          SIM_NO ,
			          TML_CD ,
			          MIN(PORT_SEQ) OVER (PARTITION BY TML_CD) PORT_SEQ
			     FROM MAS_SIM_TML_INFO
		        WHERE SIM_DT = @[f_sim_dt]
        		  AND SIM_NO = @[f_sim_no] ) b1 ,
		      (
		        SELECT DISTINCT A1.VSL_CLSS_CAPA
		        FROM MAS_SIM_VSL_SET_INFO A1,
		          (
        	       SELECT VSL_CD,
			              VSL_CLSS_CAPA
		             FROM MAS_VSL_RGST
		            WHERE VSL_TP_CD = 'C'
        		      AND VOP_CD = 'SML'
		              AND NVL(DELT_FLG, 'N') = 'N'
		            UNION ALL
        	      SELECT VSL_CD,
			             VSL_CLSS_CAPA
		            FROM MAS_SIM_VSL_RGST
         		   WHERE VOP_CD = 'SML' ) A2
			     WHERE A1.SIM_DT = @[f_sim_dt]
		           AND A1.SIM_NO = @[f_sim_no]
         		   AND A1.SIM_DIV_CD = '1'
		           AND A1.VOP_CD = 'SML'
         		   AND A1.VSL_CD = A2.VSL_CD ) B2 ,
			      (
			       SELECT SLAN_CD ,
				          EXTD_LANE_FLG
				     FROM MAS_SIM_INFO
			        WHERE SIM_DT = @[f_sim_dt]
			          AND SIM_NO = @[f_sim_no] ) b3 ) c1 ,
				  	MAS_PORT_TRF C2
					WHERE 1=1
					  AND C1.TML_CD = C2.TML_CD(+)
					  AND C2.SLAN_CD(+) = @[f_slan_cd]
					  AND C2.SLAN_CD(+) = DECODE(C1.EXTD_LANE_FLG, 'Y', C1.SLAN_CD, 'N', C2.SLAN_CD(+)) ) D1
					WHERE NUM = 1
			GROUP BY SIM_DT , SIM_NO , TML_CD , VSL_CLSS_CAPA , PORT_SEQ
		ORDER BY SIM_DT, SIM_NO, VSL_CLSS_CAPA, PORT_SEQ			]]></sql>
			<params>
				<param name="usr_id" type="12" value="" out="N"/>
				<param name="f_sim_dt" type="12" value="" out="N"/>
				<param name="f_sim_no" type="12" value="" out="N"/>
				<param name="f_slan_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
