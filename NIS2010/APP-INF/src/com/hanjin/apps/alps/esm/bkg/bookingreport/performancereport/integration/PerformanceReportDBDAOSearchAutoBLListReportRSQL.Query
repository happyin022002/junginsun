<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="PerformanceReportDBDAOSearchAutoBLListReportRSQL">
			<desc><![CDATA[2.Non Autorating B/L List]]></desc>
			<sql><![CDATA[
SELECT    DENSE_RANK() OVER(PARTITION BY T.AA ORDER BY T.BKG_NO)  ROW_NUM
,		T.BKG_NO
,       T.RT_SEQ
,       T.SVC_SCP_CD
,       T.SC_NO
,       T.BKG_OFC_CD
,       T.REGION
,       T.CMDT_CD
,       T.CMDT_NM
,       T.RATER
,       T.RATER_OFC
,       T.CHG_CD
,       T.RAT_UT_CD
,		T.AUTO_RAT_CD
,       T.AUTO_RAT_FLG
,       T.AUTO_DEL_FLG
FROM  (
            SELECT '1' AA
			,		BK.BKG_NO
            ,      RT.RT_SEQ
            ,      BK.SVC_SCP_CD
            ,      BK.SC_NO
            ,      BK.BKG_OFC_CD
            ,      OL.REGION
            ,      BK.CMDT_CD
            ,      (SELECT BL.CSTMS_DESC FROM BKG_BL_DOC BL WHERE BL.BKG_NO = BK.BKG_NO) CMDT_NM  
            ,      RT.CRE_USR_ID RATER
            ,      (SELECT CU.OFC_CD FROM COM_USER CU WHERE CU.USR_ID = RT.CRE_USR_ID) RATER_OFC
            ,       RT.CHG_CD
            ,       RT.RAT_UT_CD
			,       RT.AUTO_RAT_CD
            ,       MC.AUTO_RAT_FLG
            ,       'N' AUTO_DEL_FLG
            FROM   BKG_BOOKING     BK
            ,      BKG_OFC_LVL_V   OL
            ,      BKG_CHG_RT      RT
            ,      MDM_CHARGE      MC
            WHERE  1 = 1
            AND    BK.BKG_STS_CD <> 'X'
#if (${fr_dt} != '') 
AND    BK.BKG_CRE_DT >= TO_DATE(@[fr_dt], 'yyyy-mm-dd') 
#end
#if (${to_dt} != '') 
AND    BK.BKG_CRE_DT <  TO_DATE(@[to_dt], 'yyyy-mm-dd') + 0.99999 
#end
            AND    OL.OFC_CD   = BK.BKG_OFC_CD
            AND    BK.BKG_NO   = RT.BKG_NO
            AND    RT.CHG_CD = MC.CHG_CD
            AND    MC.DELT_FLG <> 'Y'
#if (${sel_ofc_cd} != '') 
AND   BK.BKG_OFC_CD = @[sel_ofc_cd] 
#end
#if (${sel_scp_cd} != '') 
AND   BK.SVC_SCP_CD = @[sel_scp_cd] 
#end
#if (${chg_cd} != '') 
			AND	   RT.CHG_CD =  @[chg_cd]	
#end

            UNION
            SELECT '1' AA
			,		BK.BKG_NO
            ,      HIS.RT_SEQ
            ,      BK.SVC_SCP_CD
            ,      BK.SC_NO
            ,      BK.BKG_OFC_CD
            ,      OL.REGION
            ,      BK.CMDT_CD
            ,      (SELECT BL.CSTMS_DESC FROM BKG_BL_DOC BL WHERE BL.BKG_NO = BK.BKG_NO) CMDT_NM  
            ,      HIS.CRE_USR_ID RATER
            ,      (SELECT CU.OFC_CD FROM COM_USER CU WHERE CU.USR_ID = HIS.CRE_USR_ID) RATER_OFC
            ,       HIS.CHG_CD
            ,       HIS.RAT_UT_CD
			,       HIS.AUTO_RAT_CD
            ,       MC.AUTO_RAT_FLG
            ,       'Y' AUTO_DEL_FLG
            FROM   BKG_BOOKING     BK
		    ,      BKG_CHG_RT      RT
            ,      BKG_OFC_LVL_V   OL
            ,      MDM_CHARGE      MC
            ,      BKG_AUTO_RT_HIS HIS
            WHERE  1 = 1
            AND    BK.BKG_STS_CD <> 'X'
#if (${fr_dt} != '') 
AND    BK.BKG_CRE_DT >= TO_DATE(@[fr_dt], 'yyyy-mm-dd') 
#end
#if (${to_dt} != '') 
AND    BK.BKG_CRE_DT <  TO_DATE(@[to_dt], 'yyyy-mm-dd') + 0.99999 
#end
            AND    OL.OFC_CD   = BK.BKG_OFC_CD
			AND    RT.BKG_NO   = BK.BKG_NO
            AND    BK.BKG_NO   = HIS.BKG_NO
            AND    HIS.CHG_CD = MC.CHG_CD
            AND    MC.DELT_FLG <> 'Y'
#if (${sel_ofc_cd} != '') 
AND   BK.BKG_OFC_CD = @[sel_ofc_cd] 
#end
#if (${sel_scp_cd} != '') 
AND   BK.SVC_SCP_CD = @[sel_scp_cd] 
#end
#if (${chg_cd} != '') 
			AND	   HIS.CHG_CD =  @[chg_cd]	
#end
            AND   NOT EXISTS (SELECT 1 FROM BKG_CHG_RT RT WHERE RT.BKG_NO = HIS.BKG_NO AND RT.RT_SEQ = HIS.RT_SEQ)
)  T    
WHERE 1=1

#if (${auto_rat_flg} == 'Y') 
AND	  (T.AUTO_DEL_FLG = 'N' AND T.AUTO_RAT_CD = 'A')
AND   NOT EXISTS (SELECT 1 FROM BKG_CHG_RT RT 
                  WHERE RT.BKG_NO = T.BKG_NO 
                  AND   RT.AUTO_RAT_CD <> 'A'
                  UNION
                  SELECT 1
                  FROM   MDM_CHARGE      MC
                  ,      BKG_AUTO_RT_HIS HIS
                  WHERE  1 = 1
                  AND    HIS.CHG_CD = MC.CHG_CD
                  AND    MC.DELT_FLG <> 'Y'
                  AND    HIS.BKG_NO = T.BKG_NO
                  AND    NOT EXISTS (SELECT 1 FROM BKG_CHG_RT RT WHERE RT.BKG_NO = HIS.BKG_NO AND RT.RT_SEQ = HIS.RT_SEQ)
                  )    	
#elseif (${auto_rat_flg} == 'N') 
AND   (T.AUTO_DEL_FLG = 'Y' OR  T.AUTO_RAT_CD <> 'A') AND T.AUTO_RAT_FLG  = 'Y'
#end
  
ORDER BY    T.BKG_NO,T.RT_SEQ			]]></sql>
			<params>
				<param name="fr_dt" type="12" value="" out="N"/>
				<param name="to_dt" type="12" value="" out="N"/>
				<param name="sel_ofc_cd" type="12" value="" out="N"/>
				<param name="sel_scp_cd" type="12" value="" out="N"/>
				<param name="chg_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
