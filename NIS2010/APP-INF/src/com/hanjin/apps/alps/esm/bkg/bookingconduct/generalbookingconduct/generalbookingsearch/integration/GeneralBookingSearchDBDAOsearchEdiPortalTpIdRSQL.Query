<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="GeneralBookingSearchDBDAOsearchEdiPortalTpIdRSQL">
			<desc><![CDATA[Portal EDI를 위한 수신 EDI ID를 조회함]]></desc>
			<sql><![CDATA[
SELECT DISTINCT GROUP_EDI_ID GROUP_ID
	, EDI_RECEIVE_ID RCV_ID
  FROM 
    (SELECT BKG_NO
        , MIN(RANK) RANK
        , GROUP_EDI_ID
        , EDI_RECEIVE_ID
        , REF_CODE
      FROM 
        (SELECT  BK.BKG_NO
                , MIN(TP_RANK.RANK) RANK
                , EDI_BY_CUST.GROUP_EDI_ID
                , EDI_BY_CUST.EDI_RECEIVE_ID
                , EDI_BY_CUST.CNT_CD||EDI_BY_CUST.CUST_SEQ AS REF_CODE
          FROM BKG_CUSTOMER CUST
                , BKG_BOOKING BK
                , (SELECT GRP.ESVC_GRP_CD           GROUP_EDI_ID
                         , GRP.CUST_TRD_PRNR_ID     EDI_RECEIVE_ID
                         , GRP_CUST.CNT_CD   
                         , GRP_CUST.CUST_SEQ
                         , GRP_CUST.BKG_CUST_TP_DESC 
                   FROM BKG_EDI_GRP_CUST GRP_CUST, BKG_EDI_GRP GRP
                  WHERE GRP.ESVC_GRP_CD         = GRP_CUST.ESVC_GRP_CD
                    AND GRP.CO_CD               = GRP_CUST.CO_CD
                    AND GRP.CO_CD               = 'H'
                    AND GRP.ESVC_GRP_DELT_FLG   = 'N'
                    AND GRP_CUST.CNT_CD         > ' '
                    AND GRP_CUST.CUST_SEQ       > 0
                    AND GRP_CUST.DELT_FLG       = 'N'
                    AND GRP_CUST.BKG_CFM_FLG    = 'Y'
                    ) EDI_BY_CUST               
                , (SELECT 'S' RCV_TP, '1SH' RANK FROM DUAL 
                   UNION SELECT 'C' RCV_TP, '2CN' RANK FROM DUAL 
                   UNION SELECT 'N' RCV_TP, '3NF' RANK FROM DUAL 
                   UNION SELECT 'F' RCV_TP, '4FF' RANK FROM DUAL 
                   UNION SELECT 'A' RCV_TP, '5AN' RANK FROM DUAL 
                   UNION SELECT 'E' RCV_TP, '6EX' RANK FROM DUAL) TP_RANK
         WHERE EDI_BY_CUST.CNT_CD   = CUST.CUST_CNT_CD 
           AND EDI_BY_CUST.CUST_SEQ = CUST.CUST_SEQ
           AND BK.BKG_NO            = CUST.BKG_NO
           AND CUST.BKG_CUST_TP_CD  = TP_RANK.RCV_TP
           AND BK.BKG_NO = @[bkg_no]
           AND DECODE(BKG_CUST_TP_DESC,'ALL','ALL',CUST.BKG_CUST_TP_CD)
                               IN (SELECT COLUMN_VALUE
                                     FROM TABLE(BKG_SPLIT_FNC(BKG_CUST_TP_DESC,',')))
         GROUP BY BK.BKG_NO
                , EDI_BY_CUST.GROUP_EDI_ID
                , EDI_BY_CUST.EDI_RECEIVE_ID
                , EDI_BY_CUST.CNT_CD||EDI_BY_CUST.CUST_SEQ
         UNION
          SELECT BK.BKG_NO
                , '7SC' RANK
                , EDI_BY_SC.GROUP_EDI_ID
                , EDI_BY_SC.EDI_RECEIVE_ID
                , EDI_BY_SC.SC_NO AS REF_CODE
          FROM BKG_BOOKING BK
                , (SELECT  GRP.ESVC_GRP_CD           GROUP_EDI_ID
                         , GRP.CUST_TRD_PRNR_ID     EDI_RECEIVE_ID
                         , GRP_CUST.SC_NO
                         , GRP_CUST.BKG_CTRT_TP_CD
                   FROM BKG_EDI_GRP GRP, BKG_EDI_GRP_CUST GRP_CUST
                  WHERE GRP.ESVC_GRP_CD         = GRP_CUST.ESVC_GRP_CD
                    AND GRP.CO_CD               = GRP_CUST.CO_CD      
                    AND GRP.CO_CD               = 'H'
                    AND GRP.ESVC_GRP_DELT_FLG   = 'N'
                    AND GRP_CUST.SC_NO          > ' '              
                    AND GRP_CUST.DELT_FLG       = 'N'
                    AND GRP_CUST.BKG_CFM_FLG    = 'Y'
                    ) EDI_BY_SC
         WHERE EDI_BY_SC.SC_NO  = DECODE(EDI_BY_SC.BKG_CTRT_TP_CD, '1', BK.SC_NO, '2', BK.RFA_NO)
           AND BK.BKG_NO = @[bkg_no]
           )
     GROUP BY BKG_NO
        , GROUP_EDI_ID
        , EDI_RECEIVE_ID
        , REF_CODE) MST, BKG_BOOKING BK
  WHERE BK.BKG_NO = MST.BKG_NO 
	AND ((MST.EDI_RECEIVE_ID IN ('INTTRA', 'INTTRANG2', 'GTNEXUS', 'CARGOSMART', 'PKEXM010')	
          AND EXISTS (SELECT 'X'
                            FROM BKG_HIS_MST HIS, BKG_HIS_DTL DTL
                           WHERE HIS.BKG_NO  = BK.BKG_NO
                             AND DTL.BKG_NO  = BK.BKG_NO
                             AND HIS.HIS_SEQ = DTL.HIS_SEQ
                             AND HIS.HIS_SEQ = (SELECT MAX(A.HIS_SEQ) 
                                                  FROM BKG_HIS_MST A, BKG_HIS_DTL B 
                                                 WHERE A.BKG_NO = HIS.BKG_NO 
                                                   AND A.BKG_NO   = B.BKG_NO 
                                                   AND A.HIS_SEQ  = B.HIS_SEQ)
                             AND (DTL.HIS_CATE_NM IN ('BKG QTY','Booking Cancel.','Container No.')
		      		     	      OR DTL.CRNT_CTNT LIKE 'Attach Container:%'
                                  OR DTL.CRNT_CTNT LIKE 'Combined to target bkg no:%'
                                  ) 
                             AND ROWNUM = 1)
          AND EXISTS (SELECT 'X' 
                      FROM BKG_XTER_RQST_MST BXRM 
                      WHERE BXRM.BKG_NO = @[bkg_no]
                      AND BXRM.DOC_TP_CD = 'B'
                      AND BXRM.BKG_UPLD_STS_CD = 'F'
                      AND BXRM.XTER_RQST_VIA_CD <> 'WEB')
          )  
           OR (MST.EDI_RECEIVE_ID LIKE ('IKEA%')	
                AND EXISTS (SELECT 'X'
                                  FROM BKG_HIS_MST HIS, BKG_HIS_DTL DTL
                                 WHERE HIS.BKG_NO  = BK.BKG_NO
                                   AND DTL.BKG_NO  = BK.BKG_NO
                                   AND HIS.HIS_SEQ = DTL.HIS_SEQ
                                   AND HIS.HIS_SEQ = (SELECT MAX(A.HIS_SEQ) 
                                                        FROM BKG_HIS_MST A, BKG_HIS_DTL B 
                                                       WHERE A.BKG_NO = HIS.BKG_NO 
                                                         AND A.BKG_NO   = B.BKG_NO 
                                                         AND A.HIS_SEQ  = B.HIS_SEQ)
                                   AND DTL.HIS_CATE_NM = 'Booking Cancel.' 
                                   AND ROWNUM = 1
               )
          )
        )			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
