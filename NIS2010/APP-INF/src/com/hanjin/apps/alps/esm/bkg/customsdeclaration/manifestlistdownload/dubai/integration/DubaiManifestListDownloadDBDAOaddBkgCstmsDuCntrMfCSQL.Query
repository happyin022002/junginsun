<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="DubaiManifestListDownloadDBDAOaddBkgCstmsDuCntrMfCSQL">
			<desc><![CDATA[addBkgCstmsDuCntrMf]]></desc>
			<sql><![CDATA[
INSERT  
  INTO BKG_CSTMS_DU_CNTR_MF
      (
       BL_NO
      ,POD_CD
      ,CNTR_NO
      ,CNTR_MF_SEQ
      ,DU_CNTR_SER_NO
      ,CNTR_MF_MK_DESC
      ,CNTR_MF_GDS_DESC
      ,CMDT_HS_CD
      ,PCK_QTY
      ,PCK_TP_DESC
      ,DU_PCK_TP_CD
      ,PLT_QTY
      ,CNTR_MF_WGT
      ,MEAS_QTY
      ,DCGO_FLG
      ,IMDG_UN_NO
      ,IMDG_CLSS_CD
      ,FLSH_PNT_CDO_TEMP
      ,DCGO_TEMP_UT_CD
      ,DG_STO_REQ_FLG
      ,RFRT_REQ_FLG
      ,MIN_TEMP
      ,MAX_TEMP
      ,CGO_TEMP_UT_CD
      ,CRE_USR_ID
      ,UPD_USR_ID
      )
      (
       SELECT B.BL_NO
             ,B.POD_CD
             ,C.CNTR_NO
             ,1 AS CNTR_MF_SEQ
             ,ROW_NUMBER() OVER(PARTITION BY B.BL_NO||B.POD_CD ORDER BY B.BL_NO, B.POD_CD, C.CNTR_NO) AS DU_CNTR_SER_NO
             ,B.CNTR_MF_MK_DESC
             ,B.PCK_CMDT_DESC || B.CNTR_CMDT_DESC || B.CMDT_DESC || CHR(13)||CHR(10)
             ,B.CMDT_CD AS CMDT_HS_CD
             ,C.PCK_QTY
             ,P.ATTR_CTNT2
             ,P.ATTR_CTNT1
             ,''
             ,C.CNTR_WGT
             ,C.MEAS_QTY
             ,C.DCGO_FLG
             ,DECODE(C.DCGO_FLG, 'Y', DG.IMDG_UN_NO) AS IMDG_UN_NO
             ,DECODE(C.DCGO_FLG, 'Y', DG.IMDG_CLSS_CD) AS IMDG_CLSS_CD
             ,'' FLSH_PNT_CDO_TEMP
             ,DECODE(C.DCGO_FLG, 'Y', 'C') AS DCGO_TEMP_UT_CD
             ,DECODE(C.RC_FLG, 'Y', 'Y') AS DG_STO_REQ_FLG
             ,C.RC_FLG
             ,DECODE(C.RC_FLG, 'Y', NVL(RF.CDO_TEMP, RF.FDO_TEMP)) AS MIN_TEMP
             ,DECODE(C.RC_FLG, 'Y', NVL(RF.CDO_TEMP, RF.FDO_TEMP)) AS MAX_TEMP
             ,DECODE(C.RC_FLG, 'Y', DECODE(RF.CDO_TEMP, NULL, 'F', 'C')) AS CGO_TEMP_UT_CD
             ,@[upd_usr_id]
             ,@[upd_usr_id]
         FROM 
              (
                SELECT B.BKG_NO, B.BL_NO, V.POD_CD, B.CMDT_CD
                      ,DECODE(D.PCK_CMDT_DESC, NULL, '', D.PCK_CMDT_DESC || CHR(13)||CHR(10)) AS PCK_CMDT_DESC 
                      ,DECODE(D.CNTR_CMDT_DESC, NULL, '', D.CNTR_CMDT_DESC || CHR(13)||CHR(10)) AS CNTR_CMDT_DESC
                      ,DECODE(B.DE_TERM_CD, 'S', SUBSTR(M.MK_DESC, 1, 200), 'NIL') AS CNTR_MF_MK_DESC
                      ,CASE WHEN NVL(INSTR(M.CMDT_DESC, CHR(13)||CHR(10), 1, 1), 0) = 0 THEN M.CMDT_DESC
                            ELSE SUBSTR(M.CMDT_DESC, 1, INSTR(M.CMDT_DESC, CHR(13)||CHR(10), 1, 1)-1) 
                       END CMDT_DESC
                  FROM BKG_BOOKING B
                      ,BKG_BL_DOC D
                      ,BKG_VVD V
                      ,BKG_BL_MK_DESC M
                 WHERE B.BKG_NO = V.BKG_NO
                   AND B.BKG_NO = D.BKG_NO
                   AND B.BKG_NO = M.BKG_NO(+)
                   AND (M.MK_SEQ IS NULL OR M.MK_SEQ = (SELECT MIN(MK_SEQ) FROM BKG_BL_MK_DESC SM WHERE SM.BKG_NO = B.BKG_NO))
                   AND B.BKG_STS_CD IN ('F','W')
                   AND B.BL_NO IS NOT NULL
               #if (${bl_no} != '') 
                   AND B.BL_NO = @[bl_no]
                   AND V.POD_CD LIKE 'AE%'
               #end
               #if (${vvd} != '') 
                   AND V.VSL_CD = SUBSTR(@[vvd],1,4)
                   AND V.SKD_VOY_NO = SUBSTR(@[vvd],5,4)
                   AND V.SKD_DIR_CD = SUBSTR(@[vvd],9,1)
               #end
               #if (${pol_cd} != '') 
                   AND V.POL_CD = @[pol_cd]
               #end
               #if (${pod_cd} != '') 
                   AND V.POD_CD = @[pod_cd]
               #end
               #if (${cgo_type} == 'F') 
                   AND B.BKG_CGO_TP_CD = @[cgo_type]
               #elseif (${cgo_type} == 'M') 
                   AND B.BKG_CGO_TP_CD IN ('R', 'P')
               #end
              ) B
             ,BKG_CONTAINER C
             ,BKG_CSTMS_CD_CONV_CTNT P
             ,BKG_DG_CGO DG
             ,BKG_RF_CGO RF
        WHERE B.BKG_NO = C.BKG_NO
          AND P.CNT_CD(+) = 'AE'
          AND P.CSTMS_DIV_ID(+) = 'DUBAI_PCK_CD'
          AND P.ATTR_CTNT3(+) = C.PCK_TP_CD
          AND (P.CSTMS_DIV_ID_SEQ IS NULL OR 
               P.CSTMS_DIV_ID_SEQ = (SELECT MAX(CSTMS_DIV_ID_SEQ) 
                                       FROM BKG_CSTMS_CD_CONV_CTNT 
                                      WHERE CNT_CD = 'AE' 
                                        AND CSTMS_DIV_ID = 'DUBAI_PCK_CD'
                                        AND ATTR_CTNT3 = C.PCK_TP_CD
                                     )
              )
          AND C.BKG_NO = DG.BKG_NO(+)
          AND C.CNTR_NO = DG.CNTR_NO(+)
          AND (DG.DCGO_SEQ IS NULL OR 
               DG.DCGO_SEQ = (SELECT MAX(DCGO_SEQ) 
                                FROM BKG_DG_CGO
                               WHERE BKG_NO = C.BKG_NO
                                 AND CNTR_NO = C.CNTR_NO
                             )
               )
          AND C.BKG_NO = RF.BKG_NO(+)
          AND C.CNTR_NO = RF.CNTR_NO(+)
          AND (RF.RC_SEQ IS NULL OR 
               RF.RC_SEQ = (SELECT MAX(RC_SEQ) 
                              FROM BKG_RF_CGO
                             WHERE BKG_NO = C.BKG_NO
                               AND CNTR_NO = C.CNTR_NO
                           )
              )
      )			]]></sql>
			<params>
				<param name="upd_usr_id" type="12" value="" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="cgo_type" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
