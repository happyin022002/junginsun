<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TCharterIOInvoiceDAOSearchOffhireCnfmListRSQL">
			<desc><![CDATA[TCharterIOInvoiceDAOSearchOffhireCnfmListRSQL]]></desc>
			<sql><![CDATA[
SELECT
 AA.* ,
 TO_CHAR(VNOR_OFFH_FM_DT2,'YYYY-MM-DD')  AS VNOR_OFFH_FM_DT
 ,TO_CHAR(VNOR_OFFH_TO_DT2,'YYYY-MM-DD')  AS VNOR_OFFH_TO_DT
,D.INTG_CD_VAL_DP_DESC AS vnor_offh_ind
FROM
(
SELECT O.VSL_CD,                        --VESSEL
       O.SKD_VOY_NO,
       O.SKD_DIR_CD,				    --VESSEL
       O.VNOR_VSL_STS_CD,       		--TYPE
       O.VNOR_FM_PORT_CD  			    --PLACE
       ,O.VNOR_OFFH_FM_DT AS VNOR_OFFH_FM_DT2
       ,TO_CHAR(O.VNOR_OFFH_FM_DT,'HH24:MI') AS VNOR_OFFH_FM_DT_HM
       ,O.VNOR_OFFH_TO_DT  AS VNOR_OFFH_TO_DT2
       ,TO_CHAR(O.VNOR_OFFH_TO_DT,'HH24:MI') AS VNOR_OFFH_TO_DT_HM,
       F.VNOR_ITM_CD,     -- ITEM
       F.VNOR_ITM_OFC_CD,     -- OFC
       F.VNOR_ITM_UT_CD,      -- UOM
       F.VNOR_ITM_VAL,         -- VALUE
       F.VNOR_ITM_FLET_ADD_CD,   -- KIND  
       F.ATCH_FILE_OP_KNT OPF_CNT,     -- OPF 파일 건수
       F.ATCH_FILE_FLET_KNT FMS_CNT,     -- FMS 파일 건수
       CASE WHEN C.APRO_FLG = 'Y' THEN 'A'
            WHEN C.APRO_FLG = 'N' THEN 'N'
            WHEN I.VNOR_SEQ IS NOT NULL THEN 'S'
            WHEN F.VNOR_ITM_PROC_CD = 'P' THEN 'C'
            ELSE NULL
       END vnor_offh_ind2,    -- IND
       F.VNOR_ITM_RMK,            -- REMARK
	   F.VNOR_ITM_FLET_RMK,			-- Audit Comment
       (SELECT U.USR_NM FROM COM_USER U WHERE U.USR_ID = F.CRE_USR_ID) upd_usr_id,  -- USER ID
       TO_CHAR(F.UPD_DT, 'yyyy-mm-dd hh24:mi:ss') AS UPD_DT, 
       F.ATCH_FILE_OP_KNT
      ,(SELECT COUNT(1) FROM FMS_ATCH_FILE WHERE ATCH_FILE_LNK_ID = F.ATCH_FILE_FLET_LNK_ID ) AS ATCH_FILE_FLET_KNT
      ,F.ATCH_FILE_OP_LNK_ID
	  ,F.ATCH_FILE_FLET_LNK_ID 
	  ,F.VNOR_SEQ 
      ,F.VNOR_ITM_SEQ      
	  ,O.VNOR_OFFH_KND_CD
      ,I.FLET_CTRT_NO
      ,I.INV_SEQ
FROM FMS_VNOR O, FMS_VNOR_ITM F, FMS_INV_DTL I, FMS_CONSULTATION C
WHERE O.VSL_CD = F.VSL_CD
  AND O.VNOR_SEQ = F.VNOR_SEQ  
  AND F.VNOR_ITM_PROC_CD = 'C'
  AND F.VSL_CD       = I.VSL_CD(+)
  AND F.VNOR_SEQ     = I.VNOR_SEQ(+)
  AND F.VNOR_ITM_SEQ = I.VNOR_ITM_SEQ(+)
  AND I.SLP_TP_CD = C.SLP_TP_CD(+)
  AND I.SLP_FUNC_CD = C.SLP_FUNC_CD(+)
  AND I.SLP_OFC_CD = C.SLP_OFC_CD(+)
  AND I.SLP_ISS_DT = C.SLP_ISS_DT(+)
  AND I.SLP_SER_NO = C.SLP_SER_NO(+)  
UNION ALL
SELECT O.VSL_CD,            -- VESSEL
       O.SKD_VOY_NO,
       O.SKD_DIR_CD,  		-- VESSEL
       O.VNOR_VSL_STS_CD,   -- TYPE
       O.VNOR_FM_PORT_CD  	-- PLACE
       ,O.VNOR_OFFH_FM_DT AS VNOR_OFFH_FM_DT2
       ,TO_CHAR(O.VNOR_OFFH_FM_DT,'HH24:MI') AS VNOR_OFFH_FM_DT_HM
       ,O.VNOR_OFFH_TO_DT  AS VNOR_OFFH_TO_DT2
       ,TO_CHAR(O.VNOR_OFFH_TO_DT,'HH24:MI') AS VNOR_OFFH_TO_DT_HM,
       F.VNOR_ITM_CD,     -- ITEM
       F.VNOR_ITM_OFC_CD,     -- OFC
       F.VNOR_ITM_UT_CD,      -- UOM
       F.VNOR_ITM_VAL,         -- VALUE
       F.VNOR_ITM_FLET_ADD_CD,   -- KIND
       F.ATCH_FILE_OP_KNT OPF_CNT,     -- OPF 파일 건수
       F.ATCH_FILE_FLET_KNT FMS_CNT,     -- FMS 파일 건수
       CASE WHEN C.APRO_FLG = 'Y' THEN 'A'
            WHEN C.APRO_FLG = 'N' THEN 'N'
            WHEN I.VNOR_SEQ IS NOT NULL THEN 'S'
            WHEN F.VNOR_ITM_PROC_CD = 'P' THEN 'C'
            ELSE NULL
       END vnor_offh_ind2,    -- IND
       F.VNOR_ITM_RMK,            -- REMARK
	   F.VNOR_ITM_FLET_RMK,			-- Audit Comment
       (SELECT U.USR_NM FROM COM_USER U WHERE U.USR_ID = F.CRE_USR_ID) upd_usr_id,  -- USER ID
       TO_CHAR(F.UPD_DT, 'yyyy-mm-dd hh24:mi:ss') AS UPD_DT, 
       F.ATCH_FILE_OP_KNT
      ,(SELECT COUNT(1) FROM FMS_ATCH_FILE WHERE ATCH_FILE_LNK_ID = F.ATCH_FILE_FLET_LNK_ID ) AS ATCH_FILE_FLET_KNT    
      ,F.ATCH_FILE_OP_LNK_ID
	  ,F.ATCH_FILE_FLET_LNK_ID 
	  ,F.VNOR_SEQ 
      ,F.VNOR_ITM_SEQ      
	  ,O.VNOR_OFFH_KND_CD
      ,I.FLET_CTRT_NO
      ,I.INV_SEQ
FROM FMS_VNOR O, FMS_VNOR_ITM F, FMS_INV_DTL I, FMS_CONSULTATION C
WHERE O.VSL_CD = F.VSL_CD
  AND O.VNOR_SEQ = F.VNOR_SEQ  
  AND F.VNOR_ITM_PROC_CD = 'P'
  AND F.VSL_CD       = I.VSL_CD(+)
  AND F.VNOR_SEQ     = I.VNOR_SEQ(+)
  AND F.VNOR_ITM_SEQ = I.VNOR_ITM_SEQ(+)
  AND I.SLP_TP_CD = C.SLP_TP_CD(+)
  AND I.SLP_FUNC_CD = C.SLP_FUNC_CD(+)
  AND I.SLP_OFC_CD = C.SLP_OFC_CD(+)
  AND I.SLP_ISS_DT = C.SLP_ISS_DT(+)
  AND I.SLP_SER_NO = C.SLP_SER_NO(+)
) AA, (SELECT * FROM COM_INTG_CD_DTL WHERE INTG_CD_ID = 'CD03391') D  
WHERE 1=1
AND AA.vnor_offh_ind2 = D.INTG_CD_VAL_CTNT(+)
#if (${vsl_cd} != '')
AND AA.VSL_CD = @[vsl_cd]
#end
#if (${vnor_offh_fm_dt} != '' && ${vnor_offh_to_dt} != '')
AND (    AA.VNOR_OFFH_FM_DT2 >= TO_DATE(REPLACE(@[vnor_offh_fm_dt],'-','') || '0000','YYYYMMDDHH24MI') 
	 AND AA.VNOR_OFFH_TO_DT2 <= TO_DATE(REPLACE(@[vnor_offh_to_dt],'-','') || '2359','YYYYMMDDHH24MI') 
	)
#end
#if (${vnor_offh_ind} != '')
AND AA.vnor_offh_ind2 = @[vnor_offh_ind]
#else
AND AA.vnor_offh_ind2 IN ('A', 'N', 'S', 'C')
#end

ORDER BY  AA.VNOR_OFFH_FM_DT2, AA.VSL_CD, AA.SKD_VOY_NO			]]></sql>
			<params>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="vnor_offh_fm_dt" type="12" value="" out="N"/>
				<param name="vnor_offh_to_dt" type="12" value="" out="N"/>
				<param name="vnor_offh_ind" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
