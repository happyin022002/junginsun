<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BookingUtilDBDAOSearchRfaAvailableRSQL">
			<desc><![CDATA[RFA의 가용성을 확인한다.]]></desc>
			<sql><![CDATA[
#if (${page_type}== 'ESM_BKG_0079_08')

	SELECT count(1) cnt        
	FROM PRI_RP_HDR HDR
	    , PRI_RP_MN MAIN
	    , (

		SELECT 
			CASE 
				WHEN LENGTH(RT_APLY_DT) > 0   THEN  
	#if (${application_date} != '')
		(select to_date(@[application_date]||'0000','yyyymmddhh24mi') from dual) 
	#else
		RT_APLY_DT
	#end
		#if (${application_date} != '')
					WHEN '1' > 0 THEN 		(select to_date(@[application_date]||'0000','yyyymmddhh24mi') from dual) 
		#end
				WHEN LENGTH(VPS_ETD_DT) > 0   THEN  VPS_ETD_DT
				WHEN LENGTH(BKG_CRE_DT) > 0   THEN  BKG_CRE_DT
				ELSE sysdate
			END	APPL_DT
		FROM 
			#if (${ca_flg}== 'Y')
			    BKG_BKG_HIS  BKG, 
					BKG_RT_HIS  RATE,  
			#else
			    BKG_BOOKING  BKG, 
			    BKG_RATE  RATE, 
			#end
		(
			SELECT 
		    BK.BKG_NO,
		    (SELECT VPS_ETD_DT 
		     FROM VSK_VSL_PORT_SKD S2
		     WHERE S2.VSL_CD = VVD.VSL_CD
		       AND S2.SKD_VOY_NO = VVD.SKD_VOY_NO
		       AND S2.SKD_DIR_CD = VVD.SKD_DIR_CD
		       AND S2.VPS_PORT_CD = VVD.POL_CD
		       AND S2.CLPT_IND_SEQ = VVD.POL_CLPT_IND_SEQ) VPS_ETD_DT,
		    VVD.VSL_CD,
		    VVD.SKD_VOY_NO,
		    VVD.SKD_DIR_CD,
		    VVD.POL_CD,
		    VVD.POL_CLPT_IND_SEQ 
		 FROM 
			#if (${ca_flg}== 'Y')
				BKG_BKG_HIS BK, BKG_VVD_HIS VVD
			#else
				BKG_BOOKING BK, BKG_VVD VVD
			#end
		WHERE BK.BKG_NO = VVD.BKG_NO
		AND BK.POL_CD = VVD.POL_CD
		AND BK.BKG_NO =@[bkg_no]
			#if (${ca_flg}== 'Y')
				AND BK.corr_no 		  = 'TMP0000001'
				AND VVD.corr_no 		  = 'TMP0000001'	
			#end 
	)  VVD
	WHERE	BKG.BKG_NO=RATE.BKG_NO
	AND BKG.BKG_NO=VVD.BKG_NO(+)
			#if (${ca_flg}== 'Y')
				AND BKG.corr_no 		  = 'TMP0000001'
				AND RATE.corr_no 		  = 'TMP0000001'	
			#end 
		AND BKG.BKG_NO=@[bkg_no]  	

) appl_dt
	WHERE HDR.PROP_NO = MAIN.PROP_NO
	and MAIN.eff_dt - 0.0001 < APPL_DT.APPL_DT
	AND MAIN.exp_dt + 0.9999 > APPL_DT.APPL_DT
	and main.prop_sts_cd = 'A'
	and hdr.rfa_no = @[rfa_no]

#else
SELECT (
	SELECT count(1) cnt        
	FROM PRI_RP_HDR HDR
	    , PRI_RP_MN MAIN
		, (select case  when appl_dt - ctrt_exp_dt between 0 and 7 then ctrt_exp_dt
                        else appl_dt
                  end appl_dt
           from
	         (select appl_dt,
                    (select max(ctrt_exp_dt)
                       from pri_rp_hdr h, pri_rp_mn m, pri_rp_dur d
                      where rfa_no = @[rfa_no]
                        and h.prop_no = m.prop_no
                        and m.prop_sts_cd = 'A'
                        and appl_dt > m.exp_dt   
                        and 'N' = NVL((select 'Y'
                                         from pri_rp_mn
                                        where prop_no = m.prop_no
                                          and appl_dt between eff_dt and exp_dt
                                          and PROP_STS_CD  = 'A'
                                          and rownum = 1
                                       ),'N')     -- 유효기간내에 Application Date가 없는 경우에만 데이터가 조회
                        and m.prop_no = d.prop_no
                        and m.amdt_seq = d.amdt_seq
                      ) ctrt_exp_dt
              from 
                 (
#if (${bkg_no} != '') 
                 select 1 rank, RT_APLY_DT appl_dt 
                  from bkg_rt_his r
                 where bkg_no = @[bkg_no]
			       and corr_no = 'TMP0000001'
                   and rt_aply_dt is not null
			    union all
			    select 2 rank, RT_APLY_DT appl_dt --rate applicable
                  from bkg_rate r
                 where bkg_no = @[bkg_no]
                   and rt_aply_dt is not null
                union all
                select 3 rank, skd.vps_etd_dt appl_dt --onboard date
                  from bkg_vvd_his vvd, vsk_vsl_port_skd skd, bkg_bkg_his bk
                 where bk.bkg_no          = @[bkg_no] 
			       and bk.corr_no 		  = 'TMP0000001'
			       and vvd.corr_no 		  = 'TMP0000001'
                   and bk.bkg_no          = vvd.bkg_no
                   and vvd.vsl_pre_pst_cd in ('S', 'T')
                   and vvd.pol_cd         = bk.pol_cd
                   and vvd.vsl_cd         = skd.vsl_cd
                   and vvd.skd_voy_no     = skd.skd_voy_no
                   and vvd.skd_dir_cd     = skd.skd_dir_cd
                   and vvd.pol_cd         = skd.vps_port_cd
                   and vvd.pol_CLPT_IND_SEQ = skd.CLPT_IND_SEQ
                union all
                select 4 rank, skd.vps_etd_dt appl_dt --onboard date
                  from bkg_vvd vvd, vsk_vsl_port_skd skd, bkg_booking bk
                 where bk.bkg_no          = @[bkg_no] 
                   and bk.bkg_no          = vvd.bkg_no
                   and vvd.vsl_pre_pst_cd in ('S', 'T')
                   and vvd.pol_cd         = bk.pol_cd
                   and vvd.vsl_cd         = skd.vsl_cd
                   and vvd.skd_voy_no     = skd.skd_voy_no
                   and vvd.skd_dir_cd     = skd.skd_dir_cd
                   and vvd.pol_cd         = skd.vps_port_cd
                   and vvd.pol_CLPT_IND_SEQ = skd.CLPT_IND_SEQ
                union all 
#end
                select 5 rank, sysdate appl_dt
                  from dual)   
                 where rownum = 1)) appl
	WHERE HDR.PROP_NO = MAIN.PROP_NO
	and MAIN.eff_dt - 0.0001 < APPL.APPL_DT
	AND MAIN.exp_dt + 0.9999 > APPL.APPL_DT
	and main.prop_sts_cd ='A'
	and hdr.rfa_no = @[rfa_no]			
)
+ 
(	SELECT COUNT(1) 
#if (${ca_flg}== 'Y')
	FROM  BKG_RT_HIS RT
	WHERE RT.BKG_NO = @[bkg_no] 
	AND   RT.CORR_NO = 'TMP0000001'
#else
	FROM  BKG_RATE RT
	WHERE RT.BKG_NO = @[bkg_no] 
#end
	AND   RT.RT_BL_TP_CD = 'B' 
	AND   @[rfa_no] LIKE 'COZ%'
)
CNT
FROM DUAL

#end			]]></sql>
			<params>
				<param name="application_date" type="12" value="" out="N"/>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="rfa_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
