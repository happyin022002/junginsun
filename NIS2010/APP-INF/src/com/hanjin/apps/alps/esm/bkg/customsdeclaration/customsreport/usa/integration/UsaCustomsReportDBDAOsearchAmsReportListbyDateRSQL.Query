<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="UsaCustomsReportDBDAOsearchAmsReportListbyDateRSQL">
			<desc><![CDATA[dwkim, 0041 Ams Report 조회. 생성 VO명 : UsaAmsReportListDetailVO]]></desc>
			<sql><![CDATA[
#if (${cntr_prt_flg} == '1' && ${general_or_rail} == 'RAILAMS')
SELECT TB.*   , '' AS SEQ, REPLACE(REPLACE(REPLACE(CUST.CUST_NM, CHR(13)||CHR(10),' '), CHR(13), ' '), CHR(10), ' ') AS CUST_NM
       ,CASE CSTMS_CLR_TP_CD WHEN 'L' THEN 'Local' WHEN 'I' THEN 'P/MIB' END CSTMS_CLR_TP_NM
       ,CASE WHEN (DEL_SCC = POD_SCC OR CHECKFLAG ='EQUALS') THEN 'Local cargo' WHEN DEL_SCC != POD_SCC THEN 'IPI' ELSE '' END CGO_DEST_TYPE_NM
  FROM ( 
        SELECT PBL.CNT_CD
              ,NVL(CR.DSPO_CD,' ') AS DSPO_CD
              ,BR.BL_NO AS MBL_NO
              ,PBL.BL_NO  AS AMS_FILE_NO
              ,DECODE(PBL.MF_NO, NULL, PBL.CSTMS_FILE_TP_CD, '0') FILER
              ,PBL.MF_STS_CD
              ,PBL.CSTMS_MF_TP_CD 
              ,PBL.POD_CD
              ,PBL.DEL_CD
              ,PBL.HUB_LOC_CD
              ,E.CNTR_NO
              --,(SELECT DECODE(CNTR_VOL_QTY, 1, 'N', 'Y') FROM BKG_CONTAINER	WHERE BKG_NO = BR.BKG_NO AND CNTR_NO = E.CNTR_NO) CNTR_PRT_FLG
			  ,DECODE(BC.CNTR_VOL_QTY, 1, 'N', 'Y') CNTR_PRT_FLG
              ,E.CNTR_TPSZ_CD
              ,NVL(B.FRT_CLT_FLG, 'N') AS FRT_CLT_FLG
              ,NVL(B.OBL_RDEM_FLG, 'N') AS OBL_RDEM_FLG
              ,IBD.IBD_TRSP_NO
              ,IBD.IBD_TRSP_TP_CD
              ,IBD.FREE_TRD_ZN_FLG
              ,TO_CHAR(IBD.IBD_TRSP_ISS_DT, 'YYYY-MM-DD HH24:MI') AS IBD_TRSP_ISS_DT
              ,TO_CHAR(IBD.IBD_TRSP_ACPT_DT, 'YYYY-MM-DD HH24:MI') AS IBD_TRSP_ACPT_DT
              ,TO_CHAR(NVL(E.ARR_DT, IBD.IBD_TRSP_ARR_DT), 'YYYY-MM-DD HH24:MI') AS IBD_TRSP_ARR_DT
              ,TO_CHAR(NVL(E.CGO_ARR_ACPT_DT, IBD.IBD_TRSP_ARR_ACPT_DT), 'YYYY-MM-DD HH24:MI') AS IBD_TRSP_ARR_ACPT_DT
              ,TO_CHAR(NVL(E.XPT_DT, IBD.IBD_TRSP_XPT_DT), 'YYYY-MM-DD HH24:MI') AS IBD_TRSP_XPT_DT
              ,TO_CHAR(NVL(E.XPT_ACPT_DT, IBD.IBD_TRSP_XPT_ACPT_DT), 'YYYY-MM-DD HH24:MI') AS IBD_TRSP_XPT_ACPT_DT
              ,PBL.RCV_TERM_CD
              ,PBL.DE_TERM_CD
              ,TO_CHAR(CR.RCV_DT, 'YYYY-MM-DD HH24:MI') AS ARR_DT
              ,BR.SC_NO
              ,BR.RFA_NO
              ,BR.TAA_NO
              ,NVL(NVL(NVL(BR.RFA_NO,BR.SC_NO),BR.TAA_NO),' ') CONTRAT_NO
              ,AD.CSTMS_DSPO_NM
              ,PBL.CSTMS_POL_CD POL_CD
              ,PBL.BKG_NO
              ,PBL.VSL_CD||PBL.SKD_VOY_NO||PBL.SKD_DIR_CD AS VVD
              ,CC.RAIL_CRR_REF_NO
              ,CC.USA_IB_TRSP_NO
              ,SPF.PKUP_NO
              ,DECODE(SPF.NTFC_DT, NULL, 'N', 'Y') AS PKUP_RELEASED
              ,TO_CHAR(SPF.NTFC_DT, 'YYYY-MM-DD HH24:MI') AS PKUP_DATE
              ,CASE WHEN PBL.CSTMS_POD_CD NOT LIKE 'US%' AND PBL.DEL_CD LIKE 'US%' THEN NVL(CR.CSTMS_CLR_CD, 'N')
                    ELSE NVL(B.CSTMS_CLR_CD, 'N')
               END CSTMS_CLR_CD
              ,ROW_NUMBER() OVER(ORDER BY E.BL_NO, E.CNTR_NO) AS RNUM
              ,DECODE(PBL.MF_NO, NULL, DECODE(BR.CUST_TO_ORD_FLG, 'Y', 'N', 'C'), 'C') AS BKG_CUST_TP_CD
              ,COUNT(DISTINCT PBL.BL_NO) OVER() AS BL_CNT
			  ,CASE WHEN A.CSTMS_POD_CD NOT LIKE 'US%' AND A.DEL_CD LIKE 'US%' THEN NVL(CR.CSTMS_CLR_CD, 'N')
                    ELSE NVL(B.CSTMS_CLR_CD, 'N')
               END C_FLAG
			  ,DECODE( CC.RAIL_CRR_REF_NO , NULL, '', 'Y' ) MASTER
			  ,CASE WHEN NVL(B.CSTMS_CLR_CD, 'N') IN ('Y', 'W', 'T', 'E')  THEN 'Y' ELSE 'N' END RLSE_EDI
			  ,( SELECT NVL(SUM(CM.PCK_QTY), 0) FROM BKG_CSTMS_ADV_CNTR_MF CM
				    WHERE CM.CNT_CD = PCNTR.CNT_CD
			    	AND CM.BL_NO = PCNTR.BL_NO
				    AND CM.CNTR_NO = PCNTR.CNTR_NO
			    ) SUM_CM_QTY
			  ,NVL2(CC.RAIL_CRR_REF_NO, ( SELECT 
					SUBSTR( NVL( MAX( DECODE (DSPO_CD , '55', LPAD(CSTMS_SEQ,3,'0')||CNTR_QTY ) ) 
                	,MAX( DECODE (DSPO_CD , '69', LPAD(CSTMS_SEQ,3,'0')||CNTR_QTY ) ) )
           				, 4 ) QTY 
         		 FROM BKG_CSTMS_ADV_CNTR_RSLT CRQ
			    WHERE PCNTR.CNT_cD = CRQ.CNT_cD
    			  AND PCNTR.BL_NO = CRQ.BL_NO
    			  AND PCNTR.CNTR_NO  LIKE TRIM(CRQ.CNTR_NO) || '%'
			    ), '') R_QTY
			  ,NVL2(CC.RAIL_CRR_REF_NO, ( SELECT 
					NVL(
			        SUM(DECODE(DSPO_CD, '1C', CNTR_QTY, 0)) 
			      + SUM(DECODE(DSPO_CD, '1W', CNTR_QTY, 0)) 
			      - SUM(DECODE(DSPO_CD, '4E', CNTR_QTY, 0)), 0)
		         FROM BKG_CSTMS_ADV_CNTR_RSLT CRQ
			    WHERE PCNTR.CNT_CD = CRQ.CNT_CD
				  AND PCNTR.BL_NO = CRQ.BL_NO
			      AND PCNTR.CNTR_NO  LIKE TRIM(CRQ.CNTR_NO) || '%'
			    ), '') RLSE_QTY
			  ,(SELECT 'Y' FROM TRS_TRSP_RAIL_BIL_ORD TR
				WHERE TR.BKG_NO = PBL.BKG_NO
				AND TR.EQ_NO = PCNTR.CNTR_NO
				AND TR.TRSP_SO_STS_CD = 'I' 
				AND DELT_FLG ='N'
				AND ROWNUM=1
				) R_BILLING
			  ,'' FEU
			  ,'' TEU
              ,COUNT(*) OVER() AS TOTAL
              ,CASE WHEN DECODE(PBL.MF_NO, NULL, PBL.CSTMS_FILE_TP_CD, '0') = 2  AND
                ( (PBL.POD_CD LIKE 'US%' AND A.DEL_CD NOT LIKE 'US%') OR IBD.CSTMS_CLR_TP_CD IN ('V','F')) THEN 'X' ELSE 'Y' END Non3ZSearchYn
              ,IBD.CSTMS_CLR_TP_CD 
              ,LO.SCC_CD DEL_SCC
              ,LO2.SCC_CD POD_SCC
              ,CASE WHEN (LO.SCC_CD = 'USLAX' AND LO2.SCC_CD = 'USLGB') OR (LO.SCC_CD = 'USLGB' AND LO2.SCC_CD = 'USLAX') THEN 'EQUALS' ELSE 'N' END CHECKFLAG
              ,( 
                SELECT TO_CHAR(VPS_ETD_DT, 'yyyy-mm-dd hh24:mi') AS VPS_ETD_DT 
                FROM VSK_VSL_PORT_SKD SKD1
                WHERE A.VSL_CD         = SKD1.VSL_CD
                  AND A.SKD_VOY_NO     = SKD1.SKD_VOY_NO
                  AND A.SKD_DIR_CD     = SKD1.SKD_DIR_CD
                  AND A.CSTMS_POL_CD   = SKD1.VPS_PORT_CD
                  AND SKD1.CLPT_IND_SEQ = 1
                ) T_POL_ETD
              ,( 
                SELECT TO_CHAR(VPS_ETA_DT, 'yyyy-mm-dd hh24:mi') AS VPS_ETA_DT 
                FROM VSK_VSL_PORT_SKD SKD2
                WHERE A.VSL_CD         = SKD2.VSL_CD
                  AND A.SKD_VOY_NO     = SKD2.SKD_VOY_NO
                  AND A.SKD_DIR_CD     = SKD2.SKD_DIR_CD
                  AND A.CSTMS_POD_CD   = SKD2.VPS_PORT_CD
                  AND SKD2.CLPT_IND_SEQ = 1
                ) T_POD_ETA
          FROM BKG_CSTMS_ADV_BL A
              ,BKG_CSTMS_ADV_IBD IBD
              ,BKG_CSTMS_ADV_CNTR E 
			  ,BKG_CSTMS_ADV_BL PBL
			  ,BKG_CSTMS_ADV_CNTR PCNTR 
			  ,BKG_BOOKING BR 
			  ,BKG_CONTAINER BC
			  ,BKG_CGO_RLSE B
			  ,BKG_CSTMS_ADV_CNTR_RSLT CR
			  ,BKG_PKUP_NTC SPF
			  ,BKG_CSTMS_ADV_CNTR CC
			  ,BKG_CSTMS_ADV_DSPO AD
              ,MDM_LOCATION LO
              ,MDM_LOCATION LO2              
			  ,VSK_VSL_PORT_SKD VS
         WHERE A.CNT_CD  = 'US'
		   AND A.MF_STS_CD     	 = 'A'
		   AND A.CNT_CD       	 = E.CNT_CD
		   AND A.BL_NO         	 = E.BL_NO
		   AND PBL.CNT_CD        = PCNTR.CNT_CD
		   AND PBL.BL_NO         = PCNTR.BL_NO
		   AND PCNTR.CNT_CD      = E.CNT_CD
		   AND PCNTR.CNTR_NO     = E.CNTR_NO
        #if (${mbl_no} == '')
		   AND PBL.BL_NO       	 = A.BL_NO
		#end
		   AND PBL.VSL_CD        = A.VSL_CD
		   AND PBL.SKD_VOY_NO    = A.SKD_VOY_NO
		   AND PBL.SKD_DIR_CD    = A.SKD_DIR_CD
		   AND PBL.MF_STS_CD     = 'A'
		   AND PBL.MF_NO IS NULL
		   AND A.MF_NO IS NULL
		   AND PBL.BKG_NO = BR.BKG_NO
		   AND PBL.BL_NO = B.BL_NO(+)
		   AND PCNTR.CNT_CD = CR.CNT_CD(+)
		   AND PCNTR.BL_NO= CR.BL_NO(+)
		   AND PCNTR.CNTR_NO  LIKE TRIM(CR.CNTR_NO(+)) || '%'
		   AND ( CR.CSTMS_SEQ IS NULL
      				OR CR.CSTMS_SEQ = (
                        SELECT MAX( CSTMS_SEQ )
                        FROM BKG_CSTMS_ADV_CNTR_RSLT
                        WHERE BL_NO = CR.BL_NO
                          AND CNT_CD = CR.CNT_CD
                          AND CNTR_NO LIKE SUBSTR(TRIM(CR.CNTR_NO), 1, 10) || '%' ) )
  		  AND BR.BKG_NO = SPF.BKG_NO(+)
		  AND ( SPF.NTC_SEQ IS NULL
		      OR SPF.NTC_SEQ =(
        		SELECT MAX(NTC_SEQ)
		        FROM BKG_PKUP_NTC
		        WHERE BKG_NO = BR.BKG_NO ) )  
		  AND CC.CNT_CD = 'CA'
		  AND PCNTR.BL_NO = CC.BL_NO
		  AND PCNTR.CNTR_NO = CC.CNTR_NO
		  AND CR.CNT_CD = AD.CNT_CD(+)
		  AND CR.DSPO_CD = AD.CSTMS_DSPO_CD(+)
		  AND PBL.CNT_CD = IBD.CNT_CD
		  AND PBL.BL_NO = IBD.BL_NO
		  AND BR.BKG_NO = BC.BKG_NO
		  AND PCNTR.CNTR_NO = BC.CNTR_NO
 		  AND VS.VSL_CD(+) = PBL.VSL_CD
		  AND VS.SKD_VOY_NO(+) = PBL.SKD_VOY_NO
		  AND VS.SKD_DIR_CD(+) = PBL.SKD_DIR_CD
		  AND VS.VPS_PORT_CD(+) =PBL.POD_CD
		  AND ( VS.CLPT_IND_SEQ IS NULL
                    OR VS.CLPT_IND_SEQ =(SELECT MAX(CLPT_IND_SEQ)
                          FROM VSK_VSL_PORT_SKD
                         WHERE VSL_CD = PBL.VSL_CD
                           AND SKD_VOY_NO = PBL.SKD_VOY_NO
                           AND SKD_DIR_CD = PBL.SKD_DIR_CD
                           AND VPS_PORT_CD =PBL.POD_CD) )
		   #if (${sc_no} != '')
             AND BR.SC_NO = @[sc_no]
           #end
		   #if (${cntr_tp} != '')
             AND E.CNTR_TPSZ_CD = @[cntr_tp]
           #end
		   #if (${cntr_no} != '')
             AND E.CNTR_NO = @[cntr_no]
           #end
		#if (${customs_result_code_grp} == 'WP')
		  AND CR.ENTR_NO LIKE 'V5N%'
		#end
           AND A.DEL_CD  = LO.LOC_CD
           AND A.POD_CD  = LO2.LOC_CD           
        #if (${tmp3} != '')
--             AND A.CNT_CD = CR.CNT_CD(+)
--             AND A.BL_NO  = CR.BL_NO(+)
            #if (${tmp3} == '2Z')
                AND (
                     CR.CSTMS_SEQ = (SELECT MAX( CSTMS_SEQ )
                                      FROM BKG_CSTMS_ADV_RSLT
                                     WHERE BL_NO = PBL.BL_NO
                                       AND CNT_CD = PBL.CNT_CD
                                       AND DSPO_CD = '2Z'
                                   )
                AND  CR.CSTMS_SEQ = (SELECT MAX( CSTMS_SEQ )
                                      FROM BKG_CSTMS_ADV_RSLT
                                     WHERE BL_NO = PBL.BL_NO
                                       AND CNT_CD = PBL.CNT_CD
                                   )
                     )
            #elseif (${tmp3} == '6H6I')
                AND (
                     CR.CSTMS_SEQ IN (SELECT MAX( CSTMS_SEQ )
                                      FROM BKG_CSTMS_ADV_RSLT
                                     WHERE BL_NO = PBL.BL_NO
                                       AND CNT_CD = PBL.CNT_CD
                                       AND DSPO_CD IN ('6H','6I')
                                  GROUP BY DSPO_CD
                                   )
                     )
            #elseif (${tmp3} == '3Z')
                AND (
                     NOT EXISTS (SELECT CSTMS_SEQ
                                   FROM BKG_CSTMS_ADV_RSLT
                                  WHERE CNT_CD = PBL.CNT_CD
                                    AND BL_NO = PBL.BL_NO
                                    AND DSPO_CD = '3Z'
                                 )
                     )
                AND (
                     CR.CSTMS_SEQ = (SELECT MAX( CSTMS_SEQ )
                                      FROM BKG_CSTMS_ADV_RSLT
                                     WHERE BL_NO = PBL.BL_NO
                                       AND CNT_CD = PBL.CNT_CD
                                   )
                    )
                AND ( CASE WHEN A.CSTMS_FILE_TP_CD = 2  AND ( (A.CSTMS_POD_CD LIKE 'US%' AND A.DEL_CD NOT LIKE 'US%') OR IBD.CSTMS_CLR_TP_CD IN ('V','F')) THEN 'X' ELSE 'Y' END) = 'Y'
            #elseif (${tmp3} == '2Q4Q')
                AND (
                     CR.CSTMS_SEQ IN (SELECT MAX( CSTMS_SEQ )
                                      FROM BKG_CSTMS_ADV_RSLT
                                     WHERE BL_NO = PBL.BL_NO
                                       AND CNT_CD = PBL.CNT_CD
                                       AND DSPO_CD IN ('2Q','4Q')
                                  GROUP BY DSPO_CD
                                   )
                     )
            #elseif (${tmp3} == '2O4O')
                AND (
                     CR.CSTMS_SEQ IN (SELECT MAX( CSTMS_SEQ )
                                      FROM BKG_CSTMS_ADV_RSLT
                                     WHERE BL_NO = PBL.BL_NO
                                       AND CNT_CD = PBL.CNT_CD
                                       AND DSPO_CD IN ('2O','4O')
                                  GROUP BY DSPO_CD
                                   )
                     )
            #elseif (${tmp3} == '2R4R')
                AND (
                     CR.CSTMS_SEQ IN (SELECT MAX( CSTMS_SEQ )
                                      FROM BKG_CSTMS_ADV_RSLT
                                     WHERE BL_NO = PBL.BL_NO
                                       AND CNT_CD = PBL.CNT_CD
                                       AND DSPO_CD IN ('2R','4R')
                                  GROUP BY DSPO_CD
                                   )
                     )
            #end
        #elseif (${customs_result_code} != '')
--             AND A.CNT_CD = CR.CNT_CD
--             AND A.BL_NO  = CR.BL_NO
             AND 
				  #if (${final_flg} == '1')
				  (
                  CR.CSTMS_SEQ = (SELECT MAX( CSTMS_SEQ )
                                   FROM BKG_CSTMS_ADV_RSLT
                                  WHERE BL_NO = PBL.BL_NO
                                    AND CNT_CD = PBL.CNT_CD                                   
                                )
				  )
				  AND C.DSPO_CD = @[customs_result_code]
				  #else
                  ( 
                  CR.CSTMS_SEQ = (SELECT MAX( CSTMS_SEQ )
                                   FROM BKG_CSTMS_ADV_RSLT
                                  WHERE BL_NO = PBL.BL_NO
                                    AND CNT_CD = PBL.CNT_CD
                                    AND DSPO_CD = @[customs_result_code]
                                )
				  )
				  #end	
        #elseif (${customs_result_code_grp} != '' && ${customs_result_code_grp} != 'ALL')
--             AND A.CNT_CD = CR.CNT_CD
--             AND A.BL_NO  = CR.BL_NO
             AND 
                 #if (${final_flg} == '1')
				 (
                  CR.CSTMS_SEQ = (SELECT MAX( CSTMS_SEQ )
                                   FROM BKG_CSTMS_ADV_RSLT R
                                       ,BKG_CSTMS_ADV_DSPO D
                                  WHERE R.BL_NO = PBL.BL_NO
                                    AND R.CNT_CD = PBL.CNT_CD
                                    AND R.CNT_CD = D.CNT_CD
                                    AND R.DSPO_CD = D.CSTMS_DSPO_CD
                                )
                 )
				 AND CR.DSPO_CD IN ( SELECT CSTMS_DSPO_CD FROM BKG_CSTMS_ADV_DSPO WHERE DSPO_TP_CD = @[customs_result_code_grp] )
				 #else                
				 (
                  CR.CSTMS_SEQ = (SELECT MAX( CSTMS_SEQ )
                                   FROM BKG_CSTMS_ADV_RSLT R
                                       ,BKG_CSTMS_ADV_DSPO D
                                  WHERE R.BL_NO = PBL.BL_NO
                                    AND R.CNT_CD = PBL.CNT_CD
                                    AND R.CNT_CD = D.CNT_CD
                                    AND R.DSPO_CD = D.CSTMS_DSPO_CD
                                    AND D.DSPO_TP_CD = @[customs_result_code_grp]
                                )
                  )
				  #end
        #elseif (${tmp1} == 'C')
--             AND A.CNT_CD = CR.CNT_CD (+)
--             AND A.BL_NO  = CR.BL_NO (+)
             AND (
                  CR.CSTMS_SEQ IS NULL
                  OR
                  CR.CSTMS_SEQ = (SELECT MAX( CSTMS_SEQ )
                                   FROM BKG_CSTMS_ADV_RSLT
                                  WHERE BL_NO = PBL.BL_NO
                                    AND CNT_CD = PBL.CNT_CD
                                 )
                  )
        #else
--             AND A.CNT_CD = CR.CNT_CD
--             AND A.BL_NO  = CR.BL_NO
             AND (
                  CR.CSTMS_SEQ = (SELECT MAX( CSTMS_SEQ )
                                   FROM BKG_CSTMS_ADV_RSLT
                                  WHERE BL_NO = PBL.BL_NO
                                    AND CNT_CD = PBL.CNT_CD
                                 )
                  )
        #end
        #if (${excl_rls} != '')
             AND NVL(B.CSTMS_CLR_CD, 'N') NOT IN ('Y', 'W', 'T', 'E')
        #end
        #if (${mbl_no} != '')
                AND (A.MF_NO = @[mbl_no] OR A.BL_NO = @[mbl_no])
        #else
            #if (${ams_file_no} != '')
                AND A.BL_NO = @[ams_file_no]
            #else
                #if (${vvd} != '')
                    AND A.VSL_CD = SUBSTR(@[vvd],1,4)
                    AND A.SKD_VOY_NO = SUBSTR(@[vvd], 5, 4)
                    AND A.SKD_DIR_CD = SUBSTR(@[vvd], 9, 1)
                #end
                #if (${pod} != '')
                    AND A.CSTMS_POD_CD = @[pod]
                #end
                #if (${pol} != '')
                    AND A.CSTMS_POL_CD = @[pol]
                #end
                #if (${del} != '')
                    AND A.DEL_CD = @[del]
                #end
                #if (${hub} != '')
                    AND A.HUB_LOC_CD = @[hub]
                #end
                #if (${rcv_term_cd} != '')
                    AND A.RCV_TERM_CD = @[rcv_term_cd]
                #end
                #if (${de_term_cd} != '')
                    AND A.DE_TERM_CD = @[de_term_cd]
                #end
		#if (${eq_ofc} != '' && ${eq_ofc} != 'ALL') 
	    AND LO.EQ_CTRL_OFC_CD  IN ( 
			#foreach($eqofc in ${vel_eq_ofc})  
				'$eqofc',  
				#end  
				'') 
		#end
                #if (${b_stf} != '')
                    AND BR.DOC_USR_ID = @[b_stf]
                #end
                #if (${l_rep} != '')
                    AND BR.OB_SREP_CD = @[l_rep]
                #end
                #if (${filer} != '')
                    AND (${filer})
                #end

                #if (${pmib_tp} == '61' || ${pmib_tp} == '62' || ${pmib_tp} == '63')
                    AND IBD.IBD_TRSP_TP_CD = @[pmib_tp]
                #elseif (${pmib_tp} == 'I')
                    AND IBD.CSTMS_CLR_TP_CD = 'I'
                #elseif (${pmib_tp} == 'L')
                    AND IBD.CSTMS_CLR_TP_CD = 'L'
                #elseif (${pmib_tp} == 'LC')
                    AND (LO.SCC_CD = LO2.SCC_CD OR (LO.SCC_CD = 'USLAX' AND LO2.SCC_CD = 'USLGB') OR (LO.SCC_CD = 'USLGB' AND LO2.SCC_CD = 'USLAX'))
                #elseif (${pmib_tp} == 'IP')
                    AND (LO.SCC_CD != LO2.SCC_CD AND (LO.SCC_CD != 'USLAX' OR LO2.SCC_CD != 'USLGB') AND (LO.SCC_CD != 'USLGB' OR LO2.SCC_CD != 'USLAX'))
                #end

                #if (${date_search} != '' && ${cust_arr_exp} != '' && ${fromd} != '' && ${tod} != '')
                    #if (${cust_arr_exp} == 'RCV')
                        AND CR.RCV_DT
                            BETWEEN TO_DATE(REPLACE(@[fromd], '-', '') || REPLACE(@[fromt], ':', '') ,'YYYYMMDDHH24MI')
                                AND TO_DATE(REPLACE(@[tod], '-', '')   || REPLACE(@[tot], ':', '')   ,'YYYYMMDDHH24MI')
                    #elseif (${cust_arr_exp} == 'ARR')
                        AND (
                                ER.ARR_DT
                                BETWEEN TO_DATE(REPLACE(@[fromd], '-', '') || REPLACE(@[fromt], ':', '') ,'YYYYMMDDHH24MI')
                                    AND TO_DATE(REPLACE(@[tod], '-', '')   || REPLACE(@[tot], ':', '')   ,'YYYYMMDDHH24MI')
                                OR
                                (
                                ER.ARR_DT IS NULL
                                AND
                                IBD.IBD_TRSP_ARR_DT
                                BETWEEN TO_DATE(REPLACE(@[fromd], '-', '') || REPLACE(@[fromt], ':', '') ,'YYYYMMDDHH24MI')
                                    AND TO_DATE(REPLACE(@[tod], '-', '')   || REPLACE(@[tot], ':', '')   ,'YYYYMMDDHH24MI')
                                )
                            )
                    #elseif (${cust_arr_exp} == 'EXP')
                        AND (
                                E.XPT_DT
                                BETWEEN TO_DATE(REPLACE(@[fromd], '-', '') || REPLACE(@[fromt], ':', '') ,'YYYYMMDDHH24MI')
                                    AND TO_DATE(REPLACE(@[tod], '-', '')   || REPLACE(@[tot], ':', '')   ,'YYYYMMDDHH24MI')
                                OR
                                (
                                E.XPT_DT IS NULL
                                AND IBD.IBD_TRSP_XPT_DT
                                 BETWEEN TO_DATE(REPLACE(@[fromd], '-', '') || REPLACE(@[fromt], ':', '') ,'YYYYMMDDHH24MI') 
                                    AND TO_DATE(REPLACE(@[tod], '-', '')   || REPLACE(@[tot], ':', '')   ,'YYYYMMDDHH24MI')
                                )
                            )
					#elseif (${cust_arr_exp} == 'ETA')
						AND VS.VPS_ETA_DT
                            BETWEEN TO_DATE(REPLACE(@[fromd], '-', '') || REPLACE(@[fromt], ':', '') ,'YYYYMMDDHH24MI')
                                AND TO_DATE(REPLACE(@[tod], '-', '')   || REPLACE(@[tot], ':', '')   ,'YYYYMMDDHH24MI')
                    #end
                #end
            #end
        #end

	#if (${cntr_prt_flg} == '1')
		AND BC.CNTR_VOL_QTY != 1  
	#end

       ) TB
      ,BKG_CSTMS_ADV_CUST CUST
  WHERE TB.RNUM BETWEEN @[start_no] AND @[end_no]
	AND TB.CNT_CD = CUST.CNT_CD(+)
	AND TB.AMS_FILE_NO = CUST.BL_NO(+)
	AND TB.BKG_CUST_TP_CD = CUST.BKG_CUST_TP_CD(+)
	#if (${customer_cd} != '')
	  AND CUST.CUST_CNT_CD||CUST.CUST_SEQ = @[customer_cd]
	#end
	#if (${rbilling_yn} == 'Y')
	  AND TB.R_BILLING = 'Y'
	#end
    #if (${tmp3} == '3Z')
      AND TB.Non3ZSearchYn = 'Y'
    #end

#else
WITH T_VIEW AS(
SELECT    TB.*, '' AS SEQ, REPLACE(REPLACE(REPLACE(CUST.CUST_NM, CHR(13)||CHR(10),' '), CHR(13), ' '), CHR(10), ' ') AS CUST_NM
          ,CASE CSTMS_CLR_TP_CD WHEN 'L' THEN 'Local' WHEN 'I' THEN 'P/MIB' END CSTMS_CLR_TP_NM
          ,CASE WHEN (DEL_SCC = POD_SCC OR CHECKFLAG ='EQUALS') THEN 'Local cargo' WHEN DEL_SCC != POD_SCC THEN 'IPI' ELSE '' END CGO_DEST_TYPE_NM
  FROM (
        SELECT A.CNT_CD
              ,NVL(C.DSPO_CD,' ') AS DSPO_CD
              ,BR.BL_NO AS MBL_NO
              ,A.BL_NO  AS AMS_FILE_NO
              ,DECODE(A.MF_NO, NULL, A.CSTMS_FILE_TP_CD, '0') FILER
              ,COUNT(DISTINCT A.BL_NO) OVER() AS BL_CNT
              ,COUNT(*) OVER() AS TOTAL
              ,A.MF_STS_CD
              ,A.CSTMS_MF_TP_CD
              ,A.POD_CD
              ,A.DEL_CD
              ,A.HUB_LOC_CD
              ,E.CNTR_NO
              --,(SELECT DECODE(CNTR_VOL_QTY, 1, 'N', 'Y') FROM BKG_CONTAINER	WHERE BKG_NO = BR.BKG_NO AND CNTR_NO = E.CNTR_NO) CNTR_PRT_FLG 
			  ,DECODE(BC.CNTR_VOL_QTY, 1, 'N', 'Y') CNTR_PRT_FLG
              ,E.CNTR_TPSZ_CD
              ,NVL(B.FRT_CLT_FLG, 'N') AS FRT_CLT_FLG
              ,NVL(B.OBL_RDEM_FLG, 'N') AS OBL_RDEM_FLG
              ,IBD.IBD_TRSP_NO
              ,IBD.IBD_TRSP_TP_CD
              ,IBD.FREE_TRD_ZN_FLG
              ,TO_CHAR(IBD.IBD_TRSP_ISS_DT, 'YYYY-MM-DD HH24:MI') AS IBD_TRSP_ISS_DT
              ,TO_CHAR(IBD.IBD_TRSP_ACPT_DT, 'YYYY-MM-DD HH24:MI') AS IBD_TRSP_ACPT_DT
              ,TO_CHAR(NVL(E.ARR_DT, IBD.IBD_TRSP_ARR_DT), 'YYYY-MM-DD HH24:MI') AS IBD_TRSP_ARR_DT
              ,TO_CHAR(NVL(E.CGO_ARR_ACPT_DT, IBD.IBD_TRSP_ARR_ACPT_DT), 'YYYY-MM-DD HH24:MI') AS IBD_TRSP_ARR_ACPT_DT
              ,TO_CHAR(NVL(E.XPT_DT, IBD.IBD_TRSP_XPT_DT), 'YYYY-MM-DD HH24:MI') AS IBD_TRSP_XPT_DT
              ,TO_CHAR(NVL(E.XPT_ACPT_DT, IBD.IBD_TRSP_XPT_ACPT_DT), 'YYYY-MM-DD HH24:MI') AS IBD_TRSP_XPT_ACPT_DT
              ,A.RCV_TERM_CD
              ,A.DE_TERM_CD
              ,TO_CHAR(C.ARR_DT, 'YYYY-MM-DD HH24:MI') AS ARR_DT
              ,BR.SC_NO
              ,BR.RFA_NO
              ,BR.TAA_NO
              ,NVL(NVL(NVL(BR.RFA_NO,BR.SC_NO),BR.TAA_NO),' ') CONTRAT_NO
              ,AD.CSTMS_DSPO_NM
              ,A.CSTMS_POL_CD POL_CD
              ,A.BKG_NO
              ,A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD AS VVD
        #if(${general_or_rail} == 'RAILAMS')
              ,CC.RAIL_CRR_REF_NO
              ,CC.USA_IB_TRSP_NO
              ,SPF.PKUP_NO
              ,DECODE(SPF.NTFC_DT, NULL, 'N', 'Y') AS PKUP_RELEASED
              ,TO_CHAR(SPF.NTFC_DT, 'YYYY-MM-DD HH24:MI') AS PKUP_DATE
              ,CASE WHEN A.CSTMS_POD_CD NOT LIKE 'US%' AND A.DEL_CD LIKE 'US%' THEN NVL(CR.CSTMS_CLR_CD, 'N')
                    ELSE NVL(B.CSTMS_CLR_CD, 'N')
               END CSTMS_CLR_CD
			  ,CASE WHEN A.CSTMS_POD_CD NOT LIKE 'US%' AND A.DEL_CD LIKE 'US%' THEN NVL(CR.CSTMS_CLR_CD, 'N')
                    ELSE NVL(B.CSTMS_CLR_CD, 'N')
               END C_FLAG
			  ,DECODE( CC.RAIL_CRR_REF_NO , NULL, '', 'Y' ) MASTER
			  ,CASE WHEN NVL(B.CSTMS_CLR_CD, 'N') IN ('Y', 'W', 'T', 'E')  THEN 'Y' ELSE 'N' END RLSE_EDI
			  ,'' SUM_CM_QTY
			  ,'' R_QTY
			  ,'' RLSE_QTY
			  ,'' R_BILLING
			  ,DECODE( E.CNTR_TPSZ_CD , 'X2', 1, 0 ) FEU
			  ,DECODE( E.CNTR_TPSZ_CD , 'X2', 0, 1 ) TEU
        #else
              ,'' RAIL_CRR_REF_NO
              ,'' USA_IB_TRSP_NO
              ,'' PKUP_NO
              ,'' PKUP_RELEASED
              ,'' PKUP_DATE
              ,NVL(B.CSTMS_CLR_CD, 'N') AS CSTMS_CLR_CD
        #end
              ,ROW_NUMBER() OVER(ORDER BY E.BL_NO, E.CNTR_NO) AS RNUM
              ,DECODE(A.MF_NO, NULL, DECODE(BR.CUST_TO_ORD_FLG, 'Y', 'N', 'C'), 'C') AS BKG_CUST_TP_CD
              ,IBD.CSTMS_CLR_TP_CD 
              ,LO.SCC_CD DEL_SCC
              ,LO2.SCC_CD POD_SCC
              ,CASE WHEN (LO.SCC_CD = 'USLAX' AND LO2.SCC_CD = 'USLGB') OR (LO.SCC_CD = 'USLGB' AND LO2.SCC_CD = 'USLAX') THEN 'EQUALS' ELSE 'N' END CHECKFLAG
              ,( 
                SELECT TO_CHAR(VPS_ETD_DT, 'yyyy-mm-dd hh24:mi') AS VPS_ETD_DT 
                FROM VSK_VSL_PORT_SKD SKD1
                WHERE A.VSL_CD         = SKD1.VSL_CD
                  AND A.SKD_VOY_NO     = SKD1.SKD_VOY_NO
                  AND A.SKD_DIR_CD     = SKD1.SKD_DIR_CD
                  AND A.CSTMS_POL_CD   = SKD1.VPS_PORT_CD
                  AND SKD1.CLPT_IND_SEQ = 1
                ) T_POL_ETD
              ,( 
                SELECT TO_CHAR(VPS_ETA_DT, 'yyyy-mm-dd hh24:mi') AS VPS_ETA_DT 
                FROM VSK_VSL_PORT_SKD SKD2
                WHERE A.VSL_CD         = SKD2.VSL_CD
                  AND A.SKD_VOY_NO     = SKD2.SKD_VOY_NO
                  AND A.SKD_DIR_CD     = SKD2.SKD_DIR_CD
                  AND A.CSTMS_POD_CD   = SKD2.VPS_PORT_CD
                  AND SKD2.CLPT_IND_SEQ = 1
                ) T_POD_ETA
          FROM BKG_CSTMS_ADV_BL A
              ,BKG_CSTMS_ADV_IBD IBD
              ,BKG_CGO_RLSE B
              ,BKG_CSTMS_ADV_RSLT C
              ,BKG_CSTMS_ADV_CNTR E
              ,BKG_BOOKING BR
              ,BKG_CSTMS_ADV_DSPO AD
              ,MDM_LOCATION LO
              ,MDM_LOCATION LO1
              ,MDM_LOCATION LO2              
			  ,BKG_CONTAINER BC
        #if(${general_or_rail} == 'RAILAMS')
              ,BKG_CSTMS_ADV_CNTR_RSLT CR
              ,BKG_CSTMS_ADV_CNTR  CC
              ,BKG_PKUP_NTC SPF
			  ,VSK_VSL_PORT_SKD VS
        #end
		#if (${rhq} != '')
			,(
			SELECT OFC_N3RD_LVL_CD REGION , OFC_N8TH_LVL_CD OFC_CD
			FROM (
			SELECT OFC_KIND OFC_KND_CD , A.DEL , A.OFC_CD OFC_N8TH_LVL_CD , L1 OFC_LVL , DECODE(A.L1, 1, A.OFC_CD, 2, A.OFC_CD, 3, A.OFC_CD, 4, A.OFC_CD, 5, A.OFC_CD, 6, A.OFC_CD, 7, A.OFC_CD, 8, B.OFC_CD) OFC_N7TH_LVL_CD , DECODE(A.L1, 1, A.OFC_CD, 2, A.OFC_CD, 3, A.OFC_CD, 4, A.OFC_CD, 5, A.OFC_CD, 6, A.OFC_CD, 7, B.OFC_CD, 8, C.OFC_CD) OFC_N6TH_LVL_CD , DECODE(A.L1, 1, A.OFC_CD, 2, A.OFC_CD, 3, A.OFC_CD, 4, A.OFC_CD, 5, A.OFC_CD, 6, B.OFC_CD, 7, C.OFC_CD, 8, D.OFC_CD) OFC_N5TH_LVL_CD , DECODE(A.L1, 1, A.OFC_CD, 2, A.OFC_CD, 3, A.OFC_CD, 4, A.OFC_CD, 5, B.OFC_CD, 6, C.OFC_CD, 7, D.OFC_CD, 8, E.OFC_CD) OFC_N4TH_LVL_CD , DECODE(A.L1, 1, A.OFC_CD, 2, A.OFC_CD, 3, A.OFC_CD, 4, B.OFC_CD, 5, C.OFC_CD, 6, D.OFC_CD, 7, E.OFC_CD, 8, F.OFC_CD) OFC_N3RD_LVL_CD , DECODE(A.L1, 1, A.OFC_CD, 2, A.OFC_CD, 3, B.OFC_CD, 4, C.OFC_CD, 5, D.OFC_CD, 6, E.OFC_CD, 7, F.OFC_CD, 8, G.OFC_CD) OFC_N2ND_LVL_CD , DECODE(A.L1, 1, A.OFC_CD, 2, B.OFC_CD, 3, C.OFC_CD, 4, D.OFC_CD, 5, E.OFC_CD, 6, F.OFC_CD, 7, G.OFC_CD, 8, H.OFC_CD) OFC_N1ST_LVL_CD
			FROM (
			SELECT OFC_CD , LOC_CD , PRNT_OFC_CD , DELT_FLG DEL , A.OFC_KND_CD OFC_KIND , LEVEL L1
			FROM MDM_ORGANIZATION A START WITH A.OFC_CD = 'SELHO' CONNECT BY PRIOR A.OFC_CD = A.PRNT_OFC_CD ) A , MDM_ORGANIZATION B , MDM_ORGANIZATION C , MDM_ORGANIZATION D , MDM_ORGANIZATION E , MDM_ORGANIZATION F , MDM_ORGANIZATION G , MDM_ORGANIZATION H
			WHERE A.PRNT_OFC_CD = B.OFC_CD(+)
			AND B.PRNT_OFC_CD = C.OFC_CD(+)
			AND C.PRNT_OFC_CD = D.OFC_CD(+)
			AND D.PRNT_OFC_CD = E.OFC_CD(+)
			AND E.PRNT_OFC_CD = F.OFC_CD(+)
			AND F.PRNT_OFC_CD = G.OFC_CD(+)
			AND G.PRNT_OFC_CD = H.OFC_CD(+) )
			WHERE 1=1
			--  AND NVL(DEL, 'N') = 'N'
			AND OFC_N3RD_LVL_CD IS NOT NULL
			AND OFC_N3RD_LVL_CD IN (
			SELECT OFC_CD
			FROM (
			SELECT OFC_CD , LOC_CD , PRNT_OFC_CD , DELT_FLG DEL , A.OFC_KND_CD OFC_KIND , LEVEL L1
			FROM MDM_ORGANIZATION A START WITH A.OFC_CD = 'SELHO' CONNECT BY PRIOR A.OFC_CD = A.PRNT_OFC_CD )
			WHERE L1 =3
			AND OFC_KIND = '2' )
			AND OFC_N6TH_LVL_CD IS NOT NULL
			) OLA
		#end
         WHERE A.CNT_CD  = 'US'
           AND A.CNT_CD  = IBD.CNT_CD
           AND A.BL_NO   = IBD.BL_NO
           AND A.BL_NO   = B.BL_NO(+)
           AND C.CNT_CD  = AD.CNT_CD(+)
           AND C.DSPO_CD = AD.CSTMS_DSPO_CD(+)
           AND A.CNT_CD  = E.CNT_CD
           AND A.BL_NO   = E.BL_NO
           AND A.BKG_NO  = BR.BKG_NO

           AND BR.BKG_NO = BC.BKG_NO
           AND E.CNTR_NO = BC.CNTR_NO
		#if (${customs_result_code_grp} == 'WP')
		   AND C.ENTR_NO LIKE 'V5N%'
		#end
           AND A.DEL_CD  = LO.LOC_CD
           AND A.POL_CD  = LO1.LOC_CD
           AND A.POD_CD  = LO2.LOC_CD           
        #if (${general_or_rail} == 'RAILAMS')
           AND E.CNT_CD  = CR.CNT_CD(+)
           AND E.BL_NO   = CR.BL_NO(+)
           AND E.CNTR_NO LIKE TRIM(CR.CNTR_NO(+)) || '%'
           AND (
                  CR.CSTMS_SEQ IS NULL
                  OR
                  CR.CSTMS_SEQ =  (
                                      SELECT MAX( CSTMS_SEQ )
                                        FROM BKG_CSTMS_ADV_CNTR_RSLT
                                       WHERE BL_NO = E.BL_NO
                                         AND CNT_CD = E.CNT_CD
                                         AND CNTR_NO LIKE SUBSTR(TRIM(E.CNTR_NO), 1, 10) || '%'
                                  )
                )
           AND CC.CNT_CD = 'CA'
           AND E.BL_NO   = CC.BL_NO
           AND E.CNTR_NO = CC.CNTR_NO
           AND A.BKG_NO  = SPF.BKG_NO(+)
           AND (
                  SPF.NTC_SEQ IS NULL
                  OR
                  SPF.NTC_SEQ =(SELECT MAX(NTC_SEQ)
                                  FROM BKG_PKUP_NTC
                                 WHERE BKG_NO = A.BKG_NO
                                )
                 )
           AND SPF.PKUP_NTC_TP_CD(+) > ' '
           AND A.POD_CD NOT LIKE 'US%'
           AND A.DEL_CD LIKE 'US%'
           AND A.MF_NO IS NULL
 		   AND VS.VSL_CD(+) = A.VSL_CD
		   AND VS.SKD_VOY_NO(+) = A.SKD_VOY_NO
		   AND VS.SKD_DIR_CD(+) = A.SKD_DIR_CD
		   AND VS.VPS_PORT_CD(+) = A.POD_CD
		   AND ( VS.CLPT_IND_SEQ IS NULL
                    OR VS.CLPT_IND_SEQ =(SELECT MAX(CLPT_IND_SEQ)
                          FROM VSK_VSL_PORT_SKD
                         WHERE VSL_CD = A.VSL_CD
                           AND SKD_VOY_NO = A.SKD_VOY_NO
                           AND SKD_DIR_CD = A.SKD_DIR_CD
                           AND VPS_PORT_CD = A.POD_CD) )
		   #if (${sc_no} != '')
             AND BR.SC_NO = @[sc_no]
           #end
		   #if (${cntr_tp} != '')
             AND E.CNTR_TPSZ_CD = @[cntr_tp]
           #end
		   #if (${cntr_no} != '')
             AND E.CNTR_NO = @[cntr_no]
           #end
        #end
        #if (${tmp3} != '')
             AND A.CNT_CD = C.CNT_CD(+)
             AND A.BL_NO  = C.BL_NO(+)
            #if (${tmp3} == '2Z')
                AND (
                     C.CSTMS_SEQ = (SELECT MAX( CSTMS_SEQ )
                                      FROM BKG_CSTMS_ADV_RSLT
                                     WHERE BL_NO = A.BL_NO
                                       AND CNT_CD = A.CNT_CD
                                       AND DSPO_CD = '2Z'
                                   )
                AND  C.CSTMS_SEQ = (SELECT MAX( CSTMS_SEQ )
                                      FROM BKG_CSTMS_ADV_RSLT
                                     WHERE BL_NO = A.BL_NO
                                       AND CNT_CD = A.CNT_CD
                                   )
                     )
            #elseif (${tmp3} == '6H6I')
                AND (
                     C.CSTMS_SEQ IN (SELECT MAX( CSTMS_SEQ )
                                      FROM BKG_CSTMS_ADV_RSLT
                                     WHERE BL_NO = A.BL_NO
                                       AND CNT_CD = A.CNT_CD
                                       AND DSPO_CD IN ('6H','6I')
                                  GROUP BY DSPO_CD
                                   )
                     )
            #elseif (${tmp3} == '3Z')
                AND (
                     NOT EXISTS (SELECT CSTMS_SEQ
                                   FROM BKG_CSTMS_ADV_RSLT
                                  WHERE CNT_CD = A.CNT_CD
                                    AND BL_NO = A.BL_NO
                                    AND DSPO_CD = '3Z'
                                 )
                     )
                AND (
                     C.CSTMS_SEQ = (SELECT MAX( CSTMS_SEQ )
                                      FROM BKG_CSTMS_ADV_RSLT
                                     WHERE BL_NO = A.BL_NO
                                       AND CNT_CD = A.CNT_CD
                                   )
                    )
               AND ( CASE WHEN A.CSTMS_FILE_TP_CD = 2  AND ( (A.CSTMS_POD_CD LIKE 'US%' AND A.DEL_CD NOT LIKE 'US%') OR IBD.CSTMS_CLR_TP_CD IN ('V','F')) THEN 'X' ELSE 'Y' END) = 'Y'

            #elseif (${tmp3} == '2Q4Q')
                AND (
                     C.CSTMS_SEQ IN (SELECT MAX( CSTMS_SEQ )
                                      FROM BKG_CSTMS_ADV_RSLT
                                     WHERE BL_NO = A.BL_NO
                                       AND CNT_CD = A.CNT_CD
                                       AND DSPO_CD IN ('2Q','4Q')
                                  GROUP BY DSPO_CD
                                   )
                     )
            #elseif (${tmp3} == '2O4O')
                AND (
                     C.CSTMS_SEQ IN (SELECT MAX( CSTMS_SEQ )
                                      FROM BKG_CSTMS_ADV_RSLT
                                     WHERE BL_NO = A.BL_NO
                                       AND CNT_CD = A.CNT_CD
                                       AND DSPO_CD IN ('2O','4O')
                                  GROUP BY DSPO_CD
                                   )
                     )
            #elseif (${tmp3} == '2R4R')
                AND (
                     C.CSTMS_SEQ IN (SELECT MAX( CSTMS_SEQ )
                                      FROM BKG_CSTMS_ADV_RSLT
                                     WHERE BL_NO = A.BL_NO
                                       AND CNT_CD = A.CNT_CD
                                       AND DSPO_CD IN ('2R','4R')
                                  GROUP BY DSPO_CD
                                   )
                     )
            #end
        #elseif (${customs_result_code} != '')
             AND A.CNT_CD = C.CNT_CD
             AND A.BL_NO  = C.BL_NO
             AND 
				  #if (${final_flg} == '1')
				  (
                  C.CSTMS_SEQ = (SELECT MAX( CSTMS_SEQ )
                                   FROM BKG_CSTMS_ADV_RSLT
                                  WHERE BL_NO = A.BL_NO
                                    AND CNT_CD = A.CNT_CD                                   
                                )
				  )
				  AND C.DSPO_CD = @[customs_result_code]
				  #else
                  ( 
                  C.CSTMS_SEQ = (SELECT MAX( CSTMS_SEQ )
                                   FROM BKG_CSTMS_ADV_RSLT
                                  WHERE BL_NO = A.BL_NO
                                    AND CNT_CD = A.CNT_CD
                                    AND DSPO_CD = @[customs_result_code]
                                )
				  )
				  #end	
        #elseif (${customs_result_code_grp} != '' && ${customs_result_code_grp} != 'ALL')
             AND A.CNT_CD = C.CNT_CD
             AND A.BL_NO  = C.BL_NO
             AND 
                 #if (${final_flg} == '1')
				 (
                  C.CSTMS_SEQ = (SELECT MAX( CSTMS_SEQ )
                                   FROM BKG_CSTMS_ADV_RSLT R
                                       ,BKG_CSTMS_ADV_DSPO D
                                  WHERE R.BL_NO = A.BL_NO
                                    AND R.CNT_CD = A.CNT_CD
                                    AND R.CNT_CD = D.CNT_CD
                                    AND R.DSPO_CD = D.CSTMS_DSPO_CD
                                )
                 )
				 AND C.DSPO_CD IN ( SELECT CSTMS_DSPO_CD FROM BKG_CSTMS_ADV_DSPO WHERE DSPO_TP_CD = @[customs_result_code_grp] )
				 #else                
				 (
                  C.CSTMS_SEQ = (SELECT MAX( CSTMS_SEQ )
                                   FROM BKG_CSTMS_ADV_RSLT R
                                       ,BKG_CSTMS_ADV_DSPO D
                                  WHERE R.BL_NO = A.BL_NO
                                    AND R.CNT_CD = A.CNT_CD
                                    AND R.CNT_CD = D.CNT_CD
                                    AND R.DSPO_CD = D.CSTMS_DSPO_CD
                                    AND D.DSPO_TP_CD = @[customs_result_code_grp]
                                )
                  )
				  #end
        #elseif (${tmp1} == 'C')
             AND A.CNT_CD = C.CNT_CD (+)
             AND A.BL_NO  = C.BL_NO (+)
             AND (
                  C.CSTMS_SEQ IS NULL
                  OR
                  C.CSTMS_SEQ = (SELECT MAX( CSTMS_SEQ )
                                   FROM BKG_CSTMS_ADV_RSLT
                                  WHERE BL_NO = A.BL_NO
                                    AND CNT_CD = A.CNT_CD
                                 )
                  )
        #else
             AND A.CNT_CD = C.CNT_CD
             AND A.BL_NO  = C.BL_NO
             AND (
                  C.CSTMS_SEQ = (SELECT MAX( CSTMS_SEQ )
                                   FROM BKG_CSTMS_ADV_RSLT
                                  WHERE BL_NO = A.BL_NO
                                    AND CNT_CD = A.CNT_CD
                                 )
                  )
        #end
        #if (${excl_rls} != '')
             AND NVL(B.CSTMS_CLR_CD, 'N') NOT IN ('Y', 'W', 'T', 'E')
        #end
        #if (${mbl_no} != '')
                AND (A.MF_NO = @[mbl_no] OR A.BL_NO = @[mbl_no])
        #else
            #if (${ams_file_no} != '')
                AND A.BL_NO = @[ams_file_no]
            #else
                #if (${vvd} != '')
                    AND A.VSL_CD = SUBSTR(@[vvd],1,4)
                    AND A.SKD_VOY_NO = SUBSTR(@[vvd], 5, 4)
                    AND A.SKD_DIR_CD = SUBSTR(@[vvd], 9, 1)
                #end
                #if (${pod} != '')
                    AND A.CSTMS_POD_CD = @[pod]
                #end
                #if (${pol} != '')
                    AND A.CSTMS_POL_CD = @[pol]
                #end
                #if (${del} != '')
                    AND A.DEL_CD = @[del]
                #end
                #if (${hub} != '')
                    AND A.HUB_LOC_CD = @[hub]
                #end
                #if (${rcv_term_cd} != '')
                    AND A.RCV_TERM_CD = @[rcv_term_cd]
                #end
                #if (${de_term_cd} != '')
                    AND A.DE_TERM_CD = @[de_term_cd]
                #end
		#if (${eq_ofc} != '' && ${eq_ofc} != 'ALL') 
	    AND LO.EQ_CTRL_OFC_CD  IN ( 
			#foreach($eqofc in ${vel_eq_ofc})  
				'$eqofc',  
				#end  
				'') 
		#end
                #if (${b_stf} != '')
                    AND BR.DOC_USR_ID = @[b_stf]
                #end
                #if (${l_rep} != '')
                    AND BR.OB_SREP_CD = @[l_rep]
                #end
                #if (${rhq} != '')
					AND OLA.OFC_CD = LO1.EQ_CTRL_OFC_CD
					AND OLA.REGION = @[rhq] 
                #end
                #if (${filer} != '')
                    AND (${filer})
                #end

                #if (${pmib_tp} == '61' || ${pmib_tp} == '62' || ${pmib_tp} == '63')
                    AND IBD.IBD_TRSP_TP_CD = @[pmib_tp]
                #elseif (${pmib_tp} == 'I' )
                    AND IBD.CSTMS_CLR_TP_CD = 'I'
                #elseif (${pmib_tp} == 'L')
                    AND IBD.CSTMS_CLR_TP_CD = 'L'
                #elseif (${pmib_tp} == 'LC')
                    AND (LO.SCC_CD = LO2.SCC_CD OR (LO.SCC_CD = 'USLAX' AND LO2.SCC_CD = 'USLGB') OR (LO.SCC_CD = 'USLGB' AND LO2.SCC_CD = 'USLAX'))
                #elseif (${pmib_tp} == 'IP')
                    AND (LO.SCC_CD != LO2.SCC_CD AND (LO.SCC_CD != 'USLAX' OR LO2.SCC_CD != 'USLGB') AND (LO.SCC_CD != 'USLGB' OR LO2.SCC_CD != 'USLAX'))
                #end

                #if (${date_search} != '' && ${cust_arr_exp} != '' && ${fromd} != '' && ${tod} != '')
                    #if (${cust_arr_exp} == 'RCV')
                        AND C.ARR_DT
                            BETWEEN TO_DATE(REPLACE(@[fromd], '-', '') || REPLACE(@[fromt], ':', '') ,'YYYYMMDDHH24MI')
                                AND TO_DATE(REPLACE(@[tod], '-', '')   || REPLACE(@[tot], ':', '')   ,'YYYYMMDDHH24MI')
                    #elseif (${cust_arr_exp} == 'ARR')
                        AND (
                                E.ARR_DT
                                BETWEEN TO_DATE(REPLACE(@[fromd], '-', '') || REPLACE(@[fromt], ':', '') ,'YYYYMMDDHH24MI')
                                    AND TO_DATE(REPLACE(@[tod], '-', '')   || REPLACE(@[tot], ':', '')   ,'YYYYMMDDHH24MI')
                                OR
                                (	
                                E.ARR_DT IS NULL
                                AND
                                IBD.IBD_TRSP_ARR_DT
                                BETWEEN TO_DATE(REPLACE(@[fromd], '-', '') || REPLACE(@[fromt], ':', '') ,'YYYYMMDDHH24MI')
                                    AND TO_DATE(REPLACE(@[tod], '-', '')   || REPLACE(@[tot], ':', '')   ,'YYYYMMDDHH24MI')
                                )
                            )
                    #elseif (${cust_arr_exp} == 'EXP')
                        AND (
                                E.XPT_DT
                                BETWEEN TO_DATE(REPLACE(@[fromd], '-', '') || REPLACE(@[fromt], ':', '') ,'YYYYMMDDHH24MI')
                                    AND TO_DATE(REPLACE(@[tod], '-', '')   || REPLACE(@[tot], ':', '')   ,'YYYYMMDDHH24MI')
                                OR
                                (
                                E.XPT_DT IS NULL
                                AND IBD.IBD_TRSP_XPT_DT
                                 BETWEEN TO_DATE(REPLACE(@[fromd], '-', '') || REPLACE(@[fromt], ':', '') ,'YYYYMMDDHH24MI') 
                                    AND TO_DATE(REPLACE(@[tod], '-', '')   || REPLACE(@[tot], ':', '')   ,'YYYYMMDDHH24MI')
                                )
                            )
					#elseif (${general_or_rail} == 'RAILAMS' && ${cust_arr_exp} == 'ETA')
						AND VS.VPS_ETA_DT
                            BETWEEN TO_DATE(REPLACE(@[fromd], '-', '') || REPLACE(@[fromt], ':', '') ,'YYYYMMDDHH24MI')
                                AND TO_DATE(REPLACE(@[tod], '-', '')   || REPLACE(@[tot], ':', '')   ,'YYYYMMDDHH24MI')              
                    #end
                #end
            #end
        #end

        #if (${cntr_prt_flg} == '1')
        AND BC.CNTR_VOL_QTY != 1  
        #end

        #if (${contract_type} != '')
		  #if (${contract_type} == 'SC')
	  		AND BR.SC_NO IS NOT NULL
          #elseif (${contract_type} == 'RFA')
	  		AND BR.RFA_NO IS NOT NULL
          #elseif (${contract_type} == 'TAA')
	  		AND BR.TAA_NO IS NOT NULL
          #end
        #end

  	    #if (${err_type} != '')
  	      #if (${err_type} == 'U') /*Un-Sent*/
           AND (CASE WHEN A.MF_SND_DT IS NULL THEN 1 ELSE 0 END) = 1
  	      #end
	    #end

       ) TB
      ,BKG_CSTMS_ADV_CUST CUST
  	  #if (${err_type} != '')
  	     #if (${err_type} == 'N') /*Not-Received*/
      ,(
            SELECT *
            FROM (
                SELECT C.BL_NO
                        ,MAX(CASE WHEN  A.TRSM_MSG_TP_ID IN ('MI','AI') THEN A.CRR_BAT_NO ELSE ' ' END ) S_CRR_BAT_NO
                        ,MAX(CASE WHEN  B.RCV_MSG_TP_ID IN ('MR','AR') THEN B.CRR_BAT_NO ELSE ' ' END ) R_CRR_BAT_NO 
                FROM BKG_CSTMS_ADV_SND_LOG A, BKG_CSTMS_ADV_RCV_LOG B,BKG_CSTMS_ADV_EDI_BL_RSPN C
                WHERE 1=1
                #if (${mbl_no} != '' )
                        AND C.BL_NO = @[mbl_no]
                #else
                    #if (${ams_file_no} != '')
                        AND C.BL_NO = @[ams_file_no]
                    #else
                        #if (${vvd} != '')
                            AND A.VSL_CD = SUBSTR(@[vvd],1,4)
                            AND A.SKD_VOY_NO = SUBSTR(@[vvd], 5, 4)
                            AND A.SKD_DIR_CD = SUBSTR(@[vvd], 9, 1)
                        #end
                    #end
                #end
                AND A.CNT_CD = 'US'
                AND A.IO_BND_CD = 'I'
                AND C.CNT_CD = A.CNT_CD
                AND C.CRR_BAT_NO = A.CRR_BAT_NO
                AND A.CNT_CD = B.CNT_CD(+)
                AND A.IO_BND_CD = B.IO_BND_CD(+)
                AND A.CRR_BAT_NO =  B.CRR_BAT_NO(+)
                GROUP BY C.BL_NO
            ) Y
            WHERE (CASE WHEN S_CRR_BAT_NO != R_CRR_BAT_NO THEN 1 ELSE 0 END) = 1
        ) X
  	     #end
	  #end
  WHERE TB.RNUM BETWEEN @[start_no] AND @[end_no]
	AND TB.CNT_CD = CUST.CNT_CD(+)
	AND TB.AMS_FILE_NO = CUST.BL_NO(+)
	AND TB.BKG_CUST_TP_CD = CUST.BKG_CUST_TP_CD(+)
	#if (${customer_cd} != '')
	  AND CUST.CUST_CNT_CD||CUST.CUST_SEQ = @[customer_cd]
	#end
  	#if (${err_type} != '')
  	   #if (${err_type} == 'N') /*Not-Received*/
          AND TB.AMS_FILE_NO = X.BL_NO
  	   #end
	 #end
)
SELECT X.*
FROM (
    SELECT BL.*
  	#if (${search_discrepancy} == 'Y')
        , NVL((
            SELECT SUM(RS.CNTR_QTY) CNTR_QTY
            FROM BKG_CSTMS_ADV_RSLT  RS
                ,BKG_CSTMS_ADV_RCV_LOG RM
            WHERE RS.CNT_CD = RM.CNT_CD
            AND RM.IO_BND_CD = 'I'
            AND RS.VSL_CD = RM.VSL_CD
            AND RS.SKD_VOY_NO   = RM.SKD_VOY_NO
            AND RS.SKD_DIR_CD   = RM.SKD_DIR_CD
            AND RS.ARR_DT       = RM.RCV_DT
            AND RS.CSTMS_BAT_NO = RM.CSTMS_BAT_NO
            AND RS.DSPO_CD = '69'
            AND BL.POD_CD LIKE 'US%'
            AND BL.FILER = 1
            AND RS.BL_NO = BL.MBL_NO
            AND RS.CNT_CD = BL.CNT_CD
            AND RM.SCAC_CD = 'SMLM'
            GROUP BY RS.BL_NO
        ),0) HJSC_QTY,
        NVL((
            SELECT SUM(RS.CNTR_QTY) CNTR_QTY
            FROM BKG_CSTMS_ADV_RSLT  RS
                ,BKG_CSTMS_ADV_RCV_LOG RM
            WHERE RS.CNT_CD = RM.CNT_CD
            AND RM.IO_BND_CD = 'I'
            AND RS.VSL_CD = RM.VSL_CD
            AND RS.SKD_VOY_NO   = RM.SKD_VOY_NO
            AND RS.SKD_DIR_CD   = RM.SKD_DIR_CD
            AND RS.ARR_DT       = RM.RCV_DT
            AND RS.CSTMS_BAT_NO = RM.CSTMS_BAT_NO
            AND RS.DSPO_CD = '69'
            AND BL.POD_CD LIKE 'US%'
            AND BL.FILER = 1
            AND RS.BL_NO = BL.MBL_NO
            AND RS.CNT_CD = BL.CNT_CD
            AND RM.SCAC_CD != 'SMLM'
            GROUP BY RS.BL_NO
        ),0) NON_HJSC_QTY
  	#else
      , 0 HJSC_QTY , 0 NON_HJSC_QTY
    #end
    FROM T_VIEW BL
) X  
#if (${search_discrepancy} == 'Y')
WHERE HJSC_QTY != NON_HJSC_QTY AND NON_HJSC_QTY > 0 AND HJSC_QTY > 0 --불일치
#end

#end			]]></sql>
			<params>
				<param name="sc_no" type="12" value="" out="N"/>
				<param name="cntr_tp" type="12" value="" out="N"/>
				<param name="cntr_no" type="12" value="" out="N"/>
				<param name="customs_result_code" type="12" value="" out="N"/>
				<param name="customs_result_code_grp" type="12" value="" out="N"/>
				<param name="mbl_no" type="12" value="" out="N"/>
				<param name="ams_file_no" type="12" value="" out="N"/>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="pod" type="12" value="" out="N"/>
				<param name="pol" type="12" value="" out="N"/>
				<param name="del" type="12" value="" out="N"/>
				<param name="hub" type="12" value="" out="N"/>
				<param name="rcv_term_cd" type="12" value="" out="N"/>
				<param name="de_term_cd" type="12" value="" out="N"/>
				<param name="b_stf" type="12" value="" out="N"/>
				<param name="l_rep" type="12" value="" out="N"/>
				<param name="pmib_tp" type="12" value="" out="N"/>
				<param name="fromd" type="12" value="" out="N"/>
				<param name="fromt" type="12" value="" out="N"/>
				<param name="tod" type="12" value="" out="N"/>
				<param name="tot" type="12" value="" out="N"/>
				<param name="start_no" type="12" value="" out="N"/>
				<param name="end_no" type="12" value="" out="N"/>
				<param name="customer_cd" type="12" value="" out="N"/>
				<param name="rhq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
