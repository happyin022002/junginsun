<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="PerformanceReportDBDAOSearchEBkgSiUploadTimeSummaryRSQL">
			<desc><![CDATA[eBkg&SI Upload Summary 조회
* e-BKG은 BKG Office 기준, e-SI는 Doc. Perf Office GSO 기준에 의해 실적 귀속]]></desc>
			<sql><![CDATA[
SELECT RHQ_CD, GSO_CD, BKG_OFC_CD, BKG_CNT, SI_CNT, USR_CNT, UPLD_TM, AVG_UPLD_TM, ROUND(UPLD_HH,2) UPLD_HH, ROUND(AVG_UPLD_HH,2) AVG_UPLD_HH
FROM (
    SELECT NVL(RHQ_CD,'TTL') RHQ_CD, 
           GSO_CD,
           BKG_OFC_CD, 
           COUNT(DISTINCT BKG_NO) BKG_CNT, 
           COUNT(XTER_RQST_NO) SI_CNT, 
           COUNT(DISTINCT GSO_CD||BKG_OFC_CD||UPLD_USR_ID) USR_CNT, 
           BKG_GET_CONV_INTVAL_TIME_FNC(SUM(UPLD_TIME),'TM') UPLD_TM, 
           BKG_GET_CONV_INTVAL_TIME_FNC(SUM(UPLD_TIME)/COUNT(XTER_RQST_NO),'TM') AVG_UPLD_TM,
           (SUM(UPLD_TIME))  UPLD_HH,
           (SUM(UPLD_TIME)/COUNT(XTER_RQST_NO)) AVG_UPLD_HH
    FROM (
            SELECT DISTINCT BKG_NO,XTER_RQST_NO,XTER_RQST_SEQ, U.BKG_OFC_CD,
                   DECODE(@[doc_tp_cd], 'S', O.RGN_OFC_CD, V.REGION) RHQ_CD, 
                   DECODE(@[doc_tp_cd], 'S', O.GSO_OFC_CD, V.GSO) GSO_CD,
                   UPLD_USR_ID
                   , BKG_E_BKG_TURNTIME_FNC('D',substr(U.POR_CD,1,2),RQST_DT,UPLD_DT) UPLD_TIME
                   , RQST_DT, UPLD_DT
            FROM (
                   SELECT T.BKG_NO,
                          T.POR_CD,
                          T.BKG_OFC_CD,
                          T.UPLD_USR_ID,
                          X.XTER_RQST_NO,
                          X.XTER_RQST_SEQ,
                          GLOBALDATE_PKG.TIME_CONV_FNC('KRPUS', X.CRE_DT,T.POR_CD) RQST_DT,
                          T.UPLD_DT,
                          RANK() OVER(PARTITION BY X.BKG_NO, X.RQST_DT ORDER BY T.UPLD_DT) UPLD_RANK,
                          RANK() OVER(PARTITION BY X.BKG_NO, T.UPLD_DT ORDER BY X.RQST_DT) RQST_RANK
                    FROM ( SELECT U.BKG_NO,
                                  B.POR_CD,
                                  B.BKG_OFC_CD,
                                  U.DOC_TP_CD,
                                  U.UPLD_USR_ID,
                                  LAG(GLOBALDATE_PKG.TIME_CONV_FNC('GMT',U.UPLD_GDT,B.POR_CD)) OVER (PARTITION BY U.BKG_NO, DOC_TP_CD ORDER BY GLOBALDATE_PKG.TIME_CONV_FNC('GMT',U.UPLD_GDT,B.POR_CD)) BEF_UPLD_DT,
                                  GLOBALDATE_PKG.TIME_CONV_FNC('GMT',U.UPLD_GDT,B.POR_CD) UPLD_DT
                            FROM BKG_BOOKING B, BKG_XTER_RQST_MST U
                            WHERE U.BKG_NO = B.BKG_NO
                              AND U.DOC_TP_CD = @[doc_tp_cd]
                              AND NVL(U.XTER_BL_TP_CD,'X') <> 'H'
                              AND NVL(U.SNACCS_MSG_TP_CD,'X') NOT IN ('SAT050', 'SAT054')
                              AND B.BKG_STS_CD <> 'X'
                              AND B.BKG_CGO_TP_CD = 'F'
#if (${opt_tp} == 'D' && ${period} == 'B')
                              AND B.BKG_CRE_DT BETWEEN TO_DATE(@[fm_dt],'YYYY-MM-DD') AND TO_DATE(@[to_dt],'YYYY-MM-DD')+0.99999
#elseif (${opt_tp} == 'D' && ${period} == 'R')
                              AND U.RQST_DT BETWEEN TO_DATE(@[fm_dt],'YYYY-MM-DD') AND TO_DATE(@[to_dt],'YYYY-MM-DD')+0.99999
#end
#if (${opt_tp} == 'D' && ${period} == 'E')
                              AND B.BKG_NO IN (SELECT D.BKG_NO
                                                FROM BKG_VVD D
                                                     ,VSK_VSL_PORT_SKD V
                                                WHERE V.VSL_CD = D.VSL_CD
                                                AND V.SKD_VOY_NO = D.SKD_VOY_NO
                                                AND V.SKD_DIR_CD = D.SKD_DIR_CD
                                                AND V.VPS_PORT_CD = D.POL_CD
                                                AND V.CLPT_IND_SEQ = D.POL_CLPT_IND_SEQ
                                                AND V.VPS_ETD_DT BETWEEN TO_DATE(@[fm_dt],'YYYY-MM-DD') AND TO_DATE(@[to_dt],'YYYY-MM-DD')+0.99999 )
#end
					#if (${bkg_no} != '')
                              AND B.BKG_NO = @[bkg_no]
					#end
					#if (${vvd} != '')
                              AND B.VSL_CD = SUBSTR(@[vvd],1,4)
							  AND B.SKD_VOY_NO = SUBSTR(@[vvd],5,4)
							  AND B.SKD_DIR_CD = SUBSTR(@[vvd],9,1)
					#end
					#if (${pol_cd} != '')
                              AND B.POL_CD = @[pol_cd]
					#end
					#if (${pod_cd} != '')
                              AND B.POD_CD = @[pod_cd]
					#end
					#if (${ctrt_tp_cd} == 'S/C' && ${ctrt_no} != '')
                              AND B.SC_NO = @[ctrt_no]
					#end
					#if (${ctrt_tp_cd} == 'RFA' && ${ctrt_no} != '')
                              AND B.RFA_NO = @[ctrt_no]
					#end
					#if (${ctrt_tp_cd} == 'TAA' && ${ctrt_no} != '')
                              AND B.TAA_NO = @[ctrt_no]
					#end
                    #if (${bkg_ofc_cd} != '')          
                              AND B.BKG_OFC_CD = @[bkg_ofc_cd]
					#end
    #if (${opt_tp} == 'D' && ${period} == 'B' && (${cust_cnt_cd} != '' || ${cust_grp_id} != ''))
                              
                              AND EXISTS    (SELECT 'X'
                                               FROM BKG_CUSTOMER BC, MDM_CUSTOMER MC
                                               WHERE BC.BKG_NO = B.BKG_NO
                                               AND BC.BKG_CUST_TP_CD = NVL(@[cust_tp_cd], BC.BKG_CUST_TP_CD)
                                               AND BC.CUST_CNT_CD = NVL(@[cust_cnt_cd], BC.CUST_CNT_CD)
                                               AND BC.CUST_SEQ = NVL(@[cust_seq], BC.CUST_SEQ)
                                               AND BC.BKG_CUST_TP_CD IN (${cust_grp_tp})
                                               AND BC.CUST_CNT_CD = MC.CUST_CNT_CD
                                               AND BC.CUST_SEQ = MC.CUST_SEQ
                                               AND MC.CUST_GRP_ID = NVL(@[cust_grp_id], MC.CUST_GRP_ID)
                                               AND MC.DELT_FLG = 'N'
                                               )
    #end
                          ) T, BKG_XTER_RQST_MST X
                    WHERE X.BKG_NO = T.BKG_NO
#if (${opt_tp} == 'D' && ${period} == 'R')
                      AND X.RQST_DT BETWEEN TO_DATE(@[fm_dt],'YYYY-MM-DD') AND TO_DATE(@[to_dt],'YYYY-MM-DD')+0.99999
#end
                      AND X.DOC_TP_CD = T.DOC_TP_CD
                      AND NVL(X.XTER_BL_TP_CD,'X') <> 'H'
                      AND NVL(X.SNACCS_MSG_TP_CD,'X') NOT IN ('SAT050', 'SAT054')
                      AND GLOBALDATE_PKG.TIME_CONV_FNC('KRPUS', X.CRE_DT,T.POR_CD  ) < T.UPLD_DT
                      AND GLOBALDATE_PKG.TIME_CONV_FNC('KRPUS', X.CRE_DT,T.POR_CD  ) >= NVL(T.BEF_UPLD_DT, GLOBALDATE_PKG.TIME_CONV_FNC('KRPUS', X.CRE_DT,T.POR_CD  )) 
                    )U, BKG_DOC_PERF_OFC O, BKG_OFC_LVL_V V
            WHERE U.UPLD_RANK = 1
              AND U.RQST_RANK = 1
              AND U.BKG_OFC_CD = DECODE(SUBSTR(O.POR_CD,1,2),'JP',U.BKG_OFC_CD,O.BKG_OFC_CD)
              AND U.POR_CD = DECODE(O.POR_CD,'*',U.POR_CD,O.POR_CD)
              AND U.BKG_OFC_CD = V.OFC_CD
#if (${rhq_cd} != '')
              AND DECODE('B', @[doc_tp_cd], V.REGION, O.RGN_OFC_CD) = @[rhq_cd]
#end
#if (${gso_cd} != '')
              AND DECODE('B', @[doc_tp_cd], V.GSO, O.GSO_OFC_CD) = @[gso_cd]
#end
            )
    WHERE UPLD_TIME > 0 
    GROUP BY ROLLUP(RHQ_CD, BKG_OFC_CD, GSO_CD)
    )
WHERE (GSO_CD IS NOT NULL AND BKG_OFC_CD IS NOT NULL) 
OR RHQ_CD = 'TTL'			]]></sql>
			<params>
				<param name="doc_tp_cd" type="12" value="" out="N"/>
				<param name="fm_dt" type="12" value="" out="N"/>
				<param name="to_dt" type="12" value="" out="N"/>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="ctrt_no" type="12" value="" out="N"/>
				<param name="bkg_ofc_cd" type="12" value="" out="N"/>
				<param name="cust_tp_cd" type="12" value="" out="N"/>
				<param name="cust_cnt_cd" type="12" value="" out="N"/>
				<param name="cust_seq" type="12" value="" out="N"/>
				<param name="cust_grp_id" type="12" value="" out="N"/>
				<param name="rhq_cd" type="12" value="" out="N"/>
				<param name="gso_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
