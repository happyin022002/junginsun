<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="SCProposalMainDBDAORsltPropMnPrintAuthInfoVORSQL">
			<desc><![CDATA[S/C 다운로드 보안 강화 (다운로드 버튼 접근 제한)
* 2015.08.23 최성환 [CHM-201537109] Split19-[그룹사 표준 코드 시행] HJS 프로그램 대응 및 데이타 마이그레이션 작업 요청
* 2015.09.21 최성환 [CHM-201537786] SC 다운로드 보안 강화_1차 보완
* 2015.01.05 [CHM-201639660] SELCMR로 변경 Requested by SELCMR/Pilkyung Jun]]></desc>
			<sql><![CDATA[
WITH INPUT_PARAMS AS (
    SELECT MN.PROP_NO
         , MN.AMDT_SEQ AMDT_SEQ
    FROM PRI_SP_MN MN
       , PRI_SP_HDR HDR
    WHERE 1=1
#if (${sc_no} != '')
    AND   HDR.SC_NO = @[sc_no]
    AND   MN.PROP_NO = HDR.PROP_NO
#else
    AND   MN.PROP_NO = @[prop_no]
    AND   HDR.PROP_NO = MN.PROP_NO
#end
#if (${prc_mst_prop_tp_cd} == '')
    AND   HDR.PRC_MST_PROP_TP_CD = 'P'
#end
	AND   MN.AMDT_SEQ = @[amdt_seq]
)
SELECT  
    HDR.SC_NO, 
    HDR.PRC_MST_PROP_TP_CD,
    MN.PROP_NO, 
    MN.AMDT_SEQ, 
    MN.AMDT_SEQ-1 PRE_AMDT_SEQ,
    CASE WHEN DUR.CTRT_EFF_DT = TO_DATE('99991231','YYYYMMDD') AND DUR.CTRT_EXP_DT = TO_DATE('99991231','YYYYMMDD')
         THEN ''
         ELSE TO_CHAR(DUR.CTRT_EFF_DT, 'YYYYMMDD')
    END CTRT_EFF_DT,
    CASE WHEN DUR.CTRT_EFF_DT = TO_DATE('99991231','YYYYMMDD') AND DUR.CTRT_EXP_DT = TO_DATE('99991231','YYYYMMDD')
         THEN ''
         ELSE TO_CHAR(DUR.CTRT_EXP_DT, 'YYYYMMDD')
    END CTRT_EXP_DT,
    CASE WHEN MN.EFF_DT = TO_DATE('99991231','YYYYMMDD') AND MN.EXP_DT = TO_DATE('99991231','YYYYMMDD')
         THEN ''
         ELSE TO_CHAR(MN.EFF_DT, 'YYYYMMDD')
    END EFF_DT,
    CASE WHEN MN.EFF_DT = TO_DATE('99991231','YYYYMMDD') AND MN.EXP_DT = TO_DATE('99991231','YYYYMMDD')
         THEN ''
         ELSE TO_CHAR(MN.EXP_DT, 'YYYYMMDD')
    END EXP_DT,
    NVL((SELECT CASE WHEN MN.EFF_DT <= N.EXP_DT THEN TO_CHAR(MN.EFF_DT - 1,'YYYYMMDD')
                ELSE TO_CHAR(N.EXP_DT,'YYYYMMDD')
                END AS EXP_DT
          FROM PRI_SP_MN N
         WHERE PROP_NO = MN.PROP_NO AND AMDT_SEQ = MN.AMDT_SEQ-1 
       ), TO_CHAR (MN.EFF_DT - 1, 'YYYYMMDD')) PRE_EXP_DT,
    NVL((    
    SELECT CASE WHEN MN.EFF_DT <= N.EXP_DT THEN 'Y'
           ELSE 'N'
           END AS EXP_DT
    FROM PRI_SP_MN N
    WHERE PROP_NO = MN.PROP_NO AND AMDT_SEQ = MN.AMDT_SEQ-1
    ),'N') DUR_DUP_FLG,
    MN.RF_FLG RF_FLG, 
    MN.GAMT_FLG GAMT_FLG, 
    MN.PROP_STS_CD, 
    STS_CD.INTG_CD_VAL_DP_DESC PROP_STS,
    MN.PROP_OFC_CD,  
    MN.PROP_SREP_CD, 
    SLS_REP1.SREP_NM PROP_SREP_NM,
    MN.PROP_APRO_OFC_CD, 
    MN.PROP_APRO_DT, 
    TO_CHAR(MN.CRE_DT,'YYYYMMDD') CRE_DT,
    TO_CHAR(MN.FILE_DT,'YYYYMMDD') FILE_DT,
    PTY.CUST_CNT_CD CUST_CNT_CD,     
    PTY.CUST_SEQ CUST_SEQ, 
    PTY.CTRT_PTY_NM  CTRT_PTY_NM ,
    PTY.CTRT_CUST_VAL_SGM_CD,
    PTY.PRC_PROG_STS_CD PTY_PROG_STS_CD,
    SGM1.INTG_CD_VAL_DP_DESC CTRT_CUST_VAL_SGM,
    CUST_TP.PRC_CTRT_CUST_TP_CD PRC_CTRT_CUST_TP_CD,
    PTY.CTRT_CUST_SLS_OFC_CD, 
    PTY.CTRT_CUST_SREP_CD, 
    SLS_REP2.SREP_NM CTRT_CUST_SREP_NM,
    MN.REAL_CUST_CNT_CD, 
    MN.REAL_CUST_SEQ, 
    CUST.CUST_LGL_ENG_NM REAL_CUST_NM,
    MN.REAL_CUST_VAL_SGM_CD,
    SGM2.INTG_CD_VAL_DP_DESC REAL_CUST_VAL_SGM,
    MN.REAL_CUST_TP_CD, 
    MN.REAL_CUST_SLS_OFC_CD, 
    MN.REAL_CUST_SREP_CD, 
    SLS_REP3.SREP_NM REAL_CUST_SREP_NM,
    CASE MN.PROP_STS_CD 
        WHEN 'A' THEN MQC.FNL_MQC_QTY
        WHEN 'F' THEN MQC.FNL_MQC_QTY
    ELSE                        
        MQC.PROP_MQC_QTY
    END PROP_MQC_QTY,    
    MQC.CNTR_LOD_UT_CD, 
    UT.INTG_CD_VAL_DP_DESC UNIT,
    MN.SLS_LD_NO, 
    MN.BLPL_HDR_SEQ,
    PTY.PRC_CTRT_PTY_TP_CD,
    PTY.CTRT_PTY_ADDR,
    PTY.CTRT_PTY_SGN_NM,
    PTY.CTRT_PTY_SGN_TIT_NM,
    DECODE(MN.PROP_SREP_CD,@[srep_cd],'Y','N') REQ_USR_FLG,
    DECODE (USR.USR_CNT, 0, 'N', DECODE(SIGN(AUTH.CNT2),1,'Y','N')) APRO_USR_FLG,
    DECODE (USR_MN.USR_CNT_MN, 0, 'N', DECODE(SIGN(AUTH.CNT2),1,'Y','N')) ALL_USR_FLG,
    --DECODE(USR.USR_CNT, 0,'N', DECODE (SCP_MN.CNT1, AUTH.CNT2, 'Y', 'N')) ALL_USR_FLG_OLD,
  CASE UPPER(M.OTI_ORZ_NO) WHEN 'N/A' THEN ''
                WHEN 'NONE' THEN ''
  ELSE TRIM(M.OTI_ORZ_NO)
  END OTI_NO,
  M.NVOCC_BD_ST_EFF_DT OTI_EFF_DT,
  M.NVOCC_BD_END_EFF_DT OTI_EXP_DT,
  M.NVOCC_BD_AMT OTI_AMT,
  CASE UPPER(M.NVOCC_LIC_NO) WHEN 'N/A' THEN ''
                 WHEN 'NONE' THEN ''
  ELSE TRIM(M.NVOCC_LIC_NO)
  END OTI_LIC_NO,
  PROG_USR.PROG_USR_ID PROP_APRO_STAFF_ID,
  PROG_USR.USR_NM PROP_APRO_STAFF,
  PROG_USR.PROG_OFC_CD LST_PROG_APRO_OFC_CD,
  PRS_CRNT_CM_AMT,
  PRS_ESTM_CM_AMT,
  MN.CONV_CFM_FLG,
  (SELECT CONV_CFM_FLG 
   FROM PRI_SP_MN 
   WHERE PROP_NO = MN.PROP_NO 
   AND AMDT_SEQ + 1 = MN.AMDT_SEQ) N_CONV_CFM_FLG,
  MN.LGCY_IF_FLG,
  (
  SELECT   'Y'
  FROM     PRI_SP_SCP_MN SCP,
         INPUT_PARAMS HDR
  WHERE    SCP.PROP_NO = HDR.PROP_NO
    AND    SCP.AMDT_SEQ = HDR.AMDT_SEQ
    AND EXISTS (SELECT   SVC_SCP_CD
                 FROM     PRI_SVC_SCP_PPT_MAPG
                 WHERE    SVC_SCP_PPT_CD = 'UFIL'
                 AND SCP.SVC_SCP_CD = SVC_SCP_CD)
  AND ROWNUM = 1
  ) OTI_MAP,
  (DECODE((SELECT MIN(AMDT_SEQ) FROM PRI_SP_MN WHERE PROP_NO = MN.PROP_NO AND LGCY_IF_FLG = 'N'),MN.AMDT_SEQ,'Y','N')) N1ST_IF_FLG,
  TO_CHAR(MN.UPD_DT,'YYYYMMDD-HH24MISS') UPD_DT
-- [CHM-201537786] SC 다운로드 보안 강화_1차 보완 START
, 
(
 SELECT C.USR_ID
   FROM PRI_SP_MN A
      , MDM_SLS_REP B
      , COM_USER C
 WHERE A.PROP_SREP_CD = B.SREP_CD
   AND B.EMPE_CD = C.USR_ID
   AND A.PROP_NO =  MN.PROP_NO
   AND A.AMDT_SEQ = ( SELECT MAX(AMDT_SEQ) FROM PRI_SP_MN WHERE PROP_NO = MN.PROP_NO )  
   AND ROWNUM = 1 
) AS MAX_PROP_USR_ID
-- [CHM-201537786] SC 다운로드 보안 강화_1차 보완 END

FROM   PRI_SP_MN MN
     , PRI_SP_HDR HDR
     , PRI_SP_DUR DUR
     , PRI_SP_CTRT_PTY PTY
     , PRI_SP_CTRT_CUST_TP CUST_TP
     , PRI_SP_MQC MQC
     , MDM_CUSTOMER CUST
     , COM_INTG_CD_DTL STS_CD
     , COM_INTG_CD_DTL UT      
     , COM_INTG_CD_DTL SGM1
     , COM_INTG_CD_DTL SGM2    
     , MDM_SLS_REP SLS_REP1
     , MDM_SLS_REP SLS_REP2
     , MDM_SLS_REP SLS_REP3
     , INPUT_PARAMS INP
     , MDM_CUSTOMER M
     ,(SELECT B.PROP_NO,B.AMDT_SEQ,
               COUNT(A.SVC_SCP_CD) CNT2 
       FROM   PRI_AUTHORIZATION A, 
               PRI_SP_SCP_MN B,
        INPUT_PARAMS HDR 
       WHERE 
           A.SVC_SCP_CD        = B.SVC_SCP_CD
       AND A.USR_ID            = @[usr_id]
       AND A.PRC_CTRT_TP_CD    = 'S'
     AND A.EXP_DT > SYSDATE
     AND HDR.PROP_NO = B.PROP_NO
       GROUP BY B.PROP_NO,B.AMDT_SEQ
      ) AUTH
  ,(
  SELECT COUNT (*) USR_CNT
  FROM   DUAL
  WHERE  
#if (${rhq_yn} == 'Y')
      @[rhq_ofc_cd] IN (
#else
      @[ofc_cd] IN (
#end
        SELECT MN.PROP_APRO_OFC_CD OFC_CD
        FROM   PRI_SP_MN MN, INPUT_PARAMS INP
        WHERE MN.PROP_NO = INP.PROP_NO
        AND MN.AMDT_SEQ = INP.AMDT_SEQ
        UNION ALL
        SELECT MN.PROP_SCP_APRO_OFC_CD
        FROM   PRI_SP_SCP_MN MN, INPUT_PARAMS INP
        WHERE MN.PROP_NO = INP.PROP_NO
        AND MN.AMDT_SEQ = INP.AMDT_SEQ  
           -- 현재 SC에 SPECIAL CARGO가 하나라도 섞에 있다면 SELCMR OFFICE도 APPROVAL OFFICE의 권한을 갖는다.
        UNION ALL
        SELECT 'SELCMR' -- [CHM-201639660] SELCMR로 변경 Requested by SELCMR/Pilkyung Jun
        FROM   PRI_SP_SCP_RT    SCP_RT, INPUT_PARAMS INP
        WHERE SCP_RT.PROP_NO = INP.PROP_NO
        AND SCP_RT.AMDT_SEQ = INP.AMDT_SEQ  
        AND SCP_RT.PRC_CGO_TP_CD IN ('AK','DG','RF')
        AND ROWNUM = 1
    )                
  )USR 
  ,(
  SELECT COUNT (*) USR_CNT_MN
  FROM   DUAL
  WHERE  
#if (${rhq_yn} == 'Y')
      @[rhq_ofc_cd] IN (
#else
      @[ofc_cd] IN (
#end
        SELECT MN.PROP_APRO_OFC_CD OFC_CD
        FROM   PRI_SP_MN MN, INPUT_PARAMS INP
        WHERE MN.PROP_NO = INP.PROP_NO
        AND MN.AMDT_SEQ = INP.AMDT_SEQ
    )                
  )USR_MN
,(
  SELECT A.PROP_NO
      ,A.AMDT_SEQ
      ,A.PROP_STS_CD
      ,A.PROG_USR_ID
    	,A.PROG_OFC_CD
      ,B.USR_NM
  FROM   PRI_SP_PROG A
      ,COM_USER B
  WHERE  A.PROG_USR_ID = B.USR_ID
  AND    PROP_STS_CD = 'A'
  AND    USE_FLG = 'Y'
  AND    PROP_PROG_SEQ =
            (SELECT /*+ INDEX_DESC(B XPKPRI_SP_PROG)*/ PROP_PROG_SEQ
             FROM  PRI_SP_PROG B
             WHERE PROP_NO     = A.PROP_NO
             AND   AMDT_SEQ    = A.AMDT_SEQ
             AND   PROP_STS_CD = A.PROP_STS_CD
             AND   ROWNUM = 1)   
) PROG_USR
,(
  SELECT ROUND(
     SUM(
         CASE
         WHEN SS.AMDT_SEQ = 0 THEN NULL
         ELSE SS.PRS_CRNT_CM_AMT
         END
         )) PRS_CRNT_CM_AMT   ,
         ROUND(
     SUM(
         CASE
       WHEN SS.AMDT_SEQ = 0 THEN SS.PRS_ESTM_CM_AMT
       ELSE SS.PRS_RMN_CM_AMT
       END
       )) PRS_ESTM_CM_AMT
FROM  PRI_SP_SCP_MN SS
   ,INPUT_PARAMS INP
WHERE INP.PROP_NO = SS.PROP_NO   
AND   INP.AMDT_SEQ = SS.AMDT_SEQ
)PRS_CM
WHERE
    MN.PROP_NO                    = INP.PROP_NO
AND MN.AMDT_SEQ                   = INP.AMDT_SEQ
AND HDR.PROP_NO                   = MN.PROP_NO
AND DUR.PROP_NO                   = MN.PROP_NO
AND DUR.AMDT_SEQ                  = MN.AMDT_SEQ
AND PTY.PROP_NO                   = MN.PROP_NO
AND PTY.AMDT_SEQ                  = MN.AMDT_SEQ
AND PTY.PRC_CTRT_PTY_TP_CD        = 'C'
AND PTY.CUST_CNT_CD               = M.CUST_CNT_CD
AND PTY.CUST_SEQ                  = M.CUST_SEQ
AND M.CNTR_DIV_FLG = 'Y'
AND CUST_TP.PROP_NO(+)            = PTY.PROP_NO
AND CUST_TP.AMDT_SEQ(+)           = PTY.AMDT_SEQ
AND CUST_TP.PRC_CTRT_PTY_TP_CD(+) = PTY.PRC_CTRT_PTY_TP_CD
AND SLS_REP1.SREP_CD(+)           = MN.PROP_SREP_CD
AND SLS_REP2.SREP_CD(+)           = PTY.CTRT_CUST_SREP_CD
AND SLS_REP3.SREP_CD(+)           = MN.REAL_CUST_SREP_CD
AND CUST.CUST_CNT_CD(+)           = MN.REAL_CUST_CNT_CD
AND CUST.CUST_SEQ(+)              = MN.REAL_CUST_SEQ 
AND CUST.CNTR_DIV_FLG(+) = 'Y' 
AND STS_CD.INTG_CD_ID             = 'CD01722'
AND STS_CD.INTG_CD_VAL_CTNT       = MN.PROP_STS_CD
AND MQC.PROP_NO                   = MN.PROP_NO
AND MQC.AMDT_SEQ                  = MN.AMDT_SEQ
AND UT.INTG_CD_ID                 = 'CD00897'
AND UT.INTG_CD_VAL_CTNT           = MQC.CNTR_LOD_UT_CD
AND SGM1.INTG_CD_ID(+)            = 'CD00698'
AND SGM1.INTG_CD_VAL_CTNT(+)      = PTY.CTRT_CUST_VAL_SGM_CD
AND SGM2.INTG_CD_ID(+)            = 'CD00698'
AND SGM2.INTG_CD_VAL_CTNT(+)      = MN.REAL_CUST_VAL_SGM_CD
AND AUTH.PROP_NO(+)               = INP.PROP_NO
AND AUTH.AMDT_SEQ(+)              = INP.AMDT_SEQ
AND MN.PROP_NO                    = PROG_USR.PROP_NO(+)
AND MN.AMDT_SEQ                   = PROG_USR.AMDT_SEQ(+)			]]></sql>
			<params>
				<param name="sc_no" type="12" value="SEL140114" out="N"/>
				<param name="prop_no" type="12" value="" out="N"/>
				<param name="amdt_seq" type="12" value="4" out="N"/>
				<param name="srep_cd" type="12" value="" out="N"/>
				<param name="usr_id" type="12" value="" out="N"/>
				<param name="rhq_ofc_cd" type="12" value="" out="N"/>
				<param name="ofc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
