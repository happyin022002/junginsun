<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="FFCmpnApprovalDBDAOSearchFFCmpnApprovalExcelDownRSQL">
			<desc><![CDATA[SearchFFCmpnApprovalExcelDown]]></desc>
			<sql><![CDATA[
SELECT
A.BKG_FF_CNT_CD||TO_CHAR(A.BKG_FF_SEQ,'FM000000')     AS FF_CNT_SEQ,
TO_CHAR(A.VNDR_SEQ,'FM000000')                AS VNDR_SEQ,
B.CUST_LGL_ENG_NM                             AS CUST_LGL_ENG_NM,
'' BKG_NO,
'' BL_NO,
COUNT(*) AS TOT_CNT,
SUM(A.IF_AMT) AS TOT_AMT,
A.AP_OFC_CD,
A.CSR_NO,
TO_CHAR(A.IF_DT,'YYYYMMDD') AS IF_DT,
DECODE(D.IF_FLG,'Y','Success',D.IF_ERR_RSN) AS IF_RSN,
DECODE(D.RCV_ERR_FLG,'Y','Success',D.RCV_ERR_RSN) AS RCV_RSN,
D.IF_FLG AS IF_FLG,
D.RCV_ERR_FLG AS RCV_FLG,
D.PAY_AMT,
D.PAY_DT,
D.FTU_USE_CTNT1,
D.PAY_MZD_LU_CD
FROM ACM_FF_CMPN A,
MDM_CUSTOMER B,
ACM_AGN_BKG_INFO C,
AP_INV_HDR D,
MDM_VENDOR F	
WHERE A.BKG_FF_CNT_CD = B.CUST_CNT_CD
AND A.BKG_FF_SEQ = B.CUST_SEQ
AND A.BKG_NO = C.BKG_NO
AND A.CRE_USR_ID != 'COST'
AND A.AP_OFC_CD IS NOT NULL
AND C.BL_NO IS NOT NULL
AND C.BKG_STS_CD <> 'A'	
AND A.CSR_NO = D.CSR_NO(+)
AND A.VNDR_SEQ = F.VNDR_SEQ	
#if(${if_opt} == 'CS')
       AND A.FF_CMPN_STS_CD IN ('CS', 'CM', 'CA')
#elseif(${if_opt} == 'PS')	
	   AND A.FF_CMPN_STS_CD = 'IF'
	   AND A.FF_CMPN_RMK = 'APPROVAL REQUEST!'
#elseif(${if_opt} == 'IF')	
	   AND A.FF_CMPN_STS_CD = 'IF'
	   AND A.FF_CMPN_RMK = 'Interface Success!'
#else
       AND A.FF_CMPN_STS_CD = @[if_opt]
#end	
/* 날짜 조회 조건 */	
#if(${date_div} == 'B')	
       AND C.BKG_CRE_DT	
   BETWEEN TO_DATE(REPLACE(@[date_fm],'-', ''),'YYYYMMDD')	
       AND TO_DATE(REPLACE(@[date_to],'-', ''),'YYYYMMDD')+0.99999	
#elseif(${date_div} == 'E')	
       AND A.VSL_DEP_DT	
   BETWEEN TO_DATE(REPLACE(@[date_fm],'-', ''),'YYYYMMDD')	
       AND TO_DATE(REPLACE(@[date_to],'-', ''),'YYYYMMDD')+0.99999	
#elseif(${date_div} == 'C')	
       AND A.UPD_DT	
   BETWEEN TO_DATE(REPLACE(@[date_fm],'-', ''),'YYYYMMDD')	
       AND TO_DATE(REPLACE(@[date_to],'-', ''),'YYYYMMDD')+0.99999	
#elseif(${date_div} == 'P')	
       AND A.APRO_DT	
   BETWEEN TO_DATE(REPLACE(@[date_fm],'-', ''),'YYYYMMDD')	
       AND TO_DATE(REPLACE(@[date_to],'-', ''),'YYYYMMDD')+0.99999	
#elseif(${date_div} == 'I')	
       AND A.IF_DT	
   BETWEEN TO_DATE(REPLACE(@[date_fm],'-', ''),'YYYYMMDD')	
       AND TO_DATE(REPLACE(@[date_to],'-', ''),'YYYYMMDD')+0.99999	
#end	
#if(${ff_cnt_seq} != '')	
       AND A.BKG_FF_CNT_CD = substr(@[ff_cnt_seq], 0, 2)	
       AND A.BKG_FF_SEQ    = substr(@[ff_cnt_seq], 3, 6)	
#end
#if(${bl_no} != '')
 #if(${if_opt} == 'IF')
       AND A.CSR_NO IN
         ( SELECT
                  F.CSR_NO
             FROM ACM_FF_CMPN F
            WHERE F.BKG_NO
               IN
                (     SELECT
                             E.BKG_NO        
                        FROM ACM_AGN_BKG_INFO E
                       WHERE E.BL_NO
                          IN
                           ( $bl_no
                           )
                )
         )
 #else
       AND
         ( A.BKG_FF_CNT_CD, A.BKG_FF_SEQ
         )
        IN
         (     SELECT
                      F.BKG_FF_CNT_CD,
                      F.BKG_FF_SEQ
                 FROM ACM_FF_CMPN F
                WHERE F.BKG_NO
                   IN
                    (     SELECT
                                 E.BKG_NO
                            FROM ACM_AGN_BKG_INFO E
                           WHERE E.BL_NO
                              IN
                               ( $bl_no
                               )
                    )
         )
 #end
#end
GROUP BY
A.BKG_FF_CNT_CD||TO_CHAR(A.BKG_FF_SEQ,'FM000000'),	
TO_CHAR(A.VNDR_SEQ,'FM000000'),
B.CUST_LGL_ENG_NM, A.AP_OFC_CD, A.CSR_NO,
TO_CHAR(A.IF_DT,'YYYYMMDD'),
DECODE(D.IF_FLG,'Y','Success',D.IF_ERR_RSN),
DECODE(D.RCV_ERR_FLG,'Y','Success',D.RCV_ERR_RSN),
D.IF_FLG, D.RCV_ERR_FLG,
D.PAY_AMT, D.PAY_DT, D.FTU_USE_CTNT1, D.PAY_MZD_LU_CD
UNION ALL
SELECT
A.BKG_FF_CNT_CD||TO_CHAR(A.BKG_FF_SEQ,'FM000000') AS FF_CNT_SEQ,
TO_CHAR(A.VNDR_SEQ,'FM000000') AS VNDR_SEQ,
B.CUST_LGL_ENG_NM AS CUST_LGL_ENG_NM,
A.BKG_NO,
C.BL_NO,
COUNT(*) AS TOT_CNT,
SUM(A.IF_AMT) AS TOT_AMT,
'' AS AP_OFC_CD,
A.CSR_NO AS CSR_NO,
NULL AS IF_DT,
'' AS IF_RSN,
'' AS RCV_RSN,
'' AS IF_FLG,
'' AS RCV_FLG,
NULL AS PAY_AMT,
NULL AS PAY_DT,
'' AS FTU_USE_CTNT1,
'' AS PAY_MZD_LU_CD
FROM ACM_FF_CMPN A,
MDM_CUSTOMER B,
ACM_AGN_BKG_INFO C,
AP_INV_HDR D,
MDM_VENDOR F
WHERE A.BKG_FF_CNT_CD = B.CUST_CNT_CD
AND A.BKG_FF_SEQ = B.CUST_SEQ
AND A.BKG_NO = C.BKG_NO
AND A.CRE_USR_ID != 'COST'
AND A.AP_OFC_CD IS NOT NULL
AND C.BL_NO IS NOT NULL
AND C.BKG_STS_CD <> 'A'	
AND A.CSR_NO = D.CSR_NO(+)
AND A.VNDR_SEQ = F.VNDR_SEQ	
#if(${if_opt} == 'CS')
       AND A.FF_CMPN_STS_CD IN ('CS', 'CM', 'CA')
#else
       AND A.FF_CMPN_STS_CD = @[if_opt]
#end	
/* 날짜 조회 조건 */	
#if(${date_div} == 'B')	
       AND C.BKG_CRE_DT	
   BETWEEN TO_DATE(REPLACE(@[date_fm],'-', ''),'YYYYMMDD')	
       AND TO_DATE(REPLACE(@[date_to],'-', ''),'YYYYMMDD')+0.99999	
#elseif(${date_div} == 'E')	
       AND A.VSL_DEP_DT	
   BETWEEN TO_DATE(REPLACE(@[date_fm],'-', ''),'YYYYMMDD')	
       AND TO_DATE(REPLACE(@[date_to],'-', ''),'YYYYMMDD')+0.99999	
#elseif(${date_div} == 'C')	
       AND A.UPD_DT	
   BETWEEN TO_DATE(REPLACE(@[date_fm],'-', ''),'YYYYMMDD')	
       AND TO_DATE(REPLACE(@[date_to],'-', ''),'YYYYMMDD')+0.99999	
#elseif(${date_div} == 'P')	
       AND A.APRO_DT	
   BETWEEN TO_DATE(REPLACE(@[date_fm],'-', ''),'YYYYMMDD')	
       AND TO_DATE(REPLACE(@[date_to],'-', ''),'YYYYMMDD')+0.99999	
#elseif(${date_div} == 'I')	
       AND A.IF_DT	
   BETWEEN TO_DATE(REPLACE(@[date_fm],'-', ''),'YYYYMMDD')	
       AND TO_DATE(REPLACE(@[date_to],'-', ''),'YYYYMMDD')+0.99999	
#end		
#if(${ff_cnt_seq} != '')	
       AND A.BKG_FF_CNT_CD = substr(@[ff_cnt_seq], 0, 2)	
       AND A.BKG_FF_SEQ    = substr(@[ff_cnt_seq], 3, 6)	
#end
#if(${bl_no} != '')
 #if(${if_opt} == 'IF')
       AND A.CSR_NO IN
         ( SELECT
                  F.CSR_NO
             FROM ACM_FF_CMPN F
            WHERE F.BKG_NO
               IN
                (     SELECT
                             E.BKG_NO        
                        FROM ACM_AGN_BKG_INFO E
                       WHERE E.BL_NO
                          IN
                           ( $bl_no
                           )
                )
         )
 #else
       AND
         ( A.BKG_FF_CNT_CD, A.BKG_FF_SEQ
         )
        IN
         (     SELECT
                      F.BKG_FF_CNT_CD,
                      F.BKG_FF_SEQ
                 FROM ACM_FF_CMPN F
                WHERE F.BKG_NO
                   IN
                    (     SELECT
                                 E.BKG_NO
                            FROM ACM_AGN_BKG_INFO E
                           WHERE E.BL_NO
                              IN
                               ( $bl_no
                               )
                    )
         )
 #end
#end
GROUP BY
A.BKG_FF_CNT_CD||TO_CHAR(A.BKG_FF_SEQ,'FM000000'),
TO_CHAR(A.VNDR_SEQ,'FM000000'),
B.CUST_LGL_ENG_NM, A.CSR_NO, A.BKG_NO, C.BL_NO
ORDER BY FF_CNT_SEQ, CSR_NO , BKG_NO DESC, TOT_CNT DESC			]]></sql>
			<params>
				<param name="if_opt" type="12" value="" out="N"/>
				<param name="date_fm" type="12" value="" out="N"/>
				<param name="date_to" type="12" value="" out="N"/>
				<param name="ff_cnt_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
