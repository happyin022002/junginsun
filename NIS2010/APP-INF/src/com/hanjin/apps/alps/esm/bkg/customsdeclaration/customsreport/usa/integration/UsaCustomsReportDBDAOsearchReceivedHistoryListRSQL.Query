<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="UsaCustomsReportDBDAOsearchReceivedHistoryListRSQL">
			<desc><![CDATA[RcvHistListDetailVO]]></desc>
			<sql><![CDATA[
SELECT
	 T2.CNT_CD
	,T2.IO_BND_CD
	,T2.RCV_DATE
	,T2.RCV_DT
	,T2.RCV_TM
	,T2.RCV_SEQ
	,T2.RCV_MSG_TP_ID
	,T2.VVD
	,T2.POL_CD
	,T2.POD_CD
    ,CASE WHEN NVL(MIN(T2.VPOD_CD),'X') != 'X' AND NVL(MIN(VPOD_CD_SND),'X') != 'X' THEN MIN(VPOD_CD_SND) ELSE MIN(T2.VPOD_CD) END VPOD_CD
	,T2.CSTMS_BAT_NO
	,T2.SCAC_CD
	,T2.CSTMS_RJCT_MSG
	,T2.CND_ACK_ERR_NOTE_DESC
	,CASE T2.RCV_MSG_TP_ID WHEN 'BR' THEN DECODE (SUBSTR(MAX(DTL.MSG_DESC),12,1), 'A', 'N', 'Y')
                           ELSE DECODE (MAX(DTL.MSG_DESC), NULL, 'N', 'Y')
     END AS RJCT_FLG
	,DECODE(T2.RCV_MSG_TP_ID, 'MR', '', T2.BL_NO) BL_NO
	,SUBSTR (MAX (DTL.MSG_DESC), 40) REASON
	, T2.RNUM
	, T2.TOTAL
FROM (
		    SELECT   *
		    FROM (
                
                SELECT T.*
                     ,ROW_NUMBER() OVER(ORDER BY T.RCV_DT DESC, T.RCV_TM DESC, T.RCV_SEQ) AS RNUM
                     ,COUNT(*) OVER() AS TOTAL

                FROM (
            
        #if (${bl_no} != '') 
                        SELECT   
                                                LOG.CNT_CD
                                                ,LOG.IO_BND_CD
                                                ,LOG.RCV_DT AS RCV_DATE
                                                ,TO_CHAR(LOG.RCV_DT, 'YYYYMMDD') AS RCV_DT
                                                ,TO_CHAR(LOG.RCV_DT, 'HH24MISS') AS RCV_TM
                                                ,LOG.RCV_SEQ
                                                ,LOG.RCV_MSG_TP_ID
                                                ,LOG.VSL_CD || LOG.SKD_VOY_NO || LOG.SKD_DIR_CD AS VVD
                                                ,LOG.POL_CD
                                                ,LOG.POD_CD
                                                ,MIN(BL.CSTMS_POD_CD) VPOD_CD
                                                ,MIN((SELECT POD_CD FROM BKG_CSTMS_ADV_SND_LOG SND_LOG WHERE CNT_CD = 'US' AND IO_BND_CD  = NVL(@[io_bnd_cd], 'I') AND LOG.CRR_BAT_NO = SND_LOG.CRR_BAT_NO)) VPOD_CD_SND
                                                ,LOG.CSTMS_BAT_NO
                                                ,LOG.SCAC_CD
                                                ,LOG.CSTMS_RJCT_MSG
                                                ,LOG.CND_ACK_ERR_NOTE_DESC
                                                ,LOG.BL_NO AS BL_NO
                                                ,MIN((SELECT SLS_OFC_CD FROM MDM_LOCATION X WHERE X.LOC_CD = LOG.POL_CD)) POL_LOC_CD
                                                                                                
                        FROM     
                                BKG_CSTMS_ADV_RCV_LOG LOG
                                ,BKG_CSTMS_ADV_BL BL
                        WHERE   1=1
                        AND     LOG.CNT_CD     = BL.CNT_CD(+)
                        AND     LOG.BL_NO      = BL.BL_NO(+) 
                        AND     LOG.CNT_CD     = 'US'
                
                        #if (${rcv_msg_tp_id} != '' && ${rcv_msg_tp_id} != 'AL') 
                        AND		LOG.RCV_MSG_TP_ID = @[rcv_msg_tp_id]
                        #end
                
                        #if (${vsl_cd} != '') 
                        AND     LOG.VSL_CD     = @[vsl_cd]
                        AND     LOG.SKD_VOY_NO = @[skd_voy_no]
                        AND     LOG.SKD_DIR_CD = @[skd_dir_cd]
                        #end
                        #if (${pol_cd} != '') 
                        AND		LOG.POL_CD = @[pol_cd]
                        #end
                        #if (${pod_cd} != '') 
                        AND		LOG.POD_CD = @[pod_cd]
                        #end
                        #if (${cstms_bat_no} != '') 
                        AND		LOG.CSTMS_BAT_NO = @[cstms_bat_no]
                        #end
                        #if (${scac_cd} != '') 
                        AND		LOG.SCAC_CD = @[scac_cd]
                        #end

                        #if (${bl_no} != '') 
                        AND		LOG.BL_NO = @[bl_no]
                        #end
                        AND     LOG.IO_BND_CD  = NVL(@[io_bnd_cd], 'I')
                        #if (${fromd} != '') 
                        AND 	LOG.RCV_DT >= TO_DATE(REPLACE(REPLACE(@[fromd], '-', ''), '/', '') ||' '|| REPLACE(REPLACE(@[fromt], ':', ''), '-',''),'YYYYMMDD HH24MI')
                        #else
                        AND 	LOG.RCV_DT >= TO_DATE('19000101000000','YYYYMMDDHH24MISS')
                        #end 
                        #if (${tod} != '') 
                        AND 	LOG.RCV_DT <= TO_DATE(REPLACE(REPLACE(@[tod], '-', ''), '/', '') ||' '|| REPLACE(REPLACE(@[tot], ':', ''), '-',''),'YYYYMMDD HH24MI')
                        #else
                        AND 	LOG.RCV_DT <= TO_DATE('99991231235959','YYYYMMDDHH24MISS')
                        #end  
                        GROUP BY    
                             LOG.CNT_CD
                            ,LOG.IO_BND_CD
                            ,LOG.RCV_DT
                            ,TO_CHAR(LOG.RCV_DT, 'YYYYMMDD')
                            ,TO_CHAR(LOG.RCV_DT, 'HH24MISS')
                            ,LOG.RCV_SEQ
                            ,LOG.RCV_MSG_TP_ID
                            ,LOG.VSL_CD || LOG.SKD_VOY_NO || LOG.SKD_DIR_CD
                            ,LOG.POL_CD
                            ,LOG.POD_CD
                            ,LOG.CSTMS_BAT_NO
                            ,LOG.SCAC_CD
                            ,LOG.CSTMS_RJCT_MSG
                            ,LOG.CND_ACK_ERR_NOTE_DESC
                            ,LOG.BL_NO 
                        UNION
        #end
                        SELECT   
                                                LOG.CNT_CD
                                                ,LOG.IO_BND_CD
                                                ,LOG.RCV_DT AS RCV_DATE
                                                ,TO_CHAR(LOG.RCV_DT, 'YYYYMMDD') AS RCV_DT
                                                ,TO_CHAR(LOG.RCV_DT, 'HH24MISS') AS RCV_TM
                                                ,LOG.RCV_SEQ
                                                ,LOG.RCV_MSG_TP_ID
                                                ,LOG.VSL_CD || LOG.SKD_VOY_NO || LOG.SKD_DIR_CD AS VVD
                                                ,LOG.POL_CD
                                                ,LOG.POD_CD
                                                ,MIN(BL.CSTMS_POD_CD) VPOD_CD
                                                ,MIN((SELECT POD_CD FROM BKG_CSTMS_ADV_SND_LOG SND_LOG WHERE CNT_CD = 'US' AND IO_BND_CD  = NVL(@[io_bnd_cd], 'I') AND LOG.CRR_BAT_NO = SND_LOG.CRR_BAT_NO)) VPOD_CD_SND
                                                ,LOG.CSTMS_BAT_NO
                                                ,LOG.SCAC_CD
                                                ,LOG.CSTMS_RJCT_MSG
                                                ,LOG.CND_ACK_ERR_NOTE_DESC
                                                ,MAX(EDI.BL_NO) BL_NO
                                                ,MIN((SELECT SLS_OFC_CD FROM MDM_LOCATION X WHERE X.LOC_CD = LOG.POL_CD)) POL_LOC_CD
                        FROM     
                                BKG_CSTMS_ADV_RCV_LOG LOG
                                ,BKG_CSTMS_ADV_EDI_BL_RSPN EDI
                                ,BKG_CSTMS_ADV_BL BL
                        WHERE   1=1
                        AND     LOG.CNT_CD     = EDI.CNT_CD(+)
                        AND     LOG.CRR_BAT_NO = EDI.CRR_BAT_NO(+)
                        AND     EDI.CNT_CD     = BL.CNT_CD(+)
                        AND     EDI.BL_NO      = BL.BL_NO(+)
                        AND     LOG.CNT_CD     = 'US'
                
                        #if (${rcv_msg_tp_id} != '' && ${rcv_msg_tp_id} != 'AL') 
                        AND		LOG.RCV_MSG_TP_ID = @[rcv_msg_tp_id]
                        #end
                
                        #if (${vsl_cd} != '') 
                        AND     LOG.VSL_CD     = @[vsl_cd]
                        AND     LOG.SKD_VOY_NO = @[skd_voy_no]
                        AND     LOG.SKD_DIR_CD = @[skd_dir_cd]
                        #end
                        #if (${pol_cd} != '') 
                        AND		LOG.POL_CD = @[pol_cd]
                        #end
                        #if (${pod_cd} != '') 
                        AND		LOG.POD_CD = @[pod_cd]
                        #end
                        #if (${cstms_bat_no} != '') 
                        AND		LOG.CSTMS_BAT_NO = @[cstms_bat_no]
                        #end
                        #if (${scac_cd} != '') 
                        AND		LOG.SCAC_CD = @[scac_cd]
                        #end

                        #if (${bl_no} != '') 
                        AND		EDI.BL_NO = @[bl_no]
                        #end
                        AND     LOG.IO_BND_CD  = NVL(@[io_bnd_cd], 'I')
                        #if (${fromd} != '') 
                        AND 	LOG.RCV_DT >= TO_DATE(REPLACE(REPLACE(@[fromd], '-', ''), '/', '') ||' '|| REPLACE(REPLACE(@[fromt], ':', ''), '-',''),'YYYYMMDD HH24MI')
                        #else
                        AND 	LOG.RCV_DT >= TO_DATE('19000101000000','YYYYMMDDHH24MISS')
                        #end 
                        #if (${tod} != '') 
                        AND 	LOG.RCV_DT <= TO_DATE(REPLACE(REPLACE(@[tod], '-', ''), '/', '') ||' '|| REPLACE(REPLACE(@[tot], ':', ''), '-',''),'YYYYMMDD HH24MI')
                        #else
                        AND 	LOG.RCV_DT <= TO_DATE('99991231235959','YYYYMMDDHH24MISS')
                        #end  
                        GROUP BY    
                             LOG.CNT_CD
                            ,LOG.IO_BND_CD
                            ,LOG.RCV_DT
                            ,TO_CHAR(LOG.RCV_DT, 'YYYYMMDD')
                            ,TO_CHAR(LOG.RCV_DT, 'HH24MISS')
                            ,LOG.RCV_SEQ
                            ,LOG.RCV_MSG_TP_ID
                            ,LOG.VSL_CD || LOG.SKD_VOY_NO || LOG.SKD_DIR_CD
                            ,LOG.POL_CD
                            ,LOG.POD_CD
                            ,LOG.CSTMS_BAT_NO
                            ,LOG.SCAC_CD
                            ,LOG.CSTMS_RJCT_MSG
                            ,LOG.CND_ACK_ERR_NOTE_DESC
                ) T 
			   #if (${rct_rhq_cd} != '' && ${vsl_cd} != '' ) 
			   ,(
			        SELECT OFC_CD OG_OFC_CD
			        FROM MDM_ORGANIZATION A
			        START WITH A.OFC_CD = @[rct_rhq_cd]
			        CONNECT BY PRIOR A.OFC_CD = A.PRNT_OFC_CD
			    ) OG  
			    WHERE T.POL_LOC_CD = OG.OG_OFC_CD
			    #end                 
        ) T1
        WHERE T1.RNUM BETWEEN @[start_no] AND @[end_no]
                    
	) T2
	, BKG_CSTMS_ADV_RCV_LOG_DTL DTL
	WHERE T2.CNT_CD = DTL.CNT_CD(+)
	AND T2.IO_BND_CD = DTL.IO_BND_CD(+)
	AND T2.RCV_DATE = DTL.RCV_DT(+)
	AND T2.RCV_SEQ = DTL.RCV_SEQ(+)
	AND DTL.RCV_MSG_DTL_SEQ(+) > 0
	AND DTL.MSG_DESC(+) LIKE CASE T2.RCV_MSG_TP_ID WHEN 'BR' THEN 'ACK_RESULT%'
                                                   ELSE 'W01%'
                             END                                                    
	
	GROUP BY
	   T2.CNT_CD
		,T2.IO_BND_CD
		,T2.RCV_DATE
		,T2.RCV_DT
		,T2.RCV_TM
		,T2.RCV_SEQ
		,T2.RCV_MSG_TP_ID
		,T2.VVD
		,T2.POL_CD
		,T2.POD_CD
		,T2.CSTMS_BAT_NO
		,T2.SCAC_CD
		,T2.CSTMS_RJCT_MSG
		,T2.CND_ACK_ERR_NOTE_DESC
		,DECODE(T2.RCV_MSG_TP_ID, 'MR', '', T2.BL_NO)
		,T2.RNUM
		,T2.TOTAL
		,T2.BL_NO
	
	ORDER BY T2.RNUM			]]></sql>
			<params>
				<param name="io_bnd_cd" type="12" value="" out="N"/>
				<param name="rcv_msg_tp_id" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="cstms_bat_no" type="12" value="" out="N"/>
				<param name="scac_cd" type="12" value="" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
				<param name="fromd" type="12" value="" out="N"/>
				<param name="fromt" type="12" value="" out="N"/>
				<param name="tod" type="12" value="" out="N"/>
				<param name="tot" type="12" value="" out="N"/>
				<param name="rct_rhq_cd" type="12" value="" out="N"/>
				<param name="start_no" type="12" value="" out="N"/>
				<param name="end_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
