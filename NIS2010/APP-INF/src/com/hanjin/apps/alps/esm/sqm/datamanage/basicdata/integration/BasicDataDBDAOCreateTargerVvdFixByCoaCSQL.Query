<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BasicDataDBDAOCreateTargerVvdFixByCoaCSQL">
			<desc><![CDATA[COA 대상항차 + BSA 정보로 Target vvd data 생성
- IP 구간에 대한 BSA를 실적기반의 LOAD로 세팅
- IAS Sector sales 를 하면서 IP 구간에 대한 BSA를 0으로 원복 추가적으로 PF SVC TP를 가져오도록 변경

2015.06.15 [CHM-201536164] 주간 MAS Open에 따른 타모듈 프로그램 적용 요청
2016.04.20 CHM-201640366 Target VVD Fix 월기준 항차 생성 등 개선 CSR
2016.05.24 김용습 mas에서 vvd가져올때 연도는 sls_yrmon, 월은 cost_yrmon 기준]]></desc>
			<sql><![CDATA[
INSERT INTO SQM_QTA_TGT_VVD (
     BSE_TP_CD
    ,BSE_YR
    ,BSE_QTR_CD
    ,TRD_CD
    ,RLANE_CD
    ,DIR_CD
    ,VSL_CD
    ,SKD_VOY_NO
    ,SKD_DIR_CD
    ,BSE_MON
    ,BSE_WK
    ,SUB_TRD_CD
    ,IOC_CD
    ,FNL_BSA_CAPA
    ,DELT_FLG
    ,PF_SVC_TP_CD
	,CRE_USR_ID
	,CRE_DT
	,UPD_USR_ID
	,UPD_DT   
	) 
SELECT @[f_bse_tp_cd] 
      ,@[f_bse_yr] 
      ,@[f_bse_qtr_cd]
      ,VVD.TRD_CD
      ,VVD.RLANE_CD
      ,VVD.DIR_CD
      ,VVD.VSL_CD
      ,VVD.SKD_VOY_NO
      ,VVD.DIR_CD
      ,SUBSTR(VVD.COST_YRMON,5,6) BSE_MON
      ,VVD.COST_WK
      ,VVD.SUB_TRD_CD
      ,VVD.IOC_CD
      --,NVL(BSA.FNL_HJS_BSA_CAPA,0) FNL_HJS_BSA_CAPA
      --,MAX(NVL(BSA.FNL_HJS_BSA_CAPA,0)) OVER (PARTITION BY VVD.RLANE_CD,VVD.VSL_CD,VVD.SKD_VOY_NO,VVD.DIR_CD) FNL_HJS_BSA_CAPA
      ,CASE WHEN LANE.IAS_SCTR_FLG IS NULL THEN DECODE(VVD.SUB_TRD_CD,'IP',NVL(PFMC.LOD_QTY,0),NVL(BSA.FNL_HJS_BSA_CAPA,0)) ELSE NVL(BSA.FNL_HJS_BSA_CAPA,0) END FNL_HJS_BSA_CAPA
      ,'N'
      ,VSK.PF_SKD_TP_CD
      ,@[usr_id]
      ,SYSDATE
      ,@[usr_id]
      ,SYSDATE
  FROM MAS_MON_VVD VVD
      ,BSA_VVD_MST BSA
      ,SQM_QTA_LANE_MGMT LANE
      ,VSK_VSL_SKD VSK
      ,( SELECT TRD_CD
              ,RLANE_CD
              ,DIR_CD
              ,SUB_TRD_CD
              ,ROUND(SUM(LOD_QTY)/13,0) LOD_QTY
          FROM SQM_PERF_IF
         WHERE 1=1
           AND BSE_TP_CD   = @[f_bse_tp_cd] 
           AND BSE_YR      = @[f_bse_yr]
           AND BSE_QTR_CD  = @[f_bse_qtr_cd]
           AND SUB_TRD_CD  = 'IP'
           AND OFC_VW_CD   = 'C'
           AND SQM_LVL_CD  = '2'
           AND QTA_TGT_CD  = 'D'
         GROUP BY TRD_CD, RLANE_CD, DIR_CD,SUB_TRD_CD
        )PFMC
 WHERE 1=1
   AND SUBSTR(VVD.SLS_YRMON,0,4) = @[f_bse_yr]
   AND SUBSTR(VVD.COST_YRMON, 5) BETWEEN (CASE WHEN @[f_bse_qtr_cd] = '1Q' THEN '01' WHEN @[f_bse_qtr_cd] = '2Q' THEN '04' WHEN @[f_bse_qtr_cd] = '3Q' THEN '07' WHEN @[f_bse_qtr_cd] = '4Q' THEN '10' ELSE '01' END) 
                                              AND (CASE WHEN @[f_bse_qtr_cd] = '1Q' THEN '03' WHEN @[f_bse_qtr_cd] = '2Q' THEN '06' WHEN @[f_bse_qtr_cd] = '3Q' THEN '09' WHEN @[f_bse_qtr_cd] = '4Q' THEN '12' ELSE '12' END)
   AND VVD.TRD_CD       = BSA.TRD_CD(+)
   AND VVD.RLANE_CD     = BSA.RLANE_CD(+)
   AND VVD.VSL_CD       = BSA.VSL_CD(+)
   AND VVD.SKD_VOY_NO   = BSA.SKD_VOY_NO(+)
   AND VVD.DIR_CD       = BSA.SKD_DIR_CD(+)
   AND VVD.TRD_CD       = LANE.TRD_CD
   AND VVD.RLANE_CD     = LANE.RLANE_CD
   AND VVD.SUB_TRD_CD   = LANE.SUB_TRD_CD
   AND VVD.IOC_CD       = DECODE(VVD.RLANE_CD,'RBCCO','I',VVD.IOC_CD)
   AND VVD.DIR_CD       = NVL(LANE.LANE_DIR_CD,VVD.DIR_CD)
   AND VVD.VSL_CD       = VSK.VSL_CD
   AND VVD.SKD_VOY_NO   = VSK.SKD_VOY_NO
   AND VVD.DIR_CD       = VSK.SKD_DIR_CD
   AND VVD.SLAN_CD      = VSK.VSL_SLAN_CD   
   AND VVD.DIR_CD       = PFMC.DIR_CD(+)
   AND VVD.TRD_CD       = PFMC.TRD_CD(+)
   AND VVD.RLANE_CD     = PFMC.RLANE_CD(+)
   AND VVD.SUB_TRD_CD   = PFMC.SUB_TRD_CD(+)
   AND VVD.DELT_FLG     = 'N'
   AND LANE.SQM_ACT_FLG = 'Y'			]]></sql>
			<params>
				<param name="f_bse_tp_cd" type="12" value="" out="N"/>
				<param name="f_bse_yr" type="12" value="" out="N"/>
				<param name="f_bse_qtr_cd" type="12" value="" out="N"/>
				<param name="usr_id" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
