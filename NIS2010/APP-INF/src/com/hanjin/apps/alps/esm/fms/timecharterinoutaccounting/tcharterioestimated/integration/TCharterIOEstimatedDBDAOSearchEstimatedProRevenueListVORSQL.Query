<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TCharterIOEstimatedDBDAOSearchEstimatedProRevenueListVORSQL">
			<desc><![CDATA[   ]]></desc>
			<sql><![CDATA[
SELECT 'I' ibflag,
		@[exe_yrmon] EXE_YRMON, A.REV_YRMON, A.REV_YRMON||A.FLET_CTRT_TP_CD SUBSUMCOL,
       A.FLET_CTRT_TP_CD, A.FLET_CTRT_TP_CD,
       A.RLANE_CD, A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD||A.REV_DIR_CD VVD_CD,
       A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD,
       A.VST_DT, A.VED_DT, A.ESTM_IOC_DIV_CD,
       A.HIRE_AMT,
       SUM(A.EST_AMT) EST_AMT
FROM
			(SELECT VSL_CD, SKD_VOY_NO, SKD_DIR_CD, REV_DIR_CD, REV_YRMON,
					FLET_CTRT_NO,  MIN(HIRE_EFF_DT) HIRE_EFF_DT,MAX(HIRE_EXP_DT) HIRE_EXP_DT,
					MIN(HIRE_N1ST_AMT + HIRE_N2ND_AMT) HIRE_AMT,
					SUM(DAYS*(HIRE_N1ST_AMT + HIRE_N2ND_AMT)) EST_AMT,
         VST_DT, VED_DT, ESTM_IOC_DIV_CD, FLET_CTRT_TP_CD, RLANE_CD
          
			 FROM (
					SELECT A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD, A.REV_YRMON,
							C.FLET_CTRT_NO,
							CASE WHEN A.VST_DT >= TO_CHAR(C.EFF_DT,'YYYYMMDD') THEN TO_DATE(A.VST_DT, 'YYYYMMDD') ELSE TRUNC(C.EFF_DT) END HIRE_EFF_DT,
							CASE WHEN A.VED_DT > TO_CHAR(C.EXP_DT,'YYYYMMDD') THEN TRUNC(C.EXP_DT)-1 ELSE TO_DATE(A.VED_DT, 'YYYYMMDD') END HIRE_EXP_DT,
							CASE WHEN A.VED_DT > TO_CHAR(C.EXP_DT,'YYYYMMDD') THEN TRUNC(C.EXP_DT)-1 ELSE TO_DATE(A.VED_DT, 'YYYYMMDD') END -
							CASE WHEN A.VST_DT >= TO_CHAR(C.EFF_DT,'YYYYMMDD') THEN TO_DATE(A.VST_DT, 'YYYYMMDD') ELSE TRUNC(C.EFF_DT) END +1 DAYS,
						    CASE WHEN SUBSTR(TO_CHAR(FIRST_VALUE(C.EXP_DT) OVER(PARTITION BY C.FLET_CTRT_NO, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD ORDER BY C.EXP_DT),'YYYYMMDDHH24MISS'),9,4) = '0000' AND C.HIR_CURR_N2ND_CD IS NULL THEN
									  NVL(C.HIR_RT_N1ST_AMT/DECODE(C.HIR_CURR_N1ST_CD, 'USD', 1, (SELECT NVL(EX1.USD_LOCL_XCH_RT,1) FROM GL_MON_XCH_RT EX1
																									WHERE C.HIR_CURR_N1ST_CD = EX1.CURR_CD AND EX1.ACCT_XCH_RT_YRMON = A.REV_YRMON AND EX1.ACCT_XCH_RT_LVL = '3')),0)
								 ELSE
									  FIRST_VALUE(NVL(C.HIR_RT_N1ST_AMT/DECODE(C.HIR_CURR_N1ST_CD, 'USD', 1, (SELECT NVL(EX1.USD_LOCL_XCH_RT,1) FROM GL_MON_XCH_RT EX1
																											   WHERE C.HIR_CURR_N1ST_CD = EX1.CURR_CD AND EX1.ACCT_XCH_RT_YRMON = A.REV_YRMON AND EX1.ACCT_XCH_RT_LVL = '3')),0))
																			OVER(PARTITION BY C.FLET_CTRT_NO, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD ORDER BY C.EXP_DT DESC)
							 END HIRE_N1ST_AMT,
							CASE WHEN SUBSTR(TO_CHAR(FIRST_VALUE(C.EXP_DT) OVER(PARTITION BY C.FLET_CTRT_NO, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD ORDER BY C.EXP_DT),'YYYYMMDDHH24MISS'),9,4) = '0000' AND C.HIR_CURR_N2ND_CD IS NULL THEN
									  NVL(C.HIR_RT_N2ND_AMT/DECODE(C.HIR_CURR_N2ND_CD, 'USD', 1, (SELECT NVL(EX1.USD_LOCL_XCH_RT,1) FROM GL_MON_XCH_RT EX1
																									WHERE C.HIR_CURR_N2ND_CD = EX1.CURR_CD AND EX1.ACCT_XCH_RT_YRMON = A.REV_YRMON AND EX1.ACCT_XCH_RT_LVL = '3')),0)
								 ELSE
									  FIRST_VALUE(NVL(C.HIR_RT_N2ND_AMT/DECODE(C.HIR_CURR_N2ND_CD, 'USD', 1, (SELECT NVL(EX1.USD_LOCL_XCH_RT,1) FROM GL_MON_XCH_RT EX1
																											   WHERE C.HIR_CURR_N2ND_CD = EX1.CURR_CD AND EX1.ACCT_XCH_RT_YRMON = A.REV_YRMON AND EX1.ACCT_XCH_RT_LVL = '3')),0))
																			OVER(PARTITION BY C.FLET_CTRT_NO, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD ORDER BY C.EXP_DT DESC)
							 END HIRE_N2ND_AMT,
               A.VST_DT, A.VED_DT, A.ESTM_IOC_DIV_CD,A.FLET_CTRT_TP_CD, A.RLANE_CD
					FROM 
          
          		(SELECT DISTINCT A.REV_YRMON,
        		        B.FLET_CTRT_NO, B.FLET_CTRT_TP_CD,
        		        A.RLANE_CD, A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD||A.REV_DIR_CD VVD_CD,
        		        A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD,
        		        A.VST_DT, A.VED_DT, A.ESTM_IOC_DIV_CD
	            	FROM  
                      (SELECT *
                				FROM 	GL_ESTM_REV_VVD A
                				WHERE 	EXE_YRMON = @[exe_yrmon]
                				AND 	ESTM_VVD_TP_CD = 'PV'
                				AND 	ESTM_IOC_DIV_CD = 'OO'
                				UNION ALL
                				SELECT *
                				FROM 	GL_ESTM_REV_VVD A
                				WHERE 	EXE_YRMON = @[exe_yrmon]
                				AND 	ESTM_VVD_TP_CD = 'PV'
                				AND 	ESTM_IOC_DIV_CD <> 'OO'
                				AND		NOT (SUBSTRB(RLANE_CD, 4, 1) <> 'I' AND SUBSTRB(ESTM_IOC_DIV_CD, 1, 1) = 'I')
                				AND 	NOT EXISTS (SELECT 	NULL
                									FROM 	GL_ESTM_REV_VVD
                									WHERE	EXE_YRMON = A.EXE_YRMON
                									AND		VSL_CD = A.VSL_CD
                									AND		SKD_VOY_NO = A.SKD_VOY_NO
                									AND		SKD_DIR_CD = A.SKD_DIR_CD
                									AND		REV_DIR_CD = A.REV_DIR_CD
                									AND		ESTM_VVD_TP_CD = A.ESTM_VVD_TP_CD
                									AND		ESTM_IOC_DIV_CD = 'OO')) A,
                				(SELECT VSL_CD, FLET_CTRT_NO, FLET_CTRT_TP_CD FROM FMS_CONTRACT
										WHERE FLET_CTRT_TP_CD = 'TI' AND FLET_CTRT_TP_CD LIKE null||'%' AND FLET_CTRT_FACT_CD = 'ACT'
										UNION ALL
										SELECT FI.VSL_CD, FC.FLET_CTRT_NO, FLET_CTRT_TP_CD FROM FMS_CONTRACT FC, FMS_ID_VSL FI
										WHERE FC.FLET_CTRT_NO = FI.FLET_CTRT_NO AND FC.FLET_CTRT_TP_CD = 'TI' AND FC.FLET_CTRT_TP_CD LIKE null||'%' AND FC.FLET_CTRT_FACT_CD = 'ACT') B
                			WHERE 	A.VSL_CD = B.VSL_CD

                			) A,

      				FMS_HIRE C
					WHERE A.FLET_CTRT_NO = C.FLET_CTRT_NO
					AND 	A.VST_DT <= TO_CHAR(C.EXP_DT,'YYYYMMDD')
					AND 	A.VED_DT >= TO_CHAR(C.EFF_DT,'YYYYMMDD') 
          
           )

			GROUP BY VSL_CD, SKD_VOY_NO, SKD_DIR_CD, REV_DIR_CD, REV_YRMON, FLET_CTRT_NO,  VST_DT, VED_DT, ESTM_IOC_DIV_CD, FLET_CTRT_TP_CD, RLANE_CD
			) A

GROUP BY A.REV_YRMON,
       A.FLET_CTRT_TP_CD, A.FLET_CTRT_TP_CD,
       A.RLANE_CD,
       A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD,
       A.VST_DT, A.VED_DT, A.HIRE_AMT,  VST_DT, VED_DT, ESTM_IOC_DIV_CD, FLET_CTRT_TP_CD

ORDER BY REV_YRMON, A.FLET_CTRT_TP_CD			]]></sql>
			<params>
				<param name="exe_yrmon" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
