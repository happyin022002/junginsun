<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BlRatingDBDAOSearchGroupRatingStatusRSQL">
			<desc><![CDATA[조회한 운임으로 Group Rating 가능한 상태인지 확인]]></desc>
			<sql><![CDATA[
SELECT CNTR_TPSZ_CD, RATE_CNT
FROM (
        SELECT Q.CNTR_TPSZ_CD, Q.RCV_TERM_CD, Q.DE_TERM_CD, 
               Q.DRY_CGO_FLG, Q.AWK_CGO_FLG,  Q.DCGO_FLG, Q.RC_FLG,
               Q.BB_CGO_FLG, Q.SOC_FLG, COUNT(Q.CNTR_TPSZ_CD) RATE_CNT
        FROM ( SELECT  T.BKG_NO, T.CNTR_TPSZ_CD, 
                       T.RCV_TERM_CD, T.DE_TERM_CD, 
                       T.DRY_CGO_FLG, T.AWK_CGO_FLG, 
                       T.DCGO_FLG, T.RC_FLG,
                       T.BB_CGO_FLG, T.SOC_FLG
               FROM BKG_AUTO_RT_OCN_FRT_TMP T, PRI_RAT_UT U
               WHERE T.RAT_UT_CD = U.RAT_UT_CD
                 AND T.CHG_CD = 'OFT') R,
             ( SELECT BKG_NO, 
                      CASE WHEN CNTR_TPSZ_CD LIKE 'R%' AND DRY_CGO_FLG = 'Y' -- RD 인 경우만 예외처리  
                               THEN CNTR_TPSZ_CD  
                           ELSE NVL(EQ_SUBST_CNTR_TPSZ_CD, CNTR_TPSZ_CD)  
                           END CNTR_TPSZ_CD, 
                             RCV_TERM_CD, DE_TERM_CD, 
                      DRY_CGO_FLG, AWK_CGO_FLG, 
                      DCGO_FLG, RC_FLG,
                      BB_CGO_FLG, SOC_FLG
               FROM BKG_QTY_DTL
              WHERE BKG_NO = @[bkg_no]) Q
        WHERE Q.CNTR_TPSZ_CD = R.CNTR_TPSZ_CD
          AND Q.RCV_TERM_CD = R.RCV_TERM_CD
          AND Q.DE_TERM_CD = R.DE_TERM_CD
          AND Q.DRY_CGO_FLG = R.DRY_CGO_FLG
          AND Q.AWK_CGO_FLG = R.AWK_CGO_FLG
          AND Q.DCGO_FLG = R.DCGO_FLG
          AND Q.RC_FLG = R.RC_FLG
          AND Q.BB_CGO_FLG = R.BB_CGO_FLG
          AND Q.SOC_FLG = R.SOC_FLG
        GROUP BY Q.CNTR_TPSZ_CD, Q.RCV_TERM_CD, Q.DE_TERM_CD, 
                 Q.DRY_CGO_FLG, Q.AWK_CGO_FLG, Q.DCGO_FLG, Q.RC_FLG,
                 Q.BB_CGO_FLG, Q.SOC_FLG

        UNION ALL

        SELECT CNTR_TPSZ_CD, RCV_TERM_CD, DE_TERM_CD, 
               DRY_CGO_FLG, AWK_CGO_FLG, DCGO_FLG, RC_FLG,
               BB_CGO_FLG, SOC_FLG, COUNT(CNTR_TPSZ_CD) RATE_CNT
          FROM BKG_AUTO_RT_OCN_FRT_TMP
         WHERE RAT_UT_CD = 'BL'
         GROUP BY CNTR_TPSZ_CD, RCV_TERM_CD, DE_TERM_CD, 
                  DRY_CGO_FLG, AWK_CGO_FLG, DCGO_FLG, RC_FLG,
                  BB_CGO_FLG, SOC_FLG
      )
ORDER BY RATE_CNT DESC			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
