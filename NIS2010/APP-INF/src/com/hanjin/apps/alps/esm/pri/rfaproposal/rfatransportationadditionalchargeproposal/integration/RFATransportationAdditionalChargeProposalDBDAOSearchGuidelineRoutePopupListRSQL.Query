<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="RFATransportationAdditionalChargeProposalDBDAOSearchGuidelineRoutePopupListRSQL">
			<desc><![CDATA[RFA Proposal & Amendment Arbitrary Creation]]></desc>
			<sql><![CDATA[
WITH ADDON AS
 (SELECT B.*, A.PRC_IO_BND_CD
    FROM (SELECT SVC_SCP_CD,
                 ORG_DEST_TP_CD,
                 FDR_TRF_NO,
                 AMDT_SEQ,
                 PRC_IO_BND_CD
            FROM PRI_TRF_FDR_MN
           WHERE TO_DATE(@[eff_dt], 'YYYYMMDD') BETWEEN EFF_DT AND NVL(EXP_DT, TO_DATE('9999-12-31', 'YYYY-MM-DD'))
                 AND FIC_PROP_STS_CD = 'C') A,
         PRI_TRF_FDR_RT B
   WHERE A.SVC_SCP_CD = B.SVC_SCP_CD
         AND A.FDR_TRF_NO = B.FDR_TRF_NO
         AND A.AMDT_SEQ = B.AMDT_SEQ
     	 AND A.ORG_DEST_TP_CD = B.ORG_DEST_TP_CD
         AND A.ORG_DEST_TP_CD = @[org_dest_tp_cd]   
         AND B.SRC_INFO_CD != 'AD'),
IHC AS
 (SELECT B.*
    FROM (SELECT MN.SVC_SCP_CD,
                 MN.IHC_TRF_NO,
                 MN.AMDT_SEQ,
                 MN.ORG_DEST_TP_CD
            FROM PRI_TRF_IHC_MN  MN,
                 PRI_TRF_IHC_HDR HDR
           WHERE MN.FIC_PROP_STS_CD = 'C'
                 AND MN.SVC_SCP_CD = HDR.SVC_SCP_CD
                 AND MN.ORG_DEST_TP_CD = HDR.ORG_DEST_TP_CD
                 AND MN.IHC_TRF_NO = HDR.IHC_TRF_NO      
                 AND MN.ORG_DEST_TP_CD = @[org_dest_tp_cd] 		         
                 AND TO_DATE(@[eff_dt], 'YYYYMMDD') BETWEEN MN.EFF_DT AND NVL(MN.EXP_DT, TO_DATE('9999-12-31', 'YYYY-MM-DD'))
#if(${cnt_cd} != '')
                 AND HDR.COST_CNT_CD = @[cnt_cd]
#end
    ) A,
         PRI_TRF_IHC_RT B
   WHERE A.SVC_SCP_CD = B.SVC_SCP_CD
         AND A.ORG_DEST_TP_CD = B.ORG_DEST_TP_CD
         AND A.IHC_TRF_NO = B.IHC_TRF_NO
         AND A.AMDT_SEQ = B.AMDT_SEQ
         AND B.SRC_INFO_CD != 'AD' 
		 AND B.IHC_CGO_TP_CD = 'DR'		
         AND B.OPTM_TRSP_MOD_FLG = 'Y')
SELECT T1.SVC_TP_CD,
       T1.SVC_SCP_CD,
       T1.PNT_LOC_CD,
       T1.IHC_COST_LOC_GRP_NO,
       LOC.LOC_NM                  PNT_LOC_CD_NM,
       T1.HUB_LOC_CD,
       T1.BSE_PORT_LOC_CD,
       T1.PRC_TRSP_MOD_CD,
       TRSP_MOD.INTG_CD_VAL_DESC   PRC_TRSP_MOD_CD_NM,
       T1.RCV_DE_TERM_CD,
       TERM.INTG_CD_VAL_DESC       RCV_DE_TERM_CD_NM,
       T1.GLINE_20FT_FRT_RT_AMT,
       T1.GLINE_40FT_FRT_RT_AMT,
       T1.GLINE_DG_20FT_FRT_RT_AMT,
       T1.GLINE_DG_40FT_FRT_RT_AMT,
       T1.ORG_DEST_TP_CD,
       T1.IHC_CGO_TP_CD
  FROM ( 
       SELECT '' SVC_TP_CD,
              '' SVC_SCP_CD,
              '' PNT_LOC_CD,
              '' IHC_COST_LOC_GRP_NO,
              '' HUB_LOC_CD,
              '' BSE_PORT_LOC_CD,
              '' PRC_TRSP_MOD_CD,
              '' RCV_DE_TERM_CD,
              0 GLINE_20FT_FRT_RT_AMT,
              0 GLINE_40FT_FRT_RT_AMT,
              0 GLINE_DG_20FT_FRT_RT_AMT,
              0 GLINE_DG_40FT_FRT_RT_AMT,
              '' ORG_DEST_TP_CD,
              '' IHC_CGO_TP_CD
         FROM IHC, ADDON
        WHERE 1 = 2
 #if(${svc_tp_cd} == '3' || ${svc_tp_cd} == '') 
       UNION ALL 
     SELECT SVC_TP_CD,
            SVC_SCP_CD,
            PNT_LOC_CD,
            IHC_COST_LOC_GRP_NO,
            HUB_LOC_CD,
            BSE_PORT_LOC_CD,
            PRC_TRSP_MOD_CD,
            RCV_DE_TERM_CD,
            GLINE_20FT_FRT_RT_AMT,
            GLINE_40FT_FRT_RT_AMT,
            GLINE_DG_20FT_FRT_RT_AMT,
            GLINE_DG_40FT_FRT_RT_AMT,
            ORG_DEST_TP_CD,
            IHC_CGO_TP_CD
       FROM (
           SELECT DECODE(ADDON.BSE_PORT_LOC_CD, NULL, '2', '3') SVC_TP_CD,
                   IHC.SVC_SCP_CD,
                   IHC.PNT_LOC_CD,
                   DECODE(ADDON.BSE_PORT_LOC_CD, NULL, IHC.IHC_COST_LOC_GRP_NO, '') IHC_COST_LOC_GRP_NO,
                   IHC.HUB_LOC_CD,
                   DECODE(ADDON.BSE_PORT_LOC_CD, NULL, IHC.BSE_PORT_LOC_CD, ADDON.BSE_PORT_LOC_CD) BSE_PORT_LOC_CD,
                   DECODE(ADDON.BSE_PORT_LOC_CD, NULL, IHC.PRC_TRSP_MOD_CD, 'E') PRC_TRSP_MOD_CD,
                   IHC.RCV_DE_TERM_CD,
                   NVL(IHC.GLINE_20FT_FRT_RT_AMT, 0) + NVL(ADDON.GLINE_20FT_FRT_RT_AMT, 0) GLINE_20FT_FRT_RT_AMT,
                   NVL(IHC.GLINE_40FT_FRT_RT_AMT, 0) + NVL(ADDON.GLINE_40FT_FRT_RT_AMT, 0) GLINE_40FT_FRT_RT_AMT,
                   NVL(IHC.GLINE_DG_20FT_FRT_RT_AMT, 0) + NVL(ADDON.GLINE_DG_20FT_FRT_RT_AMT, 0) GLINE_DG_20FT_FRT_RT_AMT,
                   NVL(IHC.GLINE_DG_40FT_FRT_RT_AMT, 0) + NVL(ADDON.GLINE_DG_40FT_FRT_RT_AMT, 0) GLINE_DG_40FT_FRT_RT_AMT,
                   ROW_NUMBER() OVER (PARTITION BY IHC.SVC_SCP_CD, IHC.PNT_LOC_CD, DECODE(ADDON.BSE_PORT_LOC_CD, NULL, IHC.BSE_PORT_LOC_CD, ADDON.BSE_PORT_LOC_CD), IHC.RCV_DE_TERM_CD, DECODE(ADDON.BSE_PORT_LOC_CD, NULL, IHC.PRC_TRSP_MOD_CD, 'E'), IHC.IHC_CGO_TP_CD 
                   ORDER BY  NVL(IHC.GLINE_20FT_FRT_RT_AMT, 0) + NVL(ADDON.GLINE_20FT_FRT_RT_AMT, 0) ) AS RNUM,
                   IHC.ORG_DEST_TP_CD,
                   IHC.IHC_CGO_TP_CD
              FROM ADDON,
                   IHC
             WHERE IHC.BSE_PORT_LOC_CD = ADDON.PNT_LOC_CD(+)
                   AND IHC.SVC_SCP_CD = ADDON.SVC_SCP_CD(+)
       )
       WHERE RNUM = 1
#end               
#if(${svc_tp_cd} == '1' || ${svc_tp_cd} == '')  
        UNION ALL
        SELECT '1' SVC_TP_CD,
               ADDON.SVC_SCP_CD AS SVC_SCP_CD,
               ADDON.PNT_LOC_CD AS PNT_LOC_CD,
               '',
               '',
               ADDON.BSE_PORT_LOC_CD AS BSE_PORT_LOC_CD,
               'F' PRC_TRSP_MOD_CD,
               ADDON.RCV_DE_TERM_CD,
               ADDON.GLINE_20FT_FRT_RT_AMT,
               ADDON.GLINE_40FT_FRT_RT_AMT,
               ADDON.GLINE_DG_20FT_FRT_RT_AMT,
               ADDON.GLINE_DG_40FT_FRT_RT_AMT,
               ADDON.ORG_DEST_TP_CD,
               '' IHC_CGO_TP_CD
          FROM ADDON
#end
#if(${svc_tp_cd} == '2')            
        UNION ALL
        SELECT '2' SVC_TP_CD,
               IHC.SVC_SCP_CD AS SVC_SCP_CD,
               IHC.PNT_LOC_CD AS PNT_LOC_CD,
               IHC.IHC_COST_LOC_GRP_NO,
               IHC.HUB_LOC_CD,
               IHC.BSE_PORT_LOC_CD AS BSE_PORT_LOC_CD,
               IHC.PRC_TRSP_MOD_CD,
               IHC.RCV_DE_TERM_CD,
               IHC.GLINE_20FT_FRT_RT_AMT,
               IHC.GLINE_40FT_FRT_RT_AMT,
               IHC.GLINE_DG_20FT_FRT_RT_AMT,
               IHC.GLINE_DG_40FT_FRT_RT_AMT,
               IHC.ORG_DEST_TP_CD,
               IHC.IHC_CGO_TP_CD
          FROM IHC
#end          
          ) T1,
       COM_INTG_CD_DTL TRSP_MOD,
       COM_INTG_CD_DTL TERM,
       MDM_LOCATION LOC
 WHERE T1.PRC_TRSP_MOD_CD = TRSP_MOD.INTG_CD_VAL_CTNT(+)
       AND TRSP_MOD.INTG_CD_ID(+) = 'CD01720'
       AND T1.RCV_DE_TERM_CD = TERM.INTG_CD_VAL_CTNT(+)
       AND TERM.INTG_CD_ID(+) = 'CD01725'
       AND T1.PNT_LOC_CD = LOC.LOC_CD(+)
       AND LOC.DELT_FLG(+) = 'N'
#if(${svc_tp_cd} == '3')
       AND T1.SVC_TP_CD = @[svc_tp_cd]
#end
#if(${svc_scp_cd} != '') 
       AND T1.SVC_SCP_CD = @[svc_scp_cd]
#end
 
  #if(${pnt_loc_cd} != '')
       AND ( 1=2
    #foreach( ${obj_pnt_loc_cd} in ${list_pnt_loc_cd} )
            OR T1.PNT_LOC_CD like '$obj_pnt_loc_cd' || '%'
    #end
       )
  #end
 
#if(${bse_port_loc_cd} != '')
       AND T1.BSE_PORT_LOC_CD = @[bse_port_loc_cd]
#end			]]></sql>
			<params>
				<param name="eff_dt" type="12" value="" out="N"/>
				<param name="org_dest_tp_cd" type="12" value="" out="N"/>
				<param name="cnt_cd" type="12" value="" out="N"/>
				<param name="svc_tp_cd" type="12" value="" out="N"/>
				<param name="svc_scp_cd" type="12" value="" out="N"/>
				<param name="bse_port_loc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
