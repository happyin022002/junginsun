<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="NetworkCostDBDAOSearchPortTariffDetailListRSQL">
			<desc><![CDATA[2011.07.06 이석준 CHM-201111498-01
                 터미널별 PSO 및 COA Data 수정가능토록 조회 쿼리]]></desc>
			<sql><![CDATA[
 SELECT SLAN_CD
      , VSL_CD
      , SKD_VOY_NO
      , DIR_CD AS SKD_DIR_CD
      , SUBSTR(YD_CD, 1, 5) PORT_CD
      , SUBSTR(YD_CD, 6, 2) CY_CD
      , CURRENCY AS CURR_CD
      , PORT_USD_AMT
      , PSO_PORT_AMT AS PORT_PSO_AMT
      , CNL_USD_AMT
      , PSO_CNL_AMT AS CNL_PSO_AMT
      , CRE_USR_ID
      , WRK_DT AS CRE_DT
      , CLPT_SEQ
   FROM
        (SELECT A1.SLAN_CD
              , A1.VSL_CD
              , A1.SKD_VOY_NO
              , A1.DIR_CD
              , A5.TML_CD
              , A4.YD_CD
              , 'USD' CURRENCY
              , SUM((CASE WHEN SUBSTR(NVL(A4.YD_CD, A5.TML_CD), 1, 5) IN ('EGSUZ', 'PAPAC') THEN 0 ELSE A6.INV_USD_AMT END) ) PSO_PORT_AMT
              , SUM(A5.PORT_USD_AMT) PORT_USD_AMT
              , SUM((CASE WHEN SUBSTR(NVL(A4.YD_CD, A5.TML_CD), 1, 5) IN ('EGSUZ', 'PAPAC') THEN A6.INV_USD_AMT ELSE 0 END) ) PSO_CNL_AMT
              , SUM(A5.CNL_USD_AMT) CNL_USD_AMT
              , A6.WRK_DT
              , A6.WRK_SEQ
              , MIN(A4.CLPT_SEQ) CLPT_SEQ
              , A5.CRE_USR_ID
           FROM COA_MON_VVD A1
              , COA_VSL_RGST A2
              , COA_LANE_RGST A3
              , VSK_VSL_PORT_SKD A4
              , COA_PORT_TRF A5
              , (SELECT VSL_CD
                      , SKD_VOY_NO
                      , SKD_DIR_CD
                      , YD_CD
                      , MAX(WRK_DT) WRK_DT
                      , MAX(WRK_SEQ) KEEP (DENSE_RANK FIRST ORDER BY WRK_DT DESC) WRK_SEQ
                      , MAX(INV_USD_AMT) KEEP (DENSE_RANK FIRST ORDER BY WRK_DT DESC, WRK_SEQ DESC) INV_USD_AMT
                   FROM PSO_TGT_VVD_EXPN
                  WHERE PSO_BZTP_CD = '7'
               GROUP BY VSL_CD
                      , SKD_VOY_NO
                      , SKD_DIR_CD
                      , YD_CD
                )A6
          WHERE NVL(A1.DELT_FLG, 'N') = 'N'
            AND NVL(A3.DELT_FLG, 'N') = 'N'
            AND A1.VSL_CD         = A2.VSL_CD
            AND A2.VOP_CD         = 'HJS'
            AND A1.TRD_CD         = A3.TRD_CD
            AND A1.RLANE_CD       = A3.RLANE_CD
            AND A1.IOC_CD         = A3.IOC_CD
            AND A1.DIR_CD         = A3.DIR_CD
            AND A3.TRD_CD         <> 'COM'
            AND A3.SUB_TRD_CD     <> 'IP'
            AND A3.VSL_LANE_TP_CD IN ('JO', 'SC')
            AND TO_CHAR(A1.N1ST_LODG_PORT_ETD_DT, 'YYYYMMDD') 
                BETWEEN NVL(TO_CHAR(A2.VSL_APLY_FM_DT, 'YYYYMMDD'), '19000101') AND NVL(TO_CHAR(A2.VSL_APLY_TO_DT, 'YYYYMMDD'), '99991231')
            AND A1.VSL_CD         = A4.VSL_CD
            AND A1.SKD_VOY_NO     = A4.SKD_VOY_NO
            AND A1.DIR_CD         = A4.SKD_DIR_CD
            AND A1.SLAN_CD        = A4.SLAN_CD
            AND NVL(A4.SKD_CNG_STS_CD, 'N') <> 'S'
            AND A4.SLAN_CD        = A5.SLAN_CD(+)
            AND A4.VSL_CD         = A5.VSL_CD(+)
            AND A4.SKD_VOY_NO     = A5.SKD_VOY_NO(+)
            AND A4.SKD_DIR_CD     = A5.SKD_DIR_CD(+)
            AND A4.YD_CD          = A5.TML_CD(+)
            AND A4.VSL_CD         = A6.VSL_CD(+)
            AND A4.SKD_VOY_NO     = A6.SKD_VOY_NO(+)
            AND A4.SKD_DIR_CD     = A6.SKD_DIR_CD(+)
            AND A4.YD_CD          = A6.YD_CD(+)           
            AND A1.VSL_CD         = @[f_vsl_cd]
            AND A1.SKD_VOY_NO     = @[f_skd_voy_no]
            AND A1.DIR_CD         = @[f_dir_cd]    
            AND A1.SLAN_CD        = @[f_slan_cd]
#if (${f_yrtype} == 'W')
            AND A1.SLS_YRMON LIKE SUBSTR(@[f_yearweek],1,4) || '%' AND A1.COST_WK = SUBSTR(@[f_yearweek], 6,2)
#else
            AND A1.COST_YRMON   = REPLACE(@[f_yearweek],'-')
#end   
       GROUP BY A1.SLAN_CD
              , A1.VSL_CD
              , A1.SKD_VOY_NO
              , A1.DIR_CD
              , A4.YD_CD
              , A5.TML_CD
              , A6.WRK_DT
              , A6.WRK_SEQ
              , A1.VSL_CD
              , A1.SKD_VOY_NO
              , A1.DIR_CD
              , A5.CRE_USR_ID
        )
ORDER BY CLPT_SEQ 
			]]></sql>
			<params>
				<param name="f_vsl_cd" type="12" value="" out="N"/>
				<param name="f_skd_voy_no" type="12" value="" out="N"/>
				<param name="f_dir_cd" type="12" value="" out="N"/>
				<param name="f_slan_cd" type="12" value="" out="N"/>
				<param name="f_yearweek" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
