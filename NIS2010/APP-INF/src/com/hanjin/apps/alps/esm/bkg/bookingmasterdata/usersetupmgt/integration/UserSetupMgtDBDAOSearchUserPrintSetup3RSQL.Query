<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="UserSetupMgtDBDAOSearchUserPrintSetup3RSQL">
			<desc><![CDATA[UserSetupMgtDBDAOSearchUserPrintSetup3RSQL]]></desc>
			<sql><![CDATA[
SELECT X.BKG_NO,
       X.BL_NO,
       BL_TP_CD ,
       (SELECT CONTI_CD FROM MDM_LOCATION
        WHERE LOC_CD = BKG_COM_USER_LOC_FNC(@[usr_id]) ) AS CONTI_CD,
       NVL(BB_CGO_FLG,'N') AS BB_CGO_FLG,/* BL_TP_CD >> NULL - Original Bill/ W - Waybill*/
       NVL(OBL_ISS_FLG,'N') AS OBL_ISS_FLG,
       NVL(OBL_PRN_FLG,'N') AS OBL_PRN_FLG,
       NVL(OBL_RLSE_FLG,'N') AS OBL_RLSE_FLG,
       NVL(BL_CPY_KNT,0) AS BL_CPY_KNT,
#if(${module} == 'BIS')
	   BIS_RIDER_YN_FNC(X.BKG_NO, NULL, '1', '1', NULL) AS OBL_RIDER_FLG,
#else
	   BKG_RIDER_YN_FNC(X.BKG_NO, NULL, '1', '1', NULL) AS OBL_RIDER_FLG,
       (SELECT DECODE(MAX(HBL_TP),'B','B',DECODE(MAX(HBL_TP2),'B','B','A')) AS HBL_TP
          FROM (
                SELECT CASE WHEN GDS_DESC_LINE = 1 AND LENGTH(GDS_DESC) < 329 THEN 'A'
                            WHEN GDS_DESC_LINE > 1 AND GDS_DESC_LINE < 9 THEN 'A'
                            WHEN GDS_DESC_LINE = 0 THEN 'A'
                            ELSE 'B'
                            END AS HBL_TP,
                            CASE WHEN MK_DESC_LINE = 1 AND LENGTH(MK_DESC) < 329 THEN 'A'
                            WHEN MK_DESC_LINE > 1 AND LENGTH(MK_DESC) < 9 THEN 'A'
                            WHEN MK_DESC_LINE = 0 THEN 'A'
                            ELSE 'B'
                            END AS HBL_TP2
                      ,BKG_NO
                FROM (  
                      SELECT MK_DESC  
                            ,GDS_DESC
                            ,BKG_NO
                            ,DECODE(LENGTH(MK_DESC), NULL, 0, ((LENGTH(MK_DESC) - LENGTH(REPLACE(MK_DESC, CHR(13)||CHR(10)))) / LENGTH(CHR(13)||CHR(10)) + 1)) AS MK_DESC_LINE  
                            ,DECODE(LENGTH(GDS_DESC), NULL, 0, ((LENGTH(GDS_DESC) - LENGTH(REPLACE(GDS_DESC, CHR(13)||CHR(10)))) / LENGTH(CHR(13)||CHR(10)) + 1)) AS GDS_DESC_LINE  
                            ,LENGTH(GDS_DESC)
                        FROM (  
                              SELECT HBL.BKG_NO
                            ,REGEXP_REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REGEXP_REPLACE(HBL.BL_MK_DESC,'[[:cntrl:]]{104,}',CHR(13)||CHR(10)),CHR(96),CHR(39)), CHR(13)||CHR(10), CHR(13)), CHR(10), CHR(13)), CHR(13), CHR(13)||CHR(10)), '[[:space:]]+$', '')  AS MK_DESC  
                            ,REGEXP_REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REGEXP_REPLACE(HBL.BL_GDS_DESC,'[[:cntrl:]]{104,}',CHR(13)||CHR(10)),CHR(96),CHR(39)), CHR(13)||CHR(10), CHR(13)), CHR(10), CHR(13)), CHR(13), CHR(13)||CHR(10)), '[[:space:]]+$', '') AS GDS_DESC   
                                FROM BKG_HBL hbl
                             )  
                    )  
             )
            WHERE BKG_NO = X.BKG_NO
         ) AS HBL_TP,
 
#end
       (SELECT     DECODE(COUNT(B.BKG_NO), 0, 'Y', DECODE(NVL(C.ORG_PPD_RCV_CD, 'Y'), 'N', 'N', 'Y'))  
         FROM
#if(${module} == 'BIS')
					BIS_BOOKING A,    
                    BIS_CHG_RT B,
                    BIS_BL_ISS C   
#else
					BKG_BOOKING A,    
                    BKG_CHG_RT B,
                    BKG_BL_ISS C   
#end
         WHERE      A.BKG_NO = X.BKG_NO
         AND        A.BKG_NO = B.BKG_NO(+)
         AND        A.BKG_NO = C.BKG_NO   
         AND        B.FRT_TERM_CD (+) = 'P'   
         AND        B.N3PTY_RCV_OFC_CD(+) IS NULL   
         GROUP BY   A.BKG_NO, C.ORG_PPD_RCV_CD
        ) AS ORG_PPD_RCV_CD ,
        (  SELECT     DECODE(COUNT(B.BKG_NO), 0, 'Y', DECODE(NVL(C.ORG_N3PTY_PPD_CD, 'Y'), 'N', 'N', 'Y'))    
             FROM
#if(${module} == 'BIS')
						BIS_BOOKING A,    
                        BIS_CHG_RT B,
                        BIS_BL_ISS C   
#else
						BKG_BOOKING A,    
                        BKG_CHG_RT B,
                        BKG_BL_ISS C   
#end
             WHERE      A.BKG_NO = X.BKG_NO
             AND        A.BKG_NO = B.BKG_NO(+)
             AND        A.BKG_NO = C.BKG_NO   
             AND        B.FRT_TERM_CD (+) = 'P'   
             AND        B.N3PTY_RCV_OFC_CD(+) IS NOT NULL   
             GROUP BY   A.BKG_NO , C.ORG_N3PTY_PPD_CD
        ) AS ORG_N3PTY_PPD_CD
        ,CASE WHEN X.POD_CD = 'OMMCT' AND TO_NUMBER(TO_CHAR((SELECT BL_OBRD_DT  FROM BKG_BL_DOC WHERE BKG_NO = X.BKG_NO),'YYYYMMDD')) >= 20140531 THEN 'Y'
              ELSE 'N'
         END AS DATE_FLG /*2014/05/31이후 선적된 화물인지 확인*/
FROM
#if(${module} == 'BIS')
	BIS_BOOKING X, BIS_BL_ISS Y,
#else
	BKG_BOOKING X, BKG_BL_ISS Y,
#end
     ( SELECT TRIM(COLUMN_VALUE) AS BKG_NO ,rownum as seq
        FROM table(BKG_SPLIT_CLOB_FNC(${bkg_no}))
       ) Z
WHERE  X.BKG_NO = Y.BKG_NO(+)
AND   Z.BKG_NO = X.BKG_NO
ORDER BY Z.SEQ			]]></sql>
			<params>
				<param name="usr_id" type="12" value=" " out="N"/>
			</params>
		</query>
	</querys>
</sqls>
