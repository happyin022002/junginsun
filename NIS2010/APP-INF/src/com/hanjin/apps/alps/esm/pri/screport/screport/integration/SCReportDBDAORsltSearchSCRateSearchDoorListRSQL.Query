<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="SCReportDBDAORsltSearchSCRateSearchDoorListRSQL">
			<desc><![CDATA[US Route Cost Inquiry Door List
2015.06.30 최성환 [CHM-201536493] Split03-주간 MAS Open에 따른 타모듈 프로그램 적용 요청]]></desc>
			<sql><![CDATA[
WITH
AR AS   (
SELECT  @[prop_no]           AS PROP_NO            ,
        TO_NUMBER(@[amdt_seq])          AS AMDT_SEQ           ,
        @[svc_scp_cd]        AS SVC_SCP_CD         ,
        @[gen_spcl_rt_tp_cd] AS GEN_SPCL_RT_TP_CD  ,
        TO_NUMBER(@[cmdt_hdr_seq]) AS CMDT_HDR_SEQ       ,
        TO_NUMBER(@[rout_seq])          AS ROUT_SEQ           ,
        TO_NUMBER(@[rt_seq])            AS RT_SEQ
FROM        DUAL
)   ,
DE AS (
SELECT  FM_LOC_CD       ,
                FM_ECC_CD       ,
                FM_LCC_CD       ,
                FM_RCC_CD       ,
                HUB_LOC_CD  ,
                HUB_ECC_CD  ,
                HUB_LCC_CD  ,
                HUB_RCC_CD  ,
                TO_LOC_CD       ,
                TO_ECC_CD       ,
                TO_LCC_CD       ,
                TO_RCC_CD       ,
                RAT_UT_CD       ,
                CNTR_SZ_CD
FROM        (
                SELECT  RT.FM_LOC_CD                    ,
                                E1.ECC_CD   FM_ECC_CD       ,
                                E1.LCC_CD   FM_LCC_CD       ,
                                E1.RCC_CD FM_RCC_CD     ,
                                SUBSTR(IR.HUB_NOD_CD, 1, 5)                     HUB_LOC_CD  ,
                                E2.ECC_CD   HUB_ECC_CD  ,
                                E2.LCC_CD   HUB_LCC_CD  ,
                                E2.RCC_CD HUB_RCC_CD    ,
                                RT.TO_LOC_CD                    ,
                                E3.ECC_CD   TO_ECC_CD       ,
                                E3.LCC_CD   TO_LCC_CD       ,
                                E3.RCC_CD TO_RCC_CD     ,
                                RT.RAT_UT_CD                    ,
                                ( SELECT A.CNTR_SZ_CD FROM PRI_RAT_UT A WHERE A.RAT_UT_CD = RT.RAT_UT_CD )  CNTR_SZ_CD  ,
                                ROW_NUMBER() OVER ( PARTITION BY RT.FM_LOC_CD, RT.TO_LOC_CD, RT.RAT_UT_CD ORDER BY IR.ROUT_SEQ DESC ) ROW_NUMBER
                FROM        (
                                SELECT  DISTINCT
                                                DECODE(DV.ROUT_VIA_PORT_TP_CD, 'L', DV.ROUT_VIA_PORT_DEF_CD, D1.LOC_CD) FM_LOC_CD       ,
                                                DECODE(DP.ROUT_PNT_LOC_TP_CD, 'L', DP.ROUT_PNT_LOC_DEF_CD, D2.LOC_CD)       TO_LOC_CD       ,
                                                RT.RAT_UT_CD
                                FROM        AR                                                  ,
                                                PRI_SP_SCP_RT_CMDT_ROUT CR  ,
                                                PRI_SP_SCP_RT_ROUT_VIA  DV  ,
                                                PRI_SP_SCP_RT_ROUT_PNT  DP  ,
                                                PRI_SP_SCP_GRP_LOC          G1  ,
                                                PRI_SP_SCP_GRP_LOC_DTL  D1  ,
                                                PRI_SP_SCP_GRP_LOC          G2  ,
                                                PRI_SP_SCP_GRP_LOC_DTL  D2  ,
                                                PRI_SP_SCP_RT                       RT
                                WHERE       DV.PROP_NO                      =   CR.PROP_NO
                                AND         DV.AMDT_SEQ                     = CR.AMDT_SEQ
                                AND         DV.SVC_SCP_CD                   = CR.SVC_SCP_CD
                                AND         DV.GEN_SPCL_RT_TP_CD    = CR.GEN_SPCL_RT_TP_CD
                                AND         DV.CMDT_HDR_SEQ             = CR.CMDT_HDR_SEQ
                                AND         DV.ROUT_SEQ                     = CR.ROUT_SEQ
                                AND         DV.ORG_DEST_TP_CD           = 'D'
                                AND         DP.PROP_NO                      =   CR.PROP_NO
                                AND         DP.AMDT_SEQ                     = CR.AMDT_SEQ
                                AND         DP.SVC_SCP_CD                   = CR.SVC_SCP_CD
                                AND         DP.GEN_SPCL_RT_TP_CD    = CR.GEN_SPCL_RT_TP_CD
                                AND         DP.CMDT_HDR_SEQ             = CR.CMDT_HDR_SEQ
                                AND         DP.ROUT_SEQ                     = CR.ROUT_SEQ
                                AND         DP.ORG_DEST_TP_CD           = 'D'
                                AND         G1.PROP_NO(+)                   = DV.PROP_NO
                                AND         G1.AMDT_SEQ(+)              = DV.AMDT_SEQ
                                AND         G1.SVC_SCP_CD(+)            = DV.SVC_SCP_CD
                                AND         G1.PRC_GRP_LOC_CD(+)    = DV.ROUT_VIA_PORT_DEF_CD
                                AND         D1.PROP_NO(+)                   = G1.PROP_NO
                                AND         D1.AMDT_SEQ(+)              = G1.AMDT_SEQ
                                AND         D1.SVC_SCP_CD(+)            = G1.SVC_SCP_CD
                                AND         D1.GRP_LOC_SEQ(+)           = G1.GRP_LOC_SEQ
                                AND         G2.PROP_NO(+)                   = DP.PROP_NO
                                AND         G2.AMDT_SEQ(+)              = DP.AMDT_SEQ
                                AND         G2.SVC_SCP_CD(+)            = DP.SVC_SCP_CD
                                AND         G2.PRC_GRP_LOC_CD(+)    = DP.ROUT_PNT_LOC_DEF_CD
                                AND         D2.PROP_NO(+)                   = G2.PROP_NO
                                AND         D2.AMDT_SEQ(+)              = G2.AMDT_SEQ
                                AND         D2.SVC_SCP_CD(+)            = G2.SVC_SCP_CD
                                AND         D2.GRP_LOC_SEQ(+)           = G2.GRP_LOC_SEQ
                                AND         RT.PROP_NO                      =   CR.PROP_NO
                                AND         RT.AMDT_SEQ                     = CR.AMDT_SEQ
                                AND         RT.SVC_SCP_CD                   = CR.SVC_SCP_CD
                                AND         RT.GEN_SPCL_RT_TP_CD    = CR.GEN_SPCL_RT_TP_CD
                                AND         RT.CMDT_HDR_SEQ             = CR.CMDT_HDR_SEQ
                                AND         RT.ROUT_SEQ                     = CR.ROUT_SEQ
                                /* 조회 조건 */
                                AND         CR.PROP_NO                      = AR.PROP_NO
                                AND         CR.AMDT_SEQ                     = AR.AMDT_SEQ
                                AND         CR.SVC_SCP_CD                   = AR.SVC_SCP_CD
                                AND         CR.GEN_SPCL_RT_TP_CD    = AR.GEN_SPCL_RT_TP_CD
                                AND         CR.CMDT_HDR_SEQ             = AR.CMDT_HDR_SEQ
                                AND         CR.ROUT_SEQ                     = AR.ROUT_SEQ
                                AND         RT.RT_SEQ                           = AR.RT_SEQ
                                )   RT  ,
                                PRD_INLND_ROUT_MST  IR  ,
                                MDM_LOCATION                L1  ,
                                MDM_EQ_ORZ_CHT          E1  ,
                                MDM_LOCATION                L2  ,
                                MDM_EQ_ORZ_CHT          E2  ,
                                MDM_LOCATION                L3  ,
                                MDM_EQ_ORZ_CHT          E3
                WHERE       IR.ROUT_ORG_NOD_CD      LIKE RT.FM_LOC_CD||'%'
                AND         IR.ROUT_DEST_NOD_CD     LIKE RT.TO_LOC_CD||'%'
                AND         IR.PRIO_SEQ                     = '1'
                AND         IR.PCTL_IO_BND_CD           = 'I'
                AND         NVL(IR.DELT_FLG, 'N')   = 'N'
                AND         L1.LOC_CD       = SUBSTR(IR.ROUT_ORG_NOD_CD, 1, 5)
                AND         E1.SCC_CD       = L1.SCC_CD
                AND         L2.LOC_CD       = SUBSTR(IR.HUB_NOD_CD, 1, 5)
                AND         E2.SCC_CD       = L2.SCC_CD
                AND         L3.LOC_CD       = SUBSTR(IR.ROUT_DEST_NOD_CD, 1, 5)
                AND         E3.SCC_CD       = L3.SCC_CD
                )
WHERE       ROW_NUMBER  = 1
)
SELECT  FM_LOC_CD           ,
                HUB_LOC_CD      ,
                TO_LOC_CD           ,
                CNTR_TPSZ_CD    ,
                CURR_CD             ,
                FLOOR(TRUCKAGE / 100) * 100 +
                CASE
                WHEN MOD(TRUCKAGE, 100) BETWEEN 1       AND 25 THEN 25
                WHEN MOD(TRUCKAGE, 100) BETWEEN 26  AND 50 THEN 50
                WHEN MOD(TRUCKAGE, 100) BETWEEN 51  AND 75 THEN 75
                WHEN MOD(TRUCKAGE, 100) BETWEEN 76  AND 99 THEN 100
                ELSE 0
                END TRUCKAGE ,
				'' AS PROP_NO           , -- param
				'' AS AMDT_SEQ          , -- param
				'' AS SVC_SCP_CD        , -- param
				'' AS GEN_SPCL_RT_TP_CD , -- param
				'' AS CMDT_HDR_SEQ      , -- param
				'' AS ROUT_SEQ          , -- param
				'' AS RT_SEQ              -- param
FROM        (
                SELECT  FM_LOC_CD           ,
                                HUB_LOC_CD      ,
                                TO_LOC_CD           ,
                                CNTR_TPSZ_CD    ,
                                'USD'   CURR_CD ,
                                ROUND( COALESCE(
                                    SUM(DECODE(COST_LOC_GRP_CD, 'C', STND_COST_USD_AMT))    ,
                                    SUM(DECODE(COST_LOC_GRP_CD, 'E', STND_COST_USD_AMT))    ,
                                    SUM(DECODE(COST_LOC_GRP_CD, 'L', STND_COST_USD_AMT))    ,
                                    SUM(DECODE(COST_LOC_GRP_CD, 'R', STND_COST_USD_AMT))
                                ), 0)   TRUCKAGE
                FROM        (
                                SELECT  DE.FM_LOC_CD                    ,
                                                DE.HUB_LOC_CD                   ,
                                                DE.TO_LOC_CD                    ,
                                                ST.CNTR_TPSZ_CD             ,
                                                ST.COST_LOC_GRP_CD      ,
                                                ST.STND_COST_USD_AMT
                                FROM        DE  ,
                                                MAS_LNK_AVG_STND_COST   ST
                                WHERE       ST.COST_YRMON               = LEAST(MAS_BZC_COST_YRMON_FNC(''), TO_CHAR(SYSDATE, 'YYYYMM'))
                                AND         (
                                                        (
                                                                ST.COST_LOC_GRP_CD  =   'C' /* LOCATION */
                                                        AND ST.LNK_FM_NOD_CD        = NVL(DE.HUB_LOC_CD, DE.FM_LOC_CD)
                                                        AND ST.LNK_TO_NOD_CD        = DE.TO_LOC_CD
                                                        )
                                                        OR
                                                        (
                                                                ST.COST_LOC_GRP_CD  =   'E' /* ECC */
                                                        AND ST.LNK_FM_NOD_CD        = NVL(DE.HUB_ECC_CD, DE.FM_ECC_CD)
                                                        AND ST.LNK_TO_NOD_CD        = DE.TO_ECC_CD
                                                        )
                                                        OR
                                                        (
                                                                ST.COST_LOC_GRP_CD  =   'L' /* LCC */
                                                        AND ST.LNK_FM_NOD_CD        = NVL(DE.HUB_LCC_CD, DE.FM_LCC_CD)
                                                        AND ST.LNK_TO_NOD_CD        = DE.TO_LCC_CD
                                                        )
                                                        OR
                                                        (
                                                                ST.COST_LOC_GRP_CD  =   'R' /* RCC */
                                                        AND ST.LNK_FM_NOD_CD        = NVL(DE.HUB_RCC_CD, DE.FM_RCC_CD)
                                                        AND ST.LNK_TO_NOD_CD        = DE.TO_RCC_CD
                                                        )
                                                )
                                AND         (
                                                                ST.CNTR_TPSZ_CD         = DE.RAT_UT_CD
                                                        OR
                                                        (
                                                                DE.RAT_UT_CD    IN ( '20', '40', 'HC', '45', '53' )
                                                AND ( SELECT A.CNTR_SZ_CD FROM MDM_CNTR_TP_SZ A WHERE A.CNTR_TPSZ_CD = ST.CNTR_TPSZ_CD )    = DE.CNTR_SZ_CD
                                                        )
                                                )
                                AND         ST.FULL_MTY_CD          = 'F'
                                AND         ST.MAS_COST_SRC_CD  = 'TRDRTD'
                                AND         ST.CNTR_TPSZ_CD         <> 'BOX'
                                --AND           ST.CNTR_TPSZ_CD         LIKE 'D%'
                                UNION ALL
                                SELECT  DE.FM_LOC_CD                    ,
                                                DE.HUB_LOC_CD                   ,
                                                DE.TO_LOC_CD                    ,
                                                RE.CNTR_TPSZ_CD             ,
                                                ST.COST_LOC_GRP_CD      ,
                                                ST.STND_COST_USD_AMT
                                FROM        DE  ,
                                                MAS_LNK_AVG_STND_COST   ST  ,
                                                (
                                                SELECT  DISTINCT
                                                                SPCL_CNTR_TPSZ_CD   CNTR_TPSZ_CD
                                                FROM        MAS_SPCL_REPO_CNTR_RGST
                                                WHERE       SPCL_CNTR_TPSZ_CD NOT IN ( 'Q2', 'Q4' )
                                                AND         SPCL_CNTR_TPSZ_CD NOT LIKE 'RD_'
                                                --AND           SPCL_CNTR_TPSZ_CD LIKE 'D%'
                                                AND         DELT_FLG = 'N'
                                                ) RE
                                WHERE       SUBSTR(ST.CNTR_TPSZ_CD, 1, 1) = DECODE(SUBSTR(RE.CNTR_TPSZ_CD, -1),'2','2','4')
                                AND         ST.COST_YRMON                   = LEAST(MAS_BZC_COST_YRMON_FNC(''), TO_CHAR(SYSDATE, 'YYYYMM'))
                                AND         (
                                                        (
                                                                ST.COST_LOC_GRP_CD  =   'C' /* LOCATION */
                                                        AND ST.LNK_FM_NOD_CD        = NVL(DE.HUB_LOC_CD, DE.FM_LOC_CD)
                                                        AND ST.LNK_TO_NOD_CD        = DE.TO_LOC_CD
                                                        )
                                                        OR
                                                        (
                                                                ST.COST_LOC_GRP_CD  =   'E' /* ECC */
                                                        AND ST.LNK_FM_NOD_CD        = NVL(DE.HUB_ECC_CD, DE.FM_ECC_CD)
                                                        AND ST.LNK_TO_NOD_CD        = DE.TO_ECC_CD
                                                        )
                                                        OR
                                                        (
                                                                ST.COST_LOC_GRP_CD  =   'L' /* LCC */
                                                        AND ST.LNK_FM_NOD_CD        = NVL(DE.HUB_LCC_CD, DE.FM_LCC_CD)
                                                        AND ST.LNK_TO_NOD_CD        = DE.TO_LCC_CD
                                                        )
                                                        OR
                                                        (
                                                                ST.COST_LOC_GRP_CD  =   'R' /* RCC */
                                                        AND ST.LNK_FM_NOD_CD        = NVL(DE.HUB_RCC_CD, DE.FM_RCC_CD)
                                                        AND ST.LNK_TO_NOD_CD        = DE.TO_RCC_CD
                                                        )
                                                )
                                AND         ST.FULL_MTY_CD          = 'F'
                                AND         ST.MAS_COST_SRC_CD  LIKE 'SC%'
                                AND         ST.CNTR_TPSZ_CD         <> 'BOX'
                                AND         ST.CNTR_TPSZ_CD         IN ( '20', '40' )
                                AND         (
                                                                RE.CNTR_TPSZ_CD         = DE.RAT_UT_CD
                                                        OR
                                                        (
                                                                DE.RAT_UT_CD    IN ( '20', '40', 'HC', '45', '53' )
                                                AND ( SELECT A.CNTR_SZ_CD FROM MDM_CNTR_TP_SZ A WHERE A.CNTR_TPSZ_CD = RE.CNTR_TPSZ_CD )    = DE.CNTR_SZ_CD
                                                        )
                                                )
                                )
                GROUP BY
                                FM_LOC_CD           ,
                                HUB_LOC_CD      ,
                                TO_LOC_CD           ,
                                CNTR_TPSZ_CD
                )			]]></sql>
			<params>
				<param name="prop_no" type="12" value="" out="N"/>
				<param name="amdt_seq" type="12" value="" out="N"/>
				<param name="svc_scp_cd" type="12" value="" out="N"/>
				<param name="gen_spcl_rt_tp_cd" type="12" value="" out="N"/>
				<param name="cmdt_hdr_seq" type="12" value="" out="N"/>
				<param name="rout_seq" type="12" value="" out="N"/>
				<param name="rt_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
