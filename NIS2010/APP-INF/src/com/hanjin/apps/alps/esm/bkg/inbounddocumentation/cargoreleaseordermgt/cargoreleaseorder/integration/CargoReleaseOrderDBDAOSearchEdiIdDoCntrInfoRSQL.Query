<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CargoReleaseOrderDBDAOSearchEdiIdDoCntrInfoRSQL">
			<desc><![CDATA[Booking Container 정보를 조회한다]]></desc>
			<sql><![CDATA[
SELECT   '{CNTR_INFO'   || CHR(10)
      || 'CNTR_NO:'     || CNTR_NO || CHR(10)
      || 'SIZE_TYPE:'   || CNTR_TPSZ_CD || CHR(10)
      || 'DMIF_END_DT:' || FREE_TIME_END || CHR(10)
      || 'DTIC_END_DT:' || CHR(10)
      || 'DT_FT_DAYS:'  || CHR(10)
      || '}CNTR_INFO'   || CHR(10)
  FROM 
  (
      SELECT CNTR.CNTR_NO
           , BCNTR.CNTR_TPSZ_CD
           , SEAL.CNTR_SEAL_NO
           , NVL(DMFT.FREE_TIME_END
                , DECODE(SUBSTR(BKGM.DEL_CD, 1,2)
                         , 'KR', TO_CHAR(VSKD.VPS_ETA_DT + DECODE(SUBSTR(BCNTR.CNTR_TPSZ_CD,1,1),'R',5,8), 'YYYY.MM.DD')
                         , NULL
                        )
                ) AS FREE_TIME_END
        FROM (
              SELECT DCNT.BKG_NO, DCNT.CNTR_NO
                FROM BKG_DO BKDO 
                   , BKG_DO_CNTR DCNT 
               WHERE BKDO.DO_NO = SUBSTR(@[do_no],1,10) 
                 AND BKDO.DO_NO_SPLIT = DECODE(NVL(SUBSTR(@[do_no],11,2), '00'), '00', 'X', NVL(SUBSTR(@[do_no],11,2), '00')) 
                 AND DCNT.BKG_NO = BKDO.BKG_NO 
                 AND DCNT.RLSE_SEQ = BKDO.RLSE_SEQ 
              UNION ALL 
              SELECT BCNT.BKG_NO, BCNT.CNTR_NO
                FROM BKG_DO BKDO 
                   , BKG_CONTAINER BCNT 
               WHERE BKDO.DO_NO = SUBSTR(@[do_no],1,10) 
                 AND BKDO.DO_NO_SPLIT = DECODE(NVL(SUBSTR(@[do_no],11,2), '00'), '00', '00', 'X') 
                 AND BCNT.BKG_NO = BKDO.BKG_NO 
              ) CNTR
           , BKG_CNTR_SEAL_NO SEAL
           , BKG_BOOKING BKGM
           , BKG_VVD BVVD
           , VSK_VSL_PORT_SKD VSKD
           , BKG_CONTAINER  BCNTR
           , (SELECT C.CNTR_NO
                   , MAX(DECODE(NVL(INVM1.DMDT_AR_IF_CD, 'N'),'Y', TO_CHAR(TO_MVMT_DT, 'YYYYMMDD'),
                                                              'N', TO_CHAR(FT_END_DT,  'YYYYMMDD')))   AS FREE_TIME_END
              FROM    DMT_CHG_CALC    C,
                      DMT_INV_MN  INVM1
              WHERE   (SYS_AREA_GRP_ID,CNTR_NO,CNTR_CYC_NO) IN
                      ( SELECT SYS_AREA_GRP_ID,CNTR_NO,CNTR_CYC_NO 
                          FROM DMT_CHG_BKG_CNTR 
                         WHERE BKG_NO = (SELECT BKG_NO
                                           FROM BKG_DO
                                          WHERE DO_NO = SUBSTR(@[do_no], 1,10)
                                            AND DO_NO_SPLIT = NVL(SUBSTR(@[do_no],11,2), '00'))
                      )
              AND     C.DMDT_INV_NO = INVM1.DMDT_INV_NO(+)

               AND C.DMDT_CHG_STS_CD IN ('F', 'C', 'I', 'L', 'N', 'U')  
               AND (    ( C.DMDT_TRF_CD = 'DMIF'  AND C.DMDT_CHG_LOC_DIV_CD = 'POD')
                     OR ( C.DMDT_TRF_CD = 'CTIC'  AND C.DMDT_CHG_LOC_DIV_CD = 'DEL')
                   )
           
               AND NOT (C.DUL_TP_EXPT_FLG  = 'Y' AND SUBSTR(C.DMDT_TRF_CD, 1, 1) = 'D')
               AND C.DMDT_CHG_LOC_DIV_CD <> 'SZP'   
        
--              AND     C.SYS_AREA_GRP_ID = 'KOR'  -- 한국만 적용되는 것 아님
              GROUP BY C.CNTR_NO, C.CNTR_CYC_NO, C.DMDT_TRF_CD 
             ) DMFT
       WHERE BKGM.BKG_NO = (SELECT BKG_NO
                              FROM BKG_DO
                             WHERE DO_NO = SUBSTR(@[do_no], 1,10)
                               AND DO_NO_SPLIT = NVL(SUBSTR(@[do_no],11,2), '00'))
         AND BVVD.BKG_NO = BKGM.BKG_NO
         AND BVVD.POD_CD = BKGM.POD_CD
         AND VSKD.VSL_CD(+) = BVVD.VSL_CD
         AND VSKD.SKD_VOY_NO(+) = BVVD.SKD_VOY_NO
         AND VSKD.SKD_DIR_CD(+) = BVVD.SKD_DIR_CD
         AND VSKD.VPS_PORT_CD(+) = BVVD.POD_CD
         AND VSKD.CLPT_IND_SEQ(+) = BVVD.POD_CLPT_IND_SEQ
         AND SEAL.BKG_NO(+) = CNTR.BKG_NO
         AND SEAL.CNTR_NO(+) = CNTR.CNTR_NO
         AND DMFT.CNTR_NO(+) = SEAL.CNTR_NO
         AND CNTR.BKG_NO  = BCNTR.BKG_NO
         AND CNTR.CNTR_NO = BCNTR.CNTR_NO
       ORDER BY CNTR_NO, CNTR_SEAL_SEQ
     )			]]></sql>
			<params>
				<param name="do_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
