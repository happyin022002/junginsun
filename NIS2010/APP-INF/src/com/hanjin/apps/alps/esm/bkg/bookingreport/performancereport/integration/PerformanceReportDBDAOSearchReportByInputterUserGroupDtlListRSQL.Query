<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="PerformanceReportDBDAOSearchReportByInputterUserGroupDtlListRSQL">
			<desc><![CDATA[PerformanceReportDBDAOSearchReportByInputterUserGroupDtlListRSQL]]></desc>
			<sql><![CDATA[
SELECT 
    (SELECT COUNT(*) FROM BKG_SR_HIS WHERE SR_STS_CD = 'RR' AND SR_KND_CD = B.SR_KND_CD
    	AND   SR_NO = B.SR_NO
    	AND   BKG_NO  = B.BKG_NO ) AS RTN_FREQ
    ,(SELECT COUNT(*) FROM BKG_SR_HIS WHERE SR_STS_CD = 'ST' AND SR_KND_CD = B.SR_KND_CD
    	AND   SR_NO = B.SR_NO
    	AND   BKG_NO  = B.BKG_NO ) AS AMD_FREQ
    ,B.ATND_USR_ID as pic_usr_id
    ,(SELECT  USR_NM FROM COM_USER WHERE USR_ID = B.ATND_USR_ID) USR_NM
    ,B.USER_GROUP AS USR_GROUP, B.REGION, B.BKG_NO, B.SR_NO AS SI_NO 
    ,NVL(BKG_COM_INTG_CD_NM_FNC('CD01577',B.SR_AMD_TP_CD),'Original') AS SI_KND
    ,B.SR_URG_CD AS URGENT, B.SRC, B.VVD_CD, B.POL_CD AS POL, B.DEL_CD AS DEL
    ,BKG_COM_INTG_CD_NM_FNC('CD02405',REGION) AS REGION_NM
    ,DECODE(SR_URG_CD,'N','Normal','U','Urgent','V','VIP') AS SR_URG_NM
	,CNTR_CNT
	,CM_CNT
	,H_BL
	,self_audit
	,RATE_TYPE
FROM (
    SELECT 
    H.ATND_USR_ID 
    ,BKG_JOIN_FNC(CURSOR(SELECT DISTINCT RGN_OFC_CD FROM BKG_EML_ACCT_STUP S WHERE S.BKG_OFC_CD = B.BKG_OFC_CD ),'')AS  REGION
    ,H.SR_STS_CD,H.SR_HIS_SEQ
    -- SR_AMD_SEQ 가 가장낮은 HIS_DUP_NM 1번에 BKG_NO별 데이터를 모아두고 
    ,ROW_NUMBER() OVER (PARTITION BY A.SR_KND_CD, A.BKG_NO, A.SR_NO,SR_HIS_SEQ  ORDER BY SR_AMD_SEQ,SR_HIS_SEQ ) HIS_DUP_NM
    ,ROW_NUMBER() OVER (PARTITION BY A.BKG_NO,SR_STS_CD  ORDER BY SR_AMD_SEQ,SR_HIS_SEQ ) SR_BKG_NM
    ,COUNT(DISTINCT A.RQST_RN) OVER (PARTITION BY A.BKG_NO ,SR_STS_CD) SI_CNT --해당 BKG에 SR_STS_CD의 RQST갯수-> S/I #
    ,ROW_NUMBER() OVER(PARTITION BY A.BKG_NO ORDER BY A.BKG_NO) RN_BKG
    ,COUNT(DISTINCT H.ATND_USR_ID) OVER (PARTITION BY A.BKG_NO,SR_STS_CD   ) STAFF_CNT --해당 BKG의 1ROW 만 사용하면됨.
    ,COUNT(DISTINCT A.BKG_NO ) OVER (PARTITION BY SR_STS_CD) BKG_CNT_SR
    --,DECODE(DECODE(SUBSTR(RFA_NO,0,3),'DUM',NULL,RFA_NO),NULL,DECODE(SC_NO,NULL,DECODE(TAA_NO,NULL,NULL,'TAA'),'S/C'),'RFA') RATE_TYPE 
    ,A.RQST_RN,A.SRC,A.SR_KND_CD,A.SR_NO,A.BKG_NO,A.SR_AMD_TP_CD,A.SR_AMD_SEQ,A.SR_URG_CD
    ,A.SR_AMD_KND_CD,A.RCV_OFC_CD,A.DPCS_OFC_CD,A.SR_CRNT_STS_CD,A.SR_CRNT_INFO_CD,A.BL_DOC_INP_FLG
    ,A.BL_RT_FLG,A.BL_AUD_FLG,A.SR_WRK_STS_CD,A.BL_DRFT_FAX_OUT_FLG 
    ,H.ST_DT, H.ST_GDT 
    ,RFA_NO,B.TAA_NO,B.SC_NO, H.SR_PROC_HRS,G.DPCS_WRK_GRP_CD
    ,BKG_COM_INTG_CD_NM_FNC('CD02100',G.DPCS_WRK_GRP_CD) AS USER_GROUP
    ,B.VSL_CD||B.SKD_VOY_NO||B.SKD_DIR_CD AS VVD_CD
    ,POL_CD,DEL_CD
    ,(SELECT  COUNT(*) FROM BKG_CONTAINER WHERE BKG_NO = B.BKG_NO) As CNTR_CNT
    ,(SELECT COUNT(*) FROM BKG_CNTR_MF_DESC WHERE BKG_NO = B.BKG_NO) as CM_CNT
    ,(SELECT NVL(MAX(HBL_SEQ),'0') FROM BKG_HBL WHERE BKG_NO = B.BKG_NO) As H_BL
    ,(select   AUD_STS_CD  from bkg_rate  WHERE BKG_NO = B.BKG_NO) AS self_audit
    ,(select   DECODE(DECODE(SUBSTR(RFA_NO,0,3),'DUM',NULL,RFA_NO),NULL,DECODE(SC_NO,NULL,DECODE(TAA_NO,NULL,NULL,'TAA'),'S/C'),'RFA') from bkg_booking  WHERE BKG_NO = B.BKG_NO) AS RATE_TYPE 
    FROM (
        SELECT 
        ROWNUM RQST_RN ,
        BKG_COM_INTG_CD_NM_FNC('CD01581',R.SR_KND_CD) AS SRC
        ,SR_KND_CD,SR_NO, r.BKG_NO, SR_AMD_TP_CD, SR_AMD_SEQ, SR_URG_CD, SR_AMD_KND_CD, RCV_OFC_CD
        ,DPCS_OFC_CD, SR_CRNT_STS_CD, SR_CRNT_INFO_CD, BL_DOC_INP_FLG, BL_RT_FLG, BL_AUD_FLG,SR_WRK_STS_CD,BL_DRFT_FAX_OUT_FLG
        FROM BKG_SR_CRNT_RQST R
        WHERE  1=1
        AND R.DPCS_OFC_CD = NVL(@[dpcs_ofc_cd], R.DPCS_OFC_CD)
        AND (  1=2
        #if (${sel_group} == 'ID') 
            OR (BL_DOC_INP_DT >= TO_DATE(@[from_dt]||@[from_mt], 'YYYY-MM-DDHH24:MI')
              AND  BL_DOC_INP_DT <= TO_DATE(@[to_dt]||@[to_mt], 'YYYY-MM-DDHH24:MI')+0.00068 ) 
        #end
        #if (${sel_group} == 'RD') 
            OR ( BL_RT_DT >= TO_DATE(@[from_dt]||@[from_mt], 'YYYY-MM-DDHH24:MI')
              AND  BL_RT_DT <= TO_DATE(@[to_dt]||@[to_mt], 'YYYY-MM-DDHH24:MI')+0.00068 ) 
        #end
        #if (${sel_group} == 'AD') 
            OR ( BL_AUD_DT >= TO_DATE(@[from_dt]||@[from_mt], 'YYYY-MM-DDHH24:MI')
              AND  BL_AUD_DT <=TO_DATE(@[to_dt]||@[to_mt], 'YYYY-MM-DDHH24:MI') +0.00068) 
        #end
           )
        ) A   
    ,BKG_SR_HIS H
    ,BKG_DPCS_USR_GRP G
    ,BKG_BOOKING B
    ,BKG_RATE BR
    WHERE 1 = 1
      AND A.SR_KND_CD =  H.SR_KND_CD --FAX,EMAIL,EDI
      AND A.SR_NO =  H.SR_NO
      AND A.BKG_NO =  H.BKG_NO
      AND A.BKG_NO= B.BKG_NO
      AND A.BKG_NO= BR.BKG_NO
     AND B.VSL_CD||B.SKD_VOY_NO||B.SKD_DIR_CD LIKE  DECODE(@[vvd_cd], '', '' ,@[vvd_cd])|| '%'
      AND H.ATND_USR_ID  = G.USR_ID(+)
      AND H.ATND_USR_ID = NVL(@[list_atnd_usr_id],H.ATND_USR_ID )
      AND H.SR_STS_CD  = @[sel_group]
      AND EXISTS (SELECT 'Y' FROM BKG_EML_ACCT_STUP S WHERE S.BKG_OFC_CD = B.BKG_OFC_CD AND S.RGN_OFC_CD = NVL(DECODE(@[region],'A','',@[region]),S.RGN_OFC_CD) AND ROWNUM = 1)
)B
WHERE B.HIS_DUP_NM =1			]]></sql>
			<params>
				<param name="dpcs_ofc_cd" type="12" value="" out="N"/>
				<param name="from_dt" type="12" value="" out="N"/>
				<param name="from_mt" type="12" value="" out="N"/>
				<param name="to_dt" type="12" value="" out="N"/>
				<param name="to_mt" type="12" value="" out="N"/>
				<param name="vvd_cd" type="12" value="" out="N"/>
				<param name="list_atnd_usr_id" type="12" value="" out="N"/>
				<param name="sel_group" type="12" value="" out="N"/>
				<param name="region" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
