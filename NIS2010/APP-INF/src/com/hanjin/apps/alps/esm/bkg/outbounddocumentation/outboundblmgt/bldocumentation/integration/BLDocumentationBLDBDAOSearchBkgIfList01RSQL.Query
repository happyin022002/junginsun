<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BLDocumentationBLDBDAOSearchBkgIfList01RSQL">
			<desc><![CDATA[BLDocumentationBLDBDAOSearchBkgIfList01]]></desc>
			<sql><![CDATA[
SELECT /*+ opt_param('_optimizer_skip_scan_enabled', 'false') */ 
          BKG_NO
        , STATUS
        , BL_NO
        , CUST_TP_CD
        , CUST_CD
        , REPLACE(CUST_NM, CHR(13)||CHR(10), ' ') CUST_NM
        , SC_NO
        , GROUP_EDI_ID
		, (SELECT /*+ INDEX(CUST XAK1BKG_CUSTOMER) */
                  DECODE(CUST_SEQ, '0', '', CUST_CNT_CD||TRIM(TO_CHAR(CUST_SEQ, '000000')))
			 FROM BKG_CUSTOMER CUST 
            WHERE CUST.BKG_NO = MST.BKG_NO 
              AND BKG_CUST_TP_CD = 'E') EDI_REF
        , RECEIVER_NAME
		, VVD
        , POR_CD
        , POL_CD
        , POD_CD
        , DEL_CD
        , SENT_DT
        , SND_USR_ID
        , (SELECT usr_nm FROM com_user WHERE usr_id = SND_USR_ID AND ROWNUM = 1) SND_USR_NM
        , SENT_STATUS
        , ACK
        , EDI_RECEIVE_ID RCV_ID
        , GROUP_EDI_ID GROUP_ID
        , CUST_CD REF_CODE
  FROM (SELECT  /*+ INDEX(CUST XAK1BKG_CUSTOMER) */
				MST.BKG_NO
                , BK.BKG_STS_CD STATUS
                , BK.BL_NO||BK.BL_TP_CD BL_NO
                , SUBSTR(RANK, 2, 2) CUST_TP_CD
                , CUST.CUST_CNT_CD||TRIM(TO_CHAR(CUST.CUST_SEQ, '000009')) CUST_CD
                , CUST.CUST_NM
                , BK.SC_NO
                , MST.GROUP_EDI_ID
                , MST.EDI_RECEIVE_ID
                , MST.RECEIVER_NAME
				, MST.VVD
                , BK.POR_CD
                , BK.POL_CD
                , BK.POD_CD
                , BK.DEL_CD
                , TO_CHAR(NTC.SND_RQST_DT, 'YYYY-MM-DD') SENT_DT
                , NTC.SND_USR_ID
                , DECODE(NTC.BKG_NTC_SND_RSLT_CD, 'A', 'Success', 'E', 'Fail', null) SENT_STATUS
                , null ACK
		        , NTC.HIS_SEQ
				, NTC.NTC_VIA_CD
				, NTC.NTC_KND_CD
          FROM BKG_CUSTOMER CUST, BKG_BOOKING BK, BKG_NTC_HIS NTC, 
                (SELECT BKG_NO
                        , MIN(RANK) RANK
                        , GROUP_EDI_ID
                        , EDI_RECEIVE_ID
                        , RECEIVER_NAME
						, VVD
                   FROM 
                        (SELECT /*+ INDEX(CUST XAK1BKG_CUSTOMER) */
                                 BK.BKG_NO
                                , MIN(TP_RANK.RANK) RANK
                                , EDI_BY_CUST.GROUP_EDI_ID
                                , EDI_BY_CUST.EDI_RECEIVE_ID
                                , EDI_BY_CUST.RECEIVER_NAME
								, VVD.VSL_CD||VVD.SKD_VOY_NO||VVD.SKD_DIR_CD VVD
                          FROM BKG_CUSTOMER CUST
                                , BKG_BOOKING BK
                                , BKG_VVD VVD
								, BKG_BL_ISS ISS
                                , (SELECT  GRP.ESVC_GRP_CD           GROUP_EDI_ID
                                         , GRP.CUST_TRD_PRNR_ID     EDI_RECEIVE_ID
                                         , GRP.ESVC_GRP_NM          RECEIVER_NAME
                                         , grp_CUST.CNT_CD   
                                         , grp_CUST.CUST_SEQ 
                                         , GRP_CUST.BKG_CUST_TP_DESC
                                   FROM BKG_EDI_GRP_CUST GRP_CUST, BKG_EDI_GRP GRP
                                  WHERE GRP.ESVC_GRP_CD         = GRP_CUST.ESVC_GRP_CD
                                    AND GRP.CO_CD               = GRP_CUST.CO_CD
                                    AND GRP.CO_CD               = 'H'
                                    AND GRP.ESVC_GRP_DELT_FLG   = 'N'
                                    AND GRP_CUST.CNT_CD         > ' '
                                    AND GRP_CUST.CUST_SEQ       > 0
                                    AND GRP_CUST.DELT_FLG       = 'N'
#if (${msg_type_cd} == 'B')-- booking receipt
                                    AND GRP_CUST.BKG_CFM_FLG    = 'Y'
#end
#if (${msg_type_cd} == 'D')--draft b/l
                                    AND GRP_CUST.BL_DRFT_FLG    = 'Y'
#end
#if(${edi_group_id} != '' && ${edi_receive_nm} != '')
	#if(${edi_group_id} == 'G')--Group ID
                                    AND GRP.ESVC_GRP_CD  like @[edi_receive_nm]||'%'
	#end
	#if(${edi_group_id} == 'R')--Receive ID
                                    AND GRP.CUST_TRD_PRNR_ID like @[edi_receive_nm]||'%'
	#end
	#if(${edi_group_id} == 'N')--receive name
                                    AND GRP.ESVC_GRP_NM  like @[edi_receive_nm]||'%'
	#end
#end
                                    ) EDI_BY_CUST               
                                , (SELECT 'S' RCV_TP, '1SH' RANK FROM DUAL 
                                   UNION SELECT 'C' RCV_TP, '2CN' RANK FROM DUAL 
                                   UNION SELECT 'N' RCV_TP, '3NF' RANK FROM DUAL 
                                   UNION SELECT 'F' RCV_TP, '4FF' RANK FROM DUAL 
                                   UNION SELECT 'A' RCV_TP, '5AN' RANK FROM DUAL 
                                   UNION SELECT 'E' RCV_TP, '6EX' RANK FROM DUAL) TP_RANK
                         WHERE EDI_BY_CUST.CNT_CD   = CUST.CUST_CNT_CD 
                           AND EDI_BY_CUST.CUST_SEQ = CUST.CUST_SEQ
                           AND BK.BKG_NO        = CUST.BKG_NO
                           AND BK.BKG_NO        = ISS.BKG_NO(+)
                           AND BK.BKG_NO        = VVD.BKG_NO
                           AND BK.POL_CD        = VVD.POL_CD
                           AND VVD.VSL_PRE_PST_CD IN ('T', 'S')
                           AND CUST.BKG_CUST_TP_CD = TP_RANK.RCV_TP
                           AND BK.BKG_STS_CD    IN ('F', 'W', 'S')
                           AND BK.BKG_CGO_TP_CD <> 'P'
                           AND DECODE(BKG_CUST_TP_DESC,'ALL','ALL',CUST.BKG_CUST_TP_CD)
                               IN (SELECT COLUMN_VALUE
                                     FROM TABLE(BKG_SPLIT_FNC(BKG_CUST_TP_DESC,',')))
                        ---------------------------조건절 시작   
#if (${bkg_no} != '')
                           AND BK.BKG_NO IN ( ${bkg_no} )
#end
#if (${bl_no} != '')
                           AND BK.BL_NO  = @[bl_no]
#end
                        ---------------------------bkg or b/l no입력시 다른 조건 제외함

#if (${bkg_from_dt} != '')
                           AND BK.BKG_CRE_DT > TO_DATE(REPLACE(@[bkg_from_dt],'-',''),'RRRRMMDD')
#end
#if (${bkg_to_dt} != '')
                           AND BK.BKG_CRE_DT < TO_DATE(REPLACE(@[bkg_to_dt],'-',''),'RRRRMMDD') + 1
#end

#if (${vvd} != '')
                           AND VVD.VSL_CD     = SUBSTR(@[vvd], 1, 4)
                           AND VVD.SKD_VOY_NO = SUBSTR(@[vvd], 5, 4)
                           AND VVD.SKD_DIR_CD = SUBSTR(@[vvd], 9, 1)
#end

#if (${pol_cd} != '')
                           AND BK.POL_CD = @[pol_cd]
#end
#if (${pod_cd} != '')
                           AND BK.POD_CD = @[pod_cd]
#end
#if (${del_cd} != '')
                           AND BK.DEL_CD = @[del_cd]
#end
#if (${bkg_ofc_cd} != '')
                           AND BK.BKG_OFC_CD = @[bkg_ofc_cd]
#end
#if (${bkg_stf_cd} != '')
                           AND UPPER(BK.DOC_USR_ID) = UPPER(@[bkg_stf_cd])
#end
#if (${sls_ofc_cd} != '')
                           AND BK.OB_SLS_OFC_CD = @[sls_ofc_cd]
#end
#if (${sales_rep} != '')
                           AND BK.OB_SREP_CD = @[sales_rep]
#end
#if (${bl_ofc_cd} != '')
                           AND ISS.OBL_ISS_OFC_CD = @[bl_ofc_cd]
#end
#if (${cust_tp_cd} != 'All' && ${cust_tp_cd} != '')
                           AND CUST.BKG_CUST_TP_CD = @[cust_tp_cd]
#end
#if (${cust_cnt_cd} != '')
                           AND CUST.CUST_CNT_CD = @[cust_cnt_cd]
#end
#if (${cust_seq} != '')
                           AND CUST.CUST_SEQ = TO_NUMBER(@[cust_seq])
#end
#if (${cust_nm} != '')
                           AND CUST.CUST_NM LIKE UPPER(@[cust_nm])||'%'
#end
                         GROUP BY BK.BKG_NO
                                , EDI_BY_CUST.GROUP_EDI_ID
                                , EDI_BY_CUST.EDI_RECEIVE_ID
                                , EDI_BY_CUST.RECEIVER_NAME
								, VVD.VSL_CD||VVD.SKD_VOY_NO||VVD.SKD_DIR_CD
                         UNION
                          SELECT /*+ INDEX(CUST XAK1BKG_CUSTOMER) */
                                  BK.BKG_NO
                                , '7SC' RANK
                                , EDI_BY_SC.GROUP_EDI_Id
                                , EDI_BY_SC.EDI_RECEIVE_ID
                                , EDI_BY_SC.RECEIVER_NAME
								, VVD.VSL_CD||VVD.SKD_VOY_NO||VVD.SKD_DIR_CD VVD
                          FROM BKG_CUSTOMER CUST
                                , BKG_BOOKING BK
                                , BKG_VVD VVD
								, BKG_BL_ISS ISS
                                , (SELECT  GRP.ESVC_GRP_CD          GROUP_EDI_ID
                                         , GRP.CUST_TRD_PRNR_ID     EDI_RECEIVE_ID
                                         , GRP.ESVC_GRP_NM          RECEIVER_NAME
                                         , GRP_CUST.SC_NO
                                         , GRP_CUST.BKG_CUST_TP_DESC
                                         , GRP_CUST.BKG_CTRT_TP_CD
                                   FROM BKG_EDI_GRP GRP, BKG_EDI_GRP_CUST GRP_CUST
                                  WHERE GRP.ESVC_GRP_CD         = GRP_CUST.ESVC_GRP_CD
                                    AND GRP.CO_CD               = GRP_CUST.CO_CD      
                                    AND GRP.CO_CD               = 'H'
                                    AND GRP.ESVC_GRP_DELT_FLG   = 'N'
                                    AND GRP_CUST.SC_NO          > ' '              
                                    AND GRP_CUST.DELT_FLG       = 'N'

#if (${msg_type_cd} == 'B')-- booking receipt
                                    AND GRP_CUST.BKG_CFM_FLG    = 'Y'
#end
#if (${msg_type_cd} == 'D')--draft b/l
                                    AND GRP_CUST.BL_DRFT_FLG    = 'Y'
#end

#if (${edi_group_id} != '' && ${edi_receive_nm} != '')
	#if(${edi_group_id} == 'G')--Group ID
                                    AND GRP.ESVC_GRP_CD  like @[edi_receive_nm]||'%'
	#end
	#if(${edi_group_id} == 'R')--Receive ID
                                    AND GRP.CUST_TRD_PRNR_ID like @[edi_receive_nm]||'%'
	#end
	#if(${edi_group_id} == 'N')--receive name
                                    AND GRP.ESVC_GRP_NM  like @[edi_receive_nm]||'%'
	#end
#end
                                    ) EDI_BY_SC
                         WHERE EDI_BY_SC.SC_NO  = DECODE(EDI_BY_SC.BKG_CTRT_TP_CD, '1', BK.SC_NO, '2', BK.RFA_NO)
                           AND BK.BKG_NO        = CUST.BKG_NO
                           AND BK.BKG_NO        = ISS.BKG_NO(+)
                           AND BK.BKG_NO        = VVD.BKG_NO
                           AND BK.POL_CD        = VVD.POL_CD
                           AND VVD.VSL_PRE_PST_CD IN ('T', 'S')
                           AND BK.BKG_STS_CD    IN ('F', 'A')
                           AND BK.BKG_CGO_TP_CD <> 'P'
                           AND DECODE(BKG_CUST_TP_DESC,'ALL','ALL',CUST.BKG_CUST_TP_CD)
                               IN (SELECT COLUMN_VALUE
                                     FROM TABLE(BKG_SPLIT_FNC(BKG_CUST_TP_DESC,',')))
                        ---------------------------조건절 시작   
#if (${bkg_no} != '')
                           AND BK.BKG_NO IN ( ${bkg_no} )
#end
#if (${bl_no} != '')
                           AND BK.BL_NO  = @[bl_no]
#end
                        ---------------------------bkg or b/l no입력시 다른 조건 제외함

#if (${bkg_from_dt} != '')
                           AND BK.BKG_CRE_DT > TO_DATE(@[bkg_from_dt], 'yyyy-mm-dd')
#end
#if (${bkg_to_dt} != '')
                           AND BK.BKG_CRE_DT < TO_DATE(@[bkg_to_dt],   'yyyy-mm-dd') + 1
#end

#if (${vvd} != '')
                           AND VVD.VSL_CD     = SUBSTR(@[vvd], 1, 4)
                           AND VVD.SKD_VOY_NO = SUBSTR(@[vvd], 5, 4)
                           AND VVD.SKD_DIR_CD = SUBSTR(@[vvd], 9, 1)
#end

#if (${pol_cd} != '')
                           AND BK.POL_CD = @[pol_cd]
#end
#if (${pod_cd} != '')
                           AND BK.POD_CD = @[pod_cd]
#end
#if (${del_cd} != '')
                           AND BK.DEL_CD = @[del_cd]
#end
#if (${bkg_ofc_cd} != '')
                           AND BK.BKG_OFC_CD = @[bkg_ofc_cd]
#end
#if (${bkg_stf_cd} != '')
                           AND BK.DOC_USR_ID = @[bkg_stf_cd]
#end
#if (${sls_ofc_cd} != '')
                           AND BK.OB_SLS_OFC_CD = @[sls_ofc_cd]
#end
#if (${sales_rep} != '')
                           AND BK.OB_SREP_CD = @[sales_rep]
#end
#if (${bl_ofc_cd} != '')
                           AND ISS.OBL_ISS_OFC_CD = @[bl_ofc_cd]
#end
#if (${cust_tp_cd} != 'All' && ${cust_tp_cd} != '')
                           AND CUST.BKG_CUST_TP_CD = @[cust_tp_cd]
#end
#if (${cust_cnt_cd} != '')
                           AND CUST.CUST_CNT_CD = @[cust_cnt_cd]
#end
#if (${cust_seq} != '')
                           AND CUST.CUST_SEQ = TO_NUMBER(@[cust_seq])
#end
#if (${cust_nm} != '')
                           AND CUST.CUST_NM LIKE UPPER(@[cust_nm])||'%'
#end
#if (${sc_no} != '')
                           AND BK.SC_NO = @[sc_no]
#end
                           )
                   GROUP BY BKG_NO
                        , GROUP_EDI_ID
                        , EDI_RECEIVE_ID
                        , RECEIVER_NAME
						, VVD) MST                
          WHERE MST.BKG_NO             = CUST.BKG_NO(+)
            AND SUBSTR(MST.RANK, 2, 1) = CUST.BKG_CUST_TP_CD(+)
            AND MST.BKG_NO             = BK.BKG_NO
            AND MST.BKG_NO             = NTC.BKG_NO    (+)
            AND 'E'                    = NTC.NTC_VIA_CD(+)

#if (${msg_type_cd} == 'B')-- booking receipt
            AND 'BK'                   = NTC.NTC_KND_CD(+)
#end
#if (${msg_type_cd} == 'D')--draft b/l
            AND 'BL'                   = NTC.NTC_KND_CD(+)
#end
			AND MST.EDI_RECEIVE_ID 	   = NTC.EDI_ID(+)
			AND MST.GROUP_EDI_ID   	   = NTC.ESVC_GRP_CD(+)
			
        ) MST
 WHERE 1 = 1
   AND ((HIS_SEQ IS NOT NULL AND HIS_SEQ = (SELECT MAX(HIS.HIS_SEQ) 
                                              FROM BKG_NTC_HIS HIS
                                             WHERE HIS.BKG_NO = MST.BKG_NO
                                               AND HIS.NTC_VIA_CD = MST.NTC_VIA_CD
                                               AND HIS.NTC_KND_CD = MST.NTC_KND_CD
											   AND HIS.EDI_ID     = MST.EDI_RECEIVE_ID
											   AND HIS.ESVC_GRP_CD= MST.GROUP_EDI_ID))
        OR
      (HIS_SEQ IS NULL))                                   
#if (${edi_sent_sts_cd} != 'All' && ${edi_sent_sts_cd} == 'Y')
 --edi_sent_status = sent
 AND SENT_DT IS NOT NULL
#end
#if (${edi_sent_sts_cd} != 'All' && ${edi_sent_sts_cd} == 'N')
 --edi_sent_status = unsent
 AND SENT_DT IS NULL
#end			]]></sql>
			<params>
				<param name="edi_receive_nm" type="12" value="" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
				<param name="bkg_from_dt" type="12" value="" out="N"/>
				<param name="bkg_to_dt" type="12" value="" out="N"/>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="del_cd" type="12" value="" out="N"/>
				<param name="bkg_ofc_cd" type="12" value="" out="N"/>
				<param name="bkg_stf_cd" type="12" value="" out="N"/>
				<param name="sls_ofc_cd" type="12" value="" out="N"/>
				<param name="sales_rep" type="12" value="" out="N"/>
				<param name="bl_ofc_cd" type="12" value="" out="N"/>
				<param name="cust_tp_cd" type="12" value="" out="N"/>
				<param name="cust_cnt_cd" type="12" value="" out="N"/>
				<param name="cust_seq" type="12" value="" out="N"/>
				<param name="cust_nm" type="12" value="" out="N"/>
				<param name="sc_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
