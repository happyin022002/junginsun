<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="WeeklyCMDBDAODemDetCostReportbyBKGRSQL">
			<desc><![CDATA[DEM/DET Cost Report by BKG 를 조회한다.]]></desc>
			<sql><![CDATA[
SELECT COST_YRMON
      ,COST_WK
      ,BKG_NO
      ,CNTR_NO
      ,CNTR_TPSZ_CD
      ,SC_NO
      ,RFA_NO
      ,CNTR_FM_NOD_CD
      ,IO_BND_CD
      ,CNTR_FM_DT
      ,CNTR_TO_DT
      ,CNTR_STAY_DYS
      ,FT_END_DT
      ,OVER_DYS
      ,INC_AMT
      ,BIL_AMT
      ,INV_CHG_AMT
      ,MRN_STO_WTHN
      ,RAIL_STO_WTHN
      ,CNTR_EQ_WTHN
      ,CHSS_ST_WTHN
      ,CHSS_COM_WTHN
      ,RF_HNDL_WTHN
      ,COST_TTL_WTHN
      ,MRN_STO_AFT
      ,RAIL_STO_AFT
      ,CNTR_EQ_AFT
      ,CHSS_ST_AFT
      ,CHSS_COM_AFT
      ,RF_HNDL_AFT
      ,COST_TTL_AFT
      ,STO_STATUS
      ,CNTR_STATUS
      ,CHSS_STATUS
      ,TTL_STATUS
  FROM (

        SELECT COST_YRMON
              ,COST_WK
              ,BKG_NO
              ,CNTR_NO
              ,CNTR_TPSZ_CD
              ,SC_NO
              ,RFA_NO
              ,CNTR_FM_NOD_CD
              ,IO_BND_CD
              ,CNTR_FM_DT
              ,CNTR_TO_DT
              ,CNTR_STAY_DYS
              ,FT_END_DT
              ,OVER_DYS
              ,INC_AMT
              ,BIL_AMT
              ,INV_CHG_AMT
              ,MRN_STO_WTHN
              ,RAIL_STO_WTHN
              ,CNTR_EQ_WTHN
              ,CHSS_ST_WTHN
              ,CHSS_COM_WTHN
              ,RF_HNDL_WTHN
              ,COST_TTL_WTHN
              ,MRN_STO_AFT
              ,RAIL_STO_AFT
              ,CNTR_EQ_AFT
              ,CHSS_ST_AFT
              ,CHSS_COM_AFT
              ,RF_HNDL_AFT
              ,COST_TTL_AFT
              ,CASE WHEN STO_STATUS > 0 THEN 'Finished'
                    ELSE 'Unfinished' END STO_STATUS
              ,CASE WHEN CNTR_STATUS > 0 THEN 'Finished'
                    ELSE 'Unfinished' END CNTR_STATUS
              ,CASE WHEN CHSS_STATUS > 0 THEN 'Finished'
                    ELSE 'Unfinished' END CHSS_STATUS
              ,CASE WHEN (SELECT COUNT(1) from MAS_DMDT_COST_RPT_BKG_DTL D
                          WHERE D.BKG_NO = M.BKG_NO
                            AND D.CNTR_NO = M.CNTR_NO
                            AND D.ITM_NM LIKE '%CNTR%'
                            AND D.CNTR_FM_MVMT_STS_CD = 'ID') = 0 THEN
                          'Unfinished'
                    ELSE
                        CASE WHEN (SELECT COUNT(1) from MAS_DMDT_COST_RPT_BKG_DTL D
                                      WHERE D.BKG_NO = M.BKG_NO
                                        AND D.CNTR_NO = M.CNTR_NO
                                        AND D.ITM_NM LIKE '%CNTR%'
                                        AND D.CNTR_FM_MVMT_STS_CD = 'ID'
                                        AND D.CNTR_TO_MVMT_STS_CD IS NULL) = 0 THEN 'Finished'
                             ELSE 'Unfinished'
                        END
               END TTL_STATUS

         FROM (
                SELECT B.COST_YRMON
                      ,B.COST_WK
                      ,A.BKG_NO
                      ,A.CNTR_NO
                      ,A.CNTR_TPSZ_CD
                      ,A.SC_NO
                      ,A.RFA_NO
                      ,A.CNTR_FM_NOD_CD
                      ,A.IO_BND_CD
                      ,TO_CHAR(MIN(A.CNTR_FM_DT), 'YYYY-MM-DD') AS CNTR_FM_DT
                      ,TO_CHAR(MAX(A.CNTR_TO_DT), 'YYYY-MM-DD') AS CNTR_TO_DT
                      ,SUM(A.CNTR_STAY_DYS) AS CNTR_STAY_DYS
                      ,TO_CHAR(MAX(A.FT_END_DT), 'YYYY-MM-DD') AS FT_END_DT
                      ,CASE WHEN MAX(A.CNTR_TO_DT) - MAX(A.FT_END_DT) < 0
                            THEN -FLOOR(ABS(MAX(A.CNTR_TO_DT) - MAX(A.FT_END_DT)))
                            ELSE FLOOR(MAX(A.CNTR_TO_DT) - MAX(A.FT_END_DT)) END OVER_DYS
                      ,ROUND(NVL(SUM(A.ORG_CHG_AMT), 0), 2) AS INC_AMT
                      ,ROUND(NVL(SUM(A.BIL_AMT), 0), 2) AS BIL_AMT
                      ,ROUND(NVL(SUM(A.INV_CHG_AMT), 0), 2) AS INV_CHG_AMT
                      ,ROUND(NVL(SUM(A.MRN_STO_WTHN), 0), 2) AS MRN_STO_WTHN
                      ,ROUND(NVL(SUM(A.RAIL_STO_WTHN), 0), 2) AS RAIL_STO_WTHN
                      ,ROUND(NVL(SUM(A.CNTR_EQ_WTHN), 0), 2) AS CNTR_EQ_WTHN
                      ,ROUND(NVL(SUM(A.CHSS_ST_WTHN), 0), 2) AS CHSS_ST_WTHN
                      ,ROUND(NVL(SUM(A.CHSS_COM_WTHN), 0), 2) AS CHSS_COM_WTHN
                      ,ROUND(NVL(SUM(A.RF_HNDL_WTHN), 0), 2) AS RF_HNDL_WTHN
                      ,ROUND(NVL(SUM(A.MRN_STO_WTHN) + SUM(A.RAIL_STO_WTHN) + SUM(A.CNTR_EQ_WTHN) + SUM(A.CHSS_ST_WTHN) + SUM(A.CHSS_COM_WTHN) + SUM(A.RF_HNDL_WTHN), 0), 2) AS COST_TTL_WTHN
                      ,ROUND(NVL(SUM(A.MRN_STO_AFT), 0), 2) AS MRN_STO_AFT
                      ,ROUND(NVL(SUM(A.RAIL_STO_AFT), 0), 2) AS RAIL_STO_AFT
                      ,ROUND(NVL(SUM(A.CNTR_EQ_AFT), 0), 2) AS CNTR_EQ_AFT
                      ,ROUND(NVL(SUM(A.CHSS_ST_AFT), 0), 2) AS CHSS_ST_AFT
                      ,ROUND(NVL(SUM(A.CHSS_COM_AFT), 0), 2) AS CHSS_COM_AFT
                      ,ROUND(NVL(SUM(A.RF_HNDL_AFT), 0), 2) AS RF_HNDL_AFT
                      ,ROUND(NVL(SUM(A.MRN_STO_AFT) + SUM(A.RAIL_STO_AFT) + SUM(A.CNTR_EQ_AFT) + SUM(A.CHSS_ST_AFT) + SUM(A.CHSS_COM_AFT) + SUM(A.RF_HNDL_AFT), 0), 2) AS COST_TTL_AFT
                      ,SUM(A.STO_STATUS) AS STO_STATUS
                      ,SUM(A.CNTR_STATUS) AS CNTR_STATUS
                      ,SUM(A.CHSS_STATUS) AS CHSS_STATUS
                  FROM (
                        SELECT BKG_NO
                              ,CNTR_NO
                              ,CNTR_TPSZ_CD
                              ,SC_NO
                              ,RFA_NO
                              ,CNTR_FM_NOD_CD
                              ,CASE WHEN TRF_CD = ''
                                    THEN ''
                                    WHEN TRF_CD IN ('DTIC/CTIC', 'DMIF/CTIC', 'DMIF', 'DTIC', 'CTIC')
                                    THEN 'I/B'
                                    ELSE 'O/B' END IO_BND_CD
                              ,CNTR_FM_DT
                              ,CNTR_TO_DT
                              ,CNTR_STAY_DYS
                              ,FT_END_DT
                              ,ORG_CHG_AMT
                              ,BIL_AMT
                              ,INV_CHG_AMT
                              ,DECODE(SUBSTR(ITM_NM, 5), 'MRN_STO', COST_WTHN_FT_AMT, 0) AS MRN_STO_WTHN
                              ,DECODE(SUBSTR(ITM_NM, 5), 'RAIL_STO', COST_WTHN_FT_AMT, 0) AS RAIL_STO_WTHN
                              ,DECODE(SUBSTR(ITM_NM, 5), 'CNTR_EQ', COST_WTHN_FT_AMT, 0) AS CNTR_EQ_WTHN
                              ,DECODE(SUBSTR(ITM_NM, 5), 'CHSS_ST', COST_WTHN_FT_AMT, 0) AS CHSS_ST_WTHN
                              ,DECODE(SUBSTR(ITM_NM, 5), 'CHSS_COM', COST_WTHN_FT_AMT, 0) AS CHSS_COM_WTHN
                              ,DECODE(SUBSTR(ITM_NM, 5), 'RF_HNDL', COST_WTHN_FT_AMT, 0) AS RF_HNDL_WTHN
                              ,DECODE(SUBSTR(ITM_NM, 5), 'MRN_STO', COST_AFT_FT_AMT, 0) AS MRN_STO_AFT
                              ,DECODE(SUBSTR(ITM_NM, 5), 'RAIL_STO', COST_AFT_FT_AMT, 0) AS RAIL_STO_AFT
                              ,DECODE(SUBSTR(ITM_NM, 5), 'CNTR_EQ', COST_AFT_FT_AMT, 0) AS CNTR_EQ_AFT
                              ,DECODE(SUBSTR(ITM_NM, 5), 'CHSS_ST', COST_AFT_FT_AMT, 0) AS CHSS_ST_AFT
                              ,DECODE(SUBSTR(ITM_NM, 5), 'CHSS_COM', COST_AFT_FT_AMT, 0) AS CHSS_COM_AFT
                              ,DECODE(SUBSTR(ITM_NM, 5), 'RF_HNDL', COST_AFT_FT_AMT, 0) AS RF_HNDL_AFT
                              ,CASE WHEN (SELECT COUNT(1) FROM MAS_DMDT_COST_RPT_BKG_DTL D
                                          WHERE D.BKG_NO = DTL.BKG_NO
                                            AND D.CNTR_NO = DTL.CNTR_NO
                                            AND D.ITM_NM LIKE '%STO%'
                                            AND D.CNTR_FM_MVMT_STS_CD IS NOT NULL
                                            AND D.CNTR_TO_MVMT_STS_CD IS NULL) = 0 THEN 1
                                     ELSE 0
                               END STO_STATUS
                              ,CASE WHEN (SELECT COUNT(1) FROM MAS_DMDT_COST_RPT_BKG_DTL D
                                          WHERE D.BKG_NO = DTL.BKG_NO
                                            AND D.CNTR_NO = DTL.CNTR_NO
                                            AND D.ITM_NM LIKE '%CNTR%'
                                            AND D.CNTR_FM_MVMT_STS_CD IS NOT NULL
                                            AND D.CNTR_TO_MVMT_STS_CD IS NULL) = 0 THEN 1
                                     ELSE 0
                               END CNTR_STATUS
                              ,CASE WHEN (SELECT COUNT(1) FROM MAS_DMDT_COST_RPT_BKG_DTL D
                                          WHERE D.BKG_NO = DTL.BKG_NO
                                            AND D.CNTR_NO = DTL.CNTR_NO
                                            AND D.ITM_NM LIKE '%CHSS%'
                                            AND D.CNTR_FM_MVMT_STS_CD IS NOT NULL
                                            AND D.CNTR_TO_MVMT_STS_CD IS NULL) = 0 THEN 1
                                     ELSE 0
                               END CHSS_STATUS
                          FROM MAS_DMDT_COST_RPT_BKG_DTL DTL
                          WHERE 1 = 1
							AND NVL(DMDT_CHG_STS_CD, 'F') IN ('F', 'L', 'N', 'U', 'C', 'I')
                            #if(${f_bkg_no} != '')
                               AND BKG_NO = @[f_bkg_no]
                            #end
                            #if(${f_cntr_no} != '')
                               AND CNTR_NO = @[f_cntr_no]
                            #end
                            #if(${f_cntr_ofc_cd} != '')
                               AND CNTR_OFC_CD = @[f_cntr_ofc_cd]
                            #end
                            #if(${f_por_cd} != '')
                               AND POR_CD = @[f_por_cd]
                            #end
                            #if(${f_del_cd} != '')
                               AND DEL_CD = @[f_del_cd]
                            #end
                            #if(${f_cntr_tpsz_cd} != '')
                               AND CNTR_TPSZ_CD = @[f_cntr_tpsz_cd]
                            #end
                            #if(${f_sc_no} != '')
                               AND SC_NO = @[f_sc_no]
                            #end
                            #if(${f_rfa_no} != '')
                               AND SC_NO = @[f_rfa_no]
                            #end
                            #if(${f_loc_cd} != '')
                               AND CNTR_FM_NOD_CD LIKE @[f_loc_cd]||'%'
                            #end
                        ) A, MAS_BKG_EXPN_DTL B
                   WHERE 1=1
                         AND A.BKG_NO = B.BKG_NO
                         AND A.CNTR_TPSZ_CD = B.CNTR_TPSZ_CD
                      #if(${f_year} != '')
                         #if(${f_chkprd} =='M')
                         AND B.COST_YRMON    BETWEEN @[f_year]||@[f_fm_mon] AND @[f_year]||@[f_to_mon]
                         #elseif (${f_chkprd} =='W')
                         AND B.SLS_YRMON     LIKE @[f_year]||@[f_sls_mon]||'%'
                         AND B.COST_WK       BETWEEN @[f_fm_wk] AND @[f_to_wk]
                         #end
                      #end
                GROUP BY B.COST_YRMON
                        ,B.COST_WK
                        ,A.BKG_NO
                        ,A.CNTR_NO
                        ,A.CNTR_TPSZ_CD
                        ,A.SC_NO
                        ,A.RFA_NO
                        ,A.CNTR_FM_NOD_CD
                        ,A.IO_BND_CD
                ORDER BY B.COST_YRMON, B.COST_WK, A.BKG_NO, A.CNTR_NO, A.CNTR_TPSZ_CD
              ) M
       )
WHERE 1=1
#if(${f_status} != '')
    #if(${f_status} == 'F')
      AND (TTL_STATUS = 'Finished')
    #elseif(${f_status} == 'U')
      AND TTL_STATUS = 'Unfinished'
    #end
#end			]]></sql>
			<params>
				<param name="f_bkg_no" type="12" value="" out="N"/>
				<param name="f_cntr_no" type="12" value="" out="N"/>
				<param name="f_cntr_ofc_cd" type="12" value="" out="N"/>
				<param name="f_por_cd" type="12" value="" out="N"/>
				<param name="f_del_cd" type="12" value="" out="N"/>
				<param name="f_cntr_tpsz_cd" type="12" value="" out="N"/>
				<param name="f_sc_no" type="12" value="" out="N"/>
				<param name="f_rfa_no" type="12" value="" out="N"/>
				<param name="f_loc_cd" type="12" value="" out="N"/>
				<param name="f_year" type="12" value="" out="N"/>
				<param name="f_fm_mon" type="12" value="" out="N"/>
				<param name="f_to_mon" type="12" value="" out="N"/>
				<param name="f_sls_mon" type="12" value="" out="N"/>
				<param name="f_fm_wk" type="12" value="" out="N"/>
				<param name="f_to_wk" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
