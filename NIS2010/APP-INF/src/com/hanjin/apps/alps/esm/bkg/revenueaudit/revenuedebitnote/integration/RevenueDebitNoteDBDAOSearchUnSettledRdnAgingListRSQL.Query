<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="RevenueDebitNoteDBDAOSearchUnSettledRdnAgingListRSQL">
			<desc><![CDATA[unsettled rdn aging list를 조회한다.]]></desc>
			<sql><![CDATA[
SELECT RCT_RHQ_CD
      ,BKG_OFC_CD
      ,(SELECT UMCH_TP_DESC FROM BKG_REV_UMCH_TP WHERE UMCH_TP_CD = BKG.UMCH_TP_CD) UMCH_TP_CD
      ,SUM(CASE WHEN RDN_AGE_DYS BETWEEN 0 AND 10 THEN 1 ELSE 0 END) WITHIN_10_DYS
      ,SUM(CASE WHEN RDN_AGE_DYS BETWEEN 11 AND 20 THEN 1 ELSE 0 END) WITHIN_20_DYS
      ,SUM(CASE WHEN RDN_AGE_DYS BETWEEN 21 AND 30 THEN 1 ELSE 0 END) WITHIN_30_DYS
      ,SUM(CASE WHEN RDN_AGE_DYS BETWEEN 31 AND 60 THEN 1 ELSE 0 END) WITHIN_60_DYS
      ,SUM(CASE WHEN RDN_AGE_DYS BETWEEN 61 AND 90 THEN 1 ELSE 0 END) WITHIN_90_DYS
      ,SUM(CASE WHEN RDN_AGE_DYS > 90 THEN 1 ELSE 0 END) OVER_90_DYS
      ,COUNT(1) TOTAL_CNT
      ,'' rdn_knd_cd
  FROM (
        SELECT  DR.RCT_RHQ_CD
               ,DR.RCT_OFC_CD BKG_OFC_CD
               ,DR.UMCH_TP_CD
               ,TRUNC(SYSDATE) - TRUNC(DR.RDN_ISS_DT) RDN_AGE_DYS
          FROM BKG_REV_DR_NOTE DR
          WHERE ( DR.RDN_NO, DR.RVIS_SEQ )  IN  (
                                                    SELECT  RDN_NO        ,
                                                            MAX(RVIS_SEQ)
                                                    FROM    BKG_REV_DR_NOTE
                                                    GROUP BY
                                                            RDN_NO
                                                    )
            AND DR.RDN_STS_CD NOT IN ('CL','CV','ST') -- UNSETTLE건만
#if (${rdn_knd_cd} != '') 
            AND DR.RDN_KND_CD = @[rdn_knd_cd]
#end
#if (${rct_rhq_cd} != '') 
            AND DR.RCT_RHQ_CD = @[rct_rhq_cd]
#end
#if (${bkg_ofc_cd} != '') 
            AND DR.RCT_OFC_CD = @[bkg_ofc_cd]
#end

    ) BKG
WHERE RCT_RHQ_CD IS NOT NULL
GROUP BY RCT_RHQ_CD, BKG_OFC_CD, UMCH_TP_CD
UNION ALL 
SELECT RCT_RHQ_CD
      ,'' BKG_OFC_CD
      ,(SELECT UMCH_TP_DESC FROM BKG_REV_UMCH_TP WHERE UMCH_TP_CD = BKG.UMCH_TP_CD) UMCH_TP_CD
      ,SUM(CASE WHEN RDN_AGE_DYS BETWEEN 0 AND 10 THEN 1 ELSE 0 END) WITHIN_10_DYS
      ,SUM(CASE WHEN RDN_AGE_DYS BETWEEN 11 AND 20 THEN 1 ELSE 0 END) WITHIN_20_DYS
      ,SUM(CASE WHEN RDN_AGE_DYS BETWEEN 21 AND 30 THEN 1 ELSE 0 END) WITHIN_30_DYS
      ,SUM(CASE WHEN RDN_AGE_DYS BETWEEN 31 AND 60 THEN 1 ELSE 0 END) WITHIN_60_DYS
      ,SUM(CASE WHEN RDN_AGE_DYS BETWEEN 61 AND 90 THEN 1 ELSE 0 END) WITHIN_90_DYS
      ,SUM(CASE WHEN RDN_AGE_DYS > 90 THEN 1 ELSE 0 END) OVER_90_DYS
      ,COUNT(1) TOTAL_CNT
      ,'' rdn_knd_cd
  FROM (
        SELECT  DR.RCT_RHQ_CD
               ,DR.RCT_OFC_CD BKG_OFC_CD
               ,DR.UMCH_TP_CD
               ,TRUNC(SYSDATE) - TRUNC(DR.RDN_ISS_DT) RDN_AGE_DYS
          FROM BKG_REV_DR_NOTE DR
          WHERE ( DR.RDN_NO, DR.RVIS_SEQ )  IN  (
                                                    SELECT  RDN_NO        ,
                                                            MAX(RVIS_SEQ)
                                                    FROM    BKG_REV_DR_NOTE
                                                    GROUP BY
                                                            RDN_NO
                                                    )
            AND DR.RDN_STS_CD NOT IN ('CL','CV','ST') -- UNSETTLE건만
#if (${rdn_knd_cd} != '') 
            AND DR.RDN_KND_CD = @[rdn_knd_cd]
#end
#if (${rct_rhq_cd} != '') 
            AND DR.RCT_RHQ_CD = @[rct_rhq_cd]
#end
#if (${bkg_ofc_cd} != '') 
            AND DR.RCT_OFC_CD = @[bkg_ofc_cd]
#end
    ) BKG
WHERE RCT_RHQ_CD IS NOT NULL
GROUP BY RCT_RHQ_CD, UMCH_TP_CD
#if (${rct_rhq_cd} == '') 
UNION ALL 
SELECT '' RCT_RHQ_CD
      ,'Total' BKG_OFC_CD
      ,(SELECT UMCH_TP_DESC FROM BKG_REV_UMCH_TP WHERE UMCH_TP_CD = BKG.UMCH_TP_CD) UMCH_TP_CD
      ,SUM(CASE WHEN RDN_AGE_DYS BETWEEN 0 AND 10 THEN 1 ELSE 0 END) WITHIN_10_DYS
      ,SUM(CASE WHEN RDN_AGE_DYS BETWEEN 11 AND 20 THEN 1 ELSE 0 END) WITHIN_20_DYS
      ,SUM(CASE WHEN RDN_AGE_DYS BETWEEN 21 AND 30 THEN 1 ELSE 0 END) WITHIN_30_DYS
      ,SUM(CASE WHEN RDN_AGE_DYS BETWEEN 31 AND 60 THEN 1 ELSE 0 END) WITHIN_60_DYS
      ,SUM(CASE WHEN RDN_AGE_DYS BETWEEN 61 AND 90 THEN 1 ELSE 0 END) WITHIN_90_DYS
      ,SUM(CASE WHEN RDN_AGE_DYS > 90 THEN 1 ELSE 0 END) OVER_90_DYS
      ,COUNT(1) TOTAL_CNT
      ,'' rdn_knd_cd
  FROM (
        SELECT  DR.RCT_RHQ_CD
               ,DR.RCT_OFC_CD BKG_OFC_CD
               ,DR.UMCH_TP_CD
               ,TRUNC(SYSDATE) - TRUNC(DR.RDN_ISS_DT) RDN_AGE_DYS
          FROM BKG_REV_DR_NOTE DR
          WHERE ( DR.RDN_NO, DR.RVIS_SEQ )  IN  (
                                                    SELECT  RDN_NO        ,
                                                            MAX(RVIS_SEQ)
                                                    FROM    BKG_REV_DR_NOTE
                                                    GROUP BY
                                                            RDN_NO
                                                    )
            AND DR.RDN_STS_CD NOT IN ('CL','CV','ST') -- UNSETTLE건만
#if (${rdn_knd_cd} != '') 
            AND DR.RDN_KND_CD = @[rdn_knd_cd]
#end
#if (${rct_rhq_cd} != '') 
            AND DR.RCT_RHQ_CD = @[rct_rhq_cd]
#end
#if (${bkg_ofc_cd} != '') 
            AND DR.RCT_OFC_CD = @[bkg_ofc_cd]
#end
    ) BKG
WHERE RCT_RHQ_CD IS NOT NULL
GROUP BY UMCH_TP_CD
#end
ORDER BY RCT_RHQ_CD, BKG_OFC_CD, UMCH_TP_CD			]]></sql>
			<params>
				<param name="rdn_knd_cd" type="12" value="" out="N"/>
				<param name="rct_rhq_cd" type="12" value="" out="N"/>
				<param name="bkg_ofc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
