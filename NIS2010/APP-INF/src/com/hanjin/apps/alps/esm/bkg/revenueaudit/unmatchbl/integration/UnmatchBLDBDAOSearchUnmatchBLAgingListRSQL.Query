<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="UnmatchBLDBDAOSearchUnmatchBLAgingListRSQL">
			<desc><![CDATA[unmatch bl aging list를 조회한다.]]></desc>
			<sql><![CDATA[
SELECT RCT_RHQ_CD
      ,BKG_OFC_CD
      ,SUM(CASE WHEN ERR_BL_AGE_DYS BETWEEN 0 AND 7 THEN 1 ELSE 0 END) WITHIN_7_DYS
      ,SUM(CASE WHEN ERR_BL_AGE_DYS BETWEEN 8 AND 15 THEN 1 ELSE 0 END) WITHIN_15_DYS
      ,SUM(CASE WHEN ERR_BL_AGE_DYS BETWEEN 16 AND 30 THEN 1 ELSE 0 END) WITHIN_30_DYS
      ,SUM(CASE WHEN ERR_BL_AGE_DYS BETWEEN 31 AND 45 THEN 1 ELSE 0 END) WITHIN_45_DYS
      ,SUM(CASE WHEN ERR_BL_AGE_DYS BETWEEN 46 AND 60 THEN 1 ELSE 0 END) WITHIN_60_DYS
      ,SUM(CASE WHEN ERR_BL_AGE_DYS BETWEEN 61 AND 90 THEN 1 ELSE 0 END) WITHIN_90_DYS
      ,SUM(CASE WHEN ERR_BL_AGE_DYS > 90 THEN 1 ELSE 0 END) OVER_90_DYS
      ,COUNT(1) TOTAL_CNT
      ,'' BDR_FLG
      
  FROM (
        SELECT (
                SELECT A.OFC_CD
                FROM   MDM_ORGANIZATION A
                WHERE  A.OFC_TP_CD = 'HQ'
                START  WITH A.OFC_CD = BK.BKG_OFC_CD
                CONNECT BY PRIOR A.PRNT_OFC_CD = A.OFC_CD
                ) RCT_RHQ_CD  
             ,BK.BKG_OFC_CD 
             ,DC.BDR_FLG 
             ,TRUNC(SYSDATE) - TRUNC(UB.N1ST_UMCH_FND_DT) ERR_BL_AGE_DYS 
         FROM BKG_REV_UMCH_BKG  UB
             ,BKG_BOOKING       BK
             ,BKG_BL_DOC        DC
        WHERE BK.BKG_NO = UB.BKG_NO
          AND BK.BKG_CGO_TP_CD = 'F'
          AND EXISTS ( SELECT  'Y'
                         FROM BKG_REV_UMCH_ITM ITM
                         WHERE ITM.BKG_NO = UB.BKG_NO
                         AND ITM.UMCH_BKG_SEQ = UB.UMCH_BKG_SEQ
                         AND ITM.UMCH_BKG_SEQ = ( SELECT MAX(UMCH_BKG_SEQ) FROM BKG_REV_UMCH_ITM WHERE BKG_NO = ITM.BKG_NO ) 
                         AND  ROWNUM = 1
                     )

          AND UB.REV_AUD_STS_CD = 'U'
          AND BK.BKG_NO = DC.BKG_NO
#if (${bkg_ofc_cd} != '') 
          AND BK.BKG_OFC_CD  = @[bkg_ofc_cd]
#end
#if (${bdr_flg} != '') 
          AND DC.BDR_FLG = @[bdr_flg]
#end
        )
  WHERE RCT_RHQ_CD IS NOT NULL
#if (${rct_rhq_cd} != '') 
    AND RCT_RHQ_CD = @[rct_rhq_cd]
#end
GROUP BY RCT_RHQ_CD, BKG_OFC_CD
ORDER BY RCT_RHQ_CD, BKG_OFC_CD			]]></sql>
			<params>
				<param name="bkg_ofc_cd" type="12" value="" out="N"/>
				<param name="bdr_flg" type="12" value="" out="N"/>
				<param name="rct_rhq_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
