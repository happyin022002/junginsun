<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="UsaManifestListDownloadDBDAOsearchManifestSummaryOBRSQL">
			<desc><![CDATA[UsaManifestListDownloadDBDAOsearchManifestSummaryOB]]></desc>
			<sql><![CDATA[
SELECT  NVL(TB.VSL_CD,' ')||NVL(TB.SKD_VOY_NO,' ')||NVL(TB.SKD_DIR_CD,' ') VVD
       ,TB.CSTMS_POL_CD POL
       ,TB.CSTMS_POD_CD POD   
       ,CASE WHEN MAX(VPS_ETA_DT) IS NULL THEN ' ' ELSE TO_CHAR(MAX(VPS_ETA_DT), 'YYYYMMDD HH24') || 'h' END ETA  
       ,MAX(FROB) FROB
       ,CASE WHEN SND_DT IS NULL THEN ' ' ELSE TO_CHAR(SND_DT, 'YYYYMMDD HH24') || 'h' END SENT_TIME
       ,MAX(XI) XI
       ,COUNT(DISTINCT CNTR_NO) CNTR_COUNT
       ,COUNT(DISTINCT BKG_NO) BL_COUNT
       ,CSTMS_PORT_CD  CUSTOMS
  FROM  (
        SELECT VVD.VSL_CD
               ,VVD.SKD_VOY_NO
               ,VVD.SKD_DIR_CD
               ,VVD.POL_CD AS CSTMS_POL_CD
               ,SKD1.VPS_ETD_DT AS VPS_ETD_DT
               ,VVD.POD_CD AS CSTMS_POD_CD
               ,SKD2.VPS_ETA_DT AS VPS_ETA_DT
               ,(SELECT MIN(CLPT_SEQ)
                   FROM VSK_VSL_PORT_SKD
                  WHERE	SUBSTR(VPS_PORT_CD,1,2)	IN('US', (SELECT ATTR_CTNT1 FROM BKG_CSTMS_CD_CONV_CTNT 
                                                                                    WHERE CNT_cD='US'
                                                                                    AND CSTMS_DIV_ID= 'US_CNT_CD_LIST') 
                                                                        )                             

                    AND VSL_CD = VVD.VSL_CD
                    AND SKD_VOY_NO = VVD.SKD_VOY_NO
                    AND SKD_DIR_CD = VVD.SKD_DIR_CD
                )AS MIN_CLPT_SEQ
               ,SKD2.CLPT_SEQ AS ETA_CLPT_SEQ
               ,(SELECT MAX(CLPT_SEQ)
                   FROM VSK_VSL_PORT_SKD
                  WHERE	SUBSTR(VPS_PORT_CD,1,2)	IN('US', (SELECT ATTR_CTNT1 FROM BKG_CSTMS_CD_CONV_CTNT 
                                                                                    WHERE CNT_cD='US'
                                                                                    AND CSTMS_DIV_ID= 'US_CNT_CD_LIST') 
                                                                        )                             

                    AND VSL_CD = VVD.VSL_CD
                    AND SKD_VOY_NO = VVD.SKD_VOY_NO
                    AND SKD_DIR_CD = VVD.SKD_DIR_CD
                )AS MAX_CLPT_SEQ
               ,SKD1.CLPT_SEQ POL_CLPT_SEQ
			   ,SKD2.CLPT_SEQ POD_CLPT_SEQ
               ,(SELECT SUBSTR( MIN( LPAD(CLPT_SEQ, 2, 0) ||VPS_PORT_CD) , 3)
                            FROM VSK_VSL_PORT_SKD
                           WHERE 1=1
                             AND	SUBSTR(VPS_PORT_CD,1,2)	IN('US', (SELECT ATTR_CTNT1 FROM BKG_CSTMS_CD_CONV_CTNT 
                                                                                            WHERE CNT_cD='US'
                                                                                            AND CSTMS_DIV_ID= 'US_CNT_CD_LIST') 
                                                                                )                             

                             AND VSL_CD = VVD.VSL_CD
                             AND SKD_VOY_NO = VVD.SKD_VOY_NO
                             AND SKD_DIR_CD = VVD.SKD_DIR_CD
                             AND CLPT_IND_SEQ = '1' 
               ) AS CSTMS_PORT_CD
		       ,CASE WHEN INSTR(VVD.POL_CD, 'US') != 1 THEN
		           DECODE(
		               (SELECT Y.VPS_PORT_CD 
		                FROM VSK_VSL_PORT_SKD Y
		                WHERE  Y.VSL_CD = VVD.VSL_CD AND Y.SKD_VOY_NO = VVD.SKD_VOY_NO AND Y.SKD_DIR_CD = VVD.SKD_DIR_CD
		                   AND Y.CLPT_SEQ =  (SELECT MIN(X.CLPT_SEQ) AS SEQ
									                       FROM VSK_VSL_PORT_SKD X
									                       WHERE X.VSL_CD = VVD.VSL_CD AND X.SKD_VOY_NO = VVD.SKD_VOY_NO AND X.SKD_DIR_CD = VVD.SKD_DIR_CD AND X.VPS_PORT_CD LIKE 'US%')
		                   AND Y.VPS_PORT_CD LIKE 'US%'
		               ), NULL, 'N', 'Y' 
		           )   
			       ELSE 'N'
			       END  FROB
			       ,CASE WHEN S.SND_DT  IS NULL THEN ' ' ELSE TO_CHAR(S.SND_DT, 'YYYYMMDD HH24') || 'h' END SENT_TIME
                   #if (${full_empty} == 'M')
                   		,DECODE(S.TRSM_MSG_TP_ID||S.CGO_TP_CD, 'XIM', 'Y', 'XI', 'Y', 'N') XI
                   	#end
                   	#if (${full_empty} == 'F') 
                   		,DECODE(S.TRSM_MSG_TP_ID||S.CGO_TP_CD, 'XIF', 'Y', 'XI', 'Y', 'N') XI
                   	#end
                   ,S.SND_DT
                   ,S.TRSM_MSG_TP_ID, S.CGO_TP_CD
                   ,B.CNTR_NO
                   ,VVD.BKG_NO
          FROM  BKG_VVD VVD 
               ,BKG_BOOKING BKG
               ,VSK_VSL_PORT_SKD SKD1
               ,VSK_VSL_PORT_SKD SKD2
			 ,(
		        SELECT *
		        FROM BKG_CSTMS_ADV_SND_LOG
		        WHERE CNT_CD = 'US'
		        AND IO_BND_CD = 'O'
		        AND TRSM_MSG_TP_ID = 'XI'
		        AND VSL_CD = SUBSTR(@[vvd],1,4) 
		        AND SKD_VOY_NO = SUBSTR(@[vvd],5,4)
		        AND SKD_DIR_CD = SUBSTR(@[vvd],9,1)
		        AND POL_CD LIKE NVL(@[pol],'%')
		        AND POD_CD LIKE NVL(@[pod],'%') 
		        AND DELT_FLG = 'N'
				AND NVL(CGO_TP_CD, 'X') = DECODE(NVL(CGO_TP_CD,'X'), 'X', 'X', @[full_empty])
                AND (CGO_TP_CD = 'F' OR CGO_TP_CD = 'R' OR CGO_TP_CD is null)
		        AND SND_DT IN (
		            SELECT MAX(SND_DT)
		            FROM BKG_CSTMS_ADV_SND_LOG
		            WHERE CNT_CD = 'US'
		            AND IO_BND_CD = 'O'
		            AND TRSM_MSG_TP_ID = 'XI'
		            AND VSL_CD = SUBSTR(@[vvd],1,4) 
		            AND SKD_VOY_NO = SUBSTR(@[vvd],5,4)
		            AND SKD_DIR_CD = SUBSTR(@[vvd],9,1)
		            AND POL_CD LIKE NVL(@[pol],'%')
		            AND POD_CD LIKE NVL(@[pod],'%') 
		            AND DELT_FLG = 'N'
		            AND NVL(CGO_TP_CD, 'X') = DECODE(NVL(CGO_TP_CD,'X'), 'X', 'X', @[full_empty])
                    AND (CGO_TP_CD = 'F' OR CGO_TP_CD = 'R' OR CGO_TP_CD is null)
					GROUP BY CNT_CD, IO_BND_CD, TRSM_MSG_TP_ID, VSL_CD, SKD_VOY_NO, SKD_DIR_CD, POL_CD, POD_CD
		            )
			   ) S           
			   ,BKG_CONTAINER  B               
         WHERE  VVD.BKG_NO        = BKG.BKG_NO
           AND  VVD.VSL_CD        = SUBSTR(@[vvd],1,4) 
           AND  VVD.SKD_VOY_NO    = SUBSTR(@[vvd],5,4) 
           AND  VVD.SKD_DIR_CD    = SUBSTR(@[vvd],9,1) 
           AND  BKG.BKG_STS_CD IN ('F', 'W')
           AND  BKG.BL_NO IS NOT NULL
#if (${pol} != '') 
           AND  VVD.POL_CD = @[pol]
#end
#if (${pod} != '') 
           AND  VVD.POD_CD = @[pod]
#end
#if (${full_empty} == 'F') 
           AND  BKG.BKG_CGO_TP_CD IN ('F', 'R')
#end
#if (${full_empty} == 'M') 
           AND  BKG.BKG_CGO_TP_CD = 'P'
#end
           AND  VVD.VSL_CD         = SKD1.VSL_CD
           AND  VVD.SKD_VOY_NO     = SKD1.SKD_VOY_NO
           AND  VVD.SKD_DIR_CD     = SKD1.SKD_DIR_CD
           AND  VVD.POL_CD         = SKD1.VPS_PORT_CD
           AND  SKD1.CLPT_IND_SEQ = 1
           AND  VVD.VSL_CD         = SKD2.VSL_CD
           AND  VVD.SKD_VOY_NO     = SKD2.SKD_VOY_NO
           AND  VVD.SKD_DIR_CD     = SKD2.SKD_DIR_CD
           AND  VVD.POD_CD         = SKD2.VPS_PORT_CD
           AND  SKD2.CLPT_IND_SEQ = 1
           
	       AND 'US' = S.CNT_CD(+)
	       AND VVD.VSL_CD         = S.VSL_CD(+)
	       AND VVD.SKD_VOY_NO     = S.SKD_VOY_NO(+)
	       AND VVD.SKD_DIR_CD     = S.SKD_DIR_CD(+)
	       AND VVD.POD_CD    = S.POD_CD(+)
	       AND VVD.POL_CD    = S.POL_CD(+)
	       AND VVD.BKG_NO   = B.BKG_NO(+) 
	                  
        ) TB
 WHERE  TB.ETA_CLPT_SEQ >= TB.MIN_CLPT_SEQ
 AND TB.POL_CLPT_SEQ < TB.MAX_CLPT_SEQ
#if (${customs} != '')
 AND CSTMS_PORT_CD = @[customs]
#end
GROUP BY  VSL_CD, SKD_VOY_NO, SKD_DIR_CD, CSTMS_POD_CD, CSTMS_POL_CD, CSTMS_PORT_CD, SND_DT,  TRSM_MSG_TP_ID, CGO_TP_CD
ORDER BY VSL_CD
#if (${pod} != '') 
		, CASE WHEN MAX(VPS_ETD_DT) IS NULL THEN ' ' ELSE TO_CHAR(MAX(VPS_ETD_DT), 'YYYYMMDD HH24') || 'h' END 
#end
#if (${pol} != '') 
		, CASE WHEN MAX(VPS_ETA_DT) IS NULL THEN ' ' ELSE TO_CHAR(MAX(VPS_ETA_DT), 'YYYYMMDD HH24') || 'h' END 
#end			]]></sql>
			<params>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="pol" type="12" value="" out="N"/>
				<param name="pod" type="12" value="" out="N"/>
				<param name="full_empty" type="12" value="" out="N"/>
				<param name="customs" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
