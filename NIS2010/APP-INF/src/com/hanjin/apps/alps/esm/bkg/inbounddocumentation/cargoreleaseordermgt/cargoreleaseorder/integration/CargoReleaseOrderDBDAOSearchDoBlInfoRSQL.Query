<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CargoReleaseOrderDBDAOSearchDoBlInfoRSQL">
			<desc><![CDATA[D/O Release를 위한 기본 Reference정보를 조회한다.]]></desc>
			<sql><![CDATA[
SELECT  BKG_NO
      , BL_NO
      , POR_CD
      , POL_CD
      , POD_CD
      , DEL_CD
      , DEL_NOD_CD
      , DE_TERM_CD
      , DE_TERM_DESC
      , ARRIVAL_VESSEL
-- VVD 조회 조건 추가 Start (18.03.15 하대성)
	  , VVD
-- VVD 조회 조건 추가 End (18.03.15 하대성)
      , TO_CHAR( NVL(DECODE( SUBQ.POD_CD, 'BEANR', AVVD.ETA_DT, 'NLRTM', RVVD.VVD_ETA_DT), SUBQ.VPS_ETA_DT ), 'YYYY-MM-DD HH24:MI', 'NLS_DATE_LANGUAGE = ENGLISH') AS VPS_ETA_DT
      , PCK_QTY             -- PKG 1
      , PCK_TP_CD           -- PKG 2
      , ACT_WGT             -- WGT 1
      , WGT_UT_CD           -- WGT 2
      , MEAS_QTY            -- MEA 1
      , MEAS_UT_CD          -- MEA 2
      , SOC_FLG             -- SOC
      , SPLIT_FLG           -- SPLIT_FLG
      , REP_CMDT_NM
      , NVL( IDA_DO_YD_NM, NVL(DECODE(SUBQ.POD_CD,'BEANR', AHDG.ATTR_CTNT1, 'NLRTM', RCNV.ATTR_CTNT3), YD.YD_NM)) AS DSCH_LOC
      , PKUP_YD_CD
      , IDA_DO_YD_CD
      , CNTR_PRT_FLG         -- PARTIAL
      , CCUST_NM
      , CCUST_ADDR
      , NCUST_NM
      , NCUST_ADDR
      , SCUST_NM
      , SCUST_ADDR
      , CALL_SGN_NO
--    , BL_TP_CD
      , OBL_ISS_RMK
      , SUBQ.LCLOBLISSUEFLG
FROM (
        SELECT BKGM.BKG_NO                                            AS BKG_NO     -- BKG_NO
             , BKGM.BL_NO                                             AS BL_NO      -- BL_NO
           --, DECODE(BISS.OBL_SRND_FLG,'Y','S', BKGM.BL_TP_CD)       AS BL_TP_CD
             
             , MAX(NVL(VSL_SEQ,0)) OVER (PARTITION BY BKGM.BKG_NO )   AS MAX_VSL_SEQ       
             , NVL(VSL_SEQ,0)                                         AS VSL_SEQ      -- VSL_SEQ

             , BKGM.POR_CD         AS POR_CD     -- POR
             , BKGM.POL_CD         AS POL_CD     -- POL
             , BKGM.POD_CD         AS POD_CD     -- POD
             , BKGM.DEL_CD         AS DEL_CD     -- DEL
             , SUBSTR(BKGM.DEL_NOD_CD,6,2)          AS DEL_NOD_CD     -- DEL 2
             , BKGM.DE_TERM_CD     AS DE_TERM_CD -- DE_TERM
             , (SELECT INTG_CD_VAL_DP_DESC FROM COM_INTG_CD_DTL WHERE INTG_CD_ID = 'CD00765' AND INTG_CD_VAL_CTNT = BKGM.DE_TERM_CD) AS DE_TERM_DESC
             , NVL(ANTC.VSL_NM, CVSL.VSL_ENG_NM||' '|| BVVD.SKD_VOY_NO || BVVD.SKD_DIR_CD ) AS ARRIVAL_VESSEL -- ARRIVAL VESSEL
-- VVD 조회 조건 추가 Start (18.03.15 하대성)
			 , BVVD.VSL_CD || BVVD.SKD_VOY_NO || BVVD.SKD_DIR_CD AS VVD
-- VVD 조회 조건 추가 End (18.03.15 하대성)
             , NVL(ANTC.POD_ARR_DT, VSKD.VPS_ETA_DT) AS VPS_ETA_DT               -- ETA
             , BDOC.PCK_QTY        AS PCK_QTY    -- PKG 1
             , BDOC.PCK_TP_CD      AS PCK_TP_CD  -- PKG 2
             , BDOC.ACT_WGT        AS ACT_WGT    -- WGT 1
             , BDOC.WGT_UT_CD      AS WGT_UT_CD  -- WGT 2
             , BDOC.MEAS_QTY       AS MEAS_QTY   -- MEA 1
             , BDOC.MEAS_UT_CD     AS MEAS_UT_CD -- MEA 2
             , BKGM.SOC_FLG        AS SOC_FLG    -- SOC
             , DECODE(BKGM.BKG_CRE_TP_CD,'S','Y',SPLIT_FLG)           AS SPLIT_FLG  -- SPLIT_FLG
             , CMDT.REP_CMDT_NM                                       AS REP_CMDT_NM
             , NVL(ANTC.PKUP_YD_CD,VSKD.YD_CD)                        AS PKUP_YD_CD
             , BDRF.IDA_DO_YD_CD                                      AS IDA_DO_YD_CD
             , BHDG.ATTR_CTNT2 || BHDG.ATTR_CTNT3 || BHDG.ATTR_CTNT4  AS IDA_DO_YD_NM
    --       , YD.YD_NM            AS DSCH_LOC
             , (SELECT DECODE(COUNT(1), 1, 'Y', 'N') FROM BKG_CONTAINER CNTR WHERE CNTR.BKG_NO = BKGM.BKG_NO AND CNTR_PRT_FLG ='Y' AND ROWNUM = 1 )  AS CNTR_PRT_FLG -- PARTIAL
             , CCST.CUST_NM        AS CCUST_NM
             , CCST.CUST_ADDR      AS CCUST_ADDR
             , NCST.CUST_NM        AS NCUST_NM
             , NCST.CUST_ADDR      AS NCUST_ADDR
             , SCST.CUST_NM        AS SCUST_NM
             , SCST.CUST_ADDR      AS SCUST_ADDR
             , CVSL.CALL_SGN_NO    AS CALL_SGN_NO
             , BVVD.VSL_CD         AS VSL_CD
             , BVVD.SKD_VOY_NO     AS SKD_VOY_NO
             , BVVD.SKD_DIR_CD     AS SKD_DIR_CD
             , BISS.OBL_ISS_RMK    AS OBL_ISS_RMK
             ,( SELECT DECODE( COUNT(*),0,'N','Y') 
                FROM BKG_BOOKING BKGM
                     LEFT OUTER JOIN BKG_BL_ISS BISS
                     ON ( BISS.BKG_NO =  BKGM.BKG_NO
                          AND BISS.OBL_SRND_FLG <> 'Y'
                          AND BISS.OBL_RDEM_FLG <> 'Y'
                     ) 
                WHERE  BKGM.BKG_NO IN ( SELECT BKG2.BKG_NO
                                        FROM BKG_CONTAINER CNTR1,
                                             BKG_BOOKING BKG1, 
                                             BKG_BOOKING BKG2, 
                                             BKG_CONTAINER CNTR2
                                        WHERE CNTR1.BKG_NO        = @[bkg_no]          -- cntr1 
                                        AND   CNTR1.CNTR_PRT_FLG  = 'Y'
                                        AND   CNTR1.BKG_NO        = BKG1.BKG_NO    -- bkg1
                                        AND   BKG1.BKG_STS_CD     <> 'X'
                                        AND   BKG1.VSL_CD         = BKG2.VSL_CD        -- bkg2
                                        AND   BKG1.SKD_VOY_NO     = BKG2.SKD_VOY_NO
                                        AND   BKG1.SKD_DIR_CD     = BKG2.SKD_DIR_CD
                                        AND   BKG1.POL_CD         = BKG2.POL_CD
                                        AND   BKG1.BKG_NO         <> BKG2.BKG_NO  
                                        AND   BKG2.BKG_STS_CD     <> 'X'
                                        AND   CNTR2.BKG_NO        = BKG2.BKG_NO    -- cntr2
                                        AND   CNTR2.CNTR_NO       = CNTR1.CNTR_NO
                                        AND   CNTR2.CNTR_PRT_FLG  = 'Y' )                
                AND    BKGM.BL_TP_CD <> 'W' ) AS LCLOBLISSUEFLG
          FROM BKG_BOOKING      BKGM
              LEFT OUTER JOIN BKG_VVD BVVD ON (     
                   BKGM.BKG_NO = BVVD.BKG_NO
               AND BKGM.POD_CD = BVVD.POD_CD
               AND BVVD.VSL_PRE_PST_CD IN ('T','U')
              )
             LEFT OUTER JOIN VSK_VSL_PORT_SKD VSKD ON(
                   VSKD.VSL_CD       = BVVD.VSL_CD
               AND VSKD.SKD_VOY_NO   = BVVD.SKD_VOY_NO 
               AND VSKD.SKD_DIR_CD   = BVVD.SKD_DIR_CD
               AND VSKD.VPS_PORT_CD  = BVVD.POD_CD
               AND VSKD.CLPT_IND_SEQ = BVVD.POD_CLPT_IND_SEQ
             )
             LEFT OUTER JOIN BKG_BL_ISS BISS ON (
                BISS.BKG_NO = BKGM.BKG_NO
             )
             
             JOIN BKG_BL_DOC   BDOC ON (
              BDOC.BKG_NO = BKGM.BKG_NO
             )
             JOIN BKG_CUSTOMER     SCST ON (
                   SCST.BKG_NO         = BKGM.BKG_NO
               AND SCST.BKG_CUST_TP_CD = 'S'
             )
             JOIN BKG_CUSTOMER     CCST ON (
                   CCST.BKG_NO         = BKGM.BKG_NO
               AND CCST.BKG_CUST_TP_CD = 'C'
             )
             JOIN BKG_CUSTOMER     NCST ON (
                   NCST.BKG_NO         = BKGM.BKG_NO
               AND NCST.BKG_CUST_TP_CD = 'N'
             )
             LEFT OUTER JOIN BKG_ARR_NTC      ANTC ON (
                BKGM.BKG_NO = ANTC.BKG_NO 
             )
             LEFT OUTER JOIN MDM_REP_CMDT     CMDT ON (
                BKGM.REP_CMDT_CD = CMDT.REP_CMDT_CD
             )
             LEFT OUTER JOIN  MDM_VSL_CNTR     CVSL ON (
                BVVD.VSL_CD = CVSL.VSL_CD
              )
             LEFT OUTER JOIN  BKG_DO_REF       BDRF ON (
                BKGM.BKG_NO = BDRF.BKG_NO
             )
             LEFT OUTER JOIN  BKG_HRD_CDG_CTNT BHDG ON (
                    BHDG.HRD_CDG_ID  = 'IDA_DO_YD_CD' 
                AND BHDG.ATTR_CTNT1  = BDRF.IDA_DO_YD_CD
             )
         WHERE BKGM.BKG_NO         = @[bkg_no]    -- INPUT PARAM        
     ) SUBQ LEFT OUTER JOIN MDM_YARD YD 
                         ON ( YD.YD_CD  =  SUBQ.PKUP_YD_CD )-- Discharge Location
            LEFT OUTER JOIN BKG_CSTMS_ANR_VVD  AVVD  -- ANRBS
                         ON ( SUBQ.POD_CD = 'BEANR' AND AVVD.VSL_CD = SUBQ.VSL_CD
                                                    AND AVVD.SKD_VOY_NO = SUBQ.SKD_VOY_NO
                                                    AND AVVD.SKD_DIR_CD = SUBQ.SKD_DIR_CD )
            LEFT OUTER JOIN BKG_HRD_CDG_CTNT AHDG     -- ANRBS SUB CODE
                         ON ( SUBQ.POD_CD = 'BEANR' AND AHDG.HRD_CDG_ID = 'ANR_CSTMS_BRTH_CD'
                                                    AND AHDG.ATTR_CTNT2 = AVVD.BRTH_DESC )
            LEFT OUTER JOIN BKG_CSTMS_RTM_VSL  RVVD  -- NLRTM
                         ON ( SUBQ.POD_CD = 'NLRTM' AND RVVD.VSL_CD      = SUBQ.VSL_CD
                                                    AND RVVD.SKD_VOY_NO  = SUBQ.SKD_VOY_NO
                                                    AND RVVD.SKD_DIR_CD  = SUBQ.SKD_DIR_CD
                                                    AND RVVD.VSL_CALL_REF_STS_CD <> 'C' )
            LEFT OUTER JOIN BKG_CSTMS_CD_CONV_CTNT RCNV  -- NLRTM SUB
                         ON ( SUBQ.POD_CD = 'NLRTM' AND RCNV.CNT_CD = 'NL'
                                                    AND RCNV.CSTMS_DIV_ID = 'BERTH_CD'
                                                    AND RCNV.ATTR_CTNT1 = RVVD.BRTH_CTNT)
    WHERE VSL_SEQ=MAX_VSL_SEQ			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
