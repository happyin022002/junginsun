<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="NetworkCostDBDAOCreateBunkerTariff2CSQL">
			<desc><![CDATA[[CHM-201215754-01] [COA] Bunker Fee 화면 개발 건 쿼리 생성]]></desc>
			<sql><![CDATA[
-- FCM Cons 정보를 Create 후에 최근 12주차 중에서 가장 최근에 해당하는 Unit Cost를 업데이트 한다.
-- SKD_VOY_NO가 가장 큰 값
MERGE INTO COA_BNK_TRF D1 USING
(
 SELECT A.SLAN_CD
      , A.RLANE_CD
      , A.VSL_CD
      , LPAD(MAX(TO_NUMBER(A.SKD_VOY_NO)),4,'0') SKD_VOY_NO
      , A.DIR_CD
      , MAX(B.FOIL_UC_AMT) KEEP(DENSE_RANK LAST ORDER BY A.SKD_VOY_NO ) FOIL_UC_AMT
      , MAX(B.DOIL_UC_AMT) KEEP(DENSE_RANK LAST ORDER BY A.SKD_VOY_NO ) DOIL_UC_AMT
   FROM
        (
                SELECT DISTINCT A1.SLAN_CD
                      , A1.RLANE_CD
                      , A1.DIR_CD
                      , A1.VSL_CD
                      , A1.SKD_VOY_NO
                   FROM COA_MON_VVD A1
                      , COA_VSL_RGST A2
                      , COA_LANE_RGST A3
                      , (
                                 SELECT PREV_WK_12
                                      , PREV_WK_1
                                   FROM
                                        (
                                                 SELECT LAG (COST_YR || COST_WK, 12) OVER (ORDER BY COST_YR || COST_WK)
                                                        AS PREV_WK_12
                                                      , LAG (COST_YR || COST_WK, 1) OVER (ORDER BY COST_YR || COST_WK)
                                                        AS PREV_WK_1
                                                   FROM COA_WK_PRD
                                                  WHERE COST_YR || COST_WK <= SUBSTR(@[cost_yrmon],1,4) || @[cost_wk]
                                               ORDER BY COST_YR || COST_WK DESC
                                        )
                                  WHERE ROWNUM = 1
                        )
                        A4
                  WHERE A1.TRD_CD   = A3.TRD_CD
                    AND A1.RLANE_CD = A3.RLANE_CD
                    AND A1.IOC_CD   = A3.IOC_CD
                    AND A1.DIR_CD   = A3.DIR_CD
                    
                    AND A1.RLANE_CD        = @[rlane_cd]
                    AND A1.SLAN_CD         = @[slan_cd]
                    AND A1.VSL_CD          = @[vsl_cd] 
                    AND A1.DIR_CD          = @[dir_cd]
                    
                    AND SUBSTR(A1.SLS_YRMON, 1, 4)||A1.COST_WK BETWEEN A4.PREV_WK_12 AND A4.PREV_WK_1
                    AND A3.TRD_CD         <> 'COM'
                    AND A3.VSL_LANE_TP_CD IN ('JO', 'SC')
                    AND A1.VSL_CD          = A2.VSL_CD
                    AND A1.N1ST_LODG_PORT_ETD_DT BETWEEN A2.VSL_APLY_FM_DT AND A2.VSL_APLY_TO_DT
                    AND A2.VOP_CD   = 'HJS'
                    AND A1.DELT_FLG = 'N'
                    AND A2.DELT_FLG = 'N'
                    AND A3.DELT_FLG = 'N'
        )
        A
      , COA_BNK_TRF B
  WHERE A.SLAN_CD  = B.SLAN_CD
    AND A.RLANE_CD = B.RLANE_CD
    AND A.VSL_CD   = B.VSL_CD
    AND A.SKD_VOY_NO   = B.SKD_VOY_NO
    AND A.DIR_CD   = B.DIR_CD
    AND B.FOIL_UC_AMT > 0.00
GROUP BY A.SLAN_CD
      , A.RLANE_CD
      , A.VSL_CD
      , A.DIR_CD
) D2 

ON (        D1.SLAN_CD          = D2.SLAN_CD 
        AND D1.RLANE_CD         = D2.RLANE_CD 
        AND D1.VSL_CD           = D2.VSL_CD 
	    AND D1.SKD_VOY_NO       = @[skd_voy_no]
        AND D1.DIR_CD           = D2.DIR_CD )
WHEN MATCHED THEN
         UPDATE
        SET D1.FOIL_UC_AMT      = D2.FOIL_UC_AMT
          , D1.DOIL_UC_AMT      = D2.DOIL_UC_AMT
          , D1.UPD_USR_ID       = @[cre_usr_id]
          , D1.UPD_DT           = SYSDATE			]]></sql>
			<params>
				<param name="cost_yrmon" type="12" value="" out="N"/>
				<param name="cost_wk" type="12" value="" out="N"/>
				<param name="rlane_cd" type="12" value="" out="N"/>
				<param name="slan_cd" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="dir_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="cre_usr_id" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
