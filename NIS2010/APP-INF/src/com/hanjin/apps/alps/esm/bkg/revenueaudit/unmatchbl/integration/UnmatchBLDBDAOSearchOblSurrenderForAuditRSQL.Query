<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="UnmatchBLDBDAOSearchOblSurrenderForAuditRSQL">
			<desc><![CDATA[심사를 위한 O B/L Surrender 목록을 조회한다.]]></desc>
			<sql><![CDATA[
WITH BK AS(
SELECT TO_CHAR(BR.RT_APLY_DT, 'YYYY-MM-DD')	AS RT_APLY_DT,
       BK.BKG_NO,
       BK.BL_NO||BK.BL_NO_TP||BK.BL_TP_CD BL_NO,
       BK.SVC_SCP_CD,
       BK.POR_CD,
       BK.POL_CD,
       BK.POD_CD,
       BK.DEL_CD,
       (SELECT INTG_CD_VAL_DP_DESC
        FROM COM_INTG_CD_DTL
        WHERE INTG_CD_ID ='CD01716'
        AND INTG_CD_VAL_CTNT = BR.BKG_CTRT_TP_CD) BKG_CTRT_TP_CD ,
       CASE WHEN BR.BKG_CTRT_TP_CD = 'R' THEN BK.RFA_NO
            WHEN BR.BKG_CTRT_TP_CD = 'S' THEN BK.SC_NO
            WHEN BR.BKG_CTRT_TP_CD = 'T' THEN BK.TAA_NO
       END CTRT_NO,
       BI.OBL_RDEM_OFC_CD
       
FROM BKG_BOOKING BK,
     BKG_RATE BR,
     BKG_BL_ISS BI,
     BKG_BL_DOC BD,
    (SELECT	OFC_CD 
     FROM	MDM_ORGANIZATION A
 #if (${bkg_ofc_cd} != '') 
     WHERE	OFC_CD = @[bkg_ofc_cd]
 #end
     START WITH	A.OFC_CD = @[bkg_rhq_cd]
     CONNECT BY	PRIOR A.OFC_CD	= A.PRNT_OFC_CD  
     ) OG
#if (${search_date} == 'ETD')
    ,(SELECT DISTINCT B.BKG_NO
      FROM BKG_BOOKING B, BKG_VVD BV, VSK_VSL_PORT_SKD V
      WHERE B.BKG_NO = BV.BKG_NO
      AND B.POL_CD = BV.POL_CD
      AND V.VSL_CD = BV.VSL_CD
      AND V.SKD_VOY_NO = BV.SKD_VOY_NO
      AND V.SKD_DIR_CD = BV.SKD_DIR_CD
      AND V.VPS_PORT_CD = BV.POL_CD
      AND V.CLPT_IND_SEQ = BV.POL_CLPT_IND_SEQ
      AND V.VPS_ETD_DT BETWEEN TO_DATE(@[fm_dt],'YYYY-MM-DD') AND TO_DATE(@[to_dt],'YYYY-MM-DD') + 0.99999
      ) V
WHERE BK.BKG_NO = V.BKG_NO
#elseif (${search_date} == 'APPL')
WHERE BR.RT_APLY_DT BETWEEN TO_DATE(@[fm_dt],'YYYY-MM-DD') AND TO_DATE(@[to_dt],'YYYY-MM-DD') + 0.99999
#else
WHERE BK.BKG_CRE_DT BETWEEN TO_DATE(@[fm_dt],'YYYY-MM-DD') AND TO_DATE(@[to_dt],'YYYY-MM-DD') + 0.99999
#end
AND BK.BKG_STS_CD	<> 'X'
AND	BK.BKG_CGO_TP_CD	<> 'P'
AND	BK.BKG_NO		= BR.BKG_NO
AND	BK.BKG_NO		= BI.BKG_NO
AND	BI.OBL_SRND_FLG	= 'Y'	
AND BK.BKG_NO = BD.BKG_NO
AND BK.BKG_OFC_CD = OG.OFC_CD

 #if (${svc_scp_cd} != '') 
AND BK.SVC_SCP_CD   = @[svc_scp_cd]
 #end
 #if (${t_vvd} != '') 
AND BK.VSL_CD = SUBSTR(@[t_vvd], 1, 4)
AND BK.SKD_VOY_NO = SUBSTR(@[t_vvd], 5, 4)
AND BK.SKD_DIR_CD = SUBSTR(@[t_vvd], 9, 1)
 #end
 #if (${bkg_ctrt_tp_cd} != '') 
AND     CASE
             WHEN    BK.TAA_NO IS NOT NULL THEN  'T'
             WHEN    BK.RFA_NO IS NOT NULL THEN  'R'
             ELSE    'S'
        END                     = @[bkg_ctrt_tp_cd]
 #end

 #if (${ctrt_no} != '') 
AND     CASE
             WHEN    BK.TAA_NO IS NOT NULL THEN  BK.TAA_NO
             WHEN    BK.RFA_NO IS NOT NULL THEN  BK.RFA_NO
             ELSE    BK.SC_NO
        END                     LIKE @[ctrt_no] || '%'
 #end


 #if (${por_cd} != '') 
AND BK.POR_CD   LIKE @[por_cd]||'%'
 #end
 #if (${pol_cd} != '') 
AND BK.POL_CD   LIKE @[pol_cd]||'%'
 #end
 #if (${pod_cd} != '') 
AND BK.POD_CD   LIKE @[pod_cd]||'%'
 #end
 #if (${del_cd} != '') 
AND BK.DEL_CD   LIKE @[del_cd]||'%'
 #end
#if (${bdr_flg} != '') 
AND BD.BDR_FLG   = @[bdr_flg]
#end
),
RT AS (
SELECT BK.BKG_NO,
       BK.RT_APLY_DT,
       BK.BL_NO, 
       BK.SVC_SCP_CD,
       BK.POR_CD,
       BK.POL_CD,
       BK.POD_CD,
       BK.DEL_CD,
       BK.BKG_CTRT_TP_CD,
       BK.CTRT_NO,
       BK.OBL_RDEM_OFC_CD,
       BC.CURR_CD,
       BC.CHG_UT_AMT,
       BC.RAT_AS_QTY,
       BC.RAT_UT_CD,
       BC.CHG_AMT,
       BC.FRT_INCL_XCLD_DIV_CD
  FROM BK LEFT OUTER JOIN BKG_CHG_RT BC
    ON BK.BKG_NO = BC.BKG_NO 
   AND BC.CHG_CD = 'OBS'
)
,EX AS (
SELECT RT.BKG_NO,
       RT.RT_APLY_DT,
       RT.BL_NO,
       RT.SVC_SCP_CD,
       RT.POR_CD,
       RT.POL_CD,
       RT.POD_CD,
       RT.DEL_CD,
       RT.BKG_CTRT_TP_CD,
       RT.CTRT_NO,
       RT.OBL_RDEM_OFC_CD,
       RT.CURR_CD,
       RT.CHG_UT_AMT,
       RT.RAT_AS_QTY,
       RT.RAT_UT_CD,
       RT.CHG_AMT, 
       RT.FRT_INCL_XCLD_DIV_CD,
       NVL2(AUTH.CHG_AMD_RQST_STS_CD,DECODE(AUTH.CHG_AMD_RQST_STS_CD,'A','Y','N'),'') AS APRO_FLG,
       DECODE(AUTH.CHG_AMD_RQST_STS_CD,'A',AUTH.APRO_OFC_CD,'') AS APRO_OFC_CD,
       DECODE(AUTH.CHG_AMD_RQST_STS_CD,'A',AUTH.APRO_DT,'') AS APRO_DT,
       DECODE(AUTH.CHG_AMD_RQST_STS_CD,'A',AUTH.APRO_USR_ID,'') AS APRO_USR_ID,
      (SELECT INTG_CD_VAL_DESC
         FROM COM_INTG_CD_DTL
        WHERE INTG_CD_ID = 'CD03364'
          AND INTG_CD_VAL_CTNT =  AUTH.CHG_AMD_RSN_CD) AS CHG_AMD_RSN,
       AUTH.CHG_AMD_RMK,
       DTL.CHG_RT_SEQ 
  FROM RT LEFT OUTER JOIN BKG_CHG_AMD_AUTH_DTL DTL
    ON DTL.BKG_NO = RT.BKG_NO
   AND DTL.CHG_CD = 'OBS'
  LEFT OUTER JOIN BKG_CHG_AMD_AUTH AUTH
    ON DTL.BKG_NO = AUTH.BKG_NO
   AND DTL.CHG_AMD_SEQ = AUTH.CHG_AMD_SEQ
)
SELECT EX.BKG_NO,
       EX.RT_APLY_DT,
       EX.BL_NO,
       EX.SVC_SCP_CD,
       EX.POR_CD,
       EX.POL_CD,
       EX.POD_CD,
       EX.DEL_CD,
       EX.BKG_CTRT_TP_CD,
       EX.CTRT_NO,
       EX.OBL_RDEM_OFC_CD,
       EX.CURR_CD,
       EX.CHG_UT_AMT,
       EX.RAT_AS_QTY,
       EX.RAT_UT_CD,
       EX.CHG_AMT, 
       EX.FRT_INCL_XCLD_DIV_CD,
       IC.CURR_CD  AS INV_CURR_CD,
       SUM(IC.CHG_AMT) AS INV_CHG_AMT,
       COUNT(DISTINCT EX.BKG_NO) OVER () AS  BL_CNT,
       '' BKG_RHQ_CD,
       '' BKG_OFC_CD,
       '' SEARCH_DATE,
       '' FM_DT,
       '' TO_DT, 
       '' T_VVD,
       '' BDR_FLG,
       EX.APRO_FLG,
       EX.APRO_OFC_CD,
       TO_CHAR(EX.APRO_DT,'YYYY-MM-DD') AS APRO_DT,
       (SELECT USR_NM 
          FROM COM_USER 
         WHERE USR_ID = EX.APRO_USR_ID) AS APRO_USR_NM,
       EX.CHG_AMD_RSN,
       EX.CHG_AMD_RMK

FROM EX LEFT OUTER JOIN INV_AR_MN IM
  ON IM.BL_SRC_NO = EX.BKG_NO
 AND IM.INV_DELT_DIV_CD <> 'Y'
 AND IM.REV_TP_CD = 'M'
     LEFT OUTER JOIN INV_AR_CHG IC
  ON IM.AR_IF_NO = IC.AR_IF_NO
 AND IC.CHG_CD = 'OBS'
 AND IC.INV_REV_TP_SRC_CD  IN ('MIV','MIC')
 GROUP BY EX.BKG_NO,
       EX.RT_APLY_DT,
       EX.BL_NO,
       EX.SVC_SCP_CD,
       EX.POR_CD,
       EX.POL_CD,
       EX.POD_CD,
       EX.DEL_CD,
       EX.BKG_CTRT_TP_CD,
       EX.CTRT_NO,
       EX.OBL_RDEM_OFC_CD,
       EX.CURR_CD,
       EX.CHG_UT_AMT,
       EX.RAT_AS_QTY,
       EX.RAT_UT_CD,
       EX.CHG_AMT, 
       EX.FRT_INCL_XCLD_DIV_CD,
       IC.CURR_CD,       
       EX.APRO_FLG,
       EX.APRO_OFC_CD,
       EX.APRO_DT,
       EX.APRO_USR_ID,
       EX.CHG_AMD_RSN,
       EX.CHG_AMD_RMK			]]></sql>
			<params>
				<param name="bkg_ofc_cd" type="12" value="" out="N"/>
				<param name="bkg_rhq_cd" type="12" value="" out="N"/>
				<param name="fm_dt" type="12" value="" out="N"/>
				<param name="to_dt" type="12" value="" out="N"/>
				<param name="svc_scp_cd" type="12" value="" out="N"/>
				<param name="t_vvd" type="12" value="" out="N"/>
				<param name="bkg_ctrt_tp_cd" type="12" value="" out="N"/>
				<param name="ctrt_no" type="12" value="" out="N"/>
				<param name="por_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="del_cd" type="12" value="" out="N"/>
				<param name="bdr_flg" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
