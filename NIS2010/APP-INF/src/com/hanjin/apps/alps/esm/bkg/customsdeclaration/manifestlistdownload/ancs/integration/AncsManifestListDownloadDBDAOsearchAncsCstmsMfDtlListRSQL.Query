<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="AncsManifestListDownloadDBDAOsearchAncsCstmsMfDtlListRSQL">
			<desc><![CDATA[S]]></desc>
			<sql><![CDATA[
SELECT
  '' AS SEQ,
  'N' AS KIND,
  VVD.VSL_CD || VVD.SKD_VOY_NO || VVD.SKD_DIR_CD AS VVD,
  VVD.LLOYD_TP_CD || VVD.LLOYD_NO AS LLOYD_CD,
  VVD.SVC_RQST_NO,
  (SEQ.SEQ+1) SEQUENCE,
  SEQ.SEQ PREV_DOCNO,
  BL.ACT_WGT,
  BL.ACT_WGT_UT_CD,
CASE
WHEN LENGTH(BL.VVD_SEQ) = 1  THEN '000'||BL.VVD_SEQ 
WHEN LENGTH(BL.VVD_SEQ) = 2  THEN '00'||BL.VVD_SEQ
WHEN LENGTH(BL.VVD_SEQ) = 3  THEN '0'||BL.VVD_SEQ
WHEN LENGTH(BL.VVD_SEQ) = 4  THEN ''||BL.VVD_SEQ
END AS VVD_SEQ,
  (BL.BL_NO) BL_NO,
  BL.PCK_QTY,
  BL.PCK_TP_CD,
  VVD.BRTH_DESC,
  BL.POL_CD,
  BL.PRE_RLY_PORT_CD,
  BL.PST_RLY_PORT_CD,
  BL.POR_CD,
  BL.DEL_CD,
  BL.SHPR_ADDR,
  BL.CNEE_ADDR,
  SUBSTR(TRANSLATE(NTFY.NTFY_NM, CHR(13) || CHR(10), ' '), 1, 45) AS NTFY_NAME,
  NTFY.NTFY_ADDR,
  CM.CNTR_SEQ,
  CM.PCK_QTY CM_PCK_QTY,
  CM.PCK_TP_CD CM_PCK_TP_CD,
  CM.CNTR_MF_DESC,
  CM.CNTR_MF_WGT,
  CM.WGT_UT_CD,
  CM.CNTR_NO CM_CNTR_NO,
  DECODE( CM.DECL_FLG, 'Y', 'T1', 'C' ) DECL_FLG,
  CNTR.CNTR_NO,
  CNTR.CNTR_TPSZ_CD,
  DECODE(BL.BKG_CGO_TP_CD, 'F', 'F', 'E') CNTR_FM,
  (CNTR.ORG_RCV_TERM_CD||CNTR.DEST_DE_TERM_CD) AS RD_TERM,
  (BL.BKG_NO) KIND,
  NVL(BL.ANR_MSG_STS_CD, 'N')BL_ACK,
  DECODE(NVL(BL.ANR_MSG_STS_CD, 'N'), 'A', 'Y', 'N' )BL_ACK2,
  NVL(BL_LOG.SND_STS_CD, 'N') || NVL(BL_LOG.RCV_STS_CD, 'N') BL_LAST_EDI,
  BL_EDI_SND_RCV_STS.ATTR_CTNT2 AS BL_LAST_EDI2,
  NVL(CNTR.ANR_MSG_STS_CD, 'N')CNTR_ACK,
  DECODE(NVL(CNTR.ANR_MSG_STS_CD, 'N'), 'A', 'Y', 'N' ) CNTR_ACK2,
  NVL(CNTR_LOG.SND_STS_CD, 'N') || NVL(CNTR_LOG.RCV_STS_CD, 'N') CNTR_LAST_EDI,
  CNTR_EDI_SND_RCV_STS.ATTR_CTNT2 AS CNTR_LAST_EDI2,
  BL.POD_CD,
  BL.BDR_FLG,
  BL.BKG_NO,
  BL.ANR_MSG_STS_CD,
  CNTR.PCK_QTY CNTR_PCK_QTY,
  CNTR.PCK_TP_CD CNTR_PCK_TP_CD,
  CNTR.CNTR_WGT CNTR_WGT_QTY,
  CNTR.WGT_UT_CD CNTR_WGT_UT_CD,
  CNTR.ANR_MSG_STS_CD CNTR_ANR_MSG_STS_CD,
  SUBSTR(TRANSLATE(CM.CNTR_MF_DESC, CHR(13) || CHR(10), ' '), 1, 45) AS MF_DESC,
  VVD.SVC_RQST_NO || VVD.LLOYD_TP_CD || VVD.LLOYD_NO AS ANR_DECL_NO,
  MSG_SEQ.MSG_SEQ
FROM BKG_CSTMS_ANR_BL BL,
  BKG_CSTMS_ANR_CNTR CNTR,
  BKG_CSTMS_ANR_CMDT CM,
  BKG_CSTMS_ANR_NTFY NTFY,
  ( SELECT BB.BL_NO,
      AA.EDI_SND_STS_CD AS SND_STS_CD,
      BB.EDI_RCV_STS_CD AS RCV_STS_CD
    FROM BKG_CSTMS_ANR_EDI_HIS AA,
      BKG_CSTMS_ANR_BL_LOG BB,
      (
        SELECT C.MSG_TP_CD,
          C.ANR_DECL_NO,
          C.BL_NO,
          MAX(C.REF_SEQ) MAX_REF_SEQ
        FROM BKG_CSTMS_ANR_VVD A,
          BKG_CSTMS_ANR_EDI_HIS B,
          BKG_CSTMS_ANR_BL_LOG C
        WHERE A.VSL_CD = SUBSTR( @[vvd], 1, 4 )
          AND A.SKD_VOY_NO = SUBSTR( @[vvd], 5, 4 )
          AND A.SKD_DIR_CD = SUBSTR( @[vvd], 9, 1 )
          AND B.MSG_TP_CD = 'C'
          AND B.ANR_DECL_NO = A.SVC_RQST_NO || A.LLOYD_TP_CD || A.LLOYD_NO
          AND C.MSG_TP_CD = B.MSG_TP_CD
          AND C.ANR_DECL_NO = B.ANR_DECL_NO
          AND C.REF_SEQ = B.REF_SEQ
          AND C.VSL_CD = A.VSL_CD
          AND C.SKD_VOY_NO = A.SKD_VOY_NO
          AND C.SKD_DIR_CD = A.SKD_DIR_CD
        GROUP BY C.MSG_TP_CD, C.ANR_DECL_NO, C.BL_NO) CC
    WHERE AA.MSG_TP_CD(+) = CC.MSG_TP_CD
      AND AA.ANR_DECL_NO(+) = CC.ANR_DECL_NO
      AND AA.REF_SEQ(+) = CC.MAX_REF_SEQ
      AND BB.MSG_TP_CD(+) = CC.MSG_TP_CD
      AND BB.ANR_DECL_NO(+) = CC.ANR_DECL_NO
      AND BB.REF_SEQ(+) = CC.MAX_REF_SEQ
      AND BB.BL_NO(+) = CC.BL_NO ) BL_LOG,
  ( SELECT BB.BKG_NO,
      BB.CNTR_NO,
      AA.EDI_SND_STS_CD AS SND_STS_CD,
      BB.EDI_RCV_STS_CD AS RCV_STS_CD
    FROM BKG_CSTMS_ANR_EDI_HIS AA,
      BKG_CSTMS_ANR_CNTR_LOG BB,
      (
        SELECT C.MSG_TP_CD,
          C.ANR_DECL_NO,
          C.BKG_NO,
          C.CNTR_NO,
          MAX(C.REF_SEQ) MAX_REF_SEQ
        FROM BKG_CSTMS_ANR_VVD A,
          BKG_CSTMS_ANR_EDI_HIS B,
          BKG_CSTMS_ANR_CNTR_LOG C
        WHERE A.VSL_CD = SUBSTR( @[vvd], 1, 4 )
          AND A.SKD_VOY_NO = SUBSTR( @[vvd], 5, 4 )
          AND A.SKD_DIR_CD = SUBSTR( @[vvd], 9, 1 )
          AND B.MSG_TP_CD = 'C'
          AND B.ANR_DECL_NO = A.SVC_RQST_NO || A.LLOYD_TP_CD || A.LLOYD_NO
          AND C.MSG_TP_CD = B.MSG_TP_CD
          AND C.ANR_DECL_NO = B.ANR_DECL_NO
          AND C.REF_SEQ = B.REF_SEQ
          AND C.VSL_CD = A.VSL_CD
          AND C.SKD_VOY_NO = A.SKD_VOY_NO
          AND C.SKD_DIR_CD = A.SKD_DIR_CD
        GROUP BY C.MSG_TP_CD, C.ANR_DECL_NO, C.BKG_NO, C.CNTR_NO) CC
    WHERE AA.MSG_TP_CD(+) = CC.MSG_TP_CD
      AND AA.ANR_DECL_NO(+) = CC.ANR_DECL_NO
      AND AA.REF_SEQ(+) = CC.MAX_REF_SEQ
      AND BB.MSG_TP_CD(+) = CC.MSG_TP_CD
      AND BB.ANR_DECL_NO(+) = CC.ANR_DECL_NO
      AND BB.REF_SEQ(+) = CC.MAX_REF_SEQ
      AND BB.BKG_NO(+) = CC.BKG_NO
      AND BB.CNTR_NO(+) = CC.CNTR_NO ) CNTR_LOG,
  BKG_CSTMS_ANR_VVD VVD,
  ( SELECT NVL( MAX(REF_SEQ), 0) SEQ
    FROM BKG_CSTMS_ANR_EDI_HIS HIS,
      BKG_CSTMS_ANR_VVD VVD
    WHERE VVD.VSL_CD = SUBSTR( @[vvd], 1, 4 )
      AND VVD.SKD_VOY_NO = SUBSTR( @[vvd], 5, 4 )
      AND VVD.SKD_DIR_CD = SUBSTR( @[vvd], 9, 1 )
      AND HIS.ANR_DECL_NO = VVD.SVC_RQST_NO || VVD.LLOYD_TP_CD || VVD.LLOYD_NO
      AND HIS.MSG_TP_CD = 'C' )SEQ,
  ( SELECT NVL(MAX(A.MSG_SEQ), 0) + 1 AS MSG_SEQ
    FROM BKG_CSTMS_ANR_EDI_MSG A,
      (
        SELECT NVL( MAX(REF_SEQ), 0) SEQ,
          ANR_DECL_NO
        FROM BKG_CSTMS_ANR_EDI_HIS HIS,
          BKG_CSTMS_ANR_VVD VVD
        WHERE VVD.VSL_CD = SUBSTR( @[vvd], 1, 4 )
          AND VVD.SKD_VOY_NO = SUBSTR( @[vvd], 5, 4 )
          AND VVD.SKD_DIR_CD = SUBSTR( @[vvd], 9, 1 )
          AND HIS.ANR_DECL_NO = VVD.SVC_RQST_NO || VVD.LLOYD_TP_CD || VVD.LLOYD_NO
          AND HIS.MSG_TP_CD = 'C'
        GROUP BY ANR_DECL_NO) HISINFO
    WHERE 1=1
      AND A.MSG_TP_CD = 'C'
      AND A.RCV_SND_DIV_CD = 'S'
      AND A.ANR_DECL_NO = HISINFO.ANR_DECL_NO
      AND A.REF_SEQ = HISINFO.SEQ ) MSG_SEQ,
  ( SELECT CNTR_NO,
      SUM(CNTR_WGT) CNTR_WGT
    FROM BKG_CSTMS_ANR_CNTR
    WHERE VSL_CD = SUBSTR( @[vvd], 1, 4 )
      AND SKD_VOY_NO = SUBSTR( @[vvd], 5, 4 )
      AND SKD_DIR_CD = SUBSTR( @[vvd], 9, 1 )
    GROUP BY CNTR_NO ) CNTR_WGT,
  BKG_HRD_CDG_CTNT BL_EDI_SND_RCV_STS,
  BKG_HRD_CDG_CTNT CNTR_EDI_SND_RCV_STS
WHERE BL.VSL_CD = SUBSTR( @[vvd], 1, 4 )
  AND BL.SKD_VOY_NO = SUBSTR( @[vvd], 5, 4 )
  AND BL.SKD_DIR_CD = SUBSTR( @[vvd], 9, 1 )
#if (${pol_cd} != '')
  AND BL.POL_CD  = @[pol_cd]
#end
#if (${pod} != '')
  AND BL.POD_CD  = @[pod]
#end
  AND VVD.VSL_CD = BL.VSL_CD
  AND VVD.SKD_VOY_NO = BL.SKD_VOY_NO
  AND VVD.SKD_DIR_CD = BL.SKD_DIR_CD
  AND CNTR.VSL_CD(+) = BL.VSL_CD
  AND CNTR.SKD_VOY_NO(+) = BL.SKD_VOY_NO
  AND CNTR.SKD_DIR_CD(+) = BL.SKD_DIR_CD
  AND CNTR.BKG_NO(+) = BL.BKG_NO
  AND CM.VSL_CD(+) = CNTR.VSL_CD
  AND CM.SKD_VOY_NO(+) = CNTR.SKD_VOY_NO
  AND CM.SKD_DIR_CD(+) = CNTR.SKD_DIR_CD
  AND CM.BKG_NO(+) = CNTR.BKG_NO
  AND CM.CNTR_NO(+) = CNTR.CNTR_NO
  
#if (${is_cmdt} != 'o') 
	AND CM.CNTR_SEQ(+) = 1
#end

  AND NTFY.BKG_NO(+) = BL.BKG_NO
  AND NTFY.NTFY_SEQ(+) = 1
  AND BL_LOG.BL_NO(+) = BL.BL_NO
  AND CNTR_LOG.BKG_NO(+) = CNTR.BKG_NO
  AND CNTR_LOG.CNTR_NO(+) = CNTR.CNTR_NO
  AND CNTR_WGT.CNTR_NO = CNTR.CNTR_NO
  AND BL_EDI_SND_RCV_STS.HRD_CDG_ID(+) = 'ANR_CSTMS_EDI_STS_CD'
  AND BL_EDI_SND_RCV_STS.ATTR_CTNT1(+) = NVL(BL_LOG.SND_STS_CD, 'N') || NVL(BL_LOG.RCV_STS_CD, 'N')
  AND CNTR_EDI_SND_RCV_STS.HRD_CDG_ID(+) = 'ANR_CSTMS_EDI_STS_CD'
  AND CNTR_EDI_SND_RCV_STS.ATTR_CTNT1(+) = NVL(CNTR_LOG.SND_STS_CD, 'N') || NVL(CNTR_LOG.RCV_STS_CD, 'N')
ORDER BY BL.BKG_NO, BL.BL_NO, CNTR.CNTR_NO, BL.POL_CD			]]></sql>
			<params>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pod" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
