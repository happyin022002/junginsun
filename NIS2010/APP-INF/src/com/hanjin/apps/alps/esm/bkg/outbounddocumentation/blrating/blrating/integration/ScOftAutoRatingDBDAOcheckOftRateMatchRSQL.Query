<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ScOftAutoRatingDBDAOcheckOftRateMatchRSQL">
			<desc><![CDATA[SC OFT계산결과를 체크한다.
해당 BKG의 Voume과 Rating 결과 Volume Quantity를 비교해 일치하는지 조회하며
SC 계약 담당자에게 계약 수정을 요청할지 결정하는 근거 자료로 사용된다.

 - Autorating 결과 나오는 CNTR Volume과 Qty Detail상의 Volume이 일치하면 Success
 - Autorating 결과 Rating Unit이 BL인 경우 무조건 Success
 - Co-Biz BL인 경우 무조건 Success]]></desc>
			<sql><![CDATA[
SELECT R.OFT_CMB_SEQ
FROM (SELECT DISTINCT T.BKG_NO, T.OFT_CMB_SEQ, U.CNTR_SZ_CD, 
             SUM(T.RAT_AS_QTY) OVER (PARTITION BY T.OFT_CMB_SEQ, U.CNTR_SZ_CD ) QTY,
             SUM(T.RAT_AS_QTY) OVER (PARTITION BY T.OFT_CMB_SEQ) TTL_QTY
        FROM BKG_AUTO_RT_OCN_FRT_TMP T, PRI_RAT_UT U
       WHERE T.RAT_UT_CD = U.RAT_UT_CD
       AND T.CHG_CD = 'OFT'
       AND T.CNTR_TPSZ_CD  NOT LIKE 'Q%') R,
     (SELECT DISTINCT Q.BKG_NO, U.CNTR_SZ_CD, 
             SUM(Q.OP_CNTR_QTY) OVER (PARTITION BY U.CNTR_SZ_CD) QTY,
             SUM(Q.OP_CNTR_QTY) OVER (PARTITION BY Q.BKG_NO) TTL_QTY
        FROM (SELECT BKG_NO, 
                     CASE WHEN CNTR_TPSZ_CD LIKE 'R%' AND DRY_CGO_FLG = 'Y' -- RD 인 경우만 예외처리  
                                  THEN CNTR_TPSZ_CD  
                          ELSE NVL(EQ_SUBST_CNTR_TPSZ_CD, CNTR_TPSZ_CD)  
                     END CNTR_TPSZ_CD, 
                     OP_CNTR_QTY
              FROM BKG_QTY_DTL
              WHERE BKG_NO = @[bkg_no]) Q, 
              PRI_RAT_UT U
       WHERE Q.BKG_NO = @[bkg_no]
         AND Q.CNTR_TPSZ_CD = U.RAT_UT_CD
         AND Q.CNTR_TPSZ_CD  NOT LIKE 'Q%'
         AND @[ca_flg] = 'N'
       
       UNION ALL 
       
       SELECT DISTINCT Q.BKG_NO, U.CNTR_SZ_CD, 
             SUM(Q.OP_CNTR_QTY) OVER (PARTITION BY U.CNTR_SZ_CD) QTY,
             SUM(Q.OP_CNTR_QTY) OVER (PARTITION BY Q.BKG_NO) TTL_QTY
        FROM (SELECT BKG_NO, 
                     CASE WHEN CNTR_TPSZ_CD LIKE 'R%' AND DRY_CGO_FLG = 'Y' -- RD 인 경우만 예외처리  
                                  THEN CNTR_TPSZ_CD  
                          ELSE NVL(EQ_SUBST_CNTR_TPSZ_CD, CNTR_TPSZ_CD)  
                     END CNTR_TPSZ_CD, 
                     OP_CNTR_QTY
              FROM BKG_QTY_DTL_HIS
              WHERE BKG_NO = @[bkg_no]
              AND CORR_NO = 'TMP0000001') Q, 
              PRI_RAT_UT U
       WHERE Q.BKG_NO = @[bkg_no]
         AND Q.CNTR_TPSZ_CD = U.RAT_UT_CD
         AND Q.CNTR_TPSZ_CD  NOT LIKE 'Q%'
         AND @[ca_flg] = 'Y'
         ) Q
WHERE R.CNTR_SZ_CD = Q.CNTR_SZ_CD
AND R.QTY = Q.QTY
AND R.TTL_QTY = Q.TTL_QTY

UNION ALL

SELECT OFT_CMB_SEQ
FROM BKG_AUTO_RT_OCN_FRT_TMP
WHERE RAT_UT_CD = 'BL'

UNION ALL

SELECT 1
FROM BKG_RATE
WHERE BKG_NO = @[bkg_no]
AND RT_BL_TP_CD = 'B'			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="ca_flg" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
