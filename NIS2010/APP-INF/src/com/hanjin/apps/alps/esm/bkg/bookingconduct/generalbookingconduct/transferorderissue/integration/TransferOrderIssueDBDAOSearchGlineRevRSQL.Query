<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TransferOrderIssueDBDAOSearchGlineRevRSQL">
			<desc><![CDATA[Search Guideline Revenue Amount]]></desc>
			<sql><![CDATA[
SELECT CASE WHEN CNTR_TERM_CD = 'Y' THEN 'N'
            WHEN OPTM_STS_CD = 'Y' AND CNTR_TERM_CD = 'D' THEN 'M'
            ELSE 'A'
       END AS MANIFEST_FLAG
      ,GLINE_CURR_CD
      ,GLINE_REV_AMT
      ,OPTM_STS_CD
      ,TRSP_MOD_CD
      ,CASE WHEN CNTR_TERM_CD = 'Y' AND @[add_rev_amt] IS NULL AND @[add_rev_amt2] IS NULL AND @[add_rev_amt3] IS NULL THEN 'N'
            WHEN CNTR_TERM_CD = 'Y' AND (@[add_rev_amt] IS NOT NULL OR @[add_rev_amt2] IS NOT NULL OR @[add_rev_amt3] IS NOT NULL) THEN 'B'
            WHEN OPTM_STS_CD = 'Y' AND CNTR_TERM_CD = 'D' AND @[add_rev_amt] IS NULL AND @[add_rev_amt2] IS NULL AND @[add_rev_amt3] IS NULL THEN 'Y'
            WHEN OPTM_STS_CD = 'Y' AND CNTR_TERM_CD = 'D' AND (@[add_rev_amt] IS NOT NULL OR @[add_rev_amt2] IS NOT NULL OR @[add_rev_amt3] IS NOT NULL) THEN 'A'
       END AS ALL_IN_RT_CD
       ,CASE WHEN OPTM_STS_CD = 'Y' AND CNTR_TERM_CD = 'D' AND @[add_rev_amt] IS NULL AND @[add_rev_amt2] IS NULL AND @[add_rev_amt3] IS NULL THEN
            (
                SELECT 
                    CHG_AMT
                FROM 
                    BKG_CHG_RT
                WHERE  BKG_NO= @[bkg_no]
                AND CHG_CD ='DIH' 
                AND FRT_INCL_XCLD_DIV_CD ='I' 
                AND CNTR_TPSZ_CD = RAT_UT_CD 
                AND RT_SEQ= (
                    SELECT MAX(RT_SEQ) FROM BKG_CHG_RT T
                    WHERE BKG_NO = @[bkg_no] 
                
                    AND CHG_CD='DIH' 
                    AND FRT_INCL_XCLD_DIV_CD ='I' 
                    AND RAT_UT_CD = CNTR_TPSZ_CD 
                    AND ROWNUM = 1
                )			          
            )
        END DIH_AMT
        ,AGMT_WGT
        ,IHC_TRF_NO
        ,ORG_DEST_TP_CD
        ,SVC_SCP_CD

  FROM (SELECT DECODE(IHC.GLINE_REV_AMT, NULL, '', IHC.GLINE_CURR_CD) AS GLINE_CURR_CD
              ,DECODE(IHC.GLINE_REV_AMT, NULL, 'N/A', IHC.GLINE_REV_AMT) AS GLINE_REV_AMT
              ,PRC_TRSP_MOD_CD TRSP_MOD_CD
              ,CASE WHEN DECODE(@[trsp_chg_flg], 'Y', @[trsp_mode_cd], PRC_TRSP_MOD_CD) = PRC_TRSP_MOD_CD
                     AND GLINE_REV_AMT IS NOT NULL THEN 'Y'
                    WHEN DECODE(@[trsp_chg_flg], 'Y', @[trsp_mode_cd], PRC_TRSP_MOD_CD) <> PRC_TRSP_MOD_CD
                     AND GLINE_REV_AMT IS NOT NULL THEN 'N'
               else 'A'
               END AS OPTM_STS_CD
              ,DECODE(@[io_bnd_cd], 'I', CNTR.DE_TERM_CD , 'O', BK.RCV_TERM_CD) CNTR_TERM_CD
              ,CNTR.CNTR_TPSZ_CD
              ,NVL(IHC.AGMT_WGT,0) * 1000 AS AGMT_WGT
              ,IHC.IHC_TRF_NO
              ,IHC.ORG_DEST_TP_CD
              ,IHC.SVC_SCP_CD
          FROM BKG_BOOKING BK
          LEFT OUTER JOIN
               (SELECT *
                  FROM (
                       SELECT DISTINCT MN.SVC_SCP_CD
                              ,MN.IHC_TRF_NO
                              ,MN.ORG_DEST_TP_CD
                              ,RT.LOCL_CURR_CD AS GLINE_CURR_CD
                              ,CASE
                                WHEN AWK.FLG = 'Y' THEN NULL
                                WHEN DG.FLG = 'Y' AND RT.DCGO_SVC_FLG = 'N' THEN NULL
                                WHEN SZ.SZ = '20' AND DG.FLG = 'Y' AND RT.DCGO_SVC_FLG = 'Y' THEN RT.GLINE_LOCL_CURR_DG_20FT_AMT
                                WHEN SZ.SZ = '40' AND DG.FLG = 'Y' AND RT.DCGO_SVC_FLG = 'Y' THEN RT.GLINE_LOCL_CURR_DG_40FT_AMT
                                WHEN SZ.SZ = '20' THEN GLINE_LOCL_CURR_20FT_AMT
                                WHEN SZ.SZ = '40' THEN GLINE_LOCL_CURR_40FT_AMT
                               END AS GLINE_REV_AMT
                              ,RT.PRC_TRSP_MOD_CD
                              ,CASE WHEN SZ.SZ = '20' THEN MAX (DECODE(SPCL.OVR_WGT_CGO_SVC_FLG, 'Y', DECODE(SPCL.PRC_INLND_TRF_CNTR_TPSZ_CD, '20', SPCL.MIN_CGO_WGT, '') , DECODE(SPCL.PRC_INLND_TRF_CNTR_TPSZ_CD, '20', SPCL.MAX_CGO_WGT, '')) ) OVER(PARTITION BY SPCL.SVC_SCP_CD, SPCL.ORG_DEST_TP_CD, SPCL.IHC_TRF_NO, SPCL.PRC_TRSP_MOD_CD)
                                    WHEN SZ.SZ = '40' THEN MAX (DECODE(SPCL.OVR_WGT_CGO_SVC_FLG, 'Y', DECODE(SPCL.PRC_INLND_TRF_CNTR_TPSZ_CD, '40', SPCL.MIN_CGO_WGT, '') , DECODE(SPCL.PRC_INLND_TRF_CNTR_TPSZ_CD, '40', SPCL.MAX_CGO_WGT, '') ) ) OVER(PARTITION BY SPCL.SVC_SCP_CD, SPCL.ORG_DEST_TP_CD, SPCL.IHC_TRF_NO, SPCL.PRC_TRSP_MOD_CD)
                                    WHEN HDR.RHQ_CD = 'HAMRU'  THEN MAX (DECODE(SPCL.OVR_WGT_CGO_SVC_FLG, 'Y', DECODE(SPCL.PRC_INLND_TRF_CNTR_TPSZ_CD, '45', SPCL.MIN_CGO_WGT, '') , DECODE(SPCL.PRC_INLND_TRF_CNTR_TPSZ_CD, '45', SPCL.MAX_CGO_WGT, '') ) ) OVER(PARTITION BY SPCL.SVC_SCP_CD, SPCL.ORG_DEST_TP_CD, SPCL.IHC_TRF_NO, SPCL.PRC_TRSP_MOD_CD)
                                    ELSE MAX (DECODE(SPCL.OVR_WGT_CGO_SVC_FLG, 'Y', DECODE(SPCL.PRC_INLND_TRF_CNTR_TPSZ_CD, '40', SPCL.MIN_CGO_WGT, '') , DECODE(SPCL.PRC_INLND_TRF_CNTR_TPSZ_CD, '40', SPCL.MAX_CGO_WGT, '') ) ) OVER(PARTITION BY SPCL.SVC_SCP_CD, SPCL.ORG_DEST_TP_CD, SPCL.IHC_TRF_NO, SPCL.PRC_TRSP_MOD_CD)
                                    END AS AGMT_WGT
                          FROM PRI_TRF_IHC_MN MN
                              ,PRI_TRF_IHC_RT RT
                              ,PRI_TRF_IHC_SPCL_CGO_RT SPCL
                              ,PRI_TRF_IHC_HDR HDR
                              ,BKG_BOOKING BB
                              ,(SELECT ATTR_CTNT2 AS SZ
                                  FROM BKG_HRD_CDG_CTNT
                                 WHERE HRD_CDG_ID = 'T1_REV_GLINE_TPSZ'
                                   AND ATTR_CTNT10 = 'N'
                                   AND ATTR_CTNT1 = @[cntr_tpsz_cd]) SZ
                               ,(SELECT DECODE(@[io_bnd_cd], 'I', DECODE(COUNT(1), 0, 'N', 'Y') , 'O', @[dg_flag]) FLG
                                   FROM BKG_DG_CGO
                                  WHERE BKG_NO = @[bkg_no]
                                    AND CNTR_NO = @[cntr_no]) DG
                               ,(SELECT DECODE(@[io_bnd_cd], 'I', DECODE(COUNT(1), 0, 'N', 'Y') , 'O', @[rf_flag]) FLG
                                   FROM BKG_RF_CGO
                                  WHERE BKG_NO = @[bkg_no]
                                    AND CNTR_NO = @[cntr_no] ) RC
                                ,(SELECT DECODE(@[io_bnd_cd], 'I', DECODE(COUNT(1), 0, 'N', 'Y') , 'O', @[awk_flag]) FLG
                                   FROM BKG_AWK_CGO
                                  WHERE BKG_NO = @[bkg_no]
                                    AND CNTR_NO = @[cntr_no]) AWK
                         WHERE MN.SVC_SCP_CD = RT.SVC_SCP_CD
                           AND MN.IHC_TRF_NO = RT.IHC_TRF_NO
                           AND MN.AMDT_SEQ = RT.AMDT_SEQ
                           AND NVL(TO_DATE(@[cfm_dt], 'YYYY-MM-DD HH24:MI'), SYSDATE) BETWEEN MN.EFF_DT AND NVL(MN.EXP_DT, TO_DATE('9999-12-31', 'YYYY-MM-DD'))
                           AND RT.BSE_PORT_LOC_CD = @[bse_port_loc_cd]
                           AND RT.PNT_LOC_CD = @[pnt_loc_cd]
        #if (${optm_flag} != 'Y')                   
                           AND RT.PRC_TRSP_MOD_CD = @[trsp_mode_cd]
        #end                     
                           AND RT.OPTM_TRSP_MOD_FLG = 'Y'
                           AND RT.RCV_DE_TERM_CD = 'D'
                           AND MN.FIC_PROP_STS_CD = 'C'
                           AND RT.SRC_INFO_CD <> 'AD'
                           AND MN.ORG_DEST_TP_CD = RT.ORG_DEST_TP_CD
                           AND DECODE(@[io_bnd_cd],'I','D','O') = RT.ORG_DEST_TP_CD
                           AND DECODE(RC.FLG,'Y','RF','DR') = RT.IHC_CGO_TP_CD
                           AND RT.SVC_SCP_CD      = SPCL.SVC_SCP_CD(+)
                           AND RT.ORG_DEST_TP_CD  = SPCL.ORG_DEST_TP_CD(+)
                           AND RT.IHC_TRF_NO      = SPCL.IHC_TRF_NO(+)
                           AND RT.PRC_TRSP_MOD_CD = SPCL.PRC_TRSP_MOD_CD(+)
                           AND MN.SVC_SCP_CD = HDR.SVC_SCP_CD
                           AND MN.IHC_TRF_NO = HDR.IHC_TRF_NO
                           AND MN.ORG_DEST_TP_CD = HDR.ORG_DEST_TP_CD	
                           AND BB.BKG_NO = @[bkg_no]
                           AND BB.SVC_SCP_CD = MN.SVC_SCP_CD

                           )
                     where rownum = 1
 ) IHC
            ON BK.SVC_SCP_CD = IHC.SVC_SCP_CD
          LEFT OUTER JOIN BKG_CONTAINER CNTR
            ON BK.BKG_NO = CNTR.BKG_NO
           AND CNTR.CNTR_NO = @[cntr_no]
         WHERE BK.BKG_NO = @[bkg_no]
  )			]]></sql>
			<params>
				<param name="add_rev_amt" type="12" value=" " out="N"/>
				<param name="add_rev_amt2" type="12" value="" out="N"/>
				<param name="add_rev_amt3" type="12" value="" out="N"/>
				<param name="bkg_no" type="12" value="SEL243548600" out="N"/>
				<param name="trsp_chg_flg" type="12" value="" out="N"/>
				<param name="trsp_mode_cd" type="12" value="T" out="N"/>
				<param name="io_bnd_cd" type="12" value="" out="N"/>
				<param name="cntr_tpsz_cd" type="12" value="" out="N"/>
				<param name="dg_flag" type="12" value="" out="N"/>
				<param name="cntr_no" type="12" value="" out="N"/>
				<param name="rf_flag" type="12" value="" out="N"/>
				<param name="awk_flag" type="12" value="" out="N"/>
				<param name="cfm_dt" type="12" value="" out="N"/>
				<param name="bse_port_loc_cd" type="12" value="" out="N"/>
				<param name="pnt_loc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
