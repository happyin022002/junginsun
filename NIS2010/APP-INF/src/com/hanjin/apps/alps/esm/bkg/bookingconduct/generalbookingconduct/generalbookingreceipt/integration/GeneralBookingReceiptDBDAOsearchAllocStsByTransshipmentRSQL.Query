<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="GeneralBookingReceiptDBDAOsearchAllocStsByTransshipmentRSQL">
			<desc><![CDATA[jdkjd]]></desc>
			<sql><![CDATA[
WITH BKG AS (
       SELECT (SELECT INTG_CD_VAL_DESC 
                FROM COM_INTG_CD_DTL
               WHERE INTG_CD_ID='CD01233'
                 AND INTG_CD_VAL_CTNT = BV.VSL_PRE_PST_CD 
                 AND ROWNUM = 1)||' '||BV.VSL_SEQ VVD_SEQ
              ,BB.SLAN_CD TRUNK_SLAN_CD
              ,BB.SKD_DIR_CD TRUNK_SKD_DIR_CD
              ,BB.POR_CD
              ,POR_SCC.SCC_CD POR_SCC_CD
              ,BB.POR_NOD_CD
              ,BB.POL_CD
              ,BB.POL_NOD_CD
              ,BB.POD_CD
              ,BB.POD_NOD_CD
              ,BB.DEL_CD
              ,DEL_SCC.SCC_CD DEL_SCC_CD
              ,BB.DEL_NOD_CD
              ,BB.OB_SLS_OFC_CD
              ,BB.SC_NO
              ,BB.RFA_NO
              ,BB.SKD_DIR_CD
              ,BB.CMDT_CD
              ,BB.CTRT_CUST_CNT_CD
              ,BB.CTRT_CUST_SEQ
              ,BV.VSL_PRE_PST_CD
              ,BV.VSL_SEQ
              ,BV.SLAN_CD VVD_SLAN_CD
              ,BV.VSL_CD VVD_VSL_CD
              ,BV.SKD_VOY_NO VVD_SKD_VOY_NO
              ,BV.SKD_DIR_CD VVD_SKD_DIR_CD
              ,BV.POL_CD VVD_POL_CD
              ,BV.POD_CD VVD_POD_CD
              ,BB.BKG_NO
              ,LVL.OFC_N3RD_LVL_CD
       FROM BKG_VVD BV
           ,BKG_BOOKING BB
           ,BKG_OFC_LVL_V LVL 
           ,MDM_LOCATION POR_SCC
           ,MDM_LOCATION DEL_SCC
      WHERE   BV.BKG_NO = @[bkg_no]
        AND   BV.VSL_PRE_PST_CD <> 'T'
        AND   BV.BKG_NO = BB.BKG_NO
        AND   BB.POR_CD = POR_SCC.LOC_CD
        AND   BB.DEL_CD = DEL_SCC.LOC_CD
        AND   BB.OB_SLS_OFC_CD = LVL.OFC_CD
), ALOC AS (
     SELECT BKG.VVD_SEQ
            ,BKG.VVD_VSL_CD||BKG.VVD_SKD_VOY_NO||BKG.VVD_SKD_DIR_CD VVD
            ,BKG.VVD_SLAN_CD SLAN_CD
            ,BKG.OFC_N3RD_LVL_CD L_RHQ
            ,BAM.ALOC_LOD_QTY
            ,NVL(BAM.ALOC_LOD_QTY_RTO,100) ALOC_LOD_QTY_RTO
            ,BAM.BKG_ALOC_RMK OTHER_REMARK
            ,(SELECT BAMD.BKG_ALOC_SEQ FROM BKG_ALOC_MGMT_LOC_DTL BAMD WHERE BAMD.BKG_ALOC_SEQ = BAM.BKG_ALOC_SEQ AND BAMD.LOC_DIV_CD = 'POL' AND BAMD.LOC_CD = BKG.VVD_POL_CD AND ROWNUM = 1) VVD_POL_CD_SEQ
            ,(SELECT BAMD.BKG_ALOC_SEQ FROM BKG_ALOC_MGMT_LOC_DTL BAMD WHERE BAMD.BKG_ALOC_SEQ = BAM.BKG_ALOC_SEQ AND BAMD.LOC_DIV_CD = 'POD' AND BAMD.LOC_CD = BKG.VVD_POD_CD AND ROWNUM = 1) VVD_POD_CD_SEQ
            ,(SELECT BAMD.BKG_ALOC_SEQ FROM BKG_ALOC_MGMT_LOC_DTL BAMD WHERE BAMD.BKG_ALOC_SEQ = BAM.BKG_ALOC_SEQ AND BAMD.LOC_DIV_CD = 'POL' AND ROWNUM = 1) ALOC_POL_CD_SEQ
            ,(SELECT BAMD.BKG_ALOC_SEQ FROM BKG_ALOC_MGMT_LOC_DTL BAMD WHERE BAMD.BKG_ALOC_SEQ = BAM.BKG_ALOC_SEQ AND BAMD.LOC_DIV_CD = 'POD' AND ROWNUM = 1) ALOC_POD_CD_SEQ
            ,BKG.BKG_NO
            ,BAM.N1ST_TS_POL_CNT_CD
            ,BAM.N1ST_TS_POD_CNT_CD
            ,BAM.N1ST_TS_DIR_CD
            ,BKG.VVD_SLAN_CD
            ,BKG.VVD_VSL_CD
            ,BKG.VVD_SKD_VOY_NO
            ,BKG.VVD_SKD_DIR_CD
            ,BKG.VVD_POL_CD
            ,BKG.VVD_POD_CD 
            ,BAM.ALOC_SVC_CD
            ,BAM.BKG_ALOC_TP_CD
     FROM BKG_ALOC_MGMT BAM
          ,BKG
     WHERE  BAM.BKG_ALOC_TP_CD(+) = 'S'
      AND   BAM.N1ST_TS_SLAN_CD(+) = BKG.VVD_SLAN_CD
      AND   NVL(BAM.N1ST_TS_POL_CNT_CD(+),SUBSTR(BKG.VVD_POL_CD,1,2)) = SUBSTR(BKG.VVD_POL_CD,1,2)
      AND   NVL(BAM.N1ST_TS_POD_CNT_CD(+),SUBSTR(BKG.VVD_POD_CD,1,2)) = SUBSTR(BKG.VVD_POD_CD,1,2)            
      AND   NVL(BAM.N1ST_TS_DIR_CD(+),BKG.VVD_SKD_DIR_CD) = BKG.VVD_SKD_DIR_CD           
      AND   NVL(BAM.POD_CD(+),BKG.POD_CD) = BKG.POD_CD         
      AND   NVL(BAM.N1ST_TS_SLAN_CD(+),BKG.VVD_SLAN_CD) = BKG.VVD_SLAN_CD
      AND   NVL(BAM.TRNK_SLAN_CD(+),BKG.TRUNK_SLAN_CD) = BKG.TRUNK_SLAN_CD      -- T.LANE
      AND   NVL(BAM.TRNK_DIR_CD(+),BKG.TRUNK_SKD_DIR_CD) = BKG.TRUNK_SKD_DIR_CD -- BD
      AND   NVL(BAM.POR_CD(+),BKG.POR_CD) = BKG.POR_CD         
      AND   NVL(BAM.POR_NOD_CD(+),BKG.POR_NOD_CD) = BKG.POR_NOD_CD
      AND   NVL(BAM.BKG_POR_SCC_CD(+),BKG.POR_SCC_CD) = BKG.POR_SCC_CD
      AND   NVL(BAM.POL_CD(+),BKG.POL_CD) = BKG.POL_CD
      AND   NVL(BAM.POD_CD(+),BKG.POD_CD) = BKG.POD_CD
      AND   NVL(BAM.POD_NOD_CD(+),BKG.POD_NOD_CD) = BKG.POD_NOD_CD
      AND   NVL(BAM.DEL_CD(+),BKG.DEL_CD) = BKG.DEL_CD
      AND   NVL(BAM.DEL_NOD_CD(+),BKG.DEL_NOD_CD) = BKG.DEL_NOD_CD
      AND   NVL(BAM.BKG_DEL_SCC_CD(+),BKG.DEL_SCC_CD) = BKG.DEL_SCC_CD
      AND   NVL(BAM.OB_SLS_OFC_CD(+),BKG.OB_SLS_OFC_CD) = BKG.OB_SLS_OFC_CD
      AND   NVL(BAM.VSL_CD(+),BKG.VVD_VSL_CD) = BKG.VVD_VSL_CD
      AND   NVL(BAM.SKD_VOY_NO(+),BKG.VVD_SKD_VOY_NO) = BKG.VVD_SKD_VOY_NO
      AND   NVL(BAM.SKD_DIR_CD(+),BKG.VVD_SKD_DIR_CD) = BKG.VVD_SKD_DIR_CD
      AND   NVL(BAM.BKG_POR_CNT_CD(+),SUBSTR(BKG.POR_CD,1,2)) = SUBSTR(BKG.POR_CD,1,2)
      AND   NVL(BAM.BKG_POL_CNT_CD(+),SUBSTR(BKG.POL_CD,1,2)) = SUBSTR(BKG.POL_CD,1,2)
      AND   NVL(BAM.BKG_POD_CNT_CD(+),SUBSTR(BKG.POD_CD,1,2)) = SUBSTR(BKG.POD_CD,1,2)
      AND   NVL(BAM.BKG_DEL_CNT_CD(+),SUBSTR(BKG.DEL_CD,1,2)) = SUBSTR(BKG.DEL_CD,1,2) 
), G_SUM AS (
SELECT TS.VVD_SEQ      
     , TS.VVD          
     , TS.SLAN_CD      
     , TS.L_RHQ        
     , TS.ALOC_LOD_QTY 
     , TS.TEU_TTL  
     , TS.ALOC_LOD_QTY_RTO
     , CASE WHEN TS.ALOC_LOD_QTY = 0 THEN 0 
            ELSE ROUND(TS.TEU_TTL / TS.ALOC_LOD_QTY * 100,1) 
            END TS_RATIO
     , TS.OTHER_REMARK BKG_ALOC_RMK
     , TS.ALOC_SVC_CD
     , TS.BKG_ALOC_TP_CD
FROM (
      SELECT ALOC.*
             ,(SELECT NVL(SUM(DECODE(SUBSTR(BQ.CNTR_TPSZ_CD,-1),'2',BQ.OP_CNTR_QTY,BQ.OP_CNTR_QTY*2)),0) BKG_TEU
                 FROM BKG_VVD BV1
                      ,BKG_QUANTITY BQ
                      ,BKG_BOOKING BB1
                WHERE BV1.BKG_NO = BQ.BKG_NO
                  AND BV1.BKG_NO = BB1.BKG_NO
                  AND BV1.VSL_PRE_PST_CD <> 'T'
                  AND BB1.BKG_STS_CD <> 'X'
                  AND BB1.BKG_CGO_TP_CD = 'F'
                  AND (NVL(BB1.ALOC_STS_CD,'F') = 'F' OR BB1.BKG_NO = ALOC.BKG_NO)
                  AND BV1.SLAN_CD = ALOC.VVD_SLAN_CD
                  AND BV1.VSL_CD = ALOC.VVD_VSL_CD
                  AND BV1.SKD_VOY_NO = ALOC.VVD_SKD_VOY_NO
                  AND BV1.SKD_DIR_CD = ALOC.VVD_SKD_DIR_CD
                  AND BV1.SKD_DIR_CD = NVL(ALOC.N1ST_TS_DIR_CD,BV1.SKD_DIR_CD)
                  AND BV1.POL_CD IN (SELECT BAMD.LOC_CD FROM BKG_ALOC_MGMT_LOC_DTL BAMD WHERE BAMD.BKG_ALOC_SEQ = ALOC.VVD_POL_CD_SEQ AND BAMD.LOC_DIV_CD = 'POL' 
                                      UNION ALL SELECT BV1.POL_CD FROM DUAL WHERE VVD_POL_CD_SEQ IS NULL AND ALOC_POL_CD_SEQ IS NULL)
                  AND BV1.POD_CD IN (SELECT BAMD.LOC_CD FROM BKG_ALOC_MGMT_LOC_DTL BAMD WHERE BAMD.BKG_ALOC_SEQ = ALOC.VVD_POD_CD_SEQ AND BAMD.LOC_DIV_CD = 'POD'
                                      UNION ALL SELECT BV1.POD_CD FROM DUAL WHERE VVD_POD_CD_SEQ IS NULL AND ALOC_POD_CD_SEQ IS NULL)
                  AND SUBSTR(BV1.POL_CD,1,2) = NVL(ALOC.N1ST_TS_POL_CNT_CD,SUBSTR(BV1.POL_CD,1,2))
                  AND SUBSTR(BV1.POD_CD,1,2) = NVL(ALOC.N1ST_TS_POD_CNT_CD,SUBSTR(BV1.POD_CD,1,2))
                  AND EXISTS (SELECT 'X' FROM BKG_OFC_LVL_V LVL1 WHERE LVL1.OFC_N3RD_LVL_CD = ALOC.L_RHQ AND BB1.OB_SLS_OFC_CD = LVL1.OFC_CD) 
              ) TEU_TTL
      FROM ALOC        
      WHERE ALOC.VVD_POL_CD IN 
                        (SELECT BAMD.LOC_CD FROM BKG_ALOC_MGMT_LOC_DTL BAMD WHERE BAMD.BKG_ALOC_SEQ = ALOC.VVD_POL_CD_SEQ AND BAMD.LOC_DIV_CD = 'POL' 
                         UNION ALL SELECT ALOC.VVD_POL_CD FROM DUAL WHERE VVD_POL_CD_SEQ IS NULL AND ALOC_POL_CD_SEQ IS NULL)
      AND ALOC.VVD_POD_CD IN 
                        (SELECT BAMD.LOC_CD FROM BKG_ALOC_MGMT_LOC_DTL BAMD WHERE BAMD.BKG_ALOC_SEQ = ALOC.VVD_POD_CD_SEQ AND BAMD.LOC_DIV_CD = 'POD'
                          UNION ALL SELECT ALOC.VVD_POD_CD FROM DUAL WHERE VVD_POD_CD_SEQ IS NULL AND ALOC_POD_CD_SEQ IS NULL)
) TS 
) 
SELECT 'S' ALOC_STS_CD,BKG_ALOC_TP_CD,ALOC_SVC_CD,BKG_ALOC_RMK
FROM G_SUM      
WHERE  TS_RATIO > ALOC_LOD_QTY_RTO
AND ROWNUM = 1                  
			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="SEL382993700" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
