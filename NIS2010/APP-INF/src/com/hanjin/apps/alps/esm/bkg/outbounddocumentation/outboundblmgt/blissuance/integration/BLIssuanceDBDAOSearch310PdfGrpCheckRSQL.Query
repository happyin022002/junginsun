<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BLIssuanceDBDAOSearch310PdfGrpCheckRSQL">
			<desc><![CDATA[DRAFT B/L 을 화주의 FTP에 직접 등록시 어느 위치에 생성 시킬지 체크]]></desc>
			<sql><![CDATA[
SELECT ATTR_CTNT1
 	 , CASE WHEN ATTR_CTNT1 ='KUEHNENAGEL' THEN 
            NVL((SELECT RAT_FLG FROM BKG_CUST_BL_IMG_STUP WHERE CUST_CNT_CD = CUST.CUST_CNT_CD AND CUST_SEQ = CUST.CUST_SEQ AND NVL(BK.BL_TP_CD,'C') = BL_IMG_FILE_TP_CD),ATTR_CTNT2)  
            ELSE ATTR_CTNT2
       END ATTR_CTNT2
     , ATTR_CTNT3  
 	 , CASE WHEN ATTR_CTNT1 ='KUEHNENAGEL' AND NVL((SELECT RAT_FLG FROM BKG_CUST_BL_IMG_STUP WHERE CUST_CNT_CD = CUST.CUST_CNT_CD AND CUST_SEQ = CUST.CUST_SEQ AND NVL(BK.BL_TP_CD,'C') = BL_IMG_FILE_TP_CD),ATTR_CTNT2) = 'N' THEN 
            ATTR_CTNT4 || NVL((SELECT CUST_REF_NO_CTNT FROM BKG_REFERENCE WHERE BKG_NO = BK.BKG_NO AND BKG_REF_TP_CD = 'ESFF' AND LENGTH(CUST_REF_NO_CTNT) = 16 AND ROWNUM =1),(SELECT FWRD_REF_NO FROM (SELECT FWRD_REF_NO FROM BKG_XTER_RQST_MST WHERE BKG_NO = @[bkg_no] AND LENGTH(FWRD_REF_NO) = 16 ORDER BY CRE_DT DESC) WHERE ROWNUM =1)) 
            || DECODE(BK.BL_TP_CD,'W','X100101.','X110101.') ||'SML'|| TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS') ||'.pdf' 
            WHEN ATTR_CTNT1 ='KUEHNENAGEL' AND NVL((SELECT RAT_FLG FROM BKG_CUST_BL_IMG_STUP WHERE CUST_CNT_CD = CUST.CUST_CNT_CD AND CUST_SEQ = CUST.CUST_SEQ AND NVL(BK.BL_TP_CD,'C') = BL_IMG_FILE_TP_CD),ATTR_CTNT2) = 'Y' THEN
            ATTR_CTNT4 || NVL((SELECT CUST_REF_NO_CTNT FROM BKG_REFERENCE WHERE BKG_NO = BK.BKG_NO AND BKG_REF_TP_CD = 'ESFF' AND LENGTH(CUST_REF_NO_CTNT) = 16 AND ROWNUM =1),(SELECT FWRD_REF_NO FROM (SELECT FWRD_REF_NO FROM BKG_XTER_RQST_MST WHERE BKG_NO = @[bkg_no] AND LENGTH(FWRD_REF_NO) = 16 ORDER BY CRE_DT DESC) WHERE ROWNUM =1)) 
            || DECODE(BK.BL_TP_CD,'W','X130101.','X140101.') ||'SML'|| TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS') ||'.pdf' 
			WHEN ATTR_CTNT1 ='BDP_ANR' AND NVL(BK.BL_TP_CD,'N') ='W' THEN
            ATTR_CTNT4 || (SELECT TRIM(REPLACE(CUST_REF_NO_CTNT,'BDP REF','')) FROM BKG_REFERENCE WHERE BKG_NO = BK.BKG_NO AND BKG_REF_TP_CD = 'ESFF' AND ROWNUM =1 )||'_'|| BK.BKG_NO ||'_'||'SMLM'||BK.BL_NO || CASE WHEN ATTR_CTNT6 = 'YYYYMMDDHH24MISS' THEN '_'||TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS') ELSE '' END ||'_ExpressBL.pdf'  
            ELSE ATTR_CTNT4 || BK.BKG_NO || ATTR_CTNT5 || CASE WHEN ATTR_CTNT6 = 'YYYYMMDDHH24MISS' THEN '_'||TO_CHAR(SYSDATE,'YYYYMMDDHH24MISS') ELSE '' END ||'.pdf'  
       END ATTR_CTNT4
       -- OBL RELEASE / SWB RELEASE일때만 NON-nego copy form사용
 	 , CASE WHEN ATTR_CTNT1 ='KUEHNENAGEL' AND NVL(BK.BL_TP_CD,'N') = 'W' THEN ATTR_CTNT9
            WHEN ATTR_CTNT1 ='KUEHNENAGEL' AND NVL(BK.BL_TP_CD,'N') = 'N' AND ISS.OBL_RLSE_FLG = 'Y' THEN ATTR_CTNT9
            WHEN ATTR_CTNT1 ='KUEHNENAGEL' THEN 'BKG016'
            ELSE ATTR_CTNT9
       END ATTR_CTNT9
FROM
	 BKG_BOOKING BK,
     BKG_CUSTOMER CUST,
     BKG_EDI_GRP GRP,
     BKG_EDI_GRP_CUST GRP_CUST,
     BKG_HRD_CDG_CTNT HRD,
     BKG_BL_ISS ISS

WHERE 1=1
  AND BK.BKG_NO = @[bkg_no]
  AND BK.BKG_NO = ISS.BKG_NO(+)
  AND BK.BKG_NO = CUST.BKG_NO
  AND (
        (CUST.CUST_CNT_CD = GRP_CUST.CNT_CD AND CUST.CUST_SEQ = GRP_CUST.CUST_SEQ)
        OR BK.SC_NO = GRP_CUST.SC_NO
      )
#if (${ec_edircv_id_old} == 'KUEHNENAGEL') 
  AND CUST.CUST_CNT_CD = SUBSTR(@[group_edi_cust],0,2)
  AND CUST.CUST_SEQ = SUBSTR(@[group_edi_cust],3)
#end
  AND GRP.ESVC_GRP_CD = GRP_CUST.ESVC_GRP_CD
  AND GRP.CUST_TRD_PRNR_ID = HRD.ATTR_CTNT1
  AND HRD.HRD_CDG_ID ='310_EDI_PDF_GRP'
  AND GRP.ESVC_GRP_DELT_FLG = 'N'
  AND GRP_CUST.DELT_FLG = 'N'
  AND GRP.CO_CD ='H'
  AND ATTR_CTNT1 = @[ec_edircv_id_old]
  AND NOT EXISTS (SELECT 'Y' FROM BKG_BOOKING WHERE BKG_NO = BK.BKG_NO AND NVL(BL_TP_CD,'N') <> 'W' AND 'BDP_ANR' = @[ec_edircv_id_old]) --BDP_ANR 은 Waybill 만 전송
  AND ROWNUM = 1			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="group_edi_cust" type="12" value="" out="N"/>
				<param name="ec_edircv_id_old" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
