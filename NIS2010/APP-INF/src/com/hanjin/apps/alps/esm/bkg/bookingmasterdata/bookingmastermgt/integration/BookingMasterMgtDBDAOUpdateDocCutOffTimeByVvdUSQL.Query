<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BookingMasterMgtDBDAOUpdateDocCutOffTimeByVvdUSQL">
			<desc><![CDATA[Documentation Cut-Off Time Creation에 입력된 VVD정보에 따라서 Doc cut-off time을 재 setting한다.]]></desc>
			<sql><![CDATA[
MERGE INTO BKG_CLZ_TM TM 
USING
(
    SELECT VVD.BKG_NO
          ,VVD.VSL_CD||VVD.SKD_VOY_NO||VVD.SKD_DIR_CD VVD_CD
          ,VVD.POL_CD
          ,TO_CHAR(VVD.POL_CLPT_IND_SEQ) POL_CLPT_IND_SEQ
          ,BK.POD_CD
      FROM BKG_BOOKING BK, BKG_VVD VVD, BKG_BL_DOC DOC, MDM_LOCATION MDM
     WHERE BK.BKG_NO = VVD.BKG_NO
       AND BK.POL_CD = VVD.POL_CD
       AND VVD.VSL_PRE_PST_CD IN ('S','T')
       AND VVD.VSL_CD = SUBSTR(@[vvd_cd],1,4)
       AND VVD.SKD_VOY_NO = SUBSTR(@[vvd_cd],5,4)
       AND VVD.SKD_DIR_CD = SUBSTR(@[vvd_cd],9,1)
       AND BK.POL_CD = @[yd_cd]
       AND DECODE(@[vsl_slan_cd],'*',VVD.SLAN_CD, @[vsl_slan_cd]) = VVD.SLAN_CD
       AND DECODE(@[dest_cnt_cd],'*',SUBSTR(BK.POD_CD, 1, 2), @[dest_cnt_cd]) = SUBSTR(BK.POD_CD, 1, 2)
       AND DECODE(@[conti_cd],'*',MDM.CONTI_CD, @[conti_cd]) = MDM.CONTI_CD
       AND BK.POD_CD = MDM.LOC_CD
       AND BK.BKG_NO = DOC.BKG_NO
       AND DOC.bdr_flg = 'N'
) TGT
ON (TM.BKG_NO = TGT.BKG_NO AND TM.CLZ_TP_CD = 'D')
WHEN MATCHED THEN

UPDATE SET
 TM.SYS_SET_DT = (SELECT BKG_GET_DCT_CUT_OFF_FNC(TGT.VVD_CD, TGT.POL_CD, TGT.POL_CLPT_IND_SEQ, TGT.POD_CD) FROM DUAL)
,TM.MNL_SET_DT = TO_DATE(DECODE(TM.MNL_SET_DT,'','',TO_CHAR((SELECT BKG_GET_DCT_CUT_OFF_FNC(TGT.VVD_CD, TGT.POL_CD, TGT.POL_CLPT_IND_SEQ, TGT.POD_CD) FROM DUAL),'YYYYMMDDHH24MISS')),'YYYYMMDDHH24MISS')
,TM.MNL_SET_USR_ID = DECODE(TM.MNL_SET_USR_ID,'','',@[upd_usr_id])
,TM.UPD_USR_ID = @[upd_usr_id]
,TM.UPD_DT = SYSDATE			]]></sql>
			<params>
				<param name="vvd_cd" type="12" value="" out="N"/>
				<param name="yd_cd" type="12" value="" out="N"/>
				<param name="vsl_slan_cd" type="12" value="" out="N"/>
				<param name="dest_cnt_cd" type="12" value="" out="N"/>
				<param name="conti_cd" type="12" value="" out="N"/>
				<param name="upd_usr_id" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
