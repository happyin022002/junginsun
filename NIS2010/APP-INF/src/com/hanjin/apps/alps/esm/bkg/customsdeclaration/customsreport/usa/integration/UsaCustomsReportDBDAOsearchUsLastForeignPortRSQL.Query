<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="UsaCustomsReportDBDAOsearchUsLastForeignPortRSQL">
			<desc><![CDATA[vvd와 last foreign port를 이용해 crr_cd를 조회한다.]]></desc>
			<sql><![CDATA[
SELECT MD.CRR_CD, SV4.VPS_PORT_CD L_POL
FROM (
    SELECT SV2.VSL_CD,
      MAX(SV2.CLPT_SEQ) CLPT_SEQ,
      SV2.SKD_VOY_NO,
      SV2.SKD_DIR_CD
    FROM (
        SELECT VSL_CD,
          SKD_VOY_NO,
          SKD_DIR_CD,
          MIN(CLPT_SEQ) CLPT_SEQ
        FROM VSK_VSL_PORT_SKD K
        WHERE 1=1
          AND VPS_PORT_CD LIKE 'US%'
          AND NVL(SKD_CNG_STS_CD, 'X') != 'S'
        GROUP BY VSL_CD, SKD_VOY_NO , SKD_DIR_CD ) SV1,
      VSK_VSL_PORT_SKD SV2,
      MDM_VSL_CNTR VC
    WHERE SV1.VSl_CD = SV2.VSL_CD
      AND SV1.SKD_VOY_NO = SV2.SKD_VOY_NO
      AND SV1.SKD_DIR_CD = SV2.SKD_DIR_CD
      AND NVL(SV2.SKD_CNG_STS_CD, 'X') != 'S'
      AND SV2.CLPT_SEQ < SV1.CLPT_SEQ
      AND SV1.VSL_CD = VC.VSL_CD
      AND SV1.VSL_CD = SUBSTR(@[vvd], 1, 4)
      AND SV1.SKD_VOY_NO = SUBSTR(@[vvd], 5, 4)
      AND SV1.SKD_DIR_CD = SUBSTR(@[vvd], 9, 1)
      AND SV2.VPS_PORT_CD NOT IN (
        SELECT ATTR_CTNT1
        FROM BKG_CSTMS_CD_CONV_CTNT
        WHERE CNT_CD = 'US'
          AND CSTMS_DIV_ID='CANAL_LOC_CD' )
    GROUP BY SV2.VSL_CD, SV2.SKD_VOY_NO, SV2.SKD_DIR_CD ) SV3,
  MDM_VSL_CNTR MD,
  VSK_VSL_PORT_SKD SV4
WHERE SV3.VSL_CD = MD.VSL_CD 
  AND SV3.VSl_CD = SV4.VSL_CD
  AND SV3.SKD_VOY_NO = SV4.SKD_VOY_NO
  AND SV3.SKD_DIR_CD = SV4.SKD_DIR_CD
  AND SV3.CLPT_SEQ = SV4.CLPT_SEQ			]]></sql>
			<params>
				<param name="vvd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
