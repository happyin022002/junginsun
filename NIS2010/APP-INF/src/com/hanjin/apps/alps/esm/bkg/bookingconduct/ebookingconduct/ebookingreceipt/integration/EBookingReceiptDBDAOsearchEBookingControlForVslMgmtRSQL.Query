<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="EBookingReceiptDBDAOsearchEBookingControlForVslMgmtRSQL">
			<desc><![CDATA[searchEBookingControlForVslMgmt]]></desc>
			<sql><![CDATA[
SELECT SUM(CASE WHEN BKG_NO||XTER_RQST_SEQ=BKG_NO||MAX_SEQ THEN TEU ELSE 0 END) OVER() AS SUM_TEU,
       SUM(CASE WHEN BKG_NO||XTER_RQST_SEQ=BKG_NO||MAX_SEQ THEN FEU ELSE 0 END) OVER() AS SUM_FEU,
       SUM(CASE WHEN BKG_NO||XTER_RQST_SEQ=BKG_NO||MAX_SEQ THEN TEU ELSE 0 END + 2 *
           CASE WHEN BKG_NO||XTER_RQST_SEQ=BKG_NO||MAX_SEQ THEN FEU ELSE 0 END) OVER() AS SUM_TTL,
       SUM(CASE WHEN BKG_NO||XTER_RQST_SEQ=BKG_NO||MAX_SEQ THEN EST_WGT ELSE 0 END) OVER() AS SUM_WGT,
       SUM(CASE WHEN BKG_NO||XTER_RQST_SEQ=BKG_NO||MAX_SEQ AND 'F'=BKG_UPLD_STS_CD
           THEN CASE WHEN BKG_NO||XTER_RQST_SEQ=BKG_NO||MAX_SEQ THEN TEU ELSE 0 END + 2 *
                CASE WHEN BKG_NO||XTER_RQST_SEQ=BKG_NO||MAX_SEQ THEN FEU ELSE 0 END
           ELSE 0 END) OVER() AS SUM_ULD,
       SUM(CASE WHEN BKG_NO||XTER_RQST_SEQ=BKG_NO||MAX_SEQ AND 'F'!=BKG_UPLD_STS_CD
           THEN CASE WHEN BKG_NO||XTER_RQST_SEQ=BKG_NO||MAX_SEQ THEN TEU ELSE 0 END + 2 *
                CASE WHEN BKG_NO||XTER_RQST_SEQ=BKG_NO||MAX_SEQ THEN FEU ELSE 0 END
           ELSE 0 END) OVER() AS SUM_UNU,
       T.*
  FROM (
--------------------------------------------------------------------
SELECT MAX(XTER_RQST_SEQ) OVER(PARTITION BY BKG_NO) AS MAX_SEQ,
       ROW_NUMBER() OVER(ORDER BY MST.MDFY_XTER_RQST_NO) AS ROW_NUM,
       MST.XTER_RQST_ACPT_CD,
       TO_CHAR(MST.RQST_DT, 'YYYY-MM-DD HH24:MI') AS RQST_DT,
       MST.BKG_UPLD_STS_CD,
       MST.MDFY_XTER_RQST_NO,
       MST.XTER_RQST_NO,
       MST.XTER_RQST_SEQ,
       MST.XTER_BKG_RQST_STS_CD,
       MST.SH_NM,
       MST.VVD,
       POR_CD AS XTER_POR_CD,
       DEL_CD AS XTER_DEL_CD,
       MST.DEL_CN AS DELIVERY,
       MST.FRT_TERM,
       NVL((SELECT SUM(OP_CNTR_QTY)
              FROM BKG_QUANTITY
             WHERE BKG_NO = MST.BKG_NO
               AND SUBSTRB(CNTR_TPSZ_CD,-1) = '2'),
           NVL((SELECT SUM(CNTR_QTY)
                  FROM BKG_XTER_QTY
                 WHERE XTER_SNDR_ID = MST.XTER_SNDR_ID
                   AND XTER_RQST_NO = MST.XTER_RQST_NO
                   AND XTER_RQST_SEQ = MST.XTER_RQST_SEQ
                   AND SUBSTRB(CNTR_TPSZ_CD,-1) = '2'),0)) AS TEU,
       NVL((SELECT SUM(OP_CNTR_QTY)
              FROM BKG_QUANTITY
             WHERE BKG_NO = MST.BKG_NO
               AND SUBSTRB(CNTR_TPSZ_CD,-1) != '2'),
           NVL((SELECT SUM(CNTR_QTY)
                  FROM BKG_XTER_QTY
                 WHERE XTER_SNDR_ID = MST.XTER_SNDR_ID
                   AND XTER_RQST_NO = MST.XTER_RQST_NO
                   AND XTER_RQST_SEQ = MST.XTER_RQST_SEQ
                   AND SUBSTRB(CNTR_TPSZ_CD,-1) != '2'),0)) AS FEU,
       MST.EST_WGT,
       MST.BKG_NO,
       MST.CN_NM,
       MST.VSL_ENG_NM,
       MST.HNDL_OFC_CD,
       MST.DOC_TP_CD,
       MST.XTER_RQST_VIA_CD,
       MST.POL_CD AS XTER_POL_CD,
       MST.POD_CD AS XTER_POD_CD,
       TO_CHAR(MST.RQST_DEP_DT, 'YYYY-MM-DD') AS RQST_DEP_DT,
       LPAD(MST.SKD_VOY_NO, 4, '0') || MST.SKD_DIR_CD AS SKD_VOY_NO,
       MST.PO_NO,
       MST.CNTC_EML,
       MST.OFC_CD,
       MST.UPLD_USR_ID,
       MST.UPLD_USR_NM,
       TO_CHAR(MST.UPLD_DT, 'YYYY-MM-DD') AS UPLD_DT,
       MST.XTER_SNDR_ID,
       MST.VSL_CD,
       MST.BKG_STS_CD,
       MST.SNACCS_SPLIT_NO,
       MST.SC_NO,
       MST.RFA_NO,
       MST.TS_PORT_CD AS POD_CD,
       MST.BKG_POD_CD,
		MST.SPC_CTRLR_RMK
  FROM (SELECT DISTINCT
               NVL(XBK.XTER_RQST_ACPT_CD,'N') AS XTER_RQST_ACPT_CD,
               XBK.DOC_TP_CD,
               XBK.RQST_DT,
               CASE WHEN 1=INSTRB(XBK.XTER_RQST_NO,'B') THEN SUBSTRB(XBK.XTER_RQST_NO,2,LENGTHB(XBK.XTER_RQST_NO)) ELSE XBK.XTER_RQST_NO END AS MDFY_XTER_RQST_NO,
               XBK.XTER_RQST_NO,
               XBK.XTER_RQST_SEQ,
               XBK.XTER_BKG_RQST_STS_CD,
               XBK.XTER_RQST_VIA_CD,
               XBK.BKG_NO,
               XBK.BKG_UPLD_STS_CD,
               NVL(SH.CUST_CNT_CD, XSH.CNT_CD) AS SH_CNT,
               NVL(SH.CUST_SEQ, XSH.CUST_SEQ) AS SH_SEQ,
               NVL(CN.CUST_CNT_CD, XCN.CNT_CD) AS CN_CNT,
               NVL(CN.CUST_SEQ, XCN.CUST_SEQ) AS CN_SEQ,
               REPLACE(REPLACE(NVL(SH.CUST_NM, XSH.CUST_NM), CHR(13) || CHR(10), ' '), CHR(9), ' ') AS SH_NM,
               REPLACE(REPLACE(NVL(CN.CUST_NM, XCN.CUST_NM), CHR(13) || CHR(10), ' '), CHR(9), ' ') AS CN_NM,
               XBK.HNDL_OFC_CD,
               NVL(BK.POR_CD, XBK.POR_CD) AS POR_CD,
               NVL(BK.POL_CD, XBK.POL_CD) AS POL_CD,
               NVL(BK.POD_CD, XBK.POD_CD) AS POD_CD,
               NVL(BK.DEL_CD, XBK.DEL_CD) AS DEL_CD,
               XBK.POR_NM AS XTER_POR_NM,
               XBK.POL_NM AS XTER_POL_NM,
               XBK.POD_NM AS XTER_POD_NM,
               XBK.DEL_NM AS XTER_DEL_NM,
               XBK.RQST_DEP_DT,
               XBK.VSL_CD||XBK.SKD_VOY_NO||XBK.SKD_DIR_CD AS VVD,
               NVL((SELECT VSL_ENG_NM FROM MDM_VSL_CNTR VSL WHERE XBK.VSL_CD = VSL.VSL_CD), XBK.VSL_NM) AS VSL_ENG_NM,
               XBK.SKD_VOY_NO,
               XBK.SKD_DIR_CD,
               XBK.PO_NO,
               XBK.CNTC_EML,
               (SELECT OFC_CD FROM COM_USER USR WHERE XBK.UPLD_USR_ID = USR.USR_ID) AS OFC_CD,
               XBK.UPLD_USR_ID,
               (SELECT USR_NM FROM COM_USER USR WHERE XBK.UPLD_USR_ID = USR.USR_ID) AS UPLD_USR_NM,
               XBK.UPLD_DT,
               XBK.XTER_SNDR_ID,
               XBK.RQST_DELT_FLG,
               NVL(BK.OB_SREP_CD, XBK.SREP_CD) AS SREP_CD,
               RATE.FRT_TERM_CD AS FRT_TERM,
               DOC.ACT_WGT AS EST_WGT,
               BK.CHN_AGN_CD,
               BK.BKG_STS_CD,
               XBK.VSL_CD,
               XBK.SNACCS_SPLIT_NO,
               (SELECT CONTI_CD FROM MDM_LOCATION WHERE CNT_CD LIKE SUBSTR(NVL(NVL(BK.DEL_CD, XBK.DEL_CD), NVL(BK.POD_CD, XBK.POD_CD)), 1, 2) || '%' AND ROWNUM = 1) AS DEL_CN,
               BK.SC_NO,
               BK.RFA_NO,
               NVL(BK.PRE_RLY_PORT_CD,BK.PST_RLY_PORT_CD) AS TS_PORT_CD,
               BK.POD_CD AS BKG_POD_CD,
				XBK.SPC_CTRLR_RMK
          FROM BKG_BOOKING BK,
               BKG_CUSTOMER SH,
               BKG_CUSTOMER CN,
               BKG_CUSTOMER FF,
               BKG_XTER_RQST_MST XBK,
               BKG_XTER_CUST XSH,
               BKG_XTER_CUST XCN,
               BKG_XTER_CUST XFF,
               BKG_RATE RATE,
               BKG_BL_DOC DOC
         WHERE XBK.BKG_NO = BK.BKG_NO(+)
           AND XBK.BKG_NO       = SH.BKG_NO(+)
           AND 'S'              = SH.BKG_CUST_TP_CD(+)
           AND XBK.BKG_NO       = CN.BKG_NO(+)
           AND 'C'              = CN.BKG_CUST_TP_CD(+)
           AND XBK.BKG_NO       = FF.BKG_NO(+)
           AND 'F'              = FF.BKG_CUST_TP_CD(+)
           AND XBK.XTER_SNDR_ID = XSH.XTER_SNDR_ID(+)
           AND XBK.XTER_RQST_NO = XSH.XTER_RQST_NO(+)
           AND XBK.XTER_RQST_SEQ= XSH.XTER_RQST_SEQ(+)
           AND 'S'              = XSH.XTER_CUST_TP_CD(+)
           AND XBK.XTER_SNDR_ID = XCN.XTER_SNDR_ID(+)
           AND XBK.XTER_RQST_NO = XCN.XTER_RQST_NO(+)
           AND XBK.XTER_RQST_SEQ= XCN.XTER_RQST_SEQ(+)
           AND 'C'              = XCN.XTER_CUST_TP_CD(+)
           AND XBK.XTER_SNDR_ID = XFF.XTER_SNDR_ID(+)
           AND XBK.XTER_RQST_NO = XFF.XTER_RQST_NO(+)
           AND XBK.XTER_RQST_SEQ= XFF.XTER_RQST_SEQ(+)
           AND 'F'              = XFF.XTER_CUST_TP_CD(+)
           AND (NVL(XBK.XTER_BKG_RQST_STS_CD,' ') < 'T' OR NVL(XBK.XTER_BKG_RQST_STS_CD,' ') > 'T')
           AND (NVL(XBK.XTER_BL_TP_CD, ' ') < 'H' OR NVL(XBK.XTER_BL_TP_CD, ' ') > 'H')
           AND DECODE(XBK.XTER_SNDR_ID, 'SEANACCS', XBK.SNACCS_MSG_TP_CD, ' ') NOT IN ( 'SAT050', 'SAT054', 'SAT141', 'SAT142', 'SAT146', 'SAT147' )
           AND XBK.BKG_NO = RATE.BKG_NO(+)
           AND XBK.BKG_NO = DOC.BKG_NO(+)
#if (''!=${bkg_upld_sts_cd})
           AND XBK.BKG_UPLD_STS_CD IN (${bkg_upld_sts_cd})
#end
#if (''!=${hndl_ofc_cd})
           AND @[hndl_ofc_cd] = NVL(XBK.HNDL_OFC_CD, @[hndl_ofc_cd])
#end
#if (''!=${vvd})
           AND SUBSTRB(@[vvd],1,4) = XBK.VSL_CD
           AND SUBSTRB(@[vvd],5,4) = XBK.SKD_VOY_NO
           AND SUBSTRB(@[vvd],9,1) = XBK.SKD_DIR_CD
#else
    #if (''!=${rqst_from_dt})
           AND XBK.RQST_DT > TO_DATE(@[rqst_from_dt], 'YYYY-MM-DD')
    #end
    #if (''!=${rqst_to_dt})
           AND XBK.RQST_DT < TO_DATE(@[rqst_to_dt], 'YYYY-MM-DD') + 0.99999
    #end
#end
#if (''!=${pod_cd})
           AND NVL(BK.PRE_RLY_PORT_CD,BK.PST_RLY_PORT_CD) LIKE @[pod_cd]||'%'
#end
#if ('All'!=${doc_tp_cd} && ''!=${doc_tp_cd})
           AND XBK.DOC_TP_CD IN (${doc_tp_cd})
#end
#if ('All'!=${xter_bkg_rqst_sts_cd} && ''!=${xter_bkg_rqst_sts_cd})
           AND XBK.XTER_BKG_RQST_STS_CD IN (${xter_bkg_rqst_sts_cd})
#end
       ) MST
 WHERE 1=1
#if (''!=${chn_agn_cd})
   AND (@[chn_agn_cd] = SUBSTRB(MST.BKG_NO,5,2) OR @[chn_agn_cd] = SUBSTRB(MST.BKG_NO,3,2))
#end
#if (''!=${pol_cd})
   AND MST.POL_CD LIKE @[pol_cd]||'%'
#end
#if (''!=${bkg_pod_cd})
   AND MST.POD_CD LIKE @[bkg_pod_cd]||'%'
#end
#if ('All'!=${delivery} && ''!=${delivery})
   AND MST.DEL_CN IN (${delivery})
#end
 ORDER BY MST.MDFY_XTER_RQST_NO
--------------------------------------------------------------------
) T			]]></sql>
			<params>
				<param name="hndl_ofc_cd" type="12" value="" out="N"/>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="rqst_from_dt" type="12" value="" out="N"/>
				<param name="rqst_to_dt" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="chn_agn_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="bkg_pod_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
