<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="PerformanceReportDBDAOSearchSiAutoSREmlReceivingListVORSQL">
			<desc><![CDATA[PerformanceReportDBDAOSearchSiAutoSREmlReceivingListVORSQL]]></desc>
			<sql><![CDATA[
SELECT T2.*,R2.XTER_SNDR_ID
FROM (
SELECT 
	EML.BKG_NO
,	EML.BKG_NO AS ORG_BKG_NO
,	EML.BKG_NO	AS OLD_BKG_NO
,	NVL(EML.BKG_NO_MTCH_STS_CD,'F') BKG_NO_MTCH_STS_CD
,	( SELECT C.INTG_CD_VAL_DESC
	FROM  COM_INTG_CD_DTL C
	WHERE C.INTG_CD_ID = 'CD02803' 
	AND   C.INTG_CD_VAL_CTNT = NVL(EML.BKG_NO_MTCH_STS_CD,'F') ) AS BKG_NO_MTCH_STS_NM
,	EML.SR_AMD_TP_CD
,	EML.SR_AMD_TP_CD AS OLD_SR_AMD_TP_CD
,	EML.SR_AMD_KND_CD
,	EML.FNT_OFC_EML
,	EML.SR_URG_CD
,	EML.SR_URG_CD AS OLD_SR_URG_CD
,   EML.SPLIT_STS_CD,EML.BL_SPLIT_NO,EML.BL_SPLIT_TTL_KNT --add 2011.08.11
,   EML.SPLIT_STS_CD AS OLD_SPLIT_STS_CD ,EML.BL_SPLIT_NO AS OLD_BL_SPLIT_NO, EML.BL_SPLIT_TTL_KNT AS OLD_BL_SPLIT_TTL_KNT
,	EML.EML_SUBJ_CTNT
,	EML.SR_NO
,	EML.FAX_LOG_REF_NO
,	EML.SR_KND_CD
,	EML.SNDR_FAX_NO_CTNT
,	TO_CHAR(EML.RCV_DT,'YYYY-MM-DD HH24:MI')  RCV_DT
,   GLOBALDATE_PKG.TIME_CONV_FNC((SELECT LOC_CD FROM MDM_ORGANIZATION M WHERE M.OFC_CD = EML.RCV_OFC_CD), EML.RCV_DT, 'GMT') GMT_RCV_DT
,	EML.RCV_GDT
,	EML.RCV_OFC_CD
,	EML.RCV_NM
,	EML.RCV_RMK
,	EML.SR_TRNS_USR_ID
,   (SELECT USR_NM FROM COM_USER WHERE USR_ID = EML.SR_TRNS_USR_ID) SR_TRNS_USR_NM
--,	EML.SR_TRNS_DT
,   TO_CHAR(EML.SR_TRNS_DT,'YYYY-MM-DD HH24:MI') SR_TRNS_DT
,	EML.IMG_FILE_IP
,	EML.IMG_FILE_PATH_CTNT
,	EML.IMG_FILE_NM
,	EML.TTL_PG_KNT
,	EML.SR_FAX_RSLT_CD
,	DECODE(EML.SR_FAX_RSLT_CD,'10','Received Done','Received Error') AS SR_FAX_RSLT_NM
,	NVL(EML.SR_MTCH_STS_CD,'F') SR_MTCH_STS_CD
,	DECODE(EML.SR_MTCH_STS_CD,'A','Wt + Prc','W','Waiting','P','Processing','T','Transferred') AS SR_MTCH_STS_NM
,	EML.MTCH_USR_ID
,   (SELECT USR_NM FROM COM_USER WHERE USR_ID = EML.MTCH_USR_ID) MTCH_USR_NM
,	EML.WRK_TM_NO
,	EML.RTN_FM_STS_CD
,	EML.RTN_FM_USR_ID
,	EML.RTN_DT
,	EML.RTN_GDT
,	EML.SR_RTN_TO_STS_CD
,	EML.RTN_TO_USR_ID
,	EML.RTN_TO_RTN_DT
,	EML.RTN_TO_RTN_GDT
,	EML.RTN_TO_RTN_STS_CD
,	EML.RTN_TO_RTN_USR_ID
,	EML.CRE_USR_ID
,	EML.CRE_DT
,	EML.UPD_USR_ID
,	EML.UPD_DT
,	EML.EML_ORG_SUBJ_CTNT
,	'' FROM_DT
,	'' TO_DT
,	'' IS_EML_RCV_FAIL_FLG
,	'' CHK_EML_RCV_FAIL_FLG
,	'' EML_ORIGIN_SUBJ_CTNT
,	'' OFC_INC_SUB
,	NVL(EML.TTL_PG_KNT,0) ATCH_FILE_KNT
,	CASE WHEN NVL(EML.TTL_PG_KNT,0) > 0 THEN
	 (SELECT ATC.ATCH_FILE_PATH_CTNT 
		FROM BKG_SR_EML_ATCH_FILE ATC 
		WHERE ATC.SR_NO = EML.SR_NO 
		AND ATC.FAX_LOG_REF_NO = EML.FAX_LOG_REF_NO 
		AND	ATC.SR_KND_CD = EML.SR_KND_CD
		AND ROWNUM =1 ) ELSE '' END ATCH_FILE_PATH_CTNT 
, 		DECODE(TRIM(NVL(R.SR_CRNT_STS_CD,'')),'','ST',R.SR_CRNT_STS_CD ) AS  SR_CRNT_STS_CD    
,		( SELECT DECODE(BKG_NO_MTCH_STS_CD,'S',C.INTG_CD_VAL_DESC)
		FROM  COM_INTG_CD_DTL C
		WHERE C.INTG_CD_ID = 'CD01579' 
		AND   C.INTG_CD_VAL_CTNT = DECODE(TRIM(NVL(R.SR_CRNT_STS_CD,'')),'','ST',R.SR_CRNT_STS_CD ) ) AS SR_CRNT_STS_NM
,   NVL((SELECT MAX(t.XTER_RQST_SEQ) FROM BKG_XTER_RQST_MST t WHERE eml.sr_no  = t.XTER_RQST_NO(+)
                                                    AND   eml.FAX_LOG_REF_NO = t.FAX_LOG_REF_NO(+)
                                                    ),'-1') as max_seq
,   nvl(R.SR_AMD_SEQ,'-1') as SR_AMD_SEQ 
, EML.SOL_APLY_PHS_NO
,( SELECT C.INTG_CD_VAL_DP_DESC
	FROM  COM_INTG_CD_DTL C
	WHERE C.INTG_CD_ID = 'CD02961' 
	AND   C.INTG_CD_VAL_CTNT = EML.SI_RQST_CNG_BSE_CD ) AS SI_RQST_CNG_BSE_CD
, DECODE(EML.SI_DOC_READ_SCS_FLG, 'Y','Success','N','Fail') as SI_DOC_READ_SCS_FLG
FROM BKG_SR_FAX EML
,    BKG_SR_CRNT_RQST R
WHERE 1 = 1
AND   EML.SR_NO  = R.SR_NO(+)
AND   EML.SR_KND_CD = R.SR_KND_CD(+)
AND   EML.FAX_LOG_REF_NO = R.FAX_LOG_REF_NO(+)
----------------------------
/* DPCS email-tab 과 겹치지 않게 하느 조건 */
AND   EML.BKG_NO NOT IN (
            SELECT b.bkg_no  
            FROM   BKG_BOOKING B ,BKG_CUSTOMER S, MDM_LOCATION POD
            WHERE   (
                     SUBSTR(B.BKG_NO, 1, 3) IN (SELECT ATTR_CTNT1 FROM BKG_HRD_CDG_CTNT
												WHERE HRD_CDG_ID ='DPCS_BKG_PREFIX')
                      /* DPCS Q-List로 포함조건 중 '일본발 S/I'에 대해서는 */                          
                      OR   B.POR_CD IN ('JPTYO','JPOSA','JPUKB','JPYOK','JPKIJ')  
                      /* 남중국 DPCS 처리대상 : BKG Office기준 6개 */
                      OR   B.BKG_OFC_CD IN (SELECT ATTR_CTNT2
                                            FROM BKG_HRD_CDG_CTNT H
                                            WHERE H.HRD_CDG_ID = 'CHINA_DPCS')

                      )                       
                                             
            AND    B.BKG_NO = eml.BKG_NO
            /* 2011.04. 25 한시적으로 미주 물량을 PKGSC에서 처리 못하는 관계로 아래 물량은 F/O에서 처리토록 예외를 넣어 놓는다 */                                    
            AND  
                 (VSL_CD||SKD_VOY_NO||SKD_DIR_CD||BKG_OFC_CD)  NOT IN  (
                                                                 SELECT DISTINCT ATTR_CTNT1
                                                                 FROM   BKG_HRD_CDG_CTNT
                                                                 WHERE  HRD_CDG_ID = 'DPCS' AND HRD_CDG_ID_SEQ < 90000 AND ATTR_CTNT10 = 'N'
                                                                 )
                                                    
            AND  B.BKG_NO = S.BKG_NO
            AND  S.BKG_CUST_TP_CD ='S' 
            AND  S.CUST_CNT_CD||S.CUST_SEQ NOT IN (
                                                  SELECT DISTINCT ATTR_CTNT1
                                                  FROM   BKG_HRD_CDG_CTNT
                                                  WHERE  HRD_CDG_ID = 'DPCS' AND HRD_CDG_ID_SEQ > 90000 AND ATTR_CTNT10 = 'N'
                                                  )
                                                  /*'US23335','US1650','US39899','US6047','US2495',
                                                   'US8557','US4558',\\\\\\\\\\\\\\\\*'US4431',*\\\\\\\\\\\\\\\\'US5016','US546','US625')   */  
            AND  S.CUST_CNT_CD||S.CUST_SEQ NOT IN (
                                                  SELECT DISTINCT ATTR_CTNT1
                                                  FROM   BKG_HRD_CDG_CTNT H, BKG_CUSTOMER F
                                                  WHERE  HRD_CDG_ID = 'DPCS' 
                                                  AND HRD_CDG_ID_SEQ > 90000 
                                                  AND ATTR_CTNT10 = 'Y'
                                                  AND ATTR_CTNT9 = 'Y'
                                                  AND F.BKG_NO = S.BKG_NO
                                                  AND F.BKG_CUST_TP_CD = 'F'
                                                  AND (
                                                        (F.CUST_CNT_CD = S.CUST_CNT_CD AND F.CUST_SEQ = S.CUST_SEQ)
                                                        OR 
                                                        (F.CUST_CNT_CD IS NULL AND F.CUST_SEQ IS NULL)
                                                      )
                                                  )
            AND  B.POD_CD = POD.LOC_CD
            AND  POD.CONTI_CD||S.CUST_CNT_CD||S.CUST_SEQ NOT IN (SELECT ATTR_CTNT3||ATTR_CTNT4
                                                  FROM   BKG_HRD_CDG_CTNT
                                                  WHERE  HRD_CDG_ID = 'DPCS'
                                                  AND ATTR_CTNT1 IS NULL)
)                                                   
----------------------------
AND	NVL(SR_MTCH_STS_CD,' ') != 'D'
AND nvl(EML.BKG_NO_MTCH_STS_CD,' ') = nvl(@[sr_bkg_sts_cd], nvl(EML.BKG_NO_MTCH_STS_CD,' ')) -- add 2011.08.11
AND nvl(EML.SR_URG_CD,' ') = nvl(@[sr_urgency_cd], nvl(EML.SR_URG_CD,' ')) -- add 2011.08.11
AND nvl(EML.SR_AMD_TP_CD,' ') = nvl(decode(@[sr_knd_combo_cd],'L',nvl(EML.SR_AMD_TP_CD,' '),@[sr_knd_combo_cd]  ), nvl(EML.SR_AMD_TP_CD,' ')) -- add 2011.08.11
AND nvl(EML.SPLIT_STS_CD,' ') = nvl(@[split_bkg_yn], nvl(EML.SPLIT_STS_CD,' ')) -- add 2011.08.11
AND nvl(EML.SR_PROC_TP_CD,' ') = nvl(@[sr_if_status_cd], nvl(EML.SR_PROC_TP_CD,' ')) -- add 2011.08.11


#if (${bkg_no} != '') 
	AND EML.BKG_NO= @[bkg_no]
#elseif (${from_dt} != '') 
	AND	TO_CHAR(RCV_DT,'YYYY-MM-DD') between @[from_dt] and @[to_dt]
#end
#if (${ofc_inc_sub} != '' && ${rcv_ofc_cd} != '')  
	AND EML.RCV_OFC_CD IN (
		SELECT 	OFC_CD  
		FROM   	MDM_ORGANIZATION MO
		START 	WITH MO.OFC_CD = @[rcv_ofc_cd]
				CONNECT BY PRIOR MO.OFC_CD = MO.PRNT_OFC_CD)
#else 
	#if (${rcv_ofc_cd} != '') 
	AND   EML.RCV_OFC_CD = @[rcv_ofc_cd] 
	#end
#end 

#if (${sr_no} != '') 
AND EML.SR_NO = @[sr_no]
#end
#if (${fax_log_ref_no} != '') 
AND	EML.FAX_LOG_REF_NO  = @[fax_log_ref_no]
#end

#if (${chk_eml_rcv_fail_flg} != '') 
AND	(EML.BKG_NO_MTCH_STS_CD = 'F' OR NVL(EML.SR_FAX_RSLT_CD,'11') = '11')
#else 
#if (${sr_mtch_sts_cd} != '' && ${sr_mtch_sts_cd} == 'A')
AND (SR_MTCH_STS_CD = 'W' OR SR_MTCH_STS_CD = 'P')
#elseif (${sr_mtch_sts_cd} != '' && ${sr_mtch_sts_cd} != 'A')
AND SR_MTCH_STS_CD = @[sr_mtch_sts_cd]
#end 	
#end
AND EML.SR_KND_CD in('M', 'U')
AND NVL(R.SR_AMD_SEQ,'-1') = NVL((SELECT MAX(R2.SR_AMD_SEQ) FROM BKG_SR_CRNT_RQST R2 WHERE R2.SR_NO  = R.SR_NO
                                            AND   R2.SR_KND_CD = R.SR_KND_CD
                                            AND   R2.FAX_LOG_REF_NO = R.FAX_LOG_REF_NO),'-1')
ORDER BY EML.RCV_DT,EML.SR_NO
)T2,  BKG_XTER_RQST_MST R2
WHERE T2.SR_NO  = R2.XTER_RQST_NO(+)
  AND T2.FAX_LOG_REF_NO = R2.FAX_LOG_REF_NO(+)
  AND T2.max_SEQ  = R2.xter_rqst_seq(+)			]]></sql>
			<params>
				<param name="sr_bkg_sts_cd" type="12" value="" out="N"/>
				<param name="sr_urgency_cd" type="12" value="" out="N"/>
				<param name="sr_knd_combo_cd" type="12" value="" out="N"/>
				<param name="split_bkg_yn" type="12" value="" out="N"/>
				<param name="sr_if_status_cd" type="12" value="" out="N"/>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="from_dt" type="12" value="" out="N"/>
				<param name="to_dt" type="12" value="" out="N"/>
				<param name="rcv_ofc_cd" type="12" value="" out="N"/>
				<param name="sr_no" type="12" value="" out="N"/>
				<param name="fax_log_ref_no" type="12" value="" out="N"/>
				<param name="sr_mtch_sts_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
