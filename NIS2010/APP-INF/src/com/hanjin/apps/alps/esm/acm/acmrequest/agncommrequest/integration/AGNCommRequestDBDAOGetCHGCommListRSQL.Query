<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="AGNCommRequestDBDAOGetCHGCommListRSQL">
			<desc><![CDATA[Get CHG Comm List]]></desc>
			<sql><![CDATA[
WITH ACM_PARAM AS (
    SELECT AGN_CD
         , AGN_AGMT_NO
         , IO_BND_CD
         , AC_TP_CD
         , OFC_SET_TP_CD
         , OFC_CVRG_CD
         , OFC_CD
         , POR_CD
         , POL_CD
         , POD_CD
         , DEL_CD
    FROM 
        (SELECT AGN_CD
              , AGN_AGMT_NO
              , IO_BND_CD
              , AC_TP_CD
              , NVL(OFC_SET_TP_CD, 'XXX') OFC_SET_TP_CD
              , NVL(OFC_CVRG_CD, 'XXX') OFC_CVRG_CD
              , NVL(OFC_CD, 'XXX') OFC_CD
         FROM ACM_AGN_AGMT_DTL
         WHERE AGN_CD = @[agn_cd]
         AND AGN_AGMT_NO = @[agn_agmt_no]
         AND IO_BND_CD = @[io_bnd_cd]
         AND AC_TP_CD = @[ac_tp_cd]
         AND AGN_AGMT_SEQ = @[agn_agmt_seq]) A,
        (SELECT NVL(SUBSTR(XMLAGG(XMLELEMENT(X,'',DECODE(ROUT_REF_DIV_CD, 'POR', ROUT_INFO_CD, '')) ORDER BY AGN_AGMT_SEQ, AGN_AGMT_ROUT_SEQ).EXTRACT('//text()'), 1), 'XXX') AS POR_CD
			  , NVL(SUBSTR(XMLAGG(XMLELEMENT(X,'',DECODE(ROUT_REF_DIV_CD, 'POL', ROUT_INFO_CD, '')) ORDER BY AGN_AGMT_SEQ, AGN_AGMT_ROUT_SEQ).EXTRACT('//text()'), 1), 'XXX') AS POL_CD
			  , NVL(SUBSTR(XMLAGG(XMLELEMENT(X,'',DECODE(ROUT_REF_DIV_CD, 'POD', ROUT_INFO_CD, '')) ORDER BY AGN_AGMT_SEQ, AGN_AGMT_ROUT_SEQ).EXTRACT('//text()'), 1), 'XXX') AS POD_CD
			  , NVL(SUBSTR(XMLAGG(XMLELEMENT(X,'',DECODE(ROUT_REF_DIV_CD, 'DEL', ROUT_INFO_CD, '')) ORDER BY AGN_AGMT_SEQ, AGN_AGMT_ROUT_SEQ).EXTRACT('//text()'), 1), 'XXX') AS DEL_CD
         FROM ACM_AGN_AGMT_DTL_ROUT
         WHERE AGN_CD = @[agn_cd]
         AND AGN_AGMT_NO = @[agn_agmt_no]
         AND IO_BND_CD = @[io_bnd_cd]
         AND AC_TP_CD = @[ac_tp_cd]
         AND AGN_AGMT_SEQ = @[agn_agmt_seq]) B  
)
SELECT @[bkg_no] AS BKG_NO
     , @[agn_cd] AS AGN_CD
     , @[io_bnd_cd] AS IO_BND_CD
     , @[ac_tp_cd] AS AC_TP_CD
     , @[max_ac_seq] AS MAX_AC_SEQ
     , @[ofc_curr_cd] AS OFC_CURR_CD
     , @[pay_xch_rt] AS PAY_XCH_RT
     , @[sa_dt] AS SA_DT
     , @[usr_id] AS USR_ID
     , A.CHG_COMM_DIV_CD
     , A.CHG_COMM_RT
     , A.CHG_COMM_OTR_AMT
     , A.CHG_COMM_CURR_CD
     , A.CHG_COMM_PAY_TERM_CD
     , C.CHG_CD AS COMM_CHG_CD
	 , NVL(E.USD_LOCL_XCH_RT, 0) AS USD_XCH_RT
FROM ACM_AGN_AGMT_DTL A,
     (SELECT AGN_AGMT_SEQ
           , NVL(SUBSTR(XMLAGG(XMLELEMENT(X,'',DECODE(ROUT_REF_DIV_CD, 'POR', ROUT_INFO_CD, '')) ORDER BY AGN_AGMT_SEQ, AGN_AGMT_ROUT_SEQ).EXTRACT('//text()'), 1), 'XXX') AS POR_CD
		   , NVL(SUBSTR(XMLAGG(XMLELEMENT(X,'',DECODE(ROUT_REF_DIV_CD, 'POL', ROUT_INFO_CD, '')) ORDER BY AGN_AGMT_SEQ, AGN_AGMT_ROUT_SEQ).EXTRACT('//text()'), 1), 'XXX') AS POL_CD
		   , NVL(SUBSTR(XMLAGG(XMLELEMENT(X,'',DECODE(ROUT_REF_DIV_CD, 'POD', ROUT_INFO_CD, '')) ORDER BY AGN_AGMT_SEQ, AGN_AGMT_ROUT_SEQ).EXTRACT('//text()'), 1), 'XXX') AS POD_CD
		   , NVL(SUBSTR(XMLAGG(XMLELEMENT(X,'',DECODE(ROUT_REF_DIV_CD, 'DEL', ROUT_INFO_CD, '')) ORDER BY AGN_AGMT_SEQ, AGN_AGMT_ROUT_SEQ).EXTRACT('//text()'), 1), 'XXX') AS DEL_CD
      FROM ACM_AGN_AGMT_DTL_ROUT
      WHERE AGN_CD = @[agn_cd]
      AND AGN_AGMT_NO = @[agn_agmt_no]
      AND IO_BND_CD = @[io_bnd_cd]
      AND AC_TP_CD = @[ac_tp_cd]
      GROUP BY AGN_AGMT_SEQ) B,
     ACM_AGN_AGMT_CHG_COMM C,
     ACM_PARAM D,
     GL_MON_XCH_RT E
WHERE A.AGN_CD = D.AGN_CD
AND A.AGN_AGMT_NO = D.AGN_AGMT_NO
AND A.IO_BND_CD = D.IO_BND_CD
AND A.AC_TP_CD = D.AC_TP_CD
AND NVL(A.OFC_SET_TP_CD, 'XXX') = D.OFC_SET_TP_CD
AND NVL(A.OFC_CVRG_CD, 'XXX') = D.OFC_CVRG_CD
AND NVL(A.OFC_CD, 'XXX') = D.OFC_CD
AND A.AGN_AGMT_SEQ = B.AGN_AGMT_SEQ(+)
AND NVL(B.POR_CD, 'XXX') = D.POR_CD
AND NVL(B.POL_CD, 'XXX') = D.POL_CD
AND NVL(B.POD_CD, 'XXX') = D.POD_CD
AND NVL(B.DEL_CD, 'XXX') = D.DEL_CD
AND A.AGN_CD = C.AGN_CD
AND A.AGN_AGMT_NO = C.AGN_AGMT_NO
AND A.IO_BND_CD = C.IO_BND_CD
AND A.AC_TP_CD = C.AC_TP_CD
AND A.AGN_AGMT_SEQ = C.AGN_AGMT_SEQ
AND ((A.CHG_COMM_DIV_CD = 'M' AND C.CHG_CD IN (SELECT CHG_CD FROM BKG_CHG_RT WHERE BKG_NO = @[bkg_no] AND FRT_INCL_XCLD_DIV_CD = 'N' AND FRT_TERM_CD = DECODE(A.CHG_COMM_PAY_TERM_CD, 'T', FRT_TERM_CD, '', FRT_TERM_CD, A.CHG_COMM_PAY_TERM_CD)))
  OR (A.CHG_COMM_DIV_CD = 'T' AND C.CHG_CD IN (SELECT CHG_CD FROM BKG_TRF_SCG_RT WHERE BKG_NO = @[bkg_no] AND FRT_INCL_XCLD_DIV_CD = 'N' AND FRT_TERM_CD = DECODE(A.CHG_COMM_PAY_TERM_CD, 'T', FRT_TERM_CD, '', FRT_TERM_CD, A.CHG_COMM_PAY_TERM_CD)))
  OR (A.CHG_COMM_DIV_CD = 'R' AND C.CHG_CD IN (SELECT CHG_CD FROM INV_AR_MN P, INV_AR_CHG Q WHERE P.AR_IF_NO = Q.AR_IF_NO AND P.BKG_NO = @[bkg_no] AND P.REV_TP_CD = 'M' AND P.IO_BND_CD = DECODE(A.CHG_COMM_PAY_TERM_CD, 'T', P.IO_BND_CD, '', P.IO_BND_CD, DECODE(A.CHG_COMM_PAY_TERM_CD, 'P', 'O', 'I')))))
AND A.CHG_COMM_CURR_CD = E.CURR_CD(+)
AND E.ACCT_XCH_RT_YRMON(+) = DECODE(SIGN(TO_NUMBER(TO_CHAR(SYSDATE, 'YYYYMM')) - TO_NUMBER(SUBSTR (@[sa_dt], 1, 6))), 1, SUBSTR (@[sa_dt], 1, 6),TO_CHAR(SYSDATE, 'YYYYMM')) 
AND E.ACCT_XCH_RT_LVL(+) = '1'			]]></sql>
			<params>
				<param name="agn_cd" type="12" value="" out="N"/>
				<param name="agn_agmt_no" type="12" value="" out="N"/>
				<param name="io_bnd_cd" type="12" value="" out="N"/>
				<param name="ac_tp_cd" type="12" value="" out="N"/>
				<param name="agn_agmt_seq" type="12" value="" out="N"/>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="max_ac_seq" type="12" value="" out="N"/>
				<param name="ofc_curr_cd" type="12" value="" out="N"/>
				<param name="pay_xch_rt" type="12" value="" out="N"/>
				<param name="sa_dt" type="12" value="" out="N"/>
				<param name="usr_id" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
