<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="UsaCustomsTransmissionDBDAOsearchAdvBlOBRSQL">
			<desc><![CDATA[DWKIM, BKG_CSTMS_ADV_BL조회.]]></desc>
			<sql><![CDATA[
SELECT
      BKG.VSL_CD
      ,NVL(BKG.USA_CSTMS_FILE_CD,'3') AS CSTMS_FILE_TP_CD 
      ,'N' FROB_FLG 
      , ( SELECT BL_NO FROM BKG_BOOKING WHERE BKG_NO = DECODE(BKG.BKG_CRE_TP_CD, 'S', BKG.FM_BKG_NO, NULL)) PRE_MF_NO
      ,BKG.BL_NO 
      ,BKG.POL_CD
      ,NVL(P.USA_CSTMS_PCK_CD,'PKG') AS AMS_PCK_TP_CD
      ,'US' CNT_CD
      ,NVL(D.WGT_UT_CD,'KGS') AS WGT_UT_CD
      ,VVD.POD_CD CSTMS_POD_CD
      ,BKG.UPD_USR_ID
      ,(SELECT SUBSTR( MIN( LPAD(CLPT_SEQ, 2, 0) ||VPS_PORT_CD) , 3)
                    FROM VSK_VSL_PORT_SKD
                   WHERE 1=1
                     AND	SUBSTR(VPS_PORT_CD,1,2)	IN('US', (SELECT ATTR_CTNT1 FROM BKG_CSTMS_CD_CONV_CTNT 
                                                                                    WHERE CNT_cD='US'
                                                                                    AND CSTMS_DIV_ID= 'US_CNT_CD_LIST') 
                                                                        )                             
                     AND VSL_CD = VVD.VSL_CD
                     AND SKD_VOY_NO = VVD.SKD_VOY_NO
                     AND SKD_DIR_CD = VVD.SKD_DIR_CD
                     AND CLPT_IND_SEQ = '1' 
       )AS CSTMS_PORT_CD
       ,D.ACT_WGT AS CGO_WGT
       ,CASE WHEN BKG.POD_CD = BKG.DEL_CD THEN BKG.POD_CD ELSE '' END CSTMS_LOC_CD
       , SYSDATE AMDT_SND_DT
      ,BKG.DEL_CD
      ,BKG.SKD_VOY_NO
      ,BKG.POD_CD 
      ,C.CA_ISS_DT
      ,BKG.CRE_USR_ID
      ,BKG.BKG_NO
      ,BKG.BKG_CGO_TP_CD FULL_MTY_CD
      ,BKG.POR_CD
      ,VVD.POL_CD CSTMS_POL_CD
	   ,'' AS MF_NO
       ,D.BDR_FLG     
      ,'A' MF_STS_CD 
      ,SCAC_CD
       ,SYSDATE MF_SND_DT 
       ,D.MEAS_QTY      
       ,D.PCK_QTY
      ,TO_CHAR(D.BDR_DT,'YYYYMMDDHH24MISS') AS BDR_DTBDR_DT
      ,BKG.RCV_TERM_CD
      ,D.MEAS_UT_CD
      ,BKG.UPD_DT
      ,BKG.SKD_DIR_CD
      ,BKG.DE_TERM_CD
      ,BKG.SLAN_CD
      ,C.CA_NO
      ,CASE WHEN BKG.POD_CD = 'USLAX' AND L2.SCC_CD = 'USLGB' THEN L1.SCC_CD
             WHEN BKG.POD_CD = 'USSEA' AND (L2.STE_CD LIKE 'ID%' OR L2.STE_CD LIKE 'MT%') THEN BKG.POD_CD
             WHEN BKG.POD_CD = BKG.DEL_CD THEN BKG.POD_CD
      		 ELSE L2.SCC_CD
       END HUB_LOC_CD
	  ,BKG.POD_CD IBFLAG
	  ,(SELECT ATTR_CTNT2 FROM BKG_CSTMS_CD_CONV_CTNT
		WHERE CNT_CD='US'
		AND CSTMS_DIV_ID='AMS_TML_CD_MAP'
		AND ATTR_CTNT1= BKG.POL_NOD_CD
		AND ROWNUM=1
		) AMS_TML_CD
  FROM BKG_BOOKING BKG , BKG_VVD VVD , BKG_BL_DOC D,MDM_PCK_TP P
	,(  SELECT  BKG_NO
	           ,CORR_NO AS CA_NO
        	   ,TO_CHAR(CORR_DT,'YYYYMMDDHH24MISS') AS CA_ISS_DT
        FROM   BKG_CORRECTION
        WHERE  CORR_DT = ( SELECT MAX(CORR_DT)
                           FROM   BKG_CORRECTION
                           WHERE  BKG_NO = @[bl_no]
                             AND  CORR_CXL_FLG = 'N' )
        AND    BKG_NO = @[bl_no]
        AND    CORR_CXL_FLG = 'N'
     ) C
    ,MDM_LOCATION L1
    ,MDM_LOCATION L2  
 WHERE BKG.BKG_NO = @[bl_no]
    AND BKG.BKG_NO = VVD.BKG_NO
    AND BKG.BKG_NO     = D.BKG_NO(+)     
    AND BKG.BKG_NO     = C.BKG_NO(+)    
    AND D.PCK_TP_CD  = P.PCK_CD(+)
    AND BKG.POD_CD     = L1.LOC_CD
    AND BKG.DEL_CD     = L2.LOC_CD    
    AND VVD.VSL_CD     = SUBSTR(@[vvd],1,4) 
    AND VVD.SKD_VOY_NO = SUBSTR(@[vvd],5,4) 
    AND VVD.SKD_DIR_CD = SUBSTR(@[vvd],9,1)			]]></sql>
			<params>
				<param name="bl_no" type="12" value="" out="N"/>
				<param name="vvd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
