<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="QtaAdjustmentDBDAOCopyCfmQtaForSectorUSQL">
			<desc><![CDATA[P/F GROUP 변경
 - VVD별 QTA Editor 데이터에 P/F Group 가 다를 경우가 존재함에 따라 
 - 데이터 보정을 위해 사용됨.
2016.05.20 김용습 프로포마 그룹 일괄적용되는 현상 수정]]></desc>
			<sql><![CDATA[
MERGE INTO SQM_SCTR_CFM_QTA M1 USING
(
 SELECT QTA_RLSE_VER_NO
      , BSE_TP_CD
      , BSE_YR
      , BSE_QTR_CD
      , OFC_VW_CD
      , RLANE_CD
      , DIR_CD
      , VSL_CD
      , SKD_VOY_NO
      , SKD_DIR_CD
      , RGN_OFC_CD
      , POL_CD
      , POD_CD
      , @[mas_pf_grp_cd] AS PF_GRP_CD
      , TRD_CD
      , SUB_TRD_CD
      , RHQ_CD
      , AQ_CD
      , FNL_BSA_CAPA
      , LOD_QTY
      , GRS_RPB_REV
      , PA_CM_UC_AMT
      , RA_CM_UC_AMT
      , POL_CALL_SEQ
      , POD_CALL_SEQ
      , SQM_CNG_TP_CD
      , @[usr_id] AS CRE_USR_ID
      , SYSDATE   AS CRE_DT
      , @[usr_id] AS UPD_USR_ID
      , SYSDATE   AS UPD_DT
   FROM SQM_SCTR_CFM_QTA
  WHERE 1               =1
    AND QTA_RLSE_VER_NO = SUBSTR(@[bse_yr], -2) ||@[bse_qtr_cd]||'02'
    AND BSE_TP_CD       = @[bse_tp_cd]
    AND BSE_YR          = @[bse_yr]
    AND BSE_QTR_CD      = @[bse_qtr_cd]
    AND RLANE_CD        = @[rlane_cd]
    AND DIR_CD          = @[dir_cd]
    AND VSL_CD          = SUBSTR(NVL(@[vvd], @[mas_vvd]), 1, 4)
    AND SKD_VOY_NO      = SUBSTR(NVL(@[vvd], @[mas_vvd]), 5, 4)
    AND SKD_DIR_CD      = SUBSTR(NVL(@[vvd], @[mas_vvd]), 9, 1)
) S1
ON (
            M1.QTA_RLSE_VER_NO = S1.QTA_RLSE_VER_NO
        AND M1.BSE_TP_CD       = S1.BSE_TP_CD
        AND M1.BSE_YR          = S1.BSE_YR
        AND M1.BSE_QTR_CD      = S1.BSE_QTR_CD
        AND M1.OFC_VW_CD       = S1.OFC_VW_CD
        AND M1.RLANE_CD        = S1.RLANE_CD
        AND M1.DIR_CD          = S1.DIR_CD
        AND M1.VSL_CD          = S1.VSL_CD
        AND M1.SKD_VOY_NO      = S1.SKD_VOY_NO
        AND M1.SKD_DIR_CD      = S1.SKD_DIR_CD
        AND M1.RGN_OFC_CD      = S1.RGN_OFC_CD
        AND M1.POL_CD          = S1.POL_CD
        AND M1.POD_CD          = S1.POD_CD
)
WHEN MATCHED THEN 
    UPDATE
       SET --M1.PF_GRP_CD  = S1.PF_GRP_CD
		   M1.PF_GRP_CD  = (SELECT MAX(P.PF_GRP_CD) FROM SQM_SCTR_PAIR_MGMT P
                                WHERE P.BSE_TP_CD = S1.BSE_TP_CD
                                AND P.BSE_YR = S1.BSE_YR
                                AND P.BSE_QTR_CD = S1.BSE_QTR_CD
                                AND P.RLANE_CD = S1.RLANE_CD
                                AND P.DIR_CD = S1.DIR_CD
                                AND P.SUB_TRD_CD = S1.SUB_TRD_CD
                                AND P.POL_CD = S1.POL_CD
                                AND P.POD_CD = S1.POD_CD
                                AND P.SQM_ACT_FLG = 'Y')
         , M1.UPD_USR_ID = S1.UPD_USR_ID
         , M1.UPD_DT     = S1.UPD_DT			]]></sql>
			<params>
				<param name="mas_pf_grp_cd" type="12" value="" out="N"/>
				<param name="usr_id" type="12" value="" out="N"/>
				<param name="bse_yr" type="12" value="" out="N"/>
				<param name="bse_qtr_cd" type="12" value="" out="N"/>
				<param name="bse_tp_cd" type="12" value="" out="N"/>
				<param name="rlane_cd" type="12" value="" out="N"/>
				<param name="dir_cd" type="12" value="" out="N"/>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="mas_vvd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
