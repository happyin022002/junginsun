<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ModelManageDBDAOCheckAmendScRfaRSQL">
			<desc><![CDATA[입력한 S/C, RFA 가 유효 한지 확인합니다.
2014.03.06 [CHM-20142960] SMP/Allocation control보완 요청
2014.05.16 [CHM-201430353] SMP / AES 보완요청 - SC 입력 기능 추가
2015.02.06 박은주 [CHM-201533907] IAS노선 SMP/ RFA# Key 추가
2015.02.09 박은주 [CHM-201534243] SMP RFA amend 건
                           PRI와 비교하는 기준이 상이하여 유효한 계약임에도 불구하고 유효하지 않은것으로 처리하고 있음
2015.12.29 이혜민 선반영 SMP 저장로직 변경 및 입력 날짜 기준 +30일(한달) 내 effective date를 보유한 RFA/SC시 import 가능토록 변경]]></desc>
			<sql><![CDATA[
SELECT SUM(CNT)
  FROM (
          SELECT COUNT(1) AS CNT
            FROM PRI_RP_HDR   HDR
               , PRI_RP_MN    MN
               , MDM_CUSTOMER I
           WHERE HDR.PROP_NO         = MN.PROP_NO
             AND MN.PROP_STS_CD      = 'A'
#if (${trade} == 'AES')
             AND MN.RFA_CTRT_TP_CD   = 'C' -- AES 에서는 Contract 화주만 IAS는 상관없이 모든 화주에 대해서
#end
             AND I.CUST_CNT_CD       = MN.CTRT_CUST_CNT_CD
             AND I.CUST_SEQ          = MN.CTRT_CUST_SEQ
             AND I.DELT_FLG          = 'N'
             AND MN.CTRT_CUST_CNT_CD = SUBSTR(@[cust_cd], 1, 2)
             AND MN.CTRT_CUST_SEQ    = SUBSTR(@[cust_cd], 3)
             AND HDR.RFA_NO         IN (@[rfa_no], @[sc_no])
             AND MN.AMDT_SEQ         = ( SELECT MAX(AMDT_SEQ)
                                           FROM PRI_RP_MN K
                                          WHERE K.PROP_NO     = MN.PROP_NO
                                            AND K.PROP_STS_CD = 'A'
                                            AND (TRUNC(SYSDATE) BETWEEN K.EFF_DT AND K.EXP_DT OR TRUNC(SYSDATE+30) BETWEEN K.EFF_DT AND K.EXP_DT))
          UNION ALL
          SELECT COUNT(1) AS CNT
            FROM PRI_SP_MN       M
               , PRI_SP_CTRT_PTY D
               , PRI_SP_HDR      H
               , MDM_CUSTOMER    I
           WHERE M.PROP_STS_CD        = 'F'
             AND M.PROP_NO            = D.PROP_NO
             AND M.AMDT_SEQ           = D.AMDT_SEQ
             AND H.PROP_NO            = D.PROP_NO
             AND I.CUST_CNT_CD        = D.CUST_CNT_CD
             AND I.CUST_SEQ           = D.CUST_SEQ
             AND D.CUST_CNT_CD        = SUBSTR(@[cust_cd], 1, 2)
             AND D.CUST_SEQ           = SUBSTR(@[cust_cd], 3)
             AND H.SC_NO             IN (@[rfa_no], @[sc_no])
             AND I.DELT_FLG           = 'N'
             AND D.PRC_CTRT_PTY_TP_CD = 'C'
             AND M.AMDT_SEQ           = ( SELECT MAX(AMDT_SEQ)
                                            FROM PRI_SP_MN K
                                           WHERE K.PROP_NO     = M.PROP_NO
                                             AND K.PROP_STS_CD = 'F'
                                             AND (TRUNC(SYSDATE) BETWEEN K.EFF_DT AND K.EXP_DT OR TRUNC(SYSDATE+30) BETWEEN K.EFF_DT AND K.EXP_DT))
       )			]]></sql>
			<params>
				<param name="cust_cd" type="12" value="" out="N"/>
				<param name="rfa_no" type="12" value="" out="N"/>
				<param name="sc_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
