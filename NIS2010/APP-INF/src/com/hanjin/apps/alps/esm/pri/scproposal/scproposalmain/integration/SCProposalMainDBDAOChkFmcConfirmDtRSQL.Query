<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="SCProposalMainDBDAOChkFmcConfirmDtRSQL">
			<desc><![CDATA[* 2014.06.02 전윤주 [CHM-201430580] s/c 자동 filing 기능 추가
* 2014.07.25 송호진 [CHM-201430558] Filed Cancel 로 인해 Approval 이 된 시점에서는 
                                                        별도의 추가 Confirm No 발생된 Send or C/T 없이 
                                                        기존의 경우가 있으면 Save Button Enable 되도록 로직 보완
]]></desc>
			<sql><![CDATA[
WITH PROGRESS AS (

SELECT  A.PROP_NO, A.AMDT_SEQ, A.PROP_PROG_SEQ, A.PROP_STS_CD, A.PROG_DT, LAG ( A.PROP_STS_CD, 1 ) OVER ( PARTITION BY PROP_NO, AMDT_SEQ ORDER BY PROP_PROG_SEQ ) AS PRE_STS_CD
FROM    PRI_SP_PROG A
WHERE   A.PROP_NO  = @[prop_no]
AND     A.AMDT_SEQ = @[amdt_seq]

), MAX_APRO_PROG AS (

SELECT  B.PROP_NO, B.AMDT_SEQ, B.PROP_PROG_SEQ, B.PROP_STS_CD, B.PROG_DT, B.PRE_STS_CD
FROM    PROGRESS B
WHERE   B.PROP_PROG_SEQ = ( SELECT MAX ( PROP_PROG_SEQ ) FROM PRI_SP_PROG X WHERE X.PROP_NO = B.PROP_NO AND X.AMDT_SEQ = B.AMDT_SEQ AND X.PROP_STS_CD = 'A' )
)

SELECT  NVL ( SUM ( CASE WHEN A1.PRE_STS_CD = 'Q' THEN DECODE ( SIGN ( A2.FILE_PROG_DT - A1.PROG_DT ), 1, 1, 0 )
                   WHEN A1.PRE_STS_CD <> 'Q' THEN DECODE ( A2.FILE_PROG_DT, NULL, 0, 1 ) 
                   END 
            ), 0  ) ETC1
FROM    PRI_SP_FILE_PROG A2
    ,   MAX_APRO_PROG A1
WHERE   A1.PROP_NO = A2.PROP_NO
AND     A1.AMDT_SEQ = A2.AMDT_SEQ			]]></sql>
			<params>
				<param name="prop_no" type="12" value="" out="N"/>
				<param name="amdt_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
