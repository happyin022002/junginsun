<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="GeneralBookingReceiptDBDAOModifyBkgRouteForVslSkdCngUSQL">
			<desc><![CDATA[PORT]]></desc>
			<sql><![CDATA[
UPDATE BKG_BOOKING
   SET POR_NOD_CD       = CASE WHEN RCV_TERM_CD <> 'D' AND POR_NOD_CD = POL_NOD_CD 
										THEN DECODE(POL_CD, @[port_cd], @[new_yd_cd], POL_NOD_CD)
							   ELSE POR_NOD_CD END
	 , POL_NOD_CD		= DECODE(POL_CD, @[port_cd], @[new_yd_cd], POL_NOD_CD)
  	 , POD_NOD_CD 		= DECODE(POD_CD, @[port_cd], @[new_yd_cd], POD_NOD_CD)	
	 , DEL_NOD_CD		= CASE WHEN DE_TERM_CD <> 'D' AND DEL_NOD_CD = POD_NOD_CD
										THEN DECODE(POD_CD, @[port_cd], @[new_yd_cd], POD_NOD_CD)
							   ELSE DEL_NOD_CD END
     , upd_usr_id 		= @[upd_usr_id]
     , upd_dt 			= SYSDATE
 WHERE BKG_NO IN
		(SELECT V.BKG_NO
		   FROM BKG_BOOKING B
              , BKG_VVD V
		  WHERE B.BKG_NO     = V.BKG_NO
		    AND V.VSL_CD     = substr(@[vvd], 1, 4)
		    AND V.SKD_VOY_NO = substr(@[vvd], 5, 4)
			AND V.SKD_DIR_CD = substr(@[vvd], 9, 1)
			AND ((V.POL_CD     = @[port_cd]
				  AND NVL(V.POL_CLPT_IND_SEQ, 1) = @[old_clpt_ind_seq])
				OR 
 				 (V.POD_CD     = @[port_cd]
				  AND NVL(V.POD_CLPT_IND_SEQ, 1) = @[old_clpt_ind_seq])
				)
            AND NOT EXISTS (SELECT 1 
                              FROM BKG_HRD_CDG_CTNT
                             WHERE HRD_CDG_ID = 'VSK_YD_CHG_EXPT'
                               AND NVL(ATTR_CTNT1,B.POL_CD)  = B.POL_CD
                               AND NVL(ATTR_CTNT2,B.POD_CD)  = B.POD_CD
                               AND NVL(ATTR_CTNT3,V.POL_CD)  = V.POL_CD
                               AND NVL(ATTR_CTNT4,V.POD_CD)  = V.POD_CD )
		)
   AND (   (POL_CD     = @[port_cd]
            AND POL_NOD_CD  = @[old_yd_cd] )
        OR (POD_CD     = @[port_cd]
            AND POD_NOD_CD  = @[old_yd_cd] )
       )			]]></sql>
			<params>
				<param name="port_cd" type="12" value="" out="N"/>
				<param name="new_yd_cd" type="12" value="" out="N"/>
				<param name="upd_usr_id" type="12" value="" out="N"/>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="old_clpt_ind_seq" type="12" value="" out="N"/>
				<param name="old_yd_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
