<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="SCProposalMainDBDAORsltHisAmdVORSQL">
			<desc><![CDATA[SCProposalMainDBDAO
2012.02.23 이석준[CHM-201216153-01] S/C Amendment History 화면 기능 개선 요청]]></desc>
			<sql><![CDATA[
#if (${conv_flg} == '0')       
        SELECT   PROP_SCP_TERM_TP_CD
        #if (${term_type_cd} != '')
        #if (${term_type_cd} == '03')
        		,DECODE('04',PROP_SCP_TERM_TP_CD, MAX (AMDT_FLG) ,'0') AMDT_FLG
        #elseif (${term_type_cd} == '04')
        		,DECODE('07',PROP_SCP_TERM_TP_CD, MAX (AMDT_FLG) ,'0') AMDT_FLG
        #elseif (${term_type_cd} == '11')
        		,DECODE('41',PROP_SCP_TERM_TP_CD, MAX (AMDT_FLG) ,'0') AMDT_FLG
        #elseif (${term_type_cd} == '12')
        		,DECODE('13',PROP_SCP_TERM_TP_CD, MAX (AMDT_FLG) ,'0') AMDT_FLG
        #elseif (${term_type_cd} == '13')
        		,DECODE('14',PROP_SCP_TERM_TP_CD, MAX (AMDT_FLG) ,'0') AMDT_FLG
        #elseif (${term_type_cd} == '14')
        		,DECODE('51',PROP_SCP_TERM_TP_CD, MAX (AMDT_FLG) ,'0') AMDT_FLG
        #elseif (${term_type_cd} == '15')
        		,DECODE('71',PROP_SCP_TERM_TP_CD, MAX (AMDT_FLG) ,'0') AMDT_FLG
        #elseif (${term_type_cd} == '16')
        		,DECODE('32',PROP_SCP_TERM_TP_CD, MAX (AMDT_FLG) ,'0') AMDT_FLG
        #elseif (${term_type_cd} == '17')
        		,DECODE('15',PROP_SCP_TERM_TP_CD, MAX (AMDT_FLG) ,'0') AMDT_FLG 
        #elseif (${term_type_cd} == '18')
        		,DECODE('61',PROP_SCP_TERM_TP_CD, MAX (AMDT_FLG) ,'0') AMDT_FLG
        #elseif (${term_type_cd} == '19')
        		,DECODE('16',PROP_SCP_TERM_TP_CD, MAX (AMDT_FLG) ,'0') AMDT_FLG
        #else
        		,DECODE(@[term_type_cd],PROP_SCP_TERM_TP_CD, MAX (AMDT_FLG) ,'0') AMDT_FLG
        #end
        #else
                ,MAX (AMDT_FLG)  AMDT_FLG
        #end
        		,DAT_FLG
        FROM     (SELECT DECODE(PROP_TERM_TP_CD,'03','02',PROP_TERM_TP_CD ) PROP_SCP_TERM_TP_CD
        #if (${svc_scp_cd} == '')
                        ,DECODE (AMDT_FLG, 'Y', 1, 0) AMDT_FLG
        #else
        				,0 AMDT_FLG
        #end
        				, 0 DAT_FLG
                  FROM   PRI_SP_AMDT_SMRY
                  WHERE  PROP_NO = @[prop_no]
                  AND    AMDT_SEQ = @[amdt_seq]
                  UNION ALL
                  SELECT CASE PROP_SCP_TERM_TP_CD
                            WHEN '11'
                               THEN '01'
                            WHEN '12'
                               THEN '02'
                            WHEN '42'
                               THEN '41'
                            WHEN '52'
                               THEN '51'
                            WHEN '62'
                               THEN '61'
                            WHEN '72'
                               THEN '71'
                            ELSE PROP_SCP_TERM_TP_CD
                         END
        #if (${svc_scp_cd} == '')
        				,0 
        #else
                        ,DECODE (AMDT_FLG, 'Y', 1, 0)
        #end
        				,DECODE (PROP_SCP_TERM_TP_CD ,'32',
                				(SELECT  COUNT(*) FROM    PRI_SP_SCP_NOTE  
        						 WHERE   PROP_NO = A.PROP_NO
        					     AND     AMDT_SEQ   = A.AMDT_SEQ
        				         AND     SVC_SCP_CD = A.SVC_SCP_CD
        				         AND     NOTE_TP_CD = 'P'
        				         AND     ROWNUM = 1)
        						 , 0) 
                  FROM   PRI_SP_SCP_AMDT_SMRY A
                  WHERE  PROP_NO = @[prop_no]
                  AND    AMDT_SEQ = @[amdt_seq]
        #if (${svc_scp_cd} != '')
                  AND    SVC_SCP_CD = @[svc_scp_cd]
        #end
                  AND    PROP_SCP_TERM_TP_CD NOT IN ('31'))
        GROUP BY PROP_SCP_TERM_TP_CD,DAT_FLG
#else
SELECT PROP_SCP_TERM_TP_CD,
       DECODE(DAT_FLG,1,DAT_FLG,0,AMDT_FLG) AMDT_FLG,DAT_FLG
       --1 AMDT_FLG,1 DAT_FLG
 FROM (
                  SELECT CASE A.PROP_SCP_TERM_TP_CD
                              WHEN '72'
                                 THEN '71'          
                              WHEN '62'
                                 THEN '61'
                              WHEN '52'
                                 THEN '51'
                              WHEN '42'
                                     THEN '41'
                              ELSE A.PROP_SCP_TERM_TP_CD
                           END PROP_SCP_TERM_TP_CD
#if (${svc_scp_cd} != '')
                          , DECODE(AMDT_FLG,'N',0,'Y',1) AMDT_FLG
#else
                            ,0 AMDT_FLG
#end
                          ,DECODE(DAT_CNT,'N',0,'Y',1) AS DAT_FLG
                    FROM   PRI_SP_SCP_AMDT_SMRY A
                          , (SELECT '13' PROP_SCP_TERM_TP_CD
                                   ,DECODE (COUNT (1), 0, 'N', 'Y') DAT_CNT
                             FROM   PRI_SP_SCP_GRP_LOC_DTL
                             WHERE  PROP_NO = @[prop_no]
                             AND    AMDT_SEQ = @[amdt_seq]
                             AND    SVC_SCP_CD = @[svc_scp_cd]
                             UNION ALL
                             SELECT '14' PROP_SCP_TERM_TP_CD
                                   ,DECODE (COUNT (1), 0, 'N', 'Y') DAT_CNT
                             FROM   PRI_SP_SCP_GRP_CMDT_DTL
                             WHERE  PROP_NO = @[prop_no]
                             AND    AMDT_SEQ = @[amdt_seq]
                             AND    SVC_SCP_CD = @[svc_scp_cd]
                             UNION ALL
                             SELECT '15' PROP_SCP_TERM_TP_CD
                                   ,DECODE (COUNT (1), 0, 'N', 'Y') DAT_CNT
                             FROM   PRI_SP_SCP_LODG_AGN
                             WHERE  PROP_NO = @[prop_no]
                             AND    AMDT_SEQ = @[amdt_seq]
                             AND    SVC_SCP_CD = @[svc_scp_cd]
                             UNION ALL
                                 SELECT  '16' prop_scp_term_tp_cd, DECODE(count(1),0,'N','Y') dat_cnt
                                 FROM    pri_sp_scp_goh_chg
                                 WHERE   prop_no = @[prop_no]
                                 AND     amdt_seq= @[amdt_seq]
                                 AND     svc_scp_cd = @[svc_scp_cd]
                             UNION ALL   
                             SELECT '31' PROP_SCP_TERM_TP_CD
                                   ,DECODE (COUNT (1), 0, 'N', 'Y') DAT_CNT
                             FROM   PRI_SP_SCP_NOTE
                             WHERE  PROP_NO = @[prop_no]
                             AND    AMDT_SEQ = @[amdt_seq]
                             AND    SVC_SCP_CD = @[svc_scp_cd]
                             AND    NOTE_TP_CD = 'T'
                             UNION ALL                                                       
                             SELECT '32' PROP_SCP_TERM_TP_CD
                                   ,DECODE (COUNT (1), 0, 'N', 'Y') DAT_CNT
                             FROM   PRI_SP_SCP_NOTE
                             WHERE  PROP_NO = @[prop_no]
                             AND    AMDT_SEQ = @[amdt_seq]
                             AND    SVC_SCP_CD = @[svc_scp_cd]
                             AND    NOTE_TP_CD = 'P'
                             UNION ALL
                             SELECT  '41' prop_scp_term_tp_cd, DECODE(count(1),0,'N','Y') dat_cnt
                                FROM    pri_sp_scp_rout_pnt
                               WHERE   prop_no = @[prop_no]
                                 AND     amdt_seq= @[amdt_seq]
                                 AND     svc_scp_cd = @[svc_scp_cd]
                                  AND     org_dest_tp_cd = 'O'
                                  UNION ALL
                                  SELECT  '42' prop_scp_term_tp_cd, DECODE(count(1),0,'N','Y') dat_cnt
                                  FROM    pri_sp_scp_rout_pnt
                                  WHERE   prop_no = @[prop_no]
                                  AND     amdt_seq= @[amdt_seq]
                                  AND     svc_scp_cd = @[svc_scp_cd]
                                  AND     org_dest_tp_cd = 'D'
                                  UNION ALL
                             SELECT '51' PROP_SCP_TERM_TP_CD
                                   ,DECODE (COUNT (1), 0, 'N', 'Y') DAT_CNT
                             FROM   PRI_SP_SCP_TRSP_ADD_CHG
                             WHERE  PROP_NO = @[prop_no]
                             AND    AMDT_SEQ = @[amdt_seq]
                             AND    SVC_SCP_CD = @[svc_scp_cd]
                             AND    ADD_CHG_TP_CD = 'A'
                             AND    ORG_DEST_TP_CD = 'O'
                             UNION ALL
                             SELECT '52' PROP_SCP_TERM_TP_CD
                                   ,DECODE (COUNT (1), 0, 'N', 'Y') DAT_CNT
                             FROM   PRI_SP_SCP_TRSP_ADD_CHG
                             WHERE  PROP_NO = @[prop_no]
                             AND    AMDT_SEQ = @[amdt_seq]
                             AND    SVC_SCP_CD = @[svc_scp_cd]
                             AND    ADD_CHG_TP_CD = 'A'
                             AND    ORG_DEST_TP_CD = 'D'
                             UNION ALL
                             SELECT '61' PROP_SCP_TERM_TP_CD
                                   ,DECODE (COUNT (1), 0, 'N', 'Y') DAT_CNT
                             FROM   PRI_SP_SCP_TRSP_ADD_CHG
                             WHERE  PROP_NO = @[prop_no]
                             AND    AMDT_SEQ = @[amdt_seq]
                             AND    SVC_SCP_CD = @[svc_scp_cd]
                             AND    ADD_CHG_TP_CD = 'I'
                             AND    ORG_DEST_TP_CD = 'O'
                             UNION ALL
                             SELECT '62' PROP_SCP_TERM_TP_CD
                                   ,DECODE (COUNT (1), 0, 'N', 'Y') DAT_CNT
                             FROM   PRI_SP_SCP_TRSP_ADD_CHG
                             WHERE  PROP_NO = @[prop_no]
                             AND    AMDT_SEQ = @[amdt_seq]
                             AND    SVC_SCP_CD = @[svc_scp_cd]
                             AND    ADD_CHG_TP_CD = 'I'
                             AND    ORG_DEST_TP_CD = 'D'
                             UNION ALL                             
                             SELECT '71' PROP_SCP_TERM_TP_CD
                                   ,DECODE (COUNT (1), 0, 'N', 'Y') DAT_CNT
                             FROM   PRI_SP_SCP_RT_CMDT_HDR
                             WHERE  PROP_NO = @[prop_no]
                             AND    AMDT_SEQ = @[amdt_seq]
                             AND    SVC_SCP_CD = @[svc_scp_cd]  
                             AND    GEN_SPCL_RT_TP_CD = 'G'                           
                             UNION ALL                             
                             SELECT '72' PROP_SCP_TERM_TP_CD
                                   ,DECODE (COUNT (1), 0, 'N', 'Y') DAT_CNT
                             FROM   PRI_SP_SCP_RT_CMDT_HDR
                             WHERE  PROP_NO = @[prop_no]
                             AND    AMDT_SEQ = @[amdt_seq]
                             AND    SVC_SCP_CD = @[svc_scp_cd]
                             AND    GEN_SPCL_RT_TP_CD = 'S'  ) B
                    WHERE  PROP_NO = @[prop_no]
                    AND    AMDT_SEQ = @[amdt_seq]
                    AND    SVC_SCP_CD = @[svc_scp_cd]
                    AND    A.PROP_SCP_TERM_TP_CD = B.PROP_SCP_TERM_TP_CD
                    UNION ALL

                        SELECT DECODE(A.PROP_SCP_TERM_TP_CD,'11','01','02') TP_CD
#if (${svc_scp_cd} != '')
                          ,DECODE(MAX(AMDT_FLG),'N',0,'Y',1) AMDT_FLG
#else
                                  ,0 AMDT_FLG
#end
                          ,DECODE(MAX(DAT_CNT),'N',0,'Y',1) DAT_CNT
                    FROM   PRI_SP_SCP_AMDT_SMRY A
                          , (SELECT '11' PROP_SCP_TERM_TP_CD
                                   ,DECODE (COUNT (1), 0, 'N', 'Y') DAT_CNT
                                                                                        ,SVC_SCP_CD
                             FROM   PRI_SP_SCP_DUR
                             WHERE  PROP_NO = @[prop_no]
                             AND    AMDT_SEQ = @[amdt_seq]
                                                                          GROUP BY SVC_SCP_CD
                                                                          UNION ALL
                             SELECT '12' PROP_SCP_TERM_TP_CD
                                   ,DECODE (COUNT (1), 0, 'N', 'Y') DAT_CNT
                                                                                        ,SVC_SCP_CD
                             FROM   PRI_SP_SCP_MQC
                             WHERE  PROP_NO = @[prop_no]
                             AND    AMDT_SEQ = @[amdt_seq]
                                                                          GROUP BY SVC_SCP_CD

                                                                          ) B
                    WHERE  PROP_NO = @[prop_no]
                    AND    AMDT_SEQ = @[amdt_seq]
                                                     AND    A.SVC_SCP_CD = B.SVC_SCP_CD
                    AND    A.PROP_SCP_TERM_TP_CD = B.PROP_SCP_TERM_TP_CD      
                                                     GROUP BY A.PROP_SCP_TERM_TP_CD
                     UNION ALL
                    SELECT TP_CD,
#if (${svc_scp_cd} == '')

                           DECODE(MAX(AMDT_FLG),'N',0,'Y',1) AMND_FLG,
#else
                           0 AMDT_FLG,
#end
                           DECODE(MAX(DAT_CNT),'N',0,'Y',1) DAT_CNT
                    FROM(                    
                    
                        SELECT CASE C.PROP_TERM_TP_CD
                                                 WHEN '03' THEN '02'
                                                 ELSE    C.PROP_TERM_TP_CD
                                                 END TP_CD
                              ,AMDT_FLG
                              ,ACPT_FLG
                              ,DAT_CNT
                        FROM   PRI_SP_AMDT_SMRY C
                              , (SELECT '01' PROP_TERM_TP_CD
                                       ,DECODE (COUNT (1), 0, 'N', 'Y') DAT_CNT
                                 FROM   PRI_SP_DUR
                                 WHERE  PROP_NO = @[prop_no]
                                 AND    AMDT_SEQ = @[amdt_seq]
                                 UNION ALL
                                 SELECT '02' PROP_TERM_TP_CD
                                       ,DECODE (COUNT (1), 0, 'N', 'Y') DAT_CNT
                                 FROM   PRI_SP_MQC
                                 WHERE  PROP_NO = @[prop_no]
                                 AND    AMDT_SEQ = @[amdt_seq]
                                 UNION ALL
                                 SELECT '03' PROP_TERM_TP_CD
                                       ,DECODE (COUNT (1), 0, 'N', 'Y') DAT_CNT
                                 FROM   PRI_SP_SUB_MQC
                                 WHERE  PROP_NO = @[prop_no]
                                 AND    AMDT_SEQ = @[amdt_seq]  
                                 UNION ALL
                                 SELECT '04' PROP_TERM_TP_CD
                                       ,DECODE (COUNT (1), 0, 'N', 'Y') DAT_CNT
                                 FROM   PRI_SP_CTRT_PTY 
                                 WHERE  PROP_NO = @[prop_no]
                                 AND    AMDT_SEQ = @[amdt_seq]                                                        
                                 UNION ALL
                                 SELECT '05' PROP_TERM_TP_CD
                                       ,DECODE (COUNT (1), 0, 'N', 'Y') DAT_CNT
                                 FROM   PRI_SP_AFIL
                                 WHERE  PROP_NO = @[prop_no]
                                 AND    AMDT_SEQ = @[amdt_seq]
                                 UNION ALL
                                 SELECT '06' PROP_TERM_TP_CD
                                       ,DECODE (COUNT (1), 0, 'N', 'Y') DAT_CNT
                                 FROM   PRI_SP_BLPL
                                 WHERE  PROP_NO = @[prop_no]
                                 AND    AMDT_SEQ = @[amdt_seq]                             
                                 UNION ALL
                                 SELECT '07' PROP_TERM_TP_CD
                                       ,DECODE (COUNT (1), 0, 'N', 'Y') DAT_CNT
                                 FROM   PRI_SP_CTRT_CUST_TP
                                 WHERE  PROP_NO = @[prop_no]
                                 AND    AMDT_SEQ = @[amdt_seq]
                                                                         ) D
                        WHERE  PROP_NO = @[prop_no]
                        AND    AMDT_SEQ = @[amdt_seq]
                        AND    C.PROP_TERM_TP_CD = D.PROP_TERM_TP_CD
                        ) GROUP BY TP_CD
)

#end			]]></sql>
			<params>
				<param name="term_type_cd" type="12" value="" out="N"/>
				<param name="prop_no" type="12" value="" out="N"/>
				<param name="amdt_seq" type="12" value="" out="N"/>
				<param name="svc_scp_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
