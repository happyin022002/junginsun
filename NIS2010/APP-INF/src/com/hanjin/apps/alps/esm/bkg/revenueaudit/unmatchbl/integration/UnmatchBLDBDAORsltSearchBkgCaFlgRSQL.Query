<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="UnmatchBLDBDAORsltSearchBkgCaFlgRSQL">
			<desc><![CDATA[bl no 로 bkg_no, caFlg , ctrt_tp_cd 조회]]></desc>
			<sql><![CDATA[
SELECT  BKG.BL_NO  ,
        BKG.BKG_NO ,
        BKG.SVC_SCP_CD ,
        NVL(CALC_CTRT_TP_CD,BKG_CTRT_TP_CD) CTRT_TP_CD  ,
        'N' CA_FLG     ,
         (SELECT ATTR_CTNT1 
          FROM BKG_HRD_CDG_CTNT 
          WHERE HRD_CDG_ID = 'SC_AUTORATING_TYPE' 
          AND ATTR_CTNT2 = BKG.SVC_SCP_CD) SC_RT_TP,
         (SELECT CASE WHEN SUBSTR(BKG.POR_CD,1,2) IN ('US','CA') OR SUBSTR(BKG.DEL_CD,1,2) IN ('US','CA') THEN 'N'
                      WHEN RT.RT_APLY_DT >= TO_DATE(ATTR_CTNT2,'YYYYMMDD') 
                           AND RT.RT_APLY_DT <= TO_DATE(ATTR_CTNT3,'YYYYMMDD')
                           AND (SELECT D.CTRT_EFF_DT 
                                FROM PRI_RP_HDR H, PRI_RP_DUR D
                                WHERE H.RFA_NO = BKG.RFA_NO
                                AND H.PROP_NO = D.PROP_NO
                                AND RT.RT_APLY_DT BETWEEN D.CTRT_EFF_DT AND D.CTRT_EXP_DT
                                AND ROWNUM = 1) < TO_DATE(ATTR_CTNT2,'YYYYMMDD') THEN 'Y'
                      WHEN RT.RT_APLY_DT >=  TO_DATE(ATTR_CTNT2,'YYYYMMDD') THEN 'FIC'
                      WHEN RT.RT_APLY_DT BETWEEN TO_DATE(ATTR_CTNT1,'YYYYMMDD') AND TO_DATE(ATTR_CTNT2,'YYYYMMDD') THEN 'Y'
                      ELSE 'N'
                 END HINTER_FLG
          FROM BKG_HRD_CDG_CTNT H
          WHERE HRD_CDG_ID = 'HINTERLAND_APLY_FLG') HINTER_FLG ,
 		 RT.FRT_TERM_CD
 FROM    BKG_BOOKING BKG
        ,BKG_RATE RT
 WHERE   (BKG.BL_NO = @[bl_no] OR BKG.BKG_NO = @[bl_no])
   AND   BKG.BKG_NO = RT.BKG_NO
   AND   'N' = @[ca_flg]

 UNION ALL
 SELECT  BKG.BL_NO  ,
         BKG.BKG_NO ,
         BKG.SVC_SCP_CD ,
         NVL(CALC_CTRT_TP_CD,BKG_CTRT_TP_CD),
         'Y' CA_FLG,
         (SELECT ATTR_CTNT1 
          FROM BKG_HRD_CDG_CTNT 
          WHERE HRD_CDG_ID = 'SC_AUTORATING_TYPE' 
          AND ATTR_CTNT2 = SVC_SCP_CD) SC_RT_TP ,
         (SELECT CASE WHEN SUBSTR(BKG.POR_CD,1,2) IN ('US','CA') OR SUBSTR(BKG.DEL_CD,1,2) IN ('US','CA') THEN 'N'
                      WHEN RT.RT_APLY_DT >= TO_DATE(ATTR_CTNT2,'YYYYMMDD') 
                           AND RT.RT_APLY_DT <= TO_DATE(ATTR_CTNT3,'YYYYMMDD')
                           AND (SELECT D.CTRT_EFF_DT 
                                FROM PRI_RP_HDR H, PRI_RP_DUR D
                                WHERE H.RFA_NO = BKG.RFA_NO
                                AND H.PROP_NO = D.PROP_NO
                                AND RT.RT_APLY_DT BETWEEN D.CTRT_EFF_DT AND D.CTRT_EXP_DT
                                AND ROWNUM = 1) < TO_DATE(ATTR_CTNT2,'YYYYMMDD') THEN 'Y'
                      WHEN RT.RT_APLY_DT >=  TO_DATE(ATTR_CTNT2,'YYYYMMDD') THEN 'FIC'
                      WHEN RT.RT_APLY_DT BETWEEN TO_DATE(ATTR_CTNT1,'YYYYMMDD') AND TO_DATE(ATTR_CTNT2,'YYYYMMDD') THEN 'Y'
                      ELSE 'N'
                 END HINTER_FLG
          FROM BKG_HRD_CDG_CTNT H
          WHERE HRD_CDG_ID = 'HINTERLAND_APLY_FLG')HINTER_FLG ,
		 RT.FRT_TERM_CD
 FROM    BKG_BKG_HIS BKG
        ,BKG_RATE RT
 WHERE   (BKG.BL_NO = @[bl_no] OR BKG.BKG_NO = @[bl_no])
 AND     BKG.BKG_NO = RT.BKG_NO
 AND     CORR_NO = 'TMP0000001'  -- CORRECTION 중인 DATA 를 나타내는 고정된 상수값
 AND     'Y' = @[ca_flg]			]]></sql>
			<params>
				<param name="bl_no" type="12" value="" out="N"/>
				<param name="ca_flg" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
