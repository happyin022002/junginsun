<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CndCustomsTransmissionDBDAOsearchCndCstmsExportManifestRSQL">
			<desc><![CDATA[Canada Export 조회]]></desc>
			<sql><![CDATA[
SELECT  VVD.VSL_CD || VVD.SKD_VOY_NO || VVD.SKD_DIR_CD AS VVD_CD
       ,VVD.VSL_CD
       ,VVD.SKD_VOY_NO
       ,VVD.SKD_DIR_CD
       ,VVD.POL_CD AS POL_CD
       ,VVD.POD_CD AS POD_CD
       ,VVD.POR_CD
       ,VVD.DEL_CD
       ,VVD.BKG_NO
       ,VVD.BL_NO
       ,TO_CHAR(SKD.VPS_ETD_DT,'YYYY-MM-DD HH24:MI:SS') AS ETD_DT
       ,TO_CHAR(ACT_SKD.ACT_DEP_DT, 'YYYY-MM-DD HH24:MI:SS') ACT_DEP_DT       
       ,DECODE(SUBSTR(VVD.POD_CD, 1,2), 'CA', 'N', 'Y') AS FROB_FLG
       --,TO_CHAR(Z2.VPS_ETB_DT + 1/24,'YYYY-MM-DD HH24:MI:SS') AS ETL_DT
       /*,(CASE WHEN BDR.TRNK_MNL_BDR_FLG = 'Y' THEN 'Y'
              WHEN BDR.TRNK_AUTO_BDR_FLG = 'Y' THEN 'Y'
              WHEN BDR.TRNK_BDR_FLG = 'Y' THEN 'Y'
          ELSE 'N' END) AS BDR_FLG*/
       , NVL((
          SELECT 'Y'
          FROM BKG_VVD_BDR_LOG BDR
          WHERE VVD.VSL_CD       = BDR.VSL_CD
           AND VVD.SKD_VOY_NO   = BDR.SKD_VOY_NO
           AND VVD.SKD_DIR_CD   = BDR.SKD_DIR_CD
           AND VVD.POL_CD       = BDR.POL_CD
           AND VVD.POD_CD       = BDR.POD_CD
           AND (BDR.TRNK_MNL_BDR_FLG = 'Y' OR BDR.TRNK_AUTO_BDR_FLG = 'Y' OR BDR.TRNK_BDR_FLG = 'Y' ) 
           AND ROWNUM =1
         ) ,'N') BDR_FLG
       ,CASE WHEN VVD.BKG_CGO_TP_CD = 'P' THEN 'E10'
 	         WHEN VVD.MF_NO > ' ' THEN 'S10'
	         ELSE 'A6A' END CSTMS_MF_TP_CD
       ,FILER
       ,EMP_FLG
       ,TO_CHAR(SND.SND_DT,'YYYY-MM-DD HH24:MI:SS') AS MF_SND_DT
FROM (
        SELECT  BKG.BL_NO
               ,BKG.BL_NO AS BL_NOS
               ,'' AS MF_NO
               ,'' AS CNTR_MF_NO
               ,BKG.CND_CSTMS_FILE_CD AS FILER
               ,BKG.BKG_CGO_TP_CD
               ,DECODE(BKG.BKG_CGO_TP_CD,'P','Y','N') AS EMP_FLG
               ,BKG.BKG_NO
               ,VVD.VSL_CD
               ,VVD.SKD_VOY_NO
               ,VVD.SKD_DIR_CD
               ,VVD.POL_CD
               ,VVD.POD_CD
               ,BKG.POR_CD
               ,BKG.DEL_CD               
               ,DOC.BDR_FLG
               ,(SELECT MAX(CORR_NO) FROM BKG_CORRECTION WHERE BKG_NO = BKG.BKG_NO) AS CA_NO
               ,BKG.BKG_STS_CD
               ,'M' BL_TYPE
               ,BKG.POD_CD AS BKG_POD_CD
               ,BKG.DEL_CD AS BKG_DEL_CD
          FROM  BKG_VVD VVD
               ,BKG_BOOKING BKG
               ,BKG_BL_DOC DOC
         WHERE  1=1
           #if (${vvd_cd} != '') 
           AND  VVD.VSL_CD       = SUBSTR(@[vvd_cd],1, 4)
           AND  VVD.SKD_VOY_NO   = SUBSTR(@[vvd_cd],5, 4)
           AND  VVD.SKD_DIR_CD   = SUBSTR(@[vvd_cd],9, 1)
           #end
           #if (${pol_cd} != '') 
           AND  VVD.POL_CD = @[pol_cd]
           #end
           #if (${pod_cd} != '') 
           AND  VVD.POD_CD = @[pod_cd]
           #end
           #if (${lane} != '') 
           AND VVD.SLAN_CD = @[lane]
           #end
           AND  VVD.BKG_NO = BKG.BKG_NO
           AND  BKG.BKG_NO = DOC.BKG_NO(+)
           AND  BKG.BKG_STS_CD IN ('F','W')
           AND  BKG.BL_NO IS NOT NULL
        UNION ALL
        SELECT  BKG.BL_NO AS MBL_NO
               ,H.CNTR_MF_NO AS BL_NOS
               ,H.CNTR_MF_NO
               ,BKG.BL_NO AS MF_NO               
               ,'0' AS FILER
               ,BKG.BKG_CGO_TP_CD
               ,'N' AS EMP_FLG
               ,BKG.BKG_NO
               ,VVD.VSL_CD
               ,VVD.SKD_VOY_NO
               ,VVD.SKD_DIR_CD
               ,VVD.POL_CD
               ,VVD.POD_CD
               ,BKG.POR_CD
               ,BKG.DEL_CD               
               ,DOC.BDR_FLG
               ,'' AS CA_NO
               ,BKG.BKG_STS_CD
               ,'H' BL_TYPE
               ,BKG.POD_CD AS BKG_POD_CD
               ,BKG.DEL_CD AS BKG_DEL_CD
          FROM  BKG_VVD VVD
               ,BKG_BOOKING BKG
               ,BKG_BL_DOC DOC
               ,BKG_HBL H
         WHERE  1=1
           #if (${vvd_cd} != '') 
           AND  VVD.VSL_CD       = SUBSTR(@[vvd_cd],1, 4)
           AND  VVD.SKD_VOY_NO   = SUBSTR(@[vvd_cd],5, 4)
           AND  VVD.SKD_DIR_CD   = SUBSTR(@[vvd_cd],9, 1)
           #end
           #if (${pol_cd} != '') 
           AND  VVD.POL_CD = @[pol_cd]
           #end
           #if (${pod_cd} != '') 
           AND  VVD.POD_CD = @[pod_cd]
           #end
           #if (${lane} != '') 
           AND VVD.SLAN_CD = @[lane]
           #end
           AND  VVD.BKG_NO = BKG.BKG_NO
           AND  BKG.BKG_NO = DOC.BKG_NO(+)
           AND  BKG.BKG_NO = H.BKG_NO
           AND  BKG.BKG_STS_CD IN ('F','W')
           AND  H.CNTR_MF_NO IS NOT NULL
           AND  BKG.CND_CSTMS_FILE_CD = '1'
) VVD
  ,VSK_VSL_PORT_SKD SKD
  ,VSK_ACT_PORT_SKD ACT_SKD
  ,(
      SELECT X1.CNT_CD, X1.CRR_BAT_NO,X1.BL_NO
      FROM BKG_CSTMS_ADV_EDI_BL_RSPN X1
      WHERE X1.CNT_CD  = 'CA'
      AND X1.CRR_BAT_NO = (
                  SELECT MAX(X.CRR_BAT_NO)
                  FROM BKG_CSTMS_ADV_EDI_BL_RSPN X, BKG_CSTMS_ADV_SND_LOG Y
                  WHERE X.CNT_CD  = 'CA'
                  AND X.BL_NO = X1.BL_NO
                  AND X.CNT_CD = X1.CNT_CD  
                  AND X.CNT_CD = Y.CNT_CD                
                  AND X.CRR_BAT_NO = Y.CRR_BAT_NO
		          #if (${vvd_cd} != '') 
                  AND Y.VSL_CD       = SUBSTR(@[vvd_cd],1, 4)
                  AND Y.SKD_VOY_NO   = SUBSTR(@[vvd_cd],5, 4)
                  AND Y.SKD_DIR_CD   = SUBSTR(@[vvd_cd],9, 1)
                  #end
                  )
      )  EDI 
  ,BKG_CSTMS_ADV_SND_LOG SND
WHERE   VVD.VSL_CD = SKD.VSL_CD(+)
   AND  VVD.SKD_VOY_NO = SKD.SKD_VOY_NO(+)
   AND  VVD.SKD_DIR_CD = SKD.SKD_DIR_CD(+)
   AND  VVD.POL_CD = SKD.VPS_PORT_CD(+)
   AND  SKD.CLPT_IND_SEQ(+)	= '1'
   AND  NVL(SKD.SKD_CNG_STS_CD(+),'X') != 'S'

   AND  VVD.VSL_CD = ACT_SKD.VSL_CD(+)
   AND  VVD.SKD_VOY_NO = ACT_SKD.SKD_VOY_NO(+)
   AND  VVD.SKD_DIR_CD = ACT_SKD.SKD_DIR_CD(+)
   AND  VVD.POL_CD = ACT_SKD.VPS_PORT_CD(+)
   AND  ACT_SKD.CLPT_IND_SEQ(+)	= '1'

   AND  VVD.BL_NO =  EDI.BL_NO(+)   
   AND  SND.CNT_CD(+)  = 'CA'   
   AND  EDI.CNT_CD = SND.CNT_CD(+)
   AND  EDI.CRR_BAT_NO = SND.CRR_BAT_NO(+)


   #if (${atd_from_dt} != '' && ${atd_to_dt} != '') 
   AND ACT_SKD.VPS_PORT_CD = @[atd_pod_cd]
   AND ACT_SKD.ACT_DEP_DT BETWEEN TO_DATE(REPLACE(REPLACE(@[atd_from_dt], '-', ''), '/', '') ||' '|| REPLACE(REPLACE(@[atd_from_tm], ':', ''), '-', ''), 'YYYYMMDD HH24MI') AND TO_DATE(REPLACE(REPLACE(@[atd_to_dt], '-', ''), '/', '') ||' '|| REPLACE(REPLACE(@[atd_to_tm], ':', ''), '-', ''), 'YYYYMMDD HH24MI') 
   #end			]]></sql>
			<params>
				<param name="vvd_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="lane" type="12" value="" out="N"/>
				<param name="atd_pod_cd" type="12" value="" out="N"/>
				<param name="atd_from_dt" type="12" value="" out="N"/>
				<param name="atd_from_tm" type="12" value="" out="N"/>
				<param name="atd_to_dt" type="12" value="" out="N"/>
				<param name="atd_to_tm" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
