<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="UnmatchBLDBDAOSearchNonAutoratedChargeForAuditRSQL">
			<desc><![CDATA[심사를 위한 Non Autorated Charge 목록을 조회한다.]]></desc>
			<sql><![CDATA[
WITH BK AS(
SELECT (
        SELECT  A.OFC_CD
        FROM    MDM_ORGANIZATION A
        WHERE   A.OFC_TP_CD = 'HQ'
        START   WITH A.OFC_CD = BK.BKG_OFC_CD
        CONNECT BY PRIOR A.PRNT_OFC_CD = A.OFC_CD
       ) BKG_RHQ_CD,
       BK.BKG_OFC_CD,
       BK.BKG_NO,
       TO_CHAR(BR.RT_APLY_DT, 'YYYY-MM-DD') RT_APLY_DT,
       BD.BDR_FLG,
       BK.CMDT_CD,
       (SELECT CMDT_NM FROM MDM_COMMODITY M WHERE M.CMDT_CD = BK.CMDT_CD) CMDT_NM,
       BK.SVC_SCP_CD,
       BKG_GET_AUTO_RT_HIS_FNC(BK.BKG_NO,1) RT_CNG_HIS,
       BK.POR_CD,
       BK.POL_CD,
       BK.POD_CD,
       BK.DEL_CD,
       (SELECT INTG_CD_VAL_DP_DESC
        FROM COM_INTG_CD_DTL
        WHERE INTG_CD_ID ='CD01716'
        AND INTG_CD_VAL_CTNT = BR.BKG_CTRT_TP_CD) BKG_CTRT_TP_CD ,
       CASE WHEN BR.BKG_CTRT_TP_CD = 'R' THEN BK.RFA_NO
            WHEN BR.BKG_CTRT_TP_CD = 'S' THEN BK.SC_NO
            WHEN BR.BKG_CTRT_TP_CD = 'T' THEN BK.TAA_NO
       END CTRT_NO
FROM BKG_BOOKING BK,
     BKG_RATE BR,
     BKG_BL_DOC BD,
    (SELECT	OFC_CD 
     FROM	MDM_ORGANIZATION A
 #if (${bkg_ofc_cd} != '') 
     WHERE	OFC_CD = @[bkg_ofc_cd]
 #end
     START WITH	A.OFC_CD = @[bkg_rhq_cd]
     CONNECT BY	PRIOR A.OFC_CD	= A.PRNT_OFC_CD  
     ) OG
#if (${search_date} == 'ETD')
    ,(SELECT DISTINCT B.BKG_NO
      FROM BKG_BOOKING B, BKG_VVD BV, VSK_VSL_PORT_SKD V
      WHERE B.BKG_NO = BV.BKG_NO
      AND B.POL_CD = BV.POL_CD
      AND V.VSL_CD = BV.VSL_CD
      AND V.SKD_VOY_NO = BV.SKD_VOY_NO
      AND V.SKD_DIR_CD = BV.SKD_DIR_CD
      AND V.VPS_PORT_CD = BV.POL_CD
      AND V.CLPT_IND_SEQ = BV.POL_CLPT_IND_SEQ
      AND V.VPS_ETD_DT BETWEEN TO_DATE(@[fm_dt],'YYYY-MM-DD') AND TO_DATE(@[to_dt],'YYYY-MM-DD') + 0.99999
      ) V
WHERE BK.BKG_NO = V.BKG_NO
#elseif (${search_date} == 'APPL')
WHERE BR.RT_APLY_DT BETWEEN TO_DATE(@[fm_dt],'YYYY-MM-DD') AND TO_DATE(@[to_dt],'YYYY-MM-DD') + 0.99999
#else
WHERE BK.BKG_CRE_DT BETWEEN TO_DATE(@[fm_dt],'YYYY-MM-DD') AND TO_DATE(@[to_dt],'YYYY-MM-DD') + 0.99999
#end
AND BK.BKG_STS_CD	<> 'X'
AND	BK.BKG_CGO_TP_CD	<> 'P'
AND	BK.BKG_NO		= BR.BKG_NO
AND BK.BKG_NO = BD.BKG_NO
AND BK.BKG_OFC_CD = OG.OFC_CD

 #if (${svc_scp_cd} != '') 
AND BK.SVC_SCP_CD   = @[svc_scp_cd]
 #end
 #if (${cmdt_cd} != '') 
AND BK.CMDT_CD = @[cmdt_cd]
 #end
 #if (${bkg_ctrt_tp_cd} != '') 
AND     CASE
             WHEN    BK.TAA_NO IS NOT NULL THEN  'T'
             WHEN    BK.RFA_NO IS NOT NULL THEN  'R'
             ELSE    'S'
        END                     = @[bkg_ctrt_tp_cd]
 #end

 #if (${ctrt_no} != '') 
AND     CASE
             WHEN    BK.TAA_NO IS NOT NULL THEN  BK.TAA_NO
             WHEN    BK.RFA_NO IS NOT NULL THEN  BK.RFA_NO
             ELSE    BK.SC_NO
        END                     LIKE @[ctrt_no] || '%'
 #end


 #if (${por_cd} != '') 
AND BK.POR_CD   LIKE @[por_cd]||'%'
 #end
 #if (${pol_cd} != '') 
AND BK.POL_CD   LIKE @[pol_cd]||'%'
 #end
 #if (${pod_cd} != '') 
AND BK.POD_CD   LIKE @[pod_cd]||'%'
 #end
 #if (${del_cd} != '') 
AND BK.DEL_CD   LIKE @[del_cd]||'%'
 #end
#if (${bdr_flg} != '') 
AND BD.BDR_FLG   = @[bdr_flg]
#end
),
RT AS
(
SELECT NVL(BKG.BKG_NO, HIS.BKG_NO) BKG_NO,
       BKG.CHG_CD       BKG_CHG_CD, 
       BKG.CURR_CD      BKG_CURR_CD, 
       BKG.CHG_UT_AMT   BKG_CHG_UT_AMT, 
       BKG.RAT_UT_CD    BKG_RAT_UT_CD,
       BKG.RAT_AS_QTY   BKG_RAT_AS_QTY, 
       BKG.CHG_AMT      BKG_CHG_AMT, 
       BKG.AUTO_RAT_CD  BKG_AUTO_RAT_CD,
       HIS.CHG_CD       HIS_CHG_CD, 
       HIS.CURR_CD      HIS_CURR_CD, 
       HIS.CHG_UT_AMT   HIS_CHG_UT_AMT,
       HIS.RAT_UT_CD    HIS_RAT_UT_CD,
       HIS.RAT_AS_QTY   HIS_RAT_AS_QTY,
       HIS.CHG_AMT      HIS_CHG_AMT
FROM (SELECT BK.BKG_NO,
             RT.CHG_CD, RT.CURR_CD, RT.CHG_UT_AMT, RT.RAT_UT_CD, RT.RAT_AS_QTY, RT.CHG_AMT, RT.AUTO_RAT_CD
      FROM BK, BKG_CHG_RT RT
      WHERE BK.BKG_NO = RT.BKG_NO(+)) BKG
      FULL OUTER JOIN
      (SELECT BK.BKG_NO,
             RT.CHG_CD, RT.CURR_CD, RT.CHG_UT_AMT, RT.RAT_UT_CD, RT.RAT_AS_QTY, RT.CHG_AMT
      FROM BK, BKG_AUTO_RT_HIS RT
      WHERE BK.BKG_NO = RT.BKG_NO
      AND CURR_CD IS NOT NULL) HIS
 ON BKG.BKG_NO = HIS.BKG_NO
AND BKG.CHG_CD = HIS.CHG_CD
AND BKG.RAT_UT_CD = HIS.RAT_UT_CD

WHERE 1=1
#if (${auto_rat_cd} == 'X')
 AND BKG.AUTO_RAT_CD IS NULL
#elseif (${auto_rat_cd} != '')  
 AND BKG.AUTO_RAT_CD = @[auto_rat_cd]
#end
#if (${chg_cd} != '')  
 AND BKG.CHG_CD = @[chg_cd]
#end
)
SELECT BK.BKG_RHQ_CD,
       BK.BKG_OFC_CD,
       BK.BKG_NO,
       BK.RT_APLY_DT,
       BK.BDR_FLG,
       BK.CMDT_CD,
       BK.CMDT_NM,
       BK.SVC_SCP_CD,
       BK.RT_CNG_HIS,
       BK.POR_CD,
       BK.POL_CD,
       BK.POD_CD,
       BK.DEL_CD,
       BK.BKG_CTRT_TP_CD,
       BK.CTRT_NO,
       RT.BKG_CHG_CD,
       RT.BKG_CURR_CD,
       RT.BKG_CHG_UT_AMT,
       RT.BKG_RAT_UT_CD,
       RT.BKG_RAT_AS_QTY,
       RT.BKG_CHG_AMT,
       RT.BKG_AUTO_RAT_CD,
       RT.HIS_CHG_CD,
       RT.HIS_CURR_CD,
       RT.HIS_CHG_UT_AMT,
       RT.HIS_RAT_UT_CD,
       RT.HIS_RAT_AS_QTY,
       RT.HIS_CHG_AMT,
       COUNT(DISTINCT RT.BKG_NO) OVER () AS  BL_CNT,
       '' search_date,
       '' fm_dt,
       '' to_dt       
FROM BK, RT
WHERE BK.BKG_NO = RT.BKG_NO
ORDER BY BK.BKG_RHQ_CD, BK.BKG_OFC_CD, BK.BKG_NO, RT.BKG_CHG_CD, RT.HIS_CHG_CD			]]></sql>
			<params>
				<param name="bkg_ofc_cd" type="12" value="" out="N"/>
				<param name="bkg_rhq_cd" type="12" value="" out="N"/>
				<param name="fm_dt" type="12" value="" out="N"/>
				<param name="to_dt" type="12" value="" out="N"/>
				<param name="svc_scp_cd" type="12" value="" out="N"/>
				<param name="cmdt_cd" type="12" value="" out="N"/>
				<param name="bkg_ctrt_tp_cd" type="12" value="" out="N"/>
				<param name="ctrt_no" type="12" value="" out="N"/>
				<param name="por_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="del_cd" type="12" value="" out="N"/>
				<param name="bdr_flg" type="12" value="" out="N"/>
				<param name="auto_rat_cd" type="12" value="" out="N"/>
				<param name="chg_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
