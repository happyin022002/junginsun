<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="AGNCommCalcHistoryDBDAOSearchAGNCommCalcHistoryListRSQL">
			<desc><![CDATA[]]></desc>
			<sql><![CDATA[
SELECT 
       TO_CHAR(TO_DATE(SUBSTR(B.CALC_NO,1,6),'YYMMDD'),'YYYY-MM-DD') AS EVT_DT,
       TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC('KRPUS', TO_DATE(SUBSTR(B.CALC_NO,1,6),'YYMMDD'), 'GMT'), 'YYYY-MM-DD')  AS EVT_GMT_DT,
       DECODE(A.AC_STS_CD, 'CS', 'Calculation', 'RS', 'Request', 'AS', 'Audited', 'PS', 'Approved', 'IS', 'Interface', 'Rejected') AS EVT_TP,
       A.AGN_CD,
       A.AGN_AGMT_NO,
       MAX(DECODE(A.AC_VSL_CD, 'CNTC', '', A.AC_VSL_CD||A.AC_SKD_VOY_NO||A.AC_SKD_DIR_CD||A.AC_REV_DIR_CD)) AS COMM_VVD,
       A.IO_BND_CD,
       TO_CHAR(TO_DATE(A.SAIL_ARR_DT, 'YYYYMMDD'), 'YYYY-MM-DD') AS SAIL_ARR_DT,
       DECODE(A.AC_TP_CD, 'G', 'General', 'K', 'BRKG', 'H', 'CHF', 'S', 'T/S', 'C', 'Cross', A.AC_TP_CD) AS AC_TP_CD,
       DECODE( A.CALC_NO , B.CALC_NO , B.RNK , '' ) AS CALC_SEQ,
       A.AC_STS_CD,
       SUM(DECODE(SIGN(INSTR('GKHSC', A.AC_TP_CD)), 1, A.IF_AMT, 0)) AS IF_AMT,
       SUM(DECODE(SIGN(INSTR('GKHSC', A.AC_TP_CD)), 1, A.CRNT_AMT, 0)) AS CRNT_AMT,
       COUNT(A.BKG_NO) AS BKG_CNT,
       SUM(A.CRNT_REV_AMT) AS CRNT_REV_AMT,
       SUM(A.DDCT_CHG_AMT) AS DDCT_CHG_AMT,
       SUM(A.DDCT_TRSP_AMT) AS DDCT_TRSP_AMT,
       SUM(A.DDCT_SPCL_CMPN_AMT) AS DDCT_SPCL_CMPN_AMT,
       A.BKG_NO,
       A.AC_SEQ,
       A.CALC_NO
  FROM ACM_AGN_COMM_HIS A
      ,(
        SELECT CALC_NO, RANK() OVER ( PARTITION BY BKG_NO ORDER BY CALC_NO) RNK 
        FROM (
            SELECT DISTINCT CALC_NO, BKG_NO 
            FROM ACM_AGN_COMM_HIS 
            WHERE 1 = 1
#if(${bkg_no} != '')
            AND BKG_NO    = @[bkg_no]
#end
#if(${io_bnd_cd} != '')
            AND IO_BND_CD = @[io_bnd_cd]
#end
        )
      )B
 WHERE 1 = 1
#if(${bkg_no} != '')
   AND A.BKG_NO    = @[bkg_no]
#end
#if(${io_bnd_cd} != '')
   AND A.IO_BND_CD = @[io_bnd_cd]
#end
   AND AC_STS_CD NOT IN ('CZ')
   AND A.CALC_NO = B.CALC_NO
 GROUP BY
          A.CRE_DT,
          A.AGN_CD,
          A.AGN_AGMT_NO,
          A.IO_BND_CD,
          A.SAIL_ARR_DT,
          A.AC_TP_CD,
          A.CALC_NO,
          A.AC_STS_CD,
          A.BKG_NO,
          A.AC_SEQ,
          B.CALC_NO,
          B.RNK
 ORDER BY B.CALC_NO,EVT_DT,EVT_GMT_DT,EVT_TP,AGN_CD,AGN_AGMT_NO,COMM_VVD,IO_BND_CD,SAIL_ARR_DT,CALC_SEQ,AC_TP_CD			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="io_bnd_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
