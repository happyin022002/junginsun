<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ArrivalNoticeDBDAOsearchArrNtcCustCodeErrRhqReportRSQL">
			<desc><![CDATA[Customer Code Error Report를 RHQ별로 Total 및 백분율 조회]]></desc>
			<sql><![CDATA[
SELECT RHQ_CD,
  CNT1,
  'Auto-m' EVL_RSLT1,
  AUTO,
  '('||TRIM(TO_CHAR(AUTO/CNT1*100, '99999999990.99'))||'%)' AUTO2,
  'Ok' EVL_RSLT2,
  OKAY,
  '('||TRIM(TO_CHAR(OKAY/CNT1*100, '99999999990.99'))||'%)' OKAY2,
  'Wrong' EVL_RSLT3,
  WRONGINPUT,
  '('||TRIM(TO_CHAR(WRONGINPUT/CNT1*100, '99999999990.99'))||'%)' WRONGINPUT2,
  'Not-Ex' EVL_RSLT4,
  NOTEXISTED,
  '('||TRIM(TO_CHAR(NOTEXISTED/CNT1*100, '99999999990.99'))||'%)' NOTEXISTED2,
  'Multi' EVL_RSLT5,
  MULTI,
  '('||TRIM(TO_CHAR(MULTI/CNT1*100, '99999999990.99'))||'%)' MULTI2,
  'Skip' EVL_RSLT6,
  SKIP,
  '('||TRIM(TO_CHAR(SKIP/CNT1*100, '99999999990.99'))||'%)' SKIP2,
  'BB' BB,
  '('||ROUND(BB/CNT1*100, 1)||'%)' BB2
FROM (
    SELECT RHQ_CD,
      NVL(SUM(CNT),0) CNT1,
      NVL(MAX(DECODE(EVL_RST_NM, 'Skip', CNT)),0) Skip ,
      NVL(MAX(DECODE(EVL_RST_NM, 'Not-Existed', CNT)),0) NotExisted,
      NVL(MAX(DECODE(EVL_RST_NM, 'Wrong Input', CNT)),0) WrongInput,
      NVL(MAX(DECODE(EVL_RST_NM, 'Okay', CNT)),0) Okay,
      NVL(MAX(DECODE(EVL_RST_NM, 'AUTO', CNT)),0) AUTO,
      NVL(MAX(DECODE(EVL_RST_NM, 'Multi-Code', CNT)),0) Multi,
      MAX(DECODE(EVL_RST_NM, '', CNT)) BB
    FROM (
        SELECT 
#if (${rep_year} == '2010' || ${rep_year} == '2011' || ${rep_year} == '2012' || ${rep_year} == '2013')
          DECODE(RHQ_CD,'TYOIB','SHARC',RHQ_CD) RHQ_CD,
#else
		  RHQ_CD,
#end
          EVL_RST_NM,
          COUNT(NVL(EVL_RST_NM, ' ')) CNT
        FROM ( SELECT (SELECT DISTINCT AR_HD_QTR_OFC_CD
                         FROM MDM_ORGANIZATION
                        WHERE OFC_CD  IN (
                #if(${bl_no} == '')
					#if(${ofc_tp_cd} == 'B')
								   #if ((${rep_year} == '2010' || ${rep_year} == '2011' || ${rep_year} == '2012' || ${rep_year} == '2013') && ${rhq_cd} == 'SHARC')
                                   SELECT OFC_CD FROM BKG_OFC_LVL_V WHERE REGION IN ('SHARC', 'TYOIB') AND GSO = NVL(@[gso_cd],GSO) AND OFC_CD = NVL(@[ofc_cd],BKG_OFC_CD) 
								   #else
								   SELECT OFC_CD FROM BKG_OFC_LVL_V WHERE REGION = NVL(@[rhq_cd],REGION) AND GSO = NVL(@[gso_cd],GSO) AND OFC_CD = NVL(@[ofc_cd],BKG_OFC_CD) 
								   #end
					#end
					#if(${ofc_tp_cd} == 'V')
								   #if ((${rep_year} == '2010' || ${rep_year} == '2011' || ${rep_year} == '2012' || ${rep_year} == '2013') && ${rhq_cd} == 'SHARC')
                                   SELECT OFC_CD FROM BKG_OFC_LVL_V WHERE REGION IN ('SHARC', 'TYOIB') AND GSO = NVL(@[gso_cd],GSO) AND OFC_CD = NVL(@[ofc_cd],EVL_OFC_CD) 
								   #else
								   SELECT OFC_CD FROM BKG_OFC_LVL_V WHERE REGION = NVL(@[rhq_cd],REGION) AND GSO = NVL(@[gso_cd],GSO) AND OFC_CD = NVL(@[ofc_cd],EVL_OFC_CD) 
								   #end
					#end
					#if(${ofc_tp_cd} == 'I')
								   #if ((${rep_year} == '2010' || ${rep_year} == '2011' || ${rep_year} == '2012' || ${rep_year} == '2013') && ${rhq_cd} == 'SHARC')
                                   SELECT OFC_CD FROM BKG_OFC_LVL_V WHERE REGION IN ('SHARC', 'TYOIB') AND GSO = NVL(@[gso_cd],GSO) AND OFC_CD = NVL(@[ofc_cd],CD_INPUT_OFC_CD) 
								   #else
								   SELECT OFC_CD FROM BKG_OFC_LVL_V WHERE REGION = NVL(@[rhq_cd],REGION) AND GSO = NVL(@[gso_cd],GSO) AND OFC_CD = NVL(@[ofc_cd],CD_INPUT_OFC_CD) 
								   #end
					#end
                #end
                #if(${bl_no} != '')				
                                   BKG_OFC_CD
                #end
                )) RHQ_CD,
              EVL_RST_NM ,
              BKG_OFC_CD ,
              EVL_OFC_CD ,
              CD_INPUT_OFC_CD,
			  BKG_CRE_DT
            FROM (
                SELECT BKGM.BKG_NO ,
                  BCST.BKG_CUST_TP_CD ,
                  BKGM.BL_NO,
                  BCST.BKG_CUST_TP_CD CUST_TP_CD ,
                  CDTL.INTG_CD_VAL_DP_DESC CUST_TP_CD_NM ,
                  BCST.ORG_CUST_CNT_CD || DECODE(BCST.ORG_CUST_SEQ, 0, NULL, LPAD(BCST.ORG_CUST_SEQ, 6, '0')) ERR_CD ,
                  BCST.CUST_CNT_CD || DECODE(BCST.CUST_SEQ, 0, NULL, LPAD(BCST.CUST_SEQ, 6, '0')) CRT_CD ,
                  TO_CHAR(MCST.EAI_EVNT_DT, 'YYYYMMDD') CD_CRE_DT ,
                  NVL(NVL((SELECT (SELECT OFC_CD FROM COM_USER WHERE UPPER(USR_ID) = UPPER(BKG_HIS_DTL.CRE_USR_ID) AND USE_FLG = 'Y' AND ROWNUM = 1 )
                             FROM BKG_HIS_DTL
                     	    WHERE BKG_NO = BKGM.BKG_NO
                        	  AND TO_CHAR(HIS_SEQ)||TRIM(TO_CHAR(HIS_DTL_SEQ, '000')) = TO_CHAR(BCST.HIS_CUST_CD_MAX)),
                    	  (SELECT (SELECT OFC_CD FROM COM_USER WHERE UPPER(USR_ID) = UPPER(BKG_HIS_DTL.CRE_USR_ID) AND USE_FLG = 'Y' AND ROWNUM = 1 )
                      	     FROM BKG_HIS_DTL
                      	    WHERE BKG_NO = BKGM.BKG_NO
                        	  AND TO_CHAR(HIS_SEQ)||TRIM(TO_CHAR(HIS_DTL_SEQ, '000')) = TO_CHAR(BCST.HIS_CUST_NM_MAX)))
					 ,(SELECT OFC_CD FROM COM_USER WHERE USR_ID = CUST_CRE_USR_ID)) CD_INPUT_OFC_CD,
                  BCST.VAL_CD EVL_RST_CD ,
                  DECODE(BCST.MTCH_FLG, 'Y', 'AUTO', VACD.INTG_CD_VAL_DP_DESC) AS EVL_RST_NM ,
                  TO_CHAR(BCST.CUST_CD_UPD_DT, 'YYYYMMDD') CD_INPUT_DT ,
                  BCST.CUST_CRE_USR_ID ,
                  BKGM.BKG_OFC_CD ,
                  BCST.VAL_OFC_CD EVL_OFC_CD ,
                  BCST.VAL_USR_ID EVL_USR_ID ,
                  TO_CHAR(BCST.VAL_DT, 'YYYYMMDD') EVL_DT ,
                  DECODE(BCST.OB_EV_CD, 'C' , 1, 0) OB_EV_CD ,
                  DECODE(BCST.IB_EV_CD, 'C' , 1, 0) IB_EV_CD ,
                  DECODE(BCST.HQ_EV_CD, 'C' , 1, 0) HQ_EV_CD ,
                  ROW_NUMBER() OVER (
                    ORDER BY BKGM.BKG_CRE_DT DESC, BCST.BKG_CUST_TP_CD ) ROW_NUM ,
                  COUNT(1) OVER () ROW_COUNT,
				  TO_DATE(TO_CHAR(BKGM.BKG_CRE_DT,'YYYYMMDD'), 'YYYYMMDD') AS BKG_CRE_DT
                FROM (
                   SELECT BKGM.ROWID RID,
                          BCST.CUST_CNT_CD,
                          BCST.CUST_SEQ,
                          BCST.BKG_CUST_TP_CD,
                          BCST.VAL_CD,
                          BCST.ORG_CUST_CNT_CD,
                          BCST.ORG_CUST_SEQ,
                          BCST.MTCH_FLG,
                          BCST.VAL_OFC_CD,
                          BCST.VAL_USR_ID,
                          BCST.VAL_DT,
                          BCST.OB_EV_CD,
                          BCST.IB_EV_CD,
                          BCST.HQ_EV_CD,
                          BCST.CUST_CD_UPD_DT,
						  BCST.CRE_USR_ID CUST_CRE_USR_ID,
						  (  SELECT /*+ INDEX_DESC (BKG_HIS_DTL XPKBKG_HIS_DTL) */
                                    TO_NUMBER(TO_CHAR(BKG_HIS_DTL.HIS_SEQ)||TRIM(TO_CHAR(BKG_HIS_DTL.HIS_DTL_SEQ, '000')))
                               FROM BKG_HIS_MST,
                                    BKG_HIS_DTL
                              WHERE BKG_HIS_MST.BKG_NO = BKG_HIS_DTL.BKG_NO
                                AND BKG_HIS_MST.HIS_SEQ = BKG_HIS_DTL.HIS_SEQ
                                AND BKG_HIS_MST.BKG_NO = BKGM.BKG_NO
                                AND BKG_HIS_MST.BKG_HIS_ISS_UI_ID IN ( 'ESM_BKG_0079_05', 'ESM_BKG_0229', 'ESM_BKG_0648' )
                                AND HIS_CATE_NM LIKE DECODE(BCST.BKG_CUST_TP_CD, 'C', 'CNEE CD%', 'N', 'NTFY CD%')
                                AND ROWNUM <= 1
                          ) HIS_CUST_CD_MAX,
                          (  SELECT /*+ INDEX_DESC (BKG_HIS_DTL XPKBKG_HIS_DTL) */
                                    TO_NUMBER(TO_CHAR(BKG_HIS_DTL.HIS_SEQ)||TRIM(TO_CHAR(BKG_HIS_DTL.HIS_DTL_SEQ, '000')))
                               FROM BKG_HIS_MST,
                                    BKG_HIS_DTL
                              WHERE BKG_HIS_MST.BKG_NO = BKG_HIS_DTL.BKG_NO
                                AND BKG_HIS_MST.HIS_SEQ = BKG_HIS_DTL.HIS_SEQ
                                AND BKG_HIS_MST.BKG_NO = BKGM.BKG_NO
                                AND BKG_HIS_MST.BKG_HIS_ISS_UI_ID IN ( 'ESM_BKG_0079_05', 'ESM_BKG_0229', 'ESM_BKG_0648' )
                                AND HIS_CATE_NM LIKE DECODE(BCST.BKG_CUST_TP_CD, 'C', 'CNEE NM%', 'N', 'NTFY NM%')
                                AND ROWNUM <= 1
                          ) HIS_CUST_NM_MAX
                     FROM BKG_BOOKING BKGM,
                          BKG_CUSTOMER BCST
                    WHERE BKGM.BKG_NO = BCST.BKG_NO
                      AND BCST.BKG_CUST_TP_CD IN ('C','N')  
                      AND NVL(BCST.VAL_CD,' ') NOT IN ('C','X' ) 
#if ( ${bl_no} != '')
                      AND BKGM.BL_NO = @[bl_no]
#end
#if ( ${bl_no} == '')
	#if ( ${bkg_cre_dt_s} != '' && ${bkg_cre_dt_e} != '')
                      AND BKGM.BKG_CRE_DT >= TO_DATE(@[bkg_cre_dt_s], 'YYYYMMDD')
                      AND BKGM.BKG_CRE_DT <  TO_DATE(@[bkg_cre_dt_e], 'YYYYMMDD') + 1
	#end
	#if ( ${val_dt_s} != '')
                      AND BCST.VAL_DT BETWEEN TO_DATE (@[val_dt_s], 'YYYYMMDD') AND (TO_DATE(@[val_dt_e], 'YYYYMMDD') + 1 )
	#end
	#if ( ${eta_dt_s} != '' && ${eta_dt_e} != '')
                      AND BKGM.BKG_NO IN ( SELECT DISTINCT BKG.BKG_NO
                                           FROM BKG_VVD VVD, BKG_BOOKING BKG
                                           WHERE ( VVD.VSL_CD,VVD.SKD_VOY_NO,VVD.SKD_DIR_CD,VVD.POD_CD,VVD.POD_CLPT_IND_SEQ ) IN
                                                 ( SELECT A.VSL_CD,A.SKD_VOY_NO,A.SKD_DIR_CD,A.VPS_PORT_CD,A.CLPT_IND_SEQ
                                                   FROM VSK_VSL_PORT_SKD A
                                                   WHERE A.VPS_ETA_DT >= TO_DATE(@[eta_dt_s], 'YYYY-MM-DD')
                                                   AND A.VPS_ETA_DT <= TO_DATE(@[eta_dt_e], 'YYYY-MM-DD') +0.99999)
                                                   AND VVD.BKG_NO = BKG.BKG_NO
                                                   AND VVD.POD_CD = BKG.POD_CD
                                                   AND VVD.VSL_PRE_PST_CD IN ('T','U')
                                                   AND (VVD.VSL_PRE_PST_CD, VVD.VSL_SEQ) = ( SELECT /*+ INDEX_DESC (VVD2 XPKBKG_VVD) */ VVD2.VSL_PRE_PST_CD, VVD2.VSL_SEQ
                                                                                             FROM BKG_VVD VVD2
                                                                                             WHERE VVD2.BKG_NO = VVD.BKG_NO
                                                                                             AND VVD2.VSL_PRE_PST_CD IN ('T','U')
                                                                                             AND ROWNUM = 1)
                                          )
	#end

                      AND BCST.MTCH_FLG = DECODE(@[mtch_flg], 'O', 'N', 'A', BCST.MTCH_FLG, @[mtch_flg])
                      AND (
                            NVL(BCST.VAL_CD,' ') = CASE WHEN @[mtch_flg] IN ( 'Y', 'A' )THEN ' '
                                                        WHEN @[mtch_flg] = 'O' THEN 'O'
                                                        WHEN @[val_cd] IS NOT NULL  AND @[val_cd] <> 'All' THEN @[val_cd]
                                                        WHEN @[mtch_flg] = 'N' THEN DECODE(BCST.VAL_CD,'O','o',BCST.VAL_CD)
                                                        ELSE  NVL(BCST.VAL_CD,' ')
                                                   END
						#if ( ${non_val_flg} != '' )
                          OR BCST.VAL_CD IS NULL

						#end
                           )
                      AND BKGM.DOC_USR_ID LIKE NVL(@[doc_usr_id], BKGM.DOC_USR_ID) || '%'
	#if ( ${cust_tp_cd} != 'All')
    	#if ( ${cust_tp_cd} != 'T')
                      AND BCST.BKG_CUST_TP_CD = @[cust_tp_cd]
    	#else
                      AND BCST.BKG_CUST_TP_CD = DECODE(BKGM.CUST_TO_ORD_FLG,'Y','N','C')
    	#end
	#end
	#if ( ${cust_cd} != '')
                      AND BCST.ORG_CUST_CNT_CD = SUBSTR(@[cust_cd], 1,2)
                      AND BCST.ORG_CUST_SEQ    = TO_NUMBER(SUBSTR(@[cust_cd], 3,6))
	#end
	#if ( ${val_usr_id} != '')
                      AND BCST.VAL_USR_ID LIKE @[val_usr_id] || '%'
	#end
#end
                ) BCST,
                BKG_BOOKING BKGM,
                MDM_CUSTOMER MCST,
                COM_INTG_CD_DTL CDTL,
                COM_INTG_CD_DTL VACD
         WHERE  1 = 1
           AND  BCST.RID = BKGM.ROWID
           AND  MCST.CUST_CNT_CD (+) = BCST.CUST_CNT_CD
           AND  MCST.CUST_SEQ (+) = BCST.CUST_SEQ
           AND  CDTL.INTG_CD_ID = 'CD00880'
           AND  CDTL.INTG_CD_VAL_CTNT = BCST.BKG_CUST_TP_CD
           AND  VACD.INTG_CD_ID (+) = 'CD01655'
           AND  VACD.INTG_CD_VAL_CTNT (+) = BCST.VAL_CD
        )), MDM_ORGANIZATION O
#if (  ${bl_no} == '' && ${ofc_tp_cd} == 'I')
    WHERE CD_INPUT_OFC_CD = O.OFC_CD
	#if ((${rep_year} == '2010' || ${rep_year} == '2011' || ${rep_year} == '2012' || ${rep_year} == '2013') && ${rhq_cd} == 'SHARC')
    AND AR_HD_QTR_OFC_CD IN (SELECT REGION FROM BKG_OFC_LVL_V WHERE REGION IN ('SHARC','TYOIB') AND GSO = NVL(@[gso_cd],GSO) AND OFC_CD = NVL(@[ofc_cd],CD_INPUT_OFC_CD))
    #else
    AND AR_HD_QTR_OFC_CD IN (SELECT REGION FROM BKG_OFC_LVL_V WHERE REGION = NVL(@[rhq_cd],REGION) AND GSO = NVL(@[gso_cd],GSO) AND OFC_CD = NVL(@[ofc_cd],CD_INPUT_OFC_CD))
    #end
#end 
#if (  ${bl_no} == '' && ${ofc_tp_cd} == 'B')
    WHERE BKG_OFC_CD = O.OFC_CD
    #if ((${rep_year} == '2010' || ${rep_year} == '2011' || ${rep_year} == '2012' || ${rep_year} == '2013') && ${rhq_cd} == 'SHARC')
    AND AR_HD_QTR_OFC_CD IN (SELECT REGION FROM BKG_OFC_LVL_V WHERE REGION IN ('SHARC','TYOIB') AND GSO = NVL(@[gso_cd],GSO) AND OFC_CD = NVL(@[ofc_cd],BKG_OFC_CD))
    #else
    AND AR_HD_QTR_OFC_CD IN (SELECT REGION FROM BKG_OFC_LVL_V WHERE REGION = NVL(@[rhq_cd],REGION) AND GSO = NVL(@[gso_cd],GSO) AND OFC_CD = NVL(@[ofc_cd],BKG_OFC_CD))
    #end
#end
#if (  ${bl_no} == '' && ${ofc_tp_cd} == 'V')
    WHERE EVL_OFC_CD = O.OFC_CD
    #if ((${rep_year} == '2010' || ${rep_year} == '2011' || ${rep_year} == '2012' || ${rep_year} == '2013') && ${rhq_cd} == 'SHARC')
    AND AR_HD_QTR_OFC_CD IN (SELECT REGION FROM BKG_OFC_LVL_V WHERE REGION IN ('SHARC','TYOIB') AND GSO = NVL(@[gso_cd],GSO) AND OFC_CD = NVL(@[ofc_cd],EVL_OFC_CD))
    #else
    AND AR_HD_QTR_OFC_CD IN (SELECT REGION FROM BKG_OFC_LVL_V WHERE REGION = NVL(@[rhq_cd],REGION) AND GSO = NVL(@[gso_cd],GSO) AND OFC_CD = NVL(@[ofc_cd],EVL_OFC_CD))
    #end    
#end
    GROUP BY EVL_RST_NM , BKG_CRE_DT, RHQ_CD )
GROUP BY RHQ_CD )
#if ((${rep_year} == '2010' || ${rep_year} == '2011' || ${rep_year} == '2012' || ${rep_year} == '2013') && ${rhq_cd} == 'TYOIB')
WHERE RHQ_CD ='TOYIB'
#end
UNION ALL
SELECT RHQ_CD,
  CNT1,
  'Auto-m' EVL_RSLT1,
  AUTO,
  '('||TRIM(TO_CHAR(AUTO/CNT1*100, '99999999990.99'))||'%)' AUTO2,
  'Ok' EVL_RSLT2,
  OKAY,
  '('||TRIM(TO_CHAR(OKAY/CNT1*100, '99999999990.99'))||'%)' OKAY2,
  'Wrong' EVL_RSLT3,
  WRONGINPUT,
  '('||TRIM(TO_CHAR(WRONGINPUT/CNT1*100, '99999999990.99'))||'%)' WRONGINPUT2,
  'Not-Ex' EVL_RSLT4,
  NOTEXISTED,
  '('||TRIM(TO_CHAR(NOTEXISTED/CNT1*100, '99999999990.99'))||'%)' NOTEXISTED2,
  'Multi' EVL_RSLT5,
  MULTI,
  '('||TRIM(TO_CHAR(MULTI/CNT1*100, '99999999990.99'))||'%)' MULTI2,
  'Skip' EVL_RSLT6,
  SKIP,
  '('||TRIM(TO_CHAR(SKIP/CNT1*100, '99999999990.99'))||'%)' SKIP2,
  'BB' BB,
  '('||ROUND(BB/CNT1*100, 1)||'%)' BB2
FROM (
    SELECT RHQ_CD,
      NVL(SUM(CNT),0) CNT1,
      NVL(MAX(DECODE(EVL_RST_NM, 'Skip', CNT)),0) Skip ,
      NVL(MAX(DECODE(EVL_RST_NM, 'Not-Existed', CNT)),0) NotExisted,
      NVL(MAX(DECODE(EVL_RST_NM, 'Wrong Input', CNT)),0) WrongInput,
      NVL(MAX(DECODE(EVL_RST_NM, 'Okay', CNT)),0) Okay,
      NVL(MAX(DECODE(EVL_RST_NM, 'AUTO', CNT)),0) AUTO,
      NVL(MAX(DECODE(EVL_RST_NM, 'Multi-Code', CNT)),0) Multi,
      MAX(DECODE(EVL_RST_NM, '', CNT)) BB
    FROM (
        SELECT RHQ_CD,
          EVL_RST_NM,
          COUNT(NVL(EVL_RST_NM, ' ')) CNT
        FROM (
            SELECT 
#if (${rep_year} == '2010' || ${rep_year} == '2011' || ${rep_year} == '2012' || ${rep_year} == '2013')
              DECODE(BKG_OFC_CD,'TYOIB','SHARC',BKG_OFC_CD) RHQ_CD,
#else
       	      BKG_OFC_CD RHQ_CD, 
#end
              EVL_RST_NM ,
              BKG_OFC_CD ,
              NVL(CD_INPUT_OFC_CD,(SELECT OFC_CD FROM COM_USER WHERE USR_ID = CUST_CRE_USR_ID)) CD_INPUT_OFC_CD
            FROM (
                SELECT BKGM.BKG_NO ,
                  BCST.BKG_CUST_TP_CD ,
                  BKGM.BL_NO,
                  BCST.BKG_CUST_TP_CD CUST_TP_CD ,
                  CDTL.INTG_CD_VAL_DP_DESC CUST_TP_CD_NM ,
                  BCST.ORG_CUST_CNT_CD || DECODE(BCST.ORG_CUST_SEQ, 0, NULL, LPAD(BCST.ORG_CUST_SEQ, 6, '0')) ERR_CD ,
                  BCST.CUST_CNT_CD || DECODE(BCST.CUST_SEQ, 0, NULL, LPAD(BCST.CUST_SEQ, 6, '0')) CRT_CD ,
                  TO_CHAR(MCST.EAI_EVNT_DT, 'YYYYMMDD') CD_CRE_DT ,
                  NVL((SELECT (SELECT OFC_CD FROM COM_USER WHERE UPPER(USR_ID) = UPPER(BKG_HIS_DTL.CRE_USR_ID) AND USE_FLG = 'Y' AND ROWNUM = 1 )
                       FROM BKG_HIS_DTL
                      WHERE BKG_NO = BKGM.BKG_NO
                        AND TO_CHAR(HIS_SEQ)||TRIM(TO_CHAR(HIS_DTL_SEQ, '000')) = TO_CHAR(BCST.HIS_CUST_CD_MAX)),
                    (SELECT (SELECT OFC_CD FROM COM_USER WHERE UPPER(USR_ID) = UPPER(BKG_HIS_DTL.CRE_USR_ID) AND USE_FLG = 'Y' AND ROWNUM = 1 )
                       FROM BKG_HIS_DTL
                      WHERE BKG_NO = BKGM.BKG_NO
                        AND TO_CHAR(HIS_SEQ)||TRIM(TO_CHAR(HIS_DTL_SEQ, '000')) = TO_CHAR(BCST.HIS_CUST_NM_MAX))) CD_INPUT_OFC_CD,
                  BCST.VAL_CD EVL_RST_CD ,
                  DECODE(BCST.MTCH_FLG, 'Y', 'AUTO', VACD.INTG_CD_VAL_DP_DESC) AS EVL_RST_NM ,
                  TO_CHAR(BCST.CUST_CD_UPD_DT, 'YYYYMMDD') CD_INPUT_DT ,
                  BCST.CUST_CRE_USR_ID ,
                  BKGM.BKG_OFC_CD ,
                  BCST.VAL_OFC_CD EVL_OFC_CD ,
                  BCST.VAL_USR_ID EVL_USR_ID ,
                  TO_CHAR(BCST.VAL_DT, 'YYYYMMDD') EVL_DT ,
                  DECODE(BCST.OB_EV_CD, 'C' , 1, 0) OB_EV_CD ,
                  DECODE(BCST.IB_EV_CD, 'C' , 1, 0) IB_EV_CD ,
                  DECODE(BCST.HQ_EV_CD, 'C' , 1, 0) HQ_EV_CD ,
                  ROW_NUMBER() OVER (
                    ORDER BY BKGM.BKG_CRE_DT DESC, BCST.BKG_CUST_TP_CD ) ROW_NUM ,
                  COUNT(1) OVER () ROW_COUNT
                FROM (
                   SELECT BKGM.ROWID RID,
                          BCST.CUST_CNT_CD,
                          BCST.CUST_SEQ,
                          BCST.BKG_CUST_TP_CD,
                          BCST.VAL_CD,
                          BCST.ORG_CUST_CNT_CD,
                          BCST.ORG_CUST_SEQ,
                          BCST.MTCH_FLG,
                          BCST.VAL_OFC_CD,
                          BCST.VAL_USR_ID,
                          BCST.VAL_DT,
                          BCST.OB_EV_CD,
                          BCST.IB_EV_CD,
                          BCST.HQ_EV_CD,
                          BCST.CUST_CD_UPD_DT,
						  BCST.CRE_USR_ID CUST_CRE_USR_ID,
						  (  SELECT /*+ INDEX_DESC (BKG_HIS_DTL XPKBKG_HIS_DTL) */
                                    TO_NUMBER(TO_CHAR(BKG_HIS_DTL.HIS_SEQ)||TRIM(TO_CHAR(BKG_HIS_DTL.HIS_DTL_SEQ, '000')))
                               FROM BKG_HIS_MST,
                                    BKG_HIS_DTL
                              WHERE BKG_HIS_MST.BKG_NO = BKG_HIS_DTL.BKG_NO
                                AND BKG_HIS_MST.HIS_SEQ = BKG_HIS_DTL.HIS_SEQ
                                AND BKG_HIS_MST.BKG_NO = BKGM.BKG_NO
                                AND BKG_HIS_MST.BKG_HIS_ISS_UI_ID IN ( 'ESM_BKG_0079_05', 'ESM_BKG_0229', 'ESM_BKG_0648' )
                                AND HIS_CATE_NM LIKE DECODE(BCST.BKG_CUST_TP_CD, 'C', 'CNEE CD%', 'N', 'NTFY CD%')
                                AND ROWNUM <= 1
                          ) HIS_CUST_CD_MAX,
                          (  SELECT /*+ INDEX_DESC (BKG_HIS_DTL XPKBKG_HIS_DTL) */
                                    TO_NUMBER(TO_CHAR(BKG_HIS_DTL.HIS_SEQ)||TRIM(TO_CHAR(BKG_HIS_DTL.HIS_DTL_SEQ, '000')))
                               FROM BKG_HIS_MST,
                                    BKG_HIS_DTL
                              WHERE BKG_HIS_MST.BKG_NO = BKG_HIS_DTL.BKG_NO
                                AND BKG_HIS_MST.HIS_SEQ = BKG_HIS_DTL.HIS_SEQ
                                AND BKG_HIS_MST.BKG_NO = BKGM.BKG_NO
                                AND BKG_HIS_MST.BKG_HIS_ISS_UI_ID IN ( 'ESM_BKG_0079_05', 'ESM_BKG_0229', 'ESM_BKG_0648' )
                                AND HIS_CATE_NM LIKE DECODE(BCST.BKG_CUST_TP_CD, 'C', 'CNEE NM%', 'N', 'NTFY NM%')
                                AND ROWNUM <= 1
                          ) HIS_CUST_NM_MAX
                     FROM BKG_BOOKING BKGM,
                          BKG_CUSTOMER BCST
                    WHERE BKGM.BKG_NO = BCST.BKG_NO
                      AND BCST.BKG_CUST_TP_CD IN ('C','N')   
                      AND NVL(BCST.VAL_CD,' ') NOT IN ('C','X' ) 

#if ( ${bl_no} != '')
                      AND BKGM.BL_NO = @[bl_no]
#end
#if ( ${bl_no} == '')
	#if ( ${bkg_cre_dt_s} != '' && ${bkg_cre_dt_e} != '')
                      AND BKGM.BKG_CRE_DT >= TO_DATE(@[bkg_cre_dt_s], 'YYYYMMDD')
                      AND BKGM.BKG_CRE_DT <  TO_DATE(@[bkg_cre_dt_e], 'YYYYMMDD') + 1
	#end
	#if ( ${val_dt_s} != '')
                      AND BCST.VAL_DT BETWEEN TO_DATE (@[val_dt_s], 'YYYYMMDD') AND (TO_DATE(@[val_dt_e], 'YYYYMMDD') + 1 )
	#end
	#if ( ${eta_dt_s} != '' && ${eta_dt_e} != '')
                      AND BKGM.BKG_NO IN ( SELECT DISTINCT BKG.BKG_NO
                                           FROM BKG_VVD VVD, BKG_BOOKING BKG
                                           WHERE ( VVD.VSL_CD,VVD.SKD_VOY_NO,VVD.SKD_DIR_CD,VVD.POD_CD,VVD.POD_CLPT_IND_SEQ ) IN
                                                 ( SELECT A.VSL_CD,A.SKD_VOY_NO,A.SKD_DIR_CD,A.VPS_PORT_CD,A.CLPT_IND_SEQ
                                                   FROM VSK_VSL_PORT_SKD A
                                                   WHERE A.VPS_ETA_DT >= TO_DATE(@[eta_dt_s], 'YYYY-MM-DD')
                                                   AND A.VPS_ETA_DT <= TO_DATE(@[eta_dt_e], 'YYYY-MM-DD') +0.99999)
                                                   AND VVD.BKG_NO = BKG.BKG_NO
                                                   AND VVD.POD_CD = BKG.POD_CD
                                                   AND VVD.VSL_PRE_PST_CD IN ('T','U')
                                                   AND (VVD.VSL_PRE_PST_CD, VVD.VSL_SEQ) = ( SELECT /*+ INDEX_DESC (VVD2 XPKBKG_VVD) */ VVD2.VSL_PRE_PST_CD, VVD2.VSL_SEQ
                                                                                             FROM BKG_VVD VVD2
                                                                                             WHERE VVD2.BKG_NO = VVD.BKG_NO
                                                                                             AND VVD2.VSL_PRE_PST_CD IN ('T','U')
                                                                                             AND ROWNUM = 1)
                                          )
	#end
	#if ( ${ofc_tp_cd} == 'B')
        #if ((${rep_year} == '2010' || ${rep_year} == '2011' || ${rep_year} == '2012' || ${rep_year} == '2013') && ${rhq_cd} == 'SHARC')
                      AND BKGM.BKG_OFC_CD IN (SELECT OFC_CD FROM BKG_OFC_LVL_V WHERE REGION IN ('SHARC','TYOIB') AND GSO = NVL(@[gso_cd],GSO) AND OFC_CD = NVL(@[ofc_cd],OFC_CD))
        #else
                      AND BKGM.BKG_OFC_CD IN (SELECT OFC_CD FROM BKG_OFC_LVL_V WHERE REGION = NVL(@[rhq_cd],REGION) AND GSO = NVL(@[gso_cd],GSO) AND OFC_CD = NVL(@[ofc_cd],OFC_CD))
        #end
	#end
	#if ( ${ofc_tp_cd} == 'V')
	        #if ((${rep_year} == '2010' || ${rep_year} == '2011' || ${rep_year} == '2012' || ${rep_year} == '2013') && ${rhq_cd} == 'SHARC')
                      AND BCST.VAL_OFC_CD IN (SELECT OFC_CD FROM BKG_OFC_LVL_V WHERE REGION IN ('SHARC','TYOIB') AND GSO = NVL(@[gso_cd],GSO) AND OFC_CD = NVL(@[ofc_cd],OFC_CD))
        	#else
                      AND BCST.VAL_OFC_CD IN (SELECT OFC_CD FROM BKG_OFC_LVL_V WHERE REGION = NVL(@[rhq_cd],REGION) AND GSO = NVL(@[gso_cd],GSO) AND OFC_CD = NVL(@[ofc_cd],OFC_CD))
        	#end
	#end

                      AND BCST.MTCH_FLG = DECODE(@[mtch_flg], 'O', 'N', 'A', BCST.MTCH_FLG, @[mtch_flg])
                      AND (
                            NVL(BCST.VAL_CD,' ') = CASE WHEN @[mtch_flg] IN ( 'Y', 'A' )THEN ' '
                                                        WHEN @[mtch_flg] = 'O' THEN 'O'
                                                        WHEN @[val_cd] IS NOT NULL  AND @[val_cd] <> 'All' THEN @[val_cd]
                                                        WHEN @[mtch_flg] = 'N' THEN DECODE(BCST.VAL_CD,'O','o',BCST.VAL_CD)
                                                        ELSE  NVL(BCST.VAL_CD,' ')
                                                   END
						#if ( ${non_val_flg} != '' )
                          OR BCST.VAL_CD IS NULL

						#end
                           )
                      AND BKGM.DOC_USR_ID LIKE NVL(@[doc_usr_id], BKGM.DOC_USR_ID) || '%'
	#if ( ${cust_tp_cd} != 'All')
    	#if ( ${cust_tp_cd} != 'T')
                      AND BCST.BKG_CUST_TP_CD = @[cust_tp_cd]
    	#else
                      AND BCST.BKG_CUST_TP_CD = DECODE(BKGM.CUST_TO_ORD_FLG,'Y','N','C')
    	#end
	#end
	#if ( ${cust_cd} != '')
                      AND BCST.ORG_CUST_CNT_CD = SUBSTR(@[cust_cd], 1,2)
                      AND BCST.ORG_CUST_SEQ    = TO_NUMBER(SUBSTR(@[cust_cd], 3,6))
	#end
	#if ( ${val_usr_id} != '')
                      AND BCST.VAL_USR_ID LIKE @[val_usr_id] || '%'
	#end
#end
                ) BCST,
                BKG_BOOKING BKGM,
                MDM_CUSTOMER MCST,
                COM_INTG_CD_DTL CDTL,
                COM_INTG_CD_DTL VACD
         WHERE  1 = 1
           AND  BCST.RID = BKGM.ROWID
           AND  MCST.CUST_CNT_CD (+) = BCST.CUST_CNT_CD
           AND  MCST.CUST_SEQ (+) = BCST.CUST_SEQ
           AND  CDTL.INTG_CD_ID = 'CD00880'
           AND  CDTL.INTG_CD_VAL_CTNT = BCST.BKG_CUST_TP_CD
           AND  VACD.INTG_CD_ID (+) = 'CD01655'
           AND  VACD.INTG_CD_VAL_CTNT (+) = BCST.VAL_CD
        ))
#if ( ${bl_no} == '' && ${ofc_tp_cd} == 'I')
    #if ((${rep_year} == '2010' || ${rep_year} == '2011' || ${rep_year} == '2012' || ${rep_year} == '2013') && ${rhq_cd} == 'SHARC')
    WHERE CD_INPUT_OFC_CD IN (SELECT OFC_CD FROM BKG_OFC_LVL_V WHERE REGION IN ('SHARC','TYOIB') AND GSO = NVL(@[gso_cd],GSO) AND OFC_CD = NVL(@[ofc_cd],OFC_CD))
    #else
    WHERE CD_INPUT_OFC_CD IN (SELECT OFC_CD FROM BKG_OFC_LVL_V WHERE REGION = NVL(@[rhq_cd],REGION) AND GSO = NVL(@[gso_cd],GSO) AND OFC_CD = NVL(@[ofc_cd],OFC_CD))
    #end
#end 

                    GROUP BY EVL_RST_NM , RHQ_CD )
            GROUP BY RHQ_CD )
#if ((${rep_year} == '2010' || ${rep_year} == '2011' || ${rep_year} == '2012' || ${rep_year} == '2013') && ${rhq_cd} == 'TYOIB')
WHERE RHQ_CD ='TOYIB'
#end			]]></sql>
			<params>
				<param name="gso_cd" type="12" value="" out="N"/>
				<param name="ofc_cd" type="12" value="" out="N"/>
				<param name="rhq_cd" type="12" value="" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
				<param name="bkg_cre_dt_s" type="12" value="" out="Y"/>
				<param name="bkg_cre_dt_e" type="12" value="" out="Y"/>
				<param name="val_dt_s" type="12" value="" out="N"/>
				<param name="val_dt_e" type="12" value="" out="N"/>
				<param name="eta_dt_s" type="12" value="" out="N"/>
				<param name="eta_dt_e" type="12" value="" out="N"/>
				<param name="mtch_flg" type="12" value="" out="N"/>
				<param name="val_cd" type="12" value="" out="N"/>
				<param name="doc_usr_id" type="12" value="" out="N"/>
				<param name="cust_tp_cd" type="12" value="" out="N"/>
				<param name="cust_cd" type="12" value="" out="N"/>
				<param name="val_usr_id" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
