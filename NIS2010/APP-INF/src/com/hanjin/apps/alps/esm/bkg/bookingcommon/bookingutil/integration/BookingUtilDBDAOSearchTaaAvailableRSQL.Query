<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BookingUtilDBDAOSearchTaaAvailableRSQL">
			<desc><![CDATA[taa no 가용성 조회]]></desc>
			<sql><![CDATA[
#if (${page_type}== 'ESM_BKG_0079_08')
	SELECT count(1) cnt        
	  FROM PRI_TAA_HDR HDR
		, PRI_TAA_MN MAIN
		, (
		SELECT 
            	CASE 
            		WHEN LENGTH(RT_APLY_DT) > 0     THEN  
	#if (${application_date} != '')
		(select to_date(@[application_date]||'0000','yyyymmddhh24mi') from dual) 
	#else
		RT_APLY_DT
	#end
				#if (${application_date} != '')
					WHEN '1' > 0 THEN 		(select to_date(@[application_date]||'0000','yyyymmddhh24mi') from dual) 
				#end
            		WHEN LENGTH(BKG_CRE_DT) > 0     THEN  BKG_CRE_DT
            		WHEN LENGTH(BKG_CRE_DT) > 0     THEN  BKG_CRE_DT
            		ELSE sysdate
            	END	APPL_DT
            FROM 
	#if (${ca_flg}== 'Y')
			BKG_BKG_HIS  BKG, 
			BKG_RT_HIS  RATE, 
	#else
            BKG_BOOKING  BKG, 
            BKG_RATE  RATE, 
	#end
		(
			SELECT 
		    	BK.BKG_NO, VVD.VSL_CD, VVD.SKD_VOY_NO,
			    VVD.SKD_DIR_CD, VVD.POL_CD, VVD.POL_CLPT_IND_SEQ, 
		    (SELECT VPS_ETD_DT 
		     FROM VSK_VSL_PORT_SKD S2
		     WHERE S2.VSL_CD = VVD.VSL_CD
		       AND S2.SKD_VOY_NO = VVD.SKD_VOY_NO
		       AND S2.SKD_DIR_CD = VVD.SKD_DIR_CD
		       AND S2.VPS_PORT_CD = VVD.POL_CD
		       AND S2.CLPT_IND_SEQ = VVD.POL_CLPT_IND_SEQ) VPS_ETD_DT
			FROM
				#if (${ca_flg}== 'Y')
					BKG_BKG_HIS BK, BKG_VVD_HIS VVD
				#else
					BKG_BOOKING BK, BKG_VVD VVD
				#end
			WHERE BK.BKG_NO = VVD.BKG_NO
			AND BK.POL_CD = VVD.POL_CD
			AND BK.BKG_NO =@[bkg_no]
			#if (${ca_flg}== 'Y')
				AND BK.corr_no 		  = 'TMP0000001'
				AND VVD.corr_no 	  = 'TMP0000001'	
			#end 
		) VVD
			WHERE 
            BKG.BKG_NO=RATE.BKG_NO
			AND BKG.BKG_NO=VVD.BKG_NO(+)
            AND BKG.BKG_NO= @[bkg_no]
	#if (${ca_flg}== 'Y')
			AND BKG.corr_no 		  = 'TMP0000001'
			AND RATE.corr_no 		  = 'TMP0000001'
	#end
		) appl_dt
	 WHERE HDR.TAA_PROP_NO = MAIN.TAA_PROP_NO
	   and MAIN.eff_dt - 0.0001 < APPL_DT.APPL_DT
	   AND MAIN.exp_dt + 0.9999 > APPL_DT.APPL_DT
	   and main.cfm_flg = 'Y'
	   and hdr.TAA_NO = @[taa_no]
#else

SELECT count(1) cnt        
	  FROM PRI_TAA_HDR HDR
		, PRI_TAA_MN MAIN
		, (select case  when appl_dt - ctrt_exp_dt between 0 and 7 then ctrt_exp_dt
                        else appl_dt
                  end appl_dt
           from
              (select appl_dt,
                     (select max(m.exp_dt)
                             from pri_taa_hdr h, pri_taa_mn m
                            where h.taa_no = @[taa_no]
                              and h.taa_prop_no = m.taa_prop_no
                              and m.cfm_flg = 'Y'
                              and appl_dt > m.exp_dt
                              and 'N' = NVL((select 'Y'
                                             from pri_taa_mn
                                             where taa_prop_no = m.taa_prop_no
                                             and appl_dt between eff_dt and exp_dt
                                             and cfm_flg = 'Y'
                                             and rownum = 1
                                             ),'N')
                              ) ctrt_exp_dt
               from 
                  (
#if (${bkg_no} != '') 
                  select 1 rank, RT_APLY_DT appl_dt 
                    from bkg_rt_his r
                   where bkg_no = @[bkg_no]
			         and corr_no = 'TMP0000001'
                     and rt_aply_dt is not null
			      union all
			      select 2 rank, RT_APLY_DT appl_dt --rate applicable
                    from bkg_rate r
                   where bkg_no = @[bkg_no]
                     and rt_aply_dt is not null
                  union all
                  select 3 rank, skd.vps_etd_dt appl_dt --onboard date
                    from bkg_vvd_his vvd, vsk_vsl_port_skd skd, bkg_bkg_his bk
                   where bk.bkg_no          = @[bkg_no] 
			         and bk.corr_no 		  = 'TMP0000001'
			         and vvd.corr_no 		  = 'TMP0000001'
                     and bk.bkg_no          = vvd.bkg_no
                     and vvd.vsl_pre_pst_cd in ('S', 'T')
                     and vvd.pol_cd         = bk.pol_cd
                     and vvd.vsl_cd         = skd.vsl_cd
                     and vvd.skd_voy_no     = skd.skd_voy_no
                     and vvd.skd_dir_cd     = skd.skd_dir_cd
                     and vvd.pol_cd         = skd.vps_port_cd
                     and vvd.pol_CLPT_IND_SEQ = skd.CLPT_IND_SEQ
                  union all
                  select 4 rank, skd.vps_etd_dt appl_dt --onboard date
                    from bkg_vvd vvd, vsk_vsl_port_skd skd, bkg_booking bk
                   where bk.bkg_no          = @[bkg_no] 
                     and bk.bkg_no          = vvd.bkg_no
                     and vvd.vsl_pre_pst_cd in ('S', 'T')
                     and vvd.pol_cd         = bk.pol_cd
                     and vvd.vsl_cd         = skd.vsl_cd
                     and vvd.skd_voy_no     = skd.skd_voy_no
                     and vvd.skd_dir_cd     = skd.skd_dir_cd
                     and vvd.pol_cd         = skd.vps_port_cd
                     and vvd.pol_CLPT_IND_SEQ = skd.CLPT_IND_SEQ
                  union all 
#end
                  select 5 rank, sysdate appl_dt
                    from dual)   
        where rownum = 1)) appl
	 WHERE HDR.TAA_PROP_NO = MAIN.TAA_PROP_NO
	   and MAIN.eff_dt - 0.0001 < APPL.APPL_DT
	   AND MAIN.exp_dt + 0.9999 > APPL.APPL_DT
	   and main.cfm_flg = 'Y'
	   and hdr.TAA_NO = @[taa_no]			
#end			]]></sql>
			<params>
				<param name="application_date" type="12" value="" out="N"/>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="taa_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
