<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="VietnamManifestListDownloadDBDAOSearchCustomsBlInfoRSQL">
			<desc><![CDATA[SearchCustomsBlInfo]]></desc>
			<sql><![CDATA[
SELECT   ----------------------------------------------------------------------------------------------
         --Header  
          NVL(MV.VSL_ENG_NM,'') VSL_NM
         ,NVL(MV.CALL_SGN_NO,'') VSL_CALLSIGN
         ,TO_CHAR(P.VPS_ETD_DT,'YYYYMMDD') ETD
         ,TO_CHAR(P.VPS_ETA_DT,'YYYYMMDD') ETA
         -------------------------------------------------------------------------------------------
         --Grid
         ,ROWNUM SEQ
         ,V.VSL_CD||V.SKD_VOY_NO||V.SKD_DIR_CD VVD
         ,B.BKG_NO
		 ,BKG_SPCLCHAR_CONV_FNC(SUBSTR(CU.CUST_NM, 1, 35),'Y') CUST_NM
         ,C.CNTR_NO
         ,C.CNTR_TPSZ_CD
         ,'Sent' SF        --:,NVL2(BKG_CSTMS_VN_SND_LOG.MF_SND_DT,'Sent','Un-sent') SF  --Success/Fail => --Sent / Un-sent
         ,NVL(B.RCV_TERM_CD||B.DE_TERM_CD,'') RD
#if (${pol_gubun} == '1')
         ,DECODE(B.POL_CD,V.POL_CD,'L','T') LS        --Outbound
#else
         ,DECODE(B.POD_CD,V.POD_CD,'L','T') LS        --Inbound
#end      
         ,B.POR_CD                  B_POR
         ,V.POL_CD                  V_POL
         ,V.POD_CD                  V_POD
         ,SUBSTR(V.POD_YD_CD,6,2)   V_POD_CD
         ,B.DEL_CD                  B_DEL
         ,SUBSTR(B.DEL_NOD_CD,6,2)  B_DEL_CD
         ,C.CNTR_WGT                ACT_WGT
		 ,SUM(CNTR_WGT) OVER (PARTITION BY C.CNTR_NO) ACT_WGT_SUM
         ,C.WGT_UT_CD               WGT_UT_CD
         ,BD.MEAS_QTY                MEAS_QTY
         ,BD.MEAS_UT_CD              MEAS_UT_CD
         ,C.PCK_QTY                 PCK_QTY
         ,C.PCK_TP_CD               PCK_TP_CD
         ,R.FRT_TERM_CD             Freight
         ,B.RD_CGO_FLG               RF

		 ,CASE WHEN B.DCGO_FLG = 'Y' OR B.RC_FLG = 'Y' OR B.AWK_CGO_FLG = 'Y' OR B.BB_CGO_FLG = 'Y' THEN 'Y'
          ELSE 'N' END DG

         ,TO_CHAR(SYSDATE,'YYYY/MM/DD') S_DATE --::,NVL(BKG_CSTMS_VN_SND_LOG.MF_SND_DT,'')    S_DATE
         -------------------------------------------------------------------------------------------
         --Tail:: Y  COUNTING
         ,DECODE(SUBSTR(C.CNTR_TPSZ_CD,2,1),'2','Y','')                    TPSZ_20_CHK   
         ,(CASE WHEN  SUBSTR(C.CNTR_TPSZ_CD,2,1) != '2' THEN 'Y' ELSE '' END) TPSZ_40_CHK
         ,NVL2(C.CNTR_TPSZ_CD,'Y','') TPSZ_TOT_CHK
         -------------------------------------------------------------------------------------------
		 ,NVL(QTY.CNTR_TPSZ_CD,'X') MIS_FLG

FROM      BKG_VVD V
, MDM_VSL_CNTR MV
, VSK_VSL_PORT_SKD P
, BKG_BOOKING B
, BKG_CONTAINER C
, BKG_RATE R
, BKG_CUSTOMER CU
, BKG_QUANTITY QTY
, BKG_BL_DOC BD
WHERE     1 = 1
AND       V.VSL_CD = SUBSTR(@[s_vvd],1,4)                --[vvd]
AND       V.SKD_VOY_NO = SUBSTR(@[s_vvd],5,4)            --[vvd] HNMN0088E
AND       V.SKD_DIR_CD = SUBSTR(@[s_vvd],9,1)            --[vvd]

#if (${pol_gubun} == '1')
AND       V.POL_CD = @[frm_port_cd]        --Mode=Outbound 
#else
AND       V.POD_CD = @[frm_port_cd]        --Mode=Inbound 'VNSGN'
#end 
AND       MV.VSL_CD = V.VSL_CD
AND       P.VSL_CD = V.VSL_CD
AND       P.SKD_VOY_NO = V.SKD_VOY_NO
AND       P.SKD_DIR_CD = V.SKD_DIR_CD

#if (${pol_gubun} == '1')
AND       P.VPS_PORT_CD = V.POL_CD        --Mode=Outbound 
#else
AND       P.VPS_PORT_CD = V.POD_CD        --Mode=Inbound 
#end 
AND       B.BKG_NO = V.BKG_NO
AND       B.BKG_STS_CD <> 'X'
AND       C.BKG_NO = B.BKG_NO
AND       C.BKG_NO = QTY.BKG_NO(+)
AND       C.CNTR_TPSZ_CD = QTY.CNTR_TPSZ_CD(+)
AND       R.BKG_NO(+) = B.BKG_NO
AND       B.BKG_NO = CU.BKG_NO(+)
AND       CU.BKG_CUST_TP_CD(+) = 'C'
AND       BD.BKG_NO = B.BKG_NO
AND       BD.BKG_NO = C.BKG_NO
--Mode=mis_flg
#if (${mis_flg} != '')
AND NVL(QTY.CNTR_TPSZ_CD,'X') = @[mis_flg]
#end			]]></sql>
			<params>
				<param name="s_vvd" type="12" value="" out="N"/>
				<param name="frm_port_cd" type="12" value="" out="N"/>
				<param name="mis_flg" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
