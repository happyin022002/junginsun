<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TCharterIOContractDBDAOCreateBunkerInfoCSQL">
			<desc><![CDATA[Create Bunker Info]]></desc>
			<sql><![CDATA[
MERGE INTO FMS_BUNKER TBL
USING (SELECT FLET_CTRT_NO,
			  'BOD'            AS BNK_TP_CD,
              '33'             AS ACCT_ITM_SEQ,
              ACT_FOIL_BOD_QTY AS BNK_QTY,
              FOIL_BOD_OUT_PRC AS BNK_PRC_AMT,
              BOD_PORT_CD      AS PORT_CD,
              EFF_DT           AS BNK_DT,
              (SELECT VSL_CD||SKD_VOY_NO||SKD_DIR_CD||REV_DIR_CD
               FROM FMS_VVD
               WHERE VSL_CD = A.VSL_CD
               AND TO_CHAR(A.EFF_DT, 'YYYYMMDD') BETWEEN VST_DT AND VED_DT
               AND ROWNUM = 1) VVD_CD
       FROM FMS_CONTRACT A
       WHERE FLET_CTRT_NO = @[flet_ctrt_no]
       AND (ACT_FOIL_BOD_QTY IS NOT NULL OR FOIL_BOD_OUT_PRC IS NOT NULL)
       UNION ALL
       SELECT FLET_CTRT_NO,
			  'BOD'            AS BNK_TP_CD,
              '34'             AS ACCT_ITM_SEQ,
              ACT_DOIL_BOD_QTY AS BNK_QTY,
              DOIL_BOD_OUT_PRC AS BNK_PRC_AMT,
              BOD_PORT_CD      AS PORT_CD,
              EFF_DT           AS BNK_DT,
              (SELECT VSL_CD||SKD_VOY_NO||SKD_DIR_CD||REV_DIR_CD
               FROM FMS_VVD
               WHERE VSL_CD = A.VSL_CD
               AND TO_CHAR(A.EFF_DT, 'YYYYMMDD') BETWEEN VST_DT AND VED_DT
               AND ROWNUM = 1) VVD_CD
       FROM FMS_CONTRACT A
       WHERE FLET_CTRT_NO = @[flet_ctrt_no]
       AND (ACT_DOIL_BOD_QTY IS NOT NULL OR DOIL_BOD_OUT_PRC IS NOT NULL)
       UNION ALL
       SELECT FLET_CTRT_NO,
			  'BOD'                     AS BNK_TP_CD,
              '43'                      AS ACCT_ITM_SEQ,
              ACT_LOW_SULP_FOIL_BOD_QTY AS BNK_QTY,
              LOW_SULP_FOIL_BOD_OUT_PRC AS BNK_PRC_AMT,
              BOD_PORT_CD               AS PORT_CD,
              EFF_DT                    AS BNK_DT,
              (SELECT VSL_CD||SKD_VOY_NO||SKD_DIR_CD||REV_DIR_CD
               FROM FMS_VVD
               WHERE VSL_CD = A.VSL_CD
               AND TO_CHAR(A.EFF_DT, 'YYYYMMDD') BETWEEN VST_DT AND VED_DT
               AND ROWNUM = 1) VVD_CD
       FROM FMS_CONTRACT A
       WHERE FLET_CTRT_NO = @[flet_ctrt_no]
       AND (ACT_LOW_SULP_FOIL_BOD_QTY IS NOT NULL OR LOW_SULP_FOIL_BOD_OUT_PRC IS NOT NULL)
       UNION ALL
       SELECT FLET_CTRT_NO,
			  'BOD'                        AS BNK_TP_CD,
              '70'                         AS ACCT_ITM_SEQ,
              ACT_LOW_SULP_GAS_OIL_BOD_QTY AS BNK_QTY,
              LOW_SULP_GAS_OIL_BOD_OUT_PRC AS BNK_PRC_AMT,
              BOD_PORT_CD                  AS PORT_CD,
              EFF_DT                       AS BNK_DT,
              (SELECT VSL_CD||SKD_VOY_NO||SKD_DIR_CD||REV_DIR_CD
               FROM FMS_VVD
               WHERE VSL_CD = A.VSL_CD
               AND TO_CHAR(A.EFF_DT, 'YYYYMMDD') BETWEEN VST_DT AND VED_DT
               AND ROWNUM = 1) VVD_CD
       FROM FMS_CONTRACT A
       WHERE FLET_CTRT_NO = @[flet_ctrt_no]
       AND (ACT_LOW_SULP_GAS_OIL_BOD_QTY IS NOT NULL OR LOW_SULP_GAS_OIL_BOD_OUT_PRC IS NOT NULL)
       UNION ALL
       SELECT FLET_CTRT_NO,
			  'BOR'            AS BNK_TP_CD,
              '33'             AS ACCT_ITM_SEQ,
              ACT_FOIL_BOR_QTY AS BNK_QTY,
              FOIL_BOR_OUT_PRC AS BNK_PRC_AMT,
              BOR_PORT_CD      AS PORT_CD,
              EXP_DT           AS BNK_DT,
              (SELECT VSL_CD||SKD_VOY_NO||SKD_DIR_CD||REV_DIR_CD
               FROM FMS_VVD
               WHERE VSL_CD = A.VSL_CD
               AND TO_CHAR(A.EXP_DT, 'YYYYMMDD') BETWEEN VST_DT AND VED_DT
               AND ROWNUM = 1) VVD_CD
       FROM FMS_CONTRACT A
       WHERE FLET_CTRT_NO = @[flet_ctrt_no]
       AND (ACT_FOIL_BOR_QTY IS NOT NULL OR FOIL_BOR_OUT_PRC IS NOT NULL)
       UNION ALL
       SELECT FLET_CTRT_NO,
			  'BOR'            AS BNK_TP_CD,
              '34'             AS ACCT_ITM_SEQ,
              ACT_DOIL_BOR_QTY AS BNK_QTY,
              DOIL_BOR_OUT_PRC AS BNK_PRC_AMT,
              BOR_PORT_CD      AS PORT_CD,
              EXP_DT           AS BNK_DT,
              (SELECT VSL_CD||SKD_VOY_NO||SKD_DIR_CD||REV_DIR_CD
               FROM FMS_VVD
               WHERE VSL_CD = A.VSL_CD
               AND TO_CHAR(A.EXP_DT, 'YYYYMMDD') BETWEEN VST_DT AND VED_DT
               AND ROWNUM = 1) VVD_CD
       FROM FMS_CONTRACT A
       WHERE FLET_CTRT_NO = @[flet_ctrt_no]
       AND (ACT_DOIL_BOR_QTY IS NOT NULL OR DOIL_BOR_OUT_PRC IS NOT NULL)
       UNION ALL
       SELECT FLET_CTRT_NO,
			  'BOR'                     AS BNK_TP_CD,
              '43'                      AS ACCT_ITM_SEQ,
              ACT_LOW_SULP_FOIL_BOR_QTY AS BNK_QTY,
              LOW_SULP_FOIL_BOR_OUT_PRC AS BNK_PRC_AMT,
              BOR_PORT_CD               AS PORT_CD,
              EXP_DT                    AS BNK_DT,
              (SELECT VSL_CD||SKD_VOY_NO||SKD_DIR_CD||REV_DIR_CD
               FROM FMS_VVD
               WHERE VSL_CD = A.VSL_CD
               AND TO_CHAR(A.EXP_DT, 'YYYYMMDD') BETWEEN VST_DT AND VED_DT
               AND ROWNUM = 1) VVD_CD
       FROM FMS_CONTRACT A
       WHERE FLET_CTRT_NO = @[flet_ctrt_no]
       AND (ACT_LOW_SULP_FOIL_BOR_QTY IS NOT NULL OR LOW_SULP_FOIL_BOR_OUT_PRC IS NOT NULL)
       UNION ALL
       SELECT FLET_CTRT_NO,
			  'BOR'                        AS BNK_TP_CD,
              '70'                         AS ACCT_ITM_SEQ,
              ACT_LOW_SULP_GAS_OIL_BOR_QTY AS BNK_QTY,
              LOW_SULP_GAS_OIL_BOR_OUT_PRC AS BNK_PRC_AMT,
              BOR_PORT_CD                  AS PORT_CD,
              EXP_DT                       AS BNK_DT,
              (SELECT VSL_CD||SKD_VOY_NO||SKD_DIR_CD||REV_DIR_CD
               FROM FMS_VVD
               WHERE VSL_CD = A.VSL_CD
               AND TO_CHAR(A.EXP_DT, 'YYYYMMDD') BETWEEN VST_DT AND VED_DT
               AND ROWNUM = 1) VVD_CD
       FROM FMS_CONTRACT A
       WHERE FLET_CTRT_NO = @[flet_ctrt_no]
       AND (ACT_LOW_SULP_GAS_OIL_BOR_QTY IS NOT NULL OR LOW_SULP_GAS_OIL_BOR_OUT_PRC IS NOT NULL)
) PSD ON (TBL.FLET_CTRT_NO     = PSD.FLET_CTRT_NO
          AND TBL.BNK_TP_CD    = PSD.BNK_TP_CD
          AND TBL.ACCT_ITM_SEQ = PSD.ACCT_ITM_SEQ)
WHEN MATCHED THEN
UPDATE
  SET TBL.BNK_YRMON   = DECODE(TBL.SLP_TP_CD, '', TO_CHAR(PSD.BNK_DT, 'YYYYMM'), TBL.BNK_YRMON),
      TBL.BNK_DT      = DECODE(TBL.SLP_TP_CD, '', PSD.BNK_DT, TBL.BNK_DT),
      TBL.PORT_CD     = DECODE(TBL.SLP_TP_CD, '', PSD.PORT_CD, TBL.PORT_CD),
      TBL.BNK_QTY     = DECODE(TBL.SLP_TP_CD, '', NVL(PSD.BNK_QTY, 0), TBL.BNK_QTY),
      TBL.BNK_PRC_AMT = DECODE(TBL.SLP_TP_CD, '', NVL(PSD.BNK_PRC_AMT, 0), TBL.BNK_PRC_AMT),
      TBL.BNK_AMT     = DECODE(TBL.SLP_TP_CD, '', NVL(PSD.BNK_QTY, 0) * NVL(PSD.BNK_PRC_AMT, 0), TBL.BNK_AMT),     
      TBL.UPD_USR_ID  = DECODE(TBL.SLP_TP_CD, '', @[usr_id], TBL.UPD_USR_ID),
      TBL.UPD_DT      = DECODE(TBL.SLP_TP_CD, '', SYSDATE, TBL.UPD_DT)              
WHEN NOT MATCHED THEN
INSERT (
      TBL.FLET_CTRT_NO
    , TBL.BNK_SEQ
    , TBL.BNK_YRMON
    , TBL.BNK_TP_CD
    , TBL.ACCT_CD
    , TBL.ACCT_ITM_SEQ
    , TBL.BNK_DT
    , TBL.VSL_CD
    , TBL.SKD_VOY_NO
    , TBL.SKD_DIR_CD
    , TBL.REV_DIR_CD
    , TBL.PORT_CD
    , TBL.FLET_MEAS_UT_CD
    , TBL.BNK_QTY
    , TBL.BNK_PRC_AMT
    , TBL.CRE_USR_ID
    , TBL.CRE_DT
    , TBL.UPD_USR_ID
    , TBL.UPD_DT
    , TBL.BNK_AMT
)
VALUES (
      PSD.FLET_CTRT_NO
    , FMS_BNK_SEQ.NEXTVAL
    , TO_CHAR(PSD.BNK_DT, 'YYYYMM')
    , PSD.BNK_TP_CD
    , (SELECT ACCT_CD
       FROM FMS_ACCT_CATE
       WHERE FLET_ACCT_CATE_CD = 'BU'
       AND ACCT_ITM_SEQ = PSD.ACCT_ITM_SEQ
       AND ROWNUM = 1)
    , PSD.ACCT_ITM_SEQ
    , PSD.BNK_DT
    , '' --SUBSTR(PSD.VVD_CD, 1, 4)
    , '' --SUBSTR(PSD.VVD_CD, 5, 4)
    , '' --SUBSTR(PSD.VVD_CD, 9, 1)
    , '' --SUBSTR(PSD.VVD_CD, 10, 1)
    , PSD.PORT_CD
    , 'M'
    , NVL(PSD.BNK_QTY, 0)
    , NVL(PSD.BNK_PRC_AMT, 0)
    , @[usr_id]
    , SYSDATE
    , @[usr_id]
    , SYSDATE
    , NVL(PSD.BNK_QTY, 0) * NVL(PSD.BNK_PRC_AMT, 0)
)			]]></sql>
			<params>
				<param name="flet_ctrt_no" type="12" value="" out="N"/>
				<param name="usr_id" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
