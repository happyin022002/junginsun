<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TCharterIOInquiryDBDAOSearchRfStatusInquiryByVvdSummaryCellToCellRSQL">
			<desc><![CDATA[VVD로 RF 상태를 요약 조회한다.
(CellToCell값 조회)]]></desc>
			<sql><![CDATA[
WITH SKD AS (
    SELECT S.*,
      P.REP_PORT_CD,
      DECODE(P.CHK_MTY_PLN_FLG, 'Y', 'E', 'F') AS PLANTYPE
    FROM VSK_VSL_PORT_SKD S,
      STO_PLN_VSL_PORT_SKD P
    WHERE S.VSL_CD = SUBSTR(@[vvd], 1, 4)
      AND S.TURN_PORT_IND_CD <> 'V'
      AND S.TURN_PORT_IND_CD <> 'F'
      AND S.TURN_PORT_IND_CD <> 'D'
      AND (S.SKD_CNG_STS_CD IS NULL
          OR S.SKD_CNG_STS_CD <> 'S')
      AND S.VPS_PORT_CD <> 'PAPAC'
      AND S.VPS_PORT_CD <> 'EGSUZ'
      AND S.VSL_CD = P.VSL_CD
      AND S.SKD_VOY_NO = P.SKD_VOY_NO
      AND S.SKD_DIR_CD = P.SKD_DIR_CD
      AND S.VPS_PORT_CD = P.VPS_PORT_CD
      AND S.CLPT_IND_SEQ = P.CLPT_IND_SEQ
      AND (P.CHK_FNL_PLN_FLG = 'Y' OR P.CHK_MTY_PLN_FLG = 'Y')
),
      PRE_SKD AS (
        SELECT *
        FROM (
            SELECT *
            FROM SKD
            WHERE VPS_ETA_DT < (
                SELECT MAX(VPS_ETA_DT)
                FROM SKD
                WHERE SKD_VOY_NO = SUBSTR(@[vvd],5,4)
                  AND SKD_DIR_CD = SUBSTR(@[vvd],9,1)
                  AND VPS_PORT_CD =  @[port]
                  AND CLPT_IND_SEQ = @[indicator])
            ORDER BY VPS_ETA_DT DESC )
        WHERE ROWNUM=1 )    
    SELECT COUNT(A.ID) AS cellToCell
    FROM (
        SELECT ID ,
          BAY ,
          ROWW ,
          TIER ,
          PORT_CD ,
		  CALL_IND
        FROM BAY_PLAN C,
             PRE_SKD D
       WHERE C.VSL_CD = D.VSL_CD
          AND C.VOY_NO = D.SKD_VOY_NO
          AND C.DIR_CD = D.SKD_DIR_CD
          AND C.PORT_CD = D.VPS_PORT_CD
          AND C.CALL_IND = D.CLPT_IND_SEQ
          AND C.PLAN_TYPE = @[preplantype]
          AND TEMP IS NOT NULL) A,
      (
        SELECT *
        FROM BAY_PLAN
        WHERE VSL_CD = SUBSTR(@[vvd],1,4)
          AND VOY_NO = SUBSTR(@[vvd],5,4)
          AND DIR_CD =  SUBSTR(@[vvd],9,1)
          AND PORT_CD =  @[port]
          AND CALL_IND = @[indicator]
          AND PLAN_TYPE = @[preplantype]
          AND POL <> PORT_CD
          AND TEMP IS NOT NULL) B
    WHERE A.ID = B.ID
      AND (A.BAY <> B.BAY
          OR A.ROWW <> B.ROWW
          OR A.TIER <> B.TIER
          OR B.SHIFT_TYPE IS NOT NULL)
    GROUP BY A.PORT_CD, A.CALL_IND			]]></sql>
			<params>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="port" type="12" value="" out="N"/>
				<param name="indicator" type="12" value="" out="N"/>
				<param name="preplantype" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
