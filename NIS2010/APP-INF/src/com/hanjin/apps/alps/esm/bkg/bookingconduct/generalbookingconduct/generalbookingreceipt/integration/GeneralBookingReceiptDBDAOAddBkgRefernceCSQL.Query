<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="GeneralBookingReceiptDBDAOAddBkgRefernceCSQL">
			<desc><![CDATA[reference no 정보를 추가한다]]></desc>
			<sql><![CDATA[
MERGE 
INTO 
#if (${ca_flg}== 'Y')
  BKG_REF_HIS A 
#else
  BKG_REFERENCE A 
#end
  USING (
	SELECT @[bkg_no] AS BKG_NO
			, @[cntr_no] AS CNTR_NO
#if (${bkg_ref_tp_cd}== 'CTPO')
			, 'CTPO' AS BKG_REF_TP_CD
#elseif(${bkg_ref_tp_cd}== 'MSLD')
			, 'MSLD' AS BKG_REF_TP_CD
#else
			, @[bkg_ref_tp_cd] AS BKG_REF_TP_CD
#end
	  FROM DUAL
  ) E 
ON (
	A.BKG_NO = E.BKG_NO
#if (${bkg_ref_tp_cd}== 'CTPO')
	AND A.CNTR_NO = E.CNTR_NO
#elseif (${bkg_ref_tp_cd}== 'MSLD')
	AND A.CNTR_NO = E.CNTR_NO
#end
	AND A.BKG_REF_TP_CD = E.BKG_REF_TP_CD
#if (${ca_flg}== 'Y')
	AND A.CORR_NO = 'TMP0000001'
#end
) 
WHEN MATCHED THEN
	UPDATE 
	SET 
	       CUST_REF_NO_CTNT   = Replace(Replace(@[cust_ref_no_ctnt],CHR(13),''),CHR(10),''),
	       UPD_USR_ID    = @[upd_usr_id],
	       UPD_DT        = sysdate
WHEN NOT MATCHED THEN
	INSERT (
	   BKG_NO,
#if (${ca_flg}== 'Y')
	   CORR_NO,
#end
	   REF_SEQ, 
	   BKG_REF_TP_CD, CUST_REF_NO_CTNT, CNTR_NO, 
	   CNTR_MF_SEQ, CPY_DESC_FLG, CRE_USR_ID, 
	   CRE_DT, UPD_USR_ID, UPD_DT) 
	VALUES ( 
	   @[bkg_no], 
#if (${ca_flg}== 'Y')
		'TMP0000001',
	   NVL((SELECT  NVL(MAX(REF_SEQ),0)+1 AS SEQ FROM BKG_REF_HIS
	    WHERE BKG_NO = @[bkg_no]
		AND CORR_NO = 'TMP0000001'
	   ), 1), 
#else
	   NVL((SELECT  NVL(MAX(REF_SEQ),0)+1 AS SEQ FROM BKG_REFERENCE
	    WHERE BKG_NO = @[bkg_no]
	   ), 1), 
#end
	   @[bkg_ref_tp_cd], Replace(Replace(@[cust_ref_no_ctnt],CHR(13),''),CHR(10),''), @[cntr_no], 
	   @[cntr_mf_seq], @[cpy_desc_flg], @[cre_usr_id], 
	   sysdate, @[upd_usr_id], sysdate
	)			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="cntr_no" type="12" value="" out="N"/>
				<param name="bkg_ref_tp_cd" type="12" value="" out="N"/>
				<param name="cust_ref_no_ctnt" type="12" value="" out="N"/>
				<param name="upd_usr_id" type="12" value="" out="N"/>
				<param name="cntr_mf_seq" type="12" value="" out="N"/>
				<param name="cpy_desc_flg" type="12" value="" out="N"/>
				<param name="cre_usr_id" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
