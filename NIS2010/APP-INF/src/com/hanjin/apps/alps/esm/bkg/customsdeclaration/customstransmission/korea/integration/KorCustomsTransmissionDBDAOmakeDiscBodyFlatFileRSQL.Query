<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="KorCustomsTransmissionDBDAOmakeDiscBodyFlatFileRSQL">
			<desc><![CDATA[BL Flat Buffer Creation]]></desc>
			<sql><![CDATA[
SELECT KT.BKG_NO BKG_NO
     , KT.CSTMS_DECL_TP_CD CSTMS_DECL_TP_CD
     , KT.CSTMS_BL_NO C_BL_NO
     , SUBSTR(
            MAX(TO_CHAR(KT.TRNS_SEQ, '00000') ||
            KT.CSTMS_BL_NO || '~' || /* CBL NO */
            KT.MST_BL_SEQ_NO || '~' || /* MSN */
            KT.BD_AREA_CD || '~' || /* BOND_AREAR_CODE */
            KT.CSTMS_CRR_IN_LOC_WH_CD || '~' || /* CARRY-IN CY CODE*/
            (SELECT SUBSTR(LOC_NM, 1, 50)
             FROM BKG_DCHG_LOC
             WHERE OTR_DCHG_CD = KT.CSTMS_CRR_IN_LOC_WH_CD
             AND (PORT_CD = '*' OR PORT_CD = @[port_cd])
             AND (SKD_DIR_CD = '*' OR SKD_DIR_CD = SUBSTR(@[vvd], 9, 1))
             AND (SLAN_CD = '*' OR SLAN_CD = (SELECT VSL_SLAN_CD
                                              FROM VSK_VSL_SKD
                                              WHERE VSL_CD = SUBSTR(@[vvd], 1, 4)
                                              AND SKD_VOY_NO = SUBSTR(@[vvd], 5, 4)
                                              AND SKD_DIR_CD = SUBSTR(@[vvd], 9, 1)
                                              AND ROWNUM = 1))
             AND ROWNUM = 1
             )|| '~' || /* CARRY-IN CY NAME */
            KT.PCK_QTY || '~' || /* PAKAGE COUNT */
            KT.PCK_TP_CD || '~' || /* PAKAGE UNIT */
            KT.CNTR_TTL_WGT  /* WEIGHT */

        ), 7) BL_DATA
  FROM BKG_CSTMS_KR_BL KT
 WHERE (KT.BKG_NO, KT.CSTMS_DECL_TP_CD, KT.DMST_PORT_CD, KT.TRNS_SEQ)
        IN ( SELECT BKG_NO, CSTMS_DECL_TP_CD, DMST_PORT_CD, MAX(TRNS_SEQ)
               FROM BKG_CSTMS_KR_BL
              WHERE VSL_CD           = SUBSTR(@[vvd], 1, 4)
                AND SKD_VOY_NO       = SUBSTR(@[vvd], 5, 4)
                AND SKD_DIR_CD       = SUBSTR(@[vvd], 9, 1)
                AND DMST_PORT_CD     = @[port_cd]
				#if(${in_type} == 'D')				
   			    AND KR_CSTMS_BND_CD IN ('A','B','C','M')
			    #elseif(${in_type} != 'N')
                AND KR_CSTMS_BND_CD = @[in_type]
			    #else
 			    AND KR_CSTMS_BND_CD IN ('A','N','T','M','R')
  			    #end
                AND DECODE(@[io_bnd_cd],   'I',    CSTMS_DECL_TP_CD,     'I') IN ('I', 'T')
                AND DECODE(@[io_bnd_cd],   'O',    CSTMS_DECL_TP_CD,     'E') IN ('E', 'R')
                AND DECODE(@[io_bnd_cd],   'I',    TS_POD_CD,    TS_POL_CD) 
                    = DECODE(@[io_bnd_cd], 'I', @[pod_cd], @[pol_cd])
              GROUP BY BKG_NO, CSTMS_DECL_TP_CD, DMST_PORT_CD
             HAVING SUBSTR(MAX(TO_CHAR(TRNS_SEQ, '00')||NVL(DELT_FLG, 'N')), 4) != 'Y'
            )
   AND NVL(KT.DELT_FLG,'N') = 'N'
 GROUP BY KT.BKG_NO, KT.CSTMS_DECL_TP_CD, KT.CSTMS_BL_NO
 ORDER BY BKG_NO			]]></sql>
			<params>
				<param name="port_cd" type="12" value="" out="N"/>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="in_type" type="12" value="" out="N"/>
				<param name="io_bnd_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
