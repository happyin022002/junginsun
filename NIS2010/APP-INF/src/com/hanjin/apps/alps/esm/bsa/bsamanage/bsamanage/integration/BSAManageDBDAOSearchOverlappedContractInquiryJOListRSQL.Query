<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BSAManageDBDAOSearchOverlappedContractInquiryJOListRSQL">
			<desc><![CDATA[중복 계약 조회 (JOINT OPERATING)
2015.06.08 김용습 [CHM-201536164] 주간 MAS Open에 따른 타모듈 프로그램 적용 요청]]></desc>
			<sql><![CDATA[
WITH TARGET_AGREE AS
  (
   SELECT DENSE_RANK() OVER(ORDER BY TRD_CD,RLANE_CD,DIR_CD,VOP_CD,VSL_CAPA) AS BSA_GROUP
          , BSA_SEQ
          , TRD_CD
          , RLANE_CD
          , DIR_CD
          , VOP_CD
          , VSL_CAPA
          , VVD_CD
          , BSA_CAPA
          , BSA_FM_DT
          , BSA_TO_DT
          , FNL_HJS_BSA_CAPA
          , HJS_BSA_BFR_SUB_CAPA
          , JO_DESC
          , SPC_OTR_SWAP_FLG
          , OWNR_VSL_WGT
          , UPD_USR_ID
       FROM BSA_JNT_OP_BZC
      WHERE 1=1
        --AND TRD_CD            = 'IAS'
        --AND RLANE_CD          = 'AUSIA'
        AND (TRD_CD ,RLANE_CD ,DIR_CD ,VOP_CD, VSL_CAPA ) 
         IN (   -- 선택된 기간 이후 유효한 계약만 확인 시 체크
                SELECT
                       A.TRD_CD,
                       A.RLANE_CD,
                       A.DIR_CD,
                       B.VOP_CD,
                       DECODE(NVL(B.SUB_TRD_CAPA,0),0,NVL(B.STND_LDB_CAPA,0),NVL(B.SUB_TRD_CAPA,0)) AS VSL_CAPA
                  FROM MAS_MON_VVD A,
                       (
                        SELECT DISTINCT  A.VSL_CD ,
                            A.SUB_TRD_CD ,
                            A.SUB_TRD_CAPA ,
                            A.STND_LDB_CAPA ,
                            A.VOP_CD ,
                           TO_CHAR( A.VSL_APLY_FM_DT ,'YYYYMMDD') VSL_APLY_FOM_DT,
                           TO_CHAR( A.VSL_APLY_TO_DT ,'YYYYMMDD')  VSL_APLY_TO_DT
                      FROM (
                            SELECT X.VSL_CD, Y.SUB_TRD_CD, Y.SUB_TRD_CAPA, X.STND_LDB_CAPA,
                                   X.VOP_CD, X.VSL_APLY_FM_DT VSL_APLY_FM_DT, X.VSL_APLY_TO_DT VSL_APLY_TO_DT
                              FROM MAS_VSL_RGST X,
                                   (
                                    SELECT B.VSL_CD, B.VSL_SEQ, B.SUB_TRD_CD, B.SUB_TRD_CAPA
                                      FROM MDM_SUB_TRD A, MAS_VSL_SUB_TRD_CAPA B
                                     WHERE A.DELT_FLG <> 'Y'
                                       AND A.SUB_TRD_CD      = B.SUB_TRD_CD
                                   ) Y
                             WHERE X.VSL_CD             = Y.VSL_CD(+)
                               AND X.VSL_SEQ            = Y.VSL_SEQ(+)
                               AND NVL(X.DELT_FLG,'N')  = 'N'
                               AND X.VSL_TP_CD          = 'C'
                            ) A
                       ) B
                 WHERE A.VSL_CD            = B.VSL_CD(+)
                   AND A.SUB_TRD_CD        = B.SUB_TRD_CD(+)
                   AND NVL(A.DELT_FLG,'N') <> 'Y' 
                   AND A.TRD_CD            = NVL( NULLIF(@[cobtrade], 'All') , A.TRD_CD)
				   AND A.RLANE_CD 		   = NVL( NULLIF(@[coblane], 'All') , A.RLANE_CD)
                   AND A.DIR_CD            = NVL( NULLIF(@[cobdir], 'All') ,A.DIR_CD)
                   AND TO_CHAR(A.N1ST_LODG_PORT_ETD_DT,'YYYYMMDD') BETWEEN NVL(B.VSL_APLY_FOM_DT ,'19000101') AND NVL(B.VSL_APLY_TO_DT , '99991231')
                   AND TO_CHAR(A.N1ST_LODG_PORT_ETD_DT,'YYYYMMDD') >= NVL( REPLACE(@[txtsdate],'-','') ,'19000101')
                   AND EXISTS (SELECT 'OK'
                                 FROM BSA_JNT_OP_BZC D
                                WHERE D.TRD_CD   = A.TRD_CD
                                  AND D.RLANE_CD = A.RLANE_CD
                                  AND D.DIR_CD   = A.DIR_CD
                                  AND D.VOP_CD   = B.VOP_CD
                                  AND D.VSL_CAPA = DECODE(NVL(B.SUB_TRD_CAPA,0),0,NVL(B.STND_LDB_CAPA,0),NVL(B.SUB_TRD_CAPA,0))
                              )
                     GROUP BY
                           A.TRD_CD,
                           A.RLANE_CD,
                           A.DIR_CD,
                           B.VOP_CD,
                           DECODE(NVL(B.SUB_TRD_CAPA,0),0,NVL(B.STND_LDB_CAPA,0),NVL(B.SUB_TRD_CAPA,0))
                ) 
)

SELECT DISTINCT 
       A2.BSA_GROUP  ,
       A2.BSA_SEQ    ,       
       A2.VVD_CD     ,
       A2.BSA_FM_DT  ,
       A2.BSA_TO_DT  ,       
       A2.TRD_CD     ,
       A2.RLANE_CD   ,
       A2.DIR_CD     ,
       A2.VOP_CD     ,
       A2.VSL_CAPA   ,
       --A2.BSA_CAPA   ,       
       --A2.FNL_HJS_BSA_CAPA    ,
       --A2.HJS_BSA_BFR_SUB_CAPA,
       --A2.JO_DESC    ,
       --A2.SPC_OTR_SWAP_FLG    ,
       --A2.OWNR_VSL_WGT        ,
       DECODE(A2.BSA_FM_DT,A2.BSA_TO_DT,'N',DECODE(LEAST(A2.BSA_FM_DT,A2.BSA_TO_DT),A2.BSA_TO_DT,'Y','N')) AS REVERSE_FLG
  FROM TARGET_AGREE A1,
       TARGET_AGREE A2
 WHERE A1.BSA_GROUP = A2.BSA_GROUP
   AND A1.TRD_CD    = A2.TRD_CD
   AND A1.RLANE_CD  = A2.RLANE_CD
   AND A1.DIR_CD    = A2.DIR_CD
   AND A1.VOP_CD    = A2.VOP_CD
   AND A1.VSL_CAPA  = A2.VSL_CAPA
   AND (A2.BSA_TO_DT BETWEEN A1.BSA_FM_DT AND A1.BSA_TO_DT  
        OR A2.BSA_FM_DT BETWEEN A1.BSA_FM_DT AND A1.BSA_TO_DT)
   AND A1.BSA_SEQ   < A2.BSA_SEQ    
 ORDER BY A2.BSA_GROUP,
       A2.BSA_SEQ ,
       A2.TRD_CD  ,
       A2.RLANE_CD,
       A2.DIR_CD  ,
       A2.VOP_CD  ,
       A2.VSL_CAPA			]]></sql>
			<params>
				<param name="cobtrade" type="12" value="" out="N"/>
				<param name="coblane" type="12" value="" out="N"/>
				<param name="cobdir" type="12" value="" out="N"/>
				<param name="txtsdate" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
