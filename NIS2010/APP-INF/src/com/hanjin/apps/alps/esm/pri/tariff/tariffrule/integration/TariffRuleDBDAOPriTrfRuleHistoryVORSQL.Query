<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TariffRuleDBDAOPriTrfRuleHistoryVORSQL">
			<desc><![CDATA[Tariff Rule History 정보를 조회한다.]]></desc>
			<sql><![CDATA[
WITH MAX_SEQ_RULE AS (
    SELECT TRF_PFX_CD
         , TRF_NO
         , TRF_RULE_NO
         , MAX(AMDT_SEQ) AMDT_SEQ
  	  FROM PRI_TRF_RULE
 	 WHERE TRF_PFX_CD 		= @[trf_pfx_cd]
   	   AND TRF_NO 			= @[trf_no]
   	   AND TRF_RULE_STS_CD 	= 'F' 
#if (${access_dt} != '') 
       AND EFF_DT <= TO_DATE(@[access_dt], 'YYYY-MM-DD')
       AND NVL(EXP_DT, TO_DATE('9999-12-31','YYYY-MM-DD')) >= TO_DATE(@[access_dt], 'YYYY-MM-DD')
#end
 	 GROUP BY TRF_PFX_CD, TRF_NO, TRF_RULE_NO
)


SELECT A.TRF_PFX_CD
     , A.TRF_NO
     , A.TRF_RULE_NO
     , A.AMDT_SEQ
     , A.TRF_RULE_NM
  FROM PRI_TRF_RULE A
     , MAX_SEQ_RULE B
 WHERE A.TRF_PFX_CD     = B.TRF_PFX_CD
   AND A.TRF_NO 	    = B.TRF_NO
   AND A.AMDT_SEQ 	    = B.AMDT_SEQ
   AND A.TRF_RULE_NO 	= B.TRF_RULE_NO
   AND A.TRF_PFX_CD 	= @[trf_pfx_cd]
   AND A.TRF_NO 		= @[trf_no]
   AND A.TRF_RULE_STS_CD = 'F'

#if (${rule_no} != '') 
   AND A.TRF_RULE_NO LIKE UPPER(@[rule_no] || '%')
#end
#if (${rule_nm} != '') 
   AND ( REGEXP_LIKE( A.TRF_RULE_NM , '('||@[rule_nm]||')','i') 
		OR REGEXP_LIKE( A.TRF_RULE_CTNT , '('||@[rule_nm]||')','i')) 
#end 
#if (${access_dt} != '') 
   AND A.EFF_DT <= TO_DATE(@[access_dt], 'YYYY-MM-DD')
   AND NVL(A.EXP_DT, TO_DATE('9999-12-31','YYYY-MM-DD')) >= TO_DATE(@[access_dt], 'YYYY-MM-DD')
#end
 ORDER BY LPAD(DECODE( SIGN(INSTR(A.TRF_RULE_NO,'-')), 1, SUBSTR(A.TRF_RULE_NO,1,INSTR(A.TRF_RULE_NO,'-')-1),A.TRF_RULE_NO),50,' ')
         ,LPAD(DECODE( SIGN(INSTR(A.TRF_RULE_NO,'-')), 1, SUBSTR(A.TRF_RULE_NO,INSTR(A.TRF_RULE_NO,'-')+1,LENGTH(A.TRF_RULE_NO)),0),50,' ')
         ,A.TRF_RULE_NO			]]></sql>
			<params>
				<param name="trf_pfx_cd" type="12" value="" out="N"/>
				<param name="trf_no" type="12" value="" out="N"/>
				<param name="access_dt" type="12" value="" out="N"/>
				<param name="rule_no" type="12" value="" out="N"/>
				<param name="rule_nm" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
