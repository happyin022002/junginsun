<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CargoReleaseOrderDBDAOsearchJapDoHistoryRSQL">
			<desc><![CDATA[Cargo Delivery - DO LIST CHECK REPORT(JAPAN)(UI_BKG-0694)
* History
2012.06.28 김보배 [CHM-201218501] [BKG] Japan Cargo Release Performance에 DOR I/F 처리 결과에 대한 표시 컬럼 추가 요청]]></desc>
			<sql><![CDATA[
/* 이 Query는 bkg_do_dtl의 rlse_sts_cd I값이 각 bkg_no별로 1건을 초과하여 발생할 수 없다는 가정하에서 작성되었다. 아닐 경우 데이터 등록 Application의 오류로 한다.20091228 */
SELECT RSLT.BKG_NO
     , RSLT.VVD
     , RSLT.VSL_CD
     , RSLT.SKD_VOY_NO
     , RSLT.SKD_DIR_CD
     , RSLT.POD_CD
     , RSLT.DEL_CD
     , RSLT.EVNT_OFC_CD
     , RSLT.BL_NO
     , NVL(RSLT.JP_DO_ID, RSLT.DO_NO) AS DO_NO
     , DECODE(JP_DO_SND_STS_CD,'R','Y','S','Y','N') AS DOR_IF
     , RSLT.EVNT_DT
     , RSLT.EVNT_USR_ID
     , RSLT.DO_RMK
     , REPLACE(CCST.CUST_NM, CHR(13) || CHR(10), ' ') AS CN_NM
     , REPLACE(NCST.CUST_NM, CHR(13) || CHR(10), ' ') AS NF_NM
     , RSLT.DO_RSN_RMK
     , RSLT.CGO_RMK
     , ROW_COUNT
     , RSLT.RLSE_SEQ

     /* OBL_RDEM_FLG */
     , ( SELECT DECODE(BKGM.BL_TP_CD ,'W','Y' ,DECODE( BISS.OBL_SRND_FLG ,'Y','Y', DECODE(BISS.OBL_RDEM_FLG,'Y','Y','N')))
         FROM BKG_BOOKING BKGM
              LEFT OUTER JOIN BKG_BL_ISS BISS
             ON ( BISS.BKG_NO = BKGM.BKG_NO )   
        WHERE BKGM.BKG_NO = RSLT.BKG_NO   
     ) AS OBL_RDEM_FLG
     
    ,/* ESM_BKG_0326  Event_flg */
    (SELECT  DO_HLD_FLG  /* Y 이면 event_flg R */
      FROM BKG_DO_REF 
     WHERE BKG_NO = RSLT.BKG_NO   
     ) AS DO_HLD_FLG
     
    ,/* full_mty_cd */
    (SELECT DECODE(BJBL.FULL_MTY_CD ,'F','FULL','EMPTY' ) AS FULL_MTY_CD
       FROM BKG_CSTMS_JP_BL BJBL
      WHERE BJBL.BL_NO = RSLT.BL_NO
        AND ROWNUM = 1
    ) AS FULL_MTY_CD
FROM(
    SELECT INQR.BKG_NO
         , INQR.VSL_CD
         , INQR.SKD_VOY_NO
         , INQR.SKD_DIR_CD
         , INQR.VSL_CD || INQR.SKD_VOY_NO || INQR.SKD_DIR_CD AS VVD
         , INQR.POD_CD
         , INQR.DEL_CD
         , INQR.BL_NO
         , INQR.EVNT_OFC_CD 								 AS EVNT_OFC_CD
         , INQR.DO_NO 										 AS DO_NO
         , INQR.DO_NO_SPLIT 								 AS DO_NO_SPLIT
         , INQR.JP_DO_ID    								 AS JP_DO_ID
         , INQR.JP_DO_SND_STS_CD    						 AS JP_DO_SND_STS_CD         
         , INQR.DO_RMK      								 AS DO_RMK
         , TO_CHAR(INQR.EVNT_DT, 'YYYY-MM-DD')  			 AS EVNT_DT
         , INQR.EVNT_USR_ID 								 AS EVNT_USR_ID
         , DECODE(TRIM(INQR.DO_RSN_RMK), NULL, 'No', 'Yes')  AS DO_RSN_RMK    -- IBSheet Grid 버그 및 제약사항으로 해당과 같이 처리
         , INQR.DO_RSN_RMK                					 AS CGO_RMK    -- IBSheet Grid 버그 및 제약사항으로 해당과 같이 처리
         , COUNT(1) OVER () ROW_COUNT
         , ROW_NUMBER() OVER (ORDER BY DECODE(INQR.EVNT_DT, NULL, 1, 0), INQR.EVNT_DT DESC,  INQR.BL_NO) AS ROW_NUM
		 , INQR.RLSE_SEQ
    FROM (
          SELECT BKGM.BKG_NO
               , BVVD.VSL_CD
               , BVVD.SKD_VOY_NO
               , BVVD.SKD_DIR_CD
               , BKGM.POD_CD
               , BKGM.DEL_CD
               , BKGM.BL_NO
               , BKDO.RLSE_SEQ
               , NVL( DOTL.RLSE_STS_CD, 'N') AS RLSE_STS_CD  -- I or N
               , BKDO.DO_PRN_RMK  AS DO_RMK
               , BKDO.CGOR_RMK    AS DO_RSN_RMK
               , BKDO.DO_NO
               , BKDO.DO_NO_SPLIT
               , BKDO.JP_DO_ID
               , NVL(BKDO.JP_DO_SND_STS_CD,'X') AS JP_DO_SND_STS_CD
               , DOTL.EVNT_DT
               , DOTL.EVNT_USR_ID
               , DOTL.EVNT_OFC_CD
            FROM BKG_VVD BVVD
               , BKG_BOOKING BKGM
               , BKG_DO BKDO
               , BKG_DO_DTL DOTL
           WHERE BVVD.VSL_PRE_PST_CD IN ('T', 'U')
             AND BKGM.BKG_NO = BVVD.BKG_NO
             AND BKGM.POD_CD = BVVD.POD_CD
             AND NVL(BKGM.BKG_STS_CD, ' ') <> 'X' -- Canceled BL 제거 (20100526)
#if (${rd_flag} == 'F')
             AND BVVD.VSL_CD      = @[vsl_cd]  -- VVD
             AND BVVD.SKD_VOY_NO  = @[skd_voy_no]
             AND BVVD.SKD_DIR_CD  = @[skd_dir_cd]
             AND BVVD.POD_CD      = @[pod_cd]
             AND BKDO.BKG_NO(+)   = BKGM.BKG_NO
             AND DOTL.BKG_NO(+)   = BKDO.BKG_NO
             AND DOTL.RLSE_SEQ(+) = BKDO.RLSE_SEQ
         --    AND DOTL.RLSE_STS_CD(+) = 'I'
#elseif (${rd_flag} == 'S')
             AND DOTL.EVNT_OFC_CD = @[evnt_ofc_cd]  -- Event Date
             AND DOTL.EVNT_DT BETWEEN TO_DATE(@[evnt_dt_start], 'YYYYMMDD') 
                              AND (TO_DATE (@[evnt_dt_end], 'YYYYMMDD') + 1)
             AND DOTL.RLSE_STS_CD = 'I'             
             AND BKDO.BKG_NO      = DOTL.BKG_NO
             AND BKDO.RLSE_SEQ    = DOTL.RLSE_SEQ
             AND BKGM.BKG_NO      = BKDO.BKG_NO
#end

#if (${dor_if} == 'Y')
			AND  DECODE(NVL(BKDO.JP_DO_SND_STS_CD,'X'),'R','Y','S','Y','N') = 'Y'  /* DOR_IF */
#elseif (${dor_if} == 'N')
			AND  DECODE(NVL(BKDO.JP_DO_SND_STS_CD,'X'),'R','Y','S','Y','N') = 'N'  /* DOR_IF */
#end

         ) INQR
   WHERE 1 = 1
#if (${rd_flag} == 'F' && ${rlse_sts_cd} != '*')
     AND INQR.RLSE_STS_CD = DECODE ('${rlse_sts_cd}', 'Y', 'I', 'N')    
#end
#if (${rd_flag} == 'F' && ${rlse_sts_cd} == '*')
     AND INQR.RLSE_STS_CD NOT IN ('C','D')    -- D/O Cancel된 대상은 조회 결과에서 제외 (2010.05.25 손영주 과장 요청)
#end
   ORDER BY DECODE(INQR.EVNT_DT, NULL, 1, 0)
          , INQR.EVNT_DT DESC
          ,  INQR.BL_NO
    ) RSLT
    , BKG_CUSTOMER CCST
    , BKG_CUSTOMER NCST
WHERE ROW_NUM > (TO_NUMBER(@[page_no]) -1) * TO_NUMBER(@[pagerows] )
  AND ROW_NUM <=  TO_NUMBER(@[page_no]) * TO_NUMBER(@[pagerows]  )
  AND CCST.BKG_NO = RSLT.BKG_NO
  AND CCST.BKG_CUST_TP_CD = 'C'
  AND NCST.BKG_NO = RSLT.BKG_NO
  AND NCST.BKG_CUST_TP_CD = 'N'
ORDER BY DOR_IF ,VVD,POD_CD,EVNT_DT,EVNT_OFC_CD
-- map JapDoHisSearchVO			]]></sql>
			<params>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="evnt_ofc_cd" type="12" value="" out="N"/>
				<param name="evnt_dt_start" type="12" value="" out="N"/>
				<param name="evnt_dt_end" type="12" value="" out="N"/>
				<param name="page_no" type="12" value="" out="N"/>
				<param name="pagerows" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
