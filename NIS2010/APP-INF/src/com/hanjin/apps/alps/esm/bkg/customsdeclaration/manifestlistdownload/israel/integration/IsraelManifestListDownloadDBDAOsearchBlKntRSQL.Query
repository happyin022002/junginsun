<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="IsraelManifestListDownloadDBDAOsearchBlKntRSQL">
			<desc><![CDATA[TS type 별 BL count 구하기]]></desc>
			<sql><![CDATA[
SELECT SUM(DECODE(SUM_LOCAL,0,0,1)) LOCL_BL
     , SUM(DECODE(SUM_TS,0,0,1)) TS_BL
     , COUNT(*) TTL_BL
FROM (
     SELECT DT_SEQ
          , SUM(LOCAL_CNT) SUM_LOCAL
          , SUM(TS_CNT) SUM_TS
     FROM (
           SELECT DENSE_RANK() OVER (ORDER BY BV.POD_CD, BB.BL_NO) AS DT_SEQ
                , DECODE(BB.POL_CD, BV.POL_CD, 1, 0)  AS LOCAL_CNT
                , DECODE(BB.POL_CD, BV.POL_CD, 0, 1) AS TS_CNT
           FROM BKG_BOOKING BB
                , BKG_VVD BV
                , BKG_CUSTOMER SHPR
                , BKG_CUSTOMER CNEE
                , BKG_CUSTOMER NTFY
                , VSK_VSL_PORT_SKD SKD1
                , VSK_VSL_PORT_SKD SKD2
                , VSK_VSL_PORT_SKD SKD3
                , MDM_VSL_CNTR B
                , BKG_CONTAINER BC 
        
            WHERE BB.BKG_NO = BV.BKG_NO
            AND BB.BKG_NO = BC.BKG_NO
        
            AND BB.BKG_NO = SHPR.BKG_NO (+)
            AND SHPR.BKG_CUST_TP_CD(+) = 'S'
            AND BB.BKG_NO = CNEE.BKG_NO (+)
            AND CNEE.BKG_CUST_TP_CD(+) = 'C'
            AND BB.BKG_NO = NTFY.BKG_NO (+)
            AND NTFY.BKG_CUST_TP_CD(+) = 'N'
        
            AND SKD1.VSL_CD        = B.VSL_CD
            AND SKD1.VSL_CD        =  BV.VSL_CD
            AND SKD1.SKD_VOY_NO    =  BV.SKD_VOY_NO
            AND SKD1.SKD_DIR_CD    =  BV.SKD_DIR_CD 
            AND SKD1.VPS_PORT_CD   =  BV.POL_CD
            AND NVL(SKD1.SKD_CNG_STS_CD, ' ')    <> 'S'
            AND SKD1.CLPT_IND_SEQ = BV.POL_CLPT_IND_SEQ
            
            AND SKD2.VSL_CD        = BV.VSL_CD
            AND SKD2.SKD_VOY_NO    = BV.SKD_VOY_NO
            AND SKD2.SKD_DIR_CD    = BV.SKD_DIR_CD
            AND SKD2.CLPT_IND_SEQ  = 1
            AND SKD2.VPS_PORT_CD LIKE 'IL%'
             
            AND SKD1.CLPT_SEQ < SKD2.CLPT_SEQ
        
            AND BV.VSL_CD         = SKD3.VSL_CD
            AND BV.SKD_VOY_NO     = SKD3.SKD_VOY_NO
            AND BV.SKD_DIR_CD     = SKD3.SKD_DIR_CD
            AND BV.POD_CD         = SKD3.VPS_PORT_CD
            AND BV.POD_CLPT_IND_SEQ = SKD3.CLPT_IND_SEQ
             
            AND SKD2.CLPT_SEQ  < SKD3.CLPT_SEQ
        
            AND BV.VSL_CD		= SUBSTR(@[vvd_cd], 1, 4)   
            AND BV.SKD_VOY_NO	= SUBSTR(@[vvd_cd], 5, 4)   
            AND BV.SKD_DIR_CD	= SUBSTR(@[vvd_cd], 9, 1)
            #if (${pol_cd} != '') 
            AND SKD1.VPS_PORT_CD = @[pol_cd]
            #end
   
            #if (${pod_cd} != '') 
            AND BV.POD_CD		= @[pod_cd]
            #end

            #if (${bl_no} != '') 
            AND BB.BL_NO		= @[bl_no]
            #end
    
            AND BB.BKG_STS_CD NOT IN ('X', 'S')
			AND BB.BKG_CGO_TP_CD NOT IN ('P')
            )
     GROUP BY DT_SEQ
     ORDER BY DT_SEQ
)			]]></sql>
			<params>
				<param name="vvd_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
