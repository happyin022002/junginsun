<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TCharterIOInvoiceDBDAOSearchFrgnExchangeTransactionListRSQL">
			<desc><![CDATA[FRGN Exchange Transaction(O/A0) 정보를 조회를 합니다.]]></desc>
			<sql><![CDATA[
SELECT A.*
FROM 
(
SELECT A.SLP_OFC_CD,
       A.SLP_TP_CD||A.SLP_FUNC_CD||A.SLP_OFC_CD||A.SLP_ISS_DT||A.SLP_SER_NO||A.SLP_SEQ_NO CSR_NO,
       A.EFF_DT,
       A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD||A.REV_DIR_CD VVD,
       A.AP_DESC,
       A.N2ND_CURR_CD CURR,
       A.N2ND_AMT AMT,
       A.N1ST_AMT USD_AMT,
       A.PAIR_SLP_TP_CD||A.PAIR_SLP_FUNC_CD||A.PAIR_SLP_OFC_CD||A.PAIR_SLP_ISS_DT||A.PAIR_SLP_SER_NO||A.PAIR_SLP_SEQ_NO MATCH_CSR_NO,
       (SELECT P.EFF_DT
             FROM FMS_OWNR_ACCT_SLP P
             WHERE 1 = 1
               AND A.PAIR_SLP_TP_CD = P.SLP_TP_CD
               AND A.PAIR_SLP_FUNC_CD = P.SLP_FUNC_CD
               AND A.PAIR_SLP_OFC_CD = P.SLP_OFC_CD
               AND A.PAIR_SLP_ISS_DT = P.SLP_ISS_DT
               AND A.PAIR_SLP_SER_NO = P.SLP_SER_NO
               AND A.PAIR_SLP_SEQ_NO = P.SLP_SEQ_NO) GL_DATE,  --MATCHING_CSR_NO GL DATE
          
       (SELECT P.N1ST_AMT
        FROM FMS_OWNR_ACCT_SLP P
             WHERE 1 = 1
               AND A.PAIR_SLP_TP_CD = P.SLP_TP_CD
               AND A.PAIR_SLP_FUNC_CD = P.SLP_FUNC_CD
               AND A.PAIR_SLP_OFC_CD = P.SLP_OFC_CD
               AND A.PAIR_SLP_ISS_DT = P.SLP_ISS_DT
               AND A.PAIR_SLP_SER_NO = P.SLP_SER_NO
               AND A.PAIR_SLP_SEQ_NO = P.SLP_SEQ_NO) MATCH_CSR_USD_AMT,
          
       ABS(A.N1ST_AMT) -    
       ABS((SELECT P.N1ST_AMT
        FROM FMS_OWNR_ACCT_SLP P
             WHERE 1 = 1
               AND A.PAIR_SLP_TP_CD = P.SLP_TP_CD
               AND A.PAIR_SLP_FUNC_CD = P.SLP_FUNC_CD
               AND A.PAIR_SLP_OFC_CD = P.SLP_OFC_CD
               AND A.PAIR_SLP_ISS_DT = P.SLP_ISS_DT
               AND A.PAIR_SLP_SER_NO = P.SLP_SER_NO
               AND A.PAIR_SLP_SEQ_NO = P.SLP_SEQ_NO)) LOCL_XCH_RT_AMT,  -- EX.DIFF

         -- Transaction CSR No (환차손 전표가 있는 경우)
       (SELECT D.SLP_TP_CD||D.SLP_FUNC_CD||D.SLP_OFC_CD||D.SLP_ISS_DT||D.SLP_SER_NO
                   FROM FMS_CSUL_SLP D
                  WHERE 1 = 1
                    AND D.ORG_SLP_TP_CD = A.SLP_TP_CD
                    AND D.ORG_SLP_FUNC_CD = A.SLP_FUNC_CD
                    AND D.ORG_SLP_OFC_CD = A.SLP_OFC_CD
                    AND D.ORG_ISS_DT = A.SLP_ISS_DT 
                    AND D.ORG_SLP_SER_NO = A.SLP_SER_NO
                    AND D.ORG_SLP_SEQ_NO = A.SLP_SEQ_NO
                    AND D.FLET_SRC_TP_CD = '90'
                    AND ROWNUM = 1) transaction_csr_no,

        -- 전표 Detail 정보 조회  / FMS_CSUL_SLP 테이블 ORG..시작 전표 조회
         A.SLP_TP_CD||A.SLP_FUNC_CD||A.SLP_OFC_CD||A.SLP_ISS_DT||A.SLP_SER_NO||A.SLP_SEQ_NO ORI1_CSR_NO,
         A.PAIR_SLP_TP_CD||A.PAIR_SLP_FUNC_CD||A.PAIR_SLP_OFC_CD||A.PAIR_SLP_ISS_DT||A.PAIR_SLP_SER_NO||A.PAIR_SLP_SEQ_NO ORI2_CSR_NO,

       (SELECT COUNT(F.ATCH_FILE_OA_LNK_ID) CNT
        FROM FMS_OWNR_ACCT_ATCH_FILE F
        WHERE 1=1
          AND A.SLP_TP_CD||A.SLP_FUNC_CD||A.SLP_OFC_CD||A.SLP_ISS_DT||A.SLP_SER_NO||A.SLP_SEQ_NO = F.ATCH_FILE_OA_LNK_ID
        ) ATCH_FILE_FLET_KNT,

      (SELECT /*+INDEX_DESC(F XPKFMS_ATCH_FILE) */
       	       F.ATCH_FILE_OA_LNK_ID
  	   	FROM FMS_OWNR_ACCT_ATCH_FILE F
        WHERE 1=1
          AND A.SLP_TP_CD||A.SLP_FUNC_CD||A.SLP_OFC_CD||A.SLP_ISS_DT||A.SLP_SER_NO||A.SLP_SEQ_NO = F.ATCH_FILE_OA_LNK_ID
          AND ROWNUM = 1
       ) ATTACH_LINK

FROM FMS_OWNR_ACCT_SLP A
WHERE 1 = 1
  #if(${vsl_cd} != '')
   AND A.VSL_CD = @[vsl_cd]
  #end
  #if(${origin_csr_no} != '')
   AND @[origin_csr_no] = A.SLP_TP_CD||A.SLP_FUNC_CD||A.SLP_OFC_CD||A.SLP_ISS_DT||A.SLP_SER_NO
  #end

  AND A.OA_STL_STS_CD = 'CN'
  AND A.N1ST_AMT > 0
  AND TO_CHAR(A.UPD_DT, 'YYYYMM') BETWEEN REPLACE (@[from_eff_dt],'-','')  AND REPLACE (@[to_eff_dt],'-','') 

  #if(${match_csr_no} != '')
  AND @[match_csr_no] = A.PAIR_SLP_TP_CD||A.PAIR_SLP_FUNC_CD||A.PAIR_SLP_OFC_CD||A.PAIR_SLP_ISS_DT||A.PAIR_SLP_SER_NO
  #end
  #if(${transact_cd} == 'N')
    -- 조건 Transaction = No
  AND 'N' = (SELECT DECODE(COUNT(D.SLP_TP_CD), 1, 'Y', 'N')
                   FROM FMS_CSUL_SLP D
                  WHERE 1 = 1
                    AND D.ORG_SLP_TP_CD = A.SLP_TP_CD
                    AND D.ORG_SLP_FUNC_CD = A.SLP_FUNC_CD
                    AND D.ORG_SLP_OFC_CD = A.SLP_OFC_CD
                    AND D.ORG_ISS_DT = A.SLP_ISS_DT 
                    AND D.ORG_SLP_SER_NO = A.SLP_SER_NO
                    AND D.ORG_SLP_SEQ_NO = A.SLP_SEQ_NO
                    AND D.FLET_SRC_TP_CD = '90'
                    AND ROWNUM = 1)       
  #end
  #if(${transact_cd} == 'Y')
    -- 조건 Transaction = YES
   AND 'Y' = (SELECT DECODE(COUNT(D.SLP_TP_CD), 1, 'Y', 'N')
              FROM FMS_CSUL_SLP D
              WHERE 1 = 1
              AND D.ORG_SLP_TP_CD = A.SLP_TP_CD
              AND D.ORG_SLP_FUNC_CD = A.SLP_FUNC_CD
              AND D.ORG_SLP_OFC_CD = A.SLP_OFC_CD
              AND D.ORG_ISS_DT = A.SLP_ISS_DT 
              AND D.ORG_SLP_SER_NO = A.SLP_SER_NO
              AND D.ORG_SLP_SEQ_NO = A.SLP_SEQ_NO
              AND D.FLET_SRC_TP_CD = '90'
              AND ROWNUM = 1)  
  #end
) A
#if(${transact_cd} == 'N')
WHERE ABS(A.USD_AMT) <> ABS(MATCH_CSR_USD_AMT)
#end			]]></sql>
			<params>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="origin_csr_no" type="12" value="" out="N"/>
				<param name="from_eff_dt" type="12" value="" out="N"/>
				<param name="to_eff_dt" type="12" value="" out="N"/>
				<param name="match_csr_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
