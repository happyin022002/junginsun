<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="PickUpNoticeDBDAOsearchPkupNoMnlUpldListRSQL">
			<desc><![CDATA[Pickup No를 수동으로 업로드 하 기 위해 조회]]></desc>
			<sql><![CDATA[
-- PkupNoMnlUpldVO 생성
SELECT 
        A.CHK_YN
       ,A.BKG_NO 
       ,A.BL_NO
       ,A.CNTR_PRT_FLG
       ,A.CNTR_NO
       ,A.CNTR_TPSZ_CD
       ,A.EQ_CTRL_OFC_CD
       ,A.FRT_CLT_FLG
       ,A.OBL_RDEM_FLG
       ,A.CSTMS_CLR_CD
       ,A.POD_CD
       ,A.IBD_TRSP_HUB_CD
       ,A.DEL_CD
       ,A.USA_CSTMS_FILE_CD
       ,A.DE_TERM_CD
       ,A.EQ_TPSZ_CD
       ,A.TO_NOD_CD
       ,A.ROUTE_GUIDE
       ,A.RAIL_MOVE
       ,A.TRUCK_MOVE
       ,A.ATA_DT
       ,A.VSL_CD
       ,A.SKD_VOY_NO
       ,A.SKD_DIR_CD
       ,A.VVD
       ,A.RAIL_ARR_DT
       ,A.PKUP_AVAL_DT
       ,A.LST_FREE_DT
       ,A.PKUP_NO
       ,A.PKUP_YD_CD
       ,A.PKUP_CRE_DT
       ,A.PKUP_UPD_DT
       ,A.EQ_CTRL_OFC_CD AS OFC_CD
       ,A.PKUP_CRE_USR_ID
       ,A.PKUP_UPD_USR_ID
       ,A.PKUP_NTC_SND_KNT
       ,NVL((SELECT DISTINCT 'Y' FROM BKG_PKUP_NTC T WHERE T.BKG_NO=A.BKG_NO AND T.CNTR_NO=A.CNTR_NO AND T.PKUP_NTC_SND_STS_CD='Y'),'N') AS PKUP_NTC_SND_YN
       ,A.RAIL_DEP_DT
       ,A.DELT_FLG       
       ,A.RTN_YD_CD
       ,A.ROW_COUNT
FROM   (
        SELECT 
               '' AS CHK_YN
               ,A.BKG_NO
               ,A.BL_NO
			   ,A.CNTR_PRT_FLG
               ,A.CNTR_NO
               ,A.CNTR_TPSZ_CD
               ,A.EQ_CTRL_OFC_CD
               ,A.FRT_CLT_FLG
               ,A.OBL_RDEM_FLG
               ,A.CSTMS_CLR_CD
               ,A.POD_CD
               ,A.IBD_TRSP_HUB_CD
               ,A.DEL_CD
               ,A.USA_CSTMS_FILE_CD
               ,A.DE_TERM_CD
               ,A.EQ_TPSZ_CD
               ,A.TO_NOD_CD
               ,A.ROUTE_GUIDE
               ,A.RAIL_MOVE
               ,A.TRUCK_MOVE
               ,A.ATA_DT
               ,A.VSL_CD
               ,A.SKD_VOY_NO
               ,A.SKD_DIR_CD
               ,A.VVD
               ,A.RAIL_ARR_DT
               ,F.PKUP_AVAL_DT
               ,F.LST_FREE_DT
               ,F.PKUP_NO
               ,F.PKUP_YD_CD
               ,F.PKUP_CRE_DT
               ,F.PKUP_UPD_DT
               ,A.EQ_CTRL_OFC_CD AS OFC_CD
               ,DECODE(F.PKUP_CRE_USR_ID,'BAT_BKG_019','EDI',F.PKUP_CRE_USR_ID) AS PKUP_CRE_USR_ID
               ,DECODE(F.PKUP_UPD_USR_ID,'BAT_BKG_019','EDI',F.PKUP_UPD_USR_ID) AS PKUP_UPD_USR_ID
               ,NVL(F.PKUP_NTC_SND_KNT, 0) AS PKUP_NTC_SND_KNT
               ,F.RAIL_DEP_DT
               ,NVL(F.DELT_FLG,'N') AS DELT_FLG       
               ,NVL(F.RTN_YD_CD,(SELECT 
                                        CASE WHEN MAX(SUBSTR(A.EQ_TPSZ_CD,1,1)) = 'R' THEN SUBSTR(MAX(LPAD(LENGTH(RTN.PKUP_YD_ID||RTN.PKUP_CNTR_TP_ID),2,'0')||RTN.MCNTR_RTN_YD_CD),3)
                                             ELSE SUBSTR(MAX(LPAD(
                                                                  LENGTH(RTN.PKUP_YD_ID)+DECODE(RTN.PKUP_CNTR_TP_ID,'RF',-5,LENGTH(RTN.PKUP_CNTR_TP_ID)),
                                                                  2,'0')||RTN.MCNTR_RTN_YD_CD),3)
                                        END
                                   FROM BKG_PKUP_CNTR_RTN_YD RTN
                                  WHERE A.POD_CD = RTN.POD_CD
                                    AND A.DEL_CD = RTN.FNL_DEST_CD
                                    AND A.TO_NOD_CD LIKE RTN.PKUP_YD_ID||'%'
                                    AND RTN.DELT_FLG = 'N'))
                AS RTN_YD_CD
#if(${fileup} == 'Y')
               ,0 ROW_NUM
               ,0 ROW_COUNT
#else          
  #if (${excel_flg} != 'Y')
               ,ROW_NUMBER() OVER (ORDER BY A.BKG_NO, A.CNTR_NO) ROW_NUM
               ,COUNT(1) OVER () ROW_COUNT
  #else          
               ,0 ROW_NUM
               ,0 ROW_COUNT
  #end
#end
           FROM (         
                 SELECT          
                        A.BKG_NO
                       ,A.BL_NO AS BL_NO
                       ,DECODE(NVL(E.CNTR_VOL_QTY,0),1,'N','Y') AS CNTR_PRT_FLG
                       ,A.EQ_NO AS CNTR_NO
                       ,E.CNTR_TPSZ_CD
					   ,DECODE(SUBSTR(D.DEL_CD,1,2),'US','PHXSA',H.EQ_CTRL_OFC_CD) EQ_CTRL_OFC_CD 
                       ,G.FRT_CLT_FLG
                       ,G.OBL_RDEM_FLG
                       ,(CASE WHEN SUBSTR(D.DEL_CD,1,2) = 'CA' THEN 'Y' --CA 인 경우 'Y' 로 고정
							  WHEN SUBSTR(D.POD_CD,1,2) = 'CA' THEN                  
                                   (SELECT SUBSTR(MAX(LPAD(CSTMS_SEQ,12,'0')||CSTMS_CLR_CD),-1)
                                      FROM BKG_CSTMS_ADV_CNTR_RSLT CN_RSLT
                                     WHERE CNT_CD  = 'US'
                                       AND BL_NO   = D.BL_NO
                                       AND CN_RSLT.CNTR_NO LIKE SUBSTR(E.CNTR_NO,1,LENGTH(E.CNTR_NO)-1)||'%')
                              ELSE NVL(G.CSTMS_CLR_CD,'N')
                         END) AS CSTMS_CLR_CD
                       ,A.POD_CD
                       ,I.HUB_LOC_CD AS IBD_TRSP_HUB_CD
                       ,A.DEL_CD
                       ,D.USA_CSTMS_FILE_CD
                       ,D.DE_TERM_CD
                       ,A.EQ_TPSZ_CD
                       ,A.TO_NOD_CD
                       ,A.POD_CD || ' - Rail - ' || SUBSTR(A.TO_NOD_CD, 1, 5) || CASE WHEN SUBSTR(A.TO_NOD_CD, 1, 5) <> A.DEL_CD THEN ' - Truck(DR) - ' || A.DEL_CD END AS ROUTE_GUIDE
                       ,A.POD_CD || ' -> ' || SUBSTR(A.TO_NOD_CD, 1, 5) AS RAIL_MOVE
                       ,CASE WHEN SUBSTR(A.TO_NOD_CD, 1, 5) <> A.DEL_CD THEN SUBSTR(A.TO_NOD_CD, 1, 5) || ' -> ' || A.DEL_CD END AS TRUCK_MOVE
                       ,B.VPS_ETA_DT AS ATA_DT
                       ,A.VSL_CD
                       ,A.SKD_VOY_NO
                       ,A.SKD_DIR_CD
                       ,A.VSL_CD || A.SKD_VOY_NO || A.SKD_DIR_CD AS VVD
                       ,A.ARR_DT AS RAIL_ARR_DT
                       ,ROW_NUMBER() OVER(PARTITION BY A.BKG_NO, A.EQ_NO ORDER BY A.WO_ISS_DT DESC NULLS LAST) R_ORD
                   FROM TRS_TRSP_RAIL_BIL_ORD A
                       ,VSK_VSL_PORT_SKD      B
                       ,MDM_LOCATION          C
                       ,BKG_BOOKING           D
                       ,BKG_CONTAINER         E
                       ,BKG_CGO_RLSE          G
                       ,MDM_LOCATION          H
                       ,BKG_CSTMS_ADV_BL      I
                  WHERE 1= 1

#if (${fileup} == 'Y')
                    AND D.BL_NO           IN (
  #foreach($bl_no IN ${bl_no_list})
    #if($velocityCount < $bl_no_list.size()) 
                                              '${bl_no}',
    #else                                    
                                              '${bl_no}'
    #end                                     
  #end                                       
                                             )
#else

    #if (${sch_tp_cd} == 'VVD')
                    AND A.VSL_CD          = SUBSTR(@[vvd], 1, 4)
                    AND A.SKD_VOY_NO      = SUBSTR(@[vvd], 5, 4)
                    AND A.SKD_DIR_CD      = SUBSTR(@[vvd], 9, 1)
    #elseif (${sch_tp_cd} == 'ATA')
                    AND B.VPS_ETB_DT      >= TO_DATE(@[dt_s],'YYYY-MM-DD') 
                    AND B.VPS_ETB_DT      < (TO_DATE(@[dt_e],'YYYY-MM-DD')+1)
    #elseif (${sch_tp_cd} == 'BL')
                    AND D.BL_NO           = @[bl_no]
    #elseif (${sch_tp_cd} == 'CN')
                    AND E.CNTR_NO         = @[cntr_no]
    #end

    #if (${ofc_cd} != '')
                    AND C.EQ_CTRL_OFC_CD  = @[ofc_cd]
    #end

#end
                    AND A.DELT_FLG        = 'N'
                    AND A.TRSP_BND_CD     = 'I'
                    AND B.VSL_CD(+)       = A.VSL_CD
                    AND B.SKD_VOY_NO(+)   = A.SKD_VOY_NO
                    AND B.SKD_DIR_CD(+)   = A.SKD_DIR_CD
                    AND B.VPS_PORT_CD(+)  = A.POD_CD
                    AND B.CLPT_IND_SEQ(+) = '1'   
                    AND C.LOC_CD          = A.POD_CD   
                    AND D.BKG_NO          = A.BKG_NO
                    AND E.BKG_NO          = A.BKG_NO
                    AND E.CNTR_NO         = A.EQ_NO
                    AND G.BL_NO(+)        = D.BL_NO
                    AND H.LOC_CD          = D.DEL_CD
                    AND I.CNT_CD(+)       = 'US'
                    AND I.BL_NO(+)        = D.BL_NO
                ) A
               ,BKG_PKUP_NTC_PKUP_NO  F
          WHERE R_ORD = 1
            AND F.DELT_FLG(+) = 'N'
            AND F.BKG_NO(+)   = A.BKG_NO
            AND F.CNTR_NO(+)  = A.CNTR_NO
            AND F.OFC_CD(+)   = A.EQ_CTRL_OFC_CD
       ) A
#if (${fileup} == 'Y')
#else
  #if (${excel_flg} != 'Y')
 WHERE ROW_NUM > (TO_NUMBER(@[page_no]) -1) * TO_NUMBER(@[pagerows] )
   AND ROW_NUM <=  TO_NUMBER(@[page_no]) * TO_NUMBER(@[pagerows] )
  #end
#end			]]></sql>
			<params>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="dt_s" type="12" value="" out="N"/>
				<param name="dt_e" type="12" value="" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
				<param name="cntr_no" type="12" value="" out="N"/>
				<param name="ofc_cd" type="12" value="" out="N"/>
				<param name="page_no" type="12" value="" out="N"/>
				<param name="pagerows" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
