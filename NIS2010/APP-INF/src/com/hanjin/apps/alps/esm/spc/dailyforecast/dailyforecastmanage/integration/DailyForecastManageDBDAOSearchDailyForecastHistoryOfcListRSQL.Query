<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="DailyForecastManageDBDAOSearchDailyForecastHistoryOfcListRSQL">
			<desc><![CDATA[Lee Sang-Yong : [프로젝트] Ticket ID : CHM-201004171 53ft 추가
[CHM-201322502-01] SPC 프로젝트 - 성수기 선복운영 개선을 위한 T/F추진
2013-08-12 선처리 조회 속도개선
2014.07.30 [CHM-201431081] SPC Allocation Control Option 추가 보완 요청
2015.10.21 이혜민 조회 속도개선 쿼리 튜닝]]></desc>
			<sql><![CDATA[
SELECT TRD_CD, 
       SUB_TRD_CD,
       RLANE_CD  ,
       SKD_DIR_CD, 
       IOC_CD    ,
       SLS_OFC_CD,
       BSE_WK    ,
       VVD       ,
       BSE_DT    ,
       CUST_CTRL_CD,
       CASE WHEN GROUPING_ID(USA_BKG_MOD_CD) = 1 THEN '-' ELSE DECODE(USA_BKG_MOD_CD, 'OTH', 'OTHERS', 'OTH ', 'OTHERS', USA_BKG_MOD_CD) END USA_BKG_MOD_CD,
       POL_CD    , 
       POD_CD    ,
       DECODE(GROUPING_ID(POD_CD), 1,  NULL, 'OTHERS') DEST_LOC_CD,
       SUM(FCAST_TTL_TEU_QTY ) AS FCAST_TTL_TEU_QTY ,
       SUM(FCAST_LOD_QTY     ) AS FCAST_LOD_QTY     ,
       SUM(FCAST_20FT_DRY_QTY ) AS FCAST_20FT_DRY_QTY ,
       SUM(FCAST_40FT_DRY_QTY ) AS FCAST_40FT_DRY_QTY ,
       SUM(FCAST_40FT_HC_QTY ) AS FCAST_40FT_HC_QTY ,
       SUM(FCAST_45FT_HC_QTY ) AS FCAST_45FT_HC_QTY ,
       SUM(FCAST_53FT_QTY    ) AS FCAST_53FT_QTY    ,
       SUM(FCAST_RF_QTY      ) AS FCAST_RF_QTY      ,
       SUM(FCAST_RD_QTY      ) AS FCAST_RD_QTY      ,
       SUM(FCAST_TTL_WGT     ) AS FCAST_TTL_WGT     ,
       SUM(CFCAST_TTL_TEU_QTY) AS CFCAST_TTL_TEU_QTY,
       SUM(CFCAST_LOD_QTY    ) AS CFCAST_LOD_QTY    ,
       SUM(CFCAST_40FT_HC_QTY) AS CFCAST_40FT_HC_QTY,
       SUM(CFCAST_45FT_HC_QTY) AS CFCAST_45FT_HC_QTY,
       SUM(CFCAST_53FT_QTY   ) AS CFCAST_53FT_QTY   ,
       SUM(CFCAST_RF_QTY     ) AS CFCAST_RF_QTY     ,
       SUM(CFCAST_TTL_WGT    ) AS CFCAST_TTL_WGT    ,
       SUM(ALOC_TTL_QTY      ) AS ALOC_TTL_QTY      ,
       SUM(ALOC_20FT_DRY_QTY  ) AS ALOC_20FT_DRY_QTY  ,
       SUM(ALOC_40FT_DRY_QTY  ) AS ALOC_40FT_DRY_QTY  ,
       SUM(ALOC_40FT_HC_QTY  ) AS ALOC_40FT_HC_QTY  ,
       SUM(ALOC_45FT_HC_QTY  ) AS ALOC_45FT_HC_QTY  ,
       SUM(ALOC_53FT_QTY     ) AS ALOC_53FT_QTY     ,
       SUM(ALOC_RF_QTY       ) AS ALOC_RF_QTY       ,
       SUM(ALOC_RD_QTY       ) AS ALOC_RD_QTY       ,
       SUM(ALOC_TTL_WGT      ) AS ALOC_TTL_WGT      ,         
       SUM(BKG_TTL_TEU_QTY   ) AS BKG_TTL_TEU_QTY   ,
       SUM(BKG_20FT_QTY      ) AS BKG_20FT_QTY      ,
       SUM(BKG_40FT_QTY      ) AS BKG_40FT_QTY      ,
       SUM(BKG_20FT_DRY_QTY   ) AS BKG_20FT_DRY_QTY   ,
       SUM(BKG_40FT_DRY_QTY   ) AS BKG_40FT_DRY_QTY   ,
       SUM(BKG_40FT_HC_QTY   ) AS BKG_40FT_HC_QTY   ,
       SUM(BKG_45FT_HC_QTY   ) AS BKG_45FT_HC_QTY   ,
       SUM(BKG_53FT_QTY      ) AS BKG_53FT_QTY      ,
       SUM(BKG_RF_QTY        ) AS BKG_RF_QTY        ,
       SUM(BKG_RD_QTY        ) AS BKG_RD_QTY        ,
       SUM(BKG_TTL_WGT       ) AS BKG_TTL_WGT       ,
--       DECODE(A.POL_CD, '', 1, DECODE(A.POD_CD, '', 2, 3)) AS LVL
       4-(GROUPING_ID(USA_BKG_MOD_CD) +  GROUPING_ID(POL_CD) + GROUPING_ID(POD_CD)) AS LVL
  FROM (
    SELECT /*+ LEADING(D V A ) */  A.TRD_CD     AS TRD_CD    ,
           A.SUB_TRD_CD AS SUB_TRD_CD,
           A.RLANE_CD   AS RLANE_CD  ,
           A.SKD_DIR_CD AS SKD_DIR_CD,
           DECODE(A.IOC_TS_CD, 'O', 'OCN', 'I', 'IPC', 'TS') AS IOC_CD    ,
           DECODE(A.SLS_OFC_CD, '', '+', A.SLS_OFC_CD)       AS SLS_OFC_CD,
           SUBSTR(V.SLS_YRMON, 1, 4)||V.COST_WK              AS BSE_WK    ,
           V.VSL_CD||V.SKD_VOY_NO||V.DIR_CD                  AS VVD       ,
           A.BSE_DT                                          AS BSE_DT    ,
           NVL(A.CUST_CTRL_CD, 'C') AS CUST_CTRL_CD,
           DECODE(A.POL_YD_CD, '', '+', A.POL_YD_CD)         AS POL_CD    ,
           DECODE(A.POD_YD_CD, '', '+', A.POD_YD_CD)         AS POD_CD    ,
           (NVL(A.FCAST_20FT_QTY, 0) + NVL(A.FCAST_40FT_QTY, 0) * 2 + NVL(A.FCAST_40FT_HC_QTY, 0) * 2 + NVL(A.FCAST_45FT_HC_QTY, 0) * 2 + NVL(A.FCAST_53FT_QTY, 0) * 2) AS FCAST_TTL_TEU_QTY,
           (NVL(A.FCAST_20FT_QTY, 0) + NVL(A.FCAST_40FT_QTY, 0) * 2)     AS FCAST_LOD_QTY    ,
           (A.FCAST_40FT_HC_QTY)      AS FCAST_40FT_HC_QTY,
           (A.FCAST_45FT_HC_QTY)      AS FCAST_45FT_HC_QTY,
           (A.FCAST_53FT_QTY)         AS FCAST_53FT_QTY   ,
           (A.FCAST_RF_QTY)           AS FCAST_RF_QTY     ,
           (A.FCAST_TTL_WGT)          AS FCAST_TTL_WGT    ,
           (NVL(A.CTRT_FCAST_TTL_QTY, 0) + NVL(A.CTRT_FCAST_40FT_HC_QTY, 0) * 2 + NVL(A.CTRT_FCAST_45FT_HC_QTY, 0) * 2 + NVL(A.CTRT_FCAST_53FT_QTY, 0) * 2) AS CFCAST_TTL_TEU_QTY,
           (A.CTRT_FCAST_TTL_QTY)     AS CFCAST_LOD_QTY    ,
           (A.CTRT_FCAST_40FT_HC_QTY) AS CFCAST_40FT_HC_QTY,
           (A.CTRT_FCAST_45FT_HC_QTY) AS CFCAST_45FT_HC_QTY,
           (A.CTRT_FCAST_53FT_QTY)    AS CFCAST_53FT_QTY   ,
           (A.CTRT_FCAST_RF_QTY)      AS CFCAST_RF_QTY     ,
           (A.CTRT_FCAST_TTL_WGT)     AS CFCAST_TTL_WGT    ,
           (A.ALOC_TTL_QTY)           AS ALOC_TTL_QTY     ,
           (A.ALOC_40FT_HC_QTY)       AS ALOC_40FT_HC_QTY ,
           (A.ALOC_45FT_HC_QTY)       AS ALOC_45FT_HC_QTY ,
           (A.ALOC_53FT_QTY)          AS ALOC_53FT_QTY    ,
           (A.ALOC_RF_QTY)            AS ALOC_RF_QTY      ,
           (A.ALOC_TTL_WGT)           AS ALOC_TTL_WGT     ,         
           (NVL(A.BKG_20FT_QTY, 0) + NVL(A.BKG_40FT_QTY, 0) * 2 + NVL(A.BKG_40FT_HC_QTY, 0) * 2 + NVL(A.BKG_45FT_HC_QTY, 0) * 2 + NVL(A.BKG_53FT_QTY, 0) * 2) AS BKG_TTL_TEU_QTY,
           (A.BKG_20FT_QTY)           AS BKG_20FT_QTY     ,
           (A.BKG_40FT_QTY)           AS BKG_40FT_QTY ,
           (A.BKG_40FT_HC_QTY)        AS BKG_40FT_HC_QTY ,
           (A.BKG_45FT_HC_QTY)        AS BKG_45FT_HC_QTY ,
           (A.BKG_53FT_QTY)           AS BKG_53FT_QTY    ,
           (A.BKG_RF_QTY)             AS BKG_RF_QTY      ,
           (A.BKG_TTL_WGT)            AS BKG_TTL_WGT     
           ,DECODE(A.USA_BKG_MOD_CD, 'OTH', 'OTHERS', A.USA_BKG_MOD_CD) USA_BKG_MOD_CD
--           ,DECODE(A.DEST_LOC_CD, 'XXXXX', 'OTHERS', A.DEST_LOC_CD) DEST_LOC_CD  
           ,NVL(A.FCAST_20FT_DRY_QTY, 0) FCAST_20FT_DRY_QTY
           ,NVL(A.FCAST_40FT_DRY_QTY, 0) FCAST_40FT_DRY_QTY        
           ,NVL(A.FCAST_RD_QTY, 0) FCAST_RD_QTY
           ,NVL(A.BKG_20FT_DRY_QTY, 0) BKG_20FT_DRY_QTY
           ,NVL(A.BKG_40FT_DRY_QTY, 0) BKG_40FT_DRY_QTY
           ,NVL(A.BKG_RD_QTY, 0) BKG_RD_QTY
           ,NVl(A.ALOC_20FT_DRY_QTY, 0) ALOC_20FT_DRY_QTY
           ,NVl(A.ALOC_40FT_DRY_QTY, 0)  ALOC_40FT_DRY_QTY 
           ,NVl(A.ALOC_RD_QTY, 0) ALOC_RD_QTY
            --FCAST_20FT_DRY_QTY, FCAST_40FT_DRY_QTY, FCAST_RD_QTY, BKG_20FT_DRY_QTY, BKG_40FT_DRY_QTY, BKG_RD_QTY, ALOC_20FT_DRY_QTY, ALOC_40FT_DRY_QTY, ALOC_RD_QTY            
      FROM SPC_DLY_FCAST_SLS_REP_HIS A,
           MAS_MON_VVD               V,
           (
            SELECT /*+ NO_MERGE */ TO_CHAR(TO_DATE('20130413','YYYYMMDD') +LEVEL-1,'YYYYMMDD') AS D_DT
            FROM   DUAL
            CONNECT BY LEVEL <= ( SYSDATE +1 ) - TO_DATE('20130413','YYYYMMDD') 
           )  D
     WHERE 1=1
    #if (${vvd} != '')
       AND V.VSL_CD     = @[vslcd]
       AND V.SKD_VOY_NO = @[skdvoyno]
       AND V.DIR_CD     = @[skddircd]
    #end
    #if (${vvd} == '')
    	#if (${trade} != '')
       AND V.TRD_CD     = @[trade]
    	#end
    	#if (${subTrade} != '')
       AND V.SUB_TRD_CD = @[subTrade]
    	#end
    	#if (${lane} != '')
       AND V.RLANE_CD   = @[lane]
    	#end
    	#if (${bound} != '')
       AND V.DIR_CD     = @[bound]
    	#end
    #end
    #if (${vvd} == '')
       AND SUBSTR(V.SLS_YRMON, 1, 4)||V.COST_WK  IN ( SELECT /*+ INDEX(P XPKMAS_WK_PRD) */
                                                               P.COST_YR||P.COST_WK
                                                          FROM MAS_WK_PRD P
                                                         WHERE P.COST_YR||P.COST_WK >= @[year]||@[week]
                                                           AND ROWNUM <= @[duration] )
    #end
       AND A.IOC_TS_CD  = @[ioc]
    #if (${salesOffice} != '' && ${subOffice} == '')
       AND A.SLS_RGN_OFC_CD = @[salesOffice]
       AND A.OFC_KND_CD     = '3'

    #end
    #if ((${subOffice} != '' && ${salesOffice} == '') || (${subOffice} != '' && ${salesOffice} != ''))
       AND A.SLS_OFC_CD = @[subOffice]
       AND A.OFC_KND_CD     = '4'
       AND A.SREP_CD       != '00000' -- 20130523 추가 SMK
    #end

       AND A.RLANE_CD    = V.RLANE_CD
       AND A.TRD_CD      = V.TRD_CD
       AND A.SUB_TRD_CD  = V.SUB_TRD_CD
       AND A.VSL_CD      = V.VSL_CD
       AND A.SKD_VOY_NO  = V.SKD_VOY_NO
       AND A.SKD_DIR_CD  = V.DIR_CD

       AND A.CTRT_CUST_CNT_CD = '00'
       AND A.CTRT_CUST_SEQ    = 0
       --AND A.BSE_DT >= '20130413'
       AND A.BSE_DT = D.D_DT
       
    UNION ALL

    SELECT A.TRD_CD     AS TRD_CD    ,
           A.SUB_TRD_CD AS SUB_TRD_CD,
           A.RLANE_CD   AS RLANE_CD  ,
           A.SKD_DIR_CD AS SKD_DIR_CD,
           DECODE(A.IOC_TS_CD, 'O', 'OCN', 'I', 'IPC', 'TS') AS IOC_CD    ,
           DECODE(A.SLS_OFC_CD, '', '+', A.SLS_OFC_CD)       AS SLS_OFC_CD,
           SUBSTR(V.SLS_YRMON, 1, 4)||V.COST_WK              AS BSE_WK    ,
           V.VSL_CD||V.SKD_VOY_NO||V.DIR_CD                  AS VVD       ,
           A.BSE_DT                                          AS BSE_DT    ,
          'C' AS CUST_CTRL_CD,
           DECODE(A.POL_YD_CD, '', '+', A.POL_YD_CD)         AS POL_CD    ,
           DECODE(A.POD_YD_CD, '', '+', A.POD_YD_CD)         AS POD_CD    ,
           NVL(A.FCAST_LOD_QTY, 0) + NVL(A.FCAST_40FT_HC_QTY, 0) * 2 + NVL(A.FCAST_45FT_HC_QTY, 0) * 2 + NVL(A.FCAST_53FT_QTY, 0) * 2 AS FCAST_TTL_TEU_QTY,
           NVL(A.FCAST_LOD_QTY, 0)     AS FCAST_LOD_QTY    ,
           A.FCAST_40FT_HC_QTY      AS FCAST_40FT_HC_QTY,
           A.FCAST_45FT_HC_QTY      AS FCAST_45FT_HC_QTY,
           A.FCAST_53FT_QTY         AS FCAST_53FT_QTY   ,
           A.FCAST_RF_QTY           AS FCAST_RF_QTY     ,
           A.FCAST_TTL_WGT          AS FCAST_TTL_WGT    ,
           0 AS CFCAST_TTL_TEU_QTY,
           0 AS CFCAST_LOD_QTY    ,
           0 AS CFCAST_40FT_HC_QTY,
           0 AS CFCAST_45FT_HC_QTY,
           0 AS CFCAST_53FT_QTY   ,
           0 AS CFCAST_RF_QTY     ,
           0 AS CFCAST_TTL_WGT    ,
           A.ALOC_LOD_QTY           AS ALOC_TTL_QTY     ,
           A.ALOC_40FT_HC_QTY       AS ALOC_40FT_HC_QTY ,
           A.ALOC_45FT_HC_QTY       AS ALOC_45FT_HC_QTY ,
           A.ALOC_53FT_QTY          AS ALOC_53FT_QTY    ,
           A.ALOC_RF_QTY            AS ALOC_RF_QTY      ,
           A.ALOC_TTL_WGT           AS ALOC_TTL_WGT     ,         
           0 AS BKG_TTL_TEU_QTY,
           0 AS BKG_20FT_QTY     ,
           0 AS BKG_40FT_QTY ,
           0 AS BKG_40FT_HC_QTY ,
           0 AS BKG_45FT_HC_QTY ,
           0 AS BKG_53FT_QTY    ,
           0 AS BKG_RF_QTY      ,
           0 AS BKG_TTL_WGT
           ,DECODE(A.USA_BKG_MOD_CD, 'OTH', 'OTHERS', A.USA_BKG_MOD_CD) USA_BKG_MOD_CD
--           ,DECODE(A.DEST_LOC_CD, 'XXXXX', 'OTHERS', A.DEST_LOC_CD) DEST_LOC_CD  
           ,NVl(A.FCAST_20FT_DRY_QTY, 0) FCAST_20FT_DRY_QTY
           ,NVl(A.FCAST_40FT_DRY_QTY , 0) FCAST_40FT_DRY_QTY          
           ,NVl(A.FCAST_RD_QTY, 0) FCAST_RD_QTY
           ,0 BKG_20FT_DRY_QTY
           ,0 BKG_40FT_DRY_QTY
           ,0 BKG_RD_QTY
           ,NVl(A.ALOC_20FT_DRY_QTY, 0) ALOC_20FT_DRY_QTY
           ,NVl(A.ALOC_40FT_DRY_QTY, 0)  ALOC_40FT_DRY_QTY 
           ,NVl(A.ALOC_RD_QTY, 0) ALOC_RD_QTY
            --FCAST_20FT_DRY_QTY, FCAST_40FT_DRY_QTY, FCAST_RD_QTY, ALOC_20FT_DRY_QTY, ALOC_40FT_DRY_QTY, ALOC_RD_QTY 
      FROM SPC_DLY_FCAST_HIS A,
           MAS_MON_VVD       V
     WHERE 1=1
    #if (${vvd} != '')
       AND V.VSL_CD     = @[vslcd]
       AND V.SKD_VOY_NO = @[skdvoyno]
       AND V.DIR_CD     = @[skddircd]
    #end
    #if (${vvd} == '')
    	#if (${trade} != '')
       AND V.TRD_CD     = @[trade]
    	#end
    	#if (${subTrade} != '')
       AND V.SUB_TRD_CD = @[subTrade]
    	#end
    	#if (${lane} != '')
       AND V.RLANE_CD   = @[lane]
    	#end
    	#if (${bound} != '')
       AND V.DIR_CD     = @[bound]
    	#end
    #end
    #if (${vvd} == '')
       AND SUBSTR(V.SLS_YRMON, 1, 4)||V.COST_WK  IN ( SELECT /*+ INDEX(P XPKMAS_WK_PRD) */
                                                               P.COST_YR||P.COST_WK
                                                          FROM MAS_WK_PRD P
                                                         WHERE P.COST_YR||P.COST_WK >= @[year]||@[week]
                                                           AND ROWNUM <= @[duration] )
    #end
       AND A.IOC_TS_CD  = @[ioc]
    #if (${salesOffice} != '' && ${subOffice} == '')
       AND A.SLS_RGN_OFC_CD = @[salesOffice]
       AND A.OFC_KND_CD     = '3'
    #end
    #if ((${subOffice} != '' && ${salesOffice} == '') || (${subOffice} != '' && ${salesOffice} != ''))
       AND A.SLS_OFC_CD = @[subOffice]
       AND A.OFC_KND_CD     = '4'
    #end
       AND A.RLANE_CD    = V.RLANE_CD
       AND A.TRD_CD      = V.TRD_CD
       AND A.SUB_TRD_CD  = V.SUB_TRD_CD
       AND A.VSL_CD      = V.VSL_CD
       AND A.SKD_VOY_NO  = V.SKD_VOY_NO
       AND A.SKD_DIR_CD  = V.DIR_CD
       AND A.BSE_DT < '20130413'
) A

 GROUP BY GROUPING SETS (
--                         (A.TRD_CD, A.SUB_TRD_CD,A.RLANE_CD, A.SKD_DIR_CD, BSE_WK, VVD, A.IOC_CD, A.BSE_DT, A.CUST_CTRL_CD, A.SLS_OFC_CD, USA_BKG_MOD_CD, POL_CD, POD_CD, DEST_LOC_CD),
                         (A.TRD_CD, A.SUB_TRD_CD,A.RLANE_CD, A.SKD_DIR_CD, BSE_WK, VVD, A.IOC_CD, A.BSE_DT, A.CUST_CTRL_CD, A.SLS_OFC_CD, USA_BKG_MOD_CD, POL_CD, POD_CD),
                         (A.TRD_CD, A.SUB_TRD_CD,A.RLANE_CD, A.SKD_DIR_CD, BSE_WK, VVD, A.IOC_CD, A.BSE_DT, A.CUST_CTRL_CD, A.SLS_OFC_CD, USA_BKG_MOD_CD, POL_CD),
                         (A.TRD_CD, A.SUB_TRD_CD,A.RLANE_CD, A.SKD_DIR_CD, BSE_WK, VVD, A.IOC_CD, A.BSE_DT, A.CUST_CTRL_CD, A.SLS_OFC_CD, USA_BKG_MOD_CD),
                         (A.TRD_CD, A.SUB_TRD_CD,A.RLANE_CD, A.SKD_DIR_CD, BSE_WK, VVD, A.IOC_CD, A.BSE_DT, A.CUST_CTRL_CD, A.SLS_OFC_CD)

                       )

 ORDER BY A.TRD_CD    ,
          A.SUB_TRD_CD,
          A.RLANE_CD  ,
          A.SKD_DIR_CD,
          BSE_WK DESC,
          VVD           ,
          IOC_CD   ,
          SLS_OFC_CD  ,
          BSE_DT    DESC,
          CUST_CTRL_CD  ,
--          LVL           ,
		  USA_BKG_MOD_CD,
          NVL(POL_CD, 'zzzzz') DESC,
          NVL(POD_CD, 'zzzzz') DESC			]]></sql>
			<params>
				<param name="vslcd" type="12" value="" out="N"/>
				<param name="skdvoyno" type="12" value="" out="N"/>
				<param name="skddircd" type="12" value="" out="N"/>
				<param name="trade" type="12" value="" out="N"/>
				<param name="subTrade" type="12" value="" out="N"/>
				<param name="lane" type="12" value="" out="N"/>
				<param name="bound" type="12" value="" out="N"/>
				<param name="year" type="12" value="" out="N"/>
				<param name="week" type="12" value="" out="N"/>
				<param name="duration" type="12" value="" out="N"/>
				<param name="ioc" type="12" value="" out="N"/>
				<param name="salesOffice" type="12" value="" out="N"/>
				<param name="subOffice" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
