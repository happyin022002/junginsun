<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="RFAProposalMainDBDAORsltPropMnMstVORSQL">
			<desc><![CDATA[Master RFA Main 조회 쿼리]]></desc>
			<sql><![CDATA[
WITH INPUT_PARAMS AS (
    SELECT MN.PROP_NO
         , MAX(MN.AMDT_SEQ) AMDT_SEQ
    FROM PRI_RP_MN MN
       , PRI_RP_HDR HDR
    WHERE 1=1
    AND   MN.RFA_CTRT_TP_CD = 'M'
#if (${rfa_no} != '')
    AND   HDR.RFA_NO = @[rfa_no]
#else
    AND   MN.PROP_NO = @[prop_no]
#end
    AND   HDR.PROP_NO = MN.PROP_NO
    GROUP BY MN.PROP_NO
)
SELECT HDR.RFA_NO
      ,MN.PROP_NO
      ,MN.AMDT_SEQ
      ,MN.AMDT_SEQ - 1 PRE_AMDT_SEQ
      ,CASE WHEN DUR.CTRT_EFF_DT = TO_DATE('99991231','YYYYMMDD') AND DUR.CTRT_EXP_DT = TO_DATE('99991231','YYYYMMDD')
            THEN ''
            ELSE TO_CHAR(DUR.CTRT_EFF_DT, 'YYYYMMDD')
       END CTRT_EFF_DT
      ,CASE WHEN DUR.CTRT_EFF_DT = TO_DATE('99991231','YYYYMMDD') AND DUR.CTRT_EXP_DT = TO_DATE('99991231','YYYYMMDD')
            THEN ''
            ELSE TO_CHAR(DUR.CTRT_EXP_DT, 'YYYYMMDD')
       END CTRT_EXP_DT
      ,CASE WHEN MN.EFF_DT = TO_DATE('99991231','YYYYMMDD') AND MN.EXP_DT = TO_DATE('99991231','YYYYMMDD')
            THEN ''
            ELSE TO_CHAR(MN.EFF_DT, 'YYYYMMDD')
       END EFF_DT -- Display
      ,CASE WHEN MN.EFF_DT = TO_DATE('99991231','YYYYMMDD') AND MN.EXP_DT = TO_DATE('99991231','YYYYMMDD')
            THEN ''
            ELSE TO_CHAR(MN.EXP_DT, 'YYYYMMDD')
       END EXP_DT
      --,TO_CHAR (MN.EFF_DT - 1, 'YYYYMMDD') PRE_EXP_DT
      ,NVL((SELECT CASE WHEN MN.EFF_DT <= N.EXP_DT THEN TO_CHAR(MN.EFF_DT - 1,'YYYYMMDD')
               ELSE TO_CHAR(N.EXP_DT,'YYYYMMDD')
                END AS EXP_DT
          FROM PRI_RP_MN N
         WHERE PROP_NO = MN.PROP_NO AND AMDT_SEQ = MN.AMDT_SEQ-1 
       ), TO_CHAR (MN.EFF_DT - 1, 'YYYYMMDD')) PRE_EXP_DT
      ,NVL((    
        SELECT CASE WHEN MN.EFF_DT <= N.EXP_DT THEN 'Y'
               ELSE 'N'
               END AS EXP_DT
          FROM PRI_RP_MN N
         WHERE PROP_NO = MN.PROP_NO AND AMDT_SEQ = MN.AMDT_SEQ-1
        ),'N') DUR_DUP_FLG
      ,TO_CHAR(MN.FILE_DT, 'YYYYMMDD') FILE_DT
      ,(
        SELECT SVC_SCP_CD FROM PRI_RP_SCP_MN
         WHERE PROP_NO = INP.PROP_NO
           AND AMDT_SEQ = INP.AMDT_SEQ
           AND ROWNUM = 1
      ) AS SVC_SCP_CD
      ,MN.PROP_STS_CD
      ,STS_CD.INTG_CD_VAL_DP_DESC PROP_STS
      ,MN.PROP_OFC_CD
      ,MN.PROP_SREP_CD
      ,REQ_USR.USR_NM AS REQ_USR_NM
      ,REQ_USR.USR_ID AS REQ_USR_ID
	  ,MN.PROP_USR_ID -- Request Staff
      , (SELECT USR_NM FROM COM_USER WHERE USR_ID = MN.PROP_USR_ID AND USE_FLG = 'Y' AND ROWNUM = 1) PROP_USR_NM
	  ,MN.PROP_APRO_OFC_CD
      ,PROG_USR.USR_NM PROP_APRO_STAFF
      ,TO_CHAR(MN.PROP_APRO_DT, 'YYYYMMDD') PROP_APRO_DT
      ,TO_CHAR (MN.CRE_DT, 'YYYYMMDD') CRE_DT
      ,DECODE(@[usr_id],'','N',DECODE(PROP_OFC_CD, @[ofc_cd],'Y','N')) REQ_USR_FLG
      ,DECODE (SIGN(AUTH.CNT2), 1, 'Y', 'N') AS APRO_USR_FLG
      ,DECODE (SIGN(AUTH.CNT2), 1, 'Y', 'N') AS ALL_USR_FLG
      ,NVL((
		   SELECT 'Y'
			 FROM COM_USER A
				, MDM_SLS_REP B
				, COM_USR_ROLE_MTCH C
			WHERE A.USR_ID = B.EMPE_CD
			  AND A.USR_ID = C.USR_ID
			  AND A.USE_FLG = 'Y'
			  AND B.SREP_STS_CD = 'N'
			  AND C.USR_ROLE_CD = 'PRI02'
			  AND A.USR_ID = @[usr_id]
			AND ROWNUM = 1 
        ), 'N') AS COPY_AUTH
      ,(SELECT PRC_PROP_CRE_TP_CD FROM PRI_RP_HDR WHERE MN.PROP_NO= PROP_NO) CRE_TP
      ,TO_CHAR(MN.UPD_DT,'YYYYMMDD-HH24MISS') UPD_DT
      ,MN.RFA_CTRT_TP_CD
      ,DMDT.DMDT_FT_TP_CD
FROM   PRI_RP_MN MN
      ,PRI_RP_HDR HDR
      ,PRI_RP_DUR DUR
      ,PRI_RP_DMDT DMDT
      ,COM_INTG_CD_DTL STS_CD
      ,INPUT_PARAMS INP
      , (SELECT   B.PROP_NO
                 ,B.AMDT_SEQ
                 ,COUNT (A.SVC_SCP_CD) CNT2
         FROM     PRI_AUTHORIZATION A
                 ,PRI_RP_SCP_MN B
                 ,INPUT_PARAMS HDR
         WHERE    A.SVC_SCP_CD = B.SVC_SCP_CD
         AND      A.USR_ID =  @[usr_id]
         AND      A.PRC_CTRT_TP_CD = 'R'
         AND      A.EXP_DT > SYSDATE
         AND      HDR.PROP_NO = B.PROP_NO
         GROUP BY B.PROP_NO
                 ,B.AMDT_SEQ) AUTH
	  ,(
		SELECT A.PROP_NO
    		  ,A.AMDT_SEQ
      	  	  ,A.PROP_STS_CD
      		  ,B.USR_NM
		FROM   PRI_RP_PROG A
		      ,COM_USER B
		      ,INPUT_PARAMS INP
        WHERE  INP.PROP_NO= A.PROP_NO     
        AND    INP.AMDT_SEQ = A.AMDT_SEQ 
        AND    A.PROG_USR_ID = B.USR_ID
        AND    PROP_STS_CD = 'A'
        AND    USE_FLG = 'Y'
        AND    PROP_PROG_SEQ =
          				(SELECT  /*+ INDEX_DESC(A XPKPRI_RP_PROG) */ (PROP_PROG_SEQ)
           				   FROM  PRI_RP_PROG
           				  WHERE  PROP_NO = A.PROP_NO
           					AND  AMDT_SEQ = A.AMDT_SEQ
           					AND  PROP_STS_CD = 'A'
							AND ROWNUM = 1)
		) PROG_USR
	  ,(
		SELECT A.PROP_NO
    		  ,A.AMDT_SEQ
      	  	  ,A.PROP_STS_CD
      		  ,B.USR_NM
              ,B.USR_ID
		FROM   PRI_RP_PROG A
		      ,COM_USER B
		      ,INPUT_PARAMS INP
        WHERE  INP.PROP_NO= A.PROP_NO     
        AND    INP.AMDT_SEQ = A.AMDT_SEQ 
        AND    A.PROG_USR_ID = B.USR_ID
        AND    PROP_STS_CD = 'I'
        AND    USE_FLG = 'Y'
        AND    PROP_PROG_SEQ =
          				(SELECT  /*+ INDEX_DESC(A XPKPRI_RP_PROG) */ (PROP_PROG_SEQ)
           				   FROM  PRI_RP_PROG
           				  WHERE  PROP_NO = A.PROP_NO
           					AND  AMDT_SEQ = A.AMDT_SEQ
           					AND  PROP_STS_CD = 'I'
							AND ROWNUM = 1)
		) REQ_USR
WHERE  MN.PROP_NO = INP.PROP_NO
AND    MN.AMDT_SEQ = INP.AMDT_SEQ
AND    HDR.PROP_NO = MN.PROP_NO
AND    DUR.PROP_NO = MN.PROP_NO
AND    DUR.AMDT_SEQ = MN.AMDT_SEQ
AND    STS_CD.INTG_CD_ID = 'CD01722'
AND    STS_CD.INTG_CD_VAL_CTNT = MN.PROP_STS_CD
AND    AUTH.PROP_NO(+) = INP.PROP_NO
AND    AUTH.AMDT_SEQ(+) = INP.AMDT_SEQ
AND    MN.PROP_NO 			   = PROG_USR.PROP_NO(+)
AND    MN.AMDT_SEQ             = PROG_USR.AMDT_SEQ(+)
AND    MN.PROP_NO 			   = REQ_USR.PROP_NO(+)
AND    MN.AMDT_SEQ             = REQ_USR.AMDT_SEQ(+)
AND    DMDT.PROP_NO(+) = MN.PROP_NO
AND    DMDT.AMDT_SEQ(+) = MN.AMDT_SEQ			]]></sql>
			<params>
				<param name="rfa_no" type="12" value="" out="N"/>
				<param name="prop_no" type="12" value="" out="N"/>
				<param name="usr_id" type="12" value="" out="N"/>
				<param name="ofc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
