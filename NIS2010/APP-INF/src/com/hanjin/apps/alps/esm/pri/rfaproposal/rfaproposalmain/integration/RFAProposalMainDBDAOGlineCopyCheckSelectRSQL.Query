<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="RFAProposalMainDBDAOGlineCopyCheckSelectRSQL">
			<desc><![CDATA[Guideline Copy Data Check]]></desc>
			<sql><![CDATA[
-- Guideline Copy Check
WITH CMDT_HDR AS (
    SELECT B.SVC_SCP_CD
         , B.GLINE_SEQ
         , B.CMDT_HDR_SEQ
    FROM PRI_RG_RT_CMDT_HDR B
    WHERE B.SVC_SCP_CD = @[svc_scp_cd]
    --AND   B.GLINE_SEQ = '2'
    AND   (
        EXISTS (
            SELECT 'X'
            FROM PRI_RG_RT_CMDT C
            WHERE C.SVC_SCP_CD = B.SVC_SCP_CD
            AND   C.GLINE_SEQ = B.GLINE_SEQ
            AND   C.CMDT_HDR_SEQ = B.CMDT_HDR_SEQ
        )
        OR EXISTS (
            SELECT 'X'
            FROM PRI_RG_RT_CMDT_ROUT D
            WHERE D.SVC_SCP_CD = B.SVC_SCP_CD
            AND   D.GLINE_SEQ = B.GLINE_SEQ
            AND   D.CMDT_HDR_SEQ = B.CMDT_HDR_SEQ
            AND   (
                EXISTS (
                    SELECT 'X'
                    FROM PRI_RG_RT_ROUT_PNT E
                    WHERE E.SVC_SCP_CD = D.SVC_SCP_CD
                    AND   E.GLINE_SEQ = D.GLINE_SEQ
                    AND   E.CMDT_HDR_SEQ = D.CMDT_HDR_SEQ
                    AND   E.ROUT_SEQ = D.ROUT_SEQ
                )
                OR EXISTS (
                    SELECT 'X'
                    FROM PRI_RG_RT_ROUT_VIA F
                    WHERE F.SVC_SCP_CD = D.SVC_SCP_CD
                    AND   F.GLINE_SEQ = D.GLINE_SEQ
                    AND   F.CMDT_HDR_SEQ = D.CMDT_HDR_SEQ
                    AND   F.ROUT_SEQ = D.ROUT_SEQ
                )
                OR EXISTS (
                    SELECT 'X'
                    FROM PRI_RG_RT H
                    WHERE H.SVC_SCP_CD = D.SVC_SCP_CD
                    AND   H.GLINE_SEQ = D.GLINE_SEQ
                    AND   H.CMDT_HDR_SEQ = D.CMDT_HDR_SEQ
                    AND   H.ROUT_SEQ = D.ROUT_SEQ
                )
            )
        )
    )
)
, CMDT_ROUT AS (
    SELECT B.SVC_SCP_CD
         , B.GLINE_SEQ
         , B.CMDT_HDR_SEQ
         , B.ROUT_SEQ
    FROM CMDT_HDR A
       , PRI_RG_RT_CMDT_ROUT B
    WHERE B.SVC_SCP_CD = A.SVC_SCP_CD
    AND   B.GLINE_SEQ = A.GLINE_SEQ
    AND   B.CMDT_HDR_SEQ = A.CMDT_HDR_SEQ
    AND   (
        EXISTS (
            SELECT 'X'
            FROM PRI_RG_RT_ROUT_PNT E
            WHERE E.SVC_SCP_CD = B.SVC_SCP_CD
            AND   E.GLINE_SEQ = B.GLINE_SEQ
            AND   E.CMDT_HDR_SEQ = B.CMDT_HDR_SEQ
            AND   E.ROUT_SEQ = B.ROUT_SEQ
        )
        OR EXISTS (
            SELECT 'X'
            FROM PRI_RG_RT_ROUT_VIA F
            WHERE F.SVC_SCP_CD = B.SVC_SCP_CD
            AND   F.GLINE_SEQ = B.GLINE_SEQ
            AND   F.CMDT_HDR_SEQ = B.CMDT_HDR_SEQ
            AND   F.ROUT_SEQ = B.ROUT_SEQ
        )
        OR EXISTS (
            SELECT 'X'
            FROM PRI_RG_RT H
            WHERE H.SVC_SCP_CD = B.SVC_SCP_CD
            AND   H.GLINE_SEQ = B.GLINE_SEQ
            AND   H.CMDT_HDR_SEQ = B.CMDT_HDR_SEQ
            AND   H.ROUT_SEQ = B.ROUT_SEQ
        )
    )
)
, RATE_CMDT AS ( -- RATE COMMODITY
    SELECT B.SVC_SCP_CD
         , B.GLINE_SEQ
         , B.CMDT_HDR_SEQ
         , B.CMDT_SEQ
         , B.PRC_CMDT_TP_CD
         , B.PRC_CMDT_DEF_CD
    FROM CMDT_HDR A
       , PRI_RG_RT_CMDT B
    WHERE B.SVC_SCP_CD = A.SVC_SCP_CD
    AND   B.GLINE_SEQ = A.GLINE_SEQ
    AND   B.CMDT_HDR_SEQ = A.CMDT_HDR_SEQ
)
, RATE_LOC_PNT AS ( -- RATE LOCATION POINT
    SELECT B.SVC_SCP_CD
         , B.GLINE_SEQ
         , B.CMDT_HDR_SEQ
         , B.ROUT_SEQ
         , B.ORG_DEST_TP_CD
         , B.ROUT_PNT_SEQ
         , B.ROUT_PNT_LOC_TP_CD
         , B.ROUT_PNT_LOC_DEF_CD
    FROM CMDT_ROUT A
       , PRI_RG_RT_ROUT_PNT B
    WHERE B.SVC_SCP_CD = A.SVC_SCP_CD
    AND   B.GLINE_SEQ = A.GLINE_SEQ
    AND   B.CMDT_HDR_SEQ = A.CMDT_HDR_SEQ
    AND   B.ROUT_SEQ = A.ROUT_SEQ
)
, RATE_LOC_VIA AS ( -- RATE LOCATION VIA
    SELECT B.SVC_SCP_CD
         , B.GLINE_SEQ
         , B.CMDT_HDR_SEQ
         , B.ROUT_SEQ
         , B.ORG_DEST_TP_CD
         , B.ROUT_VIA_SEQ
         , B.ROUT_VIA_PORT_TP_CD
         , B.ROUT_VIA_PORT_DEF_CD
    FROM CMDT_ROUT A
       , PRI_RG_RT_ROUT_VIA B
    WHERE B.SVC_SCP_CD = A.SVC_SCP_CD
    AND   B.GLINE_SEQ = A.GLINE_SEQ
    AND   B.CMDT_HDR_SEQ = A.CMDT_HDR_SEQ
    AND   B.ROUT_SEQ = A.ROUT_SEQ
)
SELECT SG.SVC_SCP_CD
     , SG.GLINE_SEQ
     , DECODE(SIGN(NVL(OL.CNT,0)),1,0,SIGN(NVL(LO.LOC_CHK,0))) AS LOC_CHK
     , DECODE(SIGN(NVL(OC.CNT,0)),1,0,SIGN(NVL(CM.CMDT_CHK,0))) AS CMDT_CHK
     , DECODE(SIGN(NVL(OO.CNT,0)),1,0,SIGN(NVL(AO.ARB_ORG_CHK,0))) AS ARB_ORG_CHK
     , DECODE(SIGN(NVL(OD.CNT,0)),1,0,SIGN(NVL(AD.ARB_DES_CHK,0))) AS ARB_DES_CHK
     , DECODE(SIGN(NVL(OT.CNT,0)),1,0,SIGN(NVL(RT.RATE_CHK,0))) AS RATE_CHK
     , SIGN(NVL(RC.CNT,0)) AS RT_CMDT_CNT
     , SIGN(NVL(RP.CNT,0) + NVL(RV.CNT,0)) AS RT_LOC_CNT
     , SIGN(NVL(AL.AOL_CNT,0)) AS AO_LOC_CNT
     , SIGN(NVL(AL.ADL_CNT,0)) AS AD_LOC_CNT
     , '' AS PROP_NO
     , '' AS AMDT_SEQ
     , '' AS SVC_SCP_NM
     , '' AS CRE_USR_ID
     , '' AS UPD_USR_ID
--     , 0 AS MQC_QTY
--     , 0 AS CMDT_HDR_SEQ
     , '' AS ORG_DEST_TP_CD
--     , 0 AS NOTE_HDR_SEQ
--     , 0 AS GRP_CMDT_SEQ
--     , 0 AS GRP_CMDT_DTL_SEQ
     , '' AS EFF_DT
     , '' AS EXP_DT
     , '' AS RFA_NO
FROM (  -- Scope Main
    SELECT SVC_SCP_CD
         , GLINE_SEQ
    FROM (
        SELECT B.SVC_SCP_CD
             , B.GLINE_SEQ
             , ROW_NUMBER() OVER (ORDER BY B.EFF_DT DESC) AS SEQ
        FROM PRI_RP_SCP_MN A
            ,PRI_RG_MN B
        WHERE A.PROP_NO = @[prop_no]
        AND   A.AMDT_SEQ = @[amdt_seq]
        AND   A.SVC_SCP_CD = @[svc_scp_cd]
        AND   B.SVC_SCP_CD = A.SVC_SCP_CD
        AND   B.CFM_FLG = 'Y'
        AND   A.EFF_DT BETWEEN B.EFF_DT AND B.EXP_DT
    )
    WHERE SEQ = 1
) SG
LEFT OUTER JOIN
(   -- Grp Location
    SELECT C.SVC_SCP_CD
         , C.GLINE_SEQ
         , COUNT(C.SVC_SCP_CD) AS LOC_CHK
    FROM PRI_RG_GRP_LOC C
        ,PRI_RG_GRP_LOC_DTL D
    WHERE C.SVC_SCP_CD = @[svc_scp_cd]
    AND   D.GLINE_SEQ = C.GLINE_SEQ
    AND   D.SVC_SCP_CD = C.SVC_SCP_CD
    AND   D.GLINE_SEQ = C.GLINE_SEQ
    AND   D.GRP_LOC_SEQ = C.GRP_LOC_SEQ
    GROUP BY C.SVC_SCP_CD, C.GLINE_SEQ
) LO
ON LO.SVC_SCP_CD = SG.SVC_SCP_CD
AND LO.GLINE_SEQ = SG.GLINE_SEQ
LEFT OUTER JOIN
(   -- Grp Commodity
    SELECT E.SVC_SCP_CD
         , E.GLINE_SEQ
         , COUNT(E.SVC_SCP_CD) AS CMDT_CHK
    FROM PRI_RG_GRP_CMDT E
        ,PRI_RG_GRP_CMDT_DTL F
    WHERE E.SVC_SCP_CD = @[svc_scp_cd]
    AND   F.GLINE_SEQ = E.GLINE_SEQ
    AND   F.SVC_SCP_CD = E.SVC_SCP_CD
    AND   F.GLINE_SEQ = E.GLINE_SEQ
    AND   F.GRP_CMDT_SEQ = E.GRP_CMDT_SEQ
    GROUP BY E.SVC_SCP_CD, E.GLINE_SEQ
) CM
ON CM.SVC_SCP_CD = SG.SVC_SCP_CD
AND CM.GLINE_SEQ = SG.GLINE_SEQ
LEFT OUTER JOIN
(   -- Orgin Arbitrary
    SELECT SVC_SCP_CD
         , GLINE_SEQ
         , COUNT(SVC_SCP_CD) AS ARB_ORG_CHK
    FROM PRI_RG_ARB
    WHERE SVC_SCP_CD = @[svc_scp_cd]
    AND   ORG_DEST_TP_CD = 'O'
    GROUP BY SVC_SCP_CD,GLINE_SEQ
) AO
ON AO.SVC_SCP_CD = SG.SVC_SCP_CD
AND AO.GLINE_SEQ = SG.GLINE_SEQ
LEFT OUTER JOIN
(   -- Destination Arbitrary
    SELECT SVC_SCP_CD
         , GLINE_SEQ
         , COUNT(SVC_SCP_CD) AS ARB_DES_CHK
    FROM PRI_RG_ARB
    WHERE SVC_SCP_CD = @[svc_scp_cd]
    AND   ORG_DEST_TP_CD = 'D'
    GROUP BY SVC_SCP_CD,GLINE_SEQ
) AD
ON AD.SVC_SCP_CD = SG.SVC_SCP_CD
AND AD.GLINE_SEQ = SG.GLINE_SEQ
LEFT OUTER JOIN
(   -- RATE 
    SELECT B.SVC_SCP_CD
         , B.GLINE_SEQ
         , COUNT(B.SVC_SCP_CD) AS RATE_CHK
    FROM PRI_RG_RT_CMDT_HDR B
    WHERE B.SVC_SCP_CD = @[svc_scp_cd]
    AND   (
        EXISTS (
            SELECT 'X'
            FROM PRI_RG_RT_CMDT C
            WHERE C.SVC_SCP_CD = B.SVC_SCP_CD
            AND   C.GLINE_SEQ = B.GLINE_SEQ
            AND   C.CMDT_HDR_SEQ = B.CMDT_HDR_SEQ
        )
        OR EXISTS (
            SELECT 'X'
            FROM PRI_RG_RT_CMDT_ROUT D
            WHERE D.SVC_SCP_CD = B.SVC_SCP_CD
            AND   D.GLINE_SEQ = B.GLINE_SEQ
            AND   D.CMDT_HDR_SEQ = B.CMDT_HDR_SEQ
            AND   (
                EXISTS (
                    SELECT 'X'
                    FROM PRI_RG_RT_ROUT_PNT E
                    WHERE E.SVC_SCP_CD = D.SVC_SCP_CD
                    AND   E.GLINE_SEQ = D.GLINE_SEQ
                    AND   E.CMDT_HDR_SEQ = D.CMDT_HDR_SEQ
                    AND   E.ROUT_SEQ = D.ROUT_SEQ
                )
                OR EXISTS (
                    SELECT 'X'
                    FROM PRI_RG_RT_ROUT_VIA F
                    WHERE F.SVC_SCP_CD = D.SVC_SCP_CD
                    AND   F.GLINE_SEQ = D.GLINE_SEQ
                    AND   F.CMDT_HDR_SEQ = D.CMDT_HDR_SEQ
                    AND   F.ROUT_SEQ = D.ROUT_SEQ
                )
                OR EXISTS (
                    SELECT 'X'
                    FROM PRI_RG_RT H
                    WHERE H.SVC_SCP_CD = D.SVC_SCP_CD
                    AND   H.GLINE_SEQ = D.GLINE_SEQ
                    AND   H.CMDT_HDR_SEQ = D.CMDT_HDR_SEQ
                    AND   H.ROUT_SEQ = D.ROUT_SEQ
                )
            )
        )
    )
    GROUP BY B.SVC_SCP_CD,B.GLINE_SEQ
) RT
ON RT.SVC_SCP_CD = SG.SVC_SCP_CD
AND RT.GLINE_SEQ = SG.GLINE_SEQ
LEFT OUTER JOIN
(   -- Exist Grp Location
    SELECT SVC_SCP_CD
         , COUNT(SVC_SCP_CD) AS CNT
    FROM PRI_RP_SCP_GRP_LOC
    WHERE PROP_NO = @[prop_no]
    AND   AMDT_SEQ = @[amdt_seq]
    AND   SVC_SCP_CD = @[svc_scp_cd]
    GROUP BY SVC_SCP_CD
) OL
ON OL.SVC_SCP_CD = SG.SVC_SCP_CD
LEFT OUTER JOIN
(   -- EXIST Grp Commodity
    SELECT SVC_SCP_CD
         , COUNT(SVC_SCP_CD) AS CNT
    FROM PRI_RP_SCP_GRP_CMDT
    WHERE PROP_NO = @[prop_no]
    AND   AMDT_SEQ = @[amdt_seq]
    AND   SVC_SCP_CD = @[svc_scp_cd]
    GROUP BY SVC_SCP_CD
) OC
ON OC.SVC_SCP_CD = SG.SVC_SCP_CD
LEFT OUTER JOIN
(   -- EXIST Orgin Arbitrary
    SELECT SVC_SCP_CD
         , COUNT(SVC_SCP_CD) AS CNT
    FROM PRI_RP_SCP_TRSP_ADD_CHG
    WHERE PROP_NO = @[prop_no]
    AND   AMDT_SEQ = @[amdt_seq]
    AND   SVC_SCP_CD = @[svc_scp_cd]
    AND   ADD_CHG_TP_CD = 'A'
    AND   ORG_DEST_TP_CD = 'O'
    GROUP BY SVC_SCP_CD
) OO
ON OO.SVC_SCP_CD = SG.SVC_SCP_CD
LEFT OUTER JOIN
(   -- EXIST Destination Arbitrary
    SELECT SVC_SCP_CD
         , COUNT(SVC_SCP_CD) AS CNT
    FROM PRI_RP_SCP_TRSP_ADD_CHG
    WHERE PROP_NO = @[prop_no]
    AND   AMDT_SEQ = @[amdt_seq]
    AND   SVC_SCP_CD = @[svc_scp_cd]
    AND   ADD_CHG_TP_CD = 'A'
    AND   ORG_DEST_TP_CD = 'D'
    GROUP BY SVC_SCP_CD
) OD
ON OD.SVC_SCP_CD = SG.SVC_SCP_CD
LEFT OUTER JOIN
(   -- EXIST RATE 
    SELECT B.SVC_SCP_CD
         , COUNT(B.SVC_SCP_CD) AS CNT
    FROM PRI_RP_SCP_RT_CMDT_HDR B
    WHERE B.PROP_NO = @[prop_no]
    AND   B.AMDT_SEQ = @[amdt_seq]
    AND   B.SVC_SCP_CD = @[svc_scp_cd]
    AND   (
        EXISTS (
            SELECT 'X'
            FROM PRI_RP_SCP_RT_CMDT C
            WHERE C.PROP_NO = B.PROP_NO
            AND   C.AMDT_SEQ = B.AMDT_SEQ
            AND   C.SVC_SCP_CD = B.SVC_SCP_CD
            AND   C.CMDT_HDR_SEQ = B.CMDT_HDR_SEQ
        )
        OR EXISTS (
            SELECT 'X'
            FROM PRI_RP_SCP_RT_CMDT_ROUT D
            WHERE D.PROP_NO = B.PROP_NO
            AND   D.AMDT_SEQ = B.AMDT_SEQ
            AND   D.SVC_SCP_CD = B.SVC_SCP_CD
            AND   D.CMDT_HDR_SEQ = B.CMDT_HDR_SEQ
            AND   (
                EXISTS (
                    SELECT 'X'
                    FROM PRI_RP_SCP_RT_ROUT_PNT E
                    WHERE E.PROP_NO = D.PROP_NO
                    AND   E.AMDT_SEQ = D.AMDT_SEQ
                    AND   E.SVC_SCP_CD = D.SVC_SCP_CD
                    AND   E.CMDT_HDR_SEQ = D.CMDT_HDR_SEQ
                    AND   E.ROUT_SEQ = D.ROUT_SEQ
                )
                OR EXISTS (
                    SELECT 'X'
                    FROM PRI_RP_SCP_RT_ROUT_VIA F
                    WHERE F.PROP_NO = D.PROP_NO
                    AND   F.AMDT_SEQ = D.AMDT_SEQ
                    AND   F.SVC_SCP_CD = D.SVC_SCP_CD
                    AND   F.CMDT_HDR_SEQ = D.CMDT_HDR_SEQ
                    AND   F.ROUT_SEQ = D.ROUT_SEQ
                )
                OR EXISTS (
                    SELECT 'X'
                    FROM PRI_RP_SCP_RT H
                    WHERE H.PROP_NO = D.PROP_NO
                    AND   H.AMDT_SEQ = D.AMDT_SEQ
                    AND   H.SVC_SCP_CD = D.SVC_SCP_CD
                    AND   H.CMDT_HDR_SEQ = D.CMDT_HDR_SEQ
                    AND   H.ROUT_SEQ = D.ROUT_SEQ
                )
            )
        )
    )
    GROUP BY B.SVC_SCP_CD
) OT
ON OT.SVC_SCP_CD = SG.SVC_SCP_CD
LEFT OUTER JOIN
(   -- RATE COMMODITY EXIST COUNT
    SELECT B.SVC_SCP_CD
         , B.GLINE_SEQ
         , COUNT(B.SVC_SCP_CD) AS CNT
    FROM RATE_CMDT A
        , PRI_RG_GRP_CMDT B
    WHERE B.SVC_SCP_CD = A.SVC_SCP_CD
    AND   B.GLINE_SEQ = A.GLINE_SEQ
    AND   B.PRC_GRP_CMDT_CD = A.PRC_CMDT_DEF_CD
    GROUP BY B.SVC_SCP_CD, B.GLINE_SEQ
) RC
ON  RC.SVC_SCP_CD = SG.SVC_SCP_CD
AND RC.GLINE_SEQ = SG.GLINE_SEQ
LEFT OUTER JOIN
(   -- RATE LOCATION POINT EXIST COUNT
    SELECT B.SVC_SCP_CD
         , B.GLINE_SEQ
         , COUNT(B.SVC_SCP_CD) AS CNT
    FROM RATE_LOC_PNT A
        ,PRI_RG_GRP_LOC B
    WHERE B.SVC_SCP_CD = A.SVC_SCP_CD
    AND   B.GLINE_SEQ = A.GLINE_SEQ
    AND   B.PRC_GRP_LOC_CD = A.ROUT_PNT_LOC_DEF_CD
    GROUP BY B.SVC_SCP_CD, B.GLINE_SEQ
) RP
ON  RP.SVC_SCP_CD = SG.SVC_SCP_CD
AND RP.GLINE_SEQ = SG.GLINE_SEQ
LEFT OUTER JOIN
(   -- RATE LOCATION VIA EXIST COUNT
    SELECT B.SVC_SCP_CD
         , B.GLINE_SEQ
         , COUNT(B.SVC_SCP_CD) AS CNT
    FROM RATE_LOC_VIA A
        ,PRI_RG_GRP_LOC B
    WHERE B.SVC_SCP_CD = A.SVC_SCP_CD
    AND   B.GLINE_SEQ = B.GLINE_SEQ
    AND   B.PRC_GRP_LOC_CD = A.ROUT_VIA_PORT_DEF_CD
    GROUP BY B.SVC_SCP_CD, B.GLINE_SEQ
) RV
ON  RV.SVC_SCP_CD = SG.SVC_SCP_CD
AND RV.GLINE_SEQ = SG.GLINE_SEQ
LEFT OUTER JOIN
(   --- ARBITRARY LOC EXIST CHECK
    SELECT A.SVC_SCP_CD
         , A.GLINE_SEQ
         , SUM(NVL((SELECT 1
		            FROM PRI_RG_GRP_LOC B
		            WHERE B.SVC_SCP_CD = A.SVC_SCP_CD
		            AND   B.GLINE_SEQ = A.GLINE_SEQ
		            AND   B.PRC_GRP_LOC_CD = A.BSE_PORT_DEF_CD
					AND   A.ORG_DEST_TP_CD = 'O'
           ),0)) AS AOL_CNT
         , SUM(NVL((SELECT 1
		            FROM PRI_RG_GRP_LOC B
		            WHERE B.SVC_SCP_CD = A.SVC_SCP_CD
		            AND   B.GLINE_SEQ = A.GLINE_SEQ
		            AND   B.PRC_GRP_LOC_CD = A.BSE_PORT_DEF_CD
					AND   A.ORG_DEST_TP_CD = 'D'
           ),0)) AS ADL_CNT
    FROM PRI_RG_ARB A
    WHERE A.SVC_SCP_CD = @[svc_scp_cd]
    GROUP BY A.SVC_SCP_CD, A.GLINE_SEQ
) AL
ON  AL.SVC_SCP_CD = SG.SVC_SCP_CD
AND AL.GLINE_SEQ = SG.GLINE_SEQ			]]></sql>
			<params>
				<param name="svc_scp_cd" type="12" value="" out="N"/>
				<param name="prop_no" type="12" value="" out="N"/>
				<param name="amdt_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
