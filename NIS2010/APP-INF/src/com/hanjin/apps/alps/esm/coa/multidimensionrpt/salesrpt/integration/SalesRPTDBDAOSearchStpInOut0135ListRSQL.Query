<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="SalesRPTDBDAOSearchStpInOut0135ListRSQL">
			<desc><![CDATA[STP Income/Cost Inquiry
2015.08.31 손진환 [CHM-201536992] Split14-[그룹사 표준 코드 시행] HJS 프로그램 대응 및 데이타 마이그레이션 작업 요청]]></desc>
			<sql><![CDATA[
SELECT   /*+ ORDERED INDEX(A XAK1COA_MON_VVD) */
   C.BKG_NO BKG_NO
  ,NVL(C.AGMT_SGN_OFC_CD, C.SLS_OFC_CD) AGMT_SGN_OFC_CD
  ,C.SLS_ACT_DESC
  ,C.COND_OFC_CD
  ,NVL(SUM(SVC_TRNS_PRC_AMT), 0) STP_REV
  ,NVL(SUM(SVC_TRNS_PRC_AMT), 0) - NVL(SUM(OTR_PRC_AMT), 0) STP_INCOME
  ,NVL(SUM(OTR_PRC_AMT), 0) OTH_COST
FROM COA_MON_VVD A, COA_BKG_SVC_TRNS_SMRY C, COA_OFC_LVL D
WHERE 1 = 1
  AND A.DELT_FLG       = 'N'
  AND C.BL_NO_TP       IN('M', '0')
  AND C.BKG_STS_CD     IN('F', 'S')
  AND C.BKG_CGO_TP_CD  NOT IN('P')
  AND A.VSL_CD         = C.VSL_CD
  AND A.SKD_VOY_NO     = C.SKD_VOY_NO
  AND A.DIR_CD         = C.DIR_CD
  AND A.RLANE_CD       = C.RLANE_CD
  AND A.TRD_CD         = C.TRD_CD
  AND A.IOC_CD         = C.IOC_CD 
  AND A.SLS_YRMON     BETWEEN D.OFC_APLY_FM_YRMON AND D.OFC_APLY_TO_YRMON 

#if(${f_vsl_cd} !='')
  AND A.VSL_CD         = @[f_trd_cd]
#end
#if(${f_skd_voy_no} !='')
  AND A.SKD_VOY_NO         = @[f_skd_voy_no]	
#end
#if(${f_dir_cd} !='')
  AND A.DIR_CD         = @[f_dir_cd]
#end
#if(${f_bkg_no} !='')
  AND C.BKG_NO         = @[f_bkg_no]
#end

#if(${f_stp_flg} =='Y')  /* Income */
  AND C.COND_OFC_CD   = D.OFC_CD
#else			
  AND C.COND_OFC_CD   NOT IN D.OFC_CD
  AND NVL(C.AGMT_SGN_OFC_CD, C.SLS_OFC_CD) = D.OFC_CD
#end			      
				      
#if(${f_sls_ofc_cd} !='')
  /* N200902110080   COA_SINWA 실적 조회 권한 관련 DECODE(SUBSTR(?, 1, 4), 'SHAR', 'SINRS', '') */
  AND DECODE(@[f_rhq_cd], '1', D.OFC_N1ST_LVL_CD, '2', D.OFC_N2ND_LVL_CD, '3', D.OFC_N3RD_LVL_CD, '4', D.OFC_N4TH_LVL_CD, '5', D.OFC_N5TH_LVL_CD, '6', D.OFC_N6TH_LVL_CD, '7', D.OFC_N7TH_LVL_CD) = @[f_sls_ofc_cd] 
#else
  /* N200902110080   COA_SINWA 실적 조회 권한 관련 DECODE(SUBSTR(?, 1, 4), 'SHAR', 'SINRS', '') */
  AND DECODE(@[f_ofc_lvl], '1', D.OFC_N1ST_LVL_CD, '2', D.OFC_N2ND_LVL_CD, '3', D.OFC_N3RD_LVL_CD, '4', D.OFC_N4TH_LVL_CD, '5',D.OFC_N5TH_LVL_CD, '6',D.OFC_N6TH_LVL_CD, '7', D.OFC_N7TH_LVL_CD) IN (@[f_ofc_cd], DECODE(SUBSTR(@[f_ofc_cd], 1, 4), 'SHAR', 'SINRS', '')) 
  AND DECODE(@[f_ofc_lvl], '1', D.OFC_N1ST_LVL_CD, '2', D.OFC_N2ND_LVL_CD, '3', D.OFC_N3RD_LVL_CD, '4', D.OFC_N4TH_LVL_CD, '5', D.OFC_N5TH_LVL_CD, '6', D.OFC_N6TH_LVL_CD, '7', D.OFC_N7TH_LVL_CD) IS NOT NULL  
  AND DECODE(@[f_ofc_lvl], '1', D.OFC_N1ST_LVL_CD, '2', D.OFC_N2ND_LVL_TP_CD,'3',D.OFC_N3RD_LVL_TP_CD, '4', DECODE(D.OFC_N4TH_LVL_CD,'NYCRA',D.OFC_N4TH_LVL_CD, D.OFC_N4TH_LVL_TP_CD),'5',D.OFC_N5TH_LVL_TP_CD,'6',D.OFC_N6TH_LVL_TP_CD,'7',D.OFC_N7TH_LVL_TP_CD) IS NOT NULL 
  /* 월관리 */
  AND DECODE(@[f_ofc_lvl], '1', D.OFC_N1ST_LVL_CD, '2', D.OFC_N2ND_LVL_TP_CD, '3', D.OFC_N3RD_LVL_TP_CD
            , '4', DECODE(SUBSTR(A.SLS_YRMON, 1, 4), '2008', DECODE(D.OFC_N4TH_LVL_CD, 'NYCRA', D.OFC_N4TH_LVL_CD, D.OFC_N4TH_LVL_TP_CD) 
                                                     , '2007', DECODE(D.OFC_N4TH_LVL_CD, 'NYCRA', D.OFC_N4TH_LVL_CD, D.OFC_N4TH_LVL_TP_CD) 
                                                     , DECODE(D.OFC_N4TH_LVL_CD, 'SZPDC', D.OFC_N4TH_LVL_TP_CD, D.OFC_N4TH_LVL_CD)) /* SHADSC만 AREA */
            , '5', D.OFC_N5TH_LVL_TP_CD, '6', D.OFC_N6TH_LVL_TP_CD,'7', D.OFC_N7TH_LVL_TP_CD) IS NOT NULL
#end

  AND SUBSTR(A.SLS_YRMON,0,4)||A.COST_WK = @[f_year]||@[f_wk]
GROUP BY C.COND_OFC_CD, NVL(C.AGMT_SGN_OFC_CD, C.SLS_OFC_CD), C.BKG_NO, C.SLS_ACT_DESC
ORDER BY C.COND_OFC_CD, NVL(C.AGMT_SGN_OFC_CD, C.SLS_OFC_CD), C.BKG_NO, C.SLS_ACT_DESC			]]></sql>
			<params>
				<param name="f_trd_cd" type="12" value="" out="N"/>
				<param name="f_skd_voy_no" type="12" value="" out="N"/>
				<param name="f_dir_cd" type="12" value="" out="N"/>
				<param name="f_bkg_no" type="12" value="" out="N"/>
				<param name="f_rhq_cd" type="12" value="" out="N"/>
				<param name="f_sls_ofc_cd" type="12" value="" out="N"/>
				<param name="f_ofc_lvl" type="12" value="" out="N"/>
				<param name="f_ofc_cd" type="12" value="" out="N"/>
				<param name="f_year" type="12" value="" out="N"/>
				<param name="f_wk" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
