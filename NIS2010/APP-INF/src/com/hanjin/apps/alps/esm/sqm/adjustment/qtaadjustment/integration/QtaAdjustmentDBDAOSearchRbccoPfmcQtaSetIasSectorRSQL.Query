<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="QtaAdjustmentDBDAOSearchRbccoPfmcQtaSetIasSectorRSQL">
			<desc><![CDATA[RBCCO PFMC = QTA Setting for IAS Sector 를 조회합니다.

* 2015.06.15 김용습 [CHM-201536164] 주간 MAS Open에 따른 타모듈 프로그램 적용 요청
* 2015.07.17 김용습 [CHM-201536875] [CSR 전환건] SQM의 CM Cost 산출 및 조회 로직 보완
* 2015.08.20 김용습 [CHM-201536994] Split24-[그룹사 표준 코드 시행] SML 프로그램 대응 및 데이타 마이그레이션 작업 요청
2016.01.07 SUBSTR(CNTR_TPSZ_CD, -1), 2 -> SUBSTR(CNTR_TPSZ_CD, -1), '2'로 변경]]></desc>
			<sql><![CDATA[
SELECT @[f_bse_yr] AS BSE_YR
      ,@[f_bse_qtr_cd] AS BSE_QTR_CD
      ,C1.TRD_CD
      ,C1.SUB_TRD_CD
      ,C1.OFC_VW_CD
      ,C1.RLANE_CD
      ,C1.DIR_CD
      ,C1.RHQ_CD
      ,C1.RGN_OFC_CD
      ,C1.COST_MON AS BSE_MON
      ,C1.COST_WK AS BSE_WK
      ,C1.LOD_QTY
      ,DECODE(C1.LOD_QTY, 0 , 0, TRUNC(C1.GRS_RPB_REV/C1.LOD_QTY)) AS GRS_RPB_REV
      ,DECODE(C1.LOD_QTY, 0 , 0, TRUNC(C1.PA_CM_COST/C1.LOD_QTY)) AS PA_CM_UC_AMT
      ,DECODE(C1.LOD_QTY, 0 , 0, TRUNC(C1.RA_CM_COST/C1.LOD_QTY)) AS RA_CM_UC_AMT
FROM (      
        SELECT B1.TRD_CD
              ,B1.SUB_TRD_CD
              ,DECODE(B2.CPY_NO, 0, 'Contract', 'Loading') AS OFC_VW_CD
              ,B1.RLANE_CD
              ,B1.DIR_CD
              ,DECODE(B2.CPY_NO, 0, B1.CTRT_RHQ_OFC, B1.SLS_RHQ_OFC) AS RHQ_CD
              ,DECODE(B2.CPY_NO, 0, B1.CTRT_RGN_OFC, B1.SLS_RGN_OFC) AS RGN_OFC_CD
        --      ,B1.CTRT_RHQ_OFC
        --      ,B1.CTRT_RGN_OFC
        --      ,B1.SLS_RHQ_OFC
        --      ,B1.SLS_RGN_OFC
              ,SUBSTR(B1.COST_YRMON, 5) AS COST_MON
              ,B1.COST_WK
              ,B1.LOD_QTY
              ,B1.GRS_RPB_REV
              ,B1.PA_CM_COST
              ,B1.RA_CM_COST
        FROM (      
                SELECT A1.TRD_CD
                      ,A1.SUB_TRD_CD
                      ,A1.RLANE_CD
                      ,A1.DIR_CD
                      ,A1.CTRT_RHQ_OFC
                      ,A1.CTRT_RGN_OFC
                      ,A1.SLS_RHQ_OFC
                      ,A1.SLS_RGN_OFC
                      ,A1.COST_YRMON
                      ,A1.COST_WK
                      ,SUM(A1.LOD_QTY) AS LOD_QTY
                      ,SUM(A1.GRS_RPB_REV) AS GRS_RPB_REV
                      ,SUM(A1.RA_CM_COST_TTL_AMT) AS PA_CM_COST
                      ,SUM(A1.PA_CM_COST_TTL_AMT) AS RA_CM_COST
                FROM (      
                        SELECT TRD_CD
                            ,SUB_TRD_CD
                            ,RLANE_CD
                            ,DIR_CD
                            ,NVL((SELECT N2ND_PRNT_OFC_CD FROM SQM_ORGANIZATION_V WHERE OFC_CD = CTRT_OFC_CD), 
                                 (SELECT RHQ_CD FROM SQM_QTA_OFC WHERE RGN_OFC_CD = CTRT_OFC_CD)) AS CTRT_RHQ_OFC
                            ,CASE WHEN    CTRT_OFC_CD = 'NYCRA'
                                       OR CTRT_OFC_CD = 'HAMRU'
                                       OR CTRT_OFC_CD = 'SINRS'
                                       OR CTRT_OFC_CD = 'SHARC' THEN SUBSTR(CTRT_OFC_CD, 1, 3)||'SC'
                                                                ELSE NVL((SELECT N4TH_PRNT_OFC_CD FROM SQM_ORGANIZATION_V WHERE OFC_CD = CTRT_OFC_CD),
                                                                         (SELECT RGN_OFC_CD FROM SQM_QTA_OFC WHERE RGN_OFC_CD = CTRT_OFC_CD))
                              END AS CTRT_RGN_OFC
                            ,NVL((SELECT N2ND_PRNT_OFC_CD FROM SQM_ORGANIZATION_V WHERE OFC_CD = SLS_OFC_CD),
                                 (SELECT RHQ_CD FROM SQM_QTA_OFC WHERE RGN_OFC_CD = SLS_OFC_CD)) AS SLS_RHQ_OFC
                            ,CASE WHEN    SLS_OFC_CD = 'NYCRA'
                                       OR SLS_OFC_CD = 'HAMRU'
                                       OR SLS_OFC_CD = 'SINRS'
                                       OR SLS_OFC_CD = 'SHARC' THEN SUBSTR(SLS_OFC_CD, 1, 3)||'SC'
                                                               ELSE NVL((SELECT N4TH_PRNT_OFC_CD FROM SQM_ORGANIZATION_V WHERE OFC_CD = SLS_OFC_CD),
                                                                        (SELECT RGN_OFC_CD FROM SQM_QTA_OFC WHERE RGN_OFC_CD = SLS_OFC_CD))
                              END AS SLS_RGN_OFC
                            ,COST_WK
                            ,COST_YRMON
                            ,DECODE(SUBSTR(CNTR_TPSZ_CD, -1), '2', BKG_QTY, BKG_QTY * 2) AS LOD_QTY
                            ,NVL(BKG_REV, 0) + NVL(BKG_OFT_REV, 0) + NVL(BKG_MISC_REV, 0) + NVL(SCR_CHG_REV, 0) AS GRS_RPB_REV
                            ,(RA_CM_COST_TTL_AMT - DMDT_COM_AMT) AS RA_CM_COST_TTL_AMT
                            ,(PA_CM_COST_TTL_AMT - DMDT_COM_AMT) AS PA_CM_COST_TTL_AMT 
                        FROM MAS_BKG_EXPN_DTL_WK
                        WHERE 1=1
#if (${f_bse_wk} != '' && ${f_bse_wk} != 'All')
                         AND SUBSTR(SLS_YRMON, 1, 4)||COST_WK = @[f_bse_yr]||@[f_bse_wk]
#else
                         AND SUBSTR(SLS_YRMON, 1, 4)||COST_WK BETWEEN @[f_bse_yr]||@[f_fm_wk] AND @[f_bse_yr]||@[f_to_wk]
#end                         
						 AND DELT_FLG      = 'N'
                         AND BKG_STS_CD    IN ('F','S','W')
                         AND BKG_CGO_TP_CD <> 'P'
                         AND BL_NO_TP      IN ('M','0')
                         AND RLANE_CD      = 'RBCCO'
                       ) A1   
                GROUP BY  A1.TRD_CD
                      ,A1.SUB_TRD_CD
                      ,A1.RLANE_CD
                      ,A1.DIR_CD
                      ,A1.CTRT_RHQ_OFC
                      ,A1.CTRT_RGN_OFC
                      ,A1.SLS_RHQ_OFC
                      ,A1.SLS_RGN_OFC
                      ,A1.COST_YRMON
                      ,A1.COST_WK
                ) B1, COM_CPY_NO  B2
        WHERE 1=1
        AND B2.CPY_NO        < 2
        
    ) C1, SQM_QTA_LANE_OFC C2
WHERE 1=1    
AND C2.BSE_TP_CD = 'Q'
AND C2.BSE_YR = @[f_bse_yr]
AND C2.BSE_QTR_CD = @[f_bse_qtr_cd]
AND C2.OFC_VW_CD = SUBSTR(C1.OFC_VW_CD,0,1)
AND C2.SUB_TRD_CD = C1.SUB_TRD_CD
AND C2.RLANE_CD = C1.RLANE_CD
AND C2.DIR_CD = C1.DIR_CD
AND C2.RHQ_CD = C1.RHQ_CD
AND C2.RGN_OFC_CD = C1.RGN_OFC_CD
AND C2.SQM_ACT_FLG = 'Y'    
ORDER BY TRD_CD, SUB_TRD_CD, RLANE_CD, DIR_CD,COST_WK, OFC_VW_CD, RHQ_CD, RGN_OFC_CD			]]></sql>
			<params>
				<param name="f_bse_yr" type="12" value="" out="N"/>
				<param name="f_bse_qtr_cd" type="12" value="" out="N"/>
				<param name="f_bse_wk" type="12" value="" out="N"/>
				<param name="f_fm_wk" type="12" value="" out="N"/>
				<param name="f_to_wk" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
