<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="GeneralBookingReceiptDBDAOSearchVskYardCngBkgListRSQL">
			<desc><![CDATA[Vessel Skedule 의 Yard 변경 시 그 Yard 가 Route 에 있는 BKG List를 조회한다.]]></desc>
			<sql><![CDATA[
SELECT BKG_NO
     , DECODE(DOC_USR_ID , 'HOMEPAGE'
                         , BKG_JOIN_FNC(CURSOR(SELECT USR_EML 
                                                 FROM COM_USER 
                                                WHERE USE_FLG = 'Y'
                                                  AND OFC_CD  = BK.BKG_OFC_CD), ';') -- HOMEPAGE 일 경우엔 BKG_OFC 모두에게         
                         , (SELECT USR_EML FROM COM_USER WHERE USR_ID = BK.DOC_USR_ID)
              ) EML
  FROM BKG_BOOKING BK
 WHERE BKG_NO IN
		(SELECT V.BKG_NO
		   FROM BKG_BOOKING B
              , BKG_VVD V
		  WHERE B.BKG_NO     = V.BKG_NO
			AND NVL(B.BKG_STS_CD, '') <> 'X'
		    AND V.VSL_CD     = substr(@[vvd], 1, 4)
		    AND V.SKD_VOY_NO = substr(@[vvd], 5, 4)
			AND V.SKD_DIR_CD = substr(@[vvd], 9, 1)
			AND ((V.POL_CD     = @[port_cd]
				  AND NVL(V.POL_CLPT_IND_SEQ, 1) = @[old_clpt_ind_seq])
				OR 
 				 (V.POD_CD     = @[port_cd]
				  AND NVL(V.POD_CLPT_IND_SEQ, 1) = @[old_clpt_ind_seq])
				)
            AND NOT EXISTS (SELECT 1 
                              FROM BKG_HRD_CDG_CTNT
                             WHERE HRD_CDG_ID = 'VSK_YD_CHG_EXPT'
                               AND NVL(ATTR_CTNT1,B.POL_CD)  = B.POL_CD
                               AND NVL(ATTR_CTNT2,B.POD_CD)  = B.POD_CD
                               AND NVL(ATTR_CTNT3,V.POL_CD)  = V.POL_CD
                               AND NVL(ATTR_CTNT4,V.POD_CD)  = V.POD_CD )
		)
 ORDER BY EML			]]></sql>
			<params>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="port_cd" type="12" value="" out="N"/>
				<param name="old_clpt_ind_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
