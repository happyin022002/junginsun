<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="SCProposalMainDBDAOPriSpMnFileDtVORSQL">
			<desc><![CDATA[* 2014.05.29 전윤주 [CHM-201430580] Filing 자동화 기능이 추가되어 조회 시 가져오는 정보 변경
* 2014.09.13 송호진 [CHM-201430558] 반영 포함 Check Out
* 2015.08.23 최성환 [CHM-201537109] Split19-[그룹사 표준 코드 시행] HJS 프로그램 대응 및 데이타 마이그레이션 작업 요청]]></desc>
			<sql><![CDATA[
SELECT A1.PROP_NO
      ,A1.AMDT_SEQ
      ,( SELECT TO_CHAR(FILE_DT, 'YYYYMMDD') 
           FROM PRI_SP_MN
          WHERE PROP_NO = A1.PROP_NO
            AND AMDT_SEQ = A1.AMDT_SEQ - 1 ) LAST_FILE_DT
      ,	CASE X.FMC_FILE_MDT_FLG 
			WHEN 'Y' THEN 
				DECODE ( ( SELECT  TO_CHAR(FMC_FILE_CFM_DT, 'YYYY-MM-DD HH24:MI')
                  FROM    PRI_SP_FILE_PROG
                  WHERE   PROP_NO = A1.PROP_NO
                  AND     AMDT_SEQ = A1.AMDT_SEQ
                  AND     FILE_PROG_SEQ = ( SELECT  MAX(FILE_PROG_SEQ)
                                            FROM    PRI_SP_FILE_PROG
                                            WHERE   PROP_NO = A1.PROP_NO
                                            AND     AMDT_SEQ = A1.AMDT_SEQ
                                            AND     FMC_FILE_TP_CD = 'S' ) )
                , NULL, TO_CHAR(GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC('NYCSC'), 'YYYYMMDD')
                , 'Error', TO_CHAR(GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC('NYCSC'), 'YYYYMMDD')
                , TO_CHAR( A1.EFF_DT, 'YYYYMMDD') ) 
			WHEN 'N' THEN 
				TO_CHAR(GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC(@[prop_ofc_cd]),  'YYYYMMDD') 
			END AS EFF_DT 
      --  CFM_NO 가 NULL 이거나 Error 일 때. 즉, FileContract ( Send ) 경우에만 미주 동부 시간 기본 세팅 
      --, TO_CHAR(GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC('NYCSC'), 'YYYYMMDD') EFF_DT -- 미주 동부 시간 기본 세팅
      ,TO_CHAR(GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC('NYCSC'), 'YYYY-MM-DD HH24:MI') US_EST_SYS_DT --미국 동부시간 기준 잡기 위해 office 지정
      ,( SELECT TO_CHAR(EFF_DT, 'YYYYMMDD') 
           FROM PRI_SP_MN
          WHERE PROP_NO = A1.PROP_NO
            AND AMDT_SEQ = A1.AMDT_SEQ - 1 ) PRE_EFF_DT    
      ,( SELECT TO_CHAR(FMC_FILE_CFM_DT, 'YYYY-MM-DD HH24:MI')
           FROM PRI_SP_FILE_PROG
          WHERE PROP_NO = A1.PROP_NO
            AND AMDT_SEQ = A1.AMDT_SEQ
            AND FILE_PROG_SEQ = (    
                                  SELECT MAX(FILE_PROG_SEQ)
                                    FROM PRI_SP_FILE_PROG
                                   WHERE PROP_NO = A1.PROP_NO
                                     AND AMDT_SEQ = A1.AMDT_SEQ
                                     AND FMC_FILE_TP_CD = 'S' 
                                ) -- sending type 중에 가장 마지막
        ) FMC_FILE_CFM_DT
        
      ,( SELECT CFM_NO
           FROM PRI_SP_FILE_PROG
          WHERE PROP_NO = A1.PROP_NO
            AND AMDT_SEQ = A1.AMDT_SEQ
            AND FILE_PROG_SEQ = (    
                                  SELECT MAX(FILE_PROG_SEQ)
                                    FROM PRI_SP_FILE_PROG
                                   WHERE PROP_NO = A1.PROP_NO
                                     AND AMDT_SEQ = A1.AMDT_SEQ
                                     AND FMC_FILE_TP_CD = 'S' 
                                ) -- sending type 중에 가장 마지막
       ) CFM_NO
       
      ,( SELECT (SELECT USR_NM FROM COM_USER WHERE USR_ID = PROG.FILE_PROG_USR_ID)
           FROM PRI_SP_FILE_PROG PROG
          WHERE PROP_NO = A1.PROP_NO
            AND AMDT_SEQ = A1.AMDT_SEQ
            AND FILE_PROG_SEQ = (    
                                  SELECT MAX(FILE_PROG_SEQ)
                                    FROM PRI_SP_FILE_PROG
                                   WHERE PROP_NO = A1.PROP_NO
                                     AND AMDT_SEQ = A1.AMDT_SEQ
                                     AND FMC_FILE_TP_CD = 'S' 
                                ) -- sending type 중에 가장 마지막
       ) FILE_STFF
      ,( SELECT TO_CHAR(FMC_FILE_CFM_DT, 'YYYY-MM-DD HH24:MI')
           FROM PRI_SP_FILE_PROG
          WHERE PROP_NO = A1.PROP_NO
            AND AMDT_SEQ = A1.AMDT_SEQ
            AND FILE_PROG_SEQ = (    
                                  SELECT MAX(FILE_PROG_SEQ)
                                    FROM PRI_SP_FILE_PROG
                                   WHERE PROP_NO = A1.PROP_NO
                                     AND AMDT_SEQ = A1.AMDT_SEQ
                                     AND FMC_FILE_TP_CD = 'C' 
                                ) -- correction type 중에 가장 마지막
       ) FNL_CT_DT
      ,( SELECT CFM_NO
           FROM PRI_SP_FILE_PROG
          WHERE PROP_NO = A1.PROP_NO
            AND AMDT_SEQ = A1.AMDT_SEQ
            AND FILE_PROG_SEQ = (    
                                  SELECT MAX(FILE_PROG_SEQ)
                                    FROM PRI_SP_FILE_PROG
                                   WHERE PROP_NO = A1.PROP_NO
                                     AND AMDT_SEQ = A1.AMDT_SEQ
                                     AND FMC_FILE_TP_CD = 'C' 
                                ) -- correction type 중에 가장 마지막
       ) FNL_CT_CFM_NO
      ,( SELECT (SELECT USR_NM FROM COM_USER WHERE USR_ID = PROG.FILE_PROG_USR_ID)
           FROM PRI_SP_FILE_PROG PROG
          WHERE PROP_NO = A1.PROP_NO
            AND AMDT_SEQ = A1.AMDT_SEQ
            AND FILE_PROG_SEQ = (    
                                  SELECT MAX(FILE_PROG_SEQ)
                                    FROM PRI_SP_FILE_PROG
                                   WHERE PROP_NO = A1.PROP_NO
                                     AND AMDT_SEQ = A1.AMDT_SEQ
                                     AND FMC_FILE_TP_CD = 'C' 
                                ) -- correction type 중에 가장 마지막
           ) FNL_CT_STFF
      ,( SELECT COUNT(FILE_PROG_SEQ)
          FROM PRI_SP_FILE_PROG
         WHERE PROP_NO = A1.PROP_NO
           AND AMDT_SEQ = A1.AMDT_SEQ
           AND FMC_FILE_TP_CD = 'C' ) CT_CNT            
        
      ,( SELECT FILE_CORR_CMT_CTNT
           FROM PRI_SP_FILE_PROG
          WHERE PROP_NO = A1.PROP_NO
            AND AMDT_SEQ = A1.AMDT_SEQ
            AND FILE_PROG_SEQ = (    
                                  SELECT MAX(FILE_PROG_SEQ)
                                    FROM PRI_SP_FILE_PROG
                                   WHERE PROP_NO = A1.PROP_NO
                                     AND AMDT_SEQ = A1.AMDT_SEQ
                                     AND FMC_FILE_TP_CD = 'C' 
                                ) -- correction type 중에 가장 마지막
        ) FILE_CORR_CMT_CTNT
        
      ,HOM_MLT_RTN_PKG.HOM_TBL_TO_STR_FNC( CURSOR( 
                                                 SELECT FMC_FILE_ERR_MSG
                                                   FROM PRI_SP_FILE_ERR
                                                  WHERE PROP_NO = A1.PROP_NO
                                                    AND AMDT_SEQ = A1.AMDT_SEQ
                                                    AND FILE_PROG_SEQ = (    
                                                                          SELECT MAX(FILE_PROG_SEQ) -- 현재 진행된 가장 마지막 progress
                                                                            FROM PRI_SP_FILE_PROG
                                                                           WHERE PROP_NO = A1.PROP_NO
                                                                             AND AMDT_SEQ = A1.AMDT_SEQ
                                                                        ) 
                                                  )
                                           )FMC_FILE_ERR_MSG
      , TO_CHAR(A1.FILE_DT, 'YYYYMMDD')  AS FILE_DT
      , X.FMC_FILE_MDT_FLG
      , '' AS FILE_PROG_SEQ
      , '' AS FMC_FILE_TP_CD
      , '' AS FILE_EFF_DT
      , '' AS FMC_FILE_SND_DT
      , '' AS FILE_PROG_DT
      , '' AS FILE_PROG_USR_ID
      , '' AS FMC_FILE_NM
      , '' AS ORZ_NO
      , '' AS FMC_CTRT_NO
      , '' AS FMC_AMDT_NO
      , '' AS FMC_FILE_USR_ID
      , '' AS FMC_FILE_SESS_ID
      , '' AS FMC_NO
      , '' AS FMC_EFF_DT
      , '' AS FILE_SZ_CAPA
      , '' AS MNL_FILE_FLG
      , '' AS CRE_USR_ID
      , '' AS UPD_USR_ID
      , '' AS ERR_CODE_USER_NAME
      , '' AS ERR_CODE_ORG_NUM
      , '' AS ERR_CODE_CON_NUM
      , '' AS ERR_CODE_AMD_NUM
      , '' AS ERR_CODE_EFF_DATE
      , '' AS ERR_CODE_FILE
      , '' AS ERR_MSG_USER_NAME
      , '' AS ERR_MSG_ORG_NUM
      , '' AS ERR_MSG_CON_NUM
      , '' AS ERR_MSG_AMD_NUM
      , '' AS ERR_MSG_EFF_DATE
      , '' AS ERR_MSG_FILE
      , '' AS SC_NO
      , '' AS PROP_OFC_CD
      , '' AS EFF_DT_CHG
FROM 	PRI_SP_MN A1
	,	PRI_SP_HDR H
	,	PRI_SC_PFX X
WHERE 	A1.PROP_NO = @[prop_no]
AND 	A1.AMDT_SEQ  = @[amdt_seq]
AND		A1.PROP_NO = H.PROP_NO
AND		SUBSTR ( H.SC_NO, 1, 3 ) = X.SC_PFX_CD			]]></sql>
			<params>
				<param name="prop_ofc_cd" type="12" value="" out="N"/>
				<param name="prop_no" type="12" value="" out="N"/>
				<param name="amdt_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
