<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CsScreenDBDAOsearchCntrClmInfoRSQL">
			<desc><![CDATA[US I/B CS Screen에서 B/L No 기준으로 Estimate + Actual Container Movement Detail 정보를 조회한다.]]></desc>
			<sql><![CDATA[
SELECT CNTR_NO              AS CNTR_NO
      ,CS.CLM_SGHT_ABBR_NM  AS MVMT_STS_NM
      ,MVMT_EVNT_DT         AS MVMT_EVNT_DT
      ,ORG_YD_CD            AS ORG_YD_CD
      ,DEST_YD_CD           AS DEST_YD_CD
      ,CLM_CRR_NM           AS CLM_CRR_NM
      ,TRN_NO               AS TRN_NO
      ,FCAR_NO              AS FCAR_NO 
FROM
(
    SELECT CL.CNTR_NO                                       AS CNTR_NO
          ,TO_CHAR(CL.ARR_DT, 'YYYY/MM/DD HH24:MI')         AS MVMT_EVNT_DT
          ,CL.ARR_LOC_NM|| '  ' ||CL.ARR_STE_CD             AS ORG_YD_CD
          ,CL.DEP_LOC_NM|| '  ' ||CL.DEP_STE_CD             AS DEST_YD_CD
          ,CL.CLM_CRR_NM                                    AS CLM_CRR_NM
          ,CL.TRN_NO                                        AS TRN_NO
          ,CL.FCAR_NO                                       AS FCAR_NO 
           ,CL.CLM_SGHT_CD 
    FROM (
           SELECT  BCNTR.BKG_NO
                  ,BCNTR.CNTR_NO 
                  , ( SELECT /*+ INDEX_DESC ( MVMT XPKCTM_MOVEMENT) */
                          TO_CHAR(CNMV_EVNT_DT,'YYYY/MM/DD HH24:MI')
                     FROM CTM_MOVEMENT MVMT
                     WHERE MVMT.BKG_NO = BCNTR.BKG_NO    
                       AND MVMT.CNTR_NO = BCNTR.CNTR_NO 
                       AND MVMT.CNMV_CYC_NO = BCNTR.CNMV_CYC_NO
                       AND MVMT.MVMT_STS_CD = 'VD'
                       AND ROWNUM = 1
                   ) FROM_DT
                 , ( SELECT /*+ INDEX_DESC ( MVMT XPKCTM_MOVEMENT) */ 
                            DECODE( COUNT(CNMV_EVNT_DT),0, TO_CHAR(SYSDATE,'YYYY/MM/DD HH24:MI'),MAX( TO_CHAR(CNMV_EVNT_DT,'YYYY/MM/DD HH24:MI') ) ) 
                     FROM CTM_MOVEMENT MVMT
                     WHERE MVMT.BKG_NO = BCNTR.BKG_NO    
                       AND MVMT.CNTR_NO = BCNTR.CNTR_NO 
                       AND MVMT.CNMV_CYC_NO = BCNTR.CNMV_CYC_NO
                       AND MVMT.MVMT_STS_CD = 'MT' 
                       AND ROWNUM = 1      
                   ) TO_DT
           FROM BKG_CONTAINER BCNTR
           WHERE BKG_NO  = @[bkg_no]
           AND   CNTR_NO = @[cntr_no]   
         ) SUB_MAIN
         , SCE_CLM CL
    WHERE  CL.CNTR_NO = SUB_MAIN.CNTR_NO
       AND CL.ARR_DT >=  TO_DATE(SUB_MAIN.FROM_DT, 'YYYY/MM/DD HH24:MI') 
       AND CL.ARR_DT <=  TO_DATE(SUB_MAIN.TO_DT, 'YYYY/MM/DD HH24:MI')
    UNION 
    SELECT CI.CNTR_NO                                       AS CNTR_NO
          ,TO_CHAR(CI.ARR_DT, 'YYYY/MM/DD HH24:MI')         AS MVMT_EVNT_DT
          ,CI.ARR_LOC_NM|| '  ' ||CI.ARR_STE_CD             AS ORG_YD_CD
          ,CI.DEP_LOC_NM|| '  ' ||CI.DEP_STE_CD             AS DEST_YD_CD
          ,CI.CLM_CRR_NM                                    AS CLM_CRR_NM
          ,CI.TRN_NO                                        AS TRN_NO
          ,CI.FCAR_NO                                       AS FCAR_NO  
          ,CI.CLM_SGHT_CD
    FROM (
           SELECT  BCNTR.BKG_NO
                  ,BCNTR.CNTR_NO 
                  , ( SELECT /*+ INDEX_DESC ( MVMT XPKCTM_MOVEMENT) */
                          TO_CHAR(CNMV_EVNT_DT,'YYYY/MM/DD HH24:MI')
                     FROM CTM_MOVEMENT MVMT
                     WHERE MVMT.BKG_NO = BCNTR.BKG_NO    
                       AND MVMT.CNTR_NO = BCNTR.CNTR_NO 
                       AND MVMT.CNMV_CYC_NO = BCNTR.CNMV_CYC_NO
                       AND MVMT.MVMT_STS_CD = 'VD'
                       AND ROWNUM = 1
                   ) FROM_DT
                 , ( SELECT /*+ INDEX_DESC ( MVMT XPKCTM_MOVEMENT) */ 
                            DECODE( COUNT(CNMV_EVNT_DT),0, TO_CHAR(SYSDATE,'YYYY/MM/DD HH24:MI'),MAX( TO_CHAR(CNMV_EVNT_DT,'YYYY/MM/DD HH24:MI') ) ) 
                     FROM CTM_MOVEMENT MVMT
                     WHERE MVMT.BKG_NO = BCNTR.BKG_NO    
                       AND MVMT.CNTR_NO = BCNTR.CNTR_NO 
                       AND MVMT.CNMV_CYC_NO = BCNTR.CNMV_CYC_NO
                       AND MVMT.MVMT_STS_CD = 'MT' 
                       AND ROWNUM = 1      
                   ) TO_DT
           FROM BKG_CONTAINER BCNTR
           WHERE BKG_NO  = @[bkg_no]
           AND   CNTR_NO = @[cntr_no]     
         ) SUB_MAIN
         , SCE_CLM_IF CI
    WHERE  CI.CNTR_NO = SUB_MAIN.CNTR_NO
       AND CI.ARR_DT >=  TO_DATE(SUB_MAIN.FROM_DT, 'YYYY/MM/DD HH24:MI') 
       AND CI.ARR_DT <=  TO_DATE(SUB_MAIN.TO_DT, 'YYYY/MM/DD HH24:MI')
       	AND   CI.SO_MAPG_STS_CD != '52'
)SUB_MAIN, SCE_CLM_SGHT CS  
WHERE 1=1
AND CS.CLM_SGHT_CD(+) = SUB_MAIN.CLM_SGHT_CD
ORDER BY 3 DESC			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="cntr_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
