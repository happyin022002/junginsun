<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="DailyForecastManageDBDAOSearchSlsRepAcctListRSQL">
			<desc><![CDATA[Sales Rep별 화주 정보 조회
[CHM-201322502-01] SPC 프로젝트 - 성수기 선복운영 개선을 위한 T/F추진
2013.05.02 진마리아 [CHM-201324211] 프로젝트 안정화 및 HELP DESK - Sub Trade 조회시 Trade 조회조건 누락]]></desc>
			<sql><![CDATA[
SELECT   A.SREP_CD
         , A.CUST_CNT_CD||TO_CHAR(A.CUST_SEQ, 'FM000000') AS CUST_CD
         , A.CUST_CNT_CD
         , A.CUST_SEQ
         , A.CUST_NM
         , A.RVIS_CNTR_CUST_TP_CD
         , A.SLS_OFC_CD
         , A.SLS_REP_OFC_TEAM_CD
         , MAX(A.CUST_INDIV_FLG) AS CUST_INDIV_FLG
         , DECODE(A.CUST_CNT_CD||A.CUST_SEQ, 'XX999999', 'Y', NVL((SELECT MAX('Y')
                                                                     FROM BKG_CUST_SLS_REP
                                                                    WHERE CUST_CNT_CD = A.CUST_CNT_CD
                                                                      AND CUST_SEQ    = A.CUST_SEQ
                                                                      AND DELT_FLG    = 'N'
                                                                      AND SREP_CD     = A.SREP_CD), 'N')) AS EXIST_FLG
         , MAX(SUB_TRD_CD) AS SUB_TRD_CD
    FROM (
            SELECT DISTINCT --20130422 추가
                   A.SREP_CD
                   , NVL((SELECT MAX(INDIV_CUST_USE_FLG)
                            FROM SPC_SLS_REP_CUST
                           WHERE TRD_CD      = @[trade]
                             AND SREP_CD     = A.SREP_CD
                             AND CUST_CNT_CD = A.CUST_CNT_CD
                             AND CUST_SEQ    = A.CUST_SEQ), 'N') AS CUST_INDIV_FLG
                   , A.CUST_CNT_CD
                   , A.CUST_SEQ
                   , C.CUST_LGL_ENG_NM AS CUST_NM
                   , C.RVIS_CNTR_CUST_TP_CD
                   , M.OFC_CD AS SLS_OFC_CD
                   , I.SLS_REP_OFC_TEAM_CD
              FROM SPC_SLS_REP_CUST    A,
                   MDM_SLS_REP         M,
                   MDM_CUSTOMER        C,
                   SPC_SLS_REP_TEAM_IF I
             WHERE A.SREP_CD     = M.SREP_CD
               AND A.CUST_CNT_CD = C.CUST_CNT_CD
               AND A.CUST_SEQ    = C.CUST_SEQ
               AND A.TRD_CD IN ('*', @[trade])
               AND A.DELT_FLG    = 'N'
               AND A.SREP_CD     = I.SREP_USR_ID(+)
               AND A.CUST_CNT_CD||A.CUST_SEQ <> 'XX999999'

#if(${srep_cd} != '')
               AND A.SREP_CD     = @[srep_cd]
#end

#if(${cust_cnt_cd} != '')
               AND C.CUST_CNT_CD = @[cust_cnt_cd]
#end
#if(${cust_seq} != '')
               AND C.CUST_SEQ    = TO_NUMBER(@[cust_seq])
#end
#if(${cust_nm} != '')
               AND UPPER(C.CUST_LGL_ENG_NM) LIKE '%'||UPPER(@[cust_nm])||'%'
#end

          UNION ALL
            SELECT   A.SREP_CD
                   , 'N' AS CUST_INDIV_FLG
                   , A.CUST_CNT_CD
                   , A.CUST_SEQ
                   , C.CUST_LGL_ENG_NM AS CUST_NM
                   , C.RVIS_CNTR_CUST_TP_CD
                   , M.OFC_CD AS SLS_OFC_CD
                   , I.SLS_REP_OFC_TEAM_CD
              FROM BKG_CUST_SLS_REP    A,
                   MDM_SLS_REP         M,
                   MDM_CUSTOMER        C,
                   SPC_SLS_REP_TEAM_IF I
             WHERE A.SREP_CD     = M.SREP_CD
               AND A.CUST_CNT_CD = C.CUST_CNT_CD
               AND A.CUST_SEQ    = C.CUST_SEQ
               AND A.DELT_FLG    = 'N'
               AND A.SREP_CD     = I.SREP_USR_ID(+)

#if(${srep_cd} != '')
               AND A.SREP_CD     = @[srep_cd]
#end

#if(${cust_cnt_cd} != '')
               AND C.CUST_CNT_CD = @[cust_cnt_cd]
#end
#if(${cust_seq} != '')
               AND C.CUST_SEQ    = TO_NUMBER(@[cust_seq])
#end
#if(${cust_nm} != '')
               AND UPPER(C.CUST_LGL_ENG_NM) LIKE '%'||UPPER(@[cust_nm])||'%'
#end

          UNION ALL
            SELECT   @[srep_cd] AS SREP_CD
                   , NVL((SELECT MAX(INDIV_CUST_USE_FLG)
                            FROM SPC_SLS_REP_CUST
                           WHERE TRD_CD      = @[trade]
                             AND SREP_CD     = @[srep_cd]
                             AND CUST_CNT_CD = 'XX'
                             AND CUST_SEQ    = 999999), 'Y') AS CUST_INDIV_FLG
                   , 'XX' AS CUST_CNT_CD
                   , 999999 AS CUST_SEQ
                   , 'OTHERS' AS CUST_NM
                   , 'N' AS RVIS_CNTR_CUST_TP_CD
                   , @[sls_ofc_cd] AS SLS_OFC_CD
                   , NULL AS SLS_REP_OFC_TEAM_CD
              FROM DUAL
         ) A,
         (
            SELECT   SREP_CD
                   , CUST_INDIV_FLG
                   , CUST_CNT_CD
                   , CUST_SEQ
                   , CUST_NM
                   , RVIS_CNTR_CUST_TP_CD
                   , SLS_OFC_CD
                   , SLS_REP_OFC_TEAM_CD
                   , SUBSTR(MAX(SYS_CONNECT_BY_PATH(SUB_TRD_CD, ',')), 2) AS SUB_TRD_CD
              FROM (
                      SELECT   DISTINCT
                               A.SREP_CD
                             , NVL((SELECT MAX(INDIV_CUST_USE_FLG)
                                      FROM SPC_SLS_REP_CUST
                                     WHERE TRD_CD      = @[trade]
                                       AND SREP_CD     = A.SREP_CD
                                       AND CUST_CNT_CD = A.CUST_CNT_CD
                                       AND CUST_SEQ    = A.CUST_SEQ), 'N') AS CUST_INDIV_FLG
                             , A.CUST_CNT_CD
                             , A.CUST_SEQ
                             , C.CUST_LGL_ENG_NM AS CUST_NM
                             , C.RVIS_CNTR_CUST_TP_CD
                             , M.OFC_CD AS SLS_OFC_CD
                             , I.SLS_REP_OFC_TEAM_CD
                             , A.SUB_TRD_CD
                             , DENSE_RANK() OVER (PARTITION BY A.CUST_CNT_CD, A.CUST_SEQ ORDER BY SUB_TRD_CD) AS RNUM
                        FROM SPC_SLS_REP_CUST      A,
                             MDM_SLS_REP           M,
                             MDM_CUSTOMER          C,
                             SPC_SLS_REP_TEAM_IF   I
                       WHERE A.SREP_CD     = M.SREP_CD
                         AND A.CUST_CNT_CD = C.CUST_CNT_CD
                         AND A.CUST_SEQ    = C.CUST_SEQ
                         AND A.TRD_CD IN ('*', @[trade])
                         AND A.DELT_FLG    = 'N'
                         AND A.SREP_CD     = I.SREP_USR_ID(+)
                         AND A.CUST_CNT_CD||A.CUST_SEQ <> 'XX999999'
                         AND A.SUB_TRD_CD <> '*'

#if(${srep_cd} != '')
                         AND A.SREP_CD     = @[srep_cd]
#end

#if(${cust_cnt_cd} != '')
                         AND C.CUST_CNT_CD = @[cust_cnt_cd]
#end
#if(${cust_seq} != '')
                         AND C.CUST_SEQ    = TO_NUMBER(@[cust_seq])
#end
#if(${cust_nm} != '')
                         AND UPPER(C.CUST_LGL_ENG_NM) LIKE '%'||UPPER(@[cust_nm])||'%'
#end

                      UNION ALL
                      SELECT DISTINCT --20130422 추가
                             SREP_CD
                             , INDIV_CUST_USE_FLG
                             , CUST_CNT_CD
                             , CUST_SEQ
                             , 'OTHERS' AS CUST_NM
                             , RVIS_CNTR_CUST_TP_CD
                             , SLS_OFC_CD
                             , NULL AS SLS_REP_OFC_TEAM_CD
                             , SUB_TRD_CD
                             , DENSE_RANK() OVER (PARTITION BY CUST_CNT_CD, CUST_SEQ ORDER BY SUB_TRD_CD) AS RNUM
                        FROM SPC_SLS_REP_CUST
                       WHERE TRD_CD  = @[trade]
                         AND SREP_CD = @[srep_cd]
                         AND CUST_CNT_CD||CUST_SEQ= 'XX999999'
                   )
        START WITH RNUM = 1
        CONNECT BY PRIOR RNUM = RNUM - 1 AND PRIOR CUST_CNT_CD = CUST_CNT_CD AND PRIOR CUST_SEQ = CUST_SEQ
          GROUP BY   SREP_CD
                   , CUST_INDIV_FLG
                   , CUST_CNT_CD
                   , CUST_SEQ
                   , CUST_NM
                   , RVIS_CNTR_CUST_TP_CD
                   , SLS_OFC_CD
                   , SLS_REP_OFC_TEAM_CD
         ) B
   WHERE 1=1
     AND A.SREP_CD              = B.SREP_CD             (+)
     AND A.CUST_INDIV_FLG       = B.CUST_INDIV_FLG      (+)
     AND A.CUST_CNT_CD          = B.CUST_CNT_CD         (+)
     AND A.CUST_SEQ             = B.CUST_SEQ            (+)
     AND A.CUST_NM              = B.CUST_NM             (+)
     AND A.RVIS_CNTR_CUST_TP_CD = B.RVIS_CNTR_CUST_TP_CD(+)
     AND A.SLS_OFC_CD           = B.SLS_OFC_CD          (+)
     AND NVL(A.SLS_REP_OFC_TEAM_CD, 'X') = NVL(B.SLS_REP_OFC_TEAM_CD (+) , NVL(A.SLS_REP_OFC_TEAM_CD, 'X'))
GROUP BY   A.SREP_CD
         , A.CUST_CNT_CD
         , A.CUST_SEQ
         , A.CUST_NM
         , A.RVIS_CNTR_CUST_TP_CD
         , A.SLS_OFC_CD
         , A.SLS_REP_OFC_TEAM_CD
ORDER BY   A.SREP_CD
         , DECODE(A.CUST_CNT_CD, 'XX', 0)         
         , CUST_INDIV_FLG DESC
         , A.CUST_CNT_CD
         , A.CUST_SEQ			]]></sql>
			<params>
				<param name="trade" type="12" value="" out="N"/>
				<param name="srep_cd" type="12" value="" out="N"/>
				<param name="cust_cnt_cd" type="12" value="" out="N"/>
				<param name="cust_seq" type="12" value="" out="N"/>
				<param name="cust_nm" type="12" value="" out="N"/>
				<param name="sls_ofc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
