<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BlRatingDBDAOModifyChargeRateTempForCMPBDSQL">
			<desc><![CDATA[CMPB산출을 위해 BKG Creation/Update시 BKG Volume에 해당되는 최저 Revenue만 남기고 나머지 정보는 삭제함]]></desc>
			<sql><![CDATA[
DELETE
FROM BKG_AUTO_RT_OCN_FRT_TMP
WHERE (BKG_NO, OFT_CMB_SEQ, CNTR_TPSZ_CD, CTRT_CNTR_TPSZ_CD)
    NOT IN (SELECT BKG_NO, OFT_CMB_SEQ, CNTR_TPSZ_CD, CTRT_CNTR_TPSZ_CD
            FROM (
                    SELECT T.BKG_NO, T.OFT_CMB_SEQ, T.CNTR_TPSZ_CD, T.CTRT_CNTR_TPSZ_CD,
                           ROW_NUMBER() OVER (PARTITION BY Q.CNTR_TPSZ_CD, Q.CTRT_CNTR_TPSZ_CD, Q.SUBST_SEQ
                                              ORDER BY T.CHG_AMT) RNUM
                    FROM (SELECT BKG_NO, 
                                 CNTR_TPSZ_CD, 
                                 SUBST_SEQ,
                                 CASE WHEN CNTR_TPSZ_CD LIKE 'R%' AND DRY_CGO_FLG = 'Y' -- RD 인 경우만 예외처리  
                                              THEN CNTR_TPSZ_CD  
                                      ELSE NVL(EQ_SUBST_CNTR_TPSZ_CD, CNTR_TPSZ_CD)  
                                 END CTRT_CNTR_TPSZ_CD,
                                 DRY_CGO_FLG,
                                 AWK_CGO_FLG,
                                 DCGO_FLG,
                                 RC_FLG,
                                 BB_CGO_FLG
                          FROM BKG_QTY_DTL
                          WHERE BKG_NO = @[bkg_no]) Q, 
                         BKG_AUTO_RT_OCN_FRT_TMP T
                    WHERE Q.BKG_NO = @[bkg_no]
                    -- AND Q.CNTR_TPSZ_CD  NOT LIKE 'Q%'
                    AND Q.CNTR_TPSZ_CD = T.CNTR_TPSZ_CD
                    AND Q.CTRT_CNTR_TPSZ_CD = T.CTRT_CNTR_TPSZ_CD
                    AND Q.BKG_NO = T.BKG_NO
                    AND T.CHG_CD = 'OFT'
                    AND Q.DRY_CGO_FLG = T.DRY_CGO_FLG
                    AND Q.AWK_CGO_FLG = T.AWK_CGO_FLG
                    AND Q.DCGO_FLG = T.DCGO_FLG
                    AND Q.RC_FLG = T.RC_FLG
                    AND Q.BB_CGO_FLG = T.BB_CGO_FLG
               )
            WHERE RNUM = 1
            )			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
