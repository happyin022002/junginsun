<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="RFAReportDBDAORsltPriMasterRFAOnlyRSQL">
			<desc><![CDATA[RsltPriMasterRFAOnly]]></desc>
			<sql><![CDATA[
SELECT RFA.SVC_SCP_CD                               --Scope 
     , RFA.RHQ_CD                                   --RHQ
     , RFA.OFC_CD                                   --Office
     , RFA.EFF_DT                                   --EFF      
     , RFA.EXP_DT                                   --EXP      
     , RFA.PROP_NO                                  --PROP_No
     , RFA.MST_RFA_NO                               --MST_RFA_No     
     , RFA.AMDT_SEQ                                 --AMDT_SEQ    
     , RFA.MST_ROUT_ID                              --MST_ROUT_ID      
     , RFA.ORG_PNT_LOC_DEF_CD                       --Origin  
 	 , RFA.RCV_TERM_CD                              --R Term                   
     , RFA.ORG_VIA_PORT_DEF_CD                      --O.Via       
     , RFA.DEST_VIA_PORT_DEF_CD                     --D.Via       
     , RFA.DEST_PNT_LOC_DEF_CD                      --Dest   
	 , RFA.DE_TERM_CD                               --D Term    
     , RFA.PROP_FRT_D2_RT_AMT                       --Current. Rate D2 
     , RFA.PROP_FRT_D4_RT_AMT                       --Current. Rate D4 
     , RFA.PROP_FRT_D5_RT_AMT                       --Current. Rate D5
     , CASE WHEN WM_CONCAT(DISTINCT NOTE_CONV_RULE_CD) IS NULL THEN WM_CONCAT(DISTINCT NOTE_CONV_CHG_CD) 
       		WHEN WM_CONCAT(DISTINCT NOTE_CONV_CHG_CD) IS NULL THEN WM_CONCAT(DISTINCT NOTE_CONV_RULE_CD)
			ELSE WM_CONCAT(DISTINCT NOTE_CONV_RULE_CD) ||','|| WM_CONCAT(DISTINCT NOTE_CONV_CHG_CD) 
	 		END AS NOTE_CONV_CHG_CD
     ,MAX(DECODE(NOTE_CONV_RULE_CD, 'APP', NOTE_CONV.BKG_DIR_CALL_FLG, '')) AS BKG_DIR_CALL_FLG
     ,MAX(DECODE(NOTE_CONV_RULE_CD, 'APP', NOTE_CONV.BKG_TS_PORT_DEF_CD, '')) AS BKG_TS_PORT_DEF_CD
     ,MAX(DECODE(NOTE_CONV_RULE_CD, 'APP', NOTE_CONV.BKG_SLAN_CD, '')) AS BKG_SLAN_CD
     ,MAX(DECODE(NOTE_CONV_RULE_CD, 'APP', (NOTE_CONV.BKG_VSL_CD || NOTE_CONV.BKG_SKD_VOY_NO || NOTE_CONV.BKG_SKD_DIR_CD), '')) AS BKG_VVD_CD
     ,MAX(DECODE(NOTE_CONV_RULE_CD, 'APP', NOTE_CONV.NOTE_CONV_SEQ, '')) AS NOTE_CONV_SEQ
     , RFA.PRC_CMDT_DEF_CD                           --CMDT                         
     , RFA.PROP_STS_CD AS PROP_STS_CD
FROM
    (SELECT RFA.*
          , NOTE_CONV_MAPG_ID
      FROM
            (SELECT SCP_MN.PROP_NO                      AS PROP_NO
                 , SCP_MN.AMDT_SEQ                      AS AMDT_SEQ
                 , SCP_MN.SVC_SCP_CD                    AS SVC_SCP_CD
                 , CMDT.CMDT_HDR_SEQ                    AS CMDT_HDR_SEQ
                 , ROUT.ROUT_SEQ                        AS ROUT_SEQ
                 , MAS.OFC_N3RD_LVL_CD                  AS RHQ_CD
                 , MN.PROP_OFC_CD                       AS OFC_CD                       
                 , TO_CHAR(SCP_MN.EFF_DT, 'YYYY-MM-DD') AS EFF_DT      
                 , TO_CHAR(SCP_MN.EXP_DT, 'YYYY-MM-DD') AS EXP_DT      
                 , HDR.RFA_NO                           AS MST_RFA_NO                      
                 , ROUT.MST_ROUT_ID                     AS MST_ROUT_ID                
                 , ROUT_ORG.ROUT_PNT_LOC_DEF_CD         AS ORG_PNT_LOC_DEF_CD       --ORG     
                        
                 , ROUT_ORG.RCV_DE_TERM_CD              AS RCV_TERM_CD              --R TERM                  
                 , ROUT_ORG_VIA.ROUT_VIA_PORT_DEF_CD    AS ORG_VIA_PORT_DEF_CD      --O.Via       
                 , ROUT_DEST_VIA.ROUT_VIA_PORT_DEF_CD   AS DEST_VIA_PORT_DEF_CD     --D.Via       
                 , ROUT_DEST.ROUT_PNT_LOC_DEF_CD        AS DEST_PNT_LOC_DEF_CD      --DEST  
                 , ROUT_DEST.RCV_DE_TERM_CD             AS DE_TERM_CD               --D TERM    
                 , RT_D2.PROP_FRT_RT_AMT                AS PROP_FRT_D2_RT_AMT       --Current. Rate D2 
                 , RT_D4.PROP_FRT_RT_AMT                AS PROP_FRT_D4_RT_AMT       --Current. Rate D4 
                 , RT_D5.PROP_FRT_RT_AMT                AS PROP_FRT_D5_RT_AMT       --Current. Rate D5 
                 , (SELECT CMDT_NM FROM MDM_COMMODITY MM WHERE  MM.CMDT_CD  = CMDT.PRC_CMDT_DEF_CD)     AS PRC_CMDT_DEF_CD --CMDT                         
                 , MN.PROP_STS_CD                       AS PROP_STS_CD
            FROM  PRI_RP_HDR                HDR
                , PRI_RP_MN                 MN
                , PRI_RP_SCP_MN             SCP_MN
                , PRI_RP_SCP_RT_CMDT_HDR    CMDT_HDR 
                , PRI_RP_SCP_RT_CMDT        CMDT
                , PRI_RP_SCP_RT_CMDT_ROUT   ROUT
                , PRI_RP_SCP_RT_ROUT_PNT    ROUT_ORG
                , PRI_RP_SCP_RT_ROUT_VIA    ROUT_ORG_VIA
                , PRI_RP_SCP_RT_ROUT_VIA    ROUT_DEST_VIA
                , PRI_RP_SCP_RT_ROUT_PNT    ROUT_DEST
                , PRI_RP_SCP_RT             RT_D2
                , PRI_RP_SCP_RT             RT_D4
                , PRI_RP_SCP_RT             RT_D5
				, MAS_OFC_LVL               MAS
            WHERE 1 = 1
             AND HDR.PROP_NO    = MN.PROP_NO
             ---------------------------------------
             AND MN.PROP_NO     = SCP_MN.PROP_NO
             AND MN.AMDT_SEQ    = SCP_MN.AMDT_SEQ
             ---------------------------------------
             AND SCP_MN.PROP_NO         = CMDT_HDR.PROP_NO
             AND SCP_MN.AMDT_SEQ        = CMDT_HDR.AMDT_SEQ
             AND SCP_MN.SVC_SCP_CD      = CMDT_HDR.SVC_SCP_CD
             ---------------------------------------
             AND CMDT_HDR.PROP_NO           = CMDT.PROP_NO
             AND CMDT_HDR.AMDT_SEQ          = CMDT.AMDT_SEQ
             AND CMDT_HDR.SVC_SCP_CD        = CMDT.SVC_SCP_CD
             AND CMDT_HDR.CMDT_HDR_SEQ      = CMDT.CMDT_HDR_SEQ
             ---------------------------------------
             AND CMDT_HDR.PROP_NO           = ROUT.PROP_NO
             AND CMDT_HDR.AMDT_SEQ          = ROUT.AMDT_SEQ
             AND CMDT_HDR.SVC_SCP_CD        = ROUT.SVC_SCP_CD
             AND CMDT_HDR.CMDT_HDR_SEQ      = ROUT.CMDT_HDR_SEQ
             ---------------------------------------
             AND ROUT.PROP_NO           = ROUT_ORG.PROP_NO
             AND ROUT.AMDT_SEQ          = ROUT_ORG.AMDT_SEQ
             AND ROUT.SVC_SCP_CD        = ROUT_ORG.SVC_SCP_CD
             AND ROUT.CMDT_HDR_SEQ      = ROUT_ORG.CMDT_HDR_SEQ
             AND ROUT.ROUT_SEQ          = ROUT_ORG.ROUT_SEQ
             AND 'O'                    = ROUT_ORG.ORG_DEST_TP_CD
             --------------------------------------- 
             AND ROUT.PROP_NO           = ROUT_ORG_VIA.PROP_NO(+)
             AND ROUT.AMDT_SEQ          = ROUT_ORG_VIA.AMDT_SEQ(+)
             AND ROUT.SVC_SCP_CD        = ROUT_ORG_VIA.SVC_SCP_CD(+)
             AND ROUT.CMDT_HDR_SEQ      = ROUT_ORG_VIA.CMDT_HDR_SEQ(+)
             AND ROUT.ROUT_SEQ          = ROUT_ORG_VIA.ROUT_SEQ(+)
             AND 'O'                    = ROUT_ORG_VIA.ORG_DEST_TP_CD(+)
             --------------------------------------- 
             AND ROUT.PROP_NO           = ROUT_DEST_VIA.PROP_NO(+)
             AND ROUT.AMDT_SEQ          = ROUT_DEST_VIA.AMDT_SEQ(+)
             AND ROUT.SVC_SCP_CD        = ROUT_DEST_VIA.SVC_SCP_CD(+)
             AND ROUT.CMDT_HDR_SEQ      = ROUT_DEST_VIA.CMDT_HDR_SEQ(+)
             AND ROUT.ROUT_SEQ          = ROUT_DEST_VIA.ROUT_SEQ(+)
             AND 'D'                    = ROUT_DEST_VIA.ORG_DEST_TP_CD(+)
             --------------------------------------- 
             AND ROUT.PROP_NO           = ROUT_DEST.PROP_NO
             AND ROUT.AMDT_SEQ          = ROUT_DEST.AMDT_SEQ
             AND ROUT.SVC_SCP_CD        = ROUT_DEST.SVC_SCP_CD
             AND ROUT.CMDT_HDR_SEQ      = ROUT_DEST.CMDT_HDR_SEQ
             AND ROUT.ROUT_SEQ          = ROUT_DEST.ROUT_SEQ
             AND 'D'                    = ROUT_DEST.ORG_DEST_TP_CD
             --------------------------------------- 
             AND ROUT.PROP_NO           = RT_D2.PROP_NO(+)
             AND ROUT.AMDT_SEQ          = RT_D2.AMDT_SEQ(+)
             AND ROUT.SVC_SCP_CD        = RT_D2.SVC_SCP_CD(+)
             AND ROUT.CMDT_HDR_SEQ      = RT_D2.CMDT_HDR_SEQ(+)
             AND ROUT.ROUT_SEQ          = RT_D2.ROUT_SEQ(+)
             AND 'D2'                   = RT_D2.RAT_UT_CD(+)
              --------------------------------------- 
             AND ROUT.PROP_NO           = RT_D4.PROP_NO(+)
             AND ROUT.AMDT_SEQ          = RT_D4.AMDT_SEQ(+)
             AND ROUT.SVC_SCP_CD        = RT_D4.SVC_SCP_CD(+)
             AND ROUT.CMDT_HDR_SEQ      = RT_D4.CMDT_HDR_SEQ(+)
             AND ROUT.ROUT_SEQ          = RT_D4.ROUT_SEQ(+)
             AND 'D4'                   = RT_D4.RAT_UT_CD(+)
              --------------------------------------- 
             AND ROUT.PROP_NO           = RT_D5.PROP_NO(+)
             AND ROUT.AMDT_SEQ          = RT_D5.AMDT_SEQ(+)
             AND ROUT.SVC_SCP_CD        = RT_D5.SVC_SCP_CD(+)
             AND ROUT.CMDT_HDR_SEQ      = RT_D5.CMDT_HDR_SEQ(+)
             AND ROUT.ROUT_SEQ          = RT_D5.ROUT_SEQ(+)
             AND 'D5'                   = RT_D5.RAT_UT_CD(+)
             --------------------------------------- 
 			 AND SCP_MN.PROP_SCP_OFC_CD = MAS.OFC_CD(+) 
             AND SCP_MN.EXP_DT <= TO_DATE(MAS.OFC_APLY_TO_YRMON(+),'YYYYMM')
             AND SCP_MN.EFF_DT >= TO_DATE(MAS.OFC_APLY_FM_YRMON(+),'YYYYMM')
             --------------------------------------- 
             AND MN.RFA_CTRT_TP_CD = 'M'
             AND CMDT.PRC_CMDT_DEF_CD = '000000'         -- CMDT를 'FAK'로 고정
 			AND SCP_MN.EFF_DT <= TO_DATE(@[f_exp_dt],'YYYY-MM-DD')
 			AND SCP_MN.EXP_DT >= TO_DATE(@[f_eff_dt],'YYYY-MM-DD')
			#if( ${f_m_rfa_no} != '')
 			AND HDR.RFA_NO = @[f_m_rfa_no]
 			#end
			#if( ${f_req_ofc} != '')
 			AND MN.PROP_OFC_CD = @[f_req_ofc]
 			#elseif( ${f_req_rhq} != '')
 			AND MAS.OFC_N3RD_LVL_CD = @[f_req_rhq]
 			#end
 			#if( ${f_scp} != '')
 			AND SCP_MN.SVC_SCP_CD = @[f_scp]
 			#end
			#if( ${f_org} != '')
 			AND ROUT_ORG.ROUT_PNT_LOC_DEF_CD  LIKE @[f_org]||'%'
 			#end
			#if( ${f_o_via} != '')
 			AND ROUT_ORG_VIA.ROUT_VIA_PORT_DEF_CD LIKE @[f_o_via]||'%'
 			#end
			#if( ${f_d_via} != '')
 			AND ROUT_DEST_VIA.ROUT_VIA_PORT_DEF_CD LIKE @[f_d_via]||'%'
 			#end
			#if( ${f_dest} != '')
 			AND ROUT_DEST.ROUT_PNT_LOC_DEF_CD LIKE @[f_dest]||'%'
 			#end
			#if( ${f_sts} != '')
 			AND MN.PROP_STS_CD  = @[f_sts]
 			#end
             ) RFA
           , PRI_RP_SCP_RT_CMDT_RNOTE RNOTE
     WHERE 1=1
     AND RFA.PROP_NO           = RNOTE.PROP_NO(+)
     AND RFA.AMDT_SEQ          = RNOTE.AMDT_SEQ(+)
     AND RFA.SVC_SCP_CD        = RNOTE.SVC_SCP_CD(+)
     AND RFA.CMDT_HDR_SEQ      = RNOTE.CMDT_HDR_SEQ(+)
     AND RFA.ROUT_SEQ          = RNOTE.ROUT_SEQ(+)
     )                      RFA
     , PRI_RFA_NOTE_CONV    NOTE_CONV
 WHERE RFA.NOTE_CONV_MAPG_ID = NOTE_CONV.NOTE_CONV_MAPG_ID(+)
 GROUP BY  RFA.SVC_SCP_CD  
     , RFA.RHQ_CD
     , RFA.OFC_CD 
     , RFA.EFF_DT 
     , RFA.EXP_DT 
     , RFA.PROP_NO
     , RFA.MST_RFA_NO 
     , RFA.AMDT_SEQ 
     , RFA.MST_ROUT_ID
     , RFA.ORG_PNT_LOC_DEF_CD 
 	 , RFA.RCV_TERM_CD       
     , RFA.ORG_VIA_PORT_DEF_CD 
     , RFA.DEST_VIA_PORT_DEF_CD 
     , RFA.DEST_PNT_LOC_DEF_CD
	 , RFA.DE_TERM_CD 
     , RFA.PROP_FRT_D2_RT_AMT 
     , RFA.PROP_FRT_D4_RT_AMT
     , RFA.PROP_FRT_D5_RT_AMT
     , RFA.PRC_CMDT_DEF_CD                     
     , RFA.PROP_STS_CD			]]></sql>
			<params>
				<param name="f_exp_dt" type="12" value="" out="N"/>
				<param name="f_eff_dt" type="12" value="" out="N"/>
				<param name="f_m_rfa_no" type="12" value="" out="N"/>
				<param name="f_req_ofc" type="12" value="" out="N"/>
				<param name="f_req_rhq" type="12" value="" out="N"/>
				<param name="f_scp" type="12" value="" out="N"/>
				<param name="f_org" type="12" value="" out="N"/>
				<param name="f_o_via" type="12" value="" out="N"/>
				<param name="f_d_via" type="12" value="" out="N"/>
				<param name="f_dest" type="12" value="" out="N"/>
				<param name="f_sts" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
