<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BlRatingDBDAOManageTPFSurchargeCSQL">
			<desc><![CDATA[TPF Interface
Group Rating에서는 I/F여부를 사용자에게 확인받지 않고 무조건 I/F진행.]]></desc>
			<sql><![CDATA[
INSERT INTO BKG_CHG_RT
(      BKG_NO,
       RT_SEQ,
       DP_SEQ,
       FRT_TERM_CD,
       CGO_CATE_CD,
       CHG_CD,
       CURR_CD,
       RAT_UT_CD,
       RAT_AS_QTY,
       CHG_UT_AMT,
       CHG_AMT,
       RCV_TERM_CD,
       DE_TERM_CD,
       N3PTY_RCV_OFC_CD,
       N3PTY_CUST_CNT_CD,
       N3PTY_CUST_SEQ,
       FRT_INCL_XCLD_DIV_CD,
       PRN_HDN_FLG,
       AUTO_RAT_CD,
       CRE_USR_ID,
       CRE_DT,
       UPD_USR_ID,
       UPD_DT
       )

SELECT DISTINCT BK.BKG_NO,
       NVL((SELECT MAX(RT_SEQ) 
             FROM BKG_CHG_RT 
            WHERE BKG_NO = @[bkg_no]), 0) + 1,       
       (SELECT A.DP_SEQ FROM MDM_CHARGE A WHERE A.CHG_CD='TPF' AND DELT_FLG='N') DP_SEQ,
       DECODE(SR.PAY_TERM_CD, 'O', OFT_TERM_CD,SR.PAY_TERM_CD) FRT_TERM_CD,
       'DR' CGO_CATE_CD,
       'TPF' CHG_CD,
       SR.CURR_CD,
       SR.RAT_UT_CD,
       1 RAT_AS_QTY,
       SR.SCG_AMT CHG_UT_AMT,
       SR.SCG_AMT CHG_AMT,
       BK.RCV_TERM_CD,
       BK.DE_TERM_CD,
       DECODE(RT.OFC_CNT,1,N3PTY_RCV_OFC_CD) N3PTY_RCV_OFC_CD,
       DECODE(RT.CUST_CNT,1,N3PTY_CUST_CNT_CD) N3PTY_CUST_CNT_CD,
       DECODE(RT.CUST_CNT,1,N3PTY_CUST_SEQ) N3PTY_CUST_SEQ,
       'N' FRT_INCL_XCLD_DIV_CD,
       'N' PRN_HDN_FLG,
       'I' AUTO_RAT_CD,
       @[usr_id],
       SYSDATE,
       @[usr_id],
       SYSDATE
FROM   PRI_SCG_PRF SP,
       PRI_SCG_RT SR,
       MDM_CHARGE MC,
       (SELECT DISTINCT BKG_NO, FRT_TERM_CD,
               CASE WHEN N3PTY_RCV_OFC_CD = 'HKGSC' OR L.CNT_CD <> 'CN' THEN N3PTY_RCV_OFC_CD
                    ELSE NULL
               END N3PTY_RCV_OFC_CD,
               N3PTY_CUST_CNT_CD,
               N3PTY_CUST_SEQ,
               COUNT(DISTINCT N3PTY_RCV_OFC_CD) OVER (PARTITION BY 1) OFC_CNT,
               COUNT(DISTINCT N3PTY_CUST_CNT_CD||N3PTY_CUST_SEQ) OVER (PARTITION BY 1) CUST_CNT
        FROM BKG_CHG_RT R, MDM_ORGANIZATION O, MDM_LOCATION L
        WHERE R.BKG_NO = @[bkg_no]
        AND @[ca_flag] = 'N'
        AND R.FRT_INCL_XCLD_DIV_CD = 'N'
        AND R.N3PTY_RCV_OFC_CD IS NOT NULL
        AND O.OFC_CD = R.N3PTY_RCV_OFC_CD
        AND L.LOC_CD = O.LOC_CD
        UNION ALL
        SELECT DISTINCT BKG_NO, FRT_TERM_CD, 
               CASE WHEN N3PTY_RCV_OFC_CD = 'HKGSC' OR L.CNT_CD <> 'CN' THEN N3PTY_RCV_OFC_CD
                    ELSE NULL
               END N3PTY_RCV_OFC_CD,
               N3PTY_CUST_CNT_CD,
               N3PTY_CUST_SEQ,
               COUNT(DISTINCT N3PTY_RCV_OFC_CD) OVER (PARTITION BY 1) OFC_CNT,
               COUNT(DISTINCT N3PTY_CUST_CNT_CD||N3PTY_CUST_SEQ) OVER (PARTITION BY 1) CUST_CNT
        FROM BKG_CHG_RT_HIS R, MDM_ORGANIZATION O, MDM_LOCATION L
        WHERE R.BKG_NO = @[bkg_no]
        AND @[ca_flag] = 'Y'
        AND R.CORR_NO = 'TMP0000001'
        AND R.FRT_INCL_XCLD_DIV_CD = 'N'
        AND R.N3PTY_RCV_OFC_CD IS NOT NULL
        AND O.OFC_CD = R.N3PTY_RCV_OFC_CD
        AND L.LOC_CD = O.LOC_CD) RT,
       (SELECT  BK.BKG_NO,
                BR.RT_APLY_DT,
                BK.SVC_SCP_CD,
                BK.RCV_TERM_CD,
                BK.DE_TERM_CD,
                BK.POR_CD,
                BK.POL_CD,
                BK.POD_CD,
                BK.DEL_CD,
                CASE WHEN POR.CNT_CD = 'CN' OR POL.CNT_CD = 'CN' THEN 'P'
                     WHEN POD.CNT_CD = 'CN' OR DEL.CNT_CD = 'CN' THEN 'C'
                     ELSE NULL
                END FRT_TERM_CD,
                CASE WHEN PPD.CNT_CD <> 'CN' OR BR.PPD_RCV_OFC_CD = 'HKGSC' THEN BR.PPD_RCV_OFC_CD
                     ELSE NULL
                END PPD_RCV_OFC_CD,
                CASE WHEN CCT.CNT_CD <> 'CN' OR BR.CLT_OFC_CD = 'HKGSC' THEN BR.CLT_OFC_CD
                END CLT_OFC_CD,
                POR.CNT_CD||POR.STE_CD POR_STE_CD,
                POR.RGN_CD POR_RGN_CD,
                POR.CNT_CD POR_CNT_CD,
                POL.CNT_CD||POL.STE_CD POL_STE_CD,
                POL.RGN_CD POL_RGN_CD,
                POL.CNT_CD POL_CNT_CD,
                POD.CNT_CD||POD.STE_CD POD_STE_CD,
                POD.RGN_CD POD_RGN_CD,
                POD.CNT_CD POD_CNT_CD,
                DEL.CNT_CD||DEL.STE_CD DEL_STE_CD,
                DEL.RGN_CD DEL_RGN_CD,
                DEL.CNT_CD DEL_CNT_CD,
               (SELECT FRT_TERM_CD
                FROM BKG_CHG_RT 
                WHERE BKG_NO = BK.BKG_NO
                AND @[ca_flag] = 'N'
                AND CHG_CD = 'OFT'
                AND ROWNUM = 1) OFT_TERM_CD,
               (SELECT SUM(CHG_AMT)
                FROM BKG_CHG_RT 
                WHERE BKG_NO = BK.BKG_NO
                AND @[ca_flag] = 'N'
                AND FRT_INCL_XCLD_DIV_CD = 'N'
                AND FRT_TERM_CD = 'P') PPD_AMT,
               (SELECT SUM(CHG_AMT)
                FROM BKG_CHG_RT 
                WHERE BKG_NO = BK.BKG_NO
                AND @[ca_flag] = 'N'
                AND FRT_INCL_XCLD_DIV_CD = 'N'
                AND FRT_TERM_CD = 'C') CLT_AMT
        FROM BKG_BOOKING BK,
             BKG_RATE    BR,
             MDM_ORGANIZATION PO,
             MDM_ORGANIZATION CO,
             MDM_LOCATION POR,
             MDM_LOCATION POL,
             MDM_LOCATION POD,
             MDM_LOCATION DEL,
             MDM_LOCATION PPD,
             MDM_LOCATION CCT
        WHERE BK.BKG_NO = @[bkg_no]
        AND @[ca_flag]     = 'N'
        AND BK.BKG_NO   = BR.BKG_NO
        AND POR.LOC_CD  = BK.POR_CD 
        AND POL.LOC_CD  = BK.POL_CD 
        AND POD.LOC_CD  = BK.POD_CD 
        AND DEL.LOC_CD  = BK.DEL_CD
        AND PO.OFC_CD   = BR.PPD_RCV_OFC_CD
        AND PPD.LOC_CD  = PO.LOC_CD 
        AND CO.OFC_CD   = BR.CLT_OFC_CD
        AND CCT.LOC_CD  = CO.LOC_CD 
        AND (   BR.PPD_RCV_OFC_CD = 'HKGSC'
             OR BR.CLT_OFC_CD = 'HKGSC'
             OR PPD.CNT_CD <> 'CN'
             OR CCT.CNT_CD <> 'CN'
            )
        
        UNION ALL
        
        SELECT  BK.BKG_NO,
                BR.RT_APLY_DT,
                BK.SVC_SCP_CD,
                BK.RCV_TERM_CD,
                BK.DE_TERM_CD,
                BK.POR_CD,
                BK.POL_CD,
                BK.POD_CD,
                BK.DEL_CD,
                CASE WHEN POR.CNT_CD = 'CN' OR POL.CNT_CD = 'CN' THEN 'P'
                     WHEN POD.CNT_CD = 'CN' OR DEL.CNT_CD = 'CN' THEN 'C'
                     ELSE NULL
                END FRT_TERM_CD,
                CASE WHEN PPD.CNT_CD <> 'CN' OR BR.PPD_RCV_OFC_CD = 'HKGSC' THEN BR.PPD_RCV_OFC_CD
                     ELSE NULL
                END PPD_RCV_OFC_CD,
                CASE WHEN CCT.CNT_CD <> 'CN' OR BR.CLT_OFC_CD = 'HKGSC' THEN BR.CLT_OFC_CD
                END CLT_OFC_CD,
                POR.CNT_CD||POR.STE_CD POR_STE_CD,
                POR.RGN_CD POR_RGN_CD,
                POR.CNT_CD POR_CNT_CD,
                POL.CNT_CD||POL.STE_CD POL_STE_CD,
                POL.RGN_CD POL_RGN_CD,
                POL.CNT_CD POL_CNT_CD,
                POD.CNT_CD||POD.STE_CD POD_STE_CD,
                POD.RGN_CD POD_RGN_CD,
                POD.CNT_CD POD_CNT_CD,
                DEL.CNT_CD||DEL.STE_CD DEL_STE_CD,
                DEL.RGN_CD DEL_RGN_CD,
                DEL.CNT_CD DEL_CNT_CD,
               (SELECT FRT_TERM_CD
                FROM BKG_CHG_RT_HIS 
                WHERE BKG_NO = BK.BKG_NO
                AND CORR_NO = 'TMP0000001'
                AND @[ca_flag] = 'Y'
                AND CHG_CD = 'OFT'
                AND ROWNUM = 1) OFT_TERM_CD,
               (SELECT SUM(CHG_AMT)
                FROM BKG_CHG_RT_HIS 
                WHERE BKG_NO = BK.BKG_NO
                AND CORR_NO = 'TMP0000001'
                AND @[ca_flag] = 'Y'
                AND FRT_INCL_XCLD_DIV_CD = 'N'
                AND FRT_TERM_CD = 'P') PPD_AMT,
               (SELECT SUM(CHG_AMT)
                FROM BKG_CHG_RT_HIS 
                WHERE BKG_NO = BK.BKG_NO
                AND CORR_NO = 'TMP0000001'
                AND @[ca_flag] = 'Y'
                AND FRT_INCL_XCLD_DIV_CD = 'N'
                AND FRT_TERM_CD = 'C') CLT_AMT
        FROM BKG_BKG_HIS BK,
             BKG_RT_HIS  BR,
             MDM_ORGANIZATION PO,
             MDM_ORGANIZATION CO,
             MDM_LOCATION POR,
             MDM_LOCATION POL,
             MDM_LOCATION POD,
             MDM_LOCATION DEL,
             MDM_LOCATION PPD,
             MDM_LOCATION CCT
        WHERE BK.BKG_NO = @[bkg_no]
        AND @[ca_flag]     = 'Y'
        AND BK.BKG_NO   = BR.BKG_NO
        AND BK.CORR_NO = 'TMP0000001'
        AND BK.CORR_NO  = BR.CORR_NO
        AND POR.LOC_CD  = BK.POR_CD 
        AND POL.LOC_CD  = BK.POL_CD 
        AND POD.LOC_CD  = BK.POD_CD 
        AND DEL.LOC_CD  = BK.DEL_CD
        AND PO.OFC_CD   = BR.PPD_RCV_OFC_CD
        AND PPD.LOC_CD  = PO.LOC_CD 
        AND CO.OFC_CD   = BR.CLT_OFC_CD
        AND CCT.LOC_CD  = CO.LOC_CD 
        AND (   BR.PPD_RCV_OFC_CD = 'HKGSC'
             OR BR.CLT_OFC_CD = 'HKGSC'
             OR PPD.CNT_CD <> 'CN'
             OR CCT.CNT_CD <> 'CN'
            )
        ) BK
WHERE SP.SVC_SCP_CD = BK.SVC_SCP_CD
AND SP.CHG_CD     =  'TPF'
AND SR.SVC_SCP_CD = SP.SVC_SCP_CD
AND SR.CHG_CD     = SP.CHG_CD
AND SR.WDR_FLG    =  'N'
AND SR.DELT_FLG   =  'N'   -- Sucharge 적용 중지 여부 
AND SR.SCG_RQST_PROC_CD = 'A'
AND MC.CHG_CD     = SP.CHG_CD
AND BK.RT_APLY_DT BETWEEN SR.EFF_DT AND SR.EXP_DT + 0.99999   -- 0.99999 는 23시 59분 59초를 의미 
AND BK.BKG_NO     = RT.BKG_NO(+)
AND BK.FRT_TERM_CD = RT.FRT_TERM_CD(+)
/*******************************************************************************************
R/D TERM CHECK ( MDM_CHARGE 의 R/D TERM CHECK 포함 )
*******************************************************************************************/
AND (
        SR.PRC_RCV_TERM_CD  = BK.RCV_TERM_CD
    OR  (
            ( SP.RCV_DE_TERM_USE_FLG = 'N' OR SR.PRC_RCV_TERM_CD IS NULL )
        AND (
                MC.CHG_APLY_AREA_CD = 'C'
                OR  BK.RCV_TERM_CD  IN ( DECODE(MC.NA_RD_TERM_FLG, 'Y', BK.RCV_TERM_CD), DECODE(MC.CY_RD_TERM_FLG, 'Y', 'Y'), DECODE(MC.DOR_RD_TERM_FLG, 'Y', 'D'), DECODE(MC.CFS_RD_TERM_FLG, 'Y', 'S'), DECODE(MC.TKL_TML_FLG, 'Y', 'T') )
             )
         )
    )
AND (
        SR.PRC_DE_TERM_CD   = BK.DE_TERM_CD
    OR  (
            (   SP.RCV_DE_TERM_USE_FLG = 'N' OR SR.PRC_DE_TERM_CD IS NULL )
        AND (   
                MC.CHG_APLY_AREA_CD = 'P'
            OR  BK.DE_TERM_CD   IN ( DECODE(MC.NA_RD_TERM_FLG, 'Y', BK.DE_TERM_CD), DECODE(MC.CY_RD_TERM_FLG, 'Y', 'Y'), DECODE(MC.DOR_RD_TERM_FLG, 'Y', 'D'), DECODE(MC.CFS_RD_TERM_FLG, 'Y', 'S'), DECODE(MC.TKL_TML_FLG, 'Y', 'T') )
            )
        )
    )

/* POR */ 
AND ( 
        SP.POR_USE_FLG  = 'N' 
    OR  SR.POR_DEF_CD   IS NULL 
    OR  (
            SR.POR_DEF_CD   = DECODE(SR.POR_TP_CD, 'L', BK.POR_CD, 'T', BK.POR_STE_CD, 'R', BK.POR_RGN_CD, 'C', BK.POR_CNT_CD)
        AND BK.POR_CD <> 'CNHKG' 
        AND  NVL(BK.PPD_AMT, 0) > 0
        AND (   ( N3PTY_RCV_OFC_CD IS NOT NULL AND RT.FRT_TERM_CD = 'P' )
            OR  ( PPD_RCV_OFC_CD IS NOT NULL AND RT.FRT_TERM_CD IS NULL ))
            
        )
    OR  ( 
            SR.POR_TP_CD  = 'G' 
        AND EXISTS  ( 
                    SELECT  'X' 
                    FROM    PRI_SCG_GRP_LOC     GL  , 
                            PRI_SCG_GRP_LOC_DTL GD 
                    WHERE   GD.SVC_SCP_CD     = GL.SVC_SCP_CD 
                    AND     GD.CHG_CD         = GL.CHG_CD 
                    AND     GD.GRP_LOC_SEQ    = GL.GRP_LOC_SEQ 
                    AND     GL.SVC_SCP_CD     = SR.SVC_SCP_CD 
                    AND     GL.CHG_CD         = SR.CHG_CD 
                    AND     GL.SCG_GRP_LOC_CD = SR.POR_DEF_CD 
                    AND     GD.DTL_LOC_DEF_CD = DECODE(GD.DTL_LOC_TP_CD, 'L', BK.POR_CD, 'T', BK.POR_STE_CD, 'R', BK.POR_RGN_CD, 'C', BK.POR_CNT_CD)    
                    AND     BK.RT_APLY_DT     BETWEEN GD.EFF_DT AND GD.EXP_DT + 0.99999   /* 0.99999 는 23시 59분 59초를 의미 */ 
                    AND     BK.POR_CD <> 'CNHKG' 
                    AND     NVL(BK.PPD_AMT, 0) > 0
                    AND     (   ( N3PTY_RCV_OFC_CD IS NOT NULL AND RT.FRT_TERM_CD = 'P' )
                            OR  ( PPD_RCV_OFC_CD IS NOT NULL AND RT.FRT_TERM_CD IS NULL ))
                    ) 
        ) 
    ) 
/* POL */ 
AND ( 
        SP.POL_USE_FLG  = 'N' 
    OR  SR.POL_DEF_CD   IS NULL 
    OR  (
            SR.POL_DEF_CD   = DECODE(SR.POL_TP_CD, 'L', BK.POL_CD, 'T', BK.POL_STE_CD, 'R', BK.POL_RGN_CD, 'C', BK.POL_CNT_CD) 
        AND BK.POL_CD <> 'CNHKG' 
        AND  NVL(BK.PPD_AMT, 0) > 0
        AND (   ( N3PTY_RCV_OFC_CD IS NOT NULL AND RT.FRT_TERM_CD = 'P' )
            OR  ( PPD_RCV_OFC_CD IS NOT NULL AND RT.FRT_TERM_CD IS NULL ))
        )
    OR  ( 
            SR.POL_TP_CD  = 'G' 
        AND EXISTS  ( 
                    SELECT  'X' 
                    FROM    PRI_SCG_GRP_LOC     GL  , 
                            PRI_SCG_GRP_LOC_DTL GD 
                    WHERE   GD.SVC_SCP_CD     = GL.SVC_SCP_CD 
                    AND     GD.CHG_CD         = GL.CHG_CD 
                    AND     GD.GRP_LOC_SEQ    = GL.GRP_LOC_SEQ 
                    AND     GL.SVC_SCP_CD     = SR.SVC_SCP_CD 
                    AND     GL.CHG_CD         = SR.CHG_CD 
                    AND     GL.SCG_GRP_LOC_CD = SR.POL_DEF_CD 
                    AND     GD.DTL_LOC_DEF_CD = DECODE(GD.DTL_LOC_TP_CD, 'L', BK.POL_CD, 'T', BK.POL_STE_CD, 'R', BK.POL_RGN_CD, 'C', BK.POL_CNT_CD) 
                    AND     BK.RT_APLY_DT      BETWEEN GD.EFF_DT AND GD.EXP_DT + 0.99999   /* 0.99999 는 23시 59분 59초를 의미 */ 
                    AND     BK.POL_CD <> 'CNHKG' 
                    AND      NVL(BK.PPD_AMT, 0) > 0
                    AND     (   ( N3PTY_RCV_OFC_CD IS NOT NULL AND RT.FRT_TERM_CD = 'P' )
                            OR  ( PPD_RCV_OFC_CD IS NOT NULL AND RT.FRT_TERM_CD IS NULL ))
                    ) 
        ) 
    ) 
/* POD */ 
AND ( 
        SP.POD_USE_FLG  = 'N' 
    OR  SR.POD_DEF_CD   IS NULL 
    OR  (
            SR.POD_DEF_CD   = DECODE(SR.POD_TP_CD, 'L', BK.POD_CD, 'T', BK.POD_STE_CD, 'R', BK.POD_RGN_CD, 'C', BK.POD_CNT_CD)
        AND BK.POD_CD <> 'CNHKG' 
        AND NVL(BK.CLT_AMT, 0) > 0
        AND (   ( N3PTY_RCV_OFC_CD IS NOT NULL AND RT.FRT_TERM_CD = 'C' )
            OR  ( CLT_OFC_CD IS NOT NULL AND RT.FRT_TERM_CD IS NULL ))
        ) 
    OR  ( 
            SR.POD_TP_CD  = 'G' 
        AND EXISTS  ( 
                    SELECT  'X' 
                    FROM    PRI_SCG_GRP_LOC     GL  , 
                            PRI_SCG_GRP_LOC_DTL GD 
                    WHERE   GD.SVC_SCP_CD     = GL.SVC_SCP_CD 
                    AND     GD.CHG_CD         = GL.CHG_CD 
                    AND     GD.GRP_LOC_SEQ    = GL.GRP_LOC_SEQ 
                    AND     GL.SVC_SCP_CD     = SR.SVC_SCP_CD 
                    AND     GL.CHG_CD         = SR.CHG_CD 
                    AND     GL.SCG_GRP_LOC_CD = SR.POD_DEF_CD 
                    AND     GD.DTL_LOC_DEF_CD = DECODE(GD.DTL_LOC_TP_CD, 'L', BK.POD_CD, 'T', BK.POD_STE_CD, 'R', BK.POD_RGN_CD, 'C', BK.POD_CNT_CD) 
                    AND     BK.RT_APLY_DT     BETWEEN GD.EFF_DT AND GD.EXP_DT  + 0.99999   /* 0.99999 는 23시 59분 59초를 의미 */  
                    AND     BK.POD_CD <> 'CNHKG' 
                    AND     NVL(BK.CLT_AMT, 0) > 0
                    AND     (   ( N3PTY_RCV_OFC_CD IS NOT NULL AND RT.FRT_TERM_CD = 'C' )
                            OR  ( CLT_OFC_CD IS NOT NULL AND RT.FRT_TERM_CD IS NULL ))
                    ) 
        ) 
    ) 
/* DEL */ 
AND ( 
        SP.DEL_USE_FLG  = 'N' 
    OR  SR.DEL_DEF_CD   IS NULL 
    OR  (
            SR.DEL_DEF_CD   = DECODE(SR.DEL_TP_CD, 'L', BK.DEL_CD, 'T', BK.DEL_STE_CD, 'R', BK.DEL_RGN_CD, 'C', BK.DEL_CNT_CD)
        AND BK.DEL_CD <> 'CNHKG' 
        AND NVL(BK.CLT_AMT, 0) > 0
        AND (   ( N3PTY_RCV_OFC_CD IS NOT NULL AND RT.FRT_TERM_CD = 'C' )
            OR  ( CLT_OFC_CD IS NOT NULL AND RT.FRT_TERM_CD IS NULL ))
        ) 
    OR  ( 
            SR.DEL_TP_CD  = 'G' 
        AND EXISTS  ( 
                    SELECT  'X' 
                    FROM    PRI_SCG_GRP_LOC     GL  , 
                            PRI_SCG_GRP_LOC_DTL GD 
                    WHERE   GD.SVC_SCP_CD     = GL.SVC_SCP_CD 
                    AND     GD.CHG_CD         = GL.CHG_CD 
                    AND     GD.GRP_LOC_SEQ    = GL.GRP_LOC_SEQ 
                    AND     GL.SVC_SCP_CD     = SR.SVC_SCP_CD 
                    AND     GL.CHG_CD         = SR.CHG_CD 
                    AND     GL.SCG_GRP_LOC_CD = SR.DEL_DEF_CD 
                    AND     GD.DTL_LOC_DEF_CD = DECODE(GD.DTL_LOC_TP_CD, 'L', BK.DEL_CD, 'T', BK.DEL_STE_CD, 'R', BK.DEL_RGN_CD, 'C', BK.DEL_CNT_CD) 
                    AND     BK.RT_APLY_DT      BETWEEN GD.EFF_DT AND GD.EXP_DT  + 0.99999   /* 0.99999 는 23시 59분 59초를 의미 */   
                    AND     BK.DEL_CD <> 'CNHKG' 
                    AND     NVL(BK.CLT_AMT, 0) > 0
                    AND     (   ( N3PTY_RCV_OFC_CD IS NOT NULL AND RT.FRT_TERM_CD = 'C' )
                            OR  ( CLT_OFC_CD IS NOT NULL AND RT.FRT_TERM_CD IS NULL ))                        
                    ) 
        ) 
    ) 
/* TPF Rating 여부 확인. 없는 경우에만 Charge 정보 조회 */
AND (SELECT COUNT(CHG_CD)
     FROM   (SELECT CHG_CD 
             FROM BKG_CHG_RT
             WHERE BKG_NO = @[bkg_no]
             AND CHG_CD = 'TPF'
             AND @[ca_flag] = 'N'
             UNION ALL
             SELECT CHG_CD
             FROM BKG_CHG_RT_HIS
             WHERE BKG_NO = @[bkg_no]
             AND CHG_CD = 'TPF'
             AND @[ca_flag] = 'Y'
             AND CORR_NO = 'TMP0000001'
             )) = 0			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="usr_id" type="12" value="" out="N"/>
				<param name="ca_flag" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
