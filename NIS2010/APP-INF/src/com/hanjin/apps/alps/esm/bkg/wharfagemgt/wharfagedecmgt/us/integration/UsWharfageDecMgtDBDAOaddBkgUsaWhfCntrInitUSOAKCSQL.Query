<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="UsWharfageDecMgtDBDAOaddBkgUsaWhfCntrInitUSOAKCSQL">
			<desc><![CDATA[addBkgUsaWhfCntrInitUSOAK]]></desc>
			<sql><![CDATA[
INSERT INTO BKG_USA_WHF_CNTR (
    VSL_CD
,   SKD_VOY_NO
,   SKD_DIR_CD
,   PORT_CD
,   IO_BND_CD
,   BL_NO
,   CNTR_NO
,   CNTR_TPSZ_CD
,   FULL_MTY_CD
,   CNTR_VOL_QTY
,   RCV_TERM_CD
,   DE_TERM_CD
,   USA_WHF_TRSP_TP_CD
,   USA_WHF_EXPT_FLG
,   USA_WHF_RAT_UT_CD
,   RAT_AS_QTY
,   WHF_UT_PRC
,   CRE_USR_ID
,   UPD_USR_ID
)
(
SELECT 
    TB.VSL_CD
,   TB.SKD_VOY_NO
,   TB.SKD_DIR_CD
,   TB.PORT_CD
,   TB.IO_BND_CD
,   TB.BL_NO
,   TB.CNTR_NO
,   TB.CNTR_TPSZ_CD
,   TB.FULL_MTY_CD
,   DECODE(TB.FULL_MTY_CD,'M',1,TB.CNTR_VOL_QTY) CNTR_VOL_QTY
,   TB.RCV_TERM_CD
,   TB.DE_TERM_CD
,   TB.USA_WHF_TRSP_TP_CD
,   TB.USA_WHF_EXPT_FLG
,   TB.USA_WHF_RAT_UT_CD
,   DECODE(TB.FULL_MTY_CD,'M',1,TB.RAT_AS_QTY) RAT_AS_QTY
,   RT.WHF_UT_PRC
,   TB.CRE_USR_ID
,   TB.UPD_USR_ID
  FROM (
        SELECT 
               A.VSL_CD 
              ,A.SKD_VOY_NO
              ,A.SKD_DIR_CD
              ,DECODE(@[io_bnd_cd], 'I', A.POD_CD, A.POL_CD) AS PORT_CD
              ,@[io_bnd_cd] AS IO_BND_CD
              ,A.BL_NO
              ,B.CNTR_NO
              ,B.CNTR_TPSZ_CD
              ,CASE WHEN A.BKG_CGO_TP_CD IN ('F','R') THEN 'F'
                    WHEN A.BKG_CGO_TP_CD IN ('P') THEN 'M'
                    ELSE '' 
                END FULL_MTY_CD
              ,B.CNTR_VOL_QTY
              ,B.RCV_TERM_CD
              ,B.DE_TERM_CD
              ,DECODE(@[io_bnd_cd], 'O', DECODE(A.POR_CD, 'USOAK', 'L', 'I')
                                       , BKG_GET_USOAK_WHF_TRSP_TP_FNC(A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.BL_NO, @[io_bnd_cd])
                     ) AS USA_WHF_TRSP_TP_CD
              ,'N' AS USA_WHF_EXPT_FLG
              ,CASE SUBSTR(B.CNTR_TPSZ_CD, 2, 1)
               WHEN '2' THEN '20F'
               WHEN '4' THEN '40F'
               WHEN '5' THEN '40F'
               ELSE '45F'
               END AS USA_WHF_RAT_UT_CD
              ,B.CNTR_VOL_QTY AS RAT_AS_QTY
              ,@[cre_usr_id] AS CRE_USR_ID
              ,@[cre_usr_id] AS UPD_USR_ID
          FROM (
                SELECT V.VSL_CD
                      ,V.SKD_VOY_NO
                      ,V.SKD_DIR_CD
                      ,V.POD_CD
                      ,V.POL_CD
                      ,B.BL_NO
                      ,B.BKG_NO
                      ,B.BKG_CGO_TP_CD
                      ,B.POR_CD
                  FROM BKG_BOOKING B
                      ,BKG_VVD V
                 WHERE B.BKG_NO = V.BKG_NO
                   AND V.VSL_CD = @[vsl_cd]
                    AND V.SKD_VOY_NO = @[skd_voy_no]
                   AND V.SKD_DIR_CD = @[skd_dir_cd]
                   AND B.BL_NO  IS NOT NULL
                   AND B.BKG_STS_CD IN ('F','W')
                #if (${io_bnd_cd} == 'I') 
                   AND V.POD_CD = @[port_cd]
                #else 
                   AND V.POL_CD = @[port_cd]
                #end
               ) A
              ,BKG_CONTAINER B
         WHERE A.BKG_NO = B.BKG_NO
       ) TB
       ,
      (
         SELECT USA_WHF_RAT_UT_CD
               ,FULL_MTY_CD
               ,USA_WHF_TRSP_TP_CD
               ,USA_WHF_EXPT_FLG
               ,WHF_UT_PRC
           FROM BKG_USA_WHF_RT_DTL DTL
               ,(SELECT MAX(EFF_DT) AS EFF_DT
                   FROM BKG_USA_WHF_RT
                  WHERE PORT_CD = @[port_cd]
                    AND IO_BND_CD = @[io_bnd_cd]
                ) MAX_RT
          WHERE PORT_CD = @[port_cd]
            AND IO_BND_CD = @[io_bnd_cd]
            AND DTL.EFF_DT = MAX_RT.EFF_DT
       ) RT
 WHERE  TB.USA_WHF_RAT_UT_CD = RT.USA_WHF_RAT_UT_CD(+)
   AND  TB.FULL_MTY_CD = RT.FULL_MTY_CD(+)
   AND  TB.USA_WHF_TRSP_TP_CD = RT.USA_WHF_TRSP_TP_CD(+)
   AND  TB.USA_WHF_EXPT_FLG = RT.USA_WHF_EXPT_FLG(+)
)			]]></sql>
			<params>
				<param name="io_bnd_cd" type="12" value="" out="N"/>
				<param name="cre_usr_id" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="port_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
