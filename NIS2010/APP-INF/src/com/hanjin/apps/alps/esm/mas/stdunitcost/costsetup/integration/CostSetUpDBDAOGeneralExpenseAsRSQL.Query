<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CostSetUpDBDAOGeneralExpenseAsRSQL">
			<desc><![CDATA[GeneralExpenseAs]]></desc>
			<sql><![CDATA[
SELECT A.*
     , A.OTR_EXPN_AMT * A.GEN_EXPN_RTO / 100 AS GEN_EXPN_AMT
     , 'I' AS ibflag
FROM (
SELECT REPLACE(@[f_cost_yrmon], '-','') AS COST_YRMON,
       RHQ_CD,
       OFC_VW_CD,
       CASE WHEN SUM_RATIO != 100 THEN
            CASE WHEN RNK = 1 THEN
                 RATIO + (100 - SUM_RATIO)
            ELSE
                 RATIO
            END
       ELSE
            RATIO
       END AS GEN_EXPN_RTO,
       (SELECT OTR_EXPN_AMT
          FROM MAS_MNL_COST_STUP
         WHERE COST_YRMON =  REPLACE(@[f_cost_yrmon], '-','')
           AND cost_wk    = 'XX'
           AND RLANE_CD   = 'GENTT'
       ) OTR_EXPN_AMT	-- 일반관리비 확정금액 (메인화면에서 입력)       
  FROM (
        SELECT OFC_VW_CD,
               RHQ_CD,
               RATIO,              
               DENSE_RANK() OVER(PARTITION BY OFC_VW_CD ORDER BY OFC_VW_CD, RATIO) AS RNK,
               SUM(RATIO) OVER(PARTITION BY OFC_VW_CD) AS SUM_RATIO
          FROM (
                SELECT OFC_VW_CD,
                       RHQ_CD,
                       ROUND(RATIO_TO_REPORT(TTL_REV) OVER(PARTITION BY OFC_VW_CD) * 100,2) AS RATIO
                  FROM (
                        SELECT OFC_VW_CD,
                               RHQ_CD,
                               NVL(SUM(REV_AMT),0) AS TTL_REV
                          FROM MAS_HJSACT_RHQ_REV_IF
                         WHERE COST_YRMON BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(REPLACE(@[f_sweek], '-',''),'YYYYMM'), - @[f_dur]),'YYYYMM') AND REPLACE(@[f_sweek], '-','')
                           AND OFC_VW_CD = @[ofc_vw_cd]
                           AND EXISTS (
                                      SELECT 1 FROM MAS_OFC_LVL L
                                      WHERE REPLACE(@[f_cost_yrmon], '-','') BETWEEN OFC_APLY_FM_YRMON AND OFC_APLY_TO_YRMON 
                                        AND OFC_LVL <> '9'
                                        AND OFC_N2ND_LVL_CD = RHQ_CD
                               )
                         GROUP BY OFC_VW_CD, RHQ_CD  
                      )
               )
        )
  WHERE RHQ_CD IS NOT NULL
) A
ORDER BY A.RHQ_CD			]]></sql>
			<params>
				<param name="f_cost_yrmon" type="12" value="" out="N"/>
				<param name="f_sweek" type="12" value="" out="N"/>
				<param name="f_dur" type="12" value="" out="N"/>
				<param name="ofc_vw_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
