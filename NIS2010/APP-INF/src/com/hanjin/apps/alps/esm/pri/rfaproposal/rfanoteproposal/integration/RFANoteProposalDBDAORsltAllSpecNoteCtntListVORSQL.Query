<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="RFANoteProposalDBDAORsltAllSpecNoteCtntListVORSQL">
			<desc><![CDATA[일괄 승인(Summary)에서 Special Note List 조회
* History
  2015.10.28 [CHM-201538236] RFA module 승인 절차 간소화 및 기능 개선 Request by SELCMU/김현경]]></desc>
			<sql><![CDATA[
SELECT A.*
FROM   (SELECT	C.PROP_NO
          , C.AMDT_SEQ
          , C.SVC_SCP_CD
          , CASE
              WHEN (C.AMDT_SEQ != C.N1ST_CMNC_AMDT_SEQ AND C.AMDT_SEQ > 0 AND C.AMDT_SEQ != @[amdt_seq]-1) THEN 'N'
              ELSE 'Y'
            END AS DISPLAY_YN
          , C.NOTE_SEQ
          , C.NOTE_TP_CD
          , C.NOTE_CTNT_SEQ
          , C.NOTE_CTNT
          , C.NOTE_CONV_FLG
          , C.DP_SEQ
          , C.NOTE_CONV_MAPG_ID
          , C.PRC_PROG_STS_CD
          , C.SRC_INFO_CD
          , C.N1ST_CMNC_AMDT_SEQ
          , (SELECT TO_CHAR(EFF_DT, 'YYYYMMDD') 
               FROM PRI_RP_SCP_MN 
              WHERE PROP_NO = C.PROP_NO 
                AND AMDT_SEQ = C.N1ST_CMNC_AMDT_SEQ 
                AND SVC_SCP_CD = C.SVC_SCP_CD) EFF_DT
          , CASE WHEN C.AMDT_SEQ = @[amdt_seq] THEN TO_CHAR(B.EXP_DT,'YYYYMMDD')
                 ELSE (    
                       SELECT CASE WHEN B.EFF_DT <= N.EXP_DT THEN TO_CHAR(B.EFF_DT - 1,'YYYYMMDD')
                                   ELSE TO_CHAR(N.EXP_DT,'YYYYMMDD')
                              END AS EXP_DT
                         FROM PRI_RP_SCP_MN N
                        WHERE PROP_NO = B.PROP_NO AND AMDT_SEQ = B.AMDT_SEQ-1 AND SVC_SCP_CD = B.SVC_SCP_CD ) 
            END  EXP_DT
          , (SELECT TO_CHAR(EFF_DT, 'YYYYMMDD') FROM PRI_RP_SCP_MN
              WHERE PROP_NO = C.PROP_NO
                AND AMDT_SEQ    = C.AMDT_SEQ - 1
                AND SVC_SCP_CD  = C.SVC_SCP_CD ) BEF_EFF_DT
          , (SELECT TO_CHAR(EXP_DT, 'YYYYMMDD') FROM PRI_RP_SCP_MN
              WHERE PROP_NO = C.PROP_NO
                AND AMDT_SEQ    = C.AMDT_SEQ - 1
                AND SVC_SCP_CD  = C.SVC_SCP_CD ) BEF_EXP_DT
       FROM PRI_RP_SCP_NOTE A,
            PRI_RP_SCP_MN B,
            PRI_RP_SCP_NOTE_CTNT C
      WHERE A.PROP_NO     = B.PROP_NO
        AND A.AMDT_SEQ      = B.AMDT_SEQ
        AND A.SVC_SCP_CD    = B.SVC_SCP_CD
        AND B.PROP_NO       = C.PROP_NO
        AND B.SVC_SCP_CD    = C.SVC_SCP_CD
        AND A.NOTE_TP_CD    = C.NOTE_TP_CD
        AND A.NOTE_SEQ      = C.NOTE_SEQ
        AND A.PROP_NO = @[prop_no]
        AND A.AMDT_SEQ = @[amdt_seq]
    #if (${svc_scp_cd} != '')
        AND A.SVC_SCP_CD = @[svc_scp_cd]
    #end
        AND A.NOTE_TP_CD = @[note_tp_cd]
        AND C.AMDT_SEQ IN ( @[amdt_seq], @[amdt_seq] -1 )
        AND ( C.AMDT_SEQ = @[amdt_seq]
            OR ( C.AMDT_SEQ = @[amdt_seq]-1
                    AND  C.SRC_INFO_CD <> 'AD'
                    AND  NOT EXISTS (  SELECT 'x' FROM PRI_RP_SCP_NOTE_CTNT AA
                                        WHERE AA.PROP_NO			= C.PROP_NO 
                                          AND AA.AMDT_SEQ			= @[amdt_seq]
                                          AND AA.SVC_SCP_CD			= C.SVC_SCP_CD 
                                          AND AA.NOTE_SEQ			= C.NOTE_SEQ
                                          AND AA.NOTE_CTNT_SEQ		= C.NOTE_CTNT_SEQ 
                                          AND AA.NOTE_TP_CD			= C.NOTE_TP_CD
                                          AND AA.N1ST_CMNC_AMDT_SEQ	= C.N1ST_CMNC_AMDT_SEQ 
                                    )
               )
            )
      ORDER BY FIRST_VALUE(C.DP_SEQ) OVER ( PARTITION BY C.NOTE_CTNT_SEQ ORDER BY C.AMDT_SEQ ), C.AMDT_SEQ
) A
WHERE DISPLAY_YN = 'Y' -- 조회되는 데이터 중 승인이 필요한 초기 데이터나 amend 정보만을 조회하기 위한 플래그			]]></sql>
			<params>
				<param name="amdt_seq" type="12" value="1" out="N"/>
				<param name="prop_no" type="12" value="AEV130373" out="N"/>
				<param name="svc_scp_cd" type="12" value="AFW" out="N"/>
				<param name="note_tp_cd" type="12" value="P" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
