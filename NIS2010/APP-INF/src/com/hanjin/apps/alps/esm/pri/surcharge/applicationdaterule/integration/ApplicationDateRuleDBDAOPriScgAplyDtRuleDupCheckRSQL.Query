<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ApplicationDateRuleDBDAOPriScgAplyDtRuleDupCheckRSQL">
			<desc><![CDATA[2011.07.29 [CHM-201112030-01] Application Date Rule Creation 시스템 개발 요청 (Pricing) 신규개발
                                                - Save전 중복된 데이터를 조회한다.]]></desc>
			<sql><![CDATA[
WITH DB_DATA AS (
    SELECT  TO_CHAR(SCG_APLY_DT_RULE_SEQ) AS SCG_APLY_DT_RULE_SEQ
           ,SVC_SCP_CD
           ,POR_DEF_CD
           ,POL_DEF_CD
           ,POD_DEF_CD
           ,DEL_DEF_CD
           ,TO_CHAR(EFF_DT,'YYYY-MM-DD') AS EFF_DT
           ,TO_CHAR(EXP_DT,'YYYY-MM-DD') AS EXP_DT
      FROM  PRI_SCG_APLY_DT_RULE
     WHERE  1 = 1
       #if($expVal.size() != 0)
       AND  SCG_APLY_DT_RULE_SEQ
            NOT IN (
                    #foreach(${key} in ${expVal})
                        #if($velocityCount < $expVal.size())
                            '${key}',
                        #else
                            '${key}'
                        #end
                    #end
                   )
       #end
    )
    , INPUT_DATA AS (
    SELECT  '' AS SCG_APLY_DT_RULE_SEQ
           ,'' AS SVC_SCP_CD
           ,'' AS POR_DEF_CD
           ,'' AS POL_DEF_CD
           ,'' AS POD_DEF_CD
           ,'' AS DEL_DEF_CD
           ,'' AS EFF_DT
           ,'' AS EXP_DT 
      FROM  DUAL
    #foreach(${obj} in ${chk_obj})
    UNION ALL
    SELECT  '$obj.getScgAplyDtRuleSeq()' AS SCG_APLY_DT_RULE_SEQ
           ,'$obj.getSvcScpCd()' AS SVC_SCP_CD
           ,'$obj.getPorDefCd()' AS POR_DEF_CD
           ,'$obj.getPolDefCd()' AS POL_DEF_CD
           ,'$obj.getPodDefCd()' AS POD_DEF_CD
           ,'$obj.getDelDefCd()' AS DEL_DEF_CD
           ,TO_CHAR(TO_DATE('$obj.getEffDt()', 'YYYY-MM-DD'), 'YYYY-MM-DD') AS EFF_DT
           ,TO_CHAR(TO_DATE('$obj.getExpDt()', 'YYYY-MM-DD'), 'YYYY-MM-DD') AS EXP_DT 
      FROM  DUAL
    #end
    )
SELECT  SCG_APLY_DT_RULE_SEQ
       ,SVC_SCP_CD
       ,POR_DEF_CD
       ,POL_DEF_CD
       ,POD_DEF_CD
       ,DEL_DEF_CD
       ,EFF_DT
       ,EXP_DT
  FROM  (
        SELECT  A.SCG_APLY_DT_RULE_SEQ
               ,A.SVC_SCP_CD
               ,A.POR_DEF_CD
               ,A.POL_DEF_CD
               ,A.POD_DEF_CD
               ,A.DEL_DEF_CD
               ,A.EFF_DT
               ,A.EXP_DT
          FROM  DB_DATA A
         WHERE  1 = 1
           AND  EXISTS (SELECT  'X'
                          FROM  INPUT_DATA B
                         WHERE  1 = 1
                           AND  NVL(B.SVC_SCP_CD, 'X') = NVL(A.SVC_SCP_CD, 'X')
                           AND  NVL(B.POR_DEF_CD, 'X') = NVL(A.POR_DEF_CD, 'X')
                           AND  NVL(B.POL_DEF_CD, 'X') = NVL(A.POL_DEF_CD, 'X')
                           AND  NVL(B.POD_DEF_CD, 'X') = NVL(A.POD_DEF_CD, 'X')
                           AND  NVL(B.DEL_DEF_CD, 'X') = NVL(A.DEL_DEF_CD, 'X')
                           AND  ((B.EFF_DT < A.EFF_DT AND NVL(B.EXP_DT, '99991231') >= NVL(A.EFF_DT, '99991231'))
                            OR   (B.EFF_DT BETWEEN A.EFF_DT AND NVL(A.EXP_DT, '99991231'))))
        UNION
        SELECT  A.SCG_APLY_DT_RULE_SEQ
               ,A.SVC_SCP_CD
               ,A.POR_DEF_CD
               ,A.POL_DEF_CD
               ,A.POD_DEF_CD
               ,A.DEL_DEF_CD
               ,A.EFF_DT
               ,A.EXP_DT
          FROM  INPUT_DATA A
         WHERE  1 = 1
           AND  EXISTS (SELECT  'X'
                          FROM  INPUT_DATA B
                         WHERE  1 = 1
                           AND  NVL(B.SVC_SCP_CD, 'X') = NVL(A.SVC_SCP_CD, 'X')
                           AND  NVL(B.POR_DEF_CD, 'X') = NVL(A.POR_DEF_CD, 'X')
                           AND  NVL(B.POL_DEF_CD, 'X') = NVL(A.POL_DEF_CD, 'X')
                           AND  NVL(B.POD_DEF_CD, 'X') = NVL(A.POD_DEF_CD, 'X')
                           AND  NVL(B.DEL_DEF_CD, 'X') = NVL(A.DEL_DEF_CD, 'X')
                           AND  ((B.EFF_DT < A.EFF_DT AND NVL(B.EXP_DT, '99991231') >= NVL(A.EFF_DT, '99991231'))
                            OR   (B.EFF_DT BETWEEN A.EFF_DT AND NVL(A.EXP_DT, '99991231')))
                        GROUP BY B.SVC_SCP_CD, B.POR_DEF_CD, B.POL_DEF_CD, B.POD_DEF_CD, B.DEL_DEF_CD
                        HAVING COUNT(1) >= 2)
        ) 
 ORDER  BY SVC_SCP_CD, POR_DEF_CD, POL_DEF_CD, POD_DEF_CD, DEL_DEF_CD, EFF_DT			]]></sql>
			<params>
			</params>
		</query>
	</querys>
</sqls>
