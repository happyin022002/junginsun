<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ArrivalNoticeDBDAOsearchArrNtcCustListForUploadRSQL">
			<desc><![CDATA[0672-3 조회]]></desc>
			<sql><![CDATA[
SELECT CMST.BKG_NO       
     , CMST.BKG_CUST_TP_CD
     , MAX(CMST.BL_NO      ) AS BL_NO
     , MAX(CMST.CUST_CNT_CD) AS CUST_CNT_CD
     , MAX(CMST.CUST_SEQ   ) AS CUST_SEQ
     , MAX(CMST.CUST_NM    ) AS CUST_NM
     , MAX(CMST.CUST_FAX_NO) AS CUST_FAX_NO
     , MAX(CMST.CUST_EML   ) AS CUST_EML
     , MAX(DECODE(NDTL.CUST_CNTC_TP_CD,'C2',NDTL.FAX_NO,''))  AS FAX_NO1
     , MAX(DECODE(NDTL.CUST_CNTC_TP_CD,'B1',NDTL.FAX_NO,''))  AS FAX_NO2
     , MAX(DECODE(NDTL.CUST_CNTC_TP_CD,'B2',NDTL.FAX_NO,''))  AS FAX_NO3
     , MAX(DECODE(NDTL.CUST_CNTC_TP_CD,'C2',NDTL.NTC_EML,'')) AS NTC_EML1
     , MAX(DECODE(NDTL.CUST_CNTC_TP_CD,'B1',NDTL.NTC_EML,'')) AS NTC_EML2
     , MAX(DECODE(NDTL.CUST_CNTC_TP_CD,'B2',NDTL.NTC_EML,'')) AS NTC_EML3
        --저장용
     , '' AS CUST_CNTC_TP_CD
     , '' AS FAX_NO
     , '' AS NTC_EML
FROM ( /* ======= CMST START ========= */
     SELECT BKGM.BKG_NO
          , BKGM.BL_NO
          , BKGM.SC_NO
          , BKGM.DEL_CD
          , BCST.BKG_CUST_TP_CD
          , BCST.CUST_CNT_CD
          , BCST.CUST_SEQ
          , BCST.CUST_NM
          , BCST.CUST_FAX_NO
          , BCST.CUST_EML
       FROM VSK_VSL_PORT_SKD VSKD
          , BKG_VVD BVVD
          , BKG_BOOKING BKGM
          , BKG_CUSTOMER BCST      
      WHERE 1 = 1      
#if (${sch_tp} == 'V') 
        AND BVVD.VSL_CD     = SUBSTR(@[vvd], 1,4) 
        AND BVVD.SKD_VOY_NO = SUBSTR(@[vvd], 5,4)
        AND BVVD.SKD_DIR_CD = SUBSTR(@[vvd], 9,1)
        AND BVVD.POD_CD     = @[pod_cd] -- (OPTIONAL 3)
#elseif (${sch_tp} == 'D') 
        AND VSKD.VPS_ETA_DT 
            BETWEEN TO_DATE(@[vps_eta_dt_start], 'YYYY-MM-DD') 
                AND TO_DATE(@[vps_eta_dt_end], 'YYYY-MM-DD') +0.99999  -- DURATION (OPTIONAL 2)
        AND VSKD.VPS_PORT_CD = @[pod_cd] -- (OPTIONAL 3)
#elseif (${sch_tp} == 'B') 
        AND BKGM.BL_NO = @[bl_no]  -- BL NO (OPTIONAL 5-1)
#else
        AND 1 = 0
#end
#if (${sch_tp} != 'B' && ${del_cd} != '') 
        AND BKGM.DEL_CD LIKE LPAD(@[del_cd], 2, '-') || '%'  -- DELIVERY PORT CD (OPTIONAL 4)
#end
#if (${sch_tp} != 'B' && ${pol_cd} != '') 
        AND BKGM.POL_CD = @[pol_cd]
#end
#if (${s_no} != '' && ${c_no} != '') 
        AND BKGM.SC_NO = @[s_no] || @[c_no] -- SC NO (OPTINALE 9)
#end
#if (${cust_nm} != '') 
        AND UPPER(BCST.CUST_NM) like '%' || UPPER(@[cust_nm]) || '%'   -- name
#end
#if (${cust_cnt_cd} != '') 
        AND (   BCST.CUST_CNT_CD = @[cust_cnt_cd] )
#end
#if (${cust_seq} != '')
        AND (   BCST.CUST_SEQ = @[cust_seq] )
#end
#if (${cust_ref_no} != '') 
        AND (BKGM.BKG_NO) IN (SELECT BR.BKG_NO
                                FROM BKG_REFERENCE BR
                               WHERE BR.BKG_REF_TP_CD = 'BKPO'
                                 AND BR.BKG_NO = BKGM.BKG_NO
                                 AND BR.CUST_REF_NO_CTNT  = @[cust_ref_no]  -- 고객이 요청하는 번호 (0ptional 8)
                              ) -- BKG REFERENCE NUMBER -- (OPTIONAL END )
#end
#if (${sch_tp} == 'D') 
        AND BVVD.VSL_CD = VSKD.VSL_CD    -- Join의 방향성 때문에 Duration인 경우와 아닌 경우를 분리함
        AND BVVD.SKD_VOY_NO = VSKD.SKD_VOY_NO
        AND BVVD.SKD_DIR_CD = VSKD.SKD_DIR_CD
        AND BVVD.POD_CD = VSKD.VPS_PORT_CD
        AND BVVD.POD_CLPT_IND_SEQ = VSKD.CLPT_IND_SEQ
#else
        AND BVVD.VSL_CD = VSKD.VSL_CD(+)   -- Duration이 아닌경우에는 데이터를 추출하기 위하여 해당과 같이 처리한다. (20100106 Park Mangeon)
        AND BVVD.SKD_VOY_NO = VSKD.SKD_VOY_NO(+)
        AND BVVD.SKD_DIR_CD = VSKD.SKD_DIR_CD(+)
        AND BVVD.POD_CD = VSKD.VPS_PORT_CD(+)
        AND BVVD.POD_CLPT_IND_SEQ = VSKD.CLPT_IND_SEQ(+)
#end
        AND BKGM.BKG_NO =BVVD.BKG_NO      
#if ( ${ts_flg} != 'Y')     
        AND BKGM.POD_CD = BVVD.POD_CD
#else
        AND BKGM.PST_RLY_PORT_CD = BVVD.POD_CD
#end 
        AND BKGM.BKG_STS_CD NOT IN( 'X', 'S')
        AND BKGM.BL_NO IS NOT NULL
        AND BKGM.BKG_CGO_TP_CD IN ('F', 'R')                           -------- modified by 0672-01
        AND BCST.BKG_NO = BKGM.BKG_NO
        AND BCST.BKG_CUST_TP_CD IN ('C', 'N')
        AND (
                 (BKGM.SAM_CNEE_NTFY_FLG = 'N' 
                  AND BKGM.CUST_TO_ORD_FLG = 'N' -- Consignee, Notify둘다 생성
                 )
              OR (BKGM.SAM_CNEE_NTFY_FLG = 'Y'  -- Notify는 Consignee와 같으므로 Consignee만 생성
                  AND BCST.BKG_CUST_TP_CD = 'C'
                 )
              OR (BKGM.CUST_TO_ORD_FLG = 'Y'    -- Notify에게 연락하므로 Notify만 생성
                  AND BCST.BKG_CUST_TP_CD = 'N'
                 )
            )
--        AND NVL(BCST.VAL_CD, '*') <> 'S'  -- SKIP은 NOTICE를 발송하지 않는다. (20091229 - 심영우과장에 의함)
        AND BCST.VAL_CD = 'N'      --------- Not Exists에 대해서 연락처 정보 처리
      ) CMST /* ======= CMST END ========= */      
      LEFT OUTER JOIN BKG_ARR_NTC_DTL NDTL       
      ON( CMST.BKG_NO=  NDTL.BKG_NO
          AND CMST.BKG_CUST_TP_CD = NDTL.BKG_CUST_TP_CD
          AND NDTL.CUST_CNTC_TP_CD IN( 'C2', 'B1', 'B2')
         )
 GROUP BY CMST.BKG_NO
        , CMST.BKG_CUST_TP_CD			]]></sql>
			<params>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="vps_eta_dt_start" type="12" value="" out="N"/>
				<param name="vps_eta_dt_end" type="12" value="" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
				<param name="del_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="s_no" type="12" value="" out="N"/>
				<param name="c_no" type="12" value="" out="N"/>
				<param name="cust_nm" type="12" value="" out="N"/>
				<param name="cust_cnt_cd" type="12" value="" out="N"/>
				<param name="cust_seq" type="12" value="" out="N"/>
				<param name="cust_ref_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
