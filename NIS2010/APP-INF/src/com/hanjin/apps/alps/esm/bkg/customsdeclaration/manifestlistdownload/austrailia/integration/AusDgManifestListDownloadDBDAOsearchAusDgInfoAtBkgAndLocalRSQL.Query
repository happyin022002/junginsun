<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="AusDgManifestListDownloadDBDAOsearchAusDgInfoAtBkgAndLocalRSQL">
			<desc><![CDATA[호주 위험물 정보조회 시,  Booking 쪽과 Local 테이블쪽 정보를 동시에 조회한다.]]></desc>
			<sql><![CDATA[
SELECT TBL.*, CASE WHEN DG_LIST_LOCAL_YN = 'N' AND DG.BKG_NO IS NOT NULL THEN '+'
WHEN DG_LIST_LOCAL_YN = 'Y' AND DG.BKG_NO IS NULL THEN '-' ELSE '' END DG
FROM 
(
SELECT SEQ,CNTR_CNT,MERGE_BL_NO,BL_NO,BKG_NO,POL_CD,POD_CD,
CNTR_NO,CNTR_CGO_SEQ,CNTR_TPSZ_CD,IMDG_CLSS_CD,IMDG_UN_NO,IMDG_UN_NO_SEQ,
IMDG_COMP_GRP_CD,DG_CNTR_SEQ,DG_SHORT_NM,DG_SHORT_NM_CNT,FLSH_PNT_CDO_TEMP,
AGENT,FWRD_ID1,C_TYPE,SVC_RQST_NO,IMDG_PCK_GRP_CD,IN_IMDG_PCK_QTY1,IN_IMDG_PCK_CD1,
IN_PCK_DESC,OUT_IMDG_PCK_QTY1,OUT_IMDG_PCK_CD1,OUT_PCK_DESC,EMS_NO,NET_WGT,GRS_WGT,
PACKAGES,PRP_SHP_NM,HZD_DESC,FWRD_ID,FWRD_NM,DCGO_MRN_POLUT_CD,IMDG_LMT_QTY_FLG,FDR_VSL_NM,
FDR_VSL_LLOYD_NO,FDR_VVD_ID,CRR_DT,IMDG_SUBS_RSK_LBL_CD1,IMDG_SUBS_RSK_LBL_CD2,
IMDG_SUBS_RSK_LBL_CD3,IMDG_SUBS_RSK_LBL_CD4,SEND_TYPE,SCR_FILE_NO,MSG_SND_NO,
FIRST_MSG_SND_NO,GROUP_CNT,
NET_EXPLO_WGT,DG_LIST_LOCAL_YN,D_TYPE,VVD_CD,PORT_CD,CRE_USR_ID,UPD_USR_ID,
RANK() OVER (PARTITION BY BKG_NO, CNTR_NO,CNTR_CGO_SEQ ORDER BY DG_LIST_LOCAL_YN DESC) RN
FROM 
(                                                                                                                                               
SELECT                                                                                                                                                           
		SUM(BVD.SEQ) OVER (ORDER BY BVD.BL_NO, BVD.POL_CD, BVD.POD_CD, BVD.CNTR_NO) SEQ                                                                
       ,BVD.CNTR_CNT                                                                                                                                             
       ,BVD.BL_NO MERGE_BL_NO                                                                                                                                    
       ,BVD.BL_NO   
       ,BVD.BKG_NO
       ,BVD.POL_CD                                                                                                                                               
       ,BVD.POD_CD                                                                                                                                               
       ,BVD.CNTR_NO                                                                                                                                              
	   ,NVL(BVD.CNTR_CGO_SEQ, 1) AS CNTR_CGO_SEQ                                                                                                             
	   ,BVD.CNTR_TPSZ_CD
       ,BVD.IMDG_CLSS_CD 
       ,BVD.IMDG_UN_NO                                                                                                                                           
	   ,BVD.IMDG_UN_NO_SEQ                                                                                                                                                                                                                                                                                                                                                                                                          
	   ,BVD.IMDG_COMP_GRP_CD                                                                                                                                                                                                                                                                                
       ,BVD.DG_CNTR_SEQ
	   ,BVD.DG_SHORT_NM                                                                                                                         
	   ,COUNT(BVD.DG_SHORT_NM) OVER() AS DG_SHORT_NM_CNT                                                                                                     
	   ,BVD.FLSH_PNT_CDO_TEMP                                                                                                                                
       ,'' AS AGENT                                                                                                                                  
       ,'' AS FWRD_ID1                                                                                                                             
       ,'' AS C_TYPE                                                                                                                            
       ,'' AS SVC_RQST_NO                                                                                                                          
       ,NVL(BVD.IMDG_PCK_GRP_CD,'N') IMDG_PCK_GRP_CD                                                                                                             
       ,BVD.IN_IMDG_PCK_QTY1                                                                                                                                     
       ,BVD.IN_IMDG_PCK_CD1                                                                                                                                      
       ,DECODE(NVL(BVD.IN_IMDG_PCK_QTY1, '0'), '0', (SELECT IMDG_PCK_DESC FROM SCG_IMDG_PCK_CD WHERE IMDG_PCK_CD = IN_IMDG_PCK_CD1)                             
       , BVD.IN_IMDG_PCK_QTY1 || ' ' || (SELECT IMDG_PCK_DESC FROM SCG_IMDG_PCK_CD WHERE IMDG_PCK_CD = IN_IMDG_PCK_CD1))  AS IN_PCK_DESC                                                                                                                        
                                                                                                                                                                 
       ,BVD.OUT_IMDG_PCK_QTY1                                                                                                                                    
       ,BVD.OUT_IMDG_PCK_CD1                                                                                                                                     
	   ,DECODE(NVL(BVD.OUT_IMDG_PCK_QTY1, '0'), '0', (SELECT IMDG_PCK_DESC FROM SCG_IMDG_PCK_CD WHERE IMDG_PCK_CD = OUT_IMDG_PCK_CD1)                        
       ,BVD.OUT_IMDG_PCK_QTY1 || ' ' || (SELECT IMDG_PCK_DESC FROM SCG_IMDG_PCK_CD WHERE IMDG_PCK_CD = OUT_IMDG_PCK_CD1))  AS OUT_PCK_DESC                                                                                                                                                    
       ,BVD.EMS_NO                                                                                                                                               
       ,BVD.NET_WGT                                                                                                                                              
       ,BVD.GRS_WGT                                                                                                                                              
	   ,DECODE(NVL(BVD.OUT_IMDG_PCK_QTY1, '0'), '0', (SELECT IMDG_PCK_DESC FROM SCG_IMDG_PCK_CD WHERE IMDG_PCK_CD = OUT_IMDG_PCK_CD1)                        
       , BVD.OUT_IMDG_PCK_QTY1 || ' ' || (SELECT IMDG_PCK_DESC FROM SCG_IMDG_PCK_CD WHERE IMDG_PCK_CD = OUT_IMDG_PCK_CD1))  AS PACKAGES                                                                                                                           
                                                                                                                                                                 
       ,BVD.PRP_SHP_NM                                                                                                                                           
       ,BVD.HZD_DESC
       ,'' FWRD_ID 					-- Forwarder Code
       ,'' FWRD_NM          		-- Forwarder Name
	    ,'' DCGO_MRN_POLUT_CD		-- Marine Pollutant
        ,'' IMDG_LMT_QTY_FLG		-- Limited quantity

       	,''FDR_VSL_NM           -- Feeder Name
       	,''FDR_VSL_LLOYD_NO     -- Feeder Lloyd No
       	,''FDR_VVD_ID           -- Feeder VVD
		,''	CRR_DT	   -- on carriage date
	   ,BVD.IMDG_SUBS_RSK_LBL_CD1                                                                                                                            
	   ,BVD.IMDG_SUBS_RSK_LBL_CD2                                                                                                                            
	   ,BVD.IMDG_SUBS_RSK_LBL_CD3                                                                                                                            
	   ,BVD.IMDG_SUBS_RSK_LBL_CD4 
       ,'' SEND_TYPE
        ,'' SCR_FILE_NO
   		,''MSG_SND_NO
   		,'' FIRST_MSG_SND_NO
 		,NULL GROUP_CNT
                                                                                                                                                                 
--	   ,BVD.MRN_POLUT_FLG 		DCGO_MRN_POLUT_CD	                                                                            
--       ,BVD.IMDG_LMT_QTY_FLG 	IMDG_LMT_QTY_FLG	                                                                                    
       ,BVD.NET_EXPLO_WGT
	   , 'N' DG_LIST_LOCAL_YN 
		, @[d_type] D_TYPE 
		, @[vvd_cd] VVD_CD
		, @[port_cd] PORT_CD  
		, '' CRE_USR_ID
		, '' UPD_USR_ID 
                                                                                                                                   
                                                                                                                                                                 
FROM                                                                                                                                                           
        (SELECT                                                                                                                                                  
				DECODE(LAG(BK.BL_NO) OVER ( ORDER BY BK.BL_NO, BV.POL_CD, BV.POD_CD, BDC.CNTR_NO) , BK.BL_NO, 0, 1) SEQ                          
				,COUNT(DISTINCT bdc.cntr_no) OVER() CNTR_CNT                                                                                     
               ,BV.BKG_NO      BKG_NO                                                                                                                            
 			   ,BK.BL_NO	  BL_NO                                                                                                                  
               ,BV.POL_CD     POL_CD                                                                                                                             
               ,BV.POD_CD     POD_CD                                                                                                                             
               ,BV.VSL_CD     VSL_CD                                                                                                                             
               ,BV.SKD_VOY_NO SKD_VOY_NO                                                                                                                         
               ,BV.SKD_DIR_CD SKD_DIR_CD                                                                                                                         
               ,BDC.CNTR_NO           CNTR_NO                                                                                                                    
               ,BDC.CNTR_CGO_SEQ      CNTR_CGO_SEQ                                                                                                               
			   ,BDC.CNTR_TPSZ_CD      CNTR_TPSZ_CD                                                                                                   
			   ,SIUN.IMDG_COMP_GRP_CD                                                                                                                
               ,BDC.IMDG_UN_NO        IMDG_UN_NO                                                                                                                 
               ,BDC.IMDG_UN_NO_SEQ                                                                                                                               
               ,BDC.IMDG_CLSS_CD                                                                                                                                 
			   ,(SELECT ANR_SPCL_TP_ID                                                                                                               
                 FROM BKG_CSTMS_EUR_DG_SPCL                                                                                                                    
                 WHERE IMDG_UN_NO = BDC.IMDG_UN_NO) AS DG_SHORT_NM                                                                                              
               ,BDC.DG_CNTR_SEQ                                                                                                                                  
               ,BDC.FLSH_PNT_CDO_TEMP FLSH_PNT_CDO_TEMP                                                                                                          
               ,BDC.IMDG_PCK_GRP_CD   IMDG_PCK_GRP_CD                                                                                                                                                  
               ,BDC.IN_IMDG_PCK_QTY1  IN_IMDG_PCK_QTY1                                                                                                           
               ,BDC.IN_IMDG_PCK_CD1   IN_IMDG_PCK_CD1                                                                                                                                                                                                                                                                     
               ,BDC.OUT_IMDG_PCK_QTY1 OUT_IMDG_PCK_QTY1                                                                                                          
               ,BDC.OUT_IMDG_PCK_CD1  OUT_IMDG_PCK_CD1                                                                                                           
               ,BDC.EMS_NO            EMS_NO                                                                                                                     
               ,BDC.NET_WGT           NET_WGT                                                                                                                    
               ,BDC.GRS_WGT           GRS_WGT                                                                                                                    
               ,BDC.PRP_SHP_NM        PRP_SHP_NM                                                                                                                 
               ,BDC.HZD_DESC          HZD_DESC                                                                                                                   
			   ,BDC.IMDG_SUBS_RSK_LBL_CD1          IMDG_SUBS_RSK_LBL_CD1                                                                             
			   ,BDC.IMDG_SUBS_RSK_LBL_CD2          IMDG_SUBS_RSK_LBL_CD2                                                                             
			   ,BDC.IMDG_SUBS_RSK_LBL_CD3          IMDG_SUBS_RSK_LBL_CD3                                                                             
			   ,BDC.IMDG_SUBS_RSK_LBL_CD4          IMDG_SUBS_RSK_LBL_CD4                  
               ,BDC.MRN_POLUT_FLG	  MRN_POLUT_FLG                                                                                                  
			   ,BDC.IMDG_LMT_QTY_FLG  IMDG_LMT_QTY_FLG                                                                                               
               ,BDC.NET_EXPLO_WGT                                                                                                                               
                                                                                                                                                                 
          FROM (                                                                                                                                                 
			     SELECT *                                                                                                                             
          			FROM 	BKG_VVD BV                                                                                                                      
          			WHERE 1=1                                                                                                                            
                  	AND BV.VSL_CD        =   SUBSTR(@[vvd_cd], 1, 4)                                                                                     
    				AND BV.SKD_VOY_NO    =   SUBSTR(@[vvd_cd], 5, 4)                                                                                     
         			AND BV.SKD_DIR_CD    =   SUBSTR(@[vvd_cd], 9, 1)                                                                                     
                                                                                                                                                                 
                	#if (${d_type} == 'D' || ${d_type} == 'DO' || ${d_type} == 'O')                         
             		AND BV.POD_CD      = @[port_cd]                                                                                                  
               		#elseif (${d_type} == 'L' || ${d_type} == 'PL' || ${d_type} == 'P')                            
                  	AND   BV.POL_CD      = @[port_cd]                                                                                                
         			#else                                                                                                                                
    			  	AND   BV.POL_CD      = @[port_cd]                                                                                        
    		       	#end                                                                                                                                    
               		                                                                                                                                                           
                ) BV                                                                                                                                             
               ,BKG_DG_CGO BDC                                                                                                                                   
               ,BKG_BOOKING BK                                                                                                                                   
			   ,SCG_IMDG_UN_NO SIUN                                                                                                                  
           WHERE 1=1                                                                                                                                               
                                                                                                                                                                 
           AND BV.BKG_NO        =   BK.BKG_NO                                                                                                                    
           AND BV.BKG_NO        =   BDC.BKG_NO                                                                                                                                                    
		   AND BDC.IMDG_UN_NO	= 	SIUN.IMDG_UN_NO(+)                                                                                               
		   AND BDC.IMDG_UN_NO_SEQ = SIUN.IMDG_UN_NO_SEQ(+)                                                                                                                                                       
           AND BK.DCGO_FLG      =   'Y'                                                                                                                          
           AND BK.BKG_STS_CD    <>  'X'                                                                                                                                                            
        )BVD                                                                                                                                                     
                                                                                                                                                                 
WHERE 1 = 1                                                                                                                                                     
		#if (${bl_no} != '')                                                                                                                                             
	 		AND   BVD.BL_NO     = @[bl_no]                                                                                                                          
		#end                                                                                                                                                                        
AND 'T' <> @[d_type]                                                                                                                                            

   UNION ALL                                                                                                                                                   
                                                                                                                                                                 
SELECT                                                                                                                                                           
		SUM(BVD.SEQ) OVER (ORDER BY BVD.BL_NO, BVD.POL_CD, BVD.POD_CD, BVD.CNTR_NO) SEQ                                                                  
	   ,BVD.CNTR_CNT                                                                                                                                         
       ,BVD.BL_NO MERGE_BL_NO                                                                                                                                    
       ,BVD.BL_NO       
       ,BVD.BKG_NO
       ,BVD.POL_CD                                                                                                                                               
       ,BVD.POD_CD                                                                                                                                               
       ,BVD.CNTR_NO                                                                                                                                              
	   ,NVL(BVD.CNTR_CGO_SEQ, 0) AS CNTR_CGO_SEQ                                                                                                             
	   ,BVD.CNTR_TPSZ_CD                                                                                                                                                                                                                                                                                         
	   ,BVD.IMDG_CLSS_CD 
       ,BVD.IMDG_UN_NO                                                                                                                                           
	   ,BVD.IMDG_UN_NO_SEQ                                                                                                                                                                                                                                                                                                                                                                                                          
	   ,BVD.IMDG_COMP_GRP_CD                                                                                                                                            
       ,BVD.DG_CNTR_SEQ                                                                                                                                          
	   ,BVD.DG_SHORT_NM                                                                                                                         
	   ,COUNT(BVD.DG_SHORT_NM) OVER() AS DG_SHORT_NM_CNT                                                                                                     
       ,BVD.FLSH_PNT_CDO_TEMP                                                                                                                                    
       ,'' AS AGENT                                                                                                                                    
       ,'' AS FWRD_ID                                                                                                                           
       ,'' AS C_TYPE                                                                                                                            
       ,'' AS SVC_RQST_NO                                                                                                                       
       ,NVL(BVD.IMDG_PCK_GRP_CD,'N') IMDG_PCK_GRP_CD                                                                                                             
       ,BVD.IN_IMDG_PCK_QTY1                                                                                                                                     
       ,BVD.IN_IMDG_PCK_CD1                                                                                                                                      
       ,DECODE(NVL(BVD.IN_IMDG_PCK_QTY1, '0'), '0', (SELECT IMDG_PCK_DESC FROM SCG_IMDG_PCK_CD WHERE IMDG_PCK_CD = IN_IMDG_PCK_CD1)                             
       , BVD.IN_IMDG_PCK_QTY1 || ' ' || (SELECT IMDG_PCK_DESC FROM SCG_IMDG_PCK_CD WHERE IMDG_PCK_CD = IN_IMDG_PCK_CD1))  AS IN_PCK_DESC                                                                                                                        
 	   ,BVD.OUT_IMDG_PCK_QTY1                                                                                                                                    
       ,BVD.OUT_IMDG_PCK_CD1                                                                                                                                     
	   ,DECODE(NVL(BVD.OUT_IMDG_PCK_QTY1, '0'), '0', (SELECT IMDG_PCK_DESC FROM SCG_IMDG_PCK_CD WHERE IMDG_PCK_CD = OUT_IMDG_PCK_CD1)                        
       , BVD.OUT_IMDG_PCK_QTY1 || ' ' || (SELECT IMDG_PCK_DESC FROM SCG_IMDG_PCK_CD WHERE IMDG_PCK_CD = OUT_IMDG_PCK_CD1))  AS OUT_PCK_DESC                                                                                                                       
                                                                                                                                                         
       ,BVD.EMS_NO                                                                                                                                               
       ,BVD.NET_WGT                                                                                                                                              
       ,BVD.GRS_WGT                                                                                                                                              
	   ,DECODE(NVL(BVD.OUT_IMDG_PCK_QTY1, '0'), '0', (SELECT IMDG_PCK_DESC FROM SCG_IMDG_PCK_CD WHERE IMDG_PCK_CD = OUT_IMDG_PCK_CD1)                        
       , BVD.OUT_IMDG_PCK_QTY1 || ' ' || (SELECT IMDG_PCK_DESC FROM SCG_IMDG_PCK_CD WHERE IMDG_PCK_CD = OUT_IMDG_PCK_CD1))  AS PACKAGES                                                                                                                           
                                                                                                                                                                 
       ,BVD.PRP_SHP_NM                                                                                                                                           
       ,BVD.HZD_DESC     
       ,'' FWRD_ID 					-- Forwarder Code
       ,'' FWRD_NM          							-- Forwarder Name
	    ,'' DCGO_MRN_POLUT_CD		-- Marine Pollutant
        ,'' IMDG_LMT_QTY_FLG							-- Limited quantity

       	,''FDR_VSL_NM           -- Feeder Name
       	,''FDR_VSL_LLOYD_NO     -- Feeder Lloyd No
       	,''FDR_VVD_ID           -- Feeder VVD
		,''	CRR_DT	   -- on carriage date
	   ,BVD.IMDG_SUBS_RSK_LBL_CD1                                                                                                                            
	   ,BVD.IMDG_SUBS_RSK_LBL_CD2                                                                                                                            
	   ,BVD.IMDG_SUBS_RSK_LBL_CD3                                                                                                                            
	   ,BVD.IMDG_SUBS_RSK_LBL_CD4 
          ,'' SEND_TYPE
        ,'' SCR_FILE_NO
   		,''MSG_SND_NO
   		,'' FIRST_MSG_SND_NO
 		,NULL GROUP_CNT
--	   ,BVD.MRN_POLUT_FLG 		DCGO_MRN_POLUT_CD	                                                                             
--       ,BVD.IMDG_LMT_QTY_FLG 	IMDG_LMT_QTY_FLG	                                                                                    
       ,BVD.NET_EXPLO_WGT 
		, 'N' DG_LIST_LOCAL_YN  
		, @[d_type] D_TYPE 
		, @[vvd_cd] VVD_CD
		, @[port_cd] PORT_CD  
		, '' CRE_USR_ID
		, '' UPD_USR_ID 
                                                                                                                                          
                                                                                                                                                                 
FROM                                                                                                                                                           
       (SELECT                                                                                                                                                   
               DECODE(LAG(BK.BL_NO) OVER ( ORDER BY BK.BL_NO, BV.POL_CD, BV.POD_CD, BDC.CNTR_NO) , BK.BL_NO, 0, 1) SEQ                                           
			   ,COUNT(DISTINCT bdc.cntr_no) OVER() CNTR_CNT                                                                                          
			   ,BV.BKG_NO      BKG_NO                                                                                                                
			   ,BK.BL_NO      BL_NO                                                                                                                  
               ,BV.POL_CD     POL_CD                                                                                                                             
               ,BV.POD_CD     POD_CD                                                                                                                             
               ,BV.VSL_CD     VSL_CD                                                                                                                             
               ,BV.SKD_VOY_NO SKD_VOY_NO                                                                                                                         
               ,BV.SKD_DIR_CD SKD_DIR_CD                                                                                                                         
               ,BDC.CNTR_NO   CNTR_NO                                                                                                                            
			   ,BDC.CNTR_CGO_SEQ      CNTR_CGO_SEQ	                                                                                                 
			   ,BDC.CNTR_TPSZ_CD      CNTR_TPSZ_CD                                                                                                   
	   		   ,SIUN.IMDG_COMP_GRP_CD                                                                                                                
               ,BDC.IMDG_UN_NO        IMDG_UN_NO                                                                                                                 
               ,BDC.IMDG_UN_NO_SEQ                                                                                                                               
               ,BDC.IMDG_CLSS_CD                                                                                                                                 
			   ,(SELECT ANR_SPCL_TP_ID                                                                                                               
                 FROM BKG_CSTMS_EUR_DG_SPCL                                                                                                                    
                 WHERE IMDG_UN_NO = BDC.IMDG_UN_NO) AS DG_SHORT_NM                                                                                              
               ,BDC.DG_CNTR_SEQ                                                                                                                                  
               ,BDC.FLSH_PNT_CDO_TEMP FLSH_PNT_CDO_TEMP                                                                                                          
               ,BDC.IMDG_PCK_GRP_CD   IMDG_PCK_GRP_CD                                                                                                            
               ,BDC.IN_IMDG_PCK_QTY1  IN_IMDG_PCK_QTY1                                                                                                           
               ,BDC.IN_IMDG_PCK_CD1   IN_IMDG_PCK_CD1                                                                                                            
               ,BDC.OUT_IMDG_PCK_QTY1 OUT_IMDG_PCK_QTY1                                                                                                          
               ,BDC.OUT_IMDG_PCK_CD1  OUT_IMDG_PCK_CD1                                                                                                           
               ,BDC.EMS_NO            EMS_NO                                                                                                                     
               ,BDC.NET_WGT           NET_WGT                                                                                                                    
               ,BDC.GRS_WGT           GRS_WGT                                                                                                                    
               ,BDC.PRP_SHP_NM        PRP_SHP_NM                                                                                                                 
               ,BDC.HZD_DESC          HZD_DESC                                                                                                                   
			   ,BDC.IMDG_SUBS_RSK_LBL_CD1	IMDG_SUBS_RSK_LBL_CD1                                                                                    
			   ,BDC.IMDG_SUBS_RSK_LBL_CD2	IMDG_SUBS_RSK_LBL_CD2                                                                                    
			   ,BDC.IMDG_SUBS_RSK_LBL_CD3	IMDG_SUBS_RSK_LBL_CD3                                                                                    
			   ,BDC.IMDG_SUBS_RSK_LBL_CD4	IMDG_SUBS_RSK_LBL_CD4                                                                                    
                                                                                                                                                                 
			   ,BDC.MRN_POLUT_FLG	  MRN_POLUT_FLG                                                                                                  
			   ,BDC.IMDG_LMT_QTY_FLG  IMDG_LMT_QTY_FLG                                                                                               
			                                                                                                                                         
               ,BDC.NET_EXPLO_WGT                                                                                                                               
                                                                                                                                                                 
          FROM BKG_VVD BV                                                                                                                                        
               ,BKG_DG_CGO BDC                                                                                                                                   
               ,BKG_BOOKING BK                                                                                                                                   
			   ,SCG_IMDG_UN_NO SIUN    
			WHERE 1 =1                                                                                                               
          AND BV.VSL_CD        =   SUBSTR(@[vvd_cd], 1, 4)                                                                                                      
           AND BV.SKD_VOY_NO    =   SUBSTR(@[vvd_cd], 5, 4)                                                                                                      
           AND BV.SKD_DIR_CD    =   SUBSTR(@[vvd_cd], 9, 1)                                                                                                      
           AND BV.POL_CD        IN  (SELECT VPS_PORT_CD                                                                                                          
                                        FROM VSK_VSL_PORT_SKD                                                                                                     
                                        WHERE VSL_CD      = SUBSTR(@[vvd_cd], 1, 4)                                                                                
                                        AND SKD_VOY_NO    = SUBSTR(@[vvd_cd], 5, 4)                                                                                
                                        AND SKD_DIR_CD    = SUBSTR(@[vvd_cd], 9, 1)                                                                                
                                        AND CLPT_SEQ < (     SELECT MAX(CLPT_SEQ)                                                                                
                                                               FROM VSK_VSL_PORT_SKD                                                                             
                                                               WHERE VSL_CD      = SUBSTR(@[vvd_cd], 1, 4)                                                        
                                                                AND SKD_VOY_NO   = SUBSTR(@[vvd_cd], 5, 4)                                                        
                                                                AND SKD_DIR_CD   = SUBSTR(@[vvd_cd], 9, 1)                                                        
                                                                AND VPS_PORT_CD = @[port_cd]                                                                     
                                                            )                                                                                                    
                                        AND NVL(SKD_CNG_STS_CD,'X') <> 'S'                                                                                       
                                    )                                                                                                                            
           AND BV.POD_CD        IN  (SELECT VPS_PORT_CD                                                                                                          
                                       FROM VSK_VSL_PORT_SKD                                                                                                     
                                       WHERE VSL_CD      = SUBSTR(@[vvd_cd], 1, 4)                                                                                
                                       AND SKD_VOY_NO  = SUBSTR(@[vvd_cd], 5, 4)                                                                                
                                       AND SKD_DIR_CD  = SUBSTR(@[vvd_cd], 9, 1)                                                                                
                                       AND CLPT_SEQ  > (    SELECT MIN(CLPT_SEQ)                                                                                
                                                               FROM VSK_VSL_PORT_SKD                                                                             
                                                               WHERE VSL_CD      = SUBSTR(@[vvd_cd], 1, 4)                                                        
                                                               AND SKD_VOY_NO  = SUBSTR(@[vvd_cd], 5, 4)                                                        
                                                               AND SKD_DIR_CD  = SUBSTR(@[vvd_cd], 9, 1)                                                        
                                                               AND VPS_PORT_CD = @[port_cd]                                                                     
                                                         )                                                                                                       
                                        AND  CLPT_SEQ  < (    SELECT NVL(MIN(V2.CLPT_SEQ),50)                                                                    
                                                                FROM VSK_VSL_PORT_SKD V1, VSK_VSL_PORT_SKD V2                                                    
                                                                WHERE 1=1                                                                                         
                                                                 AND  V1.VSL_CD = SUBSTR(@[vvd_cd], 1, 4)                                                        
                                                                 AND V1.SKD_VOY_NO = SUBSTR(@[vvd_cd], 5, 4)                                                     
                                                                 AND V1.SKD_DIR_CD = SUBSTR(@[vvd_cd], 9, 1)                                                     
                                                                 AND V1.VSL_CD = V2.VSL_CD                                                                       
                                                                 AND V1.SKD_VOY_NO = V2.SKD_VOY_NO                                                               
                                                                 AND V1.SKD_DIR_CD = V2.SKD_DIR_CD                                                               
                                                                 AND NVL(V1.SKD_CNG_STS_CD,'X') = 'O'                                                            
                                                                 AND NVL(V2.SKD_CNG_STS_CD,'X') = 'A'                                                            
                                                                 AND V1.CLPT_SEQ < V2.CLPT_SEQ                                                                   
                                                         )                                                                                                       
                                        AND NVL(SKD_CNG_STS_CD,'X') <> 'S'                                                                                       
                                                                                                                                                                 
                                    )                                                                                                                            
           AND BV.BKG_NO        =   BK.BKG_NO                                                                                                                    
           AND BV.BKG_NO        =   BDC.BKG_NO                                                                                                                   
                                                                                                                                                                 
		   AND BDC.IMDG_UN_NO	= 	SIUN.IMDG_UN_NO(+)                                                                                               
		   AND BDC.IMDG_UN_NO_SEQ = SIUN.IMDG_UN_NO_SEQ(+)                                                                                               
                                                                                                                                                                 
           AND BK.DCGO_FLG      =   'Y'                                                                                                                          
           AND BK.BKG_STS_CD    <>  'X'                                                                                                                                                   
        )BVD                                                                                                                                                     
                                                                                                                                                                 
                                                                                                                                                     
WHERE 1 = 1                                                                                                                                                     

#if (${bl_no} != '')                                                                                                                                             
AND   BVD.BL_NO     = @[bl_no]                                                                                                                                
#end                                                                                                                                                             
AND 'T' = @[d_type]                            

UNION ALL

SELECT 
         SUM(SUB1.SEQ) OVER (ORDER BY SUB1.BL_NO, SUB1.POL_CD, SUB1.POD_CD, SUB1.CNTR_NO) SEQ
		,SUB1.CNTR_CNT			-- TOTAL CONTAINER COUNT
        ,SUB1.BL_NO MERGE_BL_NO
        ,SUB1.BL_NO              -- BL_NO
		,SUB1.BKG_NO
        ,SUB1.POL_CD             -- POL_CD
        ,SUB1.POD_CD             -- POD_CD
        ,SUB1.CNTR_NO            -- Container No
        ,SUB1.CNTR_CGO_SEQ       -- Container Cargo Seq
        ,'' CNTR_TPSZ_CD
        ,SUB1.IMDG_CLSS_CD       -- Class
        ,SUB1.IMDG_UN_NO         -- UN No.
        ,SUB1.IMDG_UN_NO_SEQ     -- UN No SEQ.
		,SUB1.IMDG_COMP_GRP_CD
        ,NULL DG_CNTR_SEQ
        ,SUB1.ANR_SPCL_TP_ID AS DG_SHORT_NM     -- S.D/G
        ,NULL DG_SHORT_NM_CNT  
        ,SUB1.FLSH_PNT_CDO_TEMP  				-- Flash Point
        ,SUB1.ANR_ROLE_DIV_CD AS AGENT  		-- Agent
        ,'' AS FWRD_ID
        ,SUB1.ANR_CRR_TP_CD AS C_TYPE     		-- Carriage Type
        ,SUB1.FDR_SVC_RQST_NO    -- SSR(Feeder)
        ,SUB1.IMDG_PCK_GRP_CD    -- Package Group
        ,NULL IN_IMDG_PCK_QTY1                                                                                                                                     
        ,'' IN_IMDG_PCK_CD1                                                                                                                                      
        ,'' IN_PCK_DESC 
        ,SUB1.OUT_IMDG_PCK_QTY1  -- Outer Package QTY
        ,SUB1.OUT_IMDG_PCK_CD1   -- Outer Package Code
        ,''OUT_PCK_DESC 
        ,SUB1.EMS_NO             -- EMS
        ,SUB1.NET_WGT            -- Net Weight
        ,SUB1.GRS_WGT            -- Gross Weight
        ,SUB1.PCK_DESC AS PACKAGES 					-- Packages
        ,SUB1.PRP_SHP_NM         						-- Substance
        ,SUB1.HZD_DESC           						-- Hazardous Contents
        ,SUB1.ANR_FWRD_ID AS FWRD_ID 					-- Forwarder Code
        ,SUB1.FWRD_NM          							-- Forwarder Name
	    ,SUB1.DCGO_MRN_POLUT_CD	DCGO_MRN_POLUT_CD	-- Marine Pollutant
        ,SUB1.IMDG_LMT_QTY_FLG							-- Limited quantity
       	,SUB1.FDR_VSL_NM           -- Feeder Name
       	,SUB1.FDR_VSL_LLOYD_NO     -- Feeder Lloyd No
       	,SUB1.FDR_VVD_ID           -- Feeder VVD
		,TO_CHAR(SUB1.CRR_DT, 'YYYYMMDD')	CRR_DT	   -- on carriage date
		,SUB1.IMDG_SUBS_RSK_LBL_CD1-- Sub Label 1
		,SUB1.IMDG_SUBS_RSK_LBL_CD2-- Sub Label 2
		,SUB1.IMDG_SUBS_RSK_LBL_CD3-- Sub Label 3
		,SUB1.IMDG_SUBS_RSK_LBL_CD4-- Sub Label 4
   		,NVL(SUB1.MSG_FUNC_ID, '') SEND_TYPE
        ,NVL(SUB1.SCR_FILE_NO, '') SCR_FILE_NO
   		,SUB1.MSG_SND_NO MSG_SND_NO
   		,SUB1.FIRST_MSG_SND_NO
 		,COUNT(DISTINCT SUB1.BL_NO) OVER(PARTITION BY SUB1.FIRST_MSG_SND_NO ) AS GROUP_CNT
        ,SUB1.NET_EXPLO_WGT
		, 'Y' DG_LIST_LOCAL_YN
		, @[d_type] D_TYPE 
		, @[vvd_cd] VVD_CD
		, @[port_cd] PORT_CD 
		, '' CRE_USR_ID
		, '' UPD_USR_ID   
FROM 
    (
			SELECT 
        	 DECODE(LAG(A.BL_NO) OVER ( ORDER BY A.BL_NO, A.POL_CD, A.POD_CD, A.CNTR_NO ) , A.BL_NO, 0, 1) SEQ  
			,COUNT(DISTINCT A.CNTR_NO) OVER() CNTR_CNT
        	,A.BL_NO              -- BL_NO
			,C.BKG_NO
		    ,A.POL_CD             -- POL_CD
		    ,A.POD_CD             -- POD_CD
		    ,A.CNTR_NO            -- Container No
			,A.CNTR_CGO_SEQ		  -- Container Cargo Seq
            ,'' CNTR_TPSZ_CD
		    ,A.IMDG_CLSS_CD       -- Class
		    ,A.IMDG_UN_NO         -- UN No.
		    ,A.IMDG_UN_NO_SEQ     -- UN No SEQ.
            ,NULL DG_CNTR_SEQ
			,SIUN.IMDG_COMP_GRP_CD
		    ,A.ANR_SPCL_TP_ID     -- S.D/G
            ,NULL DG_SHORT_NM_CNT  
		    ,A.FLSH_PNT_CDO_TEMP  -- Flash Point
		    ,A.ANR_ROLE_DIV_CD    -- Agent
            ,'' AS FWRD_ID
		    ,A.ANR_CRR_TP_CD      -- Carriage Type
		    ,A.FDR_SVC_RQST_NO    -- SSR(Feeder)
		    ,A.IMDG_PCK_GRP_CD    -- Package Group
            ,NULL IN_IMDG_PCK_QTY1                                                                                                                                     
            ,'' IN_IMDG_PCK_CD1                                                                                                                                      
            ,'' IN_PCK_DESC 
		    ,A.OUT_IMDG_PCK_QTY1  -- Outer Package QTY
		    ,A.OUT_IMDG_PCK_CD1   -- Outer Package Code
            ,''OUT_PCK_DESC 
		    ,A.EMS_NO             -- EMS
		    ,A.NET_WGT            -- Net Weight
		    ,A.GRS_WGT            -- Gross Weight
		    ,A.PCK_DESC       -- Packages
		    ,A.PRP_SHP_NM         -- Substance
		    ,A.HZD_DESC           -- Hazardous Contents
		    ,A.ANR_FWRD_ID
		    ,'' FWRD_NM            -- Forwarder Name
	        ,A.DCGO_MRN_POLUT_CD
        	,A.IMDG_LMT_QTY_FLG

        	,A.FDR_VSL_NM           -- Feeder Name
        	,A.FDR_VSL_LLOYD_NO     -- Feeder Lloyd No
        	,A.FDR_VVD_ID           -- Feeder VVD
			,A.CRR_DT				-- on carriage date
			,A.IMDG_SUBS_RSK_LBL_CD1-- Sub Label 1
            ,A.IMDG_SUBS_RSK_LBL_CD2-- Sub Label 2
            ,A.IMDG_SUBS_RSK_LBL_CD3-- Sub Label 3
            ,A.IMDG_SUBS_RSK_LBL_CD4-- Sub Label 4
        	
            ,'' MSG_FUNC_ID

            ,'' MSG_SND_NO
  			,F_LOG.SCR_FILE_NO
            ,F_LOG.MSG_SND_NO   FIRST_MSG_SND_NO
            ,NULL GROUP_CNT

            ,A.NET_EXPLO_WGT
        	
		FROM BKG_CSTMS_DG A
			 ,SCG_IMDG_UN_NO SIUN
			 ,BKG_BOOKING C

            , (
                SELECT
                     A.DG_DECL_TP_CD
					,A.VSL_CD
                    ,A.SKD_VOY_NO
                    ,A.SKD_DIR_CD
                    ,A.PORT_CD
                    ,A.MSG_FUNC_ID
                    ,A.MSG_SND_NO
                    ,'' SCR_FILE_NO
                FROM BKG_CSTMS_DG_SND A
				WHERE 1 = 1
                     AND   A.DG_DECL_TP_CD = @[d_type]                                                                            
                AND   A.VSL_CD      = SUBSTR(@[vvd_cd], 1, 4)                                                                    
                AND   A.SKD_VOY_NO  = SUBSTR(@[vvd_cd], 5, 4)                                                                    
                AND   A.SKD_DIR_CD  = SUBSTR(@[vvd_cd], 9, 1)                                                                    
                AND   A.PORT_CD     = @[port_cd]                                                                                   
                AND   A.EDI_MSG_TP_ID ='IFD'
                AND   A.MSG_FUNC_ID = 'O'
                AND   A.SND_DT = (
                                            SELECT
                                                 MAX(A.SND_DT)
                                            FROM BKG_CSTMS_DG_SND A
                                        		WHERE A.DG_DECL_TP_CD = @[d_type]                                                    
                                        	AND   A.VSL_CD      = SUBSTR(@[vvd_cd], 1, 4)                                            
                                        	AND   A.SKD_VOY_NO  = SUBSTR(@[vvd_cd], 5, 4)                                            
                                        	AND   A.SKD_DIR_CD  = SUBSTR(@[vvd_cd], 9, 1)                                            
                                       	 	AND   A.PORT_CD     = @[port_cd]                                                         
                                            AND   A.EDI_MSG_TP_ID ='IFD'
                                            AND   A.MSG_FUNC_ID = 'O'
											GROUP BY A.EDI_MSG_TP_ID
                                      )
                
                
            ) F_LOG
	    WHERE A.VSL_CD      = SUBSTR(@[vvd_cd], 1, 4)
		AND   A.SKD_VOY_NO  = SUBSTR(@[vvd_cd], 5, 4)
		AND   A.SKD_DIR_CD  = SUBSTR(@[vvd_cd], 9, 1)
		AND   A.PORT_CD     = @[port_cd]
		
		#if (${d_type} != '') 
		AND   A.DG_DECL_TP_CD = @[d_type]
		#end

		AND   A.BL_NO 		= C.BL_NO

		AND   A.DG_DECL_TP_CD = F_LOG.DG_DECL_TP_CD(+)
        AND   A.VSL_CD      = F_LOG.VSL_CD(+)
        AND   A.SKD_VOY_NO  = F_LOG.SKD_VOY_NO(+)
        AND   A.SKD_DIR_CD  = F_LOG.SKD_DIR_CD(+)
        AND   A.PORT_CD     = F_LOG.PORT_CD(+)
		AND   A.IMDG_UN_NO	= 	SIUN.IMDG_UN_NO(+)
		AND   A.IMDG_UN_NO_SEQ = SIUN.IMDG_UN_NO_SEQ(+)
		AND	  A.CNT_CD = 'AU'
) SUB1       ) TBL1 ) TBL, BKG_DG_CGO DG
 WHERE TBL.BKG_NO = DG.BKG_NO(+)
  AND TBL.CNTR_NO = DG.CNTR_NO(+)
  AND TBL.CNTR_CGO_SEQ = DG.CNTR_CGO_SEQ(+)
  AND TBL.RN = 1 			]]></sql>
			<params>
				<param name="d_type" type="12" value="" out="N"/>
				<param name="vvd_cd" type="12" value="" out="N"/>
				<param name="port_cd" type="12" value="" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
