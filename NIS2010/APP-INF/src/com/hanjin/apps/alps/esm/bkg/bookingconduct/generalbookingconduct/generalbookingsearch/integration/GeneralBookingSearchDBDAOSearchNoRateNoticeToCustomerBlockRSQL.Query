<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="GeneralBookingSearchDBDAOSearchNoRateNoticeToCustomerBlockRSQL">
			<desc><![CDATA[Customer 에게 보내는 No Rate Notice 를 Block 하는 조건에 해당 하는 지를 조회한다
- 미주발 BKG인 경우, ETB 까지 8주 이상 남았을 때는 발송하지 않음]]></desc>
			<sql><![CDATA[
SELECT NTC_BLCK 
  FROM (
         SELECT 'Y' NTC_BLCK -- 미주 경우 ETB 까지 8주 이상 남았으면 BLOCK
           FROM (
                  SELECT VPS.VPS_ETB_DT, BK.POL_CD
                    FROM VSK_VSL_PORT_SKD VPS
                       , BKG_VVD VVD
                       , BKG_BOOKING BK
                   WHERE 1=1
                     AND VVD.BKG_NO = BK.BKG_NO
                     AND VVD.BKG_NO = @[bkg_no]
                     AND VVD.POL_CD = VPS.VPS_PORT_CD 
                     AND VVD.VSL_CD = VPS.VSL_CD 
                     AND VVD.SKD_VOY_NO = VPS.SKD_VOY_NO 
                     AND VVD.SKD_DIR_CD = VPS.SKD_DIR_CD 
                     AND VVD.POL_CLPT_IND_SEQ = VPS.CLPT_IND_SEQ
                     AND VVD.VSL_PRE_PST_CD || VVD.VSL_SEQ = (SELECT MIN(BV.VSL_PRE_PST_CD || BV.VSL_SEQ) 
                                                                FROM BKG_VVD BV
                                                               WHERE BV.BKG_NO = VVD.BKG_NO)
                     AND ROWNUM = 1
                )
          WHERE VPS_ETB_DT - SYSDATE > 56                
            AND SUBSTR(POL_CD,1,2) IN ('US','CA')
          
         UNION ALL

         SELECT 'Y' NTC_BLCK -- 미주 경우 첫배 ETB NULL 이면 BLOCK
           FROM BKG_BOOKING BK
          WHERE BK.BKG_NO = @[bkg_no]
            AND SUBSTR(POL_CD,1,2) IN ('US','CA')       
            AND (
                  SELECT VPS.VPS_ETB_DT
                    FROM VSK_VSL_PORT_SKD VPS
                       , BKG_VVD VVD
                   WHERE 1=1
                     AND VVD.BKG_NO = BK.BKG_NO
                     AND VVD.POL_CD = VPS.VPS_PORT_CD 
                     AND VVD.VSL_CD = VPS.VSL_CD 
                     AND VVD.SKD_VOY_NO = VPS.SKD_VOY_NO 
                     AND VVD.SKD_DIR_CD = VPS.SKD_DIR_CD 
                     AND VVD.POL_CLPT_IND_SEQ = VPS.CLPT_IND_SEQ
                     AND VVD.VSL_PRE_PST_CD || VVD.VSL_SEQ = (SELECT MIN(BV.VSL_PRE_PST_CD || BV.VSL_SEQ) 
                                                                FROM BKG_VVD BV
                                                               WHERE BV.BKG_NO = VVD.BKG_NO)
                     AND ROWNUM = 1
                ) IS NULL          

         UNION ALL

         SELECT 'Y' NTC_BLCK -- NoRate 아니면 BLOCK
           FROM BKG_BOOKING BK
          WHERE BK.BKG_NO = @[bkg_no]
            AND NVL(BK.NON_RT_STS_CD,'F') <> 'R'
         
         UNION ALL
         
         SELECT 'Y' NTC_BLCK -- 발송 된 적 있으면 BLOCK
           FROM BKG_DOC_PROC_SKD PROC
          WHERE PROC.BKG_NO = @[bkg_no]
            AND PROC.BKG_DOC_PROC_TP_CD = 'NORTNC'

         UNION ALL
         
         SELECT 'Y' NTC_BLCK -- 발송 된 적 있으면 BLOCK 보완 (임시)
           FROM DUAL
          WHERE ( SELECT COUNT(1)            
                    FROM BKG_NTC_HIS
                   WHERE BKG_NO = @[bkg_no]
                     AND NTC_VIA_CD = 'M'
                     AND NTC_KND_CD = 'NR' ) > 1
         
         UNION ALL
         
         SELECT 'Y' NTC_BLCK -- C/A 면 BLOCK
           FROM DUAL
          WHERE 'Y' = NVL(@[ca_flg],'N')  
       )
 WHERE ROWNUM = 1			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="ca_flg" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
