<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="Kor24ManifestListDBDAOSearchManifestCrsChkInfoKorRSQL">
			<desc><![CDATA[SearchManifestCrsChkInfoKor]]></desc>
			<sql><![CDATA[
SELECT
    A.BKG_NO BKG_NO,
    B.BKG_NO DN_BKG_NO,
	C.BKG_NO RMK_BKG_NO,
	A.BL_NO,
	A.POL_CD,
	A.POD_CD,
	A.PCK_QTY,
	A.PCK_TP_CD,
	A.ACT_WGT,
	A.WGT_UT_CD,
	A.MEAS_QTY,
	A.MEAS_UT_CD,
	A.XPT_LIC_NO,
    A.TP TP,
	B.PCK_QTY        DN_PCK_QTY,
	B.PCK_TP_CD      DN_PCK_TP_CD,
	B.CNTR_TTL_WGT   CNTR_TTL_WGT,
	B.WGT_UT_CD      DN_WGT_UT_CD,
	B.MEAS_QTY       DN_MEAS_QTY,
	B.BL_MEAS_UT_CD  BL_MEAS_UT_CD,
	B.DN_XPT_LIC_NO  DN_XPT_LIC_NO,
    C.CSTMS_RMK1,
    A.VSL_CD,
    A.SKD_VOY_NO,
    A.SKD_DIR_CD,
    DECODE(@[in_bound], 'O', DECODE( A.SC,'N',
                                        DECODE(( SELECT MDM.RVIS_CNTR_CUST_TP_CD
                                                   FROM BKG_CUSTOMER CUST, MDM_CUSTOMER MDM
                                                  WHERE CUST.CUST_CNT_CD  = MDM.CUST_CNT_CD(+)
                                                    AND CUST.CUST_SEQ       = MDM.CUST_SEQ(+)
                                                    AND CUST.BKG_CUST_TP_CD = 'S'
                                                    AND CUST.BKG_NO = A.BKG_NO ), 'N', 'C', 'B', 'S', A.SC ),
                                      A.SC ),
                      A.SC ) SC,

    A.FE,
    ( SELECT COUNT(*) FROM BKG_CONTAINER WHERE BKG_NO = A.BKG_NO ) CNTR_CNT,
	@[kt_port] PORT_CD
FROM
     (
		SELECT NVL(B.BL_NO,' ') BL_NO
			 , NVL(B.BKG_NO,' ') BKG_NO
			 , NVL(B.BKG_NO,' ') A_BKG_NO
			 , NVL(C.MF_SEQ_NO,' ') MSN
			 , '' CORRECTION
			  --, DECODE(A.POL_CD,B.POL_CD,'E','R') TP
			 , CASE WHEN @[in_bound] = 'O'
       				THEN CASE WHEN A.POL_CD = B.POL_CD THEN 'E'
       				ELSE 'R' END
      			    WHEN @[in_bound] = 'I' THEN
							CASE WHEN @[in_pod] = B.POD_CD AND B.BKG_CGO_TP_CD = 'P' THEN 'M'
								 WHEN A.POD_CD = B.POD_CD THEN 'I'
                                 ELSE 'T' END
       			ELSE ' ' END TP

			, NVL(B.BKG_CGO_TP_CD,' ') FE
			, NVL(A.POL_CD,' ') HIDDEN1
			, NVL(A.POD_CD,' ') HIDDEN2
			, NVL(B.POL_CD,' ') POL_CD

       #if( ${in_bound} == 'I')
	        , NVL(B.POD_CD,' ') POD_CD
       #else
          #if (${sel_type} !='A')
            , NVL(A.POD_CD,' ') POD_CD
          #else
		    , NVL(B.POD_CD,' ') POD_CD
          #end
       #end

			, NVL(D.PCK_QTY ,0) PCK_QTY
			, D.PCK_TP_CD PCK_TP_CD
			, TRUNC(NVL(D.ACT_WGT,0),1) ACT_WGT
			, D.WGT_UT_CD WGT_UT_CD
			, NVL(D.MEAS_QTY,0) MEAS_QTY
			, D.MEAS_UT_CD MEAS_UT_CD
		 	, A.VSL_CD
			,A.SKD_VOY_NO
			,A.SKD_DIR_CD

			, CASE WHEN @[in_bound] = 'O'
       			   THEN CASE WHEN A.POL_CD <> B.POL_CD THEN 'C'
                 			 WHEN SUBSTR(B.POD_CD,1,2) IN ('US','CA','MX','GT') AND B.BKG_CGO_TP_CD <> 'P' THEN 'A'
                 			 WHEN B.BKG_CGO_TP_CD = 'P' THEN 'M'
                 			ELSE 'B' END
       			   WHEN @[in_bound] = 'I'
       				THEN CASE WHEN @[in_pod] = B.POD_CD AND B.BKG_CGO_TP_CD = 'P' THEN 'M'
                              WHEN @[sel_type] = 'A' AND B.BKG_CGO_TP_CD <> 'P' THEN 'A'
                 			ELSE 'N' END
       		       END CREATEDTYPE
              , XPT_LIC_NO
              , ( SELECT DECODE(COUNT(*),0,'N','Y') FROM BKG_XPT_IMP_LIC BB
			       WHERE BKG_NO = A.BKG_NO
			         AND IO_BND_CD = @[in_bound]
                     AND XPT_LIC_NO IS NOT NULL
                     AND 0 = ( SELECT COUNT(*) FROM BKG_CSTMS_ADV_KR_XPT_LIC AA
                                WHERE AA.BKG_NO = BB.BKG_NO
                                  AND AA.XPT_LIC_NO = BB.XPT_LIC_NO )
                   ) LIC_FLG
               , DECODE(@[in_bound], 'O', NVL(B.KR_CSTMS_CUST_TP_CD,'N'), NVL(C.KR_CSTMS_BL_TP_CD,'N')) SC
      FROM BKG_VVD A, BKG_BOOKING B, BKG_CSTMS_KR_MF_SEQ_NO C, BKG_BL_DOC D, BKG_CSTMS_CD_CONV_CTNT F, BKG_XPT_IMP_LIC LIC
	  WHERE A.VSL_CD = SUBSTR(@[in_vvd],1,4)
		AND A.SKD_VOY_NO = SUBSTR(@[in_vvd],5,4)
		AND A.SKD_DIR_CD    = SUBSTR(@[in_vvd],9,1)

	#if (${in_bound} == 'O')
		AND A.POL_CD LIKE @[in_pol]||'%'
	#else
		AND A.POD_CD LIKE @[in_pod]||'%'
	#end

		AND DECODE(@[in_bound],'I',DECODE(LENGTH(NULL),7,A.POD_YD_CD,' '),' ')
		= DECODE(@[in_bound],'I',DECODE(LENGTH(NULL),7,NULL,' '),' ')
		AND A.BKG_NO = B.BKG_NO
		AND B.BKG_NO = D.BKG_NO
		AND B.BL_NO  > ' '
		AND B.BKG_STS_CD != 'X'
		AND B.BKG_STS_CD != 'S'
		AND B.BL_NO = NVL(@[in_blno],B.BL_NO)
		AND B.BKG_NO = C.BKG_NO(+)
        AND LIC.BKG_NO(+) = A.BKG_NO
        AND LIC.IO_BND_CD(+) = @[in_bound]
	#if(${mrn_no}!='')
		AND C.MF_REF_NO(+) = @[mrn_no]
	#end
		AND F.CNT_CD(+) = 'KR'
		AND F.CSTMS_DIV_ID(+) = 'KOR_CSTM_CMDT'
		AND B.REP_CMDT_CD = F.ATTR_CTNT1(+)

	#if( ${sel_type} == 'A'||${sel_type} == 'B'||${sel_type} == 'C')
		AND B.BKG_CGO_TP_CD !='P'
	#end

	#if( ${sel_type} == 'M')
	   	AND B.BKG_CGO_TP_CD ='P'
	#end

		ORDER BY NVL(B.BL_NO,' '), NVL(A.POL_CD,' '), NVL(A.POD_CD,' ')

	) A, --A BKG_BOOKING TABLE 에서 구하는 부분

    (
      SELECT A.BKG_NO,
			 A.BL_NO,
			 A.POL_CD,
			 A.PCK_QTY,
			 A.PCK_TP_CD      ,
			 A.CNTR_TTL_WGT   ,
			 A.WGT_UT_CD      ,
			 A.MEAS_QTY       ,
			 A.BL_MEAS_UT_CD  ,
			 A.CSTMS_BL_NO,
	         LIC.XPT_LIC_NO DN_XPT_LIC_NO,
			 A.CSTMS_DECL_TP_CD,
			 A.TRNS_SEQ A_TRNS_SEQ
        FROM BKG_CSTMS_ADV_KR_BL A, BKG_CSTMS_ADV_KR_XPT_LIC LIC
        WHERE VSL_CD = SUBSTR(@[in_vvd], 1, 4)
  		  AND SKD_VOY_NO = SUBSTR(@[in_vvd], 5, 4)
  		  AND SKD_DIR_CD = SUBSTR(@[in_vvd], 9, 1)
  		  AND ((@[in_bound] = 'O'  AND TS_POL_CD = @[in_pol])
           OR  (@[in_bound] = 'I'  AND TS_POD_CD = @[in_pod]))
          AND ((@[in_bound] = 'O'  AND NVL(PORT_TML_CD, ' ') LIKE '%')
           OR DECODE(LENGTH(@[in_pod_tmnl]), 7, PORT_TML_CD, ' ') = DECODE(LENGTH(@[in_pod_tmnl]), 7, @[in_pod_tmnl], ' '))
          AND ((@[in_bound] = 'O'  AND A.CSTMS_DECL_TP_CD IN ('E','R'))
           OR (@[in_bound] = 'I'  AND
                #if (${sel_type} == 'A')
                    A.CSTMS_DECL_TP_CD = 'I'))
				#else
					A.CSTMS_DECL_TP_CD IN ('I','T')))
				#end
        #if (${sel_type} == 'M')
          AND KR_CSTMS_BND_CD='M'
         #end

          AND A.DMST_PORT_CD = @[kt_port]
 		  AND A.CSTMS_BL_NO = NVL(@[in_blno], A.CSTMS_BL_NO)
  		  AND A.BKG_NO = NVL(@[in_bkg_no], A.BKG_NO)
  		  AND A.TRNS_SEQ = (
                          SELECT MAX(TRNS_SEQ)
    						FROM BKG_CSTMS_ADV_KR_BL BB
   						   WHERE BB.BKG_NO = A.BKG_NO
     						 AND BB.DMST_PORT_CD = A.DMST_PORT_CD
     						 AND BB.VSL_CD = A.VSL_CD
     						 AND BB.SKD_VOY_NO = A.SKD_VOY_NO
     						 AND BB.SKD_DIR_CD = A.SKD_DIR_CD
							 AND CRE_DT <= ( SELECT V.VPS_ETD_DT FROM VSK_VSL_PORT_SKD V, BKG_VVD BV
                                             WHERE 1=1
                     						 AND V.VSL_CD = BB.VSL_CD
                     						 AND V.SKD_VOY_NO = BB.SKD_VOY_NO
                     						 AND V.SKD_DIR_CD = BB.SKD_DIR_CD
                     						 AND V.VPS_PORT_CD = BB.DMST_PORT_CD
											 AND BV.BKG_NO = BB.BKG_NO
										     AND V.VSL_CD = BV.VSL_CD
                                             AND V.SKD_VOY_NO = BV.SKD_VOY_NO
                                             AND V.SKD_DIR_CD = BV.SKD_DIR_CD
                                             AND V.VPS_PORT_CD = DECODE(@[in_bound],'O',BV.POL_CD, BV.POD_CD)
                                             AND V.CLPT_IND_SEQ = DECODE(@[in_bound],'O',BV.POL_CLPT_IND_SEQ,BV.POD_CLPT_IND_SEQ)   )
                             )
  		 AND NVL(DELT_FLG, ' ') <> 'Y'
         AND LIC.BKG_NO(+) = A.BKG_NO
         AND LIC.CSTMS_DECL_TP_CD(+) = A.CSTMS_DECL_TP_CD
         AND LIC.DMST_PORT_CD(+) = A.DMST_PORT_CD
         AND LIC.TRNS_SEQ(+) = A.TRNS_SEQ
         AND LIC.CSTMS_BL_NO(+) = A.CSTMS_BL_NO
      ) B, --B D/L 에서 구하는 부분
     BKG_CSTMS_KR_RMK C --C remark 테이블

WHERE A.BKG_NO = B.BKG_NO(+)
  AND A.TP = B.CSTMS_DECL_TP_CD(+)
  AND A.BKG_NO = C.BKG_NO(+)
  AND A.CREATEDTYPE LIKE DECODE( @[sel_type],'D','%','N','%',@[sel_type] )
  AND ( NVL(A.PCK_QTY,0) <> NVL(B.PCK_QTY,1) OR NVL(A.PCK_TP_CD,' ') <> NVL(B.PCK_TP_CD,'A')
    OR  NVL(A.ACT_WGT,0) <> NVL(B.CNTR_TTL_WGT,1) --OR NVL(A.WGT_UT_CD,' ') <> NVL(B.WGT_UT_CD,'A')
--    OR  NVL(A.MEAS_QTY,0) <> NVL(B.MEAS_QTY,1) OR NVL(A.MEAS_UT_CD,' ') <> NVL(B.BL_MEAS_UT_CD,'A')
    OR  'Y' = ( SELECT MAX(CASE WHEN AA.XPT_LIC_NO IS NULL THEN 'Y'
                                ELSE 'N'
                                 END)
                  FROM BKG_XPT_IMP_LIC BB, BKG_CSTMS_ADV_KR_XPT_LIC AA
                 WHERE BB.BKG_NO = A.BKG_NO
                   AND BB.IO_BND_CD = @[in_bound]
                   AND BB.XPT_LIC_NO IS NOT NULL
                   AND AA.BKG_NO(+) = BB.BKG_NO
                   AND AA.XPT_LIC_NO(+) = BB.XPT_LIC_NO
                   AND AA.TRNS_SEQ(+) = B.A_TRNS_SEQ ))			]]></sql>
			<params>
				<param name="in_bound" type="12" value="" out="N"/>
				<param name="kt_port" type="12" value="" out="N"/>
				<param name="in_pod" type="12" value="" out="N"/>
				<param name="sel_type" type="12" value="" out="N"/>
				<param name="in_vvd" type="12" value="" out="N"/>
				<param name="in_pol" type="12" value="" out="N"/>
				<param name="in_blno" type="12" value="" out="N"/>
				<param name="mrn_no" type="12" value="" out="N"/>
				<param name="in_pod_tmnl" type="12" value="" out="N"/>
				<param name="in_bkg_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
