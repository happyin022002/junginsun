<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="SpaceAllocationManageDBDAOMultiSpcAlocCustHis42CSQL">
			<desc><![CDATA[SPC_ALOC_CUST_POL_POD 의 지정된 ibflag 값에 따라 SPC_ALOC_CUST_HIS DB에 반영한다.(입력)
[CHM-201322502-01] SPC 프로젝트 - 성수기 선복운영 개선을 위한 T/F추진
2014.02.04 [CHM-201428383-01] RFA 로직 추가
2014.05.22 [선반영] AES-SC관련 로직 추가]]></desc>
			<sql><![CDATA[
INSERT INTO SPC_ALOC_CUST_HIS (
    RLANE_CD              ,
    DIR_CD                ,
    VSL_CD                ,
    SKD_VOY_NO            ,
    SKD_DIR_CD            ,
    SLS_OFC_CD            ,
    POL_YD_CD             ,
    POD_YD_CD             ,
    TS_FLG                ,
    MNL_FLG               ,
    CUST_CNT_CD           ,
    CUST_SEQ              ,
    CTRT_NO               ,
    CUST_CTRL_CD          ,
    MODI_SEQ              ,
    REP_TRD_CD            ,
    REP_SUB_TRD_CD        ,
    TRD_CD                ,
    SUB_TRD_CD            ,
    IOC_CD                ,
    SLS_RHQ_CD            ,
    SLS_RGN_OFC_CD        ,
    ASGN_TTL_QTY          ,
    ASGN_20FT_QTY         ,
    ASGN_40FT_QTY         ,
    ASGN_40FT_HC_QTY      ,
    ASGN_45FT_HC_QTY      ,
    ASGN_53FT_QTY         ,
    ASGN_RF_QTY           ,
    ASGN_TTL_WGT          ,
    BKG_AVAL_TTL_QTY      ,
    BKG_AVAL_20FT_QTY     ,
    BKG_AVAL_40FT_QTY     ,
    BKG_AVAL_40FT_HC_QTY  ,
    BKG_AVAL_45FT_HC_QTY  ,
    BKG_AVAL_53FT_QTY     ,
    BKG_AVAL_RF_QTY       ,
    BKG_AVAL_TTL_WGT      ,
    ALOC_USR_ID           ,
    ALOC_GDT              ,
    CUST_SPC_GNTE_QTY     ,
    MODI_USR_ID           ,
    MODI_GDT              ,
    MNL_ALOC_RMK          ,
    IOC_TS_CD             ,
    FCAST_TTL_QTY         ,
    FCAST_40FT_HC_QTY     ,
    FCAST_45FT_HC_QTY     ,
    FCAST_53FT_QTY        ,
    FCAST_RF_QTY          ,
    FCAST_TTL_WGT         ,
    CTRT_FCAST_TTL_QTY    ,
    CTRT_FCAST_40FT_HC_QTY,
    CTRT_FCAST_45FT_HC_QTY,
    CTRT_FCAST_53FT_QTY   ,
    CTRT_FCAST_RF_QTY     ,
    CTRT_FCAST_TTL_WGT    ,
    USD_BKG_TTL_QTY       ,
    USD_BKG_20FT_QTY      ,
    USD_BKG_40FT_QTY      ,
    USD_BKG_40FT_HC_QTY   ,
    USD_BKG_45FT_HC_QTY   ,
    USD_BKG_53FT_QTY      ,
    USD_BKG_RF_QTY        ,
    USD_BKG_TTL_WGT       ,
    ALOC_LOD_QTY          ,
    ALOC_40FT_HC_QTY      ,
    ALOC_45FT_HC_QTY      ,
    ALOC_53FT_QTY         ,
    ALOC_RF_QTY           ,
    ALOC_TTL_WGT          ,
    -- 2014.08.17 컬럼 추가
    ALOC_20FT_DRY_QTY	  ,
    ALOC_40FT_DRY_QTY	  ,
    ALOC_RD_QTY			  ,
    CRE_USR_ID            ,
    CRE_DT                ,
    UPD_USR_ID            ,
    UPD_DT		  ,
    -- 2014.07.28 컬럼 추가
    -- CUST_CNT_CD,
    -- CUST_SEQ,
    USA_BKG_MOD_CD,
    DEST_LOC_CD,
    ASGN_20FT_DRY_QTY,
    ASGN_40FT_DRY_QTY,
    ASGN_RD_QTY,
    BKG_AVAL_20FT_DRY_QTY,
    BKG_AVAL_40FT_DRY_QTY,
    BKG_AVAL_RD_QTY,
    FCAST_20FT_DRY_QTY,
    FCAST_40FT_DRY_QTY,
    FCAST_RD_QTY,
    USD_BKG_20FT_DRY_QTY,
    USD_BKG_40FT_DRY_QTY,
    USD_BKG_RD_QTY 
)
  SELECT RLANE_CD    ,
         DIR_CD      ,
         VSL_CD      ,
         SKD_VOY_NO  ,
         SKD_DIR_CD  ,
         SLS_OFC_CD  ,
         POL_YD_CD   ,
         POD_YD_CD   ,
         TS_FLG      ,
         MNL_FLG     ,
         CUST_CNT_CD ,
         CUST_SEQ    ,
         CTRT_NO     ,
         CUST_CTRL_CD,
         (
           SELECT NVL(MAX(MODI_SEQ), 0) + 1
             FROM SPC_ALOC_CUST_HIS
            WHERE RLANE_CD     = @[rlane_cd]
              AND DIR_CD       = @[dir_cd]
              AND VSL_CD       = @[vsl_cd]
              AND SKD_VOY_NO   = @[skd_voy_no]
              AND SKD_DIR_CD   = @[skd_dir_cd]
              AND SLS_OFC_CD   = @[sls_ofc_cd]
              AND POL_YD_CD    = @[pol_cd]
              AND POD_YD_CD    = @[pod_cd]
              AND TS_FLG       = @[ts_flg]
              AND MNL_FLG      = @[mnl_flg]
              AND CUST_CTRL_CD = @[cust_ctrl_cd]
              AND IOC_CD       = DECODE(@[ioc_cd], 'OCN', 'O', 'T-OCN', 'O', 'I')
              AND USA_BKG_MOD_CD = DECODE(@[us_mod], 'OTHERS', 'OTH',  @[us_mod])
              AND DEST_LOC_CD  = DECODE(NVL(@[del_cd], 'XXXXX'), '1', 'XXXXX', 'OTHERS', 'XXXXX', NVL(@[del_cd], '00000'))
              AND CUST_CNT_CD  = DECODE(@[account_cd], 'OTHERS', 'XX', SUBSTR(@[account_cd], 1, 2))
              AND CUST_SEQ     = DECODE(@[account_cd], 'OTHERS', '999999', SUBSTR(@[account_cd], 3, 6))
         ) HIS_SEQ             ,
         REP_TRD_CD            ,
         REP_SUB_TRD_CD        ,
         TRD_CD                ,
         SUB_TRD_CD            ,
         IOC_CD                ,
         SLS_RHQ_CD            ,
         SLS_RGN_OFC_CD        ,
         ASGN_TTL_QTY          ,
         ASGN_20FT_QTY         ,
         ASGN_40FT_QTY         ,
         ASGN_40FT_HC_QTY      ,
         ASGN_45FT_HC_QTY      ,
         ASGN_53FT_QTY         ,
         ASGN_RF_QTY           ,
         ASGN_TTL_WGT          ,
         BKG_AVAL_TTL_QTY      ,
         BKG_AVAL_20FT_QTY     ,
         BKG_AVAL_40FT_QTY     ,
         BKG_AVAL_40FT_HC_QTY  ,
         BKG_AVAL_45FT_HC_QTY  ,
         BKG_AVAL_53FT_QTY     ,
         BKG_AVAL_RF_QTY       ,
         BKG_AVAL_TTL_WGT      ,
         ALOC_USR_ID           ,
         ALOC_GDT              ,
         0                     ,
         UPD_USR_ID            ,
         ALOC_GDT              ,
         MNL_ALOC_RMK          ,
         DECODE(TS_FLG, 'Y', 'T', IOC_CD),
         FCAST_TTL_QTY         ,
         FCAST_40FT_HC_QTY     ,
         FCAST_45FT_HC_QTY     ,
         FCAST_53FT_QTY        ,
         FCAST_RF_QTY          ,
         FCAST_TTL_WGT         ,
         CTRT_FCAST_TTL_QTY    ,
         CTRT_FCAST_40FT_HC_QTY,
         CTRT_FCAST_45FT_HC_QTY,
         CTRT_FCAST_53FT_QTY   ,
         CTRT_FCAST_RF_QTY     ,
         CTRT_FCAST_TTL_WGT    ,
         USD_BKG_TTL_QTY       ,
         USD_BKG_20FT_QTY      ,
         USD_BKG_40FT_QTY      ,
         USD_BKG_40FT_HC_QTY   ,
         USD_BKG_45FT_HC_QTY   ,
         USD_BKG_53FT_QTY      ,
         USD_BKG_RF_QTY        ,
         USD_BKG_TTL_WGT       ,
         DECODE(MNL_ALOC_RMK, '3', ASGN_TTL_QTY    , BKG_AVAL_TTL_QTY)    ,
         DECODE(MNL_ALOC_RMK, '3', ASGN_40FT_HC_QTY, BKG_AVAL_40FT_HC_QTY),
         DECODE(MNL_ALOC_RMK, '3', ASGN_45FT_HC_QTY, BKG_AVAL_45FT_HC_QTY),
         DECODE(MNL_ALOC_RMK, '3', ASGN_53FT_QTY   , BKG_AVAL_53FT_QTY)   ,
         DECODE(MNL_ALOC_RMK, '3', ASGN_RF_QTY     , BKG_AVAL_RF_QTY)     ,
         DECODE(MNL_ALOC_RMK, '3', ASGN_TTL_WGT    , BKG_AVAL_TTL_WGT)    ,
		 -- 2014.08.17 컬럼 추가
	     DECODE(MNL_ALOC_RMK, '3', ASGN_20FT_DRY_QTY, BKG_AVAL_20FT_DRY_QTY),
         DECODE(MNL_ALOC_RMK, '3', ASGN_40FT_DRY_QTY, BKG_AVAL_40FT_DRY_QTY),
         DECODE(MNL_ALOC_RMK, '3', ASGN_RD_QTY      , BKG_AVAL_RD_QTY)      ,
         CRE_USR_ID,
         CRE_DT    ,
         UPD_USR_ID,
         UPD_DT    ,
         -- 2014.07.28 컬럼 추가
    	 -- CUST_CNT_CD,
    	 -- CUST_SEQ,
         USA_BKG_MOD_CD,
         DEST_LOC_CD,
         ASGN_20FT_DRY_QTY,
         ASGN_40FT_DRY_QTY,
         ASGN_RD_QTY,
         BKG_AVAL_20FT_DRY_QTY,
         BKG_AVAL_40FT_DRY_QTY,
         BKG_AVAL_RD_QTY,
         FCAST_20FT_DRY_QTY,
         FCAST_40FT_DRY_QTY,
         FCAST_RD_QTY,
         USD_BKG_20FT_DRY_QTY,
         USD_BKG_40FT_DRY_QTY,
         USD_BKG_RD_QTY 
    FROM SPC_ALOC_CUST_POL_POD,
         (
           SELECT SUM(NVL(FCAST_TTL_QTY    , 0) + NVL(FCAST_40FT_HC_QTY, 0) * 2) AS CTRT_FCAST_TTL_QTY,
                  SUM(NVL(FCAST_40FT_HC_QTY, 0)) AS CTRT_FCAST_40FT_HC_QTY,
                  SUM(NVL(FCAST_45FT_HC_QTY, 0)) AS CTRT_FCAST_45FT_HC_QTY,
                  SUM(NVL(FCAST_53FT_QTY   , 0)) AS CTRT_FCAST_53FT_QTY   ,
                  SUM(NVL(FCAST_RF_QTY     , 0)) AS CTRT_FCAST_RF_QTY     ,
                  SUM(NVL(FCAST_TTL_WGT    , 0)) AS CTRT_FCAST_TTL_WGT
             FROM SPC_CTRT_FCAST_CUST A,
                  ( SELECT CUST_CNT_CD ,
                           CUST_SEQ    ,
                           CUST_CTRL_CD,
                           SC_NO       ,
                           RFA_NO
                      FROM SPC_MDL_CUST_CTRL
                     WHERE DELT_FLG = 'N'
                       AND (TRD_CD, COST_YRWK, VER_SEQ) IN ( SELECT /*+ INDEX_DESC (V XPKSPC_MDL_VER_MST) */
                                                                    TRD_CD, COST_YRWK, VER_SEQ
                                                               FROM SPC_MDL_VER_MST V
                                                              WHERE (  SELECT SUBSTR(SLS_YRMON, 1, 4)||COST_WK
                                                                         FROM MAS_MON_VVD
                                                                        WHERE DELT_FLG   = 'N'
                                                                          AND TRD_CD     = @[trd_cd]
                                                                          AND RLANE_CD   = @[rlane_cd]
                                                                          AND VSL_CD     = @[vsl_cd]
                                                                          AND SKD_VOY_NO = @[skd_voy_no]
                                                                          AND DIR_CD     = @[dir_cd]      ) BETWEEN VER_ST_YRWK AND VER_END_YRWK
                                                                AND TRD_CD  = @[trd_cd]
                                                                AND CFM_FLG = 'Y' 
                                                                AND ROWNUM  = 1 ) ) B
            WHERE A.TRD_CD          = @[trd_cd]
              AND A.RLANE_CD        = @[rlane_cd]
              AND A.IOC_TS_CD       = DECODE(@[ts_flg], 'Y', 'T', DECODE(@[ioc_cd], 'OCN', 'O', 'T-OCN', 'O', 'I'))
              AND A.VSL_CD          = @[vsl_cd]
              AND A.SKD_VOY_NO      = @[skd_voy_no]
              AND A.SKD_DIR_CD      = @[skd_dir_cd]
              AND A.SLS_RGN_OFC_CD  = @[sls_ofc_cd]
              AND A.POL_YD_CD       = @[pol_cd]
              AND A.POD_YD_CD       = @[pod_cd]
              AND A.CUST_CNT_CD     = B.CUST_CNT_CD
              AND A.CUST_SEQ        = B.CUST_SEQ
              AND NVL(A.SC_NO, NVL(A.RFA_NO, 'X')) = NVL(B.SC_NO, NVL(B.RFA_NO, 'X'))
              AND B.CUST_CTRL_CD    = @[cust_ctrl_cd]
         )
   WHERE RLANE_CD     = @[rlane_cd]
     AND DIR_CD       = @[dir_cd]
     AND VSL_CD       = @[vsl_cd]
     AND SKD_VOY_NO   = @[skd_voy_no]
     AND SKD_DIR_CD   = @[skd_dir_cd]
     AND SLS_OFC_CD   = @[sls_ofc_cd]
     AND POL_YD_CD    = @[pol_cd]
     AND POD_YD_CD    = @[pod_cd]
     AND TS_FLG       = @[ts_flg]
     AND MNL_FLG      = @[mnl_flg]
     AND CUST_CTRL_CD = @[cust_ctrl_cd]
     AND IOC_CD       = DECODE(@[ioc_cd], 'OCN', 'O', 'T-OCN', 'O', 'I')
     AND USA_BKG_MOD_CD = DECODE(@[us_mod], 'OTHERS', 'OTH',  @[us_mod])
     AND DEST_LOC_CD  = DECODE(NVL(@[del_cd], 'XXXXX'), '1', 'XXXXX', 'OTHERS', 'XXXXX', NVL(@[del_cd], '00000'))
     AND CUST_CNT_CD  = DECODE(@[account_cd], 'OTHERS', 'XX', SUBSTR(@[account_cd], 1, 2))
     AND CUST_SEQ     = DECODE(@[account_cd], 'OTHERS', '999999', SUBSTR(@[account_cd], 3, 6))
     AND CTRT_NO      = @[ctrt_no]			]]></sql>
			<params>
				<param name="rlane_cd" type="12" value="" out="N"/>
				<param name="dir_cd" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="sls_ofc_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="ts_flg" type="12" value="" out="N"/>
				<param name="mnl_flg" type="12" value="" out="N"/>
				<param name="cust_ctrl_cd" type="12" value="" out="N"/>
				<param name="ioc_cd" type="12" value="" out="N"/>
				<param name="us_mod" type="12" value="" out="N"/>
				<param name="del_cd" type="12" value="" out="N"/>
				<param name="account_cd" type="12" value="" out="N"/>
				<param name="trd_cd" type="12" value="" out="N"/>
				<param name="ctrt_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
