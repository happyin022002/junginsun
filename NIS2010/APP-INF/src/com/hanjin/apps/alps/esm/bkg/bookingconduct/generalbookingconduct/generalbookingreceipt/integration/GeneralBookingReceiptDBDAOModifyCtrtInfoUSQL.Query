<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="GeneralBookingReceiptDBDAOModifyCtrtInfoUSQL">
			<desc><![CDATA[계약관련 추가 정보를 update한다.

[CHM-201432116] SPOT GUIDE RFA 일 땐 OB_SREP_CD, OB_OFC_CD 를 CTRT 로 함
[CHM-201641186] Split01-[Master/Basic RFA] 관련 BKG 연계로직 개발 및 오토레이팅 개발 요청                           ]]></desc>
			<sql><![CDATA[
#if (${ca_flg}== 'Y')
UPDATE BKG_BKG_HIS BK
#else
UPDATE BKG_BOOKING BK 
#end
   SET CTRT_OFC_CD = NVL((case 
            when SUBSTR(NVL(BK.RFA_NO, 'DUM'), 6, 1) IN ('G','M') then -- SPOT GUIDE RFA, MASTER
                 BK.OB_SLS_OFC_CD
            when SUBSTR(NVL(BK.RFA_NO, 'DUM'), 1, 3) <> 'DUM' then 
				(select distinct main.RESPB_SLS_OFC_CD			
                   from pri_rp_mn main
                        , pri_rp_hdr hdr
                    	, (SELECT 
                    		   (select RT_APLY_DT --rate applicable
                    #if (${ca_flg}== 'Y')
                    			  from BKG_RT_HIS rt
                    		     where bkg_no = @[bkg_no]
                    			   AND CORR_NO = 'TMP0000001'
                    #else
                    		      from bkg_rate r
                    		     where bkg_no = @[bkg_no]
                    #end
                    		       and rt_aply_dt is not null) rt_appl_dt,
                    		   (select skd.vps_etd_dt --etd date
                    #if (${ca_flg}== 'Y')
                    		      from bkg_vvd_his vvd, vsk_vsl_port_skd skd, bkg_bkg_his bk
                    		     where bk.bkg_no          = @[bkg_no]  
                    			   and bk.corr_no 		  = 'TMP0000001'
                    			   and vvd.corr_no 		  = 'TMP0000001'
                    #else
                    		      from bkg_vvd vvd, vsk_vsl_port_skd skd, bkg_booking bk
                    		     where bk.bkg_no          = @[bkg_no]  
                    #end 
                    		       and bk.bkg_no          = vvd.bkg_no
                    		       and vvd.vsl_pre_pst_cd in ('S', 'T')
                    		       and vvd.pol_cd         = bk.pol_cd
                    		       and vvd.vsl_cd         = skd.vsl_cd
                    		       and vvd.skd_voy_no     = skd.skd_voy_no
                    		       and vvd.skd_dir_cd     = skd.skd_dir_cd
                    		       and vvd.pol_cd         = skd.vps_port_cd
                    		       and vvd.pol_CLPT_IND_SEQ = skd.CLPT_IND_SEQ
								   and rownum = 1) etd_dt
                    	  from dual) APPL_DT
                  where hdr.prop_no         = main.prop_no
                    and hdr.rfa_no          = BK.RFA_NO
					and MAIN.eff_dt - 0.0001 < nvl(NVL(APPL_DT.RT_APPL_DT, APPL_DT.ETD_DT), bk.bkg_cre_dt)
					AND MAIN.exp_dt + 0.9999 > nvl(NVL(APPL_DT.RT_APPL_DT, APPL_DT.ETD_DT), bk.bkg_cre_dt)
					AND ((main.amdt_seq = 0 and main.prop_sts_cd = 'A') or (main.amdt_seq > 0))
                   and rownum = 1)
			when SUBSTR(NVL(BK.TAA_NO, 'DUM'), 1, 3) <> 'DUM' then
				(select distinct RESPB_SLS_OFC_CD
                   from pri_taa_mn main
                        , pri_taa_hdr hdr
                    	, (SELECT 
                    		   (select RT_APLY_DT --rate applicable
                    #if (${ca_flg}== 'Y')
                    			  from BKG_RT_HIS rt
                    		     where bkg_no = @[bkg_no]
                    			   AND CORR_NO = 'TMP0000001'
                    #else
                    		      from bkg_rate r
                    		     where bkg_no = @[bkg_no]
                    #end
                    		       and rt_aply_dt is not null) rt_appl_dt,
                    		   (select skd.vps_etd_dt --etd date
                    #if (${ca_flg}== 'Y')
                    		      from bkg_vvd_his vvd, vsk_vsl_port_skd skd, bkg_bkg_his bk
                    		     where bk.bkg_no          = @[bkg_no]  
                    			   and bk.corr_no 		  = 'TMP0000001'
                    			   and vvd.corr_no 		  = 'TMP0000001'
                    #else
                    		      from bkg_vvd vvd, vsk_vsl_port_skd skd, bkg_booking bk
                    		     where bk.bkg_no          = @[bkg_no]  
                    #end 
                    		       and bk.bkg_no          = vvd.bkg_no
                    		       and vvd.vsl_pre_pst_cd in ('S', 'T')
                    		       and vvd.pol_cd         = bk.pol_cd
                    		       and vvd.vsl_cd         = skd.vsl_cd
                    		       and vvd.skd_voy_no     = skd.skd_voy_no
                    		       and vvd.skd_dir_cd     = skd.skd_dir_cd
                    		       and vvd.pol_cd         = skd.vps_port_cd
                    		       and vvd.pol_CLPT_IND_SEQ = skd.CLPT_IND_SEQ
								   and rownum = 1) etd_dt
                    	  from dual) APPL_DT
				  WHERE HDR.TAA_PROP_NO      = MAIN.TAA_PROP_NO
                    and hdr.TAA_NO           = BK.TAA_NO
					and MAIN.eff_dt - 0.0001 < nvl(NVL(APPL_DT.RT_APPL_DT, APPL_DT.ETD_DT), bk.bkg_cre_dt)
					AND MAIN.exp_dt + 0.9999 > nvl(NVL(APPL_DT.RT_APPL_DT, APPL_DT.ETD_DT), bk.bkg_cre_dt)
			 	    and main.cfm_flg         = 'Y'
                    and rownum = 1)
			when SUBSTR(NVL(BK.SC_NO,  'DUM'), 1, 3) <> 'DUM' then 
				(select distinct nvl(main.REAL_CUST_SLS_OFC_CD,main.RESPB_SLS_OFC_CD)
				   FROM PRI_SP_HDR HDR
						, PRI_SP_MN MAIN
                    	, (SELECT 
                    		   (select RT_APLY_DT --rate applicable
                    #if (${ca_flg}== 'Y')
                    			  from BKG_RT_HIS rt
                    		     where bkg_no = @[bkg_no]
                    			   AND CORR_NO = 'TMP0000001'
                    #else
                    		      from bkg_rate r
                    		     where bkg_no = @[bkg_no]
                    #end
                    		       and rt_aply_dt is not null) rt_appl_dt,
                    		   (select skd.vps_etd_dt --etd date
                    #if (${ca_flg}== 'Y')
                    		      from bkg_vvd_his vvd, vsk_vsl_port_skd skd, bkg_bkg_his bk
                    		     where bk.bkg_no          = @[bkg_no]  
                    			   and bk.corr_no 		  = 'TMP0000001'
                    			   and vvd.corr_no 		  = 'TMP0000001'
                    #else
                    		      from bkg_vvd vvd, vsk_vsl_port_skd skd, bkg_booking bk
                    		     where bk.bkg_no          = @[bkg_no]  
                    #end 
                    		       and bk.bkg_no          = vvd.bkg_no
                    		       and vvd.vsl_pre_pst_cd in ('S', 'T')
                    		       and vvd.pol_cd         = bk.pol_cd
                    		       and vvd.vsl_cd         = skd.vsl_cd
                    		       and vvd.skd_voy_no     = skd.skd_voy_no
                    		       and vvd.skd_dir_cd     = skd.skd_dir_cd
                    		       and vvd.pol_cd         = skd.vps_port_cd
                    		       and vvd.pol_CLPT_IND_SEQ = skd.CLPT_IND_SEQ
								   and rownum = 1) etd_dt
                    	  from dual) APPL_DT
				  WHERE HDR.PROP_NO = MAIN.PROP_NO
                    and hdr.sc_no        = BK.SC_NO
					and MAIN.eff_dt - 0.0001 < nvl(NVL(APPL_DT.RT_APPL_DT, APPL_DT.ETD_DT), bk.bkg_cre_dt)
					AND MAIN.exp_dt + 0.9999 > nvl(NVL(APPL_DT.RT_APPL_DT, APPL_DT.ETD_DT), bk.bkg_cre_dt)
					and main.prop_sts_cd = 'F'
					and rownum = 1)
            else (SELECT OFC_CD FROM MDM_SLS_REP WHERE SREP_CD = BK.OB_SREP_CD) end), (SELECT OFC_CD FROM MDM_SLS_REP WHERE SREP_CD = BK.OB_SREP_CD))
,	CTRT_SREP_CD = NVL((case 
            when SUBSTR(NVL(BK.RFA_NO, 'DUM'), 6, 1) IN ('G','M') then -- SPOT GUIDE RFA, MASTER
                 BK.OB_SREP_CD
            when SUBSTR(NVL(BK.RFA_NO, 'DUM'), 1, 3) <> 'DUM' then 
				(select distinct main.RESPB_SREP_CD
                   from pri_rp_mn main
                        , pri_rp_hdr hdr
                    	, (SELECT 
                    		   (select RT_APLY_DT --rate applicable
                    #if (${ca_flg}== 'Y')
                    			  from BKG_RT_HIS rt
                    		     where bkg_no = @[bkg_no]
                    			   AND CORR_NO = 'TMP0000001'
                    #else
                    		      from bkg_rate r
                    		     where bkg_no = @[bkg_no]
                    #end
                    		       and rt_aply_dt is not null) rt_appl_dt,
                    		   (select skd.vps_etd_dt --etd date
                    #if (${ca_flg}== 'Y')
                    		      from bkg_vvd_his vvd, vsk_vsl_port_skd skd, bkg_bkg_his bk
                    		     where bk.bkg_no          = @[bkg_no]  
                    			   and bk.corr_no 		  = 'TMP0000001'
                    			   and vvd.corr_no 		  = 'TMP0000001'
                    #else
                    		      from bkg_vvd vvd, vsk_vsl_port_skd skd, bkg_booking bk
                    		     where bk.bkg_no          = @[bkg_no]  
                    #end 
                    		       and bk.bkg_no          = vvd.bkg_no
                    		       and vvd.vsl_pre_pst_cd in ('S', 'T')
                    		       and vvd.pol_cd         = bk.pol_cd
                    		       and vvd.vsl_cd         = skd.vsl_cd
                    		       and vvd.skd_voy_no     = skd.skd_voy_no
                    		       and vvd.skd_dir_cd     = skd.skd_dir_cd
                    		       and vvd.pol_cd         = skd.vps_port_cd
                    		       and vvd.pol_CLPT_IND_SEQ = skd.CLPT_IND_SEQ
								   and rownum = 1) etd_dt
                    	  from dual) APPL_DT
                  where hdr.prop_no         = main.prop_no
                    and hdr.rfa_no          = BK.RFA_NO
					and MAIN.eff_dt - 0.0001 < nvl(NVL(APPL_DT.RT_APPL_DT, APPL_DT.ETD_DT), bk.bkg_cre_dt)
					AND MAIN.exp_dt + 0.9999 > nvl(NVL(APPL_DT.RT_APPL_DT, APPL_DT.ETD_DT), bk.bkg_cre_dt)
					AND ((main.amdt_seq = 0 and main.prop_sts_cd = 'A') or (main.amdt_seq > 0))
                   and rownum = 1)
			when SUBSTR(NVL(BK.TAA_NO, 'DUM'), 1, 3) <> 'DUM' then 
				(select distinct RESPB_SREP_CD
                   from pri_taa_mn main
                        , pri_taa_hdr hdr
                    	, (SELECT 
                    		   (select RT_APLY_DT --rate applicable
                    #if (${ca_flg}== 'Y')
                    			  from BKG_RT_HIS rt
                    		     where bkg_no = @[bkg_no]
                    			   AND CORR_NO = 'TMP0000001'
                    #else
                    		      from bkg_rate r
                    		     where bkg_no = @[bkg_no]
                    #end
                    		       and rt_aply_dt is not null) rt_appl_dt,
                    		   (select skd.vps_etd_dt --etd date
                    #if (${ca_flg}== 'Y')
                    		      from bkg_vvd_his vvd, vsk_vsl_port_skd skd, bkg_bkg_his bk
                    		     where bk.bkg_no          = @[bkg_no]  
                    			   and bk.corr_no 		  = 'TMP0000001'
                    			   and vvd.corr_no 		  = 'TMP0000001'
                    #else
                    		      from bkg_vvd vvd, vsk_vsl_port_skd skd, bkg_booking bk
                    		     where bk.bkg_no          = @[bkg_no]  
                    #end 
                    		       and bk.bkg_no          = vvd.bkg_no
                    		       and vvd.vsl_pre_pst_cd in ('S', 'T')
                    		       and vvd.pol_cd         = bk.pol_cd
                    		       and vvd.vsl_cd         = skd.vsl_cd
                    		       and vvd.skd_voy_no     = skd.skd_voy_no
                    		       and vvd.skd_dir_cd     = skd.skd_dir_cd
                    		       and vvd.pol_cd         = skd.vps_port_cd
                    		       and vvd.pol_CLPT_IND_SEQ = skd.CLPT_IND_SEQ
								   and rownum = 1) etd_dt
                    	  from dual) APPL_DT
				  WHERE HDR.TAA_PROP_NO      = MAIN.TAA_PROP_NO
                    and hdr.TAA_NO           = BK.TAA_NO
					and MAIN.eff_dt - 0.0001 < nvl(NVL(APPL_DT.RT_APPL_DT, APPL_DT.ETD_DT), bk.bkg_cre_dt)
					AND MAIN.exp_dt + 0.9999 > nvl(NVL(APPL_DT.RT_APPL_DT, APPL_DT.ETD_DT), bk.bkg_cre_dt)
			 	    and main.cfm_flg         = 'Y'
                    and rownum = 1)
			when SUBSTR(NVL(BK.SC_NO,  'DUM'), 1, 3) <> 'DUM' then 
				(select distinct nvl(main.REAL_CUST_SREP_CD ,main.RESPB_SREP_CD)
				   FROM PRI_SP_HDR HDR
						, PRI_SP_MN MAIN
                    	, (SELECT 
                    		   (select RT_APLY_DT --rate applicable
                    #if (${ca_flg}== 'Y')
                    			  from BKG_RT_HIS rt
                    		     where bkg_no = @[bkg_no]
                    			   AND CORR_NO = 'TMP0000001'
                    #else
                    		      from bkg_rate r
                    		     where bkg_no = @[bkg_no]
                    #end
                    		       and rt_aply_dt is not null) rt_appl_dt,
                    		   (select skd.vps_etd_dt --etd date
                    #if (${ca_flg}== 'Y')
                    		      from bkg_vvd_his vvd, vsk_vsl_port_skd skd, bkg_bkg_his bk
                    		     where bk.bkg_no          = @[bkg_no]  
                    			   and bk.corr_no 		  = 'TMP0000001'
                    			   and vvd.corr_no 		  = 'TMP0000001'
                    #else
                    		      from bkg_vvd vvd, vsk_vsl_port_skd skd, bkg_booking bk
                    		     where bk.bkg_no          = @[bkg_no]  
                    #end 
                    		       and bk.bkg_no          = vvd.bkg_no
                    		       and vvd.vsl_pre_pst_cd in ('S', 'T')
                    		       and vvd.pol_cd         = bk.pol_cd
                    		       and vvd.vsl_cd         = skd.vsl_cd
                    		       and vvd.skd_voy_no     = skd.skd_voy_no
                    		       and vvd.skd_dir_cd     = skd.skd_dir_cd
                    		       and vvd.pol_cd         = skd.vps_port_cd
                    		       and vvd.pol_CLPT_IND_SEQ = skd.CLPT_IND_SEQ
								   and rownum = 1) etd_dt
                    	  from dual) APPL_DT
				  WHERE HDR.PROP_NO          = MAIN.PROP_NO
                    and hdr.sc_no            = BK.SC_NO
					and MAIN.eff_dt - 0.0001 < nvl(NVL(APPL_DT.RT_APPL_DT, APPL_DT.ETD_DT), bk.bkg_cre_dt)
					AND MAIN.exp_dt + 0.9999 > nvl(NVL(APPL_DT.RT_APPL_DT, APPL_DT.ETD_DT), bk.bkg_cre_dt)
					and main.prop_sts_cd = 'F'
					and rownum = 1)
            else BK.OB_SREP_CD end), BK.OB_SREP_CD)
,   CTRT_CUST_CNT_CD = NVL((case 
			when SUBSTR(NVL(BK.RFA_NO, 'DUM'), 1, 3) <> 'DUM' then 
            				(select distinct main.CTRT_CUST_CNT_CD			
                               from pri_rp_mn main
                                    , pri_rp_hdr hdr
                    	, (SELECT 
                    		   (select RT_APLY_DT --rate applicable
                    #if (${ca_flg}== 'Y')
                    			  from BKG_RT_HIS rt
                    		     where bkg_no = @[bkg_no]
                    			   AND CORR_NO = 'TMP0000001'
                    #else
                    		      from bkg_rate r
                    		     where bkg_no = @[bkg_no]
                    #end
                    		       and rt_aply_dt is not null) rt_appl_dt,
                    		   (select skd.vps_etd_dt --etd date
                    #if (${ca_flg}== 'Y')
                    		      from bkg_vvd_his vvd, vsk_vsl_port_skd skd, bkg_bkg_his bk
                    		     where bk.bkg_no          = @[bkg_no]  
                    			   and bk.corr_no 		  = 'TMP0000001'
                    			   and vvd.corr_no 		  = 'TMP0000001'
                    #else
                    		      from bkg_vvd vvd, vsk_vsl_port_skd skd, bkg_booking bk
                    		     where bk.bkg_no          = @[bkg_no]  
                    #end 
                    		       and bk.bkg_no          = vvd.bkg_no
                    		       and vvd.vsl_pre_pst_cd in ('S', 'T')
                    		       and vvd.pol_cd         = bk.pol_cd
                    		       and vvd.vsl_cd         = skd.vsl_cd
                    		       and vvd.skd_voy_no     = skd.skd_voy_no
                    		       and vvd.skd_dir_cd     = skd.skd_dir_cd
                    		       and vvd.pol_cd         = skd.vps_port_cd
                    		       and vvd.pol_CLPT_IND_SEQ = skd.CLPT_IND_SEQ
								   and rownum = 1) etd_dt
                    	  from dual) APPL_DT
                              where hdr.prop_no         = main.prop_no
                                and hdr.rfa_no          = BK.RFA_NO
								and MAIN.eff_dt - 0.0001 < nvl(NVL(APPL_DT.RT_APPL_DT, APPL_DT.ETD_DT), bk.bkg_cre_dt)
								AND MAIN.exp_dt + 0.9999 > nvl(NVL(APPL_DT.RT_APPL_DT, APPL_DT.ETD_DT), bk.bkg_cre_dt)
            					AND ((main.amdt_seq = 0 and main.prop_sts_cd = 'A') or (main.amdt_seq > 0))
                               and rownum = 1)
            			when SUBSTR(NVL(BK.TAA_NO, 'DUM'), 1, 3) <> 'DUM' then
            				(select distinct CTRT_CUST_CNT_CD
                               from pri_taa_mn main
                                    , pri_taa_hdr hdr
                    	, (SELECT 
                    		   (select RT_APLY_DT --rate applicable
                    #if (${ca_flg}== 'Y')
                    			  from BKG_RT_HIS rt
                    		     where bkg_no = @[bkg_no]
                    			   AND CORR_NO = 'TMP0000001'
                    #else
                    		      from bkg_rate r
                    		     where bkg_no = @[bkg_no]
                    #end
                    		       and rt_aply_dt is not null) rt_appl_dt,
                    		   (select skd.vps_etd_dt --etd date
                    #if (${ca_flg}== 'Y')
                    		      from bkg_vvd_his vvd, vsk_vsl_port_skd skd, bkg_bkg_his bk
                    		     where bk.bkg_no          = @[bkg_no]  
                    			   and bk.corr_no 		  = 'TMP0000001'
                    			   and vvd.corr_no 		  = 'TMP0000001'
                    #else
                    		      from bkg_vvd vvd, vsk_vsl_port_skd skd, bkg_booking bk
                    		     where bk.bkg_no          = @[bkg_no]  
                    #end 
                    		       and bk.bkg_no          = vvd.bkg_no
                    		       and vvd.vsl_pre_pst_cd in ('S', 'T')
                    		       and vvd.pol_cd         = bk.pol_cd
                    		       and vvd.vsl_cd         = skd.vsl_cd
                    		       and vvd.skd_voy_no     = skd.skd_voy_no
                    		       and vvd.skd_dir_cd     = skd.skd_dir_cd
                    		       and vvd.pol_cd         = skd.vps_port_cd
                    		       and vvd.pol_CLPT_IND_SEQ = skd.CLPT_IND_SEQ
								   and rownum = 1) etd_dt
                    	  from dual) APPL_DT
            				  WHERE HDR.TAA_PROP_NO      = MAIN.TAA_PROP_NO
                                and hdr.TAA_NO           = BK.TAA_NO
								and MAIN.eff_dt - 0.0001 < nvl(NVL(APPL_DT.RT_APPL_DT, APPL_DT.ETD_DT), bk.bkg_cre_dt)
								AND MAIN.exp_dt + 0.9999 > nvl(NVL(APPL_DT.RT_APPL_DT, APPL_DT.ETD_DT), bk.bkg_cre_dt)
            			 	    and main.cfm_flg         = 'Y'
                                and rownum = 1)
            			when SUBSTR(NVL(BK.SC_NO,  'DUM'), 1, 3) <> 'DUM' then 
            				(select distinct nvl(main.REAL_CUST_CNT_CD, cust.CUST_CNT_CD)
            				   FROM PRI_SP_HDR HDR
            						, PRI_SP_MN MAIN
            						, PRI_SP_CTRT_PTY cust
                    	, (SELECT 
                    		   (select RT_APLY_DT --rate applicable
                    #if (${ca_flg}== 'Y')
                    			  from BKG_RT_HIS rt
                    		     where bkg_no = @[bkg_no]
                    			   AND CORR_NO = 'TMP0000001'
                    #else
                    		      from bkg_rate r
                    		     where bkg_no = @[bkg_no]
                    #end
                    		       and rt_aply_dt is not null) rt_appl_dt,
                    		   (select skd.vps_etd_dt --etd date
                    #if (${ca_flg}== 'Y')
                    		      from bkg_vvd_his vvd, vsk_vsl_port_skd skd, bkg_bkg_his bk
                    		     where bk.bkg_no          = @[bkg_no]  
                    			   and bk.corr_no 		  = 'TMP0000001'
                    			   and vvd.corr_no 		  = 'TMP0000001'
                    #else
                    		      from bkg_vvd vvd, vsk_vsl_port_skd skd, bkg_booking bk
                    		     where bk.bkg_no          = @[bkg_no]  
                    #end 
                    		       and bk.bkg_no          = vvd.bkg_no
                    		       and vvd.vsl_pre_pst_cd in ('S', 'T')
                    		       and vvd.pol_cd         = bk.pol_cd
                    		       and vvd.vsl_cd         = skd.vsl_cd
                    		       and vvd.skd_voy_no     = skd.skd_voy_no
                    		       and vvd.skd_dir_cd     = skd.skd_dir_cd
                    		       and vvd.pol_cd         = skd.vps_port_cd
                    		       and vvd.pol_CLPT_IND_SEQ = skd.CLPT_IND_SEQ
								   and rownum = 1) etd_dt
                    	  from dual) APPL_DT
            				  WHERE HDR.PROP_NO = MAIN.PROP_NO
            				    and main.prop_no = cust.prop_no
            				    and main.AMDT_SEQ = cust.AMDT_SEQ
            				    and cust.PRC_CTRT_PTY_TP_CD = 'C'
                                and hdr.sc_no        = BK.SC_NO
								and MAIN.eff_dt - 0.0001 < nvl(NVL(APPL_DT.RT_APPL_DT, APPL_DT.ETD_DT), bk.bkg_cre_dt)
								AND MAIN.exp_dt + 0.9999 > nvl(NVL(APPL_DT.RT_APPL_DT, APPL_DT.ETD_DT), bk.bkg_cre_dt)
            					and main.prop_sts_cd = 'F'
            					and rownum = 1)
                        else null end)
		#if (${ca_flg}== 'Y')
					, NVL((select cust_cnt_cd from bkg_cust_his cust where cust.bkg_no = bk.bkg_no and bkg_cust_tp_cd = 'S' and cust.corr_no = 'TMP0000001')
					    , (select cust_cnt_cd from bkg_cust_his cust where cust.bkg_no = bk.bkg_no and bkg_cust_tp_cd = 'F' and cust.corr_no = 'TMP0000001')))
		#else
					, NVL((select cust_cnt_cd from bkg_customer cust where cust.bkg_no = bk.bkg_no and bkg_cust_tp_cd = 'S')
					    , (select cust_cnt_cd from bkg_customer cust where cust.bkg_no = bk.bkg_no and bkg_cust_tp_cd = 'F')))
		#end
,   CTRT_CUST_SEQ = NVL((case 
                when SUBSTR(NVL(BK.RFA_NO, 'DUM'), 1, 3) <> 'DUM' then 
            				(select distinct main.CTRT_CUST_SEQ
                               from pri_rp_mn main
                                    , pri_rp_hdr hdr
                    	, (SELECT 
                    		   (select RT_APLY_DT --rate applicable
                    #if (${ca_flg}== 'Y')
                    			  from BKG_RT_HIS rt
                    		     where bkg_no = @[bkg_no]
                    			   AND CORR_NO = 'TMP0000001'
                    #else
                    		      from bkg_rate r
                    		     where bkg_no = @[bkg_no]
                    #end
                    		       and rt_aply_dt is not null) rt_appl_dt,
                    		   (select skd.vps_etd_dt --etd date
                    #if (${ca_flg}== 'Y')
                    		      from bkg_vvd_his vvd, vsk_vsl_port_skd skd, bkg_bkg_his bk
                    		     where bk.bkg_no          = @[bkg_no]  
                    			   and bk.corr_no 		  = 'TMP0000001'
                    			   and vvd.corr_no 		  = 'TMP0000001'
                    #else
                    		      from bkg_vvd vvd, vsk_vsl_port_skd skd, bkg_booking bk
                    		     where bk.bkg_no          = @[bkg_no]  
                    #end 
                    		       and bk.bkg_no          = vvd.bkg_no
                    		       and vvd.vsl_pre_pst_cd in ('S', 'T')
                    		       and vvd.pol_cd         = bk.pol_cd
                    		       and vvd.vsl_cd         = skd.vsl_cd
                    		       and vvd.skd_voy_no     = skd.skd_voy_no
                    		       and vvd.skd_dir_cd     = skd.skd_dir_cd
                    		       and vvd.pol_cd         = skd.vps_port_cd
                    		       and vvd.pol_CLPT_IND_SEQ = skd.CLPT_IND_SEQ
								   and rownum = 1) etd_dt
                    	  from dual) APPL_DT
                              where hdr.prop_no         = main.prop_no
                                and hdr.rfa_no          = BK.RFA_NO
            					and MAIN.eff_dt - 0.0001 < nvl(NVL(APPL_DT.RT_APPL_DT, APPL_DT.ETD_DT), bk.bkg_cre_dt)
            					AND MAIN.exp_dt + 0.9999 > nvl(NVL(APPL_DT.RT_APPL_DT, APPL_DT.ETD_DT), bk.bkg_cre_dt)
            					AND ((main.amdt_seq = 0 and main.prop_sts_cd = 'A') or (main.amdt_seq > 0))
                               and rownum = 1)
            			when SUBSTR(NVL(BK.TAA_NO, 'DUM'), 1, 3) <> 'DUM' then 
            				(select distinct CTRT_CUST_SEQ
                               from pri_taa_mn main
                                    , pri_taa_hdr hdr
                    	, (SELECT 
                    		   (select RT_APLY_DT --rate applicable
                    #if (${ca_flg}== 'Y')
                    			  from BKG_RT_HIS rt
                    		     where bkg_no = @[bkg_no]
                    			   AND CORR_NO = 'TMP0000001'
                    #else
                    		      from bkg_rate r
                    		     where bkg_no = @[bkg_no]
                    #end
                    		       and rt_aply_dt is not null) rt_appl_dt,
                    		   (select skd.vps_etd_dt --etd date
                    #if (${ca_flg}== 'Y')
                    		      from bkg_vvd_his vvd, vsk_vsl_port_skd skd, bkg_bkg_his bk
                    		     where bk.bkg_no          = @[bkg_no]  
                    			   and bk.corr_no 		  = 'TMP0000001'
                    			   and vvd.corr_no 		  = 'TMP0000001'
                    #else
                    		      from bkg_vvd vvd, vsk_vsl_port_skd skd, bkg_booking bk
                    		     where bk.bkg_no          = @[bkg_no]  
                    #end 
                    		       and bk.bkg_no          = vvd.bkg_no
                    		       and vvd.vsl_pre_pst_cd in ('S', 'T')
                    		       and vvd.pol_cd         = bk.pol_cd
                    		       and vvd.vsl_cd         = skd.vsl_cd
                    		       and vvd.skd_voy_no     = skd.skd_voy_no
                    		       and vvd.skd_dir_cd     = skd.skd_dir_cd
                    		       and vvd.pol_cd         = skd.vps_port_cd
                    		       and vvd.pol_CLPT_IND_SEQ = skd.CLPT_IND_SEQ
								   and rownum = 1) etd_dt
                    	  from dual) APPL_DT
            				  WHERE HDR.TAA_PROP_NO      = MAIN.TAA_PROP_NO
                                and hdr.TAA_NO           = BK.TAA_NO
								and MAIN.eff_dt - 0.0001 < nvl(NVL(APPL_DT.RT_APPL_DT, APPL_DT.ETD_DT), bk.bkg_cre_dt)
								AND MAIN.exp_dt + 0.9999 > nvl(NVL(APPL_DT.RT_APPL_DT, APPL_DT.ETD_DT), bk.bkg_cre_dt)
            			 	    and main.cfm_flg         = 'Y'
                                and rownum = 1)
            			when SUBSTR(NVL(BK.SC_NO,  'DUM'), 1, 3) <> 'DUM' then 
            				(select distinct nvl(main.REAL_CUST_SEQ, CUST_SEQ)
            				   FROM PRI_SP_HDR HDR
            						, PRI_SP_MN MAIN
            						, PRI_SP_CTRT_PTY cust
                    	, (SELECT 
                    		   (select RT_APLY_DT --rate applicable
                    #if (${ca_flg}== 'Y')
                    			  from BKG_RT_HIS rt
                    		     where bkg_no = @[bkg_no]
                    			   AND CORR_NO = 'TMP0000001'
                    #else
                    		      from bkg_rate r
                    		     where bkg_no = @[bkg_no]
                    #end
                    		       and rt_aply_dt is not null) rt_appl_dt,
                    		   (select skd.vps_etd_dt --etd date
                    #if (${ca_flg}== 'Y')
                    		      from bkg_vvd_his vvd, vsk_vsl_port_skd skd, bkg_bkg_his bk
                    		     where bk.bkg_no          = @[bkg_no]  
                    			   and bk.corr_no 		  = 'TMP0000001'
                    			   and vvd.corr_no 		  = 'TMP0000001'
                    #else
                    		      from bkg_vvd vvd, vsk_vsl_port_skd skd, bkg_booking bk
                    		     where bk.bkg_no          = @[bkg_no]  
                    #end 
                    		       and bk.bkg_no          = vvd.bkg_no
                    		       and vvd.vsl_pre_pst_cd in ('S', 'T')
                    		       and vvd.pol_cd         = bk.pol_cd
                    		       and vvd.vsl_cd         = skd.vsl_cd
                    		       and vvd.skd_voy_no     = skd.skd_voy_no
                    		       and vvd.skd_dir_cd     = skd.skd_dir_cd
                    		       and vvd.pol_cd         = skd.vps_port_cd
                    		       and vvd.pol_CLPT_IND_SEQ = skd.CLPT_IND_SEQ
								   and rownum = 1) etd_dt
                    	  from dual) APPL_DT
            				  WHERE HDR.PROP_NO          = MAIN.PROP_NO
            				    and main.prop_no = cust.prop_no
            				    and main.AMDT_SEQ = cust.AMDT_SEQ
            				    and cust.PRC_CTRT_PTY_TP_CD = 'C'
                                and hdr.sc_no            = BK.SC_NO
								and MAIN.eff_dt - 0.0001 < nvl(NVL(APPL_DT.RT_APPL_DT, APPL_DT.ETD_DT), bk.bkg_cre_dt)
								AND MAIN.exp_dt + 0.9999 > nvl(NVL(APPL_DT.RT_APPL_DT, APPL_DT.ETD_DT), bk.bkg_cre_dt)
            					and main.prop_sts_cd = 'F'
            					and rownum = 1)
                        else null end)
		#if (${ca_flg}== 'Y')
					, NVL((select cust_seq from bkg_cust_his cust where cust.bkg_no = bk.bkg_no and bkg_cust_tp_cd = 'S' and cust.corr_no = 'TMP0000001')
					    , (select cust_seq from bkg_cust_his cust where cust.bkg_no = bk.bkg_no and bkg_cust_tp_cd = 'F' and cust.corr_no = 'TMP0000001')))
		#else
					, NVL((select cust_seq from bkg_customer cust where cust.bkg_no = bk.bkg_no and bkg_cust_tp_cd = 'S')
						, (select cust_seq from bkg_customer cust where cust.bkg_no = bk.bkg_no and bkg_cust_tp_cd = 'F')))
		#end
WHERE	BKG_NO = @[bkg_no]
#if (${ca_flg}== 'Y')
AND   CORR_NO = 'TMP0000001'
#end			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="SEL001930700" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
