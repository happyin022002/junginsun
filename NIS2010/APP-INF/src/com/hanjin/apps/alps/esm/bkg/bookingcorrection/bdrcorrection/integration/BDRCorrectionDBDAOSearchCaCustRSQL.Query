<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BDRCorrectionDBDAOSearchCaCustRSQL">
			<desc><![CDATA[BDRCorrectionDBDAOSearchCaCustRSQL]]></desc>
			<sql><![CDATA[
with CA as
(
select nvl(old.BKG_CUST_TP_CD,' ') ocust_tp_cd, nvl(old.cust_cd,'0') ocust_cd, nvl(old.cust_nm_addr,' ') ocust_nm, nvl(old.addr_cd,'///') oaddr_cd, nvl(old.fax_eml,'/') ofax_eml,
       nvl(new.BKG_CUST_TP_CD,' ') ncust_tp_cd, nvl(new.cust_cd,'0') ncust_cd, nvl(new.cust_nm_addr,' ') ncust_nm, nvl(new.addr_cd,'///') naddr_cd, nvl(new.fax_eml,'/') nfax_eml
from 
( select BKG_CUST_TP_CD, trim(CUST_CNT_CD||nvl(CUST_SEQ,0)) cust_cd, CUST_NM||CUST_ADDR cust_nm_addr,
         CUST_CTY_NM||'/'||CUST_STE_CD||'/'||CUST_ZIP_ID||'/'||CSTMS_DECL_CNT_CD addr_cd,
         CUST_FAX_NO||'/'||CUST_EML fax_eml 
from bkg_cust_his
where bkg_no = @[bkg_no]
  and corr_no = @[ca_no]
  and BKG_CUST_TP_CD in ( 'S','C','F','N','A','E' ) ) new FULL OUTER JOIN         
( select BKG_CUST_TP_CD, trim(CUST_CNT_CD||nvl(CUST_SEQ,0)) cust_cd, CUST_NM||CUST_ADDR cust_nm_addr,
         CUST_CTY_NM||'/'||CUST_STE_CD||'/'||CUST_ZIP_ID||'/'||CSTMS_DECL_CNT_CD addr_cd,
         CUST_FAX_NO||'/'||CUST_EML fax_eml 
from bkg_cust_his BCH
where bkg_no = @[bkg_no]  
  and BKG_CUST_TP_CD in ( 'S','C','F','N','A','E' )
  and corr_no  = ( SELECT CORR_NO FROM BKG_CORRECTION 
                    WHERE BKG_NO = BCH.BKG_NO
                      AND CORR_DT = ( SELECT MAX(CORR_DT) FROM BKG_CORRECTION
                                       WHERE BKG_NO = BCH.BKG_NO
                                         AND CORR_DT < ( select CORR_DT from bkg_correction 
                                                        where BKG_NO = BCH.BKG_NO 
                                                        AND  corr_no = @[ca_no] )) ) ) old
on old.BKG_CUST_TP_CD = new.BKG_CUST_TP_CD
)
SELECT item_hdr, his_cate_nm, pre_ctnt, crnt_ctnt
FROM (
    select MAX(item_hdr) item_hdr, MAX(his_cate_nm) his_cate_nm, MAX(pre_ctnt) pre_ctnt, MAX(crnt_ctnt) crnt_ctnt, SEQ SEQ
      from (
        select '' item_hdr,
               case
               when ocust_tp_cd = 'S' or ncust_tp_cd = 'S' Then 'Shipper Code'
               when ocust_tp_cd = 'C' or ncust_tp_cd = 'C' Then 'Consignee Code'
               when ocust_tp_cd = 'N' or ncust_tp_cd = 'N' Then 'Notify Code'
               when ocust_tp_cd = 'F' or ncust_tp_cd = 'F' Then 'F/Forward Code'
               when ocust_tp_cd = 'A' or ncust_tp_cd = 'A' Then 'A/Notify Code'
               when ocust_tp_cd = 'E' or ncust_tp_cd = 'E' Then 'Export Ref Code'
               END his_cate_nm,
               ocust_cd pre_ctnt,
               ncust_cd crnt_ctnt,
               case
               when ocust_tp_cd = 'S' or ncust_tp_cd = 'S' Then 10
               when ocust_tp_cd = 'C' or ncust_tp_cd = 'C' Then 30
               when ocust_tp_cd = 'F' or ncust_tp_cd = 'F' Then 50
               when ocust_tp_cd = 'N' or ncust_tp_cd = 'N' Then 70
               when ocust_tp_cd = 'A' or ncust_tp_cd = 'A' Then 90
               when ocust_tp_cd = 'E' or ncust_tp_cd = 'E' Then 110
               END seq
            from ca
            where ocust_cd <> ncust_cd
            union all
        select '' item_hdr,
               case
               when ocust_tp_cd = 'S' or ncust_tp_cd = 'S' Then 'Shipper'
               when ocust_tp_cd = 'C' or ncust_tp_cd = 'C' Then 'Consignee'
               when ocust_tp_cd = 'N' or ncust_tp_cd = 'N' Then 'Notify'
               when ocust_tp_cd = 'F' or ncust_tp_cd = 'F' Then 'F/Forward'
               when ocust_tp_cd = 'A' or ncust_tp_cd = 'A' Then 'A/Notify'
               when ocust_tp_cd = 'E' or ncust_tp_cd = 'E' Then 'Export Ref'
               END his_cate_nm,
               ocust_nm pre_ctnt,
               ncust_nm crnt_ctnt,
               case
               when ocust_tp_cd = 'S' or ncust_tp_cd = 'S' Then 20
               when ocust_tp_cd = 'C' or ncust_tp_cd = 'C' Then 40
               when ocust_tp_cd = 'F' or ncust_tp_cd = 'F' Then 60
               when ocust_tp_cd = 'N' or ncust_tp_cd = 'N' Then 80
               when ocust_tp_cd = 'A' or ncust_tp_cd = 'A' Then 100
               when ocust_tp_cd = 'E' or ncust_tp_cd = 'E' Then 120
               END seq
            from ca
            where ocust_nm <> ncust_nm
        union all
        select '' item_hdr,
               case
               when ocust_tp_cd = 'S' or ncust_tp_cd = 'S' Then 'Shipper Addr Code'
               when ocust_tp_cd = 'C' or ncust_tp_cd = 'C' Then 'Consignee Addr Code'
               when ocust_tp_cd = 'N' or ncust_tp_cd = 'N' Then 'Notify Addr Code'
               when ocust_tp_cd = 'F' or ncust_tp_cd = 'F' Then 'F/Forward Addr Code'
               when ocust_tp_cd = 'A' or ncust_tp_cd = 'A' Then 'A/Notify Addr Code'
               when ocust_tp_cd = 'E' or ncust_tp_cd = 'E' Then 'Export Ref Addr Code'
               END his_cate_nm,
               oaddr_cd pre_ctnt,
               naddr_cd crnt_ctnt,
               case
               when ocust_tp_cd = 'S' or ncust_tp_cd = 'S' Then 21
               when ocust_tp_cd = 'C' or ncust_tp_cd = 'C' Then 41
               when ocust_tp_cd = 'F' or ncust_tp_cd = 'F' Then 61
               when ocust_tp_cd = 'N' or ncust_tp_cd = 'N' Then 81
               when ocust_tp_cd = 'A' or ncust_tp_cd = 'A' Then 101
               when ocust_tp_cd = 'E' or ncust_tp_cd = 'E' Then 121
               END seq
            from ca
            where oaddr_cd <> naddr_cd
        union all
        select '' item_hdr,
               case
               when ocust_tp_cd = 'S' or ncust_tp_cd = 'S' Then 'Shipper Fax Email'
               when ocust_tp_cd = 'C' or ncust_tp_cd = 'C' Then 'Consignee Fax Email'
               when ocust_tp_cd = 'N' or ncust_tp_cd = 'N' Then 'Notify Fax Email'
               when ocust_tp_cd = 'F' or ncust_tp_cd = 'F' Then 'F/Forward Fax Email'
               when ocust_tp_cd = 'A' or ncust_tp_cd = 'A' Then 'A/Notify Fax Email'
               when ocust_tp_cd = 'E' or ncust_tp_cd = 'E' Then 'Export Ref Fax Email'
               END his_cate_nm,
               ofax_eml pre_ctnt,
               nfax_eml crnt_ctnt,
               case
               when ocust_tp_cd = 'S' or ncust_tp_cd = 'S' Then 22
               when ocust_tp_cd = 'C' or ncust_tp_cd = 'C' Then 42
               when ocust_tp_cd = 'F' or ncust_tp_cd = 'F' Then 62
               when ocust_tp_cd = 'N' or ncust_tp_cd = 'N' Then 82
               when ocust_tp_cd = 'A' or ncust_tp_cd = 'A' Then 102
               when ocust_tp_cd = 'E' or ncust_tp_cd = 'E' Then 122
               END seq
            from ca
            where ofax_eml <> nfax_eml
        ) ca, bkg_correction cor
        where cor.bkg_no = @[bkg_no]
          and cor.corr_no = @[ca_no]
        GROUP BY seq
    )
    WHERE pre_ctnt <> crnt_ctnt
    ORDER BY SEQ			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="KORYC010002" out="N"/>
				<param name="ca_no" type="12" value="SEL9000005" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
