<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="GeneralBookingSearchDBDAOSearchAlocStandbyReasonCustRSQL">
			<desc><![CDATA[Allocation Stand by Reason 의 Customer Constraint 를 조회한다.]]></desc>
			<sql><![CDATA[
SELECT BKG_ALOC_TP_CD 
       , CUST_CD
       , SC_NO
       , CUST_NM
       , MAX(DECODE(ALOC_FLAG,'TRUNK','Y','N')) TRUNK_VVD_FLAG
       , MAX(DECODE(ALOC_FLAG,'TS','Y','N')) TS_VVD_FLAG
       , MAX(DECODE(ALOC_FLAG,'EQ','Y','N')) EQ_FLAG
       , MAX(DECODE(ALOC_FLAG,'COMMODITY','Y','N')) COMMODITY_FLAG
       , MAX(DECODE(ALOC_FLAG,'OTHER','Y','N')) OTHER_FLAG
       , MAX(CASE WHEN ALOC_FLAG = 'TRUNK' THEN BKG_ALOC_RMK ELSE '' END) TRUNK_VVD_REMARK
       , MAX(CASE WHEN ALOC_FLAG = 'TS' THEN BKG_ALOC_RMK ELSE '' END) TS_VVD_REMARK
       , MAX(CASE WHEN ALOC_FLAG = 'EQ' THEN BKG_ALOC_RMK ELSE '' END) EQ_REMARK
       , MAX(CASE WHEN ALOC_FLAG = 'COMMODITY' THEN BKG_ALOC_RMK ELSE '' END) COMMODITY_REMARK
       , MAX(CASE WHEN ALOC_FLAG = 'OTHER' THEN BKG_ALOC_RMK ELSE '' END) OTHER_REMARK
FROM (
     SELECT 'C' BKG_ALOC_TP_CD
           ,BKG.CUST_CNT_CD||TRIM(TO_CHAR(BKG.CUST_SEQ,'000000')) CUST_CD
           ,BKG.SC_NO
           ,(SELECT MC.CUST_LGL_ENG_NM FROM MDM_CUSTOMER MC WHERE MC.CUST_CNT_CD = BKG.CUST_CNT_CD AND MC.CUST_SEQ = BKG.CUST_SEQ) CUST_NM
           ,CASE WHEN BKG.VSL_PRE_PST_CD = 'T' AND BAM.VSL_CD||BAM.SKD_VOY_NO||BAM.SKD_DIR_CD = BKG.VVD_VSL_CD||BKG.VVD_SKD_VOY_NO||BKG.VVD_SKD_DIR_CD THEN 'TRUNK'
                 WHEN BKG.VSL_PRE_PST_CD <> 'T' AND BAM.VSL_CD||BAM.SKD_VOY_NO||BAM.SKD_DIR_CD = BKG.VVD_VSL_CD||BKG.VVD_SKD_VOY_NO||BKG.VVD_SKD_DIR_CD THEN 'TS'
                 WHEN BAM.CNTR_TPSZ_CD = BKG.CNTR_TPSZ_CD THEN 'EQ'
                 WHEN (SELECT WM_CONCAT(CMDT.CMDT_CD) FROM SPC_BKG_ALOC_MGMT_CMDT_DTL CMDT WHERE CMDT.BKG_ALOC_SEQ = BAM.BKG_ALOC_SEQ) LIKE '%'||BKG.CMDT_CD||'%' OR
                    --BAM.CMDT_CD = BKG.CMDT_CD OR
                      BAM.SCG_GRP_CMDT_SEQ = BKG.GRP_CMDT_CD THEN 'COMMODITY'
                 WHEN (SELECT WM_CONCAT(LD.SB_LOC_CD) FROM SPC_BKG_ALOC_MGMT_NOD_DTL LD WHERE LD.BKG_ALOC_SEQ = BAM.BKG_ALOC_SEQ AND LD.SB_LOC_DIV_CD IN ('TPL', 'SPL') AND LENGTH(LD.SB_LOC_CD) = 5) LIKE '%'||BKG.VVD_POL_CD||'%' OR
                      (SELECT WM_CONCAT(LD.SB_LOC_CD) FROM SPC_BKG_ALOC_MGMT_NOD_DTL LD WHERE LD.BKG_ALOC_SEQ = BAM.BKG_ALOC_SEQ AND LD.SB_LOC_DIV_CD IN ('TPD', 'SPD') AND LENGTH(LD.SB_LOC_CD) = 5) LIKE '%'||BKG.VVD_POD_CD||'%' OR
                      --BAM.N1ST_TS_POL_CD = BKG.VVD_POL_CD OR
                      --BAM.N1ST_TS_POD_CD = BKG.VVD_POD_CD OR
                      BAM.N1ST_TS_SLAN_CD = BKG.VVD_SLAN_CD OR
                      BAM.TRNK_SLAN_CD = BKG.TRUNK_SLAN_CD OR
                      BAM.TRNK_DIR_CD = BKG.TRUNK_SKD_DIR_CD OR
--                      BAM.POR_CD = BKG.POR_CD OR
                      (SELECT WM_CONCAT(LD.SB_LOC_CD) FROM SPC_BKG_ALOC_MGMT_NOD_DTL LD WHERE LD.BKG_ALOC_SEQ = BAM.BKG_ALOC_SEQ AND LD.SB_LOC_DIV_CD = 'POR' AND LENGTH(LD.SB_LOC_CD) = 5) LIKE '%'||BKG.POR_CD||'%' OR
                      BAM.POR_NOD_CD = BKG.POR_NOD_CD OR
                      BAM.BKG_POR_SCC_CD = BKG.POR_SCC_CD OR 
--                      BAM.POL_CD = BKG.POL_CD OR
                      (SELECT WM_CONCAT(LD.SB_LOC_CD) FROM SPC_BKG_ALOC_MGMT_NOD_DTL LD WHERE LD.BKG_ALOC_SEQ = BAM.BKG_ALOC_SEQ AND LD.SB_LOC_DIV_CD = 'POL' AND LENGTH(LD.SB_LOC_CD) = 5) LIKE '%'||BKG.POL_CD||'%' OR
                      BAM.POL_NOD_CD = BKG.POL_NOD_CD OR
--                      BAM.POD_CD = BKG.POD_CD OR
                      (SELECT WM_CONCAT(LD.SB_LOC_CD) FROM SPC_BKG_ALOC_MGMT_NOD_DTL LD WHERE LD.BKG_ALOC_SEQ = BAM.BKG_ALOC_SEQ AND LD.SB_LOC_DIV_CD = 'POD' AND LENGTH(LD.SB_LOC_CD) = 5) LIKE '%'||BKG.POD_CD||'%' OR
                      BAM.POD_NOD_CD = BKG.POD_NOD_CD OR 
--                      BAM.DEL_CD = BKG.DEL_CD OR
                      (SELECT WM_CONCAT(LD.SB_LOC_CD) FROM SPC_BKG_ALOC_MGMT_NOD_DTL LD WHERE LD.BKG_ALOC_SEQ = BAM.BKG_ALOC_SEQ AND LD.SB_LOC_DIV_CD = 'DEL' AND LENGTH(LD.SB_LOC_CD) = 5) LIKE '%'||BKG.DEL_CD||'%' OR
                      BAM.DEL_NOD_CD = BKG.DEL_NOD_CD OR
                      BKG_DEL_SCC_CD = BKG.DEL_SCC_CD OR
                      BAM.OB_SLS_OFC_CD = BKG.OB_SLS_OFC_CD OR
                      BAM.SC_NO = BKG.SC_NO OR
                      BAM.RFA_NO = BKG.RFA_NO OR
--                      BAM.BKG_POR_CNT_CD = SUBSTR(BKG.POR_CD,1,2) OR
--                      BAM.BKG_POL_CNT_CD = SUBSTR(BKG.POL_CD,1,2) OR
--                      BAM.BKG_POD_CNT_CD = SUBSTR(BKG.POD_CD,1,2) OR
--                      BAM.BKG_DEL_CNT_CD = SUBSTR(BKG.DEL_CD,1,2) OR
                      (SELECT WM_CONCAT(LD.SB_LOC_CD) FROM SPC_BKG_ALOC_MGMT_NOD_DTL LD WHERE LD.BKG_ALOC_SEQ = BAM.BKG_ALOC_SEQ AND LD.SB_LOC_DIV_CD = 'POR' AND LENGTH(LD.SB_LOC_CD) = 2) LIKE '%'||SUBSTR(BKG.POR_CD,1,2)||'%' OR
                      (SELECT WM_CONCAT(LD.SB_LOC_CD) FROM SPC_BKG_ALOC_MGMT_NOD_DTL LD WHERE LD.BKG_ALOC_SEQ = BAM.BKG_ALOC_SEQ AND LD.SB_LOC_DIV_CD = 'POL' AND LENGTH(LD.SB_LOC_CD) = 2) LIKE '%'||SUBSTR(BKG.POL_CD,1,2)||'%' OR
                      (SELECT WM_CONCAT(LD.SB_LOC_CD) FROM SPC_BKG_ALOC_MGMT_NOD_DTL LD WHERE LD.BKG_ALOC_SEQ = BAM.BKG_ALOC_SEQ AND LD.SB_LOC_DIV_CD = 'POD' AND LENGTH(LD.SB_LOC_CD) = 2) LIKE '%'||SUBSTR(BKG.POD_CD,1,2)||'%' OR
                      (SELECT WM_CONCAT(LD.SB_LOC_CD) FROM SPC_BKG_ALOC_MGMT_NOD_DTL LD WHERE LD.BKG_ALOC_SEQ = BAM.BKG_ALOC_SEQ AND LD.SB_LOC_DIV_CD = 'DEL' AND LENGTH(LD.SB_LOC_CD) = 2) LIKE '%'||SUBSTR(BKG.DEL_CD,1,2)||'%' OR
                      (BAM.CTRT_CUST_CNT_CD = BKG.CTRT_CUST_CNT_CD AND BAM.CTRT_CUST_SEQ = BKG.CTRT_CUST_SEQ) OR
                      (BAM.CUST_CNT_CD = BKG.CUST_CNT_CD AND BAM.CUST_SEQ = BKG.CUST_SEQ) THEN 'OTHER'
                 END ALOC_FLAG
           ,BAM.BKG_ALOC_RMK
    FROM SPC_BKG_ALOC_MGMT BAM
         ,(SELECT BB.SLAN_CD TRUNK_SLAN_CD
                  ,BB.SKD_DIR_CD TRUNK_SKD_DIR_CD
                  ,BB.POR_CD
                  ,POR_SCC.SCC_CD POR_SCC_CD
                  ,BB.POR_NOD_CD
                  ,BB.POL_CD
                  ,BB.POL_NOD_CD
                  ,BB.POD_CD
                  ,BB.POD_NOD_CD
                  ,BB.DEL_CD
                  ,DEL_SCC.SCC_CD DEL_SCC_CD
                  ,BB.DEL_NOD_CD
                  ,BB.OB_SLS_OFC_CD
                  ,BB.SC_NO
                  ,BB.RFA_NO
                  ,BB.SKD_DIR_CD
                  ,BB.CMDT_CD
                  ,BB.CTRT_CUST_CNT_CD
                  ,BB.CTRT_CUST_SEQ
                  ,BV.VSL_PRE_PST_CD
                  ,BV.SLAN_CD VVD_SLAN_CD
                  ,BV.VSL_CD VVD_VSL_CD
                  ,BV.SKD_VOY_NO VVD_SKD_VOY_NO
                  ,BV.SKD_DIR_CD VVD_SKD_DIR_CD
                  ,BV.POL_CD VVD_POL_CD
                  ,BV.POD_CD VVD_POD_CD
                  ,BQ.CNTR_TPSZ_CD
                  ,BC.CUST_CNT_CD
                  ,BC.CUST_SEQ
                  ,NVL((SELECT PSC.SCG_GRP_CMDT_SEQ
                      FROM PRI_SCG_GRP_CMDT_DTL PSC
                     WHERE PSC.SVC_SCP_CD = 'TPW'
                       AND PSC.CHG_CD = 'GRI'
                       AND PSC.CMDT_CD = BB.CMDT_CD
                       AND ROWNUM = 1),9999) GRP_CMDT_CD
             FROM BKG_BOOKING BB
                 ,BKG_QUANTITY BQ
                 ,BKG_VVD BV
                 ,BKG_OFC_LVL_V LVL 
                 ,MDM_LOCATION POR_SCC
                 ,MDM_LOCATION DEL_SCC
                 ,BKG_CUSTOMER BC
            WHERE BB.BKG_NO = @[bkg_no]
            AND   BB.BKG_NO = BQ.BKG_NO
            AND   BV.BKG_NO = BB.BKG_NO
            AND   BB.POR_CD = POR_SCC.LOC_CD
            AND   BB.DEL_CD = DEL_SCC.LOC_CD
            AND   BB.BKG_NO = BC.BKG_NO
            AND   BC.BKG_CUST_TP_CD = 'S'
            AND   BB.OB_SLS_OFC_CD = LVL.OFC_CD)  BKG
    WHERE BAM.BKG_ALOC_TP_CD(+) = 'C' 
    AND   NVL(BAM.SC_NO(+),NVL(BKG.SC_NO,'A')) = NVL(BKG.SC_NO,'A')
    AND   NVL(BAM.RFA_NO(+),NVL(BKG.RFA_NO,'A')) = NVL(BKG.RFA_NO,'A')
    AND   NVL(BAM.TRNK_SLAN_CD(+),BKG.TRUNK_SLAN_CD) = BKG.TRUNK_SLAN_CD      -- T.LANE
    AND   NVL(BAM.TRNK_DIR_CD(+),BKG.SKD_DIR_CD) = BKG.SKD_DIR_CD -- BD
--    AND   NVL(BAM.POR_CD(+),BKG.POR_CD) = BKG.POR_CD
	AND   NVL((SELECT WM_CONCAT(LD.SB_LOC_CD) FROM SPC_BKG_ALOC_MGMT_NOD_DTL LD WHERE LD.BKG_ALOC_SEQ = BAM.BKG_ALOC_SEQ AND LD.SB_LOC_DIV_CD = 'POR' AND LENGTH(LD.SB_LOC_CD) = 5), BKG.POR_CD) LIKE '%'||BKG.POR_CD||'%'                      
    AND   NVL(BAM.POR_NOD_CD(+),BKG.POR_NOD_CD) = BKG.POR_NOD_CD
    AND   NVL(BAM.BKG_POR_SCC_CD(+),BKG.POR_SCC_CD) = BKG.POR_SCC_CD
--    AND   NVL(BAM.POL_CD(+),BKG.POL_CD) = BKG.POL_CD
	AND   NVL((SELECT WM_CONCAT(LD.SB_LOC_CD) FROM SPC_BKG_ALOC_MGMT_NOD_DTL LD WHERE LD.BKG_ALOC_SEQ = BAM.BKG_ALOC_SEQ AND LD.SB_LOC_DIV_CD = 'POL' AND LENGTH(LD.SB_LOC_CD) = 5), BKG.POL_CD) LIKE '%'||BKG.POL_CD||'%'                      
    AND   NVL(BAM.POD_NOD_CD(+),BKG.POD_NOD_CD) = BKG.POD_NOD_CD
--    AND   NVL(BAM.POD_CD(+),BKG.POD_CD) = BKG.POD_CD
	AND   NVL((SELECT WM_CONCAT(LD.SB_LOC_CD) FROM SPC_BKG_ALOC_MGMT_NOD_DTL LD WHERE LD.BKG_ALOC_SEQ = BAM.BKG_ALOC_SEQ AND LD.SB_LOC_DIV_CD = 'POD' AND LENGTH(LD.SB_LOC_CD) = 5), BKG.POD_CD) LIKE '%'||BKG.POD_CD||'%'                      
    AND   NVL(BAM.POD_NOD_CD(+),BKG.POD_NOD_CD) = BKG.POD_NOD_CD
--    AND   NVL(BAM.DEL_CD(+),BKG.DEL_CD) = BKG.DEL_CD
	AND   NVL((SELECT WM_CONCAT(LD.SB_LOC_CD) FROM SPC_BKG_ALOC_MGMT_NOD_DTL LD WHERE LD.BKG_ALOC_SEQ = BAM.BKG_ALOC_SEQ AND LD.SB_LOC_DIV_CD = 'DEL' AND LENGTH(LD.SB_LOC_CD) = 5), BKG.DEL_CD) LIKE '%'||BKG.DEL_CD||'%'                      
    AND   NVL(BAM.DEL_NOD_CD(+),BKG.DEL_NOD_CD) = BKG.DEL_NOD_CD
--    AND   NVL(BAM.N1ST_TS_POL_CD(+),BKG.VVD_POL_CD) = BKG.VVD_POL_CD
--    AND   NVL(BAM.N1ST_TS_POD_CD(+),BKG.VVD_POD_CD) = BKG.VVD_POD_CD
	AND   NVL((SELECT WM_CONCAT(LD.SB_LOC_CD) FROM SPC_BKG_ALOC_MGMT_NOD_DTL LD WHERE LD.BKG_ALOC_SEQ = BAM.BKG_ALOC_SEQ AND LD.SB_LOC_DIV_CD IN ('TPL', 'SPL') AND LENGTH(LD.SB_LOC_CD) = 5), BKG.VVD_POL_CD) LIKE '%'||BKG.VVD_POL_CD||'%'                      
	AND   NVL((SELECT WM_CONCAT(LD.SB_LOC_CD) FROM SPC_BKG_ALOC_MGMT_NOD_DTL LD WHERE LD.BKG_ALOC_SEQ = BAM.BKG_ALOC_SEQ AND LD.SB_LOC_DIV_CD IN ('TPD', 'SPD') AND LENGTH(LD.SB_LOC_CD) = 5), BKG.VVD_POD_CD) LIKE '%'||BKG.VVD_POD_CD||'%'                      
    AND   NVL(BAM.N1ST_TS_SLAN_CD(+),BKG.VVD_SLAN_CD) = BKG.VVD_SLAN_CD
    AND   NVL(BAM.BKG_DEL_SCC_CD(+),BKG.DEL_SCC_CD) = BKG.DEL_SCC_CD
    AND   NVL(BAM.OB_SLS_OFC_CD(+),BKG.OB_SLS_OFC_CD) = BKG.OB_SLS_OFC_CD
    AND   NVL(BAM.CNTR_TPSZ_CD(+),BKG.CNTR_TPSZ_CD) = BKG.CNTR_TPSZ_CD
--    AND   NVL(BAM.CMDT_CD(+),BKG.CMDT_CD) = BKG.CMDT_CD
    AND   NVL((SELECT WM_CONCAT(CMDT.CMDT_CD) FROM SPC_BKG_ALOC_MGMT_CMDT_DTL CMDT WHERE CMDT.BKG_ALOC_SEQ = BAM.BKG_ALOC_SEQ),BKG.CMDT_CD) LIKE '%'||BKG.CMDT_CD||'%'
    AND   NVL(BAM.SCG_GRP_CMDT_SEQ(+),BKG.GRP_CMDT_CD) = BKG.GRP_CMDT_CD
    AND   NVL(BAM.VSL_CD(+),BKG.VVD_VSL_CD) = BKG.VVD_VSL_CD
    AND   NVL(BAM.SKD_VOY_NO(+),BKG.VVD_SKD_VOY_NO) = BKG.VVD_SKD_VOY_NO
    AND   NVL(BAM.SKD_DIR_CD(+),BKG.VVD_SKD_DIR_CD) = BKG.VVD_SKD_DIR_CD 
    AND   NVL(BAM.CTRT_CUST_CNT_CD(+),BKG.CTRT_CUST_CNT_CD) = BKG.CTRT_CUST_CNT_CD 
    AND   NVL(BAM.CTRT_CUST_SEQ(+),BKG.CTRT_CUST_SEQ) = BKG.CTRT_CUST_SEQ
    AND   NVL(BAM.CUST_CNT_CD(+),BKG.CUST_CNT_CD) = BKG.CUST_CNT_CD 
    AND   NVL(BAM.CUST_SEQ(+),BKG.CUST_SEQ) = BKG.CUST_SEQ  
--    AND   NVL(BAM.BKG_POR_CNT_CD(+),SUBSTR(BKG.POR_CD,1,2)) = SUBSTR(BKG.POR_CD,1,2)
--    AND   NVL(BAM.BKG_POL_CNT_CD(+),SUBSTR(BKG.POL_CD,1,2)) = SUBSTR(BKG.POL_CD,1,2)
--    AND   NVL(BAM.BKG_POD_CNT_CD(+),SUBSTR(BKG.POD_CD,1,2)) = SUBSTR(BKG.POD_CD,1,2)
--    AND   NVL(BAM.BKG_DEL_CNT_CD(+),SUBSTR(BKG.DEL_CD,1,2)) = SUBSTR(BKG.DEL_CD,1,2) 
    AND NVL((SELECT WM_CONCAT(LD.SB_LOC_CD) FROM SPC_BKG_ALOC_MGMT_NOD_DTL LD WHERE LD.BKG_ALOC_SEQ = BAM.BKG_ALOC_SEQ AND LD.SB_LOC_DIV_CD = 'POR' AND LENGTH(LD.SB_LOC_CD) = 2),SUBSTR(BKG.POR_CD,1,2)) LIKE '%'||SUBSTR(BKG.POR_CD,1,2)||'%'
    AND NVL((SELECT WM_CONCAT(LD.SB_LOC_CD) FROM SPC_BKG_ALOC_MGMT_NOD_DTL LD WHERE LD.BKG_ALOC_SEQ = BAM.BKG_ALOC_SEQ AND LD.SB_LOC_DIV_CD = 'POL' AND LENGTH(LD.SB_LOC_CD) = 2),SUBSTR(BKG.POL_CD,1,2)) LIKE '%'||SUBSTR(BKG.POL_CD,1,2)||'%'
    AND NVL((SELECT WM_CONCAT(LD.SB_LOC_CD) FROM SPC_BKG_ALOC_MGMT_NOD_DTL LD WHERE LD.BKG_ALOC_SEQ = BAM.BKG_ALOC_SEQ AND LD.SB_LOC_DIV_CD = 'POD' AND LENGTH(LD.SB_LOC_CD) = 2),SUBSTR(BKG.POD_CD,1,2)) LIKE '%'||SUBSTR(BKG.POD_CD,1,2)||'%'
    AND NVL((SELECT WM_CONCAT(LD.SB_LOC_CD) FROM SPC_BKG_ALOC_MGMT_NOD_DTL LD WHERE LD.BKG_ALOC_SEQ = BAM.BKG_ALOC_SEQ AND LD.SB_LOC_DIV_CD = 'DEL' AND LENGTH(LD.SB_LOC_CD) = 2),SUBSTR(BKG.DEL_CD,1,2)) LIKE '%'||SUBSTR(BKG.DEL_CD,1,2)||'%'			  
    AND BAM.SLS_RHQ_CD(+) = 'NYCRA'
)
GROUP BY BKG_ALOC_TP_CD
       , CUST_CD
       , SC_NO 
       , CUST_NM
			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
