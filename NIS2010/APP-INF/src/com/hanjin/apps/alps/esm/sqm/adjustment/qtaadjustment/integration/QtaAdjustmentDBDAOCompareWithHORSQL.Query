<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="QtaAdjustmentDBDAOCompareWithHORSQL">
			<desc><![CDATA[* 2015.07.22 김용습 [CHM-201537172] [CSR 전환건] QTA Adjustment by VVD 화면 내 신규 기능 추가
QTA Adjustment by VVD과 Portion Adjustment by Head Office의 결과를 비교하여 QTA Adjustment by VVD 화면에 뿌려줌
* 2015.09.09 김용습 [CHM-201537818] QTA Adjustment by VVD, QTA Adjustment by VVD for IAS Sector 두 화면내 칼럼 수정
2016.03.22 CHM-201640709 Adjusted 클릭시 Contract 컬럼을 Contract O/B와 Contract N/OB로 나눠서 보여주도록 로직 수정]]></desc>
			<sql><![CDATA[
SELECT 'COMPARISON_WITH_HO_LOADING_'||COMPARISON_WITH_HO_LOADING AS HOL_RESULT
	,'COMPARISON_WITH_HO_CONTRACT_'||COMPARISON_WITH_HO_CONTRACT AS HOC_RESULT
FROM
(
    SELECT COMPARISON_WITH_HO_LOADING, COMPARISON_WITH_HO_CONTRACT
    FROM
    (
        WITH PORTION_ADJUST_HO_LOADING AS
        (
            (
                SELECT TRD_CD, SUB_TRD_CD, RLANE_CD, DIR_CD, MIN(HO_APLY_FM_YRWK_LOADING) AS HO_APLY_FM_YRWK_LOADING, MAX(HO_APLY_TO_YRWK_LOADING) AS HO_APLY_TO_YRWK_LOADING 
                FROM
                (
                    SELECT A2.TRD_CD, A2.SUB_TRD_CD, A2.RLANE_CD, A2.DIR_CD, A2.APLY_FM_YRWK AS HO_APLY_FM_YRWK_LOADING, A2.APLY_TO_YRWK AS HO_APLY_TO_YRWK_LOADING
                      FROM SQM_QTA_LANE_OFC A1
                          ,SQM_CFM_QTA_POTN_MGMT A2
                          ,SQM_DAT_RLT A3
                          ,MAS_LANE_RGST A4
                     WHERE 1=1
                       AND A2.TRD_CD       = A4.TRD_CD
                       AND A2.RLANE_CD     = A4.RLANE_CD
                       AND A2.DIR_CD       = A4.DIR_CD
                       AND A4.DELT_FLG     = 'N'

                       AND A2.BSE_TP_CD    = A3.BSE_TP_CD
                       AND A2.BSE_YR       = A3.BSE_YR
                       AND A2.BSE_QTR_CD   = A3.BSE_QTR_CD
                       AND A2.OFC_VW_CD    = A3.OFC_VW_CD
                       AND A2.TRD_CD       = A3.TRD_CD
                       AND A2.CONV_DIR_CD  = A3.CONV_DIR_CD
                       AND A2.RHQ_CD       = A3.RHQ_CD

                       AND A1.BSE_TP_CD    = A2.BSE_TP_CD
                       AND A1.BSE_YR       = A2.BSE_YR
                       AND A1.BSE_QTR_CD   = A2.BSE_QTR_CD
                       AND A1.OFC_VW_CD    = A2.OFC_VW_CD
                       AND A1.RHQ_CD       = A2.RHQ_CD
                       AND A1.TRD_CD       = A2.TRD_CD
                       AND A1.RLANE_CD     = A2.RLANE_CD
                       AND A1.DIR_CD       = A2.DIR_CD
                       AND A1.SQM_ACT_FLG  = 'Y'
                       AND A2.BSE_TP_CD    = @[f_bse_tp_cd]
                       AND A2.BSE_YR       = @[f_bse_yr]
                       AND A2.BSE_QTR_CD   = DECODE(@[f_bse_tp_cd], 'Y', '00', @[f_bse_qtr_cd])
                       AND A2.OFC_VW_CD    = 'L'
                       AND A2.QTA_STEP_CD  = '02'
                    #if (${f_trd_cd} != '' && ${f_trd_cd} != 'All')
                       AND A2.TRD_CD       = @[f_trd_cd]
                    #end
                    #if (${f_rlane_cd} != '' && ${f_rlane_cd} != 'All')
                       AND A2.RLANE_CD     = @[f_rlane_cd]
                    #end
                    #if (${f_click} != 'on' && ${f_conv_dir_cd} != '' && ${f_conv_dir_cd} != 'All')
                       AND A2.CONV_DIR_CD  = @[f_conv_dir_cd]
                    #end
                    #if (${f_click} == 'on' && ${f_trd_dir} != '' && ${f_trd_dir} != 'All')
                       AND A4.HUL_BND_CD  = @[f_trd_dir]
                    #end
                        GROUP BY A2.TRD_CD, A2.SUB_TRD_CD, A2.RLANE_CD, A2.DIR_CD, A2.APLY_FM_YRWK, A2.APLY_TO_YRWK
                )
                GROUP BY TRD_CD , SUB_TRD_CD, RLANE_CD, DIR_CD
            )
            UNION ALL
            (
                SELECT TRD_CD, SUB_TRD_CD, RLANE_CD, DIR_CD, '999999' AS HO_APLY_FM_YRWK_LOADING, '999999' AS HO_APLY_TO_YRWK_LOADING
                FROM
                (
                    SELECT DISTINCT A2.TRD_CD, A2.SUB_TRD_CD, A2.RLANE_CD, A2.DIR_CD, A2.TRD_CD||A2.SUB_TRD_CD||A2.RLANE_CD||A2.DIR_CD AS TSRD
                        FROM MAS_LANE_RGST A1, 
                             (
                               SELECT O_QTA_RLSE_VER_NO  AS QTA_RLSE_VER_NO
                                     ,O_TRD_CD           AS TRD_CD
                                     ,O_RLANE_CD         AS RLANE_CD
                                     ,O_SUB_TRD_CD       AS SUB_TRD_CD
                                     ,O_DIR_CD           AS DIR_CD
                                     ,O_IOC_CD           AS IOC_CD
                                     ,O_VVD
                                     ,MAX(SLS_YR)        AS SLS_YR
                                     ,MAX(SLS_YRMON)     AS SLS_YRMON
                                     ,MAX(BSE_YR)        AS BSE_YR
                                     ,MAX(BSE_MON)       AS BSE_MON
                                     ,MAX(BSE_WK)        AS BSE_WK
                                     ,MAX(VVD)           AS VVD
                                     ,MAX(SQM_CNG_TP_CD) AS SQM_CNG_TP_CD
                                     ,MAX(FNL_BSA_CAPA)  AS FNL_BSA_CAPA
                                     ,MAX(LOD_QTY)       AS LOD_QTY
                                     ,MAX(GRS_REV)       AS GRS_REV
                                     ,MAX(CASE WHEN NVL(SQM_INFO, '*') = NVL(MAS_INFO, '*') THEN '' ELSE MAS_COST_YR             END) AS MAS_COST_YR
                                     ,MAX(CASE WHEN NVL(SQM_INFO, '*') = NVL(MAS_INFO, '*') THEN '' ELSE MAS_COST_YRMON          END) AS MAS_COST_YRMON
                                     ,MAX(CASE WHEN NVL(SQM_INFO, '*') = NVL(MAS_INFO, '*') THEN '' ELSE MAS_MON                END) AS MAS_BSE_MON
                                     ,MAX(CASE WHEN NVL(SQM_INFO, '*') = NVL(MAS_INFO, '*') THEN '' ELSE COST_WK                END) AS MAS_BSE_WK
                                     ,MAX(CASE WHEN NVL(SQM_INFO, '*') = NVL(MAS_INFO, '*') THEN '' ELSE MAS_VVD                END) AS MAS_VVD
                                     ,MAX(CASE WHEN NVL(SQM_INFO, '*') = NVL(MAS_INFO, '*') THEN '' ELSE FNL_HJS_BSA_CAPA || '' END) AS MAS_FNL_BSA_CAPA
                                     ,CASE WHEN MAX(SQM_INFO) = MAX(MAS_INFO) THEN 'R'
                                           WHEN NVL(MAX(SQM_INFO), '*') = '*' THEN 'I'
                                           WHEN NVL(MAX(MAS_INFO), '*') = '*' THEN 'D'
                                                                              ELSE 'U'
                                      END AS FLAG
                                     ,MAX(SQM_INFO) AS SQM_INFO
                                     ,MAX(MAS_INFO) AS MAS_INFO
                                 FROM (
                                         SELECT B1.QTA_RLSE_VER_NO
                                               ,B1.TRD_CD
                                               ,B1.DIR_CD
                                               ,B1.SUB_TRD_CD
                                               ,B1.RLANE_CD
                                               ,B1.BSE_YR
                                               ,B1.BSE_MON
                                               ,B1.BSE_WK
                                               ,B1.SLS_YRMON
                                               ,SUBSTR(B1.SLS_YRMON,0,4) AS SLS_YR
                                               ,B1.VSL_CD || B1.SKD_VOY_NO || B1.DIR_CD AS VVD
                                               ,B1.SQM_CNG_TP_CD
                                               ,B1.FNL_BSA_CAPA
                                               ,B1.LOD_QTY
                                               ,B1.GRS_REV
                                               ,B2.COST_YRMON AS MAS_COST_YRMON
                                               ,SUBSTR(B2.COST_YRMON,0,4) AS MAS_COST_YR
                                               ,SUBSTR(B2.YRMON, -2) AS MAS_MON
                                               ,B2.COST_WK
                                               ,B2.VSL_CD || B2.SKD_VOY_NO || B2.DIR_CD AS MAS_VVD
                                               ,B2.FNL_HJS_BSA_CAPA
                                               ,B1.TRD_CD || B1.SUB_TRD_CD || B1.RLANE_CD || B1.DIR_CD || B1.VSL_CD || B1.SKD_VOY_NO || B1.DIR_CD || B1.BSE_WK || B1.FNL_BSA_CAPA || B1.SLS_YRMON AS SQM_INFO
                                               ,B2.TRD_CD || B2.SUB_TRD_CD || B2.RLANE_CD || B2.DIR_CD || B2.VSL_CD || B2.SKD_VOY_NO || B2.DIR_CD || B2.COST_WK || B2.FNL_HJS_BSA_CAPA || B2.COST_YRMON AS MAS_INFO
                                               ,NVL(B1.QTA_RLSE_VER_NO, B2.QTA_RLSE_VER_NO)       AS O_QTA_RLSE_VER_NO
                                               ,NVL(B1.TRD_CD         , B2.TRD_CD)                AS O_TRD_CD
                                               ,NVL(B1.RLANE_CD       , B2.RLANE_CD)              AS O_RLANE_CD
                                               ,NVL(B1.SUB_TRD_CD     , B2.SUB_TRD_CD)            AS O_SUB_TRD_CD
                                               ,NVL(B1.IOC_CD         , B2.IOC_CD)                AS O_IOC_CD
                                               ,NVL(B1.DIR_CD         , B2.DIR_CD)                AS O_DIR_CD
                                               ,NVL(B1.BSE_MON        , SUBSTR(B2.YRMON, -2))     AS O_BSE_MON
                                               ,NVL(B1.BSE_WK         , B2.COST_WK)               AS O_BSE_WK
                                               ,NVL(B1.VSL_CD || B1.SKD_VOY_NO || B1.DIR_CD, B2.VSL_CD || B2.SKD_VOY_NO || B2.DIR_CD) AS O_VVD
                                           FROM (
                                                  SELECT 
                                                         V.QTA_RLSE_VER_NO
                                                        ,V.TRD_CD
                                                        ,V.DIR_CD
                                                        ,V.SUB_TRD_CD
                                                        ,V.RLANE_CD
                                                        ,V.BSE_YR
                                                        ,V.BSE_MON
                                                        ,V.BSE_WK
                                                        ,V.SLS_YRMON
                                                        ,V.VSL_CD
                                                        ,V.SKD_VOY_NO
                                                        ,V.FNL_BSA_CAPA
                                                        ,Q.LOD_QTY
                                                        ,Q.GRS_REV
                                                        ,V.IOC_CD
                                                        ,Q.SQM_CNG_TP_CD
                                                    FROM SQM_CFM_TGT_VVD V
                                                        ,(
                                                          SELECT QTA_RLSE_VER_NO
                                                                ,TRD_CD
                                                                ,RLANE_CD
                                                                ,DIR_CD
                                                                ,VSL_CD
                                                                ,SKD_VOY_NO
                                                                ,SKD_DIR_CD
                                                                ,SQM_CNG_TP_CD
                                                                ,SUM(LOD_QTY) AS LOD_QTY
                                                                ,ROUND(SUM(LOD_QTY*GRS_RPB_REV)) AS GRS_REV
                                                            FROM SQM_CFM_QTA
                                                           WHERE 1=1
                                                             AND QTA_RLSE_VER_NO = ( SELECT QTA_RLSE_VER_NO
                                                                                       FROM SQM_QTA_RLSE_VER
                                                                                      WHERE BSE_TP_CD      = @[f_bse_tp_cd]
                                                                                        AND BSE_YR         = @[f_bse_yr]
                                                                                        AND BSE_QTR_CD     = @[f_bse_qtr_cd]
                                                                                        AND SQM_VER_STS_CD = 'R' )
                                                             AND OFC_VW_CD       = 'L'
                    #if (${f_trd_cd} != '' && ${f_trd_cd} != 'All')
                                                             AND TRD_CD          = @[f_trd_cd]
                    #end
                    #if (${f_rlane_cd} != '' && ${f_rlane_cd} != 'All')
                                                             AND RLANE_CD        = @[f_rlane_cd]
                    #end
                    #if (${f_trd_dir} != 'on' && ${f_dir_cd} != '' && ${f_dir_cd} != 'All')
                                                             AND DIR_CD          = @[f_dir_cd]
                    #end
                                                           GROUP BY QTA_RLSE_VER_NO
                                                                   ,TRD_CD
                                                                   ,RLANE_CD
                                                                   ,DIR_CD
                                                                   ,VSL_CD
                                                                   ,SKD_VOY_NO
                                                                   ,SKD_DIR_CD
                                                                   ,SQM_CNG_TP_CD
                                                         ) Q
                                                   WHERE 1=1
                                                     AND V.QTA_RLSE_VER_NO = Q.QTA_RLSE_VER_NO(+)
                                                     AND V.TRD_CD          = Q.TRD_CD(+)
                                                     AND V.RLANE_CD        = Q.RLANE_CD(+)
                                                     AND V.DIR_CD          = Q.DIR_CD(+)
                                                     AND V.VSL_CD          = Q.VSL_CD(+)
                                                     AND V.SKD_VOY_NO      = Q.SKD_VOY_NO(+)
                                                     AND V.SKD_DIR_CD      = Q.SKD_DIR_CD(+)
                                                     AND V.QTA_RLSE_VER_NO = SUBSTR(@[f_bse_yr],-2) ||@[f_bse_qtr_cd]||'02'
                                                     AND V.BSE_TP_CD       = @[f_bse_tp_cd]
                                                     AND V.BSE_YR          = @[f_bse_yr]
                                                     AND V.BSE_QTR_CD      = @[f_bse_qtr_cd]
                    #if (${f_bse_wk} != '')
                                                     AND V.BSE_WK          = @[f_bse_wk]
                    #end
                    #if (${f_trd_cd} != '' && ${f_trd_cd} != 'All')
                                                     AND V.TRD_CD          = @[f_trd_cd]
                    #end
                    #if (${f_rlane_cd} != '' && ${f_rlane_cd} != 'All')
                                                     AND V.RLANE_CD        = @[f_rlane_cd]
                    #end
                    #if (${f_trd_dir} != 'on' && ${f_dir_cd} != '' && ${f_dir_cd} != 'All')
                                                     AND V.DIR_CD          = @[f_dir_cd]
                    #end
--                                                     AND 1 = CASE WHEN V.BSE_YR || v.BSE_QTR_CD > '20142Q'
--                                                                       THEN (SELECT NVL((
--                                                                                        SELECT DISTINCT 0
--                                                                                          FROM SQM_SCTR_PAIR_MGMT S1
--                                                                                         WHERE 1=1
--                                                                                           AND S1.BSE_TP_CD  = V.BSE_TP_CD
--                                                                                           AND S1.BSE_YR     = V.BSE_YR
--                                                                                           AND S1.BSE_QTR_CD = V.BSE_QTR_CD
--                                                                                           AND S1.TRD_CD     = V.TRD_CD
--                                                                                           AND S1.RLANE_CD   = V.RLANE_CD
--                                                                                           AND S1.DIR_CD     = V.DIR_CD
--                                                                                        ),1)
--                                                                            FROM DUAL)
--                                                                  ELSE 1
--                                                             END

                                                ) B1
                                                FULL OUTER JOIN
                                                (
                                                  SELECT 
                                                         A3.QTA_RLSE_VER_NO
                                                        ,A1.TRD_CD
                                                        ,A1.SUB_TRD_CD
                                                        ,A1.RLANE_CD
                                                        ,A1.DIR_CD
                                                        ,A1.VSL_CD
                                                        ,A1.SKD_VOY_NO
                                                        ,A1.COST_YRMON
                                                        ,DECODE(A3.BSE_YR, '2014', A1.SLS_YRMON, A1.COST_YRMON) YRMON
                                                        ,A1.COST_WK
                                                        ,A1.IOC_CD
                                                        ,ROUND(NVL(A2.FNL_HJS_BSA_CAPA, 0)) AS FNL_HJS_BSA_CAPA
                                                    FROM MAS_MON_VVD       A1
                                                        ,BSA_VVD_MST       A2
                                                        ,(
                                                           SELECT DISTINCT
                                                                  S1.QTA_RLSE_VER_NO
                                                                 ,S2.BSE_TP_CD
                                                                 ,S2.BSE_YR
                                                                 ,S2.BSE_QTR_CD
                                                                 ,S2.TRD_CD
                                                                 ,S2.RLANE_CD
                                                                 ,S2.DIR_CD
                                                             FROM SQM_QTA_RLSE_VER S1
                    #if (${f_cond_tp} == '1')
                                                                  -- 해당 분기의 LANE-OFFICE RELATION SETTING 한 노선의 정보를 걸어준다
                                                                  -- (2013년간 데이터를 제외한 모든 분기를 걸어주면됨 현재는 현재 분기와 미래 판매목표만 걸어주고 있음)
                                                                 ,SQM_QTA_LANE_OFC S2
                    #else
                                                                  -- 2013년도 데이터는  LANE-OFFICE RELATION SETTING 정보가 없기 때문에 TARGET VVD 정보를 걸어서 노선정보를 가져온다.
                                                                 ,SQM_CFM_TGT_VVD S2
                    #end
                                                            WHERE 1=1
                                                              AND S1.BSE_TP_CD      = S2.BSE_TP_CD
                                                              AND S1.BSE_YR         = S2.BSE_YR
                                                              AND S1.BSE_QTR_CD     = S2.BSE_QTR_CD
                                                              AND S1.SQM_VER_STS_CD = 'R'
                                                              AND S2.BSE_TP_CD      = @[f_bse_tp_cd]
                                                              AND S2.BSE_YR         = @[f_bse_yr]
                                                              AND S2.BSE_QTR_CD     = @[f_bse_qtr_cd]
                    #if (${f_cond_tp} == '1')
                                                              AND S2.OFC_VW_CD      = 'L'
                    #end
                    #if (${f_trd_cd} != '' && ${f_trd_cd} != 'All')
                                                              AND S2.TRD_CD         = @[f_trd_cd]
                    #end
                    #if (${f_rlane_cd} != '' && ${f_rlane_cd} != 'All')
                                                              AND S2.RLANE_CD       = @[f_rlane_cd]
                    #end
                    #if (${f_trd_dir} != 'on' && ${f_dir_cd} != '' && ${f_dir_cd} != 'All')
                                                              AND S2.DIR_CD         = @[f_dir_cd]
                    #end
--                                                              AND 1 = CASE WHEN S2.BSE_YR || S2.BSE_QTR_CD > '20142Q'
--                                                                                THEN (SELECT NVL((
--                                                                                                 SELECT 0
--                                                                                                   FROM SQM_SCTR_PAIR_MGMT X1
--                                                                                                  WHERE 1=1
--                                                                                                    AND X1.BSE_TP_CD  = S2.BSE_TP_CD
--                                                                                                    AND X1.BSE_YR     = S2.BSE_YR
--                                                                                                    AND X1.BSE_QTR_CD = S2.BSE_QTR_CD
--                                                                                                    AND X1.TRD_CD     = S2.TRD_CD
--                                                                                                    AND X1.RLANE_CD   = S2.RLANE_CD
--                                                                                                    AND X1.DIR_CD     = S2.DIR_CD
--                                                                                                 ),1)
--                                                                                     FROM DUAL)
--                                                                           ELSE 1
--                                                                      END
                                                          ) A3
                                                   WHERE A1.TRD_CD         = A2.TRD_CD     (+)
                                                     AND A1.RLANE_CD       = A2.RLANE_CD   (+)
                                                     AND A1.VSL_CD         = A2.VSL_CD     (+)
                                                     AND A1.SKD_VOY_NO     = A2.SKD_VOY_NO (+)
                                                     AND A1.DIR_CD         = A2.SKD_DIR_CD (+)
                                                     AND A1.IOC_CD         = A2.IOC_CD     (+)
                                                     AND A1.TRD_CD         = A3.TRD_CD
                                                     AND A1.RLANE_CD       = A3.RLANE_CD
                                                     AND A1.DIR_CD         = A3.DIR_CD
                    #if (${f_bse_wk} != '')
                                                     AND A1.COST_WK        = @[f_bse_wk]
                    #end
                                                     AND A1.DELT_FLG       = 'N'
                                                     AND A1.IOC_CD         = DECODE(A1.RLANE_CD, 'RBCCO', 'I', A1.IOC_CD) -- RBCCO 노선은 IOC_CD = 'I' 인것만
                                                     -- 2013년 : SLS_YRMON / 2014년 : Week / 2015년~ : COST_YRMON (COA 이행 데이터 기준이 다름)
                                                     AND CASE WHEN '2013' = A3.BSE_YR THEN A1.SLS_YRMON WHEN '2014' = A3.BSE_YR THEN SUBSTR(A1.SLS_YRMON, 1, 4)||A1.COST_WK ELSE A1.COST_YRMON END 
                                                         BETWEEN CASE WHEN '2014' = A3.BSE_YR THEN @[f_bse_yr]||@[f_fm_wk] ELSE @[f_bse_yr]||DECODE(@[f_bse_qtr_cd],'1Q','01','2Q','04','3Q','07','4Q','10') END 
                                                             AND CASE WHEN '2014' = A3.BSE_YR THEN @[f_bse_yr]||@[f_to_wk] ELSE @[f_bse_yr]||DECODE(@[f_bse_qtr_cd],'1Q','03','2Q','06','3Q','09','4Q','12') END 
                                                     AND NOT EXISTS ( SELECT 1
                                                                        FROM SQM_QTA_TGT_VVD S1
                                                                       WHERE S1.BSE_TP_CD  = @[f_bse_tp_cd]
                                                                         AND S1.BSE_YR     = @[f_bse_yr]
                                                                         AND S1.BSE_QTR_CD = @[f_bse_qtr_cd]
                                                                         AND S1.DELT_FLG   = 'Y'
                                                                         AND A1.TRD_CD     = S1.TRD_CD
                                                                         AND A1.RLANE_CD   = S1.RLANE_CD
                                                                         AND A1.VSL_CD     = S1.VSL_CD
                                                                         AND A1.SKD_VOY_NO = S1.SKD_VOY_NO
                                                                         AND A1.DIR_CD     = S1.DIR_CD
                                                                    )
                                                ) B2
                                             ON B1.QTA_RLSE_VER_NO = B2.QTA_RLSE_VER_NO
                                            AND B1.TRD_CD          = B2.TRD_CD
                                            AND B1.SUB_TRD_CD      = B2.SUB_TRD_CD
                                            AND B1.DIR_CD          = B2.DIR_CD
                                            AND B1.RLANE_CD        = B2.RLANE_CD
                                            AND B1.IOC_CD          = B2.IOC_CD
                                            AND B1.VSL_CD          = B2.VSL_CD
                                            AND B1.SKD_VOY_NO      = B2.SKD_VOY_NO
                                      )
                             GROUP BY O_QTA_RLSE_VER_NO
                                     ,O_TRD_CD
                                     ,O_RLANE_CD
                                     ,O_SUB_TRD_CD
                                     ,O_DIR_CD
                                     ,O_IOC_CD
                                     ,O_VVD
                             )A2
                    WHERE A1.TRD_CD         = A2.TRD_CD
                    AND A1.SUB_TRD_CD       = A2.SUB_TRD_CD
                    AND A1.RLANE_CD         = A2.RLANE_CD
                    AND A1.DIR_CD           = A2.DIR_CD
                    AND A1.IOC_CD           = A2.IOC_CD
                    #if (${f_portion_link} != '' && ${f_portion_link} != 'All')
                    AND DECODE(SQM_CNG_TP_CD, 'I', 'Y', 'N') = @[f_portion_link]
                    #end
                    #if (${f_trd_dir} == 'on' && ${f_hul_bnd_cd} != '' && ${f_hul_bnd_cd} != 'All')
                    AND A1.HUL_BND_CD               		 = @[f_hul_bnd_cd]
                    #end
                )
                WHERE TSRD NOT IN
                (
                    SELECT DISTINCT A2.TRD_CD||A2.SUB_TRD_CD||A2.RLANE_CD||A2.DIR_CD
                      FROM SQM_QTA_LANE_OFC A1
                          ,SQM_CFM_QTA_POTN_MGMT A2
                          ,SQM_DAT_RLT A3
                          ,MAS_LANE_RGST A4
                     WHERE 1=1
                       AND A2.TRD_CD       = A4.TRD_CD
                       AND A2.RLANE_CD     = A4.RLANE_CD
                       AND A2.DIR_CD       = A4.DIR_CD
                       AND A4.DELT_FLG     = 'N'

                       AND A2.BSE_TP_CD    = A3.BSE_TP_CD
                       AND A2.BSE_YR       = A3.BSE_YR
                       AND A2.BSE_QTR_CD   = A3.BSE_QTR_CD
                       AND A2.OFC_VW_CD    = A3.OFC_VW_CD
                       AND A2.TRD_CD       = A3.TRD_CD
                       AND A2.CONV_DIR_CD  = A3.CONV_DIR_CD
                       AND A2.RHQ_CD       = A3.RHQ_CD

                       AND A1.BSE_TP_CD    = A2.BSE_TP_CD
                       AND A1.BSE_YR       = A2.BSE_YR
                       AND A1.BSE_QTR_CD   = A2.BSE_QTR_CD
                       AND A1.OFC_VW_CD    = A2.OFC_VW_CD
                       AND A1.RHQ_CD       = A2.RHQ_CD
                       AND A1.TRD_CD       = A2.TRD_CD
                       AND A1.RLANE_CD     = A2.RLANE_CD
                       AND A1.DIR_CD       = A2.DIR_CD
                       AND A1.SQM_ACT_FLG  = 'Y'
                       AND A2.BSE_TP_CD    = @[f_bse_tp_cd]
                       AND A2.BSE_YR       = @[f_bse_yr]
                       AND A2.BSE_QTR_CD   = DECODE(@[f_bse_tp_cd], 'Y', '00', @[f_bse_qtr_cd])
                       AND A2.OFC_VW_CD    = 'L'
                       AND A2.QTA_STEP_CD  = '02'
                    #if (${f_trd_cd} != '' && ${f_trd_cd} != 'All')
                       AND A2.TRD_CD       = @[f_trd_cd]
                    #end
                    #if (${f_rlane_cd} != '' && ${f_rlane_cd} != 'All')
                       AND A2.RLANE_CD     = @[f_rlane_cd]
                    #end
                    #if (${f_click} != 'on' && ${f_conv_dir_cd} != '' && ${f_conv_dir_cd} != 'All')
                       AND A2.CONV_DIR_CD  = @[f_conv_dir_cd]
                    #end
                    #if (${f_click} == 'on' && ${f_trd_dir} != '' && ${f_trd_dir} != 'All')
                       AND A4.HUL_BND_CD  = @[f_trd_dir]
                    #end
                )
            )
        )
        ,PORTION_ADJUST_HO_CONTRACT AS
        (
            (
                SELECT TRD_CD, SUB_TRD_CD, RLANE_CD, DIR_CD, MIN(HO_APLY_FM_YRWK_CONTRACT) AS HO_APLY_FM_YRWK_CONTRACT, MAX(HO_APLY_TO_YRWK_CONTRACT) AS HO_APLY_TO_YRWK_CONTRACT 
                FROM
                (
                    SELECT A2.TRD_CD, A2.SUB_TRD_CD, A2.RLANE_CD, A2.DIR_CD, A2.APLY_FM_YRWK AS HO_APLY_FM_YRWK_CONTRACT, A2.APLY_TO_YRWK AS HO_APLY_TO_YRWK_CONTRACT
                      FROM SQM_QTA_LANE_OFC A1
                          ,SQM_CFM_QTA_POTN_MGMT A2
                          ,SQM_DAT_RLT A3
                          ,MAS_LANE_RGST A4
                     WHERE 1=1
                       AND A2.TRD_CD       = A4.TRD_CD
                       AND A2.RLANE_CD     = A4.RLANE_CD
                       AND A2.DIR_CD       = A4.DIR_CD
                       AND A4.DELT_FLG     = 'N'

                       AND A2.BSE_TP_CD    = A3.BSE_TP_CD
                       AND A2.BSE_YR       = A3.BSE_YR
                       AND A2.BSE_QTR_CD   = A3.BSE_QTR_CD
                       AND A2.OFC_VW_CD    = A3.OFC_VW_CD
                       AND A2.TRD_CD       = A3.TRD_CD
                       AND A2.CONV_DIR_CD  = A3.CONV_DIR_CD
                       AND A2.RHQ_CD       = A3.RHQ_CD

                       AND A1.BSE_TP_CD    = A2.BSE_TP_CD
                       AND A1.BSE_YR       = A2.BSE_YR
                       AND A1.BSE_QTR_CD   = A2.BSE_QTR_CD
                       AND A1.OFC_VW_CD    = A2.OFC_VW_CD
                       AND A1.RHQ_CD       = A2.RHQ_CD
                       AND A1.TRD_CD       = A2.TRD_CD
                       AND A1.RLANE_CD     = A2.RLANE_CD
                       AND A1.DIR_CD       = A2.DIR_CD
                       AND A1.SQM_ACT_FLG  = 'Y'
                       AND A2.BSE_TP_CD    = @[f_bse_tp_cd]
                       AND A2.BSE_YR       = @[f_bse_yr]
                       AND A2.BSE_QTR_CD   = DECODE(@[f_bse_tp_cd], 'Y', '00', @[f_bse_qtr_cd])
                       AND A2.OFC_VW_CD    = 'C'
                       AND A2.QTA_STEP_CD  = '02'
                    #if (${f_trd_cd} != '' && ${f_trd_cd} != 'All')
                       AND A2.TRD_CD       = @[f_trd_cd]
                    #end
                    #if (${f_rlane_cd} != '' && ${f_rlane_cd} != 'All')
                       AND A2.RLANE_CD     = @[f_rlane_cd]
                    #end
                    #if (${f_click} != 'on' && ${f_conv_dir_cd} != '' && ${f_conv_dir_cd} != 'All')
                       AND A2.CONV_DIR_CD  = @[f_conv_dir_cd]
                    #end
                    #if (${f_click} == 'on' && ${f_trd_dir} != '' && ${f_trd_dir} != 'All')
                       AND A4.HUL_BND_CD  = @[f_trd_dir]
                    #end
                        GROUP BY A2.TRD_CD, A2.SUB_TRD_CD, A2.RLANE_CD, A2.DIR_CD, A2.APLY_FM_YRWK, A2.APLY_TO_YRWK
                )
                GROUP BY TRD_CD , SUB_TRD_CD, RLANE_CD, DIR_CD
            )
            UNION ALL
            (
                SELECT TRD_CD, SUB_TRD_CD, RLANE_CD, DIR_CD, '999999' AS HO_APLY_FM_YRWK_CONTRACT, '999999' AS HO_APLY_TO_YRWK_CONTRACT
                FROM
                (
                    SELECT DISTINCT A2.TRD_CD, A2.SUB_TRD_CD, A2.RLANE_CD, A2.DIR_CD, A2.TRD_CD||A2.SUB_TRD_CD||A2.RLANE_CD||A2.DIR_CD AS TSRD
                        FROM MAS_LANE_RGST A1, 
                             (
                               SELECT O_QTA_RLSE_VER_NO  AS QTA_RLSE_VER_NO
                                     ,O_TRD_CD           AS TRD_CD
                                     ,O_RLANE_CD         AS RLANE_CD
                                     ,O_SUB_TRD_CD       AS SUB_TRD_CD
                                     ,O_DIR_CD           AS DIR_CD
                                     ,O_IOC_CD           AS IOC_CD
                                     ,O_VVD
                                     ,MAX(SLS_YR)        AS SLS_YR
                                     ,MAX(SLS_YRMON)     AS SLS_YRMON
                                     ,MAX(BSE_YR)        AS BSE_YR
                                     ,MAX(BSE_MON)       AS BSE_MON
                                     ,MAX(BSE_WK)        AS BSE_WK
                                     ,MAX(VVD)           AS VVD
                                     ,MAX(SQM_CNG_TP_CD) AS SQM_CNG_TP_CD
                                     ,MAX(FNL_BSA_CAPA)  AS FNL_BSA_CAPA
                                     ,MAX(LOD_QTY)       AS LOD_QTY
                                     ,MAX(GRS_REV)       AS GRS_REV
                                     ,MAX(CASE WHEN NVL(SQM_INFO, '*') = NVL(MAS_INFO, '*') THEN '' ELSE MAS_COST_YR             END) AS MAS_COST_YR
                                     ,MAX(CASE WHEN NVL(SQM_INFO, '*') = NVL(MAS_INFO, '*') THEN '' ELSE MAS_COST_YRMON          END) AS MAS_COST_YRMON
                                     ,MAX(CASE WHEN NVL(SQM_INFO, '*') = NVL(MAS_INFO, '*') THEN '' ELSE MAS_MON                END) AS MAS_BSE_MON
                                     ,MAX(CASE WHEN NVL(SQM_INFO, '*') = NVL(MAS_INFO, '*') THEN '' ELSE COST_WK                END) AS MAS_BSE_WK
                                     ,MAX(CASE WHEN NVL(SQM_INFO, '*') = NVL(MAS_INFO, '*') THEN '' ELSE MAS_VVD                END) AS MAS_VVD
                                     ,MAX(CASE WHEN NVL(SQM_INFO, '*') = NVL(MAS_INFO, '*') THEN '' ELSE FNL_HJS_BSA_CAPA || '' END) AS MAS_FNL_BSA_CAPA
                                     ,CASE WHEN MAX(SQM_INFO) = MAX(MAS_INFO) THEN 'R'
                                           WHEN NVL(MAX(SQM_INFO), '*') = '*' THEN 'I'
                                           WHEN NVL(MAX(MAS_INFO), '*') = '*' THEN 'D'
                                                                              ELSE 'U'
                                      END AS FLAG
                                     ,MAX(SQM_INFO) AS SQM_INFO
                                     ,MAX(MAS_INFO) AS MAS_INFO
                                 FROM (
                                         SELECT B1.QTA_RLSE_VER_NO
                                               ,B1.TRD_CD
                                               ,B1.DIR_CD
                                               ,B1.SUB_TRD_CD
                                               ,B1.RLANE_CD
                                               ,B1.BSE_YR
                                               ,B1.BSE_MON
                                               ,B1.BSE_WK
                                               ,B1.SLS_YRMON
                                               ,SUBSTR(B1.SLS_YRMON,0,4) AS SLS_YR
                                               ,B1.VSL_CD || B1.SKD_VOY_NO || B1.DIR_CD AS VVD
                                               ,B1.SQM_CNG_TP_CD
                                               ,B1.FNL_BSA_CAPA
                                               ,B1.LOD_QTY
                                               ,B1.GRS_REV
                                               ,B2.COST_YRMON AS MAS_COST_YRMON
                                               ,SUBSTR(B2.COST_YRMON,0,4) AS MAS_COST_YR
                                               ,SUBSTR(B2.YRMON, -2) AS MAS_MON
                                               ,B2.COST_WK
                                               ,B2.VSL_CD || B2.SKD_VOY_NO || B2.DIR_CD AS MAS_VVD
                                               ,B2.FNL_HJS_BSA_CAPA
                                               ,B1.TRD_CD || B1.SUB_TRD_CD || B1.RLANE_CD || B1.DIR_CD || B1.VSL_CD || B1.SKD_VOY_NO || B1.DIR_CD || B1.BSE_WK || B1.FNL_BSA_CAPA || B1.SLS_YRMON AS SQM_INFO
                                               ,B2.TRD_CD || B2.SUB_TRD_CD || B2.RLANE_CD || B2.DIR_CD || B2.VSL_CD || B2.SKD_VOY_NO || B2.DIR_CD || B2.COST_WK || B2.FNL_HJS_BSA_CAPA || B2.COST_YRMON AS MAS_INFO
                                               ,NVL(B1.QTA_RLSE_VER_NO, B2.QTA_RLSE_VER_NO)       AS O_QTA_RLSE_VER_NO
                                               ,NVL(B1.TRD_CD         , B2.TRD_CD)                AS O_TRD_CD
                                               ,NVL(B1.RLANE_CD       , B2.RLANE_CD)              AS O_RLANE_CD
                                               ,NVL(B1.SUB_TRD_CD     , B2.SUB_TRD_CD)            AS O_SUB_TRD_CD
                                               ,NVL(B1.IOC_CD         , B2.IOC_CD)                AS O_IOC_CD
                                               ,NVL(B1.DIR_CD         , B2.DIR_CD)                AS O_DIR_CD
                                               ,NVL(B1.BSE_MON        , SUBSTR(B2.YRMON, -2))     AS O_BSE_MON
                                               ,NVL(B1.BSE_WK         , B2.COST_WK)               AS O_BSE_WK
                                               ,NVL(B1.VSL_CD || B1.SKD_VOY_NO || B1.DIR_CD, B2.VSL_CD || B2.SKD_VOY_NO || B2.DIR_CD) AS O_VVD
                                           FROM (
                                                  SELECT 
                                                         V.QTA_RLSE_VER_NO
                                                        ,V.TRD_CD
                                                        ,V.DIR_CD
                                                        ,V.SUB_TRD_CD
                                                        ,V.RLANE_CD
                                                        ,V.BSE_YR
                                                        ,V.BSE_MON
                                                        ,V.BSE_WK
                                                        ,V.SLS_YRMON
                                                        ,V.VSL_CD
                                                        ,V.SKD_VOY_NO
                                                        ,V.FNL_BSA_CAPA
                                                        ,Q.LOD_QTY
                                                        ,Q.GRS_REV
                                                        ,V.IOC_CD
                                                        ,Q.SQM_CNG_TP_CD
                                                    FROM SQM_CFM_TGT_VVD V
                                                        ,(
                                                          SELECT QTA_RLSE_VER_NO
                                                                ,TRD_CD
                                                                ,RLANE_CD
                                                                ,DIR_CD
                                                                ,VSL_CD
                                                                ,SKD_VOY_NO
                                                                ,SKD_DIR_CD
                                                                ,SQM_CNG_TP_CD
                                                                ,SUM(LOD_QTY) AS LOD_QTY
                                                                ,ROUND(SUM(LOD_QTY*GRS_RPB_REV)) AS GRS_REV
                                                            FROM SQM_CFM_QTA
                                                           WHERE 1=1
                                                             AND QTA_RLSE_VER_NO = ( SELECT QTA_RLSE_VER_NO
                                                                                       FROM SQM_QTA_RLSE_VER
                                                                                      WHERE BSE_TP_CD      = @[f_bse_tp_cd]
                                                                                        AND BSE_YR         = @[f_bse_yr]
                                                                                        AND BSE_QTR_CD     = @[f_bse_qtr_cd]
                                                                                        AND SQM_VER_STS_CD = 'R' )
                                                             AND OFC_VW_CD       = 'L'
                    #if (${f_trd_cd} != '' && ${f_trd_cd} != 'All')
                                                             AND TRD_CD          = @[f_trd_cd]
                    #end
                    #if (${f_rlane_cd} != '' && ${f_rlane_cd} != 'All')
                                                             AND RLANE_CD        = @[f_rlane_cd]
                    #end
                    #if (${f_trd_dir} != 'on' && ${f_dir_cd} != '' && ${f_dir_cd} != 'All')
                                                             AND DIR_CD          = @[f_dir_cd]
                    #end
                                                           GROUP BY QTA_RLSE_VER_NO
                                                                   ,TRD_CD
                                                                   ,RLANE_CD
                                                                   ,DIR_CD
                                                                   ,VSL_CD
                                                                   ,SKD_VOY_NO
                                                                   ,SKD_DIR_CD
                                                                   ,SQM_CNG_TP_CD
                                                         ) Q
                                                   WHERE 1=1
                                                     AND V.QTA_RLSE_VER_NO = Q.QTA_RLSE_VER_NO(+)
                                                     AND V.TRD_CD          = Q.TRD_CD(+)
                                                     AND V.RLANE_CD        = Q.RLANE_CD(+)
                                                     AND V.DIR_CD          = Q.DIR_CD(+)
                                                     AND V.VSL_CD          = Q.VSL_CD(+)
                                                     AND V.SKD_VOY_NO      = Q.SKD_VOY_NO(+)
                                                     AND V.SKD_DIR_CD      = Q.SKD_DIR_CD(+)
                                                     AND V.QTA_RLSE_VER_NO = SUBSTR(@[f_bse_yr],-2) ||@[f_bse_qtr_cd]||'02'
                                                     AND V.BSE_TP_CD       = @[f_bse_tp_cd]
                                                     AND V.BSE_YR          = @[f_bse_yr]
                                                     AND V.BSE_QTR_CD      = @[f_bse_qtr_cd]
                    #if (${f_bse_wk} != '')
                                                     AND V.BSE_WK          = @[f_bse_wk]
                    #end
                    #if (${f_trd_cd} != '' && ${f_trd_cd} != 'All')
                                                     AND V.TRD_CD          = @[f_trd_cd]
                    #end
                    #if (${f_rlane_cd} != '' && ${f_rlane_cd} != 'All')
                                                     AND V.RLANE_CD        = @[f_rlane_cd]
                    #end
                    #if (${f_trd_dir} != 'on' && ${f_dir_cd} != '' && ${f_dir_cd} != 'All')
                                                     AND V.DIR_CD          = @[f_dir_cd]
                    #end
--                                                     AND 1 = CASE WHEN V.BSE_YR || v.BSE_QTR_CD > '20142Q'
--                                                                       THEN (SELECT NVL((
--                                                                                        SELECT DISTINCT 0
--                                                                                          FROM SQM_SCTR_PAIR_MGMT S1
--                                                                                         WHERE 1=1
--                                                                                           AND S1.BSE_TP_CD  = V.BSE_TP_CD
--                                                                                           AND S1.BSE_YR     = V.BSE_YR
--                                                                                           AND S1.BSE_QTR_CD = V.BSE_QTR_CD
--                                                                                           AND S1.TRD_CD     = V.TRD_CD
--                                                                                           AND S1.RLANE_CD   = V.RLANE_CD
--                                                                                           AND S1.DIR_CD     = V.DIR_CD
--                                                                                        ),1)
--                                                                            FROM DUAL)
--                                                                  ELSE 1
--                                                             END

                                                ) B1
                                                FULL OUTER JOIN
                                                (
                                                  SELECT 
                                                         A3.QTA_RLSE_VER_NO
                                                        ,A1.TRD_CD
                                                        ,A1.SUB_TRD_CD
                                                        ,A1.RLANE_CD
                                                        ,A1.DIR_CD
                                                        ,A1.VSL_CD
                                                        ,A1.SKD_VOY_NO
                                                        ,A1.COST_YRMON
                                                        ,DECODE(A3.BSE_YR, '2014', A1.SLS_YRMON, A1.COST_YRMON) YRMON
                                                        ,A1.COST_WK
                                                        ,A1.IOC_CD
                                                        ,ROUND(NVL(A2.FNL_HJS_BSA_CAPA, 0)) AS FNL_HJS_BSA_CAPA
                                                    FROM MAS_MON_VVD       A1
                                                        ,BSA_VVD_MST       A2
                                                        ,(
                                                           SELECT DISTINCT
                                                                  S1.QTA_RLSE_VER_NO
                                                                 ,S2.BSE_TP_CD
                                                                 ,S2.BSE_YR
                                                                 ,S2.BSE_QTR_CD
                                                                 ,S2.TRD_CD
                                                                 ,S2.RLANE_CD
                                                                 ,S2.DIR_CD
                                                             FROM SQM_QTA_RLSE_VER S1
                    #if (${f_cond_tp} == '1')
                                                                  -- 해당 분기의 LANE-OFFICE RELATION SETTING 한 노선의 정보를 걸어준다
                                                                  -- (2013년간 데이터를 제외한 모든 분기를 걸어주면됨 현재는 현재 분기와 미래 판매목표만 걸어주고 있음)
                                                                 ,SQM_QTA_LANE_OFC S2
                    #else
                                                                  -- 2013년도 데이터는  LANE-OFFICE RELATION SETTING 정보가 없기 때문에 TARGET VVD 정보를 걸어서 노선정보를 가져온다.
                                                                 ,SQM_CFM_TGT_VVD S2
                    #end
                                                            WHERE 1=1
                                                              AND S1.BSE_TP_CD      = S2.BSE_TP_CD
                                                              AND S1.BSE_YR         = S2.BSE_YR
                                                              AND S1.BSE_QTR_CD     = S2.BSE_QTR_CD
                                                              AND S1.SQM_VER_STS_CD = 'R'
                                                              AND S2.BSE_TP_CD      = @[f_bse_tp_cd]
                                                              AND S2.BSE_YR         = @[f_bse_yr]
                                                              AND S2.BSE_QTR_CD     = @[f_bse_qtr_cd]
                    #if (${f_cond_tp} == '1')
                                                              AND S2.OFC_VW_CD      = 'L'
                    #end
                    #if (${f_trd_cd} != '' && ${f_trd_cd} != 'All')
                                                              AND S2.TRD_CD         = @[f_trd_cd]
                    #end
                    #if (${f_rlane_cd} != '' && ${f_rlane_cd} != 'All')
                                                              AND S2.RLANE_CD       = @[f_rlane_cd]
                    #end
                    #if (${f_trd_dir} != 'on' && ${f_dir_cd} != '' && ${f_dir_cd} != 'All')
                                                              AND S2.DIR_CD         = @[f_dir_cd]
                    #end
--                                                              AND 1 = CASE WHEN S2.BSE_YR || S2.BSE_QTR_CD > '20142Q'
--                                                                                THEN (SELECT NVL((
--                                                                                                 SELECT 0
--                                                                                                   FROM SQM_SCTR_PAIR_MGMT X1
--                                                                                                  WHERE 1=1
--                                                                                                    AND X1.BSE_TP_CD  = S2.BSE_TP_CD
--                                                                                                    AND X1.BSE_YR     = S2.BSE_YR
--                                                                                                    AND X1.BSE_QTR_CD = S2.BSE_QTR_CD
--                                                                                                    AND X1.TRD_CD     = S2.TRD_CD
--                                                                                                    AND X1.RLANE_CD   = S2.RLANE_CD
--                                                                                                    AND X1.DIR_CD     = S2.DIR_CD
--                                                                                                 ),1)
--                                                                                     FROM DUAL)
--                                                                           ELSE 1
--                                                                      END
                                                          ) A3
                                                   WHERE A1.TRD_CD         = A2.TRD_CD     (+)
                                                     AND A1.RLANE_CD       = A2.RLANE_CD   (+)
                                                     AND A1.VSL_CD         = A2.VSL_CD     (+)
                                                     AND A1.SKD_VOY_NO     = A2.SKD_VOY_NO (+)
                                                     AND A1.DIR_CD         = A2.SKD_DIR_CD (+)
                                                     AND A1.IOC_CD         = A2.IOC_CD     (+)
                                                     AND A1.TRD_CD         = A3.TRD_CD
                                                     AND A1.RLANE_CD       = A3.RLANE_CD
                                                     AND A1.DIR_CD         = A3.DIR_CD
                    #if (${f_bse_wk} != '')
                                                     AND A1.COST_WK        = @[f_bse_wk]
                    #end
                                                     AND A1.DELT_FLG       = 'N'
                                                     AND A1.IOC_CD         = DECODE(A1.RLANE_CD, 'RBCCO', 'I', A1.IOC_CD) -- RBCCO 노선은 IOC_CD = 'I' 인것만
                                                     -- 2013년 : SLS_YRMON / 2014년 : Week / 2015년~ : COST_YRMON (COA 이행 데이터 기준이 다름)
                                                     AND CASE WHEN '2013' = A3.BSE_YR THEN A1.SLS_YRMON WHEN '2014' = A3.BSE_YR THEN SUBSTR(A1.SLS_YRMON, 1, 4)||A1.COST_WK ELSE A1.COST_YRMON END 
                                                         BETWEEN CASE WHEN '2014' = A3.BSE_YR THEN @[f_bse_yr]||@[f_fm_wk] ELSE @[f_bse_yr]||DECODE(@[f_bse_qtr_cd],'1Q','01','2Q','04','3Q','07','4Q','10') END 
                                                             AND CASE WHEN '2014' = A3.BSE_YR THEN @[f_bse_yr]||@[f_to_wk] ELSE @[f_bse_yr]||DECODE(@[f_bse_qtr_cd],'1Q','03','2Q','06','3Q','09','4Q','12') END 
                                                     AND NOT EXISTS ( SELECT 1
                                                                        FROM SQM_QTA_TGT_VVD S1
                                                                       WHERE S1.BSE_TP_CD  = @[f_bse_tp_cd]
                                                                         AND S1.BSE_YR     = @[f_bse_yr]
                                                                         AND S1.BSE_QTR_CD = @[f_bse_qtr_cd]
                                                                         AND S1.DELT_FLG   = 'Y'
                                                                         AND A1.TRD_CD     = S1.TRD_CD
                                                                         AND A1.RLANE_CD   = S1.RLANE_CD
                                                                         AND A1.VSL_CD     = S1.VSL_CD
                                                                         AND A1.SKD_VOY_NO = S1.SKD_VOY_NO
                                                                         AND A1.DIR_CD     = S1.DIR_CD
                                                                    )
                                                ) B2
                                             ON B1.QTA_RLSE_VER_NO = B2.QTA_RLSE_VER_NO
                                            AND B1.TRD_CD          = B2.TRD_CD
                                            AND B1.SUB_TRD_CD      = B2.SUB_TRD_CD
                                            AND B1.DIR_CD          = B2.DIR_CD
                                            AND B1.RLANE_CD        = B2.RLANE_CD
                                            AND B1.IOC_CD          = B2.IOC_CD
                                            AND B1.VSL_CD          = B2.VSL_CD
                                            AND B1.SKD_VOY_NO      = B2.SKD_VOY_NO
                                      )
                             GROUP BY O_QTA_RLSE_VER_NO
                                     ,O_TRD_CD
                                     ,O_RLANE_CD
                                     ,O_SUB_TRD_CD
                                     ,O_DIR_CD
                                     ,O_IOC_CD
                                     ,O_VVD
                             )A2
                    WHERE A1.TRD_CD         = A2.TRD_CD
                    AND A1.SUB_TRD_CD       = A2.SUB_TRD_CD
                    AND A1.RLANE_CD         = A2.RLANE_CD
                    AND A1.DIR_CD           = A2.DIR_CD
                    AND A1.IOC_CD           = A2.IOC_CD
                    #if (${f_portion_link} != '' && ${f_portion_link} != 'All')
                    AND DECODE(SQM_CNG_TP_CD, 'I', 'Y', 'N') = @[f_portion_link]
                    #end
                    #if (${f_trd_dir} == 'on' && ${f_hul_bnd_cd} != '' && ${f_hul_bnd_cd} != 'All')
                    AND A1.HUL_BND_CD               		 = @[f_hul_bnd_cd]
                    #end
                )
                WHERE TSRD NOT IN
                (
                    SELECT DISTINCT A2.TRD_CD||A2.SUB_TRD_CD||A2.RLANE_CD||A2.DIR_CD
                      FROM SQM_QTA_LANE_OFC A1
                          ,SQM_CFM_QTA_POTN_MGMT A2
                          ,SQM_DAT_RLT A3
                          ,MAS_LANE_RGST A4
                     WHERE 1=1
                       AND A2.TRD_CD       = A4.TRD_CD
                       AND A2.RLANE_CD     = A4.RLANE_CD
                       AND A2.DIR_CD       = A4.DIR_CD
                       AND A4.DELT_FLG     = 'N'

                       AND A2.BSE_TP_CD    = A3.BSE_TP_CD
                       AND A2.BSE_YR       = A3.BSE_YR
                       AND A2.BSE_QTR_CD   = A3.BSE_QTR_CD
                       AND A2.OFC_VW_CD    = A3.OFC_VW_CD
                       AND A2.TRD_CD       = A3.TRD_CD
                       AND A2.CONV_DIR_CD  = A3.CONV_DIR_CD
                       AND A2.RHQ_CD       = A3.RHQ_CD

                       AND A1.BSE_TP_CD    = A2.BSE_TP_CD
                       AND A1.BSE_YR       = A2.BSE_YR
                       AND A1.BSE_QTR_CD   = A2.BSE_QTR_CD
                       AND A1.OFC_VW_CD    = A2.OFC_VW_CD
                       AND A1.RHQ_CD       = A2.RHQ_CD
                       AND A1.TRD_CD       = A2.TRD_CD
                       AND A1.RLANE_CD     = A2.RLANE_CD
                       AND A1.DIR_CD       = A2.DIR_CD
                       AND A1.SQM_ACT_FLG  = 'Y'
                       AND A2.BSE_TP_CD    = @[f_bse_tp_cd]
                       AND A2.BSE_YR       = @[f_bse_yr]
                       AND A2.BSE_QTR_CD   = DECODE(@[f_bse_tp_cd], 'Y', '00', @[f_bse_qtr_cd])
                       AND A2.OFC_VW_CD    = 'C'
                       AND A2.QTA_STEP_CD  = '02'
                    #if (${f_trd_cd} != '' && ${f_trd_cd} != 'All')
                       AND A2.TRD_CD       = @[f_trd_cd]
                    #end
                    #if (${f_rlane_cd} != '' && ${f_rlane_cd} != 'All')
                       AND A2.RLANE_CD     = @[f_rlane_cd]
                    #end
                    #if (${f_click} != 'on' && ${f_conv_dir_cd} != '' && ${f_conv_dir_cd} != 'All')
                       AND A2.CONV_DIR_CD  = @[f_conv_dir_cd]
                    #end
                    #if (${f_click} == 'on' && ${f_trd_dir} != '' && ${f_trd_dir} != 'All')
                       AND A4.HUL_BND_CD  = @[f_trd_dir]
                    #end
                )
            )
        )   

        SELECT CASE
                    WHEN BSE_WK IN ('00', '53')
                    THEN
                        (
                        CASE
                            WHEN NVL((SELECT SUBSTR(MMV.COST_YRMON, 1, 4) FROM MAS_MON_VVD MMV WHERE MMV.TRD_CD = A2.TRD_CD AND MMV.RLANE_CD = A2.RLANE_CD AND MMV.VSL_CD = SUBSTR(A2.VVD,1,4) AND MMV.SKD_VOY_NO = SUBSTR(A2.VVD,5,8) AND MMV.DIR_CD = SUBSTR(A2.VVD,9,9)),SLS_YR) = SUBSTR(HO_APLY_FM_YRWK_LOADING,1,4)  -- HO FROM YEAR 비교
                            THEN 
                                (
                                    CASE 
                                        WHEN NVL((SELECT SUBSTR(MMV.COST_YRMON, 1, 4) FROM MAS_MON_VVD MMV WHERE MMV.TRD_CD = A2.TRD_CD AND MMV.RLANE_CD = A2.RLANE_CD AND MMV.VSL_CD = SUBSTR(A2.VVD,1,4) AND MMV.SKD_VOY_NO = SUBSTR(A2.VVD,5,8) AND MMV.DIR_CD = SUBSTR(A2.VVD,9,9)),SLS_YR) = SUBSTR(HO_APLY_TO_YRWK_LOADING,1,4) -- HO TO YEAR 비교
                                        THEN 
                                            (
                                                CASE 
                                                  WHEN BSE_WK >= SUBSTR(HO_APLY_FM_YRWK_LOADING,5) -- HO FROM WEEK 비교
                                                  THEN 
                                                    (
                                                        CASE
                                                            WHEN BSE_WK <= SUBSTR(HO_APLY_TO_YRWK_LOADING,5) -- HO TO WEEK 비교
                                                            THEN 'SAME'
                                                            ELSE 'DIFFERENT!'||HL.TRD_CD||'!'||HL.SUB_TRD_CD||'!'||HL.RLANE_CD||'!'||HL.DIR_CD||'!'||BSE_WK
                                                        END
                                                    )
                                                  ELSE 'DIFFERENT!'||HL.TRD_CD||'!'||HL.SUB_TRD_CD||'!'||HL.RLANE_CD||'!'||HL.DIR_CD||'!'||BSE_WK
                                                END
                                            )
                                        ELSE 'DIFFERENT!'||HL.TRD_CD||'!'||HL.SUB_TRD_CD||'!'||HL.RLANE_CD||'!'||HL.DIR_CD||'!'||BSE_WK
                                    END
                                )
                            WHEN NVL((SELECT SUBSTR(MMV.COST_YRMON, 1, 4) FROM MAS_MON_VVD MMV WHERE MMV.TRD_CD = A2.TRD_CD AND MMV.RLANE_CD = A2.RLANE_CD AND MMV.VSL_CD = SUBSTR(A2.VVD,1,4) AND MMV.SKD_VOY_NO = SUBSTR(A2.VVD,5,8) AND MMV.DIR_CD = SUBSTR(A2.VVD,9,9)),SLS_YR) > SUBSTR(HO_APLY_FM_YRWK_LOADING,1,4)  
                            THEN 'SAME'
                            WHEN NVL((SELECT SUBSTR(MMV.COST_YRMON, 1, 4) FROM MAS_MON_VVD MMV WHERE MMV.TRD_CD = A2.TRD_CD AND MMV.RLANE_CD = A2.RLANE_CD AND MMV.VSL_CD = SUBSTR(A2.VVD,1,4) AND MMV.SKD_VOY_NO = SUBSTR(A2.VVD,5,8) AND MMV.DIR_CD = SUBSTR(A2.VVD,9,9)),SLS_YR) < SUBSTR(HO_APLY_FM_YRWK_LOADING,1,4)
                            THEN 'DIFFERENT!'||HL.TRD_CD||'!'||HL.SUB_TRD_CD||'!'||HL.RLANE_CD||'!'||HL.DIR_CD||'!'||BSE_WK  
                        END
                        )
                    WHEN SLS_YR = SUBSTR(HO_APLY_FM_YRWK_LOADING,1,4)  -- HO FROM YEAR 비교
                    THEN 
                        (
                            CASE 
                                WHEN SLS_YR = SUBSTR(HO_APLY_TO_YRWK_LOADING,1,4) -- HO TO YEAR 비교
                                THEN 
                                    (
                                        CASE 
                                          WHEN BSE_WK >= SUBSTR(HO_APLY_FM_YRWK_LOADING,5) -- HO FROM WEEK 비교
                                          THEN 
                                            (
                                                CASE
                                                    WHEN BSE_WK <= SUBSTR(HO_APLY_TO_YRWK_LOADING,5) -- HO TO WEEK 비교
                                                    THEN 'SAME'
                                                    ELSE 'DIFFERENT!'||HL.TRD_CD||'!'||HL.SUB_TRD_CD||'!'||HL.RLANE_CD||'!'||HL.DIR_CD||'!'||BSE_WK
                                                END
                                            )
                                          ELSE 'DIFFERENT!'||HL.TRD_CD||'!'||HL.SUB_TRD_CD||'!'||HL.RLANE_CD||'!'||HL.DIR_CD||'!'||BSE_WK
                                        END
                                    )
                                ELSE 'DIFFERENT!'||HL.TRD_CD||'!'||HL.SUB_TRD_CD||'!'||HL.RLANE_CD||'!'||HL.DIR_CD||'!'||BSE_WK
                            END
                        )
                    WHEN SLS_YR > SUBSTR(HO_APLY_FM_YRWK_LOADING,1,4)  
                    THEN 'SAME'
                    WHEN SLS_YR < SUBSTR(HO_APLY_FM_YRWK_LOADING,1,4)
                    THEN 'DIFFERENT!'||HL.TRD_CD||'!'||HL.SUB_TRD_CD||'!'||HL.RLANE_CD||'!'||HL.DIR_CD||'!'||BSE_WK
                    END AS COMPARISON_WITH_HO_LOADING    
               ,CASE
                    WHEN BSE_WK IN ('00', '53')
                    THEN
                        (
                        CASE
                            WHEN NVL((SELECT SUBSTR(MMV.COST_YRMON, 1, 4) FROM MAS_MON_VVD MMV WHERE MMV.TRD_CD = A2.TRD_CD AND MMV.RLANE_CD = A2.RLANE_CD AND MMV.VSL_CD = SUBSTR(A2.VVD,1,4) AND MMV.SKD_VOY_NO = SUBSTR(A2.VVD,5,8) AND MMV.DIR_CD = SUBSTR(A2.VVD,9,9)),SLS_YR) = SUBSTR(HO_APLY_FM_YRWK_CONTRACT,1,4)  -- HO FROM YEAR 비교
                            THEN 
                                (
                                    CASE 
                                        WHEN NVL((SELECT SUBSTR(MMV.COST_YRMON, 1, 4) FROM MAS_MON_VVD MMV WHERE MMV.TRD_CD = A2.TRD_CD AND MMV.RLANE_CD = A2.RLANE_CD AND MMV.VSL_CD = SUBSTR(A2.VVD,1,4) AND MMV.SKD_VOY_NO = SUBSTR(A2.VVD,5,8) AND MMV.DIR_CD = SUBSTR(A2.VVD,9,9)),SLS_YR) = SUBSTR(HO_APLY_TO_YRWK_CONTRACT,1,4) -- HO TO YEAR 비교
                                        THEN 
                                            (
                                                CASE 
                                                  WHEN BSE_WK >= SUBSTR(HO_APLY_FM_YRWK_CONTRACT,5) -- HO FROM WEEK 비교
                                                  THEN 
                                                    (
                                                        CASE
                                                            WHEN BSE_WK <= SUBSTR(HO_APLY_TO_YRWK_CONTRACT,5) -- HO TO WEEK 비교
                                                            THEN 'SAME'
                                                            ELSE 'DIFFERENT!'||HC.TRD_CD||'!'||HC.SUB_TRD_CD||'!'||HC.RLANE_CD||'!'||HC.DIR_CD||'!'||BSE_WK
                                                        END
                                                    )
                                                  ELSE 'DIFFERENT!'||HC.TRD_CD||'!'||HC.SUB_TRD_CD||'!'||HC.RLANE_CD||'!'||HC.DIR_CD||'!'||BSE_WK
                                                END
                                            )
                                        ELSE 'DIFFERENT!'||HC.TRD_CD||'!'||HC.SUB_TRD_CD||'!'||HC.RLANE_CD||'!'||HC.DIR_CD||'!'||BSE_WK
                                    END
                                )
                            WHEN NVL((SELECT SUBSTR(MMV.COST_YRMON, 1, 4) FROM MAS_MON_VVD MMV WHERE MMV.TRD_CD = A2.TRD_CD AND MMV.RLANE_CD = A2.RLANE_CD AND MMV.VSL_CD = SUBSTR(A2.VVD,1,4) AND MMV.SKD_VOY_NO = SUBSTR(A2.VVD,5,8) AND MMV.DIR_CD = SUBSTR(A2.VVD,9,9)),SLS_YR) > SUBSTR(HO_APLY_FM_YRWK_CONTRACT,1,4)  
                            THEN 'SAME'
                            WHEN NVL((SELECT SUBSTR(MMV.COST_YRMON, 1, 4) FROM MAS_MON_VVD MMV WHERE MMV.TRD_CD = A2.TRD_CD AND MMV.RLANE_CD = A2.RLANE_CD AND MMV.VSL_CD = SUBSTR(A2.VVD,1,4) AND MMV.SKD_VOY_NO = SUBSTR(A2.VVD,5,8) AND MMV.DIR_CD = SUBSTR(A2.VVD,9,9)),SLS_YR) < SUBSTR(HO_APLY_FM_YRWK_CONTRACT,1,4)  
                            THEN 'DIFFERENT!'||HC.TRD_CD||'!'||HC.SUB_TRD_CD||'!'||HC.RLANE_CD||'!'||HC.DIR_CD||'!'||BSE_WK
                        END
                        )
                    WHEN SLS_YR = SUBSTR(HO_APLY_FM_YRWK_CONTRACT,1,4)  -- HO FROM YEAR 비교
                    THEN 
                        (
                            CASE 
                                WHEN SLS_YR = SUBSTR(HO_APLY_TO_YRWK_CONTRACT,1,4) -- HO TO YEAR 비교
                                THEN 
                                    (
                                        CASE 
                                          WHEN BSE_WK >= SUBSTR(HO_APLY_FM_YRWK_CONTRACT,5) -- HO FROM WEEK 비교
                                          THEN 
                                            (
                                                CASE
                                                    WHEN BSE_WK <= SUBSTR(HO_APLY_TO_YRWK_CONTRACT,5) -- HO TO WEEK 비교
                                                    THEN 'SAME'
                                                    ELSE 'DIFFERENT!'||HC.TRD_CD||'!'||HC.SUB_TRD_CD||'!'||HC.RLANE_CD||'!'||HC.DIR_CD||'!'||BSE_WK
                                                END
                                            )
                                          ELSE 'DIFFERENT!'||HC.TRD_CD||'!'||HC.SUB_TRD_CD||'!'||HC.RLANE_CD||'!'||HC.DIR_CD||'!'||BSE_WK
                                        END
                                    )
                                ELSE 'DIFFERENT!'||HC.TRD_CD||'!'||HC.SUB_TRD_CD||'!'||HC.RLANE_CD||'!'||HC.DIR_CD||'!'||BSE_WK
                            END
                        )
                    WHEN SLS_YR > SUBSTR(HO_APLY_FM_YRWK_CONTRACT,1,4)  
                    THEN 'SAME'
                    WHEN SLS_YR < SUBSTR(HO_APLY_FM_YRWK_CONTRACT,1,4)  
                    THEN 'DIFFERENT!'||HC.TRD_CD||'!'||HC.SUB_TRD_CD||'!'||HC.RLANE_CD||'!'||HC.DIR_CD||'!'||BSE_WK
                    END AS COMPARISON_WITH_HO_CONTRACT
            
            FROM MAS_LANE_RGST A1, 
                 (
                   SELECT O_QTA_RLSE_VER_NO  AS QTA_RLSE_VER_NO
                         ,O_TRD_CD           AS TRD_CD
                         ,O_RLANE_CD         AS RLANE_CD
                         ,O_SUB_TRD_CD       AS SUB_TRD_CD
                         ,O_DIR_CD           AS DIR_CD
                         ,O_IOC_CD           AS IOC_CD
                         ,O_VVD
                         ,MAX(SLS_YR)        AS SLS_YR
                         ,MAX(SLS_YRMON)     AS SLS_YRMON
                         ,MAX(BSE_YR)        AS BSE_YR
                         ,MAX(BSE_MON)       AS BSE_MON
                         ,MAX(BSE_WK)        AS BSE_WK
                         ,MAX(VVD)           AS VVD
                         ,MAX(SQM_CNG_TP_CD) AS SQM_CNG_TP_CD
                         ,MAX(FNL_BSA_CAPA)  AS FNL_BSA_CAPA
                         ,MAX(LOD_QTY)       AS LOD_QTY
                         ,MAX(GRS_REV)       AS GRS_REV
                         ,MAX(CASE WHEN NVL(SQM_INFO, '*') = NVL(MAS_INFO, '*') THEN '' ELSE MAS_COST_YR             END) AS MAS_COST_YR
                         ,MAX(CASE WHEN NVL(SQM_INFO, '*') = NVL(MAS_INFO, '*') THEN '' ELSE MAS_COST_YRMON          END) AS MAS_COST_YRMON
                         ,MAX(CASE WHEN NVL(SQM_INFO, '*') = NVL(MAS_INFO, '*') THEN '' ELSE MAS_MON                END) AS MAS_BSE_MON
                         ,MAX(CASE WHEN NVL(SQM_INFO, '*') = NVL(MAS_INFO, '*') THEN '' ELSE COST_WK                END) AS MAS_BSE_WK
                         ,MAX(CASE WHEN NVL(SQM_INFO, '*') = NVL(MAS_INFO, '*') THEN '' ELSE MAS_VVD                END) AS MAS_VVD
                         ,MAX(CASE WHEN NVL(SQM_INFO, '*') = NVL(MAS_INFO, '*') THEN '' ELSE FNL_HJS_BSA_CAPA || '' END) AS MAS_FNL_BSA_CAPA
                         ,CASE WHEN MAX(SQM_INFO) = MAX(MAS_INFO) THEN 'R'
                               WHEN NVL(MAX(SQM_INFO), '*') = '*' THEN 'I'
                               WHEN NVL(MAX(MAS_INFO), '*') = '*' THEN 'D'
                                                                  ELSE 'U'
                          END AS FLAG
                         ,MAX(SQM_INFO) AS SQM_INFO
                         ,MAX(MAS_INFO) AS MAS_INFO
                     FROM (
                             SELECT B1.QTA_RLSE_VER_NO
                                   ,B1.TRD_CD
                                   ,B1.DIR_CD
                                   ,B1.SUB_TRD_CD
                                   ,B1.RLANE_CD
                                   ,B1.BSE_YR
                                   ,B1.BSE_MON
                                   ,B1.BSE_WK
                                   ,B1.SLS_YRMON
                                   ,SUBSTR(B1.SLS_YRMON,0,4) AS SLS_YR
                                   ,B1.VSL_CD || B1.SKD_VOY_NO || B1.DIR_CD AS VVD
                                   ,B1.SQM_CNG_TP_CD
                                   ,B1.FNL_BSA_CAPA
                                   ,B1.LOD_QTY
                                   ,B1.GRS_REV
                                   ,B2.COST_YRMON AS MAS_COST_YRMON
                                   ,SUBSTR(B2.COST_YRMON,0,4) AS MAS_COST_YR
                                   ,SUBSTR(B2.YRMON, -2) AS MAS_MON
                                   ,B2.COST_WK
                                   ,B2.VSL_CD || B2.SKD_VOY_NO || B2.DIR_CD AS MAS_VVD
                                   ,B2.FNL_HJS_BSA_CAPA
                                   ,B1.TRD_CD || B1.SUB_TRD_CD || B1.RLANE_CD || B1.DIR_CD || B1.VSL_CD || B1.SKD_VOY_NO || B1.DIR_CD || B1.BSE_WK || B1.FNL_BSA_CAPA || B1.SLS_YRMON AS SQM_INFO
                                   ,B2.TRD_CD || B2.SUB_TRD_CD || B2.RLANE_CD || B2.DIR_CD || B2.VSL_CD || B2.SKD_VOY_NO || B2.DIR_CD || B2.COST_WK || B2.FNL_HJS_BSA_CAPA || B2.COST_YRMON AS MAS_INFO
                                   ,NVL(B1.QTA_RLSE_VER_NO, B2.QTA_RLSE_VER_NO)       AS O_QTA_RLSE_VER_NO
                                   ,NVL(B1.TRD_CD         , B2.TRD_CD)                AS O_TRD_CD
                                   ,NVL(B1.RLANE_CD       , B2.RLANE_CD)              AS O_RLANE_CD
                                   ,NVL(B1.SUB_TRD_CD     , B2.SUB_TRD_CD)            AS O_SUB_TRD_CD
                                   ,NVL(B1.IOC_CD         , B2.IOC_CD)                AS O_IOC_CD
                                   ,NVL(B1.DIR_CD         , B2.DIR_CD)                AS O_DIR_CD
                                   ,NVL(B1.BSE_MON        , SUBSTR(B2.YRMON, -2))     AS O_BSE_MON
                                   ,NVL(B1.BSE_WK         , B2.COST_WK)               AS O_BSE_WK
                                   ,NVL(B1.VSL_CD || B1.SKD_VOY_NO || B1.DIR_CD, B2.VSL_CD || B2.SKD_VOY_NO || B2.DIR_CD) AS O_VVD
                               FROM (
                                      SELECT 
                                             V.QTA_RLSE_VER_NO
                                            ,V.TRD_CD
                                            ,V.DIR_CD
                                            ,V.SUB_TRD_CD
                                            ,V.RLANE_CD
                                            ,V.BSE_YR
                                            ,V.BSE_MON
                                            ,V.BSE_WK
                                            ,V.SLS_YRMON
                                            ,V.VSL_CD
                                            ,V.SKD_VOY_NO
                                            ,V.FNL_BSA_CAPA
                                            ,Q.LOD_QTY
                                            ,Q.GRS_REV
                                            ,V.IOC_CD
                                            ,Q.SQM_CNG_TP_CD
                                        FROM SQM_CFM_TGT_VVD V
                                            ,(
                                              SELECT QTA_RLSE_VER_NO
                                                    ,TRD_CD
                                                    ,RLANE_CD
                                                    ,DIR_CD
                                                    ,VSL_CD
                                                    ,SKD_VOY_NO
                                                    ,SKD_DIR_CD
                                                    ,SQM_CNG_TP_CD
                                                    ,SUM(LOD_QTY) AS LOD_QTY
                                                    ,ROUND(SUM(LOD_QTY*GRS_RPB_REV)) AS GRS_REV
                                                FROM SQM_CFM_QTA
                                               WHERE 1=1
                                                 AND QTA_RLSE_VER_NO = ( SELECT QTA_RLSE_VER_NO
                                                                           FROM SQM_QTA_RLSE_VER
                                                                          WHERE BSE_TP_CD      = @[f_bse_tp_cd]
                                                                            AND BSE_YR         = @[f_bse_yr]
                                                                            AND BSE_QTR_CD     = @[f_bse_qtr_cd]
                                                                            AND SQM_VER_STS_CD = 'R' )
                                                 AND OFC_VW_CD       = 'L'
        #if (${f_trd_cd} != '' && ${f_trd_cd} != 'All')
                                                 AND TRD_CD          = @[f_trd_cd]
        #end
        #if (${f_rlane_cd} != '' && ${f_rlane_cd} != 'All')
                                                 AND RLANE_CD        = @[f_rlane_cd]
        #end
        #if (${f_trd_dir} != 'on' && ${f_dir_cd} != '' && ${f_dir_cd} != 'All')
                                                 AND DIR_CD          = @[f_dir_cd]
        #end
                                               GROUP BY QTA_RLSE_VER_NO
                                                       ,TRD_CD
                                                       ,RLANE_CD
                                                       ,DIR_CD
                                                       ,VSL_CD
                                                       ,SKD_VOY_NO
                                                       ,SKD_DIR_CD
                                                       ,SQM_CNG_TP_CD
                                             ) Q
                                       WHERE 1=1
                                         AND V.QTA_RLSE_VER_NO = Q.QTA_RLSE_VER_NO(+)
                                         AND V.TRD_CD          = Q.TRD_CD(+)
                                         AND V.RLANE_CD        = Q.RLANE_CD(+)
                                         AND V.DIR_CD          = Q.DIR_CD(+)
                                         AND V.VSL_CD          = Q.VSL_CD(+)
                                         AND V.SKD_VOY_NO      = Q.SKD_VOY_NO(+)
                                         AND V.SKD_DIR_CD      = Q.SKD_DIR_CD(+)
                                         AND V.QTA_RLSE_VER_NO = SUBSTR(@[f_bse_yr],-2) ||@[f_bse_qtr_cd]||'02'
                                         AND V.BSE_TP_CD       = @[f_bse_tp_cd]
                                         AND V.BSE_YR          = @[f_bse_yr]
                                         AND V.BSE_QTR_CD      = @[f_bse_qtr_cd]
        #if (${f_bse_wk} != '')
                                         AND V.BSE_WK          = @[f_bse_wk]
        #end
        #if (${f_trd_cd} != '' && ${f_trd_cd} != 'All')
                                         AND V.TRD_CD          = @[f_trd_cd]
        #end
        #if (${f_rlane_cd} != '' && ${f_rlane_cd} != 'All')
                                         AND V.RLANE_CD        = @[f_rlane_cd]
        #end
        #if (${f_trd_dir} != 'on' && ${f_dir_cd} != '' && ${f_dir_cd} != 'All')
                                         AND V.DIR_CD          = @[f_dir_cd]
        #end
--                                         AND 1 = CASE WHEN V.BSE_YR || v.BSE_QTR_CD > '20142Q'
--                                                           THEN (SELECT NVL((
--                                                                            SELECT DISTINCT 0
--                                                                              FROM SQM_SCTR_PAIR_MGMT S1
--                                                                             WHERE 1=1
--                                                                               AND S1.BSE_TP_CD  = V.BSE_TP_CD
--                                                                               AND S1.BSE_YR     = V.BSE_YR
--                                                                               AND S1.BSE_QTR_CD = V.BSE_QTR_CD
--                                                                               AND S1.TRD_CD     = V.TRD_CD
--                                                                               AND S1.RLANE_CD   = V.RLANE_CD
--                                                                               AND S1.DIR_CD     = V.DIR_CD
--                                                                            ),1)
--                                                                FROM DUAL)
--                                                      ELSE 1
--                                                 END

                                    ) B1
                                    FULL OUTER JOIN
                                    (
                                      SELECT 
                                             A3.QTA_RLSE_VER_NO
                                            ,A1.TRD_CD
                                            ,A1.SUB_TRD_CD
                                            ,A1.RLANE_CD
                                            ,A1.DIR_CD
                                            ,A1.VSL_CD
                                            ,A1.SKD_VOY_NO
                                            ,A1.COST_YRMON
                                            ,DECODE(A3.BSE_YR, '2014', A1.SLS_YRMON, A1.COST_YRMON) YRMON
                                            ,A1.COST_WK
                                            ,A1.IOC_CD
                                            ,ROUND(NVL(A2.FNL_HJS_BSA_CAPA, 0)) AS FNL_HJS_BSA_CAPA
                                        FROM MAS_MON_VVD       A1
                                            ,BSA_VVD_MST       A2
                                            ,(
                                               SELECT DISTINCT
                                                      S1.QTA_RLSE_VER_NO
                                                     ,S2.BSE_TP_CD
                                                     ,S2.BSE_YR
                                                     ,S2.BSE_QTR_CD
                                                     ,S2.TRD_CD
                                                     ,S2.RLANE_CD
                                                     ,S2.DIR_CD
                                                 FROM SQM_QTA_RLSE_VER S1
        #if (${f_cond_tp} == '1')
                                                      -- 해당 분기의 LANE-OFFICE RELATION SETTING 한 노선의 정보를 걸어준다
                                                      -- (2013년간 데이터를 제외한 모든 분기를 걸어주면됨 현재는 현재 분기와 미래 판매목표만 걸어주고 있음)
                                                     ,SQM_QTA_LANE_OFC S2
        #else
                                                      -- 2013년도 데이터는  LANE-OFFICE RELATION SETTING 정보가 없기 때문에 TARGET VVD 정보를 걸어서 노선정보를 가져온다.
                                                     ,SQM_CFM_TGT_VVD S2
        #end
                                                WHERE 1=1
                                                  AND S1.BSE_TP_CD      = S2.BSE_TP_CD
                                                  AND S1.BSE_YR         = S2.BSE_YR
                                                  AND S1.BSE_QTR_CD     = S2.BSE_QTR_CD
                                                  AND S1.SQM_VER_STS_CD = 'R'
                                                  AND S2.BSE_TP_CD      = @[f_bse_tp_cd]
                                                  AND S2.BSE_YR         = @[f_bse_yr]
                                                  AND S2.BSE_QTR_CD     = @[f_bse_qtr_cd]
        #if (${f_cond_tp} == '1')
                                                  AND S2.OFC_VW_CD      = 'L'
        #end
        #if (${f_trd_cd} != '' && ${f_trd_cd} != 'All')
                                                  AND S2.TRD_CD         = @[f_trd_cd]
        #end
        #if (${f_rlane_cd} != '' && ${f_rlane_cd} != 'All')
                                                  AND S2.RLANE_CD       = @[f_rlane_cd]
        #end
        #if (${f_trd_dir} != 'on' && ${f_dir_cd} != '' && ${f_dir_cd} != 'All')
                                                  AND S2.DIR_CD         = @[f_dir_cd]
        #end
--                                                  AND 1 = CASE WHEN S2.BSE_YR || S2.BSE_QTR_CD > '20142Q'
--                                                                    THEN (SELECT NVL((
--                                                                                     SELECT 0
--                                                                                       FROM SQM_SCTR_PAIR_MGMT X1
--                                                                                      WHERE 1=1
--                                                                                        AND X1.BSE_TP_CD  = S2.BSE_TP_CD
--                                                                                        AND X1.BSE_YR     = S2.BSE_YR
--                                                                                        AND X1.BSE_QTR_CD = S2.BSE_QTR_CD
--                                                                                        AND X1.TRD_CD     = S2.TRD_CD
--                                                                                        AND X1.RLANE_CD   = S2.RLANE_CD
--                                                                                        AND X1.DIR_CD     = S2.DIR_CD
--                                                                                     ),1)
--                                                                         FROM DUAL)
--                                                               ELSE 1
--                                                          END
                                              ) A3
                                       WHERE A1.TRD_CD         = A2.TRD_CD     (+)
                                         AND A1.RLANE_CD       = A2.RLANE_CD   (+)
                                         AND A1.VSL_CD         = A2.VSL_CD     (+)
                                         AND A1.SKD_VOY_NO     = A2.SKD_VOY_NO (+)
                                         AND A1.DIR_CD         = A2.SKD_DIR_CD (+)
                                         AND A1.IOC_CD         = A2.IOC_CD     (+)
                                         AND A1.TRD_CD         = A3.TRD_CD
                                         AND A1.RLANE_CD       = A3.RLANE_CD
                                         AND A1.DIR_CD         = A3.DIR_CD
        #if (${f_bse_wk} != '')
                                         AND A1.COST_WK        = @[f_bse_wk]
        #end
                                         AND A1.DELT_FLG       = 'N'
                                         AND A1.IOC_CD         = DECODE(A1.RLANE_CD, 'RBCCO', 'I', A1.IOC_CD) -- RBCCO 노선은 IOC_CD = 'I' 인것만
                                         -- 2013년 : SLS_YRMON / 2014년 : Week / 2015년~ : COST_YRMON (COA 이행 데이터 기준이 다름)
                                         AND CASE WHEN '2013' = A3.BSE_YR THEN A1.SLS_YRMON WHEN '2014' = A3.BSE_YR THEN SUBSTR(A1.SLS_YRMON, 1, 4)||A1.COST_WK ELSE A1.COST_YRMON END 
                                             BETWEEN CASE WHEN '2014' = A3.BSE_YR THEN @[f_bse_yr]||@[f_fm_wk] ELSE @[f_bse_yr]||DECODE(@[f_bse_qtr_cd],'1Q','01','2Q','04','3Q','07','4Q','10') END 
                                                 AND CASE WHEN '2014' = A3.BSE_YR THEN @[f_bse_yr]||@[f_to_wk] ELSE @[f_bse_yr]||DECODE(@[f_bse_qtr_cd],'1Q','03','2Q','06','3Q','09','4Q','12') END 
                                         AND NOT EXISTS ( SELECT 1
                                                            FROM SQM_QTA_TGT_VVD S1
                                                           WHERE S1.BSE_TP_CD  = @[f_bse_tp_cd]
                                                             AND S1.BSE_YR     = @[f_bse_yr]
                                                             AND S1.BSE_QTR_CD = @[f_bse_qtr_cd]
                                                             AND S1.DELT_FLG   = 'Y'
                                                             AND A1.TRD_CD     = S1.TRD_CD
                                                             AND A1.RLANE_CD   = S1.RLANE_CD
                                                             AND A1.VSL_CD     = S1.VSL_CD
                                                             AND A1.SKD_VOY_NO = S1.SKD_VOY_NO
                                                             AND A1.DIR_CD     = S1.DIR_CD
                                                        )
                                    ) B2
                                 ON B1.QTA_RLSE_VER_NO = B2.QTA_RLSE_VER_NO
                                AND B1.TRD_CD          = B2.TRD_CD
                                AND B1.SUB_TRD_CD      = B2.SUB_TRD_CD
                                AND B1.DIR_CD          = B2.DIR_CD
                                AND B1.RLANE_CD        = B2.RLANE_CD
                                AND B1.IOC_CD          = B2.IOC_CD
                                AND B1.VSL_CD          = B2.VSL_CD
                                AND B1.SKD_VOY_NO      = B2.SKD_VOY_NO
                          )
                 GROUP BY O_QTA_RLSE_VER_NO
                         ,O_TRD_CD
                         ,O_RLANE_CD
                         ,O_SUB_TRD_CD
                         ,O_DIR_CD
                         ,O_IOC_CD
                         ,O_VVD
                 )A2
                 ,PORTION_ADJUST_HO_LOADING HL
                 ,PORTION_ADJUST_HO_CONTRACT HC
        WHERE A1.TRD_CD         = A2.TRD_CD
        AND A1.SUB_TRD_CD       = A2.SUB_TRD_CD
        AND A1.RLANE_CD         = A2.RLANE_CD
        AND A1.DIR_CD           = A2.DIR_CD
        AND A1.IOC_CD           = A2.IOC_CD

        AND A1.TRD_CD           = HL.TRD_CD
        AND A1.SUB_TRD_CD       = HL.SUB_TRD_CD
        AND A1.RLANE_CD         = HL.RLANE_CD
        AND A1.DIR_CD           = HL.DIR_CD
        
        AND A1.TRD_CD           = HC.TRD_CD
        AND A1.SUB_TRD_CD       = HC.SUB_TRD_CD
        AND A1.RLANE_CD         = HC.RLANE_CD
        AND A1.DIR_CD           = HC.DIR_CD

        #if (${f_portion_link} != '' && ${f_portion_link} != 'All')
        AND DECODE(SQM_CNG_TP_CD, 'I', 'Y', 'N') = @[f_portion_link]
        #end
        #if (${f_trd_dir} == 'on' && ${f_hul_bnd_cd} != '' && ${f_hul_bnd_cd} != 'All')
        AND A1.HUL_BND_CD               		 = @[f_hul_bnd_cd]
        #end
        ORDER BY A2.TRD_CD
                ,A2.RLANE_CD
                ,A2.DIR_CD
                ,NVL(SLS_YR,NVL(MAS_COST_YR, BSE_YR))
                ,NVL(MAS_BSE_MON, BSE_MON)
                ,NVL(MAS_BSE_WK, BSE_WK)
    )
)
WHERE COMPARISON_WITH_HO_LOADING LIKE 'DIFFERENT%'
 OR COMPARISON_WITH_HO_CONTRACT LIKE 'DIFFERENT%'			]]></sql>
			<params>
				<param name="f_bse_tp_cd" type="12" value="" out="N"/>
				<param name="f_bse_yr" type="12" value="" out="N"/>
				<param name="f_bse_qtr_cd" type="12" value="" out="N"/>
				<param name="f_trd_cd" type="12" value="" out="N"/>
				<param name="f_rlane_cd" type="12" value="" out="N"/>
				<param name="f_conv_dir_cd" type="12" value="" out="N"/>
				<param name="f_trd_dir" type="12" value="" out="N"/>
				<param name="f_dir_cd" type="12" value="" out="N"/>
				<param name="f_bse_wk" type="12" value="" out="N"/>
				<param name="f_fm_wk" type="12" value="" out="N"/>
				<param name="f_to_wk" type="12" value="" out="N"/>
				<param name="f_portion_link" type="12" value="" out="N"/>
				<param name="f_hul_bnd_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
