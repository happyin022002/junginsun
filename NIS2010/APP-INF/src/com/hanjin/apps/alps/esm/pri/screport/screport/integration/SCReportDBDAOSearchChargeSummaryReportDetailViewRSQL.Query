<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="SCReportDBDAOSearchChargeSummaryReportDetailViewRSQL">
			<desc><![CDATA[Charge Summary Report - Detail View Tab을 조회한다.
2013.06.24 송호진 [CHM-201324516] MDM_CHARGE 에 새로 추가된 MDT_RAT_FLG 적용
2014.02.26 전윤주 [CHM-201429075] Charge Summary Report_Detail view 조회 기능 추가
2014.06.02 최성환 [CHM-201430519]Charge Summary Report 로직 보완 요청
2015.06.30 최성환 [CHM-201536493] Split03-주간 MAS Open에 따른 타모듈 프로그램 적용 요청]]></desc>
			<sql><![CDATA[
SELECT C1.CHG_CD
      ,C1.MDTR_CD 
      ,C1.SVC_SCP_CD
#if (${rhq_cd} != '')
      ,C1.RHQ_CD
#end
#if (${bkg_ofc_cd} != '' )	
      ,C1.BKG_OFC_CD
#end
#if (${por_cd} != '' )
      ,C1.POR_CD
#end
#if (${pol_cd} != '' )
      ,C1.POL_CD
#end
#if (${pod_cd} != '' )
      ,C1.POD_CD
#end
#if (${del_cd} != '' )
      ,C1.DEL_CD
#end
#if (${per_cd} != '' )
      ,DECODE(C1.PER_CD, 'OT', 'Other', C1.PER_CD) PER_CD
#end
#if (${cgo_cate_cd} != '' )
      ,C1.CGO_CATE_CD
#end
      ,SUM(C1.RAT_USD_CHG_AMT) RAT_USD_CHG_AMT
      ,SUM(C1.TRF_USD_CHG_AMT) TRF_USD_CHG_AMT
      ,ROUND(DECODE(SUM(C1.TRF_USD_CHG_AMT), 0, 0
             ,SUM(C1.RAT_USD_CHG_AMT)/SUM(C1.TRF_USD_CHG_AMT)*100)
            ,2) CLT_RATIO
	  ,COUNT(C1.BKG_NO) BKG_COUNT
FROM (
        SELECT CHG_CD 
              ,MDTR_CD
              ,SVC_SCP_CD
#if (${rhq_cd} != '')
    		  ,RHQ_CD
#end
              ,BKG_OFC_CD
              ,POR_CD
              ,POL_CD
              ,POD_CD
              ,DEL_CD
              ,PER_CD
              ,CGO_CATE_CD         
              ,BKG_NO
              ,SUM(B1.TRF_USD_CHG_AMT) TRF_USD_CHG_AMT
              ,(SELECT SUM(MAS_CONV_CURR_USD_FNC(CURR_CD, NVL(CHG_AMT, 0),TO_CHAR(SYSDATE, 'YYYYMM')))
                 FROM BKG_CHG_RT B2
                WHERE B2.BKG_NO = B1.BKG_NO
                  AND B2.CHG_CD = B1.CHG_CD
                  AND B2.CGO_CATE_CD = B1.CGO_CATE_CD
				  --RAT UT CODE를 PER 기준으로 환산하여 join 함
                  AND (DECODE((SELECT DECODE(RAT_UT_CD, 'BX', 'BX', 'BL', 'BL', CNTR_SZ_CD)
                                FROM PRI_RAT_UT
                               WHERE RAT_UT_CD(+) = B2.RAT_UT_CD) 
                             ,'2', '20'
                             ,'4', '40'
                             ,'7', '45'
                             ,'BX','BX'
                             ,'BL','BL' 
                             ,'OT') = B1.PER_CD
						 OR B1.PER_CD  IN ( 'BX', 'BL' )
                	   )
                  AND B2.FRT_INCL_XCLD_DIV_CD <> 'I'                  
                ) RAT_USD_CHG_AMT              
         FROM ( 
               SELECT  A1.CHG_CD 
                      ,A2.SVC_SCP_CD
#if (${rhq_cd} != '')
                      ,@[rhq_cd] RHQ_CD -- RHQ 조건이 들어올 때만
#end 
                      ,A2.BKG_OFC_CD
                      ,A2.POR_CD
                      ,A2.POL_CD
                      ,A2.POD_CD
                      ,A2.DEL_CD
                      ,A1.RAT_UT_CD
					   --20, 40, 45, BX, BL, OT 6가지 CODE로 GROUP BY 
                      ,DECODE((SELECT DECODE(RAT_UT_CD, 'BX', 'BX', 'BL', 'BL', CNTR_SZ_CD)
                                 FROM PRI_RAT_UT
                                WHERE RAT_UT_CD(+) = A1.RAT_UT_CD) 
                             ,'2', '20'
                             ,'4', '40'
                             ,'7', '45'
                             ,'BX','BX'
                             ,'BL','BL'
                             ,'OT') PER_CD
                      ,A1.CGO_CATE_CD         
                      ,DECODE ( A3.MDT_RAT_FLG, 'Y','YES','N','NO' ) AS MDTR_CD
                      ,A1.BKG_NO
                      ,MAS_CONV_CURR_USD_FNC(A1.CURR_CD, NVL(A1.CHG_AMT, 0),TO_CHAR(SYSDATE, 'YYYYMM')) TRF_USD_CHG_AMT            
                FROM  
                     BKG_BOOKING A2
                    ,BKG_TRF_SCG_RT A1      
                    ,MDM_CHARGE A3    
#if (${rhq_cd} != '' )
-- RHQ 조건이 들어올 때만 조인됨
                    ,(
                      SELECT OFC_CD 
                        FROM MDM_ORGANIZATION A
                       WHERE DELT_FLG = 'N'
                      START WITH A.OFC_CD  = @[rhq_cd]
                      CONNECT BY PRIOR A.OFC_CD = A.PRNT_OFC_CD  
                      ) A4
#end 
                WHERE 1=1
                  AND A1.BKG_NO = A2.BKG_NO
                  AND A1.CHG_CD = A3.CHG_CD
                  AND A2.BKG_STS_CD <> 'X'
                  AND A2.BKG_CGO_TP_CD <> 'P'                
#if(${gubun} == '1')
                  -- WEEK 로 조건이 들어올 때
                  AND EXISTS ( SELECT BKG_NO
                                FROM MAS_BKG_EXPN_DTL_WK
                                WHERE 1=1
	#if(${f_sls_mon} == '' )
                                -- Year, Week만 들어올 때
                                AND SUBSTR(SLS_YRMON,1,4)||COST_WK BETWEEN @[f_year]||@[f_fm_wk] AND @[f_year]||@[f_to_wk]
	#end
    #if(${f_sls_mon} != '' )
                                 -- Year, Month ,Week 들어올 때
                                AND  SUBSTR(SLS_YRMON,5,2) = @[f_sls_mon]
    #end
                                AND BKG_NO = A2.BKG_NO)
#end
#if (${gubun} == '2' )
                  -- MONTH 로 조건이 들어올 때
                  AND EXISTS (SELECT  /*+ INDEX (MAS_BKG_EXPN_DTL, XAK3MAS_BKG_EXPN_DTL) */  
                                   BKG_NO
                              FROM MAS_BKG_EXPN_DTL
                              WHERE COST_YRMON BETWEEN @[f_year]||@[f_fm_mon] AND @[f_year]||@[f_to_mon]
                              AND BKG_NO = A2.BKG_NO)          
#end
#if (${gubun} == '3' )
                  -- Appl 로 조건이 들어올때
                  AND EXISTS (SELECT BKG_NO
                              FROM BKG_RATE
                              WHERE RT_APLY_DT >= TO_DATE(@[start_dt], 'YYYY-MM-DD')
                              AND RT_APLY_DT <= TO_DATE(@[end_dt], 'YYYY-MM-DD') + 0.99999
                              AND BKG_NO = A2.BKG_NO)
#end
#if (${rhq_cd} != '' )
                  AND A2.CTRT_OFC_CD =A4.OFC_CD
#end
#if (${chg_cd} != '' )                     
                  AND A1.CHG_CD IN (${chg_cd}) 
#end 
#if (${svc_scp_cd} != '')
                  AND A2.SVC_SCP_CD  IN (${svc_scp_cd})
#end 
#if (${por_cd} != '')
                  AND A2.POR_CD like @[por_cd]||'%' --POR 조건
#end 
#if (${pol_cd} != '')
                  AND A2.POL_CD like @[pol_cd]||'%' -- POL 조건
#end 
#if (${pod_cd} != '')
                  AND A2.POD_CD like @[pod_cd]||'%' -- POD 조건
#end 
#if (${del_cd} != '')
                  AND A2.DEL_CD like @[del_cd]||'%' --DEL 조건 
#end 
#if (${bkg_ofc_cd} != '')
                  AND A2.BKG_OFC_CD IN (${bkg_ofc_cd}) -- B.OFC 조건
#end 
#if (${cgo_cate_cd} != '')
                  AND A1.CGO_CATE_CD IN (${cgo_cate_cd}) --cgo_cate_cd조건 
#end 
#if (${mdtr_cd} != 'A')
                  AND A3.MDT_RAT_FLG = @[mdtr_cd]
#end
				 ) B1
        WHERE 1=1 
#if (${per_cd} != '' )
        AND PER_CD IN (${per_cd}) --PER 조건
#end
    GROUP BY CHG_CD 
            ,MDTR_CD
            ,SVC_SCP_CD
#if (${rhq_cd} != '')
        	,RHQ_CD
#end
            ,BKG_OFC_CD
            ,POR_CD
            ,POL_CD
            ,POD_CD
            ,DEL_CD
            ,PER_CD
            ,CGO_CATE_CD         
            ,BKG_NO
)C1
GROUP BY C1.CHG_CD 
      ,C1.MDTR_CD
      ,C1.SVC_SCP_CD
#if (${rhq_cd} != '')
      ,C1.RHQ_CD
#end
#if (${bkg_ofc_cd} != '')
      ,C1.BKG_OFC_CD
#end
#if (${por_cd} != '')
      ,C1.POR_CD
#end 
#if (${pol_cd} != '')
      ,C1.POL_CD
#end 
#if (${pod_cd} != '')
      ,C1.POD_CD
#end 
#if (${del_cd} != '')
      ,C1.DEL_CD
#end
#if (${per_cd} != '' )
      ,C1.PER_CD
#end
#if (${cgo_cate_cd} != '')
      ,C1.CGO_CATE_CD
#end			]]></sql>
			<params>
				<param name="rhq_cd" type="12" value="" out="N"/>
				<param name="f_year" type="12" value="" out="N"/>
				<param name="f_fm_wk" type="12" value="" out="N"/>
				<param name="f_to_wk" type="12" value="" out="N"/>
				<param name="f_sls_mon" type="12" value="" out="N"/>
				<param name="f_fm_mon" type="12" value="" out="N"/>
				<param name="f_to_mon" type="12" value="" out="N"/>
				<param name="start_dt" type="12" value="" out="N"/>
				<param name="end_dt" type="12" value="" out="N"/>
				<param name="por_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="del_cd" type="12" value="" out="N"/>
				<param name="mdtr_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
