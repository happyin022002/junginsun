<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BlRatingDBDAOSearchInvoiceInterfaceDifferenceRSQL">
			<desc><![CDATA[BKG_CHG_RT와 INV Interface Temp 테이블을 비교해 차이가 발생한 BKG List를 조회]]></desc>
			<sql><![CDATA[
SELECT T01.BKG_NO,
'' FM_DT,
'' TO_DT,
  T01.CHG_CD,
  T01.CURR_CD,
  T01.RAT_UT_CD ,
  T01.RAT_AS_QTY ,
  T01.CHG_AMT,
  (
    SELECT BKG_STS_CD||' '|| TO_CHAR(BKG_CRE_DT, 'YYYY-MM-DD')
    FROM BKG_BOOKING BK
    WHERE BK.BKG_NO = T01.BKG_NO) BKG_STS_DT,
  (
    SELECT BKG_STS_CD
    FROM BKG_BOOKING BK
    WHERE BK.BKG_NO = T01.BKG_NO) BKG_STS_CD,
  (
    SELECT /*+ index_desc(INV_BKG_IF_MN XPKINV_BKG_IF_MN) */SRC_IF_DT
    FROM INV_BKG_IF_MN INV
    WHERE INV.BKG_NO = T01.BKG_NO
      AND ROWNUM =1) BL_INV_IF_DT,
  (
    SELECT MAX(BL_INV_IF_DT)
    FROM INV_AR_MN
    WHERE BKG_NO = T01.BKG_NO) AR_IF_DT,
  ROW_NUMBER() OVER (PARTITION BY T01.BKG_NO
    ORDER BY T01.BKG_NO DESC) RT_SEQ,
  (
    SELECT BL_NO
    FROM BKG_BOOKING BK
    WHERE BK.BKG_NO = T01.BKG_NO) BL_NO,
  (
    SELECT NVL(MAX(BKG_SEQ), 0)+1
    FROM BKG_INV_IF_MNTR
    WHERE BKG_NO = T01.BKG_NO) BKG_SEQ
FROM (
    SELECT RT.BKG_NO,
      CHG_CD,
      CURR_CD,
      RAT_UT_CD ,
      RAT_AS_QTY ,
      CHG_AMT
    FROM BKG_CHG_RT RT,
      (
        SELECT DISTINCT R.BKG_NO
        FROM BKG_CHG_RT R,
          BKG_BOOKING B
        WHERE 1=1
#if (${bkg_no} != '') 
          AND B.BKG_NO = @[bkg_no]
#else 
          AND R.UPD_DT >= TO_DATE(@[fm_dt], 'YYYY-MM-DD')
          AND R.UPD_DT <= TO_DATE(@[to_dt], 'YYYY-MM-DD') + 0.99999
#end
          AND R.FRT_INCL_XCLD_DIV_CD = 'N'
          AND R.CHG_CD != 'WHF'
          AND R.BKG_NO = B.BKG_NO
          AND B.BKG_CRE_DT > SYSDATE -730 ) J
    WHERE 1=1
      AND FRT_INCL_XCLD_DIV_CD = 'N'
      AND CHG_CD != 'WHF'
      AND RT.BKG_NO = J.BKG_NO
#if (${bkg_no} != '') 
      AND RT.BKG_NO = @[bkg_no]
#else 
      AND RT.UPD_DT >= TO_DATE(@[fm_dt], 'YYYY-MM-DD')
      AND RT.UPD_DT <= TO_DATE(@[to_dt], 'YYYY-MM-DD') + 0.99999
#end
    UNION
    SELECT RT.BKG_NO,
      CHG_CD,
      CURR_CD,
      RAT_UT_CD ,
      RAT_AS_QTY ,
      CHG_AMT
    FROM BKG_INV_IF_MNTR MNTR,
      BKG_CHG_RT RT ,
      BKG_BOOKING B
    WHERE 1=1
#if (${bkg_no} != '') 
      AND RT.BKG_NO = @[bkg_no]
#else 
      AND RT.UPD_DT >= TO_DATE(@[fm_dt], 'YYYY-MM-DD')
      AND RT.UPD_DT <= TO_DATE(@[to_dt], 'YYYY-MM-DD') + 0.99999
#end
      AND MNTR.BKG_NO = RT.BKG_NO
      AND MNTR.USE_FLG ='N'
      AND RT.FRT_INCL_XCLD_DIV_CD = 'N'
      AND RT.CHG_CD != 'WHF'
      AND RT.BKG_NO = B.BKG_NO
      AND B.BKG_CRE_DT > SYSDATE - 730 ) T01
WHERE 1= 1
  AND NOT EXISTS (
    SELECT 'Y'
    FROM BKG_BOOKING
    WHERE 1=1
      AND BKG_NO = T01.BKG_NO
      AND PRG_FLG ='Y')
  AND NOT EXISTS (
    SELECT BKG_NO,
      CHG_CD,
      CURR_CD,
      PER_TP_CD,
      RAT_AS_CNTR_QTY,
      CHG_AMT
    FROM (
        SELECT BKG_NO,
          CHG_CD,
          CURR_CD,
          PER_TP_CD,
          RAT_AS_CNTR_QTY,
          CHG_AMT
        FROM (
            SELECT T1.BKG_NO,
              CHG_CD,
              CURR_CD,
              PER_TP_CD,
              RAT_AS_CNTR_QTY,
              CHG_AMT,
              ROW_NUMBER() OVER (PARTITION BY T1.BKG_NO, CHG_SEQ
                ORDER BY T1.BKG_NO, BKG_SEQ DESC) AS MAX_SEQ
            FROM INV_BKG_IF_CHG T1 ,
              (
                SELECT DISTINCT RT.BKG_NO
                FROM BKG_CHG_RT RT,
                  BKG_BOOKING B
                WHERE 1=1
#if (${bkg_no} != '') 
                  AND B.BKG_NO = @[bkg_no]
#else 
                  AND RT.UPD_DT >= TO_DATE(@[fm_dt], 'YYYY-MM-DD')
                  AND RT.UPD_DT <= TO_DATE(@[to_dt], 'YYYY-MM-DD') + 0.99999
#end
                  AND RT.FRT_INCL_XCLD_DIV_CD = 'N'
                  AND RT.CHG_CD != 'WHF'
                  AND RT.BKG_NO = B.BKG_NO
                  AND B.BKG_CRE_DT > SYSDATE -730
                GROUP BY RT.BKG_NO
                UNION ALL
                SELECT DISTINCT MNTR.BKG_NO
                FROM BKG_INV_IF_MNTR MNTR,
                  BKG_BOOKING B,
                  BKG_CHG_RT RT
                WHERE 1=1
#if (${bkg_no} != '') 
                  AND B.BKG_NO = @[bkg_no]
#else 
                  AND RT.UPD_DT >= TO_DATE(@[fm_dt], 'YYYY-MM-DD')
                  AND RT.UPD_DT <= TO_DATE(@[to_dt], 'YYYY-MM-DD') + 0.99999
#end
                  AND RT.FRT_INCL_XCLD_DIV_CD = 'N'
                  AND RT.CHG_CD != 'WHF'
                  AND RT.BKG_NO = B.BKG_NO
                  AND MNTR.USE_FLG ='N'
                  AND MNTR.BKG_NO = B.BKG_NO
                  AND B.BKG_CRE_DT > SYSDATE - 730) RT
            WHERE 1= 1
              AND T1.BKG_NO = RT.BKG_NO
              AND T1.CHG_CD !='WHF' )
        WHERE MAX_SEQ =1 )T02
    WHERE 1=1
      AND T01.BKG_NO = T02.BKG_NO
      AND T01.CHG_CD = T02.CHG_CD
      AND T01.CURR_CD = T02.CURR_CD
      AND T01.RAT_UT_CD = T02.PER_TP_CD
      AND T01.RAT_AS_QTY = T02.RAT_AS_CNTR_QTY
      AND T01.CHG_AMT = T02.CHG_AMT )
UNION
SELECT T02.BKG_NO,
'' FM_DT,
'' TO_DT,
  T02.CHG_CD,
  T02.CURR_CD,
  T02.PER_TP_CD AS RAT_UT_CD ,
  T02.RAT_AS_QTY ,
  T02.CHG_AMT,
  (
    SELECT BKG_STS_CD||' '|| TO_CHAR(BKG_CRE_DT, 'YYYY-MM-DD')
    FROM BKG_BOOKING BK
    WHERE BK.BKG_NO = T02.BKG_NO) BKG_STS_DT,
  (
    SELECT BKG_STS_CD
    FROM BKG_BOOKING BK
    WHERE BK.BKG_NO = T02.BKG_NO) BKG_STS_CD,
  (
    SELECT /*+ index_desc(INV_BKG_IF_MN XPKINV_BKG_IF_MN) */SRC_IF_DT
    FROM INV_BKG_IF_MN INV
    WHERE INV.BKG_NO = T02.BKG_NO
      AND ROWNUM =1) BL_INV_IF_DT,
  (
    SELECT MAX(BL_INV_IF_DT)
    FROM INV_AR_MN
    WHERE BKG_NO = T02.BKG_NO) AR_IF_DT,
  ROW_NUMBER() OVER (PARTITION BY T02.BKG_NO
    ORDER BY T02.BKG_NO DESC) RT_SEQ,
  (
    SELECT BL_NO
    FROM BKG_BOOKING BK
    WHERE BK.BKG_NO = T02.BKG_NO) BL_NO,
  (
    SELECT NVL(MAX(BKG_SEQ), 0)+1
    FROM BKG_INV_IF_MNTR
    WHERE BKG_NO = T02.BKG_NO) BKG_SEQ
FROM (
    SELECT BKG_NO,
      CHG_CD,
      CURR_CD,
      PER_TP_CD,
      RAT_AS_QTY,
      CHG_AMT
    FROM (
        SELECT T1.BKG_NO,
          CHG_CD,
          CURR_CD,
          PER_TP_CD,
          RAT_AS_CNTR_QTY AS RAT_AS_QTY,
          CHG_AMT,
          RANK() OVER (PARTITION BY T1.BKG_NO
            ORDER BY T1.BKG_NO, BKG_SEQ DESC) AS MAX_SEQ
        FROM INV_BKG_IF_CHG T1 ,
          (
            SELECT RT.BKG_NO
            FROM BKG_CHG_RT RT,
              BKG_BOOKING B
            WHERE 1=1
#if (${bkg_no} != '') 
              AND B.BKG_NO = @[bkg_no]
#else 
              AND RT.UPD_DT >= TO_DATE(@[fm_dt], 'YYYY-MM-DD')
              AND RT.UPD_DT <= TO_DATE(@[to_dt], 'YYYY-MM-DD') + 0.99999
#end
              AND RT.FRT_INCL_XCLD_DIV_CD = 'N'
              AND RT.CHG_CD != 'WHF'
              AND RT.BKG_NO = B.BKG_NO
              AND B.BKG_CRE_DT > SYSDATE - 730
            GROUP BY RT.BKG_NO
            UNION ALL
            SELECT DISTINCT MNTR.BKG_NO
            FROM BKG_INV_IF_MNTR MNTR,
                 BKG_BOOKING B,
                 BKG_CHG_RT RT
            WHERE 1=1--
#if (${bkg_no} != '') 
              AND MNTR.BKG_NO = @[bkg_no]
#else 
              AND RT.UPD_DT >= TO_DATE(@[fm_dt], 'YYYY-MM-DD')
              AND RT.UPD_DT <= TO_DATE(@[to_dt], 'YYYY-MM-DD') + 0.99999
#end
              AND MNTR.USE_FLG ='N'
              AND MNTR.BKG_NO = B.BKG_NO
              AND RT.FRT_INCL_XCLD_DIV_CD = 'N'
              AND RT.CHG_CD != 'WHF'
              AND RT.BKG_NO = B.BKG_NO
              AND B.BKG_CRE_DT > SYSDATE - 730) RT
        WHERE 1= 1
          AND T1.BKG_NO = RT.BKG_NO
          AND T1.CHG_CD NOT IN ('WHF',
              'FAC') )
    WHERE MAX_SEQ =1 ) T02
WHERE 1= 1
  AND NOT EXISTS (
    SELECT 'Y'
    FROM BKG_BOOKING
    WHERE 1=1
      AND BKG_NO = T02.BKG_NO
      AND PRG_FLG ='Y')
  AND NOT EXISTS (
    SELECT BKG_NO,
      CHG_CD,
      CURR_CD,
      RAT_UT_CD,
      RAT_AS_QTY,
      CHG_AMT
    FROM (
        SELECT RT.BKG_NO,
          CHG_CD,
          CURR_CD,
          RAT_UT_CD ,
          RAT_AS_QTY ,
          CHG_AMT
        FROM BKG_CHG_RT RT,
          (
            SELECT DISTINCT R.BKG_NO
            FROM BKG_CHG_RT R,
              BKG_BOOKING B
            WHERE 1=1
#if (${bkg_no} != '') 
              AND B.BKG_NO = @[bkg_no]
#else
              AND R.UPD_DT >= TO_DATE(@[fm_dt], 'YYYY-MM-DD')
              AND R.UPD_DT <= TO_DATE(@[to_dt], 'YYYY-MM-DD') + 0.99999
#end
              AND R.FRT_INCL_XCLD_DIV_CD = 'N'
              AND R.CHG_CD != 'WHF'
              AND R.BKG_NO = B.BKG_NO
              AND B.BKG_CRE_DT > SYSDATE -730 ) J
        WHERE 1=1
          AND FRT_INCL_XCLD_DIV_CD = 'N'
          AND CHG_CD != 'WHF'
          AND RT.BKG_NO = J.BKG_NO
        UNION ALL
        SELECT RT.BKG_NO,
          CHG_CD,
          CURR_CD,
          RAT_UT_CD ,
          RAT_AS_QTY ,
          CHG_AMT
        FROM BKG_INV_IF_MNTR MNTR,
          BKG_CHG_RT RT ,
          BKG_BOOKING B
        WHERE 1=1
#if (${bkg_no} != '') 
          AND MNTR.BKG_NO = @[bkg_no]
#else
          AND RT.UPD_DT >= TO_DATE(@[fm_dt], 'YYYY-MM-DD')
          AND RT.UPD_DT <= TO_DATE(@[to_dt], 'YYYY-MM-DD') + 0.99999
#end
          AND MNTR.BKG_NO = RT.BKG_NO
          AND MNTR.USE_FLG ='N'
          AND RT.FRT_INCL_XCLD_DIV_CD = 'N'
          AND RT.CHG_CD != 'WHF'
          AND RT.BKG_NO = B.BKG_NO
          AND B.BKG_CRE_DT > SYSDATE -730 )T03
    WHERE 1=1
      AND T03.BKG_NO = T02.BKG_NO
      AND T03.CHG_CD = T02.CHG_CD
      AND T03.CURR_CD = T02.CURR_CD
      AND T03.RAT_UT_CD = T02.PER_TP_CD
      AND T03.RAT_AS_QTY = T02.RAT_AS_QTY
      AND T03.CHG_AMT = T02.CHG_AMT )
ORDER BY BKG_NO			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="fm_dt" type="12" value="" out="N"/>
				<param name="to_dt" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
