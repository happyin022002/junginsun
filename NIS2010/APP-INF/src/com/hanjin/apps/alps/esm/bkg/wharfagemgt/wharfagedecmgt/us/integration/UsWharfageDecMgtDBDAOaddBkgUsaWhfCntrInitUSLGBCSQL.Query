<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="UsWharfageDecMgtDBDAOaddBkgUsaWhfCntrInitUSLGBCSQL">
			<desc><![CDATA[addBkgUsaWhfCntrInitUSLGB]]></desc>
			<sql><![CDATA[
INSERT INTO BKG_USA_WHF_CNTR (
    VSL_CD
,   SKD_VOY_NO
,   SKD_DIR_CD
,   PORT_CD
,   IO_BND_CD
,   BL_NO
,   CNTR_NO
,   CNTR_TPSZ_CD
,   FULL_MTY_CD
,   CNTR_VOL_QTY
,   RCV_TERM_CD
,   DE_TERM_CD
,   USA_WHF_TRSP_TP_CD
,   USA_WHF_EXPT_FLG
,   USA_WHF_RAT_UT_CD
,   RAT_AS_QTY
,   WHF_UT_PRC
,   CRE_USR_ID
,   UPD_USR_ID
)
(
SELECT 
    TB.VSL_CD
,   TB.SKD_VOY_NO
,   TB.SKD_DIR_CD
,   TB.PORT_CD
,   TB.IO_BND_CD
,   TB.BL_NO
,   TB.CNTR_NO
,   TB.CNTR_TPSZ_CD
,   TB.FULL_MTY_CD
,   DECODE(TB.FULL_MTY_CD,'M',1,TB.CNTR_VOL_QTY)
,   TB.RCV_TERM_CD
,   TB.DE_TERM_CD
,   TB.USA_WHF_TRSP_TP_CD
,   TB.USA_WHF_EXPT_FLG
,   TB.USA_WHF_RAT_UT_CD
,   DECODE(TB.FULL_MTY_CD,'M',1,TB.CNTR_VOL_QTY)
,   RT.WHF_UT_PRC
,   @[cre_usr_id]
,   @[cre_usr_id]
  FROM  (
        SELECT  BKG.*
               ,DECODE(BKG.KW_NM, NULL, 'N', 'Y') AS USA_WHF_EXPT_FLG
               ,CNTR.CNTR_NO
               ,CNTR.CNTR_TPSZ_CD
               ,CNTR.CNTR_VOL_QTY
               ,CNTR.RCV_TERM_CD
               ,CNTR.DE_TERM_CD
               ,DECODE(BKG.USA_WHF_TRSP_TP_CD1, 'T', 'T', 'L', 'L', 
                       BKG_GET_USLGB_WHF_TRSP_TP_FNC(BKG.BKG_NO, CNTR.CNTR_NO, @[io_bnd_cd], @[port_cd])) AS USA_WHF_TRSP_TP_CD
               ,CASE SUBSTR(CNTR.CNTR_TPSZ_CD, 2, 1)
                    WHEN '2' THEN '20F'
                    WHEN '4' THEN '40F'
                    WHEN '5' THEN '40F'
                    ELSE '45F'
                 END AS USA_WHF_RAT_UT_CD
          FROM (
                SELECT 
                       A.VSL_CD
                      ,A.SKD_VOY_NO
                      ,A.SKD_DIR_CD
                      ,DECODE(@[io_bnd_cd], 'I', A.POD_CD, A.POL_CD) AS PORT_CD
                      ,@[io_bnd_cd] AS IO_BND_CD
                      ,A.BL_NO
                      ,A.BKG_NO
                      ,CASE WHEN A.BKG_CGO_TP_CD IN ('F','R') THEN 'F'
                            WHEN A.BKG_CGO_TP_CD IN ('P') THEN 'M'
                            ELSE '' 
                        END FULL_MTY_CD
                      ,(SELECT W.KW_NM1 || ' AND ' ||  W.KW_NM2
                          FROM BKG_USA_WHF_EXPT_CMDT W
                         WHERE W.PORT_CD = @[port_cd]
                           AND W.IO_BND_CD = @[io_bnd_cd]
                           AND C.CSTMS_DESC LIKE '%' || W.KW_NM1 || '%'
                           AND C.CSTMS_DESC LIKE '%' || W.KW_NM2 || '%'
                           AND ROWNUM = 1
                        ) AS KW_NM
        #if (${io_bnd_cd} == 'I') 
                      ,CASE WHEN A.POD_CD <> A.BKG_POD_CD THEN 'T'
                            WHEN A.BKG_POD_CD = A.DEL_CD THEN 'L'
                            ELSE 'R'
                        END AS USA_WHF_TRSP_TP_CD1
       #else
                      ,CASE WHEN A.BKG_POD_CD = A.DEL_CD THEN 'L'
                            ELSE 'R'
                        END AS USA_WHF_TRSP_TP_CD1
       #end
                  FROM (
                        SELECT A.VSL_CD
                              ,A.SKD_VOY_NO
                              ,A.SKD_DIR_CD
                              ,A.POD_CD
                              ,A.POL_CD
                              ,B.BL_NO
                              ,B.BKG_NO
                              ,B.BKG_CGO_TP_CD
                              ,B.POD_CD AS BKG_POD_CD
                              ,B.DEL_CD
                          FROM BKG_VVD A 
                              ,BKG_BOOKING B
                         WHERE A.VSL_CD = @[vsl_cd]
                           AND A.SKD_VOY_NO = @[skd_voy_no]
                           AND A.SKD_DIR_CD = @[skd_dir_cd]
                           AND A.BKG_NO = B.BKG_NO
                           AND B.BL_NO  IS NOT NULL
                           AND B.BKG_STS_CD IN ('F','W')
                        #if (${io_bnd_cd} == 'I') 
                           AND A.POD_CD = @[port_cd]
                        #else 
                           AND A.POL_CD = @[port_cd]
                        #end
                       ) A
                      ,BKG_BL_DOC C
                 WHERE A.BKG_NO = C.BKG_NO
               ) BKG
               ,BKG_CONTAINER CNTR
         WHERE  BKG.BKG_NO = CNTR.BKG_NO
        ) TB
       ,(
         SELECT USA_WHF_RAT_UT_CD
               ,FULL_MTY_CD
               ,USA_WHF_TRSP_TP_CD
               ,USA_WHF_EXPT_FLG
               ,WHF_UT_PRC
           FROM BKG_USA_WHF_RT_DTL DTL
               ,(SELECT MAX(EFF_DT) AS EFF_DT
                   FROM BKG_USA_WHF_RT
                  WHERE PORT_CD = @[port_cd]
                    AND IO_BND_CD = @[io_bnd_cd]
                ) MAX_RT
          WHERE PORT_CD = @[port_cd]
            AND IO_BND_CD = @[io_bnd_cd]
            AND DTL.EFF_DT = MAX_RT.EFF_DT
        ) RT
 WHERE  TB.USA_WHF_RAT_UT_CD = RT.USA_WHF_RAT_UT_CD(+)
   AND  TB.FULL_MTY_CD = RT.FULL_MTY_CD(+)
   AND  TB.USA_WHF_TRSP_TP_CD = RT.USA_WHF_TRSP_TP_CD(+)
   AND  TB.USA_WHF_EXPT_FLG = RT.USA_WHF_EXPT_FLG(+)
)			]]></sql>
			<params>
				<param name="cre_usr_id" type="12" value="" out="N"/>
				<param name="io_bnd_cd" type="12" value="" out="N"/>
				<param name="port_cd" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
