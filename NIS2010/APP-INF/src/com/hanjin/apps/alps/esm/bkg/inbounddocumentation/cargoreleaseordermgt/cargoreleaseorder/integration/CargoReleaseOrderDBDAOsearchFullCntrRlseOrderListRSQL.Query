<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CargoReleaseOrderDBDAOsearchFullCntrRlseOrderListRSQL">
			<desc><![CDATA[searchFullCntrRlseOrderList]]></desc>
			<sql><![CDATA[
SELECT  BL_NO                               
       ,BKG_NO   
       ,BKG_CGO_TP_CD                           
       ,VVD 
       ,POL_CD
       ,POD_CD 
       ,CNTR_NO 
       ,CNTR_TPSZ_CD
       ,DE_TERM_CD 
       ,YD_CD       -- 'Y' 이면 Uncheck       
       ,SVR_ID
       ,ERR       -- 'Y' 이면 Uncheck    
       ,CUST_NM
       ,SENT_FLG  -- Sent 
       ,FAX_NO         
       ,YD_NM         
       ,YD_EML         
       ,PHN_NO         
       ,VSL_NM         
       ,LOC_NM        
       ,DO_NO_YN         
       ,CXL_FLG         
       ,DO_NO         
       ,DIFF_RMK         
       ,DO_ISS_DT
       ,CASE WHEN SUBSTR(POD_CD,1,2) = 'BE' OR SUBSTR(POD_CD,1,2) = 'NL'OR SUBSTR(POD_CD,1,2) = 'DE' THEN LTRIM(TO_CHAR(nisadm.BKG_PIN_NB_SEQ.nextval,'0009')) 
             ELSE NULL END AS PIN_NO
       ,MSG_ACPT_REF_NO
       ,DEL_CD 
       ,CUST AS FRT_FWRD_CD
       ,CUST AS PTY_TO_INV_CD
       ,CNTR_RTN_YD_CD AS MT_RET_CY_CD
FROM (
	
	SELECT MST.BL_NO                               
	       ,MST.BKG_NO   
	       ,MST.BKG_CGO_TP_CD                           
	       ,MST.VVD 
	       ,MST.POL_CD
	       ,MST.POD_CD 
	       ,MST.DEL_CD 
	       ,MST.CNTR_NO 
	       ,MST.CNTR_TPSZ_CD
	       ,MST.DE_TERM_CD 
	       ,DECODE(MST.SVR_ID,MST.USR_SVR_ID,MST.CRNT_YD_CD,'')  AS YD_CD       -- 'Y' 이면 Uncheck       
	       ,MST.SVR_ID
	       ,DECODE(MST.SVR_ID,MST.USR_SVR_ID,'0','1')                            AS ERR       -- 'Y' 이면 Uncheck    
	       ,REPLACE(NVL(FORD.CUST_NM, MST.CUST_NM), CHR(13)||CHR(10), ' ')       AS CUST_NM
	       ,DECODE( NVL(FORD.CGOR_MZD_CD,'N') ,'E','Y'
	                                          ,'F','Y'
	                                          ,'M','Y'
	                                          ,'N')                              AS SENT_FLG  -- Sent 
	       ,MST.FAX_NO         
	       ,MST.YD_NM         
	       ,MST.YD_EML         
	       ,MST.PHN_NO         
	       ,MST.VSL_NM         
	       ,MST.LOC_NM        
	       ,MST.DO_NO_YN         
	       ,MST.CXL_FLG         
	       ,MST.DO_NO         
	       ,MST.DIFF_RMK         
	       ,MST.DO_ISS_DT	       
	       ,
	        ( 
    	      SELECT RSV.MSG_ACPT_REF_NO 
 				FROM BKG_CSTMS_EUR_DG_RCV RSV
 			  WHERE RSV.EUR_EDI_MSG_TP_ID='CTA'
              AND   RSV.BL_NO LIKE SUBSTR(MST.BL_NO,1,10)||'%' 
              AND   RSV.CNTR_NO = MST.CNTR_NO 
              AND   RSV.MSG_ACPT_REF_NO IS NOT NULL
 			  AND   ROWNUM = 1
            ) AS MSG_ACPT_REF_NO
			,MST.CNTR_RTN_YD_CD
            ,MST.CUST

	FROM (
	     SELECT BKG.BL_NO                                          AS BL_NO
	         , BKG.BKG_NO                                          AS BKG_NO
	         , BKG.BKG_CGO_TP_CD                                   AS BKG_CGO_TP_CD
	         , BVVD.VSL_CD||BVVD.SKD_VOY_NO||BVVD.SKD_DIR_CD       AS VVD
	         , BKG.POL_CD                                          AS POL_CD
	         , BVVD.POD_CD                                         AS POD_CD
	         , BKG.DEL_CD                                         AS DEL_CD
	         , BCNTR.CNTR_NO                                       AS CNTR_NO
	         , BCNTR.CNTR_TPSZ_CD                                  AS CNTR_TPSZ_CD
	         , BKG.DE_TERM_CD                                      AS DE_TERM_CD
	         , CNTR.CRNT_YD_CD                                     AS CRNT_YD_CD   -- 화면상에 YD_CD
	         , CNTR.SYS_AREA_GRP_ID                                AS SVR_ID
	         , BCUST.CUST_NM                                       AS CUST_NM
	         , (SELECT /*+ INDEX_DESC (ORD XPKBKG_FULL_CGO_RLSE_ORD) */ ORD.RLSE_ORD_SEQ 
	            FROM BKG_FULL_CGO_RLSE_ORD ORD 
	            WHERE ORD.BKG_NO = BCNTR.BKG_NO 
	            AND   ORD.CNTR_NO = BCNTR.CNTR_NO
	            AND   ROWNUM = 1)                                  AS MAX_RLSE_SEQ  
	         , YD.FAX_NO                                           AS FAX_NO
	         , YD.YD_NM                                            AS YD_NM
	         , YD.YD_EML                                           AS YD_EML
	         , YD.PHN_NO                                           AS PHN_NO
	         , VSL.VSL_ENG_NM                                      AS VSL_NM
	         , LOC.LOC_NM                                          AS LOC_NM
	         , DECODE( NVL(DDTL.RLSE_STS_CD,'N'),'N','N','Y')      AS DO_NO_YN
	         , 'N'                                                 AS CXL_FLG
	         , NVL(BDO.DO_NO || BDO.DO_NO_SPLIT,'')                AS DO_NO
	         , BDO.DO_PRN_RMK                                      AS DIFF_RMK
	         , TO_CHAR(DDTL.EVNT_DT,'YYYY-MM-DD HH24:MI')       AS DO_ISS_DT
	         , (SELECT SYS_AREA_GRP_ID 
	            FROM COM_SYS_AREA_GRP_ID 
	            WHERE  CNT_CD= @[cnt_cd]  
	               AND CO_IND_CD='H' 
	               AND SVR_USD_FLG='Y' )                           AS USR_SVR_ID
              , (SELECT TRO.CNTR_RTN_YD_CD  AS CNTR_RTN_YD_CD 
	              FROM BKG_EUR_TRO TRO
	              WHERE 1=1
	                AND TRO.BKG_NO  = BCNTR.BKG_NO
                    AND TRO.CNTR_NO  = BCNTR.CNTR_NO
                    AND TRO.CXL_FLG  = 'N'
                    AND ROWNUM = 1) AS CNTR_RTN_YD_CD
             , ( SELECT ACT_CUST_CNT_CD || TO_CHAR (ACT_CUST_SEQ, 'FM000000') CUST
                    FROM   INV_AR_MN
                    WHERE  AR_IF_NO = (SELECT MAX (AR_IF_NO) IF_NO
                                       FROM   INV_AR_MN
                                       WHERE  BL_INV_CFM_DT IS NOT NULL
                                        AND BL_SRC_NO = @[in_bl_no]
                                        AND AR_OFC_CD = (SELECT AR_OFC_CD
                                                            FROM(
                                                                SELECT DISTINCT A.AR_OFC_CD,
                                                                  DECODE(B.AR_OFC_CD, A.AR_OFC_CD, 0, 1) OFCSEQ,
                                                                  C.INV_DUP_FLG
                                                                FROM INV_AR_MN A,
                                                                  MDM_ORGANIZATION B,
                                                                  INV_AR_STUP_OFC C
                                                                WHERE A.BL_SRC_NO = @[in_bl_no]
                                                                  AND A.AR_OFC_CD IN (
                                                                    SELECT AR_OFC_CD
                                                                    FROM MDM_ORGANIZATION
                                                                    WHERE AR_HD_QTR_OFC_CD = (
                                                                        SELECT AR_HD_QTR_OFC_CD
                                                                        FROM MDM_ORGANIZATION
                                                                        WHERE OFC_CD = @[usr_ofc_cd])
                                                                      AND OFC_CD = AR_OFC_CD )
                                                                  AND B.OFC_CD = @[usr_ofc_cd]
                                                                  AND A.AR_OFC_CD = C.AR_OFC_CD (+)
                                                                  AND NVL(A.INV_DELT_DIV_CD, 'N') <> 'Y'
																  ORDER BY OFCSEQ)
															WHERE ROWNUM = 1
                                                            )
                                                                                        AND NVL (INV_DELT_DIV_CD, 'N') <> 'Y')) AS CUST

	      FROM BKG_BOOKING BKG
	         , BKG_VVD BVVD
	         , BKG_CONTAINER BCNTR
	         , MST_CONTAINER CNTR
	         , BKG_CUSTOMER BCUST
	         , MDM_YARD YD
	         , MDM_VSL_CNTR VSL
	         , MDM_LOCATION LOC
	         , BKG_EDI_YD EY
	         , BKG_DO_CNTR DCNTR
	         , BKG_DO_DTL  DDTL
	         , BKG_DO BDO
	     WHERE @[in_option] = 'BL'
	       AND BKG.BL_NO            = @[in_bl_no]
	       AND BCNTR.BKG_NO         = BKG.BKG_NO
	#if ( ${in_cntr_no} != '' )
	       AND BCNTR.CNTR_NO LIKE @[in_cntr_no]||'%'
	#end
	       AND BVVD.BKG_NO          = BKG.BKG_NO
	    --   AND BVVD.POD_CD          = BKG.POD_CD
	       AND BVVD.VSL_PRE_PST_CD  = 'T'       
	       AND BCUST.BKG_NO         = BKG.BKG_NO 
	       AND BCUST.BKG_CUST_TP_CD = 'C'
	       AND VSL.VSL_CD           = BVVD.VSL_CD
	       AND LOC.LOC_CD           = BVVD.POL_CD  
	       AND DCNTR.BKG_NO(+)      = BCNTR.BKG_NO         
	       AND DCNTR.CNTR_NO(+)     = BCNTR.CNTR_NO      
	       AND BDO.BKG_NO(+)        = DCNTR.BKG_NO
	       AND BDO.RLSE_SEQ(+)      = DCNTR.RLSE_SEQ
	       AND DDTL.BKG_NO(+)       = BDO.BKG_NO 
	       AND DDTL.RLSE_SEQ(+)     = BDO.RLSE_SEQ        
	       AND DDTL.RLSE_STS_CD(+)  = 'R'   
	       AND CNTR.CNTR_NO         = BCNTR.CNTR_NO    
	       AND YD.YD_CD(+)          = CNTR.CRNT_YD_CD        
	       AND EY.YD_CD(+)          = YD.YD_CD        
	       AND EY.FULL_RLSE_EDI_CD(+) = '1'
	   UNION ALL
	   SELECT BKG.BL_NO                                            AS BL_NO
	         , BKG.BKG_NO                                          AS BKG_NO
	         , BKG.BKG_CGO_TP_CD                                   AS BKG_CGO_TP_CD
	         , BVVD.VSL_CD||BVVD.SKD_VOY_NO||BVVD.SKD_DIR_CD       AS VVD
	         , BKG.POL_CD                                          AS POL_CD
	         , BVVD.POD_CD                                         AS POD_CD
	         , BKG.DEL_CD                                         AS DEL_CD
	         , BCNTR.CNTR_NO                                       AS CNTR_NO
	         , BCNTR.CNTR_TPSZ_CD                                  AS CNTR_TPSZ_CD
	         , BKG.DE_TERM_CD                                      AS DE_TERM_CD
	         , CNTR.CRNT_YD_CD                                     AS CRNT_YD_CD   -- 화면상에 YD_CD
	         , CNTR.SYS_AREA_GRP_ID                                AS SVR_ID
	         , BCUST.CUST_NM                                       AS CUST_NM
	         ,(SELECT /*+ INDEX_DESC (ORD XPKBKG_FULL_CGO_RLSE_ORD) */ ORD.RLSE_ORD_SEQ 
	           FROM BKG_FULL_CGO_RLSE_ORD ORD 
	           WHERE ORD.BKG_NO = BCNTR.BKG_NO 
	           AND   ORD.CNTR_NO = BCNTR.CNTR_NO
	           AND   ROWNUM = 1)                                   AS  MAX_RLSE_SEQ  
	         , YD.FAX_NO                                           AS FAX_NO
	         , YD.YD_NM                                            AS YD_NM
	         , YD.YD_EML                                           AS YD_EML
	         , YD.PHN_NO                                           AS PHN_NO
	         , VSL.VSL_ENG_NM                                      AS VSL_NM
	         , LOC.LOC_NM                                          AS LOC_NM
	         , DECODE( NVL(DDTL.RLSE_STS_CD,'N'),'N','N','Y')      AS DO_NO_YN
	         , 'N'                                                 AS CXL_FLG
	         , NVL(BDO.DO_NO || BDO.DO_NO_SPLIT,'')                AS DO_NO
	         , BDO.DO_PRN_RMK                                      AS DIFF_RMK
	         , TO_CHAR(DDTL.EVNT_DT,'YYYY-MM-DD HH24:MI')          AS DO_ISS_DT
	         ,(SELECT SYS_AREA_GRP_ID 
	            FROM COM_SYS_AREA_GRP_ID 
	            WHERE  CNT_CD = @[cnt_cd] 
	               AND CO_IND_CD='H' 
	               AND SVR_USD_FLG='Y' )                           AS  USR_SVR_ID
             , (SELECT TRO.CNTR_RTN_YD_CD  AS CNTR_RTN_YD_CD 
	              FROM BKG_EUR_TRO TRO
	              WHERE 1=1
	                AND TRO.BKG_NO  = BCNTR.BKG_NO
                    AND TRO.CNTR_NO  = BCNTR.CNTR_NO
                    AND TRO.CXL_FLG  = 'N'
                    AND ROWNUM = 1)  AS CNTR_RTN_YD_CD
			, (SELECT ACT_CUST_CNT_CD || TO_CHAR (ACT_CUST_SEQ, 'FM000000') AS CUST
        		 FROM   INV_AR_MN MN
        		WHERE 1=1
          		  AND  MN.BL_SRC_NO = BKG.BKG_NO
          		  AND  AR_IF_NO = (SELECT MAX (AR_IF_NO) IF_NO
                           FROM   INV_AR_MN A
                           WHERE  BL_INV_CFM_DT IS NOT NULL
                            AND A.BL_SRC_NO = MN.BKG_NO
                            AND AR_OFC_CD = (SELECT DISTINCT A.AR_OFC_CD
                                                    FROM INV_AR_MN A,
                                                      MDM_ORGANIZATION B,
                                                      INV_AR_STUP_OFC C
                                                    WHERE A.BL_SRC_NO = MN.BKG_NO
                                                      AND A.AR_OFC_CD IN (
                                                                            SELECT AR_OFC_CD
                                                                            FROM MDM_ORGANIZATION
                                                                            WHERE AR_HD_QTR_OFC_CD = (
                                                                                SELECT AR_HD_QTR_OFC_CD
                                                                                FROM MDM_ORGANIZATION
                                                                                WHERE OFC_CD = @[usr_ofc_cd])
                                                                              AND OFC_CD = AR_OFC_CD )
                                                      AND B.OFC_CD = @[usr_ofc_cd]
                                                      AND A.AR_OFC_CD = C.AR_OFC_CD (+)
                                                      AND NVL(A.INV_DELT_DIV_CD, 'N') <> 'Y'
                                                      AND ROWNUM = 1 )
                                                      
                            AND NVL (INV_DELT_DIV_CD, 'N') <> 'Y')) AS CUST

	      FROM BKG_BOOKING BKG
	         , BKG_VVD BVVD
	         , BKG_CONTAINER BCNTR
	         , MST_CONTAINER CNTR
	         , BKG_CUSTOMER BCUST
	         , MDM_YARD YD
	         , MDM_VSL_CNTR VSL
	         , MDM_LOCATION LOC
	         , BKG_EDI_YD EY
	         , BKG_DO_CNTR DCNTR
	         , BKG_DO_DTL  DDTL
	         , BKG_DO BDO
	     WHERE 'VVD'               =  @[in_option]
	       AND BVVD.VSL_CD         = SUBSTR(@[in_vvd], 1, 4)
	       AND BVVD.SKD_VOY_NO     = SUBSTR(@[in_vvd], 5, 4)
	       AND BVVD.SKD_DIR_CD     = SUBSTR(@[in_vvd], 9, 1)     
	       AND BVVD.VSL_PRE_PST_CD = 'T'       
	       AND BVVD.POD_CD         = @[in_pod] 
	       AND BCNTR.BKG_NO        = BVVD.BKG_NO 
	#if ( ${in_cntr_no} != '' )
	       AND BCNTR.CNTR_NO LIKE  @[in_cntr_no]||'%'
	#end
	       AND BKG.BKG_NO           = BVVD.BKG_NO 
	       AND BKG.BKG_STS_CD       IN ('W', 'F')
	       
	       
	#if ( ${in_del} != '' )
	       AND BKG.DEL_CD  like @[in_del]||'%' 
	       
	#end
	       AND BCUST.BKG_NO         = BVVD.BKG_NO 
	       AND BCUST.BKG_CUST_TP_CD = 'C'
	       AND DCNTR.BKG_NO(+)      = BCNTR.BKG_NO 
	       AND DCNTR.CNTR_NO(+)     = BCNTR.CNTR_NO   
	       AND BDO.BKG_NO(+)        = DCNTR.BKG_NO
	       AND BDO.RLSE_SEQ(+)      = DCNTR.RLSE_SEQ
	       AND DDTL.BKG_NO(+)       = DCNTR.BKG_NO 
	       AND DDTL.RLSE_SEQ(+)     = DCNTR.RLSE_SEQ 
	       AND DDTL.RLSE_STS_CD(+)  = 'R'      
	       AND VSL.VSL_CD           = BVVD.VSL_CD 
	       AND LOC.LOC_CD           = BVVD.POL_CD 
	       AND CNTR.CNTR_NO         = BCNTR.CNTR_NO 
	       AND YD.YD_CD(+)          = CNTR.CRNT_YD_CD     
	       AND EY.YD_CD(+)          = YD.YD_CD 
	       AND EY.FULL_RLSE_EDI_CD(+) = '1'
	) MST, BKG_FULL_CGO_RLSE_ORD FORD
	WHERE 1=1
	#if ( ${in_do_no} != '')
	  AND DO_NO_YN = @[in_do_no]
	#end
	AND FORD.BKG_NO(+)            = MST.BKG_NO
	AND FORD.CNTR_NO(+)           = MST.CNTR_NO
	AND FORD.RLSE_ORD_SEQ(+)      = MST.MAX_RLSE_SEQ
	#if ( ${sent_flg} != 'A')
	AND DECODE( NVL(FORD.CGOR_MZD_CD,'N') ,'E','Y'
	                                      ,'F','Y'
	                                      ,'M','Y'
	                                      ,'N')    = @[sent_flg]
	#end
	ORDER BY MST.BL_NO
)			]]></sql>
			<params>
				<param name="cnt_cd" type="12" value="" out="N"/>
				<param name="in_bl_no" type="12" value="" out="N"/>
				<param name="usr_ofc_cd" type="12" value="" out="N"/>
				<param name="in_option" type="12" value="" out="N"/>
				<param name="in_cntr_no" type="12" value="" out="N"/>
				<param name="in_vvd" type="12" value="" out="N"/>
				<param name="in_pod" type="12" value="" out="N"/>
				<param name="in_del" type="12" value="" out="N"/>
				<param name="in_do_no" type="12" value="" out="N"/>
				<param name="sent_flg" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
