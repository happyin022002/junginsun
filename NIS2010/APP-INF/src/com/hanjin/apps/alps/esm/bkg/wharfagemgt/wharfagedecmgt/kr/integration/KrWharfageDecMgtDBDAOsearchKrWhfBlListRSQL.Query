<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="KrWharfageDecMgtDBDAOsearchKrWhfBlListRSQL">
			<desc><![CDATA[한국 WHF 신고 대상 BL 목록 조회
2011.03.30 김영철 [CHM-201109395] Korea Wharfage 보완 요청 - Cancel Booking 인지 값 조회]]></desc>
			<sql><![CDATA[
--3. 국내 개항간 B/L  I(I/B) 존재
--   국내 개항간이라고 함은, 부산에서 양하하여 T/S 되어 인천, 광양 평택 등을 가는 화물입니다. 
--    이는 국내화물로 볼 수 있으나 부산에서 T/S  됨으로  WHF 신고시 T/S로 인식되어 야 합니다. 
--   상기 모선에 순수 I/B B/L 건수는 114개 인데요, 제가 NIS&ALPS 확인해 보니까 국내 항간 
--   B/L이 4건이 추가 되어 있었습니다. 
--   국내 항간   B/L은 I/F 시 T(T/S)로 분류 될 수 있게 부탁 드립니다. 
--(EX) HNBN0042W, KRPUS, INBOUND, MEXY8105004
-- ==> BOOKING의 LAST POD와 비교하여 같으면 II (I), 다르면 IT (T)로 구분
SELECT DISTINCT
       BBBB.BKG_NO, BBBB.BL_NO,
       CASE WHEN SUBSTR(@[whf_bnd_cd], 1, 1) = 'I' AND SUBSTR(BBBB.POD_CD, 1, 2) = 'KR' AND BBBB.POD_CD != BBBB.DMST_PORT_CD THEN 'T' ELSE BBBB.CSTMS_DECL_TP_CD END AS CSTMS_DECL_TP_CD,
       'O' AS DNLD_STS,
	   DECODE(CCCC.BKG_STS_CD,'X','Cancel Booking','') AS RESULTS
  FROM (
        SELECT BBB.BKG_NO, BBB.CSTMS_DECL_TP_CD, BBB.VSL_CD, BBB.SKD_VOY_NO,BBB.SKD_DIR_CD, MAX(TRNS_SEQ) AS TRNS_SEQ
          FROM (
                SELECT DISTINCT AA.VSL_CD, AA.SKD_VOY_NO, AA.SKD_DIR_CD
                  FROM (
                        SELECT A.MRN_NO, A.MRN_CHK_NO, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.IO_BND_CD, A.PORT_CD, A.OB_DECL_TP_CD, MAX(VVD_SEQ) AS VVD_SEQ
                          FROM BKG_CSTMS_KR_VVD_SMRY A
                         WHERE A.MRN_NO = SUBSTR(@[mrn_no], 1, 10)
                           AND A.MRN_CHK_NO = SUBSTR(@[mrn_no], 11, 1)
                           AND A.IO_BND_CD = SUBSTR(@[whf_bnd_cd], 1, 1)
                           AND A.PORT_CD = @[whf_pol_cd]
                         GROUP BY A.MRN_NO, A.MRN_CHK_NO, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.IO_BND_CD, A.PORT_CD, A.OB_DECL_TP_CD) AA,
                       BKG_CSTMS_KR_VVD_SMRY BB
                 WHERE BB.MRN_NO = AA.MRN_NO
                   AND BB.MRN_CHK_NO = AA.MRN_CHK_NO
                   AND BB.VSL_CD = AA.VSL_CD
                   AND BB.SKD_VOY_NO = AA.SKD_VOY_NO
                   AND BB.SKD_DIR_CD = AA.SKD_dIR_CD
                   AND BB.OB_DECL_TP_CD = AA.OB_DECL_TP_CD
                   AND BB.VVD_SEQ = AA.VVD_SEQ) AAA,
               BKG_CSTMS_KR_BL BBB, MDM_LOCATION CCC
         WHERE BBB.VSL_CD = AAA.VSL_CD
           AND BBB.SKD_VOY_NO = AAA.SKD_VOY_NO
           AND BBB.SKD_DIR_CD = AAA.SKD_DIR_CD
           AND BBB.CSTMS_DECL_TP_CD IN (DECODE(@[whf_bnd_cd], 'OO', 'E', 'I'), DECODE(@[whf_bnd_cd], 'OO', 'R', 'T'))
           AND DECODE(@[whf_bnd_cd], 'II', BBB.TS_POD_CD, BBB.TS_POL_CD) = @[whf_pol_cd]
           AND NVL(BBB.DELT_FLG, 'N') = 'N'
           AND CCC.LOC_CD = DECODE(@[whf_bnd_cd], 'II', BBB.TS_POD_CD, BBB.TS_POL_CD)
         GROUP BY BBB.BKG_NO, BBB.CSTMS_DECL_TP_CD,BBB.VSL_CD, BBB.SKD_VOY_NO,BBB.SKD_DIR_CD) AAAA,
       BKG_CSTMS_KR_BL BBBB,
       BKG_BOOKING CCCC
 WHERE BBBB.BKG_NO = AAAA.BKG_NO
   AND BBBB.TRNS_SEQ = AAAA.TRNS_SEQ
   AND BBBB.VSL_CD = AAAA.VSL_CD
   AND BBBB.SKD_VOY_NO = AAAA.SKD_VOY_NO
   AND BBBB.SKD_DIR_CD = AAAA.SKD_DIR_CD
   AND BBBB.CSTMS_DECL_TP_CD = AAAA.CSTMS_DECL_TP_CD
   AND BBBB.TRNS_SEQ = AAAA.TRNS_SEQ
   AND CCCC.BKG_NO(+) = BBBB.BKG_NO
 ORDER BY BKG_NO			]]></sql>
			<params>
				<param name="whf_bnd_cd" type="12" value="" out="N"/>
				<param name="mrn_no" type="12" value="" out="N"/>
				<param name="whf_pol_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
