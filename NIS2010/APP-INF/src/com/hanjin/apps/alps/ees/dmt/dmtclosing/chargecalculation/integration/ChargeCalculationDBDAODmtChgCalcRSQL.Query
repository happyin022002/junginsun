<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ChargeCalculationDBDAODmtChgCalcRSQL">
			<desc><![CDATA[ChargeCalculationDBDAODmtChgCalcVORSQL.Query]]></desc>
			<sql><![CDATA[
SELECT ( SELECT INTG_CD_VAL_DP_DESC 
            FROM COM_INTG_CD_DTL 
           WHERE INTG_CD_ID = 'CD03382' 
             AND INTG_CD_VAL_CTNT = AA.DMDT_DELT_RQST_STS_CD ) AS INACT_STS_NM
     , AA.*
#if (${est_mk} != 'P')  
	 , DECODE(TRIM(DMDT_EXPT_RQST_STS_CD), NULL, NULL, '', NULL, DECODE(DMDT_EXPT_RQST_STS_CD, 'R', 'BLUE', 'J', 'RED', 'O', 'RED', 'A', 'BLACK', 'PINK')) DMDT_EXPT_RQST_STS_COLOR
	   , CASE WHEN DMDT_EXPT_RQST_STS_CD = 'O' THEN 
				   (SELECT DECODE(MAX(AFT_BKG_PATH_LVL), 1, 'SCO PIC ', 2, 'SSZ/BAG ', 3, 'RHQ PIC ', 4, 'RHQ MGR ', 5, 'HO PIC ', 6, 'HO MGR ', '') || 'Counter-Offer'
					  FROM DMT_AFT_BKG_APRO_PATH
 			         WHERE AFT_EXPT_DAR_NO = AA.AFT_EXPT_DAR_NO
					   AND DMDT_EXPT_RQST_STS_CD IS NOT NULL
	 		           AND AFT_BKG_PATH_CPLS_FLG = 'Y')
			 ELSE  (SELECT INTG_CD_VAL_DP_DESC 
			          FROM COM_INTG_CD_DTL
		             WHERE INTG_CD_ID = 'CD01971'
	    	           AND INTG_CD_VAL_CTNT = DMDT_EXPT_RQST_STS_CD)
			 END DMDT_EXPT_RQST_STS_CD_DESC
#end
FROM (
SELECT  DISTINCT
          T1.BKG_NO
        , T1.BL_NO
        , T2.SYS_AREA_GRP_ID                                                               		 AS SVR_ID
        , T2.DMDT_CHG_STS_CD
		,(
			SELECT  CASE 
						WHEN NVL(MAX(DD.DMDT_DELT_RQST_STS_CD), 'N') IN ('C','N') THEN 'N'
						WHEN 0 < MAX((
									SELECT  COUNT(1)
									  FROM  DMT_CHG_DELT_PATH 
									 WHERE  SYS_AREA_GRP_ID     = DD.SYS_AREA_GRP_ID
									   AND  CNTR_NO             = DD.CNTR_NO
									   AND  CNTR_CYC_NO         = DD.CNTR_CYC_NO
									   AND  DMDT_TRF_CD         = DD.DMDT_TRF_CD
									   AND  DMDT_CHG_LOC_DIV_CD = DD.DMDT_CHG_LOC_DIV_CD
									   AND  CHG_SEQ             = DD.CHG_SEQ
									   AND  CHG_OFC_CD          = DD.CHG_OFC_CD
									   AND  DELT_SEQ            = DD.DELT_SEQ
									   AND  CHG_DELT_PATH_LVL  >=
											(
												SELECT  max(CHG_DELT_PATH_LVL)
												  FROM  DMT_CHG_DELT_PATH
												 WHERE  SYS_AREA_GRP_ID        = DD.SYS_AREA_GRP_ID
												   AND  CNTR_NO                = DD.CNTR_NO
												   AND  CNTR_CYC_NO            = DD.CNTR_CYC_NO
												   AND  DMDT_TRF_CD            = DD.DMDT_TRF_CD
												   AND  DMDT_CHG_LOC_DIV_CD    = DD.DMDT_CHG_LOC_DIV_CD
												   AND  CHG_SEQ                = DD.CHG_SEQ
												   AND  CHG_OFC_CD             = DD.CHG_OFC_CD
												   AND  DELT_SEQ               = DD.DELT_SEQ
												   AND  CHG_DELT_PATH_CPLS_FLG = 'Y'
											)
									   and  CHG_DELT_STS_CD = 'A'
								 )) THEN 'X'		--// Charge Deletion 요청 불가, Charge Deletion Cancel 불가
						ELSE MAX(DD.DMDT_DELT_RQST_STS_CD)
					END
						
			  FROM  DMT_CHG_DELT_RQST_APRO DD
			 WHERE  DD.SYS_AREA_GRP_ID     = T2.SYS_AREA_GRP_ID
			   AND	DD.CNTR_NO		       = T2.CNTR_NO
			   AND	DD.CNTR_CYC_NO		   = T2.CNTR_CYC_NO
			   AND	DD.DMDT_TRF_CD		   = T2.DMDT_TRF_CD
			   AND	DD.DMDT_CHG_LOC_DIV_CD = T2.DMDT_CHG_LOC_DIV_CD
			   AND	DD.CHG_SEQ			   = T2.CHG_SEQ
			   AND  DD.DELT_SEQ            = 
					( 
						SELECT  NVL(MAX(DS.DELT_SEQ), 0) 
						  FROM  DMT_CHG_DELT_RQST_APRO DS
						 WHERE  DS.SYS_AREA_GRP_ID     = DD.SYS_AREA_GRP_ID
						   AND  DS.CNTR_NO	           = DD.CNTR_NO
						   AND  DS.CNTR_CYC_NO	       = DD.CNTR_CYC_NO
						   AND  DS.DMDT_TRF_CD	       = DD.DMDT_TRF_CD
						   AND  DS.DMDT_CHG_LOC_DIV_CD = DD.DMDT_CHG_LOC_DIV_CD
						   AND  DS.CHG_SEQ		       = DD.CHG_SEQ
						   AND  DS.CHG_OFC_CD          = DD.CHG_OFC_CD   
						   AND  DS.DMDT_DELT_RQST_STS_CD != 'C'
					)  
		 ) 																						 AS DMDT_DELT_RQST_STS_CD	  
        , T2.CNTR_NO
        , T2.CNTR_CYC_NO
        , T2.DMDT_CHG_LOC_DIV_CD
        , T2.OFC_CD
        , T2.OFC_RHQ_CD
        , T2.CHG_SEQ
        , T1.CNTR_TPSZ_CD
        , T2.FM_MVMT_YD_CD
        , T2.TO_MVMT_YD_CD
        , T2.FM_MVMT_STS_CD
        , T2.TO_MVMT_STS_CD
        , T2.DMDT_TRF_CD
        , T2.FT_DYS
        , T2.FX_FT_OVR_DYS
		-- 조건추가(S) 2013.12.13
		, TO_DATE(TO_CHAR(SYSDATE, 'YYYYMMDD'), 'YYYYMMDD') - TO_DATE(TO_CHAR(NVL(T2.TO_MVMT_DT, T2.FT_END_DT), 'YYYYMMDD'), 'YYYYMMDD') AS OVR_DUE
		-- 조건추가(E)
        , TO_CHAR(T2.FM_MVMT_DT, 'YYYYMMDD')                                                     AS FM_MVMT_DT
        , TO_CHAR(T2.FM_MVMT_DT, 'HH24MI')                                                       AS FM_MVMT_DT_TIME
        , TO_CHAR(T2.TO_MVMT_DT, 'YYYYMMDD')                                                     AS TO_MVMT_DT
        , TO_CHAR(T2.TO_MVMT_DT, 'HH24MI')                                                       AS TO_MVMT_DT_TIME
        , TO_CHAR(T2.FT_CMNC_DT, 'YYYYMMDD')                                                     AS FT_CMNC_DT
        , TO_CHAR(T2.FT_END_DT , 'YYYYMMDD')                                                     AS FT_END_DT
        , T2.BZC_TRF_CURR_CD
        , T2.ORG_CHG_AMT
        , T2.SC_RFA_EXPT_AMT
        , T2.AFT_EXPT_DC_AMT
        , T2.BIL_AMT
        , DECODE(T2.CHG_SEQ, 1, 'G', 'B')                                                        AS CHG_TYPE
        , NVL(T2.UCLM_FLG, 'N')                                                                  AS UCLM_FLG
        , NVL(T1.SOC_FLG, 'N')                                                                   AS SOC_FLG
        , CASE
          WHEN T2.DMDT_TRF_CD='DMIF' AND T2.TO_MVMT_STS_CD      ='ID'               THEN 'L'
          WHEN T2.DMDT_TRF_CD='DMIF' AND T2.TO_MVMT_STS_CD NOT IN ('ID','CS','DR')  THEN 'I'
          WHEN T2.DMDT_TRF_CD='DMOF' AND T2.DMDT_CHG_LOC_DIV_CD<>'POL'              THEN 'L'
          WHEN T2.DMDT_TRF_CD='DMOF' AND T2.DMDT_CHG_LOC_DIV_CD ='POL'              THEN 'I'
          END                                                                                 AS LI
        , (
          SELECT NVL(HLG_TP_CD, 'N')      /* 'C'ARRIER, 'M'ERCHANT, 'N'ULL */
          FROM   BKG_EUR_TRO
          WHERE  BKG_NO              = T1.BKG_NO
          AND    IO_BND_CD           = SUBSTR(T2.DMDT_TRF_CD, 3, 1)    /* IN/OUT BOUND */
          AND    NVL(CXL_FLG, 'N')   = 'N'
          AND    CNTR_NO             = T2.CNTR_NO
          AND    ROWNUM              = 1
          )                                                                                     AS CH
        , (
          SELECT 'Y'
          FROM   DUAL
          WHERE  EXISTS (
                        SELECT  S2.RLSE_STS_CD
                        FROM    BKG_DO     S1,
                                BKG_DO_DTL S2
                        WHERE   S1.BKG_NO        = S2.BKG_NO
                        AND     S1.BKG_NO        = T1.BKG_NO
                        AND     S2.RLSE_STS_CD IN ('R', 'I')
                        ) 
          )                                                                                   AS D_O
        , (	
          SELECT  S2.EVNT_OFC_CD
          FROM    BKG_DO         S1,
                  BKG_DO_DTL     S2
          WHERE   S1.BKG_NO        = S2.BKG_NO
          AND     S1.BKG_NO        = T1.BKG_NO
          AND     S2.RLSE_STS_CD IN ('R', 'I')
          AND     ROWNUM           = 1 
          )                                                                                   AS RLSE_OFC
        , T4.CLT_OFC_CD
        , NVL(T2.OFC_TRNS_FLG, 'N') AS OFC_TRNS_FLG
        ,(
          SELECT 'C'
          FROM   DUAL
          WHERE  EXISTS (
                        SELECT 1
                        FROM   BKG_ROLL_OVR R
                        WHERE  R.BKG_NO          = T1.BKG_NO
                        AND    R.ROLL_OVR_RSN_CD IN ( 'C','H' )
          	        )
        )                                                                                   AS ROLL_OVR
        , T2.DMDT_INV_NO
        , TO_CHAR(T5.CRE_DT, 'YYYYMMDD')                                                    AS ISS_DT
        , T5.INV_CURR_CD
        , T6.CNTR_INV_AMT
        , T5.DMDT_AR_IF_CD
        , T2.WEB_IND_FLG 
        , DECODE(T2.WEB_IND_FLG, 'Y', TO_CHAR(NVL(T2.WEB_MTY_DT, T2.TO_MVMT_DT), 'YYYY-MM-DD'), TO_CHAR(T2.WEB_MTY_DT, 'YYYY-MM-DD'))         AS WEB_CRE_DT
        , DECODE(T2.WEB_IND_FLG, 'Y', TO_CHAR(NVL(T2.FT_END_DT, T2.TO_MVMT_DT) + 7, 'YYYY-MM-DD'), TO_CHAR(T2.FT_END_DT + 7, 'YYYY-MM-DD')) AS WEB_MTY_DT
        , T2.WEB_NTFY_PIC_NM
        , T2.DUL_TP_EXPT_FLG
        , T2.CXL_BKG_CHG_FLG
        , NVL(T6.CRE_OFC_CD, T2.OFC_CD)                                                     AS CRE_OFC_CD
        , T2.NOT_CRE_BAL_FLG
#if (${est_mk} != 'P')  
        , (
          SELECT  COUNT (CNTR_NO) 
          FROM    BKG_CONTAINER
          WHERE   BKG_NO  = @[bkg_no]
          )                                                                                 AS BKG_QTY
        , T3.INCUR_QTY
        , T3.INCUR_CNTR_TEU_KNT
        , T3.EXPT_QTY
        , T3.EXPT_CNTR_TEU_KNT
        , T3.INCUR_AMT
        , T3.EXPT_DYS
        , T3.EXPT_COST_AMT
        , (
          SELECT  SUM(DECODE(SUBSTR(CNTR_TPSZ_CD,2,1),'2',1,2))
          FROM    BKG_CONTAINER
          WHERE   BKG_NO     = @[bkg_no]
          AND     SUBSTR(CNTR_TPSZ_CD,1,1) <> 'Q'
          )                                                                               AS BKG_CNTR_TEU
        , T1.BKG_DE_TERM_CD 
        , T1.BKG_RCV_TERM_CD 
		, (SELECT AA.AFT_EXPT_DAR_NO
              FROM DMT_AFT_BKG_ADJ_RQST_DTL CC
                 , DMT_AFT_BKG_CNTR BB
                 , DMT_AFT_BKG_ADJ_RQST AA
             WHERE 1=1
               AND CC.BKG_NO = T1.BKG_NO
               AND CC.AFT_EXPT_DAR_NO = BB.AFT_EXPT_DAR_NO
               AND CC.AFT_EXPT_ADJ_SEQ = BB.AFT_EXPT_ADJ_SEQ
               AND CC.DMDT_TRF_CD = T2.DMDT_TRF_CD
               AND BB.SYS_AREA_GRP_ID = T2.SYS_AREA_GRP_ID
               AND BB.CNTR_NO = T2.CNTR_NO
               AND BB.CNTR_CYC_NO = T2.CNTR_CYC_NO
               AND BB.DMDT_TRF_CD = T2.DMDT_TRF_CD
               AND BB.DMDT_CHG_LOC_DIV_CD = T2.DMDT_CHG_LOC_DIV_CD
               AND BB.CHG_SEQ = T2.CHG_SEQ
               AND AA.AFT_EXPT_DAR_NO = BB.AFT_EXPT_DAR_NO
               AND AA.RQST_DT = (SELECT MAX(RQST_DT)
                      FROM DMT_AFT_BKG_ADJ_RQST A1
                         , DMT_AFT_BKG_ADJ_RQST_DTL B1
                     WHERE A1.AFT_EXPT_DAR_NO=B1.AFT_EXPT_DAR_NO
                       AND B1.BKG_NO=CC.BKG_NO )
               AND DMDT_EXPT_RQST_STS_CD != 'T' ) AFT_EXPT_DAR_NO
         , (SELECT DMDT_EXPT_RQST_STS_CD
              FROM DMT_AFT_BKG_ADJ_RQST_DTL CC
                 , DMT_AFT_BKG_CNTR BB
                 , DMT_AFT_BKG_ADJ_RQST AA
             WHERE 1=1
               AND CC.BKG_NO = T1.BKG_NO
               AND CC.AFT_EXPT_DAR_NO = BB.AFT_EXPT_DAR_NO
               AND CC.AFT_EXPT_ADJ_SEQ = BB.AFT_EXPT_ADJ_SEQ
               AND CC.DMDT_TRF_CD = T2.DMDT_TRF_CD
               AND BB.SYS_AREA_GRP_ID = T2.SYS_AREA_GRP_ID
               AND BB.CNTR_NO = T2.CNTR_NO
               AND BB.CNTR_CYC_NO = T2.CNTR_CYC_NO
               AND BB.DMDT_TRF_CD = T2.DMDT_TRF_CD
               AND BB.DMDT_CHG_LOC_DIV_CD = T2.DMDT_CHG_LOC_DIV_CD
               AND BB.CHG_SEQ = T2.CHG_SEQ
               AND AA.AFT_EXPT_DAR_NO = BB.AFT_EXPT_DAR_NO
               AND AA.RQST_DT = (SELECT MAX(RQST_DT)
                      FROM DMT_AFT_BKG_ADJ_RQST A1
                         , DMT_AFT_BKG_ADJ_RQST_DTL B1
                     WHERE A1.AFT_EXPT_DAR_NO=B1.AFT_EXPT_DAR_NO
                       AND B1.BKG_NO=CC.BKG_NO )
               AND DMDT_EXPT_RQST_STS_CD != 'T' ) DMDT_EXPT_RQST_STS_CD
#end
#if (${est_mk} == 'P') 
FROM	  DMT_CHG_PRE_CALC_BKG_CNTR T1
        , DMT_CHG_PRE_CALC          T2
#else
FROM	  DMT_CHG_BKG_CNTR          T1
        , DMT_CHG_CALC              T2
        , DMT_EXPT_CHG_CALC         T3
#end
        , BKG_RATE                  T4
        , DMT_INV_MN                T5
        , DMT_INV_DTL               T6
WHERE   T1.SYS_AREA_GRP_ID      = T2.SYS_AREA_GRP_ID
AND     T1.CNTR_NO              = T2.CNTR_NO
AND     T1.CNTR_CYC_NO          = T2.CNTR_CYC_NO
AND     T1.BKG_NO               = T4.BKG_NO(+)
AND     T1.BKG_NO               = @[bkg_no]
AND     T2.DMDT_TRF_CD          = @[dmdt_trf_cd]
#if (${est_mk} != 'P')
AND     T2.DMDT_CHG_STS_CD   IN (
	#foreach( $chg_sts_cd in ${chg_sts_cd_list} )
		#if($velocityCount < $chg_sts_cd_list.size()) '$chg_sts_cd', #else '$chg_sts_cd' #end
	#end
	)
AND     T2.CNTR_NO               = T3.CNTR_NO             (+)
AND     T2.CNTR_CYC_NO           = T3.CNTR_CYC_NO         (+)
AND     T2.DMDT_TRF_CD           = T3.DMDT_TRF_CD         (+)
AND     T2.DMDT_CHG_LOC_DIV_CD   = T3.DMDT_CHG_LOC_DIV_CD (+)
AND     T2.CHG_SEQ               = T3.CHG_SEQ             (+)
AND     T3.BKG_NO            (+) = @[bkg_no]
#end
AND     NOT (T2.DUL_TP_EXPT_FLG  = 'Y' AND SUBSTR(T2.DMDT_TRF_CD, 1, 1) = 'D')
AND     T2.DMDT_CHG_LOC_DIV_CD	<> 'SZP'
AND     T2.DMDT_INV_NO           = T6.DMDT_INV_NO       (+)
AND     T2.SYS_AREA_GRP_ID       = T6.SYS_AREA_GRP_ID   (+)
AND     T2.CNTR_NO               = T6.CNTR_NO           (+)
AND     T2.CNTR_CYC_NO           = T6.CNTR_CYC_NO       (+)
AND     T2.DMDT_TRF_CD           = T6.DMDT_TRF_CD       (+)
AND     T2.DMDT_CHG_LOC_DIV_CD	 = T6.DMDT_CHG_LOC_DIV_CD(+)
AND     T2.CHG_SEQ               = T6.CHG_SEQ           (+)
AND     T5.DMDT_INV_NO        (+)= T6.DMDT_INV_NO
AND     T5.CRE_OFC_CD         (+)= T6.CRE_OFC_CD
AND     T5.DMDT_INV_STS_CD    (+)= 'I'
		
#if (${rhq_ofc_cd} != 'All')
AND     T2.OFC_RHQ_CD            = @[rhq_ofc_cd]
#end

-- 조건추가(S) 2013.09.11
#if(${uclm_flg} != 'ALL')          
AND     NVL(T2.UCLM_FLG, 'N')    =  @[uclm_flg]
#end
-- 조건추가(E)

ORDER BY T2.DMDT_TRF_CD, T2.CNTR_NO, T2.CNTR_CYC_NO, TO_CHAR(T2.FM_MVMT_DT, 'YYYYMMDD')
) AA			]]></sql>
			<params>
				<param name="bkg_no" type="12" value=" " out="N"/>
				<param name="dmdt_trf_cd" type="12" value="" out="N"/>
				<param name="rhq_ofc_cd" type="12" value="" out="N"/>
				<param name="uclm_flg" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
