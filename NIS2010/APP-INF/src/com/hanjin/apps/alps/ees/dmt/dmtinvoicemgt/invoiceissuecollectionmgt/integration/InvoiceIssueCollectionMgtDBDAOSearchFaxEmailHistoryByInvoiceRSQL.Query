<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="InvoiceIssueCollectionMgtDBDAOSearchFaxEmailHistoryByInvoiceRSQL">
			<desc><![CDATA[InvoiceIssueCollectionMgtDBDAOSearchFaxEmailHistoryByInvoiceRSQL]]></desc>
			<sql><![CDATA[
select  T2.DMDT_INV_NO 								as INVNOO
	   ,T2.DMDT_SND_DOC_TP_CD						as SHTYPE
	   ,decode(T2.DMDT_FAX_EML_SND_TP_CD, 'F', T2.DMDT_PAYR_FAX_NO, T2.DMDT_PAYR_EML)	
													as FAXEML
	   ,decode(T2.DMDT_FAX_EML_SND_TP_CD, 'E', (
													select  decode(EML_PROC_STS_CD, 3, 'Sent Successfully', '')
													  from  COM_EML_SND_INFO
													 where  EML_SND_NO = T2.FAX_EML_SND_NO
												)
											 , (
													select  nvl(XPT_ERR_MSG , FAX_ERR_MSG)
													  from  COM_FAX_SND_INFO
													 where  RD_SUB_SYS_CD = 'DMT'
													   and  FAX_SND_NO    = T2.FAX_EML_SND_NO
												)
		) 											as RSTMSG
	   ,to_char(T2.CRE_DT, 'YYYY-MM-DD HH24:mi') 	as SNDDAT
	   ,T2.CRE_OFC_CD                          		as SNDOFF
	   ,T2.CRE_USR_ID                          		as SNDRID	
	   ,(
			select  USR_NM 
			  from  COM_USER 
			 where  USR_ID = T2.CRE_USR_ID
		)											as SNDRNM
  from  (
			select  T1.DMDT_INV_NO
			  from  DMT_INV_MN  T1
			 where  T1.DMDT_INV_NO in
					(
						#foreach( $dmdt_inv_no_p in ${tempINVOICEList}) 
							#if($velocityCount < $tempINVOICEList.size()) 
							   '$dmdt_inv_no_p', 
							#else 
							   '$dmdt_inv_no_p' 
							#end 
						#end
					)
						   
			union all
						   
			select  DMDT_INV_NO
			  from  (
						select  T1.DMDT_INV_NO
							   ,row_number() over (order by T1.UPD_DT desc) as VT_INV_SEQ
						  from  DMT_INV_MN  T1
						 where  (T1.DMDT_INV_NO, T1.CRE_OFC_CD) in
								(
									 select  DMDT_INV_NO, CRE_OFC_CD
									   from  DMT_INV_DTL
									  where  (SYS_AREA_GRP_ID, CNTR_NO, CNTR_CYC_NO, DMDT_TRF_CD, DMDT_CHG_LOC_DIV_CD, CHG_SEQ) in
											 (
												 select  SYS_AREA_GRP_ID, CNTR_NO, CNTR_CYC_NO, DMDT_TRF_CD, DMDT_CHG_LOC_DIV_CD, CHG_SEQ
												   from  DMT_INV_DTL
												  where  DMDT_INV_NO in
														(
															#foreach( $dmdt_inv_no_p in ${tempINVOICEList}) 
																#if($velocityCount < $tempINVOICEList.size()) 
																   '$dmdt_inv_no_p', 
																#else 
																   '$dmdt_inv_no_p' 
																#end 
															#end
														)												  
											 )
								 ) 
						   and  T1.DMDT_INV_NO not in
								(
									#foreach( $dmdt_inv_no_p in ${tempINVOICEList}) 
										#if($velocityCount < $tempINVOICEList.size()) 
										   '$dmdt_inv_no_p', 
										#else 
										   '$dmdt_inv_no_p' 
										#end 
									#end
								)						   
						   and  T1.DMDT_INV_STS_CD     = 'X'
						   and  T1.DMDT_VT_INV_STS_CD  = 'I'
						   and  exists
								(
									select  1
									  from  DMT_FAX_EML_SND_HIS
									 where  DMDT_INV_NO = T1.DMDT_INV_NO
								)
					)
			 where  VT_INV_SEQ = 1
		) 						T1
	   ,DMT_FAX_EML_SND_HIS 	T2
 where  T1.DMDT_INV_NO = T2.DMDT_INV_NO   

#if (${shttppp} != 'A')
   and  T2.DMDT_SND_DOC_TP_CD = @[shttppp]
#end

group by T2.DMDT_INV_NO
        ,T2.DMDT_SND_DOC_TP_CD
        ,T2.DMDT_PAYR_FAX_NO
        ,T2.DMDT_PAYR_EML
        ,T2.FAX_EML_SND_RSLT_MSG
        ,T2.CRE_DT
        ,T2.CRE_OFC_CD
        ,T2.CRE_USR_ID
        ,T2.FAX_EML_SND_NO
        ,T2.DMDT_FAX_EML_SND_TP_CD

order by T2.DMDT_INV_NO desc, T2.CRE_DT desc			]]></sql>
			<params>
				<param name="shttppp" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
