<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="LeasePlanDBDAOOffHirePlanPerformanceListRSQL">
			<desc><![CDATA[Off-Hire Plan Performance List Search]]></desc>
			<sql><![CDATA[
SELECT NVL(OFFH_RGN_LOC_CD,'G.TTL') AS OFFH_RGN_LOC_CD,
       DECODE(NVL(OFFH_RGN_LOC_CD,'G.TTL'),'G.TTL','',NVL(OFFH_LOC_CD,'TTL')) AS OFFH_LOC_CD,
#if ( ${offh_pln_tp_cd} == 'O' )
       DECODE(NVL(OFFH_RGN_LOC_CD,'G.TTL'),'G.TTL','',LSTM_CD) AS LSTM_CD,
#else
       DECODE(NVL(OFFH_RGN_LOC_CD,'G.TTL'),'G.TTL','',NVL(LSTM_CD,'TTL')) AS LSTM_CD,
#end
       CNTR_TPSZ_CD,
       TYPE_CD,
       DECODE(TYPE_CD, 1, 'Plan', 2, 'PFMC', 3, 'Ratio') AS TYPE_NM,
#foreach($key IN ${offh_yrmon_seq})
#set ($col_name='MNTH_'+$velocityCount)
       MAX(DECODE(OFFH_YRMON, '$key', VAL, DECODE(TYPE_CD, 3, '0%', '0'))) AS $col_name,
#end
       MAX(DECODE(OFFH_YRMON, 'G.TTL',  VAL, DECODE(TYPE_CD, 3, '0%', '0'))) AS TTL_QTY
  FROM (
         SELECT AA.OFFH_RGN_LOC_CD,
                AA.OFFH_LOC_CD,
                AA.LSTM_CD,
                AA.CNTR_TPSZ_CD,
                NVL(AA.OFFH_YRMON, 'G.TTL') AS OFFH_YRMON,
                TP.TYPE_CD,
                DECODE(TP.TYPE_CD, 1, TRIM(TO_CHAR(AA.PLAN_OFFH_QTY,'999,999,999')), 
                                   2, TRIM(TO_CHAR(AA.PFMC_OFFH_QTY,'999,999,999')), 
                                   DECODE(AA.PLAN_OFFH_QTY, 0, '0%', TO_CHAR(ROUND(AA.PFMC_OFFH_QTY/AA.PLAN_OFFH_QTY*100, 2))||'%')) AS VAL
           FROM (
                  SELECT OFFH_RGN_LOC_CD,
                         OFFH_LOC_CD,
                         LSTM_CD,
                         CNTR_TPSZ_CD,
                         OFFH_YRMON,
                         SUM(PLAN_OFFH_QTY) AS PLAN_OFFH_QTY,
                         SUM(PFMC_OFFH_QTY) AS PFMC_OFFH_QTY,
                         GROUPING_ID ( OFFH_RGN_LOC_CD,
                                       OFFH_LOC_CD,
                                       LSTM_CD,
                                       CNTR_TPSZ_CD,
                                       OFFH_YRMON ) AS GRP_ID
                    FROM (
                           SELECT A.OFFH_YRMON,
#if ( ${offh_pln_tp_cd} == 'O' )
                                  'ALL' AS LSTM_CD,
#else
                                  A.LSTM_CD,
#end
                                  A.CNTR_TPSZ_CD,
                                  A.OFFH_RGN_LOC_CD,
                                  A.OFFH_LOC_CD,
                                  A.OFFH_QTY AS PLAN_OFFH_QTY,
                                  0 AS PFMC_OFFH_QTY
                             FROM LSE_OFFH_PLN A
                            WHERE 1 = 1

#if ( ${cntr_tpsz_cd} != '' )
                              AND A.CNTR_TPSZ_CD IN (
#foreach($key IN ${cntr_tpsz_cd_seq})
#if($velocityCount < $cntr_tpsz_cd_seq.size())
                                                      '$key',
#else
                                                      '$key'
#end
#end
                                                    )
#end

#if ( ${offh_yrmon} != '' )
                              AND A.OFFH_YRMON IN (
#foreach($key IN ${offh_yrmon_seq})
#if($velocityCount < $offh_yrmon_seq.size())
                                                    '$key',
#else
                                                    '$key'
#end
#end
                                                  )
#end

#if ( ${lstm_cd} != '' )
                              AND A.LSTM_CD = @[lstm_cd]
#end

#if ( ${loc_cd} != '' )
#if ( ${loc_tp} == 'RCC' )
                              AND A.OFFH_RGN_LOC_CD = @[loc_cd]
#elseif ( ${loc_tp} == 'LCC' )
                              AND A.OFFH_LOC_CD = @[loc_cd]
#end
#end

#if ( ${offh_pln_tp_cd} != '' )
                              AND A.OFFH_PLN_TP_CD = @[offh_pln_tp_cd]
#end

#if ( ${offh_loc_tp_cd} != '' )
                              AND A.OFFH_LOC_TP_CD = @[offh_loc_tp_cd]
#end

                              AND A.OFFH_VER_SEQ = ( SELECT /*+ INDEX_DESC (B XPKLSE_OFFH_PLN) */
                                                            OFFH_VER_SEQ
                                                       FROM LSE_OFFH_PLN B
                                                      WHERE 1 = 1
#if ( ${offh_pln_tp_cd} != '' )
                                                        AND B.OFFH_PLN_TP_CD = @[offh_pln_tp_cd]
#end

#if ( ${offh_loc_tp_cd} != '' )
                                                        AND B.OFFH_LOC_TP_CD = @[offh_loc_tp_cd]
#end
                                                        AND B.OFFH_VER_SEQ > 0
                                                        AND ROWNUM = 1 )
                           UNION ALL
                           SELECT TO_CHAR(B.CNTR_STS_EVNT_DT, 'YYYYMM') AS OFFH_YRMON,
#if ( ${offh_pln_tp_cd} == 'O' )
                                  'ALL' AS LSTM_CD,
#else
                                  A.LSTM_CD,
#end
                                  C.CNTR_TPSZ_CD,
                                  B.RCC_CD AS OFFH_RGN_LOC_CD,
#if ( ${offh_pln_tp_cd} == 'O' )
                                  B.LCC_CD AS OFFH_LOC_CD,
#else
                                  B.RCC_CD AS OFFH_LOC_CD,
#end
                                  0 AS PLAN_OFFH_QTY,
                                  COUNT(B.CNTR_NO) AS PFMC_OFFH_QTY
                             FROM MST_CONTAINER C,
                                  MST_CNTR_STS_HIS B,
                                  LSE_AGREEMENT A
                            WHERE C.HJS_CRE_FLG = 'N'
#if ( ${cntr_tpsz_cd} != '' )
                              AND C.CNTR_TPSZ_CD IN (
#foreach($key IN ${cntr_tpsz_cd_seq})
#if($velocityCount < $cntr_tpsz_cd_seq.size())
                                                     '$key',
#else
                                                     '$key'
#end
#end
                                                    )
#end
                              AND C.CNTR_NO = B.CNTR_NO
                              AND SUBSTR(NVL(B.CNTR_STS_RMK, ' '), 1, 6) <> 'SELLOE'
                              AND B.AGMT_SEQ <> 999990
                              AND B.CNTR_LSTM_CNG_FLG = 'N'
                              AND B.CNTR_STS_EVNT_DT BETWEEN TO_DATE(@[from_offh_yrmon], 'YYYY-MM') AND LAST_DAY(TO_DATE(@[to_offh_yrmon], 'YYYY-MM'))+0.99999
#if ( ${loc_cd} != '' )
#if ( ${loc_tp} == 'RCC' )
                              AND B.RCC_CD = @[loc_cd]
#elseif ( ${loc_tp} == 'LCC' )
                              AND B.LCC_CD = @[loc_cd]
#end
#end
                              --AND B.CNTR_STS_CD IN ('LSO', 'DIO', 'TLL', 'SRO', 'DON', 'SCR', 'SLD')
                              AND B.CNTR_STS_CD IN ('LSO', 'DIO')
                              AND B.AGMT_SEQ = A.AGMT_SEQ
                              AND B.AGMT_CTY_CD = A.AGMT_CTY_CD
#if ( ${lstm_cd} != '' )
                              AND A.LSTM_CD = @[lstm_cd]
#else
                              AND A.LSTM_CD IN ('LT','ST')
#end
                            GROUP BY B.CNTR_STS_EVNT_DT, A.LSTM_CD, C.CNTR_TPSZ_CD, B.RCC_CD, 
#if ( ${offh_pln_tp_cd} == 'O' )
                                  B.LCC_CD
#else
                                  B.RCC_CD
#end
                         )
                   GROUP BY CUBE ( OFFH_RGN_LOC_CD, OFFH_LOC_CD, LSTM_CD, CNTR_TPSZ_CD, OFFH_YRMON )
                ) AA
              , ( SELECT LEVEL TYPE_CD FROM DUAL CONNECT BY LEVEL <= 3 ) TP
          WHERE GRP_ID IN (0,1,14,15,30,31)
       ) BB
 GROUP BY BB.OFFH_RGN_LOC_CD, BB.OFFH_LOC_CD, BB.LSTM_CD, BB.CNTR_TPSZ_CD, BB.TYPE_CD
 ORDER BY BB.OFFH_RGN_LOC_CD, BB.OFFH_LOC_CD, BB.LSTM_CD, BB.CNTR_TPSZ_CD, BB.TYPE_CD			]]></sql>
			<params>
				<param name="lstm_cd" type="12" value="" out="N"/>
				<param name="loc_cd" type="12" value="" out="N"/>
				<param name="offh_pln_tp_cd" type="12" value="" out="N"/>
				<param name="offh_loc_tp_cd" type="12" value="" out="N"/>
				<param name="from_offh_yrmon" type="12" value="" out="N"/>
				<param name="to_offh_yrmon" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
