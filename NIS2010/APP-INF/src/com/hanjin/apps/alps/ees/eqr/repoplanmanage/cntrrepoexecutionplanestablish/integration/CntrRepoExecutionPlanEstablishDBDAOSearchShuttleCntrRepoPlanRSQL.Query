<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CntrRepoExecutionPlanEstablishDBDAOSearchShuttleCntrRepoPlanRSQL">
			<desc><![CDATA[컨테이너 이송 실행 계획 조회 Shuttle (EES_EQR_083) 정보 조회]]></desc>
			<sql><![CDATA[
SELECT 
    PLN_YRWK													  						
    ,COMPANY                                                      
    ,DIVISION                                                     
    ,ITEM                                                         
    ,FRLOC                                                                  
    ,ETD														  
    ,TOLOC                                                        
    ,ETA														  
    ,PURPOSE                                                      
    ,CNTRNO                                                       
    ,SOSEND		                                                  
    ,REF_ID       						                          
    ,CMB_REF_ID    

    ,SUM(TOTALVOL)  TOTALVOL                                      
    #foreach(${key} in ${tpszArr}) 
        ,SUM(${key}VOL)     ${key}VOL			  
    #end
    ,SUM(TOTALCOST) TOTALCOST                                     
    #foreach(${key} in ${tpszArr}) 
        ,SUM(${key}COST)    ${key}COST            
    #end        	
    ,REPO_PLN_ID 	## HIDDEN                                     
    ,SORTNUM    	## HIDDEN	PLAN(1), Execution(2), SO(3)를 구분
    ,NUM        	## HIDDEN 	NORMAL ROW(1), SUB TOTAL(2), GRAND TOTAL(3) 구분 
    ,'' CNTRNOINPUT  ## HIDDEN                                    
    ,'' TPSZINPUT    ## HIDDEN                                            

    #foreach(${key} in ${tpszArr}) 
        ,SUM(${key}CNTRVOL) ${key}CNTRVOL	    	
    #end  
    
    ## TYPE SIZE별 수정된 VOL 정보를 확인하기 위한 FLAG
    #foreach(${key} in ${tpszArr}) 
          ,'F' ${key}FLAG									
    #end        	
    ,(
        SELECT 
            WK_ST_DT  
        FROM 
            EQR_WK_PRD 
        WHERE 
            PLN_YR||PLN_WK = PLN_YRWK 
    ) WK_ST_DT  ## week from date 
    ,(
        SELECT 
            WK_END_DT 
        FROM 
            EQR_WK_PRD 
        WHERE 
            PLN_YR||PLN_WK = PLN_YRWK 
    ) WK_END_DT ## week to date      
    ,(
        SELECT 
            TO_CHAR(TO_DATE(WK_END_DT, 'YYYYMMDD')+49, 'YYYYMMDD') WK_MAX_DT 
        FROM 
            EQR_WK_PRD 
        WHERE 
            PLN_YR||PLN_WK = PLN_YRWK 
    ) WK_MAX_DT ## WEEK MAX DATE +7    	    
    ,(
        SELECT 
            DISTINCT RCC_CD 
        FROM 
            MDM_EQ_ORZ_CHT 
        WHERE 
            SCC_CD = SUBSTR(FRLOC, 0, 5)
    ) FRLOC_RCC     ## from ecc's RCC      							
    ,(
        SELECT 
            DISTINCT ECC_CD 
        FROM 
            MDM_EQ_ORZ_CHT 
        WHERE 
            SCC_CD = SUBSTR(FRLOC, 0, 5)
    ) FRLOC_ECC     ## FROM ECC      							
    ,(
        SELECT 
            DISTINCT ECC_CD 
        FROM 
            MDM_EQ_ORZ_CHT 
        WHERE 
            SCC_CD = SUBSTR(TOLOC, 0, 5)
    ) TOLOC_ECC     ## TO   ECC      							

    ,TRSPNO_P     ## TRSP P CD COUNT (HIDDEN)					            
    ,TRSPNO_D     ## TRSP D CD COUNT (HIDDEN)					            
    
    ,SUBSTR(FRLOC, 0, 5) SORT_FRLOC                 ## NOT SHOW             
    ,SUBSTR(TOLOC, 0, 5) SORT_TOLOC                 ## NOT SHOW             
    ,SUBSTR(FRLOC, 0, 5) || SUBSTR(TOLOC, 0, 5) SORT1 ## NOT SHOW             
FROM                                                                
    (                                                                   
        SELECT 
            DECODE(B.NUM, 1, A.PLN_YRWK, 2, A.PLN_YRWK||' TTL', 3, 'TOTAL') PLN_YRWK                                          
            ,DECODE(B.NUM, 1, A.COMPANY,  2, '', 3, '')  COMPANY   		
            ,A.DIVISION                                               	
            ,DECODE(B.NUM, 1, A.ITEM ,  2, '', 3, '')     ITEM          
            ,DECODE(B.NUM, 1, A.FRLOC,  2, '', 3, '')     FRLOC         
            ,DECODE(B.NUM, 1, A.ETD  ,  2, NULL, 3, NULL) ETD         	
            ,DECODE(B.NUM, 1, A.TOLOC,  2, '', 3, '')     TOLOC         
            ,DECODE(B.NUM, 1, A.ETA  ,  2, NULL, 3, NULL) ETA         	
            ,DECODE(B.NUM, 1, A.PURPOSE,  2, '', 3, '')   PURPOSE       
            ,DECODE(B.NUM, 1, A.CNTRNO,  2, '', 3, '')   CNTRNO         
            ,DECODE(B.NUM, 1, A.SOSEND,  2, '', 3, '')   SOSEND			 
            ,SUM(A.TOTALVOL)  TOTALVOL                                	
            ,SUM(A.TOTALCOST) TOTALCOST                               	
            #foreach(${key} in ${tpszArr})                                                
                ,SUM(A.${key}VOL)     ${key}VOL       	
                ,SUM(A.${key}COST)    ${key}COST      	
            #end 
            ## TPSZ별 CNTR 갯수
            #foreach(${key} in ${tpszArr}) 
                ,SUM(A.${key}CNTRVOL) ${key}CNTRVOL 
            #end
            ,DECODE(B.NUM, 1, A.REF_ID,  2, '', 3, '') REF_ID   	   
            ,DECODE(B.NUM, 1, A.CMB_REF_ID,  2, '', 3, '') CMB_REF_ID 
            ,DECODE(B.NUM, 1, A.REPO_PLN_ID,  2, '', 3, '') REPO_PLN_ID ## HIDDEN   
            ,A.SORTNUM    	    ## HIDDEN							  	  
            ,B.NUM           	## HIDDEN 										                                                                             
            ,DECODE(B.NUM, 1, A.TRSPNO_P,  2, '', 3, '') TRSPNO_P	## HIDDEN 			                                                                             
            ,DECODE(B.NUM, 1, A.TRSPNO_D,  2, '', 3, '') TRSPNO_D	## HIDDEN 			                                                                             
        FROM															
            (                                                             

            ## query 시작(NORMAL, SUB, GRAND TOTAL 공동사용)
            ## PLAN(없음)####################################-          
            ## Execution ######################################-          
                SELECT 
                    A.PLN_YRWK 		PLN_YRWK           					                       
                    ,A.CO_CD 			COMPANY                                  
                    ,'Execution' 		DIVISION                            
                    ,A.TRSP_MOD_CD 	ITEM                                
                    ,A.FM_YD_CD  		FRLOC                               
                    ,TO_CHAR(A.FM_ETD_DT, 'YYYYMMDD') 		ETD                   
                    ,A.TO_YD_CD  		TOLOC                               
                    ,TO_CHAR(A.TO_ETA_DT, 'YYYYMMDD') 		ETA         
                    ,A.EQ_REPO_PURP_CD PURPOSE                            
                    ,CASE WHEN A.PLN_YRWK = C.PLN_YRWK AND A.REF_ID = C.REF_ID 
                        THEN 
                            '0'  ## CNTR 존재       
                        ELSE 
                            '1'  ## CNTR 존재안함 
                    END CNTRNO             
                    ,A.EXE_ISS_FLG    	 SOSEND			                                     
                    ,
                    #foreach(${key} in ${tpszArr}) 
                        NVL(MAX(DECODE(A.CNTR_TPSZ_CD, '${key}', A.CNTR_QTY)),0)
                        #if($velocityCount < $tpszArr.size()) 
                            +
                        #end 
                    #end	
                    TOTALVOL                       									
                    ,
                    #foreach(${key} in ${tpszArr}) 
                        NVL(MAX(DECODE(A.CNTR_TPSZ_CD, '${key}', A.TRSP_COST_AMT)),0)
                        #if($velocityCount < $tpszArr.size()) 
                            +
                        #end 
                    #end	
                    TOTALCOST                       									
        
                    #foreach(${key} in ${tpszArr}) 
                        ,NVL(MAX(DECODE(A.CNTR_TPSZ_CD, '${key}', A.CNTR_QTY)),0) 	 ${key}VOL  
                        ,NVL(MAX(DECODE(A.CNTR_TPSZ_CD, '${key}', A.TRSP_COST_AMT)),0) ${key}COST 
                    #end	
                    ## TPSZ별 CNTR 갯수
                    #foreach(${key} in ${tpszArr}) 
                        ,NVL(MAX(DECODE(A.CNTR_TPSZ_CD, '${key}', D.REFCOUNT)),0) 		  ${key}CNTRVOL  
                    #end	
        
                    ,A.REF_ID                                             
                    ,A.CMB_REF_ID                                         
                    ,A.REPO_PLN_ID 				## HIDDEN               
                    ,2 SORTNUM   					## HIDDEN               	
                    ,CASE WHEN A.PLN_YRWK = E.PLN_YRWK AND A.REF_ID = E.REF_ID 
                        THEN 
                            E.TRSPCOUNT_P  ## TRSP 존재    
                        ELSE 
                            0            ## TRSP 존재안함  
                    END TRSPNO_P              				
                    ,CASE WHEN A.PLN_YRWK = E.PLN_YRWK AND A.REF_ID = E.REF_ID 
                        THEN 
                            E.TRSPCOUNT_D  ## TRSP 존재    
                        ELSE 
                            0            ## TRSP 존재안함  
                    END TRSPNO_D              				
                FROM 
                    (
                        SELECT
                            A.REPO_PLN_ID,    
                            A.PLN_YRWK,       
                            A.REF_ID,         
                            A.CO_CD,          
                            A.TRSP_MOD_CD,    
                            A.FM_YD_CD,       
                            A.FM_ETD_DT,      
                            A.TO_YD_CD,       
                            A.TO_ETA_DT,      
                            A.EQ_REPO_PURP_CD,
                            A.EXE_ISS_FLG,    
                            A.CMB_REF_ID,     
                            A.CRE_USR_ID,     
                            A.CRE_DT,         
                            A.UPD_USR_ID,     
                            A.UPD_DT,
                            Q.CNTR_TPSZ_CD,
                            Q.TRSP_COST_AMT,
                            Q.CNTR_QTY
                        FROM                            
                            EQR_ECC_INTER_EXE_PLN A, 
                            EQR_ECC_INTER_EXE_PLN_QTY Q    
                        WHERE
                            A.REPO_PLN_ID = Q.REPO_PLN_ID                
                            AND   A.PLN_YRWK    = Q.PLN_YRWK                   
                            AND   A.REF_ID      = Q.REF_ID
                    ) A ,                      
                    (                                                      
                        SELECT 
                            A.REPO_PLN_ID
                            , A.PLN_YRWK
                            , A.REF_ID
                            , NVL(COUNT(*), 0) REFCOUNT  
                        FROM 
                            EQR_EXE_PLN_CNTR A,							
                            EQR_ECC_INTER_EXE_PLN B,							
                            EQR_ECC_INTER_EXE_PLN_QTY Q                       
                        WHERE 
                            A.REPO_PLN_ID = B.REPO_PLN_ID                
                            AND   A.PLN_YRWK    = B.PLN_YRWK                   
                            AND   A.REF_ID      = B.REF_ID                     
                            AND   B.REPO_PLN_ID = @[repoPlanID]	            
                            AND   Q.REPO_PLN_ID = B.REPO_PLN_ID               
                            AND   Q.PLN_YRWK    = B.PLN_YRWK                   
                            AND   Q.REF_ID      = B.REF_ID   
                            #if(${userECC} != '')     	        
                                AND (	
        								SUBSTR(B.FM_YD_CD, 0, 5) IN (
        															SELECT 
        																SCC_CD 
        															FROM 
        																MDM_EQ_ORZ_CHT 
        															WHERE 
        																ECC_CD IN ( ${userLocStrArr} )
        								) 
        								OR 
        								SUBSTR(B.TO_YD_CD, 0, 5) IN (
        															SELECT 
        																SCC_CD 
        															FROM 
        																MDM_EQ_ORZ_CHT 
        															WHERE 
        																ECC_CD IN ( ${userLocStrArr} )
        								)
        							)                 	
            				#end
        					#if(${fmtoat} == '1')    ## FROM TO
                		 		AND   B.PLN_YRWK BETWEEN @[fromWeek] AND @[toWeek]   
        					
        						#if(${fromStatus} != '') 	        
        							AND SUBSTR(B.FM_YD_CD, 0, 5) IN (
        															SELECT 
        																SCC_CD 
        															FROM 
        																MDM_EQ_ORZ_CHT 
        															WHERE 
        																ECC_CD IN ( ${fromLocStrArr} ) 
        							)      
        						#end   
        						#if(${toStatus} != '')   	        
        							AND SUBSTR(B.TO_YD_CD, 0, 5) IN (
        															SELECT 
        																SCC_CD 
        															FROM 
        																MDM_EQ_ORZ_CHT 
        															WHERE 
        																ECC_CD IN ( ${toLocStrArr} )
        							)
        						#end						
        
        					## CSR No  N200906040080 의거 변경 
        					## fmtoat 3   Fm ETD
        					## fmtoat 4   To ETA
        					#elseif(${fmtoat} == '3') 
                       			AND  TO_CHAR(B.FM_ETD_DT ,'YYYYMMDD') BETWEEN 	(
        																		SELECT 
        																			WK_ST_DT  
        																		FROM 
        																			EQR_WK_PRD 
        																		WHERE 
        																			PLN_YR||PLN_WK = @[fromWeek]
        																	   	)  
        																	AND 
        																		(
        																		SELECT 
        																			WK_END_DT  
        																		FROM 
        																			EQR_WK_PRD 
        																		WHERE 
        																			PLN_YR||PLN_WK = @[toWeek]
        						)    	  	
        
        						#if(${fromStatus} != '') 	        
        							AND SUBSTR(B.FM_YD_CD, 0, 5) IN (
        															SELECT 
        																SCC_CD 
        															FROM 
        																MDM_EQ_ORZ_CHT 
        															WHERE 
        																ECC_CD IN ( ${fromLocStrArr} )
        							) 
        						#end        
        						#if(${toStatus} != '')   	        
        							AND SUBSTR(B.TO_YD_CD, 0, 5) IN (
        															SELECT
        																SCC_CD 
        															FROM 
        																MDM_EQ_ORZ_CHT 
        															WHERE 
        																ECC_CD IN ( ${toLocStrArr})
        							)
        						#end						
        					#elseif (${fmtoat} == '4') 
                       			AND  TO_CHAR(B.TO_ETA_DT ,'YYYYMMDD') BETWEEN 	(
        																		SELECT 
        																			WK_ST_DT  
        																		FROM 
        																			EQR_WK_PRD 
        																		WHERE 
        																			PLN_YR||PLN_WK = @[fromWeek]
        																		)   
        																	AND 
        																		(
        																		SELECT 
        																			WK_END_DT  
        																		FROM 
        																			EQR_WK_PRD 
        																		WHERE 
        																			PLN_YR||PLN_WK = @[toWeek]
        						)    	  	
        
        						#if(${fromStatus} != '') 	        
        							AND SUBSTR(B.FM_YD_CD, 0, 5) IN (
        															SELECT 
        																SCC_CD 
        														    FROM 
        														        MDM_EQ_ORZ_CHT 
        														    WHERE 
        														        ECC_CD IN ( ${fromLocStrArr} ) 
        							)
        						#end         
        						#if(${toStatus} != '')   	        
        							AND SUBSTR(B.TO_YD_CD, 0, 5) IN (
        															SELECT 
        																SCC_CD 
        															FROM 
        																MDM_EQ_ORZ_CHT 
        															WHERE 	
        																ECC_CD IN ( ${toLocStrArr} )
        							)						
        					## CSR No  N200906040080 끝   
        						#end
        					#else                     ## AT
        						#if(${atStatus} != '') 
        	        		 		AND   
        								(												      	
        					        		(
        										B.PLN_YRWK BETWEEN @[fromWeek] AND @[toWeek] 
        										AND 
        										SUBSTR(B.FM_YD_CD, 0, 5) IN (
        																		SELECT 
        																			SCC_CD 
        																		FROM 
        																			MDM_EQ_ORZ_CHT 
        																		WHERE 
        																			ECC_CD IN ( ${fromLocStrArr} ) 
        										)
        									)   
        						    	OR												 
        									(
        										(
        											SELECT 
        												PLN_YR||PLN_WK 
        											FROM 
        												EQR_WK_PRD 
        											WHERE 
        												TO_CHAR(B.TO_ETA_DT, 'YYYYMMDD') BETWEEN WK_ST_DT AND WK_END_DT
        										) BETWEEN @[fromWeek] AND @[toWeek] 
        										AND 
        										SUBSTR(B.TO_YD_CD, 0, 5) IN (
        																	SELECT 
        																		SCC_CD 
        																	FROM 
        																		MDM_EQ_ORZ_CHT 
        																	WHERE 
        																		ECC_CD IN ( ${fromLocStrArr} ) 
        										)
        									)   
        	                       		)												
        
        						#else 
        	        		 		AND   
        								(														      	
        					        		(
        										B.PLN_YRWK BETWEEN @[fromWeek] AND @[toWeek] 
        									)   
        						    	OR														 
        	                        		(
        										(
        											SELECT 
        												PLN_YR||PLN_WK 
        											FROM 
        												EQR_WK_PRD 
        											WHERE 
        												TO_CHAR(B.TO_ETA_DT, 'YYYYMMDD') BETWEEN WK_ST_DT AND WK_END_DT
        										) BETWEEN @[fromWeek] AND @[toWeek] 
        									)   
        	                       		)														     		
        						#end	        
        					#end
        
        					#if(${tpsz} != '' && ${tpsztype} != '')        		 
        						AND Q.CNTR_TPSZ_CD IN ( ${tpszStrArr} )
        					#end 	                
							## AS-IS TRSP_MOD_CD decode 구문 없음 오류 수정 09.11.30 Modify By ChungEunHo
        					#if(${itemname} != '') 	    			        		 
        						AND DECODE(B.TRSP_MOD_CD, 'W', 'S', 'T', 'S', 'R', 'S') IN ( ${itemnameStrArr} )
        					#end					         
        					#if(${sosend} != '')  	    			        		 
        						AND B.EXE_ISS_FLG = @[sosend]
        					#end									
                      
        				GROUP BY 
        					A.REPO_PLN_ID
        					, A.PLN_YRWK
        					, A.REF_ID       
                		 HAVING NVL(COUNT(*), 0) > 0                        
        			) C,                                                           
        			(                                                      
        				SELECT 
        					A.REPO_PLN_ID
        					, A.PLN_YRWK
        					, A.REF_ID
        					, Q.CNTR_TPSZ_CD
        					, NVL(COUNT(*), 0) REFCOUNT  	    
                		FROM 
        					EQR_EXE_PLN_CNTR A,							
        					EQR_ECC_INTER_EXE_PLN B ,							
        					EQR_ECC_INTER_EXE_PLN_QTY Q                       
        				WHERE 
        					A.REPO_PLN_ID = B.REPO_PLN_ID                
                			AND   A.PLN_YRWK    = B.PLN_YRWK                   
                			AND   A.REF_ID      = B.REF_ID    
                			AND   Q.REPO_PLN_ID = B.REPO_PLN_ID                
                			AND   Q.PLN_YRWK    = B.PLN_YRWK                   
                			AND   Q.REF_ID      = B.REF_ID                   
                			AND   A.CNTR_TPSZ_CD= Q.CNTR_TPSZ_CD				
                			AND   B.REPO_PLN_ID = @[repoPlanID]	            
        
        					#if(${userECC} != '')     	        
        						AND (
        								SUBSTR(B.FM_YD_CD, 0, 5) IN (
        															SELECT 
        																SCC_CD 
        															FROM 
        																MDM_EQ_ORZ_CHT 
        															WHERE 
        																ECC_CD IN ( ${userLocStrArr} )
        								) 
        							OR 
        								SUBSTR(B.TO_YD_CD, 0, 5) IN (
        															SELECT 
        																SCC_CD 
        															FROM 
        																MDM_EQ_ORZ_CHT 
        															WHERE 
        																ECC_CD IN ( ${userLocStrArr} )
        								)
        							)                 		   
        					#end
        					#if(${fmtoat} == '1')    ## FROM TO
                		 		AND   B.PLN_YRWK BETWEEN @[fromWeek] AND @[toWeek]   
        
        						#if(${fromStatus} != '') 	        
        							AND SUBSTR(B.FM_YD_CD, 0, 5) IN (
        															SELECT 
        																SCC_CD 
        															FROM 
        																MDM_EQ_ORZ_CHT 
        															WHERE 
        																ECC_CD IN ( ${fromLocStrArr} ) 
        							)
        						#end         
        						#if(${toStatus} != '') 	        
        							AND SUBSTR(B.TO_YD_CD, 0, 5) IN (
        															SELECT 
        																SCC_CD 
        															FROM 
        																MDM_EQ_ORZ_CHT 
        															WHERE 
        																ECC_CD IN ( ${toLocStrArr} )
        							) 
        						#end
        					##		      CSR No  N200906040080 의거 변경 
        					## fmtoat 3   Fm ETD
        					## fmtoat 4   To ETA
        					#elseif(${fmtoat} == '3') 
                       			AND  TO_CHAR(B.FM_ETD_DT ,'YYYYMMDD') BETWEEN 	(
        																		SELECT 
        																			WK_ST_DT  
        																		FROM 
        																			EQR_WK_PRD 
        																		WHERE 
        																			PLN_YR||PLN_WK = @[fromWeek]
        																		)   
        																	AND (
        																		SELECT 
        																			WK_END_DT  
        																		FROM 
        																			EQR_WK_PRD 
        																		WHERE 
        																			PLN_YR||PLN_WK = @[toWeek]
        						)    	  	
        
        						#if(${fromStatus} != '') 	        
        							AND SUBSTR(B.FM_YD_CD, 0, 5) IN (
        															SELECT 
        																SCC_CD 
        															FROM 
        																MDM_EQ_ORZ_CHT 
        															WHERE 
        																ECC_CD IN ( ${fromLocStrArr} ) 
        							)    
        						#end     
        						#if(${toStatus} != '')   	        
        							AND SUBSTR(B.TO_YD_CD, 0, 5) IN (
        															SELECT 
        																SCC_CD 
        															FROM 
        																MDM_EQ_ORZ_CHT
        															WHERE 
        																ECC_CD IN ( ${toLocStrArr} )
        							)
        						#end						
        					#elseif(${fmtoat} == '4') 
                       			AND  TO_CHAR(B.TO_ETA_DT ,'YYYYMMDD') BETWEEN 	(
        																		SELECT 
        																			WK_ST_DT  
        																		FROM 
        																			EQR_WK_PRD 
        																		WHERE 
        																			PLN_YR||PLN_WK = @[fromWeek]
        																		)   
        																	AND (
        																		SELECT 
        																			WK_END_DT  
        																		FROM 
        																			EQR_WK_PRD 
        																		WHERE 
        																			PLN_YR||PLN_WK = @[toWeek]
        						)    	  	
        
        						#if(${fromStatus} != '') 	        
        							AND SUBSTR(B.FM_YD_CD, 0, 5) IN (
        															SELECT 
        																SCC_CD 
        															FROM 
        																MDM_EQ_ORZ_CHT 
        															WHERE 
        																ECC_CD IN ( ${fromLocStrArr} ) 
        							)
        						#end         
        						#if(${toStatus} != '')   	        
        							AND SUBSTR(B.TO_YD_CD, 0, 5) IN (
        															SELECT 
        																SCC_CD 
        															FROM 
        																MDM_EQ_ORZ_CHT 
        															WHERE 
        																ECC_CD IN ( ${toLocStrArr} )
        							)
        						#end						
        					## CSR No  N200906040080 끝   
        
        
        					#else                     ## AT
        						#if(${atStatus} != '') 
        	        		 		AND   
        								(												      	
        					        		(
        										B.PLN_YRWK BETWEEN @[fromWeek] AND @[toWeek] 
        										AND SUBSTR(B.FM_YD_CD, 0, 5) IN (
        																		SELECT 
        																			SCC_CD 
        																		FROM 
        																			MDM_EQ_ORZ_CHT 
        																		WHERE 
        																			ECC_CD IN ( ${fromLocStrArr} ) 
        										)
        									)   
        						    	OR												 
        									(	
        										(
        											SELECT 
        												PLN_YR||PLN_WK 
        											FROM 
        												EQR_WK_PRD 
        											WHERE 
        												TO_CHAR(B.TO_ETA_DT, 'YYYYMMDD') BETWEEN WK_ST_DT AND WK_END_DT
        										) BETWEEN @[fromWeek] AND @[toWeek] 
        										AND 
        										SUBSTR(B.TO_YD_CD, 0, 5) IN (
        																	SELECT 
        																		SCC_CD 
        																	FROM 
        																		MDM_EQ_ORZ_CHT 
        																	WHERE 
        																		ECC_CD IN ( ${fromLocStrArr} ) 
        										)
        									)   
        	                       		)												
        
        						#else 
        	        		 		AND   
        								(														      	
        					        		(
        										B.PLN_YRWK BETWEEN @[fromWeek] AND @[toWeek] 
        									)   
        						    	OR														 
        	                        		(
        										(
        											SELECT 
        												PLN_YR||PLN_WK 
        											FROM 
        												EQR_WK_PRD 
        											WHERE 
        												TO_CHAR(B.TO_ETA_DT, 'YYYYMMDD') BETWEEN WK_ST_DT AND WK_END_DT
        										) BETWEEN @[fromWeek] AND @[toWeek] 
        									)   
        	                       		)														 		
        						#end	       
        					#end
        
        					#if(${tpsz} != ''  && ${tpsztype} != '')        		 
        						AND Q.CNTR_TPSZ_CD IN ( ${tpszStrArr} ) 	                
        						## CSR NO  N200905180100 (ECC internal mode에서 'Rail' 추가) Modified by Lee Byoung Hun
        					#end
        					#if(${itemname} != '') 					        		 
        						AND DECODE(B.TRSP_MOD_CD, 'W', 'S', 'T', 'S', 'R', 'S') IN ( ${itemnameStrArr} )
        					#end
        					#if(${sosend} != '')	    				        		 
        						AND B.EXE_ISS_FLG = @[sosend]
        					#end									
                      		
        				GROUP BY 
        					A.REPO_PLN_ID
        					, A.PLN_YRWK
        					, A.REF_ID
        					, Q.CNTR_TPSZ_CD 
        			) D,                                                           
        			(                                                      
        				SELECT 
        					A.REPO_PLN_ID
        					, A.PLN_YRWK
        					, A.REF_ID
        					, NVL(SUM(DECODE(A.TRSP_SO_STS_CD, 'P', 1, 0)), 0) TRSPCOUNT_P
        					, NVL(SUM(DECODE(A.TRSP_SO_STS_CD, 'D', 1, 0)), 0) TRSPCOUNT_D    	    	    
              			FROM												
                			(													        
                		    	SELECT 
        							A.REPO_PLN_ID
        								, A.PLN_YRWK
        								, A.REF_ID
        								, A.CNTR_TPSZ_CD
        								, A.TRSP_SO_STS_CD         
                		     	FROM 
        							EQR_REPO_EXE_SO_IF A						
                		          	, EQR_ECC_INTER_EXE_PLN B  					
                		          	, EQR_ECC_INTER_EXE_PLN_QTY Q                   
                		     	WHERE 
        							A.REPO_PLN_ID = B.REPO_PLN_ID                
                		     		AND   A.PLN_YRWK    = B.PLN_YRWK                   
                		     		AND   A.REF_ID      = B.REF_ID                     
                		     		AND   Q.REPO_PLN_ID = B.REPO_PLN_ID                
                		     		AND   Q.PLN_YRWK    = B.PLN_YRWK                   
                		     		AND   Q.REF_ID      = B.REF_ID                     
                		     		AND   A.CNTR_TPSZ_CD= Q.CNTR_TPSZ_CD				
                		     		AND   B.REPO_PLN_ID = @[repoPlanID]	            
                		     		AND   B.PLN_YRWK BETWEEN @[fromWeek] AND @[toWeek]   
        
        ## modified by shin yongchan - 20081020 
        ## CSR NO  N200810240024
        ## P - S/O Send 최초 
        ## D - TRS모듈에서 W/O 시도후 취소 상태
        ## P, D 모두 S/O Cancel 대상으로 포함	             			
                		     		AND   A.TRSP_SO_STS_CD IN ('P', 'D')                  ## 중요
        
        							#if(${userECC} != '')     	        		     
        								AND (
        										SUBSTR(B.FM_YD_CD, 0, 5) IN (
        																		SELECT 
        																			SCC_CD 
        																		FROM 
        																			MDM_EQ_ORZ_CHT 
        																		WHERE 
        																			ECC_CD IN ( ${userLocStrArr} )
        										) 
        									OR 
        										SUBSTR(B.TO_YD_CD, 0, 5) IN (
        																		SELECT 
        																			SCC_CD 
        																		FROM 
        																			MDM_EQ_ORZ_CHT 
        																		WHERE 
        																			ECC_CD IN ( ${userLocStrArr} )
        										)
        									)                 	
        							#end
        							#if(${fmtoat} == '1')    ## FROM TO
                		     			AND   B.PLN_YRWK BETWEEN @[fromWeek] AND @[toWeek]   
        
        								#if(${fromStatus} != '')          		     
        									AND SUBSTR(B.FM_YD_CD, 0, 5) IN (
        																	SELECT 
        																		SCC_CD 
        																	FROM 
        																		MDM_EQ_ORZ_CHT 
        																	WHERE 
        																		ECC_CD IN ( ${fromLocStrArr} ) 
        									)
        								#end         
        								#if(${toStatus} != '')            		     
        									AND SUBSTR(B.TO_YD_CD, 0, 5) IN (
        																	SELECT 
        																		SCC_CD 
        																	FROM 
        																		MDM_EQ_ORZ_CHT 
        																	WHERE 
        																		ECC_CD IN ( ${toLocStrArr} )
        									)
        								#end 
        
        							## CSR No  N200906040080 의거 변경 
        							## fmtoat 3   Fm ETD
        							## fmtoat 4   To ETA
        							#elseif(${fmtoat} == '3') 
                       					AND  TO_CHAR(B.FM_ETD_DT ,'YYYYMMDD') BETWEEN 	(
        																				SELECT 
        																					WK_ST_DT  
        																				FROM 
        																					EQR_WK_PRD 
        																				WHERE 
        																					PLN_YR||PLN_WK = @[fromWeek]
        																				)   
        																			AND (
        																				SELECT 	
        																					WK_END_DT  
        																				FROM 
        																					EQR_WK_PRD 
        																				WHERE PLN_YR||PLN_WK = @[toWeek]
        								)    	  	
        
        								#if(${fromStatus} != '') 	                   
        									AND SUBSTR(B.FM_YD_CD, 0, 5) IN (
        																	SELECT 
        																		SCC_CD 
        																	FROM 
        																		MDM_EQ_ORZ_CHT 
        																	WHERE 
        																		ECC_CD IN ( ${fromLocStrArr} ) 
        									)
        								#end         
        								#if(${toStatus} != '')   	                   
        									AND SUBSTR(B.TO_YD_CD, 0, 5) IN (
        																	SELECT 
        																		SCC_CD 
        																	FROM 
        																		MDM_EQ_ORZ_CHT 
        																	WHERE 
        																		ECC_CD IN ( ${toLocStrArr} )
        									)			
        								#end			
        							#elseif(${fmtoat} == '4') 
                       					AND  TO_CHAR(B.TO_ETA_DT ,'YYYYMMDD') BETWEEN 	(
        																				SELECT 
        																					WK_ST_DT  
        																				FROM 
        																					EQR_WK_PRD 
        																				WHERE 
        																					PLN_YR||PLN_WK = @[fromWeek]	
        																				)   
        																			AND (
        																				SELECT 
        																					WK_END_DT  
        																				FROM
        																					EQR_WK_PRD 
        																				WHERE 
        																					PLN_YR||PLN_WK = @[toWeek]
        								)    	  	
        
        								#if(${fromStatus} != '') 	                   
        									AND SUBSTR(B.FM_YD_CD, 0, 5) IN (
        																		SELECT 
        																			SCC_CD 
        																		FROM 
        																			MDM_EQ_ORZ_CHT 
        																		WHERE 
        																			ECC_CD IN ( ${fromLocStrArr} ) 
        									)
        								#end         
        								#if(${toStatus} != '')   	                   
        									AND SUBSTR(B.TO_YD_CD, 0, 5) IN (
        																		SELECT 
        																			SCC_CD 
        																		FROM 
        																			MDM_EQ_ORZ_CHT 
        																		WHERE 
        																			ECC_CD IN ( ${toLocStrArr} )
        									)
        								#end						
        							## CSR No  N200906040080 끝   	
        
        							#else                     ## AT
        								#if(${atStatus} != '') 
        	        						AND
        										(												      	
        								        	(
        												B.PLN_YRWK BETWEEN @[fromWeek] AND @[toWeek] 
        												AND SUBSTR(B.FM_YD_CD, 0, 5) IN (
        																					SELECT 
        																						SCC_CD 
        																					FROM 
        																						MDM_EQ_ORZ_CHT 	
        																					WHERE 
        																						ECC_CD IN ( ${fromLocStrArr} ) 
        												)
        											)   
        						    			OR												 
        	                        				(
        												(
        													SELECT 
        														PLN_YR||PLN_WK 
        													FROM 
        														EQR_WK_PRD 
        													WHERE 
        														TO_CHAR(B.TO_ETA_DT, 'YYYYMMDD') BETWEEN WK_ST_DT AND WK_END_DT
        												) BETWEEN @[fromWeek] AND @[toWeek] 
        												AND SUBSTR(B.TO_YD_CD, 0, 5) IN (
        																					SELECT 
        																						SCC_CD 
        																					FROM 
        																						MDM_EQ_ORZ_CHT 
        																					WHERE 
        																						ECC_CD IN ( ${fromLocStrArr} ) 
        												)
        											)   
        	                       				)												
        
        								#else 
        	        		 				AND   
        										(														      	
        					        				(
        												B.PLN_YRWK BETWEEN @[fromWeek] AND @[toWeek] 
        											)   
        						    			OR														 
        
        	                        				(
        												(
        													SELECT 
        														PLN_YR||PLN_WK 
        													FROM 
        														EQR_WK_PRD 
        													WHERE 
        														TO_CHAR(B.TO_ETA_DT, 'YYYYMMDD') BETWEEN WK_ST_DT AND WK_END_DT
        												) BETWEEN @[fromWeek] AND @[toWeek] 
        											)   
        	                       				)														 		
        								#end	       	        	    
        							#end
        
        							#if(${tpsz} != ''  && ${tpsztype} != '')        		     
        								AND Q.CNTR_TPSZ_CD IN ( ${tpszStrArr} ) 	        
        							#end        
        								## CSR NO  N200905180100 (ECC internal mode에서 'Rail' 추가) Modified by Lee Byoung Hun							
        							#if(${itemname} != '') 	    			        		     
        								AND DECODE(B.TRSP_MOD_CD, 'W', 'S', 'T', 'S', 'R', 'S') IN ( ${itemnameStrArr} )
        							#end
        							#if(${sosend} != '')	    				        		     
        								AND B.EXE_ISS_FLG = @[sosend]
        							#end									
                		 	) A                                                        
        				GROUP BY 
        					A.REPO_PLN_ID
        					, A.PLN_YRWK
        					, A.REF_ID   	                      		        
        			) E                                               		        
        
        		WHERE 
        			A.PLN_YRWK = C.PLN_YRWK(+)							
                	AND   A.REF_ID   = C.REF_ID(+)   							 
                	AND   A.PLN_YRWK = D.PLN_YRWK(+)							 			
                	AND   A.REF_ID   = D.REF_ID(+) 							 
                	AND   A.CNTR_TPSZ_CD = D.CNTR_TPSZ_CD(+)   				 
                	AND   A.PLN_YRWK = E.PLN_YRWK(+)							 
                	AND   A.REF_ID   = E.REF_ID(+) 							 
                	AND   A.REPO_PLN_ID = @[repoPlanID]  
        
        			#if(${userECC} != '')    	            
        				AND 
        					(
        						SUBSTR(A.FM_YD_CD, 0, 5) IN (
        													SELECT 
        														SCC_CD 
        													FROM 
        														MDM_EQ_ORZ_CHT 
        													WHERE 
        														ECC_CD IN ( ${userLocStrArr} )
        						) 
        					OR 
        						SUBSTR(A.TO_YD_CD, 0, 5) IN (
        													SELECT 
        														SCC_CD 
        													FROM 
        														MDM_EQ_ORZ_CHT 
        													WHERE 
        														ECC_CD IN ( ${userLocStrArr} )
        						)
        					)                 	
        			#end
        
        			#if(${fmtoat} == '1')    ## FROM TO
        				AND   A.PLN_YRWK BETWEEN @[fromWeek] AND @[toWeek]    
        			
        				#if(${fromStatus} != '')	        
        					AND SUBSTR(A.FM_YD_CD, 0, 5) IN (
        													SELECT 
        														SCC_CD 
        													FROM 
        														MDM_EQ_ORZ_CHT 
        													WHERE 
        														ECC_CD IN ( ${fromLocStrArr} ) 
        					)	
        				#end         
        				#if(${toStatus} != '') 	        
        					AND SUBSTR(A.TO_YD_CD, 0, 5) IN (
        													SELECT 
        														SCC_CD 
        													FROM 
        														MDM_EQ_ORZ_CHT 
        													WHERE 
        														ECC_CD IN ( ${toLocStrArr} )
        					)
        				#end 
        
        			##		      CSR No  N200906040080 의거 변경 
        			## fmtoat 3   Fm ETD
        			## fmtoat 4   To ETA
        			#elseif(${fmtoat} == '3') 
                       AND  TO_CHAR(A.FM_ETD_DT ,'YYYYMMDD') BETWEEN 	(
        																SELECT 
        																	WK_ST_DT  
        																FROM 
        																	EQR_WK_PRD 
        																WHERE 
        																	PLN_YR||PLN_WK = @[fromWeek]
        																)   
        															AND (
        																SELECT 
        																	WK_END_DT  
        																FROM 
        																	EQR_WK_PRD 
        																WHERE 
        																	PLN_YR||PLN_WK = @[toWeek]
        				)    	  	
        
        				#if(${fromStatus} != '') 	        
        					AND SUBSTR(A.FM_YD_CD, 0, 5) IN (
        													SELECT 
        														SCC_CD 
        													FROM 
        														MDM_EQ_ORZ_CHT 
        													WHERE 
        														ECC_CD IN ( ${fromLocStrArr} ) 
        					)
        				#end         
        				#if(${toStatus} != '')   	        
        					AND SUBSTR(A.TO_YD_CD, 0, 5) IN (
        													SELECT 
        														SCC_CD 
        													FROM 
        														MDM_EQ_ORZ_CHT 
        													WHERE 
        														ECC_CD IN ( ${toLocStrArr} )
        					)
        				#end						
        			#elseif(${fmtoat} == '4' ) 
                       AND  TO_CHAR(A.TO_ETA_DT ,'YYYYMMDD') BETWEEN 	(	
        																SELECT 
        																	WK_ST_DT  
        																FROM 
        																	EQR_WK_PRD 
        																WHERE 
        																	PLN_YR||PLN_WK = @[fromWeek]
        																)   
        															AND (
        																SELECT 
        																	WK_END_DT  
        																FROM 
        																	EQR_WK_PRD 
        																WHERE 
        																	PLN_YR||PLN_WK = @[toWeek]
        				)    	  	
        
        				#if(${fromStatus} != '') 	        
        					AND SUBSTR(A.FM_YD_CD, 0, 5) IN (
        													SELECT 
        														SCC_CD 
        													FROM 
        														MDM_EQ_ORZ_CHT 
        													WHERE 
        														ECC_CD IN ( ${fromLocStrArr} ) 
        					)
        				#end         
        				#if(${toStatus} != '')   	        
        					AND SUBSTR(A.TO_YD_CD, 0, 5) IN (
        													SELECT 
        														SCC_CD 
        													FROM 
        														MDM_EQ_ORZ_CHT 
        													WHERE 
        														ECC_CD IN ( ${toLocStrArr} )
        					)						
        				#end
        			## CSR No  N200906040080 끝   
        
        
        			#else                     ## AT
        				#if(${atStatus} != '') 
        	        		AND   
        						(												      	
        					    	(
        								A.PLN_YRWK BETWEEN @[fromWeek] AND @[toWeek] 
        								AND SUBSTR(A.FM_YD_CD, 0, 5) IN (
        																SELECT 
        																	SCC_CD 
        																FROM 
        																	MDM_EQ_ORZ_CHT 
        																WHERE 
        																	ECC_CD IN ( ${fromLocStrArr} ) 
        								)
        							)   
        						OR												 
        	                        (
        								(
        									SELECT 
        										PLN_YR||PLN_WK 
        									FROM 
        										EQR_WK_PRD 
        									WHERE 
        										TO_CHAR(A.TO_ETA_DT, 'YYYYMMDD') BETWEEN WK_ST_DT AND WK_END_DT
        								) BETWEEN @[fromWeek] AND @[toWeek] 
        								AND SUBSTR(A.TO_YD_CD, 0, 5) IN (
        																SELECT 
        																	SCC_CD 
        																FROM 
        																	MDM_EQ_ORZ_CHT 
        																WHERE 
        																	ECC_CD IN ( ${fromLocStrArr} ) 
        								)
        							)   
        						)												
        
        				#else 
        					AND   
        						(														      	
        							(
        								A.PLN_YRWK BETWEEN @[fromWeek] AND @[toWeek] 
        							)   
        						OR														 
        							(
        								(	
        									SELECT 
        										PLN_YR||PLN_WK 
        									FROM 
        										EQR_WK_PRD 
        									WHERE 
        										TO_CHAR(A.TO_ETA_DT, 'YYYYMMDD') BETWEEN WK_ST_DT AND WK_END_DT
        								) BETWEEN @[fromWeek] AND @[toWeek] 
        							)   
        						)														 
        
        				#end	       
        
        			#end
        
        			#if(${tpsz} != '' && ${tpsztype} != '') 
        				AND   A.CNTR_TPSZ_CD IN ( ${tpszStrArr} ) 	                
        			## CSR NO  N200905180100 (ECC internal mode에서 'Rail' 추가) Modified by Lee Byoung Hun
        			#end
        			#if(${itemname} != '')         
        				AND   DECODE(A.TRSP_MOD_CD, 'W', 'S', 'T', 'S', 'R', 'S') IN ( ${itemnameStrArr} )
        			#end
        			#if(${sosend} != '')	         
        				AND   A.EXE_ISS_FLG = @[sosend]
        			#end									
        
        		GROUP BY 
        			A.PLN_YRWK                                                                   
                    ,A.CO_CD                                                   
                    ,A.TRSP_MOD_CD                                             
                    ,A.FM_YD_CD                                                
                    ,TO_CHAR(A.FM_ETD_DT, 'YYYYMMDD')                          
                    ,A.TO_YD_CD                                                
                    ,TO_CHAR(A.TO_ETA_DT, 'YYYYMMDD')                          
                    ,A.EQ_REPO_PURP_CD                                         
                    ,CASE WHEN A.PLN_YRWK = C.PLN_YRWK AND A.REF_ID = C.REF_ID  
                        THEN 
                            '0'  ## CNTR 존재       
                        ELSE 
                            '1'  ## CNTR 존재안함  
                        END                        
                    ,A.EXE_ISS_FLG                                             
                    ,A.REPO_PLN_ID 		                                     
                    ,A.REF_ID                                                  
                    ,A.CMB_REF_ID                                              
                    ,CASE WHEN A.PLN_YRWK = E.PLN_YRWK AND A.REF_ID = E.REF_ID 
                        THEN 
                            E.TRSPCOUNT_P  ## TRSP 존재   
                        ELSE 
                            0            ## TRSP 존재안함 
                        END                               
                    ,CASE WHEN A.PLN_YRWK = E.PLN_YRWK AND A.REF_ID = E.REF_ID    
                        THEN 
                            E.TRSPCOUNT_D  ## TRSP 존재   
                        ELSE 
                            0            ## TRSP 존재안함 
                        END                               
        
                ## W/O Issue ##########################################	
            UNION														
                SELECT 
                    PLN_YRWK 		PLN_YRWK                            
                    ,CO_CD 			COMPANY                             
                    ,'W/O Issue' 		DIVISION                        
                    ##	            	    ,'S'              ITEM                              
                    ,TRSP_MOD_CD      ITEM                              
                    ,FM_YD_CD 		FRLOC                               
                    ,FM_DT 			ETD                                 
                    ,TO_YD_CD 		TOLOC                               
                    ,TO_DT 			ETA                                 
                    ,'' PURPOSE                                         
                    ,'' CNTRNO                                          
                    ,'' SOSEND                                          
                    
                    ,COUNT(CNTR_TPSZ_CD) TOTALVOL	
        			,                    
                    #foreach(${key} in ${tpszArr}) 
                        NVL(SUM(DECODE(CNTR_TPSZ_CD, '${key}', REPO_COST_AMT)),0)
        				#if($velocityCount < $tpszArr.size()) 
                            +
                        #end 
                    #end	
                    TOTALCOST                       									
                    
                    #foreach(${key} in ${tpszArr})         	  
                        ,COUNT(DECODE(CNTR_TPSZ_CD, '${key}', CNTR_TPSZ_CD))  ${key}VOL  
                        ,SUM(DECODE(CNTR_TPSZ_CD,   '${key}', REPO_COST_AMT)) ${key}COST 
                    #end  
                    ## TPSZ별 CNTR 갯수
                    #foreach(${key} in ${tpszArr}) 
                        ,0 ${key}CNTRVOL  						
                    #end	
                                                                 
                    ,REF_ID REFNO											
                    ,''     CMB_REF_ID    								
                    ,REPO_PLN_ID 	## HIDDEN                           	
                    ,3 SORTNUM	## HIDDEN                           	
                    ,0 TRSPNO_P 	## HIDDEN                           	
                    ,0 TRSPNO_D 	## HIDDEN                           	
                FROM 
                    EQR_REPO_EXE_SO_IF OUTER                                                                                                                         
                WHERE 
        			OUTER.WO_EXE_FLG = 'Y'                							                        									       										
                	AND EXISTS                                               	 
                		(                                              			         
                    		SELECT 
        						REPO_PLN_ID
        						, REF_ID
        						, PLN_YRWK           		
                    		FROM                                     				 
                    			(                                    					         		        
                    				SELECT 
                                        A.REPO_PLN_ID                                
                                        ,A.PLN_YRWK                                 
                                        ,A.REF_ID                                   
                                        ,Q.CNTR_TPSZ_CD                             
                                        ,A.CO_CD                                    
                                        ,A.TRSP_MOD_CD                              
                                        ,A.FM_YD_CD                                 
                                        ,A.FM_ETD_DT                                
                                        ,A.TO_YD_CD                                 
                                        ,A.TO_ETA_DT                                
                                        ,A.EQ_REPO_PURP_CD                          
                                        ,Q.CNTR_QTY                                 
                                        ,Q.TRSP_COST_AMT                            
                                        ,Q.EXE_RQST_DT                              
                                        ,A.EXE_ISS_FLG                                       
        			                FROM 
        			                    EQR_ECC_INTER_EXE_PLN A 
        			                    , EQR_ECC_INTER_EXE_PLN_QTY Q                        
                		            WHERE 
                		                A.REPO_PLN_ID = Q.REPO_PLN_ID
                		                AND A.PLN_YRWK = Q.PLN_YRWK 
                		                AND A.REF_ID = Q.REF_ID 
                		                AND A.REPO_PLN_ID = @[repoPlanID]       			
        
        								#if(${userECC} != '')     	        
        									AND 
        										(
        											SUBSTR(A.FM_YD_CD, 0, 5) IN (
        																		SELECT 
        																			SCC_CD 
        																		FROM 
        																			MDM_EQ_ORZ_CHT 
        																		WHERE 
        																			ECC_CD IN ( ${userLocStrArr} )
        											) 
        										OR 
        											SUBSTR(A.TO_YD_CD, 0, 5) IN (
        																		SELECT 
        																			SCC_CD 
        																		FROM 
        																			MDM_EQ_ORZ_CHT 
        																		WHERE 
        																			ECC_CD IN ( ${userLocStrArr} )
        											)	
        										)                 	
        								#end
        								#if(${fmtoat} == '1')    ## FROM TO
                							AND   A.PLN_YRWK BETWEEN @[fromWeek] AND @[toWeek]      			
        
        									#if(${fromStatus} != '') 	        
        										AND SUBSTR(A.FM_YD_CD, 0, 5) IN (
        																		SELECT 
        																			SCC_CD 
        																		FROM 	
        																			MDM_EQ_ORZ_CHT 
        																		WHERE 
        																			ECC_CD IN ( ${fromLocStrArr} ) 
        										)
        									#end         
        									#if(${toStatus} != '') 	        
        										AND SUBSTR(A.TO_YD_CD, 0, 5) IN (
        																		SELECT 
        																			SCC_CD 
        																		FROM 
        																			MDM_EQ_ORZ_CHT 
        																		WHERE 
        																			ECC_CD IN ( ${toLocStrArr} )
        										)
        									#end 
        
        								##		      CSR No  N200906040080 의거 변경 
        								## fmtoat 3   Fm ETD
        								## fmtoat 4   To ETA
        								#elseif(${fmtoat} == '3') 
                       						AND  TO_CHAR(A.FM_ETD_DT ,'YYYYMMDD') BETWEEN 	(
        																					SELECT 
        																						WK_ST_DT  
        																					FROM 
        																						EQR_WK_PRD 
        																					WHERE 
        																						PLN_YR||PLN_WK = @[fromWeek]
        																					)   
        																				AND (
        																					SELECT 
        																						WK_END_DT  
        																					FROM 
        																						EQR_WK_PRD 
        																					WHERE 
        																						PLN_YR||PLN_WK = @[toWeek]
        									)    	  	
        
        									#if(${fromStatus} != '') 	        
        										AND SUBSTR(A.FM_YD_CD, 0, 5) IN (
        																			SELECT 
        																				SCC_CD 
        																			FROM 
        																				MDM_EQ_ORZ_CHT 
        																			WHERE 
        																				ECC_CD IN ( ${fromLocStrArr} ) 
        										)
        									#end         
        									#if(${toStatus} != '')   	        
        										AND SUBSTR(A.TO_YD_CD, 0, 5) IN (
        																			SELECT 
        																				SCC_CD 
        																			FROM 
        																				MDM_EQ_ORZ_CHT 
        																			WHERE 
        																				ECC_CD IN ( ${toLocStrArr} )
        										)
        									#end						
        								#elseif(${fmtoat} == '4') 
        									AND  TO_CHAR(A.TO_ETA_DT ,'YYYYMMDD') BETWEEN 	(
        																					SELECT 
        																						WK_ST_DT  
        																					FROM 
        																						EQR_WK_PRD 
        																					WHERE 
        																						PLN_YR||PLN_WK = @[fromWeek]
        																					)   
        																				AND (
        																					SELECT 
        																						WK_END_DT  
        																					FROM 
        																						EQR_WK_PRD 
        																					WHERE 
        																						PLN_YR||PLN_WK = @[toWeek]	
        									)    	  	
        
        									#if(${fromStatus} != '') 	        
        										AND SUBSTR(A.FM_YD_CD, 0, 5) IN (
        																		SELECT 
        																			SCC_CD 
        																		FROM 
        																			MDM_EQ_ORZ_CHT 
        																		WHERE 
        																			ECC_CD IN ( ${fromLocStrArr} ) 
        										)
        									#end         
        									#if(${toStatus} != '')   	        
        										AND SUBSTR(A.TO_YD_CD, 0, 5) IN (
        																		SELECT 
        																			SCC_CD 
        																		FROM 
        																			MDM_EQ_ORZ_CHT 
        																		WHERE 
        																			ECC_CD IN ( ${toLocStrArr} )
        										)
        									#end						
        								## CSR No  N200906040080 끝   
        
        
        								#else                     ## AT
        									#if(${atStatus} != '') 
        	        		 					AND   
        											(												      	
        									        	(
        													A.PLN_YRWK BETWEEN @[fromWeek] AND @[toWeek] 
        													AND SUBSTR(A.FM_YD_CD, 0, 5) IN (
        																					SELECT 
        																						SCC_CD 
        																					FROM 
        																						MDM_EQ_ORZ_CHT 
        																					WHERE 
        																						ECC_CD IN ( ${fromLocStrArr} ) 
        													)
        												)   
        						    				OR												 
        
        	                        					(
        													(
        														SELECT 
        															PLN_YR||PLN_WK 
        														FROM 
        															EQR_WK_PRD 
        														WHERE 
        															TO_CHAR(A.TO_ETA_DT, 'YYYYMMDD') BETWEEN WK_ST_DT AND WK_END_DT
        													) BETWEEN @[fromWeek] AND @[toWeek] 
        													AND SUBSTR(A.TO_YD_CD, 0, 5) IN (
        																					SELECT 
        																						SCC_CD 
        																					FROM 
        																						MDM_EQ_ORZ_CHT 
        																					WHERE 
        																						ECC_CD IN ( ${fromLocStrArr} ) 
        													)
        												)   
        	                       					)												
        
        									#else 
        	        		 					AND   
        											(														      	
        					        					(
        													A.PLN_YRWK BETWEEN @[fromWeek] AND @[toWeek] 
        												)   
        						    				OR														
        	                        					(
        													(
        														SELECT 
        															PLN_YR||PLN_WK 
        														FROM 
        															EQR_WK_PRD 
        														WHERE 
        															TO_CHAR(A.TO_ETA_DT, 'YYYYMMDD') BETWEEN WK_ST_DT AND WK_END_DT
        													) BETWEEN @[fromWeek] AND @[toWeek] 
        												)   
        	                       					)														 		
        									#end	       	        
        								#end
        
        								#if(${tpsz} != '' && ${tpsztype} != '')         		
        									AND Q.CNTR_TPSZ_CD IN ( ${tpszStrArr} )                     
        								#end
        								## CSR NO  N200905180100 (ECC internal mode에서 'Rail' 추가) Modified by Lee Byoung Hun                  
        								#if(${itemname} != '')	        		
        									AND DECODE(A.TRSP_MOD_CD, 'W', 'S', 'T', 'S', 'R', 'S') IN ( ${itemnameStrArr} )
        								#end
        								#if(${sosend} != '')		        		
        									AND A.EXE_ISS_FLG = @[sosend]
        								#end
               					) INNER                         						
        					WHERE 
        						INNER.REPO_PLN_ID = OUTER.REPO_PLN_ID             
                     			AND   INNER.REF_ID      = OUTER.REF_ID   				
                      			AND   INNER.PLN_YRWK    = OUTER.PLN_YRWK               	
               			)                          														
        		GROUP BY 
        			PLN_YRWK                                         	
        			,CO_CD                                             	
                	,TRSP_MOD_CD                                   		
                	,FM_YD_CD                                          	
                	,FM_DT                                         		
                	,TO_YD_CD                                          	
                	,TO_DT                                         		
                	,REF_ID                                            	
                	,REPO_PLN_ID                                       	       
            ) A,																
            (                                                                 
                SELECT 1 NUM, '' NAME FROM DUAL                             
                UNION                                                       
                SELECT 2 NUM, 'TOTAL' NAME FROM DUAL                        
                UNION                                                       
                SELECT 3 NUM, 'GRAND TOTAL' NAME FROM DUAL                  
            ) B                                                                       

## modified by shin yongchan - 20080125 (CSR  R200801154869)                     	

        GROUP BY 
            DECODE(B.NUM, 1, A.PLN_YRWK, 2, A.PLN_YRWK||' TTL', 3, 'TOTAL')                                         
            ,DECODE(B.NUM, 1, A.COMPANY,  2, '', 3, '')    			
            ,A.DIVISION                                               
            ,DECODE(B.NUM, 1, A.ITEM ,  2, '', 3, '')              	
            ,DECODE(B.NUM, 1, A.FRLOC,  2, '', 3, '')             	
            ,DECODE(B.NUM, 1, A.ETD  ,  2, NULL, 3, NULL)         	
            ,DECODE(B.NUM, 1, A.TOLOC,  2, '', 3, '')              	
            ,DECODE(B.NUM, 1, A.ETA  ,  2, NULL, 3, NULL)          	
            ,DECODE(B.NUM, 1, A.PURPOSE,  2, '', 3, '')          		
            ,DECODE(B.NUM, 1, A.CNTRNO,  2, '', 3, '')            	
            ,DECODE(B.NUM, 1, A.SOSEND,  2, '', 3, '')   				     
            ,DECODE(B.NUM, 1, A.REF_ID,  2, '', 3, '')    			   
            ,DECODE(B.NUM, 1, A.CMB_REF_ID,  2, '', 3, '')			 
            ,DECODE(B.NUM, 1, A.REPO_PLN_ID,  2, '', 3, '')  			
            ,A.SORTNUM    	    									  	  
            ,B.NUM           														                                                                             
            ,DECODE(B.NUM, 1, A.TRSPNO_P,  2, '', 3, '')  	    				                 
            ,DECODE(B.NUM, 1, A.TRSPNO_D,  2, '', 3, '') 							                 
    )                                                                   	
GROUP BY 
    PLN_YRWK                                                   	
    ,COMPANY                                                    	
    ,DIVISION                                                   	
    ,ITEM                                                       	
    ,FRLOC                                                      	
    ,ETD  														
    ,TOLOC                                                      	
    ,ETA  														
    ,PURPOSE                                                    	
    ,CNTRNO                                                     	
    ,SOSEND			                                           	
    ,REF_ID       			                                   	
    ,CMB_REF_ID   			                                    
    ,REPO_PLN_ID ## HIDDEN                                        
    ,SORTNUM     ## HIDDEN  PLAN(1), Execution(2), SO(3)를 구분    
    ,NUM         ## HIDDEN  NORMAL(1), SUB TOTAL(2), GRAND TOTAL(3)
    ,TRSPNO_P     ## TRSP CD COUNT    							          		
    ,TRSPNO_D     ## TRSP CD COUNT    				                           
ORDER BY 
    1
    , ITEM
    , SORT1
    , REF_ID
    , SORTNUM			]]></sql>
			<params>
				<param name="repoPlanID" type="12" value="" out="N"/>
				<param name="fromWeek" type="12" value="" out="N"/>
				<param name="toWeek" type="12" value="" out="N"/>
				<param name="sosend" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
