<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="OnewaySimulateDBDAOSearchOneWayMainRSQL">
			<desc><![CDATA[EQR_ONE_WY_OFFR에서 One Way Offer 정보 검색]]></desc>
			<sql><![CDATA[
SELECT  
	A.FCAST_YRWK
	, A.FM_ECC_CD
	, A.TO_ECC_CD
	, A.Division                
	#foreach( ${key} in ${cntrTpSzList}) 
		, A.PLAN${key.field1}  
	#end                                                                                                            
    , A.numm
	, @[repo_pln_id] repo_pln_id                                                                                                             
FROM 
	(                                                                                                                         
   		##-------------------------Forecast VDL 구하기 ----------------------------------------                                           
    	SELECT  
			FCAST_YRWK
			, FM_ECC_CD
			, TO_ECC_CD
			#foreach( ${key} in ${cntrTpSzList})
				, ${key.field1}  PLAN${key.field1}
			#end                                                                                                  
 	        , 'Forecast VOL' Division
			, '1' numm                                                                                                               
    	FROM 
			(                                                                                                                      
 	  			SELECT 
					FCAST_YRWK
					, FM_ECC_CD
					, TO_ECC_CD 
					#foreach( ${key} in ${cntrTpSzList})
             			, SUM(DECODE(CNTR_TPSZ_CD , '${key.field1}', CNTR_VOL_QTY)) ${key.field1}
					#end                                                                    
 	 			FROM 
					(
						SELECT 
							FCAST_YRWK
							, FM_ECC_CD
							, TO_ECC_CD
							, CNTR_TPSZ_CD
							, CNTR_VOL_QTY
							, ROW_NUMBER() OVER (PARTITION BY FCAST_YRWK, FM_ECC_CD , TO_ECC_CD , CNTR_TPSZ_CD  ORDER BY ROWNUM) RUMM         
 		    			FROM 
							EQR_OB_FCAST                                                                                            
 				 			, (
								SELECT 
									ecc_cd 
								FROM 
									eqr_ecc_mst 
								WHERE 
									1 = 1
                         			#if (${fmecccd} != '') 
            							#if (${fmtype} == 'R')
                 							AND RCC_CD IN (${arrfmecccd}) 
										#end
            							#if (${fmtype} == 'L')
                 							AND LCC_CD IN (${arrfmecccd})
										#end
            							#if (${fmtype} == 'E')
                 							AND ECC_CD IN (${arrfmecccd})
										#end
		 				 			#end
                         	) c
                      		, (
								SELECT 
									ecc_cd 
								FROM 
									eqr_ecc_mst 
								WHERE 
									1 = 1 
                          			#if (${toecccd} != '') 
            							#if (${totype} == 'R')
                							AND RCC_CD IN (${arrtoecccd}) 
										#end
            							#if (${totype} == 'L')
                 							AND LCC_CD IN (${arrtoecccd})
										#end
            							#if (${totype} == 'E')
                 							AND ECC_CD IN (${arrtoecccd})
										#end
		  							#end
						 	) d   	 			                   
 						WHERE 
							SCNR_ID =  @[scnr_id]                                                                               
            				AND FCAST_YRWK  BETWEEN @[fm_yrwk]  AND @[to_yrwk]                                                  
            				AND fm_ecc_cd = c.ecc_cd 
							AND to_ecc_cd = d.ecc_cd                                                                        
      				)	                                                                                                                   
 				GROUP BY 
					FCAST_YRWK
					, FM_ECC_CD
					, TO_ECC_CD                                                                                                   
    		)                                                                                                                  
 	                                                                                                                             
	UNION ALL                                                                                                                    
   		##--------------------------- O/F offer 구하기 --------------------------------------------------------------------------    
   		SELECT      
			FCAST_YRWK
			, FM_ECC_CD
			, TO_ECC_CD
			#foreach( ${key} in ${cntrTpSzList})
				, ${key.field1}  OFFER${key.field1}
			#end                                                                                                              
 	        , 'O/F Offer' Division 
			, '2' numm                                                                                                               
    	FROM 
			(                                                                                                                      
 	   			SELECT    
					FCAST_YRWK
					, FM_ECC_CD
					, TO_ECC_CD
					#foreach( ${key} in ${cntrTpSzList})
						, MAX(DECODE(CNTR_TPSZ_CD , '${key.field1}', CNTR_QTY) ${key.field1}
					#end                                                                                  
 	 			FROM 
					(
						SELECT 
							FCAST_YRWK
							, FM_ECC_CD
							, TO_ECC_CD
							, CNTR_TPSZ_CD
							, CNTR_QTY
							, ROW_NUMBER() OVER (PARTITION BY FCAST_YRWK, FM_ECC_CD , TO_ECC_CD , CNTR_TPSZ_CD   ORDER BY ROWNUM) RUMM            
 		    			FROM 
							EQR_ONE_WY_OFFR                                                                                           
 	             			, (
								SELECT 
									ecc_cd 
								FROM 
									eqr_ecc_mst 
								WHERE 
									1 = 1
                         			#if (${fmecccd} != '') 
            							#if (${fmtype} == 'R')
                 							AND RCC_CD IN (${arrfmecccd}) 
										#end
            							#if (${fmtype} == 'L')
                 							AND LCC_CD IN (${arrfmecccd})
										#end
            							#if (${fmtype} == 'E')
                 							AND ECC_CD IN (${arrfmecccd})
										#end
		 				 			#end
                         	) c
                      		, (
								SELECT 
									ecc_cd 
								FROM 
									eqr_ecc_mst 
								WHERE 
									1 = 1 
                          			#if (${toecccd} != '') 
            							#if (${totype} == 'R')
                							AND RCC_CD IN (${arrtoecccd}) 
										#end
            							#if (${totype} == 'L')
                 							AND LCC_CD IN (${arrtoecccd})
										#end
            							#if (${totype} == 'E')
                 							AND ECC_CD IN (${arrtoecccd})
										#end
		  							#end
						 	) d   		 			                   
 						WHERE 
							REPO_PLN_ID = @[repo_pln_id]                                                                            
            				AND FCAST_YRWK  BETWEEN @[fm_yrwk]  AND @[to_yrwk]                                                     
       						AND fm_ecc_cd = c.ecc_cd 
							AND to_ecc_cd = d.ecc_cd                                                                        
 		 			)	                                                                                                                   
 				GROUP BY 
					FCAST_YRWK
					, FM_ECC_CD
					, TO_ECC_CD                                                                                                       
			)                                                                                                                  
	) A
	, ( 
			SELECT 
				'1' numm
				,  'Forecast VOL' Division 
			FROM 
				DUAL                                                                            
		UNION all                                                                                                                 
 	   		SELECT 
				'2' numm
				,  'O/F Offer' Division 
			FROM 
				DUAL                                                                                                             
	) B                                                                                                                         
 	                                                                                                                             
WHERE 
	A.numm = B.numm                                                                                                       

UNION ALL                                                                                          
    
	(
		SELECT 
			'' AS FCAST_YRWK
			, '' AS FM_ECC_CD
			, '' AS TO_ECC_CD
			, A.Division
			#foreach( ${key} in ${cntrTpSzList})
				, 	CASE WHEN A.NUMM = 1                                                                                                    
            			THEN                                                                                                               
                 			SUM(A.PLAN${key.field1})                                                                                                 
            			ELSE                                                                                                               
                 			CASE WHEN ${key.field2} - SUM(A.PLAN${key.field1}) > 0                                                                               
                 				THEN                                                                                                          
                      				SUM(A.PLAN${key.field1}) + ( ${key.field2} - SUM(A.PLAN${key.field1}))                                                                 
                 				ELSE                                                                                                          
                      				SUM(A.PLAN${key.field1}) + ( ${key.field2} - SUM(A.PLAN${key.field1}))                                                                 
                 			END                                                                                                           
            	END   PLNAD2
			#end                                                                                                      
            , A.numm
			, @[repo_pln_id] repo_pln_id                                                                                                             
 		FROM 
			(                                                                                                                      
   				##-------------------------Forecast VDL 구하기 ----------------------------------------                                           
    			SELECT     
					FCAST_YRWK
					, FM_ECC_CD
					, TO_ECC_CD
					#foreach( ${key} in ${cntrTpSzList})
						, ${key.field1}  PLAN${key.field1}
					#end                                                                                                      
 	          		, 'Forecast VOL' Division
					, '1' numm                                                                                                             
    			FROM 
					(                                                                                                                   
 	  					SELECT 
							FCAST_YRWK
							, FM_ECC_CD
							, TO_ECC_CD                                                                                            
							#foreach( ${key} in ${arrtpszcd})
             					, SUM(DECODE(CNTR_TPSZ_CD , '$key', CNTR_VOL_QTY)) ${key}
          					#end                                                                                      
 	  					FROM 
							(
								SELECT 
									FCAST_YRWK
									, FM_ECC_CD
									, TO_ECC_CD
									, CNTR_TPSZ_CD
									, CNTR_VOL_QTY
									, ROW_NUMBER() OVER (PARTITION BY FCAST_YRWK, FM_ECC_CD , TO_ECC_CD , CNTR_TPSZ_CD  ORDER BY ROWNUM) RUMM       
 		    					FROM 
									EQR_OB_FCAST                                                                                            
 				 					, (
										SELECT 
											ecc_cd 	
										FROM 
											eqr_ecc_mst 
										WHERE 
											1 = 1
                         					#if (${fmecccd} != '') 
            									#if (${fmtype} == 'R')
                 									AND RCC_CD IN (${arrfmecccd}) 
												#end
            									#if (${fmtype} == 'L')
                 									AND LCC_CD IN (${arrfmecccd})
												#end
            									#if (${fmtype} == 'E')
                 									AND ECC_CD IN (${arrfmecccd})
												#end
		 				 					#end
                         			) c
                      				, (
										SELECT 
											ecc_cd 
										FROM 
											eqr_ecc_mst 
										WHERE 
											1 = 1 
                          					#if (${toecccd} != '') 
            									#if (${totype} == 'R')
                									AND RCC_CD IN (${arrtoecccd}) 
												#end
            									#if (${totype} == 'L')
                 									AND LCC_CD IN (${arrtoecccd})
												#end
            									#if (${totype} == 'E')
                 									AND ECC_CD IN (${arrtoecccd})
												#end
		  									#end
						 			) d  			                                                                                                                   
 			 					WHERE 
									SCNR_ID = @[scnr_id]                                                                              
             						AND FCAST_YRWK  BETWEEN @[fm_yrwk]  AND @[to_yrwk]                                                          
    		 						AND fm_ecc_cd = c.ecc_cd 
									AND to_ecc_cd = d.ecc_cd                                                           
 							)	                                                                                                                 
 						GROUP BY 
							FCAST_YRWK	
							, FM_ECC_CD
							, TO_ECC_CD                                                                                                 
       				)                                                                                                               
 	                                                                                                                           
   			UNION ALL                                                                                                                 
   				##--------------------------- O/F offer 구하기 -------------------------------------------------------------------------- 
   				SELECT      
					FCAST_YRWK
					, FM_ECC_CD
					, TO_ECC_CD
					#foreach( ${key} in ${cntrTpSzList})
						, ROUND(${key.field1}/DECODE(${key.field1}SUM,0,1,D2SUM) * ${key.field2},0)  OFFER${key.field1}  
					#end                                                                                   
 	          		, 'O/F Offer' Division 	
					, '2' numm                                                                                                             
   				FROM
					( 
						SELECT    
							FCAST_YRWK
							, FM_ECC_CD
							, TO_ECC_CD                                                                                          
 							#foreach( ${key} in ${arrtpszcd})
                   				, SUM(DECODE(CNTR_TPSZ_CD , '$key', CNTR_VOL_QTY)) ${key}                                                                                                          
                			#end
       			 			#foreach( ${key} in ${arrtpszcd})
		         				, (
									SELECT 
										SUM(DECODE(CNTR_TPSZ_CD , '$key', CNTR_VOL_QTY))
                  					FROM 
										EQR_OB_FCAST 
                      					, (
											SELECT 
												ecc_cd 
											FROM 
												eqr_ecc_mst 
											WHERE 
												1 = 1
                           						#if (${fmecccd} != '') 
            										#if (${fmtype} == 'R')
                 										AND RCC_CD IN (${arrfmecccd}) 
													#end
            										#if (${fmtype} == 'L')
                 										AND LCC_CD IN (${arrfmecccd})
													#end
            										#if (${fmtype} == 'E')
                 										AND ECC_CD IN (${arrfmecccd})
													#end
		 				 						#end
                         				) c
                  						, (
											SELECT 
												ecc_cd 
											FROM 
												eqr_ecc_mst 
											WHERE 
												1 = 1 
                          						#if (${toecccd} != '') 
            										#if (${totype} == 'R')
                										AND RCC_CD IN (${arrtoecccd}) 
													#end
            										#if (${totype} == 'L')
                 										AND LCC_CD IN (${arrtoecccd})
													#end
            										#if (${totype} == 'E')
                 										AND ECC_CD IN (${arrtoecccd})
													#end
		  										#end
						 				) d 	
                  					WHERE  
										SCNR_ID = @[scnr_id] 
                  						AND FCAST_YRWK  BETWEEN  @[fm_yrwk] AND @[to_yrwk]
                  						AND fm_ecc_cd = c.ecc_cd 
										AND to_ecc_cd = d.ecc_cd
                				) ${key}SUM
							#end	                                                                                                        
 		 				FROM 
							(
								SELECT 
									FCAST_YRWK
									, FM_ECC_CD
									, TO_ECC_CD
									, CNTR_TPSZ_CD
									, CNTR_QTY
									, ROW_NUMBER() OVER (PARTITION BY FCAST_YRWK, FM_ECC_CD , TO_ECC_CD , CNTR_TPSZ_CD  ORDER BY ROWNUM) RUMM       
 			   					FROM 
									EQR_ONE_WY_OFFR                                                                                            
 	                				, (
										SELECT 
											ecc_cd 
										FROM 
											eqr_ecc_mst 
										WHERE 
											1 = 1
                         					#if (${fmecccd} != '') 
            									#if (${fmtype} == 'R')
                 									AND RCC_CD IN (${arrfmecccd}) 
												#end
            									#if (${fmtype} == 'L')
                 									AND LCC_CD IN (${arrfmecccd})
												#end
            									#if (${fmtype} == 'E')
                 									AND ECC_CD IN (${arrfmecccd})
												#end
		 				 					#end
                         			) c
                  					, (
										SELECT 
											ecc_cd 
										FROM 
											eqr_ecc_mst 
										WHERE 
											1 = 1 
                          					#if (${toecccd} != '') 
            									#if (${totype} == 'R')
                									AND RCC_CD IN (${arrtoecccd}) 
												#end
            									#if (${totype} == 'L')
                 									AND LCC_CD IN (${arrtoecccd})
												#end
            									#if (${totype} == 'E')
                 									AND ECC_CD IN (${arrtoecccd})
												#end
		  									#end
						 			) d 	 				                                                                                                                   
 								WHERE 
									REPO_PLN_ID = @[repo_pln_id]                                                                              
                					AND FCAST_YRWK  BETWEEN @[fm_yrwk]  AND @[to_yrwk]                                                           
                					AND fm_ecc_cd = c.ecc_cd 
									AND to_ecc_cd = d.ecc_cd                                                         
 							)	                                                                                                                 
 						GROUP BY 
							FCAST_YRWK
							, FM_ECC_CD
							, TO_ECC_CD                                                                                                     
             		)                                                                                                               
 	 		) A
			, ( 
					SELECT 
						'1' numm
						,  'Forecast VOL' Division 
					FROM 
						DUAL                                                                          
 	   			UNION all                                                                                                               
 	   				SELECT 
						'2' numm
						,  'O/F Offer' Division 
					FROM 
						DUAL                                                                        
 	                                                                                                                           
 	 		) B                                                                                                                       
 	                                                                                                                           
 	 	WHERE 
			A.numm = B.numm                                                                                                     
     	GROUP BY 
			A.Division
			, A.numm                                          
	)                    
 	                                                                                                                             
ORDER BY 
	1
	,2
	,3
	,numm
	,FCAST_DT			]]></sql>
			<params>
				<param name="repo_pln_id" type="12" value="" out="N"/>
				<param name="scnr_id" type="12" value="" out="N"/>
				<param name="fm_yrwk" type="12" value="" out="N"/>
				<param name="to_yrwk" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
