<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ChargeAmountDiscountMgtDBDAOSearchAfterBookingMasListRSQL">
			<desc><![CDATA[ChargeAmountDiscountMgtDBDAOSearchAfterBookingMasList]]></desc>
			<sql><![CDATA[
SELECT @[aft_expt_dar_no] AFT_EXPT_DAR_NO
     , T2.CUST_CD
     , T2.CUST_NM
     , NVL(T1.LOD_QTY,0) LOD_QTY
     , NVL(T1.CM_AMT, 0 ) CM_AMT
     , NVL(T1.CMPB_AMT, 0) CMPB_AMT
FROM ( 
SELECT @[aft_expt_dar_no] AFT_EXPT_DAR_NO
      ,BB.CUST_CNT_CD||TRIM(TO_CHAR(BB.CUST_SEQ,'000000')) CUST_CD
      ,BB.CUST_LGL_ENG_NM CUST_NM
      --,CTRT_NO AS AFT_BKG_CTRT_NO
      --,CTRT_TP_CD AS BKG_CTRT_TP_CD
      ,NVL(SUM(LOAD),0) AS LOD_QTY    --LOAD
      ,NVL(ROUND(SUM(BKG_REV+MISC_REV+DEM_DET) - NVL(SUM(CM_COST),0),2),0) AS CM_AMT   -- CM
      ,NVL(ROUND((SUM(BKG_REV+MISC_REV+DEM_DET) - NVL(SUM(CM_COST),0) ) / SUM(LOAD),2),0)  AS CMPB_AMT   -- CMPB
  FROM (
    SELECT AA.CTRT_NO CTRT_NO
         , AA.CTRT_TP_CD
         , CUST_CD
         , SUM(DECODE(SUBSTR(D.SPCL_CNTR_TPSZ_CD,-1,1),'2', D.BKG_QTY, '3', D.BKG_QTY, D.BKG_QTY*2)) AS LOAD
         , SUM(NVL(D.BKG_REV,0)+NVL(D.BKG_OFT_REV,0)) AS BKG_REV
         , SUM(NVL(D.BKG_MISC_REV,0)+NVL(D.SCR_CHG_REV,0)) AS MISC_REV  
         , SUM(NVL(D.PA_CM_COST_TTL_AMT, 0)) AS CM_COST
         , SUM(NVL(D.DMDT_COM_AMT,0)) AS DEM_DET
    FROM BKG_BOOKING BB, MAS_BKG_EXPN_DTL_WK D, MAS_OFC_LVL L, MAS_MON_VVD V 
       , ( SELECT DISTINCT SC_NO CTRT_NO, 'S' CTRT_TP_CD 
                , C.CUST_CNT_CD||TRIM(TO_CHAR(C.CUST_SEQ,'000000')) CUST_CD
            FROM PRI_SP_MN A, PRI_SP_HDR B, PRI_SP_CTRT_PTY C
            WHERE C.CUST_CNT_CD = SUBSTR(@[cust_cd],1,2)
            AND C.CUST_SEQ = TO_NUMBER(SUBSTR(@[cust_cd],3))
            AND A.PROP_NO = B.PROP_NO
            AND A.PROP_NO = C.PROP_NO
            UNION ALL
            SELECT DISTINCT B.RFA_NO, 'R' CTRT_TP_CD 
                 , A.CTRT_CUST_CNT_CD||TRIM(TO_CHAR(A.CTRT_CUST_SEQ,'000000')) CUST_CD
            FROM PRI_RP_MN A, PRI_RP_HDR B
            WHERE A.CTRT_CUST_CNT_CD = SUBSTR(@[cust_cd],1,2)
            AND A.CTRT_CUST_SEQ = TO_NUMBER(SUBSTR(@[cust_cd],3))
            AND A.PROP_NO = B.PROP_NO ) AA
		, ( SELECT to_char(sysdate - DECODE(@[lcc_flg],'Y3', 365 + 94, 'Y0', 365, '63', 183 + 94, '60', 183, 0),'YYYYWW') FM_WK, 
                   to_char(sysdate - DECODE(@[lcc_flg],'Y3', 94, '63', 94, 0),'YYYYWW')-1 TO_WK
              FROM DUAL ) CC
    WHERE AA.CTRT_NO IN ( BB.RFA_NO, BB.SC_NO )
    
    AND BB.BKG_NO = D.BKG_NO
    
    AND TRIM(SUBSTR(D.SLS_YRMON, 1, 4)||D.COST_WK) BETWEEN FM_WK AND TO_WK
    AND D.BL_NO_TP             IN ('M','0')
    AND D.BKG_STS_CD           IN ('F','S',DECODE(NVL('','N'), 'Y', 'W'))
    
    AND D.AGMT_SGN_OFC_CD = L.OFC_CD
    AND L.OFC_LVL < '9'
    AND D.SLS_YRMON  BETWEEN L.OFC_APLY_FM_YRMON AND L.OFC_APLY_TO_YRMON
    
    
    AND V.TRD_CD              = D.TRD_CD 
    AND V.RLANE_CD            = D.RLANE_CD 
    AND V.IOC_CD              = D.IOC_CD 
    AND V.VSL_CD              = D.VSL_CD 
    AND V.SKD_VOY_NO          = D.SKD_VOY_NO 
    AND V.DIR_CD              = D.DIR_CD 
    AND NVL(V.DELT_FLG,'N')   = 'N'

    GROUP BY AA.CTRT_NO, AA.CTRT_TP_CD, AA.CUST_CD
    ) AA, MDM_CUSTOMER BB

WHERE 1=1
  AND BB.CUST_CNT_CD = SUBSTR(AA.CUST_CD(+),1,2)
  AND BB.CUST_SEQ = SUBSTR(AA.CUST_CD(+),3)
  AND BB.CUST_CNT_CD = SUBSTR(@[cust_cd],1,2)
  AND BB.CUST_SEQ = TO_NUMBER(SUBSTR(@[cust_cd],3))
GROUP BY --CTRT_NO, CTRT_TP_CD, 
		BB.CUST_CNT_CD||TRIM(TO_CHAR(BB.CUST_SEQ,'000000')), BB.CUST_LGL_ENG_NM ) T1

	, ( SELECT @[cust_cd] CUST_CD, 
               ( SELECT CUST_LGL_ENG_NM FROM MDM_CUSTOMER WHERE CUST_CNT_CD = SUBSTR(@[cust_cd],1,2) AND CUST_SEQ = TO_NUMBER(SUBSTR(@[cust_cd],3))) CUST_NM
          FROM DUAL ) T2
WHERE T1.CUST_CD(+) = T2.CUST_CD			]]></sql>
			<params>
				<param name="aft_expt_dar_no" type="12" value="" out="N"/>
				<param name="cust_cd" type="12" value="" out="N"/>
				<param name="lcc_flg" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
