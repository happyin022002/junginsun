<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ContainerMovementMgtDBDAOCorrectionVLVDListRSQL">
			<desc><![CDATA[   VL VD Collection Select]]></desc>
			<sql><![CDATA[
SELECT CTM.CNTR_NO,
       CTM.CNTR_TPSZ_CD,
       CTM.CNMV_CYC_NO,
       CTM.MVMT_STS_CD,
       CTM.MVMT_CRE_TP_CD,
       CTM.ORG_YD_CD,
	   SUBSTR(CTM.ORG_YD_CD,0,5) AS ORG_YD_CD1,
       SUBSTR(CTM.ORG_YD_CD,6) AS ORG_YD_CD2,
       CTM.CNMV_EVNT_DT,
       CTM.CRNT_VSL_CD||CTM.CRNT_SKD_VOY_NO||CTM.CRNT_SKD_DIR_CD AS VVL_ID,
       CTM.CRNT_VSL_CD||CTM.CRNT_SKD_VOY_NO||CTM.CRNT_SKD_DIR_CD AS CNTR_ID,
       CTM.BKG_NO,
       '' AS BKG_NO_SPLIT,
       CTM.BKG_KNT,
       BKG.BL_NO,
       DECODE (CTM.FCNTR_FLG, 'Y', 'F', 'M') AS FCNTR_FLG,
       DECODE (CTM.OB_CNTR_FLG, 'Y', 'O', 'I') AS OB_CNTR_FLG,
       CTM.MVMT_INP_TP_CD,
       CTM.BKG_RCV_TERM_CD,
       CTM.CNTR_DMG_FLG,
       CTM.CNTR_DISP_FLG,
       CTM.IMDT_EXT_FLG,
       CTM.CNTR_RFUB_FLG,
       CTM.SPCL_CGO_FLG,
       CTM.VNDR_SEQ,
       VEN.VNDR_LGL_ENG_NM,
       CTM.MVMT_TRSP_MOD_CD,
       CTM.UPD_LOCL_DT,
       CTM.CRE_LOCL_DT,
       CTM.OFC_CD,
       CTM.USR_NM,
       CTM.CNMV_RMK,
       CTM.CNMV_YR,
       CTM.CNMV_ID_NO,
       ORD.CNT,
       ORD.VL_DATE,
       CTM.BKG_CGO_TP_CD,
       SYS_AREA_GRP_ID CNTR_SVR_ID,
       CTM.CNMV_SEQ,
       CTM.CNMV_CO_CD,
       CTM.MVMT_EDI_MSG_TP_ID,
       CTM.CNTR_XCH_CD,
       CTM.MGST_NO,
       CTM.CHSS_NO,
       CTM.INP_YD_CD,
       CTM.DEST_YD_CD,
       CTM.CNMV_SPLIT_NO,
       CTM.PKUP_NO,
       CTM.WBL_NO
  FROM CTM_MOVEMENT CTM,
       BKG_BOOKING BKG,
       MDM_VENDOR VEN,
#if(${p_status} == 'VL')
       (SELECT DISTINCT AA.CNTR_NO,
               AA.MVMT_STS_CD,
               AA.CNMV_EVNT_DT,
               BB.CNT,
               AA.CNMV_CYC_NO,
               AA.CNMV_YR,
               AA.CNMV_SEQ,
               AA.CNMV_SPLIT_NO,
               AA.BKG_CGO_TP_CD,
               (SELECT /*+ INDEX_DESC(AAA XUK1CTM_MOVEMENT) */
                       AAA.CNMV_EVNT_DT
                  FROM CTM_MOVEMENT AAA
                 WHERE AAA.CNTR_NO = AA.CNTR_NO
                   AND AAA.MVMT_STS_CD <> @[p_status]
                   AND ROWNUM = 1) VL_DATE
          FROM CTM_MOVEMENT AA,
               (SELECT D.CNTR_NO,
                       D.CNMV_YR,
                       C.CNMV_SEQ,
                       C.CNMV_SPLIT_NO,
                       C.MVMT_STS_CD,
                       COUNT (*) OVER (PARTITION BY D.CNTR_NO ORDER BY D.CNTR_NO) AS CNT
                  FROM CTM_MOVEMENT C,
                       (SELECT CNTR_NO,
                               CNMV_YR,
                               CNMV_SEQ,
                               CNMV_SPLIT_NO
                          FROM CTM_MOVEMENT
                         WHERE CRNT_VSL_CD = SUBSTR (@[p_vvdcd], 0, 4)
                           AND CRNT_SKD_VOY_NO = SUBSTR (@[p_vvdcd], 5, 4)
                           AND CRNT_SKD_DIR_CD = SUBSTR (@[p_vvdcd], 9, 1)
     #if (${p_yard1} != '')
               #if (${p_yard2} != '')
                             AND ORG_YD_CD = @[p_yard1]||@[p_yard2]
               #else
                             AND ORG_YD_CD LIKE @[p_yard1]||'%'
               #end
     #end
                             AND CNMV_EVNT_DT BETWEEN TO_DATE (@[p_date0], 'YYYY-MM-DD') AND TO_DATE (@[p_date0], 'YYYY-MM-DD') + 0.99999
                             AND MVMT_STS_CD = @[p_status]
     #if (${p_type} != '')
                             AND BKG_CGO_TP_CD = @[p_type]
     #end
                         ) D
                   WHERE C.CNTR_NO = D.CNTR_NO
                     AND C.CNMV_YR >= D.CNMV_YR
                     AND C.CNMV_SEQ >= D.CNMV_SEQ
                     AND C.CNMV_SPLIT_NO >= D.CNMV_SPLIT_NO) BB
           WHERE AA.CNTR_NO = BB.CNTR_NO
             AND AA.CNMV_YR >= BB.CNMV_YR
             AND AA.CNMV_SEQ >= BB.CNMV_SEQ
             AND AA.CNMV_SPLIT_NO >= BB.CNMV_SPLIT_NO
        ORDER BY BB.CNT DESC,
                 AA.CNTR_NO,
                 AA.CNMV_YR,
                 AA.CNMV_SEQ,
                 AA.CNMV_SPLIT_NO) ORD
#else
       (SELECT DISTINCT AA.CNTR_NO,
               AA.MVMT_STS_CD,
               AA.CNMV_EVNT_DT,
               BB.CNT,
               AA.CNMV_CYC_NO,
               AA.CNMV_YR,
               AA.CNMV_SEQ,
               AA.CNMV_SPLIT_NO,
               AA.BKG_CGO_TP_CD,
               VL_DATE
          FROM CTM_MOVEMENT AA,
              (SELECT D.CNTR_NO,
                       D.CNMV_YR,
                       C.CNMV_SEQ,
                       C.CNMV_SPLIT_NO,
                       C.MVMT_STS_CD,
                       VL_DATE,
                       COUNT (*) OVER (PARTITION BY D.CNTR_NO ORDER BY D.CNTR_NO) AS CNT
                  FROM CTM_MOVEMENT C,
                       (SELECT *
                          FROM (SELECT B.CNTR_NO,
                                       B.CNMV_YR,
                                       B.CNMV_SEQ,
                                       B.CNMV_SPLIT_NO,
                                       B.CNMV_EVNT_DT,
                                       B.MVMT_STS_CD,
                                       LAG (TO_CHAR (CNMV_EVNT_DT, 'YYYY-MM-DD HH24:MI'), 1) OVER (PARTITION BY B.CNTR_NO ORDER BY CNMV_ID_NO) AS VL_DATE
                                  FROM CTM_MOVEMENT B,
                                       (SELECT CNTR_NO,
                                               CNMV_CYC_NO
                                          FROM CTM_MOVEMENT
                                         WHERE CRNT_VSL_CD = SUBSTR (@[p_vvdcd], 0, 4)
                                           AND CRNT_SKD_VOY_NO = SUBSTR (@[p_vvdcd], 5, 4)
                                           AND CRNT_SKD_DIR_CD = SUBSTR (@[p_vvdcd], 9, 1)
     #if (${p_yard1} != '')
          #if (${p_yard2} != '')
                                           AND ORG_YD_CD = @[p_yard1]||@[p_yard2]
          #else
                                           AND ORG_YD_CD LIKE @[p_yard1]||'%'
          #end
     #end
                                           AND CNMV_EVNT_DT BETWEEN TO_DATE (@[p_date0], 'YYYY-MM-DD') AND TO_DATE (@[p_date0], 'YYYY-MM-DD') + 0.99999
                                           AND MVMT_STS_CD = @[p_status]
     #if (${p_type} != '')
                                           AND BKG_CGO_TP_CD = @[p_type]
     #end
                                       ) A
                                 WHERE CRNT_VSL_CD = SUBSTR (@[p_vvdcd], 0, 4)
                                   AND CRNT_SKD_VOY_NO = SUBSTR (@[p_vvdcd], 5, 4)
                                   AND CRNT_SKD_DIR_CD = SUBSTR (@[p_vvdcd], 9, 1)
                                   AND B.CNMV_CYC_NO = A.CNMV_CYC_NO
                                   AND B.CNTR_NO = A.CNTR_NO)
                         WHERE MVMT_STS_CD = @[p_status]) D
                 WHERE C.CNTR_NO = D.CNTR_NO
                   AND C.CNMV_YR >= D.CNMV_YR
                   AND C.CNMV_SEQ >= D.CNMV_SEQ
                   AND C.CNMV_SPLIT_NO >= D.CNMV_SPLIT_NO) BB
         WHERE AA.CNTR_NO = BB.CNTR_NO
           AND AA.CNMV_YR >= BB.CNMV_YR
           AND AA.CNMV_SEQ >= BB.CNMV_SEQ
           AND AA.CNMV_SPLIT_NO >= BB.CNMV_SPLIT_NO
      ORDER BY BB.CNT DESC,
               AA.CNTR_NO,
               AA.CNMV_YR,
               AA.CNMV_SEQ,
               AA.CNMV_SPLIT_NO) ORD
#end
 WHERE CTM.BKG_NO = BKG.BKG_NO
   AND CTM.VNDR_SEQ = VEN.VNDR_SEQ(+)
   AND CTM.CNTR_NO = ORD.CNTR_NO
   AND CTM.CNMV_YR = ORD.CNMV_YR
   AND CTM.CNMV_CYC_NO = ORD.CNMV_CYC_NO
   AND CTM.CNMV_SEQ = ORD.CNMV_SEQ
   AND CTM.CNMV_SPLIT_NO = ORD.CNMV_SPLIT_NO
   AND CTM.MVMT_STS_CD = ORD.MVMT_STS_CD
 ORDER BY ORD.CNT DESC,
       CTM.CNTR_NO,
       CTM.CNMV_YR,
       CTM.CNMV_SEQ,
       CTM.CNMV_SPLIT_NO			]]></sql>
			<params>
				<param name="p_status" type="12" value=" " out="N"/>
				<param name="p_vvdcd" type="12" value="" out="N"/>
				<param name="p_yard1" type="12" value="" out="N"/>
				<param name="p_yard2" type="12" value="" out="N"/>
				<param name="p_date0" type="12" value="" out="N"/>
				<param name="p_type" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
