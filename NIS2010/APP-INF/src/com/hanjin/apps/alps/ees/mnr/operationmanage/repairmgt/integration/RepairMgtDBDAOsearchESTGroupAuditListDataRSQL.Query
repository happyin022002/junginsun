<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="RepairMgtDBDAOsearchESTGroupAuditListDataRSQL">
			<desc><![CDATA[2012.11.23 조경완 [CHM-201220893-01] Estimate Group Auditing 모듈에서 Repair code 및 division code 수정 기능 추가
- Estimate Group Auditing SQL 튜닝]]></desc>
			<sql><![CDATA[
SELECT   RSV.RQST_EQ_NO
       , RSV.RPR_RQST_SEQ
       , RSV.RPR_RQST_VER_NO
       , RSV.RPR_RQST_LST_VER_FLG
       , RSV.EQ_KND_CD
       , RSV.EQ_TPSZ_CD
       , RSV.VNDR_SEQ
       , RSV.VNDR_NM
       , RSV.RPR_STS_CD
       , RSV.RPR_DTL_STS_CD
       , RSV.RQST_REF_NO
       , RSV.MNR_INP_TP_CD
       , RSV.COST_OFC_CD
       , TO_CHAR(GLOBALDATE_PKG.TIME_CONV_OFC_FNC(MNR_COMMON_PKG.MNR_GET_HOOFC_FNC(),RSV.RQST_DT,@[cur_ofc_cd]),'YYYY-MM-DD') AS RQST_DT
       , RSV.RQST_USR_ID
       , RSV.MNR_MEAS_UT_CD
       , RSV.APRO_OFC_CD
       , TO_CHAR(GLOBALDATE_PKG.TIME_CONV_OFC_FNC(MNR_COMMON_PKG.MNR_GET_HOOFC_FNC(),RSV.APRO_DT,@[cur_ofc_cd]),'YYYY-MM-DD') AS APRO_DT
       , RSV.APRO_USR_ID
       , RSV.RPR_OFFH_FLG
       , TO_CHAR(RSV.RPR_RSLT_DT,'YYYY-MM-DD') AS RPR_RSLT_DT
       , RSV.CURR_CD
       , RSV.RPR_YD_CD
       , TO_CHAR(RSV.EQ_DMG_DT,'YYYY-MM-DD') AS EQ_DMG_DT
       , RSV.EQ_DMG_TP_CD
       , RSV.RPR_WRK_TP_CD
       , RSV.MNR_EDI_NM
       , RSV.N3PTY_FLG
       , RSV.IF_TRC_SEQ
       , RSV.N3PTY_BIL_TTL_AMT
       , RSV.DISP_FLG
       , RSV.DISP_NO
       , RSV.DISP_DTL_SEQ
       , RSV.FILE_SEQ
       , RSV.MNR_RPR_RMK
       , RSV.EDI_ID
       , RSV.MNR_ORD_OFC_CTY_CD
       , RSV.MNR_ORD_SEQ
       , RSV.AGMT_OFC_CTY_CD
       , RSV.AGMT_SEQ
       , RSV.AGMT_VER_NO
       , RSV.CRE_USR_ID
       , TO_CHAR(GLOBALDATE_PKG.TIME_CONV_OFC_FNC(MNR_COMMON_PKG.MNR_GET_HOOFC_FNC(),RSV.CRE_DT,@[cur_ofc_cd]),'YYYY-MM-DD') AS CRE_DT
       , RSV.UPD_USR_ID
       , TO_CHAR(GLOBALDATE_PKG.TIME_CONV_OFC_FNC(MNR_COMMON_PKG.MNR_GET_HOOFC_FNC(),RSV.UPD_DT,@[cur_ofc_cd]),'YYYY-MM-DD') AS UPD_DT
       , NVL2((MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC (TO_CHAR(SYSDATE, 'YYYYMM'),RSV.CURR_CD_MGI, RSV.CURR_CD, RSV.AUTO_AMT))
              , DECODE((MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC (TO_CHAR(SYSDATE, 'YYYYMM'),RSV.CURR_CD_MGI, RSV.CURR_CD, RSV.AUTO_AMT)),0,-1,(MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(TO_CHAR(SYSDATE, 'YYYYMM'),RSV.CURR_CD_MGI, RSV.CURR_CD, RSV.AUTO_AMT)))
              , -1
         ) AS AUTO_AMT
       , NVL2(MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC (TO_CHAR(SYSDATE, 'YYYYMM'),RSV.CURR_CD_MGI, RSV.CURR_CD, RSV.APPOVAL_AMT)
              , DECODE(MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC (TO_CHAR(SYSDATE, 'YYYYMM'),RSV.CURR_CD_MGI, RSV.CURR_CD, RSV.APPOVAL_AMT),0,9999999999999,MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC (TO_CHAR(SYSDATE, 'YYYYMM'),RSV.CURR_CD_MGI, RSV.CURR_CD, RSV.APPOVAL_AMT))
              , 9999999999999
         ) AS APPOVAL_AMT
       , RSV.UPPR_OFC_CD
       , RSV.TRSM_MOD_CD
       , RSV.TRF_NO
       , MNR_COMMON_PKG.MNR_CONV_AGMT_NO_FNC(RSV.AGMT_OFC_CTY_CD, RSV.AGMT_SEQ) AS AGMT_NO
       , RSV.AGMT_OFC_CD
       , RSV.MNR_VRFY_TP_CD
       , RSV.DMG_FLAG
       , RSV.IMM_EXT
       , RSV.TOTAL_AMT
       , MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC (TO_CHAR(SYSDATE, 'YYYYMM'), RSV.CURR_CD, 'USD', RSV.TOTAL_AMT) AS TOTAL_USD_AMT
       , RSV.AGMT_REF_NO
--동일 vendor 가 동일 장비를 15일 이내에 approval 기록이 있는지 조회, 신용찬, 2014-09-09
       , (
           SELECT   CASE WHEN COUNT(1) >= 1 THEN 'T' ELSE 'F' END CHK_RSLT 
           FROM     MNR_RPR_RQST_HDR X
           WHERE    1 = 1
           AND      X.RQST_EQ_NO           = RSV.RQST_EQ_NO
           AND      X.VNDR_SEQ             = TO_NUMBER(RSV.VNDR_SEQ)
           AND      X.RPR_RQST_LST_VER_FLG = 'Y'
           AND      X.RPR_STS_CD           = 'HA'
           AND      X.APRO_DT BETWEEN GLOBALDATE_PKG.TIME_CONV_OFC_FNC(RSV.APRO_OFC_CD, SYSDATE-15, MNR_COMMON_PKG.MNR_GET_HOOFC_FNC()) --APRO_OFC_CD
           AND      GLOBALDATE_PKG.TIME_CONV_OFC_FNC(RSV.APRO_OFC_CD, SYSDATE,    MNR_COMMON_PKG.MNR_GET_HOOFC_FNC()) --APRO_OFC_CD   
         ) DUP_CHK
FROM     (
           SELECT   /*+ LEADING(MRH) INDEX(MRH XAK4MNR_RPR_RQST_HDR) */
                    MRH.RQST_EQ_NO
                  , MRH.RPR_RQST_SEQ
                  , MRH.RPR_RQST_VER_NO
                  , MRH.RPR_RQST_LST_VER_FLG
                  , MRH.EQ_KND_CD
                  , MRH.EQ_TPSZ_CD
                  , MRH.VNDR_SEQ
                  , MDV.VNDR_LGL_ENG_NM AS VNDR_NM
                  , MRH.RPR_STS_CD
                  , MRH.RPR_DTL_STS_CD
                  , MRH.RQST_REF_NO
                  , MRH.MNR_INP_TP_CD
                  , MRH.COST_OFC_CD
                  , MRH.RQST_DT
                  , MRH.RQST_USR_ID
                  , MRH.MNR_MEAS_UT_CD
                  , MRH.APRO_OFC_CD
                  , MRH.APRO_DT
                  , MRH.APRO_USR_ID
                  , MRH.RPR_OFFH_FLG
                  , MRH.RPR_RSLT_DT
                  , MRH.CURR_CD
                  , MRH.RPR_YD_CD
                  , MRH.EQ_DMG_DT
                  , MRH.EQ_DMG_TP_CD
                  , MRH.RPR_WRK_TP_CD
                  , MRH.MNR_EDI_NM
                  , MRH.N3PTY_FLG
                  , MRH.IF_TRC_SEQ
                  , MRH.N3PTY_BIL_TTL_AMT
                  , MRH.DISP_FLG
                  , MRH.DISP_NO
                  , MRH.DISP_DTL_SEQ
                  , MRH.FILE_SEQ
                  , MRH.MNR_RPR_RMK
                  , MPA.EDI_ID
                  , MRH.MNR_ORD_OFC_CTY_CD
                  , MRH.MNR_ORD_SEQ
                  , MRH.AGMT_OFC_CTY_CD
                  , MRH.AGMT_SEQ
                  , MRH.AGMT_VER_NO
                  , MRH.CRE_USR_ID
                  , MRH.CRE_DT
                  , MRH.UPD_USR_ID
                  , MRH.UPD_DT
                  , MGI.CURR_CD CURR_CD_MGI
                  , DECODE(SIGN(SYSDATE - MGI.EFF_DT),1,MGI.AFT_AUTO_APRO_AMT,MGI.BFR_AUTO_APRO_AMT) AUTO_AMT
                  , DECODE(SIGN(SYSDATE - MGI.EFF_DT),1,MGI.AFT_SELF_AUTH_AMT,MGI.BFR_SELF_AUTH_AMT) APPOVAL_AMT
                  , MGI.UPPR_OFC_CD
                  , MPA.TRSM_MOD_CD
                  , MAH.TRF_NO
                  , MAH.AGMT_OFC_CD
                  , NVL(MSV.DMG_FLAG,'N') DMG_FLAG
                  , MSV.IMM_EXT
                  , (
                      SELECT   MAX(DECODE(MRD.MNR_VRFY_TP_CD, 'AA', 'SS', MRD.MNR_VRFY_TP_CD))
                      FROM     MNR_RPR_RQST_DTL MRD
                      WHERE    1 = 1
                      AND      MRD.RQST_EQ_NO = MRH.RQST_EQ_NO
                      AND      MRD.RPR_RQST_SEQ = MRH.RPR_RQST_SEQ
                      AND      MRD.RPR_RQST_VER_NO = MRH.RPR_RQST_VER_NO
                    ) MNR_VRFY_TP_CD
                  , NVL(MRH.MNR_WRK_AMT,0) TOTAL_AMT
                  , MAH.AGMT_REF_NO
           FROM     MNR_RPR_RQST_HDR MRH
                  , MNR_OFC_GEN_INFO MGI
                  , MDM_VENDOR MDV
                  , MNR_AGMT_HDR MAH
                  , MNR_PARTNER MPA
                  , MNR_EQ_STS_V MSV
           WHERE    1 = 1
           AND      MGI.MNR_GRP_TP_CD(+) = 'RPR'
           AND      MGI.OFC_CD(+)    = MRH.APRO_OFC_CD
           AND      MGI.EQ_KND_CD(+) = MRH.EQ_KND_CD
           AND      MGI.COST_CD(+) = 'MR' || DECODE(MRH.EQ_KND_CD,'U',DECODE(SUBSTR(MRH.EQ_TPSZ_CD, 1, 1), 'R', 'R', 'D'),MRH.EQ_KND_CD)
           AND      RTRIM(MRH.APRO_OFC_CD) = @[apro_ofc_cd]
           AND      MRH.RPR_STS_CD IN ('HR','SR')
           AND      MRH.VNDR_SEQ = MDV.VNDR_SEQ
           AND      MRH.RPR_RQST_LST_VER_FLG = 'Y'
           AND      NVL(MRH.RCT_RPR_FLG,'N') <> 'Y'
#if (${rqst_type} != 'Y')
           AND      MRH.MNR_INP_TP_CD <> 'E'
#else
           AND      MRH.MNR_INP_TP_CD = 'E'
#end
           AND      MAH.AGMT_OFC_CTY_CD = MRH.AGMT_OFC_CTY_CD
           AND      MAH.AGMT_SEQ = MRH.AGMT_SEQ
           AND      MAH.AGMT_LST_VER_FLG = 'Y'
           AND      MPA.MNR_GRP_TP_CD = 'RPR'
           AND      MPA.MNR_PRNR_SEQ = MRH.VNDR_SEQ
           AND      MPA.CTRL_OFC_CD  = MRH.COST_OFC_CD
           AND      MRH.RQST_EQ_NO = MSV.EQ_NO(+)
   
#if (${fm_rqst_dt} != '' && ${to_rqst_dt} != '')
           AND      MRH.RQST_DT BETWEEN GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[cur_ofc_cd],TO_DATE(@[fm_rqst_dt],'yyyy-mm-dd'),MNR_COMMON_PKG.MNR_GET_HOOFC_FNC()) AND GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[cur_ofc_cd],TO_DATE(@[to_rqst_dt],'yyyy-mm-dd') + 0.99999,MNR_COMMON_PKG.MNR_GET_HOOFC_FNC())    
#end

#if (${eq_knd_cd} != 'ALL')
           AND      MRH.EQ_KND_CD = @[eq_knd_cd]
#end
#if (${rqst_eq_no} != '')
           AND     MRH.RQST_EQ_NO IN (
    #foreach ($user_eq_no IN ${eqNos})
        #if($velocityCount < $eqNos.size())
                                '$user_eq_no',
        #else
                                '$user_eq_no'
        #end
    #end                      
                   )
#end
         ) RSV
WHERE    1 = 1
AND      NVL2((MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC (TO_CHAR(SYSDATE, 'YYYYMM'),RSV.CURR_CD_MGI, RSV.CURR_CD, RSV.AUTO_AMT))
	         , DECODE((MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC (TO_CHAR(SYSDATE, 'YYYYMM'),RSV.CURR_CD_MGI, RSV.CURR_CD, RSV.AUTO_AMT)),0,-1,(MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(TO_CHAR(SYSDATE, 'YYYYMM'),RSV.CURR_CD_MGI, RSV.CURR_CD, RSV.AUTO_AMT)))
	         , -1
         ) >= RSV.TOTAL_AMT			]]></sql>
			<params>
				<param name="cur_ofc_cd" type="12" value="" out="N"/>
				<param name="apro_ofc_cd" type="12" value="" out="N"/>
				<param name="fm_rqst_dt" type="12" value="" out="N"/>
				<param name="to_rqst_dt" type="12" value="" out="N"/>
				<param name="eq_knd_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
