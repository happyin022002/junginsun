<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ReceivableRentalCostDBDAOReceivableRentalPreparationListCSQL">
			<desc><![CDATA[입력 월에 대한 Receivable Rental Preparation 작업을 일괄 수행한다.]]></desc>
			<sql><![CDATA[
INSERT INTO LSE_RCV_RNTL_CHG (
    COST_YRMON, RCV_RNTL_SEQ, QTY_YRMON, VNDR_SEQ, 
    VNDR_ABBR_NM, AGMT_CTY_CD, AGMT_SEQ, LSTM_CD, 
    CURR_CD, LSE_CNTR_CHG_STS_CD, EFF_DT, 
    EXP_DT, REF_NO, RGST_OFC_CD,
    CRE_USR_ID, CRE_DT, UPD_USR_ID, UPD_DT,
    RCV_AMT_BAL_CD, CXL_FLG, AUTO_INP_FLG, LOCL_TAX_FLG
) 
SELECT  /*+ ORDERED USE_NL(A B C D) */
		TO_CHAR(ADD_MONTHS(TO_DATE(@[qty_yrmon],'RRRRMM'), 1), 'RRRRMM'), 
		ROWNUM, @[qty_yrmon], B.VNDR_SEQ, D.VNDR_ABBR_NM, 
		A.AGMT_CTY_CD, A.AGMT_SEQ, A.LSTM_CD,  
		'USD', 'N', C.EFF_DT, B.LST_EXP_DT AS EXP_DT, B.REF_NO, @[ofc_cd],
		@[cre_usr_id], SYSDATE, @[cre_usr_id], SYSDATE,
		'N','N','Y','N'
FROM   (SELECT  /*+ USE_NL(A E) */ 
				A.AGMT_CTY_CD, A.AGMT_SEQ,
                DECODE(A.CNTR_STS_CD,'SBO','SO','SBI','SO','MO') AS LSTM_CD
        FROM    MST_CNTR_STS_HIS A,
                MST_CNTR_STS_HIS E
        WHERE   A.CNTR_NO = E.CNTR_NO(+)
        AND     A.CNTR_STS_SEQ = E.PRNR_STS_SEQ(+)   
        AND     A.CNTR_STS_EVNT_DT < TO_DATE(@[qty_yrmon],'RRRRMM')
        AND     A.CNTR_STS_CD IN ('SBO','MUO')
		AND     A.AGMT_SEQ <> 999990
		AND     NVL(E.CNTR_STS_EVNT_DT, SYSDATE) > TO_DATE(@[qty_yrmon],'RRRRMM')
        UNION
        SELECT  A.AGMT_CTY_CD, A.AGMT_SEQ,
                DECODE(A.CNTR_STS_CD,'SBO','SO','SBI','SO','MO') AS LSTM_CD
        FROM    MST_CNTR_STS_HIS A
        WHERE   A.AGMT_SEQ <> 999990
        AND     A.CNTR_STS_CD IN ('SBO','SBI','MUO','MUI')
		AND     A.CNTR_STS_EVNT_DT >= TO_DATE(@[qty_yrmon], 'YYYYMM')
        AND     A.CNTR_STS_EVNT_DT < ADD_MONTHS(TO_DATE(@[qty_yrmon], 'YYYYMM'),1)
        ) A,
		LSE_AGREEMENT B, 
        LSE_AGMT_VER C, 
        MDM_VENDOR D                   
WHERE   A.AGMT_CTY_CD = B.AGMT_CTY_CD
AND     A.AGMT_SEQ = B.AGMT_SEQ
AND     A.AGMT_CTY_CD = C.AGMT_CTY_CD
AND     A.AGMT_SEQ = C.AGMT_SEQ
AND     B.ITCHG_FEE_FLG <> 'Y' 
AND     C.AGMT_VER_SEQ = 1
AND     B.VNDR_SEQ = D.VNDR_SEQ			]]></sql>
			<params>
				<param name="qty_yrmon" type="12" value="" out="N"/>
				<param name="ofc_cd" type="12" value="" out="N"/>
				<param name="cre_usr_id" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
