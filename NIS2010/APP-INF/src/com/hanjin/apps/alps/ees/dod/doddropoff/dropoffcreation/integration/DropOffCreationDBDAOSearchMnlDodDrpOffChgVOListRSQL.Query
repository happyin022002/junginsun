<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="DropOffCreationDBDAOSearchMnlDodDrpOffChgVOListRSQL">
			<desc><![CDATA[BKG 정보중 RTN CY를 알 수없는 booking으로 직접데이터를 생성하기 위한 대상을 가져온다. Manual Invoice Creation화면에서 호출한다. ]]></desc>
			<sql><![CDATA[
SELECT A.TRO_IB_CFM_OFC_CD,
       A.TRO_IB_CFM_DT,
       A.CNTR_RTN_DT,
       A.BKG_NO BKG_NO,
	   A.BL_NO,
       A.CNTR_NO CNTR_NO,
       A.CNTR_TPSZ_CD CNTR_TPSZ_CD,
       A.DEL_CD DEL_CD,
        CASE
            WHEN A.CUST_SEQ IS NULL OR A.CUST_CNT_CD IS NULL
            THEN (SELECT U.CUST_CNT_CD
                    FROM BKG_CUSTOMER U
                   WHERE U.BKG_NO = A.BKG_NO
                     AND U.BKG_CUST_TP_CD = 'N' ) 
            ELSE
                 A.CUST_CNT_CD
        END CUST_CNT_CD,
        CASE
            WHEN A.CUST_SEQ IS NULL OR A.CUST_CNT_CD IS NULL
            THEN (SELECT U.CUST_SEQ
                    FROM BKG_CUSTOMER U
                   WHERE U.BKG_NO = A.BKG_NO
                     AND U.BKG_CUST_TP_CD = 'N' ) 
            ELSE
                 A.CUST_SEQ
        END CUST_SEQ,
        CASE
            WHEN A.CUST_SEQ IS NULL OR A.CUST_CNT_CD IS NULL
            THEN (SELECT SUBSTR(C.CUST_LGL_ENG_NM, 1, 50)
                    FROM MDM_CUSTOMER C, BKG_CUSTOMER U
                   WHERE C.CUST_CNT_CD = U.CUST_CNT_CD
                     AND C.CUST_SEQ = U.CUST_SEQ
                     AND U.BKG_NO = A.BKG_NO
                     AND U.BKG_CUST_TP_CD = 'N' )
            ELSE
                 A.CUST_LGL_ENG_NM
        END CUST_LGL_ENG_NM,
        CASE
            WHEN A.CUST_SEQ IS NULL OR A.CUST_CNT_CD IS NULL
            THEN (SELECT U.CUST_CNT_CD|| LPAD(U.CUST_SEQ, 6, 0)
                    FROM BKG_CUSTOMER U
                   WHERE U.BKG_NO = A.BKG_NO
                     AND U.BKG_CUST_TP_CD = 'N' )
            ELSE
                 A.CUST_CNT_CD|| LPAD(A.CUST_SEQ, 6, 0)
        END CUST_CD_SEQ,
        CASE
            WHEN A.CUST_SEQ IS NULL OR A.CUST_CNT_CD IS NULL
            THEN (SELECT U.CUST_CNT_CD
                    FROM BKG_CUSTOMER U
                   WHERE U.BKG_NO = A.BKG_NO
                     AND U.BKG_CUST_TP_CD = 'N' ) 
            ELSE
                 A.CUST_CNT_CD
        END TMP_CUST_CNT_CD,
        CASE
            WHEN A.CUST_SEQ IS NULL OR A.CUST_CNT_CD IS NULL
            THEN (SELECT U.CUST_SEQ
                    FROM BKG_CUSTOMER U
                   WHERE U.BKG_NO = A.BKG_NO
                     AND U.BKG_CUST_TP_CD = 'N' ) 
            ELSE
                 A.CUST_SEQ
        END TMP_CUST_SEQ,
        CASE
            WHEN A.CUST_SEQ IS NULL OR A.CUST_CNT_CD IS NULL
            THEN (SELECT SUBSTR(C.CUST_LGL_ENG_NM, 1, 50)
                    FROM MDM_CUSTOMER C, BKG_CUSTOMER U
                   WHERE C.CUST_CNT_CD = U.CUST_CNT_CD
                     AND C.CUST_SEQ = U.CUST_SEQ
                     AND U.BKG_NO = A.BKG_NO
                     AND U.BKG_CUST_TP_CD = 'N' )
            ELSE
                 A.CUST_LGL_ENG_NM
        END TMP_CUST_LGL_ENG_NM,
        CASE
            WHEN A.CUST_SEQ IS NULL OR A.CUST_CNT_CD IS NULL
            THEN (SELECT U.CUST_CNT_CD|| LPAD(U.CUST_SEQ, 6, 0)
                    FROM BKG_CUSTOMER U
                   WHERE U.BKG_NO = A.BKG_NO
                     AND U.BKG_CUST_TP_CD = 'N' )
            ELSE
                 A.CUST_CNT_CD|| LPAD(A.CUST_SEQ, 6, 0)
        END TMP_CUST_CD_SEQ,
       A.SPCL_CUST_CNT_CD,
       A.SPCL_CUST_SEQ,
       A.SPCL_CUST_CNT_CD|| LPAD(A.SPCL_CUST_SEQ, 6, 0) SPCL_CD_SEQ,
       A.SPCL_CUST_LGL_ENG_NM,
       A.RFA_NO,
       A.SC_NO
  FROM (SELECT @[ofc_cd] TRO_IB_CFM_OFC_CD,
               '' TRO_IB_CFM_DT,
               '' CNTR_RTN_DT,
               B.BKG_NO BKG_NO,
			   B.BL_NO,
               C.CNTR_NO CNTR_NO,
               C.CNTR_TPSZ_CD CNTR_TPSZ_CD,
               B.DEL_CD DEL_CD,
               (SELECT U.CUST_CNT_CD
                  FROM BKG_CUSTOMER U
                 WHERE U.BKG_NO = B.BKG_NO
                   AND U.BKG_CUST_TP_CD = 'C' ) CUST_CNT_CD,
               (SELECT U.CUST_SEQ
                  FROM BKG_CUSTOMER U
                 WHERE U.BKG_NO = B.BKG_NO
                   AND U.BKG_CUST_TP_CD = 'C' ) CUST_SEQ,
               (SELECT U.CUST_CNT_CD
                  FROM BKG_CUSTOMER U
                 WHERE U.BKG_NO = B.BKG_NO
                   AND U.BKG_CUST_TP_CD = 'C' )|| LPAD((SELECT U.CUST_SEQ
                          FROM BKG_CUSTOMER U
                         WHERE U.BKG_NO = B.BKG_NO
                           AND U.BKG_CUST_TP_CD = 'C' ), 6, 0) CUST_CD_SEQ,
               (SELECT SUBSTR(C.CUST_LGL_ENG_NM, 1, 50)
                  FROM MDM_CUSTOMER C,
                       BKG_CUSTOMER U
                 WHERE C.CUST_CNT_CD = U.CUST_CNT_CD
                   AND C.CUST_SEQ = U.CUST_SEQ
                   AND U.BKG_NO = B.BKG_NO
                   AND U.BKG_CUST_TP_CD = 'C' ) CUST_LGL_ENG_NM,
               B.AGMT_ACT_CNT_CD SPCL_CUST_CNT_CD,
               DECODE(B.AGMT_ACT_CUST_SEQ, 0, '', B.AGMT_ACT_CUST_SEQ) SPCL_CUST_SEQ,
               B.AGMT_ACT_CNT_CD|| LPAD(DECODE(B.AGMT_ACT_CUST_SEQ, 0, '', B.AGMT_ACT_CUST_SEQ), 6, 0) SPCL_CD_SEQ,
               (SELECT SUBSTR(C.CUST_LGL_ENG_NM, 1, 50)
                  FROM MDM_CUSTOMER C
                 WHERE C.CUST_CNT_CD = B.AGMT_ACT_CNT_CD
                   AND C.CUST_SEQ = B.AGMT_ACT_CUST_SEQ ) SPCL_CUST_LGL_ENG_NM,
               B.RFA_NO,
               B.SC_NO
          FROM BKG_BOOKING B,
               BKG_CONTAINER C,
               (SELECT RANK() OVER (PARTITION BY G.BKG_NO, G.CNTR_NO, G.DEL_CD
                         ORDER BY G.UPD_DT DESC) RNK,
                       G.*
                  FROM DOD_DRP_OFF_CHG G ) G
         WHERE 1 = 1
           AND B.BKG_NO = C.BKG_NO
           AND C.BKG_NO = G.BKG_NO(+)
           AND C.CNTR_NO = G.CNTR_NO(+)
           AND 'N' = G.TRO_IB_CXL_FLG(+)
           AND 1 = G.RNK(+)
           AND NOT EXISTS (SELECT 'OK'
                  FROM DOD_DRP_OFF_CHG G
                 WHERE C.BKG_NO = G.BKG_NO
                   AND C.CNTR_NO = G.CNTR_NO
                   AND B.DEL_CD = G.DEL_CD
                   AND 'N' = G.TRO_IB_CXL_FLG
                   AND 1 = G.RNK )
#if (${bkg_no} != '') 
                   AND B.BKG_NO IN (
                        #foreach ($user_bkg_no IN ${bkgNos})
                            #if($velocityCount < $bkgNos.size())
                                '$user_bkg_no',
                            #else
                                '$user_bkg_no'
                            #end
                        #end
                        )
#end
#if (${cntr_no} != '') 
                   AND C.CNTR_NO = @[cntr_no]
#end
 				   AND EXISTS (SELECT 'OK'
                        FROM BKG_EUR_TRO T
                       WHERE B.BKG_NO = T.BKG_NO
                         AND T.CFM_FLG = 'Y'
                         AND T.CXL_FLG = 'N'
                         AND T.IO_BND_CD = 'I'
                         AND ((T.HLG_TP_CD = 'M' AND SUBSTR(T.CNTR_RTN_YD_CD, 1, 5) = B.DEL_CD)
                             OR (T.HLG_TP_CD = 'C' AND 1 = 1))
                         AND C.CNTR_NO = T.CNTR_NO)


           ) A
 WHERE 1 = 1			]]></sql>
			<params>
				<param name="ofc_cd" type="12" value="" out="N"/>
				<param name="cntr_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
