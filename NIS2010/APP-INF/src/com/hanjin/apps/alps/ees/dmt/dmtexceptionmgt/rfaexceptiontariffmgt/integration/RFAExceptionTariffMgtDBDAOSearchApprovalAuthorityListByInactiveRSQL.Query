<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="RFAExceptionTariffMgtDBDAOSearchApprovalAuthorityListByInactiveRSQL">
			<desc><![CDATA[RFAExceptionTariffMgtDBDAOSearchApprovalAuthorityListByInactiveRSQL]]></desc>
			<sql><![CDATA[
select  APVL_PATH_CD
       ,APVL_PATH_LVL
	   ,OFC_CD
	   ,USR_ID
	   ,USR_NM

  from  (
			--// BBG(지점장) 조회
			select  'BBG' 					as APVL_PATH_CD
                   ,1                       as APVL_PATH_LVL
				   ,T4.OFC_CD
				   ,T4.USR_ID
				   ,T4.USR_NM
				   
			  from  DMT_CHG_DELT_PATH_STUP  T1
				   ,DMT_CHG_DELT_OFC_STUP   T2
				   ,DMT_OFC_LVL_V			T3
				   ,(
						select  USR_ID
							   ,USR_NM
							   ,OFC_CD
						  from  COM_USER
						 where  PSN_ENG_NM           = 'Country Manager'
						   and  substr(OFC_CD, 4, 2) = 'BB'
						   and  USE_FLG              = 'Y'
						   
						union all
						
						select  USR_ID
							   ,USR_NM
							   ,OFC_CD
						  from  COM_USER  SUB1
						 where  PSN_ENG_NM = 'Branch MGR'
						   and  (
									OFC_CD in ('SELSC', 'TYOSC')
								 or exists
									(
										select  1
										  from  MDM_ORGANIZATION    
										 where  REP_CUST_CNT_CD IN ('CN','US')     
										   and  OFC_TP_CD = 'BB'   
										   and  DELT_FLG  = 'N'
										   and  OFC_CD    = SUB1.OFC_CD
									)
								)
						   and  USE_FLG    = 'Y'
					)						T4

			 where  T1.EFF_DT <= sysdate and (T1.EXP_DT is null or T1.EXP_DT >= sysdate)
			   and  T1.CHG_DELT_PATH_STUP_SEQ = T2.CHG_DELT_PATH_STUP_SEQ
			   and  T1.DMDT_BRNC_FLG          = 'Y'
               #if (${ofc_cd_list} != '')
               and  T2.CHG_DELT_OFC_CD        in
                    (
						#foreach( $ofc_cd in ${ofc_cd_list} )
							#if($velocityCount < $ofc_cd_list.size()) '$ofc_cd', #else '$ofc_cd' #end
						#end
                    )
               #end
  			   and  T2.CHG_DELT_OFC_CD        = T3.OFC_N8TH_LVL_CD
			   and  T3.OFC_N4TH_LVL_CD		  = T4.OFC_CD(+)
               #if (${ofc_cd} != '') 
			   and  T4.OFC_CD                 = @[ofc_cd]
			   #end
			   #if (${usr_nm} != '') 
			   and  upper(T4.USR_NM) like '%'||UPPER(@[usr_nm])||'%'
			   #end
			   
			union all

			--// RHQ(지역본부장) 조회
			select  'RHQ' 					as APVL_PATH_CD
                   ,2                       as APVL_PATH_LVL
				   ,T4.OFC_CD
				   ,T4.USR_ID
				   ,T4.USR_NM

			  from  DMT_CHG_DELT_PATH_STUP  T1
				   ,DMT_CHG_DELT_OFC_STUP   T2
				   ,DMT_OFC_LVL_V			T3	
				   ,(
						select  USR_ID
							   ,USR_NM
							   ,OFC_CD
						  from  COM_USER                       
						 where  PSN_ENG_NM = 'Managing Director(RHQ)'                       
						   and  USE_FLG = 'Y'  
						   
						union all
						
						select  USR_ID
							   ,USR_NM
							   ,decode(OFC_CD, 'SELSC', 'SELIB', 'TYOSC', 'TYOIB', 'VVOBA', 'VVOIA', OFC_CD)
						 from  COM_USER                       
						where  PSN_ENG_NM in ('Branch MGR', 'Branch Manager')                       
						  and  USE_FLG = 'Y'                        
						  and  OFC_CD in ('SELSC', 'TYOSC', 'VVOBA')
					)						T4
			 where  T1.EFF_DT <= sysdate and (T1.EXP_DT is null or T1.EXP_DT >= sysdate)
			   and  T1.CHG_DELT_PATH_STUP_SEQ = T2.CHG_DELT_PATH_STUP_SEQ
			   and  (
						T1.DMDT_RHQ_FLG       = 'Y' 
					 or T1.DMDT_HO_FLG        = 'N'
					)
			   #if (${ofc_cd_list} != '')
               and  T2.CHG_DELT_OFC_CD        in
                    (
						#foreach( $ofc_cd in ${ofc_cd_list} )
							#if($velocityCount < $ofc_cd_list.size()) '$ofc_cd', #else '$ofc_cd' #end
						#end
                    )
               #end
               and  T2.CHG_DELT_OFC_CD        = T3.OFC_N8TH_LVL_CD
			   and  T3.OFC_N3RD_LVL_CD		  = T4.OFC_CD(+)
               #if (${ofc_cd} != '') 
			   and  T4.OFC_CD                 = @[ofc_cd]
			   #end
			   #if (${usr_nm} != '') 
			   and  upper(T4.USR_NM) like '%'||UPPER(@[usr_nm])||'%'
			   #end
			   
			union all

			--// DMT02 권한사용자 조회 (RHQ 권한 = RHQ(지역본부장) or DMT02 권한사용자)
			select  'RHQ'					as APVL_PATH_CD
                   ,2                       as APVL_PATH_LVL
			       ,SUB2.OFC_CD
			       ,SUB2.USR_ID
				   ,SUB2.USR_NM

			  from  DMT_USR_ROLE_MTCH  SUB1
				   ,COM_USER           SUB2
			 where  SUB1.USR_ROLE_CD = 'DMT02'
			   and  SUB1.USR_ID      = SUB2.USR_ID
			   and  SUB2.USE_FLG     = 'Y'   
               #if (${ofc_cd} != '') 
			   and  SUB2.OFC_CD                 = @[ofc_cd]
			   #end
			   #if (${usr_nm} != '') 
			   and  upper(SUB2.USR_NM) like '%' || upper(@[usr_nm]) || '%'
			   #end
			   and  exists
                    (
						select  1
						  from  DMT_CHG_DELT_PATH_STUP  T1
				               ,DMT_CHG_DELT_OFC_STUP   T2
						 where  T1.EFF_DT <= sysdate and (T1.EXP_DT is null or T1.EXP_DT >= sysdate)
						   and  T1.CHG_DELT_PATH_STUP_SEQ = T2.CHG_DELT_PATH_STUP_SEQ
						   and  (
									T1.DMDT_RHQ_FLG       = 'Y' 
								 or T1.DMDT_HO_FLG        = 'N'
								)
						   #if (${ofc_cd_list} != '')
						   and  T2.CHG_DELT_OFC_CD        in
								(
									#foreach( $ofc_cd in ${ofc_cd_list} )
										#if($velocityCount < $ofc_cd_list.size()) '$ofc_cd', #else '$ofc_cd' #end
									#end
								)
						   #end
					)

			union all

			--// DMT01 권한사용자 조회 (HO 권한 = DMT01 권한사용자)
			select  'HO'					as APVL_PATH_CD
                   ,3                       as APVL_PATH_LVL
			       ,SUB2.OFC_CD
			       ,SUB2.USR_ID
				   ,SUB2.USR_NM

			  from  DMT_USR_ROLE_MTCH  SUB1
				   ,COM_USER           SUB2
			 where  SUB1.USR_ROLE_CD = 'DMT01'
			   and  SUB1.USR_ID      = SUB2.USR_ID
			   and  SUB2.USE_FLG     = 'Y'
               #if (${ofc_cd} != '') 
			   and  SUB2.OFC_CD                 = @[ofc_cd]
			   #end
			   #if (${usr_nm} != '') 
			   and  upper(SUB2.USR_NM) like '%' || upper(@[usr_nm]) || '%'
			   #end
			   and  exists
                    (
						select  1
						  from  DMT_CHG_DELT_PATH_STUP  T1
				               ,DMT_CHG_DELT_OFC_STUP   T2
						 where  T1.EFF_DT <= sysdate and (T1.EXP_DT is null or T1.EXP_DT >= sysdate)
						   and  T1.CHG_DELT_PATH_STUP_SEQ = T2.CHG_DELT_PATH_STUP_SEQ
						   #if (${ofc_cd_list} != '')
						   and  T2.CHG_DELT_OFC_CD        in
								(
									#foreach( $ofc_cd in ${ofc_cd_list} )
										#if($velocityCount < $ofc_cd_list.size()) '$ofc_cd', #else '$ofc_cd' #end
									#end
								)
						   #end
					)			   
		)

group by APVL_PATH_CD
        ,APVL_PATH_LVL
	    ,OFC_CD
	    ,USR_ID
	    ,USR_NM
        
order by APVL_PATH_LVL			]]></sql>
			<params>
				<param name="ofc_cd" type="12" value="" out="N"/>
				<param name="usr_nm" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
