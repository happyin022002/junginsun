<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ChargeAmountDiscountMgtDBDAOSearchAfterBookingDetailFlgRSQL">
			<desc><![CDATA[ChargeAmountDiscountMgtDBDAOSearchAfterBookingDetailFlg]]></desc>
			<sql><![CDATA[
SELECT 
     NVL((
        SELECT 'Y'
        FROM DMT_AFT_BKG_ACT_COST_RQST
        WHERE AFT_EXPT_DAR_NO = T.AFT_EXPT_DAR_NO
        AND AFT_BKG_ACT_COST_ITM_LVL = '8'
        AND TRIM(AFT_BKG_ACT_COST_RMK) IS NOT NULL
     ),'N') AS RSN_DC_FLG
   , NVL((
        SELECT 'Y'
        FROM DMT_AFT_BKG_ACT_COST_RQST
        WHERE AFT_EXPT_DAR_NO = T.AFT_EXPT_DAR_NO
        AND AFT_BKG_ACT_COST_ITM_LVL = '9'
        AND TRIM(AFT_BKG_ACT_COST_RMK) IS NOT NULL
     ),'N') AS RSN_CLE_FLG
    , NVL((
        SELECT DISTINCT 'Y'
          FROM DMT_AFT_BKG_FILE_RQST A
         WHERE A.AFT_EXPT_DAR_NO = T.AFT_EXPT_DAR_NO
           AND AFT_BKG_FILE_DIV_CD = 'CSRL01'
    ),'N') AS CUST_RQST_FLG
   , NVL((
        SELECT DISTINCT 'Y'
        FROM DMT_AFT_BKG_ACT_COST_RQST A, DMT_HRD_CDG_CTNT B
        WHERE A.AFT_EXPT_DAR_NO = T.AFT_EXPT_DAR_NO
        AND B.HRD_CDG_ID LIKE 'AFT_BKG_ACTUAL_COST'
        AND B.ATTR_CTNT1 = A.AFT_BKG_ACT_COST_ITM_NM
		AND A.AFT_BKG_ACT_COST_AMT != 0
		AND TRIM(A.AFT_BKG_ACT_COST_RMK) IS NOT NULL
    ),'N') AS ACT_COST_FLG
    , NVL((
        SELECT DISTINCT 'Y'
          FROM DMT_AFT_BKG_FILE_RQST A
         WHERE A.AFT_EXPT_DAR_NO = T.AFT_EXPT_DAR_NO
           AND AFT_BKG_FILE_DIV_CD = 'OAIN01'
    ),'N') AS OTH_ATT_FLG
    , NVL((
        SELECT DISTINCT 'Y'
          FROM DMT_AFT_BKG_FILE_RQST A
         WHERE A.AFT_EXPT_DAR_NO = T.AFT_EXPT_DAR_NO
           AND AFT_BKG_FILE_DIV_CD = 'CIOD01'
    ),'N') AS CGO_INV_OLD_FLG
    , NVL((
        SELECT DISTINCT 'Y'
          FROM DMT_AFT_BKG_FILE_RQST A
         WHERE A.AFT_EXPT_DAR_NO = T.AFT_EXPT_DAR_NO
           AND AFT_BKG_FILE_DIV_CD = 'CINW01'
    ),'N') AS CGO_INV_NEW_FLG
    , NVL((
        SELECT MIN( CASE WHEN A.CGOR_DT IS NULL OR A.MCNTR_RTN_DT IS NULL THEN 'N' ELSE 'Y' END )
          FROM DMT_AFT_BKG_EXPT_CLR_RQST A
         WHERE A.AFT_EXPT_DAR_NO = T.AFT_EXPT_DAR_NO
    ),'N') AS EXP_CLE_FLG
    , NVL((
        SELECT DISTINCT 'Y'
          FROM DMT_AFT_BKG_MAS_RQST A
         WHERE A.AFT_EXPT_DAR_NO = T.AFT_EXPT_DAR_NO
    ),'N') AS CUST_SAL_PFMC_FLG
    , NVL((
        SELECT AFT_BKG_FILE_DIV_CD FROM DMT_AFT_BKG_RSN_RMK_RQST
         WHERE AFT_EXPT_DAR_NO = T.AFT_EXPT_DAR_NO
           AND AFT_BKG_RMK_LVL = '0'
    ),'') AS RSN_CD
    , NVL((
        SELECT B.ATTR_CTNT2||' ( '||ATTR_CTNT4||' )' 
        FROM DMT_AFT_BKG_RSN_RMK_RQST A,DMT_HRD_CDG_CTNT B
        WHERE B.HRD_CDG_ID = 'AFT_BKG_RSN_CD'
        AND A.AFT_BKG_FILE_DIV_CD = B.ATTR_CTNT3
        AND AFT_EXPT_DAR_NO = T.AFT_EXPT_DAR_NO
        AND ROWNUM = 1
    ),'') AS RSN_DESC
    , NVL((
        SELECT DISTINCT 'Y'
          FROM DMT_AFT_BKG_FILE_RQST A
         WHERE A.AFT_EXPT_DAR_NO = T.AFT_EXPT_DAR_NO
           AND AFT_BKG_FILE_DIV_CD IN( SELECT ATTR_CTNT3 FROM DMT_HRD_CDG_CTNT WHERE HRD_CDG_ID = 'AFT_BKG_RSN_CD' )
    ),'N') AS ATT_FILE_FLG
    , NVL((
        SELECT DISTINCT 'Y'
          FROM DMT_AFT_BKG_RSN_RMK_RQST A
         WHERE A.AFT_EXPT_DAR_NO = T.AFT_EXPT_DAR_NO
           AND AFT_BKG_FILE_DIV_CD IN( SELECT ATTR_CTNT3 FROM DMT_HRD_CDG_CTNT WHERE HRD_CDG_ID = 'AFT_BKG_RSN_CD' )
           AND AFT_BKG_RMK_LVL > '0'
    ),'N') AS RSN_DTL_RMK_FLG
    , NVL((
        SELECT DISTINCT 'Y'
          FROM DMT_AFT_BKG_PERF_RQST A
         WHERE A.AFT_EXPT_DAR_NO = T.AFT_EXPT_DAR_NO
    ),'N') AS DMT_PFMC_FLG
    , NVL((
        SELECT DISTINCT 'Y'
          FROM DMT_AFT_BKG_FULL_HIS_RQST A
         WHERE A.AFT_EXPT_DAR_NO = T.AFT_EXPT_DAR_NO
    ),'N') AS FULL_HIS_FLG
    , CASE WHEN NVL(T.UC_CGO_PSBL_FLG,' ') = ' ' THEN 'N' ELSE 'Y' END AS HIGH_LOW_FLG
    , NVL((
        
        SELECT 'Y'
          
				FROM    DMT_AFT_BKG_FILE_RQST FL
				    ,   COM_UPLD_FILE T2
				    ,   DMT_AFT_BKG_ADJ_RQST ADJ_RQST
					,   DMT_AFT_BKG_ADJ_RQST_DTL ADJ_RQST_DTL
					,   BKG_BOOKING BB
					,   PRI_RP_HDR RP_HDR
					,   PRI_RP_MN RP_MN
					,   PRI_SP_HDR SP_HDR
					,   PRI_SP_CTRT_PTY SP_PTY
					,   PRI_TAA_HDR TAA_HDR
					,   PRI_TAA_MN TAA_MN

				WHERE 1=1
					AND ADJ_RQST.DMDT_EXPT_RQST_STS_CD = 'A'
				    AND FL.AFT_BKG_FILE_DIV_CD = 'LETT01'
                    AND FL.FILE_SAV_ID          = T2.FILE_SAV_ID(+)
                    AND T2.DELT_FLG(+)             = 'N'
                    
				    AND FL.AFT_EXPT_DAR_NO = ADJ_RQST.AFT_EXPT_DAR_NO
					AND ADJ_RQST.AFT_EXPT_DAR_NO = ADJ_RQST_DTL.AFT_EXPT_DAR_NO
					AND ADJ_RQST_DTL.BKG_NO = BB.BKG_NO

					AND BB.RFA_NO = RP_HDR.RFA_NO(+)
					AND RP_HDR.PROP_NO = RP_MN.PROP_NO(+)
					AND	(
							RP_MN.AMDT_SEQ IS NULL
							OR
							(
								RP_MN.AMDT_SEQ =
								(
									SELECT 	/*+ INDEX_DESC(PRI_RP_MN XPKPRI_RP_MN) */AMDT_SEQ
									FROM	PRI_RP_MN
									WHERE	PROP_NO = RP_MN.PROP_NO
										AND	ROWNUM = 1
								)
							)
						)
					AND BB.SC_NO = SP_HDR.SC_NO(+)
					AND SP_HDR.PROP_NO = SP_PTY.PROP_NO(+)
					AND (
							(
								SP_PTY.PRC_CTRT_PTY_TP_CD IS NULL AND SP_PTY.AMDT_SEQ IS NULL
							)
							OR 
							(
								SP_PTY.PRC_CTRT_PTY_TP_CD = 'C' 
								AND 
								SP_PTY.AMDT_SEQ = 
								(
									SELECT	/*+ INDEX_DESC(PRI_SP_CTRT_PTY XPKPRI_SP_CTRT_PTY) */AMDT_SEQ 
									FROM	PRI_SP_CTRT_PTY 
									WHERE 	PROP_NO = SP_PTY.PROP_NO
										AND	PRC_CTRT_PTY_TP_CD = 'C'
										AND	ROWNUM = 1
								)				
							)  
						)

					AND TAA_HDR.TAA_NO(+) = BB.TAA_NO
					AND TAA_HDR.TAA_PROP_NO = TAA_MN.TAA_PROP_NO(+)
					AND	(
							TAA_MN.AMDT_SEQ IS NULL
							OR
							(
								TAA_MN.AMDT_SEQ =
								(
									SELECT 	/*+ INDEX_DESC(PRI_TAA_MN XFK1PRI_TAA_MN) */AMDT_SEQ
									FROM	PRI_TAA_MN
									WHERE	TAA_PROP_NO = TAA_MN.TAA_PROP_NO
										AND	ROWNUM = 1
								)
							)
						)

					AND ( RP_MN.CTRT_CUST_CNT_CD || LPAD(RP_MN.CTRT_CUST_SEQ, 6, '0') = @[cust_cd]
                       OR SP_PTY.CUST_CNT_CD || LPAD(SP_PTY.CUST_SEQ, 6, '0') = @[cust_cd]
                       OR TAA_MN.CTRT_CUST_CNT_CD || LPAD(TAA_MN.CTRT_CUST_SEQ, 6, '0') = @[cust_cd]
						)
				AND ROWNUM = 1
    ),'N') AS GNTE_LTR_FLG
FROM DMT_AFT_BKG_ADJ_RQST T
WHERE 
#if(${dar_no} != '')
		T.AFT_EXPT_DAR_NO = @[dar_no]
#elseif(${apvl_no} != '')
		T.AFT_BKG_APRO_NO = @[apvl_no]
#end			]]></sql>
			<params>
				<param name="cust_cd" type="12" value="" out="N"/>
				<param name="dar_no" type="12" value="" out="N"/>
				<param name="apvl_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
