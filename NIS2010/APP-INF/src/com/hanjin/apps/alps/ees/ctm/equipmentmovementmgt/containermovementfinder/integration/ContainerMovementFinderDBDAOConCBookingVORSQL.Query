<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ContainerMovementFinderDBDAOConCBookingVORSQL">
			<desc><![CDATA[Ticket No : CHM-201108835-01
개발자 : 나상보
Title : bkg/mvmt vl/vd unmatch inquiry 화면 logic 추가
Description :    1.Cancel된 mt bkg 조회되지 않도록 수정

2012.11.07 문동선 [CHM-201221016] [CTM] BKG/MVMT VL unmatched 에서 Local/TS 확인기능 보완
2013.08.23 최덕우 [CHM-201325812] [CTM] Bkg/MVMT VL/VD Unmatch Inquiry기능 보완 (Restuffing, TTL, RHQ)
2014.03.10 박다은 [CHM-201428741] [CTM] Stowage Plan POD (BKG/MVMT VL/VD unmatch Inquiry)]]></desc>
			<sql><![CDATA[
#if (${flgrslt} == 'RL')
	#if (${viewtype} == '1')
    SELECT CNTR_NO, CNTR_TPSZ_CD, MAX(ORG_YD_CD) ORG_YD_CD, FULL_FG, MAX(MVMT_STS_CD) MVMT_STS_CD, MAX(BKG_NO) BKG_NO
      FROM (
            SELECT C.CNTR_NO, C.CNTR_TPSZ_CD, C.ORG_YD_CD, DECODE (B.BKG_CGO_TP_CD, 'P', 'M', 'F' ) FULL_FG, C.CNMV_STS_CD MVMT_STS_CD, C.BKG_NO
              FROM BKG_CONTAINER C, BKG_BOOKING B
             WHERE C.BKG_NO IN (
                                SELECT BV.BKG_NO
                                  FROM BKG_VVD BV2, BKG_VVD BV
                                 WHERE BV.VSL_CD = SUBSTR(@[vls_cd], 0,4)
                                   AND BV.SKD_VOY_NO = SUBSTR(@[vls_cd], 5,4)
                                   AND BV.SKD_DIR_CD = SUBSTR(@[vls_cd], 9,1)
                                   AND BV.POL_YD_CD LIKE @[p_yard] || '%'
                                   AND BV2.BKG_NO(+) = BV.BKG_NO
                                   AND ASCII (BV2.VSL_PRE_PST_CD(+)) * 10 + TO_NUMBER (BV2.VSL_SEQ(+)) <
                                       ASCII (BV.VSL_PRE_PST_CD) * 10 + TO_NUMBER (BV.VSL_SEQ)
		#if (${locl_type} != '')
                                   AND DECODE (BV2.VSL_PRE_PST_CD, NULL, 'N', 'Y') IN (@[locl_type])
		#end
                                )
               AND C.BKG_NO = B.BKG_NO
               AND B.BKG_STS_CD NOT IN ('X', 'S')
		#if (${cgo_type} != '')
               AND DECODE(B.BKG_CGO_TP_CD , 'P', 'P', 'F') = @[cgo_type]
		#end

		#if (${restuff} == 'Y')
				AND (C.BKG_NO, C.CNTR_NO) NOT IN (SELECT  CM.BKG_NO, CM.CNTR_NO
													FROM    CTM_MVMT_XCH    CX,
															CTM_MOVEMENT    CM
													WHERE   XCH_CNTR_NO = C.CNTR_NO
															AND     XCH_CNTR_YR = C.CNMV_YR
															AND     CM.CNTR_NO  = XCH_CNTR_NO
                                                            AND     CM.CNMV_YR  = XCH_CNTR_YR
                                                            AND     CM.CNMV_ID_NO = XCH_CNMV_ID_NO
                                                            AND     ROWNUM = 1
												)															
		#end
		#if (${ttl} == 'Y')
     			 AND ('TLL', SUBSTR(@[p_yard], 1, 5)) <> (SELECT CNTR_STS_CD, LOC_CD FROM MST_CONTAINER
								WHERE CNTR_NO = C.CNTR_NO)
		#end
            )
    GROUP BY CNTR_NO, CNTR_TPSZ_CD, FULL_FG
    ORDER BY CNTR_NO
	#else
		#if (${mv_type} == '')
    SELECT DISTINCT A.CNTR_NO, A.CNTR_TPSZ_CD, A.FULL_FG, A.ORG_YD_CD, A.MVMT_STS_CD, A.MVMT_INP_TP_CD, A.BKG_NO
      FROM (SELECT DISTINCT CNTR_NO, CNTR_TPSZ_CD, CTM.ORG_YD_CD, DECODE(BKG_CGO_TP_CD, 'P', 'M', 'F') FULL_FG, MVMT_STS_CD, MVMT_INP_TP_CD, BKG_NO
              FROM CTM_MOVEMENT CTM
             WHERE CRNT_VSL_CD = SUBSTR(@[vls_cd], 0,4)
               AND CRNT_SKD_VOY_NO = SUBSTR(@[vls_cd], 5,4)
               AND CRNT_SKD_DIR_CD = SUBSTR(@[vls_cd], 9,1)
               AND ORG_YD_CD       LIKE @[p_yard] || '%'
			#if (${cgo_type} != '')
               AND DECODE(BKG_CGO_TP_CD , 'P', 'P', 'F') = @[cgo_type]
			#end
               AND MVMT_STS_CD = 'VL'
			#if (${restuff} == 'Y')
				AND (CTM.BKG_NO, CTM.CNTR_NO) NOT IN (SELECT  CM.BKG_NO, CM.CNTR_NO
														FROM    CTM_MVMT_XCH    CX,
																CTM_MOVEMENT    CM
														WHERE   XCH_CNTR_NO = CTM.CNTR_NO
															AND     XCH_CNTR_YR = CTM.CNMV_YR
															AND     CM.CNTR_NO  = XCH_CNTR_NO
															AND     CM.CNMV_YR  = XCH_CNTR_YR
															AND     CM.CNMV_ID_NO = XCH_CNMV_ID_NO
															AND     ROWNUM = 1
													  )
    		#end
           ) A,
           (SELECT BV.BKG_NO
              FROM BKG_VVD BV2, BKG_VVD BV
             WHERE BV.VSL_CD = SUBSTR(@[vls_cd], 0,4)
               AND BV.SKD_VOY_NO = SUBSTR(@[vls_cd], 5,4)
               AND BV.SKD_DIR_CD = SUBSTR(@[vls_cd], 9,1)
               AND BV.POL_YD_CD LIKE @[p_yard] || '%'
               AND BV2.BKG_NO(+) = BV.BKG_NO
               AND ASCII (BV2.VSL_PRE_PST_CD(+)) * 10 + TO_NUMBER (BV2.VSL_SEQ(+)) <
                   ASCII (BV.VSL_PRE_PST_CD) * 10 + TO_NUMBER (BV.VSL_SEQ)
			#if (${locl_type} != '')
               AND DECODE (BV2.VSL_PRE_PST_CD, NULL, 'N', 'Y') IN (@[locl_type])
			#end
           ) B
     WHERE A.BKG_NO = B.BKG_NO
     ORDER BY CNTR_NO
		#else
			SELECT DISTINCT CNTR_REF_NO CNTR_NO, CNTR_TPSZ_CD CNTR_TPSZ_CD, '' ORG_YD_CD, DECODE(FULL_MTY_CD, 'E', 'M', 'F') FULL_FG, 'VL' MVMT_STS_CD, '' BKG_NO
			  FROM OPF_BAY_PLN_LDIS
			 WHERE VSL_CD = SUBSTR(@[vls_cd], 0,4)
			   AND SKD_VOY_NO = SUBSTR(@[vls_cd], 5,4)
			   AND SKD_DIR_CD = SUBSTR(@[vls_cd], 9,1)
			   AND POL_CD LIKE @[p_yard] || '%'
			   AND LODG_DCHG_IND_CD = 'L'
               AND CRR_CD = 'SML'
			#if (${cgo_type} != '')
               AND DECODE(FULL_MTY_CD, 'E', 'P', 'M', 'P', 'F') = @[cgo_type]
            #end
          ORDER BY CNTR_NO
		#end
	#end
#elseif (${flgrslt} == 'PD')
	#if (${viewtype} == '1')
    SELECT CNTR_NO, CNTR_TPSZ_CD, FULL_FG, MAX(ORG_YD_CD) ORG_YD_CD, MAX(MVMT_STS_CD) MVMT_STS_CD, MAX(BKG_NO) BKG_NO, substr(CNTR_NO||MAX(ORG_YD_CD),1,16) MAT_POD
    FROM (
		SELECT C.CNTR_NO, C.CNTR_TPSZ_CD, C.ORG_YD_CD, DECODE(B.BKG_CGO_TP_CD, 'P', 'M', 'F') FULL_FG, C.CNMV_STS_CD MVMT_STS_CD, C.BKG_NO
		FROM BKG_CONTAINER C, BKG_BOOKING B
		WHERE C.BKG_NO IN (
			SELECT BV.BKG_NO
			    FROM BKG_VVD BV2, BKG_VVD BV
			    WHERE  BV.VSL_CD = SUBSTR(@[vls_cd], 0,4)
			    AND BV.SKD_VOY_NO = SUBSTR(@[vls_cd], 5,4)
			    AND BV.SKD_DIR_CD = SUBSTR(@[vls_cd], 9,1)
			    AND BV.POD_YD_CD LIKE @[p_yard] || '%'
			    AND BV2.BKG_NO(+) = BV.BKG_NO
			    AND	ASCII(BV2.VSL_PRE_PST_CD(+)) * 10 + TO_NUMBER(BV2.VSL_SEQ(+)) >
					ASCII(BV.VSL_PRE_PST_CD) * 10 + TO_NUMBER(BV.VSL_SEQ)
				#if (${locl_type} != '')
			     AND DECODE (BV2.VSL_PRE_PST_CD, NULL, 'N', 'Y') IN (@[locl_type])
				#end
		    )
		AND C.BKG_NO = B.BKG_NO
		#if (${cgo_type} != '')
 	    AND DECODE(B.BKG_CGO_TP_CD , 'P', 'P', 'F') = @[cgo_type]
		#end
		AND B.BKG_STS_CD NOT IN ('X', 'S')
		AND B.POD_CD <> 'XXXXX'

		#if (${restuff} == 'Y')
				AND (C.BKG_NO, C.CNTR_NO) NOT IN (SELECT  CM.BKG_NO, CM.CNTR_NO
													FROM    CTM_MVMT_XCH    CX,
															CTM_MOVEMENT    CM
													WHERE   XCH_CNTR_NO = C.CNTR_NO
															AND     XCH_CNTR_YR = C.CNMV_YR
															AND     CM.CNTR_NO  = XCH_CNTR_NO
                                                            AND     CM.CNMV_YR  = XCH_CNTR_YR
                                                            AND     CM.CNMV_ID_NO = XCH_CNMV_ID_NO
                                                            AND     ROWNUM = 1
												)															
		#end
		#if (${ttl} == 'Y')
				AND	(
						(
							('TLL', SUBSTR(@[p_yard], 1, 5)) IN (SELECT CNTR_STS_CD, LOC_CD FROM MST_CONTAINER MC	
																	WHERE MC.CNTR_NO = C.CNTR_NO )	
							AND EXISTS(SELECT CM.CNTR_NO
										FROM BKG_VVD BV, CTM_MOVEMENT    CM
										WHERE  BV.VSL_CD = SUBSTR(@[vls_cd], 0,4)
											AND BV.SKD_VOY_NO = SUBSTR(@[vls_cd], 5,4)
											AND BV.SKD_DIR_CD = SUBSTR(@[vls_cd], 9,1)
											AND BV.POD_YD_CD LIKE @[p_yard] || '%'
											AND BV.VSL_CD = CM.CRNT_VSL_CD
											AND BV.SKD_VOY_NO = CM.CRNT_SKD_VOY_NO
											AND BV.SKD_DIR_CD = CM.CRNT_SKD_DIR_CD
											AND BV.POD_CD = SUBSTR(CM.ORG_YD_CD, 1, 5)
											AND CM.MVMT_STS_CD = 'VD'
											AND CM.cntr_no = C.CNTR_NO
											AND C.BKG_NO = BV.BKG_NO
										)
						)
						OR
						( C.CNTR_NO IN (SELECT MC.CNTR_NO FROM MST_CONTAINER MC
											WHERE MC.CNTR_NO = C.CNTR_NO
												AND CNTR_STS_CD <> 'TLL'
										)
						)
					)
		#end
    )
    GROUP BY CNTR_NO, CNTR_TPSZ_CD, FULL_FG
    ORDER BY CNTR_NO
	#else
		#if (${mv_type} == '')
		SELECT DISTINCT A.CNTR_NO, A.CNTR_TPSZ_CD, A.FULL_FG, A.ORG_YD_CD, A.MVMT_STS_CD, A.MVMT_INP_TP_CD BKG_NO
		  FROM (SELECT CNTR_NO, CNTR_TPSZ_CD, ORG_YD_CD,
			           DECODE (BKG_CGO_TP_CD, 'P', 'M', 'F') FULL_FG, MVMT_STS_CD,
			           MVMT_INP_TP_CD, BKG_NO
 			      FROM CTM_MOVEMENT CTM
			     WHERE CRNT_VSL_CD = SUBSTR(@[vls_cd], 0,4)
			       AND CRNT_SKD_VOY_NO = SUBSTR(@[vls_cd], 5,4)
			       AND CRNT_SKD_DIR_CD = SUBSTR(@[vls_cd], 9,1)
			#if (${cgo_type} != '')
 		   	       AND DECODE(BKG_CGO_TP_CD , 'P', 'P', 'F') = @[cgo_type]
			#end
			       AND MVMT_STS_CD NOT IN ('VD', 'IC', 'TS', 'MT')			
			#if (${restuff} == 'Y')
				AND (CTM.BKG_NO, CTM.CNTR_NO) NOT IN (SELECT  CM.BKG_NO, CM.CNTR_NO
														FROM    CTM_MVMT_XCH    CX,
																CTM_MOVEMENT    CM
														WHERE   XCH_CNTR_NO = CTM.CNTR_NO
															AND     XCH_CNTR_YR = CTM.CNMV_YR
															AND     CM.CNTR_NO  = XCH_CNTR_NO
															AND     CM.CNMV_YR  = XCH_CNTR_YR
															AND     CM.CNMV_ID_NO = XCH_CNMV_ID_NO
															AND     ROWNUM = 1
													  )
    		#end
				) A,
		       (SELECT BV.BKG_NO
			      FROM BKG_VVD BV2, BKG_VVD BV
			     WHERE BV.VSL_CD = SUBSTR(@[vls_cd], 0,4)
			       AND BV.SKD_VOY_NO = SUBSTR(@[vls_cd], 5,4)
			       AND BV.SKD_DIR_CD = SUBSTR(@[vls_cd], 9,1)
			       AND BV.POD_YD_CD LIKE @[p_yard] || '%'
			       AND BV2.BKG_NO(+) = BV.BKG_NO
			       AND ASCII (BV2.VSL_PRE_PST_CD(+)) * 10 + TO_NUMBER (BV2.VSL_SEQ(+)) >
					   ASCII (BV.VSL_PRE_PST_CD) * 10
					   + TO_NUMBER (BV.VSL_SEQ)
				#if (${locl_type} != '')
			       AND DECODE (BV2.VSL_PRE_PST_CD, NULL, 'N', 'Y') IN (@[locl_type])
				#end
				) B
		 WHERE A.BKG_NO = B.BKG_NO
         ORDER BY CNTR_NO
		#else
SELECT DISTINCT SKD_VOY_NO,CNTR_REF_NO CNTR_NO, CNTR_TPSZ_CD CNTR_TPSZ_CD, '' ORG_YD_CD, POD_CD, DECODE(FULL_MTY_CD, 'E', 'M', 'F') FULL_FG, 'VD' MVMT_STS_CD, '' BKG_NO, CNTR_REF_NO||POD_CD MAT_POD
       FROM OPF_BAY_PLN_LDIS
    WHERE VSL_CD = SUBSTR(@[vls_cd], 0,4)
      AND SKD_VOY_NO = SUBSTR(@[vls_cd], 5,4)
      AND SKD_DIR_CD = SUBSTR(@[vls_cd], 9,1)
      AND POD_CD LIKE @[p_yard] || '%'
      AND LODG_DCHG_IND_CD = 'L'
         AND CRR_CD = 'SML'
UNION
SELECT DISTINCT SKD_VOY_NO,CNTR_REF_NO CNTR_NO, CNTR_TPSZ_CD CNTR_TPSZ_CD, '' ORG_YD_CD, POD_CD, DECODE(FULL_MTY_CD, 'E', 'M', 'F') FULL_FG, 'VD' MVMT_STS_CD, '' BKG_NO, CNTR_REF_NO||POD_CD MAT_POD
       FROM OPF_BAY_PLN_LDIS    OPFB,
       (
SELECT A.CNTR_NO
FROM   (
SELECT CNTR_NO, CNTR_TPSZ_CD, FULL_FG, MAX(ORG_YD_CD) ORG_YD_CD, MAX(MVMT_STS_CD) MVMT_STS_CD, MAX(BKG_NO) BKG_NO
    FROM (
  SELECT C.CNTR_NO, C.CNTR_TPSZ_CD, C.ORG_YD_CD, DECODE(B.BKG_CGO_TP_CD, 'P', 'M', 'F') FULL_FG, C.CNMV_STS_CD MVMT_STS_CD, C.BKG_NO
  FROM BKG_CONTAINER C, BKG_BOOKING B
  WHERE C.BKG_NO IN (
   SELECT BV.BKG_NO
       FROM BKG_VVD BV2, BKG_VVD BV
       WHERE  BV.VSL_CD = SUBSTR(@[vls_cd], 0,4)
       AND BV.SKD_VOY_NO = SUBSTR(@[vls_cd], 5,4)
       AND BV.SKD_DIR_CD = SUBSTR(@[vls_cd], 9,1)
#if(${spln_pod} == 'All')
#else
      AND BV.POD_YD_CD LIKE @[p_yard] || '%'
#end
       AND BV2.BKG_NO(+) = BV.BKG_NO
       AND ASCII(BV2.VSL_PRE_PST_CD(+)) * 10 + TO_NUMBER(BV2.VSL_SEQ(+)) >
     ASCII(BV.VSL_PRE_PST_CD) * 10 + TO_NUMBER(BV.VSL_SEQ)
          )
  AND C.BKG_NO = B.BKG_NO
    AND B.BKG_STS_CD NOT IN ('X', 'S')
  AND B.POD_CD <> 'XXXXX'
      AND (C.BKG_NO, C.CNTR_NO) NOT IN (SELECT  CM.BKG_NO, CM.CNTR_NO
             FROM    CTM_MVMT_XCH    CX,
               CTM_MOVEMENT    CM
             WHERE   XCH_CNTR_NO = C.CNTR_NO
               AND     XCH_CNTR_YR = C.CNMV_YR
               AND     CM.CNTR_NO  = XCH_CNTR_NO
                                                            AND     CM.CNMV_YR  = XCH_CNTR_YR
                                                            AND     CM.CNMV_ID_NO = XCH_CNMV_ID_NO
                                                            AND     ROWNUM = 1
            )               
        AND (
      (
       ('TLL', SUBSTR(@[p_yard], 1, 5)) IN (SELECT CNTR_STS_CD, LOC_CD FROM MST_CONTAINER MC 
                 WHERE MC.CNTR_NO = C.CNTR_NO ) 
       AND EXISTS(SELECT CM.CNTR_NO
          FROM BKG_VVD BV, CTM_MOVEMENT    CM
          WHERE  BV.VSL_CD = SUBSTR(@[vls_cd], 0,4)
           AND BV.SKD_VOY_NO = SUBSTR(@[vls_cd], 5,4)
           AND BV.SKD_DIR_CD = SUBSTR(@[vls_cd], 9,1)
           AND BV.POD_YD_CD LIKE @[p_yard] || '%'
           AND BV.VSL_CD = CM.CRNT_VSL_CD
           AND BV.SKD_VOY_NO = CM.CRNT_SKD_VOY_NO
           AND BV.SKD_DIR_CD = CM.CRNT_SKD_DIR_CD
           AND BV.POD_CD = SUBSTR(CM.ORG_YD_CD, 1, 5)
           AND CM.MVMT_STS_CD = 'VD'
           AND CM.cntr_no = C.CNTR_NO
           AND C.BKG_NO = BV.BKG_NO
          )
      )
      OR
      ( C.CNTR_NO IN (SELECT MC.CNTR_NO FROM MST_CONTAINER MC
           WHERE MC.CNTR_NO = C.CNTR_NO
            AND CNTR_STS_CD <> 'TLL'
          )
      )
     )
      )
    GROUP BY CNTR_NO, CNTR_TPSZ_CD, FULL_FG
    ORDER BY CNTR_NO
 ) A
 MINUS
 SELECT B.CNTR_NO
 FROM   (SELECT DISTINCT SKD_VOY_NO,CNTR_REF_NO CNTR_NO, CNTR_TPSZ_CD CNTR_TPSZ_CD, '' ORG_YD_CD, POD_CD, DECODE(FULL_MTY_CD, 'E', 'M', 'F') FULL_FG, 'VD' MVMT_STS_CD, '' BKG_NO
       FROM OPF_BAY_PLN_LDIS
    WHERE VSL_CD = SUBSTR(@[vls_cd], 0,4)
      AND SKD_VOY_NO = SUBSTR(@[vls_cd], 5,4)
      AND SKD_DIR_CD = SUBSTR(@[vls_cd], 9,1)
      AND POD_CD LIKE @[p_yard] || '%'
      AND LODG_DCHG_IND_CD = 'L'
               AND CRR_CD = 'SML') B
) C
    WHERE VSL_CD = SUBSTR(@[vls_cd], 0,4)
      AND SKD_VOY_NO = SUBSTR(@[vls_cd], 5,4)
      AND SKD_DIR_CD = SUBSTR(@[vls_cd], 9,1)
      AND LODG_DCHG_IND_CD = 'L'
         AND CRR_CD = 'SML'
         AND OPFB.CNTR_REF_NO = C.CNTR_NO
   			#if (${cgo_type} != '')
               AND DECODE(FULL_MTY_CD,'E', 'P', 'M', 'P', 'F') = @[cgo_type]
             ORDER BY CNTR_NO
            #end
		#end
	#end


#elseif (${flgrslt} == 'RD')
	#if (${viewtype} == '1')
    SELECT CNTR_NO, CNTR_TPSZ_CD, FULL_FG, MAX(ORG_YD_CD) ORG_YD_CD, MAX(MVMT_STS_CD) MVMT_STS_CD, MAX(BKG_NO) BKG_NO
    FROM (
		SELECT C.CNTR_NO, C.CNTR_TPSZ_CD, C.ORG_YD_CD, DECODE(B.BKG_CGO_TP_CD, 'P', 'M', 'F') FULL_FG, C.CNMV_STS_CD MVMT_STS_CD, C.BKG_NO
		FROM BKG_CONTAINER C, BKG_BOOKING B
		WHERE C.BKG_NO IN (
		SELECT BV.BKG_NO
			    FROM BKG_VVD BV2, BKG_VVD BV
			    WHERE  BV.VSL_CD = SUBSTR(@[vls_cd], 0,4)
			    AND BV.SKD_VOY_NO = SUBSTR(@[vls_cd], 5,4)
			    AND BV.SKD_DIR_CD = SUBSTR(@[vls_cd], 9,1)
			    AND BV.POD_YD_CD LIKE @[p_yard] || '%'
			    AND BV2.BKG_NO(+) = BV.BKG_NO
			    AND	ASCII(BV2.VSL_PRE_PST_CD(+)) * 10 + TO_NUMBER(BV2.VSL_SEQ(+)) >
					ASCII(BV.VSL_PRE_PST_CD) * 10 + TO_NUMBER(BV.VSL_SEQ)
				#if (${locl_type} != '')
			     AND DECODE (BV2.VSL_PRE_PST_CD, NULL, 'N', 'Y') IN (@[locl_type])
				#end
		)
		AND C.BKG_NO = B.BKG_NO
		#if (${cgo_type} != '')
   	    AND DECODE(B.BKG_CGO_TP_CD , 'P', 'P', 'F') = @[cgo_type]
		#end
		AND B.BKG_STS_CD NOT IN ('X', 'S')
		AND B.POD_CD <> 'XXXXX'

		#if (${restuff} == 'Y')
				AND (C.BKG_NO, C.CNTR_NO) NOT IN (SELECT  CM.BKG_NO, CM.CNTR_NO
													FROM    CTM_MVMT_XCH    CX,
															CTM_MOVEMENT    CM
													WHERE   XCH_CNTR_NO = C.CNTR_NO
															AND     XCH_CNTR_YR = C.CNMV_YR
															AND     CM.CNTR_NO  = XCH_CNTR_NO
                                                            AND     CM.CNMV_YR  = XCH_CNTR_YR
                                                            AND     CM.CNMV_ID_NO = XCH_CNMV_ID_NO
                                                            AND     ROWNUM = 1
												)															
		#end
		#if (${ttl} == 'Y')
				AND	(
						(
							('TLL', SUBSTR(@[p_yard], 1, 5)) IN (SELECT CNTR_STS_CD, LOC_CD FROM MST_CONTAINER MC	
																	WHERE MC.CNTR_NO = C.CNTR_NO )	
							AND EXISTS(SELECT CM.CNTR_NO
										FROM BKG_VVD BV, CTM_MOVEMENT    CM
										WHERE  BV.VSL_CD = SUBSTR(@[vls_cd], 0,4)
											AND BV.SKD_VOY_NO = SUBSTR(@[vls_cd], 5,4)
											AND BV.SKD_DIR_CD = SUBSTR(@[vls_cd], 9,1)
											AND BV.POD_YD_CD LIKE @[p_yard] || '%'
											AND BV.VSL_CD = CM.CRNT_VSL_CD
											AND BV.SKD_VOY_NO = CM.CRNT_SKD_VOY_NO
											AND BV.SKD_DIR_CD = CM.CRNT_SKD_DIR_CD
											AND BV.POD_CD = SUBSTR(CM.ORG_YD_CD, 1, 5)
											AND CM.MVMT_STS_CD = 'VD'
											AND CM.cntr_no = C.CNTR_NO
											AND C.BKG_NO = BV.BKG_NO
										)
						)
						OR
						( C.CNTR_NO IN (SELECT MC.CNTR_NO FROM MST_CONTAINER MC
											WHERE MC.CNTR_NO = C.CNTR_NO
												AND CNTR_STS_CD <> 'TLL'
										)
						)
					)
		#end
    )
    GROUP BY CNTR_NO, CNTR_TPSZ_CD, FULL_FG
    ORDER BY CNTR_NO
	#else
		SELECT DISTINCT A.CNTR_NO, A.CNTR_TPSZ_CD, A.ORG_YD_CD, A.FULL_FG, A.MVMT_STS_CD, A.MVMT_INP_TP_CD BKG_NO
		  FROM (SELECT CNTR_NO, CNTR_TPSZ_CD, ORG_YD_CD,
			       DECODE (BKG_CGO_TP_CD, 'P', 'M', 'F') FULL_FG, MVMT_STS_CD,
			       MVMT_INP_TP_CD, BKG_NO
			  FROM CTM_MOVEMENT CTM
			 WHERE CRNT_VSL_CD = SUBSTR(@[vls_cd], 0,4)
			   AND CRNT_SKD_VOY_NO = SUBSTR(@[vls_cd], 5,4)
			   AND CRNT_SKD_DIR_CD = SUBSTR(@[vls_cd], 9,1)
			   AND ORG_YD_CD       LIKE @[p_yard] || '%'
		#if (${cgo_type} != '')
 		   	   AND DECODE(BKG_CGO_TP_CD , 'P', 'P', 'F') = @[cgo_type]
		#end
			   AND MVMT_STS_CD = 'VD'
		#if (${restuff} == 'Y')
				AND (CTM.BKG_NO, CTM.CNTR_NO) NOT IN (SELECT  CM.BKG_NO, CM.CNTR_NO
														FROM    CTM_MVMT_XCH    CX,
																CTM_MOVEMENT    CM
														WHERE   XCH_CNTR_NO = CTM.CNTR_NO
															AND     XCH_CNTR_YR = CTM.CNMV_YR
															AND     CM.CNTR_NO  = XCH_CNTR_NO
															AND     CM.CNMV_YR  = XCH_CNTR_YR
															AND     CM.CNMV_ID_NO = XCH_CNMV_ID_NO
															AND     ROWNUM = 1
													  )
    	#end
			) A,
		       (SELECT BV.BKG_NO
			  FROM BKG_VVD BV2, BKG_VVD BV
			 WHERE BV.VSL_CD = SUBSTR(@[vls_cd], 0,4)
			   AND BV.SKD_VOY_NO = SUBSTR(@[vls_cd], 5,4)
			   AND BV.SKD_DIR_CD = SUBSTR(@[vls_cd], 9,1)
			   AND BV.POD_CD = SUBSTR(@[p_yard], 0,5)
			   AND BV2.BKG_NO(+) = BV.BKG_NO
			   AND ASCII (BV2.VSL_PRE_PST_CD(+)) * 10 + TO_NUMBER (BV2.VSL_SEQ(+)) >
				   ASCII (BV.VSL_PRE_PST_CD) * 10
					+ TO_NUMBER (BV.VSL_SEQ)
				#if (${locl_type} != '')
			     AND DECODE (BV2.VSL_PRE_PST_CD, NULL, 'N', 'Y') IN (@[locl_type])
				#end
				) B
		 WHERE A.BKG_NO = B.BKG_NO
         ORDER BY CNTR_NO
	#end
#end			]]></sql>
			<params>
				<param name="vls_cd" type="12" value="" out="N"/>
				<param name="p_yard" type="12" value="" out="N"/>
				<param name="locl_type" type="12" value="" out="N"/>
				<param name="cgo_type" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
