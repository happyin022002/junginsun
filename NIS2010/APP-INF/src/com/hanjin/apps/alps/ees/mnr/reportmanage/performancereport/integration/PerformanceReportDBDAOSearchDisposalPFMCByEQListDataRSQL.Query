<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="PerformanceReportDBDAOSearchDisposalPFMCByEQListDataRSQL">
			<desc><![CDATA[SearchDisposalPFMCByEQListData]]></desc>
			<sql><![CDATA[
SELECT 
RSV.SOLD_DT,
RSV.DISP_NO,
RSV.DISP_STS,
RSV.EQ_TY,
RSV.EQ_NO,
RSV.TS,
RSV.MNFR_DT,
RSV.BUYER_CD,
RSV.BUYER_NM,
RSV.SOLD_YD,
RSV.SCC,
RSV.LCC,
RSV.RCC,
(SELECT GC.MNR_CD_DP_DESC FROM MNR_GEN_CD GC WHERE GC.PRNT_CD_ID = 'CD00038' AND RSV.DISP_RSN_CD = GC.MNR_CD_ID AND ROWNUM = 1) DISP_RSN_CD,
RSV.AMT,
RSV.CURR_CD,
RSV.DISP_TP_CD,
RSV.DISP_BULTN_DT,
RSV.DISP_EML_FLG,
RSV.DISP_END_DT,
RSV.DISP_PKUP_END_DT,
RSV.DISP_PKUP_ST_DT,
RSV.DISP_QTY,
RSV.DISP_ST_DT,
RSV.DISP_ST_PRC,
RSV.EQ_KND_CD,
RSV.FILE_SEQ,
RSV.RQST_DT,
RSV.RQST_USR_ID,
RSV.DISP_STS_CD,
RSV.RQST_OFC_CD,
RSV.APRO_OFC_CD,
RSV.RNK,
(CASE
   WHEN (RSV.DISP_RSN_CD <> 'C') THEN
    (SELECT GC.MNR_CD_DP_DESC FROM MNR_GEN_CD GC WHERE GC.PRNT_CD_ID = 'CD00080' AND 'DA' = GC.MNR_CD_ID AND ROWNUM = 1)
   WHEN (RSV.TRF_UT_PRC = '0') THEN
    (SELECT GC.MNR_CD_DP_DESC FROM MNR_GEN_CD GC WHERE GC.PRNT_CD_ID = 'CD00080' AND 'NT' = GC.MNR_CD_ID AND ROWNUM = 1)
   WHEN (RSV.DISP_UT_PRC >= RSV.TRF_UT_PRC) THEN
    (SELECT GC.MNR_CD_DP_DESC FROM MNR_GEN_CD GC WHERE GC.PRNT_CD_ID = 'CD00080' AND 'SS' = GC.MNR_CD_ID AND ROWNUM = 1)
   WHEN (RSV.DISP_UT_PRC < RSV.TRF_UT_PRC) THEN
    (SELECT GC.MNR_CD_DP_DESC FROM MNR_GEN_CD GC WHERE GC.PRNT_CD_ID = 'CD00080' AND 'UP' = GC.MNR_CD_ID AND ROWNUM = 1)
  END) AS DSP_VRFY_TP_CD
FROM 
(    
    SELECT TO_CHAR(DD.DISP_SOLD_DT, 'YYYY-MM-DD') SOLD_DT,
    DD.DISP_NO DISP_NO,
    (SELECT GC.MNR_CD_DP_DESC FROM MNR_GEN_CD GC WHERE GC.PRNT_CD_ID = 'CD00029' AND DH.DISP_STS_CD = GC.MNR_CD_ID AND ROWNUM = 1) DISP_STS,
    (SELECT GC.MNR_CD_DP_DESC FROM MNR_GEN_CD GC WHERE GC.PRNT_CD_ID = 'CD00002' AND DH.EQ_KND_CD = GC.MNR_CD_ID AND ROWNUM = 1) EQ_TY,
    DD.EQ_NO EQ_NO,
    DD.EQ_TPSZ_CD TS,
    TO_CHAR(TO_DATE(SV.MANU_DT, 'yyyy-mm-dd'), 'YYYY') MNFR_DT,
    MNR_COMMON_PKG.MNR_CONV_PARTNER_CD_FNC(DD.MNR_PRNR_SEQ, DD.MNR_PRNR_CNT_CD) BUYER_CD,
    MP.MNR_PRNR_LGL_ENG_NM BUYER_NM,
    DD.DISP_YD_CD SOLD_YD,
    OC.SCC_CD SCC,
    OC.LCC_CD LCC,
    OC.RCC_CD RCC,
    DD.DISP_RSN_CD,
    DD.PART_AMT AS AMT,
    DH.CURR_CD,
    (SELECT GC.MNR_CD_DP_DESC FROM MNR_GEN_CD GC WHERE GC.PRNT_CD_ID = 'CD00035' AND DH.DISP_TP_CD = GC.MNR_CD_ID AND ROWNUM = 1) DISP_TP_CD,
    TO_CHAR(DH.DISP_BULTN_DT, 'YYYY-MM-DD') DISP_BULTN_DT,
    DH.DISP_EML_FLG,
    TO_CHAR(DH.DISP_END_DT, 'YYYY-MM-DD') DISP_END_DT,
    TO_CHAR(DH.DISP_PKUP_END_DT, 'YYYY-MM-DD') DISP_PKUP_END_DT,
    TO_CHAR(DH.DISP_PKUP_ST_DT, 'YYYY-MM-DD') DISP_PKUP_ST_DT,
    DH.DISP_QTY,
    TO_CHAR(DH.DISP_ST_DT, 'YYYY-MM-DD') DISP_ST_DT,
    DH.DISP_ST_PRC,
    DH.EQ_KND_CD,
    DH.FILE_SEQ,
    TO_CHAR(DH.RQST_DT, 'YYYY-MM-DD') RQST_DT,
    DH.RQST_USR_ID,
    DH.DISP_STS_CD,
    DH.RQST_OFC_CD,
    DH.APRO_OFC_CD,
    DD.DISP_UT_PRC,
    DECODE(DH.DISP_TP_CD,'C','',(MPD.RNO - MPD.LVL  + 1)) RNK,
    MNR_COMMON_PKG.MNR_GET_DTRFPRC_FNC( DH.DISP_TP_CD,
                                        DD.EQ_TPSZ_CD, 
                                        DH.CURR_CD,
                                        SUBSTR(DD.DISP_YD_CD, 1, 5),
                                        DH.RQST_OFC_CD
    ) AS TRF_UT_PRC
    FROM MNR_DISP_HDR DH, MNR_DISP_DTL DD, MNR_EQ_STS_V SV, MNR_PARTNER MP, MDM_EQ_ORZ_CHT OC,
    ( 
      SELECT DISP_NO
          ,DISP_DTL_SEQ
          ,MNR_PRNR_CNT_CD
          ,MNR_PRNR_SEQ
          ,PART_UT_AMT
          ,UPD_DT
          ,MNR_DISP_CFM_STS_CD
          ,RANK() OVER (ORDER BY DISP_NO, DISP_DTL_SEQ) AS LVL
          ,RANK() OVER (ORDER BY DISP_NO, DISP_DTL_SEQ,PART_UT_AMT DESC, UPD_DT ASC) AS RNO
      FROM MNR_DISP_BUYR_DTL_PART
    ) MPD
    WHERE DD.DISP_NO = DH.DISP_NO
    AND   DD.EQ_NO   = SV.EQ_NO
    AND   MPD.DISP_NO(+) = DD.DISP_NO
    AND   MPD.DISP_DTL_SEQ(+) = DD.DISP_DTL_SEQ
    AND   MPD.MNR_DISP_CFM_STS_CD(+) = 'C'
    AND   DD.MNR_PRNR_CNT_CD = MP.MNR_PRNR_CNT_CD(+)
    AND   DD.MNR_PRNR_SEQ    = MP.MNR_PRNR_SEQ(+)
    AND   SUBSTR(DD.DISP_YD_CD, 1, 5) = OC.SCC_CD
    AND   DD.DISP_SOLD_DT BETWEEN  TO_DATE(REPLACE(@[fm_dt],'-',''), 'YYYYMMDD') AND TO_DATE(REPLACE(@[to_dt],'-',''), 'YYYYMMDD')
	AND   DH.DISP_STS_CD <> 'HD'
#if (${eq_kind} != 'A')
    AND   DH.EQ_KND_CD = @[eq_kind]
    #end
    #if (${eq_tpsz_cd} != 'A')
    AND   DD.EQ_TPSZ_CD = @[eq_tpsz_cd] 
    #end
    #if (${rhq} != 'A') 
    AND   MNR_COMMON_PKG.MNR_GET_RHQ_OFC_FNC(DH.RQST_OFC_CD) = @[rhq]
    #end
    #if (${ofc_cd} != 'A')
    AND   DH.RQST_OFC_CD = @[ofc_cd] 
    #end
    #if (${disp_rsn_cd} != 'A')
    AND   DD.DISP_RSN_CD = @[disp_rsn_cd] 
    #end
    #if (${disp_tp_cd} != 'A')
    AND   DH.DISP_TP_CD = @[disp_tp_cd] 
    #end
    #if (${usd_only} == 'Y')
    AND   DH.CURR_CD = 'USD'
    #end
#if (${disp_sts_cd} != 'A')
    #if (${disp_sts_cd} == 'II')
    AND   DD.RCV_INV_SEQ IS NOT NULL
    #elseif  (${disp_sts_cd} == 'SC')
    AND   DD.DISP_SOLD_DT IS NOT NULL
    #elseif  (${disp_sts_cd} == 'IS')
    AND   EXISTS (
              SELECT 'X'
			  FROM BKG_OUTSTANDING BO
			  WHERE BO.CLT_BL_NO = DD.INV_NO
              AND BO.OTS_STL_FLG = 'Y'   
                  )
    #else
    AND   DH.DISP_STS_CD = @[disp_sts_cd] 
    #end
#end
) RSV
ORDER BY RSV.TS			]]></sql>
			<params>
				<param name="fm_dt" type="12" value="" out="N"/>
				<param name="to_dt" type="12" value="" out="N"/>
				<param name="eq_kind" type="12" value="" out="N"/>
				<param name="eq_tpsz_cd" type="12" value="" out="N"/>
				<param name="rhq" type="12" value="" out="N"/>
				<param name="ofc_cd" type="12" value="" out="N"/>
				<param name="disp_rsn_cd" type="12" value="" out="N"/>
				<param name="disp_tp_cd" type="12" value="" out="N"/>
				<param name="disp_sts_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
