<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ChargeAmountDiscountMgtDBDAOModifyAfterBookingAproPathCSQL">
			<desc><![CDATA[ChargeAmountDiscountMgtDBDAOModifyAfterBookingAproPath]]></desc>
			<sql><![CDATA[
MERGE INTO DMT_AFT_BKG_APRO_PATH A
  USING (
            SELECT  A.AFT_EXPT_DAR_NO
                   ,B.INTG_CD_VAL_CTNT
                   ,B.INTG_CD_VAL_DP_SEQ 
                   ,'' STS_CD
                   ,CASE INTG_CD_VAL_CTNT 
						WHEN 'BBOPIC' THEN BRNC_OFC_PIC_CHK_FLG
						WHEN 'OOMMGR' THEN BRNC_OFC_OP_MGR_APRO_FLG
                        WHEN 'BBGMGR' THEN BRNC_OFC_MGR_APRO_FLG
                        WHEN 'RHQPIC' THEN RHQ_PIC_CHK_FLG
                        WHEN 'RHQMGR' THEN RHQ_MGR_APRO_FLG
                        WHEN 'HDOPIC' THEN HO_PIC_CHK_FLG
                        WHEN 'HDOMGR' THEN HO_MGR_APRO_FLG
                        ELSE 'N' 
					END AS APRO_FLG
                   ,CASE INTG_CD_VAL_CTNT 
						WHEN 'BBOPIC' THEN APPL_OFC_CD
						WHEN 'OOMMGR' THEN APPL_OFC_CD
                        WHEN 'BBGMGR' THEN APPL_OFC_CD
                        WHEN 'RHQPIC' THEN ( SELECT OFC_N3RD_LVL_CD FROM DMT_OFC_LVL_V WHERE OFC_N8TH_LVL_CD = APPL_OFC_CD )
                        WHEN 'RHQMGR' THEN ( SELECT OFC_N3RD_LVL_CD FROM DMT_OFC_LVL_V WHERE OFC_N8TH_LVL_CD = APPL_OFC_CD )
                        WHEN 'HDOPIC' THEN 'SELHO'
                        WHEN 'HDOMGR' THEN 'SELHO'
                        ELSE 'ERROR' 
					END APRO_OFC_CD
                   ,@[upd_usr_id] AS UPD_USR_ID
                 
              FROM  (
						SELECT  AFT_EXPT_DAR_NO
                               ,(
									SELECT  OFC_CD
									  FROM  (
												SELECT  DECODE(OFC_D, 'DXBME', 1, DECODE(OFC_TP_CD, 'BB', 2, 'BA', 3, 4)) AS SEQ
												       ,DECODE(OFC_D, 'DXBME', 'DXBSC', OFC_CD) AS OFC_CD
												  FROM  (
															WITH RQST AS ( 
																SELECT  RQST_OFC_CD 
																  FROM  DMT_AFT_BKG_ADJ_RQST 
																 WHERE  AFT_EXPT_DAR_NO = @[aft_expt_dar_no] 
															)

															SELECT  A.OFC_CD
															       ,A.OFC_TP_CD
																   ,( 
																		SELECT  OFC_N4TH_LVL_CD
																		  FROM  DMT_OFC_LVL_V
																		       ,RQST
																		 WHERE  OFC_N8TH_LVL_CD = RQST.RQST_OFC_CD
																	) OFC_D
															  FROM  MDM_ORGANIZATION A
															 WHERE  A.OFC_TP_CD IN ('BB','BA')
															   AND  A.OFC_CD IN ( 
																		SELECT  OFC_N4TH_LVL_CD
																		  FROM  DMT_OFC_LVL_V
																		       ,RQST
																		 WHERE  OFC_N8TH_LVL_CD = RQST.RQST_OFC_CD
                                    
																		UNION ALL
                                    
																		SELECT  OFC_N5TH_LVL_CD
																		  FROM  DMT_OFC_LVL_V
																		       ,RQST
																		 WHERE  OFC_N8TH_LVL_CD = RQST.RQST_OFC_CD
																		 
																		UNION ALL
                                    
																		SELECT  OFC_N6TH_LVL_CD
																		  FROM  DMT_OFC_LVL_V
																		       ,RQST
																		 WHERE  OFC_N8TH_LVL_CD = RQST.RQST_OFC_CD
																	)
														)
												ORDER BY SEQ 
											)
									 WHERE  ROWNUM = 1
								) AS SSZ_OFC_CD
                               ,BRNC_OFC_PIC_CHK_FLG
							   ,BRNC_OFC_OP_MGR_APRO_FLG
                               ,BRNC_OFC_MGR_APRO_FLG
                               ,RHQ_PIC_CHK_FLG
                               ,RHQ_MGR_APRO_FLG
                               ,HO_PIC_CHK_FLG
                               ,HO_MGR_APRO_FLG
--					           ,APPL_OFC_CD
                               ,(
									SELECT  RQST_OFC_CD 
									  FROM  DMT_AFT_BKG_ADJ_RQST 
									 WHERE  AFT_EXPT_DAR_NO = @[aft_expt_dar_no]
								) AS RQST_OFC_CD
                               ,DECODE((
											SELECT  DECODE(COUNT(ATTR_CTNT1), 0, 'N', 'Y')
											  FROM  DMT_HRD_CDG_CTNT
											 WHERE  HRD_CDG_ID = 'DAR_AFT_BKG_DXBME'
											   AND  ATTR_CTNT1 = APPL_OFC_CD
										), 'Y', 'DXBSC', APPL_OFC_CD) AS APPL_OFC_CD
										
						  FROM  (
									SELECT  '1' SEQ
									       ,T1.AFT_EXPT_DAR_NO
										   ,T4.OFC_CD APPL_OFC_CD
										   ,T2.*
										   
									  FROM  DMT_AFT_BKG_ADJ_RQST 		T1
									       ,DMT_AFT_BKG_PATH_OFC_STUP 	T2
										   ,(
												SELECT  MAX(DC_AMT) DC_AMT
												  FROM  (
															SELECT  BKG_NO
															       ,ROUND(SUM(B.RQST_DC_AMT) / A.AFT_BKG_XCH_RT,2) DC_AMT
															  FROM  DMT_AFT_BKG_ADJ_RQST_DTL 	A
															       ,DMT_AFT_BKG_CNTR 			B
															 WHERE  A.AFT_EXPT_DAR_NO = @[aft_expt_dar_no]
															   AND  A.AFT_EXPT_DAR_NO = B.AFT_EXPT_DAR_NO
															   AND  A.AFT_EXPT_ADJ_SEQ = B.AFT_EXPT_ADJ_SEQ
															GROUP BY BKG_NO, A.AFT_BKG_XCH_RT 
														) 
											) T3
										   ,( 
												SELECT  OFC_N5TH_LVL_CD OFC_CD 
												  FROM  MAS_OFC_LVL
												 WHERE  OFC_CD = NVL(( 
																		SELECT  OFC_CD 
																		  FROM  DMT_CHG_CALC
																		 WHERE  (SYS_AREA_GRP_ID, CNTR_NO, CNTR_CYC_NO, DMDT_TRF_CD, DMDT_CHG_LOC_DIV_CD, CHG_SEQ) = 
																				(
																					SELECT  SYS_AREA_GRP_ID, CNTR_NO, CNTR_CYC_NO, DMDT_TRF_CD, DMDT_CHG_LOC_DIV_CD, CHG_SEQ 
																					  FROM  DMT_AFT_BKG_CNTR
																					 WHERE  AFT_EXPT_DAR_NO = @[aft_expt_dar_no]
																					   AND  NVL(RQST_DC_AMT, 0) != 0
																					   AND  ROWNUM = 1 
																				)
																	), 
																	( 
																		SELECT  OFC_CD 
																		  FROM  DMT_CHG_CALC
																		 WHERE  (CNTR_NO, CNTR_CYC_NO, DMDT_TRF_CD, DMDT_CHG_LOC_DIV_CD, CHG_SEQ) = 
																				(
																					SELECT  CNTR_NO, CNTR_CYC_NO, DMDT_TRF_CD, DMDT_CHG_LOC_DIV_CD, CHG_SEQ 
																					  FROM  DMT_AFT_BKG_CNTR
																					 WHERE  AFT_EXPT_DAR_NO = @[aft_expt_dar_no]
																					   AND  NVL(RQST_DC_AMT, 0) != 0
																					   AND  ROWNUM = 1
																				)
																		   AND  ROWNUM = 1
																	))
												   AND  TO_CHAR(SYSDATE,'YYYYMM') BETWEEN OFC_APLY_FM_YRMON AND OFC_APLY_TO_YRMON
												   AND  ROWNUM = 1
											) T4
											
									 WHERE  T1.AFT_EXPT_DAR_NO = @[aft_expt_dar_no]
									   AND  T1.RQST_DT BETWEEN T2.EFF_DT AND NVL(T2.EXP_DT, SYSDATE)
									   AND  T2.OFC_CD = T4.OFC_CD
									   AND  T3.DC_AMT BETWEEN NVL(FM_DC_AMT,-999999999999999) AND NVL(TO_DC_AMT,999999999999999)
									   AND  T2.DELT_FLG = 'N'
									   
									   
									UNION ALL
                    
									SELECT  '2' SEQ
									       ,T1.AFT_EXPT_DAR_NO
										   ,T4.OFC_CD
										   ,T2.*
										   
									  FROM  DMT_AFT_BKG_ADJ_RQST 		T1
									       ,DMT_AFT_BKG_PATH_OFC_STUP 	T2
										   ,(
												SELECT  MAX(DC_AMT) DC_AMT
												  FROM  (
															SELECT  BKG_NO
															       ,ROUND(SUM(B.RQST_DC_AMT) / A.AFT_BKG_XCH_RT,2) DC_AMT
															  FROM  DMT_AFT_BKG_ADJ_RQST_DTL 	A
															       ,DMT_AFT_BKG_CNTR 			B
															 WHERE  A.AFT_EXPT_DAR_NO  = @[aft_expt_dar_no]
															   AND  A.AFT_EXPT_DAR_NO  = B.AFT_EXPT_DAR_NO
															   AND  A.AFT_EXPT_ADJ_SEQ = B.AFT_EXPT_ADJ_SEQ
															GROUP BY BKG_NO, A.AFT_BKG_XCH_RT
														)
											) T3
										   ,(
												SELECT  OFC_N5TH_LVL_CD OFC_CD 
												  FROM  MAS_OFC_LVL
												 WHERE  OFC_CD = NVL((
																		SELECT  OFC_CD 
																		  FROM  DMT_CHG_CALC
																		 WHERE  (SYS_AREA_GRP_ID, CNTR_NO, CNTR_CYC_NO, DMDT_TRF_CD, DMDT_CHG_LOC_DIV_CD, CHG_SEQ) = 
																				(
																					SELECT  SYS_AREA_GRP_ID, CNTR_NO, CNTR_CYC_NO, DMDT_TRF_CD, DMDT_CHG_LOC_DIV_CD, CHG_SEQ 
																					  FROM  DMT_AFT_BKG_CNTR
																					 WHERE  AFT_EXPT_DAR_NO = @[aft_expt_dar_no]
																					   AND  NVL(RQST_DC_AMT, 0) != 0
																					   AND  ROWNUM = 1
																				)
																	),
																	( 
																		SELECT  OFC_CD 
																		  FROM  DMT_CHG_CALC
																		 WHERE  (CNTR_NO, CNTR_CYC_NO, DMDT_TRF_CD, DMDT_CHG_LOC_DIV_CD, CHG_SEQ) = 
																				(
																					SELECT  CNTR_NO, CNTR_CYC_NO, DMDT_TRF_CD, DMDT_CHG_LOC_DIV_CD, CHG_SEQ 
																					  FROM  DMT_AFT_BKG_CNTR
																					 WHERE  AFT_EXPT_DAR_NO = @[aft_expt_dar_no]
																					   AND  NVL(RQST_DC_AMT, 0) != 0
																					   AND  ROWNUM = 1
																				)
																		   AND  ROWNUM = 1
																	))
												   AND  TO_CHAR(SYSDATE,'YYYYMM') BETWEEN OFC_APLY_FM_YRMON AND OFC_APLY_TO_YRMON
												   AND  ROWNUM = 1
											) T4
											
									 WHERE  T1.AFT_EXPT_DAR_NO = @[aft_expt_dar_no]
									   AND T1.RQST_DT BETWEEN T2.EFF_DT AND NVL(T2.EXP_DT, SYSDATE)
									   AND T2.RHQ_CD = (SELECT OFC_N3RD_LVL_CD FROM DMT_OFC_LVL_V WHERE OFC_N8TH_LVL_CD = T4.OFC_CD AND ROWNUM = 1 ) 
									   AND T2.OFC_CD IS NULL
									   AND T3.DC_AMT BETWEEN NVL(FM_DC_AMT,-999999999999999) AND NVL(TO_DC_AMT,999999999999999)
									   AND T2.DELT_FLG = 'N'
									ORDER BY SEQ 
								) AA
						 WHERE  ROWNUM = 1
					) 					A
				   ,COM_INTG_CD_DTL 	B
				   
			 WHERE  B.INTG_CD_ID = 'CD03468'
            ORDER BY INTG_CD_VAL_DP_SEQ
        ) B
  ON (      A.AFT_EXPT_DAR_NO = B.AFT_EXPT_DAR_NO 
		AND A.AFT_BKG_PATH_CD = B.INTG_CD_VAL_CTNT
     )
	 
  WHEN MATCHED THEN
    UPDATE
      SET  A.AFT_BKG_PATH_CPLS_FLG = B.APRO_FLG
          ,DMDT_EXPT_RQST_STS_CD   = B.STS_CD
		  ,A.APRO_OFC_CD           = B.APRO_OFC_CD
          ,A.UPD_USR_ID            = B.UPD_USR_ID
          ,A.UPD_DT                = SYSDATE
		  ,A.AFT_BKG_PATH_LVL      = TO_CHAR(B.INTG_CD_VAL_DP_SEQ)
		  
  WHEN NOT MATCHED THEN
    INSERT (AFT_EXPT_DAR_NO
           ,AFT_BKG_PATH_CD
           ,AFT_BKG_PATH_LVL
           ,DMDT_EXPT_RQST_STS_CD
           ,AFT_BKG_PATH_CPLS_FLG
           ,CRE_USR_ID
           ,CRE_DT
           ,UPD_USR_ID
           ,UPD_DT 
		   ,APRO_OFC_CD )
    VALUES (B.AFT_EXPT_DAR_NO
           ,B.INTG_CD_VAL_CTNT
           ,B.INTG_CD_VAL_DP_SEQ
           ,''
           ,B.APRO_FLG
           ,B.UPD_USR_ID
           ,SYSDATE
           ,B.UPD_USR_ID
           ,SYSDATE
		   ,B.APRO_OFC_CD)			]]></sql>
			<params>
				<param name="upd_usr_id" type="12" value="" out="N"/>
				<param name="aft_expt_dar_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
