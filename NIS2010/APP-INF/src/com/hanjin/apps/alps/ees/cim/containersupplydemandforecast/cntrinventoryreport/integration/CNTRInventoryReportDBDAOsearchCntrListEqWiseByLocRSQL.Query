<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CNTRInventoryReportDBDAOsearchCntrListEqWiseByLocRSQL">
			<desc><![CDATA[Container List by Location
2011.05.13 남궁진호[CHM-201110740-01] M/Date 조건 추가에 따른 SQL수정 CNTR 생산년도 Fr~To 조건추가
2012.02.08 신자영 [CHM-201216058-01] [CIM] Land Inventory with cntr list 기능 보완]]></desc>
			<sql><![CDATA[
SELECT AA.*
       ,(SELECT A.YD_NM FROM MDM_YARD A WHERE A.YD_CD = AA.CRNT_YD_CD) YD_NM
FROM (
SELECT
     A.SUB_LOC_CD
    ,A.CRNT_YD_CD
    ,A.CNTR_NO
    ,A.CNTR_TPSZ_CD
    ,A.LSTM_CD
    ,A.CNMV_STS_CD
	,A.FULL_FLG
	,A.AGMT_NO
    ,A.CNMV_DT
	,LTRIM(TO_CHAR(A.STAY_DAYS,'9,999')) STAY_DAYS
    ,A.BKG_NO
    ,A.BL_NO
	,A.VVD
    ,DECODE(A.DMG_FLG,'Y',A.DMG_FLG,'') DMG_FLG
	,(SELECT INTG_CD_VAL_DP_DESC FROM COM_INTG_CD_DTL WHERE INTG_CD_ID='CD02012' AND INTG_CD_VAL_CTNT=A.CNTR_HNGR_RCK_CD) CNTR_HNGR_RCK_CD
	,A.MNR_HNGR_BAR_TP_CD
    ,A.CNTR_HNGR_BAR_ATCH_KNT
    ,DECODE(A.DISP_FLG,'Y',A.DISP_FLG,'') DISP_FLG
    ,DECODE(A.IMDT_EXT_FLG,'Y',A.IMDT_EXT_FLG,'') IMDT_EXT_FLG
    ,DECODE(A.UCLM_LS_FLG,'Y',A.UCLM_LS_FLG,'') UCLM_LS_FLG
    ,DECODE(A.PLST_FLR_FLG,'Y',A.PLST_FLR_FLG,'') PLST_FLR_FLG
	,A.DE_TERM_CD
	,A.RF_TP_CD
    ,PSA_NO
	
	#if (${view_customer} == 'Y')
        ,REPLACE(SUBSTR(B.CUST_NM,1,50),CHR(13)||chr(10),' ')  SHPR
        ,REPLACE(SUBSTR(C.CUST_NM,1,50),CHR(13)||chr(10),' ')  CNEE
        ,REPLACE(SUBSTR(D.CUST_NM,1,50),CHR(13)||chr(10),' ')  NTFY
    #end

	#if (${view_commodity} == 'Y')
    	,(SELECT D.CMDT_NM FROM MDM_COMMODITY D
    	  WHERE   A.CMDT_CD = D.CMDT_CD
    	 ) REP_CMDT_NM
    	,(SELECT REPLACE(SUBSTR(X.CNTR_MF_GDS_DESC,1,100),CHR(13)||chr(10),' ') MK_DESC
    		FROM BKG_CNTR_MF_DESC X
    	   WHERE A.BKG_NO = X.BKG_NO
    	   AND A.CNTR_NO=X.CNTR_NO
           AND ROWNUM=1
         ) MK_DESC
    #end
	,A.OB_SLS_OFC_CD
    ,(SELECT X.VNDR_ABBR_NM
      FROM MDM_VENDOR X
      WHERE A.VNDR_SEQ = X.VNDR_SEQ) LESSOR
    ,A.MFT_DT
	#if (${over_stay_days} != '' &&  ${over_stay_days} != '0')
	    ,NVL(TO_NUMBER(SUBSTR(A.FT_END_DYS,11,4)),0) FT_DYS
	    ,SUBSTR(A.FT_END_DYS,1,10) FT_END_DT
	    ,CASE WHEN A.STAY_DAYS-NVL(TO_NUMBER(SUBSTR(A.FT_END_DYS,11,4)),0) >99999 THEN
			99999
		 ELSE
	 	    A.STAY_DAYS-NVL(TO_NUMBER(SUBSTR(A.FT_END_DYS,11,4)),0)
		 END  ACT_DYS 
	#end
	,DECODE(A.DCGO_FLG, 'Y', A.DCGO_FLG, '') DG_FLG
    ,CASE WHEN A.LSTM_CD = 'LT' AND NVL(A.MIN_ONH_DYS,0) = 0 THEN
            CASE WHEN TRUNC(SYSDATE) - ( SELECT /*+ INDEX_DESC (S XPKLSE_AGMT_VER) */ TRUNC(EXP_DT)
                                  		   FROM LSE_AGMT_VER S
                                  		   WHERE  S.AGMT_CTY_CD = A.AGMT_CTY_CD
                                  		   AND    S.AGMT_SEQ    = A.AGMT_SEQ
                                  		   AND    ROWNUM = 1   
                                       ) > 0
             	   THEN  'Y'
          ELSE '' 
          END
     WHEN A.LSTM_CD = 'LT' AND NVL(A.MIN_ONH_DYS,0) > 0 THEN
            CASE WHEN TRUNC(SYSDATE)  > TRUNC(A.ONH_DT) + (NVL(A.MIN_ONH_DYS,0) - 1)
                 THEN  'Y'
            ELSE '' END
     WHEN A.LSTM_CD IN ('ST', 'SI', 'OF', 'MI') THEN
               CASE WHEN TRUNC(SYSDATE)  > TRUNC(A.ONH_DT) + (NVL(A.MIN_ONH_DYS,0) - 1)
                  THEN  'Y'
          ELSE '' END
    ELSE '' END OFF_HIRE
FROM
(    
    SELECT
        DECODE(@[loc_type_code],'1',LCC_CD,'2',SCC_CD,'3',SCC_CD,'4',SCC_CD,'5',SCC_CD) SUB_LOC_CD
        ,A.CRNT_YD_CD
        ,A.CNTR_NO
        ,A.CNTR_TPSZ_CD
        ,A.LSTM_CD
        ,A.CNMV_STS_CD
    	,DECODE(A.FULL_FLG,'Y','F','M') FULL_FLG
		,A.AGMT_CTY_CD||A.AGMT_SEQ AGMT_NO
        ,TO_CHAR(A.CNMV_DT,'YYYY-MM-DD') CNMV_DT
    	,CEIL(TO_DATE(@[rcc_date],'yyyy-MM-dd HH24:mi:SS') - A.CNMV_DT) STAY_DAYS
        ,A.BKG_NO
        ,B.BL_NO
    	,A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD VVD
        ,A.DMG_FLG
    	,A.CNTR_HNGR_RCK_CD
		,A.MNR_HNGR_BAR_TP_CD
        ,A.CNTR_HNGR_BAR_ATCH_KNT
        ,A.DISP_FLG
        ,A.IMDT_EXT_FLG
        ,DECODE(A.UCLM_LS_DIV_CD,'U','Y','N') UCLM_LS_FLG
        ,A.PLST_FLR_FLG
		,B.RCV_TERM_CD||'/'||B.DE_TERM_CD DE_TERM_CD
    	,A.RF_TP_CD
    	,B.OB_SLS_OFC_CD
        ,TO_CHAR(A.MFT_DT,'YYYY-MM-DD') MFT_DT
    	,A.VNDR_SEQ
    	,B.CMDT_CD
		#if (${over_stay_days} != '' &&  ${over_stay_days} != '0')
	        ,(SELECT  MAX(NVL(TO_CHAR(FT_END_DT,'YYYY-MM-DD'),'1111-11-11')||LTRIM(TO_CHAR(FT_DYS,'0000')))
	        FROM DMT_CHG_CALC E,DMT_CHG_BKG_CNTR F
	        WHERE E.CNTR_NO = A.CNTR_NO
	        AND E.SYS_AREA_GRP_ID  =  A.SYS_AREA_GRP_ID
	        AND E.CNTR_CYC_NO = A. CNMV_CYC_NO
	        AND E.CHG_SEQ = 1
	        AND E.FM_MVMT_YD_CD = A.CRNT_YD_CD
	        AND E.DMDT_CHG_STS_CD <> 'E'
	        AND F.CNTR_NO = E.CNTR_NO
	        AND F.SYS_AREA_GRP_ID  = E.SYS_AREA_GRP_ID
	        AND F.CNTR_CYC_NO = E.CNTR_CYC_NO
	        AND F.BKG_NO = A.BKG_NO
			AND A.CNMV_STS_CD NOT IN ('TS','MT')
			) FT_END_DYS  
		#end
		,B.DCGO_FLG
        ,A.AGMT_CTY_CD
	 	,A.AGMT_SEQ
        ,A.MIN_ONH_DYS
        ,A.ONH_DT
        ,C.PSA_NO
    FROM MST_CONTAINER A,BKG_BOOKING B,
         ( SELECT * FROM
                (SELECT BKG_NO, PSA_NO, ROW_NUMBER() OVER (PARTITION BY BKG_NO ORDER BY DCGO_SEQ, DG_CNTR_SEQ) AS RN FROM BKG_DG_CGO)
          WHERE RN = '1') C
    WHERE A.ACIAC_DIV_CD='A'
    AND   A.BKG_NO =B.BKG_NO(+)
    AND   A.BKG_NO =C.BKG_NO(+)

    #if(${psa_no} != '')
        AND C.PSA_NO IN ('1','1D','1S','2','1S/2S' ) 
    #end

    AND   A.CNTR_USE_CO_CD = @[cntr_use_co_cd]
    
    #if(${off_hire_flg} != '')
 		AND (
                  ( A.LSTM_CD = 'LT' AND NVL(A.min_onh_dys,0) > 0
                      AND  TRUNC(SYSDATE) > TRUNC(A.ONH_DT) + (NVL(A.MIN_ONH_DYS,0) - 1)
                  )
                  OR
                  ( A.LSTM_CD = 'LT' AND NVL(A.min_onh_dys,0) = 0
                     AND  TRUNC(SYSDATE) - ( SELECT /*+ INDEX_DESC (S XPKLSE_AGMT_VER) */ TRUNC(EXP_DT)
                                                                  FROM   LSE_AGMT_VER S
                                                                  WHERE  S.AGMT_CTY_CD = A.AGMT_CTY_CD
                                                                  AND    S.AGMT_SEQ    = A.AGMT_SEQ
                                                                  AND    ROWNUM = 1
                               ) > 0
                 )
                OR
                 ( A.LSTM_CD IN ('ST', 'SI', 'OF', 'MI','OL')
                     AND TRUNC(SYSDATE)  > TRUNC(A.ONH_DT) + (NVL(A.MIN_ONH_DYS,0) - 1)
                 )
            )
	#end


    #if (${loc_type_code} == '1')
    	AND A.RCC_CD =@[loc_cd]
    #elseif (${loc_type_code} == '2')
    	AND A.LCC_CD =@[loc_cd]
    #elseif (${loc_type_code} == '3')
    	AND A.ECC_CD =@[loc_cd]
    #elseif (${loc_type_code} == '4')
    	AND A.SCC_CD =@[loc_cd]
    #elseif (${loc_type_code} == '5')
    	AND A.CRNT_YD_CD =@[loc_cd]
    #end 
    
    #if (${full_flg} != '')
    	AND A.FULL_FLG = @[full_flg]
    #end

    #if (${cntr_tpsz_cd} != '')
    	AND A.CNTR_TPSZ_CD IN ( 
    		  				 SELECT COLUMN_VALUE
        	                 FROM TABLE ( SELECT cast( CIM_IN_LIST_FNC( @[cntr_tpsz_cd] ) AS listItemType ) 
            	             FROM dual )
    				        )
    #end
    
    #if (${imdt_ext_flg} != '')
        AND A.IMDT_EXT_FLG =@[imdt_ext_flg]
    #end
    
    #if (${plst_flr_flg} != '')
        AND A.PLST_FLR_FLG =@[plst_flr_flg]
    #end
    
    #if (${dmg_flg} != '')
    	AND A.DMG_FLG = @[dmg_flg]
    #end      
    
    #if (${cntr_no} != '')
    	AND SUBSTR(A.CNTR_NO,0,4) = @[cntr_no]
    #end  
    
    
    #if (${rf_tp_cd_c} != '' || ${rf_tp_cd_h} != '' || ${rf_cntr} != '' || ${rd_cgo_flg} != '')
        AND A.CNTR_TPSZ_CD LIKE 'R%'
    #end  
    
    #if (${rf_tp_cd_c} != '' || ${rf_tp_cd_h} != '' || ${rf_tp_cd_m} != '')
        AND A.RF_TP_CD IN(@[rf_tp_cd_c],@[rf_tp_cd_h],@[rf_tp_cd_m])
    #end  
    
    #if (${rd_cgo_flg} != '' || ${rf_cntr} != '')
        AND B.RD_CGO_FLG IN(@[rf_cntr],@[rd_cgo_flg])
    #end          
    
    #if (${soc_cd} != '')
    	#if (${soc_cd} == '1')
    		AND A.LSTM_CD <> 'SH'
    	#else
    		AND A.LSTM_CD = 'SH'
    	#end
    #end

   	#if (${uclm_ls_div_cd} == 'E')
       	AND NVL(A.UCLM_LS_DIV_CD,'X') <> 'U'
	#elseif(${uclm_ls_div_cd} == 'O')
       	AND A.UCLM_LS_DIV_CD = 'U'
    #end

    #if (${cnmv_sts_cd} != '')
    	AND A.CNMV_STS_CD IN ( 
    		  				 SELECT COLUMN_VALUE
        	                 FROM TABLE ( SELECT cast( CIM_IN_LIST_FNC( @[cnmv_sts_cd] ) AS listItemType ) 
            	             FROM dual )
    				        )
        AND A.CNMV_STS_CD NOT IN('VL','XX','VD')
    #elseif (${d2_payld_flg} == '')
        AND A.CNMV_STS_CD IN (
        'CD'
        ,'CE'
        ,'CI'
        ,'CM'
        ,'CO'
        ,'CP'
        ,'CT'
        ,'CX'
        ,'EN'
        ,'IC'
        ,'ID'
        ,'MT'
        ,'OC'
        ,'OP'
        ,'TN'
        ,'TS'
        )
    #end

	#if (${over_stay_days} != '')
    	AND  CEIL(TO_DATE(@[rcc_date],'yyyy-MM-dd HH24:mi:SS') - CNMV_DT) >= @[over_stay_days]
    #end

    #if (${lstm_cd} != '')
    	AND A.LSTM_CD IN ( 
    		  				 SELECT COLUMN_VALUE
        	                 FROM TABLE ( SELECT cast( CIM_IN_LIST_FNC( @[lstm_cd] ) AS listItemType ) 
            	             FROM dual )
    				        )
    #end
    
    #if (${cntr_hngr_rck_cd} != '')
    	AND (A.CNTR_HNGR_RCK_CD IS NOT NULL  OR  A.CNTR_HNGR_BAR_ATCH_KNT > 0)
    #end


    #if (${disp_flg} != '')
    	AND A.DISP_FLG = @[disp_flg]
    #end
    #if (${d2_payld_flg} != '')
    	AND A.CNTR_TPSZ_CD='D2'
    	AND A.D2_PAYLD_FLG = @[d2_payld_flg]
    #end	
	#if (${view_flg} == 'eq') 
		#if (${froms} != '') 
			AND TO_CHAR(MFT_DT,'YYYY') BETWEEN @[froms] AND @[tos]
		#end
	#end

    #if (${dg_flg} != '')
    	AND B.DCGO_FLG  = @[dg_flg]
    #end
	
) A
#if (${view_customer} == 'Y')
, BKG_CUSTOMER B, BKG_CUSTOMER C, BKG_CUSTOMER D
WHERE A.BKG_NO =B.BKG_NO(+)
AND  A.BKG_NO =C.BKG_NO(+)
AND  A.BKG_NO =D.BKG_NO(+)
AND B.BKG_CUST_TP_CD(+) ='S'
AND C.BKG_CUST_TP_CD(+) ='C'
AND D.BKG_CUST_TP_CD(+) ='N'
#end
) AA			]]></sql>
			<params>
				<param name="loc_type_code" type="12" value="" out="N"/>
				<param name="rcc_date" type="12" value="" out="N"/>
				<param name="cntr_use_co_cd" type="12" value="" out="N"/>
				<param name="loc_cd" type="12" value="" out="N"/>
				<param name="full_flg" type="12" value="" out="N"/>
				<param name="cntr_tpsz_cd" type="12" value="" out="N"/>
				<param name="imdt_ext_flg" type="12" value="" out="N"/>
				<param name="plst_flr_flg" type="12" value="" out="N"/>
				<param name="dmg_flg" type="12" value="" out="N"/>
				<param name="cntr_no" type="12" value="" out="N"/>
				<param name="rf_tp_cd_c" type="12" value="" out="N"/>
				<param name="rf_tp_cd_h" type="12" value="" out="N"/>
				<param name="rf_tp_cd_m" type="12" value="" out="N"/>
				<param name="rf_cntr" type="12" value="" out="N"/>
				<param name="rd_cgo_flg" type="12" value="" out="N"/>
				<param name="cnmv_sts_cd" type="12" value="" out="N"/>
				<param name="over_stay_days" type="12" value="" out="N"/>
				<param name="lstm_cd" type="12" value="" out="N"/>
				<param name="disp_flg" type="12" value="" out="N"/>
				<param name="d2_payld_flg" type="12" value="" out="N"/>
				<param name="froms" type="12" value="" out="N"/>
				<param name="tos" type="12" value="" out="N"/>
				<param name="dg_flg" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
