<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ContainerMovementFinderDBDAOConCBookingCountRSQL">
			<desc><![CDATA[EES_CTM_0413의 Matched Count를 구한다]]></desc>
			<sql><![CDATA[
#if (${flgrslt} == 'RL')
   SELECT COUNT(1) AS MAT
   FROM (
		SELECT C.CNTR_NO, C.CNTR_TPSZ_CD, DECODE (B.BKG_CGO_TP_CD, 'P', 'M', 'F' ) FULL_FG, C.CNMV_STS_CD MVMT_STS_CD, C.BKG_NO
		  FROM BKG_CONTAINER C, BKG_BOOKING B
		 WHERE C.BKG_NO IN (
			  SELECT BV.BKG_NO
			    FROM BKG_VVD BV2, BKG_VVD BV
			   WHERE BV.VSL_CD = SUBSTR(@[vls_cd], 0,4)
			     AND BV.SKD_VOY_NO = SUBSTR(@[vls_cd], 5,4)
			     AND BV.SKD_DIR_CD = SUBSTR(@[vls_cd], 9,1)
			     AND BV.POL_CD = SUBSTR(@[pol_cd], 0, 5)
			     AND BV2.BKG_NO(+) = BV.BKG_NO
			     AND ASCII (BV2.VSL_PRE_PST_CD(+)) * 10 + TO_NUMBER (BV2.VSL_SEQ(+)) <
					ASCII (BV.VSL_PRE_PST_CD) * 10
					+ TO_NUMBER (BV.VSL_SEQ)
				#if (${locl_type} != '')
			     AND DECODE (BV2.VSL_PRE_PST_CD, NULL, 'N', 'Y') IN (@[locl_type])
				#end
			     )
		   AND C.BKG_NO = B.BKG_NO
		   AND B.BKG_STS_CD NOT IN ('X', 'S')
        ) A, ( 
	#if (${mv_type} == '')
		SELECT CNTR_NO, CNTR_TPSZ_CD, DECODE (BKG_CGO_TP_CD, 'P', 'M', 'F' ) FULL_FG, MVMT_STS_CD, MVMT_INP_TP_CD BKG_NO
		  FROM CTM_MOVEMENT
		 WHERE CRNT_VSL_CD = SUBSTR(@[vls_cd], 0,4)
		   AND CRNT_SKD_VOY_NO = SUBSTR(@[vls_cd], 5,4)
		   AND CRNT_SKD_DIR_CD = SUBSTR(@[vls_cd], 9,1)
		   AND SUBSTR(ORG_YD_CD,1, 5) = @[pol_cd]
		   AND MVMT_STS_CD = 'VL'
	#else
			SELECT CNTR_REF_NO CNTR_NO, ISM_CNTR_TPSZ_CD CNTR_TPSZ_CD, DECODE(FULL_MTY_CD, 'E', 'M', 'F') FULL_FG, 'VL' MVMT_STS_CD, '' BKG_NO
			FROM OPF_BAY_PLN_LDIS
			WHERE VSL_CD = SUBSTR(@[vls_cd], 0,4)
			AND SKD_VOY_NO = SUBSTR(@[vls_cd], 5,4)
			AND SKD_DIR_CD = SUBSTR(@[vls_cd], 9,1)
			AND POL_CD = SUBSTR(@[pol_cd], 0, 5)
			AND LODG_DCHG_IND_CD = 'C'
	#end
        ) B
   WHERE A.CNTR_NO = B.CNTR_NO
     AND A.MVMT_STS_CD = B.MVMT_STS_CD
#elseif (${flgrslt} == 'PD')
   SELECT COUNT(1) AS MAT
   FROM (
 		SELECT C.CNTR_NO, C.CNTR_TPSZ_CD, DECODE(B.BKG_CGO_TP_CD, 'P', 'M', 'F') FULL_FG, C.CNMV_STS_CD MVMT_STS_CD, C.BKG_NO
		FROM BKG_CONTAINER C, BKG_BOOKING B
		WHERE C.BKG_NO IN 
		    (
			SELECT BV.BKG_NO
			    FROM BKG_VVD BV2, BKG_VVD BV
			    WHERE  BV.VSL_CD = SUBSTR(@[vls_cd], 0,4)
			    AND BV.SKD_VOY_NO = SUBSTR(@[vls_cd], 5,4)
			    AND BV.SKD_DIR_CD = SUBSTR(@[vls_cd], 9,1)
			    AND BV.POD_CD = SUBSTR(@[pol_cd], 0, 5)
			    AND BV2.BKG_NO(+) = BV.BKG_NO
			    AND	ASCII(BV2.VSL_PRE_PST_CD(+)) * 10 + TO_NUMBER(BV2.VSL_SEQ(+))
					< ASCII(BV.VSL_PRE_PST_CD) * 10 + TO_NUMBER(BV.VSL_SEQ)
				#if (${locl_type} != '')
			     AND DECODE (BV2.VSL_PRE_PST_CD, NULL, 'N', 'Y') IN (@[locl_type])
				#end
		    )
		AND C.BKG_NO = B.BKG_NO
		AND B.BKG_STS_CD NOT IN ('X', 'S')
        ) A,  
	#if (${mv_type} == '')
		(
		SELECT A.CNTR_NO, A.CNTR_TPSZ_CD, A.FULL_FG, A.MVMT_STS_CD, A.MVMT_INP_TP_CD BKG_NO
		  FROM (SELECT CNTR_NO, CNTR_TPSZ_CD,
			       DECODE (BKG_CGO_TP_CD, 'P', 'M', 'F') FULL_FG, MVMT_STS_CD,
			       MVMT_INP_TP_CD, BKG_NO
			  FROM CTM_MOVEMENT
			 WHERE CRNT_VSL_CD = SUBSTR(@[vls_cd], 0,4)
			   AND CRNT_SKD_VOY_NO = SUBSTR(@[vls_cd], 5,4)
			   AND CRNT_SKD_DIR_CD = SUBSTR(@[vls_cd], 9,1)
			#if (${cgo_type} != '')
 		   	   AND B.BKG_CGO_TP_CD = @[cgo_type]
			#end
			   AND MVMT_STS_CD <> 'VD') A,
		       (SELECT BV.BKG_NO
			  FROM BKG_VVD BV2, BKG_VVD BV
			 WHERE BV.VSL_CD = SUBSTR(@[vls_cd], 0,4)
			   AND BV.SKD_VOY_NO = SUBSTR(@[vls_cd], 5,4)
			   AND BV.SKD_DIR_CD = SUBSTR(@[vls_cd], 9,1)
			   AND BV.POD_CD = SUBSTR(@[pol_cd], 0, 5)
			   AND BV2.BKG_NO(+) = BV.BKG_NO
			   AND ASCII (BV2.VSL_PRE_PST_CD(+)) * 10 + TO_NUMBER (BV2.VSL_SEQ(+)) <
					ASCII (BV.VSL_PRE_PST_CD) * 10
					+ TO_NUMBER (BV.VSL_SEQ)
				#if (${locl_type} != '')
			     AND DECODE (BV2.VSL_PRE_PST_CD, NULL, 'N', 'Y') IN (@[locl_type])
				#end
				) B
		 WHERE A.BKG_NO = B.BKG_NO
        	) B
	#else
		(
			SELECT CNTR_REF_NO CNTR_NO, ISM_CNTR_TPSZ_CD CNTR_TPSZ_CD, DECODE(FULL_MTY_CD, 'E', 'M', 'F') FULL_FG, 'VD' MVMT_STS_CD, '' BKG_NO
			FROM OPF_BAY_PLN_LDIS
			WHERE VSL_CD = SUBSTR(@[vls_cd], 0,4)
			AND SKD_VOY_NO = SUBSTR(@[vls_cd], 5,4)
			AND SKD_DIR_CD = SUBSTR(@[vls_cd], 9,1)
			AND POD_CD = SUBSTR(@[pol_cd], 0, 5)
			AND LODG_DCHG_IND_CD = 'C'
		   ) B
	#end
   WHERE A.CNTR_NO = B.CNTR_NO
     AND A.MVMT_STS_CD = B.MVMT_STS_CD
#elseif (${flgrslt} == 'RD')
   SELECT COUNT(1) AS MAT
   FROM (
		SELECT C.CNTR_NO, C.CNTR_TPSZ_CD, DECODE(B.BKG_CGO_TP_CD, 'P', 'M', 'F') FULL_FG, C.CNMV_STS_CD MVMT_STS_CD, C.BKG_NO
		FROM BKG_CONTAINER C, BKG_BOOKING B
		WHERE C.BKG_NO IN 
		(
		SELECT BV.BKG_NO
			    FROM BKG_VVD BV2, BKG_VVD BV
			    WHERE  BV.VSL_CD = SUBSTR(@[vls_cd], 0,4)
			    AND BV.SKD_VOY_NO = SUBSTR(@[vls_cd], 5,4)
			    AND BV.SKD_DIR_CD = SUBSTR(@[vls_cd], 9,1)
			    AND BV.POD_CD = SUBSTR(@[pol_cd], 0, 5)
			    AND BV2.BKG_NO(+) = BV.BKG_NO
			    AND	ASCII(BV2.VSL_PRE_PST_CD(+)) * 10 + TO_NUMBER(BV2.VSL_SEQ(+))
					< ASCII(BV.VSL_PRE_PST_CD) * 10 + TO_NUMBER(BV.VSL_SEQ)
				#if (${locl_type} != '')
			     AND DECODE (BV2.VSL_PRE_PST_CD, NULL, 'N', 'Y') IN (@[locl_type])
				#end
		)
		AND C.BKG_NO = B.BKG_NO
		AND B.BKG_STS_CD NOT IN ('X', 'S')
        ) A, ( 
		SELECT A.CNTR_NO, A.CNTR_TPSZ_CD, A.FULL_FG, A.MVMT_STS_CD, A.MVMT_INP_TP_CD
		  FROM (SELECT CNTR_NO, CNTR_TPSZ_CD,
			       DECODE (BKG_CGO_TP_CD, 'P', 'M', 'F') FULL_FG, MVMT_STS_CD,
			       MVMT_INP_TP_CD, BKG_NO
			  FROM CTM_MOVEMENT
			 WHERE CRNT_VSL_CD = SUBSTR(@[vls_cd], 0,4)
			   AND CRNT_SKD_VOY_NO = SUBSTR(@[vls_cd], 5,4)
			   AND CRNT_SKD_DIR_CD = SUBSTR(@[vls_cd], 9,1)
			   AND MVMT_STS_CD = 'VD') A,
		       (SELECT BV.BKG_NO
			  FROM BKG_VVD BV2, BKG_VVD BV
			 WHERE BV.VSL_CD = SUBSTR(@[vls_cd], 0,4)
			   AND BV.SKD_VOY_NO = SUBSTR(@[vls_cd], 5,4)
			   AND BV.SKD_DIR_CD = SUBSTR(@[vls_cd], 9,1)
			   AND BV.POD_CD = SUBSTR(@[pol_cd], 0, 5)
			   AND BV2.BKG_NO(+) = BV.BKG_NO
			   AND ASCII (BV2.VSL_PRE_PST_CD(+)) * 10 + TO_NUMBER (BV2.VSL_SEQ(+)) <
					ASCII (BV.VSL_PRE_PST_CD) * 10
					+ TO_NUMBER (BV.VSL_SEQ)
				#if (${locl_type} != '')
			     AND DECODE (BV2.VSL_PRE_PST_CD, NULL, 'N', 'Y') IN (@[locl_type])
				#end
			   ) B
		 WHERE A.BKG_NO = B.BKG_NO
         ) B
   WHERE A.CNTR_NO = B.CNTR_NO
     AND A.MVMT_STS_CD = B.MVMT_STS_CD
#end			]]></sql>
			<params>
				<param name="vls_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="locl_type" type="12" value="" out="N"/>
				<param name="cgo_type" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
