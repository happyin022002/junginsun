<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TotalLossMgtDBDAOSearchTotalLossLessorReportListDataRSQL">
			<desc><![CDATA[SearchTotalLossLessorReportListData]]></desc>
			<sql><![CDATA[
WITH TOTAL_LOSS AS (
        SELECT DECODE(EV.LESSOR_CD, '0', (SELECT VNDR_SEQ
                          FROM CGM_EQUIPMENT
                         WHERE EQ_NO = RD.RQST_EQ_NO
                           AND ROWNUM = 1), EV.LESSOR_CD) LESSOR_CD,
               DECODE(EV.LESSOR_CD, '0', (SELECT B.VNDR_LGL_ENG_NM
                          FROM CGM_EQUIPMENT A,
                               MDM_VENDOR B
                         WHERE A.VNDR_SEQ = B.VNDR_SEQ(+)
                           AND A.EQ_NO = RD.RQST_EQ_NO
                           AND ROWNUM = 1), EV.LESSOR_NM) LESSOR_NM,
               DECODE(RD.EQ_KND_CD, 'U', 'Container', 'G', 'MG Set', 'Z', 'Chassis') EQ_TYPE,
               RD.RQST_EQ_NO EQ_NO,
               RD.INV_NO INV_NO,
               RD.TTL_LSS_NO,
               RD.TTL_LSS_DTL_SEQ,
               TO_CHAR(RH.RQST_DT, 'YYYY-MM-DD') RQST_DT,
               TO_CHAR(RH.TTL_LSS_CFM_DT, 'YYYY-MM-DD') TTL_LSS_CFM_DT,
               (SELECT MNR_CD_DESC
                  FROM MNR_GEN_CD
                 WHERE PRNT_CD_ID = 'TR'
                   AND MNR_CD_ID = RH.TTL_LSS_RSN_CD
                   AND ROWNUM = 1) TTL_LSS_RSN_NM,
               DECODE(RD.TTL_LSS_CMPL_DT, NULL, 'N', 'Y') CMPL_FLG,
               TO_CHAR(RH.TTL_LSS_DT, 'YYYY-MM-DD') TLL_DT,
               RD.DPC_VAL_AMT DV_VALUE,
                       CASE
                         WHEN RD.EQ_KND_CD = 'U' THEN (SELECT AGMT_CTY_CD||LPAD(AGMT_SEQ, 6, 0)
                  FROM MST_CONTAINER
                 WHERE CNTR_NO = RD.RQST_EQ_NO
                   AND ROWNUM = 1)
                         ELSE (SELECT AGMT_OFC_CTY_CD||LPAD(AGMT_SEQ, 6, 0)
                  FROM CGM_EQUIPMENT
                 WHERE EQ_NO = RD.RQST_EQ_NO
                   AND ROWNUM = 1)
                       END AGMT_NO
          FROM MNR_TTL_LSS_RQST_HDR RH,
               MNR_TTL_LSS_RQST_DTL RD,
               MNR_EQ_STS_V EV
         WHERE RH.TTL_LSS_NO = RD.TTL_LSS_NO
           AND RH.RQST_DT BETWEEN TO_DATE(@[from_dt], 'YYYY-MM-DD') AND TO_DATE(@[to_dt], 'YYYY-MM-DD')+0.99999  
           AND RD.RQST_EQ_NO = EV.EQ_NO
           AND RD.MNR_INV_TP_CD IN ('DV')
--           AND EV.LSTM_CD IN ('LT', 'ST') 
),
       COLLECTION AS (
        SELECT A.TTL_LSS_NO,
               C.RQST_EQ_NO EQ_NO,
               NVL(TO_NUMBER(SUM(MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(TO_CHAR(B.TTL_LSS_CFM_DT, 'YYYYMM'), A.CURR_CD, 'USD', A.CLT_AMT, 3))), 0) CLT_AMT
          FROM MNR_TTL_LSS_CLT A,
               MNR_TTL_LSS_RQST_HDR B,
               MNR_TTL_LSS_RQST_DTL C
         WHERE A.TTL_LSS_NO = B.TTL_LSS_NO
           AND A.TTL_LSS_NO = C.TTL_LSS_NO
           AND A.TTL_LSS_DTL_SEQ = C.TTL_LSS_DTL_SEQ
           AND B.RQST_DT BETWEEN TO_DATE(@[from_dt], 'YYYY-MM-DD') AND TO_DATE(@[to_dt], 'YYYY-MM-DD')+0.99999  
         GROUP BY A.TTL_LSS_NO,
               B.TTL_LSS_CFM_DT,
               C.RQST_EQ_NO)
SELECT TL.LESSOR_CD,
       TL.LESSOR_NM,
       TL.EQ_TYPE,
       TL.EQ_NO,
       TL.INV_NO,
       TL.TTL_LSS_NO,
       TL.RQST_DT,
       TL.TTL_LSS_CFM_DT,
       TL.TTL_LSS_RSN_NM,
       TL.CMPL_FLG,
       TL.TLL_DT,
       ROUND(TL.DV_VALUE, 2) DV_VALUE,
       ROUND(CL.CLT_AMT, 2) CLT_AMT,
       TL.AGMT_NO
  FROM TOTAL_LOSS TL,
       COLLECTION CL
 WHERE 1=1
   AND TL.TTL_LSS_NO = CL.TTL_LSS_NO (+)
   AND TL.EQ_NO = CL.EQ_NO (+)			]]></sql>
			<params>
				<param name="from_dt" type="12" value="" out="N"/>
				<param name="to_dt" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
