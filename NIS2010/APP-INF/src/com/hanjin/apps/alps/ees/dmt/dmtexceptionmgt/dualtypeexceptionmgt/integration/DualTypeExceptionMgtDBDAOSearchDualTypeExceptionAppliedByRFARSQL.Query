<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="DualTypeExceptionMgtDBDAOSearchDualTypeExceptionAppliedByRFARSQL">
			<desc><![CDATA[Dual Type Exception 이 적용된 RFA 데이터를 조회하는 쿼리]]></desc>
			<sql><![CDATA[
SELECT	DISTINCT RP_HDR.RFA_NO
	,	RFA_TRF.PROP_NO
	,	RFA_TRF.RFA_EXPT_DAR_NO DAR_NO
	,	LPAD(RFA_TRF.RFA_EXPT_VER_SEQ, 3, '0') VER
	,	RFA_TRF.RFA_EXPT_APRO_NO APVL_NO
	,	CD_DTL.INTG_CD_VAL_DP_DESC STATUS
	,	TO_CHAR(RFA_TRF_DTL.EFF_DT, 'YYYY-MM-DD') EFF_DT
	,	TO_CHAR(RFA_TRF_DTL.EXP_DT, 'YYYY-MM-DD') EXP_DT
	,	SUBSTR(RFA_TRF_DTL.DMDT_TRF_CD, 3, 1) IO_BND_CD
	,	RFA_CVRG.CVRG_CNT_CD CNT_CD
	,	CASE 
			WHEN RFA_CVRG.CVRG_CNT_CD IN ('CA', 'US') 
				THEN RFA_CVRG.CVRG_STE_CD 
				ELSE RFA_CVRG.CVRG_RGN_CD
		END RGN_CD
	,	RFA_CVRG.CVRG_LOC_CD LOC_CD
	,	CASE 
			WHEN RFA_TRF_DTL.DMDT_CNTR_TP_CD IS NOT NULL AND RFA_TRF_DTL.DMDT_CGO_TP_CD IS NOT NULL
			THEN RFA_TRF_DTL.DMDT_CNTR_TP_CD || ':' || RFA_TRF_DTL.DMDT_CGO_TP_CD
			ELSE ''
		END DMDT_CNTR_CGO_TP_CD
	,	(
			SELECT	DECODE(DMDT_CALC_TP_CD, 'D', 'Dual', 'C', 'Combined', '')
			FROM	DMT_CALC_TP
			WHERE	IO_BND_CD = SUBSTR(RFA_TRF_DTL.DMDT_TRF_CD, 3, 1)
				AND	EXP_DT IS NULL
				AND	(
				        ( CNT_CD = RFA_CVRG.CVRG_CNT_CD AND RGN_CD = NVL(RFA_CVRG.CVRG_RGN_CD, ' ') AND STE_CD = NVL(RFA_CVRG.CVRG_STE_CD, ' ') AND LOC_CD = NVL(RFA_CVRG.CVRG_LOC_CD, ' ')	)
				        OR
				        ( CNT_CD = RFA_CVRG.CVRG_CNT_CD AND RGN_CD = NVL(RFA_CVRG.CVRG_RGN_CD, ' ') AND STE_CD = NVL(RFA_CVRG.CVRG_STE_CD, ' ')	)
				        OR
				        ( CNT_CD = RFA_CVRG.CVRG_CNT_CD	)
					)
				AND ROWNUM = 1
		) LOC_TP

FROM    PRI_RP_MN RP_MN
    ,   PRI_RP_HDR RP_HDR
    ,   DMT_RFA_EXPT_TRF RFA_TRF
	,	DMT_RFA_EXPT_TRF_DTL RFA_TRF_DTL
	,	DMT_RFA_EXPT_CVRG_CMB RFA_CVRG
	,	COM_INTG_CD_DTL CD_DTL

WHERE   RP_MN.CTRT_CUST_CNT_CD = SUBSTR(@[cust_cd], 0, 2)
    AND RP_MN.CTRT_CUST_SEQ = SUBSTR(@[cust_cd], 3)
	AND RP_MN.AMDT_SEQ =
		(
			SELECT	/*+	INDEX_DESC(PRI_RP_MN XPKPRI_RP_MN)*/ AMDT_SEQ
			FROM	PRI_RP_MN
			WHERE	PROP_NO = RP_MN.PROP_NO
				AND	ROWNUM = 1
		)
    AND RP_MN.PROP_NO = RP_HDR.PROP_NO
    AND RP_HDR.PROP_NO = RFA_TRF.PROP_NO
	AND RFA_TRF.DMDT_EXPT_RQST_STS_CD IN ('A', 'O', 'R')
	AND RFA_TRF.RFA_EXPT_DAR_NO = RFA_TRF_DTL.RFA_EXPT_DAR_NO
	AND RFA_TRF.RFA_EXPT_MAPG_SEQ = RFA_TRF_DTL.RFA_EXPT_MAPG_SEQ
	AND RFA_TRF.RFA_EXPT_VER_SEQ = RFA_TRF_DTL.RFA_EXPT_VER_SEQ
    AND RFA_TRF_DTL.EFF_DT >= TO_DATE(@[eff_dt], 'YYYY-MM-DD')
#if(${exp_dt} != '')
	AND RFA_TRF_DTL.EXP_DT <= TO_DATE(@[exp_dt], 'YYYY-MM-DD') + 0.999999
#end
#if(${io_bnd_cd} != '')
	AND SUBSTR(RFA_TRF_DTL.DMDT_TRF_CD, 3, 1) = @[io_bnd_cd]
#end
#if(${dmdt_cntr_cgo_tp_cd} != '')
	AND RFA_TRF_DTL.DMDT_CNTR_TP_CD = SUBSTR(@[dmdt_cntr_cgo_tp_cd], 0, 1)
	AND RFA_TRF_DTL.DMDT_CGO_TP_CD = SUBSTR(@[dmdt_cntr_cgo_tp_cd], 3)
#end
	AND	RFA_TRF_DTL.DMDT_TRF_CD LIKE 'C%'
	AND RFA_TRF_DTL.RFA_EXPT_DAR_NO = RFA_CVRG.RFA_EXPT_DAR_NO
	AND RFA_TRF_DTL.RFA_EXPT_MAPG_SEQ = RFA_CVRG.RFA_EXPT_MAPG_SEQ
	AND RFA_TRF_DTL.RFA_EXPT_VER_SEQ = RFA_CVRG.RFA_EXPT_VER_SEQ
	AND	RFA_TRF_DTL.RFA_RQST_DTL_SEQ = RFA_CVRG.RFA_RQST_DTL_SEQ
#if(${cnt_cd} != '')
	AND RFA_CVRG.CVRG_CNT_CD = @[cnt_cd]
#end
#if(${rgn_cd} != '')
	AND RFA_CVRG.CVRG_RGN_CD = @[rgn_cd]
	AND RFA_CVRG.CVRG_STE_CD = ' '
#end
#if(${ste_cd} != '')
	AND RFA_CVRG.CVRG_STE_CD = @[ste_cd]
	AND RFA_CVRG.CVRG_RGN_CD = ' '
#end
#if(${loc_cd} != '')
	AND RFA_CVRG.CVRG_LOC_CD = @[loc_cd]
#end

#if(${prop_no} != '')
	AND RP_HDR.PROP_NO = @[prop_no]
#end
    AND RFA_TRF.DMDT_EXPT_RQST_STS_CD = CD_DTL.INTG_CD_VAL_CTNT
    AND CD_DTL.INTG_CD_ID = 'CD02069'

ORDER BY RFA_NO, DAR_NO ASC, VER DESC, CNT_CD, RGN_CD, LOC_CD ASC			]]></sql>
			<params>
				<param name="cust_cd" type="12" value="" out="N"/>
				<param name="eff_dt" type="12" value="" out="N"/>
				<param name="exp_dt" type="12" value="" out="N"/>
				<param name="io_bnd_cd" type="12" value="" out="N"/>
				<param name="dmdt_cntr_cgo_tp_cd" type="12" value="" out="N"/>
				<param name="cnt_cd" type="12" value="" out="N"/>
				<param name="rgn_cd" type="12" value="" out="N"/>
				<param name="ste_cd" type="12" value="" out="N"/>
				<param name="loc_cd" type="12" value="" out="N"/>
				<param name="prop_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
