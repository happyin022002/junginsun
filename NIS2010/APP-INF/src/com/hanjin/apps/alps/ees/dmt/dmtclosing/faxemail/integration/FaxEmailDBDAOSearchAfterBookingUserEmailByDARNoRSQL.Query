<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="FaxEmailDBDAOSearchAfterBookingUserEmailByDARNoRSQL">
			<desc><![CDATA[승인시 After Booking DAR 을 요청한 사용자에게 메일을 보내기 위해서 메일정보를 조회하기 위한 쿼리]]></desc>
			<sql><![CDATA[
SELECT BKG_JOIN_FNC(CURSOR((

        SELECT C.USR_EML
        FROM DMT_AFT_BKG_APRO_PATH A, DMT_USR_ROLE_MTCH B, COM_USER C
        WHERE A.AFT_EXPT_DAR_NO = @[aft_expt_dar_no]
        AND A.AFT_BKG_PATH_LVL = (
                                SELECT MIN(AFT_BKG_PATH_LVL) 
                                FROM DMT_AFT_BKG_APRO_PATH
                                WHERE AFT_EXPT_DAR_NO = A.AFT_EXPT_DAR_NO
                                AND AFT_BKG_PATH_CPLS_FLG = 'Y'
                                AND DMDT_EXPT_RQST_STS_CD IS NULL )
        AND DECODE(A.APRO_OFC_CD,'SELHO',SUBSTR(A.APRO_OFC_CD,1,5),SUBSTR(C.OFC_CD,1,5)) = SUBSTR(A.APRO_OFC_CD,1,5)
        AND C.USR_ID = B.USR_ID
        AND C.USE_FLG = 'Y'
        AND CASE WHEN A.AFT_BKG_PATH_CD = 'SSZMGR' THEN 'DMT50'
                 WHEN A.AFT_BKG_PATH_CD = 'BBOPIC' THEN 'DMT30'
                 WHEN A.AFT_BKG_PATH_CD = 'BBGMGR' THEN 'DMT03'
                 WHEN A.AFT_BKG_PATH_CD = 'RHQPIC' THEN 'DMT02'
                 WHEN A.AFT_BKG_PATH_CD = 'RHQMGR' THEN 'DMT20'
                 WHEN A.AFT_BKG_PATH_CD = 'HDOPIC' THEN 'DMT01'
                 WHEN A.AFT_BKG_PATH_CD = 'HDOMGR' THEN 'DMT10'
                 ELSE '0' END = B.USR_ROLE_CD
		AND NOT EXISTS ( SELECT 'X' FROM DMT_AFT_BKG_ADJ_RQST WHERE AFT_EXPT_DAR_NO = A.AFT_EXPT_DAR_NO AND DMDT_EXPT_RQST_STS_CD IN ( 'O', 'J' ))

        UNION ALL

        SELECT	COM_USER.USR_EML
        FROM	DMT_AFT_BKG_ADJ_PROG ADJ_PROG
        	,	COM_USER
        WHERE	ADJ_PROG.AFT_EXPT_DAR_NO = @[aft_expt_dar_no]
        	AND	ADJ_PROG.PROG_SEQ >=
        		(
        			SELECT	/*+ INDEX_DESC(DMT_AFT_BKG_ADJ_PROG XPKDMT_AFT_BKG_ADJ_PROG) */ PROG_SEQ
        			FROM	DMT_AFT_BKG_ADJ_PROG
        			WHERE	AFT_EXPT_DAR_NO = ADJ_PROG.AFT_EXPT_DAR_NO
        				AND	DMDT_EXPT_RQST_STS_CD = 'R'
        				AND ROWNUM = 1
        		)		
        	AND	ADJ_PROG.PROG_USR_ID = COM_USER.USR_ID
        	AND ADJ_PROG.PROG_SEQ != 
        	   (
        			SELECT	/*+ INDEX_DESC(DMT_AFT_BKG_ADJ_PROG XPKDMT_AFT_BKG_ADJ_PROG) */ PROG_SEQ
        			FROM	DMT_AFT_BKG_ADJ_PROG
        			WHERE	AFT_EXPT_DAR_NO = ADJ_PROG.AFT_EXPT_DAR_NO
        				AND ROWNUM = 1
        		)	)),';')
  FROM DUAL			]]></sql>
			<params>
				<param name="aft_expt_dar_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
