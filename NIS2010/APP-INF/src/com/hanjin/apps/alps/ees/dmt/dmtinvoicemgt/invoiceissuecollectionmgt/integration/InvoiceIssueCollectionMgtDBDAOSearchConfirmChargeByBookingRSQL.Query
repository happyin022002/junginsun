<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="InvoiceIssueCollectionMgtDBDAOSearchConfirmChargeByBookingRSQL">
			<desc><![CDATA[Invoice Creation & Issue]]></desc>
			<sql><![CDATA[
select  BKG_NO
	   ,BL_NO
	   ,CNTR_CNT
	   ,'' 											as GB
	   ,CNTR_NO
	   ,OFC_CD
	   ,DMDT_TRF_CD
	   ,decode(ACT_CNT_CD,'00','',ACT_CNT_CD) 		as ACT_CNT_CD
	   ,decode(ACT_CUST_SEQ,0,'',ACT_CUST_SEQ) 		as ACT_CUST_SEQ
	   , ( 
           SELECT CASE WHEN (DMDT_TRF_CD IN ('DTIC', 'CTIC') AND SUBSTR(DEL_CD,1,2) = 'US' AND BB.DE_TERM_CD = 'Y')
                    OR (DMDT_TRF_CD IN ('DTOC', 'CTOC') AND SUBSTR(POR_CD,1,2) = 'US' AND BB.RCV_TERM_CD = 'Y')
                       		THEN AA.VNDR_SEQ
                       ELSE 
                              CASE WHEN SUBSTR(DMDT_TRF_CD,3,1) = 'I' AND SUBSTR(DEL_CD,1,2) IN ('US', 'CA') THEN
                                                         NVL(( SELECT CUST_CNT_CD||LPAD(CUST_SEQ,6,'0') 
                                                                 FROM BKG_CUSTOMER 
                                                                WHERE BKG_NO = BB.BKG_NO 
                                                                  AND BKG_CUST_TP_CD = 'C'
																  AND CUST_CNT_CD IS NOT NULL AND CUST_SEQ IS NOT NULL),
                                                             ( SELECT CUST_CNT_CD||LPAD(CUST_SEQ,6,'0')
                                                                 FROM BKG_CUSTOMER 
                                                                WHERE BKG_NO = BB.BKG_NO 
                                                                  AND BKG_CUST_TP_CD = 'N'))
                                   WHEN SUBSTR(DMDT_TRF_CD,3,1) = 'O' AND SUBSTR(POR_CD,1,2) IN ('US', 'CA') THEN
                                                             ( SELECT CUST_CNT_CD||LPAD(CUST_SEQ,6,'0') 
                                                                 FROM BKG_CUSTOMER 
                                                                WHERE BKG_NO = BB.BKG_NO 
                                                                  AND BKG_CUST_TP_CD = 'S')                                   
								   ELSE  NVL(
											   (SELECT ACT_CUST_CNT_CD || LPAD(ACT_CUST_SEQ, 6, '0')
													FROM INV_AR_MN AR
													WHERE BKG_NO = AA.BKG_NO
													AND IO_BND_CD = SUBSTR(DMDT_TRF_CD,3,1)
													AND AR_IF_NO = (SELECT MAX(AR_IF_NO)
																			FROM INV_AR_MN
																			WHERE BKG_NO = AA.BKG_NO
																			AND   IO_BND_CD = SUBSTR(DMDT_TRF_CD,3,1)
																	)
												), DECODE(CUST_CD,'00','',CUST_CD)
											)
                                   END
                   END
            FROM BKG_BOOKING BB WHERE BB.BKG_NO = AA.BKG_NO ) AS CUST_CD
	    ,(
           SELECT CASE WHEN (DMDT_TRF_CD IN ('DTIC', 'CTIC') AND SUBSTR(DEL_CD,1,2) = 'US' AND BB.DE_TERM_CD = 'Y')
                    OR (DMDT_TRF_CD IN ('DTOC', 'CTOC') AND SUBSTR(POR_CD,1,2) = 'US' AND BB.RCV_TERM_CD = 'Y')
                           THEN (SELECT	VNDR_LGL_ENG_NM FROM MDM_VENDOR WHERE VNDR_SEQ = AA.VNDR_SEQ AND ROWNUM = 1)
                       ELSE 
                              CASE WHEN SUBSTR(DMDT_TRF_CD,3,1) = 'I' AND SUBSTR(DEL_CD,1,2) IN ('US', 'CA') THEN
                                                         NVL(( SELECT CUST_LGL_ENG_NM
                                                                 FROM BKG_CUSTOMER A, MDM_CUSTOMER B
                                                                WHERE A.BKG_NO = BB.BKG_NO 
                                                                  AND A.BKG_CUST_TP_CD = 'C'
																  AND A.CUST_CNT_CD IS NOT NULL AND A.CUST_SEQ IS NOT NULL
                                                                  AND A.CUST_CNT_CD = B.CUST_CNT_CD
                                                                  AND A.CUST_SEQ = B.CUST_SEQ 
                                                                  AND ROWNUM = 1 ),
                                                             ( SELECT CUST_LGL_ENG_NM
                                                                 FROM BKG_CUSTOMER A, MDM_CUSTOMER B
                                                                WHERE A.BKG_NO = BB.BKG_NO 
                                                                  AND A.BKG_CUST_TP_CD = 'N'
                                                                  AND A.CUST_CNT_CD = B.CUST_CNT_CD
                                                                  AND A.CUST_SEQ = B.CUST_SEQ 
                                                                  AND ROWNUM = 1 ))
                                   WHEN SUBSTR(DMDT_TRF_CD,3,1) = 'O' AND SUBSTR(POR_CD,1,2) IN ('US', 'CA') THEN
                                                             ( SELECT CUST_LGL_ENG_NM
                                                                 FROM BKG_CUSTOMER A, MDM_CUSTOMER B
                                                                WHERE A.BKG_NO = BB.BKG_NO 
                                                                  AND A.BKG_CUST_TP_CD = 'S'
                                                                  AND A.CUST_CNT_CD = B.CUST_CNT_CD
                                                                  AND A.CUST_SEQ = B.CUST_SEQ 
                                                                  AND ROWNUM = 1 )
                                   ELSE NVL((SELECT CUST_LGL_ENG_NM 
                                            	FROM MDM_CUSTOMER
                                            	WHERE (CUST_SEQ, CUST_CNT_CD) = 
													(SELECT ACT_CUST_SEQ, ACT_CUST_CNT_CD
														FROM INV_AR_MN AR
														WHERE BKG_NO = BB.BKG_NO
														AND IO_BND_CD = SUBSTR(AA.DMDT_TRF_CD,3,1)
														AND AR_IF_NO = (SELECT MAX(AR_IF_NO)
																			FROM INV_AR_MN
																			WHERE BKG_NO = BB.BKG_NO
																			AND   IO_BND_CD = SUBSTR(AA.DMDT_TRF_CD,3,1)
																		)
                                                    )
												), CUST_NM)
                                   END
                   END
            FROM BKG_BOOKING BB WHERE BB.BKG_NO = AA.BKG_NO )CUST_NM
	   ,SC_NO
	   ,RFA_NO
	   ,TAA_NO
	   ,AR_CURR_CD
	   ,SUBSTR(VVD_CD,1,4) AS VSL_CD
	   ,SUBSTR(VVD_CD,5,4) AS SKD_VOY_NO
	   ,SUBSTR(VVD_CD,9,1) AS SKD_DIR_CD
	   ,POL_CD
	   ,POD_CD
	   ,POR_CD
	   ,DEL_CD
	   ,BZC_TRF_CURR_CD
	   ,ORG_CHG_AMT
	   ,SC_RFA_EXPT_AMT
	   ,AFT_EXPT_DC_AMT
	   ,BIL_AMT
	   ,CHG_CUST_CNT_CD
	   ,CHG_CUST_SEQ
	   ,'' 											as DMDT_CHG_LOC_DIV_CD
       ,DMDT_DELT_RQST_STS_CD
	   
  from  (
			select  A.BKG_NO
				   ,BB.BL_NO 							as BL_NO
				   ,count(A.CNTR_NO) 						as CNTR_CNT
				   ,'' 										as CNTR_NO
				   ,min(B.OFC_CD) 							as OFC_CD
				   ,min(B.DMDT_TRF_CD) 						as DMDT_TRF_CD
				   ,min(B.ACT_CNT_CD) 						as ACT_CNT_CD
				   ,min(B.ACT_CUST_SEQ) 					as ACT_CUST_SEQ
				   ,min(B.CUST_CNT_CD) 						as CHG_CUST_CNT_CD
				   ,min(B.CUST_SEQ) 						as CHG_CUST_SEQ
				   ,min(decode(B.ACT_CNT_CD, '00', '', B.ACT_CNT_CD) ||
				   	  decode(B.ACT_CUST_SEQ,  0, '', LPAD(B.ACT_CUST_SEQ, 6, '0'))
				   	  ) 							as CUST_CD
				   ,min(decode(B.ACT_CNT_CD, '00', (select VNDR_LGL_ENG_NM from MDM_VENDOR   where VNDR_SEQ = B.ACT_CUST_SEQ)
				   							     , (select CUST_LGL_ENG_NM from MDM_CUSTOMER where CUST_CNT_CD = B.ACT_CNT_CD and CUST_SEQ = B.ACT_CUST_SEQ)
						)
				   	) 										as CUST_NM
				   ,min(BB.SC_NO) 							as SC_NO
				   ,min(BB.RFA_NO) 							as RFA_NO
				   ,min(BB.TAA_NO) 							as TAA_NO
				   ,min(B.BZC_TRF_CURR_CD) 					as BZC_TRF_CURR_CD
				   ,sum(B.ORG_CHG_AMT) 						as ORG_CHG_AMT
				   ,sum(B.SC_RFA_EXPT_AMT) 					as SC_RFA_EXPT_AMT
				   ,sum(B.AFT_EXPT_DC_AMT) 					as AFT_EXPT_DC_AMT
				   ,sum(B.BIL_AMT) 							as BIL_AMT
				   ,case 
						when (select AR_OFC_CD from MDM_ORGANIZATION  where OFC_CD = @[ofc_cd]) in ('MTRBS', 'TORSC', 'VANSO') then 'USD'
						else (select AR_CURR_CD from MDM_ORGANIZATION where OFC_CD = @[ofc_cd])
				    end										as AR_CURR_CD

                   , MIN(DECODE(SUBSTR(B.DMDT_TRF_CD,3,1),'I',
                     ( SELECT /*+ ORDERED USE_NL( V K )
                                            INDEX    ( V XPKBKG_VVD )
                                            INDEX_DESC    ( K XPKVSK_VSL_PORT_SKD) */
                               V.VSL_CD||V.SKD_VOY_NO||V.SKD_DIR_CD
                          FROM BKG_VVD V
                              ,VSK_VSL_PORT_SKD K
                         WHERE V.BKG_NO = BB.BKG_NO
                           AND V.POD_CD = BB.POD_CD
                           AND (V.VSL_PRE_PST_CD, V.VSL_SEQ) =
                                  (SELECT /*+ INDEX_DESC( VV XPKBKG_VVD) */
                                          VV.VSL_PRE_PST_CD
                                         ,VV.VSL_SEQ
                                     FROM BKG_VVD VV
                                    WHERE VV.BKG_NO = V.BKG_NO
                                      AND VV.POD_CD = V.POD_CD
                                      AND ROWNUM = 1)
                           AND V.VSL_CD = K.VSL_CD(+)
                           AND V.SKD_VOY_NO = K.SKD_VOY_NO(+)
                           AND V.SKD_DIR_CD = K.SKD_DIR_CD(+)
                           AND V.POD_CD = K.VPS_PORT_CD(+)
                           AND V.POD_CLPT_IND_SEQ = K.CLPT_IND_SEQ(+)
                           AND NVL (K.SKD_CNG_STS_CD, ' ') != 'S'
                           AND ROWNUM = 1 )
                   , ( SELECT /*+ ORDERED USE_NL( V K )
                               INDEX    ( V XPKBKG_VVD )
                               INDEX_DESC    ( K XPKVSK_VSL_PORT_SKD) */
                           V.VSL_CD||V.SKD_VOY_NO||V.SKD_DIR_CD
                      FROM BKG_VVD V
                          ,VSK_VSL_PORT_SKD K
                     WHERE V.BKG_NO = BB.BKG_NO
                       AND V.POL_CD = BB.POL_CD
                       AND (V.VSL_PRE_PST_CD, V.VSL_SEQ) =
                              (SELECT /*+ INDEX( VV XPKBKG_VVD) */
                                      VV.VSL_PRE_PST_CD
                                     ,VV.VSL_SEQ
                                 FROM BKG_VVD VV
                                WHERE VV.BKG_NO = V.BKG_NO
                                  AND VV.POL_CD = V.POL_CD
                                  AND ROWNUM = 1)
                       AND V.VSL_CD = K.VSL_CD(+)
                       AND V.SKD_VOY_NO = K.SKD_VOY_NO(+)
                       AND V.SKD_DIR_CD = K.SKD_DIR_CD(+)
                       AND V.POL_CD = K.VPS_PORT_CD(+)
                       AND V.POL_CLPT_IND_SEQ = K.CLPT_IND_SEQ(+)
                       AND NVL (K.SKD_CNG_STS_CD, ' ') != 'S'
                       AND ROWNUM = 1 ))) AS VVD_CD

				   ,min(BB.POL_CD) 							as POL_CD
				   ,min(BB.POD_CD) 							as POD_CD
				   ,min(BB.POR_CD) 							as POR_CD
				   ,min(BB.DEL_CD) 							as DEL_CD

--				   ,max(nvl(R.DMDT_DELT_RQST_STS_CD,'N'))  	as DMDT_DELT_RQST_STS_CD
--                    ,MAX( NVL( ( SELECT MAX(DMDT_DELT_RQST_STS_CD)
--                              FROM DMT_CHG_DELT_RQST_APRO R
--                             WHERE 1=1
--                               and  B.CNTR_NO 		  = R.CNTR_NO
--                               and  B.CNTR_CYC_NO 	  = R.CNTR_CYC_NO
--                               and  B.SYS_AREA_GRP_ID = R.SYS_AREA_GRP_ID
--                               and  B.DMDT_TRF_CD     = R.DMDT_TRF_CD ) , 'N' )) AS DMDT_DELT_RQST_STS_CD
				   ,nvl(max((
				 	SELECT  CASE 
				 				WHEN NVL(MAX(DD.DMDT_DELT_RQST_STS_CD), 'N') IN ('C', 'N') THEN 'N'
				 				WHEN 0 < MAX((	
				 							SELECT  COUNT(1)
				 							  FROM  DMT_CHG_DELT_PATH
				 							 WHERE  SYS_AREA_GRP_ID     = DD.SYS_AREA_GRP_ID
				 							   AND  CNTR_NO             = DD.CNTR_NO
				 							   AND  CNTR_CYC_NO         = DD.CNTR_CYC_NO
				 							   AND  DMDT_TRF_CD         = DD.DMDT_TRF_CD
				 							   AND  DMDT_CHG_LOC_DIV_CD = DD.DMDT_CHG_LOC_DIV_CD
				 							   AND  CHG_SEQ             = DD.CHG_SEQ
				 							   AND  CHG_OFC_CD          = DD.CHG_OFC_CD
				 							   AND  DELT_SEQ            = DD.DELT_SEQ
				 							   AND  CHG_DELT_PATH_LVL  >=
				 									(
				 										SELECT  max(CHG_DELT_PATH_LVL)
				 										  FROM  DMT_CHG_DELT_PATH
				 										 WHERE  SYS_AREA_GRP_ID        = DD.SYS_AREA_GRP_ID
				 										   AND  CNTR_NO                = DD.CNTR_NO
				 										   AND  CNTR_CYC_NO            = DD.CNTR_CYC_NO
				 										   AND  DMDT_TRF_CD            = DD.DMDT_TRF_CD
				 										   AND  DMDT_CHG_LOC_DIV_CD    = DD.DMDT_CHG_LOC_DIV_CD
				 										   AND  CHG_SEQ                = DD.CHG_SEQ
				 										   AND  CHG_OFC_CD             = DD.CHG_OFC_CD
				 										   AND  DELT_SEQ               = DD.DELT_SEQ
				 										   AND  CHG_DELT_PATH_CPLS_FLG = 'Y'
				 									)
				 							   and  CHG_DELT_STS_CD IN ('A', 'J')
				 						 )) THEN 'X'		--// Charge Deletion 요청 불가, Charge Deletion Cancel 불가
				 				ELSE MAX(DD.DMDT_DELT_RQST_STS_CD)
				 			END
				 	  FROM  DMT_CHG_DELT_RQST_APRO DD
				 	 WHERE  DD.SYS_AREA_GRP_ID     = B.SYS_AREA_GRP_ID
				 	   AND	DD.CNTR_NO		       = B.CNTR_NO
				 	   AND	DD.CNTR_CYC_NO		   = B.CNTR_CYC_NO
				 	   AND	DD.DMDT_TRF_CD		   = B.DMDT_TRF_CD
				 	   AND	DD.DMDT_CHG_LOC_DIV_CD = B.DMDT_CHG_LOC_DIV_CD
				 	   AND	DD.CHG_SEQ			   = B.CHG_SEQ
				 	   AND  DD.CHG_OFC_CD          = B.OFC_CD
				 	   AND  DD.DELT_SEQ            = 
				 			( 
				 				SELECT  NVL(MAX(DS.DELT_SEQ), 0) 
				 				  FROM  DMT_CHG_DELT_RQST_APRO DS
				 				 WHERE  DS.SYS_AREA_GRP_ID     = DD.SYS_AREA_GRP_ID
				 				   AND  DS.CNTR_NO	           = DD.CNTR_NO
				 				   AND  DS.CNTR_CYC_NO	       = DD.CNTR_CYC_NO
				 				   AND  DS.DMDT_TRF_CD	       = DD.DMDT_TRF_CD
				 				   AND  DS.DMDT_CHG_LOC_DIV_CD = DD.DMDT_CHG_LOC_DIV_CD
				 				   AND  DS.CHG_SEQ		       = DD.CHG_SEQ
				 				   AND  DS.CHG_OFC_CD          = DD.CHG_OFC_CD  
				 			)  
				    )), 'N') AS DMDT_DELT_RQST_STS_CD
				   
				 	, MAX( ( SELECT	LPAD(VNDR_SEQ,6,'0') AS VNDR_CD
                               FROM	MDM_VENDOR
                              WHERE	VNDR_SEQ = B.VNDR_SEQ
                                AND	DELT_FLG <> 'Y' )) VNDR_SEQ	
			  from  DMT_CHG_BKG_CNTR 		A 
				   ,DMT_CHG_CALC 			B
				   ,BKG_BOOKING				BB

--########## Confirm 된 Charge 는 무조건 Invoice 생성 대상이 되어야 함.(Office Transfer 조건과는 무관) 2015.02.26 ##############################	   
			--	   ,COM_SYS_AREA_GRP_ID     C
--####################################################################################################################################

--				   ,DMT_CHG_DELT_RQST_APRO 	R
				   
			 where  A.SYS_AREA_GRP_ID = B.SYS_AREA_GRP_ID
               and  A.CNTR_NO         = B.CNTR_NO
			   and  A.CNTR_CYC_NO     = B.CNTR_CYC_NO
			   AND  A.BKG_NO          = BB.BKG_NO
--			   and  B.CNTR_NO 		  = R.CNTR_NO(+)
--			   and  B.CNTR_CYC_NO 	  = R.CNTR_CYC_NO(+)
--			   and  B.SYS_AREA_GRP_ID = R.SYS_AREA_GRP_ID(+)
--			   and  B.DMDT_TRF_CD     = R.DMDT_TRF_CD(+)

--########## Confirm 된 Charge 는 무조건 Invoice 생성 대상이 되어야 함.(Office Transfer 조건과는 무관) 2015.02.26 ##############################
--			   and  (							-- OFC_TRNS_FLG 상태에 따라 쿼리가 달라짐
--						(	B.OFC_TRNS_FLG = 'Y'
--							and C.SYS_AREA_GRP_ID = A.SYS_AREA_GRP_ID
--							and C.CNT_CD = (SELECT SUBSTR(LOC_CD,1,2) 
--											FROM MDM_ORGANIZATION 
--											WHERE OFC_CD = B.OFC_CD)
--							and CO_IND_CD = 'H'
--							and decode(B.OFC_TRNS_RHQ_CNG_FLG, 'Y', B.SYS_AREA_GRP_ID, A.SYS_AREA_GRP_ID)=B.SYS_AREA_GRP_ID
--						)
--						OR
--						(
--							B.OFC_TRNS_FLG = 'N'
--							and C.CNT_CD = (SELECT SUBSTR(LOC_CD,1,2) 
--											FROM MDM_ORGANIZATION 
--											WHERE OFC_CD = B.OFC_CD)
--							and CO_IND_CD = 'H'
--							and A.SYS_AREA_GRP_ID = B.SYS_AREA_GRP_ID       
--						)
--					)
--####################################################################################################################################

			and  B.OFC_CD 			= @[s_ofc_cd]
			and  B.DMDT_CHG_STS_CD 	= 'C'
			#if (${s_dmdt_trf_cd} != '')
			and B.DMDT_TRF_CD in 
				(
					#foreach( $dmdt_trf_no in ${dmdt_trf_cd_list}) 
						#if($velocityCount < $dmdt_trf_cd_list.size()) 
						   '$dmdt_trf_no', 
						#else 
						   '$dmdt_trf_no' 
						#end 
					#end
				)
			#end
			#if (${s_cont_type} == 'date') 
			and to_char(B.CFM_DT,'YYYYMMDD') between @[fm_cfm_dt] and @[to_cfm_dt]
			#elseif (${s_cont_type} == 'cntr') 
				#if (${s_bkg_no} != '')	
					and A.BKG_NO in 
						(
							#foreach( $bkg_cd in ${bkg_no_list} )
								#if($velocityCount < $bkg_no_list.size()) 
									'$bkg_cd', 
								#else 
									'$bkg_cd' 
								#end
							#end
						)
				#end
				#if (${s_bl_no} != '')	
					and A.BL_NO in 
						(
							#foreach( $bl_cd in ${bl_no_list} )
								#if($velocityCount < $bl_no_list.size()) 
									'$bl_cd', 
								#else 
									'$bl_cd' 
								#end
							#end
						)
				#end
				#if (${s_cntr_no} != '')	
					and A.CNTR_NO in 
						(
							#foreach( $cntr_cd in ${cntr_no_list} )
								#if($velocityCount < $cntr_no_list.size()) 
									'$cntr_cd', 
								#else 
									'$cntr_cd' 
								#end
							#end
						)
				#end
				#if (${s_fm_dt} != '' && ${s_to_dt} != '')					
					and to_char(B.CFM_DT,'YYYYMMDD') between REPLACE(@[s_fm_dt],'-','') and REPLACE(@[s_to_dt],'-','')
				#end
			#end
			#if (${s_chg_type} == 'G') 
			and B.CHG_SEQ = 1
			#elseif (${s_chg_type} == 'B') 
			and B.CHG_SEQ <> 1
			#end
			#if (${s_cust_cd} != '') 
				#if (${s_cust_gubun} == '1')
			and LPAD(B.ACT_CUST_SEQ,6,'0') = LPAD(@[s_cust_cd],6,'0')
				#elseif (${s_cust_gubun} == '2') 
			and B.ACT_CNT_CD = SUBSTR(@[s_cust_cd],1,2)
			and LPAD(B.ACT_CUST_SEQ,6,'0') = SUBSTR(@[s_cust_cd],3)
				#end
			#end
			#if (${s_sc_no} != '') 
			and A.SC_NO = @[s_sc_no]
			#end
			#if (${rfa_no} != '') 
			and A.RFA_NO = @[rfa_no]
			#end
		## 조건 추가(2010.01.12)
			and ((B.DUL_TP_EXPT_FLG= 'Y' and SUBSTR(B.DMDT_TRF_CD,1,1)  = 'C') or (B.DUL_TP_EXPT_FLG ='N'))
			group by A.BKG_NO, BB.BL_NO
		) AA
 where  AA.DMDT_DELT_RQST_STS_CD in ('N', 'X')	--// 삭제요청이 없었거나, 삭제요청이 있었을 경우에는 필수최종승인을 통해서 Charge 의 상태가 최종갱신된 경우의 건만 조회한다.
order by BKG_NO			]]></sql>
			<params>
				<param name="ofc_cd" type="12" value="" out="N"/>
				<param name="s_ofc_cd" type="12" value="" out="N"/>
				<param name="fm_cfm_dt" type="12" value="" out="N"/>
				<param name="to_cfm_dt" type="12" value="" out="N"/>
				<param name="s_fm_dt" type="12" value="" out="N"/>
				<param name="s_to_dt" type="12" value="" out="N"/>
				<param name="s_cust_cd" type="12" value="" out="N"/>
				<param name="s_sc_no" type="12" value="" out="N"/>
				<param name="rfa_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
