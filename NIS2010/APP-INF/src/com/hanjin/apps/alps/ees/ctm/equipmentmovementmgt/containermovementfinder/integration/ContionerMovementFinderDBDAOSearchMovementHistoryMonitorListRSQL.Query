<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ContionerMovementFinderDBDAOSearchMovementHistoryMonitorListRSQL">
			<desc><![CDATA[ContainerMovementHistoryMonitorList]]></desc>
			<sql><![CDATA[
SELECT ROWNUM AS SEQ
      ,CNTR_NO
      ,CNTR_TPSZ_CD
      ,CASE WHEN MODI_TP_FLG = 'I' THEN 'Insert'
            WHEN MODI_TP_FLG = 'U' THEN 'Update'
            WHEN MODI_TP_FLG = 'D' THEN 'Delete'
            ELSE '' END AS CORRECTION_TYPE
      ,CNMV_CYC_NO
      ,CNMV_CO_CD
      ,MVMT_STS_CD
      ,MVMT_CRE_TP_CD
      ,(SELECT MEOC.RCC_CD
        FROM   MDM_YARD MY
              ,MDM_LOCATION ML
              ,MDM_EQ_ORZ_CHT MEOC
        WHERE  ML.SCC_CD = MEOC.SCC_CD
        AND    MY.LOC_CD = ML.LOC_CD
        AND    ML.DELT_FLG <> 'Y'
        AND    MEOC.DELT_FLG <> 'Y'
        AND    MY.YD_CD = A.ORG_YD_CD
        AND    ROWNUM = 1) AS RCC_CD
      ,(SELECT MEOC.LCC_CD
        FROM   MDM_YARD MY
              ,MDM_LOCATION ML
              ,MDM_EQ_ORZ_CHT MEOC
        WHERE  ML.SCC_CD = MEOC.SCC_CD
        AND    MY.LOC_CD = ML.LOC_CD
        AND    ML.DELT_FLG <> 'Y'
        AND    MEOC.DELT_FLG <> 'Y'
        AND    MY.YD_CD = A.ORG_YD_CD
        AND    ROWNUM = 1) AS LCC_CD
      ,ORG_YD_CD
      ,DEST_YD_CD
      ,CNMV_EVNT_DT
      ,TRNK_VSL_CD || TRNK_SKD_VOY_NO || TRNK_SKD_DIR_CD AS VVD
      ,BKG_NO
      ,DECODE(FCNTR_FLG, 'Y', 'F', 'M') AS FCNTR_FLG
      ,DECODE(OB_CNTR_FLG, 'Y', 'O', 'I') AS OB_CNTR_FLG
      ,MVMT_EDI_MSG_TP_ID
      ,BKG_CGO_TP_CD
      ,CNTR_DMG_FLG 
      ,CNTR_DISP_FLG 
      ,IMDT_EXT_FLG 
      ,CNTR_RFUB_FLG 
      ,SPCL_CGO_FLG 
      ,NVL2(VNDR_SEQ, VNDR_SEQ || (SELECT VNDR_ABBR_NM FROM MDM_VENDOR WHERE VNDR_SEQ = A.VNDR_SEQ) ,'') AS SERVICE_PROVIDER
      ,VNDR_SEQ AS VNDR
      ,NVL2(VNDR_SEQ, (SELECT VNDR_ABBR_NM FROM MDM_VENDOR WHERE VNDR_SEQ = A.VNDR_SEQ) ,'') AS VNDR_ABBR_NM
      ,INP_DIV_FLG
      ,MVMT_TRSP_MOD_CD
      ,CHSS_NO
      ,MGST_NO
      ,CNTR_SEAL_NO
      ,WBL_NO
      ,PKUP_NO
      ,(SELECT INTG_CD_VAL_DESC FROM COM_INTG_CD_DTL WHERE INTG_CD_ID = 'CD03488' AND INTG_CD_VAL_CTNT = A.CNMV_CORR_RSN) AS CNMV_CORR_RSN
      ,ATCH_FILE_SAV_ID
      ,DECODE(NVL(ATCH_FILE_SAV_ID,''),'','N','Y') AS ATCH_FILE_SAV_YN
      ,UPD_LOCL_DT
      ,CRE_LOCL_DT
      ,UPD_DT
      ,CRE_DT
      ,OFC_CD
      ,USR_NM
      ,CNMV_RMK
      ,CASE WHEN (SELECT COUNT(CNTR_NO) AS CNT
                    FROM CTM_MVMT_MNL_HIS_COL 
                   WHERE CNTR_NO = A.CNTR_NO 
                     AND CNMV_YR = A.CNMV_YR 
                     AND CNMV_ID_NO = A.CNMV_ID_NO 
                     AND CNMV_HIS_SEQ = A.CNMV_HIS_SEQ) = 0
            THEN 'N' ELSE 'Y' END AS CNG_YN
      ,(SELECT NLS_LOWER(SUBSTR (XMLAGG (XMLELEMENT (B, ':', B.CNMV_COL_NM) ORDER BY B.CNMV_COL_NM).EXTRACT ('//text()'), 2)) AS CNMV_COL_NM
          FROM CTM_MVMT_MNL_HIS_COL B
         WHERE B.CNTR_NO = A.CNTR_NO 
           AND B.CNMV_YR = A.CNMV_YR 
           AND B.CNMV_ID_NO = A.CNMV_ID_NO 
           AND B.CNMV_HIS_SEQ = A.CNMV_HIS_SEQ
       ) AS CNMV_HIS_COL_NM
FROM CTM_MVMT_MNL_HIS A
WHERE 1 = 1
  AND DAT_DIV_FLG = 'T' -- 변경된 ROW만 보여 주기 위한 조건
#if ( ${divflag} == 1 )
	#if(${event_from_dt} != '')
  AND CNMV_EVNT_DT BETWEEN TO_DATE(@[event_from_dt], 'YYYY-MM-DD') AND TO_DATE(@[event_to_dt], 'YYYY-MM-DD') + 0.99999
	#end
#else
	#if(${upt_from_dt} != '')
  AND UPD_DT BETWEEN TO_DATE(@[upt_from_dt], 'YYYY-MM-DD') AND TO_DATE(@[upt_to_dt], 'YYYY-MM-DD') + 0.99999
	#end
#end

#if (${yard_cd1} == '')
  #if ((${lcc_cd} != '' && ${lcc_cd} != 'ALL') || (${rcc_cd} != '' && ${rcc_cd} != 'ALL'))
  AND ORG_YD_CD IN (SELECT YD_CD FROM MDM_YARD
                    WHERE LOC_CD IN (SELECT LOC_CD FROM MDM_LOCATION
                                     WHERE DELT_FLG <> 'Y'
                                       AND SCC_CD IN (SELECT SCC_CD FROM MDM_EQ_ORZ_CHT
                                                      WHERE DELT_FLG <> 'Y'
    #if (${lcc_cd} != '')
                                                        AND LCC_CD IN (${lcc_cd})
    #elseif (${rcc_cd} != '')
                                                        AND RCC_CD = @[rcc_cd]
    #end
                                                     )
                                    )
                   )
  #end
#else
  #if (${yard_cd2} != '' && ${yard_cd2} != 'ALL')
  AND ORG_YD_CD IN (${org_yd_cd})
  #else
  AND SUBSTR(ORG_YD_CD, 1, 5) = @[yard_cd1]
  #end
#end

#if(${cnmv_his_col_nm} != '')
  AND (CNTR_NO, CNMV_YR, CNMV_ID_NO, CNMV_HIS_SEQ) IN (SELECT CNTR_NO, CNMV_YR, CNMV_ID_NO, CNMV_HIS_SEQ
                                                       FROM CTM_MVMT_MNL_HIS_COL
                                                       WHERE 1 = 1
                                                         AND CNMV_COL_NM = @[cnmv_his_col_nm]
                                                      )
#end
#if(${cnmv_corr_rsn} != '')
  AND CNMV_CORR_RSN = @[cnmv_corr_rsn]
#end
#if(${atch_file_sav_id} != '')
	#if(${atch_file_sav_id} == 'Y')
  AND ATCH_FILE_SAV_ID IS NOT NULL
	#else
  AND ATCH_FILE_SAV_ID IS NULL
	#end
#end
#if(${correction_type} != '')
  AND MODI_TP_FLG = @[correction_type]
#end
  -- 2016.05.17 김상현 [CHM-201641462] Correction reason 컨테이너 list 기능 보완 (no highlighted)
  --  -'CNMV_SPLIT_NO'만 변경된 data는 보이지 않도록 조건 추가
  AND 'TRUE' = CASE WHEN A.MODI_TP_FLG = 'U' AND EXISTS(SELECT 1
                                                    FROM CTM_MVMT_MNL_HIS_COL
                                                    WHERE 1 = 1
                                                      AND CNTR_NO = A.CNTR_NO
                                                      AND CNMV_YR = A.CNMV_YR
                                                      AND CNMV_ID_NO = A.CNMV_ID_NO
                                                      AND CNMV_HIS_SEQ = A.CNMV_HIS_SEQ
                                                      AND CNMV_COL_NM <> 'CNMV_SPLIT_NO'
                                             )
                      THEN 'TRUE'
                    WHEN A.MODI_TP_FLG <> 'U' THEN 'TRUE'
                    ELSE 'FALSE'
               END
ORDER BY A.UPD_DT DESC			]]></sql>
			<params>
				<param name="event_from_dt" type="12" value="" out="N"/>
				<param name="event_to_dt" type="12" value="" out="N"/>
				<param name="upt_from_dt" type="12" value="" out="N"/>
				<param name="upt_to_dt" type="12" value="" out="N"/>
				<param name="rcc_cd" type="12" value="" out="N"/>
				<param name="yard_cd1" type="12" value="" out="N"/>
				<param name="cnmv_his_col_nm" type="12" value="" out="N"/>
				<param name="cnmv_corr_rsn" type="12" value="" out="N"/>
				<param name="correction_type" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
