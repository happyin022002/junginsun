<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ExpenseMgtDBDAOsearchPayableInvoiceListByWODataRSQL">
			<desc><![CDATA[ExpenseMgtDBDAOsearchPayableInvoiceListByWODataRSQL
-- 2014.11 10만불 결제관련]]></desc>
			<sql><![CDATA[
SELECT   OM.WO_NO
       , OM.WO_TYPE_CODE
       , OM.WO_TYPE
       , OM.VNDR_SEQ
       , OM.VNDR_LGL_ENG_NM
       , OM.COST_OFC_CD
       , OM.RCV_DT
       , OM.CRE_DT
       , OM.MNR_WRK_AMT
       , OM.SLS_TAX_AMT
       , OM.TTL_AMT
       , OM.PAY_TERM_DYS
       , OM.CURR_CD
       , OM.DP_PRCS_KNT
       , OM.FILE_SEQ
       , OM.CNT_CD
       , OM.IDA_TAX_DIV_CD
       , OM.IDA_SPCL_ECN_ZN_UT_FLG
       , OM.IDA_GST_RGST_NO_FLG
       , OM.IDA_GST_RGST_NO
       , OM.IDA_STE_CD
       , OM.IDA_STE_NM
       , (
           SELECT   SUM( ROUND( OD.COST_AMT * I.IDA_CGST_RTO / 100, 2 ) )
           FROM     MNR_ORD_DTL OD
                  , MNR_HRD_CDG_CTNT T
                  , TABLE( INV_GET_IDA_GST_RTO_FNC( INV_GET_GST_DIV_CD_FNC( OM.COST_OFC_CD, 'V', NULL, NULL, OM.VNDR_SEQ, NULL ) , T.ATTR_CTNT2 ) ) I
           WHERE    1 = 1
           AND      OD.COST_CD = T.ATTR_CTNT1
           AND      T.HRD_CDG_ID = 'MNR_INV_IDA'
           AND      OD.MNR_ORD_OFC_CTY_CD = OM.MNR_ORD_OFC_CTY_CD
           AND      OD.MNR_ORD_SEQ = OM.MNR_ORD_SEQ
         ) AS IDA_CGST_AMT
       , (
           SELECT   SUM( ROUND( OD.COST_AMT * I.IDA_SGST_RTO / 100, 2 ) )
           FROM     MNR_ORD_DTL OD
                  , MNR_HRD_CDG_CTNT T
                  , TABLE( INV_GET_IDA_GST_RTO_FNC( INV_GET_GST_DIV_CD_FNC( OM.COST_OFC_CD, 'V', NULL, NULL, OM.VNDR_SEQ, NULL ) , T.ATTR_CTNT2 ) ) I
           WHERE    1 = 1
           AND      OD.COST_CD = T.ATTR_CTNT1
           AND      T.HRD_CDG_ID = 'MNR_INV_IDA'
           AND      OD.MNR_ORD_OFC_CTY_CD = OM.MNR_ORD_OFC_CTY_CD
           AND      OD.MNR_ORD_SEQ = OM.MNR_ORD_SEQ
         ) AS IDA_SGST_AMT
       , (
           SELECT   SUM( ROUND( OD.COST_AMT * I.IDA_IGST_RTO / 100, 2 ) )
           FROM     MNR_ORD_DTL OD
                  , MNR_HRD_CDG_CTNT T
                  , TABLE( INV_GET_IDA_GST_RTO_FNC( INV_GET_GST_DIV_CD_FNC( OM.COST_OFC_CD, 'V', NULL, NULL, OM.VNDR_SEQ, NULL ) , T.ATTR_CTNT2 ) ) I
           WHERE    1 = 1
           AND      OD.COST_CD = T.ATTR_CTNT1
           AND      T.HRD_CDG_ID = 'MNR_INV_IDA'
           AND      OD.MNR_ORD_OFC_CTY_CD = OM.MNR_ORD_OFC_CTY_CD
           AND      OD.MNR_ORD_SEQ = OM.MNR_ORD_SEQ
         ) AS IDA_IGST_AMT
       , (
           SELECT   SUM( ROUND( OD.COST_AMT * I.IDA_UGST_RTO / 100, 2 ) )
           FROM     MNR_ORD_DTL OD
                  , MNR_HRD_CDG_CTNT T
                  , TABLE( INV_GET_IDA_GST_RTO_FNC( INV_GET_GST_DIV_CD_FNC( OM.COST_OFC_CD, 'V', NULL, NULL, OM.VNDR_SEQ, NULL ) , T.ATTR_CTNT2 ) ) I
           WHERE    1 = 1
           AND      OD.COST_CD = T.ATTR_CTNT1
           AND      T.HRD_CDG_ID = 'MNR_INV_IDA'
           AND      OD.MNR_ORD_OFC_CTY_CD = OM.MNR_ORD_OFC_CTY_CD
           AND      OD.MNR_ORD_SEQ = OM.MNR_ORD_SEQ
         ) AS IDA_UGST_AMT
FROM     (
           SELECT   A.MNR_ORD_OFC_CTY_CD || A.MNR_ORD_SEQ AS WO_NO
                  , A.MNR_ORD_OFC_CTY_CD
                  , A.MNR_ORD_SEQ
                  , A.MNR_WO_TP_CD AS WO_TYPE_CODE
                  , D.MNR_CD_DESC AS WO_TYPE
                  , MNR_COMMON_PKG.MNR_CONV_PARTNER_CD_FNC(A.VNDR_SEQ) AS VNDR_SEQ
                  , V.VNDR_LGL_ENG_NM
                  , A.COST_OFC_CD
                  , TO_CHAR(A.MNR_INP_DT , 'yyyy-mm-dd') AS RCV_DT
                  , TO_CHAR(GLOBALDATE_PKG.TIME_CONV_OFC_FNC(MNR_COMMON_PKG.MNR_GET_HOOFC_FNC(), A.CRE_DT, @[user_ofc_cd]), 'yyyy-mm-dd') AS CRE_DT
                  , A.MNR_WRK_AMT
                  , 0 AS SLS_TAX_AMT
                  , A.MNR_WRK_AMT AS TTL_AMT
                  , C.PAY_TERM_DYS
                  , C.CURR_CD
                  , E.DP_PRCS_KNT
                  , A.FILE_SEQ
                  , L.CNT_CD
                  , INV_GET_GST_DIV_CD_FNC( A.COST_OFC_CD, 'V', NULL, NULL, A.VNDR_SEQ, NULL ) AS IDA_TAX_DIV_CD
                  , V.IDA_SPCL_ECN_ZN_UT_FLG
                  , CASE WHEN V.IDA_GST_RGST_NO IS NULL THEN 'N' ELSE 'Y' END AS IDA_GST_RGST_NO_FLG
                  , V.IDA_GST_RGST_NO
                  , S.IDA_STE_CD
                  , S.STE_NM AS IDA_STE_NM
           FROM     MNR_ORD_HDR A
                  , MDM_VENDOR V
                  , MNR_AGMT_HDR C
                  , MNR_GEN_CD D
                  , MDM_CURRENCY E
                  , MDM_ORGANIZATION O
                  , MDM_LOCATION L
                  , MDM_STATE S
           WHERE    1 = 1
           AND      A.VNDR_SEQ = V.VNDR_SEQ(+)
           AND      A.AGMT_OFC_CTY_CD = C.AGMT_OFC_CTY_CD(+)
           AND      A.AGMT_SEQ = C.AGMT_SEQ(+)
           AND      A.AGMT_VER_NO = C.AGMT_VER_NO(+) 
           AND      A.MNR_WO_TP_CD = D.MNR_CD_ID(+)
           AND      C.CURR_CD = E.CURR_CD
           AND      A.COST_OFC_CD = O.OFC_CD
           AND      O.LOC_CD = L.LOC_CD
           AND      L.CNT_CD = S.CNT_CD(+)
           AND      L.STE_CD = S.STE_CD(+)
           AND      D.PRNT_CD_ID(+) = 'CD00020'
           
#if (${mnr_inv_sts_cd} != 'SS') 
           AND      A.COST_OFC_CD IN
                    (
                      SELECT   D.OFC_CD
                      FROM     MNR_OFC_GEN_INFO D
                      WHERE    1 = 1
                      AND      D.UPPR_OFC_CD = @[user_ofc_cd]
                      AND      D.MNR_GRP_TP_CD = 'OFC'
                      AND      D.COST_CD       = 'RPRINV'
    #if (${wo_ofc_cd} != 'ALL') 
                      AND      D.OFC_CD = @[wo_ofc_cd]
	#end
                      UNION ALL
                      SELECT   @[user_ofc_cd]
                      FROM     DUAL
                    )
#end

           AND      EXISTS
                    (
                      SELECT   'X'
                      FROM     MNR_ORD_DTL E             
                      WHERE    1 = 1
                      AND      A.MNR_ORD_OFC_CTY_CD = E.MNR_ORD_OFC_CTY_CD
                      AND      A.MNR_ORD_SEQ        = E.MNR_ORD_SEQ
                      AND      E.INV_NO IS NULL
                      AND      E.ACCT_CD <> '511591'
                      AND      ROWNUM = 1
                    )
         
#if (${woNos} != '')
           AND      A.MNR_ORD_SEQ IN
         (
    #foreach ($user_woNos IN ${woNos})
        #if($velocityCount < $woNos.size())
				$user_woNos,
        #else
				$user_woNos
        #end
    #end
	)
#else
           AND      A.UPD_DT BETWEEN ( SELECT GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd] , TO_DATE(@[from_dt] , 'YYYY-MM-DD'), MNR_COMMON_PKG.MNR_GET_HOOFC_FNC()) FROM DUAL )
                             AND     ( SELECT GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd] , TO_DATE(@[to_dt] ,   'YYYY-MM-DD'), MNR_COMMON_PKG.MNR_GET_HOOFC_FNC())+ 0.99999 FROM DUAL )
#end

#if (${vndr_seq} != '') 
           AND      A.VNDR_SEQ = @[vndr_seq]
#end

#if (${mnr_inv_sts_cd} == 'SS')
           AND      ( A.MNR_ORD_OFC_CTY_CD,A.MNR_ORD_SEQ ) NOT IN 
                    (
                      SELECT   B.MNR_ORD_OFC_CTY_CD
                             , B.MNR_ORD_SEQ 
                      FROM     MNR_PAY_INV_WRK A
                             , MNR_PAY_INV_TMP B 
                      WHERE    1 = 1
                      AND      A.PAY_INV_SEQ = B.PAY_INV_SEQ 
                      AND      A.ORD_VNDR_SEQ = TO_NUMBER(@[vndr_seq])
                      AND      A.MNR_INV_STS_CD IN ('SS','SR')
                    )
#end

         ) OM
WHERE    1 = 1			]]></sql>
			<params>
				<param name="user_ofc_cd" type="12" value="" out="N"/>
				<param name="wo_ofc_cd" type="12" value="" out="N"/>
				<param name="from_dt" type="12" value="" out="N"/>
				<param name="to_dt" type="12" value="" out="N"/>
				<param name="vndr_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
