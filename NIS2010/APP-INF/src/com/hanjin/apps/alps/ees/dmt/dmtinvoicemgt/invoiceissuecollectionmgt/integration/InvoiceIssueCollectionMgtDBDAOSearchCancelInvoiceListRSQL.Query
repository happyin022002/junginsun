<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="InvoiceIssueCollectionMgtDBDAOSearchCancelInvoiceListRSQL">
			<desc><![CDATA[InvoiceIssueCollectionMgtDBDAOSearchCancelInvoiceListRSQL]]></desc>
			<sql><![CDATA[
select  DMDT_INV_NO
	   ,CRE_OFC_CD
	   ,SUTH_CHN_ISS_FLG
	   ,'WAI'					as INTG_CD_VAL_CTNT
       ,(
 			select  INTG_CD_VAL_DP_DESC
			  from  COM_INTG_CD_DTL
			 where  INTG_CD_ID       = 'CD01962'
			   and  INTG_CD_VAL_CTNT = 'WAI'
			   and  APLY_ST_DT      <= to_char(sysdate, 'YYYYMMDD')
			   and  APLY_END_DT     >= to_char(sysdate, 'YYYYMMDD')
        )					as INTG_CD_VAL_DP_DESC
	   ,'Invoice nbr.' || DMDT_INV_NO || ' was cancelled automatically due to ' || decode(@[dmdt_expt_rqst_sts_cd], 'A', 'approval', 'J', 'reject', 'O', 'counter offer') || ' for After BKG DAR No. ' || @[aft_expt_dar_no] as CXL_RMK

  from  DMT_INV_MN
 where  DMDT_INV_NO in
		(
			select  T4.DMDT_INV_NO
			
			  from  DMT_AFT_BKG_ADJ_RQST  		T1
				   ,DMT_AFT_BKG_ADJ_RQST_DTL	T2
				   ,DMT_AFT_BKG_CNTR			T3
				   ,DMT_CHG_CALC				T4
				   
			 where  T1.AFT_EXPT_DAR_NO      =  @[aft_expt_dar_no]
			   and  T1.AFT_EXPT_DAR_NO      =  T2.AFT_EXPT_DAR_NO
			   and  T2.AFT_EXPT_DAR_NO      =  T3.AFT_EXPT_DAR_NO
			   and  T2.AFT_EXPT_ADJ_SEQ     =  T3.AFT_EXPT_ADJ_SEQ
			   and  T3.SYS_AREA_GRP_ID		= 'KOR'
			   and  T3.SYS_AREA_GRP_ID      =  T4.SYS_AREA_GRP_ID
			   and  T3.CNTR_NO              =  T4.CNTR_NO
			   and  T3.CNTR_CYC_NO          =  T4.CNTR_CYC_NO
			   and  T3.DMDT_TRF_CD          =  T4.DMDT_TRF_CD
			   and  T3.DMDT_CHG_LOC_DIV_CD  =  T4.DMDT_CHG_LOC_DIV_CD
			   and  T3.CHG_SEQ              =  T4.CHG_SEQ
		)
   and  DMDT_INV_STS_CD = 'I'			]]></sql>
			<params>
				<param name="dmdt_expt_rqst_sts_cd" type="12" value="" out="N"/>
				<param name="aft_expt_dar_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
