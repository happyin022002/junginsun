<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ChargeCalculationDBDAOSearchBookingInfoRSQL">
			<desc><![CDATA[ChargeCalculationDBDAOSearchBookingInfoRSQL]]></desc>
			<sql><![CDATA[
SELECT  NVL(
			( 
				SELECT  B.VSL_CD||B.SKD_VOY_NO||B.SKD_DIR_CD||'|'||DECODE(@[io_bnd_cd],'O',A.RCV_TERM_CD,A.DE_TERM_CD)
				  FROM  BKG_BOOKING A
				       ,BKG_VVD 	B
				 WHERE  1 = 1
				   AND  A.BKG_NO = @[bkg_no]
				   AND  A.BKG_NO = B.BKG_NO
				   AND  CASE WHEN @[io_bnd_cd] = 'O' THEN A.POl_CD ELSE A.POD_CD END = CASE WHEN @[io_bnd_cd] = 'O' THEN B.POl_CD ELSE B.POD_CD END
				   AND  ROWNUM = 1
			),' | '
		)||'|'||
		NVL(
			( 
				SELECT  DECODE(DMDT_INV_STS_CD,'I','Y','N') ||'|'||INV_CURR_CD ||'|'||INV_CHG_AMT
						||'|'||DECODE(ACT_PAYR_CNT_CD,'00','',ACT_PAYR_CNT_CD)||TRIM(TO_CHAR(ACT_PAYR_SEQ, '000000'))
						||'|'||
						(
							SELECT  CUST_LGL_ENG_NM 
							  FROM  MDM_CUSTOMER 
							 WHERE  CUST_CNT_CD = DECODE(A.ACT_PAYR_CNT_CD,'00','TB',A.ACT_PAYR_CNT_CD) 
							   AND  CUST_SEQ = A.ACT_PAYR_SEQ
						)
				  FROM  DMT_INV_MN A
				 WHERE  DMDT_INV_NO = @[dmdt_inv_no]
				   AND  ROWNUM = 1 
			),'E| | | | '
		)||'|'||
		NVL(
			( 
				SELECT  ( 
							SELECT  INTG_CD_VAL_DP_DESC 
							  FROM  COM_INTG_CD_DTL
							 WHERE  INTG_CD_ID = 'CD00588'
							   AND  INTG_CD_VAL_CTNT = C.OTS_STS_CD
						) ||'|'|| B.CURR_CD ||'|'|| B.INV_AMT
				  FROM  TPB_OTS_GRP_STS C
				       ,TPB_OTS_GRP 	B
				 WHERE  1 = 1
				   AND  C.OTS_STS_LST_FLG = 'Y'
				   AND  C.N3PTY_NO = @[tpb_no]
				   AND  B.N3PTY_NO = C.N3PTY_NO 
				   AND  B.N3PTY_DELT_TP_CD IN ('N','C','S') 
				   AND  ROWNUM = 1 
			),'E| | '
		)||'|'||
		NVL(
			( 
				SELECT  DECODE(SOC_FLG,'Y','Yes','No')
				  FROM  BKG_CONTAINER 
				 WHERE  1 = 1
				   AND  BKG_NO = @[bkg_no]
				   AND  CNTR_NO = @[cntr_no]
				   AND  ROWNUM = 1
			),
			(
				SELECT  DECODE(SOC_FLG,'Y','Yes','No')
				  FROM  DMT_CHG_BKG_CNTR
				 WHERE  BKG_NO = @[bkg_no]
				   AND  CNTR_NO = @[cntr_no]
                   AND  ROWNUM = 1				   
			)
		)||'|'||
		NVL(
			(             
				SELECT  CHG_CD||'|'||'USD'||'|'||
						TO_CHAR(SUM(
									(
										SELECT  ROUND( AA.CHG_AMT / F.USD_LOCL_XCH_RT , 2 )
										  FROM  GL_MON_XCH_RT F
										 WHERE  1 = 1
										   AND  F.ACCT_XCH_RT_YRMON = TO_CHAR(SYSDATE, 'YYYYMM')
										   AND  F.ACCT_XCH_RT_LVL = '1'
										   AND  F.CURR_CD = AA.CURR_CD 
									)
								)
						) CHG_AMT
				  FROM  (
							SELECT  BKG_JOIN_FNC(CURSOR(
														(
															SELECT  C.CHG_CD
															  FROM  INV_AR_MN 	M 
																   ,INV_AR_CHG 	C
															 WHERE  M.AR_IF_NO = C.AR_IF_NO
															   AND  M.BKG_NO = @[bkg_no]
															   AND  C.CHG_CD IN ('DMR','DTC','CDD')
															   AND  (M.REV_TP_CD IN ('B','C') OR (M.REV_TP_CD = 'M' AND M.REV_SRC_CD NOT IN ('DM','DT','CD')))
															GROUP BY C.CHG_CD
														)
												)
									) AS CHG_CD
								   ,CURR_CD
								   ,SUM(CHG_AMT) AS CHG_AMT
							  FROM  INV_AR_MN 	M
							       ,INV_AR_CHG 	C
							 WHERE  M.AR_IF_NO = C.AR_IF_NO
							   AND  M.BKG_NO = @[bkg_no]
							   AND  C.CHG_CD IN ('DMR','DTC','CDD')
							   AND  (M.REV_TP_CD IN ('B','C') OR (M.REV_TP_CD = 'M' AND M.REV_SRC_CD NOT IN ('DM','DT','CD')))
							GROUP BY CURR_CD
						) AA
				GROUP BY CHG_CD
			),' |E| '
		)||'|'||
		NVL(
			(
				SELECT  'Y' 
				  FROM  VSK_VSL_PORT_SKD
				 WHERE  VSL_CD = SUBSTR(@[vvd_cd], 1, 4)
				   AND  SKD_VOY_NO = SUBSTR(@[vvd_cd], 5, 4)
				   AND  SKD_DIR_CD = SUBSTR(@[vvd_cd], 9)
				   AND  ROWNUM = 1 
			), 'N'
		)||'|'||
		NVL(
			(
				SELECT  CURR_CD 
				  FROM  MDM_CURRENCY
				 WHERE  DELT_FLG = 'N'
				   AND  CURR_CD = @[curr_cd]
				   AND  ROWNUM = 1
			),'E'
		)||'|'||
		NVL(
			(
				SELECT  MTY_PKUP_YD_CD||'|'||SVC_SCP_CD 
				  FROM  BKG_BOOKING
				 WHERE  1 = 1
				   AND  BKG_NO = @[bkg_no]
				   AND  ROWNUM = 1
			),'E|E'
		)||'|'||
		NVL(
			( 
				SELECT  CHG_CD || '|' || SUM(CHG_AMT) 
				  FROM  BKG_CHG_RT
				 WHERE  BKG_NO = @[bkg_no]
				   AND  CURR_CD = @[curr_cd]
				   AND  CHG_CD = 'SRC'
				GROUP BY CHG_CD
			),'E|E'
		)||'|'||
		NVL(
			( 
				SELECT  NVL(TAA_NO, NVL(RFA_NO, SC_NO))||'|'||
						SUBSTR(BB.PRI, INSTR(BB .PRI, ',', 1, 1)+1, INSTR(BB .PRI, ',', 1, 2)-INSTR(BB .PRI, ',', 1, 1)-1)||'|'||
						SUBSTR(BB.PRI, INSTR(BB .PRI, ',', 1, 2)+1)
				  FROM  (
							SELECT  DISTINCT A.* 
								   ,CASE
										WHEN A.CONTRACT_TYPE = 'SC' 
											THEN
												(
													SELECT  MN.PROP_OFC_CD||','||
															CASE 
																WHEN REAL_CUST_CNT_CD||TRIM(TO_CHAR(REAL_CUST_SEQ, '000000')) IS NULL THEN 
																		PTY.CUST_CNT_CD||TRIM(TO_CHAR(PTY.CUST_SEQ, '000000'))
															ELSE REAL_CUST_CNT_CD||TRIM(TO_CHAR(REAL_CUST_SEQ, '000000'))
															END ||','||
															CASE
																WHEN REAL_CUST_CNT_CD||TRIM(TO_CHAR(REAL_CUST_SEQ, '000000')) IS NULL THEN A.CUST_LGL_ENG_NM
															ELSE R.CUST_LGL_ENG_NM
															END
													  FROM  PRI_SP_HDR 		HDR
													       ,PRI_SP_MN 		MN
														   ,PRI_SP_CTRT_PTY PTY
														   ,MDM_CUSTOMER 	R
														   ,MDM_CUSTOMER 	A
													 WHERE  1 = 1
													   AND  A.SC_NO = HDR.SC_NO
													   AND  HDR.PROP_NO = MN.PROP_NO
													   AND  MN.PROP_STS_CD ='F'
													   AND  MN.AMDT_SEQ = 
															(
																SELECT  MAX(AMDT_SEQ)
																  FROM  PRI_SP_MN
																 WHERE  1 = 1
																   AND  PROP_NO = MN.PROP_NO
																   AND  PROP_STS_CD = MN.PROP_STS_CD
															)
													   AND  PTY.PROP_NO = MN.PROP_NO
													   AND  PTY.AMDT_SEQ = MN.AMDT_SEQ
													   AND  PTY.PRC_CTRT_PTY_TP_CD = 'C'
													   AND  REAL_CUST_CNT_CD = R.CUST_CNT_CD(+)
													   AND  REAL_CUST_SEQ = R.CUST_SEQ (+)
													   AND  PTY.CUST_CNT_CD = A.CUST_CNT_CD(+)
													   AND  PTY.CUST_SEQ = A.CUST_SEQ(+) 
												)
										WHEN A.CONTRACT_TYPE = 'RFA' 
											THEN
												(
													SELECT  MN.PROP_OFC_CD ||','|| MN.CTRT_CUST_CNT_CD||TRIM(TO_CHAR(MN.CTRT_CUST_SEQ, '000000'))||','|| REPLACE(REPLACE(R.CUST_LGL_ENG_NM, CHR(13)||CHR(10), ' '), CHR(9), ' ')
													  FROM  PRI_RP_HDR 		HDR
													       ,PRI_RP_MN 		MN
														   ,MDM_CUSTOMER 	R
													 WHERE  1 = 1
													   AND  HDR.RFA_NO = A.RFA_NO
													   AND  HDR.PROP_NO = MN.PROP_NO
													   AND  MN.PROP_STS_CD = 'A'
													   AND  MN.AMDT_SEQ = 
															(
																SELECT  MAX(AMDT_SEQ)
																  FROM  PRI_RP_MN
																 WHERE  1 = 1
																   AND  PROP_NO = MN.PROP_NO
																   AND  PROP_STS_CD = MN.PROP_STS_CD 
															)
													   AND  MN.CTRT_CUST_CNT_CD = R.CUST_CNT_CD(+)
													   AND  MN.CTRT_CUST_SEQ = R.CUST_SEQ(+) 
												)
										WHEN A.CONTRACT_TYPE = 'TAA' 
											THEN 
												(
													SELECT  MN.RESPB_SLS_OFC_CD||','|| MN.CTRT_CUST_CNT_CD||TRIM(TO_CHAR(MN.CTRT_CUST_SEQ, '000000')) ||','|| REPLACE(REPLACE(R.CUST_LGL_ENG_NM, CHR(13)||CHR(10), ' '), CHR(9), ' ')
													  FROM  PRI_TAA_HDR 	HDR
													       ,PRI_TAA_MN 		MN
														   ,MDM_CUSTOMER 	R
													 WHERE  1 = 1
													   AND  HDR.TAA_NO = A.TAA_NO
													   AND  HDR.TAA_PROP_NO = MN.TAA_PROP_NO
													   AND  MN.CFM_FLG = 'Y'
													   AND  MN.AMDT_SEQ = 
															(
																SELECT  MAX(AMDT_SEQ)
																  FROM  PRI_TAA_MN
																 WHERE  1=1
																   AND  TAA_PROP_NO = MN.TAA_PROP_NO
																   AND  CFM_FLG = MN.CFM_FLG
															)
													   AND  MN.CTRT_CUST_CNT_CD = R.CUST_CNT_CD(+)
													   AND  MN.CTRT_CUST_SEQ = R.CUST_SEQ(+) 
												)
										ELSE 'AAA'
									END PRI
							  FROM  (
										SELECT  CASE 
													WHEN SUBSTR(BK.RFA_NO, 1, 3) != 'DUM' AND BK.RFA_NO IS NOT NULL THEN 'RFA'
													WHEN SUBSTR(BK.TAA_NO, 1, 3) != 'DUM' AND BK.TAA_NO IS NOT NULL THEN 'TAA'
													WHEN SUBSTR(BK.SC_NO, 1, 3)  != 'DUM' AND BK.SC_NO  IS NOT NULL THEN 'SC'
													ELSE 'AAA'
												END AS CONTRACT_TYPE 
											   ,BK.RFA_NO
											   ,BK.TAA_NO
											   ,BK.SC_NO
										  FROM  BKG_BOOKING BK
										 WHERE  BKG_NO = @[bkg_no] 
									) A 
						) BB 
			),'E|E|E'
		)||'|' AS rtnValue
FROM DUAL			]]></sql>
			<params>
				<param name="io_bnd_cd" type="12" value="" out="N"/>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="dmdt_inv_no" type="12" value="" out="N"/>
				<param name="tpb_no" type="12" value="" out="N"/>
				<param name="cntr_no" type="12" value="" out="N"/>
				<param name="vvd_cd" type="12" value="" out="N"/>
				<param name="curr_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
