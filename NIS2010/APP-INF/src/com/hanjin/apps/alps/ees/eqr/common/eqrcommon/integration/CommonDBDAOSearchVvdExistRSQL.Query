<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CommonDBDAOSearchVvdExistRSQL">
			<desc><![CDATA[vvd, lane 정보를 검색(execute plan INLAND WATER(080) 에서 사용)]]></desc>
			<sql><![CDATA[
#if(${division} == 'etd')
    SELECT 
        A.VVD       																					
	    ,A.SLAN_CD   																					
	    ,B.VSL_DT 																						
	FROM      																								
	(																										
	    SELECT 
	        VSL_CD||SKD_VOY_NO||SKD_DIR_CD VVD  														
	        ,VSL_SLAN_CD SLAN_CD    																					
	    FROM 
	        VSK_VSL_SKD   								            									
	    WHERE 
    	    VSL_CD     = @[vsl_cd]																				
    	    AND   SKD_VOY_NO = @[skd_voy_no]																				
    	    AND   SKD_DIR_CD = @[skd_dir_cd]									  																	
	) A,																												
	(																										
	
--	    SELECT VSL_CD||SKD_VOY_NO||SKD_DIR_CD VVD 																
--			          ,SLAN_CD																									
--			          ,TO_CHAR(VPS_ETD_DT, 'YYYY-MM-DD', 'NLS_DATE_LANGUAGE=AMERICAN')  VSL_DT  --VSL_ETD_DT   				
--			    FROM VSK_VSL_PORT_SKD     																				
--			    WHERE VSL_CD     = ?																				
--			    AND   SKD_VOY_NO = ?																				
--			    AND   SKD_DIR_CD = ?									  																	
--			    AND   VPS_PORT_CD= ?                                                                   			
--			    AND   TO_CHAR(VPS_ETD_DT ,'YYYYMMDD') >= (SELECT WK_ST_DT FROM EQR_WK_PRD WHERE PLN_YR || PLN_WK = ? ) 
	
	    SELECT 
	        A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD VVD    													
	      	,A.SLAN_CD																					   			
		    ,TO_CHAR(A.VPS_ETD_DT, 'YYYY-MM-DD')  VSL_DT  --VPS_ETD_DT												
		 FROM      																								
		 (																									
			 SELECT 
			    VSL_CD																					
		    	,SKD_VOY_NO								  																		
		        ,SKD_DIR_CD                                         										
	            ,SLAN_CD       																			
	            ,VPS_ETD_DT       																		
	            ,CLPT_IND_SEQ       																		
		    FROM 
		        VSK_VSL_PORT_SKD  																			
		    WHERE 
    		    VSL_CD     = @[vsl_cd]										 																				
    	 	    AND   SKD_VOY_NO = @[skd_voy_no]										 																				
    		    AND   SKD_DIR_CD = @[skd_dir_cd]									  	 																				
    		    AND   VPS_PORT_CD= @[ecc_cd]                                           									 
	-- modified by shin yongchan - 20080326
	-- plan year week 안에 들어오는 ETD만 검색하는 방식으로 변경 
	-- CSR NO : N200803260007
	--	    AND   TO_CHAR(VPS_ETD_DT ,'YYYYMMDD') >= (SELECT WK_ST_DT FROM EQR_WK_PRD WHERE PLN_YR || PLN_WK = ? ) 
		        AND   TO_CHAR(VPS_ETD_DT ,'YYYYMMDD') 
					BETWEEN (
							SELECT WK_ST_DT FROM EQR_WK_PRD WHERE PLN_YR || PLN_WK = @[pln_yrwk]
							) 
					AND 	(
							SELECT WK_END_DT FROM EQR_WK_PRD WHERE PLN_YR || PLN_WK = @[pln_yrwk] 
							) 
		 ) A    																							
		 WHERE 
		    ROWNUM=1  																					
		 ORDER BY A.CLPT_IND_SEQ DESC    																			
	) B																									
	WHERE A.VVD = B.VVD(+)                                                                                 
	AND   A.SLAN_CD = B.SLAN_CD(+)																			
	
#else  -- eta (단 1개만 조회되어야 함)
	SELECT
	    A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD VVD    														
	    ,A.SLAN_CD																					    			
	    ,TO_CHAR(A.VPS_ETA_DT, 'YYYY-MM-DD')  VSL_DT  --VSL_ETA_DT													
	FROM      																									
	(																										
        SELECT 
	        VSL_CD																						
		    ,SKD_VOY_NO								  																			
	        ,SKD_DIR_CD                                         											
	        ,SLAN_CD       																				
	        ,VPS_ETA_DT       																			
	        ,CLPT_IND_SEQ       																			
        FROM 
	        VSK_VSL_PORT_SKD  																				
	    WHERE 
            VSL_CD     = @[vsl_cd]										 																					
            AND   SKD_VOY_NO = @[skd_voy_no]										 																					
            AND   SKD_DIR_CD = @[skd_dir_cd]									  	 																					
            AND   VPS_PORT_CD= @[ecc_cd]                                           										
            AND TO_CHAR(VPS_ETA_DT ,'YYYYMMDD') >= TO_CHAR(TO_DATE( @[pln_yrwk] , 'YYYY-MM-DD') ,'YYYYMMDD')     			
	) A    																								
	WHERE ROWNUM=1  																						
	-- modified by shin yongchan - 20080327
	-- CLPT_IND_SEQ 가장 작은것 부터 ETA로 취급하는것으로 변경 
	-- DESC ==>ASC
	-- CSR NO : N200803260007
	--ORDER BY A.CLPT_IND_SEQ DESC    																					
	ORDER BY A.CLPT_IND_SEQ ASC    																		
#end			]]></sql>
			<params>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="ecc_cd" type="12" value="" out="N"/>
				<param name="pln_yrwk" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
