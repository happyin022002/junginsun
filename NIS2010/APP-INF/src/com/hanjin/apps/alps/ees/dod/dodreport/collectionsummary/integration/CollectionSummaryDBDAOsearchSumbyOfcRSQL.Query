<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CollectionSummaryDBDAOsearchSumbyOfcRSQL">
			<desc><![CDATA[Summary by Office 조회]]></desc>
			<sql><![CDATA[
SELECT A.*
FROM
(  
SELECT  /*+ opt_param('_optimizer_cost_based_transformation','off') bypass_ujvc */
	   A.TRO_IB_CFM_OFC_CD,
       A.LOC_CD,
       A.CNTR_TPSZ_CD,

	   #if(${s_curr_cd} == 'LOCAL')
		   A.CURR_CD
	   #else
	   	   @[s_curr_cd] CURR_CD
	   #end
       
	   ,SUM(A.GEN_TRF_CNTR) GEN_TRF_CNTR,
       SUM(A.GEN_TRF_AMT) GEN_TRF_AMT,
       SUM(A.SPC_TRF_CNTR) SPC_TRF_CNTR,
       SUM(A.SPC_TRF_AMT) SPC_TRF_AMT,
       SUM(A.ADJ_CNTR) ADJ_CNTR,
       SUM(A.ADJ_AMT) ADJ_AMT,

       #if(${s_ar_if_yn} == 'N')
         0 INV_CNTR,
         0 INV_AMT,
       #end
       #if(${s_ar_if_yn} != 'N')
          SUM(A.INV_CNTR) INV_CNTR,
          SUM(A.INV_AMT) INV_AMT,
       #end
   
       SUM(DECODE(A.PEN_SPC_AMT, NULL, DECODE(A.PEN_GEN_AMT, NULL, 0, 1), 1)) PEN_CNTR,     
       SUM(DECODE(A.PEN_SPC_AMT, NULL, A.PEN_GEN_AMT, A.PEN_SPC_AMT))  PEN_AMT,

       SUM(A.INV_CNTR2) INV_CNTR2

FROM
(
    SELECT E.CFM_OFC_CD  TRO_IB_CFM_OFC_CD
           , SUBSTR(E.CNTR_RTN_YD_CD, 1, 5) LOC_CD
           , E.CNTR_TPSZ_CD
           , E.CURR_CD
       
         #if(${s_ar_if_yn} == 'A') 
          , (SELECT DECODE(NVL(G.DRP_OFF_CHG_TRF_SEQ, 0), 0, 0, 1)
                FROM DOD_DRP_OFF_CHG G
               WHERE G.BKG_NO = E.BKG_NO
                 AND G.CNTR_NO = E.CNTR_NO
                 AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                        FROM DOD_DRP_OFF_CHG C
                       WHERE C.BKG_NO = G.BKG_NO
                         AND C.CNTR_NO = G.CNTR_NO) ) GEN_TRF_CNTR
         #end
         #if(${s_ar_if_yn} == 'Y') 
          , (SELECT DECODE(NVL(G.DRP_OFF_CHG_TRF_SEQ, 0), 0, 0, 1)
                FROM DOD_DRP_OFF_CHG G
               WHERE G.BKG_NO = E.BKG_NO
                 AND G.CNTR_NO = E.CNTR_NO
                 AND G.AR_IF_NO IS NOT NULL
                 AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                        FROM DOD_DRP_OFF_CHG C
                       WHERE C.BKG_NO = G.BKG_NO
                         AND C.CNTR_NO = G.CNTR_NO) ) GEN_TRF_CNTR

         #end
         #if(${s_ar_if_yn} == 'N') 
          , (SELECT DECODE(NVL(G.DRP_OFF_CHG_TRF_SEQ, 0), 0, 0, 1)
                FROM DOD_DRP_OFF_CHG G
               WHERE G.BKG_NO = E.BKG_NO
                 AND G.CNTR_NO = E.CNTR_NO
                 AND G.AR_IF_NO IS NULL
                 AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                        FROM DOD_DRP_OFF_CHG C
                       WHERE C.BKG_NO = G.BKG_NO
                         AND C.CNTR_NO = G.CNTR_NO) ) GEN_TRF_CNTR

         #end
                         
           , (SELECT CASE WHEN DECODE(G.DRP_OFF_CHG_TRF_SPCL_SEQ, NULL, G.GEN_TRF_AMT, 0) > 0 THEN 
			
		    --G.GEN_TRF_AMT 
			-- Currency Convert
			
			#if(${s_curr_cd} == 'LOCAL')
				ROUND( G.GEN_TRF_AMT,2 )
			#else
    	        ROUND( MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC( TO_CHAR(G.TRO_IB_CFM_DT , 'YYYYMM') , G.CURR_CD, @[s_curr_cd] , G.GEN_TRF_AMT), 2 )
			#end

             #if(${s_ar_if_yn} == 'A') 

				 WHEN DECODE(G.DRP_OFF_CHG_TRF_SPCL_SEQ, NULL, G.GEN_TRF_AMT, 0) < 0 THEN 0
                          ELSE 0
                          END END
                FROM DOD_DRP_OFF_CHG G
               WHERE G.BKG_NO = E.BKG_NO
                 AND G.CNTR_NO = E.CNTR_NO
                 AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                        FROM DOD_DRP_OFF_CHG C
                       WHERE C.BKG_NO = G.BKG_NO
                         AND C.CNTR_NO = G.CNTR_NO) ) GEN_TRF_AMT
            #end
            #if(${s_ar_if_yn} == 'N') 
               WHEN DECODE(G.DRP_OFF_CHG_TRF_SPCL_SEQ, NULL, G.GEN_TRF_AMT, 0) < 0 THEN 0
                          ELSE 0
                          END END
                FROM DOD_DRP_OFF_CHG G
               WHERE G.BKG_NO = E.BKG_NO
                 AND G.CNTR_NO = E.CNTR_NO
                 AND G.AR_IF_NO IS NULL
                 AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                        FROM DOD_DRP_OFF_CHG C
                       WHERE C.BKG_NO = G.BKG_NO
                         AND C.CNTR_NO = G.CNTR_NO) ) GEN_TRF_AMT
            #end
           #if(${s_ar_if_yn} == 'Y') 
               WHEN DECODE(G.DRP_OFF_CHG_TRF_SPCL_SEQ, NULL, G.GEN_TRF_AMT, 0) < 0 THEN 0
                          ELSE 0
                          END END
                FROM DOD_DRP_OFF_CHG G
               WHERE G.BKG_NO = E.BKG_NO
                 AND G.CNTR_NO = E.CNTR_NO
                 AND G.AR_IF_NO IS NOT NULL
                 AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                        FROM DOD_DRP_OFF_CHG C
                       WHERE C.BKG_NO = G.BKG_NO
                         AND C.CNTR_NO = G.CNTR_NO) ) GEN_TRF_AMT
            #end
                 
         #if(${s_ar_if_yn} == 'A')            
           , (SELECT DECODE(NVL(G.DRP_OFF_CHG_TRF_SPCL_SEQ, 0), 0, 0, 1)
                FROM DOD_DRP_OFF_CHG G
               WHERE G.BKG_NO = E.BKG_NO
                 AND G.CNTR_NO = E.CNTR_NO
                 AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                        FROM DOD_DRP_OFF_CHG C
                       WHERE C.BKG_NO = G.BKG_NO
                         AND C.CNTR_NO = G.CNTR_NO) ) SPC_TRF_CNTR
         #end
         #if(${s_ar_if_yn} == 'N')
          , (SELECT DECODE(NVL(G.DRP_OFF_CHG_TRF_SPCL_SEQ, 0), 0, 0, 1)
                FROM DOD_DRP_OFF_CHG G
               WHERE G.BKG_NO = E.BKG_NO
                 AND G.CNTR_NO = E.CNTR_NO
                 AND G.AR_IF_NO IS NULL
                 AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                        FROM DOD_DRP_OFF_CHG C
                       WHERE C.BKG_NO = G.BKG_NO
                         AND C.CNTR_NO = G.CNTR_NO) ) SPC_TRF_CNTR
         #end
         #if(${s_ar_if_yn} == 'Y')
          , (SELECT DECODE(NVL(G.DRP_OFF_CHG_TRF_SPCL_SEQ, 0), 0, 0, 1)
                FROM DOD_DRP_OFF_CHG G
               WHERE G.BKG_NO = E.BKG_NO
                 AND G.CNTR_NO = E.CNTR_NO
                 AND G.AR_IF_NO IS NOT NULL
                 AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                        FROM DOD_DRP_OFF_CHG C
                       WHERE C.BKG_NO = G.BKG_NO
                         AND C.CNTR_NO = G.CNTR_NO) ) SPC_TRF_CNTR
         #end
                                
           , (SELECT CASE WHEN DECODE(G.DRP_OFF_CHG_TRF_SPCL_SEQ, NULL, 0, G.SPCL_TRF_AMT) > 0 THEN 

			--G.SPCL_TRF_AMT
			-- Currency Convert

			#if(${s_curr_cd} == 'LOCAL')
				ROUND( G.SPCL_TRF_AMT,2 )
			#else
    	        ROUND( MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC( TO_CHAR(G.TRO_IB_CFM_DT , 'YYYYMM') , G.CURR_CD, @[s_curr_cd] , G.SPCL_TRF_AMT), 2 )
			#end

            #if(${s_ar_if_yn} == 'A') 
                   WHEN DECODE(G.DRP_OFF_CHG_TRF_SPCL_SEQ, NULL, 0, G.SPCL_TRF_AMT) < 0 THEN 0
                          ELSE 0
                          END END
                FROM DOD_DRP_OFF_CHG G
               WHERE G.BKG_NO = E.BKG_NO
                 AND G.CNTR_NO = E.CNTR_NO
                 AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                        FROM DOD_DRP_OFF_CHG C
                       WHERE C.BKG_NO = G.BKG_NO
                         AND C.CNTR_NO = G.CNTR_NO) ) SPC_TRF_AMT
          #end
          #if(${s_ar_if_yn} == 'N') 
                  WHEN DECODE(G.DRP_OFF_CHG_TRF_SPCL_SEQ, NULL, 0, G.SPCL_TRF_AMT) < 0 THEN 0
                          ELSE 0
                          END END
                FROM DOD_DRP_OFF_CHG G
               WHERE G.BKG_NO = E.BKG_NO
                 AND G.CNTR_NO = E.CNTR_NO
                 AND G.AR_IF_NO IS NULL
                 AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                        FROM DOD_DRP_OFF_CHG C
                       WHERE C.BKG_NO = G.BKG_NO
                         AND C.CNTR_NO = G.CNTR_NO) ) SPC_TRF_AMT
          #end  
          #if(${s_ar_if_yn} == 'Y') 
                  WHEN DECODE(G.DRP_OFF_CHG_TRF_SPCL_SEQ, NULL, 0, G.SPCL_TRF_AMT) < 0 THEN 0
                          ELSE 0
                          END END
                FROM DOD_DRP_OFF_CHG G
               WHERE G.BKG_NO = E.BKG_NO
                 AND G.CNTR_NO = E.CNTR_NO
                 AND G.AR_IF_NO IS NOT NULL
                 AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                        FROM DOD_DRP_OFF_CHG C
                       WHERE C.BKG_NO = G.BKG_NO
                         AND C.CNTR_NO = G.CNTR_NO) ) SPC_TRF_AMT
          #end 
                         
          #if(${s_ar_if_yn} == 'A') 
            , (SELECT DECODE(NVL((-G.DC_AMT + G.SVC_FEE_AMT)*-1, 0), 0, 0, 1)
                FROM DOD_DRP_OFF_CHG G
               WHERE G.BKG_NO = E.BKG_NO
                 AND G.CNTR_NO = E.CNTR_NO
                 AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                        FROM DOD_DRP_OFF_CHG C
                       WHERE C.BKG_NO = G.BKG_NO
                         AND C.CNTR_NO = G.CNTR_NO) ) ADJ_CNTR
           #end
           #if(${s_ar_if_yn} == 'N') 
             , (SELECT DECODE(NVL((-G.DC_AMT + G.SVC_FEE_AMT)*-1, 0), 0, 0, 1)
                FROM DOD_DRP_OFF_CHG G
               WHERE G.BKG_NO = E.BKG_NO
                 AND G.CNTR_NO = E.CNTR_NO
                 AND G.AR_IF_NO IS NULL
                 AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                        FROM DOD_DRP_OFF_CHG C
                       WHERE C.BKG_NO = G.BKG_NO
                         AND C.CNTR_NO = G.CNTR_NO) ) ADJ_CNTR
           #end
           #if(${s_ar_if_yn} == 'Y') 
             , (SELECT DECODE(NVL((-G.DC_AMT + G.SVC_FEE_AMT)*-1, 0), 0, 0, 1)
                FROM DOD_DRP_OFF_CHG G
               WHERE G.BKG_NO = E.BKG_NO
                 AND G.CNTR_NO = E.CNTR_NO
                 AND G.AR_IF_NO IS NOT NULL
                 AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                        FROM DOD_DRP_OFF_CHG C
                       WHERE C.BKG_NO = G.BKG_NO
                         AND C.CNTR_NO = G.CNTR_NO) ) ADJ_CNTR
           #end

			-- G.DC_AMT + SVC_FEE_AMT
			-- Currency Convert

			#if(${s_curr_cd} == 'LOCAL')
			, (SELECT  ROUND( (-G.DC_AMT + G.SVC_FEE_AMT)*-1 ,2 )
			#else
    	    , (SELECT  ROUND( MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC( TO_CHAR(G.TRO_IB_CFM_DT , 'YYYYMM') , G.CURR_CD, @[s_curr_cd] , ROUND( (-G.DC_AMT + G.SVC_FEE_AMT)*-1 ,2 )), 2 )
			#end

            #if(${s_ar_if_yn} == 'A') 
                FROM DOD_DRP_OFF_CHG G
               WHERE G.BKG_NO = E.BKG_NO
                 AND G.CNTR_NO = E.CNTR_NO
                 AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                        FROM DOD_DRP_OFF_CHG C
                       WHERE C.BKG_NO = G.BKG_NO
                         AND C.CNTR_NO = G.CNTR_NO) ) ADJ_AMT
            #end
            #if(${s_ar_if_yn} == 'N') 
               FROM DOD_DRP_OFF_CHG G
               WHERE G.BKG_NO = E.BKG_NO
                 AND G.CNTR_NO = E.CNTR_NO
                 AND G.AR_IF_NO IS NULL
                 AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                        FROM DOD_DRP_OFF_CHG C
                       WHERE C.BKG_NO = G.BKG_NO
                         AND C.CNTR_NO = G.CNTR_NO) ) ADJ_AMT
            #end
            #if(${s_ar_if_yn} == 'Y') 
               FROM DOD_DRP_OFF_CHG G
               WHERE G.BKG_NO = E.BKG_NO
                 AND G.CNTR_NO = E.CNTR_NO
                 AND G.AR_IF_NO IS NOT NULL
                 AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                        FROM DOD_DRP_OFF_CHG C
                       WHERE C.BKG_NO = G.BKG_NO
                         AND C.CNTR_NO = G.CNTR_NO) ) ADJ_AMT
            #end
                 
       #if(${s_ar_if_yn} == 'Y') 
        , (SELECT 1
                FROM DOD_DRP_OFF_CHG G
               WHERE G.BKG_NO = E.BKG_NO
                 AND G.CNTR_NO = E.CNTR_NO
                 AND G.AR_IF_NO IS NOT NULL
                 AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                        FROM DOD_DRP_OFF_CHG C
                       WHERE C.BKG_NO = G.BKG_NO
                         AND C.CNTR_NO = G.CNTR_NO) ) INV_CNTR
       #end

       #if(${s_ar_if_yn} == 'A') 
        , (SELECT 1
                FROM DOD_DRP_OFF_CHG G
               WHERE G.BKG_NO = E.BKG_NO
                 AND G.CNTR_NO = E.CNTR_NO
                 AND G.AR_IF_NO IS NOT NULL
                 AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                        FROM DOD_DRP_OFF_CHG C
                       WHERE C.BKG_NO = G.BKG_NO
                         AND C.CNTR_NO = G.CNTR_NO) ) INV_CNTR
       #end

      , (SELECT 1
                FROM DOD_DRP_OFF_CHG G
               WHERE G.BKG_NO = E.BKG_NO
                 AND G.CNTR_NO = E.CNTR_NO
                 AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                        FROM DOD_DRP_OFF_CHG C
                       WHERE C.BKG_NO = G.BKG_NO
                         AND C.CNTR_NO = G.CNTR_NO)) INV_CNTR2 

       #if(${s_ar_if_yn} == 'N') 
        , (SELECT 1
                FROM DOD_DRP_OFF_CHG G
               WHERE G.BKG_NO = E.BKG_NO
                 AND G.CNTR_NO = E.CNTR_NO
                 AND G.AR_IF_NO IS NULL
                 AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                        FROM DOD_DRP_OFF_CHG C
                       WHERE C.BKG_NO = G.BKG_NO
                         AND C.CNTR_NO = G.CNTR_NO) ) INV_CNTR
        #end

           , (SELECT CASE WHEN G.TTL_AMT > 0 AND G.AR_IF_NO IS NOT NULL THEN

		   	    #if(${s_curr_cd} == 'LOCAL')
				    ROUND( G.TTL_AMT ,2 )
			    #else
    	            ROUND( MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC( TO_CHAR(G.TRO_IB_CFM_DT , 'YYYYMM') , G.CURR_CD, @[s_curr_cd] ,G.TTL_AMT), 2 )
			    #end

              WHEN G.TTL_AMT < 0 THEN 0
              ELSE 0
              END END

             #if(${s_ar_if_yn} != 'N')
                FROM DOD_DRP_OFF_CHG G
               WHERE G.BKG_NO = E.BKG_NO
                 AND G.CNTR_NO = E.CNTR_NO
                 AND G.AR_IF_NO IS NOT NULL
                 AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                        FROM DOD_DRP_OFF_CHG C
                       WHERE C.BKG_NO = G.BKG_NO
                         AND C.CNTR_NO = G.CNTR_NO) ) INV_AMT
             #end

             #if(${s_ar_if_yn} == 'N')
                FROM DOD_DRP_OFF_CHG G
               WHERE G.BKG_NO = E.BKG_NO
                 AND G.CNTR_NO = E.CNTR_NO
                 AND G.AR_IF_NO IS NULL
                 AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                        FROM DOD_DRP_OFF_CHG C
                       WHERE C.BKG_NO = G.BKG_NO
                         AND C.CNTR_NO = G.CNTR_NO) ) INV_AMT
             #end


             ,( SELECT 
            #if(${s_curr_cd} == 'LOCAL')
				ROUND( D.DRP_OFF_CHG_TRF_AMT ,2 )
			#else
    	        ROUND( MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC( TO_CHAR(D.DRP_OFF_CHG_TRF_CFM_DT , 'YYYYMM') , D.CURR_CD, @[s_curr_cd] , D.DRP_OFF_CHG_TRF_AMT), 2 )
			#end
                  FROM DOD_DRP_OFF_CHG_TRF D
                 WHERE 1 = 1
                   AND DECODE(D.DEL_CD, NULL, '1', D.DEL_CD) = DECODE(D.DEL_CD, NULL, '1', B.POD_CD)
                   AND D.CNTR_RTN_LOC_CD = SUBSTR(E.CNTR_RTN_YD_CD, 1, 5)
                   AND DECODE(D.CNTR_RTN_YD_SFX_CD, NULL, '1', D.CNTR_RTN_YD_SFX_CD) = DECODE(D.CNTR_RTN_YD_SFX_CD, NULL, '1', SUBSTR(E.CNTR_RTN_YD_CD, 6, 2))
                   AND D.POL_CONTI_CD = SUBSTR(B.ORG_SCONTI_CD, 1, 1)
                   AND D.CNTR_TPSZ_CD = E.CNTR_TPSZ_CD
                   AND D.DRP_OFF_CHG_TRF_DIV_CD = 'S'
                   AND D.DRP_OFF_CHG_TRF_CFM_FLG = 'Y'
                   AND D.DRP_OFF_CHG_TRF_EXPT_FLG = 'N'
                   AND B.POL_ETD_DT BETWEEN TO_DATE(D.DRP_OFF_CHG_TRF_EFF_DT, 'YYYYMMDD') + .0 AND TO_DATE(D.DRP_OFF_CHG_TRF_EXP_DT, 'YYYYMMDD') + .99999
                   AND DECODE(D.SPCL_CUST_CNT_CD, NULL, '1', D.SPCL_CUST_CNT_CD) = DECODE(D.SPCL_CUST_CNT_CD, NULL, '1', B.AGMT_ACT_CNT_CD)
                   AND DECODE(D.SPCL_CUST_SEQ, NULL, 1, D.SPCL_CUST_SEQ) = DECODE(D.SPCL_CUST_SEQ, NULL, 1, B.AGMT_ACT_CUST_SEQ)
                   AND DECODE(D.SC_NO, NULL, D.RFA_NO, D.SC_NO) = DECODE(D.SC_NO, NULL, B.RFA_NO, B.SC_NO)
        
                   AND NVL(D.DEL_CD||D.CNTR_RTN_YD_SFX_CD, 1) = 
                     (SELECT NVL(MAX(D.DEL_CD)||MAX(D.CNTR_RTN_YD_SFX_CD), 1)
                        FROM DOD_DRP_OFF_CHG_TRF D
                         WHERE 1 = 1
                           AND DECODE(D.DEL_CD, NULL, '1', D.DEL_CD) = DECODE(D.DEL_CD, NULL, '1', B.POD_CD)
                           AND D.CNTR_RTN_LOC_CD = SUBSTR(E.CNTR_RTN_YD_CD, 1, 5)
                           AND DECODE(D.CNTR_RTN_YD_SFX_CD, NULL, '1', D.CNTR_RTN_YD_SFX_CD) = DECODE(D.CNTR_RTN_YD_SFX_CD, NULL, '1', SUBSTR(E.CNTR_RTN_YD_CD, 6, 2))
                           AND D.POL_CONTI_CD = SUBSTR(B.ORG_SCONTI_CD, 1, 1)
                           AND D.CNTR_TPSZ_CD = E.CNTR_TPSZ_CD
                           AND D.DRP_OFF_CHG_TRF_DIV_CD = 'S'
                           AND D.DRP_OFF_CHG_TRF_CFM_FLG = 'Y'
                           AND D.DRP_OFF_CHG_TRF_EXPT_FLG = 'N'
                           AND B.POL_ETD_DT BETWEEN TO_DATE(D.DRP_OFF_CHG_TRF_EFF_DT, 'YYYYMMDD') + .0 AND TO_DATE(D.DRP_OFF_CHG_TRF_EXP_DT, 'YYYYMMDD') + .99999
                           AND DECODE(D.SPCL_CUST_CNT_CD, NULL, '1', D.SPCL_CUST_CNT_CD) = DECODE(D.SPCL_CUST_CNT_CD, NULL, '1', B.AGMT_ACT_CNT_CD)
                           AND DECODE(D.SPCL_CUST_SEQ, NULL, 1, D.SPCL_CUST_SEQ) = DECODE(D.SPCL_CUST_SEQ, NULL, 1, B.AGMT_ACT_CUST_SEQ)
                           AND DECODE(D.SC_NO, NULL, D.RFA_NO, D.SC_NO) = DECODE(D.SC_NO, NULL, B.RFA_NO, B.SC_NO)
                           )
                   
                          AND NVL(D.SPCL_CUST_CNT_CD||D.SPCL_CUST_SEQ, 1) = 
                              (SELECT NVL(MAX(D.SPCL_CUST_CNT_CD||D.SPCL_CUST_SEQ), 1)
                                FROM DOD_DRP_OFF_CHG_TRF D
                               WHERE 1 = 1
                                 AND DECODE(D.DEL_CD, NULL, '1', D.DEL_CD) = DECODE(D.DEL_CD, NULL, '1', B.POD_CD)
                                 AND D.CNTR_RTN_LOC_CD = SUBSTR(E.CNTR_RTN_YD_CD, 1, 5)
                                 AND DECODE(D.CNTR_RTN_YD_SFX_CD, NULL, '1', D.CNTR_RTN_YD_SFX_CD) = DECODE(D.CNTR_RTN_YD_SFX_CD, NULL, '1', SUBSTR(E.CNTR_RTN_YD_CD, 6, 2))
                                 AND D.POL_CONTI_CD = SUBSTR(B.ORG_SCONTI_CD, 1, 1)
                                 AND D.CNTR_TPSZ_CD = E.CNTR_TPSZ_CD
                                 AND D.DRP_OFF_CHG_TRF_DIV_CD = 'S'
                                 AND D.DRP_OFF_CHG_TRF_CFM_FLG = 'Y'
                                 AND D.DRP_OFF_CHG_TRF_EXPT_FLG = 'N'
                                 AND B.POL_ETD_DT BETWEEN TO_DATE(D.DRP_OFF_CHG_TRF_EFF_DT, 'YYYYMMDD') + .0 AND TO_DATE(D.DRP_OFF_CHG_TRF_EXP_DT, 'YYYYMMDD') + .99999
                                 AND DECODE(D.SPCL_CUST_CNT_CD, NULL, '1', D.SPCL_CUST_CNT_CD) = DECODE(D.SPCL_CUST_CNT_CD, NULL, '1', B.AGMT_ACT_CNT_CD)
                                 AND DECODE(D.SPCL_CUST_SEQ, NULL, 1, D.SPCL_CUST_SEQ) = DECODE(D.SPCL_CUST_SEQ, NULL, 1, B.AGMT_ACT_CUST_SEQ)
                                 AND DECODE(D.SC_NO, NULL, D.RFA_NO, D.SC_NO) = DECODE(D.SC_NO, NULL, B.RFA_NO, B.SC_NO)         
                                 )   
                           AND NOT EXISTS (SELECT 'OK'
                                          FROM DOD_DRP_OFF_CHG G
                                         WHERE G.BKG_NO = E.BKG_NO
                                           AND G.CNTR_NO = E.CNTR_NO
                                            )      
            ) PEN_SPC_AMT
            
            ,( SELECT 

			-- D.DRP_OFF_CHG_TRF_AMT 
			-- Currency Convert

			#if(${s_curr_cd} == 'LOCAL')
				ROUND( D.DRP_OFF_CHG_TRF_AMT ,2 )
			#else
    	        ROUND( MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC( TO_CHAR(D.DRP_OFF_CHG_TRF_CFM_DT , 'YYYYMM') , D.CURR_CD, @[s_curr_cd] , D.DRP_OFF_CHG_TRF_AMT), 2 )
			#end

                FROM DOD_DRP_OFF_CHG_TRF D
               WHERE 1 = 1
                 AND DECODE(D.DEL_CD, NULL, '1', D.DEL_CD) = DECODE(D.DEL_CD, NULL, '1', B.POD_CD)
                 AND D.CNTR_RTN_LOC_CD = SUBSTR(E.CNTR_RTN_YD_CD, 1, 5)
                 AND DECODE(D.CNTR_RTN_YD_SFX_CD, NULL, '1', D.CNTR_RTN_YD_SFX_CD) = DECODE(D.CNTR_RTN_YD_SFX_CD, NULL, '1', SUBSTR(E.CNTR_RTN_YD_CD, 6, 2))
                 AND D.POL_CONTI_CD = SUBSTR(B.ORG_SCONTI_CD, 1, 1)
                 AND D.CNTR_TPSZ_CD = E.CNTR_TPSZ_CD
                 AND D.DRP_OFF_CHG_TRF_DIV_CD = 'G'
                 AND D.DRP_OFF_CHG_TRF_CFM_FLG = 'Y'
                 AND D.DRP_OFF_CHG_TRF_EXPT_FLG = 'N'
                 AND B.POL_ETD_DT BETWEEN TO_DATE(D.DRP_OFF_CHG_TRF_EFF_DT, 'YYYYMMDD') + .0 AND TO_DATE(D.DRP_OFF_CHG_TRF_EXP_DT, 'YYYYMMDD') + .99999
        
                  AND NVL(D.DEL_CD||D.CNTR_RTN_YD_SFX_CD, 1) = 
                       (SELECT NVL(MAX(D.DEL_CD)||MAX(D.CNTR_RTN_YD_SFX_CD), 1)
                         FROM DOD_DRP_OFF_CHG_TRF D
                            WHERE 1 = 1
                         AND DECODE(D.DEL_CD, NULL, '1', D.DEL_CD) = DECODE(D.DEL_CD, NULL, '1', B.POD_CD)
                              AND D.CNTR_RTN_LOC_CD = SUBSTR(E.CNTR_RTN_YD_CD, 1, 5)
                              AND DECODE(D.CNTR_RTN_YD_SFX_CD, NULL, '1', D.CNTR_RTN_YD_SFX_CD) = DECODE(D.CNTR_RTN_YD_SFX_CD, NULL, '1', SUBSTR(E.CNTR_RTN_YD_CD, 6, 2))
                              AND D.POL_CONTI_CD = SUBSTR(B.ORG_SCONTI_CD, 1, 1)
                              AND D.CNTR_TPSZ_CD = E.CNTR_TPSZ_CD
                              AND D.DRP_OFF_CHG_TRF_DIV_CD = 'G'
                              AND D.DRP_OFF_CHG_TRF_CFM_FLG = 'Y'
                              AND D.DRP_OFF_CHG_TRF_EXPT_FLG = 'N'
                              AND B.POL_ETD_DT BETWEEN TO_DATE(D.DRP_OFF_CHG_TRF_EFF_DT, 'YYYYMMDD') + .0 AND TO_DATE(D.DRP_OFF_CHG_TRF_EXP_DT, 'YYYYMMDD') + .99999
                         )
                 AND NOT EXISTS (SELECT 'OK'
                                    FROM DOD_DRP_OFF_CHG G
                                   WHERE G.BKG_NO = E.BKG_NO
                                     AND G.CNTR_NO = E.CNTR_NO
                                 )     
              ) PEN_GEN_AMT
    FROM BKG_EUR_TRO E
       , BKG_BOOKING B
    WHERE 1=1
     AND E.BKG_NO = B.BKG_NO
     AND E.IO_BND_CD = 'I'
     AND E.HLG_TP_CD = 'M'
     AND SUBSTR(E.CNTR_RTN_YD_CD, 1, 5) <> B.DEL_CD
     AND E.CXL_FLG = 'N'
     AND E.CFM_FLG = 'Y'
     AND E.TRO_SEQ = (SELECT MAX(TT.TRO_SEQ)
                               FROM BKG_EUR_TRO TT
                              WHERE TT.BKG_NO = E.BKG_NO
                                AND TT.CNTR_NO = E.CNTR_NO
                                AND TT.IO_BND_CD = 'I') 
 
       -- TRO DATE (DATE, MONTH, WEEK 별)
	#if (${period} == 'W') 
		AND	E.CFM_DT	BETWEEN	( 
							SELECT TO_DATE(K.WK_ST_DT,'YYYYMMDD') + .0
							FROM   EQR_WK_PRD K
							WHERE  K.PLN_YR||K.PLN_WK = @[from]
							)	
			AND				( 
							 SELECT TO_DATE(K.WK_END_DT,'YYYYMMDD') + .99999
							 FROM   EQR_WK_PRD K
							 WHERE  K.PLN_YR||K.PLN_WK = @[to]
							) 
	
	#elseif (${period} == 'D' || ${period} == 'M') 
    	AND 	E.CFM_DT BETWEEN 	TO_DATE( @[from], 'YYYYMMDD') + .0 
	  	AND 							TO_DATE( @[to], 'YYYYMMDD') + .99999
	#end 


  -- RETURN LOCATION 조건
  #if(${s_rtn_loc} != '')
  AND E.CNTR_RTN_YD_CD LIKE @[s_rtn_loc]||'%'
  #end     
    
  -- CNTR TYPE 조건
	AND	SUBSTR(E.CNTR_TPSZ_CD,1,1)	IN (
					#foreach( $cntr_tp in ${cntr_tp_list} )
						#if ($cntr_tp == 'S')
							'F', 'O', 'T', 'P', 'S', 'A'
						#elseif ($cntr_tp == 'D' || $cntr_tp == 'R')
							'$cntr_tp'
						#end

						#if($velocityCount < $cntr_tp_list.size()) , #end
					#end
				)
    
    -- AR I/F 조건
   #if(${s_ar_if_yn} == 'Y')
    AND EXISTS  (SELECT 'OK'
                FROM DOD_DRP_OFF_CHG GG
               WHERE GG.BKG_NO = E.BKG_NO
                 AND GG.CNTR_NO = E.CNTR_NO
                 AND GG.AR_IF_NO IS NOT NULL
                 AND GG.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                                             FROM DOD_DRP_OFF_CHG C
                                            WHERE C.BKG_NO = GG.BKG_NO
                                              AND C.CNTR_NO = GG.CNTR_NO)) 
	#end

    -- INV CUST 조건
  #if(${s_cust_cd} != '')
    AND EXISTS (SELECT 'OK'
                FROM DOD_DRP_OFF_CHG GG
                WHERE GG.BKG_NO = E.BKG_NO
                  AND GG.CNTR_NO = E.CNTR_NO

    AND GG.CUST_CNT_CD || LPAD(GG.CUST_SEQ, 6, '0') = @[s_cust_cd]
	)
  #end
                 
  -- DOD OFFICE
  #if (${ofc_flg} == 'O')
    AND   E.CFM_OFC_CD IN (
        #foreach( $an_ofc in ${ofc_cd_list} )
          #if($velocityCount < $ofc_cd_list.size()) '$an_ofc', #else '$an_ofc' #end
        #end
        )
  #elseif (${ofc_flg} == 'R' && ${ofc_cd} != 'All')
    AND @[ofc_cd] = (SELECT DISTINCT OFC_CD 
					 FROM MDM_ORGANIZATION
					 WHERE 1 = 1
						 AND OFC_KND_CD = '2'
						 AND PRNT_OFC_CD = 'SELDC'
						 START WITH OFC_CD = E.CFM_OFC_CD 
						 CONNECT BY PRIOR PRNT_OFC_CD = OFC_CD)
 
  #end

) A
GROUP BY A.TRO_IB_CFM_OFC_CD, A.LOC_CD, A.CNTR_TPSZ_CD, A.CURR_CD
) A
#if(${s_ar_if_yn} == 'N')
WHERE PEN_CNTR > 0
 OR GEN_TRF_CNTR > 0
 OR SPC_TRF_CNTR > 0
#end
#if(${s_ar_if_yn} == 'A')
WHERE PEN_CNTR > 0
 OR GEN_TRF_CNTR > 0
 OR SPC_TRF_CNTR > 0
 OR INV_CNTR2 > 0
#end
			]]></sql>
			<params>
				<param name="s_curr_cd" type="12" value="" out="N"/>
				<param name="from" type="12" value="" out="N"/>
				<param name="to" type="12" value="" out="N"/>
				<param name="s_rtn_loc" type="12" value="" out="N"/>
				<param name="s_cust_cd" type="12" value="" out="N"/>
				<param name="ofc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
