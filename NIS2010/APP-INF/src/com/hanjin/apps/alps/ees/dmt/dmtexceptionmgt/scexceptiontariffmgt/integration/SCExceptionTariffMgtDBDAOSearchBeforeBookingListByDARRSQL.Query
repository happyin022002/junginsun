<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="SCExceptionTariffMgtDBDAOSearchBeforeBookingListByDARRSQL">
			<desc><![CDATA[SC & RFA Exception Inquiry (BeforeBooking, DAR) 조회쿼리]]></desc>
			<sql><![CDATA[
SELECT	DISTINCT RFA_NO
	,	STATUS
	,	RQST_SEQ
	,	TARIFF
	,	EFF_DT
	,	EXP_DT
	,	CNTRCGO
	,	CVRG_SEQ
	,	CNT_CD
	,	RGN_CD
	,	LOC_CD
	,	FT_ADD_DYS
	,	FT_TOT_DYS
	,	XCLD_SAT_FLG
	,	XCLD_SUN_FLG
	,	XCLD_HOL_FLG
	,	CURR_CD
	, 	DECODE(CVRG_COUNT, 1, 'Single', 'Multi') ORG_DEST_MULTI
	,	DECODE(CVRG_COUNT, 1, ORG_DEST_CONTI_CD, '') ORG_DEST_CONTI_CD
	,	DECODE(CVRG_COUNT, 1, ORG_DEST_CNT_CD, '') ORG_DEST_CNT_CD
	,	DECODE(CVRG_COUNT, 1, ORG_DEST_RGN_CD, '') ORG_DEST_RGN_CD 
	,	DECODE(CVRG_COUNT, 1, ORG_DEST_LOC_CD, '') ORG_DEST_LOC_CD
	,	FNL_DEST_CNT_CD
	,	FNL_DEST_RGN_CD
	,	FNL_DEST_LOC_CD
	,	ACT_CUST_CD
	,	ACT_CUST_NM
	,	RT_FLG
	,	DAR_NO
	,	VER_SEQ
	,	APVL_NO
	,	PROP_NO
	,	CUST_CD
	,	CUST_NM

FROM	(
			SELECT  HDR.RFA_NO
			    ,   COM_DTL.INTG_CD_VAL_DP_DESC STATUS
				,	TRF_DTL.RFA_RQST_DTL_SEQ RQST_SEQ
				,   TRF_DTL.DMDT_TRF_CD TARIFF
				,	TO_CHAR(TRF_DTL.EFF_DT, 'YYYY-MM-DD') EFF_DT
				,	TO_CHAR(TRF_DTL.EXP_DT, 'YYYY-MM-DD') EXP_DT
				,	COM_DTL2.INTG_CD_VAL_DP_DESC || ' - ' || COM_DTL3.INTG_CD_VAL_DP_DESC CNTRCGO
				,	CVRG.CVRG_CMB_SEQ CVRG_SEQ
				,	CVRG.CVRG_CNT_CD CNT_CD
				,	CASE WHEN CVRG.CVRG_CNT_CD IN ('CA', 'US') THEN CVRG.CVRG_STE_CD ELSE CVRG.CVRG_RGN_CD END RGN_CD
				,	CVRG.CVRG_LOC_CD LOC_CD
				,	TRF_DTL.ADD_DYS FT_ADD_DYS
				,	TRF_DTL.TTL_DYS FT_TOT_DYS
				,	TRF_DTL.XCLD_SAT_FLG
				,	TRF_DTL.XCLD_SUN_FLG
				,	TRF_DTL.XCLD_HOL_FLG
				,	TRF_DTL.CURR_CD
				,	CVRG.ORG_DEST_CONTI_CD
				,	CVRG.ORG_DEST_CNT_CD
				,	CASE WHEN CVRG.ORG_DEST_CNT_CD IN ('CA', 'US') THEN CVRG.ORG_DEST_STE_CD ELSE CVRG.ORG_DEST_RGN_CD END ORG_DEST_RGN_CD
				,	CVRG.ORG_DEST_LOC_CD
				,	TRF_DTL.FNL_DEST_CNT_CD
				,	CASE WHEN TRF_DTL.FNL_DEST_CNT_CD IN ('CA', 'US') THEN TRF_DTL.FNL_DEST_STE_CD ELSE TRF_DTL.FNL_DEST_RGN_CD END FNL_DEST_RGN_CD
				,	TRF_DTL.FNL_DEST_LOC_CD
				,	TRF_DTL.ACT_CUST_CNT_CD || LPAD(TRF_DTL.ACT_CUST_SEQ, 6, '0') ACT_CUST_CD
				,	CUST2.CUST_LGL_ENG_NM ACT_CUST_NM   
				,	TRF_DTL.RT_USE_FLG RT_FLG
				,	TRF.RFA_EXPT_DAR_NO DAR_NO
			    ,   LPAD(TRF.RFA_EXPT_VER_SEQ, 3, '0') VER_SEQ
			    ,   TRF.RFA_EXPT_APRO_NO APVL_NO
			    ,   TRF.PROP_NO
			    ,   MN.CTRT_CUST_CNT_CD || LPAD(MN.CTRT_CUST_SEQ, 6, '0') CUST_CD
			    ,   CUST.CUST_LGL_ENG_NM CUST_NM            
				,   (
			        	SELECT  COUNT(CVRG_CMB_SEQ)
			        	FROM    DMT_RFA_EXPT_CVRG_CMB
			        	WHERE   RFA_EXPT_DAR_NO = TRF_DTL.RFA_EXPT_DAR_NO
			            	AND RFA_EXPT_MAPG_SEQ = TRF_DTL.RFA_EXPT_MAPG_SEQ
			            	AND RFA_EXPT_VER_SEQ = TRF_DTL.RFA_EXPT_VER_SEQ
			            	AND RFA_RQST_DTL_SEQ = TRF_DTL.RFA_RQST_DTL_SEQ
			     	) CVRG_COUNT
			
			FROM    PRI_RP_HDR HDR
			    ,   PRI_RP_MN MN
			    ,   MDM_CUSTOMER CUST
			    ,   DMT_RFA_EXPT_TRF TRF
			    ,   COM_INTG_CD_DTL COM_DTL 
			    ,   DMT_RFA_EXPT_TRF_DTL TRF_DTL
			    ,   MDM_CUSTOMER CUST2
				,   COM_INTG_CD_DTL COM_DTL2
				,   COM_INTG_CD_DTL COM_DTL3
				,	DMT_RFA_EXPT_CVRG_CMB CVRG
    
			WHERE   HDR.PROP_NO = MN.PROP_NO
			#if(${rfa_no} != '')
				AND HDR.RFA_NO = @[rfa_no]
			#end
			#if(${prop_no} != '')
				AND HDR.PROP_NO = @[prop_no]
			#end
			    AND MN.AMDT_SEQ = (SELECT MAX(AMDT_SEQ) FROM PRI_RP_MN WHERE PROP_NO = HDR.PROP_NO)
			#if(${cust_cd} != '' && ${act_cust_cd} != '')
			    AND MN.CTRT_CUST_CNT_CD = CUST.CUST_CNT_CD(+)
			    AND MN.CTRT_CUST_SEQ = CUST.CUST_SEQ(+)
			#else
			    AND MN.CTRT_CUST_CNT_CD = CUST.CUST_CNT_CD
			    AND MN.CTRT_CUST_SEQ = CUST.CUST_SEQ
			#end
			    AND MN.PROP_NO = TRF.PROP_NO
			#if(${dar_no} != '')
				AND TRF.RFA_EXPT_DAR_NO = @[dar_no]
			#end
			#if(${apvl_no} != '')
				AND TRF.RFA_EXPT_APRO_NO = @[apvl_no]
			#end
				AND TRF.DMDT_EXPT_RQST_STS_CD IN (
						#foreach( $sts_cd in ${sts_cd_list} )
							#if($velocityCount < $sts_cd_list.size()) '$sts_cd', #else '$sts_cd' #end
						#end
					)
			    AND TRF.DMDT_EXPT_RQST_STS_CD = COM_DTL.INTG_CD_VAL_CTNT
			    AND COM_DTL.INTG_CD_ID = 'CD02069'
			    AND TRF.RFA_EXPT_DAR_NO = TRF_DTL.RFA_EXPT_DAR_NO
			    AND TRF.RFA_EXPT_MAPG_SEQ = TRF_DTL.RFA_EXPT_MAPG_SEQ
			    AND TRF.RFA_EXPT_VER_SEQ = TRF_DTL.RFA_EXPT_VER_SEQ
				AND TRF_DTL.DMDT_TRF_CD IN (
						#foreach( $trf_cd in ${trf_cd_list} )
							#if($velocityCount < $trf_cd_list.size()) '$trf_cd', #else '$trf_cd' #end
						#end
					)
				AND TRF_DTL.DMDT_CNTR_TP_CD = COM_DTL2.INTG_CD_VAL_CTNT
				AND COM_DTL2.INTG_CD_ID = 'CD02053'
				AND TRF_DTL.DMDT_CGO_TP_CD = COM_DTL3.INTG_CD_VAL_CTNT
				AND COM_DTL3.INTG_CD_ID = 'CD01963'
			#if(${cust_cd} != '' && ${act_cust_cd} == '')
			    AND MN.CTRT_CUST_CNT_CD = SUBSTR(@[cust_cd], 0, 2) AND MN.CTRT_CUST_SEQ = SUBSTR(@[cust_cd], 3)
			#elseif(${cust_cd} == '' && ${act_cust_cd} != '')
				AND TRF_DTL.ACT_CUST_CNT_CD = SUBSTR(@[act_cust_cd], 0, 2) AND TRF_DTL.ACT_CUST_SEQ = SUBSTR(@[act_cust_cd], 3)
			#elseif(${cust_cd} != '' && ${act_cust_cd} != '')
				AND (
						(MN.CTRT_CUST_CNT_CD = SUBSTR(@[cust_cd], 0, 2) AND MN.CTRT_CUST_SEQ = SUBSTR(@[cust_cd], 3))
						OR
						(TRF_DTL.ACT_CUST_CNT_CD = SUBSTR(@[act_cust_cd], 0, 2) AND TRF_DTL.ACT_CUST_SEQ = SUBSTR(@[act_cust_cd], 3))
					)
			#end
				AND TRF_DTL.ACT_CUST_CNT_CD = CUST2.CUST_CNT_CD(+)
				AND TRF_DTL.ACT_CUST_SEQ = CUST2.CUST_SEQ(+)
			    AND TRF_DTL.RFA_EXPT_DAR_NO = CVRG.RFA_EXPT_DAR_NO
			    AND TRF_DTL.RFA_EXPT_MAPG_SEQ = CVRG.RFA_EXPT_MAPG_SEQ
			    AND TRF_DTL.RFA_EXPT_VER_SEQ = CVRG.RFA_EXPT_VER_SEQ
			    AND TRF_DTL.RFA_RQST_DTL_SEQ = CVRG.RFA_RQST_DTL_SEQ
				AND CVRG.CVRG_CMB_SEQ = (
											SELECT	/*+ INDEX_ASC(DMT_RFA_EXPT_CVRG_CMB XPKDMT_RFA_EXPT_CVRG_CMB) */ CVRG_CMB_SEQ
											FROM	DMT_RFA_EXPT_CVRG_CMB
											WHERE	RFA_EXPT_DAR_NO = CVRG.RFA_EXPT_DAR_NO
												AND	RFA_EXPT_MAPG_SEQ = CVRG.RFA_EXPT_MAPG_SEQ
												AND RFA_EXPT_VER_SEQ = CVRG.RFA_EXPT_VER_SEQ
												AND RFA_RQST_DTL_SEQ = CVRG.RFA_RQST_DTL_SEQ
												AND ROWNUM = 1
										)
		)

ORDER BY RFA_NO, PROP_NO, VER_SEQ, RQST_SEQ, CVRG_SEQ			]]></sql>
			<params>
				<param name="rfa_no" type="12" value="" out="N"/>
				<param name="prop_no" type="12" value="" out="N"/>
				<param name="dar_no" type="12" value="" out="N"/>
				<param name="apvl_no" type="12" value="" out="N"/>
				<param name="cust_cd" type="12" value="" out="N"/>
				<param name="act_cust_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
