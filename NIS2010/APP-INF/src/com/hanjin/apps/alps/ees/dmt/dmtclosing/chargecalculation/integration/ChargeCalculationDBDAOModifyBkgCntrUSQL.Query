<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ChargeCalculationDBDAOModifyBkgCntrUSQL">
			<desc><![CDATA[ChargeCalculationDBDAOModifyBkgCntrUSQL]]></desc>
			<sql><![CDATA[
UPDATE DMT_CHG_BKG_CNTR KKK
    SET ( BL_NO,VSL_CD,SKD_VOY_NO,SKD_DIR_CD
        , SC_NO,RFA_NO, CMDT_CD, REP_CMDT_CD, DMDT_CNTR_TP_CD, DMDT_BKG_CGO_TP_CD
        , DCGO_FLG, RC_FLG, BB_CGO_FLG, AWK_CGO_FLG, RD_CGO_FLG, SOC_FLG
        , POR_CD,POL_CD,POD_CD,DEL_CD,BKG_RCV_TERM_CD,BKG_DE_TERM_CD,BKG_CNTR_QTY,SLS_OFC_CD,RHQ_CD
        , UPD_USR_ID,UPD_DT,UPD_OFC_CD )
        = (
        SELECT DISTINCT
               BL_NO, SUBSTR(VVD_CD,1,4), SUBSTR(VVD_CD,5,4), SUBSTR(VVD_CD,9,1)
             , SC_NO,RFA_NO, CMDT_CD, REP_CMDT_CD, CNTR_TPSZ, CGO_TP
             , DCGO_FLG, RC_FLG, BB_CGO_FLG, AWK_CGO_FLG, RD_CGO_FLG, SOC_FLG
             , POR_CD,POL_CD,POD_CD,DEL_CD,RCV_TERM_CD,DE_TERM_CD,BKG_CNTR_QTY,SLS_OFC_CD,RHQ_CD
             , UPD_USR_ID,UPD_DT,UPD_OFC_CD
        FROM
        (
        SELECT BB.BL_NO 
                        , DECODE(SUBSTR(T02.DMDT_TRF_CD,3,1),'I',
                             ( SELECT /*+ ORDERED USE_NL( V K )
                                                    INDEX    ( V XPKBKG_VVD )
                                                    INDEX_DESC    ( K XPKVSK_VSL_PORT_SKD) */
                                       V.VSL_CD||V.SKD_VOY_NO||V.SKD_DIR_CD
                                  FROM BKG_VVD V
                                      ,VSK_VSL_PORT_SKD K
                                 WHERE V.BKG_NO = BB.BKG_NO
                                   AND V.POD_CD = BB.POD_CD
                                   AND (V.VSL_PRE_PST_CD, V.VSL_SEQ) =
                                          (SELECT /*+ INDEX_DESC( VV XPKBKG_VVD) */
                                                  VV.VSL_PRE_PST_CD
                                                 ,VV.VSL_SEQ
                                             FROM BKG_VVD VV
                                            WHERE VV.BKG_NO = V.BKG_NO
                                              AND VV.POD_CD = V.POD_CD
                                              AND ROWNUM = 1)
                                   AND V.VSL_CD = K.VSL_CD(+)
                                   AND V.SKD_VOY_NO = K.SKD_VOY_NO(+)
                                   AND V.SKD_DIR_CD = K.SKD_DIR_CD(+)
                                   AND V.POD_CD = K.VPS_PORT_CD(+)
                                   AND V.POD_CLPT_IND_SEQ = K.CLPT_IND_SEQ(+)
                                   AND NVL (K.SKD_CNG_STS_CD, ' ') != 'S'
                                   AND ROWNUM = 1 )
                           , ( SELECT /*+ ORDERED USE_NL( V K )
                                       INDEX    ( V XPKBKG_VVD )
                                       INDEX_DESC    ( K XPKVSK_VSL_PORT_SKD) */
                                   V.VSL_CD||V.SKD_VOY_NO||V.SKD_DIR_CD
                              FROM BKG_VVD V
                                  ,VSK_VSL_PORT_SKD K
                             WHERE V.BKG_NO = BB.BKG_NO
                               AND V.POL_CD = BB.POL_CD
                               AND (V.VSL_PRE_PST_CD, V.VSL_SEQ) =
                                      (SELECT /*+ INDEX( VV XPKBKG_VVD) */
                                              VV.VSL_PRE_PST_CD
                                             ,VV.VSL_SEQ
                                         FROM BKG_VVD VV
                                        WHERE VV.BKG_NO = V.BKG_NO
                                          AND VV.POL_CD = V.POL_CD
                                          AND ROWNUM = 1)
                               AND V.VSL_CD = K.VSL_CD(+)
                               AND V.SKD_VOY_NO = K.SKD_VOY_NO(+)
                               AND V.SKD_DIR_CD = K.SKD_DIR_CD(+)
                               AND V.POL_CD = K.VPS_PORT_CD(+)
                               AND V.POL_CLPT_IND_SEQ = K.CLPT_IND_SEQ(+)
                               AND NVL (K.SKD_CNG_STS_CD, ' ') != 'S'
                               AND ROWNUM = 1 )) AS VVD_CD
        , BB.SC_NO, BB.RFA_NO
        , BB.CMDT_CD, BB.REP_CMDT_CD 
        
        , BB.DCGO_FLG
        , BB.RC_FLG
        , BB.BB_CGO_FLG
        , BB.AWK_CGO_FLG
        , BB.RD_CGO_FLG
        , BB.SOC_FLG
        , BB.POR_CD
        , BB.POL_CD
        , BB.POD_CD
        , BB.DEL_CD
        , BB.RCV_TERM_CD
        , BB.DE_TERM_CD
        , ( SELECT COUNT(*) FROM BKG_CONTAINER WHERE BKG_NO = BB.BKG_NO ) BKG_CNTR_QTY
        , T02.OFC_CD SLS_OFC_CD
        , T02.OFC_RHQ_CD RHQ_CD
        
        ,@[upd_usr_id] UPD_USR_ID
        , NVL(GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC(@[upd_ofc_cd]),SYSDATE) UPD_DT
        , @[upd_ofc_cd] UPD_OFC_CD
        
        , CASE
            WHEN SUBSTR( T01.CNTR_TPSZ_CD, 1, 1)      = 'P' THEN 'F'
            WHEN SUBSTR( T01.CNTR_TPSZ_CD, 1, 1)      = 'C' THEN 'O' 
            WHEN SUBSTR( T01.CNTR_TPSZ_CD, 1, 1)      = 'A' THEN 'F' 
            WHEN SUBSTR( T01.CNTR_TPSZ_CD, 1, 1)      = 'S' THEN 'O' 
            ELSE SUBSTR( T01.CNTR_TPSZ_CD, 1, 1)
            END AS CNTR_TPSZ
        , NVL(( SELECT CASE
                    WHEN RC_FLG      = 'Y' THEN 'RFR' 
                    WHEN AWK_CGO_FLG = 'Y' THEN 'AWK' 
                    WHEN DCGO_FLG    = 'Y' THEN 'DGR' 
                    WHEN BB_CGO_FLG  = 'Y' THEN 'B/B' 
                    WHEN RD_CGO_FLG  = 'Y' THEN 'DRY' 
                    WHEN SOC_FLG     = 'Y' THEN 'SOC' 
                    ELSE                         'DRY'
                    END  
              FROM BKG_CONTAINER
             WHERE BKG_NO = BB.BKG_NO
               AND CNTR_NO = T01.CNTR_NO ),'DRY')  AS CGO_TP
        
        FROM BKG_BOOKING BB, DMT_CHG_BKG_CNTR T01, DMT_CHG_CALC T02
        WHERE T02.SYS_AREA_GRP_ID = @[svr_id]
        AND T02.CNTR_NO = @[cntr_no]
        AND T02.CNTR_CYC_NO = @[cntr_cyc_no]
        AND T02.DMDT_CHG_LOC_DIV_CD = @[dmdt_chg_loc_div_cd]
        AND	T02.CHG_SEQ             = @[chg_seq]
        AND T01.SYS_AREA_GRP_ID = T02.SYS_AREA_GRP_ID
        AND T01.CNTR_NO = T02.CNTR_NO
        AND T01.CNTR_CYC_NO = T02.CNTR_CYC_NO
        AND T01.BKG_NO = BB.BKG_NO
        AND T01.SYS_AREA_GRP_ID = ( SELECT SYS_AREA_GRP_ID
                                    FROM COM_SYS_AREA_GRP_ID
                                   WHERE CNT_CD = SUBSTR(T02.FM_MVMT_YD_CD,1,2)
                                     AND CO_IND_CD = 'H' )
        AND ROWNUM = 1 ) 
        )
    WHERE   SYS_AREA_GRP_ID	= @[svr_id]
    AND     CNTR_NO     	= @[cntr_no]
    AND     CNTR_CYC_NO 	= @[cntr_cyc_no]
    AND     EXISTS ( SELECT 'Y'
                       FROM DMT_CHG_CALC A
                      WHERE A.SYS_AREA_GRP_ID 		= @[svr_id]
                        AND A.CNTR_NO 				= @[cntr_no]
                        AND A.CNTR_CYC_NO 			= @[cntr_cyc_no]
                        AND A.DMDT_CHG_LOC_DIV_CD 	= @[dmdt_chg_loc_div_cd]
                        AND	A.CHG_SEQ             	= @[chg_seq]                
                        AND A.SYS_AREA_GRP_ID = ( SELECT SYS_AREA_GRP_ID
                                                    FROM COM_SYS_AREA_GRP_ID
                                                   WHERE CNT_CD = SUBSTR(A.FM_MVMT_YD_CD,1,2)
                                                     AND CO_IND_CD = 'H' ) )			]]></sql>
			<params>
				<param name="upd_usr_id" type="12" value="" out="N"/>
				<param name="upd_ofc_cd" type="12" value="" out="N"/>
				<param name="svr_id" type="12" value="" out="N"/>
				<param name="cntr_no" type="12" value="" out="N"/>
				<param name="cntr_cyc_no" type="12" value="" out="N"/>
				<param name="dmdt_chg_loc_div_cd" type="12" value="" out="N"/>
				<param name="chg_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
