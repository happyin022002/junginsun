<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ContainerOnOffhireDBDAOSearchCntrStatusUpdateHistoryDataRSQL">
			<desc><![CDATA[searchCntrStatusUpdateHistoryData]]></desc>
			<sql><![CDATA[
WITH PARAM
AS (
(SELECT /*+ INDEX( A XPKMST_CONTAINER) */
                 CNTR_NO 
                 FROM MST_CONTAINER A
                 WHERE 1 = 1
           		 #if(${noExit} == 'A')
       				 #if (${chk_dgt} == '')
       			 AND  A.CNTR_NO = @[cntr_no]
       				 #end
        			#if (${chk_dgt} != '') 
        		 AND  A.CNTR_NO = @[cntr_no] || @[chk_dgt]
        			#end 
    			#end
   				 #if(${noExit} == 'E')
        			#if (${chk_dgt} == '')
       			 AND  A.CNTR_NO = MST_COMMON_PKG.MST_CNTR_NO_FNC(@[cntr_no])
       				 #end
       			 	 #if (${chk_dgt} != '') 
       			 AND  A.CNTR_NO = @[cntr_no] || @[chk_dgt]
       				 #end 
    			#end 
                 AND CNMV_DT = (
                               SELECT MAX(CNMV_DT) 
                               FROM MST_CONTAINER 
                               WHERE 1 = 1
                         #if(${noExit} == 'A')
       				 #if (${chk_dgt} == '')
       			 AND  CNTR_NO = @[cntr_no]
       				 #end
        			#if (${chk_dgt} != '') 
        		 AND   CNTR_NO = @[cntr_no] || @[chk_dgt]
        			#end 
    			#end
   				 #if(${noExit} == 'E')
        			#if (${chk_dgt} == '')
       			 AND  CNTR_NO = MST_COMMON_PKG.MST_CNTR_NO_FNC(@[cntr_no])
       				 #end
       			 	 #if (${chk_dgt} != '') 
       			 AND   CNTR_NO = @[cntr_no] || @[chk_dgt]
       				 #end 
    			#end 
                               )
                 AND ROWNUM = 1 
))
SELECT
	A.CNTR_STS_CD
	,TO_CHAR(A.CNTR_STS_EVNT_DT, 'YYYY-MM-DD') CNTR_STS_EVNT_DT
	,A.YD_CD
    ,A.AGMT_CTY_CD
    ,A.AGMT_SEQ
	,B.LSTM_CD
	,B.REF_NO,
	 CASE WHEN A.CNTR_STS_CD IN ('SLD') 
	      THEN DECODE(NVL(A.CUST_CNT_CD,'0'), '0', '', A.CUST_CNT_CD||A.CUST_SEQ)
	 ELSE TO_CHAR(B.VNDR_SEQ) END VNDR_SEQ,
	 CASE WHEN A.CNTR_STS_CD IN ('SLD') 
	      THEN DECODE(NVL(A.CUST_CNT_CD,'0'), '0', A.CUST_NM, (SELECT CUST_LGL_ENG_NM FROM MDM_CUSTOMER WHERE CUST_CNT_CD = A.CUST_CNT_CD AND CUST_SEQ = A.CUST_SEQ))
	 ELSE C.VNDR_LGL_ENG_NM END VNDR_LGL_ENG_NM
	,A.DIR_ITCHG_VNDR_SEQ
    ,(SELECT VNDR_LGL_ENG_NM FROM MDM_VENDOR WHERE VNDR_SEQ = A.DIR_ITCHG_VNDR_SEQ) DIR_VNDR_LGL_ENG_NM
	,A.OFC_CD
	,A.CNTR_OLD_VAN_FLG
   ,CASE WHEN A.CNTR_PKUP_CHG_AMT > 0 THEN
      A.CNTR_PKUP_CHG_AMT 
   ELSE  0 END CNTR_PKUP_CHG_AMT
   ,CASE WHEN A.CNTR_PKUP_CHG_AMT < 0 THEN
      A.CNTR_PKUP_CHG_AMT * (-1)
   ELSE 0 END CNTR_PKUP_CR_CHG_AMT
	,A.CNTR_MIN_ONH_DYS
	,A.RNTL_CHG_FREE_DYS
	,A.CNTR_DIR_ITCHG_FEE_AMT
   ,CASE WHEN A.CNTR_DRFF_CR_AMT > 0 THEN
      A.CNTR_DRFF_CR_AMT 
   ELSE  0 END CNTR_DRFF_AMT
   ,CASE WHEN A.CNTR_DRFF_CR_AMT < 0 THEN
      A.CNTR_DRFF_CR_AMT * (-1)
   ELSE 0 END CNTR_DRFF_CR_AMT   
	,A.CNTR_LFT_CHG_AMT
	,A.CNTR_LSTM_CNG_FLG
	,TO_CHAR(A.CRE_DT, 'YYYY-MM-DD HH24:MI') CRE_DT
	,TO_CHAR(A.UPD_DT, 'YYYY-MM-DD HH24:MI') UPD_DT
	,A.CNTR_STS_RMK
    ,D.CNMV_STS_CD MVMT_STS_CD
    ,A.CNTR_STS_SEQ
    ,A.CURR_CD
    ,TO_CHAR(GLOBALDATE_PKG.TIME_LOCAL_FNC(SUBSTR(A.YD_CD, 1, 5)) , 'YYYY-MM-DD') TIME_LOCAL
    ,CASE WHEN A.CNTR_STS_CD = 'LSI' AND 
          	   D.CNMV_STS_CD = 'MT' AND 
              NVL((SELECT TO_NUMBER(SUBSTR(MAX(TO_CHAR(CRE_DT,'YYYYMMDDHH24MISS')||LTRIM(TO_CHAR(CNMV_CYC_NO,'0000'))), 15))
               FROM BKG_CONTAINER 
               WHERE CNTR_NO = P.CNTR_NO),88888888) != 9999 THEN 'O'
      ELSE 'X' END DEL_FLG
FROM 
   MST_CNTR_STS_HIS A,
   LSE_AGREEMENT B,
   MDM_VENDOR C,
   MST_CONTAINER D,
   PARAM P
WHERE 1 = 1
AND A.CNTR_NO     = P.CNTR_NO
AND B.AGMT_CTY_CD(+) = A.AGMT_CTY_CD
AND B.AGMT_SEQ(+)    = A.AGMT_SEQ
AND C.VNDR_SEQ(+)    = B.VNDR_SEQ
AND D.CNTR_NO     = A.CNTR_NO
ORDER BY A.CNTR_STS_EVNT_DT, A.CNTR_STS_SEQ			]]></sql>
			<params>
				<param name="cntr_no" type="12" value="" out="N"/>
				<param name="chk_dgt" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
