<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CntrRepoExecutionPlanEstablishDBDAOSearchOnOffHireCntrRepoPlanRSQL">
			<desc><![CDATA[컨테이너 이송 실행 계획 조회 Shuttle (EES_EQR_081) 정보 조회]]></desc>
			<sql><![CDATA[
SELECT 
    PLN_YRWK																				
    ,COMPANY                                                      
    ,DIVISION                                                     
    ,ITEM                           
    ,LEASE      -- LEASE TERM                              
    ,LSR 		-- VENDOR ABBR NM                                   
    ,FRLOC                                                        
    ,ETD                                                          
    ,TOLOC                                                        
    ,ETA                                                          
    ,CNTRNO                                                       
    ,SOSEND                                                       
    ,NOSOSEND                                                     
    ,REFNO														
    ,REASON                                                       
    ,REASONREMARK                                                 
    ,SUM(TOTALVOL)  TOTALVOL   
    
    #foreach(${key} in ${tpszArr}) 
        ,NVL(SUM(${key}VOL),0)     ${key}VOL		
    #end  
    
    ,SUM(TOTALCOST) TOTALCOST                                     
    
    #foreach(${key} in ${tpszArr}) 
        ,NVL(SUM(${key}COST),0)    ${key}COST     
    #end        	
    
    ,REPO_PLN_ID 	-- HIDDEN      
    ,PLN_SEQ        -- HIDDEN                         
    ,VNDR_ABBR_NM	-- HIDDEN                                       
    ,VNDR_CNT_CD	-- HIDDEN                                       
    ,VNDR_SEQ 	    -- HIDDEN                                       
    ,SORTNUM      -- HIDDEN,  PLAN(1), Execution(2), SO(3)를 구분	 
    ,NUM          -- HIDDEN,  NORMAL ROW(1), SUB TOTAL(2), GRAND TOTAL(3) 구분  
    
    ,(
		SELECT 
			DISTINCT RCC_CD 
		FROM 
			EQR_ECC_MST 
		WHERE 
			ECC_CD = FM_ECC
	) FM_RCC     -- From ecc's RCC   
    ,(
		SELECT 
			DISTINCT RCC_CD 
		FROM 
			EQR_ECC_MST 
		WHERE 
			ECC_CD = TO_ECC
	) TO_RCC     -- To   ecc's RCC   
    ,(
		SELECT 
			DISTINCT LCC_CD 
		FROM 
			EQR_ECC_MST 
		WHERE 
			ECC_CD = FM_ECC
	) FM_LCC     -- From ecc's LCC   
    ,(
		SELECT 
			DISTINCT LCC_CD 
		FROM 
			EQR_ECC_MST 
		WHERE 
			ECC_CD = TO_ECC
	) TO_LCC     -- To   ecc's LCC           
    ,FM_ECC     -- FM ECC     									    							
    ,TO_ECC     -- TO ECC     									    							
    
    ,'' CNTRNOINPUT  -- HIDDEN                                    
    ,'' TPSZINPUT    -- HIDDEN                                            
    ,SORT1														
    -- TYPE SIZE별 수정된 VOL 정보를 확인하기 위한 FLAG
    #foreach(${key} in ${tpszArr}) 
    	,'F' ${key}FLAG									
    #end        	
    ,'F' SOCANCEL_FLAG -- HIDDEN(SOCANCEL 확인용)					
    
    ,(
		SELECT 
			WK_ST_DT  
		FROM 
			EQR_WK_PRD 
		WHERE 
			PLN_YR||PLN_WK = PLN_YRWK 
	) WK_ST_DT   -- week from date 
    ,(
		SELECT 
			WK_END_DT 
		FROM 
			EQR_WK_PRD 
		WHERE 
			PLN_YR||PLN_WK = PLN_YRWK 
	) WK_END_DT -- week to date      
    ,(
		SELECT 
			TO_CHAR(TO_DATE(WK_END_DT, 'YYYYMMDD')+49, 'YYYYMMDD') WK_MAX_DT 
		FROM 
			EQR_WK_PRD 
		WHERE 
			PLN_YR||PLN_WK = PLN_YRWK 
	) WK_MAX_DT -- WEEK MAX DATE +7    
    ,TRSPNO_P     -- TRSP P CD COUNT								    							
    ,TRSPNO_D     -- TRSP D CD COUNT								    							
    
    -- 특정 PLAN에 포함된 EXECUTE의 TYPESIZE별 VOL 전체
    #foreach(${key} in ${tpszArr}) 
    	,NVL(SUM(${key}MAXVOL),0) ${key}MAXVOL --HIDDEN 
    #end
    
    -- TYPESIZE VOL별 FEEDBACK 정보
    #foreach(${key} in ${tpszArr})         	
    	,NVL(SUM(${key}BASICRATIO),0) ${key}BASICRATIO --HIDDEN 
    	,NVL(SUM(${key}BASICVOL),0)   ${key}BASICVOL   --HIDDEN 
    #end    
    
    -- TYPESIZE UNIT COST, FROM COST, TO COST
    #foreach(${key} in ${tpszArr})         	
    	,NVL(SUM(${key}UNITCOST),0) ${key}UNITCOST --HIDDEN 
    --	        	      ,NVL(SUM(${key}FROMCOST),0) ${key}FROMCOST --HIDDEN 
    --	        		  ,NVL(SUM(${key}TOCOST),0)   ${key}TOCOST   --HIDDEN 
    #end	        
FROM                                                                
    (                                                                   
    SELECT 
        DECODE(B.NUM, 1, A.PLN_YRWK, 2, A.PLN_YRWK||' TTL', 3, 'TOTAL') PLN_YRWK  
        ,DECODE(B.NUM, 1, A.COMPANY,  2, '', 3, '')  COMPANY 	  
        ,A.DIVISION                                               
        ,DECODE(B.NUM, 1, A.ITEM ,  2, '', 3, '') ITEM            
        ,DECODE(B.NUM, 1, A.LSR,  2, '', 3, '')   LSR -- VENDOR ABBR NM             
        ,DECODE(B.NUM, 1, A.LEASE,  2, '', 3, '')   LEASE -- LEASE TERM
        ,DECODE(B.NUM, 1, A.FRLOC,  2, '', 3, '') FRLOC           
        ,DECODE(B.NUM, 1, A.ETD  ,  2, NULL, 3, NULL) ETD         
        ,DECODE(B.NUM, 1, A.TOLOC,  2, '', 3, '')     TOLOC       
        ,DECODE(B.NUM, 1, A.ETA  ,  2, NULL, 3, NULL) ETA         
        ,DECODE(B.NUM, 1, A.SOSEND  ,  2, NULL, 3, NULL) SOSEND   
        ,DECODE(B.NUM, 1, A.NOSOSEND  ,  2, NULL, 3, NULL) NOSOSEND  
        ,DECODE(B.NUM, 1, A.REASON,  2, '', 3, '') REASON         
        ,DECODE(B.NUM, 1, A.REASONREMARK,  2, '', 3, '') REASONREMARK  
        ,DECODE(B.NUM, 1, A.CNTRNO,  2, '', 3, '') CNTRNO         
        ,SUM(A.TOTALVOL)  TOTALVOL                                
        ,SUM(A.TOTALCOST) TOTALCOST                               
        
        #foreach(${key} in ${tpszArr})                                                
            ,SUM(A.${key}VOL)     ${key}VOL       
            ,SUM(A.${key}COST)    ${key}COST      
        #end                                                                                   
        ,DECODE(B.NUM, 1, A.REFNO,  2, '', 3, '')         REFNO                     
        ,DECODE(B.NUM, 1, A.REPO_PLN_ID,  2, '', 3, '')   REPO_PLN_ID   -- HIDDEN      
        ,DECODE(B.NUM, 1, A.PLN_SEQ,  2, '', 3, '')       PLN_SEQ       -- HIDDEN   
        ,DECODE(B.NUM, 1, A.VNDR_ABBR_NM,  2, '', 3, '')  VNDR_ABBR_NM	-- HIDDEN   
        ,DECODE(B.NUM, 1, A.VNDR_CNT_CD,  2, '', 3, '')   VNDR_CNT_CD	-- HIDDEN   
        ,DECODE(B.NUM, 1, A.VNDR_SEQ,  2, '', 3, '')      VNDR_SEQ 		-- HIDDEN   
        ,A.SORTNUM SORTNUM	-- HIDDEN	                        
        ,B.NUM           	-- HIDDEN 	                        
        ,DECODE(B.NUM, 1, DECODE(A.ITEM, 'O', A.TO_ECC, A.FM_ECC),  2, '', 3, '')  SORT1 -- LOCATION SORTING 
        ,DECODE(B.NUM, 1, A.FM_ECC,  2, '', 3, '') FM_ECC   	        
        ,DECODE(B.NUM, 1, A.TO_ECC,  2, '', 3, '') TO_ECC               
        ,DECODE(B.NUM, 1, A.TRSPNO_P,  2, '', 3, '') TRSPNO_P 		          	  												
        ,DECODE(B.NUM, 1, A.TRSPNO_D,  2, '', 3, '') TRSPNO_D 		          	  												
        
        -- 특정 PLAN에 포함된 EXECUTE의 TYPESIZE별 VOL 전체
        #foreach(${key} in ${tpszArr}) 
            ,SUM(A.${key}MAXVOL) ${key}MAXVOL --HIDDEN 
        #end
        
        -- TYPESIZE VOL별 FEEDBACK 정보
        #foreach(${key} in ${tpszArr})         	
            ,SUM(A.${key}BASICRATIO) ${key}BASICRATIO --HIDDEN 
            ,SUM(A.${key}BASICVOL)   ${key}BASICVOL   --HIDDEN 
        #end    
        
        -- TYPESIZE UNIT COST, FROM COST, TO COST
        #foreach(${key} in ${tpszArr})         	
            ,SUM(A.${key}UNITCOST)   ${key}UNITCOST --HIDDEN 
--	        ,SUM(A.${key}FROMCOST)   ${key}FROMCOST --HIDDEN 
--	        ,SUM(A.${key}TOCOST)     ${key}TOCOST   --HIDDEN 
        #end  
    
    FROM															
        (                                                               
    
            -- PLAN -------------------------------------------			
            SELECT 
				A.PLN_YRWK       
				,A.PLN_SEQ                                    
            	,'' COMPANY  -- E.CO_CD                                     
            	,'Plan' DIVISION                                      
            	,A.ONF_HIR_DIV_CD ITEM   
            	,A.CNTR_LSTM_CD  LEASE                         
            	,'' LSR                                               
            	,DECODE(A.ONF_HIR_DIV_CD, 'F', A.ECC_CD, ' ') FRLOC   
            	,'' ETD                                               
            	,DECODE(A.ONF_HIR_DIV_CD, 'O', A.ECC_CD, ' ') TOLOC   
            	,'' ETA                                               
            	,'' SOSEND                                            
            	,'' NOSOSEND                                          
            	,'' REASON                                            
            	,'' REASONREMARK                                      
            	,'' CNTRNO                                            
--        	  	,SUM(A.CNTR_QTY) TOTALVOL                             
--        	  	,SUM(A.ONF_HIR_COST_AMT) TOTALCOST                    
            	,
            	#foreach(${key} in ${tpszArr}) 
					NVL(MAX(DECODE(A.CNTR_TPSZ_CD, '${key}', A.CNTR_QTY)),0)
					#if($velocityCount < $tpszArr.size()) 
						+
					#end
            	#end	
            	TOTALVOL                       									
            	,
            	#foreach(${key} in ${tpszArr}) 
					NVL(MAX(DECODE(A.CNTR_TPSZ_CD, '${key}', A.ONF_HIR_COST_AMT)),0)
					#if($velocityCount < $tpszArr.size()) 
						+
					#end
            	#end	
            	TOTALCOST                       									
            
            	#foreach(${key} in ${tpszArr}) 
            		,NVL(MAX(DECODE(A.CNTR_TPSZ_CD, '${key}', A.CNTR_QTY)),0) 		 ${key}VOL  
            		,NVL(MAX(DECODE(A.CNTR_TPSZ_CD, '${key}', A.ONF_HIR_COST_AMT)),0) ${key}COST 
            	#end
            	,'' REFNO                                     			
            	,A.REPO_PLN_ID 		-- HIDDEN                           
            	,'' VNDR_ABBR_NM 	-- HIDDEN                           	
            	,'' VNDR_CNT_CD 	-- HIDDEN                           	
            	,0 VNDR_SEQ  		-- HIDDEN    	                    	
            	,1 SORTNUM    	-- HIDDEN	  	  	                	
            	,DECODE(A.ONF_HIR_DIV_CD, 'F', A.ECC_CD, ' ') FM_ECC -- SORT에 사용될 SCC의 해당 FM ECC 정보 
            	,DECODE(A.ONF_HIR_DIV_CD, 'O', A.ECC_CD, ' ') TO_ECC -- SORT에 사용될 SCC의 해당 TO ECC 정보  	                	
            	,0 TRSPNO_P                                                  	                	  	  
            	,0 TRSPNO_D                                                  	                	  	  
            
            	-- 특정 PLAN에 포함된 EXECUTE의 TYPESIZE별 VOL 전체
            	#foreach(${key} in ${tpszArr}) 
            		,NVL(MAX(DECODE(E.CNTR_TPSZ_CD, '${key}', E.MAX_QTY)),0) ${key}MAXVOL --HIDDEN 
            	#end
            
            	-- TYPESIZE VOL별 FEEDBACK 정보
            	#foreach(${key} in ${tpszArr}) 
            		#if(${key} == 'S2') 		
						#set($tranTpsz = "O2")
					#elseif(${key} == 'S4')
						#set($tranTpsz = "O4")
        			#elseif(${key} == 'A2') 	
						#set($tranTpsz = "F2")
        			#elseif(${key} == 'A4')
						#set($tranTpsz = "F4")
--        	 		project_name : 신규 장비(F5-40ft H/C Flat rack) 발주에 따른 NIS 상에 F5 등록
        			#elseif(${key} == 'F5') 	
						#set($tranTpsz = "F4")
        			#else
						#set($tranTpsz = ${key})
					#end
            
            		,NVL(MAX(DECODE(F.CNTR_TPSZ_CD, '$tranTpsz', F.FB_RTO)),0)       ${key}BASICRATIO --HIDDEN 
            		,NVL(MAX(DECODE(F.CNTR_TPSZ_CD, '$tranTpsz', F.CNTR_VOL_QTY)),0) ${key}BASICVOL   --HIDDEN 
            		,NVL(MAX(DECODE(A.CNTR_TPSZ_CD, '$tranTpsz', A.PLN_UC_AMT)),0)   ${key}UNITCOST --HIDDEN 
            	#end 
            
            FROM 
				(
				    SELECT
				        A0.REPO_PLN_ID
				        ,A0.PLN_YRWK
				        ,A0.PLN_SEQ
				        ,A0.ONF_HIR_DIV_CD
				        ,A0.ECC_CD
				        ,A0.CNTR_LSTM_CD
				        ,Q.CNTR_TPSZ_CD
				        ,Q.PLN_UC_AMT
				        ,Q.CNTR_QTY
				        ,Q.ONF_HIR_COST_AMT
				    FROM
				        EQR_ONF_HIR_PLN A0, 
				        EQR_ONF_HIR_PLN_QTY Q
				    WHERE
				        A0.REPO_PLN_ID = Q.REPO_PLN_ID
            		    AND A0.PLN_YRWK = Q.PLN_YRWK
            		    AND A0.PLN_SEQ  = Q.PLN_SEQ
				) A ,                                        	
            
            	-- reason, company, sosend 검색정보 사용시만 조인쿼리를 사용합니다.
            	#if(${reason} != '' ||  ${sosend} != '') 
            	( 													          	
            		SELECT 
						DISTINCT A.REPO_PLN_ID						
            			,A.PLN_YRWK		
            			,A.PLN_SEQ							
            			,A.REF_ID				
            			,A.CO_CD					
            			,Q.CNTR_TPSZ_CD								
            			,A.CO_CD                                     
            			,A.ONF_HIR_DIV_CD                            
            			,A.FM_YD_CD                                  
            			,A.TO_YD_CD                                  
            			,A.REPO_PLN_FB_RSN_CD                        
            			,A.SO_ISS_FLG                                            
            			,A.NON_SO_ISS_FLG                                        
            			,B.ECC_CD FM_ECC								
            			,C.ECC_CD TO_ECC								
            		FROM 
						EQR_ONF_HIR_EXE_PLN A, 	
						EQR_ONF_HIR_EXE_PLN_QTY Q,					
            			MDM_EQ_ORZ_CHT B,								
            			MDM_EQ_ORZ_CHT C								
            		WHERE 
            		    A.REPO_PLN_ID = Q.REPO_PLN_ID
            		    AND A.PLN_YRWK = Q.PLN_YRWK
            		    AND A.PLN_SEQ  = Q.PLN_SEQ
            		    AND A.REF_ID = Q.REF_ID
						AND SUBSTR(A.FM_YD_CD, 0, 5) = B.SCC_CD 			
            			AND   SUBSTR(A.TO_YD_CD, 0, 5) = C.SCC_CD   		
            
            			#if(${reason} != '')
							AND A.REPO_PLN_FB_RSN_CD IN ( ${reasonStrArr} )
						#end              
            		         
            			#if(${sosend} != '')
							AND (	
								A.SO_ISS_FLG = @[sosend] 
								OR 
								A.NON_SO_ISS_FLG= @[sosend]
							)
						#end 
            
            	) B, 													
            	#end
            
            	(			                                                    
            		SELECT 
            			A.PLN_YRWK         
            			,A.PLN_SEQ
            			,A.CO_CD                         	                               	
                        ,A.ONF_HIR_DIV_CD                                                       
                        ,DECODE(A.ONF_HIR_DIV_CD, 'F', B.ECC_CD, ' ') FM_ECC								
                        ,DECODE(A.ONF_HIR_DIV_CD, 'O', C.ECC_CD, ' ') TO_ECC 
                        ,Q.CNTR_TPSZ_CD                                    	
                        ,SUM(Q.CNTR_QTY) MAX_QTY                             
                    FROM 
                        EQR_ONF_HIR_EXE_PLN A,    
                        EQR_ONF_HIR_EXE_PLN_QTY Q,	                            
                        MDM_EQ_ORZ_CHT B,                                     
                        MDM_EQ_ORZ_CHT C                                      
                    WHERE 
                        A.REPO_PLN_ID = Q.REPO_PLN_ID
            		    AND A.PLN_YRWK = Q.PLN_YRWK
            		    AND A.PLN_SEQ  = Q.PLN_SEQ
            		    AND A.REF_ID = Q.REF_ID
						AND SUBSTR(A.FM_YD_CD, 0, 5) = B.SCC_CD 	                
                        AND SUBSTR(A.TO_YD_CD, 0, 5) = C.SCC_CD 					
                        AND A.REPO_PLN_ID = @[repoPlanID]                     
            
-- CSR No : N200906040080 의거 변경 
-- 추가 내용 : Fm/To , At일 경우는 PLN_YRWK으로 조건을 걸고 Fm ETD 경우 FM_ETD_DT로, To ETA일경우 TO_ETA_DT로 조건을 건다.

--	                    AND   A.PLN_YRWK BETWEEN  fromWeek  AND  toWeek    
                        #if(${fmtoat} == '3' ) --Fm ETD
                            AND  A.FM_LOC_DT  BETWEEN (
                                                        SELECT 
                                                            WK_ST_DT  
                                                        FROM 
                                                            EQR_WK_PRD 
                                                        WHERE 
                                                            PLN_YR||PLN_WK = @[fromWeek]
                                                      )   
                                                      AND 
                                                      ( 
                                                        SELECT 
                                                            WK_END_DT  
                                                        FROM 
                                                            EQR_WK_PRD 
                                                        WHERE 
                                                            PLN_YR||PLN_WK = @[toWeek]
                                                      )    	  	
                        #elseif(${fmtoat} == '4') --To ETA
                            AND  A.TO_LOC_DT  BETWEEN (
                                                        SELECT 
                                                            WK_ST_DT  
                                                        FROM 
                                                            EQR_WK_PRD 
                                                        WHERE 
                                                            PLN_YR||PLN_WK = @[fromWeek]
                                                      ) 
                                                      AND 
                                                      (
                                                        SELECT 
                                                            WK_END_DT  
                                                        FROM 
                                                            EQR_WK_PRD 
                                                        WHERE 
                                                            PLN_YR||PLN_WK = @[toWeek]
                                                      )    		
                        #else  -- Fm/To , At일경우 
                            AND   A.PLN_YRWK BETWEEN @[fromWeek] AND @[toWeek]   	
                        #end
            
                    GROUP BY 
                        A.PLN_YRWK  
                        ,A.PLN_SEQ  
                        ,A.CO_CD                             	                               	
                        ,A.ONF_HIR_DIV_CD                                                                                            	
                        ,DECODE(A.ONF_HIR_DIV_CD, 'F', B.ECC_CD, ' ')							
                        ,DECODE(A.ONF_HIR_DIV_CD, 'O', C.ECC_CD, ' ')      
                        ,Q.CNTR_TPSZ_CD						            
                ) E,                                                           
                (                                                              
                    SELECT 
                        FB_ITM_CD ITEM                                      
                        ,A.CNTR_TPSZ_CD                                      
                        ,A.FB_RTO                                            
                        ,A.CNTR_VOL_QTY                                      
                    FROM 
                        EQR_REPO_EXE_PLN_FB A,                                
                        COM_INTG_CD_DTL B    				  	                
                    WHERE 
                        A.FB_ITM_CD = B.INTG_CD_VAL_CTNT  							
                        AND   B.INTG_CD_ID = 'CD00565'		 						 				 
--                  GROUP BY FB_ITM_CD                                        
                ) F	          		                                            
            
            WHERE 
                1=1     	                                                
            
                -- reason, company, sosend 검색정보 사용시만 조인쿼리를 사용합니다.
                #if(${reason} != '' || ${sosend} != '') 
                    AND   A.REPO_PLN_ID = B.REPO_PLN_ID                        	
                    AND   A.PLN_YRWK    = B.PLN_YRWK                         	
                    AND   A.PLN_SEQ     = B.PLN_SEQ                          	
                    AND   A.ONF_HIR_DIV_CD = B.ONF_HIR_DIV_CD                  	
                    AND   (
							A.ECC_CD=B.FM_ECC 
							OR 
							A.ECC_CD=B.TO_ECC
						  ) 				        
                #end        
                AND   A.ONF_HIR_DIV_CD IN ('O', 'F')                        	
                AND   A.REPO_PLN_ID = @[repoPlanID]                        	
                AND   A.PLN_YRWK BETWEEN @[fromWeek] AND @[toWeek]      	
                
                AND   A.PLN_YRWK       = E.PLN_YRWK(+)  
                AND   A.PLN_SEQ        = E.PLN_SEQ(+)                          
                AND   A.ONF_HIR_DIV_CD = E.ONF_HIR_DIV_CD(+)                    
                AND   DECODE(A.ONF_HIR_DIV_CD, 'F', A.ECC_CD, ' ') = E.FM_ECC(+)
                AND   DECODE(A.ONF_HIR_DIV_CD, 'O', A.ECC_CD, ' ') = E.TO_ECC(+)
                AND   A.ONF_HIR_DIV_CD = F.ITEM(+)					            			
            
                -- user location 
                #if(${userECC} != '')          
                    AND A.ECC_CD IN ( ${userLocWhere} )             
                #end
                -- FROMTO
                -- CSR No:N200906040080 의거 Fm ETD, To ETA 조건 추가
                -- fmtoat 3 : Fm ETD , fmtoat 4 : To ETA
                -- IF ( fmtoat 1   &&  fromStatus != '' )        AND A.ECC_CD IN  frLocWhere  --원본  
                #if( ( ${fmtoat} == '1' || ${fmtoat} =='3' || ${fmtoat} == '4' ) && ${fromStatus} != '')        
                    AND A.ECC_CD IN ( ${frLocWhere} ) 
                #end
                #if(${tpsz} != '' && ${tpsztype} != '')	        
                    AND A.CNTR_TPSZ_CD IN ( ${tpszWhere} )   
                #end      
                #if(${itemname} != '') 						        
                    AND A.ONF_HIR_DIV_CD IN ( ${itemnameWhere} ) 				
                #end
            
            GROUP BY 
                A.PLN_YRWK       
                ,A.PLN_SEQ         
                ,E.CO_CD                           	
                ,A.ONF_HIR_DIV_CD   
                ,A.CNTR_LSTM_CD                                  	
                ,DECODE(A.ONF_HIR_DIV_CD, 'F', A.ECC_CD, ' ')           
                ,DECODE(A.ONF_HIR_DIV_CD, 'O', A.ECC_CD, ' ')           
                ,A.REPO_PLN_ID                                        	
        -- Execution ---------------------------------------          	
        UNION                                                       	
            SELECT 
                A.PLN_YRWK PLN_YRWK  
                ,A.PLN_SEQ                                	
                ,A.CO_CD COMPANY                                      	
                ,'Execution' DIVISION                                   	
                ,A.ONF_HIR_DIV_CD ITEM  
                ,'' LEASE                              	
                ,A.VNDR_ABBR_NM LSR                                   	
                ,A.FM_YD_CD FRLOC                                     	
                ,A.FM_LOC_DT ETD                                      	
                ,A.TO_YD_CD TOLOC                                     	
                ,A.TO_LOC_DT ETA                                      	
                ,A.SO_ISS_FLG SOSEND                                  	
                ,A.NON_SO_ISS_FLG SOSEND                     				            
                ,A.REPO_PLN_FB_RSN_CD REASON                          	
                ,A.REPO_PLN_FB_RMK REASONREMARK                       	
                ,CASE WHEN A.PLN_YRWK = C.PLN_YRWK AND A.REF_ID = C.REF_ID THEN 
					'0'  -- CNTR 존재      
                ELSE 
					'1'  -- CNTR 존재안함  
                END CNTRNO            		
                --        	  ,MAX(A.CNTR_QTY) TOTALVOL                             
                --        	  ,MAX(A.ONF_HIR_COST_AMT) TOTALCOST   
				,                 
                #foreach(${key} in ${tpszArr}) 
					NVL(MAX(DECODE(A.CNTR_TPSZ_CD, '${key}', A.CNTR_QTY)),0)
					#if($velocityCount < $tpszArr.size()) 
						+
					#end
                #end	
                TOTALVOL                       									
                ,
                #foreach(${key} in ${tpszArr}) 
                	NVL(MAX(DECODE(A.CNTR_TPSZ_CD, '${key}', A.ONF_HIR_COST_AMT)),0)
					#if($velocityCount < $tpszArr.size()) 
						+
					#end
                #end	
                TOTALCOST                       									
                
                #foreach(${key} in ${tpszArr}) 
                	,NVL(MAX(DECODE(A.CNTR_TPSZ_CD, '${key}', A.CNTR_QTY)),0) 		 ${key}VOL  
                	,NVL(MAX(DECODE(A.CNTR_TPSZ_CD, '${key}', A.ONF_HIR_COST_AMT)),0) ${key}COST 
                #end	
                
                ,A.REF_ID REFNO										
                ,A.REPO_PLN_ID 				-- HIDDEN               
                ,A.VNDR_ABBR_NM VNDR_ABBR_NM 	-- HIDDEN               
                ,A.VNDR_CNT_CD  VNDR_CNT_CD 	-- HIDDEN               
                ,A.VNDR_SEQ     VNDR_SEQ  	-- HIDDEN    	        
                ,2 SORTNUM   					-- HIDDEN               
                ,A.FM_ECC  -- SORT에 사용될 SCC의 해당 FM ECC 정보    	
                ,A.TO_ECC  -- SORT에 사용될 SCC의 해당 TO ECC 정보    	
                ,CASE WHEN A.PLN_YRWK = D.PLN_YRWK AND A.REF_ID = D.REF_ID THEN 
					D.TRSPCOUNT_P  -- TRSP 존재        
                ELSE 
					0              -- TRSP 존재안함    
                END TRSPNO_P                   		  
                ,CASE WHEN A.PLN_YRWK = D.PLN_YRWK AND A.REF_ID = D.REF_ID THEN 
					D.TRSPCOUNT_D  -- TRSP 존재        
                ELSE 
					0            -- TRSP 존재안함      
                END TRSPNO_D                     	  
                
                -- 특정 PLAN에 포함된 EXECUTE의 TYPESIZE별 VOL 전체
                #foreach(${key} in ${tpszArr}) 
                	,0 ${key}MAXVOL --HIDDEN 					
                #end
                
                -- TYPESIZE VOL별 FEEDBACK 정보
                #foreach(${key} in ${tpszArr})         	
                	,0   ${key}BASICRATIO --HIDDEN 			
                	,0   ${key}BASICVOL   --HIDDEN 			
                	,NVL(MAX(DECODE(A.CNTR_TPSZ_CD, '${key}', A.PLN_UC_AMT)),0)      ${key}UNITCOST --HIDDEN 
                #end    
    
            FROM 
                (                                 						
                    SELECT 
                        A.REPO_PLN_ID       						
                        ,A.PLN_YRWK         
                        ,A.PLN_SEQ                         
                        ,A.REF_ID                                    
                        ,Q.CNTR_TPSZ_CD                              
                        ,A.CO_CD                                     
                        ,A.ONF_HIR_DIV_CD                            
                        ,A.VNDR_CNT_CD                               
                        ,A.VNDR_SEQ                                  
                        ,A.VNDR_ABBR_NM                              
                        ,A.FM_YD_CD                                  
                        ,A.FM_LOC_DT                                 
                        ,A.TO_YD_CD                                  
                        ,A.TO_LOC_DT                                 
                        ,A.REPO_PLN_FB_RSN_CD                        
                        ,A.REPO_PLN_FB_RMK                           
                        ,Q.CNTR_QTY                                  
                        ,Q.ONF_HIR_COST_AMT                          
                        ,A.SO_RQST_DT                                
                        ,A.SO_ISS_FLG                                
                        ,A.NON_SO_ISS_FLG                            
                        ,B.ECC_CD FM_ECC								
                        ,C.ECC_CD TO_ECC								
                        ,Q.PLN_UC_AMT                                		
                        --	                               ,A.FM_ECC_COST_AMT                           		
                        --	                               ,A.TO_ECC_COST_AMT                           			        	        
                    FROM 
                        EQR_ONF_HIR_EXE_PLN A,
                        EQR_ONF_HIR_EXE_PLN_QTY Q, 						
                        MDM_EQ_ORZ_CHT B,								
                        MDM_EQ_ORZ_CHT C								
                    WHERE 
                        A.REPO_PLN_ID = Q.REPO_PLN_ID
            		    AND A.PLN_YRWK = Q.PLN_YRWK
            		    AND A.PLN_SEQ  = Q.PLN_SEQ
            		    AND A.REF_ID = Q.REF_ID
                        AND SUBSTR(A.FM_YD_CD, 0, 5) = B.SCC_CD 			
                        AND   SUBSTR(A.TO_YD_CD, 0, 5) = C.SCC_CD   		
                ) A,     												
--              EQR_ONF_HIR_PLN B,                                     
                (                                                      
                    SELECT 
                        A.REPO_PLN_ID
                        , A.PLN_YRWK
                        , A.PLN_SEQ
                        , A.REF_ID
                        , NVL(COUNT(*), 0) REFCOUNT  
                    FROM 
                        EQR_EXE_PLN_CNTR A,							
                        EQR_ONF_HIR_EXE_PLN B ,						
                        EQR_ONF_HIR_EXE_PLN_QTY Q                          
                    WHERE 
                        A.REPO_PLN_ID = B.REPO_PLN_ID                
                        AND   A.PLN_YRWK    = B.PLN_YRWK             
                        AND   A.PLN_SEQ     = B.PLN_SEQ                  
                        AND   A.REF_ID      = B.REF_ID     
                        AND   B.REPO_PLN_ID = Q.REPO_PLN_ID                
                        AND   B.PLN_YRWK    = Q.PLN_YRWK                 
                        AND   B.PLN_SEQ     = Q.PLN_SEQ                   
                        AND   B.REF_ID      = Q.REF_ID                
--                      AND   A.CNTR_TPSZ_CD= B.CNTR_TPSZ_CD                     
                        AND   B.REPO_PLN_ID = @[repoPlanID]	            
--	                	AND   B.PLN_YRWK BETWEEN  fromWeek  AND  toWeek     
        
                        -- CSR No : N200906040080 의거 변경 
                        -- 추가 내용 : Fm/To 일 경우는 PLN_YRWK으로 조건을 걸고 Fm ETD 경우 FM_ETD_DT로, To ETA일경우 TO_ETA_DT로 조건을 건다.
                        #if(${fmtoat} == '3') --Fm ETD
                            AND  B.FM_LOC_DT  BETWEEN 	(
															SELECT 
																WK_ST_DT  
															FROM 
																EQR_WK_PRD 
															WHERE 
																PLN_YR||PLN_WK = @[fromWeek]
													  	)   
													  	AND 
													 	(
															SELECT 
																WK_END_DT  
															FROM 
																EQR_WK_PRD 
															WHERE 
																PLN_YR||PLN_WK = @[toWeek]
														)    	  	
                        #elseif(${fmtoat} == '4') --To ETA
                            AND  B.TO_LOC_DT  BETWEEN 	(
															SELECT 
																WK_ST_DT  
															FROM 
																EQR_WK_PRD 
															WHERE 
																PLN_YR||PLN_WK = @[fromWeek]
														)   
														AND 
														(
															SELECT 
																WK_END_DT  
															FROM 
																EQR_WK_PRD 
															WHERE 
																PLN_YR||PLN_WK = @[toWeek]
														)    		
                        #else  -- Fm/To  
                            AND  B.PLN_YRWK BETWEEN @[fromWeek] AND @[toWeek]   	
                        #end
                        
                        -- user location 
                        #if(${userECC} != '') 
                        	AND (
									SUBSTR(B.FM_YD_CD, 0, 5) IN (
																SELECT 
																	SCC_CD 
																FROM 
																	MDM_EQ_ORZ_CHT 
																WHERE 
																	ECC_CD IN ( ${userLocWhere} ) 
									) 
								OR 
									SUBSTR(B.TO_YD_CD, 0, 5) IN (
																SELECT 
																	SCC_CD 
																FROM 
																	MDM_EQ_ORZ_CHT 
																WHERE 
																	ECC_CD IN ( ${userLocWhere} )
									)
								) 
                        #end
                        
                        #if(${fmtoat} == '1' && ${fromStatus} != '') 
                        	AND SUBSTR(B.FM_YD_CD, 0, 5) IN (
																SELECT 
																	SCC_CD 
																FROM 
																	MDM_EQ_ORZ_CHT 
																WHERE 
																	ECC_CD IN ( ${frLocWhere} ) 
							) 
                        #end       
                        --CSR No:N200906040080 의거 Fm ETD, To ETA 조건 추가
                        -- fmtoat.equals('3'): Fm ETD , fmtoat.equals('4'): To ETA
                        #if(${fmtoat} == '3' && ${fromStatus} != '') 
                        	AND SUBSTR(B.FM_YD_CD, 0, 5) IN (
																SELECT 
																	SCC_CD 
																FROM 
																	MDM_EQ_ORZ_CHT 
																WHERE 
																	ECC_CD IN ( ${frLocWhere} )
							) 
                        #end    
                        
                        #if(${fmtoat} == '4' && ${fromStatus} != '' ) 
                        	AND SUBSTR(B.FM_YD_CD, 0, 5) IN (
																SELECT 
																	SCC_CD 
																FROM 
																	MDM_EQ_ORZ_CHT 
																WHERE 
																	ECC_CD IN ( ${frLocWhere} ) 
							) 
                        #end    
                        --CSR NO: N200906040080 끝 
                        
                        #if(${tpsz} != ''  && ${tpsztype} != '') 
                        	AND Q.CNTR_TPSZ_CD IN ( ${tpszWhere} ) 
						#end			                
                        #if(${reason} != '') 	        		 
							AND B.REPO_PLN_FB_RSN_CD IN ( ${reasonWhere} )
						#end
                        #if(${itemname} != '')
							AND B.ONF_HIR_DIV_CD IN ( ${itemnameWhere} )
						#end
                        #if(${sosend} != '')          		 
							AND (
									B.SO_ISS_FLG = @[sosend]
								OR 
									B.NON_SO_ISS_FLG = @[sosend]
								)
        				#end
                    GROUP BY 
                        A.REPO_PLN_ID
                        , A.PLN_SEQ
                        , A.PLN_YRWK
                        , A.REF_ID       
                    HAVING 
                        NVL(COUNT(*), 0) > 0                        
                ) C,                                                           
        
                (                                                      
--        	        SELECT A.REPO_PLN_ID, A.PLN_YRWK, A.REF_ID, NVL(COUNT(*), 0) TRSPCOUNT   
                    SELECT 
                        A.REPO_PLN_ID
                        , A.PLN_YRWK
                        , A.PLN_SEQ
                        , A.REF_ID
                        , NVL(SUM(DECODE(A.TRSP_SO_STS_CD, 'P', 1, 0)), 0) TRSPCOUNT_P
                        , NVL(SUM(DECODE(A.TRSP_SO_STS_CD, 'D', 1, 0)), 0) TRSPCOUNT_D   
                    FROM                                               
                        (                                                  
                            SELECT 
                                A.REPO_PLN_ID
                                , A.PLN_YRWK
                                , A.PLN_SEQ
                                , A.REF_ID
                                , A.CNTR_TPSZ_CD
                                , A.TRSP_SO_STS_CD	
                            FROM 
                                EQR_REPO_EXE_SO_IF A,                     
                                EQR_ONF_HIR_EXE_PLN B,                     
                                EQR_ONF_HIR_EXE_PLN_QTY Q                     
                            
                            WHERE 
                                A.REPO_PLN_ID = B.REPO_PLN_ID            
                                AND   A.PLN_YRWK    = B.PLN_YRWK          
                                AND   A.PLN_SEQ     = B.PLN_SEQ               
                                AND   A.REF_ID      = B.REF_ID                 
                                AND   B.REPO_PLN_ID = Q.REPO_PLN_ID            
                                AND   B.PLN_YRWK    = Q.PLN_YRWK            
                                AND   B.PLN_SEQ     = Q.PLN_SEQ              
                                AND   B.REF_ID      = Q.REF_ID                 
                                AND   A.CNTR_TPSZ_CD= Q.CNTR_TPSZ_CD                 
                                AND   B.REPO_PLN_ID = @[repoPlanID]	        
                                --         		     AND   B.PLN_YRWK BETWEEN  fromWeek  AND  toWeek   
                                
                                -- CSR No : N200906040080 의거 변경 
                                -- 추가 내용 : Fm/To 일 경우는 PLN_YRWK으로 조건을 걸고 Fm ETD 경우 FM_ETD_DT로, To ETA일경우 TO_ETA_DT로 조건을 건다.
                                #if(${fmtoat} == '3') --Fm ETD
                               		AND  B.FM_LOC_DT  BETWEEN 	(
																	SELECT 
																		WK_ST_DT  
																	FROM 
																		EQR_WK_PRD 
																	WHERE 
																		PLN_YR||PLN_WK = @[fromWeek]
																)   
																AND 
																(	
																	SELECT 
																		WK_END_DT  
																	FROM 
																		EQR_WK_PRD 
																	WHERE 
																		PLN_YR||PLN_WK = @[toWeek]
																)    	  	
                                #elseif(${fmtoat} == '4') --To ETA
                                	AND  B.TO_LOC_DT  BETWEEN 	(
																	SELECT 
																		WK_ST_DT  
																	FROM 
																		EQR_WK_PRD 
																	WHERE 
																		PLN_YR||PLN_WK = @[fromWeek]
																)   
																AND 
																(
																	SELECT 
																		WK_END_DT  
																	FROM 
																		EQR_WK_PRD 
																	WHERE 
																		PLN_YR||PLN_WK = @[toWeek]
																)    		
                                #else  -- Fm/To  
                                	AND  B.PLN_YRWK BETWEEN @[fromWeek] AND @[toWeek]   	
                                #end
                                
                                
                                -- modified by shin yongchan - 20081020 
                                -- CSR NO : N200810240024
                                -- 'P' - S/O Send 최초 
                                -- 'D' - TRS모듈에서 W/O 시도후 취소 상태
                                -- P, D 모두 S/O Cancel 대상으로 포함
                                --        		     AND   A.TRSP_SO_STS_CD = 'P'                -- 중요
                                AND   A.TRSP_SO_STS_CD IN ('P', 'D')             -- 중요
                                
                                -- user location 
                                #if(${userECC} != '')	        				        		     
									AND (
											SUBSTR(B.FM_YD_CD, 0, 5) IN (
																		SELECT 
																			SCC_CD 	
																		FROM 
																			MDM_EQ_ORZ_CHT 
																		WHERE 
																			ECC_CD IN ( ${userLocWhere} )
																		) 
										OR 
											SUBSTR(B.TO_YD_CD, 0, 5) IN (
																		SELECT 
																			SCC_CD 
																		FROM 
																			MDM_EQ_ORZ_CHT 
																		WHERE 
																			ECC_CD IN ( ${userLocWhere} )
																		)
										) 
								#end
                                --CSR No:N200906040080 의거 Fm ETD, To ETA 조건 추가
                                -- fmtoat.equals('3'): Fm ETD , fmtoat.equals('4'): To ETA
                                -- IF( fmtoat 1  && fromStatus != '' )        		     AND SUBSTR(B.FM_YD_CD, 0, 5) IN (SELECT SCC_CD FROM MDM_EQ_ORZ_CHT WHERE ECC_CD IN  frLocWhere  )  --원본 
                                #if((${fmtoat} == '1' || ${fmtoat} == '3' || ${fmtoat} == '4') && ${fromStatus} != '')
									AND SUBSTR(B.FM_YD_CD, 0, 5) IN (
																		SELECT 
																			SCC_CD 
																		FROM 
																			MDM_EQ_ORZ_CHT 
																		WHERE 
																			ECC_CD IN ( ${frLocWhere} )
									) 
								#end
                                #if(${tpsz} != '' && ${tpsztype} != '') 	        		     
									AND Q.CNTR_TPSZ_CD IN ( ${tpszWhere} )
								#end
                                #if(${reason} != '')  						        		     
									AND B.REPO_PLN_FB_RSN_CD IN ( ${reasonWhere} )
								#end
                                #if(${itemname} != '')						        		     
									AND B.ONF_HIR_DIV_CD IN ( ${itemnameWhere} ) 			         
                                #end
								#if(${sosend} != '')  						        		     
									AND (
											B.SO_ISS_FLG = @[sosend] 
										OR 
											B.NON_SO_ISS_FLG = @[sosend]
										)
								#end
                        
                        ) A	                                            
                    GROUP BY 
                        A.REPO_PLN_ID
                        , A.PLN_YRWK
                        , A.PLN_SEQ
                        , A.REF_ID       
--        		        HAVING NVL(COUNT(*), 0) > 0                        
                ) D                                                      
        
            WHERE 
                A.REPO_PLN_ID = @[repoPlanID]                      
--              AND   A.PLN_YRWK BETWEEN  fromWeek  AND toWeek    
        
                -- CSR No : N200906040080 의거 변경 
                -- 추가 내용 : Fm/To 일 경우는 PLN_YRWK으로 조건을 걸고 Fm ETD 경우 FM_ETD_DT로, To ETA일경우 TO_ETA_DT로 조건을 건다.
                #if(${fmtoat} == '3') --Fm ETD
                	AND  A.FM_LOC_DT  BETWEEN 	(
													SELECT 
														WK_ST_DT  
													FROM 
														EQR_WK_PRD 
													WHERE 
														PLN_YR||PLN_WK = @[fromWeek]
												)   
												AND 
												(
													SELECT 
														WK_END_DT  
													FROM 
														EQR_WK_PRD 
													WHERE 
														PLN_YR||PLN_WK = @[toWeek]
												)    	  	
                #elseif(${fmtoat} == '4') --To ETA
                	AND  A.TO_LOC_DT  BETWEEN 	(
													SELECT 
														WK_ST_DT  
													FROM 
														EQR_WK_PRD 
													WHERE 
														PLN_YR||PLN_WK = @[fromWeek]
												)   
												AND 
												(
													SELECT 
														WK_END_DT  
													FROM 
														EQR_WK_PRD 
													WHERE 
														PLN_YR||PLN_WK = @[toWeek]
												)    		
                #else  -- Fm/To  
                	AND  A.PLN_YRWK BETWEEN @[fromWeek] AND @[toWeek]   	
                #end
                
                --        WHERE A.REPO_PLN_ID = B.REPO_PLN_ID                         
                --        AND   A.PLN_YRWK    = B.PLN_YRWK                            
                --        AND   A.ONF_HIR_DIV_CD = B.ONF_HIR_DIV_CD                   
                --        AND   B.ONF_HIR_DIV_CD IN ('O', 'F')                        
                
                --        --AND   A.CNTR_TPSZ_CD   = B.CNTR_TPSZ_CD                   
                --        AND   (A.FM_ECC = B.ECC_CD OR A.TO_ECC = B.ECC_CD)   		
                AND   A.PLN_YRWK = C.PLN_YRWK(+) 		
                AND   A.PLN_SEQ  = C.PLN_SEQ(+)							
                AND   A.REF_ID   = C.REF_ID(+)   							 
                AND   A.PLN_YRWK = D.PLN_YRWK(+)							
                AND   A.REF_ID   = D.REF_ID(+)   							 
                
                -- user location 
                #if(${userECC} != '') 			        	        
					AND (
							A.FM_ECC IN ( ${userLocWhere} )
						OR 
							A.TO_ECC IN ( ${userLocWhere} )
						) 
				#end
                --CSR No:N200906040080 의거 Fm ETD, To ETA 조건 추가
                -- fmtoat.equals('3'): Fm ETD , fmtoat.equals('4'): To ETA
                -- IF(fmtoat 1  &&  fromStatus != '' )        AND (A.FM_ECC IN  frLocWhere  OR A.TO_ECC IN  frLocWhere ) 	
                #if( ( ${fmtoat} == '1' || ${fmtoat} == '3' || ${fmtoat} == '4' ) && ${fromStatus} != '')        
					AND (
							A.FM_ECC IN ( ${frLocWhere} ) 
						OR 
							A.TO_ECC IN ( ${frLocWhere} )
						) 	
				#end
                #if(${tpsz} != '' && ${tpsztype} != '')	        
					AND   A.CNTR_TPSZ_CD IN ( ${tpszWhere} )  
				#end
                #if(${reason} != '') 	        				        
					AND   A.REPO_PLN_FB_RSN_CD IN ( ${reasonWhere} ) 
				#end
                #if(${itemname} != '') 	        			        
					AND   A.ONF_HIR_DIV_CD IN ( ${itemnameWhere} )
				#end
                #if(${sosend} != '') 	        				        
					AND (
							A.SO_ISS_FLG = @[sosend]
						OR 
							A.NON_SO_ISS_FLG = @[sosend]
						)
				#end
        
            GROUP BY 
                A.PLN_YRWK    
                ,A.PLN_SEQ                                     
                ,A.CO_CD                                              
                ,A.ONF_HIR_DIV_CD                                     
                ,A.VNDR_ABBR_NM                                       
                ,A.FM_YD_CD                                           
                ,A.FM_LOC_DT                                          
                ,A.TO_YD_CD                                           
                ,A.TO_LOC_DT                                          
                ,A.SO_ISS_FLG                                         
                ,A.NON_SO_ISS_FLG                                     
                ,A.REPO_PLN_FB_RSN_CD                                 
                ,A.REPO_PLN_FB_RMK                                    
                ,A.REF_ID                                             
                ,A.VNDR_ABBR_NM                                       
                ,A.VNDR_CNT_CD                                        
                ,A.VNDR_SEQ                                           
                ,CASE WHEN A.PLN_YRWK = C.PLN_YRWK AND A.REF_ID = C.REF_ID THEN 
                    '0'               
                ELSE 
                    '1'               
                END                    
                ,A.REPO_PLN_ID									    
                ,A.FM_ECC  -- SORT에 사용될 SCC의 해당 FM ECC 정보		
                ,A.TO_ECC  -- SORT에 사용될 SCC의 해당 TO ECC 정보					  			  								    
                ,CASE WHEN A.PLN_YRWK = D.PLN_YRWK AND A.REF_ID = D.REF_ID THEN 
                    D.TRSPCOUNT_P  -- TRSP 존재     
                ELSE 
                    0              -- TRSP 존재안함 
                END                     	  	    
                ,CASE WHEN A.PLN_YRWK = D.PLN_YRWK AND A.REF_ID = D.REF_ID THEN 
                    D.TRSPCOUNT_D  -- TRSP 존재     
                ELSE 
                    0              -- TRSP 존재안함 
                END                     	  	    
    
        -- W/O Issue ------------------------------------------		
        UNION														
            SELECT 
                PLN_YRWK 		PLN_YRWK  
                ,PLN_SEQ        PLN_SEQ                          
                ,CO_CD 			COMPANY                             
                ,'W/O Issue' 		DIVISION                            
                ,SO_IF_DIV_CD     ITEM   
                ,''               LEASE                             
                ,'' 	            LSR                                 
                ,FM_YD_CD 		FRLOC                               
                ,FM_DT 			ETD                                 
                ,TO_YD_CD 		TOLOC                               
                ,TO_DT 			ETA                                 
                ,'' SOSEND                                            
                ,'' NOSOSEND                                          
                ,'' REASON                                            
                ,'' REASONREMARK                                      
                ,'' CNTRNO                                            
                ,COUNT(CNTR_TPSZ_CD) TOTALVOL	                        
                --        	  ,SUM(A.REPO_COST_AMT) TOTALCOST     
				,                  
                #foreach(${key} in ${tpszArr}) 
					NVL(SUM(DECODE(CNTR_TPSZ_CD, '${key}', REPO_COST_AMT)),0)
					#if($velocityCount < $tpszArr.size()) 
						+
					#end
                #end	
                TOTALCOST                       									
                
                #foreach(${key} in ${tpszArr})         	  
                	,COUNT(DECODE(CNTR_TPSZ_CD, '${key}', CNTR_TPSZ_CD))  ${key}VOL  
                	,SUM(DECODE(CNTR_TPSZ_CD,   '${key}', REPO_COST_AMT)) ${key}COST 
                #end                                                                                       
                ,REF_ID REFNO											
                ,REPO_PLN_ID 	-- HIDDEN                           	
                ,'' VNDR_ABBR_NM 	-- HIDDEN                           
                ,'' VNDR_CNT_CD 	-- HIDDEN                           
                ,0 VNDR_SEQ  		-- HIDDEN      	                    
                ,3 SORTNUM	 	-- HIDDEN                           
                ,B.ECC_CD FM_ECC  -- SORT에 사용될 SCC의 해당 FM ECC 정보
                ,C.ECC_CD TO_ECC  -- SORT에 사용될 SCC의 해당 TO ECC 정보			                               
                ,0 TRSPNO_P									        			
                ,0 TRSPNO_D									        			
                
                -- 특정 PLAN에 포함된 EXECUTE의 TYPESIZE별 VOL 전체
                #foreach(${key} in ${tpszArr}) 
                	,0 ${key}MAXVOL --HIDDEN 
                #end
                
                -- TYPESIZE VOL별 FEEDBACK 정보
                #foreach(${key} in ${tpszArr})         	
                	,0   ${key}BASICRATIO --HIDDEN 
                	,0   ${key}BASICVOL   --HIDDEN 
                	,0   ${key}UNITCOST --HIDDEN 	 
                #end    
    
            FROM 
                EQR_REPO_EXE_SO_IF OUTER, 								
                MDM_EQ_ORZ_CHT B,										
                MDM_EQ_ORZ_CHT C           							  
            WHERE 
                OUTER.WO_EXE_FLG = 'Y'                							                        									       										        
                AND EXISTS                                                   
                    (                                              				         
                    SELECT 
                        INNER.REPO_PLN_ID                       			 
                        ,INNER.REF_ID                       				 
                        ,INNER.PLN_YRWK                       			 
                    FROM                                     				 
                        (                                    					 
                        SELECT 
                            A.REPO_PLN_ID                           		 
                            ,A.PLN_YRWK									 
                            ,A.REF_ID  									 
                            ,A.ONF_HIR_DIV_CD								 
                            ,A.FM_ECC										 
                            ,A.TO_ECC										 
                            ,A.CO_CD										 
                            ,A.SO_ISS_FLG									 
                            ,A.REPO_PLN_FB_RSN_CD							 
                        FROM 
                            (												 
                            SELECT 
                                A.REPO_PLN_ID       					
                                ,A.PLN_YRWK     
                                ,A.PLN_SEQ                      
                                ,A.REF_ID                             
                                ,Q.CNTR_TPSZ_CD                       
                                ,A.CO_CD                              
                                ,A.ONF_HIR_DIV_CD                     
                                ,A.VNDR_CNT_CD                        
                                ,A.VNDR_SEQ                           
                                ,A.VNDR_ABBR_NM                       
                                ,A.FM_YD_CD                           
                                ,A.FM_LOC_DT                          
                                ,A.TO_YD_CD                           
                                ,A.TO_LOC_DT                          
                                ,A.REPO_PLN_FB_RSN_CD                 
                                ,A.REPO_PLN_FB_RMK                    
                                ,Q.CNTR_QTY                           
                                ,Q.ONF_HIR_COST_AMT                   
                                ,A.SO_RQST_DT                         
                                ,A.SO_ISS_FLG                         
                                ,A.NON_SO_ISS_FLG                     
                                ,B.ECC_CD FM_ECC						
                                ,C.ECC_CD TO_ECC						
                            FROM 
                                EQR_ONF_HIR_EXE_PLN A,
                                EQR_ONF_HIR_EXE_PLN_QTY Q, 				 
                                MDM_EQ_ORZ_CHT B,						 
                                MDM_EQ_ORZ_CHT C						 
                            WHERE 
                                A.REPO_PLN_ID = Q.REPO_PLN_ID
                                AND A.PLN_YRWK = Q.PLN_YRWK
                                AND A.PLN_SEQ  = Q.PLN_SEQ
                                AND A.REF_ID  = Q.REF_ID
                                AND SUBSTR(A.FM_YD_CD, 0, 5) = B.SCC_CD 	 
                                AND SUBSTR(A.TO_YD_CD, 0, 5) = C.SCC_CD	  
                            ) A,          									 
                            EQR_ONF_HIR_PLN B,								 
                            EQR_ONF_HIR_PLN_QTY Q                         		         
                        WHERE 
                            A.REPO_PLN_ID = B.REPO_PLN_ID           		               
                            AND A.PLN_YRWK    = B.PLN_YRWK          		               
                            AND A.PLN_SEQ     = B.PLN_SEQ                 
                            AND B.REPO_PLN_ID = Q.REPO_PLN_ID            
                            AND B.PLN_YRWK    = Q.PLN_YRWK            
                            AND B.PLN_SEQ     = Q.PLN_SEQ               		               
                            AND A.ONF_HIR_DIV_CD = B.ONF_HIR_DIV_CD     		 
                            AND B.ONF_HIR_DIV_CD IN ('O', 'F')                
                            
                            --AND   A.CNTR_TPSZ_CD  =  B.CNTR_TPSZ_CD       	 
                            AND   (A.FM_ECC = B.ECC_CD OR A.TO_ECC = B.ECC_CD)                                      
                            
                            AND   A.REPO_PLN_ID = @[repoPlanID]          				
                            --          		AND   A.PLN_YRWK BETWEEN  fromWeek  AND toWeek      			
                            
                            -- CSR No : N200906040080 의거 변경 
                            -- 추가 내용 : Fm/To 일 경우는 PLN_YRWK으로 조건을 걸고 Fm ETD 경우 FM_ETD_DT로, To ETA일경우 TO_ETA_DT로 조건을 건다.
                            #if(${fmtoat} == '3') --Fm ETD
                            	AND  A.FM_LOC_DT  BETWEEN 	(
																SELECT 
																	WK_ST_DT  
																FROM 
																	EQR_WK_PRD 
																WHERE 
																	PLN_YR||PLN_WK = @[fromWeek]
															)   
															AND 
															(
																SELECT 
																	WK_END_DT  
																FROM 
																	EQR_WK_PRD 
																WHERE 
																	PLN_YR||PLN_WK = @[toWeek]
															)    	  	
                            #elseif(${fmtoat} =='4') --To ETA
                            	AND  A.TO_LOC_DT  BETWEEN 	(
																SELECT 
																	WK_ST_DT  
																FROM 
																	EQR_WK_PRD 
																WHERE 
																	PLN_YR||PLN_WK = @[fromWeek]
															)   
															AND 
															(
																SELECT 
																	WK_END_DT  
																FROM 
																	EQR_WK_PRD 
																WHERE 
																	PLN_YR||PLN_WK = @[toWeek]
															)    		
                            #else  -- Fm/To  
                            	AND  A.PLN_YRWK BETWEEN @[fromWeek] AND @[toWeek]   	
                            #end
                            -- user location 
                            #if(${userECC} != '') 	        			        		 
								AND (
										A.FM_ECC IN ( ${userLocWhere} ) 
									OR 
										A.TO_ECC IN ( ${userLocWhere} )
									)
							#end 
                            --CSR No:N200906040080 의거 Fm ETD, To ETA 조건 추가
                            -- fmtoat.equals('3'): Fm ETD , fmtoat.equals('4'): To ETA
                            -- IF(fmtoat 1  &&  fromStatus != '' )        		 AND (A.FM_ECC IN  frLocWhere  OR A.TO_ECC IN  frLocWhere )	
                            #if((${fmtoat} == '1' || ${fmtoat} == '3' || ${fmtoat} == '4') && ${fromStatus} != '')
								AND (
										A.FM_ECC IN ( ${frLocWhere} )
									OR 
										A.TO_ECC IN ( ${frLocWhere} )
									)	
							#end
                            #if(${tpsz} != '' && ${tpsztype} != '')	        		
								AND Q.CNTR_TPSZ_CD IN ( ${tpszWhere} ) 						                    
							#end
                            #if(${itemname} != '')	        			        		
								AND B.ONF_HIR_DIV_CD IN ( ${itemnameWhere} )
							#end								         
                            #if(${sosend} != '') 	        				       		    
								AND (
										A.SO_ISS_FLG = @[sosend]
									OR 
										A.NON_SO_ISS_FLG = @[sosend]
									) 
							#end
                            #if(${reason} != '') 	        				                
								AND A.REPO_PLN_FB_RSN_CD IN ( ${reasonWhere} )
							#end
        
                        ) INNER                         									
                    WHERE 
                        INNER.REPO_PLN_ID = OUTER.REPO_PLN_ID                         
                        AND   INNER.REF_ID		= OUTER.REF_ID   							
                        AND   INNER.PLN_YRWK 	= OUTER.PLN_YRWK                       		
--                      AND INNER.ONF_HIR_DIV_CD = OUTER.SO_IF_DIV_CD   			
--                      AND INNER.CNTR_TPSZ_CD = OUTER.CNTR_TPSZ_CD   			
                    )                          												
                AND SUBSTR(OUTER.FM_YD_CD, 0, 5) = B.SCC_CD 					
                AND SUBSTR(OUTER.TO_YD_CD, 0, 5) = C.SCC_CD 						                        									
    
            GROUP BY 
                OUTER.PLN_YRWK      
                ,OUTER.PLN_SEQ                               
                ,OUTER.CO_CD                                        
                ,OUTER.SO_IF_DIV_CD                                 
                --        	    ,B.VNDR_ABBR_NM                                     
                ,OUTER.FM_YD_CD                                     
                ,OUTER.FM_DT                                        
                ,OUTER.TO_YD_CD                                     
                ,OUTER.TO_DT                                        
                ,OUTER.REF_ID                                       
                ,OUTER.REPO_PLN_ID                                  
                ,B.ECC_CD    -- SORT에 사용될 SCC의 해당 FM ECC 정보   
                ,C.ECC_CD    -- SORT에 사용될 SCC의 해당 TO ECC 정보					  	                       			  			                                          	
    
        ) A,															  
        (                                                               
            SELECT 
                1 NUM
                , '' NAME 
            FROM 
                DUAL                           
            UNION                                                     
            SELECT 
                2 NUM
                , 'TOTAL' NAME 
            FROM 
                DUAL                      
            UNION                                                     
            SELECT 
                3 NUM
                , 'GRAND TOTAL' NAME 
            FROM 
                DUAL                
        ) B                                                              
    
    --modified by shin yongchan - 20080125 (CSR : R200801154869)				
    
    GROUP BY 
        DECODE(B.NUM, 1, A.PLN_YRWK, 2, A.PLN_YRWK||' TTL', 3, 'TOTAL')   
        ,DECODE(B.NUM, 1, A.COMPANY,  2, '', 3, '')   	  	
        ,A.DIVISION                                           
        ,DECODE(B.NUM, 1, A.ITEM ,  2, '', 3, '')      
        ,DECODE(B.NUM, 1, A.LEASE,  2, '', 3, '')       
        ,DECODE(B.NUM, 1, A.LSR,  2, '', 3, '')   		    
        ,DECODE(B.NUM, 1, A.FRLOC,  2, '', 3, '')             
        ,DECODE(B.NUM, 1, A.ETD  ,  2, NULL, 3, NULL)         
        ,DECODE(B.NUM, 1, A.TOLOC,  2, '', 3, '')            	
        ,DECODE(B.NUM, 1, A.ETA  ,  2, NULL, 3, NULL)         
        ,DECODE(B.NUM, 1, A.SOSEND  ,  2, NULL, 3, NULL)      
        ,DECODE(B.NUM, 1, A.NOSOSEND  ,  2, NULL, 3, NULL)    
        ,DECODE(B.NUM, 1, A.REASON,  2, '', 3, '')            
        ,DECODE(B.NUM, 1, A.REASONREMARK,  2, '', 3, '')      
        ,DECODE(B.NUM, 1, A.CNTRNO,  2, '', 3, '')            
        ,DECODE(B.NUM, 1, A.REFNO,  2, '', 3, '')             
        ,DECODE(B.NUM, 1, A.REPO_PLN_ID,  2, '', 3, '')  
        ,DECODE(B.NUM, 1, A.PLN_SEQ,  2, '', 3, '')     
        ,DECODE(B.NUM, 1, A.VNDR_ABBR_NM,  2, '', 3, '')      
        ,DECODE(B.NUM, 1, A.VNDR_CNT_CD,  2, '', 3, '')       
        ,DECODE(B.NUM, 1, A.VNDR_SEQ,  2, '', 3, '')          
        ,A.SORTNUM    	-- HIDDEN	                        
        ,B.NUM           	-- HIDDEN 	                        
        ,DECODE(B.NUM, 1, DECODE(A.ITEM, 'O', A.TO_ECC, A.FM_ECC),  2, '', 3, '')   
        ,DECODE(B.NUM, 1, A.FM_ECC,  2, '', 3, '')   	    	        
        ,DECODE(B.NUM, 1, A.TO_ECC,  2, '', 3, '')         	        
        ,DECODE(B.NUM, 1, A.TRSPNO_P,  2, '', 3, '')  		          	  												
        ,DECODE(B.NUM, 1, A.TRSPNO_D,  2, '', 3, '')  		          	  												
    
    )                                                                   
GROUP BY 
    PLN_YRWK                                                   
    ,COMPANY                                                    
    ,DIVISION                                                   
    ,ITEM                      
    ,LEASE      -- LEASE TERM                                 
    ,LSR 		-- VENDOR ABBR NM                                 
    ,FRLOC                                                      
    ,ETD                                                        
    ,TOLOC                                                      
    ,ETA                                                        
    ,SOSEND                                                     
    ,NOSOSEND                                                   
    ,REASON                                                     
    ,REASONREMARK                                               
    ,CNTRNO                                                     
    ,REFNO                                                      
    ,REPO_PLN_ID 	-- HIDDEN       
    ,PLN_SEQ        -- HIDDEN                              
    ,VNDR_ABBR_NM	-- HIDDEN                                     
    ,VNDR_CNT_CD	-- HIDDEN                                     
    ,VNDR_SEQ 		-- HIDDEN                                 
    ,SORTNUM      	-- HIDDEN, PLAN(1), Execution(2), SO(3)를 구분 	 
    ,NUM          	-- HIDDEN, NORMAL ROW(1), SUB TOTAL(2), GRAND TOTAL(3) 구분   	
    ,SORT1                                                      
    ,FM_ECC                                                     
    ,TO_ECC                                                     
    ,TRSPNO_P     -- TRSP P CD COUNT                                                    
    ,TRSPNO_D     -- TRSP D CD COUNT                                                    
ORDER BY 
    1
    , 4
    , SORT1
    , REFNO||SORTNUM			]]></sql>
			<params>
				<param name="sosend" type="12" value="" out="N"/>
				<param name="repoPlanID" type="12" value="" out="N"/>
				<param name="fromWeek" type="12" value="" out="N"/>
				<param name="toWeek" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
