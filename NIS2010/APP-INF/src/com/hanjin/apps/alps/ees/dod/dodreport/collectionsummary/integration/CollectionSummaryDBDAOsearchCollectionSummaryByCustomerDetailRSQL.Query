<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CollectionSummaryDBDAOsearchCollectionSummaryByCustomerDetailRSQL">
			<desc><![CDATA[20160523 hong 최초생성]]></desc>
			<sql><![CDATA[
SELECT  
      OFC_CD,
      CNTR_NO,
      TPSZ_CD,
      RTN_YD,
      A_RTN_YD,
      RTN_DT,
      TRO_DT,
      BKG_NO,
      POR_CD,
      POL_CD,
      POD_CD,
      DEL_CD,
      SC_NO,
      RFA_NO,
      INV_CUST_CD,
      INV_CUST_NM,
      CUST_CNT_CD,
      CUST_SEQ,
      CUST_CD,
      CUST_NM,
      CONTRACT_OFC,
      CURR_CD,
      DECODE(NVL(PEN_AMT, 0), 0, GEN_TRF_AMT, GEN_AMT) GEN_TRF_AMT,
      DECODE(NVL(PEN_AMT, 0), 0, SPCL_TRF_AMT, SPC_AMT) SPCL_TRF_AMT,
      ADJ_AMT,
      
      #if(${ar_if} == 'N')
        0 INV_AMT,
        0 INV_USD_AMT,
      #else
        INV_AMT,
        INV_USD_AMT,
      #end
 
      SPC_AMT,
      GEN_AMT,
      EXEMPTION,
      AR_IF_DT,
      CRE_USR_ID,
      INV_OFC_CD,
      PEN_AMT,
      INV_CNTR
FROM
(
SELECT DISTINCT A.*, 
       DECODE(SPC_AMT, NULL, GEN_AMT, SPC_AMT) AS PEN_AMT
FROM
    (
    SELECT E.CFM_OFC_CD AS OFC_CD
       , E.CNTR_NO
       , E.CNTR_TPSZ_CD AS TPSZ_CD
       , E.CNTR_RTN_YD_CD RTN_YD
       ,(SELECT /*+ INDEX( M XIE6CTM_MOVEMENT ) */
                M.ORG_YD_CD AS ACT_TRN_YARD
            FROM CTM_MOVEMENT M
               , MST_CONTAINER C
           WHERE 1 = 1
             AND M.CNTR_NO = E.CNTR_NO
             AND M.BKG_NO = E.BKG_NO
             AND M.MVMT_STS_CD = 'MT'
             AND M.CNTR_NO = C.CNTR_NO
             AND NVL(C.LSTM_CD, '  ') <> 'SH' /* SOC  */
             AND NVL(M.MVMT_CRE_TP_CD, '  ') NOT IN ( 'C','L' )
             AND 'ID' = (SELECT /*+ INDEX_DESC ( MM XFN1CTM_MOVEMENT ) */
                                MM.MVMT_STS_CD /*  PRE_MVMT_STS_CD   */
                         FROM CTM_MOVEMENT MM
                         WHERE 1 = 1
                           AND MM.CNTR_NO = M.CNTR_NO
                           --AND MM.BKG_NO = E.BKG_NO
                           AND MM.CNMV_YR || TO_CHAR(MM.CNMV_SEQ, '0000') ||MM.CNMV_SPLIT_NO < M.CNMV_YR||TO_CHAR(M.CNMV_SEQ,'0000')||M.CNMV_SPLIT_NO
                           AND ROWNUM = 1 
                         )
         ) A_RTN_YD
       ,(SELECT /*+ INDEX( M XIE6CTM_MOVEMENT ) */
                TO_CHAR(M.CNMV_EVNT_DT,'YYYY-MM-DD')
            FROM CTM_MOVEMENT M
               , MST_CONTAINER C
           WHERE 1 = 1
             AND M.CNTR_NO = E.CNTR_NO
             AND M.BKG_NO = E.BKG_NO
             AND M.MVMT_STS_CD = 'MT'
             AND M.CNTR_NO = C.CNTR_NO
             AND NVL(C.LSTM_CD, '  ') <> 'SH' /* SOC  */
             AND NVL(M.MVMT_CRE_TP_CD, '  ') NOT IN ( 'C','L' )
             AND 'ID' = (SELECT /*+ INDEX_DESC ( MM XFN1CTM_MOVEMENT ) */
                                MM.MVMT_STS_CD /*  PRE_MVMT_STS_CD   */
                         FROM CTM_MOVEMENT MM
                         WHERE 1 = 1
                           AND MM.CNTR_NO = M.CNTR_NO
                           --AND MM.BKG_NO = E.BKG_NO
                           AND MM.CNMV_YR || TO_CHAR(MM.CNMV_SEQ, '0000') ||MM.CNMV_SPLIT_NO < M.CNMV_YR||TO_CHAR(M.CNMV_SEQ,'0000')||M.CNMV_SPLIT_NO
                           AND ROWNUM = 1 
                         )
         ) RTN_DT                                   
       , TO_CHAR(E.CFM_DT, 'YYYY-MM-DD') TRO_DT  -- TRO DATE
       , E.BKG_NO
       , B.POR_CD
       , B.POL_CD
       , B.POD_CD
       , B.DEL_CD
       , B.SC_NO
       , B.RFA_NO
       , (SELECT G.CUST_CNT_CD || LPAD(G.CUST_SEQ, 6, '0')
         FROM DOD_DRP_OFF_CHG G
         WHERE G.BKG_NO = E.BKG_NO
           AND G.CNTR_NO = E.CNTR_NO
           AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                                    FROM DOD_DRP_OFF_CHG C
                                   WHERE C.BKG_NO = G.BKG_NO
                                     AND C.CNTR_NO = G.CNTR_NO
                                   )) INV_CUST_CD
                                   
      , (SELECT SUBSTR(R.CUST_LGL_ENG_NM, 1, 50)
         FROM DOD_DRP_OFF_CHG G, MDM_CUSTOMER R
         WHERE G.BKG_NO = E.BKG_NO
           AND G.CNTR_NO = E.CNTR_NO
           AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                                    FROM DOD_DRP_OFF_CHG C
                                   WHERE C.BKG_NO = G.BKG_NO
                                     AND C.CNTR_NO = G.CNTR_NO
                                   ) 
           AND G.CUST_CNT_CD = R.CUST_CNT_CD
           AND G.CUST_SEQ = R.CUST_SEQ   )  INV_CUST_NM
       , (SELECT U.CUST_CNT_CD
            FROM BKG_CUSTOMER U
           WHERE U.BKG_NO = B.BKG_NO
             AND U.BKG_CUST_TP_CD = 'S' ) CUST_CNT_CD
       , (SELECT U.CUST_SEQ
            FROM BKG_CUSTOMER U
           WHERE U.BKG_NO = B.BKG_NO
             AND U.BKG_CUST_TP_CD = 'S' ) CUST_SEQ
       , (SELECT U.CUST_CNT_CD || LPAD(U.CUST_SEQ, 6, '0')
            FROM BKG_CUSTOMER U
           WHERE U.BKG_NO = B.BKG_NO
             AND U.BKG_CUST_TP_CD = 'S' )AS CUST_CD
       , DECODE(NVL(B.SC_NO,''), '', RFA.CUST_NM, SC.CTRT_PTY_NM) AS CUST_NM
       , DECODE(NVL(B.SC_NO,''), '', RFA.PROP_OFC_CD, SC.PROP_OFC_CD) AS CONTRACT_OFC

       , E.CFM_CURR_CD CURR_CD
       ,(SELECT  ROUND(G.GEN_TRF_AMT, 2)
            FROM DOD_DRP_OFF_CHG G
           WHERE G.BKG_NO = E.BKG_NO
             AND G.CNTR_NO = E.CNTR_NO

       #if(${ar_if} == 'Y')
          AND G.AR_IF_NO IS NOT NULL
       #end
       #if(${ar_if} == 'N')
          AND G.AR_IF_NO IS NULL
       #end

             AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                    FROM DOD_DRP_OFF_CHG C
                   WHERE C.BKG_NO = G.BKG_NO
                     AND C.CNTR_NO = G.CNTR_NO) ) GEN_TRF_AMT
       , (SELECT ROUND(G.SPCL_TRF_AMT, 2)
            FROM DOD_DRP_OFF_CHG G
           WHERE G.BKG_NO = E.BKG_NO
             AND G.CNTR_NO = E.CNTR_NO

       #if(${ar_if} == 'Y')
          AND G.AR_IF_NO IS NOT NULL
       #end
       #if(${ar_if} == 'N')
          AND G.AR_IF_NO IS NULL
       #end

             AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                    FROM DOD_DRP_OFF_CHG C
                   WHERE C.BKG_NO = G.BKG_NO
                     AND C.CNTR_NO = G.CNTR_NO) ) SPCL_TRF_AMT
       , (SELECT ROUND( (-G.DC_AMT + G.SVC_FEE_AMT)*-1 ,2 )
            FROM DOD_DRP_OFF_CHG G
           WHERE G.BKG_NO = E.BKG_NO
             AND G.CNTR_NO = E.CNTR_NO

       #if(${ar_if} == 'Y')
          AND G.AR_IF_NO IS NOT NULL
       #end
       #if(${ar_if} == 'N')
          AND G.AR_IF_NO IS NULL
       #end

             AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                    FROM DOD_DRP_OFF_CHG C
                   WHERE C.BKG_NO = G.BKG_NO
                     AND C.CNTR_NO = G.CNTR_NO)) ADJ_AMT
       ,  (SELECT CASE WHEN G.TTL_AMT > 0 THEN ROUND( G.TTL_AMT, 2 )
                   WHEN G.TTL_AMT < 0 THEN 0
                   ELSE 0
                   END END
            FROM DOD_DRP_OFF_CHG G
           WHERE G.BKG_NO = E.BKG_NO
             AND G.CNTR_NO = E.CNTR_NO

       #if(${ar_if} == 'Y')
          AND G.AR_IF_NO IS NOT NULL
       #end
       #if(${ar_if} == 'N')
          AND G.AR_IF_NO IS NULL
       #end

             AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                    FROM DOD_DRP_OFF_CHG C
                   WHERE C.BKG_NO = G.BKG_NO
                     AND C.CNTR_NO = G.CNTR_NO) ) INV_AMT
       , (SELECT ROUND( MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC( TO_CHAR(G.TRO_IB_CFM_DT , 'YYYYMM') , G.CURR_CD, 'USD' ,G.TTL_AMT), 2 )
            FROM DOD_DRP_OFF_CHG G
           WHERE G.BKG_NO = E.BKG_NO
             AND G.CNTR_NO = E.CNTR_NO

       #if(${ar_if} == 'Y')
          AND G.AR_IF_NO IS NOT NULL
       #end
       #if(${ar_if} == 'N')
          AND G.AR_IF_NO IS NULL
       #end

             AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                    FROM DOD_DRP_OFF_CHG C
                   WHERE C.BKG_NO = G.BKG_NO
                     AND C.CNTR_NO = G.CNTR_NO) ) INV_USD_AMT
         , (SELECT ROUND(D.DRP_OFF_CHG_TRF_AMT, 2)
              FROM DOD_DRP_OFF_CHG_TRF D
             WHERE 1 = 1
               AND DECODE(D.DEL_CD, NULL, '1', D.DEL_CD) = DECODE(D.DEL_CD, NULL, '1', B.POD_CD)
               AND D.CNTR_RTN_LOC_CD = SUBSTR(E.CNTR_RTN_YD_CD, 1, 5)
               AND DECODE(D.CNTR_RTN_YD_SFX_CD, NULL, '1', D.CNTR_RTN_YD_SFX_CD) = DECODE(D.CNTR_RTN_YD_SFX_CD, NULL, '1', SUBSTR(E.CNTR_RTN_YD_CD, 6, 2))
               AND D.POL_CONTI_CD = SUBSTR(B.ORG_SCONTI_CD, 1, 1)
               AND D.CNTR_TPSZ_CD = E.CNTR_TPSZ_CD
               AND D.DRP_OFF_CHG_TRF_DIV_CD = 'S'
               AND D.DRP_OFF_CHG_TRF_CFM_FLG = 'Y'
               AND D.DRP_OFF_CHG_TRF_EXPT_FLG = 'N'
               AND B.POL_ETD_DT BETWEEN TO_DATE(D.DRP_OFF_CHG_TRF_EFF_DT, 'YYYYMMDD') + .0 AND TO_DATE(D.DRP_OFF_CHG_TRF_EXP_DT, 'YYYYMMDD') + .99999
               AND DECODE(D.SPCL_CUST_CNT_CD, NULL, '1', D.SPCL_CUST_CNT_CD) = DECODE(D.SPCL_CUST_CNT_CD, NULL, '1', B.AGMT_ACT_CNT_CD)
               AND DECODE(D.SPCL_CUST_SEQ, NULL, 1, D.SPCL_CUST_SEQ) = DECODE(D.SPCL_CUST_SEQ, NULL, 1, B.AGMT_ACT_CUST_SEQ)
               AND DECODE(D.SC_NO, NULL, D.RFA_NO, D.SC_NO) = DECODE(D.SC_NO, NULL, B.RFA_NO, B.SC_NO)
               AND NVL(D.DEL_CD||D.CNTR_RTN_YD_SFX_CD, 1) = 
                 (SELECT NVL(MAX(D.DEL_CD)||MAX(D.CNTR_RTN_YD_SFX_CD), 1)
                    FROM DOD_DRP_OFF_CHG_TRF D
                     WHERE 1 = 1
                       AND DECODE(D.DEL_CD, NULL, '1', D.DEL_CD) = DECODE(D.DEL_CD, NULL, '1', B.POD_CD)
                       AND D.CNTR_RTN_LOC_CD = SUBSTR(E.CNTR_RTN_YD_CD, 1, 5)
                       AND DECODE(D.CNTR_RTN_YD_SFX_CD, NULL, '1', D.CNTR_RTN_YD_SFX_CD) = DECODE(D.CNTR_RTN_YD_SFX_CD, NULL, '1', SUBSTR(E.CNTR_RTN_YD_CD, 6, 2))
                       AND D.POL_CONTI_CD = SUBSTR(B.ORG_SCONTI_CD, 1, 1)
                       AND D.CNTR_TPSZ_CD = E.CNTR_TPSZ_CD
                       AND D.DRP_OFF_CHG_TRF_DIV_CD = 'S'
                       AND D.DRP_OFF_CHG_TRF_CFM_FLG = 'Y'
                       AND D.DRP_OFF_CHG_TRF_EXPT_FLG = 'N'
                       AND B.POL_ETD_DT BETWEEN TO_DATE(D.DRP_OFF_CHG_TRF_EFF_DT, 'YYYYMMDD') + .0 AND TO_DATE(D.DRP_OFF_CHG_TRF_EXP_DT, 'YYYYMMDD') + .99999
                       AND DECODE(D.SPCL_CUST_CNT_CD, NULL, '1', D.SPCL_CUST_CNT_CD) = DECODE(D.SPCL_CUST_CNT_CD, NULL, '1', B.AGMT_ACT_CNT_CD)
                       AND DECODE(D.SPCL_CUST_SEQ, NULL, 1, D.SPCL_CUST_SEQ) = DECODE(D.SPCL_CUST_SEQ, NULL, 1, B.AGMT_ACT_CUST_SEQ)
                       AND DECODE(D.SC_NO, NULL, D.RFA_NO, D.SC_NO) = DECODE(D.SC_NO, NULL, B.RFA_NO, B.SC_NO)
                       )
                      AND NVL(D.SPCL_CUST_CNT_CD||D.SPCL_CUST_SEQ, 1) = 
                          (SELECT NVL(MAX(D.SPCL_CUST_CNT_CD||D.SPCL_CUST_SEQ), 1)
                            FROM DOD_DRP_OFF_CHG_TRF D
                           WHERE 1 = 1
                             AND DECODE(D.DEL_CD, NULL, '1', D.DEL_CD) = DECODE(D.DEL_CD, NULL, '1', B.POD_CD)
                             AND D.CNTR_RTN_LOC_CD = SUBSTR(E.CNTR_RTN_YD_CD, 1, 5)
                             AND DECODE(D.CNTR_RTN_YD_SFX_CD, NULL, '1', D.CNTR_RTN_YD_SFX_CD) = DECODE(D.CNTR_RTN_YD_SFX_CD, NULL, '1', SUBSTR(E.CNTR_RTN_YD_CD, 6, 2))
                             AND D.POL_CONTI_CD = SUBSTR(B.ORG_SCONTI_CD, 1, 1)
                             AND D.CNTR_TPSZ_CD = E.CNTR_TPSZ_CD
                             AND D.DRP_OFF_CHG_TRF_DIV_CD = 'S'
                             AND D.DRP_OFF_CHG_TRF_CFM_FLG = 'Y'
                             AND D.DRP_OFF_CHG_TRF_EXPT_FLG = 'N'
                             AND B.POL_ETD_DT BETWEEN TO_DATE(D.DRP_OFF_CHG_TRF_EFF_DT, 'YYYYMMDD') + .0 AND TO_DATE(D.DRP_OFF_CHG_TRF_EXP_DT, 'YYYYMMDD') + .99999
                             AND DECODE(D.SPCL_CUST_CNT_CD, NULL, '1', D.SPCL_CUST_CNT_CD) = DECODE(D.SPCL_CUST_CNT_CD, NULL, '1', B.AGMT_ACT_CNT_CD)
                             AND DECODE(D.SPCL_CUST_SEQ, NULL, 1, D.SPCL_CUST_SEQ) = DECODE(D.SPCL_CUST_SEQ, NULL, 1, B.AGMT_ACT_CUST_SEQ)
                             AND DECODE(D.SC_NO, NULL, D.RFA_NO, D.SC_NO) = DECODE(D.SC_NO, NULL, B.RFA_NO, B.SC_NO)         
                             )   
                       AND NOT EXISTS (SELECT 'OK'
                                      FROM DOD_DRP_OFF_CHG G
                                     WHERE G.BKG_NO = E.BKG_NO
                                       AND G.CNTR_NO = E.CNTR_NO
                                       )      
                            
        ) SPC_AMT
        , ( SELECT ROUND(D.DRP_OFF_CHG_TRF_AMT, 2)
            FROM DOD_DRP_OFF_CHG_TRF D
           WHERE 1 = 1
             AND DECODE(D.DEL_CD, NULL, '1', D.DEL_CD) = DECODE(D.DEL_CD, NULL, '1', B.POD_CD)
             AND D.CNTR_RTN_LOC_CD = SUBSTR(E.CNTR_RTN_YD_CD, 1, 5)
             AND DECODE(D.CNTR_RTN_YD_SFX_CD, NULL, '1', D.CNTR_RTN_YD_SFX_CD) = DECODE(D.CNTR_RTN_YD_SFX_CD, NULL, '1', SUBSTR(E.CNTR_RTN_YD_CD, 6, 2))
             AND D.POL_CONTI_CD = SUBSTR(B.ORG_SCONTI_CD, 1, 1)
             AND D.CNTR_TPSZ_CD = E.CNTR_TPSZ_CD
             AND D.DRP_OFF_CHG_TRF_DIV_CD = 'G'
             AND D.DRP_OFF_CHG_TRF_CFM_FLG = 'Y'
             AND D.DRP_OFF_CHG_TRF_EXPT_FLG = 'N'
             AND B.POL_ETD_DT BETWEEN TO_DATE(D.DRP_OFF_CHG_TRF_EFF_DT, 'YYYYMMDD') + .0 AND TO_DATE(D.DRP_OFF_CHG_TRF_EXP_DT, 'YYYYMMDD') + .99999
    
              AND NVL(D.DEL_CD||D.CNTR_RTN_YD_SFX_CD, 1) = 
                   (SELECT NVL(MAX(D.DEL_CD)||MAX(D.CNTR_RTN_YD_SFX_CD), 1)
                     FROM DOD_DRP_OFF_CHG_TRF D
                        WHERE 1 = 1
                     AND DECODE(D.DEL_CD, NULL, '1', D.DEL_CD) = DECODE(D.DEL_CD, NULL, '1', B.POD_CD)
                          AND D.CNTR_RTN_LOC_CD = SUBSTR(E.CNTR_RTN_YD_CD, 1, 5)
                          AND DECODE(D.CNTR_RTN_YD_SFX_CD, NULL, '1', D.CNTR_RTN_YD_SFX_CD) = DECODE(D.CNTR_RTN_YD_SFX_CD, NULL, '1', SUBSTR(E.CNTR_RTN_YD_CD, 6, 2))
                          AND D.POL_CONTI_CD = SUBSTR(B.ORG_SCONTI_CD, 1, 1)
                          AND D.CNTR_TPSZ_CD = E.CNTR_TPSZ_CD
                          AND D.DRP_OFF_CHG_TRF_DIV_CD = 'G'
                          AND D.DRP_OFF_CHG_TRF_CFM_FLG = 'Y'
                          AND D.DRP_OFF_CHG_TRF_EXPT_FLG = 'N'
                          AND B.POL_ETD_DT BETWEEN TO_DATE(D.DRP_OFF_CHG_TRF_EFF_DT, 'YYYYMMDD') + .0 AND TO_DATE(D.DRP_OFF_CHG_TRF_EXP_DT, 'YYYYMMDD') + .99999
                     )
             AND NOT EXISTS (SELECT 'OK'
                                      FROM DOD_DRP_OFF_CHG G
                                     WHERE G.BKG_NO = E.BKG_NO
                                       AND G.CNTR_NO = E.CNTR_NO
                             )     
          ) GEN_AMT
      
        , (SELECT 
               NVL((CASE WHEN G.DRP_OFF_CHG_TRF_SPCL_SEQ IS NULL
                    THEN (SELECT F.DRP_OFF_CHG_TRF_EXPT_FLG
                            FROM DOD_DRP_OFF_CHG D, DOD_DRP_OFF_CHG_TRF F
                           WHERE D.BKG_NO = G.BKG_NO
                             AND D.CNTR_NO = G.CNTR_NO
                             AND D.DRP_OFF_CHG_TRF_SEQ = F.DRP_OFF_CHG_TRF_SEQ
                             AND D.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                                    FROM DOD_DRP_OFF_CHG C
                                   WHERE C.BKG_NO = G.BKG_NO
                                     AND C.CNTR_NO = G.CNTR_NO))
                     ELSE (SELECT F.DRP_OFF_CHG_TRF_EXPT_FLG
                            FROM DOD_DRP_OFF_CHG D, DOD_DRP_OFF_CHG_TRF F
                           WHERE D.BKG_NO = G.BKG_NO
                             AND D.CNTR_NO = G.CNTR_NO
                             AND D.DRP_OFF_CHG_TRF_SPCL_SEQ = F.DRP_OFF_CHG_TRF_SEQ
                             AND D.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                                    FROM DOD_DRP_OFF_CHG C
                                   WHERE C.BKG_NO = G.BKG_NO
                                     AND C.CNTR_NO = G.CNTR_NO))
                    END), 'N')
             FROM DOD_DRP_OFF_CHG G
             WHERE G.BKG_NO = E.BKG_NO
               AND G.CNTR_NO = E.CNTR_NO
               AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                                          FROM DOD_DRP_OFF_CHG C
                                         WHERE C.BKG_NO = G.BKG_NO
                                           AND C.CNTR_NO = G.CNTR_NO) ) EXEMPTION
           
       , (SELECT TO_CHAR(G.CRE_DT, 'YYYY-MM-DD')
            FROM DOD_DRP_OFF_CHG G
           WHERE G.BKG_NO = E.BKG_NO
             AND G.CNTR_NO = E.CNTR_NO
             AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                    FROM DOD_DRP_OFF_CHG C
                   WHERE C.BKG_NO = G.BKG_NO
                     AND C.CNTR_NO = G.CNTR_NO) ) AR_IF_DT
      , (SELECT G.CRE_USR_ID
            FROM DOD_DRP_OFF_CHG G
           WHERE G.BKG_NO = E.BKG_NO
             AND G.CNTR_NO = E.CNTR_NO
             AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                    FROM DOD_DRP_OFF_CHG C
                   WHERE C.BKG_NO = G.BKG_NO
                     AND C.CNTR_NO = G.CNTR_NO) ) CRE_USR_ID
      , (SELECT G.TRO_IB_CFM_OFC_CD
            FROM DOD_DRP_OFF_CHG G
           WHERE G.BKG_NO = E.BKG_NO
             AND G.CNTR_NO = E.CNTR_NO
             AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                    FROM DOD_DRP_OFF_CHG C
                   WHERE C.BKG_NO = G.BKG_NO
                     AND C.CNTR_NO = G.CNTR_NO) ) INV_OFC_CD

     , (SELECT 1
                FROM DOD_DRP_OFF_CHG G
               WHERE G.BKG_NO = E.BKG_NO
                 AND G.CNTR_NO = E.CNTR_NO
                 AND G.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                        FROM DOD_DRP_OFF_CHG C
                       WHERE C.BKG_NO = G.BKG_NO
                         AND C.CNTR_NO = G.CNTR_NO) ) INV_CNTR 

    FROM BKG_EUR_TRO E
       , BKG_CUSTOMER BC
       , BKG_BOOKING B
       , (SELECT SPH.SC_NO, SC.PROP_OFC_CD, SCP.CUST_CNT_CD,SCP.CUST_SEQ,SCP.CTRT_PTY_NM
          FROM   PRI_SP_HDR SPH
               , PRI_SP_MN SC
               , PRI_SP_CTRT_PTY SCP 
          WHERE  SPH.PROP_NO = SC.PROP_NO 
          AND    SCP.PROP_NO = SPH.PROP_NO 
          AND    SC.AMDT_SEQ = SCP.AMDT_SEQ 
          AND    SCP.PRC_CTRT_PTY_TP_CD = 'C' 
          AND    SC.AMDT_SEQ = (SELECT MAX (AMDT_SEQ) 
                                  FROM PRI_SP_MN 
                                 WHERE PROP_NO = SPH.PROP_NO 
                                   AND ROWNUM <= 1)

#if(${item_list} != '')
          AND SPH.SC_NO IN (
	#foreach( $an_item in ${item_list} )
		#if($velocityCount < $item_list.size())
			SELECT (CASE WHEN SUBSTR(MSG, 1, INSTR(MSG, '|', 1, 1) - 1) = 'S' 
			            THEN SUBSTR(MSG, INSTR(MSG, '|', 1, 1) + 1, INSTR(MSG, '|', 1, 2) - INSTR(MSG, '|', 1, 1) - 1)
			            ELSE '' END)
			FROM (SELECT $an_item AS MSG FROM DUAL) 
			UNION ALL
		#else
			SELECT (CASE WHEN SUBSTR(MSG, 1, INSTR(MSG, '|', 1, 1) - 1) = 'S' 
			            THEN SUBSTR(MSG, INSTR(MSG, '|', 1, 1) + 1, INSTR(MSG, '|', 1, 2) - INSTR(MSG, '|', 1, 1) - 1)
			            ELSE '' END)
			FROM (SELECT $an_item AS MSG FROM DUAL) 
		#end
	#end
         )  
#end 
          GROUP BY SPH.SC_NO, SC.PROP_OFC_CD, SCP.CUST_CNT_CD,SCP.CUST_SEQ,SCP.CTRT_PTY_NM
         ) SC
       , (SELECT RFH.RFA_NO,RFA.CTRT_CUST_CNT_CD, RFA.CTRT_CUST_SEQ, RFA.PROP_OFC_CD, 
                 (SELECT CUST_LGL_ENG_NM FROM MDM_CUSTOMER WHERE CUST_CNT_CD = RFA.CTRT_CUST_CNT_CD AND CUST_SEQ = RFA.CTRT_CUST_SEQ) AS CUST_NM
          FROM   PRI_RP_HDR RFH
               , PRI_RP_MN RFA 
          WHERE  RFA.PROP_NO(+) = RFH.PROP_NO 
          AND    RFA.AMDT_SEQ = (SELECT MAX (AMDT_SEQ) 
                                   FROM PRI_RP_MN 
                                  WHERE PROP_NO = RFH.PROP_NO 
                                    AND ROWNUM <= 1)
#if(${item_list} != '')
     AND RFH.RFA_NO IN (
	#foreach( $an_item in ${item_list} )
		#if($velocityCount < $item_list.size())
			SELECT (CASE WHEN SUBSTR(MSG, 1, INSTR(MSG, '|', 1, 1) - 1) = 'R' 
			             THEN SUBSTR(MSG, INSTR(MSG, '|', 1, 1) + 1, INSTR(MSG, '|', 1, 2) - INSTR(MSG, '|', 1, 1) - 1)
			             ELSE '' END)
			FROM (SELECT $an_item AS MSG FROM DUAL) 
			UNION ALL
		#else
			SELECT (CASE WHEN SUBSTR(MSG, 1, INSTR(MSG, '|', 1, 1) - 1) = 'R' 
			             THEN SUBSTR(MSG, INSTR(MSG, '|', 1, 1) + 1, INSTR(MSG, '|', 1, 2) - INSTR(MSG, '|', 1, 1) - 1)
			             ELSE '' END)
			FROM (SELECT $an_item AS MSG FROM DUAL) 
		#end
	#end
         )  
#end 
          GROUP BY RFH.RFA_NO,RFA.CTRT_CUST_CNT_CD, RFA.CTRT_CUST_SEQ, RFA.PROP_OFC_CD
         ) RFA

    WHERE 1=1
     AND E.BKG_NO = B.BKG_NO
     AND E.IO_BND_CD = 'I'
     AND E.HLG_TP_CD = 'M'
     AND SUBSTR(E.CNTR_RTN_YD_CD, 1, 5) <> B.DEL_CD
     AND E.CXL_FLG = 'N'
     AND E.CFM_FLG = 'Y'
     AND E.BKG_NO = BC.BKG_NO(+)
     AND E.TRO_SEQ = (SELECT MAX(TT.TRO_SEQ)
                               FROM BKG_EUR_TRO TT
                              WHERE TT.BKG_NO = E.BKG_NO
                                AND TT.CNTR_NO = E.CNTR_NO
                                AND TT.IO_BND_CD = 'I') 
-- AR I/F 조건
   #if(${ar_if} == 'Y')
    AND EXISTS  (SELECT 'OK'
                FROM DOD_DRP_OFF_CHG GG
               WHERE GG.BKG_NO = E.BKG_NO
                 AND GG.CNTR_NO = E.CNTR_NO
                 AND GG.AR_IF_NO IS NOT NULL
                 AND GG.DRP_OFF_CHG_SEQ = (SELECT MAX(C.DRP_OFF_CHG_SEQ)
                                             FROM DOD_DRP_OFF_CHG C
                                            WHERE C.BKG_NO = GG.BKG_NO
                                              AND C.CNTR_NO = GG.CNTR_NO)) 
	#end

--SC_NO BOOKING 조회조건 시작
#if (${cust_flg} == 'BKG')
	#if (${cust_type_A} != '')
     AND BC.BKG_CUST_TP_CD IN ( 'S','C','N' )
	#else
     AND BC.BKG_CUST_TP_CD IN ( NVL(@[cust_type_S],' '), NVL(@[cust_type_C],' '), NVL(@[cust_type_N],' ') )
	#end
#end 
     AND B.SC_NO = SC.SC_NO(+)
     AND B.RFA_NO = RFA.RFA_NO(+)
--SC_NO BOOKING 조회조건 종료


#if (${period} == 'W') 
     AND E.CFM_DT BETWEEN (SELECT TO_DATE(K.WK_ST_DT,'YYYYMMDD') + .0
						   FROM   EQR_WK_PRD K
						   WHERE  K.PLN_YR||K.PLN_WK = @[from]
						  )	AND
						  (SELECT TO_DATE(K.WK_END_DT,'YYYYMMDD') + .99999
						   FROM   EQR_WK_PRD K
						   WHERE  K.PLN_YR||K.PLN_WK = @[to]
						  ) 
#elseif (${period} == 'D' || ${period} == 'M') 
     AND E.CFM_DT BETWEEN TO_DATE( @[from], 'YYYYMMDD') + .0 AND TO_DATE( @[to], 'YYYYMMDD') + .99999
#end 

#if(${item_list} != '')
     AND (NVL(B.SC_NO,'')||NVL(B.RFA_NO,'')||E.CFM_OFC_CD||SUBSTR(E.CNTR_RTN_YD_CD,1,5)||E.CNTR_TPSZ_CD||DECODE(NVL(B.SC_NO,''), '', RFA.PROP_OFC_CD, SC.PROP_OFC_CD)||DECODE(NVL(B.SC_NO,''), '', RFA.CTRT_CUST_CNT_CD || LPAD(RFA.CTRT_CUST_SEQ, 6, '0'), SC.CUST_CNT_CD || LPAD(SC.CUST_SEQ, 6, '0')))
          IN 
         (
	#foreach( $an_item in ${item_list} )
		#if($velocityCount < $item_list.size())
			SELECT (CASE WHEN SUBSTR(MSG, 1, INSTR(MSG, '|', 1, 1) - 1) = 'S' 
			            THEN SUBSTR(MSG, INSTR(MSG, '|', 1, 1) + 1, INSTR(MSG, '|', 1, 2) - INSTR(MSG, '|', 1, 1) - 1)
			            ELSE B.SC_NO END)||
			      (CASE WHEN SUBSTR(MSG, 1, INSTR(MSG, '|', 1, 1) - 1) = 'R' 
			            THEN SUBSTR(MSG, INSTR(MSG, '|', 1, 1) + 1, INSTR(MSG, '|', 1, 2) - INSTR(MSG, '|', 1, 1) - 1)
			            ELSE B.RFA_NO END)||
			       SUBSTR(MSG, INSTR(MSG, '|', 1, 2) + 1, INSTR(MSG, '|', 1, 3) - INSTR(MSG, '|', 1, 2) - 1)||
			       SUBSTR(MSG, INSTR(MSG, '|', 1, 3) + 1, INSTR(MSG, '|', 1, 4) - INSTR(MSG, '|', 1, 3) - 1)||
			       SUBSTR(MSG, INSTR(MSG, '|', 1, 4) + 1, INSTR(MSG, '|', 1, 5) - INSTR(MSG, '|', 1, 4) - 1)||
			       SUBSTR(MSG, INSTR(MSG, '|', 1, 5) + 1, INSTR(MSG, '|', 1, 6) - INSTR(MSG, '|', 1, 5) - 1)||
			       SUBSTR(MSG, INSTR(MSG, '|', 1, 6) + 1)
			FROM (SELECT $an_item AS MSG FROM DUAL) 
			UNION ALL
		#else
			SELECT (CASE WHEN SUBSTR(MSG, 1, INSTR(MSG, '|', 1, 1) - 1) = 'S' 
			            THEN SUBSTR(MSG, INSTR(MSG, '|', 1, 1) + 1, INSTR(MSG, '|', 1, 2) - INSTR(MSG, '|', 1, 1) - 1)
			            ELSE B.SC_NO END)||
			      (CASE WHEN SUBSTR(MSG, 1, INSTR(MSG, '|', 1, 1) - 1) = 'R' 
			            THEN SUBSTR(MSG, INSTR(MSG, '|', 1, 1) + 1, INSTR(MSG, '|', 1, 2) - INSTR(MSG, '|', 1, 1) - 1)
			            ELSE B.RFA_NO END)||
			       SUBSTR(MSG, INSTR(MSG, '|', 1, 2) + 1, INSTR(MSG, '|', 1, 3) - INSTR(MSG, '|', 1, 2) - 1)||
			       SUBSTR(MSG, INSTR(MSG, '|', 1, 3) + 1, INSTR(MSG, '|', 1, 4) - INSTR(MSG, '|', 1, 3) - 1)||
			       SUBSTR(MSG, INSTR(MSG, '|', 1, 4) + 1, INSTR(MSG, '|', 1, 5) - INSTR(MSG, '|', 1, 4) - 1)||
			       SUBSTR(MSG, INSTR(MSG, '|', 1, 5) + 1, INSTR(MSG, '|', 1, 6) - INSTR(MSG, '|', 1, 5) - 1)||
			       SUBSTR(MSG, INSTR(MSG, '|', 1, 6) + 1)
			FROM (SELECT $an_item AS MSG FROM DUAL) 
		#end
	#end
         )  
#end 
) A
) A
#if(${ar_if} == 'N')
WHERE A.PEN_AMT > 0 
 OR A.EXEMPTION = 'Y'
#end
#if(${ar_if} == 'A')
WHERE A.PEN_AMT > 0
  OR INV_CNTR > 0
#end			]]></sql>
			<params>
				<param name="cust_type_S" type="12" value="" out="N"/>
				<param name="cust_type_C" type="12" value="" out="N"/>
				<param name="cust_type_N" type="12" value="" out="N"/>
				<param name="from" type="12" value="" out="N"/>
				<param name="to" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
