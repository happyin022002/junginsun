<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="PerformanceReportDBDAOSearchRepairExpensePFMCListDataRSQL">
			<desc><![CDATA[SearchRepairExpensePFMCListData]]></desc>
			<sql><![CDATA[
WITH OFC_LIST AS (SELECT DISTINCT MNR_COMMON_PKG.MNR_GET_RHQ_OFC_FNC(PD.CTRL_OFC_CD) RHQ, PD.CTRL_OFC_CD OFC_CD
                    FROM MNR_PLN_DTL PD, MNR_PLN_HDR PH
                   WHERE PH.MNR_PLN_SEQ = PD.MNR_PLN_SEQ
                     AND PH.MNR_PLN_YR BETWEEN SUBSTR(REPLACE(@[from_mon], '-', ''), 3, 6) 
                                           AND SUBSTR(REPLACE(@[to_mon], '-', ''), 3, 6)
                     AND PH.MNR_GRP_TP_CD = 'RPR'
                     AND PH.MNR_PLN_FLG = 'Y'
                     AND PD.OFC_TP_CD = 'BB'
#if (${ofc_cd} != 'A')
                     AND PD.CTRL_OFC_CD = @[ofc_cd] 
#end  
                  UNION
#if (${report_type} == 'BI') 
                  SELECT DISTINCT MNR_COMMON_PKG.MNR_GET_RHQ_OFC_FNC(MIW.ISS_OFC_CD) RHQ, MIW.ISS_OFC_CD OFC_CD
                    FROM MNR_ORD_DTL OD, MNR_PAY_INV_WRK MIW
                   WHERE OD.PAY_INV_SEQ = MIW.PAY_INV_SEQ
                     AND MIW.CRE_DT BETWEEN GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd], TO_DATE(REPLACE(@[from_mon], '-', '') ||'01', 'YYYYMMDD'), MNR_COMMON_PKG.MNR_GET_HOOFC_FNC()) 
                                        AND GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd], LAST_DAY(TO_DATE(REPLACE(@[to_mon], '-', ''), 'YYYYMM')) + 0.99999, MNR_COMMON_PKG.MNR_GET_HOOFC_FNC())
#if (${ofc_cd} != 'A')
                     AND MIW.ISS_OFC_CD = @[ofc_cd]
#end
#else 
                  SELECT DISTINCT MNR_COMMON_PKG.MNR_GET_RHQ_OFC_FNC(OH.COST_OFC_CD) RHQ, OH.COST_OFC_CD OFC_CD
                    FROM MNR_ORD_DTL OD, MNR_ORD_HDR OH
                   WHERE OH.MNR_ORD_OFC_CTY_CD = OD.MNR_ORD_OFC_CTY_CD
                     AND OH.MNR_ORD_SEQ = OD.MNR_ORD_SEQ
                     AND OH.CRE_DT BETWEEN GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd], TO_DATE(REPLACE(@[from_mon], '-', '') ||'01', 'YYYYMMDD'), MNR_COMMON_PKG.MNR_GET_HOOFC_FNC()) 
                                       AND GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd], LAST_DAY(TO_DATE(REPLACE(@[to_mon], '-', ''), 'YYYYMM')) + 0.99999, MNR_COMMON_PKG.MNR_GET_HOOFC_FNC())
#if (${ofc_cd} != 'A')
                     AND OH.COST_OFC_CD = @[ofc_cd]
#end
#end                           
                   )
SELECT RHQ,    
   OFC_CD,                     
	       CURR_CD,    
	       PLN_511511,    
	       PFMC_511511,    
	       PLN_511521,    
	       PFMC_511521,    
	       PLN_511531,    
	       PFMC_511531,    
	       PLN_511541,    
	       PFMC_511541,    
	       PLN_511551,    
	       PFMC_511551,    
	       PLN_511561,    
	       PFMC_511561    
	       FROM (    		
				  SELECT CASE WHEN  GROUPING(RHQ) = 1 AND GROUPING(OFC_CD) = 1 THEN 'G.TOTAL' WHEN GROUPING(RHQ) = 1 THEN 'G.TTL' ELSE RHQ    END AS RHQ     
				  	        , CASE WHEN  GROUPING(RHQ) = 1 AND GROUPING(OFC_CD) = 1 THEN  NULL   WHEN GROUPING(OFC_CD) = 1 THEN 'S.TTL' ELSE OFC_CD END AS OFC_CD          
				  	        , MAX(CURR_CD) CURR_CD,    
				  	        SUM(PLN_511511) PLN_511511,    
				  	       SUM(PFMC_511511) PFMC_511511,    
				  	       SUM(PLN_511521) PLN_511521,    
				  	       SUM(PFMC_511521) PFMC_511521,    
				  	       SUM(PLN_511531) PLN_511531,    
				  	       SUM(PFMC_511531) PFMC_511531,    
				  	       SUM(PLN_511541) PLN_511541,    
				  	       SUM(PFMC_511541) PFMC_511541,    
				  	       SUM(PLN_511551) PLN_511551,    
				  	       SUM(PFMC_511551) PFMC_511551,    
				  	       SUM(PLN_511561) PLN_511561,    
				  	       SUM(PFMC_511561) PFMC_511561    
				  	FROM (
                                SELECT OFC_LIST.RHQ RHQ,
                                       OFC_LIST.OFC_CD OFC_CD,
                                       'USD' CURR_CD,
                                       BUDGET.A AS PLN_511511,
                                       PFMC.A   AS PFMC_511511,
                                       BUDGET.B AS PLN_511521,
                                       PFMC.B   AS PFMC_511521,
                                       BUDGET.C AS PLN_511531,
                                       PFMC.C   AS PFMC_511531,
                                       BUDGET.D AS PLN_511541,
                                       PFMC.D   AS PFMC_511541,
                                       BUDGET.E AS PLN_511551,
                                       PFMC.E   AS PFMC_511551,
                                       BUDGET.F AS PLN_511561,
                                       PFMC.F   AS PFMC_511561
                                  FROM (SELECT MNR_COMMON_PKG.MNR_GET_RHQ_OFC_FNC(PD.CTRL_OFC_CD) RHQ, PD.CTRL_OFC_CD OFC_CD,
                                               NVL(SUM(DECODE(PD.ACCT_CD, '511511', PD.MNR_PLN_AMT, 0)), 0) A,
                                               NVL(SUM(DECODE(PD.ACCT_CD, '511521', PD.MNR_PLN_AMT, 0)), 0) B,
                                               NVL(SUM(DECODE(PD.ACCT_CD, '511531', PD.MNR_PLN_AMT, 0)), 0) C,
                                               NVL(SUM(DECODE(PD.ACCT_CD, '511541', PD.MNR_PLN_AMT, 0)), 0) D,
                                               NVL(SUM(DECODE(PD.ACCT_CD, '511551', PD.MNR_PLN_AMT, 0)), 0) E,
                                               NVL(SUM(DECODE(PD.ACCT_CD, '511561', PD.MNR_PLN_AMT, 0)), 0) F
                                          FROM MNR_PLN_DTL PD, MNR_PLN_HDR PH
                                         WHERE PH.MNR_PLN_SEQ = PD.MNR_PLN_SEQ
                                           AND PH.MNR_PLN_YR BETWEEN SUBSTR(REPLACE(@[from_mon], '-', ''), 3, 6) 
                                                                 AND SUBSTR(REPLACE(@[to_mon], '-', ''), 3, 6)
                                #if (${ofc_cd} != 'A')
                                           AND PD.CTRL_OFC_CD = @[ofc_cd] 
                                #end
                                           AND PH.MNR_GRP_TP_CD = 'RPR'
                                           AND PH.MNR_PLN_FLG = 'Y'
                                           AND PD.OFC_TP_CD = 'BB'
                                      GROUP BY MNR_COMMON_PKG.MNR_GET_RHQ_OFC_FNC(PD.CTRL_OFC_CD), PD.CTRL_OFC_CD) BUDGET, 
                                #if (${report_type} == 'BI') 
                                       (SELECT MNR_COMMON_PKG.MNR_GET_RHQ_OFC_FNC(MIW.ISS_OFC_CD) RHQ, MIW.ISS_OFC_CD OFC_CD,
                                               SUM(DECODE(OD.ACCT_CD, '511511', MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(TO_CHAR(MIW.CRE_DT, 'YYYYMM'), MIW.CURR_CD, 'USD', NVL(OD.INV_AMT, 0)), 0)) A,
                                               SUM(DECODE(OD.ACCT_CD, '511521', MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(TO_CHAR(MIW.CRE_DT, 'YYYYMM'), MIW.CURR_CD, 'USD', NVL(OD.INV_AMT, 0)), 0)) B,
                                               SUM(DECODE(OD.ACCT_CD, '511531', MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(TO_CHAR(MIW.CRE_DT, 'YYYYMM'), MIW.CURR_CD, 'USD', NVL(OD.INV_AMT, 0)), 0)) C,
                                               SUM(DECODE(OD.ACCT_CD, '511541', MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(TO_CHAR(MIW.CRE_DT, 'YYYYMM'), MIW.CURR_CD, 'USD', NVL(OD.INV_AMT, 0)), 0)) D,
                                               SUM(DECODE(OD.ACCT_CD, '511551', MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(TO_CHAR(MIW.CRE_DT, 'YYYYMM'), MIW.CURR_CD, 'USD', NVL(OD.INV_AMT, 0)), 0)) E,
                                               SUM(DECODE(OD.ACCT_CD, '511561', MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(TO_CHAR(MIW.CRE_DT, 'YYYYMM'), MIW.CURR_CD, 'USD', NVL(OD.INV_AMT, 0)), 0)) F
                                          FROM MNR_ORD_DTL OD, MNR_PAY_INV_WRK MIW
                                         WHERE OD.PAY_INV_SEQ = MIW.PAY_INV_SEQ
                                           AND MIW.CRE_DT BETWEEN GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd], TO_DATE(REPLACE(@[from_mon], '-', '') ||'01', 'YYYYMMDD'), MNR_COMMON_PKG.MNR_GET_HOOFC_FNC()) 
                                                              AND GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd], LAST_DAY(TO_DATE(REPLACE(@[to_mon], '-', ''), 'YYYYMM')) + 0.99999, MNR_COMMON_PKG.MNR_GET_HOOFC_FNC())
                                #if (${ofc_cd} != 'A')
                                           AND MIW.ISS_OFC_CD = @[ofc_cd] 
                                #end
                                      GROUP BY MNR_COMMON_PKG.MNR_GET_RHQ_OFC_FNC(MIW.ISS_OFC_CD), MIW.ISS_OFC_CD
                                        #else 
                                       (SELECT MNR_COMMON_PKG.MNR_GET_RHQ_OFC_FNC(OH.COST_OFC_CD) RHQ, OH.COST_OFC_CD OFC_CD,
                                               SUM(DECODE(OD.ACCT_CD, '511511', MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(TO_CHAR(OD.CRE_DT, 'YYYYMM'), OH.CURR_CD, 'USD', NVL(OD.COST_AMT, 0)), 0)) A, 
                                               SUM(DECODE(OD.ACCT_CD, '511521', MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(TO_CHAR(OD.CRE_DT, 'YYYYMM'), OH.CURR_CD, 'USD', NVL(OD.COST_AMT, 0)), 0)) B, 
                                               SUM(DECODE(OD.ACCT_CD, '511531', MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(TO_CHAR(OD.CRE_DT, 'YYYYMM'), OH.CURR_CD, 'USD', NVL(OD.COST_AMT, 0)), 0)) C, 
                                               SUM(DECODE(OD.ACCT_CD, '511541', MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(TO_CHAR(OD.CRE_DT, 'YYYYMM'), OH.CURR_CD, 'USD', NVL(OD.COST_AMT, 0)), 0)) D, 
                                               SUM(DECODE(OD.ACCT_CD, '511551', MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(TO_CHAR(OD.CRE_DT, 'YYYYMM'), OH.CURR_CD, 'USD', NVL(OD.COST_AMT, 0)), 0)) E, 
                                               SUM(DECODE(OD.ACCT_CD, '511561', MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(TO_CHAR(OD.CRE_DT, 'YYYYMM'), OH.CURR_CD, 'USD', NVL(OD.COST_AMT, 0)), 0)) F
                                          FROM MNR_ORD_DTL OD, MNR_ORD_HDR OH
                                         WHERE OH.MNR_ORD_OFC_CTY_CD = OD.MNR_ORD_OFC_CTY_CD
                                           AND OH.MNR_ORD_SEQ = OD.MNR_ORD_SEQ
                                           AND OH.CRE_DT BETWEEN GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd], TO_DATE(REPLACE(@[from_mon], '-', '') ||'01', 'YYYYMMDD'), MNR_COMMON_PKG.MNR_GET_HOOFC_FNC()) 
                                                             AND GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd], LAST_DAY(TO_DATE(REPLACE(@[to_mon], '-', ''), 'YYYYMM')) + 0.99999, MNR_COMMON_PKG.MNR_GET_HOOFC_FNC())
                                #if (${ofc_cd} != 'A')
                                           AND OH.COST_OFC_CD = @[ofc_cd]
                                #end
                                      GROUP BY MNR_COMMON_PKG.MNR_GET_RHQ_OFC_FNC(OH.COST_OFC_CD), OH.COST_OFC_CD
                                #end 
                                      ) PFMC,
                                      OFC_LIST
                                 WHERE BUDGET.OFC_CD(+) = OFC_LIST.OFC_CD
                                   AND PFMC.OFC_CD(+) = OFC_LIST.OFC_CD
                                #if (${rhq} != 'A')
                                   AND OFC_LIST.RHQ = DECODE(@[rhq], 'SELCON', 'SELHO', @[rhq])
                                #end
								)	
					GROUP BY GROUPING SETS ((RHQ), (RHQ,OFC_CD), ())	
					ORDER BY DECODE(RHQ, 'SELHO', 0, 'G.TOTAL',2,1), RHQ, DECODE(OFC_CD, 'S.TTL', 1, 0)	
					)	
	where RHQ <> 'SELHO' or OFC_CD <> 'S.TTL'			]]></sql>
			<params>
				<param name="from_mon" type="12" value="" out="N"/>
				<param name="to_mon" type="12" value="" out="N"/>
				<param name="ofc_cd" type="12" value="" out="N"/>
				<param name="user_ofc_cd" type="12" value="" out="N"/>
				<param name="rhq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
