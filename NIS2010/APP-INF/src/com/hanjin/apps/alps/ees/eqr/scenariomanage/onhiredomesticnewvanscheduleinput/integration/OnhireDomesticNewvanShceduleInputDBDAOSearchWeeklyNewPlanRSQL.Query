<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="OnhireDomesticNewvanShceduleInputDBDAOSearchWeeklyNewPlanRSQL">
			<desc><![CDATA[EQR_SCNR_NEW_VAN_LONG_TERM + EQR_NEW_VAN_LONG_TERM_PERF 테이블 데이터 조회(Weekly)]]></desc>
			<sql><![CDATA[
SELECT
    CO_CD ,
    RCC_CD,
    ECC_CD,
    CNTR_LSTM_CD,
    CNTR_TPSZ_CD,
    VNDR_ABBR_NM VNDR_ABBR_NM_CD,
    VNDR_CNT_CD||VNDR_SEQ VNDR_SEQ_CD,
    CNTR_DE_STS_CD,
    #if ($arrPerfixWeekly.size() > 0)
        #foreach( $key in ${arrPerfixWeekly})
            #if($velocityCount == 1)
                NVL(MAX (DECODE (PLN_YRMON,'$key' , CNTR_VOL_QTY)),0 )
                --해당 월의 모든 전주의 Available 수량을 구한다.
                #if (${pikupVolSearchchk} == 'TRUE')
                    + (
                        (
                            SELECT
                            NVL(SUM(A.CNTR_VOL_QTY),0) QTY1
                            FROM
                            EQR_NEW_VAN_LONG_TERM A
                            WHERE A.PLN_YRMON
                            IN (
                                SELECT PLN_YR|| PLN_WK
                                FROM EQR_WK_PRD
                                WHERE PLN_YR =@[st_year]
                                AND PLN_MON =@[st_month]
                                AND PLN_WK < @[st_weekly]
                            )
                            AND A.CNTR_TPSZ_CD = C.CNTR_TPSZ_CD
                            AND A.CO_CD = C.CO_CD
                            AND A.ECC_CD = C.ECC_CD
                            AND A.CNTR_LSTM_CD = C.CNTR_LSTM_CD
                            AND A.VNDR_CNT_CD  = C.VNDR_CNT_CD
                            AND A.VNDR_SEQ     = C.VNDR_SEQ
                            AND A.VNDR_ABBR_NM   = C.VNDR_ABBR_NM
                            AND A.CNTR_DE_STS_CD = 'A'
                        )  -
                        --전주에 해당하는 월을 구하여 pkup vol 값을 가져온다.
                        (
                            SELECT
                            NVL(SUM(A.CNTR_PKUP_QTY),0) QTY2
                            FROM  EQR_NEW_VAN_LONG_TERM_PERF A
                            WHERE PERF_YRMON =@[fmPlnYrmo]
                            AND A.CNTR_TPSZ_CD = C.CNTR_TPSZ_CD
                            AND A.CO_CD = C.CO_CD
                            AND A.ECC_CD = C.ECC_CD
                            AND A.CNTR_LSTM_CD = C.CNTR_LSTM_CD
                            AND A.CNTR_TPSZ_CD = C.CNTR_TPSZ_CD
                            AND A.VNDR_CNT_CD  = C.VNDR_CNT_CD
                            AND A.VNDR_SEQ     = C.VNDR_SEQ
                            AND A.VNDR_ABBR_NM   = C.VNDR_ABBR_NM
                        )
                    )
                #end
                +
                --조회 주를 제외한 01월 부터 조회주 이전 달의 주의 Availble 값을 구한다.
                (
                    (
                        SELECT
                        NVL(SUM(A.CNTR_VOL_QTY),0) QTY1
                        FROM
                        EQR_NEW_VAN_LONG_TERM A
                        WHERE A.PLN_YRMON IN  (
                            SELECT PLN_YR|| PLN_WK
                            FROM EQR_WK_PRD
                            WHERE PLN_YR =@[st_year]
                            AND PLN_MON <=@[month_key]
                        )
                        AND A.CNTR_TPSZ_CD = C.CNTR_TPSZ_CD
                        AND A.CO_CD = C.CO_CD
                        AND A.ECC_CD = C.ECC_CD
                        AND A.CNTR_LSTM_CD = C.CNTR_LSTM_CD
                        AND A.CNTR_TPSZ_CD = C.CNTR_TPSZ_CD
                        AND A.VNDR_CNT_CD  = C.VNDR_CNT_CD
                        AND A.VNDR_SEQ     = C.VNDR_SEQ
                        AND A.VNDR_ABBR_NM   = C.VNDR_ABBR_NM
                        AND A.CNTR_DE_STS_CD ='A'
                    )  -
                    (
                        --조회주 제안한 1월달 부터 조회 전주 달까지 pkup vol 총합을 가져온다
                        SELECT
                        NVL(SUM(A.CNTR_PKUP_QTY),0) QTY2
                        FROM  EQR_NEW_VAN_LONG_TERM_PERF A
                        WHERE PERF_YRMON IN (SELECT DISTINCT(PLN_YR|| PLN_MON)
                        FROM EQR_WK_PRD
                        WHERE PLN_YR =@[st_year] AND PLN_MON <=@[month_key])
                        AND A.CNTR_TPSZ_CD = C.CNTR_TPSZ_CD
                        AND A.CO_CD = C.CO_CD
                        AND A.ECC_CD = C.ECC_CD
                        AND A.CNTR_LSTM_CD = C.CNTR_LSTM_CD
                        AND A.CNTR_TPSZ_CD = C.CNTR_TPSZ_CD
                        AND A.VNDR_CNT_CD  = C.VNDR_CNT_CD
                        AND A.VNDR_SEQ     = C.VNDR_SEQ
                        AND A.VNDR_ABBR_NM   = C.VNDR_ABBR_NM
                    )
                )
                S1_${key}_CNTR_VOL_QTY,
            #else
                MAX (DECODE (PLN_YRMON,'$key' , CNTR_VOL_QTY)) S1_${key}_CNTR_VOL_QTY,
            #end
        #end
    #end
    SCNR_ID,
    VNDR_CNT_CD,
    VNDR_ABBR_NM,
    VNDR_SEQ
FROM (
    SELECT
        A.CO_CD,
        A.CNTR_LSTM_CD,
        A.CNTR_TPSZ_CD,
        (SELECT RCC_CD FROM EQR_ECC_MST WHERE A.ECC_CD = ECC_CD)RCC_CD,
        A.ECC_CD,
        A.VNDR_ABBR_NM,
        A.VNDR_CNT_CD,
        A.VNDR_SEQ,
        A.CNTR_DE_STS_CD,
        A.PLN_YRMON,
        A.SCNR_ID,
        SUM (A.CNTR_VOL_QTY) AS CNTR_VOL_QTY
    FROM
        EQR_SCNR_NEW_VAN_LONG_TERM A,
        EQR_ECC_MST B
    WHERE
        A.ECC_CD = B.ECC_CD
        AND A.SCNR_ID = @[scnr_id]
        AND A.PLN_YRMON BETWEEN @[fmPlnYrwk] AND @[toPlnYrwk]
        AND A.CNTR_DE_STS_CD ='A'
        #if (${location} == 'R')
        AND B.RCC_CD IN(
          #foreach( $key in ${arrlocation})
            #if($velocityCount < $arrlocation.size())
            '$key',
            #else
            '$key'
            #end
          #end
          )
        #elseif (${location} == 'L')
        AND B.LCC_CD IN(
          #foreach( $key in ${arrlocation})
            #if($velocityCount < $arrlocation.size())
            '$key',
            #else
            '$key'
            #end
          #end
        )
        #elseif (${location} == 'E')
        AND B.ECC_CD IN(
          #foreach( $key in ${arrlocation})
            #if($velocityCount < $arrlocation.size())
            '$key',
            #else
            '$key'
            #end
          #end
        )
        #end
        #if ($arrtpszcd.size() > 0)
          AND A.CNTR_TPSZ_CD IN(
          #foreach( $key in ${arrtpszcd})
            #if($velocityCount < $arrtpszcd.size())
            '$key',
            #else
            '$key'
            #end
          #end
          )
        #end
        #if (${leaseterm} != '')
            AND A.CNTR_LSTM_CD =@[leaseterm]
        #end
    GROUP BY
        A.PLN_YRMON,
        A.CO_CD,
        A.CNTR_LSTM_CD,
        A.CNTR_TPSZ_CD,
        A.ECC_CD,
        A.VNDR_CNT_CD,
        A.VNDR_SEQ,
        A.CNTR_DE_STS_CD,
        A.SCNR_ID ,
        A.VNDR_ABBR_NM
)C
GROUP BY
    CO_CD,
    CNTR_LSTM_CD,
    CNTR_TPSZ_CD,
    RCC_CD, ECC_CD,
    VNDR_CNT_CD,
    VNDR_SEQ,
    CNTR_DE_STS_CD,
    SCNR_ID,
    VNDR_ABBR_NM

UNION

SELECT
    CO_CD,
    RCC_CD,
    ECC_CD,
    CNTR_LSTM_CD,
    CNTR_TPSZ_CD,
    VNDR_ABBR_NM,
    VNDR_CNT_CD||VNDR_SEQ ,
    CNTR_DE_STS_CD,
    #if ($arrPerfixWeekly.size() > 0)
        #foreach( $key in ${arrPerfixWeekly})
            MAX (DECODE (PLN_YRMON,'$key' , CNTR_VOL_QTY)) S1_${key}_CNTR_VOL_QTY,
        #end
    #end
    SCNR_ID,
    VNDR_CNT_CD,
    VNDR_ABBR_NM AS VNDER_ADDR ,
    VNDR_SEQ
FROM (
    SELECT
        A.CO_CD,
        A.CNTR_LSTM_CD,
        A.CNTR_TPSZ_CD,
        (SELECT RCC_CD FROM EQR_ECC_MST WHERE A.ECC_CD = ECC_CD)RCC_CD,
        A.ECC_CD,
        A.VNDR_ABBR_NM,
        A.VNDR_CNT_CD,
        A.VNDR_SEQ,
        A.CNTR_DE_STS_CD,
        A.PLN_YRMON,
        A.SCNR_ID,
        SUM (A.CNTR_VOL_QTY) AS CNTR_VOL_QTY
    FROM
        EQR_SCNR_NEW_VAN_LONG_TERM A,
        EQR_ECC_MST B
    WHERE
        A.ECC_CD = B.ECC_CD
        AND A.SCNR_ID = @[scnr_id]
        AND A.PLN_YRMON BETWEEN @[fmPlnYrwk] AND @[toPlnYrwk]
        AND A.CNTR_DE_STS_CD ='L'
        #if (${location} == 'R')
        AND B.RCC_CD IN(
          #foreach( $key in ${arrlocation})
            #if($velocityCount < $arrlocation.size())
            '$key',
            #else
            '$key'
            #end
          #end
          )
        #elseif (${location} == 'L')
        AND B.LCC_CD IN(
          #foreach( $key in ${arrlocation})
            #if($velocityCount < $arrlocation.size())
            '$key',
            #else
            '$key'
            #end
          #end
        )
        #elseif (${location} == 'E')
        AND B.ECC_CD IN(
          #foreach( $key in ${arrlocation})
            #if($velocityCount < $arrlocation.size())
            '$key',
            #else
            '$key'
            #end
          #end
        )
        #end
        #if ($arrtpszcd.size() > 0)
          AND A.CNTR_TPSZ_CD IN(
          #foreach( $key in ${arrtpszcd})
            #if($velocityCount < $arrtpszcd.size())
            '$key',
            #else
            '$key'
            #end
          #end
          )
        #end
        #if (${leaseterm} != '')
            AND A.CNTR_LSTM_CD =@[leaseterm]
        #end
    GROUP BY
        PLN_YRMON,
        CO_CD,
        CNTR_LSTM_CD,
        CNTR_TPSZ_CD,
        A.ECC_CD,
        VNDR_CNT_CD,
        VNDR_SEQ,
        CNTR_DE_STS_CD,
        A.SCNR_ID ,
        VNDR_ABBR_NM
)
GROUP BY
    CO_CD,
    CNTR_LSTM_CD,
    CNTR_TPSZ_CD,
    RCC_CD,
    ECC_CD,
    VNDR_CNT_CD,
    VNDR_SEQ,
    CNTR_DE_STS_CD,
    SCNR_ID,
    VNDR_ABBR_NM
ORDER BY
    CO_CD,
    CNTR_LSTM_CD,
    CNTR_TPSZ_CD,
    RCC_CD ,
    ECC_CD,
    VNDR_ABBR_NM,
    VNDR_SEQ,
    CNTR_DE_STS_CD			]]></sql>
			<params>
				<param name="st_year" type="12" value="" out="N"/>
				<param name="st_month" type="12" value="" out="N"/>
				<param name="st_weekly" type="12" value="" out="N"/>
				<param name="fmPlnYrmo" type="12" value="" out="N"/>
				<param name="month_key" type="12" value="" out="N"/>
				<param name="scnr_id" type="12" value="" out="N"/>
				<param name="fmPlnYrwk" type="12" value="" out="N"/>
				<param name="toPlnYrwk" type="12" value="" out="N"/>
				<param name="leaseterm" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
