<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="InvoiceIssueCollectionMgtDBDAOSearchOTSInquiryByDetailListForSrepRSQL">
			<desc><![CDATA[EES_DMT_4011
Outstanding Inquiry by Customer N Issue for Sales Rep - Detail(s)
]]></desc>
			<sql><![CDATA[
WITH MN_DATA AS (
SELECT  M.DMDT_INV_NO
       ,M.VSL_CD
       ,M.SKD_VOY_NO
       ,M.SKD_DIR_CD  
       ,M.BKG_NO       
       ,M.BL_NO        
       ,M.TAX_RTO
       ,M.INV_CURR_CD  
       ,M.INV_CHG_AMT
       ,M.TAX_AMT
       ,M.INV_AMT
       ,M.DMDT_TRF_CD      
       ,M.CRE_DT                    
       ,M.CRE_OFC_CD
       ,M.POR_CD
       ,M.POL_CD
       ,M.POD_CD
       ,M.DEL_CD
       ,(SELECT /*+ NO_UNNEST */ OB_SREP_CD FROM BKG_BOOKING WHERE BKG_NO = M.BKG_NO ) AS OB_SREP_CD
       ,(SELECT /*+ NO_UNNEST */ SUM(ORG_CHG_AMT) FROM DMT_CHG_CALC WHERE DMDT_INV_NO = M.DMDT_INV_NO ) AS ORG_CHG_AMT
       ,(SELECT /*+ NO_UNNEST */ SC_NO  FROM BKG_BOOKING WHERE BKG_NO = M.BKG_NO ) AS SC_NO
       ,(SELECT /*+ NO_UNNEST */ RFA_NO FROM BKG_BOOKING WHERE BKG_NO = M.BKG_NO ) AS RFA_NO
       ,(SELECT /*+ NO_UNNEST */ TAA_NO FROM BKG_BOOKING WHERE BKG_NO = M.BKG_NO ) AS TAA_NO
       ,(SELECT /*+ NO_UNNEST */ CUST_CNT_CD FROM BKG_CUSTOMER WHERE BKG_NO = M.BKG_NO AND BKG_CUST_TP_CD ='S') AS S_CUST_CNT_CD
       ,(SELECT /*+ NO_UNNEST */ CUST_SEQ    FROM BKG_CUSTOMER WHERE BKG_NO = M.BKG_NO AND BKG_CUST_TP_CD ='S') AS S_CUST_SEQ
       ,(SELECT /*+ NO_UNNEST */ CUST_NM     FROM BKG_CUSTOMER WHERE BKG_NO = M.BKG_NO AND BKG_CUST_TP_CD ='S') AS S_CUST_NM
       ,(SELECT /*+ NO_UNNEST */ CUST_CNT_CD FROM BKG_CUSTOMER WHERE BKG_NO = M.BKG_NO AND BKG_CUST_TP_CD ='C') AS C_CUST_CNT_CD
       ,(SELECT /*+ NO_UNNEST */ CUST_SEQ    FROM BKG_CUSTOMER WHERE BKG_NO = M.BKG_NO AND BKG_CUST_TP_CD ='C') AS C_CUST_SEQ
       ,(SELECT /*+ NO_UNNEST */ CUST_NM     FROM BKG_CUSTOMER WHERE BKG_NO = M.BKG_NO AND BKG_CUST_TP_CD ='C') AS C_CUST_NM
       ,(SELECT /*+ NO_UNNEST */ SUM(CMDT_EXPT_AMT)   FROM DMT_CHG_CALC WHERE DMDT_INV_NO = M.DMDT_INV_NO )     AS CMDT_EXPT_AMT
       ,(SELECT /*+ NO_UNNEST */ SUM(SC_RFA_EXPT_AMT) FROM DMT_CHG_CALC WHERE DMDT_INV_NO = M.DMDT_INV_NO )     AS SC_RFA_EXPT_AMT
       ,(SELECT /*+ NO_UNNEST */ SUM(AFT_EXPT_DC_AMT) FROM DMT_CHG_CALC WHERE DMDT_INV_NO = M.DMDT_INV_NO )     AS AFT_EXPT_DC_AMT
       ,M.INV_RMK
       ,M.CXL_RMK
       ,M.DMDT_INV_STS_CD
       ,M.DMDT_VT_INV_STS_CD
       ,OTS_CLT_FLG
       ,CASE 
			WHEN (NVL(OTS_CLT_FLG,'N') != 'Y' AND DMDT_INV_STS_CD = 'I' AND DMDT_AR_IF_CD = 'Y' AND ATTR_CTNT1 IS NULL) THEN 
				'Y'
			ELSE 
				'N'
		END V_COLLECTED
	   ,INV_XCH_RT
	   
  FROM  DMT_INV_MN      	M
       ,DMT_HRD_CDG_CTNT 	D
	   
 WHERE  1 = 1 
   AND  M.CRE_OFC_CD    = D.ATTR_CTNT1(+)
   AND  D.HRD_CDG_ID(+) = 'AUTO_AR_IF_OFC'

	#if (${arif} != '')
   AND  ( 1!=1 
		#if (${uncollected} == 'N')
		OR (DMDT_INV_STS_CD  IN ('I','X','C') AND DMDT_AR_IF_CD = 'N')								--// AUTO I/F OFFICE 가 아닌 경우
		#end 
		#if (${collected} == 'Y')
		OR ( DMDT_AR_IF_CD = 'Y' )
		#end 
		#if (${hold} == 'H')
		OR M.DMDT_AR_IF_CD = 'H'
		#end 
		#if (${hold_Litigation} == 'L')
		OR (M.DMDT_AR_IF_CD = 'H' AND M.INV_HLD_RSN_CD = 'LIT')
		#end 
		)
	#end 

   AND  M.CRE_DT BETWEEN TO_DATE(REPLACE(@[frdt],'-',''),'YYYYMMDD') + .00000 AND TO_DATE(REPLACE(@[todt],'-',''),'YYYYMMDD') + .99999   /* INVOICE ISSUE DATE */
                
#if ( ${isof} != '' )
   AND  M.CRE_OFC_CD IN (
#foreach( $cre_ofc_cd_p in ${tempISOFList}) 
  #if($velocityCount < $tempISOFList.size()) 
     '$cre_ofc_cd_p', 
  #else 
     '$cre_ofc_cd_p' 
  #end 
#end
)
#end

   AND  (M.DMDT_INV_STS_CD = 'I' or (M.DMDT_INV_STS_CD = 'X' AND M.DMDT_VT_INV_STS_CD = 'C'))		-- NOT CANCELED INVOICE or VIRTUAL INVOICE modified 2014.12.30 by jameskai
   AND  M.ACT_PAYR_CNT_CD  = DECODE(LENGTH(@[payc]), 8, NVL(SUBSTR(@[payc], 1, 2), M.ACT_PAYR_CNT_CD), 6, M.ACT_PAYR_CNT_CD, M.ACT_PAYR_CNT_CD)
   AND  M.ACT_PAYR_SEQ     = DECODE(LENGTH(@[payc]), 8, NVL(SUBSTR(@[payc], 3, 6), M.ACT_PAYR_SEQ),    6, @[payc],           M.ACT_PAYR_SEQ)

#if ( ${inpayr} != '' )
   AND  M.ACT_PAYR_CNT_CD  = DECODE(LENGTH(@[inpayr]), 8, NVL(SUBSTR(@[inpayr], 1, 2), M.ACT_PAYR_CNT_CD), 6, M.ACT_PAYR_CNT_CD, M.ACT_PAYR_CNT_CD)
   AND  M.ACT_PAYR_SEQ     = DECODE(LENGTH(@[inpayr]), 8, NVL(SUBSTR(@[inpayr], 3, 6), M.ACT_PAYR_SEQ),    6, @[inpayr],           M.ACT_PAYR_SEQ)
#end


#if ( ${grop_cust} != '' )
   AND  ( M.ACT_PAYR_CNT_CD, M.ACT_PAYR_SEQ ) IN
			( SELECT A.CUST_CNT_CD, A.CUST_SEQ FROM MDM_CUSTOMER A, MDM_CUST_PERF_GRP B
			   WHERE A.CUST_GRP_ID = B.CUST_GRP_ID
				 AND A.DELT_FLG ='N'
				 AND B.DELT_FLG ='N'
				 AND A.CUST_GRP_ID = 'G-'||@[grop_cust] )
#end

#if ( ${tftp} != 'A' )
   AND  M.DMDT_TRF_CD IN (
#foreach( $dmdt_trf_cd_p in ${tempTFTPList}) 
  #if($velocityCount < $tempTFTPList.size()) 
     '$dmdt_trf_cd_p', 
  #else 
     '$dmdt_trf_cd_p' 
  #end 
#end
)
#end

#if( ${ctrt_no} != '')
	#if ( ${ctrt_tp} == 'SC' )
	AND (SELECT SC_NO FROM BKG_BOOKING WHERE BKG_NO = M.BKG_NO ) = @[ctrt_no]
	#elseif (${ctrt_tp} == 'RFA' )
	AND (SELECT RFA_NO FROM BKG_BOOKING WHERE BKG_NO = M.BKG_NO ) = @[ctrt_no]
	#else
	AND (SELECT TAA_NO FROM BKG_BOOKING WHERE BKG_NO = M.BKG_NO ) = @[ctrt_no]
	#end
#end
#if ( ${ctrt_tp} == 'SC' )
AND EXISTS (SELECT 'X' FROM BKG_BOOKING WHERE BKG_NO = M.BKG_NO AND SC_NO IS NOT NULL )
#elseif (${ctrt_tp} == 'RFA' )
AND EXISTS (SELECT 'X' FROM BKG_BOOKING WHERE BKG_NO = M.BKG_NO AND RFA_NO IS NOT NULL )
#else
AND EXISTS (SELECT 'X' FROM BKG_BOOKING WHERE BKG_NO = M.BKG_NO AND TAA_NO IS NOT NULL )
#end


#if ( ${scNoList} != '' || ${rfaNoList} != '' || ${taaNoList} != '' )
	AND (1 = 0 
#if ( ${scNoList} != '' )
   	OR (SELECT SC_NO FROM BKG_BOOKING WHERE BKG_NO = M.BKG_NO ) IN (
			#foreach( $scNo in ${scNoList}) #if($velocityCount < $scNoList.size()) '$scNo', #else '$scNo' #end #end
		)
#end
#if ( ${rfaNoList} != '' )
   	OR (SELECT RFA_NO FROM BKG_BOOKING WHERE BKG_NO = M.BKG_NO ) IN (
			#foreach( $rfaNo in ${rfaNoList}) #if($velocityCount < $rfaNoList.size()) '$rfaNo', #else '$rfaNo' #end #end
		)
#end
#if ( ${taaNoList} != '' )
   	OR (SELECT TAA_NO FROM BKG_BOOKING WHERE BKG_NO = M.BKG_NO ) IN (
			#foreach( $taaNo in ${taaNoList}) #if($velocityCount < $taaNoList.size()) '$taaNo', #else '$taaNo' #end #end
		)
#end
	)
#end


#if( ${cuno} != '')
 AND  M.BKG_NO  in 
(
select  BKG_NO
from  BKG_CUSTOMER    BC
where  BC.CUST_CNT_CD = NVL(SUBSTR(@[cuno], 1, 2), BC.CUST_CNT_CD)
 AND  BC.CUST_SEQ    = NVL(SUBSTR(@[cuno], 3, 6), BC.CUST_SEQ)
 AND  (
		DECODE(NVL(@[cutp],''),'','A',@[cutp]) = 'A'

		#if ( ${cutp} != 'A' )
		or BKG_CUST_TP_CD in 
		   (
			#foreach( $bkg_cust_tp_cd_p in ${tempCUTPList}) 
				#if($velocityCount < $tempCUTPList.size()) 
				   '$bkg_cust_tp_cd_p', 
				#else 
				   '$bkg_cust_tp_cd_p' 
				#end 
			#end
		   )
		#end
	)
)
#end
#if ( ${prg_ex_in_cd} == 'EX' )
AND  NVL(M.PRG_FLG, 'N') = 'N'   -- PURGE BOOKING 제외
#elseif ( ${prg_ex_in_cd} == 'ON' )
AND  NVL(M.PRG_FLG, 'N') = 'Y'   -- PURGE BOOKING 제외
#end

#if ( ${coll} != '' && ${coll} != 'A' )	 
	#if ( ${coll} == 'N' ) 
   AND  CASE 
			WHEN D.ATTR_CTNT1 IS NOT NULL AND M.DMDT_AR_IF_CD = 'Y' THEN 
				NVL(OTS_CLT_FLG, 'N')
            WHEN D.ATTR_CTNT1 IS NOT NULL AND M.DMDT_INV_STS_CD = 'X' AND M.DMDT_AR_IF_CD = 'N' THEN 
				'Y'
            WHEN M.DMDT_INV_STS_CD = 'I' AND M.DMDT_AR_IF_CD = 'Y' THEN 
				'Y'
            WHEN M.DMDT_INV_STS_CD = 'I' AND M.DMDT_AR_IF_CD = 'N' THEN 
				'N'
            WHEN M.DMDT_INV_STS_CD IN ('C', 'X') THEN 
				'Y'
            ELSE 
				'N' 
		END = 'N'
	#else 

   AND  CASE 
			WHEN D.ATTR_CTNT1 IS NOT NULL AND M.DMDT_AR_IF_CD = 'Y' THEN 
				NVL(OTS_CLT_FLG, 'N')
            WHEN D.ATTR_CTNT1 IS NOT NULL AND M.DMDT_INV_STS_CD = 'X' AND M.DMDT_AR_IF_CD = 'N' THEN 
				'Y'
            WHEN M.DMDT_INV_STS_CD = 'I' AND M.DMDT_AR_IF_CD = 'Y' THEN 
				'Y'
            WHEN M.DMDT_INV_STS_CD = 'I' AND M.DMDT_AR_IF_CD = 'N' THEN 
				'N'
            WHEN M.DMDT_INV_STS_CD IN ('C', 'X') THEN 
				'Y'
            ELSE 
				'N' 
		END = 'Y'
	#end 
#end  

#if ( ${invocr} != '' ) 
    AND M.INV_CURR_CD = @[invocr]
#end  

GROUP BY 
    M.DMDT_INV_NO
   ,M.VSL_CD
   ,M.SKD_VOY_NO
   ,M.SKD_DIR_CD  
   ,M.BKG_NO       
   ,M.BL_NO        
   ,M.TAX_RTO
   ,M.INV_CURR_CD  
   ,M.INV_CHG_AMT
   ,M.TAX_AMT
   ,M.INV_AMT
   ,M.DMDT_TRF_CD      
   ,M.CRE_DT                    
   ,M.CRE_OFC_CD
   ,M.POR_CD
   ,M.POL_CD
   ,M.POD_CD
   ,M.DEL_CD
   ,M.INV_RMK
   ,M.CXL_RMK
   ,M.DMDT_INV_STS_CD
   ,M.DMDT_VT_INV_STS_CD
   ,OTS_CLT_FLG
   ,CASE 
		WHEN (NVL(OTS_CLT_FLG,'N') !='Y' AND DMDT_INV_STS_CD = 'I' AND DMDT_AR_IF_CD = 'Y' AND ATTR_CTNT1 IS NULL) THEN 
			'Y'
		ELSE 
			'N'
	END
   ,INV_XCH_RT
)


, PRI_INFO AS (
    SELECT *
      FROM ( 
#if ( ${ctrt_tp} == 'SC' )
			 SELECT /*+ LEADING(A,HDR,MN,PTY) USE_NL(HDR,MN,PTY) */ 
                    A.*, NVL(MN.REAL_CUST_SLS_OFC_CD, PTY.CTRT_CUST_SLS_OFC_CD) PRI_OFC_CD
                    , NVL(MN.REAL_CUST_SREP_CD, PTY.CTRT_CUST_SREP_CD) PRI_SREP_CD
                    , CASE WHEN REAL_CUST_CNT_CD||TRIM(TO_CHAR(REAL_CUST_SEQ,'000000')) IS NULL 
                                THEN PTY.CUST_CNT_CD
                           ELSE REAL_CUST_CNT_CD END CTRT_CUST_CNT_CD
                    , CASE WHEN REAL_CUST_CNT_CD||TRIM(TO_CHAR(REAL_CUST_SEQ,'000000')) IS NULL 
                                THEN PTY.CUST_SEQ
                           ELSE REAL_CUST_SEQ END CTRT_CUST_SEQ
               FROM MN_DATA A,
                    PRI_SP_HDR HDR, 
                    PRI_SP_MN MN, 
                    PRI_SP_CTRT_PTY PTY
              WHERE 1=1
                AND A.SC_NO IS NOT NULL
                AND A.SC_NO = HDR.SC_NO
#if ( ${ctof} != '' )
   	AND NVL(MN.REAL_CUST_SLS_OFC_CD, PTY.CTRT_CUST_SLS_OFC_CD) IN (
			#foreach( $ctrt_ofc_cd in ${tempCTOFList}) #if($velocityCount < $tempCTOFList.size()) '$ctrt_ofc_cd', #else '$ctrt_ofc_cd' #end #end
		)
#end

   	AND NVL(MN.REAL_CUST_SREP_CD, PTY.CTRT_CUST_SREP_CD) = @[ctrt_srep_cd]

    AND HDR.PROP_NO = MN.PROP_NO
    AND MN.PROP_STS_CD ='F'
    AND MN.AMDT_SEQ = (SELECT /*+ NO_UNNEST */ 
                              MAX(AMDT_SEQ)
                       FROM PRI_SP_MN 
                       WHERE 1=1
                         AND PROP_NO = MN.PROP_NO
                         AND PROP_STS_CD = MN.PROP_STS_CD 
                       )    
    AND PTY.PROP_NO                  = MN.PROP_NO
    AND PTY.AMDT_SEQ                  = MN.AMDT_SEQ
    AND PTY.PRC_CTRT_PTY_TP_CD        = 'C'
#if( ${ctrt_no} != '')
		   AND HDR.SC_NO = @[ctrt_no]
#end
#if ( ${ctrt_cust} != '' )
   and  CASE WHEN REAL_CUST_CNT_CD||TRIM(TO_CHAR(REAL_CUST_SEQ,'000000')) IS NULL 
                                THEN PTY.CUST_CNT_CD
                           ELSE REAL_CUST_CNT_CD END     =   SUBSTR(@[ctrt_cust], 1, 2)
   and  CASE WHEN REAL_CUST_CNT_CD||TRIM(TO_CHAR(REAL_CUST_SEQ,'000000')) IS NULL 
                                THEN PTY.CUST_SEQ
                           ELSE REAL_CUST_SEQ END        =   SUBSTR(@[ctrt_cust], 3, 6)
#end  

#end
#if ( ${ctrt_tp} == 'RFA' )
             SELECT /*+ LEADING(A) USE_NL(HDR,MN) */
                    A.*, NVL(MN.RESPB_SLS_OFC_CD, MN.PROP_OFC_CD) PRI_OFC_CD
                    , NVL(MN.RESPB_SREP_CD, MN.PROP_SREP_CD) PRI_SREP_CD
                    , MN.CTRT_CUST_CNT_CD, MN.CTRT_CUST_SEQ
               FROM MN_DATA A,
                    PRI_RP_HDR HDR, 
                    PRI_RP_MN MN
    WHERE 1=1
                AND A.RFA_NO IS NOT NULL
                AND A.RFA_NO = HDR.RFA_NO
#if ( ${ctof} != '' )
   	AND NVL(MN.RESPB_SLS_OFC_CD, MN.PROP_OFC_CD) IN (
			#foreach( $ctrt_ofc_cd in ${tempCTOFList}) #if($velocityCount < $tempCTOFList.size()) '$ctrt_ofc_cd', #else '$ctrt_ofc_cd' #end #end
		)
#end

   	AND NVL(MN.RESPB_SREP_CD, MN.PROP_SREP_CD) = @[ctrt_srep_cd]

    AND HDR.PROP_NO = MN.PROP_NO
    AND MN.PROP_STS_CD  = 'A' 
    AND MN.AMDT_SEQ = (SELECT /*+ NO_UNNEST */
                              MAX(AMDT_SEQ)
                       FROM PRI_RP_MN 
                       WHERE 1=1
                         AND PROP_NO = MN.PROP_NO
                         AND PROP_STS_CD = MN.PROP_STS_CD 
                       )

#if( ${ctrt_no} != '')
		   AND HDR.RFA_NO = @[ctrt_no]
#end
#if ( ${ctrt_cust} != '' )
   and  MN.CTRT_CUST_CNT_CD     =   SUBSTR(@[ctrt_cust], 1, 2)
   and  MN.CTRT_CUST_SEQ        =   SUBSTR(@[ctrt_cust], 3, 6)
#end  
    
#end
#if ( ${ctrt_tp} == 'TAA' )
             SELECT /*+ LEADING(A) USE_NL(MN)  */
                    A.*, MN.RESPB_SLS_OFC_CD PRI_OFC_CD
                    , MN.RESPB_SREP_CD PRI_SREP_CD
                    , MN.CTRT_CUST_CNT_CD, MN.CTRT_CUST_SEQ
               FROM MN_DATA A,
                    PRI_TAA_HDR HDR, 
                    PRI_TAA_MN MN
    WHERE 1=1
                AND A.TAA_NO IS NOT NULL
                AND A.TAA_NO = HDR.TAA_NO
#if ( ${ctof} != '' )
   	AND MN.RESPB_SLS_OFC_CD IN (
			#foreach( $ctrt_ofc_cd in ${tempCTOFList}) #if($velocityCount < $tempCTOFList.size()) '$ctrt_ofc_cd', #else '$ctrt_ofc_cd' #end #end
		)
#end

   	AND MN.RESPB_SREP_CD = @[ctrt_srep_cd]

    AND HDR.TAA_PROP_NO = MN.TAA_PROP_NO
    AND MN.CFM_FLG  = 'Y' 
    AND MN.AMDT_SEQ = (SELECT /*+ NO_UNNEST */ MAX(AMDT_SEQ)
                       FROM PRI_TAA_MN 
                       WHERE 1=1
                         AND TAA_PROP_NO = MN.TAA_PROP_NO
                         AND CFM_FLG = MN.CFM_FLG 
                       )
#if( ${ctrt_no} != '')
		   AND HDR.TAA_NO = @[ctrt_no]
#end
#if ( ${ctrt_cust} != '' )
   and  MN.CTRT_CUST_CNT_CD     =   SUBSTR(@[ctrt_cust], 1, 2)
   and  MN.CTRT_CUST_SEQ        =   SUBSTR(@[ctrt_cust], 3, 6)
#end  
    
#end
)
)

SELECT  N.*
       ,(
			SELECT  CASE 
						WHEN A3.CNT_CD = 'IN' AND A1.CRE_DT >= TO_DATE(A4.ATTR_CTNT1, 'YYYYMMDDHH24MI') 
							THEN SUBSTR(A1.DMDT_INV_NO, 4, 1)
						ELSE
							SUBSTR(A1.DMDT_INV_NO, 3, 1)
					END
					
			  FROM  DMT_INV_MN			A1
			       ,MDM_ORGANIZATION  	A2
				   ,MDM_LOCATION      	A3
				   ,DMT_HRD_CDG_CTNT	A4
				   
			 WHERE  A1.DMDT_INV_NO = N.INVNOO
			   AND  A1.CRE_OFC_CD  = A2.OFC_CD
			   AND  A2.LOC_CD      = A3.LOC_CD
			   AND  A4.HRD_CDG_ID = 'IDA_TAX_APPL_DT'
	    ) AS DMDT_INV_TP_CD
		
  FROM  (
			SELECT  T.*
				   ,COL_CHARGE1 AS COL_CHARGE
				   ,COL_TAX1 AS COL_TAX
				   ,NVL(INVAMT,0) - (NVL(COL_CHARGE1,0)+NVL(COL_TAX1,0))  AS UNCOL_AMT
				   
			  FROM  ( 
						SELECT  INVNOO
							   ,VVDCDD
							   ,BKGNOO
							   ,BLNOOO
							   ,CURRCY
							   ,BILAMT
							   ,TAXAMT
							   ,INVAMT
							   ,TARFTP
							   ,ISSEDT
							   ,ISSEOF
							   ,INVOVD
							   ,SHEETP
							   ,POR_CD
							   ,POL_CD
							   ,POD_CD
							   ,DEL_CD
							   ,OB_SREP_CD
							   ,RFA_NO
							   ,SC_NO
							   ,TAA_NO
							   ,SH_CUST_CD
							   ,SH_CUST_NM
							   ,CN_CUST_CD
							   ,CN_CUST_NM
							   ,INV_RMK
							   ,sum(ORG_CHG_AMT) 			as ORG_CHG_AMT
							   ,sum(NVL(CMDT_EXPT_AMT,0)) 	as CMDT_EXPT_AMT
							   ,sum(SC_RFA_EXPT_AMT) 		as SC_RFA_EXPT_AMT
							   ,sum(AFT_EXPT_DC_AMT) 		as AFT_EXPT_DC_AMT
							   ,max(DMDT_VT_INV_YN)			as DMDT_VT_INV_YN
							   ,max(DMDT_VT_INV_NO)			as DMDT_VT_INV_NO
							   ,max(DMDT_VT_INV_STS_CD)		as DMDT_VT_INV_STS_CD
							   ,max(COL_CHARGE) AS COL_CHARGE1
							   ,max(COL_TAX) AS COL_TAX1
							   ,TO_CHAR(MAX(COL_DATE), 'YYYY-MM-DD') AS COL_DATE
							   ,MAX(OTS_CLT_FLG) AS OTS_CLT_FLG
							   ,MAX(V_COLLECTED) AS V_COLLECTED
							   
						  FROM  (
									SELECT  M.DMDT_INV_NO											as INVNOO        /*  INVOICE NO                  */
										   ,M.VSL_CD||M.SKD_VOY_NO||M.SKD_DIR_CD                    as VVDCDD        /*  VVD                         */
										   ,M.BKG_NO                                                as BKGNOO        /*  BKG NO                      */
										   ,M.BL_NO                                                 as BLNOOO        /*  BL NO                       */
										   ,M.INV_CURR_CD                                           as CURRCY        /*  INVOICE CURRENCY            */
										   ,case when M.DMDT_INV_STS_CD = 'X' and M.DMDT_VT_INV_STS_CD = 'C' 
										  		 then
										  				 (
										  					 select  sum(T3.BIL_AMT)
										  					 from  DMT_INV_MN   	T1
										  						 ,DMT_INV_DTL  	T2
										  						 ,DMT_CHG_CALC	T3
										  					 where  T1.DMDT_INV_NO			= M.DMDT_INV_NO
										  					 and  T1.CRE_OFC_CD  			= M.CRE_OFC_CD
										  					 and  T1.DMDT_INV_NO 			= T2.DMDT_INV_NO
										  					 and  T1.CRE_OFC_CD  			= T2.CRE_OFC_CD
										  					 and  T2.SYS_AREA_GRP_ID 		= T3.SYS_AREA_GRP_ID
										  					 and  T2.CNTR_NO 				= T3.CNTR_NO
										  					 and  T2.CNTR_CYC_NO 			= T3.CNTR_CYC_NO
										  					 and  T2.DMDT_TRF_CD 			= T3.DMDT_TRF_CD
										  					 and  T2.DMDT_CHG_LOC_DIV_CD 	= T3.DMDT_CHG_LOC_DIV_CD 
										  					 and  T2.CHG_SEQ				= T3.CHG_SEQ
										  				 )
										  		 else
										  				 M.INV_CHG_AMT
										  	end														as BILAMT		/*  INVOICE BILLING AMOUNT      */
										   ,case when M.DMDT_INV_STS_CD = 'X' and M.DMDT_VT_INV_STS_CD = 'C' 
										  		 then
										  				 case when NVL(M.TAX_RTO, 0) = 0 
										  					 then 0
										  					 else 
										  							 (
										  								 select  sum(T3.BIL_AMT/M.TAX_RTO)
										  								 from  DMT_INV_MN   	T1
										  									 ,DMT_INV_DTL  	T2
										  									 ,DMT_CHG_CALC	T3
										  								 where  T1.DMDT_INV_NO			= M.DMDT_INV_NO
										  								 and  T1.CRE_OFC_CD  			= M.CRE_OFC_CD
										  								 and  T1.DMDT_INV_NO 			= T2.DMDT_INV_NO
										  								 and  T1.CRE_OFC_CD  			= T2.CRE_OFC_CD
										  								 and  T2.SYS_AREA_GRP_ID 		= T3.SYS_AREA_GRP_ID
										  								 and  T2.CNTR_NO 				= T3.CNTR_NO
										  								 and  T2.CNTR_CYC_NO 			= T3.CNTR_CYC_NO
										  								 and  T2.DMDT_TRF_CD 			= T3.DMDT_TRF_CD
										  								 and  T2.DMDT_CHG_LOC_DIV_CD 	= T3.DMDT_CHG_LOC_DIV_CD 
										  								 and  T2.CHG_SEQ				= T3.CHG_SEQ
										  							 )
										  				 end
										  		 else
										  				 M.TAX_AMT
										  	end														as TAXAMT   	/*  INVOICE TAX AMOUNT          */
										   ,case when M.DMDT_INV_STS_CD = 'X' and M.DMDT_VT_INV_STS_CD = 'C' 
										  		 then
										  				 case when NVL(M.TAX_RTO, 0) = 0 
										  					 then  
										  							 (
										  								 select  sum(T3.BIL_AMT)
										  								 from  DMT_INV_MN   	T1
										  									 ,DMT_INV_DTL  	T2
										  									 ,DMT_CHG_CALC	T3
										  								 where  T1.DMDT_INV_NO			= M.DMDT_INV_NO
										  								 and  T1.CRE_OFC_CD  			= M.CRE_OFC_CD
										  								 and  T1.DMDT_INV_NO 			= T2.DMDT_INV_NO
										  								 and  T1.CRE_OFC_CD  			= T2.CRE_OFC_CD
										  								 and  T2.SYS_AREA_GRP_ID 		= T3.SYS_AREA_GRP_ID
										  								 and  T2.CNTR_NO 				= T3.CNTR_NO
										  								 and  T2.CNTR_CYC_NO 			= T3.CNTR_CYC_NO
										  								 and  T2.DMDT_TRF_CD 			= T3.DMDT_TRF_CD
										  								 and  T2.DMDT_CHG_LOC_DIV_CD 	= T3.DMDT_CHG_LOC_DIV_CD 
										  								 and  T2.CHG_SEQ				= T3.CHG_SEQ
										  							 )									 
										  					 else
										  							 (
										  								 select  sum(T3.BIL_AMT + T3.BIL_AMT/M.TAX_RTO)
										  								 from  DMT_INV_MN   	T1
										  									 ,DMT_INV_DTL  	T2
										  									 ,DMT_CHG_CALC	T3
										  								 where  T1.DMDT_INV_NO			= M.DMDT_INV_NO
										  								 and  T1.CRE_OFC_CD  			= M.CRE_OFC_CD
										  								 and  T1.DMDT_INV_NO 			= T2.DMDT_INV_NO
										  								 and  T1.CRE_OFC_CD  			= T2.CRE_OFC_CD
										  								 and  T2.SYS_AREA_GRP_ID 		= T3.SYS_AREA_GRP_ID
										  								 and  T2.CNTR_NO 				= T3.CNTR_NO
										  								 and  T2.CNTR_CYC_NO 			= T3.CNTR_CYC_NO
										  								 and  T2.DMDT_TRF_CD 			= T3.DMDT_TRF_CD
										  								 and  T2.DMDT_CHG_LOC_DIV_CD 	= T3.DMDT_CHG_LOC_DIV_CD 
										  								 and  T2.CHG_SEQ				= T3.CHG_SEQ
										  							 )									 
										  				 end
										  		 else
										  				 M.INV_AMT
										  	end														as INVAMT		 /*  INVOICE AMOUNT              */
										   ,M.DMDT_TRF_CD                                           as TARFTP        /*  TARIFF TYPE                 */
										   ,case when M.DMDT_INV_STS_CD = 'X' and M.DMDT_VT_INV_STS_CD = 'C' 
										  		 then ''
										  		 else to_char(M.CRE_DT,'YYYY-MM-DD')
										    end														as ISSEDT        /*  INVOICE ISSUE DATE          */
										   ,M.CRE_OFC_CD											as ISSEOF        /*  INVOICE ISSUE OFFICE        */
										   ,case when M.DMDT_INV_STS_CD = 'X' and M.DMDT_VT_INV_STS_CD = 'C' 
										  		 then 0
										  		 else TO_DATE(to_char(sysdate ,'YYYYMMDD'),'YYYYMMDD') - TO_DATE(to_char(M.CRE_DT,'YYYYMMDD'),'YYYYMMDD')
										    end														as INVOVD        /*  INVOICE OVER DAY = sysdate - ISSUE DATE #ADD 2007.12.03 */
										   ,'O' SHEETP
										   ,M.POR_CD
										   ,M.POL_CD
										   ,M.POD_CD
										   ,M.DEL_CD
										   ,M.OB_SREP_CD
										   ,case when M.DMDT_INV_STS_CD = 'X' and M.DMDT_VT_INV_STS_CD = 'C' 
										  		 then
										  				 (
										  					 select  sum(T3.ORG_CHG_AMT)
										  					 from  DMT_INV_MN   	T1
										  						 ,DMT_INV_DTL  	T2
										  						 ,DMT_CHG_CALC	T3
										  					 where  T1.DMDT_INV_NO			= M.DMDT_INV_NO
										  					 and  T1.CRE_OFC_CD  			= M.CRE_OFC_CD
										  					 and  T1.DMDT_INV_NO 			= T2.DMDT_INV_NO
										  					 and  T1.CRE_OFC_CD  			= T2.CRE_OFC_CD
										  					 and  T2.SYS_AREA_GRP_ID 		= T3.SYS_AREA_GRP_ID
										  					 and  T2.CNTR_NO 				= T3.CNTR_NO
										  					 and  T2.CNTR_CYC_NO 			= T3.CNTR_CYC_NO
										  					 and  T2.DMDT_TRF_CD 			= T3.DMDT_TRF_CD
										  					 and  T2.DMDT_CHG_LOC_DIV_CD 	= T3.DMDT_CHG_LOC_DIV_CD 
										  					 and  T2.CHG_SEQ				= T3.CHG_SEQ
										  				 )
										  		 else
										  				 M.ORG_CHG_AMT
										  	end														as ORG_CHG_AMT
										   ,M.RFA_NO
										   ,M.SC_NO
										   ,M.TAA_NO
										   ,S_CUST_CNT_CD||S_CUST_SEQ 								as SH_CUST_CD
										   ,S_CUST_NM 												as SH_CUST_NM
										   ,C_CUST_CNT_CD||C_CUST_SEQ 								as CN_CUST_CD
										   ,C_CUST_NM 												as CN_CUST_NM
										   ,case when M.DMDT_INV_STS_CD = 'X' and M.DMDT_VT_INV_STS_CD = 'C' 
										  		 then
										  				 (
										  					 select  sum(T3.CMDT_EXPT_AMT)
										  					 from  DMT_INV_MN   	T1
										  						 ,DMT_INV_DTL  	T2
										  						 ,DMT_CHG_CALC	T3
										  					 where  T1.DMDT_INV_NO			= M.DMDT_INV_NO
										  					 and  T1.CRE_OFC_CD  			= M.CRE_OFC_CD
										  					 and  T1.DMDT_INV_NO 			= T2.DMDT_INV_NO
										  					 and  T1.CRE_OFC_CD  			= T2.CRE_OFC_CD
										  					 and  T2.SYS_AREA_GRP_ID 		= T3.SYS_AREA_GRP_ID
										  					 and  T2.CNTR_NO 				= T3.CNTR_NO
										  					 and  T2.CNTR_CYC_NO 			= T3.CNTR_CYC_NO
										  					 and  T2.DMDT_TRF_CD 			= T3.DMDT_TRF_CD
										  					 and  T2.DMDT_CHG_LOC_DIV_CD 	= T3.DMDT_CHG_LOC_DIV_CD 
										  					 and  T2.CHG_SEQ				= T3.CHG_SEQ
										  				 )
										  		 else
										  				 M.CMDT_EXPT_AMT
										  	end														as CMDT_EXPT_AMT
										   ,case when M.DMDT_INV_STS_CD = 'X' and M.DMDT_VT_INV_STS_CD = 'C' 
										  		 then
										  				 (
										  					 select  sum(T3.SC_RFA_EXPT_AMT)
										  					 from  DMT_INV_MN   	T1
										  						 ,DMT_INV_DTL  	T2
										  						 ,DMT_CHG_CALC	T3
										  					 where  T1.DMDT_INV_NO			= M.DMDT_INV_NO
										  					 and  T1.CRE_OFC_CD  			= M.CRE_OFC_CD
										  					 and  T1.DMDT_INV_NO 			= T2.DMDT_INV_NO
										  					 and  T1.CRE_OFC_CD  			= T2.CRE_OFC_CD
										  					 and  T2.SYS_AREA_GRP_ID 		= T3.SYS_AREA_GRP_ID
										  					 and  T2.CNTR_NO 				= T3.CNTR_NO
										  					 and  T2.CNTR_CYC_NO 			= T3.CNTR_CYC_NO
										  					 and  T2.DMDT_TRF_CD 			= T3.DMDT_TRF_CD
										  					 and  T2.DMDT_CHG_LOC_DIV_CD 	= T3.DMDT_CHG_LOC_DIV_CD 
										  					 and  T2.CHG_SEQ				= T3.CHG_SEQ
										  				 )
										  		 else
										  				 M.SC_RFA_EXPT_AMT
										  	end														as SC_RFA_EXPT_AMT
										   ,case when M.DMDT_INV_STS_CD = 'X' and M.DMDT_VT_INV_STS_CD = 'C' 
										  		 then
										  				 (
										  					 select  sum(T3.AFT_EXPT_DC_AMT)
										  					 from  DMT_INV_MN   	T1
										  						 ,DMT_INV_DTL  	T2
										  						 ,DMT_CHG_CALC	T3
										  					 where  T1.DMDT_INV_NO			= M.DMDT_INV_NO
										  					 and  T1.CRE_OFC_CD  			= M.CRE_OFC_CD
										  					 and  T1.DMDT_INV_NO 			= T2.DMDT_INV_NO
										  					 and  T1.CRE_OFC_CD  			= T2.CRE_OFC_CD
										  					 and  T2.SYS_AREA_GRP_ID 		= T3.SYS_AREA_GRP_ID
										  					 and  T2.CNTR_NO 				= T3.CNTR_NO
										  					 and  T2.CNTR_CYC_NO 			= T3.CNTR_CYC_NO
										  					 and  T2.DMDT_TRF_CD 			= T3.DMDT_TRF_CD
										  					 and  T2.DMDT_CHG_LOC_DIV_CD 	= T3.DMDT_CHG_LOC_DIV_CD 
										  					 and  T2.CHG_SEQ				= T3.CHG_SEQ
										  				 )
										  		 else
										  				 M.AFT_EXPT_DC_AMT
										  	end														as AFT_EXPT_DC_AMT
										   ,case when M.DMDT_INV_STS_CD = 'X' and M.DMDT_VT_INV_STS_CD = 'C' 
										  		 then M.CXL_RMK
										  		 else M.INV_RMK
										    end														as INV_RMK
										   ,case when M.DMDT_INV_STS_CD = 'X' and M.DMDT_VT_INV_STS_CD = 'C' 
										  		 then 'Y'
										  		 else 'N'
										    end														as DMDT_VT_INV_YN
										   ,case when M.DMDT_INV_STS_CD = 'X' and M.DMDT_VT_INV_STS_CD = 'C' 
										  		 then M.DMDT_INV_NO
										  		 else ''
										    end														as DMDT_VT_INV_NO								
										   ,M.DMDT_VT_INV_STS_CD									as DMDT_VT_INV_STS_CD
										   ,CASE WHEN (V_COLLECTED = 'Y')
										  	 THEN  INV_CHG_AMT
										  	 ELSE  B.COL_CHARGE 
										  	END COL_CHARGE
										   ,CASE WHEN (V_COLLECTED = 'Y')
										  	 THEN  TAX_AMT
										  	 ELSE  B.COL_TAX 
										  	END COL_TAX
										   ,B.COL_DATE
										   ,OTS_CLT_FLG
										   ,V_COLLECTED
										   
									  FROM  PRI_INFO M
										  ,(
												SELECT  A.DMDT_INV_NO 
                                                       ,SUM(DECODE(DMDT_INV_PAY_TP_CD,'M',INV_PAY_AMT*DECODE(A.INV_CURR_CD,B.INV_CURR_CD,1,INV_XCH_RT),0)) AS COL_CHARGE
                                                       ,SUM(DECODE(DMDT_INV_PAY_TP_CD,'V',INV_PAY_AMT*DECODE(A.INV_CURR_CD,B.INV_CURR_CD,1,INV_XCH_RT),0)) AS COL_TAX
                                                       ,MAX(INV_PAY_DT)  		AS COL_DATE
                                                       ,MAX(INV_PAY_COFF_DT) 	AS COL_DUE_DT
												  FROM  DMT_INV_OTS_PAY_RCV A
												       ,(SELECT DISTINCT DMDT_INV_NO, INV_XCH_RT, INV_CURR_CD FROM MN_DATA)B
												 WHERE  B.DMDT_INV_NO = A.DMDT_INV_NO(+)
												GROUP BY A.DMDT_INV_NO
											) B      
									 WHERE  M.DMDT_INV_NO = B.DMDT_INV_NO(+)
								)
						group by INVNOO,VVDCDD,BKGNOO,BLNOOO,CURRCY,BILAMT,TAXAMT,INVAMT,TARFTP,ISSEDT,ISSEOF,INVOVD,SHEETP,POR_CD,POL_CD,POD_CD,DEL_CD,OB_SREP_CD,RFA_NO,SC_NO,TAA_NO,SH_CUST_CD,SH_CUST_NM,CN_CUST_CD,CN_CUST_NM,INV_RMK
						order by INVNOO
					) T
		) N
 WHERE  1 = 1
	#if (${coll} != 'All')
		#if (${coll} == 'N')
   AND  N.UNCOL_AMT != 0
        #end 
		#if (${coll} == 'Y')
   AND  N.UNCOL_AMT = 0
        #end
	#end			]]></sql>
			<params>
				<param name="frdt" type="12" value="" out="N"/>
				<param name="todt" type="12" value="" out="N"/>
				<param name="payc" type="12" value="" out="N"/>
				<param name="inpayr" type="12" value="" out="N"/>
				<param name="grop_cust" type="12" value="" out="N"/>
				<param name="ctrt_no" type="12" value="" out="N"/>
				<param name="cuno" type="12" value="" out="N"/>
				<param name="cutp" type="12" value="" out="N"/>
				<param name="invocr" type="12" value="" out="N"/>
				<param name="ctrt_srep_cd" type="12" value="" out="N"/>
				<param name="ctrt_cust" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
