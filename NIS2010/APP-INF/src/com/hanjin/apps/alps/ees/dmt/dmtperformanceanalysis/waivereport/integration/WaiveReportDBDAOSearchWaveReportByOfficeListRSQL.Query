<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="WaiveReportDBDAOSearchWaveReportByOfficeListRSQL">
			<desc><![CDATA[WAIVE REPORT
EES_DMT_6009
Waive Report by Office]]></desc>
			<sql><![CDATA[
WITH AFT_BKG# AS (
    SELECT DB.SC_NO, DB.RFA_NO,
           CASE
               WHEN DB.SC_NO IS NOT NULL AND DB.RFA_NO IS NULL THEN 'S'
               ELSE 'R'
           END CTRT_TP,
           AFT_EXP.PROG_OFC_CD, AFT_EXP.AFT_EXPT_DAR_NO,
           DB.SYS_AREA_GRP_ID, DB.CNTR_NO, DB.CNTR_CYC_NO, AFT_EXP.DMDT_TRF_CD
      FROM (
--  AND :reqapp ='R'                 --------- 해당부분을 UNION ALL로 분기하여야 합니다. 해당부분로직검토 필요
--  AND :ofc_flg2='O'            
        SELECT /*+ LEADING(AM)   USE_NL(AM AD) */
			DISTINCT	AM.AFT_EXPT_DAR_NO,
						AM.RQST_OFC_CD PROG_OFC_CD,
						AD.BKG_NO,
						AD.DMDT_TRF_CD
        FROM DMT_AFT_BKG_ADJ_RQST AM,
          DMT_AFT_BKG_ADJ_RQST_DTL AD
        WHERE 1 = 1
#if ( ${ofc_cd2} != '' )
          AND AM.RQST_OFC_CD IN (
                                    #foreach( $waive_off_cd_p in ${tempWaiveOFFList}) 
                                        #if($velocityCount < $tempWaiveOFFList.size()) 
                                           '$waive_off_cd_p', 
                                        #else 
                                           '$waive_off_cd_p' 
                                        #end 
                                    #end
                                )
          AND @[reqapp] = 'R'
          AND @[ofc_flg2] = 'O'
#end
          AND AM.AFT_EXPT_DAR_NO = AD.AFT_EXPT_DAR_NO
          AND AM.DMDT_EXPT_RQST_STS_CD = 'A'
        UNION ALL
--  AND :reqapp ='R'
--  AND :ofc_flg2='R'    
        SELECT /*+ INDEX( AM XAK2DMT_AFT_BKG_ADJ_RQST) USE_NL(AM AD)*/
        	DISTINCT  AM.AFT_EXPT_DAR_NO,
			          AM.RQST_OFC_CD PROG_OFC_CD,
			          AD.BKG_NO,
			          AD.DMDT_TRF_CD
        FROM DMT_AFT_BKG_ADJ_RQST AM,
          DMT_AFT_BKG_ADJ_RQST_DTL AD
        WHERE 1 = 1
#if ( ${ofc_cd2} != '' )
          AND @[reqapp] = 'R'
          AND @[ofc_flg2] = 'R'
          AND @[ofc_cd2] <> 'All'
          AND AM.RQST_OFC_CD IN (
            SELECT OFC_CD
            FROM MDM_ORGANIZATION START WITH OFC_CD IN (
                                                            #foreach( $waive_off_cd_p in ${tempWaiveOFFList}) 
                                                                #if($velocityCount < $tempWaiveOFFList.size()) 
                                                                   '$waive_off_cd_p', 
                                                                #else 
                                                                   '$waive_off_cd_p' 
                                                                #end 
                                                            #end
                                                       ) CONNECT BY NOCYCLE PRIOR OFC_CD = PRNT_OFC_CD)
#end
          AND AM.AFT_EXPT_DAR_NO = AD.AFT_EXPT_DAR_NO
          AND AM.DMDT_EXPT_RQST_STS_CD = 'A'
        UNION ALL
--  AND :reqapp ='A'
--  AND :ofc_flg2='O'    
        SELECT /*+ LEADING(AM)   USE_NL(AM AD) opt_param('_OPTIMIZER_SKIP_SCAN_ENABLED','FALSE') */
        	DISTINCT  AM.AFT_EXPT_DAR_NO,
			          AM.APRO_OFC_CD PROG_OFC_CD,
			          AD.BKG_NO,
			          AD.DMDT_TRF_CD
        FROM DMT_AFT_BKG_ADJ_RQST AM,
          DMT_AFT_BKG_ADJ_RQST_DTL AD
        WHERE 1 = 1
#if ( ${ofc_cd2} != '' )
          AND AM.APRO_OFC_CD IN (
                                    #foreach( $waive_off_cd_p in ${tempWaiveOFFList}) 
                                        #if($velocityCount < $tempWaiveOFFList.size()) 
                                           '$waive_off_cd_p', 
                                        #else 
                                           '$waive_off_cd_p' 
                                        #end 
                                    #end
                                )
          AND @[reqapp] = 'A'
          AND @[ofc_flg2] = 'O'
#end
          AND AM.AFT_EXPT_DAR_NO = AD.AFT_EXPT_DAR_NO
          AND AM.DMDT_EXPT_RQST_STS_CD = 'A'
        UNION ALL
--  AND :reqapp ='A'
--  AND :ofc_flg2='R'    
        SELECT /*+ INDEX( AM XAK2DMT_AFT_BKG_ADJ_RQST) USE_NL(AM AD)*/
        	DISTINCT  AM.AFT_EXPT_DAR_NO,
			          AM.APRO_OFC_CD PROG_OFC_CD,
			          AD.BKG_NO,
			          AD.DMDT_TRF_CD
        FROM DMT_AFT_BKG_ADJ_RQST AM,
          DMT_AFT_BKG_ADJ_RQST_DTL AD
        WHERE 1 = 1
#if ( ${ofc_cd2} != '' )
          AND @[reqapp] = 'A'
          AND @[ofc_flg2] = 'R'
          AND @[ofc_cd2] <> 'All'
          AND AM.APRO_OFC_CD IN (
            SELECT OFC_CD
            FROM MDM_ORGANIZATION START WITH OFC_CD IN (
                                                            #foreach( $waive_off_cd_p in ${tempWaiveOFFList}) 
                                                                #if($velocityCount < $tempWaiveOFFList.size()) 
                                                                   '$waive_off_cd_p', 
                                                                #else 
                                                                   '$waive_off_cd_p' 
                                                                #end 
                                                            #end
                                                       ) CONNECT BY NOCYCLE PRIOR OFC_CD = PRNT_OFC_CD)
#end
          AND AM.AFT_EXPT_DAR_NO = AD.AFT_EXPT_DAR_NO
          AND AM.DMDT_EXPT_RQST_STS_CD = 'A') AFT_EXP  , DMT_CHG_BKG_CNTR DB
    WHERE DB.BKG_NO        = AFT_EXP.BKG_NO
)











SELECT  DECODE(@[grp_flg], 'O', X.PROG_OFC_CD, 'R', OV.OFC_N3RD_LVL_CD) AS OFFICE,
        X.DMDT_TRF_CD AS TARIFF,
        X.SC_NO AS SCNO,
        X.RFA_NO AS RFANO,
        X.CUST_CNT_CD||LPAD(X.CUST_SEQ,6,'0') AS CUSCODE,
        (   SELECT  CUST_LGL_ENG_NM
              FROM  MDM_CUSTOMER
             WHERE  CUST_CNT_CD     = X.CUST_CNT_CD
               AND  CUST_SEQ        = X.CUST_SEQ
        )   AS CUSNAME,
        DECODE( @[curr_flg], 'U', 'USD', X.BZC_TRF_CURR_CD) AS CUR,
		X.BZC_TRF_CURR_CD AS LOCALCUR,
		NVL ( COUNT ( DISTINCT DECODE ( SIGN(X.ORG_CHG_AMT), 1, X.CNTR_NO)) , 0 ) AS CNTR1,
        NVL ( ROUND ( SUM ( DECODE( @[curr_flg], 'U', X.ORG_CHG_AMT  / F.USD_LOCL_XCH_RT, X.ORG_CHG_AMT  ) ), 2 ) , 0 ) AS AMT1,
        NVL ( COUNT ( DISTINCT DECODE ( SIGN(X.CMDT_EXPT_AMT), 1, X.CNTR_NO)) , 0 )  AS CNTR2,
        NVL ( ROUND ( SUM ( DECODE( @[curr_flg], 'U', NVL(X.CMDT_EXPT_AMT, 0) / F.USD_LOCL_XCH_RT, NVL(X.CMDT_EXPT_AMT, 0) ) ), 2 ) , 0 ) AS AMT2,
        NVL ( COUNT ( DISTINCT DECODE ( SIGN(X.SC_RFA_EXPT_AMT), 1, X.CNTR_NO)) , 0 )  AS CNTR3,
        NVL ( ROUND ( SUM ( DECODE( @[curr_flg], 'U', X.SC_RFA_EXPT_AMT / F.USD_LOCL_XCH_RT, X.SC_RFA_EXPT_AMT) ), 2 ) , 0 ) AS AMT3,
        NVL ( COUNT ( DISTINCT DECODE ( SIGN(X.AFT_EXPT_DC_AMT), 1, X.CNTR_NO)) , 0 )   AS CNTR4,
        NVL ( ROUND ( SUM ( DECODE( @[curr_flg], 'U', X.AFT_EXPT_DC_AMT  / F.USD_LOCL_XCH_RT, X.AFT_EXPT_DC_AMT  ) ), 2 ) , 0 ) AS AMT4,
        NVL ( COUNT ( DISTINCT DECODE ( SIGN(X.SC_RFA_EXPT_AMT), 1, X.CNTR_NO, DECODE( SIGN(X.AFT_EXPT_DC_AMT), 1, X.CNTR_NO))) , 0 ) AS CNTR5,
        NVL(ROUND ( SUM ( DECODE( @[curr_flg], 'U', X.SC_RFA_EXPT_AMT / F.USD_LOCL_XCH_RT, X.SC_RFA_EXPT_AMT) ), 2 ), 0)
        + NVL(ROUND ( SUM ( DECODE( @[curr_flg], 'U', X.AFT_EXPT_DC_AMT  / F.USD_LOCL_XCH_RT, X.AFT_EXPT_DC_AMT  ) ), 2 ), 0) AS AMT5
FROM    (
        SELECT  /*+ USE_NL(SC CUST DC ) LEADING(SC) */
                SC.SC_NO,
                '' RFA_NO,
                SC.PROP_NO,
                CUST.CUST_CNT_CD    CUST_CNT_CD,
                CUST.CUST_SEQ       CUST_SEQ,
                SC.PROG_OFC_CD    PROG_OFC_CD,
                DC.SYS_AREA_GRP_ID, DC.CNTR_NO, DC.CNTR_CYC_NO, DC.DMDT_TRF_CD,
                DC.BZC_TRF_CURR_CD, DC.ORG_CHG_AMT, DC.CMDT_EXPT_AMT, DC.SC_RFA_EXPT_AMT, 
                CASE WHEN DC.AFT_EXPT_DC_AMT > 0 THEN   (
                                                            SELECT	DC.AFT_EXPT_DC_AMT
                                                            FROM	DMT_AFT_BKG_ADJ_RQST AM
                                                            WHERE
                                                                    DECODE(@[reqapp], 'R', AM.RQST_OFC_CD, AM.APRO_OFC_CD) = SC.PROG_OFC_CD
                                                            AND     AM.AFT_EXPT_DAR_NO = DC.AFT_EXPT_DAR_NO 
                                                        )
                     WHEN DC.AFT_EXPT_DC_AMT = 0 THEN 0
                END AS AFT_EXPT_DC_AMT
                	, DC.TO_MVMT_DT
          FROM  DMT_CHG_CALC	DC,
                (
                SELECT	/*+ USE_NL(SC SCH SC_EXP)*/ 
                		PROP_NO, AMDT_SEQ, SC_NO, PROG_OFC_CD
                  FROM (
                        SELECT	/*+ USE_NL(SC SCH SC_EXP)*/
                        		SCH.PROP_NO, SC.AMDT_SEQ, SCH.SC_NO, SC_EXP.PROG_OFC_CD  PROG_OFC_CD,
                               	DENSE_RANK() OVER(PARTITION BY SCH.SC_NO ORDER BY SC.AMDT_SEQ DESC) AMDT_SEQ_FILTER
                          FROM (
                                SELECT DISTINCT PROP_NO, PROG_OFC_CD
                                  FROM DMT_SC_EXPT_VER_PROG
                                 WHERE 1=1
#if ( ${ofc_cd2} != '' )
                                   AND (
                                        (
                                            @[ofc_flg2]   =   'O'
                                            AND
                                            PROG_OFC_CD IN (
                                                #foreach( $waive_off_cd_p in ${tempWaiveOFFList}) 
                                                    #if($velocityCount < $tempWaiveOFFList.size()) 
                                                       '$waive_off_cd_p', 
                                                    #else 
                                                       '$waive_off_cd_p' 
                                                    #end 
                                                #end
                                            )
                                        )
                                   OR   (
                                            @[ofc_flg2]   =   'R'
                                            AND
                                            @[ofc_cd2] <> 'All'
                                            AND
                                            PROG_OFC_CD   IN  (
                                                                SELECT OFC_CD
                                                                FROM   MDM_ORGANIZATION
                                                                START WITH OFC_CD IN (
                                                                    #foreach( $waive_off_cd_p in ${tempWaiveOFFList}) 
                                                                        #if($velocityCount < $tempWaiveOFFList.size()) 
                                                                           '$waive_off_cd_p', 
                                                                        #else 
                                                                           '$waive_off_cd_p' 
                                                                        #end 
                                                                    #end
                                                                )
                                                                CONNECT BY NOCYCLE PRIOR OFC_CD = PRNT_OFC_CD
                                                            )
                                        )
                                       )
#end
                                   AND DMDT_EXPT_VER_STS_CD = DECODE(@[reqapp], 'R', 'R', 'A', 'L')
                               ) SC_EXP, PRI_SP_HDR SCH, PRI_SP_MN SC
                         WHERE SC_EXP.PROP_NO = SCH.PROP_NO
                           AND SCH.PROP_NO    = SC.PROP_NO
                       )
                 WHERE AMDT_SEQ_FILTER = 1
               ) SC, PRI_SP_CTRT_PTY CUST
         WHERE SC.PROP_NO  = CUST.PROP_NO
           AND SC.AMDT_SEQ = CUST.AMDT_SEQ
           AND CUST.PRC_CTRT_PTY_TP_CD = 'C'
           AND DC.SC_NO = SC.SC_NO
           AND DC.TO_MVMT_DT BETWEEN TO_DATE (REPLACE (@[start_dt], '-', ''), 'YYYYMMDD') + .0
                             	 AND TO_DATE (REPLACE (@[end_dt], '-', ''), 'YYYYMMDD') + .99999
--          AND DC.DMDT_TRF_CD IN ('DMIF', 'DTIC', 'DMOF', 'DTOC', 'CTIC', 'CTOC')
			AND DC.DMDT_TRF_CD	IN	(
					#foreach( $trf_cd in ${tempDMTTRFList} )
						#if($velocityCount < $tempDMTTRFList.size()) '$trf_cd', #else '$trf_cd' #end
					#end
					)

           AND DC.DMDT_CHG_STS_CD IN ('F', 'C', 'I', 'N')
    	#if (${ofc_flg} == 'O')
    		AND	DC.OFC_CD	IN (
    			#foreach( $an_ofc in ${tempDEMDETOFFList} )
    				#if($velocityCount < $tempDEMDETOFFList.size()) '$an_ofc', #else '$an_ofc' #end
    			#end
    			)
    	#elseif (${ofc_flg} == 'R' && ${ofc_cd} != 'All')
    		AND	DECODE(DC.OFC_RHQ_CD, 'NYCHQ', 'NYCRA', DC.OFC_RHQ_CD) = @[ofc_cd]
    	#end
			AND (DC.SC_RFA_EXPT_AMT > 0  OR DC.AFT_EXPT_DC_AMT > 0)
--           AND DC.SC_NO = SC.SC_NO
--           AND DC.SYS_AREA_GRP_ID =
--                (SELECT SYS_AREA_GRP_ID
--                   FROM COM_SYS_AREA_GRP_ID S, MDM_ORGANIZATION M
--                  WHERE CNT_CD = SUBSTR (LOC_CD, 1, 2)
--                    AND CO_IND_CD = 'H'
--                    AND M.OFC_CD = DC.OFC_CD
--                )
			AND DC.DMDT_CHG_LOC_DIV_CD <> 'SZP'	-- 2010/03/19 추가
			AND	-- 2010/03/25 추가
			(
			    (DC.DUL_TP_EXPT_FLG = 'Y' AND SUBSTR(DC.DMDT_TRF_CD, 1, 1) = 'C')
			    OR        
			    (DC.DUL_TP_EXPT_FLG = 'N')
			)

    UNION ALL

        SELECT  /*+ USE_NL(REQ_APP DC ) LEADING(REQ_APP) */
                '' SC_NO,
                REQ_APP.RFA_NO,
                REQ_APP.PROP_NO,
                REQ_APP.CTRT_CUST_CNT_CD    CUST_CNT_CD,
                REQ_APP.CTRT_CUST_SEQ       CUST_SEQ,
                REQ_APP.PROG_OFC_CD     PROG_OFC_CD,
                DC.SYS_AREA_GRP_ID, DC.CNTR_NO, DC.CNTR_CYC_NO, DC.DMDT_TRF_CD,
                DC.BZC_TRF_CURR_CD, DC.ORG_CHG_AMT, DC.CMDT_EXPT_AMT, DC.SC_RFA_EXPT_AMT, 
                CASE WHEN DC.AFT_EXPT_DC_AMT > 0 THEN   (
                                                            SELECT
                                                                    DC.AFT_EXPT_DC_AMT
                                                            FROM
                                                                    DMT_AFT_BKG_ADJ_RQST AM
                                                            WHERE
                                                                    DECODE(@[reqapp], 'R', AM.RQST_OFC_CD, AM.APRO_OFC_CD) = REQ_APP.PROG_OFC_CD
                                                            AND     AM.AFT_EXPT_DAR_NO = DC.AFT_EXPT_DAR_NO 
                                                        )
                     WHEN DC.AFT_EXPT_DC_AMT = 0 THEN 0
                END AS AFT_EXPT_DC_AMT
                , DC.TO_MVMT_DT
          FROM  DMT_CHG_CALC	DC,
				(
                	SELECT	/*+ USE_NL(RFA_EXP RFH RFA) */ RFH.RFA_NO, RFH.PROP_NO, RFA.CTRT_CUST_CNT_CD, RFA.CTRT_CUST_SEQ, RFA_EXP.PROG_OFC_CD, RFA_EXP.RFA_EXPT_DAR_NO,
                       		DENSE_RANK() OVER(PARTITION BY RFH.RFA_NO ORDER BY RFA.AMDT_SEQ DESC) AMDT_SEQ_FILTER
                  	FROM (
--  AND :reqapp ='R'   --------- 해당부분을 UNION ALL로 분기하여야 합니다. 해당부분로직검토 필요
--  AND :ofc_flg2='O'            
            SELECT DISTINCT PROP_NO,
              RFA_EXPT_DAR_NO ,
              --RQST_OFC_CD PROG_OFC_CD
              DECODE(@[reqapp], 'R', RQST_OFC_CD, APRO_OFC_CD)  PROG_OFC_CD
            FROM DMT_RFA_EXPT_TRF
            WHERE 1 = 1

#if ( ${ofc_cd2} != '' )
          AND RQST_OFC_CD IN (
                                    #foreach( $waive_off_cd_p in ${tempWaiveOFFList}) 
                                        #if($velocityCount < $tempWaiveOFFList.size()) 
                                           '$waive_off_cd_p', 
                                        #else 
                                           '$waive_off_cd_p' 
                                        #end 
                                    #end
                                )
          AND @[reqapp] = 'R'
          AND @[ofc_flg2] = 'O'
#end

            UNION ALL
--  AND :reqapp ='R'
--  AND :ofc_flg2='R'    
            SELECT DISTINCT PROP_NO,
              RFA_EXPT_DAR_NO,
              -- RQST_OFC_CD PROG_OFC_CD
              DECODE(@[reqapp], 'R', RQST_OFC_CD, APRO_OFC_CD)  PROG_OFC_CD
            FROM DMT_RFA_EXPT_TRF
            WHERE 1 = 1

#if ( ${ofc_cd2} != '' )
          AND @[reqapp] = 'R'
          AND @[ofc_flg2] = 'R'
          AND @[ofc_cd2] <> 'All'
          AND RQST_OFC_CD IN (
            SELECT OFC_CD
            FROM MDM_ORGANIZATION START WITH OFC_CD IN (
                                                            #foreach( $waive_off_cd_p in ${tempWaiveOFFList}) 
                                                                #if($velocityCount < $tempWaiveOFFList.size()) 
                                                                   '$waive_off_cd_p', 
                                                                #else 
                                                                   '$waive_off_cd_p' 
                                                                #end 
                                                            #end
                                                       ) CONNECT BY NOCYCLE PRIOR OFC_CD = PRNT_OFC_CD)
#end

            UNION ALL
--  AND :reqapp ='A'
--  AND :ofc_flg2='O'    
            SELECT DISTINCT PROP_NO,
              RFA_EXPT_DAR_NO,
              --RQST_OFC_CD PROG_OFC_CD
              DECODE(@[reqapp], 'R', RQST_OFC_CD, APRO_OFC_CD)  PROG_OFC_CD
            FROM DMT_RFA_EXPT_TRF
            WHERE 1 = 1

#if ( ${ofc_cd2} != '' )
          AND APRO_OFC_CD IN (
                                    #foreach( $waive_off_cd_p in ${tempWaiveOFFList}) 
                                        #if($velocityCount < $tempWaiveOFFList.size()) 
                                           '$waive_off_cd_p', 
                                        #else 
                                           '$waive_off_cd_p' 
                                        #end 
                                    #end
                                )
          AND @[reqapp] = 'A'
          AND @[ofc_flg2] = 'O'
#end

            UNION ALL
--  AND :reqapp ='A'
--  AND :ofc_flg2='R'    
            SELECT DISTINCT PROP_NO,
              RFA_EXPT_DAR_NO,
              --RQST_OFC_CD PROG_OFC_CD
              DECODE(@[reqapp], 'R', RQST_OFC_CD, APRO_OFC_CD)  PROG_OFC_CD
            FROM DMT_RFA_EXPT_TRF
            WHERE 1 = 1

#if ( ${ofc_cd2} != '' )
          AND @[reqapp] = 'A'
          AND @[ofc_flg2] = 'R'
          AND @[ofc_cd2] <> 'All'
          AND APRO_OFC_CD IN (
            SELECT OFC_CD
            FROM MDM_ORGANIZATION START WITH OFC_CD IN (
                                                            #foreach( $waive_off_cd_p in ${tempWaiveOFFList}) 
                                                                #if($velocityCount < $tempWaiveOFFList.size()) 
                                                                   '$waive_off_cd_p', 
                                                                #else 
                                                                   '$waive_off_cd_p' 
                                                                #end 
                                                            #end
                                                       ) CONNECT BY NOCYCLE PRIOR OFC_CD = PRNT_OFC_CD)
#end

) RFA_EXP , PRI_RP_HDR RFH, PRI_RP_MN RFA
                 WHERE RFA_EXP.PROP_NO  = RFH.PROP_NO
                   AND RFH.PROP_NO      = RFA.PROP_NO
               )   REQ_APP
         WHERE AMDT_SEQ_FILTER = 1
           AND DC.TO_MVMT_DT BETWEEN TO_DATE (REPLACE (@[start_dt], '-', ''), 'YYYYMMDD') + .0
                                       AND TO_DATE (REPLACE (@[end_dt], '-', ''), 'YYYYMMDD')
                                           + .99999
--           AND DC.DMDT_TRF_CD IN ('DMIF', 'DTIC', 'DMOF', 'DTOC', 'CTIC', 'CTOC')
    	   AND DC.DMDT_TRF_CD	IN	(
    					#foreach( $trf_cd in ${tempDMTTRFList} )
    						#if($velocityCount < $tempDMTTRFList.size()) '$trf_cd', #else '$trf_cd' #end
    					#end
    					)
               AND DC.DMDT_CHG_STS_CD IN ('F', 'C', 'I', 'N')
        	#if (${ofc_flg} == 'O')
        		AND	DC.OFC_CD	IN (
        			#foreach( $an_ofc in ${tempDEMDETOFFList} )
        				#if($velocityCount < $tempDEMDETOFFList.size()) '$an_ofc', #else '$an_ofc' #end
        			#end
        			)
        	#elseif (${ofc_flg} == 'R' && ${ofc_cd} != 'All')
        		AND	DECODE(DC.OFC_RHQ_CD, 'NYCHQ', 'NYCRA', DC.OFC_RHQ_CD) = @[ofc_cd]
        	#end
			AND (DC.SC_RFA_EXPT_AMT > 0  OR DC.AFT_EXPT_DC_AMT > 0)
			AND DC.RFA_EXPT_DAR_NO   =  REQ_APP.RFA_EXPT_DAR_NO
--           AND DC.SYS_AREA_GRP_ID =
--                (SELECT SYS_AREA_GRP_ID
--                   FROM COM_SYS_AREA_GRP_ID S, MDM_ORGANIZATION M
--                  WHERE CNT_CD = SUBSTR (LOC_CD, 1, 2)
--                    AND CO_IND_CD = 'H'
--                    AND M.OFC_CD = DC.OFC_CD)

			AND DC.DMDT_CHG_LOC_DIV_CD <> 'SZP'	-- 2010/03/19 추가
			AND	-- 2010/03/25 추가
			(
			    (DC.DUL_TP_EXPT_FLG = 'Y' AND SUBSTR(DC.DMDT_TRF_CD, 1, 1) = 'C')
			    OR        
			    (DC.DUL_TP_EXPT_FLG = 'N')
			)

    UNION ALL

        SELECT /*+ INDEX(DC XAK16DMT_CHG_CALC) */
                AFT_BKG#.SC_NO,
                AFT_BKG#.RFA_NO,
                SC.PROP_NO,
                CUST.CUST_CNT_CD    CUST_CNT_CD,
                CUST.CUST_SEQ       CUST_SEQ,
                AFT_BKG#.PROG_OFC_CD     PROG_OFC_CD,
                DC.SYS_AREA_GRP_ID, DC.CNTR_NO, DC.CNTR_CYC_NO, DC.DMDT_TRF_CD,
                DC.BZC_TRF_CURR_CD, DC.ORG_CHG_AMT, DC.CMDT_EXPT_AMT, 
-- DC.SC_RFA_EXPT_AMT, 
          CASE
            WHEN DC.SC_RFA_EXPT_AMT > 0 AND DC.SC_NO IS NOT NULL THEN 
            (
                SELECT  DC.SC_RFA_EXPT_AMT
                FROM    DMT_SC_EXPT_VER_PROG
                        ,PRI_SP_HDR         P
                WHERE 1=1
#if ( ${ofc_cd2} != '' )
                                   AND (
                                        (
                                            @[ofc_flg2]   =   'O'
                                            AND
                                            PROG_OFC_CD IN (
                                                #foreach( $waive_off_cd_p in ${tempWaiveOFFList}) 
                                                    #if($velocityCount < $tempWaiveOFFList.size()) 
                                                       '$waive_off_cd_p', 
                                                    #else 
                                                       '$waive_off_cd_p' 
                                                    #end 
                                                #end
                                            )
                                        )
                                   OR   (
                                            @[ofc_flg2]   =   'R'
                                            AND
                                            @[ofc_cd2] <> 'All'
                                            AND
                                            PROG_OFC_CD   IN  (
                                                                SELECT OFC_CD
                                                                FROM   MDM_ORGANIZATION
                                                                START WITH OFC_CD IN (
                                                                    #foreach( $waive_off_cd_p in ${tempWaiveOFFList}) 
                                                                        #if($velocityCount < $tempWaiveOFFList.size()) 
                                                                           '$waive_off_cd_p', 
                                                                        #else 
                                                                           '$waive_off_cd_p' 
                                                                        #end 
                                                                    #end
                                                                )
                                                                CONNECT BY NOCYCLE PRIOR OFC_CD = PRNT_OFC_CD
                                                            )
                                        )
                                       )
#end
                                   AND DMDT_EXPT_VER_STS_CD = DECODE(@[reqapp], 'R', 'R', 'A', 'L')
                  and P.SC_NO         =   DC.SC_NO
                  AND DMT_SC_EXPT_VER_PROG.PROP_NO = P.PROP_NO
            )
            WHEN  DC.SC_RFA_EXPT_AMT > 0 AND DC.RFA_EXPT_DAR_NO IS NOT NULL THEN 
            (
                SELECT  DC.SC_RFA_EXPT_AMT
                  FROM  DMT_RFA_EXPT_TRF
                         WHERE (
                                (
                                    @[ofc_flg2]   =   'O'
                                    AND
                                    DECODE(@[reqapp], 'R', RQST_OFC_CD, APRO_OFC_CD) IN (
                                                #foreach( $waive_off_cd_p in ${tempWaiveOFFList}) 
                                                    #if($velocityCount < $tempWaiveOFFList.size()) 
                                                       '$waive_off_cd_p', 
                                                    #else 
                                                       '$waive_off_cd_p' 
                                                    #end 
                                                #end
                                            )
                                )
                          OR   (
                                    @[ofc_flg2]   =   'R'
                                    AND
                                    @[ofc_cd2] <> 'A'
                                    AND
                                    DECODE(@[reqapp], 'R', RQST_OFC_CD, APRO_OFC_CD)   IN  (
                                                        SELECT OFC_CD
                                                        FROM   MDM_ORGANIZATION
                                                        START WITH OFC_CD IN (
                                                            #foreach( $waive_off_cd_p in ${tempWaiveOFFList}) 
                                                                #if($velocityCount < $tempWaiveOFFList.size()) 
                                                                   '$waive_off_cd_p', 
                                                                #else 
                                                                   '$waive_off_cd_p' 
                                                                #end 
                                                            #end
                                                        )
                                                        CONNECT BY NOCYCLE PRIOR OFC_CD = PRNT_OFC_CD
                                                    )
                                )
                               )
            )
            WHEN DC.SC_RFA_EXPT_AMT = 0 THEN 0
          END AS SC_RFA_EXPT_AMT ,
DC.AFT_EXPT_DC_AMT, DC.TO_MVMT_DT

          FROM  DMT_CHG_CALC        DC,
                AFT_BKG#,
                PRI_SP_CTRT_PTY CUST,
                PRI_SP_HDR       SCH,
                PRI_SP_MN        SC
         WHERE DC.SYS_AREA_GRP_ID   = AFT_BKG#.SYS_AREA_GRP_ID
           AND DC.CNTR_NO           = AFT_BKG#.CNTR_NO
           AND DC.CNTR_CYC_NO       = AFT_BKG#.CNTR_CYC_NO
           AND SC.PROP_NO  = CUST.PROP_NO
           AND SC.AMDT_SEQ = CUST.AMDT_SEQ
           AND CUST.PRC_CTRT_PTY_TP_CD = 'C'
           AND DC.TO_MVMT_DT BETWEEN TO_DATE (REPLACE (@[start_dt], '-', ''), 'YYYYMMDD') + .0
                                       AND TO_DATE (REPLACE (@[end_dt], '-', ''), 'YYYYMMDD')
                                           + .99999
           AND DC.DMDT_TRF_CD       = AFT_BKG#.DMDT_TRF_CD
           AND SCH.PROP_NO          = SC.PROP_NO
           AND SCH.SC_NO            = AFT_BKG#.SC_NO
           AND SC.AMDT_SEQ          = (
                                         SELECT MAX(AMDT_SEQ)
                                         FROM   PRI_SP_MN
                                         WHERE  PRI_SP_MN.PROP_NO          = SCH.PROP_NO
                                      )
           AND AFT_BKG#.CTRT_TP     = 'S'

--           AND DC.DMDT_TRF_CD IN ('DMIF', 'DTIC', 'DMOF', 'DTOC', 'CTIC', 'CTOC')
            AND DC.DMDT_TRF_CD IN (
             #foreach( $trf_cd in ${tempDMTTRFList} )
              #if($velocityCount < $tempDMTTRFList.size()) '$trf_cd', #else '$trf_cd' #end
             #end
             )
                   AND DC.DMDT_CHG_STS_CD IN ('F', 'C', 'I', 'N')
             #if (${ofc_flg} == 'O')
              AND DC.OFC_CD IN (
               #foreach( $an_ofc in ${tempDEMDETOFFList} )
                #if($velocityCount < $tempDEMDETOFFList.size()) '$an_ofc', #else '$an_ofc' #end
               #end
               )
             #elseif (${ofc_flg} == 'R' && ${ofc_cd} != 'All')
              AND DECODE(DC.OFC_RHQ_CD, 'NYCHQ', 'NYCRA', DC.OFC_RHQ_CD) = @[ofc_cd]
             #end
			AND DC.AFT_EXPT_DAR_NO   =  AFT_BKG#.AFT_EXPT_DAR_NO
			AND (DC.SC_RFA_EXPT_AMT > 0  OR DC.AFT_EXPT_DC_AMT > 0)
--           AND DC.SYS_AREA_GRP_ID =
--                (SELECT SYS_AREA_GRP_ID
--                   FROM COM_SYS_AREA_GRP_ID S, MDM_ORGANIZATION M
--                  WHERE CNT_CD = SUBSTR (LOC_CD, 1, 2)
--                    AND CO_IND_CD = 'H'
--                    AND M.OFC_CD = DC.OFC_CD)

			AND DC.DMDT_CHG_LOC_DIV_CD <> 'SZP'	-- 2010/03/19 추가
			AND	-- 2010/03/25 추가
			(
			    (DC.DUL_TP_EXPT_FLG = 'Y' AND SUBSTR(DC.DMDT_TRF_CD, 1, 1) = 'C')
			    OR        
			    (DC.DUL_TP_EXPT_FLG = 'N')
			)

    UNION ALL

        SELECT /*+ INDEX(DC XAK16DMT_CHG_CALC) */
                AFT_BKG#.SC_NO,
                AFT_BKG#.RFA_NO,
                RFA.PROP_NO,
                RFA.CTRT_CUST_CNT_CD    CUST_CNT_CD,
                RFA.CTRT_CUST_SEQ       CUST_SEQ,
                AFT_BKG#.PROG_OFC_CD     PROG_OFC_CD,
                DC.SYS_AREA_GRP_ID, DC.CNTR_NO, DC.CNTR_CYC_NO, DC.DMDT_TRF_CD,
                DC.BZC_TRF_CURR_CD, DC.ORG_CHG_AMT, DC.CMDT_EXPT_AMT, 
-- DC.SC_RFA_EXPT_AMT, 

-- //////////////////////////////// DAT_W030_튜닝요청및가이드(DMT)_20100106_10.doc 데이터확인 필요한 부분 시작

          CASE
            WHEN DC.SC_RFA_EXPT_AMT > 0 AND DC.SC_NO IS NOT NULL THEN 
            (
                SELECT  DC.SC_RFA_EXPT_AMT
                FROM    DMT_SC_EXPT_VER_PROG
                        ,PRI_SP_HDR         P
                WHERE 1=1
#if ( ${ofc_cd2} != '' )
                                   AND (
                                        (
                                            @[ofc_flg2]   =   'O'
                                            AND
                                            PROG_OFC_CD IN (
                                                #foreach( $waive_off_cd_p in ${tempWaiveOFFList}) 
                                                    #if($velocityCount < $tempWaiveOFFList.size()) 
                                                       '$waive_off_cd_p', 
                                                    #else 
                                                       '$waive_off_cd_p' 
                                                    #end 
                                                #end
                                            )
                                        )
                                   OR   (
                                            @[ofc_flg2]   =   'R'
                                            AND
                                            @[ofc_cd2] <> 'All'
                                            AND
                                            PROG_OFC_CD   IN  (
                                                                SELECT OFC_CD
                                                                FROM   MDM_ORGANIZATION
                                                                START WITH OFC_CD IN (
                                                                    #foreach( $waive_off_cd_p in ${tempWaiveOFFList}) 
                                                                        #if($velocityCount < $tempWaiveOFFList.size()) 
                                                                           '$waive_off_cd_p', 
                                                                        #else 
                                                                           '$waive_off_cd_p' 
                                                                        #end 
                                                                    #end
                                                                )
                                                                CONNECT BY NOCYCLE PRIOR OFC_CD = PRNT_OFC_CD
                                                            )
                                        )
                                       )
#end
                                   AND DMDT_EXPT_VER_STS_CD = DECODE(@[reqapp], 'R', 'R', 'A', 'L')
                  and P.SC_NO         =   DC.SC_NO
                  AND DMT_SC_EXPT_VER_PROG.PROP_NO = P.PROP_NO
            )
            WHEN  DC.SC_RFA_EXPT_AMT > 0 AND DC.RFA_EXPT_DAR_NO IS NOT NULL THEN 
            (
                SELECT  DC.SC_RFA_EXPT_AMT
                  FROM  DMT_RFA_EXPT_TRF
                 WHERE  (
                                (
                                    @[ofc_flg2]   =   'O'
                                    AND
                                    DECODE(@[reqapp], 'R', RQST_OFC_CD, APRO_OFC_CD) IN (
                                                #foreach( $waive_off_cd_p in ${tempWaiveOFFList}) 
                                                    #if($velocityCount < $tempWaiveOFFList.size()) 
                                                       '$waive_off_cd_p', 
                                                    #else 
                                                       '$waive_off_cd_p' 
                                                    #end 
                                                #end
                                            )
                                )
                          OR   (
                                    @[ofc_flg2]   =   'R'
                                    AND
                                    @[ofc_cd2] <> 'A'
                                    AND
                                    DECODE(@[reqapp], 'R', RQST_OFC_CD, APRO_OFC_CD)   IN  (
                                                        SELECT OFC_CD
                                                        FROM   MDM_ORGANIZATION
                                                        START WITH OFC_CD IN (
                                                            #foreach( $waive_off_cd_p in ${tempWaiveOFFList}) 
                                                                #if($velocityCount < $tempWaiveOFFList.size()) 
                                                                   '$waive_off_cd_p', 
                                                                #else 
                                                                   '$waive_off_cd_p' 
                                                                #end 
                                                            #end
                                                        )
                                                        CONNECT BY NOCYCLE PRIOR OFC_CD = PRNT_OFC_CD
                                                    )
                                )
                        )
				AND DC.RFA_EXPT_DAR_NO = RFA_EXPT_DAR_NO   -- 20100122 추가 필요
				AND DMDT_EXPT_RQST_STS_CD = 'A'	-- 20110414 [CHM-201110144-01]
            )
            WHEN DC.SC_RFA_EXPT_AMT = 0 THEN 0
          END AS SC_RFA_EXPT_AMT ,

-- //////////////////////////////// DAT_W030_튜닝요청및가이드(DMT)_20100106_10.doc 데이터확인 필요한 부분 끝

DC.AFT_EXPT_DC_AMT, DC.TO_MVMT_DT

          FROM  DMT_CHG_CALC        DC,
                AFT_BKG#,
                PRI_RP_HDR       RFH,
                PRI_RP_MN        RFA
         WHERE DC.SYS_AREA_GRP_ID   = AFT_BKG#.SYS_AREA_GRP_ID
           AND DC.CNTR_NO           = AFT_BKG#.CNTR_NO
           AND DC.CNTR_CYC_NO       = AFT_BKG#.CNTR_CYC_NO
           AND DC.TO_MVMT_DT BETWEEN TO_DATE (REPLACE (@[start_dt], '-', ''), 'YYYYMMDD') + .0
                                       AND TO_DATE (REPLACE (@[end_dt], '-', ''), 'YYYYMMDD')
                                           + .99999
           AND DC.DMDT_TRF_CD       = AFT_BKG#.DMDT_TRF_CD
           AND RFH.PROP_NO          = RFA.PROP_NO
           AND RFH.RFA_NO            = AFT_BKG#.RFA_NO
           AND RFA.AMDT_SEQ          = (
                                         SELECT MAX(AMDT_SEQ)
                                         FROM   PRI_RP_MN
                                         WHERE  PRI_RP_MN.PROP_NO          = RFH.PROP_NO
                                      )
           AND AFT_BKG#.CTRT_TP     = 'R'

--           AND DC.DMDT_TRF_CD IN ('DMIF', 'DTIC', 'DMOF', 'DTOC', 'CTIC', 'CTOC')
            AND DC.DMDT_TRF_CD IN (
             #foreach( $trf_cd in ${tempDMTTRFList} )
              #if($velocityCount < $tempDMTTRFList.size()) '$trf_cd', #else '$trf_cd' #end
             #end
             )
                   AND DC.DMDT_CHG_STS_CD IN ('F', 'C', 'I', 'N')
             #if (${ofc_flg} == 'O')
              AND DC.OFC_CD IN (
               #foreach( $an_ofc in ${tempDEMDETOFFList} )
                #if($velocityCount < $tempDEMDETOFFList.size()) '$an_ofc', #else '$an_ofc' #end
               #end
               )
             #elseif (${ofc_flg} == 'R' && ${ofc_cd} != 'All')
              AND DECODE(DC.OFC_RHQ_CD, 'NYCHQ', 'NYCRA', DC.OFC_RHQ_CD) = @[ofc_cd]
             #end
			AND DC.AFT_EXPT_DAR_NO   =  AFT_BKG#.AFT_EXPT_DAR_NO
			AND (DC.SC_RFA_EXPT_AMT > 0  OR DC.AFT_EXPT_DC_AMT > 0)
--           AND DC.SYS_AREA_GRP_ID =
--                (SELECT SYS_AREA_GRP_ID
--                   FROM COM_SYS_AREA_GRP_ID S, MDM_ORGANIZATION M
--                  WHERE CNT_CD = SUBSTR (LOC_CD, 1, 2)
--                    AND CO_IND_CD = 'H'
--                    AND M.OFC_CD = DC.OFC_CD)
			AND DC.DMDT_CHG_LOC_DIV_CD <> 'SZP'	-- 2010/03/19 추가
			AND	-- 2010/03/25 추가
			(
			    (DC.DUL_TP_EXPT_FLG = 'Y' AND SUBSTR(DC.DMDT_TRF_CD, 1, 1) = 'C')
			    OR        
			    (DC.DUL_TP_EXPT_FLG = 'N')
			)
        )   X,
        GL_MON_XCH_RT		F,
		DMT_CHG_BKG_CNTR    DB,
        (
           SELECT   OFC_N3RD_LVL_CD ,
                    OFC_N8TH_LVL_CD
           FROM     DMT_OFC_LVL_V
        )   OV

WHERE   F.ACCT_XCH_RT_YRMON	=	TO_CHAR(X.TO_MVMT_DT,'YYYYMM')
AND		F.ACCT_XCH_RT_LVL	=	'1'
AND		F.CURR_CD          	=	X.BZC_TRF_CURR_CD
AND     X.PROG_OFC_CD       =   OV.OFC_N8TH_LVL_CD
AND     (X.SC_RFA_EXPT_AMT  >   0   OR  X.AFT_EXPT_DC_AMT > 0)

AND     X.SYS_AREA_GRP_ID   =   DB.SYS_AREA_GRP_ID
AND     X.CNTR_NO           =   DB.CNTR_NO
AND     X.CNTR_CYC_NO       =   DB.CNTR_CYC_NO
AND     DB.DMDT_CNTR_TP_CD  IN
    (
     SELECT 'D' FROM DUAL WHERE DECODE(@[dmdt_cntr_tp_cd], 'A', 'Y', 'D', 'Y', 'N') = 'Y'
     UNION ALL
     SELECT 'R' FROM DUAL WHERE DECODE(@[dmdt_cntr_tp_cd], 'A', 'Y', 'R', 'Y', 'N') = 'Y'
     UNION ALL
     SELECT 'F' FROM DUAL WHERE DECODE(@[dmdt_cntr_tp_cd], 'A', 'Y', 'S', 'Y', 'N') = 'Y'
     UNION ALL
     SELECT 'O' FROM DUAL WHERE DECODE(@[dmdt_cntr_tp_cd], 'A', 'Y', 'S', 'Y', 'N') = 'Y'
     UNION ALL
     SELECT 'T' FROM DUAL WHERE DECODE(@[dmdt_cntr_tp_cd], 'A', 'Y', 'S', 'Y', 'N') = 'Y'
     UNION ALL
     SELECT 'P' FROM DUAL WHERE DECODE(@[dmdt_cntr_tp_cd], 'A', 'Y', 'S', 'Y', 'N') = 'Y'
     UNION ALL                  /* Sliding Open Top, Adjustable Flatrack 추가 - #add 2008.10.09 */
     SELECT 'S' FROM DUAL WHERE DECODE(@[dmdt_cntr_tp_cd], 'A', 'Y', 'S', 'Y', 'N') = 'Y'
     UNION ALL
     SELECT 'A' FROM DUAL WHERE DECODE(@[dmdt_cntr_tp_cd], 'A', 'Y', 'S', 'Y', 'N') = 'Y'
    )

GROUP BY DECODE(@[grp_flg], 'O', X.PROG_OFC_CD, 'R', OV.OFC_N3RD_LVL_CD),
        X.DMDT_TRF_CD,
        X.SC_NO,
        X.RFA_NO,
        X.CUST_CNT_CD||X.CUST_SEQ,
        X.BZC_TRF_CURR_CD, X.CUST_CNT_CD, X.CUST_SEQ			]]></sql>
			<params>
				<param name="reqapp" type="12" value="" out="N"/>
				<param name="ofc_flg2" type="12" value="" out="N"/>
				<param name="ofc_cd2" type="12" value="" out="N"/>
				<param name="grp_flg" type="12" value="" out="N"/>
				<param name="curr_flg" type="12" value="" out="N"/>
				<param name="start_dt" type="12" value="" out="N"/>
				<param name="end_dt" type="12" value="" out="N"/>
				<param name="ofc_cd" type="12" value="" out="N"/>
				<param name="dmdt_cntr_tp_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
