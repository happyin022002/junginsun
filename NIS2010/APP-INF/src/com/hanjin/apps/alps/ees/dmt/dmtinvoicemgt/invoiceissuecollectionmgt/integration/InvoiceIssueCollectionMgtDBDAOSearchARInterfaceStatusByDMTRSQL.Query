<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="InvoiceIssueCollectionMgtDBDAOSearchARInterfaceStatusByDMTRSQL">
			<desc><![CDATA[SearchARInterfaceStatusByDMT]]></desc>
			<sql><![CDATA[
WITH INV_DATA AS (
    SELECT  DISTINCT 
#if (${ofc_tp} == 'ar_if_ofc') 
            I.AR_IF_OFC_CD AS OFC_CD
            , I.AR_IF_OFC_CD || TO_CHAR(I.AR_IF_DT ,'YYYYMMDD') || I.INV_CURR_CD AS SUBTOT
#elseif (${ofc_tp} == 'issue_ofc')   
             I.CRE_OFC_CD   AS OFC_CD
	       , I.CRE_OFC_CD || TO_CHAR(I.AR_IF_DT ,'YYYYMMDD') || I.INV_CURR_CD AS SUBTOT
#end
            , TO_CHAR(I.AR_IF_DT ,'YYYY-MM-DD HH24:MI') AS AR_IF_DT
            , I.DMDT_TRF_CD
            , I.DMDT_INV_NO
            , I.BKG_NO
            , I.BL_NO
            , I.AR_IF_NO
            , I.VSL_CD || I.SKD_VOY_NO || I.SKD_DIR_CD AS VVD
            , DECODE(SUBSTR(I.DMDT_TRF_CD, 3, 1),'I', I.POD_CD, I.POL_CD) AS PORT
            , I.AR_IF_OFC_CD
##      ,I.AR_IF_USR_ID
            , (SELECT USR_NM FROM COM_USER WHERE USR_ID = I.AR_IF_USR_ID) AS AR_IF_USR_ID
            , TO_CHAR(I.CRE_DT,'YYYY-MM-DD') AS CRE_DT
            , I.CRE_OFC_CD
##      ,I.CRE_USR_ID
            , (SELECT USR_NM FROM COM_USER WHERE USR_ID = I.CRE_USR_ID) AS CRE_USR_ID
            , I.INV_CURR_CD
            , I.INV_CHG_AMT
            , I.TAX_AMT
            , I.INV_AMT
            , 
            (
            SELECT  DELT_FLG
            FROM    MDM_CUSTOMER
            WHERE   CUST_CNT_CD = DECODE (I.ACT_PAYR_CNT_CD,'00', '',I.ACT_PAYR_CNT_CD)
            AND     CUST_SEQ    = TO_CHAR (I.ACT_PAYR_SEQ, 'FM000000')
            )                                       AS PAYER_FLG
            , DECODE (I.ACT_PAYR_CNT_CD,'00', '',I.ACT_PAYR_CNT_CD)|| TO_CHAR (I.ACT_PAYR_SEQ, 'FM000000') AS PAYER_CD
            , CASE
            WHEN I.DMDT_TRF_CD = 'DTIC' AND INSTR (NVL (I.POD_CD, '  '), 'US') = 1  AND I.ACT_PAYR_CNT_CD = '00' THEN
                (
                SELECT  MV.VNDR_LGL_ENG_NM
                FROM    MDM_VENDOR MV
                WHERE   MV.VNDR_SEQ     = TO_CHAR (I.ACT_PAYR_SEQ, 'FM000000')
                )  
            WHEN I.DMDT_TRF_CD = 'DTOC' AND INSTR (NVL (I.POL_CD, '  '), 'US') = 1 AND I.ACT_PAYR_CNT_CD = '00' THEN
                (
                SELECT  MV.VNDR_LGL_ENG_NM
                FROM    MDM_VENDOR MV
                WHERE   MV.VNDR_SEQ     = TO_CHAR (I.ACT_PAYR_SEQ, 'FM000000')
                )
            WHEN I.DMDT_TRF_CD IN ('DMIF', 'CTIC') OR (I.DMDT_TRF_CD = 'DTIC' AND INSTR (NVL (I.POD_CD, '  '), 'US') <> 1) THEN
                (
                SELECT  MC.CUST_LGL_ENG_NM
                FROM    MDM_CUSTOMER MC
                WHERE   MC.CUST_CNT_CD  = DECODE (I.ACT_PAYR_CNT_CD,'00', '',I.ACT_PAYR_CNT_CD)
                AND     MC.CUST_SEQ     = TO_CHAR (I.ACT_PAYR_SEQ, 'FM000000')
                )
            WHEN I.DMDT_TRF_CD IN ('DMOF', 'CTOC') OR (    I.DMDT_TRF_CD = 'DTOC' AND INSTR (NVL (I.POL_CD, '  '), 'US') <> 1) THEN
                (
                SELECT  MC.CUST_LGL_ENG_NM
                FROM    MDM_CUSTOMER MC
                WHERE   MC.CUST_CNT_CD  = DECODE (I.ACT_PAYR_CNT_CD,'00', '',I.ACT_PAYR_CNT_CD)
                AND     MC.CUST_SEQ     = TO_CHAR (I.ACT_PAYR_SEQ, 'FM000000')
                )
            ELSE    
                (
                SELECT MC.CUST_LGL_ENG_NM
                FROM MDM_CUSTOMER MC
                WHERE MC.CUST_CNT_CD = DECODE (I.ACT_PAYR_CNT_CD,'00', '',I.ACT_PAYR_CNT_CD)
                AND MC.CUST_SEQ = TO_CHAR (I.ACT_PAYR_SEQ, 'FM000000')
                )                            
            END     AS PAYER_NM  
            , BS.CUST_CNT_CD || TRIM (TO_CHAR (BS.CUST_SEQ, '000000'))  AS SHIPPER_CD
            , REPLACE (BS.CUST_NM, CHR (13)|| CHR (10), ' ')            AS SHIPPER_NM
            , DECODE (BC.CUST_CNT_CD
               || TRIM (TO_CHAR (BC.CUST_SEQ, '000000'))
              ,'000000', NULL
              , BC.CUST_CNT_CD
                || TRIM (TO_CHAR (BC.CUST_SEQ, '000000'))
              )                                                         AS CONSIGNEE_CD
            ,REPLACE (BC.CUST_NM, CHR (13)|| CHR (10), ' ')             AS CONSIGNEE_NM
            ,DECODE (BN.CUST_CNT_CD
               || TRIM (TO_CHAR (BN.CUST_SEQ, '000000'))
              ,'000000', NULL
              , BN.CUST_CNT_CD
                || TRIM (TO_CHAR (BN.CUST_SEQ, '000000'))
              )                                                         AS NOTIFY_CD
            ,NVL (RTRIM (REPLACE (REPLACE (BN.CUST_NM, CHR (34), ''), CHR (13) || CHR (10) ,' ')), '-') AS NOTIFY_NM	
           ,(
				SELECT  CASE 
							WHEN A2.CNT_CD = 'IN' AND I.CRE_DT >= TO_DATE(A3.ATTR_CTNT1, 'YYYYMMDDHH24MI') 
								THEN SUBSTR(I.DMDT_INV_NO, 4, 1)
							ELSE
								SUBSTR(I.DMDT_INV_NO, 3, 1)
						END
						
				  FROM  MDM_ORGANIZATION  	A1
					   ,MDM_LOCATION      	A2
					   ,DMT_HRD_CDG_CTNT	A3
				 WHERE  A1.OFC_CD     = I.CRE_OFC_CD
				   AND  A1.LOC_CD     = A2.LOC_CD
				   AND  A3.HRD_CDG_ID = 'IDA_TAX_APPL_DT'
			) AS DMDT_INV_TP_CD
			
    FROM    DMT_INV_MN   I,
            BKG_CUSTOMER BS,
            BKG_CUSTOMER BC,
            BKG_CUSTOMER BN
    WHERE   BS.BKG_NO(+)            = I.BKG_NO
    AND     BS.BKG_CUST_TP_CD(+)    = 'S'
    AND     BC.BKG_NO(+)            = I.BKG_NO
    AND     BC.BKG_CUST_TP_CD(+)    = 'C'
    AND     BN.BKG_NO(+)            = I.BKG_NO
    AND     BN.BKG_CUST_TP_CD(+)    = 'N'
#if (${s_invoice_no} != '') 
	AND     I.DMDT_INV_NO IN (
		#foreach( $s_invoice_no in ${s_invoice_no_list} )
            #if($velocityCount < $s_invoice_no_list.size()) '$s_invoice_no', #else '$s_invoice_no' #end
		#end
        )
#end
#if (${s_bkg_no} != '') 
	AND     I.BKG_NO IN (
		#foreach( $s_bkg_no in ${s_bkg_no_list} )
            #if($velocityCount < $s_bkg_no_list.size()) '$s_bkg_no', #else '$s_bkg_no' #end
		#end
        )
#end
#if (${ofc_tp} == 'ar_if_ofc') 
    AND     I.AR_IF_OFC_CD IN (
        #foreach( $ofc_cd in ${ofc_cd_list} )
            #if($velocityCount < $ofc_cd_list.size()) '$ofc_cd', #else '$ofc_cd' #end
	#end
        )
#elseif (${ofc_tp} == 'issue_ofc')   
    AND     I.CRE_OFC_CD IN (
        #foreach( $ofc_cd in ${ofc_cd_list} )
            #if($velocityCount < $ofc_cd_list.size()) '$ofc_cd', #else '$ofc_cd' #end
        #end
        )   
#end   
   
#if (${dmdt_trf_cd_t1} != '') 
    AND     I.DMDT_TRF_CD IN (
        #foreach( $trf_cd in ${trf_cd_list} )
            #if($velocityCount < $trf_cd_list.size()) '$trf_cd', #else '$trf_cd' #end
        #end
        ) 
#end   
        
    AND     I.AR_IF_DT  BETWEEN TO_DATE (@[fm_dt], 'yyyymmdd')
                        AND     TO_DATE (@[to_dt], 'yyyymmdd') + 0.99999                       
    AND     I.DMDT_AR_IF_CD = 'Y'
#if (${cust_cd} != '')
 #if (${cust_type} == 'P')
  #if (${cust_len} == '8')
    AND     I.ACT_PAYR_CNT_CD   = SUBSTR(@[cust_cd],1,2)
    AND     I.ACT_PAYR_SEQ      = LTRIM(SUBSTR(@[cust_cd],3),'0')
  #else
    AND     I.ACT_PAYR_SEQ      = LTRIM(SUBSTR(@[cust_cd],1,6),'0')
  #end
 #elseif (${cust_type} == 'S') 
    AND     BS.CUST_CNT_CD      = SUBSTR(@[cust_cd],1,2)
    AND     BS.CUST_SEQ         = LTRIM(SUBSTR(@[cust_cd],3),'0')
 #elseif (${cust_type} == 'C') 
    AND     BC.CUST_CNT_CD      = SUBSTR(@[cust_cd],1,2)
    AND     BC.CUST_SEQ         = LTRIM(SUBSTR(@[cust_cd],3),'0')
 #elseif (${cust_type} == 'N') 
    AND     BN.CUST_CNT_CD      = SUBSTR(@[cust_cd],1,2)
    AND     BN.CUST_SEQ         = LTRIM(SUBSTR(@[cust_cd],3),'0')
 #end
#end
)

#if (${usr_ofc_cd} == 'SAOBB' && ${btn_id} == 'btn_downexcel')
SELECT    T1.OFC_CD
        , T1.SUBTOT
        , T1.AR_IF_DT
        , T1.DMDT_TRF_CD
        , T1.DMDT_INV_NO
        , T1.BKG_NO
        , T1.BL_NO
        , T1.AR_IF_NO
        , T1.VVD
        , T1.PORT
        , T1.AR_IF_OFC_CD
        , T1.AR_IF_USR_ID
        , T1.CRE_DT
        , T1.CRE_OFC_CD
        , T1.CRE_USR_ID
        , T1.INV_CURR_CD
        , T1.INV_CHG_AMT
        , T1.TAX_AMT
        , T1.INV_AMT
        , T1.PAYER_FLG
        , T1.PAYER_CD
        , T1.PAYER_NM
        , T1.SHIPPER_CD
        , T1.SHIPPER_NM
        , T1.CONSIGNEE_CD
        , T1.CONSIGNEE_NM
        , T1.NOTIFY_CD
        , T1.NOTIFY_NM
        , T3.CNTR_NO
        , TO_CHAR(T2.FM_MVMT_DT, 'YYYY-MM-DD HH24:MI') AS FT_CMNC_DT --컬럼이 다름으로 주위하세요!!
        , TO_CHAR(T2.TO_MVMT_DT, 'YYYY-MM-DD HH24:MI') AS FT_END_DT  --컬럼이 다름으로 주위하세요!!
        , T3.FX_FT_OVR_DYS
        , T1.DMDT_INV_TP_CD

FROM    INV_DATA        T1,
        DMT_INV_DTL     T2,
        DMT_CHG_CALC    T3
WHERE   1=1
AND     T1.DMDT_INV_NO          = T2.DMDT_INV_NO
AND     T1.CRE_OFC_CD           = T2.CRE_OFC_CD
AND     T2.SYS_AREA_GRP_ID      = T3.SYS_AREA_GRP_ID    (+)
AND     T2.CNTR_NO              = T3.CNTR_NO            (+)
AND     T2.CNTR_CYC_NO          = T3.CNTR_CYC_NO        (+)
AND     T2.DMDT_TRF_CD          = T3.DMDT_TRF_CD        (+)
AND     T2.DMDT_CHG_LOC_DIV_CD  = T3.DMDT_CHG_LOC_DIV_CD(+)
AND     T2.CHG_SEQ              = T3.CHG_SEQ            (+)


#else

SELECT   *
FROM     INV_DATA T1

#end

#if (${ofc_tp} == 'ar_if_ofc') 
ORDER BY T1.AR_IF_OFC_CD ASC, T1.AR_IF_DT ASC, T1.INV_CURR_CD ASC
#elseif (${ofc_tp} == 'issue_ofc')   
ORDER BY T1.CRE_OFC_CD, T1.AR_IF_DT , T1.INV_CURR_CD
#end			]]></sql>
			<params>
				<param name="fm_dt" type="12" value="20140701" out="N"/>
				<param name="to_dt" type="12" value="20140801" out="N"/>
				<param name="cust_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
