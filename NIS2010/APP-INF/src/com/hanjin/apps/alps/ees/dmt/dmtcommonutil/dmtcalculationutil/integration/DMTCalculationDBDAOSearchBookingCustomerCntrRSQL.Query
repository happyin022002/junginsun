<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="DMTCalculationDBDAOSearchBookingCustomerCntrRSQL">
			<desc><![CDATA[searchBookingCustomerCntr]]></desc>
			<sql><![CDATA[
SELECT * 
FROM (
SELECT CNTR_NO ,
  SUM(FX_FT_OVR_DYS) OVER() AS FX_FT_OVR_DYS ,
  BZC_TRF_CURR_CD ,
  SUM(BIL_AMT) OVER() AS BIL_AMT ,
  FT_DYS ,
  MAX(FT_END_DT) OVER() AS FT_END_DT
  FROM (SELECT C.CNTR_NO AS CNTR_NO
              ,C.FX_FT_OVR_DYS AS FX_FT_OVR_DYS
              ,C.BZC_TRF_CURR_CD AS BZC_TRF_CURR_CD
              ,C.BIL_AMT AS BIL_AMT
              ,SUM (C.FT_DYS) OVER (PARTITION BY C.SYS_AREA_GRP_ID, C.CNTR_NO, C.CNTR_CYC_NO, C.DMDT_TRF_CD, C.DMDT_CHG_LOC_DIV_CD)
                                                                      AS FT_DYS
              , MAX (TO_CHAR (DECODE(NVL(INVM.DMDT_AR_IF_CD, 'N'),'Y',C.TO_MVMT_DT, C.FT_END_DT), 'YYYYMMDD')) OVER (PARTITION BY C.SYS_AREA_GRP_ID, C.CNTR_NO, C.CNTR_CYC_NO, C.DMDT_TRF_CD, C.DMDT_CHG_LOC_DIV_CD) AS FT_END_DT
--              ,MIN (TO_CHAR (C.FT_END_DT, 'YYYYMMDD')) OVER (PARTITION BY C.SYS_AREA_GRP_ID, C.CNTR_NO, C.CNTR_CYC_NO, C.DMDT_TRF_CD, C.DMDT_CHG_LOC_DIV_CD) AS FT_END_DT
          FROM DMT_CHG_CALC C, DMT_INV_MN  INVM
         WHERE (C.SYS_AREA_GRP_ID, C.CNTR_NO, C.CNTR_CYC_NO) IN (
                              SELECT D.SYS_AREA_GRP_ID
                                    ,D.CNTR_NO
                                    ,D.CNTR_CYC_NO
                                FROM DMT_CHG_BKG_CNTR D
                               WHERE D.BKG_NO = @[bkg_no])
           AND C.CNTR_NO = @[cntr_no]
	       AND C.DMDT_CHG_STS_CD IN ('F', 'C', 'I', 'L', 'N', 'U')  
           AND (   (    C.DMDT_TRF_CD = 'DMIF'
                    AND C.DMDT_CHG_LOC_DIV_CD = 'POD')
                OR (    C.DMDT_TRF_CD = 'CTIC'
                    AND C.DMDT_CHG_LOC_DIV_CD = 'DEL')
               )
           AND C.DMDT_INV_NO = INVM.DMDT_INV_NO(+)
		   AND NOT (C.DUL_TP_EXPT_FLG  = 'Y' AND SUBSTR(C.DMDT_TRF_CD, 1, 1) = 'D')
		   AND C.DMDT_CHG_LOC_DIV_CD    <> 'SZP'
		)
)
 WHERE ROWNUM < 2			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="cntr_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
