<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="RFAExceptionTariffMgtDBDAOSearchBeforeBookingListByDateUserOfficeSNDRSQL">
			<desc><![CDATA[DEM/DET Adjustment Request & Approval Status 조회(BeforeBooking, DATE-Office, Sent)용 쿼리]]></desc>
			<sql><![CDATA[
SELECT	/* ordered */ DISTINCT TTL.DAR_NO
	,	TTL.VER_NO
	,	TTL.APVL_NO
    ,	CD_DTL.INTG_CD_VAL_DP_DESC AS STATUS

	#if(${group_by} == 'CVRG')
	,	RFA_TRF_DTL.RFA_RQST_DTL_SEQ AS DTL_SEQ
    ,   RFA_TRF_DTL.DMDT_TRF_CD
	,	RFA_CVRG.CVRG_CMB_SEQ AS CVRG_SEQ
	,	RFA_CVRG.CVRG_CNT_CD AS CNT_CD
	,	CASE 
			WHEN SUBSTR(RFA_CVRG.CVRG_CNT_CD, 1, 2) IN ('CA', 'US') 
				THEN RFA_CVRG.CVRG_STE_CD
				ELSE RFA_CVRG.CVRG_RGN_CD
		END AS RGN_CD
	,	RFA_CVRG.CVRG_LOC_CD AS LOC_CD
	#end

    ,	TTL.REQ_OFC_CD
	,	APRO_OFC_CD
	,	TTL.UPD_DT
	,	RP_HDR.RFA_NO
	,	RP_HDR.PROP_NO
	,	RP_MN.CTRT_CUST_CNT_CD || LPAD(RP_MN.CTRT_CUST_SEQ, 6, '0') CUST_CD
	,	CUST.CUST_LGL_ENG_NM CUST_NM
FROM	(
		    SELECT	RFA_TRF.RFA_EXPT_DAR_NO AS DAR_NO
				,	LPAD(RFA_TRF.RFA_EXPT_VER_SEQ, 3, '0') AS VER_NO
			    ,	RFA_TRF.RFA_EXPT_APRO_NO AS APVL_NO
				,	RFA_TRF_PROG.PROG_OFC_CD AS REQ_OFC_CD
      			,	'' AS APRO_OFC_CD
				,	TO_CHAR(RFA_TRF.UPD_DT, 'YYYY-MM-DD') AS UPD_DT
      			,	RFA_TRF.PROP_NO
      			,	RFA_TRF.RFA_EXPT_DAR_NO
      			,	RFA_TRF.RFA_EXPT_MAPG_SEQ
      			,	RFA_TRF.RFA_EXPT_VER_SEQ
				,	RFA_TRF.DMDT_EXPT_RQST_STS_CD
			FROM	DMT_RFA_EXPT_TRF RFA_TRF
				,	DMT_RFA_EXPT_TRF_PROG RFA_TRF_PROG
			WHERE 	RFA_TRF.RFA_EXPT_DAR_NO 		= RFA_TRF_PROG.RFA_EXPT_DAR_NO
      			AND RFA_TRF.RFA_EXPT_MAPG_SEQ 		= RFA_TRF_PROG.RFA_EXPT_MAPG_SEQ
      			AND RFA_TRF.RFA_EXPT_VER_SEQ 		= RFA_TRF_PROG.RFA_EXPT_VER_SEQ
      			AND RFA_TRF.DMDT_EXPT_RQST_STS_CD 	= 'R'
      			AND RFA_TRF.UPD_DT BETWEEN TO_DATE(@[fm_dt], 'YYYY-MM-DD') AND TO_DATE(@[to_dt], 'YYYY-MM-DD') + 0.99999
      			AND RFA_TRF_PROG.PROG_SEQ 			= 
					(
						SELECT	/*+ INDEX_DESC(DMT_RFA_EXPT_TRF_PROG XPKDMT_RFA_EXPT_TRF_PROG) */PROG_SEQ
						FROM	DMT_RFA_EXPT_TRF_PROG
						WHERE	RFA_EXPT_DAR_NO 		= RFA_TRF_PROG.RFA_EXPT_DAR_NO
							AND RFA_EXPT_MAPG_SEQ 		= RFA_TRF_PROG.RFA_EXPT_MAPG_SEQ
							AND RFA_EXPT_VER_SEQ 		= RFA_TRF_PROG.RFA_EXPT_VER_SEQ
							AND PROG_OFC_CD IN
								(
									#foreach( $ofc_cd in ${ofc_cd_list} )
										#if($velocityCount < $ofc_cd_list.size()) '$ofc_cd', #else '$ofc_cd' #end
									#end
								)
							AND DMDT_EXPT_RQST_STS_CD 	= 'R'
							AND ROWNUM 					= 1 
					)

			UNION

			SELECT	RFA_TRF.RFA_EXPT_DAR_NO AS DAR_NO
				,	LPAD(RFA_TRF.RFA_EXPT_VER_SEQ, 3, '0') AS VER_NO
				,	RFA_TRF.RFA_EXPT_APRO_NO AS APVL_NO
				,	RFA_TRF_PROG2.PROG_OFC_CD AS REQ_OFC_CD
				,	DECODE(RFA_TRF.DMDT_EXPT_RQST_STS_CD, 'C', '', RFA_TRF_PROG.PROG_OFC_CD) AS APRO_OFC_CD
				,	TO_CHAR(RFA_TRF.UPD_DT, 'YYYY-MM-DD') AS UPD_DT
				,	RFA_TRF.PROP_NO
				,	RFA_TRF.RFA_EXPT_DAR_NO
				,	RFA_TRF.RFA_EXPT_MAPG_SEQ
				,	RFA_TRF.RFA_EXPT_VER_SEQ
				,	RFA_TRF.DMDT_EXPT_RQST_STS_CD
			FROM	DMT_RFA_EXPT_TRF RFA_TRF
				,	DMT_RFA_EXPT_TRF_PROG RFA_TRF_PROG
				,	DMT_RFA_EXPT_TRF_PROG RFA_TRF_PROG2
			WHERE RFA_TRF.RFA_EXPT_DAR_NO 		= RFA_TRF_PROG.RFA_EXPT_DAR_NO
		      AND RFA_TRF.RFA_EXPT_MAPG_SEQ 	= RFA_TRF_PROG.RFA_EXPT_MAPG_SEQ
		      AND RFA_TRF.RFA_EXPT_VER_SEQ 		= RFA_TRF_PROG.RFA_EXPT_VER_SEQ
		      AND RFA_TRF.RFA_EXPT_DAR_NO 		= RFA_TRF_PROG2.RFA_EXPT_DAR_NO
		      AND RFA_TRF.RFA_EXPT_MAPG_SEQ 	= RFA_TRF_PROG2.RFA_EXPT_MAPG_SEQ
		      AND RFA_TRF.RFA_EXPT_VER_SEQ 		= RFA_TRF_PROG2.RFA_EXPT_VER_SEQ
		      AND RFA_TRF.DMDT_EXPT_RQST_STS_CD IN ('A','C','J','O')
		      AND RFA_TRF.UPD_DT BETWEEN TO_DATE(@[fm_dt], 'YYYY-MM-DD') AND TO_DATE(@[to_dt], 'YYYY-MM-DD') + 0.99999
		      AND RFA_TRF_PROG.PROG_SEQ 		= 
				(
					SELECT	/*+ INDEX_DESC(DMT_RFA_EXPT_TRF_PROG XPKDMT_RFA_EXPT_TRF_PROG) */PROG_SEQ
					FROM	DMT_RFA_EXPT_TRF_PROG
					WHERE	RFA_EXPT_DAR_NO 		= RFA_TRF_PROG.RFA_EXPT_DAR_NO
						AND RFA_EXPT_MAPG_SEQ 		= RFA_TRF_PROG.RFA_EXPT_MAPG_SEQ
						AND RFA_EXPT_VER_SEQ 		= RFA_TRF_PROG.RFA_EXPT_VER_SEQ
						AND	PROG_OFC_CD IN
							(
								#foreach( $ofc_cd in ${ofc_cd_list} )
									#if($velocityCount < $ofc_cd_list.size()) '$ofc_cd', #else '$ofc_cd' #end
								#end
							)
						AND DMDT_EXPT_RQST_STS_CD 	IN ('A','C','J','O')
						AND ROWNUM 					= 1 
				)
		      AND RFA_TRF_PROG2.PROG_SEQ 		= 
				(
					SELECT	/*+ INDEX_DESC(DMT_RFA_EXPT_TRF_PROG XPKDMT_RFA_EXPT_TRF_PROG) */PROG_SEQ
					FROM	DMT_RFA_EXPT_TRF_PROG
					WHERE	RFA_EXPT_DAR_NO 		= RFA_TRF_PROG.RFA_EXPT_DAR_NO
						AND RFA_EXPT_MAPG_SEQ 		= RFA_TRF_PROG.RFA_EXPT_MAPG_SEQ
						AND RFA_EXPT_VER_SEQ 		= RFA_TRF_PROG.RFA_EXPT_VER_SEQ
						AND DMDT_EXPT_RQST_STS_CD 	= 'R'
						AND ROWNUM 					= 1 
				)
		) TTL
	,	PRI_RP_HDR RP_HDR
	,	PRI_RP_MN RP_MN
	,	DMT_RFA_EXPT_TRF_DTL RFA_TRF_DTL

	#if(${group_by} == 'CVRG')
	,	DMT_RFA_EXPT_CVRG_CMB RFA_CVRG
	#end

	,	MDM_CUSTOMER CUST
	,	COM_INTG_CD_DTL CD_DTL

WHERE	TTL.PROP_NO 			= RP_HDR.PROP_NO
	AND RP_HDR.PROP_NO 			= RP_MN.PROP_NO
	AND RP_MN.AMDT_SEQ 			= 
		(
			SELECT 	/*+ INDEX_DESC(PRI_RP_MN XPKPRI_RP_MN) */ AMDT_SEQ
			FROM 	PRI_RP_MN
			WHERE 	PROP_NO = RP_MN.PROP_NO
				AND ROWNUM 	= 1 
	)
	AND RP_MN.CTRT_CUST_CNT_CD 	= CUST.CUST_CNT_CD
	AND RP_MN.CTRT_CUST_SEQ 	= CUST.CUST_SEQ

	#if(${cust_cd} != '')
	AND RP_MN.CTRT_CUST_CNT_CD = SUBSTR(@[cust_cd], 0, 2) AND RP_MN.CTRT_CUST_SEQ = SUBSTR(@[cust_cd], 3)
	#end

   AND TTL.RFA_EXPT_DAR_NO 			= RFA_TRF_DTL.RFA_EXPT_DAR_NO
   AND TTL.RFA_EXPT_MAPG_SEQ 		= RFA_TRF_DTL.RFA_EXPT_MAPG_SEQ
   AND TTL.RFA_EXPT_VER_SEQ 		= RFA_TRF_DTL.RFA_EXPT_VER_SEQ
   AND TTL.DMDT_EXPT_RQST_STS_CD 	= CD_DTL.INTG_CD_VAL_CTNT
   AND CD_DTL.INTG_CD_ID 			= 'CD02069'



	#if(${group_by} == 'CVRG')
	AND RFA_TRF_DTL.DMDT_TRF_CD IN (
		#foreach( $trf_cd in ${trf_cd_list} )
			#if($velocityCount < $trf_cd_list.size()) '$trf_cd', #else '$trf_cd' #end
		#end
	)
	AND RFA_TRF_DTL.RFA_EXPT_DAR_NO 	= RFA_CVRG.RFA_EXPT_DAR_NO
	AND RFA_TRF_DTL.RFA_EXPT_MAPG_SEQ 	= RFA_CVRG.RFA_EXPT_MAPG_SEQ
	AND RFA_TRF_DTL.RFA_EXPT_VER_SEQ 	= RFA_CVRG.RFA_EXPT_VER_SEQ
   	AND RFA_TRF_DTL.RFA_RQST_DTL_SEQ 	= RFA_CVRG.RFA_RQST_DTL_SEQ
	AND RFA_CVRG.CVRG_CMB_SEQ 			= 
		(
			SELECT	/*+ INDEX_ASC(DMT_RFA_EXPT_CVRG_CMB XPKDMT_RFA_EXPT_CVRG_CMB) */ CVRG_CMB_SEQ
			FROM	DMT_RFA_EXPT_CVRG_CMB
			WHERE	RFA_EXPT_DAR_NO 	= RFA_CVRG.RFA_EXPT_DAR_NO
				AND	RFA_EXPT_MAPG_SEQ 	= RFA_CVRG.RFA_EXPT_MAPG_SEQ
				AND RFA_EXPT_VER_SEQ 	= RFA_CVRG.RFA_EXPT_VER_SEQ
				AND RFA_RQST_DTL_SEQ 	= RFA_CVRG.RFA_RQST_DTL_SEQ
				AND ROWNUM 				= 1
		)
	#end

ORDER BY UPD_DT, DAR_NO #if(${group_by} == 'CVRG'),	DTL_SEQ, CVRG_SEQ#end			]]></sql>
			<params>
				<param name="fm_dt" type="12" value="" out="N"/>
				<param name="to_dt" type="12" value="" out="N"/>
				<param name="cust_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
