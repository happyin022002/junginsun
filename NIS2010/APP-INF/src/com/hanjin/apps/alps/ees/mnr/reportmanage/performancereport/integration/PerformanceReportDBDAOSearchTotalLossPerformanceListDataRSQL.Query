<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="PerformanceReportDBDAOSearchTotalLossPerformanceListDataRSQL">
			<desc><![CDATA[searchTotalLossPerformanceListData
----------------------------------------------------------
2012.02.27 신혜정 [CHM-201216419] Payer 기준으로 조회할 수 있는 조건 추가 구현(payer code, payer type 조건 추가)
2012.03.05 신혜정 [선처리] Lessor 코드 조회 보완
2013.02.13 조경완 [CHM-201322896-01] ALPS MNR-Total Loss Logic 검토 및 수정 요청
2013.06.20 조경완 [CHM-201324955-01] ALPS MNR-TOTAL-Total Loss Performance 조회 시, complete 건 조회 에러 요청
2013.12.16 최덕우 [CHM-201328048] ALPS-MNR-Total Loss 모듈에 문제점 검토 및 logic 수정 요청
2014-01-08 Jonghee HAN [CHM-201328248] Performance조회시 Recovery 금액 반영 수정 요청
2014-02-17 Jonghee HAN WITH PARAM 조회 조건 추가 FPMC 향상
2015-06-15 박정민 [CHM-201536250] [CSR전환] Total Loss Performance 데이터 검증 요청
                 Responsible OFC 미입력건 Req OFC로 대체 하던 내용 수정
                 RHQ, OFC 모두 RES OFC, REQ OFC별로 구분하여 검색하도록 수정
2015-10-01 박정민 [CHM-201538166] 3자 구상 실적에 local currency 추가 요청 3rd Party및 Disposal항목에 Currency Code 및 USD변환 금액 추가
----------------------------------------------------------]]></desc>
			<sql><![CDATA[
WITH CLT_PARAM 
AS (SELECT MTRD.TTL_LSS_NO, MTRD.TTL_LSS_DTL_SEQ, MTRD.MNR_INV_TP_CD, MTLC.CLT_AMT, MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(TO_CHAR(MTRH.TTL_LSS_DT, 'YYYYMM'), MTLC.CURR_CD, 'USD', MTLC.CLT_AMT) CLT_USD_AMT, MTLC.CURR_CD CLT_CURR_CD
      FROM MNR_TTL_LSS_RQST_HDR MTRH, MNR_TTL_LSS_RQST_DTL MTRD, MNR_TTL_LSS_CLT MTLC
     WHERE MTRH.TTL_LSS_NO = MTRD.TTL_LSS_NO
       AND MTRD.TTL_LSS_NO = MTLC.TTL_LSS_NO
       AND MTRD.TTL_LSS_DTL_SEQ IN MTLC.TTL_LSS_DTL_SEQ
    #if (${rhq} != 'A' && ${rhq} != '')
		#if (${in_office_tp} == 'A')
			AND (MNR_COMMON_PKG.MNR_GET_RHQ_OFC_FNC(MTRH.RQST_OFC_CD)  = @[rhq] OR MNR_COMMON_PKG.MNR_GET_RHQ_OFC_FNC(MTRH.RESPB_OFC_CD)  = @[rhq])
		#elseif (${in_office_tp} == 'S')
			AND MNR_COMMON_PKG.MNR_GET_RHQ_OFC_FNC(MTRH.RESPB_OFC_CD)  = @[rhq]
		#elseif (${in_office_tp} == 'Q')
			AND MNR_COMMON_PKG.MNR_GET_RHQ_OFC_FNC(MTRH.RQST_OFC_CD)  = @[rhq]
		#end
    #end
    #if (${eq_kind} != 'A')
       AND MTRD.EQ_KND_CD  = @[eq_kind]
    #end
	#if (${in_office_tp} == 'A')
    	#if (${ofc_cd} != 'A' && ${ofc_cd} != '')
       AND (MTRH.RQST_OFC_CD = @[ofc_cd] OR MTRH.RESPB_OFC_CD = @[ofc_cd])
    	#end
	#elseif (${in_office_tp} == 'S')
		#if (${ofc_cd} != 'A' && ${ofc_cd} != '')
       AND MTRH.RESPB_OFC_CD = @[ofc_cd]
		#end
	#elseif (${in_office_tp} == 'Q')
		#if (${ofc_cd} != 'A' && ${ofc_cd} != '')
       AND MTRH.RQST_OFC_CD = @[ofc_cd]
		#end
	#end
    #if (${in_search_dt_tp} == 'R')
       AND MTRH.CRE_DT BETWEEN GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd],TO_DATE(@[fm_dt], 'yyyy-mm-dd'),MNR_COMMON_PKG.MNR_GET_HOOFC_FNC()) AND GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd],TO_DATE(@[to_dt], 'yyyy-mm-dd'),MNR_COMMON_PKG.MNR_GET_HOOFC_FNC())+0.99999    
    #elseif (${in_search_dt_tp} == 'C')
       AND MTRH.TTL_LSS_DT BETWEEN GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd],TO_DATE(@[fm_dt], 'yyyy-mm-dd'),MNR_COMMON_PKG.MNR_GET_HOOFC_FNC()) AND GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd],TO_DATE(@[to_dt], 'yyyy-mm-dd'),MNR_COMMON_PKG.MNR_GET_HOOFC_FNC())+0.99999
    #else  
       AND MTRD.TTL_LSS_CMPL_DT BETWEEN GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd],TO_DATE(@[fm_dt], 'yyyy-mm-dd'),MNR_COMMON_PKG.MNR_GET_HOOFC_FNC()) AND GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd],TO_DATE(@[to_dt], 'yyyy-mm-dd'),MNR_COMMON_PKG.MNR_GET_HOOFC_FNC())+0.99999
    #end

    #if (${in_days} != '')
      AND MTRH.TTL_LSS_DT < ( GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd], SYSDATE, MNR_COMMON_PKG.MNR_GET_HOOFC_FNC()) - @[in_days] )
      AND MTRD.TTL_LSS_CMPL_DT IS NULL
    #end
    
    #if (${in_status_tp} != '')
       AND MTRH.TTL_LSS_STS_CD IN (
        #foreach ($user_inStatusTps IN ${inStatusTps})
        #if($velocityCount < $inStatusTps.size())
            '$user_inStatusTps',
          #else
            '$user_inStatusTps'
          #end
        #end
        )
    #end

    #if(${statusPandC} == 'P')
        AND MTRD.TTL_LSS_CMPL_DT IS NULL
    #elseif(${statusPandC} == 'C')
        AND MTRD.TTL_LSS_CMPL_DT IS NOT NULL
    #end

    #if (${eq_no} != '')
       AND MTRD.RQST_EQ_NO IN (
        #foreach ($user_eqNos IN ${eqNos})
          #if($velocityCount < $eqNos.size())
            '$user_eqNos',
          #else
            '$user_eqNos'
          #end
        #end			  
      )
    #end
    #if (${total_loss_no} != '')
       AND MTRH.TTL_LSS_NO IN (
        #foreach ($user_totalLossNos IN ${totalLossNos})
          #if($velocityCount < $totalLossNos.size())
            '$user_totalLossNos',
          #else
            '$user_totalLossNos'
          #end
        #end			  
      )
    #end		

	#if(${rsn_cd_all_flg} != 'Y')
    #if (${rsn_cd} != 'A' || ${rsn_cd} != '')
       AND MTRH.TTL_LSS_RSN_CD IN(
		#foreach ($user_rsnCds IN ${rsnCds})
          #if($velocityCount < $rsnCds.size())
            '$user_rsnCds',
          #else
            '$user_rsnCds'
          #end
        #end			  
      )
    #end		
	#end

    #if (${ttl_lss_dtl_rsn_cd} != 'A')
       AND MTRH.TTL_LSS_DTL_RSN_CD = @[ttl_lss_dtl_rsn_cd]
    #end
    
	#if(${close_tp_all_flg} != 'Y')
    #if (${ttl_lss_cmpl_cd} != 'A' || ${ttl_lss_cmpl_cd} != '')
       AND (MTRD.TTL_LSS_CMPL_CD IN(
		#foreach ($user_ttlLssCmplCds IN ${ttlLssCmplCds})
          #if($velocityCount < $ttlLssCmplCds.size())
            '$user_ttlLssCmplCds',
          #else
            '$user_ttlLssCmplCds'
          #end
        #end			  
      ) OR MTRD.TTL_LSS_CMPL_CD IS NULL)
    #end		
	#end    

	#if (${payer_code} != '')
       AND MTRD.MNR_PRNR_SEQ = @[payer_code]
	#end
    #if (${usa_edi_cd} != '')
       AND MTRD.USA_EDI_CD IN (
        #foreach ($user_usaEdiCds IN ${usaEdiCds})
          #if($velocityCount < $usaEdiCds.size())
            '$user_usaEdiCds',
          #else
            '$user_usaEdiCds'
          #end
        #end			  
      )
    #end
	#if (${buyer_code} != '')
       AND MTRD.TTL_LSS_BUYR_SEQ = @[buyer_code]
	#end
    UNION ALL   
    SELECT MTRD.TTL_LSS_NO, MTRD.TTL_LSS_DTL_SEQ, MTRD.MNR_INV_TP_CD, BOD.CLT_FRT_AMT + BOD.CLT_TAX_AMT CLT_AMT, MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(TO_CHAR(MTRH.TTL_LSS_DT, 'YYYYMM'), BOD.BL_CURR_CD, 'USD', BOD.CLT_FRT_AMT + BOD.CLT_TAX_AMT) CLT_USD_AMT, BOD.BL_CURR_CD CLT_CURR_CD
      FROM MNR_TTL_LSS_RQST_HDR MTRH, MNR_TTL_LSS_RQST_DTL MTRD, BKG_OTS_DTL BOD
     WHERE MTRH.TTL_LSS_NO = MTRD.TTL_LSS_NO
       AND MTRD.INV_NO = BOD.CLT_BL_NO
       AND MTRD.MNR_INV_TP_CD = 'DS'
    #if (${rhq} != 'A' && ${rhq} != '')
		#if (${in_office_tp} == 'A')
			AND (MNR_COMMON_PKG.MNR_GET_RHQ_OFC_FNC(MTRH.RQST_OFC_CD)  = @[rhq] OR MNR_COMMON_PKG.MNR_GET_RHQ_OFC_FNC(MTRH.RESPB_OFC_CD)  = @[rhq])
		#elseif (${in_office_tp} == 'S')
			AND MNR_COMMON_PKG.MNR_GET_RHQ_OFC_FNC(MTRH.RESPB_OFC_CD)  = @[rhq]
		#elseif (${in_office_tp} == 'Q')
			AND MNR_COMMON_PKG.MNR_GET_RHQ_OFC_FNC(MTRH.RQST_OFC_CD)  = @[rhq]
		#end
    #end
    #if (${eq_kind} != 'A')
       AND MTRD.EQ_KND_CD  = @[eq_kind]
    #end
	#if (${in_office_tp} == 'A')
    	#if (${ofc_cd} != 'A' && ${ofc_cd} != '')
       AND (MTRH.RQST_OFC_CD = @[ofc_cd] OR MTRH.RESPB_OFC_CD = @[ofc_cd])
    	#end
	#elseif (${in_office_tp} == 'S')
		#if (${ofc_cd} != 'A' && ${ofc_cd} != '')
       AND MTRH.RESPB_OFC_CD = @[ofc_cd]
		#end
	#elseif (${in_office_tp} == 'Q')
		#if (${ofc_cd} != 'A' && ${ofc_cd} != '')
       AND MTRH.RQST_OFC_CD = @[ofc_cd]
		#end
	#end
    #if (${in_search_dt_tp} == 'R')
       AND MTRH.CRE_DT BETWEEN GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd],TO_DATE(@[fm_dt], 'yyyy-mm-dd'),MNR_COMMON_PKG.MNR_GET_HOOFC_FNC()) AND GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd],TO_DATE(@[to_dt], 'yyyy-mm-dd'),MNR_COMMON_PKG.MNR_GET_HOOFC_FNC())+0.99999    
    #elseif (${in_search_dt_tp} == 'C')
       AND MTRH.TTL_LSS_DT BETWEEN GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd],TO_DATE(@[fm_dt], 'yyyy-mm-dd'),MNR_COMMON_PKG.MNR_GET_HOOFC_FNC()) AND GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd],TO_DATE(@[to_dt], 'yyyy-mm-dd'),MNR_COMMON_PKG.MNR_GET_HOOFC_FNC())+0.99999
    #else  
       AND MTRD.TTL_LSS_CMPL_DT BETWEEN GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd],TO_DATE(@[fm_dt], 'yyyy-mm-dd'),MNR_COMMON_PKG.MNR_GET_HOOFC_FNC()) AND GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd],TO_DATE(@[to_dt], 'yyyy-mm-dd'),MNR_COMMON_PKG.MNR_GET_HOOFC_FNC())+0.99999
    #end

    #if (${in_days} != '')
      AND MTRH.TTL_LSS_DT < ( GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd], SYSDATE, MNR_COMMON_PKG.MNR_GET_HOOFC_FNC()) - @[in_days] )
      AND MTRD.TTL_LSS_CMPL_DT IS NULL
    #end

    #if (${in_status_tp} != '')
       AND MTRH.TTL_LSS_STS_CD IN (
        #foreach ($user_inStatusTps IN ${inStatusTps})
        #if($velocityCount < $inStatusTps.size())
            '$user_inStatusTps',
          #else
            '$user_inStatusTps'
          #end
        #end
        )
    #end
    
    #if(${statusPandC} == 'P')
        AND MTRD.TTL_LSS_CMPL_DT IS NULL
    #elseif(${statusPandC} == 'C')
        AND MTRD.TTL_LSS_CMPL_DT IS NOT NULL
    #end

    #if (${eq_no} != '')
       AND MTRD.RQST_EQ_NO IN (
        #foreach ($user_eqNos IN ${eqNos})
          #if($velocityCount < $eqNos.size())
            '$user_eqNos',
          #else
            '$user_eqNos'
          #end
        #end			  
      )
    #end
    #if (${total_loss_no} != '')
       AND MTRH.TTL_LSS_NO IN (
        #foreach ($user_totalLossNos IN ${totalLossNos})
          #if($velocityCount < $totalLossNos.size())
            '$user_totalLossNos',
          #else
            '$user_totalLossNos'
          #end
        #end			  
      )
    #end		

	#if(${rsn_cd_all_flg} != 'Y')
	#if (${rsn_cd} != 'A' || ${rsn_cd} != '')
       AND MTRH.TTL_LSS_RSN_CD IN(
		#foreach ($user_rsnCds IN ${rsnCds})
          #if($velocityCount < $rsnCds.size())
            '$user_rsnCds',
          #else
            '$user_rsnCds'
          #end
        #end			  
      )
    #end
	#end

    #if (${ttl_lss_dtl_rsn_cd} != 'A')
       AND MTRH.TTL_LSS_DTL_RSN_CD = @[ttl_lss_dtl_rsn_cd]
    #end
    
	#if(${close_tp_all_flg} != 'Y')
    #if (${ttl_lss_cmpl_cd} != 'A' || ${ttl_lss_cmpl_cd} != '')
       AND (MTRD.TTL_LSS_CMPL_CD IN(
		#foreach ($user_ttlLssCmplCds IN ${ttlLssCmplCds})
          #if($velocityCount < $ttlLssCmplCds.size())
            '$user_ttlLssCmplCds',
          #else
            '$user_ttlLssCmplCds'
          #end
        #end			  
      ) OR MTRD.TTL_LSS_CMPL_CD IS NULL)
    #end
	#end

	#if (${payer_code} != '')
       AND MTRD.MNR_PRNR_SEQ = @[payer_code]
	#end
    #if (${usa_edi_cd} != '')
       AND MTRD.USA_EDI_CD IN (
        #foreach ($user_usaEdiCds IN ${usaEdiCds})
          #if($velocityCount < $usaEdiCds.size())
            '$user_usaEdiCds',
          #else
            '$user_usaEdiCds'
          #end
        #end			  
      )
    #end
	#if (${buyer_code} != '')
       AND MTRD.TTL_LSS_BUYR_SEQ = @[buyer_code]
	#end
)
SELECT 
   DECODE(TTS.TTL_LSS_NO,'','',DENSE_RANK() OVER (PARTITION BY TSV.MNR_INV_TP_CD ORDER BY TTS.TTL_LSS_NO ASC)) TMPSEQ
  ,DECODE(TTS.TTL_LSS_NO,'','Total',TTS.TTL_LSS_NO) TTL_LSS_NO
  ,DECODE(TTS.TTL_LSS_NO,'','',TTS.RQST_OFC_CD) RQST_OFC_CD
  ,DECODE(TTS.TTL_LSS_NO,'','',TTS.APRO_OFC_CD) APRO_OFC_CD
  ,DECODE(TTS.TTL_LSS_NO,'','',TTS.RESPB_OFC_CD) RESPB_OFC_CD
  ,DECODE(TTS.TTL_LSS_NO,'','',TTS.TTL_LSS_DT)  TTL_LSS_DT
  ,DECODE(TTS.TTL_LSS_NO,'','',TTS.RQST_DT) RQST_DT
  ,DECODE(TTS.TTL_LSS_NO,'','',TTS.TTL_LSS_STS_NM) TTL_LSS_STS_NM
  ,DECODE(TTS.TTL_LSS_NO,'','',NVL(TTS.TTL_LSS_CFM_DT,'Proccessing')) TTL_LSS_CFM_DT
  ,DECODE(TTS.TTL_LSS_NO,'','',TTS.TTL_LSS_RSN_NM) TTL_LSS_RSN_NM
  ,DECODE(TTS.TTL_LSS_NO,'','',TTS.TTL_LSS_DTL_RSN_NM) TTL_LSS_DTL_RSN_NM
  ,DECODE(TTS.TTL_LSS_NO,'','',TSV.RQST_EQ_NO) RQST_EQ_NO
  ,DECODE(TTS.TTL_LSS_NO,'','',(SELECT MNR_CD_DESC FROM  MNR_GEN_CD WHERE PRNT_CD_ID = 'CD00072' AND MNR_CD_ID = TSV.TTL_LSS_CMPL_CD)) TTL_LSS_DTL_CMPL_NM
  ,DECODE(TTS.TTL_LSS_NO,'','',TO_CHAR(TSV.TTL_LSS_CMPL_DT, 'yyyy-mm-dd')) TTL_LSS_DTL_CMPL_DT
  ,TTS.DV_EQ_QTY
  ,TTS.DV_DV_VAL
  ,TTS.DV_EXP
  ,TTS.DV_BAL
  ,TTS.TP_EQ_QTY
  ,TTS.TP_DV_VAL
  ,TTS.TP_CURR_CD
  ,TTS.TP_EXP
  ,TTS.TP_USD_EXP
  ,TTS.TP_BAL
  ,TTS.DS_EQ_QTY
  ,TTS.DS_DV_VAL
  ,TTS.DS_CURR_CD
  ,TTS.DS_EXP
  ,TTS.DS_USD_EXP
  ,TTS.DS_BAL
  ,TTS.SC_EQ_QTY
  ,TTS.SC_DV_VAL
  ,TTS.SC_EXP
  ,TTS.SC_BAL
  ,TTS.IR_EQ_QTY
  ,TTS.IR_DV_VAL
  ,TTS.IR_EXP
  ,TTS.IR_BAL
  ,TTS.CLT_AMT
  ,DECODE(TTS.TTL_LSS_NO,'','',TTS.TTL_LSS_N3PTY_TP_CD) TTL_LSS_N3PTY_TP_CD
  ,NVL(TTS.USA_EDI_CD, ' ') USA_EDI_CD
  ,NVL(DECODE(TTS.TTL_LSS_N3PTY_TP_CD, 'S', (SELECT VNDR_LGL_ENG_NM
                                            FROM MDM_VENDOR
                                          WHERE VNDR_SEQ = TTS.MNR_PRNR_SEQ
                                            AND NVL(DELT_FLG, 'N') <> 'Y') 
                                  , 'C', (SELECT CUST_LGL_ENG_NM
                                            FROM MDM_CUSTOMER
                                          WHERE CUST_CNT_CD = TTS.MNR_PRNR_CNT_CD
                                            AND CUST_SEQ = TTS.MNR_PRNR_SEQ)
                                  ,  DECODE(TTS.MNR_INV_TP_CD,'DV',(SELECT VNDR_LGL_ENG_NM
                                                                      FROM MDM_VENDOR
                                                                    WHERE VNDR_SEQ = TTS.MNR_PRNR_SEQ
                                                                      AND NVL(DELT_FLG, 'N') <> 'Y')
                                  ,'')
  ), ' ') PAYER_NAME  
  ,(SELECT NVL((SELECT VNDR_LGL_ENG_NM
  	FROM MDM_VENDOR
    WHERE VNDR_SEQ = TTS.TTL_LSS_BUYR_SEQ
    	AND NVL(DELT_FLG, 'N') <> 'Y'), ' ')
   FROM DUAL      
  ) BUYER_NAME  
FROM MNR_TTL_LSS_RQST_DTL TSV,
(
    SELECT
         TH.TTL_LSS_NO
        ,MAX(TH.RQST_OFC_CD) RQST_OFC_CD
        ,MAX(TH.APRO_OFC_CD) APRO_OFC_CD
        ,MAX(TH.RESPB_OFC_CD) RESPB_OFC_CD
        ,TO_CHAR(MAX(TH.TTL_LSS_DT), 'yyyy-mm-dd') TTL_LSS_DT
        ,TO_CHAR(GLOBALDATE_PKG.TIME_CONV_OFC_FNC(MNR_COMMON_PKG.MNR_GET_HOOFC_FNC(),MAX(TH.RQST_DT),@[user_ofc_cd]), 'yyyy-mm-dd') RQST_DT
        ,MAX((SELECT MNR_CD_DP_DESC
              FROM MNR_GEN_CD
              WHERE PRNT_CD_ID='CD00039'
                AND MNR_CD_ID=TH.TTL_LSS_STS_CD
            )) AS TTL_LSS_STS_NM
        ,TO_CHAR(DECODE(MAX(TH.TTL_LSS_STS_CD),'HE',GLOBALDATE_PKG.TIME_CONV_OFC_FNC(MNR_COMMON_PKG.MNR_GET_HOOFC_FNC(),MAX(TH.TTL_LSS_CFM_DT),@[user_ofc_cd]),null), 'yyyy-mm-dd') TTL_LSS_CFM_DT
        ,MAX((SELECT MNR_CD_DP_DESC
              FROM MNR_GEN_CD
              WHERE PRNT_CD_ID='TR'
                AND MNR_CD_ID=TH.TTL_LSS_RSN_CD
            )) AS TTL_LSS_RSN_NM
        ,MAX((SELECT MNR_CD_DP_DESC
              FROM MNR_GEN_CD
              WHERE PRNT_CD_ID=TH.TTL_LSS_RSN_CD
                AND MNR_CD_ID=TH.TTL_LSS_DTL_RSN_CD
            )) AS TTL_LSS_DTL_RSN_NM
        ,NVL(SUM(DECODE(TD.MNR_INV_TP_CD, 'DV', 1)),0) DV_EQ_QTY
		,NVL(SUM(DECODE(TD.MNR_INV_TP_CD, 'DV', NVL(TD.DPC_VAL_AMT,0))),0) DV_DV_VAL
		,NVL(SUM(DECODE(TD.MNR_INV_TP_CD, 'DV', NVL(TTL_LSS_BIL_AMT,0))),0) DV_EXP
		,NVL(SUM(DECODE(TD.MNR_INV_TP_CD, 'DV', NVL(TD.DPC_VAL_AMT,0))),0) - NVL(SUM(DECODE(TD.MNR_INV_TP_CD, 'DV', NVL(TTL_LSS_BIL_AMT,0))),0) DV_BAL
        ,NVL(SUM(DECODE(CP.MNR_INV_TP_CD, 'TP', 1, 0)), 0) TP_EQ_QTY
        ,NVL(SUM(DECODE(TD.MNR_INV_TP_CD, 'TP', NVL(TD.DPC_VAL_AMT,0))), 0) TP_DV_VAL
        ,NVL(MAX(DECODE(CP.MNR_INV_TP_CD, 'TP', NVL(CP.CLT_CURR_CD,''))), ' ') TP_CURR_CD
        ,NVL(SUM(DECODE(CP.MNR_INV_TP_CD, 'TP', NVL(CP.CLT_AMT,0))), 0) TP_EXP
        ,NVL(SUM(DECODE(CP.MNR_INV_TP_CD, 'TP', NVL(CP.CLT_USD_AMT,0))), 0) TP_USD_EXP
        ,NVL(SUM(DECODE(TD.MNR_INV_TP_CD, 'TP', NVL(TD.DPC_VAL_AMT,0))), 0) - NVL(SUM(DECODE(CP.MNR_INV_TP_CD, 'TP', NVL(CP.CLT_AMT,0))), 0) TP_BAL
        ,NVL(SUM(DECODE(CP.MNR_INV_TP_CD, 'DS', 1, 0)), 0) DS_EQ_QTY
        ,NVL(SUM(DECODE(TD.MNR_INV_TP_CD, 'DS', NVL(TD.DPC_VAL_AMT,0))), 0) DS_DV_VAL
        ,NVL(MAX(DECODE(CP.MNR_INV_TP_CD, 'DS', NVL(CP.CLT_CURR_CD,''))), ' ') DS_CURR_CD
        ,NVL(SUM(DECODE(CP.MNR_INV_TP_CD, 'DS', NVL(CP.CLT_AMT,0))), 0) DS_EXP
        ,NVL(SUM(DECODE(CP.MNR_INV_TP_CD, 'DS', NVL(CP.CLT_USD_AMT,0))), 0) DS_USD_EXP
        ,NVL(SUM(DECODE(TD.MNR_INV_TP_CD, 'DS', NVL(TD.DPC_VAL_AMT,0))), 0) - NVL(SUM(DECODE(CP.MNR_INV_TP_CD, 'DS', NVL(CP.CLT_AMT,0))), 0) DS_BAL
        ,NVL(SUM(DECODE(TD.MNR_INV_TP_CD, 'SC', 1)),0) SC_EQ_QTY
		,NVL(SUM(DECODE(TD.MNR_INV_TP_CD, 'SC', NVL(TD.DPC_VAL_AMT,0))),0) SC_DV_VAL
		,NVL(SUM(DECODE(TD.MNR_INV_TP_CD, 'SC', NVL(TTL_LSS_INCM_AMT,0))),0) - NVL(SUM(DECODE(TD.MNR_INV_TP_CD, 'SC', NVL(TTL_LSS_EXPN_AMT,0))),0) SC_EXP
		,NVL(SUM(DECODE(TD.MNR_INV_TP_CD, 'SC', NVL(TD.DPC_VAL_AMT,0))),0) - NVL(SUM(DECODE(TD.MNR_INV_TP_CD, 'DV', NVL(TTL_LSS_BIL_AMT,0))),0) SC_BAL
		,NVL(SUM(DECODE(TD.MNR_INV_TP_CD, 'IR', 1)),0) IR_EQ_QTY
		,NVL(SUM(DECODE(TD.MNR_INV_TP_CD, 'IR', NVL(TD.DPC_VAL_AMT,0))),0) IR_DV_VAL
		,NVL(SUM(DECODE(TD.MNR_INV_TP_CD, 'IR', NVL(TTL_LSS_EXPN_AMT,0))),0) IR_EXP
		,NVL(SUM(DECODE(TD.MNR_INV_TP_CD, 'IR', NVL(TD.DPC_VAL_AMT,0))),0) - NVL(SUM(DECODE(TD.MNR_INV_TP_CD, 'DV', NVL(TTL_LSS_BIL_AMT,0))),0) IR_BAL 
        ,MAX(
             (SELECT
                 SUM(NVL(BOD.CLT_FRT_AMT,0) + NVL(BOD.CLT_TAX_AMT,0)) 
                  + MAX((SELECT SUM(NVL(MTLC.CLT_AMT,0))
                         FROM MNR_TTL_LSS_CLT MTLC
                         WHERE TD.TTL_LSS_NO=MTLC.TTL_LSS_NO))
              FROM MNR_DISP_DTL MDD, BKG_OTS_DTL BOD 
              WHERE TD.RQST_EQ_NO      = MDD.EQ_NO(+)
                AND MDD.INV_NO      = BOD.CLT_BL_NO(+)
                AND BOD.OFC_CD(+) > ' '
                AND TD.MNR_INV_TP_CD = 'DS'
          ))  CLT_AMT  
        , MAX(TD.TTL_LSS_N3PTY_TP_CD) AS TTL_LSS_N3PTY_TP_CD   
		, MAX(TD.USA_EDI_CD) AS USA_EDI_CD
        , MAX(TD.MNR_PRNR_SEQ) AS MNR_PRNR_SEQ
        , MAX(TD.MNR_INV_TP_CD) MNR_INV_TP_CD
        , MAX(TD.MNR_PRNR_CNT_CD) MNR_PRNR_CNT_CD
		, MAX(TD.TTL_LSS_BUYR_SEQ) TTL_LSS_BUYR_SEQ
    FROM MNR_TTL_LSS_RQST_HDR TH, MNR_TTL_LSS_RQST_DTL TD,MNR_EQ_STS_V MV, CLT_PARAM CP
    WHERE  TH.TTL_LSS_NO = TD.TTL_LSS_NO
    AND TD.RQST_EQ_NO = MV.EQ_NO
    AND CP.TTL_LSS_NO(+) = TD.TTL_LSS_NO
    AND CP.TTL_LSS_DTL_SEQ(+) IN TD.TTL_LSS_DTL_SEQ
    #if (${eq_kind} != 'A')
    AND   TD.EQ_KND_CD  = @[eq_kind]
    #end
    #if (${rhq} != 'A' && ${rhq} != '')
		#if (${in_office_tp} == 'A')
			AND (MNR_COMMON_PKG.MNR_GET_RHQ_OFC_FNC(TH.RQST_OFC_CD)  = @[rhq] OR MNR_COMMON_PKG.MNR_GET_RHQ_OFC_FNC(TH.RESPB_OFC_CD)  = @[rhq])
		#elseif (${in_office_tp} == 'S')
			AND MNR_COMMON_PKG.MNR_GET_RHQ_OFC_FNC(TH.RESPB_OFC_CD)  = @[rhq]
		#elseif (${in_office_tp} == 'Q')
			AND MNR_COMMON_PKG.MNR_GET_RHQ_OFC_FNC(TH.RQST_OFC_CD)  = @[rhq]
		#end
    #end

	#if (${in_office_tp} == 'A')
    	#if (${ofc_cd} != 'A' && ${ofc_cd} != '')
    	AND   (TH.RQST_OFC_CD = @[ofc_cd] OR TH.RESPB_OFC_CD = @[ofc_cd])
    	#end
	#elseif (${in_office_tp} == 'S')
		#if (${ofc_cd} != 'A' && ${ofc_cd} != '')
		AND TH.RESPB_OFC_CD = @[ofc_cd]
		#end
	#elseif (${in_office_tp} == 'Q')
		#if (${ofc_cd} != 'A' && ${ofc_cd} != '')
		AND TH.RQST_OFC_CD = @[ofc_cd]
		#end
	#end

    #if (${in_search_dt_tp} == 'R')
        AND TH.CRE_DT BETWEEN GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd],TO_DATE(@[fm_dt], 'yyyy-mm-dd'),MNR_COMMON_PKG.MNR_GET_HOOFC_FNC()) AND GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd],TO_DATE(@[to_dt], 'yyyy-mm-dd'),MNR_COMMON_PKG.MNR_GET_HOOFC_FNC())+0.99999    
    #elseif (${in_search_dt_tp} == 'C')
      AND TH.TTL_LSS_DT BETWEEN GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd],TO_DATE(@[fm_dt], 'yyyy-mm-dd'),MNR_COMMON_PKG.MNR_GET_HOOFC_FNC()) AND GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd],TO_DATE(@[to_dt], 'yyyy-mm-dd'),MNR_COMMON_PKG.MNR_GET_HOOFC_FNC())+0.99999
    #else  
      AND TD.TTL_LSS_CMPL_DT BETWEEN GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd],TO_DATE(@[fm_dt], 'yyyy-mm-dd'),MNR_COMMON_PKG.MNR_GET_HOOFC_FNC()) AND GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd],TO_DATE(@[to_dt], 'yyyy-mm-dd'),MNR_COMMON_PKG.MNR_GET_HOOFC_FNC())+0.99999
    #end
    
    #if (${in_days} != '')
      AND TH.TTL_LSS_DT < ( GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd], SYSDATE, MNR_COMMON_PKG.MNR_GET_HOOFC_FNC()) - @[in_days] )
      AND TD.TTL_LSS_CMPL_DT IS NULL
    #end

    #if (${in_status_tp} != '')
       AND TH.TTL_LSS_STS_CD IN (
        #foreach ($user_inStatusTps IN ${inStatusTps})
        #if($velocityCount < $inStatusTps.size())
            '$user_inStatusTps',
          #else
            '$user_inStatusTps'
          #end
        #end
        )
    #end
    
    #if(${statusPandC} == 'P')
        AND TD.TTL_LSS_CMPL_DT IS NULL
    #elseif(${statusPandC} == 'C')
        AND TD.TTL_LSS_CMPL_DT IS NOT NULL
    #end

    #if (${eq_no} != '')
      AND	TD.RQST_EQ_NO IN (
        #foreach ($user_eqNos IN ${eqNos})
          #if($velocityCount < $eqNos.size())
            '$user_eqNos',
          #else
            '$user_eqNos'
          #end
        #end			  
      )
    #end
    #if (${total_loss_no} != '')
      AND	TH.TTL_LSS_NO IN (
        #foreach ($user_totalLossNos IN ${totalLossNos})
          #if($velocityCount < $totalLossNos.size())
            '$user_totalLossNos',
          #else
            '$user_totalLossNos'
          #end
        #end			  
      )
    #end	

	#if(${rsn_cd_all_flg} != 'Y')
	#if (${rsn_cd} != 'A' || ${rsn_cd} != '')
       AND TH.TTL_LSS_RSN_CD IN(
		#foreach ($user_rsnCds IN ${rsnCds})
          #if($velocityCount < $rsnCds.size())
            '$user_rsnCds',
          #else
            '$user_rsnCds'
          #end
        #end			  
      )
    #end
	#end

    #if (${ttl_lss_dtl_rsn_cd} != 'A')
    AND   TH.TTL_LSS_DTL_RSN_CD = @[ttl_lss_dtl_rsn_cd]
    #end
    #if(${close_tp_all_flg} != 'Y')
    #if (${ttl_lss_cmpl_cd} != 'A' || ${ttl_lss_cmpl_cd} != '')
       AND (TD.TTL_LSS_CMPL_CD IN(
		#foreach ($user_ttlLssCmplCds IN ${ttlLssCmplCds})
          #if($velocityCount < $ttlLssCmplCds.size())
            '$user_ttlLssCmplCds',
          #else
            '$user_ttlLssCmplCds'
          #end
        #end			  
      ) OR TD.TTL_LSS_CMPL_CD IS NULL)
    #end
	#end
    
    #if (${vndr_seq} != '')
    AND   MV.LESSOR_CD = @[vndr_seq]
    #end
	#if (${payer_code} != '')
	AND TD.MNR_PRNR_SEQ = @[payer_code]
	#end
    #if (${usa_edi_cd} != '')
      AND	TD.USA_EDI_CD IN (
        #foreach ($user_usaEdiCds IN ${usaEdiCds})
          #if($velocityCount < $usaEdiCds.size())
            '$user_usaEdiCds',
          #else
            '$user_usaEdiCds'
          #end
        #end			  
      )
    #end
	#if (${buyer_code} != '')
	AND TD.TTL_LSS_BUYR_SEQ = @[buyer_code]
	#end
    GROUP BY ROLLUP(TH.TTL_LSS_NO)
) TTS
#if (${vndr_seq} != '')
, MNR_EQ_STS_V MV
#end
WHERE TTS.TTL_LSS_NO = TSV.TTL_LSS_NO(+)
AND TSV.MNR_INV_TP_CD(+) = 'DV'
#if (${vndr_seq} != '')
AND MV.LESSOR_CD = @[vndr_seq]
AND TSV.RQST_EQ_NO = MV.EQ_NO 
#end

#if(${statusPandC} == 'P')
AND TSV.TTL_LSS_CMPL_DT(+) IS NULL
#elseif(${statusPandC} == 'C')
AND TSV.TTL_LSS_CMPL_DT(+) IS NOT NULL
#end
#if(${close_tp_all_flg} != 'Y')
#if (${ttl_lss_cmpl_cd} != 'A' || ${ttl_lss_cmpl_cd} != '')
   AND ( TSV.TTL_LSS_CMPL_CD IN(
    #foreach ($user_ttlLssCmplCds IN ${ttlLssCmplCds})
      #if($velocityCount < $ttlLssCmplCds.size())
        '$user_ttlLssCmplCds',
      #else
        '$user_ttlLssCmplCds'
      #end
    #end			  
   ) OR TSV.TTL_LSS_CMPL_CD IS NULL
   OR TTS.TTL_LSS_NO IS NULL  )
#end
#end			]]></sql>
			<params>
				<param name="rhq" type="12" value="" out="N"/>
				<param name="eq_kind" type="12" value="" out="N"/>
				<param name="ofc_cd" type="12" value="" out="N"/>
				<param name="user_ofc_cd" type="12" value="" out="N"/>
				<param name="fm_dt" type="12" value="" out="N"/>
				<param name="to_dt" type="12" value="" out="N"/>
				<param name="in_days" type="12" value="" out="N"/>
				<param name="ttl_lss_dtl_rsn_cd" type="12" value="" out="N"/>
				<param name="payer_code" type="12" value="" out="N"/>
				<param name="buyer_code" type="12" value="" out="N"/>
				<param name="vndr_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
