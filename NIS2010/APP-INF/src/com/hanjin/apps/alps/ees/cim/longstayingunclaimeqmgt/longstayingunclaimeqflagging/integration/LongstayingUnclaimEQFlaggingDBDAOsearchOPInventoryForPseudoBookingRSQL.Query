<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="LongstayingUnclaimEQFlaggingDBDAOsearchOPInventoryForPseudoBookingRSQL">
			<desc><![CDATA[OP Inventory for Pseudo Booking]]></desc>
			<sql><![CDATA[
SELECT
	   A.LVL 
    ,DECODE(A.LVL,'111110','',A.AR_HD_QTR_OFC_CD) RHQ_CD
    ,DECODE(A.LVL,'111110','',A.BKG_OFC_CD) BKG_OFC_CD
    ,DECODE(A.LVL,'000111','','111110','',A.OB_SREP_CD) OB_SREP_CD
    ,DECODE(A.LVL,'000111','','111110','',A.CUST_CD) CUST_CD
    
    ,DECODE(A.LVL,'000111','Total','111110','Total',A.CUST_NM) CUST_NM
    ,DECODE(A.LVL,'000111','', A.CNTR_TPSZ_CD) CNTR_TPSZ_CD

    ,A.TOTAL_QTY
    ,ROUND(A.TOTAL_STAY_DAYS/A.TOTAL_QTY,1) TOTAL_AVG

    ,A.OVER_QTY
    ,A.OVER_AVG
	  ,A.OVER_STAY_DAYS
  	,TO_CHAR(A.OVER_QTY/A.TOTAL_QTY*100,'990.0')||'%' OVER_RATE    
    ,A.QTY1
    ,A.AVG1
    ,A.STAY_DAYS1
    ,TO_CHAR(A.QTY1/A.TOTAL_QTY*100,'990.0')||'%' RATE1

    ,A.QTY2
    ,A.AVG2
    ,A.STAY_DAYS2
    ,TO_CHAR(A.QTY2/A.TOTAL_QTY*100,'990.0')||'%' RATE2
    
    ,A.QTY3
    ,A.AVG3
    ,A.STAY_DAYS3
    ,TO_CHAR(A.QTY3/A.TOTAL_QTY*100,'990.0')||'%' RATE3

    ,A.QTY4
    ,A.AVG4
    ,A.STAY_DAYS4
    ,TO_CHAR(A.QTY4/A.TOTAL_QTY*100,'990.0')||'%' RATE4

    ,A.QTY5
    ,A.AVG5
    ,A.STAY_DAYS5
    ,TO_CHAR(A.QTY5/A.TOTAL_QTY*100,'990.0')||'%' RATE5

    ,A.QTY6
    ,A.AVG6
    ,A.STAY_DAYS6
    ,TO_CHAR(A.QTY6/A.TOTAL_QTY*100,'990.0')||'%' RATE6

  	,A.QTY7
	  ,A.AVG7
	  ,A.STAY_DAYS7
    ,TO_CHAR(A.QTY7/A.TOTAL_QTY*100,'990.0')||'%' RATE7
FROM 
(
    SELECT 
		    A.LVL
		    ,A.AR_HD_QTR_OFC_CD
        ,A.BKG_OFC_CD
        ,A.OB_SREP_CD
        ,A.CUST_CD
        ,A.CUST_NM 
        ,A.CNTR_TPSZ_CD
        ,DECODE(A.QTY1+A.QTY2+A.QTY3+A.QTY4+A.QTY5+A.QTY6+A.QTY7,0,NULL,A.QTY1+A.QTY2+A.QTY3+A.QTY4+A.QTY5+A.QTY6+A.QTY7) TOTAL_QTY
        ,A.STAY_DAYS1+A.STAY_DAYS2+A.STAY_DAYS3+A.STAY_DAYS4+A.STAY_DAYS5+A.STAY_DAYS6+A.STAY_DAYS7 TOTAL_STAY_DAYS

		    ,A.OVER_STAY_DAYS
        ,NVL(A.OVER_QTY,0) OVER_QTY
        ,NVL(ROUND(A.OVER_STAY_DAYS/DECODE(A.OVER_QTY,0,NULL,A.OVER_QTY),1),0) OVER_AVG

        ,A.QTY1
        ,A.STAY_DAYS1
        ,NVL(ROUND(A.STAY_DAYS1/DECODE(A.QTY1,0,NULL,A.QTY1),1),0) AVG1
        
        ,A.QTY2
        ,A.STAY_DAYS2
        ,NVL(ROUND(A.STAY_DAYS2/DECODE(A.QTY2,0,NULL,A.QTY2),1),0) AVG2

        ,A.QTY3
        ,A.STAY_DAYS3
        ,NVL(ROUND(A.STAY_DAYS3/DECODE(A.QTY3,0,NULL,A.QTY3),1),0) AVG3

        ,A.QTY4
        ,A.STAY_DAYS4
        ,NVL(ROUND(A.STAY_DAYS4/DECODE(A.QTY4,0,NULL,A.QTY4),1),0) AVG4

        ,A.QTY5
        ,A.STAY_DAYS5
        ,NVL(ROUND(A.STAY_DAYS5/DECODE(A.QTY5,0,NULL,A.QTY5),1),0) AVG5

        ,A.QTY6
        ,A.STAY_DAYS6
        ,NVL(ROUND(A.STAY_DAYS6/DECODE(A.QTY6,0,NULL,A.QTY6),1),0) AVG6

		    ,A.QTY7
		    ,A.STAY_DAYS7
		    ,NVL(ROUND(A.STAY_DAYS7/DECODE(A.QTY7,0,NULL,A.QTY7),1),0) AVG7
    FROM 
	(	  	
         SELECT 
				      GROUPING(A.AR_HD_QTR_OFC_CD)||GROUPING(A.BKG_OFC_CD)||GROUPING(A.OB_SREP_CD)||GROUPING(A.CUST_CD)||GROUPING(A.CUST_NM)||GROUPING(A.CNTR_TPSZ_CD) LVL
			        , A.AR_HD_QTR_OFC_CD
              ,A.BKG_OFC_CD
              ,A.OB_SREP_CD
              ,A.CUST_CD
              ,A.CUST_NM     
	            ,A.CNTR_TPSZ_CD
	            ,NVL(ROUND(SUM(CASE WHEN STAY_DAYS >= NVL(@[stay_days],0) THEN STAY_DAYS END),1),0) OVER_STAY_DAYS
	            ,NVL(SUM(CASE WHEN STAY_DAYS >= NVL(@[stay_days],0) THEN 1 END),0) OVER_QTY
	
	            ,NVL(ROUND(SUM(CASE WHEN STAY_DAYS BETWEEN 0 AND 15 THEN STAY_DAYS END),1),0) STAY_DAYS1
	            ,NVL(SUM(CASE WHEN STAY_DAYS BETWEEN 0 AND 15 THEN 1 END),0) QTY1
	    
	            ,NVL(ROUND(SUM(CASE WHEN STAY_DAYS BETWEEN 16 AND 30 THEN STAY_DAYS END),1),0) STAY_DAYS2
	            ,NVL(SUM(CASE WHEN STAY_DAYS BETWEEN 16 AND 30 THEN 1 END),0) QTY2
	        
	            ,NVL(ROUND(SUM(CASE WHEN STAY_DAYS BETWEEN 31 AND 60 THEN STAY_DAYS END),1),0) STAY_DAYS3
	            ,NVL(SUM(CASE WHEN STAY_DAYS BETWEEN 31 AND 60 THEN 1 END),0) QTY3
	        
	            ,NVL(ROUND(SUM(CASE WHEN STAY_DAYS BETWEEN 61 AND 120 THEN STAY_DAYS END),1),0) STAY_DAYS4
	            ,NVL(SUM(CASE WHEN STAY_DAYS BETWEEN 61 AND 120 THEN 1 END),0) QTY4
	        
	            ,NVL(ROUND(SUM(CASE WHEN STAY_DAYS BETWEEN 121 AND 180 THEN STAY_DAYS END),1),0) STAY_DAYS5
	            ,NVL(SUM(CASE WHEN STAY_DAYS BETWEEN 121 AND 180 THEN 1 END),0) QTY5
	        
	            ,NVL(ROUND(SUM(CASE WHEN STAY_DAYS BETWEEN 181 AND 365 THEN STAY_DAYS END),1),0) STAY_DAYS6
	            ,NVL(SUM(CASE WHEN STAY_DAYS BETWEEN 181 AND 365 THEN 1 END),0) QTY6
	        
	            ,NVL(ROUND(SUM(CASE WHEN STAY_DAYS >366 THEN STAY_DAYS END),1),0) STAY_DAYS7
	            ,NVL(SUM(CASE WHEN STAY_DAYS >366 THEN 1 END),0) QTY7
	    
	    FROM
      (
  	     SELECT   O.AR_HD_QTR_OFC_CD
                  ,B.BKG_OFC_CD
                  ,B.OB_SREP_CD
                  ,C.CUST_CNT_CD||LPAD(C.CUST_SEQ,6,0) CUST_CD
                  ,T.CUST_LGL_ENG_NM CUST_NM
                  ,A.CNTR_TPSZ_CD
      				    ,(SELECT RPT_DP_SEQ
      	            FROM MDM_CNTR_TP_SZ E
      	            WHERE A.CNTR_TPSZ_CD = E.CNTR_TPSZ_CD) RPT_DP_SEQ    
				  ,CEIL(GLOBALDATE_PKG.TIME_LOCAL_FNC(A.RCC_CD) - A.CNMV_DT) STAY_DAYS
     	    FROM MST_CONTAINER A, BKG_BOOKING B, MDM_ORGANIZATION O, BKG_CUSTOMER C, MDM_CUSTOMER T 
    			WHERE A.ACIAC_DIV_CD = 'A'
            AND A.BKG_NO  =  B.BKG_NO
            AND B.VSL_CD LIKE '%XX'
            AND A.CNMV_STS_CD = 'OP'
            AND B.BKG_OFC_CD = O.OFC_CD
            AND C.BKG_NO = B.BKG_NO
            AND C.BKG_CUST_TP_CD = 'S'
            AND T.CUST_CNT_CD = C.CUST_CNT_CD
            AND T.CUST_SEQ    = C.CUST_SEQ
            
      #if (${rhq_cd} != '')
      		AND O.AR_HD_QTR_OFC_CD   = @[rhq_cd]
      #end

      #if (${bkg_ofc_cd} != '')
      		AND B.BKG_OFC_CD         = @[bkg_ofc_cd]
      #end

      #if (${bkg_no} != '')
      		AND A.BKG_NO             = @[bkg_no]
      #end

      #if (${cust_cd} != '')
      		AND C.CUST_CNT_CD        = SUBSTR(@[cust_cd],1,2)
      		AND LPAD(C.CUST_SEQ,6,0) = SUBSTR(@[cust_cd],3)
      #end

      #if (${cust_nm} != '')
      		AND T.CUST_LGL_ENG_NM    LIKE @[cust_nm]||'%'
      #end

      #if (${op_loc_cd} != '')
      		AND A.LOC_CD             = @[op_loc_cd]
      #end

	   ) A
		GROUP BY CUBE(A.AR_HD_QTR_OFC_CD, A.BKG_OFC_CD, A.OB_SREP_CD, A.CUST_CD, A.CUST_NM, A.CNTR_TPSZ_CD)
    ORDER BY RANK() OVER (ORDER BY A.AR_HD_QTR_OFC_CD, A.BKG_OFC_CD, A.OB_SREP_CD, A.CUST_CD)--, A.RPT_DP_SEQ
	     
	) A
  WHERE A.LVL IN ('000000', '000111', '111110', '111111' )
) A			]]></sql>
			<params>
				<param name="stay_days" type="12" value="" out="N"/>
				<param name="rhq_cd" type="12" value="" out="N"/>
				<param name="bkg_ofc_cd" type="12" value="" out="N"/>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="cust_cd" type="12" value="" out="N"/>
				<param name="cust_nm" type="12" value="" out="N"/>
				<param name="op_loc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
