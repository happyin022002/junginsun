<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="EQMatchBackNLoadFactorMgtDBDAOSearchCargoFlowMapLocTrendRSQL">
			<desc><![CDATA[[CHM-201432577] Cargo Flow Map 관련 검색 기능 개선 제안]]></desc>
			<sql><![CDATA[
WITH LV_YMD AS
(
	SELECT
	#if (${week_list} != '')
		#foreach ($user_week IN ${weekLists})
			#if($velocityCount < $weekLists.size())
            	REPLACE('$user_week','-','') AS YMW$velocityCount,
    	  	#else
				REPLACE('$user_week','-','') AS YMW$velocityCount
		  	#end
		#end
    #end
	FROM DUAL
),
LV_DATA0 AS
(
      SELECT  
              DECODE(BND,1,LOC1,2,LOC2,'') LOC1,
              DECODE(BND,1,LOC2,2,LOC1,'') LOC2,
              NVL(DSP_SEQ, 99) DSP_SEQ,
              NVL(CNTR_TPSZ_CD,'99') CNTR_TPSZ_CD,
              SUM(DECODE(BND,1,CNT,0)) CNT1,
              SUM(DECODE(BND,2,CNT,0)) CNT2,
              NVL(TGT_DT,'999912') AS TGT_DT
        FROM                      
        (
              SELECT BND,
					 DECODE(BND,1,
					 #if     (${inquiryWise1} == 'R')
								A.FM_RCC_CD ,
					 #elseif (${inquiryWise1} == 'L')
								A.FM_LCC_CD ,
					 #elseif (${inquiryWise1} == 'E')
								A.FM_ECC_CD ,
					 #elseif (${inquiryWise1} == 'S')
								A.FM_SCC_CD ,
					 #elseif (${inquiryWise1} == 'C')
								SUBSTR(A.FM_SCC_CD,1,2) ,
					 #elseif (${inquiryWise1} == 'P')
							   A.LOC_CD ,
					 #end  								
					 #if     (${inquiryWise2} == 'R')
								A.FM_RCC_CD
					 #elseif (${inquiryWise2} == 'L')
								A.FM_LCC_CD
					 #elseif (${inquiryWise2} == 'E')
								A.FM_ECC_CD
					 #elseif (${inquiryWise2} == 'S')
								A.FM_SCC_CD
					 #elseif (${inquiryWise2} == 'C')
								SUBSTR(A.FM_SCC_CD,1,2)
					 #elseif (${inquiryWise2} == 'P')
							   A.LOC_CD
					 #end 	
					 )LOC1,		
					 DECODE(BND,1,
					 #if     (${inquiryWise2} == 'R')
								A.TO_RCC_CD,
					 #elseif (${inquiryWise2} == 'L')
								A.TO_LCC_CD,
					 #elseif (${inquiryWise2} == 'E')
								A.TO_ECC_CD,
					 #elseif (${inquiryWise2} == 'S')
								A.TO_SCC_CD,
					 #elseif (${inquiryWise2} == 'C')
								SUBSTR(A.TO_SCC_CD,1,2),
					 #elseif (${inquiryWise2} == 'P')
							   A.TO_LOC_CD,
					 #end  	
					 #if     (${inquiryWise1} == 'R')
								A.TO_RCC_CD
					 #elseif (${inquiryWise1} == 'L')
								A.TO_LCC_CD
					 #elseif (${inquiryWise1} == 'E')
								A.TO_ECC_CD
					 #elseif (${inquiryWise1} == 'S')
								A.TO_SCC_CD
					 #elseif (${inquiryWise1} == 'C')
								SUBSTR(A.TO_SCC_CD,1,2)
					 #elseif (${inquiryWise1} == 'P')
							   A.TO_LOC_CD
					 #end 
					 ) LOC2, 
                     DSP_SEQ,
                     CNTR_TPSZ_CD,                             
                     SUM(CNT) CNT
                     ,TGT_DT
               FROM
                    (
                             SELECT
                                    T.LOC_CD,
                                    T.TO_LOC_CD,
                                    O1.SCC_CD FM_SCC_CD,
                                    O1.ECC_CD FM_ECC_CD,
                                    O1.LCC_CD FM_LCC_CD,
                                    O1.RCC_CD FM_RCC_CD,
                                    O2.SCC_CD TO_SCC_CD,
                                    O2.ECC_CD TO_ECC_CD,
                                    O2.LCC_CD TO_LCC_CD,
                                    O2.RCC_CD TO_RCC_CD,
                                    S.DP_SEQ DSP_SEQ,
                                    T.CNTR_TPSZ_CD,
                                    (T.OB_QTY) CNT
#if (${period} == 'W')
                                    ,SUBSTR(T.TGT_YRWK,0,6) AS TGT_DT
#elseif (${period} == 'M')
                                    ,SUBSTR(T.TGT_MVMT_DT,0,6) AS TGT_DT
#end
                               FROM CIM_BKG_MTCH_BAK_SMRY T,
                                    CIM_TP_SZ_DP_SEQ S,
                                    MDM_LOCATION     L1,
                                    MDM_EQ_ORZ_CHT   O1,
                                    MDM_LOCATION     L2,
                                    MDM_EQ_ORZ_CHT   O2
                               WHERE 1=1
#if (${period} == 'W')
                                AND T.TGT_YRWK BETWEEN @[fromz] AND @[toz]
#elseif (${period} == 'M')
                                AND T.TGT_MVMT_DT BETWEEN @[fromz] AND @[toz]
#end
                                AND T.CNTR_TPSZ_CD = S.CNTR_TPSZ_CD
                                AND T.LOC_CD       = L1.LOC_CD
                                AND L1.SCC_CD      = O1.SCC_CD
                                AND T.TO_LOC_CD    = L2.LOC_CD
                                AND L2.SCC_CD      = O2.SCC_CD
#if ( ${inquiryWise1} == 'P')
                                AND	T.CNTR_PERF_LOC_DIV_CD = 'POL'
#else
                                AND	T.CNTR_PERF_LOC_DIV_CD = 'POR'
#end
#if (${location} !='' && ${location2} =='')		
                                AND (    DECODE(@[inquiryWise1],'R',O1.RCC_CD,'L',O1.LCC_CD,'E',O1.ECC_CD,'S',O1.SCC_CD,'C',SUBSTR(O1.SCC_CD,1,2),'P',L1.LOC_CD) IN(#foreach( $key IN ${arrLocFr}) #if($velocityCount < $arrLocFr.size()) '$key', #else '$key' #end #end) 
                                      OR
                                         DECODE(@[inquiryWise1],'R',O2.RCC_CD,'L',O2.LCC_CD,'E',O2.ECC_CD,'S',O2.SCC_CD,'C',SUBSTR(O2.SCC_CD,1,2),'P',L2.LOC_CD) IN(#foreach( $key IN ${arrLocFr}) #if($velocityCount < $arrLocFr.size()) '$key', #else '$key' #end #end)
                                    )
                                
#elseif (${location} =='' && ${location2} !='')
								AND (    DECODE(@[inquiryWise2],'R',O2.RCC_CD,'L',O2.LCC_CD,'E',O2.ECC_CD,'S',O2.SCC_CD,'C',SUBSTR(O2.SCC_CD,1,2),'P',L2.LOC_CD) IN(#foreach( $key IN ${arrLocTo}) #if($velocityCount < $arrLocTo.size()) '$key', #else '$key' #end #end)                                                              
                                      OR
                                         DECODE(@[inquiryWise2],'R',O1.RCC_CD,'L',O1.LCC_CD,'E',O1.ECC_CD,'S',O1.SCC_CD,'C',SUBSTR(O1.SCC_CD,1,2),'P',L1.LOC_CD) IN(#foreach( $key IN ${arrLocTo}) #if($velocityCount < $arrLocTo.size()) '$key', #else '$key' #end #end)
                                    )
#elseif (${location} !='' && ${location2} !='')
                                AND ((    DECODE(@[inquiryWise1],'R',O1.RCC_CD,'L',O1.LCC_CD,'E',O1.ECC_CD,'S',O1.SCC_CD,'C',SUBSTR(O1.SCC_CD,1,2),'P',L1.LOC_CD) IN(#foreach( $key IN ${arrLocFr}) #if($velocityCount < $arrLocFr.size()) '$key', #else '$key' #end #end) 
                                      AND DECODE(@[inquiryWise2],'R',O2.RCC_CD,'L',O2.LCC_CD,'E',O2.ECC_CD,'S',O2.SCC_CD,'C',SUBSTR(O2.SCC_CD,1,2),'P',L2.LOC_CD) IN(#foreach( $key IN ${arrLocTo}) #if($velocityCount < $arrLocTo.size()) '$key', #else '$key' #end #end))                                                              
                                      OR
                                     (    DECODE(@[inquiryWise2],'R',O1.RCC_CD,'L',O1.LCC_CD,'E',O1.ECC_CD,'S',O1.SCC_CD,'C',SUBSTR(O1.SCC_CD,1,2),'P',L1.LOC_CD) IN(#foreach( $key IN ${arrLocTo}) #if($velocityCount < $arrLocTo.size()) '$key', #else '$key' #end #end) 
                                      AND DECODE(@[inquiryWise1],'R',O2.RCC_CD,'L',O2.LCC_CD,'E',O2.ECC_CD,'S',O2.SCC_CD,'C',SUBSTR(O2.SCC_CD,1,2),'P',L2.LOC_CD) IN(#foreach( $key IN ${arrLocFr})  #if($velocityCount < $arrLocFr.size()) '$key', #else '$key' #end #end))
                                    )
#end    
                              /* tpsz */
                			#if (${tpsz} == 'D')
                				AND  T.CNTR_TPSZ_CD IN ( 'D2','D4','D5','D7','D8','D9','DW','DX' )
                			#end
                			#if (${tpsz} == 'S')
                				AND  T.CNTR_TPSZ_CD IN ( 'O2','O4','O5','S2','S4','F2','F4','F5','A4','A2','P2','P4','T2','T4' )
               			 	#end
                			#if (${tpsz} == 'R')
                				AND  T.CNTR_TPSZ_CD IN ( 'R2','R5','R7','R9' )
                			#end
                              /* rdType */
                			#if (${rdtype} == 'E')
                                AND  T.RD_FLG = 'N'
                			#end
                			#if (${rdtype} == 'O')
                                AND  T.RD_FLG = 'Y'
                			#end
                              /* soc */
                			#if (${soc} == 'E')
                                AND  T.SOC_FLG  = 'N'
                			#end
                			#if (${soc} == 'O')
                                AND  T.SOC_FLG  = 'Y'
                			#end
                      ) A
                    , (SELECT LEVEL BND FROM DUAL CONNECT BY LEVEL<=2) B
                   WHERE 1=1      
		#if (${location} !='' && ${location2} =='')
		        AND (   BND = 1 
                      AND DECODE(@[inquiryWise1],'R',A.FM_RCC_CD,'L',A.FM_LCC_CD,'E',A.FM_ECC_CD,'S',A.FM_SCC_CD,'C',SUBSTR(A.FM_SCC_CD,1,2),'P',A.LOC_CD) IN(#foreach( $key IN ${arrLocFr})  #if($velocityCount < $arrLocFr.size()) '$key', #else '$key' #end #end)
                     OR
                       BND = 2                        
                      AND DECODE(@[inquiryWise1],'R',A.TO_RCC_CD,'L',A.TO_LCC_CD,'E',A.TO_ECC_CD,'S',A.TO_SCC_CD,'C',SUBSTR(A.TO_SCC_CD,1,2),'P',A.TO_LOC_CD) IN(#foreach( $key IN ${arrLocFr})  #if($velocityCount < $arrLocFr.size()) '$key', #else '$key' #end #end)
                   )
        #elseif (${location} =='' && ${location2} !='')
			   AND (  BND = 1 
                      AND DECODE(@[inquiryWise2],'R',A.TO_RCC_CD,'L',A.TO_LCC_CD,'E',A.TO_ECC_CD,'S',A.TO_SCC_CD,'C',SUBSTR(A.TO_SCC_CD,1,2),'P',A.TO_LOC_CD) IN(#foreach( $key IN ${arrLocTo}) #if($velocityCount < $arrLocTo.size()) '$key', #else '$key' #end #end)
                     OR
                      BND = 2 
                      AND DECODE(@[inquiryWise2],'R',A.FM_RCC_CD,'L',A.FM_LCC_CD,'E',A.FM_ECC_CD,'S',A.FM_SCC_CD,'C',SUBSTR(A.FM_SCC_CD,1,2),'P',A.LOC_CD) IN(#foreach( $key IN ${arrLocTo}) #if($velocityCount < $arrLocTo.size()) '$key', #else '$key' #end #end)
                   )
		#elseif (${location} !='' && ${location2} !='')
			   AND ((   BND = 1  
                      AND DECODE(@[inquiryWise1],'R',A.FM_RCC_CD,'L',A.FM_LCC_CD,'E',A.FM_ECC_CD,'S',A.FM_SCC_CD,'C',SUBSTR(A.FM_SCC_CD,1,2),'P',A.LOC_CD) IN(#foreach( $key IN ${arrLocFr})  #if($velocityCount < $arrLocFr.size()) '$key', #else '$key' #end #end) 
                      AND DECODE(@[inquiryWise2],'R',A.TO_RCC_CD,'L',A.TO_LCC_CD,'E',A.TO_ECC_CD,'S',A.TO_SCC_CD,'C',SUBSTR(A.TO_SCC_CD,1,2),'P',A.TO_LOC_CD) IN(#foreach( $key IN ${arrLocTo}) #if($velocityCount < $arrLocTo.size()) '$key', #else '$key' #end #end))
                     OR
                    (   BND = 2  
                      AND DECODE(@[inquiryWise2],'R',A.FM_RCC_CD,'L',A.FM_LCC_CD,'E',A.FM_ECC_CD,'S',A.FM_SCC_CD,'C',SUBSTR(A.FM_SCC_CD,1,2),'P',A.LOC_CD) IN(#foreach( $key IN ${arrLocTo}) #if($velocityCount < $arrLocTo.size()) '$key', #else '$key' #end #end) 
                      AND DECODE(@[inquiryWise1],'R',A.TO_RCC_CD,'L',A.TO_LCC_CD,'E',A.TO_ECC_CD,'S',A.TO_SCC_CD,'C',SUBSTR(A.TO_SCC_CD,1,2),'P',A.TO_LOC_CD) IN(#foreach( $key IN ${arrLocFr})  #if($velocityCount < $arrLocFr.size()) '$key', #else '$key' #end #end))
                   )
        #end   
                                   
                   GROUP BY BND
                    ,DECODE(B.BND,1,
                             #if     (${inquiryWise1} == 'R')
            							A.FM_RCC_CD ,
            				 #elseif (${inquiryWise1} == 'L')
            							A.FM_LCC_CD ,
            				 #elseif (${inquiryWise1} == 'E')
            							A.FM_ECC_CD ,
            				 #elseif (${inquiryWise1} == 'S')
            							A.FM_SCC_CD ,
            				 #elseif (${inquiryWise1} == 'C')
            							SUBSTR(A.FM_SCC_CD,1,2) ,
            				 #elseif (${inquiryWise1} == 'P')
            						   A.LOC_CD ,
            				 #end  								
							 #if     (${inquiryWise2} == 'R')
            							A.FM_RCC_CD
            				 #elseif (${inquiryWise2} == 'L')
            							A.FM_LCC_CD
            				 #elseif (${inquiryWise2} == 'E')
            							A.FM_ECC_CD
            				 #elseif (${inquiryWise2} == 'S')
            							A.FM_SCC_CD
            				 #elseif (${inquiryWise2} == 'C')
            							SUBSTR(A.FM_SCC_CD,1,2)
            				 #elseif (${inquiryWise2} == 'P')
            						   A.LOC_CD
            				 #end 	
							 ),					                                  
                             DECODE(B.BND,1,
							 #if     (${inquiryWise2} == 'R')
            							A.TO_RCC_CD,
            				 #elseif (${inquiryWise2} == 'L')
            							A.TO_LCC_CD,
            				 #elseif (${inquiryWise2} == 'E')
            							A.TO_ECC_CD,
            				 #elseif (${inquiryWise2} == 'S')
            							A.TO_SCC_CD,
            				 #elseif (${inquiryWise2} == 'C')
            							SUBSTR(A.TO_SCC_CD,1,2),
            				 #elseif (${inquiryWise2} == 'P')
            						   A.TO_LOC_CD,
            				 #end  	
                             #if     (${inquiryWise1} == 'R')
            							A.TO_RCC_CD
            				 #elseif (${inquiryWise1} == 'L')
            							A.TO_LCC_CD
            				 #elseif (${inquiryWise1} == 'E')
            							A.TO_ECC_CD
            				 #elseif (${inquiryWise1} == 'S')
            							A.TO_SCC_CD
            				 #elseif (${inquiryWise1} == 'C')
            							SUBSTR(A.TO_SCC_CD,1,2)
            				 #elseif (${inquiryWise1} == 'P')
            						   A.TO_LOC_CD
            				 #end 
							 )
                            ,DSP_SEQ
                            ,CNTR_TPSZ_CD
                            ,TGT_DT
       )                                                                         
     GROUP BY GROUPING SETS((DECODE(BND,1,LOC1,2,LOC2,''),DECODE(BND,1,LOC2,2,LOC1,''),DSP_SEQ,CNTR_TPSZ_CD,TGT_DT)
                           ,(DECODE(BND,1,LOC1,2,LOC2,''),DECODE(BND,1,LOC2,2,LOC1,''))
                          )  
),
LV_DATA1 AS
(
    SELECT
         LOC1,
         LOC2,
         DSP_SEQ,
         CNTR_TPSZ_CD,
          DECODE(BND, 1, CNT1, 2, CNT2, '') CNT 
         ,TGT_DT
         ,BND
    FROM LV_DATA0 A
        ,(SELECT LEVEL BND FROM DUAL CONNECT BY LEVEL<=2) B
)
SELECT
	'LocTrend' AS YARD_CD
    ,DECODE(BND,1,LOC1,2,LOC2,'TOTAL')    			AS LOC_CD 
    ,DECODE(BND,1,LOC2,2,LOC1,'TOTAL')    			AS VVD    
    ,DECODE(CNTR_TPSZ_CD,'99','TOTAL',CNTR_TPSZ_CD) AS TP_SZ
	,BND AS DIVISION
    ,SUM(CNT) 						  AS TOTAL
	#if (${week_list} != '')
		#foreach ($user_week IN ${weekLists})
		#set( $num = $velocityCount - 1 )
	    ,SUM(DECODE(TGT_DT,YMW$velocityCount,CNT,0)) AS QTY_$num
		#end
	#end
FROM
 LV_DATA1 A
,LV_YMD B 
WHERE 1=1
AND TGT_DT !='999912'
GROUP BY LOC1,LOC2,BND,CNTR_TPSZ_CD,DSP_SEQ
ORDER BY LOC1||LOC2||BND||DSP_SEQ			]]></sql>
			<params>
				<param name="fromz" type="12" value="" out="N"/>
				<param name="toz" type="12" value="" out="N"/>
				<param name="inquiryWise1" type="12" value="" out="N"/>
				<param name="inquiryWise2" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
