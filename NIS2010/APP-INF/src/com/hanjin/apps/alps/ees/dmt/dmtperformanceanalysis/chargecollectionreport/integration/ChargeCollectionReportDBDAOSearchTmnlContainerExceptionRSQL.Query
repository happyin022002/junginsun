<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ChargeCollectionReportDBDAOSearchTmnlContainerExceptionRSQL">
			<desc><![CDATA[ChargeCollectionReportDBDAOSearchTmnlContainerExceptionRSQL]]></desc>
			<sql><![CDATA[
SELECT BL_NO
     , VVD
     , CNTR_NO
     , CNTR_TPSZ_CD
     , OC_EVNT_DT
     , VD_EVNT_DT
     , CNMV_STS_CD
     , POL_CD
     , POD_CD
     , CNEE_NM
     , NOTY_NM
     , SC_NO
     , RFA_NO
     , DMDT_TRF_CD
     , SUBSTR(CTRT_INFO,1,INSTR(CTRT_INFO,'-',1)-1) AS INFO_CD
     , SUBSTR(CTRT_INFO,INSTR(CTRT_INFO,'-',1)+1,INSTR(CTRT_INFO,'-',1,2)-INSTR(CTRT_INFO,'-',1)-1) AS PROP_NO
     , SUBSTR(CTRT_INFO,INSTR(CTRT_INFO,'-',1,2)+1,INSTR(CTRT_INFO,'-',1,3)-INSTR(CTRT_INFO,'-',1,2)-1) AS VER_SEQ
     , SUBSTR(CTRT_INFO,INSTR(CTRT_INFO,'-',1,3)+1,INSTR(CTRT_INFO,'-',1,4)-INSTR(CTRT_INFO,'-',1,3)-1) AS GRP_SEQ
     , SUBSTR(CTRT_INFO,INSTR(CTRT_INFO,'-',1,4)+1,INSTR(CTRT_INFO,'-',1,5)-INSTR(CTRT_INFO,'-',1,4)-1) AS EXCL_SAT
     , SUBSTR(CTRT_INFO,INSTR(CTRT_INFO,'-',1,5)+1,INSTR(CTRT_INFO,'-',1,6)-INSTR(CTRT_INFO,'-',1,5)-1) AS EXCL_SUN
     , SUBSTR(CTRT_INFO,INSTR(CTRT_INFO,'-',1,6)+1,INSTR(CTRT_INFO,'-',1,7)-INSTR(CTRT_INFO,'-',1,6)-1) AS EXCL_HOLI
     , SUBSTR(CTRT_INFO,INSTR(CTRT_INFO,'-',1,7)+1,INSTR(CTRT_INFO,'-',1,8)-INSTR(CTRT_INFO,'-',1,7)-1) AS ADD_DYS
     , SUBSTR(CTRT_INFO,INSTR(CTRT_INFO,'-',1,8)+1,INSTR(CTRT_INFO,'-',1,9)-INSTR(CTRT_INFO,'-',1,8)-1) AS TTL_DYS
     , SUBSTR(CTRT_INFO,INSTR(CTRT_INFO,'-',1,9)+1,INSTR(CTRT_INFO,'-',1,10)-INSTR(CTRT_INFO,'-',1,9)-1) AS RQST_OFC_CD
     , SUBSTR(CTRT_INFO,INSTR(CTRT_INFO,'-',1,10)+1,INSTR(CTRT_INFO,'-',1,11)-INSTR(CTRT_INFO,'-',1,10)-1) AS APVL_OFC_CD
  FROM (
    SELECT DISTINCT BL_NO, 
           VVD,
           CNTR_NO,
           CNTR_TPSZ_CD,
           OC_EVNT_DT,
           VD_EVNT_DT,
           CNMV_STS_CD,
           POL_CD,
           POD_CD,
           CNEE_NM,
           NOTY_NM,
           SC_NO,
           RFA_NO,
           DECODE(DMDT_CALC_TP_CD,'C','CTIC',DECODE(DUL_EXPT_FLG,'N','DMIF','CTIC')) DMDT_TRF_CD,
           CASE WHEN RFA_NO IS NOT NULL AND SUBSTR(RFA_NO,1,3) != 'DUM'
           THEN NVL((
                        SELECT DISTINCT 
                           'RFA_DMT'||'-'||A.RFA_EXPT_APRO_NO||'-'||B.RFA_EXPT_VER_SEQ||'-'||B.RFA_RQST_DTL_SEQ||'-'||B.XCLD_SAT_FLG||'-'||B.XCLD_SUN_FLG||'-'||B.XCLD_HOL_FLG
                                    ||'-'||NVL(B.ADD_DYS,0)||'-'||NVL(B.TTL_DYS,0)||'-'|| A.RQST_OFC_CD ||'-'|| A.APRO_OFC_CD ||'-'||' '
                        FROM DMT_CHG_BKG_CNTR T1, DMT_CHG_CALC T2, DMT_RFA_EXPT_TRF_DTL B, DMT_RFA_EXPT_TRF A
                        WHERE 1=1
                        AND T1.BKG_NO = AA.BKG_NO
                        AND T1.CNTR_NO = AA.CNTR_NO
                        AND T1.SYS_AREA_GRP_ID = T2.SYS_AREA_GRP_ID
                        AND T1.CNTR_NO = T2.CNTR_NO
                        AND T1.CNTR_CYC_NO = T2.CNTR_CYC_NO
                        AND T2.DMDT_TRF_CD = DECODE(DMDT_CALC_TP_CD,'C','CTIC',DECODE(DUL_EXPT_FLG,'N','DMIF','CTIC'))
                        AND T2.CHG_SEQ = 1
                        AND B.RFA_EXPT_DAR_NO = T2.RFA_EXPT_DAR_NO
                        AND B.RFA_EXPT_MAPG_SEQ = T2.RFA_EXPT_MAPG_SEQ
                        AND B.RFA_EXPT_VER_SEQ = T2.RFA_EXPT_VER_SEQ
                        AND B.RFA_RQST_DTL_SEQ = T2.RFA_RQST_DTL_SEQ
                        AND A.RFA_EXPT_DAR_NO = B.RFA_EXPT_DAR_NO
                        AND A.RFA_EXPT_MAPG_SEQ = B.RFA_EXPT_MAPG_SEQ
                        AND A.RFA_EXPT_VER_SEQ = B.RFA_EXPT_VER_SEQ )
                  , (CASE WHEN ( SELECT COUNT(*) 
                            FROM DMT_CHG_BKG_CNTR T1, 
                                DMT_CHG_CALC T2
                            WHERE 1=1
                              AND T1.BKG_NO = AA.BKG_NO
                              AND T1.CNTR_NO = AA.CNTR_NO
                              AND T1.SYS_AREA_GRP_ID = T2.SYS_AREA_GRP_ID
                              AND T1.CNTR_NO = T2.CNTR_NO
                              AND T1.CNTR_CYC_NO = T2.CNTR_CYC_NO
                              AND T2.DMDT_TRF_CD = DECODE(DMDT_CALC_TP_CD,'C','CTIC',DECODE(DUL_EXPT_FLG,'N','DMIF','CTIC'))
                              AND T2.CHG_SEQ = 1 ) != 0 THEN 'NULL'
                    ELSE DMT_RFA_EXCEPTION_FNC(AA.BKG_NO,AA.CNTR_NO, @[tml_yd_cd], DECODE(DMDT_CALC_TP_CD,'C','CTIC',DECODE(DUL_EXPT_FLG,'N','DMIF','CTIC')), AA.CNMV_CYC_NO) 
                    END
                    )  
                )
           WHEN SC_NO IS NOT NULL AND SUBSTR(SC_NO,1,3) != 'DUM'
		   THEN
           NVL((
                SELECT 'SC_DMT'||'-'||T3.PROP_NO||'-'||T3.SC_EXPT_VER_SEQ||'-'||T3.SC_EXPT_GRP_SEQ||'-'||T3.XCLD_SAT_FLG||'-'||T3.XCLD_SUN_FLG||'-'||T3.XCLD_HOL_FLG
                           ||'-'||DECODE(T3.FT_ADD_FLG,'Y',T3.FT_ADD_DYS,0)||'-'||DECODE(T3.FT_ADD_FLG,'N',T3.FT_ADD_DYS,0)||'-'||
                           ( SELECT /*+ INDEX_ASC(A DMT_SC_EXPT_VER_PROG) */ PROG_OFC_CD
                                FROM DMT_SC_EXPT_VER_PROG A
                                WHERE PROP_NO = T3.PROP_NO
                                  AND SC_EXPT_VER_SEQ = T3.SC_EXPT_VER_SEQ
                                  AND DMDT_EXPT_VER_STS_CD = 'R'
                                  AND ROWNUM = 1 ) ||'-'||
                           ( SELECT /*+ INDEX_DESC(A DMT_SC_EXPT_VER_PROG) */ PROG_OFC_CD
                                FROM DMT_SC_EXPT_VER_PROG A
                                WHERE PROP_NO = T3.PROP_NO
                                  AND SC_EXPT_VER_SEQ = T3.SC_EXPT_VER_SEQ
                                  AND DMDT_EXPT_VER_STS_CD = 'L'
                                  AND ROWNUM = 1 ) ||'-'||' '
                FROM DMT_CHG_BKG_CNTR T1, DMT_CHG_CALC T2, DMT_SC_EXPT_GRP T3
                WHERE 1=1
                AND T1.BKG_NO = AA.BKG_NO
                AND T1.CNTR_NO = AA.CNTR_NO
                AND T1.SYS_AREA_GRP_ID = T2.SYS_AREA_GRP_ID
                AND T1.CNTR_NO = T2.CNTR_NO
                AND T1.CNTR_CYC_NO = T2.CNTR_CYC_NO
                AND T2.DMDT_TRF_CD = DECODE(DMDT_CALC_TP_CD,'C','CTIC',DECODE(DUL_EXPT_FLG,'N','DMIF','CTIC'))
                AND T2.DMDT_CHG_LOC_DIV_CD = 'POD'
                AND T2.CHG_SEQ = 1
                AND T3.PROP_NO = AA.PROP_NO
                AND T3.SC_EXPT_VER_SEQ = T2.SC_EXPT_VER_SEQ
                AND T3.SC_EXPT_GRP_SEQ = T2.SC_EXPT_GRP_SEQ
                AND T3.DMDT_TRF_CD = T2.DMDT_TRF_CD
            ), CASE WHEN ( SELECT COUNT(*) 
                            FROM DMT_CHG_BKG_CNTR T1, 
                                DMT_CHG_CALC T2
                            WHERE 1=1
                              AND T1.BKG_NO = AA.BKG_NO
                              AND T1.CNTR_NO = AA.CNTR_NO
                              AND T1.SYS_AREA_GRP_ID = T2.SYS_AREA_GRP_ID
                              AND T1.CNTR_NO = T2.CNTR_NO
                              AND T1.CNTR_CYC_NO = T2.CNTR_CYC_NO
                              AND T2.DMDT_TRF_CD = DECODE(DMDT_CALC_TP_CD,'C','CTIC',DECODE(DUL_EXPT_FLG,'N','DMIF','CTIC'))
                              AND T2.DMDT_CHG_LOC_DIV_CD = 'POD'
                              AND T2.CHG_SEQ = 1 ) != 0 THEN 'NULL'
                    ELSE DMT_SC_EXCEPTION_FNC(AA.BKG_NO,AA.CNTR_NO, @[tml_yd_cd], DECODE(DMDT_CALC_TP_CD,'C','CTIC',DECODE(DUL_EXPT_FLG,'N','DMIF','CTIC')), AA.CNMV_CYC_NO) 
                    END
                    )
                    
            ELSE 'ERROR' END CTRT_INFO
    FROM (
        SELECT DISTINCT BB.BKG_NO,
           BB.BL_NO, 
           BV.VSL_CD||BV.SKD_VOY_NO||BV.SKD_DIR_CD VVD,
           BC.CNTR_NO,
           BC.CNTR_TPSZ_CD,
           BC.CNMV_CYC_NO,
           ( SELECT /*+ INDEX_DESC(A XAK11CTM_MOVEMENT) */ 
                    TO_CHAR(CNMV_EVNT_DT,'YYYY-MM-DD')
               FROM CTM_MOVEMENT A
              WHERE CNTR_NO = BC.CNTR_NO
                AND CNMV_CYC_NO <= BC.CNMV_CYC_NO
                AND MVMT_STS_CD = 'OC'
                AND ROWNUM = 1 ) OC_EVNT_DT,
           ( SELECT /*+ INDEX_DESC(A XAK13CTM_MOVEMENT) */ 
                    TO_CHAR(CNMV_EVNT_DT,'YYYY-MM-DD')
               FROM CTM_MOVEMENT A
              WHERE CNTR_NO = BC.CNTR_NO
                AND BKG_NO = BC.BKG_NO
                AND CNMV_CYC_NO <= BC.CNMV_CYC_NO
                AND MVMT_STS_CD = 'VD'
                AND ROWNUM = 1 ) VD_EVNT_DT,
           ( SELECT CNMV_STS_CD
               FROM MST_CONTAINER A
              WHERE CNTR_NO = BC.CNTR_NO 
                AND ROWNUM = 1 ) CNMV_STS_CD,
           BB.POL_CD,
           BB.POD_CD,
           ( SELECT CUST_NM FROM BKG_CUSTOMER WHERE BKG_NO = BB.BKG_NO AND BKG_CUST_TP_CD = 'C' ) CNEE_NM,
           ( SELECT CUST_NM FROM BKG_CUSTOMER WHERE BKG_NO = BB.BKG_NO AND BKG_CUST_TP_CD = 'N' ) NOTY_NM,
           BB.SC_NO,
           BB.RFA_NO,
           PS.PROP_NO,
		   NVL((
		   		SELECT DMDT_CALC_TP_CD FROM DMT_CALC_TP
				WHERE loc_cd = SUBSTR(@[tml_yd_cd],1,5)
			  	AND IO_BND_CD = 'I'
			  	AND SYSDATE BETWEEN EFF_DT AND NVL(EXP_DT,TO_DATE('99991231','YYYYMMDD'))
				AND ROWNUM = 1 ),
			   (
				SELECT DMDT_CALC_TP_CD FROM DMT_CALC_TP
				WHERE CNT_CD = SUBSTR(@[tml_yd_cd],1,2)
  				AND loc_cd = ' '
  				AND IO_BND_CD = 'I'
  				AND SYSDATE BETWEEN EFF_DT AND NVL(EXP_DT,TO_DATE('99991231','YYYYMMDD'))
				AND ROWNUM = 1 )
			) DMDT_CALC_TP_CD,
           NVL(DMT_COMBINED_EXCEPTION_FNC(BB.BKG_NO,BC.CNTR_NO, @[tml_yd_cd], 'CTIC', BC.CNMV_CYC_NO),'N') DUL_EXPT_FLG
        FROM
         (
        SELECT * FROM BKG_VVD V
        WHERE 1=1
           AND V.VSL_CD = SUBSTR(@[tml_vvd],1,4)
           AND V.SKD_VOY_NO = SUBSTR(@[tml_vvd],5,4)
           AND V.SKD_DIR_CD = SUBSTR(@[tml_vvd],9,1)
           AND V.POD_YD_CD = @[tml_yd_cd]
           AND V.POD_CLPT_IND_SEQ = 1 ) BV
          , BKG_BOOKING BB
          , BKG_CONTAINER BC          
          , PRI_SP_HDR PS
        WHERE BV.BKG_NO = BB.BKG_NO
          AND BV.POD_CD = BB.POD_CD
          AND BB.BKG_NO = BC.BKG_NO
    	  AND BB.BKG_STS_CD = 'F'
    	  AND BB.BKG_CGO_TP_CD = 'F'
          AND BB.SC_NO = PS.SC_NO(+)
          ) AA
)
ORDER BY VVD, BL_NO, CNTR_NO			]]></sql>
			<params>
				<param name="tml_yd_cd" type="12" value="" out="N"/>
				<param name="tml_vvd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
