<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="UncollectedCargoDBDAOSearchUncollectedCreationRSQL">
			<desc><![CDATA[Uncollected Cargo Creation 메뉴의  UC 조회  Query ]]></desc>
			<sql><![CDATA[
SELECT	u.uc_cs_no
		, d.bl_no
		, d.uc_seq
		, u.hndl_rhq_cd
		, u.hndl_brnc_cd
		, u.hndl_hdlr_usr_id
        , (SELECT P.USR_NM FROM COM_USER P WHERE P.USR_ID = u.hndl_hdlr_usr_id  ) AS hndl_hdlr_usr_nm
		, u.hndl_upd_id
		, TO_CHAR(u.hndl_upd_dt,'YYYYMMDD') hndl_upd_dt
		, u.hndl_upd_dt
		, u.kntr_rhq_cd
		, u.kntr_brnc_cd
		, u.kntr_hdlr_usr_id
        , (SELECT P.USR_NM FROM COM_USER P WHERE P.USR_ID = u.kntr_hdlr_usr_id  ) AS kntr_hdlr_usr_nm
		, u.kntr_upd_id
		, TO_CHAR(u.kntr_upd_dt,'YYYYMMDD') kntr_upd_dt
		, u.uc_sts_cd
		, u.uc_ropn_flg
		, u.uc_ofc_trns_flg
		, u.cnee_uc_dt
		, u.uc_clz_dt
		, u.cre_usr_id
		, u.cre_dt
		, u.upd_usr_id
		, u.upd_dt		
		, d.ctrt_ttl_vol_ctnt
		, ( SELECT count(*) FROM CIM_UC_CGO_CNTR WHERE uc_cs_no = u.uc_cs_no ) uc_ctrt_ttl_vol
		, d.uc_ctrt_rmk
		, d.uc_rsn_cd
		, d.uc_inv_amt
		, d.uc_inv_curr_cd
		, d.uc_inv_xch_rt
		, d.uc_inv_usd_amt
		, d.uc_crnt_amt
		, d.uc_crnt_curr_cd
		, d.uc_crnt_xch_rt
		, d.uc_crnt_usd_amt
		, d.uc_obl_hld_cd
		, d.uc_piclb_cd
		, d.uc_piclb_ref_no
		, (	SELECT	TO_CHAR(NVL(MAX(evnt_dt),''),'YYYYMMDD')
			FROM	BKG_DO_DTL dtl,
    				BKG_BOOKING bkg
			WHERE	1 = 1
					AND dtl.bkg_no = d.bl_no
	    			AND bkg.bkg_no = dtl.bkg_no
	    			AND dtl.rlse_sts_cd = DECODE(SUBSTR(bkg.del_cd, 1, 2), 'JP', 'D', 'R')
		  ) uc_do_iss_dt
		, d.uc_disp_opt_cd
		, d.aban_ltr_shpr_dt
		, d.aban_ltr_cnee_dt
		, d.uc_cgo_loc_nm
		, d.uc_cgo_n1st_ntc_dt
		, d.uc_cgo_n2nd_ntc_dt
		, d.uc_cgo_n3rd_ntc_dt
		, d.uc_cgo_fnl_ntc_dt
		, d.uc_cgo_ntc_rmk
		, d.ots_oft_amt
		, d.ots_otr_amt
		, d.ots_dmdt_amt
		, d.ots_dmdt_dt
		, d.ots_sto_amt
		, d.ots_sto_dt
		, d.ots_otr_cost_amt
		, d.ots_otr_cost_dt
		, d.ots_rcvr_amt
		, d.ots_insur_cvr_amt
		, d.ots_rmk
		, d.fact_fnd_act_desc
		, d.hndl_ofc_opin_desc
		, d.kntr_ofc_opin_desc
		, b.vsl_cd||b.skd_voy_no||b.skd_dir_cd vvd
		, ( SELECT vsl_eng_nm FROM mdm_vsl_cntr WHERE vsl_cd = b.vsl_cd ) vsl_nm
		, b.por_cd por
		, (	SELECT	NVL(MIN(mm.cnmv_evnt_dt),'')
			FROM	CIM_UC_CGO_CNTR cc, CTM_MOVEMENT mm, BKG_BOOKING bb
			WHERE	1 = 1
					AND cc.bl_no = d.bl_no
	    			AND mm.bkg_no = bb.bkg_no
	    			AND cc.bl_no = bb.bkg_no
	    			AND mm.trnk_vsl_cd||mm.trnk_skd_voy_no||mm.trnk_skd_dir_cd = b.vsl_cd||b.skd_voy_no||b.skd_dir_cd
	    			AND mm.mvmt_sts_cd = 'OC'
		  ) por_dt
        , (
             SELECT  MIN(bb.pol_cd)
             FROM    bkg_vvd bb, bkg_booking kk, vsk_vsl_port_skd vv
             WHERE   1 = 1
                     AND kk.bl_no = b.bl_no
                     AND kk.bkg_no = bb.bkg_no
                     AND kk.pol_cd = bb.pol_cd
                     AND bb.vsl_cd = vv.vsl_cd
                     AND bb.skd_voy_no = vv.skd_voy_no
                     AND bb.skd_dir_cd = vv.skd_dir_cd
                     AND bb.pol_cd = vv.vps_port_cd
          ) pol
        , (
             SELECT  MIN(vv.vps_etd_dt)
             FROM    bkg_vvd bb, bkg_booking kk, vsk_vsl_port_skd vv
             WHERE   1 = 1
                     AND kk.bl_no = b.bl_no
                     AND kk.bkg_no = bb.bkg_no
                     AND kk.pol_cd = bb.pol_cd
                     AND bb.vsl_cd = vv.vsl_cd
                     AND bb.skd_voy_no = vv.skd_voy_no
                     AND bb.skd_dir_cd = vv.skd_dir_cd
                     AND bb.pol_cd = vv.vps_port_cd
          ) pol_etd
        , ( 
            SELECT  MIN(bb.pod_cd)
            FROM    bkg_vvd bb, bkg_booking kk, vsk_vsl_port_skd vv
            WHERE   1 = 1
                    AND kk.bl_no = b.bl_no
                    AND kk.bkg_no = bb.bkg_no
                    AND kk.pod_cd = bb.pod_cd
                    AND bb.vsl_cd = vv.vsl_cd
                    AND bb.skd_voy_no = vv.skd_voy_no
                    AND bb.skd_dir_cd = vv.skd_dir_cd
                    AND bb.pod_cd = vv.vps_port_cd
          ) pod
        , ( 
            SELECT  MIN(vv.vps_eta_dt)
            FROM    bkg_vvd bb, bkg_booking kk, vsk_vsl_port_skd vv
            WHERE   1 = 1
                    AND kk.bl_no = b.bl_no
                    AND kk.bkg_no = bb.bkg_no
                    AND kk.pod_cd = bb.pod_cd
                    AND bb.vsl_cd = vv.vsl_cd
                    AND bb.skd_voy_no = vv.skd_voy_no
                    AND bb.skd_dir_cd = vv.skd_dir_cd
                    AND bb.pod_cd = vv.vps_port_cd
          ) pod_eta
		, b.del_cd del_cd
		, (	SELECT	NVL(MIN(mm.cnmv_evnt_dt),'')
			FROM	CIM_UC_CGO_CNTR cc, CTM_MOVEMENT mm, BKG_BOOKING bb
			WHERE	1 =1
					AND cc.bl_no = d.bl_no
	    			AND mm.bkg_no = bb.bkg_no
	    			AND cc.bl_no = bb.bkg_no
	    			AND mm.trnk_vsl_cd||mm.trnk_skd_voy_no||mm.trnk_skd_dir_cd = b.vsl_cd||b.skd_voy_no||b.skd_dir_cd
	    			AND mm.mvmt_sts_cd = 'ID'
		  ) del_dt
		, ( SELECT	replace(substr(c.cust_nm,1,50),chr(13)||chr(10),' ')
         	FROM   	bkg_customer c
         	WHERE  	b.bkg_no = c.bkg_no
         			AND c.bkg_cust_tp_cd = 'S'
       	  ) shpr
		, ( SELECT 	replace(substr(c.cust_nm,1,50),chr(13)||chr(10),' ')
         	FROM   	bkg_customer c
         	WHERE  	b.bkg_no = c.bkg_no
         			AND c.bkg_cust_tp_cd = 'C'
       	  ) cnee
		, ( SELECT 	replace(substr(c.cust_nm,1,50),chr(13)||chr(10),' ')
         	FROM   	bkg_customer c
         	WHERE  	b.bkg_no = c.bkg_no
         			AND c.bkg_cust_tp_cd = 'N'
       	  ) noti
		, ( SELECT 	replace(substr(c.cust_nm,1,50),chr(13)||chr(10),' ')
         	FROM   	bkg_customer c
         	WHERE  	b.bkg_no = c.bkg_no
         			AND c.bkg_cust_tp_cd = 'F'
       	  ) frwd
		, ( SELECT 	c.cmdt_nm 
         	FROM 	mdm_commodity c 
         	WHERE 	c.cmdt_cd = b.cmdt_cd
          ) cmdt
		, (	SELECT	ROUND(SUM(NVL(R.CHG_AMT / DECODE(R.CURR_CD, 'USD', 1, 
            		( 	SELECT 	NVL(EX1.USD_LOCL_XCH_RT, 1) 
             			FROM 	GL_MON_XCH_RT EX1
             			WHERE 	R.CURR_CD = EX1.CURR_CD 
               					AND EX1.ACCT_XCH_RT_YRMON =
                  							( 	SELECT	SUBSTR(TO_CHAR(NVL(MIN(S.VPS_ETB_DT),''), 'YYYYMM'), 1, 6)
                   								FROM	VSK_VSL_PORT_SKD S
                   								WHERE	S.VSL_CD = B.VSL_CD
                  										AND	S.SKD_VOY_NO = b.SKD_VOY_NO
                  										AND S.SKD_DIR_CD = b.SKD_DIR_CD
                  										AND S.VPS_PORT_CD = b.POL_CD
                 							 )
               					AND EX1.ACCT_XCH_RT_LVL = '1'
             	   )),0)), 2)
			FROM	BKG_CHG_RT R
      		WHERE	b.BKG_NO = R.BKG_NO
       				AND R.FRT_TERM_CD = 'P'
     	   ) prepaid
		, ( SELECT	ROUND(SUM(NVL(R.CHG_AMT / DECODE(R.CURR_CD, 'USD', 1, 
            		(	SELECT	NVL(EX1.USD_LOCL_XCH_RT, 1) 
             			FROM 	GL_MON_XCH_RT EX1
             			WHERE 	R.CURR_CD = EX1.CURR_CD 
               					AND	EX1.ACCT_XCH_RT_YRMON =
                  						(	SELECT	SUBSTR(TO_CHAR(NVL(MIN(S.VPS_ETB_DT),''), 'YYYYMM'), 1, 6)
                   							FROM	VSK_VSL_PORT_SKD S
                   							WHERE	S.VSL_CD = b.VSL_CD
                  									AND S.SKD_VOY_NO = b.SKD_VOY_NO
                  									AND S.SKD_DIR_CD = b.SKD_DIR_CD
                  									AND S.VPS_PORT_CD = b.POL_CD
                 						)
               					AND EX1.ACCT_XCH_RT_LVL = '1'
             		)),0)), 2)
      		FROM	BKG_CHG_RT R
      		WHERE	b.BKG_NO = R.BKG_NO
       				AND R.FRT_TERM_CD = 'C'
     	  ) collect
		, TO_CHAR(SYSDATE,'YYYY-MM-DD') today
		, ( SELECT  COUNT(*) FROM CIM_UC_CGO_FILE WHERE uc_cs_no = u.uc_cs_no AND uc_cgo_file_id = 'UCA' ) file_cnt 
#if     (${isauthority} == '1')
        , UC_CGO_RHQ_MM_DESC AS manager_memo
#else
        , UC_CGO_HO_MM_DESC AS manager_memo
#end   
FROM	CIM_UC_CGO u,
		CIM_UC_CGO_DTL d, 
		BKG_BOOKING b
WHERE	1 = 1
		AND u.uc_cs_no = d.uc_cs_no
		AND d.bl_no = b.bl_no(+)
		#if (${uc_cs_no} != '') 
		AND d.uc_cs_no = @[uc_cs_no]
		#end
		#if (${bl_no} != '') 
		AND d.uc_cs_no = ( SELECT MAX(uc_cs_no) FROM CIM_UC_CGO_DTL WHERE bl_no = @[bl_no] )
		#end
ORDER BY d.uc_seq			]]></sql>
			<params>
				<param name="uc_cs_no" type="12" value="" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
