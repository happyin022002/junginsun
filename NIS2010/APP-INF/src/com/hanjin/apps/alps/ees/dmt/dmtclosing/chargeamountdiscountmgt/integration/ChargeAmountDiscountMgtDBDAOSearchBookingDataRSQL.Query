<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ChargeAmountDiscountMgtDBDAOSearchBookingDataRSQL">
			<desc><![CDATA[BKG No. 나 B/L No. 에 해당되는 데이터를 조회하기 위한 쿼리]]></desc>
			<sql><![CDATA[
SELECT 	TVVD
	, 	POR_CD
	, 	POL_CD
	, 	POD_CD
	,	DEL_CD
	, 	RD
    ,   DCGO_FLG
	,	RC_FLG
	, 	AWK_CGO_FLG
	,	BB_CGO_FLG
	, 	RD_CGO_FLG
	, 	SOC_FLG
	, 	CMDT_CD
	,	CMDT_NM
	,	SC_NO
	,	RFA_NO
	,	TAA_NO
	,	BKG_NO
	,	BL_NO
	,	CUST_CD
	,	CUST_NM
	,   ROUND(AFT_BKG_CM_AMT,2) AFT_BKG_CM_AMT
    , NVL((        
        SELECT 'Y'          
				FROM    DMT_AFT_BKG_FILE_RQST FL
				    ,   COM_UPLD_FILE T2
				    ,   DMT_AFT_BKG_ADJ_RQST ADJ_RQST
					,   DMT_AFT_BKG_ADJ_RQST_DTL ADJ_RQST_DTL
					,   BKG_BOOKING BB
					,   PRI_RP_HDR RP_HDR
					,   PRI_RP_MN RP_MN
					,   PRI_SP_HDR SP_HDR
					,   PRI_SP_CTRT_PTY SP_PTY
					,   PRI_TAA_HDR TAA_HDR
					,   PRI_TAA_MN TAA_MN

				WHERE 1=1
					AND ADJ_RQST.DMDT_EXPT_RQST_STS_CD = 'A'
				    AND FL.AFT_BKG_FILE_DIV_CD = 'LETT01'
                    AND FL.FILE_SAV_ID          = T2.FILE_SAV_ID(+)
                    AND T2.DELT_FLG(+)             = 'N'
                    
				    AND FL.AFT_EXPT_DAR_NO = ADJ_RQST.AFT_EXPT_DAR_NO
					AND ADJ_RQST.AFT_EXPT_DAR_NO = ADJ_RQST_DTL.AFT_EXPT_DAR_NO
					AND ADJ_RQST_DTL.BKG_NO = BB.BKG_NO

					AND BB.RFA_NO = RP_HDR.RFA_NO(+)
					AND RP_HDR.PROP_NO = RP_MN.PROP_NO(+)
					AND	(
							RP_MN.AMDT_SEQ IS NULL
							OR
							(
								RP_MN.AMDT_SEQ =
								(
									SELECT 	/*+ INDEX_DESC(PRI_RP_MN XPKPRI_RP_MN) */AMDT_SEQ
									FROM	PRI_RP_MN
									WHERE	PROP_NO = RP_MN.PROP_NO
										AND	ROWNUM = 1
								)
							)
						)
					AND BB.SC_NO = SP_HDR.SC_NO(+)
					AND SP_HDR.PROP_NO = SP_PTY.PROP_NO(+)
					AND (
							(
								SP_PTY.PRC_CTRT_PTY_TP_CD IS NULL AND SP_PTY.AMDT_SEQ IS NULL
							)
							OR 
							(
								SP_PTY.PRC_CTRT_PTY_TP_CD = 'C' 
								AND 
								SP_PTY.AMDT_SEQ = 
								(
									SELECT	/*+ INDEX_DESC(PRI_SP_CTRT_PTY XPKPRI_SP_CTRT_PTY) */AMDT_SEQ 
									FROM	PRI_SP_CTRT_PTY 
									WHERE 	PROP_NO = SP_PTY.PROP_NO
										AND	PRC_CTRT_PTY_TP_CD = 'C'
										AND	ROWNUM = 1
								)				
							)  
						)

					AND TAA_HDR.TAA_NO(+) = BB.TAA_NO
					AND TAA_HDR.TAA_PROP_NO = TAA_MN.TAA_PROP_NO(+)
					AND	(
							TAA_MN.AMDT_SEQ IS NULL
							OR
							(
								TAA_MN.AMDT_SEQ =
								(
									SELECT 	/*+ INDEX_DESC(PRI_TAA_MN XFK1PRI_TAA_MN) */AMDT_SEQ
									FROM	PRI_TAA_MN
									WHERE	TAA_PROP_NO = TAA_MN.TAA_PROP_NO
										AND	ROWNUM = 1
								)
							)
						)

					AND ( RP_MN.CTRT_CUST_CNT_CD || LPAD(RP_MN.CTRT_CUST_SEQ, 6, '0') = A.CUST_CD
                       OR SP_PTY.CUST_CNT_CD || LPAD(SP_PTY.CUST_SEQ, 6, '0') = A.CUST_CD
                       OR TAA_MN.CTRT_CUST_CNT_CD || LPAD(TAA_MN.CTRT_CUST_SEQ, 6, '0') = A.CUST_CD
						)
				AND ROWNUM = 1
    ),'N') AS GNTE_LTR_FLG
    , DECODE(OFC_CNT,1,
             NVL (( SELECT OFC_CD 
				   FROM DMT_CHG_BKG_CNTR A, DMT_CHG_CALC B, dmt_hrd_cdg_ctnt C
                   WHERE 1=1
                   AND A.SYS_AREA_GRP_ID = B.SYS_AREA_GRP_ID
                   AND A.CNTR_NO = B.CNTR_NO
                   AND A.CNTR_CYC_NO = B.CNTR_CYC_NO 
				#if(${bkg_no} != '')
					AND A.BKG_NO = @[bkg_no]
				#else
					AND A.BKG_NO = (SELECT BKG_NO FROM BKG_BOOKING WHERE BL_NO = @[bl_no])
				#end
                   AND B.DMDT_TRF_CD = @[tariff]
				   AND C.HRD_CDG_ID = 'AFT_BKG_OFC_CHK'
				   AND B.OFC_CD = C.ATTR_CTNT1
                   AND ROWNUM = 1 ),'N') , 'N') OFC_CD

FROM (
SELECT	TVVD
	, 	POR_CD
	, 	POL_CD
	, 	POD_CD
	,	DEL_CD
	, 	RD
    ,   DCGO_FLG
	,	RC_FLG
	, 	AWK_CGO_FLG
	,	BB_CGO_FLG
	, 	RD_CGO_FLG
	, 	SOC_FLG
	, 	CMDT_CD
	,	CMDT_NM
	,	SC_NO
	,	RFA_NO
	,	TAA_NO
	,	BKG_NO
	,	BL_NO
	,	DECODE(NVL(TAA_CUST_CD, '' ), '',DECODE(NVL(RP_CUST_CD, ''), '', SP_CUST_CD, RP_CUST_CD),TAA_CUST_CD) CUST_CD
	,	DECODE(NVL(TAA_CUST_CD, ''), '', DECODE(NVL(RP_CUST_CD, ''), '', SP_CUST_NM, RP_CUST_NM),TAA_CUST_NM) CUST_NM
	,   AFT_BKG_CM_AMT
	,   ( SELECT COUNT(*)
	      FROM
	           ( SELECT OFC_CD, COUNT(*) FROM DMT_CHG_BKG_CNTR A, DMT_CHG_CALC B
                 WHERE 1=1
                   AND A.SYS_AREA_GRP_ID = B.SYS_AREA_GRP_ID
                   AND A.CNTR_NO = B.CNTR_NO
                   AND A.CNTR_CYC_NO = B.CNTR_CYC_NO 
				#if(${bkg_no} != '')
					AND A.BKG_NO = @[bkg_no]
				#else
					AND A.BKG_NO = (SELECT BKG_NO FROM BKG_BOOKING WHERE BL_NO = @[bl_no])
				#end
                   AND B.DMDT_TRF_CD = @[tariff]
                   GROUP BY OFC_CD ) ) OFC_CNT
FROM	(
			SELECT  ROWNUM IDX
				,	BOOKING.VSL_CD || BOOKING.SKD_VOY_NO || BOOKING.SKD_DIR_CD TVVD
			    ,   BOOKING.POR_CD
			    ,   BOOKING.POL_CD
			    ,   BOOKING.POD_CD
			    ,   BOOKING.DEL_CD
			    ,   BOOKING.RCV_TERM_CD || '/' || BOOKING.DE_TERM_CD RD
			    ,   DECODE(BOOKING.DCGO_FLG, 'N', '', BOOKING.DCGO_FLG) DCGO_FLG
			    ,   DECODE(BOOKING.RC_FLG, 'N', '', BOOKING.RC_FLG) RC_FLG
			    ,   DECODE(BOOKING.AWK_CGO_FLG, 'N', '', BOOKING.AWK_CGO_FLG) AWK_CGO_FLG
			    ,   DECODE(BOOKING.BB_CGO_FLG, 'N', '', BOOKING.BB_CGO_FLG) BB_CGO_FLG
				, 	DECODE(BOOKING.RD_CGO_FLG, 'N', '', BOOKING.RD_CGO_FLG) RD_CGO_FLG
				, 	DECODE(BOOKING.SOC_FLG, 'N', '', BOOKING.SOC_FLG) SOC_FLG
				,	BOOKING.BKG_NO
				,	BOOKING.BL_NO
				,	BOOKING.SC_NO
				,	BOOKING.RFA_NO
				,	BOOKING.TAA_NO
	            ,   RP_MN.CTRT_CUST_CNT_CD || LPAD(RP_MN.CTRT_CUST_SEQ, 6, '0') RP_CUST_CD
	            ,   (
						SELECT	CUST_LGL_ENG_NM 
						FROM 	MDM_CUSTOMER 
						WHERE	CUST_CNT_CD = RP_MN.CTRT_CUST_CNT_CD 
							AND CUST_SEQ = RP_MN.CTRT_CUST_SEQ
					) RP_CUST_NM
	            ,   SP_PTY.CUST_CNT_CD || LPAD(SP_PTY.CUST_SEQ, 6, '0') SP_CUST_CD
	            ,   (
						SELECT	CUST_LGL_ENG_NM 
						FROM	MDM_CUSTOMER 
						WHERE	CUST_CNT_CD = SP_PTY.CUST_CNT_CD 
							AND CUST_SEQ = SP_PTY.CUST_SEQ 
					) SP_CUST_NM

		        ,   TAA_MN.CTRT_CUST_CNT_CD || LPAD(TAA_MN.CTRT_CUST_SEQ, 6, '0') TAA_CUST_CD
		        ,   (
						SELECT	CUST_LGL_ENG_NM 
						FROM 	MDM_CUSTOMER 
						WHERE	CUST_CNT_CD = TAA_MN.CTRT_CUST_CNT_CD 
							AND CUST_SEQ = TAA_MN.CTRT_CUST_SEQ
					) TAA_CUST_NM

				, 	BOOKING.CMDT_CD
			    ,	CMDT.CMDT_NM
				,   (
                     SELECT   SUM(NVL(A2.BKG_REV,0) + NVL(A2.BKG_OFT_REV,0) + NVL(A2.BKG_MISC_REV,0) + NVL(A2.SCR_CHG_REV,0) + NVL(A1.DMDT_COM_AMT,0)) 
								- SUM(DECODE('P'||'C', 'PC',NVL(A2.ESTM_CM_COST_AMT,0)
																	  , 'PO',NVL(A2.ESTM_CM_COST_AMT,0) -- + NVL(A2.ESTM_OPFIT_COST_AMT,0) /*CHM-200901045 Trade profit - OP 선택 시 OP 계정이 CM에 계산 되어 반영 되는 부분  쿼리수정 [061]*/
																	  , 'PM',NVL(A2.ESTM_CM_COST_AMT,0) + NVL(A1.OWN_FDR_AMT,0)
																	  , 'RC',NVL(A2.RA_CM_COST_AMT,0)
																	  , 'RM',NVL(A2.RA_CM_COST_AMT,0) + NVL(A1.OWN_FDR_AMT,0)
																	  , 'RO',NVL(A2.RA_CM_COST_AMT,0) + NVL(A2.RA_OPFIT_COST_AMT,0)
																	  , 0))   AS CM
                    FROM     MAS_BKG_EXPN_DTL    A1
                            ,MAS_BKG_REV_DTL     A2
                            ,MAS_BKG_OP_EXPN_DTL A6
                    WHERE    1 = 1
                    AND A1.BKG_NO         = BOOKING.BKG_NO
                    AND a1.bl_no_tp      IN ('M','0')
                    AND A1.BKG_STS_CD    IN ('F','S','W')
                    AND A1.BKG_CGO_TP_CD <> 'P'
                    AND A1.BKG_NO         = A2.BKG_NO (+)
                    AND A1.CNTR_TPSZ_CD   = A2.CNTR_TPSZ_CD (+)
                    AND A1.COST_ROUT_NO   = A2.COST_ROUT_NO (+)
                    AND A1.BKG_NO         = A6.BKG_NO (+)
                    AND A1.CNTR_TPSZ_CD   = A6.CNTR_TPSZ_CD (+)
                    AND A1.COST_ROUT_NO   = A6.COST_ROUT_NO (+)
					) AS AFT_BKG_CM_AMT

			FROM	BKG_BOOKING BOOKING
				,	MDM_COMMODITY CMDT
				,   PRI_RP_HDR RP_HDR
				,   PRI_RP_MN RP_MN
				,   PRI_SP_HDR SP_HDR
				,   PRI_TAA_HDR TAA_HDR
				,   PRI_TAA_MN TAA_MN
				,   PRI_SP_CTRT_PTY SP_PTY

			WHERE   
				#if(${bkg_no} != '')
					BOOKING.BKG_NO 	= @[bkg_no]
				#else
					BOOKING.BKG_NO 	= (SELECT BKG_NO FROM BKG_BOOKING WHERE BL_NO = @[bl_no])
				#end
				AND BOOKING.CMDT_CD = CMDT.CMDT_CD(+)
				AND BOOKING.RFA_NO 	= RP_HDR.RFA_NO(+)
				AND RP_HDR.PROP_NO 	= RP_MN.PROP_NO(+)
				AND	(
						RP_MN.AMDT_SEQ IS NULL
						OR
						(
							RP_MN.AMDT_SEQ =
							(
								SELECT 	/*+ INDEX_DESC(PRI_RP_MN XPKPRI_RP_MN) */AMDT_SEQ
								FROM	PRI_RP_MN
								WHERE	PROP_NO = RP_MN.PROP_NO
									AND	ROWNUM = 1
							)
						)
					)
				AND BOOKING.SC_NO 	= SP_HDR.SC_NO(+)
				AND SP_HDR.PROP_NO 	= SP_PTY.PROP_NO(+)
				AND (
						(
							SP_PTY.PRC_CTRT_PTY_TP_CD IS NULL AND SP_PTY.AMDT_SEQ IS NULL
						)
						OR 
						(
							SP_PTY.PRC_CTRT_PTY_TP_CD = 'C' 
							AND 
							SP_PTY.AMDT_SEQ = 
							(
								SELECT	/*+ INDEX_DESC(PRI_SP_CTRT_PTY XPKPRI_SP_CTRT_PTY) */AMDT_SEQ 
								FROM	PRI_SP_CTRT_PTY 
								WHERE 	PROP_NO = SP_PTY.PROP_NO
									AND	PRC_CTRT_PTY_TP_CD = 'C'
									AND	ROWNUM = 1
							)				
						)  
					)		
				AND TAA_HDR.TAA_NO(+) = BOOKING.TAA_NO
				AND TAA_HDR.TAA_PROP_NO = TAA_MN.TAA_PROP_NO(+)
				AND	(
						TAA_MN.AMDT_SEQ IS NULL
						OR
						(
							TAA_MN.AMDT_SEQ =
							(
								SELECT 	/*+ INDEX_DESC(PRI_TAA_MN XFK1PRI_TAA_MN) */AMDT_SEQ
								FROM	PRI_TAA_MN
								WHERE	TAA_PROP_NO = TAA_MN.TAA_PROP_NO
									AND	ROWNUM = 1
							)
						)
					)
		)
WHERE IDX = 1
) A			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
				<param name="tariff" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
