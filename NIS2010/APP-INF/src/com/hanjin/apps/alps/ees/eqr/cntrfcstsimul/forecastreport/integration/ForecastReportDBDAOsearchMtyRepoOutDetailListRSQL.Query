<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ForecastReportDBDAOsearchMtyRepoOutDetailListRSQL">
			<desc><![CDATA[forecast reposition out 데이터 조회
- 20150127, CHM-201432224, REPOSITION OUT 현재미래는 지역별 날짜 사용 안함.]]></desc>
			<sql><![CDATA[
WITH REPO_IN_RESULT AS (      

SELECT CRE_SEQ
      ,YARD
      ,LANE
      ,VVD 
      ,ETB
      ,ETB_DAY
      ,POD_CD
      ,DIV
      ,RPT_SEQ    -- HIDDEN                                                       
      ,D2_QTY 
      ,D4_QTY
      ,D5_QTY
      ,D7_QTY
      ,R2_QTY
      ,R5_QTY
      ,R9_QTY
      ,O2_QTY
      ,O4_QTY
      ,O5_QTY
      ,S2_QTY
      ,S4_QTY
      ,F2_QTY
      ,F4_QTY
      ,F5_QTY
      ,A2_QTY
      ,A4_QTY 
      ,A5_QTY                 
      ,REMARK 
FROM
(      
    SELECT ROW_NUMBER() OVER(PARTITION BY YARD, LANE, VVD ORDER BY CRE_SEQ   ) AS RN -- 동일 YARD, LANE, VVD 의 경우 COD CONFIRM 우선
          ,CRE_SEQ
          ,YARD
          ,LANE
          ,VVD
          ,ETB
          ,ETB_DAY
          ,POD_CD
          ,DIV
          ,RPT_SEQ    -- HIDDEN                                                       
          ,D2_QTY 
          ,D4_QTY
          ,D5_QTY
          ,D7_QTY
          ,R2_QTY
          ,R5_QTY
          ,R9_QTY
          ,O2_QTY
          ,O4_QTY
          ,O5_QTY
          ,S2_QTY
          ,S4_QTY
          ,F2_QTY
          ,F4_QTY
          ,F5_QTY
          ,A2_QTY
          ,A4_QTY          
          ,A5_QTY         
          ,REMARK 
    FROM
    (      
        -- COD Confirmation 데이터 조회
        SELECT '0' CRE_SEQ -- 삭제불가, REMARK 만 수정 가능
              ,NVL(B.YD_CD, B.PORT_CD) YARD
              ,A.SLAN_CD LANE
              ,B.VSL_CD||B.SKD_VOY_NO||B.SKD_DIR_CD VVD
              ,TO_CHAR(B.ETB_DT, 'YYYY-MM-DD') ETB
              ,SUBSTR(TO_CHAR(B.ETB_DT, 'DAY', 'NLS_DATE_LANGUAGE=ENGLISH'), 1,3) ETB_DAY      
              ,'' POD_CD  -- HIDDEN
              ,'C' DIV    -- HIDDEN 
              ,0 RPT_SEQ    -- HIDDEN                                                       
              ,NVL(B.D2_QTY,0) D2_QTY 
              ,NVL(B.D4_QTY,0) D4_QTY
              ,NVL(B.D5_QTY,0) D5_QTY
              ,NVL(B.D7_QTY,0) D7_QTY
              ,NVL(B.R2_QTY,0) R2_QTY
              ,NVL(B.R5_QTY,0) R5_QTY
              ,NVL(B.R9_QTY,0) R9_QTY
              ,NVL(B.O2_QTY,0) O2_QTY
              ,NVL(B.O4_QTY,0) O4_QTY
              ,NVL(B.O5_QTY,0) O5_QTY
              ,NVL(B.S2_QTY,0) S2_QTY
              ,NVL(B.S4_QTY,0) S4_QTY
              ,NVL(B.F2_QTY,0) F2_QTY
              ,NVL(B.F4_QTY,0) F4_QTY
              ,NVL(B.F5_QTY,0) F5_QTY
              ,NVL(B.A2_QTY,0) A2_QTY
              ,NVL(B.A4_QTY,0) A4_QTY            
              ,NVL(B.A5_QTY,0) A5_QTY     
              ,C.DIFF_RMK REMARK     
        FROM EQR_MTY_COD_VVD  A
            ,EQR_MTY_COD_PORT B   
            ,EQR_MTY_COD_RMK  C
        WHERE A.VSL_CD         = B.VSL_CD
        AND   A.SKD_VOY_NO     = B.SKD_VOY_NO
        AND   A.SKD_DIR_CD     = B.SKD_DIR_CD
        AND   A.COD_CFM_DIV_CD = B.COD_CFM_DIV_CD      
        AND   B.VSL_CD         = C.VSL_CD(+)
        AND   B.SKD_VOY_NO     = C.SKD_VOY_NO(+)
        AND   B.SKD_DIR_CD     = C.SKD_DIR_CD(+)
        AND   B.COD_CFM_DIV_CD = C.COD_CFM_DIV_CD(+)    
        AND   B.PORT_CD IN (                        
                                SELECT LOC_CD FROM MDM_LOCATION 
                                WHERE SCC_CD IN ( 
                                               SELECT SCC_CD 
                                               FROM MDM_EQ_ORZ_CHT 
            								#if(${loc_grp_cd} == 'S')
                            				   WHERE SCC_CD = @[loc_cd]  -- IF GRP_CD=S
            								#elseif(${loc_grp_cd} == 'E')
                           					   WHERE ECC_CD = @[loc_cd]  -- IF GRP_CD=E
            								#elseif(${loc_grp_cd} == 'L')
                            				   WHERE LCC_CD = @[loc_cd]  -- IF GRP_CD=L
            								#end                                 
                                                )
                            )   
        AND   B.ETB_DT BETWEEN TO_DATE(@[wk_st_dt], 'YYYYMMDD') AND TO_DATE(@[wk_end_dt], 'YYYYMMDD')+0.99999    
        AND   B.LODG_DCHG_DIV_CD = 'L' -- load            
        AND   B.COD_CFM_DIV_CD   = 'C' -- confirm
  
        UNION ALL    
       
	    -- BKG Loading Data
        SELECT '2' CRE_SEQ -- 삭제불가능, 수정가능 없음.
              ,A.YD_CD YARD
              ,A.VSL_LANE_CD LANE
              ,A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD VVD
              ,TO_CHAR(A.ETD_DT, 'YYYY-MM-DD') ETB
              ,SUBSTR(TO_CHAR(A.ETD_DT, 'DAY', 'NLS_DATE_LANGUAGE=ENGLISH'), 1,3) ETB_DAY   
              ,(SELECT X.LOC_CD FROM MDM_YARD X WHERE X.YD_CD = A.YD_CD) POD_CD -- HIDDEN
              ,A.COD_CFM_DIV_CD DIV -- HIDDEN
              ,0 RPT_SEQ         -- HIDDEN
              ,NVL(A.D2_FCAST_QTY,0) D2_QTY
              ,NVL(A.D4_FCAST_QTY,0) D4_QTY
              ,NVL(A.D5_FCAST_QTY,0) D5_QTY
              ,NVL(A.D7_FCAST_QTY,0) D7_QTY
              ,NVL(A.R2_FCAST_QTY,0) R2_QTY
              ,NVL(A.R5_FCAST_QTY,0) R5_QTY
              ,NVL(A.R9_FCAST_QTY,0) R9_QTY
              ,NVL(A.O2_FCAST_QTY,0) O2_QTY
              ,NVL(A.O4_FCAST_QTY,0) O4_QTY                              
              ,NVL(A.O5_FCAST_QTY,0) O5_QTY                              
              ,NVL(A.S2_FCAST_QTY,0) S2_QTY
              ,NVL(A.S4_FCAST_QTY,0) S4_QTY               
              ,NVL(A.F2_FCAST_QTY,0) F2_QTY
              ,NVL(A.F4_FCAST_QTY,0) F4_QTY
              ,NVL(A.F5_FCAST_QTY,0) F5_QTY                              
              ,NVL(A.A2_FCAST_QTY,0) A2_QTY
              ,NVL(A.A4_FCAST_QTY,0) A4_QTY
              ,NVL(A.A5_FCAST_QTY,0) A5_QTY
              ,A.DIFF_RMK REMARK
       
        FROM EQR_CTRL_REPO_OUT_SNAP A
            ,(
                    SELECT C.YD_CD, A.SCC_CD
                    FROM MDM_EQ_ORZ_CHT A,MDM_LOCATION B,MDM_YARD C                     
        #if(${loc_grp_cd} == 'S')
                    WHERE A.SCC_CD = @[loc_cd]  -- IF GRP_CD=S
        #elseif(${loc_grp_cd} == 'E')
                    WHERE A.ECC_CD = @[loc_cd]  -- IF GRP_CD=E
        #elseif(${loc_grp_cd} == 'L')
                    WHERE A.LCC_CD = @[loc_cd]  -- IF GRP_CD=L
        #end                                  
                    AND   A.SCC_CD = B.SCC_CD
                    AND   B.LOC_CD = C.LOC_CD
              ) C
         WHERE A.ETD_DT BETWEEN  TO_DATE(@[wk_st_dt],'YYYYMMDD') AND TO_DATE(@[wk_end_dt],'YYYYMMDD')+0.9999          
         AND   A.YD_CD = C.YD_CD         

    )     
)  
WHERE RN=1 -- 동일 YARD, LANE, VVD 의 경우 COD CONFIRM 우선


UNION ALL

-- REPO IN DETAIL(EES_EQR_1049에서 수기입력)
-- 항상 조회됨(현재 + 미래)
SELECT '1' CRE_SEQ -- 삭제가능
      ,LOC_CD YARD
      ,VSL_LANE_CD LANE
      ,VSL_CD||SKD_VOY_NO||SKD_DIR_CD VVD
      ,TO_CHAR(ETD_DT, 'YYYY-MM-DD') ETB
      ,SUBSTR(TO_CHAR(ETD_DT, 'DAY', 'NLS_DATE_LANGUAGE=ENGLISH'), 1,3) ETB_DAY      
      ,'' POD_CD  -- HIDDEN
      ,'' DIV     -- HIDDEN 
      ,RPT_SEQ    -- HIDDEN                                                       
      ,NVL(D2_FCAST_QTY,0) D2_QTY
      ,NVL(D4_FCAST_QTY,0) D4_QTY
      ,NVL(D5_FCAST_QTY,0) D5_QTY
      ,NVL(D7_FCAST_QTY,0) D7_QTY
      ,NVL(R2_FCAST_QTY,0) R2_QTY
      ,NVL(R5_FCAST_QTY,0) R5_QTY
      ,NVL(R9_FCAST_QTY,0) R9_QTY
      ,NVL(O2_FCAST_QTY,0) O2_QTY
      ,NVL(O4_FCAST_QTY,0) O4_QTY
      ,NVL(O5_FCAST_QTY,0) O5_QTY
      ,NVL(S2_FCAST_QTY,0) S2_QTY
      ,NVL(S4_FCAST_QTY,0) S4_QTY
      ,NVL(F2_FCAST_QTY,0) F2_QTY
      ,NVL(F4_FCAST_QTY,0) F4_QTY
      ,NVL(F5_FCAST_QTY,0) F5_QTY
      ,NVL(A2_FCAST_QTY,0) A2_QTY
      ,NVL(A4_FCAST_QTY,0) A4_QTY               
      ,NVL(A5_FCAST_QTY,0) A5_QTY               
      ,DIFF_RMK REMARK       
FROM EQR_CTRL_BAL_RPT_LODG_MNL 
WHERE ETD_DT BETWEEN TO_DATE(@[wk_st_dt], 'YYYYMMDD') AND TO_DATE(@[wk_end_dt], 'YYYYMMDD')+0.99999
AND   LOC_CD IN 
      (                        
          SELECT LOC_CD FROM MDM_LOCATION 
          WHERE SCC_CD IN 
          ( 
              SELECT SCC_CD 
              FROM MDM_EQ_ORZ_CHT 
    			#if(${loc_grp_cd} == 'S')
          	   WHERE SCC_CD = @[loc_cd]  -- IF GRP_CD=S
    			#elseif(${loc_grp_cd} == 'E')
          	   WHERE ECC_CD = @[loc_cd]  -- IF GRP_CD=E
    			#elseif(${loc_grp_cd} == 'L')
          	   WHERE LCC_CD = @[loc_cd]  -- IF GRP_CD=L
    			#end                                 
          )
      )                
                                                                                                            
)


SELECT CRE_SEQ
      ,LVL
      ,TO_YD_CD
      ,VSL_LANE_CD
      ,VVD
      ,TO_ETB_DT
      ,REPLACE(TO_ETB_DT, '-', '') TO_ETB_DT_ORG
      ,TO_ETB_DAY
      ,D2_FCAST_QTY
      ,D4_FCAST_QTY
      ,D5_FCAST_QTY
      ,D7_FCAST_QTY
      ,R2_FCAST_QTY
      ,R5_FCAST_QTY
      ,R9_FCAST_QTY
      ,O2_FCAST_QTY
      ,S2_FCAST_QTY
      ,O4_FCAST_QTY
      ,S4_FCAST_QTY
      ,O5_FCAST_QTY
      ,F2_FCAST_QTY
      ,A2_FCAST_QTY
      ,F4_FCAST_QTY
      ,A4_FCAST_QTY
      ,A5_FCAST_QTY
      ,F5_FCAST_QTY
      ,REMARK
	  ,WK_ST_DT
      ,WK_END_DT
      ,'F' CURR_FLAG -- HIDDEN     
      ,DIV        -- HIDDEN     
      ,RPT_SEQ    -- HIDDEN     
FROM
(
    SELECT CRE_SEQ
          ,'000000'   LVL
          ,YARD		  TO_YD_CD
          ,LANE	      VSL_LANE_CD
          ,VVD
          ,ETB		  TO_ETB_DT
          ,ETB_DAY	  TO_ETB_DAY
          ,D2_QTY	  D2_FCAST_QTY
          ,D4_QTY	  D4_FCAST_QTY
          ,D5_QTY	  D5_FCAST_QTY
          ,D7_QTY	  D7_FCAST_QTY
          ,R2_QTY	  R2_FCAST_QTY 
          ,R5_QTY	  R5_FCAST_QTY
          ,R9_QTY	  R9_FCAST_QTY
          ,O2_QTY	  O2_FCAST_QTY
          ,S2_QTY	  S2_FCAST_QTY
          ,O4_QTY	  O4_FCAST_QTY
          ,S4_QTY	  S4_FCAST_QTY
          ,O5_QTY	  O5_FCAST_QTY
          ,F2_QTY	  F2_FCAST_QTY
          ,A2_QTY	  A2_FCAST_QTY
          ,F4_QTY	  F4_FCAST_QTY
          ,A4_QTY	  A4_FCAST_QTY
          ,A5_QTY	  A5_FCAST_QTY
          ,F5_QTY	  F5_FCAST_QTY
          ,REMARK	
    	  ,TO_CHAR(TO_DATE(@[wk_st_dt], 'YYYYMMDD'), 'YYYY/MM/DD') 	WK_ST_DT
          ,TO_CHAR(TO_DATE(@[wk_end_dt], 'YYYYMMDD'), 'YYYY/MM/DD')	WK_END_DT
          ,DIV
          ,RPT_SEQ    -- HIDDEN     
    FROM REPO_IN_RESULT       
    WHERE  (
               D2_QTY
              +D4_QTY
              +D5_QTY
              +D7_QTY
              +R2_QTY  
              +R5_QTY
              +R9_QTY
              +O2_QTY
              +S2_QTY
              +O4_QTY
              +S4_QTY
              +O5_QTY
              +F2_QTY
              +A2_QTY
              +F4_QTY
              +A4_QTY
              +A5_QTY
              +F5_QTY 
           ) > 0  -- 0보다 큰것만 수집
	
    UNION ALL
    -- TOTAL
    SELECT '0' CRE_SEQ
          ,'111111' LVL
          ,NULL TO_YD_CD
          ,NULL VSL_LANE_CD
          ,NULL VVD
          ,NULL TO_ETB_DT
          ,NULL TO_ETB_DAY
          ,SUM(D2_QTY) D2_FCAST_QTY
          ,SUM(D4_QTY) D4_FCAST_QTY
          ,SUM(D5_QTY) D5_FCAST_QTY
          ,SUM(D7_QTY) D7_FCAST_QTY
          ,SUM(R2_QTY) R2_FCAST_QTY  
          ,SUM(R5_QTY) R5_FCAST_QTY
          ,SUM(R9_QTY) R9_FCAST_QTY
          ,SUM(O2_QTY) O2_FCAST_QTY
          ,SUM(S2_QTY) S2_FCAST_QTY
          ,SUM(O4_QTY) O4_FCAST_QTY
          ,SUM(S4_QTY) S4_FCAST_QTY
          ,SUM(O5_QTY) O5_FCAST_QTY
          ,SUM(F2_QTY) F2_FCAST_QTY
          ,SUM(A2_QTY) A2_FCAST_QTY
          ,SUM(F4_QTY) F4_FCAST_QTY
          ,SUM(A4_QTY) A4_FCAST_QTY
          ,SUM(A5_QTY) A5_FCAST_QTY
          ,SUM(F5_QTY) F5_FCAST_QTY
          ,NULL REMARK
    	  ,TO_CHAR(TO_DATE(@[wk_st_dt], 'YYYYMMDD'), 'YYYY/MM/DD')	WK_ST_DT
          ,TO_CHAR(TO_DATE(@[wk_end_dt], 'YYYYMMDD'), 'YYYY/MM/DD')	WK_END_DT
          ,NULL DIV
          ,NULL RPT_SEQ    -- HIDDEN     
    FROM REPO_IN_RESULT 
    
) 
ORDER BY TO_ETB_DT, TO_YD_CD ASC			]]></sql>
			<params>
				<param name="loc_cd" type="12" value="" out="N"/>
				<param name="wk_st_dt" type="12" value="" out="N"/>
				<param name="wk_end_dt" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
