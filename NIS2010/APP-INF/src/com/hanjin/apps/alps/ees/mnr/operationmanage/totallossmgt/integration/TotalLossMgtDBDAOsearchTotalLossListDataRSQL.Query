<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TotalLossMgtDBDAOsearchTotalLossListDataRSQL">
			<desc><![CDATA[searchTotalLossListData
2014-01-08 Jonghee HAN [CHM-201328248] Performance조회시 Recovery 금액 반영 수정 요청]]></desc>
			<sql><![CDATA[
#if (${work_type} == 'collection')
WITH CLT_PARAM 
AS (SELECT MTRD.TTL_LSS_NO, MTRD.TTL_LSS_DTL_SEQ, MTRD.MNR_INV_TP_CD, MTLC.CLT_AMT, MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(TO_CHAR(MTRH.TTL_LSS_DT, 'YYYYMM'), MTLC.CURR_CD, 'USD', MTLC.CLT_AMT) CLT_USD_AMT, MTLC.CURR_CD CLT_CURR_CD
      FROM MNR_TTL_LSS_RQST_HDR MTRH, MNR_TTL_LSS_RQST_DTL MTRD, MNR_TTL_LSS_CLT MTLC
     WHERE MTRH.TTL_LSS_NO = MTRD.TTL_LSS_NO
       AND MTRD.TTL_LSS_NO = MTLC.TTL_LSS_NO
       AND MTRD.TTL_LSS_DTL_SEQ IN MTLC.TTL_LSS_DTL_SEQ
    UNION ALL   
    SELECT MTRD.TTL_LSS_NO, MTRD.TTL_LSS_DTL_SEQ, MTRD.MNR_INV_TP_CD, BOD.CLT_FRT_AMT + BOD.CLT_TAX_AMT CLT_AMT, MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(TO_CHAR(MTRH.TTL_LSS_DT, 'YYYYMM'), BOD.BL_CURR_CD, 'USD', BOD.CLT_FRT_AMT + BOD.CLT_TAX_AMT) CLT_USD_AMT, BOD.BL_CURR_CD CLT_CURR_CD
      FROM MNR_TTL_LSS_RQST_HDR MTRH, MNR_TTL_LSS_RQST_DTL MTRD, BKG_OTS_DTL BOD
     WHERE MTRH.TTL_LSS_NO = MTRD.TTL_LSS_NO
       AND MTRD.INV_NO = BOD.CLT_BL_NO
       AND MTRD.MNR_INV_TP_CD = 'DS')
#end
SELECT
         A.TTL_LSS_NO
        ,MAX(A.RQST_OFC_CD) RQST_OFC_CD
        ,MAX(A.APRO_OFC_CD) APRO_OFC_CD
        ,MAX(DECODE(A.RESPB_OFC_CD,null,A.RQST_OFC_CD,'',A.RQST_OFC_CD,A.RESPB_OFC_CD)) AS RESPB_OFC_CD  
        ,TO_CHAR(MAX(A.TTL_LSS_DT), 'yyyy-mm-dd') TTL_LSS_DT
        ,TO_CHAR(GLOBALDATE_PKG.TIME_CONV_OFC_FNC(MNR_COMMON_PKG.MNR_GET_HOOFC_FNC(), MAX(A.RQST_DT),@[user_ofc_cd]), 'yyyy-mm-dd') RQST_DT
        ,MAX(A.TTL_LSS_STS_CD) TTL_LSS_STS_CD
        ,MAX(A.MNR_STS_REF_NO) MNR_STS_REF_NO
        ,MAX(A.TTL_LSS_CMPL_CD) TTL_LSS_CMPL_CD
        ,TO_CHAR(GLOBALDATE_PKG.TIME_CONV_OFC_FNC(MNR_COMMON_PKG.MNR_GET_HOOFC_FNC(),MAX(A.TTL_LSS_CFM_DT),@[user_ofc_cd]), 'yyyy-mm-dd') TTL_LSS_CFM_DT
        ,MAX(A.TTL_LSS_CFM_ID) TTL_LSS_CFM_ID
        ,MAX(A.TTL_LSS_RSN_CD) TTL_LSS_RSN_CD
        ,MAX(A.TTL_LSS_DTL_RSN_CD) TTL_LSS_DTL_RSN_CD
        ,MAX((SELECT MNR_CD_DP_DESC 
          FROM MNR_GEN_CD 
          WHERE PRNT_CD_ID=A.TTL_LSS_RSN_CD
            AND MNR_CD_ID=A.TTL_LSS_DTL_RSN_CD
         )) AS TTL_LSS_DTL_RSN_NM
        ,MAX(A.TTL_LSS_RMK) TTL_LSS_RMK
        ,MAX(A.FILE_SEQ) FILE_SEQ
        ,MAX(A.CRE_USR_ID) CRE_USR_ID
        ,TO_CHAR(MAX(A.CRE_DT), 'yyyy-mm-dd') CRE_DT
        ,MAX(A.UPD_USR_ID) UPD_USR_ID
        ,TO_CHAR(MAX(A.UPD_DT), 'yyyy-mm-dd') UPD_DT
        ,SUM(DECODE(B.MNR_INV_TP_CD, 'DV', 1)) DV_EQ_QTY
        ,SUM(DECODE(B.MNR_INV_TP_CD, 'DV', B.DPC_VAL_AMT)) DV_DV_VAL
        ,SUM(DECODE(B.MNR_INV_TP_CD, 'DV', TTL_LSS_BIL_AMT)) DV_EXP
        ,SUM(DECODE(B.MNR_INV_TP_CD, 'DV', B.DPC_VAL_AMT)) - SUM(DECODE(B.MNR_INV_TP_CD, 'DV', B.TTL_LSS_BIL_AMT)) DV_BAL
#if (${work_type} == 'collection')
        ,SUM(DECODE(C.MNR_INV_TP_CD, 'TP', 1, 0)) TP_EQ_QTY
        ,SUM(DECODE(B.MNR_INV_TP_CD, 'TP', B.DPC_VAL_AMT)) TP_DV_VAL
        ,MAX(DECODE(C.MNR_INV_TP_CD, 'TP', C.CLT_CURR_CD)) TP_CURR_CD
        ,SUM(DECODE(C.MNR_INV_TP_CD, 'TP', C.CLT_AMT)) TP_EXP
        ,SUM(DECODE(C.MNR_INV_TP_CD, 'TP', C.CLT_USD_AMT)) TP_USD_EXP
        ,SUM(DECODE(B.MNR_INV_TP_CD, 'TP', B.DPC_VAL_AMT)) - SUM(DECODE(C.MNR_INV_TP_CD, 'TP', C.CLT_AMT)) TP_BAL
        ,SUM(DECODE(C.MNR_INV_TP_CD, 'DS', 1, 0)) DS_EQ_QTY
        ,SUM(DECODE(B.MNR_INV_TP_CD, 'DS', B.DPC_VAL_AMT)) DS_DV_VAL
        ,MAX(DECODE(C.MNR_INV_TP_CD, 'DS', C.CLT_CURR_CD)) DS_CURR_CD
        ,SUM(DECODE(C.MNR_INV_TP_CD, 'DS', C.CLT_AMT)) DS_EXP
        ,SUM(DECODE(C.MNR_INV_TP_CD, 'DS', C.CLT_USD_AMT)) DS_USD_EXP
        ,SUM(DECODE(B.MNR_INV_TP_CD, 'DS', B.DPC_VAL_AMT)) - SUM(DECODE(C.MNR_INV_TP_CD, 'DS', C.CLT_AMT)) DS_BAL
#else       
        ,SUM(DECODE(B.MNR_INV_TP_CD, 'TP', 1)) TP_EQ_QTY
        ,SUM(DECODE(B.MNR_INV_TP_CD, 'TP', B.DPC_VAL_AMT)) TP_DV_VAL
        ,MAX(DECODE(B.MNR_INV_TP_CD, 'TP', B.CURR_CD)) TP_CURR_CD
        ,SUM(DECODE(B.MNR_INV_TP_CD, 'TP', TTL_LSS_BIL_AMT)) TP_EXP
        ,SUM(DECODE(B.MNR_INV_TP_CD, 'TP', MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(TO_CHAR(A.TTL_LSS_DT, 'YYYYMM'), B.CURR_CD, 'USD', B.TTL_LSS_BIL_AMT))) TP_USD_EXP
        ,SUM(DECODE(B.MNR_INV_TP_CD, 'TP', B.DPC_VAL_AMT)) - SUM(DECODE(B.MNR_INV_TP_CD, 'DV', B.TTL_LSS_BIL_AMT)) TP_BAL  
        ,SUM(DECODE(B.MNR_INV_TP_CD, 'DS', 1)) DS_EQ_QTY
        ,SUM(DECODE(B.MNR_INV_TP_CD, 'DS', B.DPC_VAL_AMT)) DS_DV_VAL
        ,MAX(DECODE(B.MNR_INV_TP_CD, 'DS', B.CURR_CD)) DS_CURR_CD
        ,SUM(DECODE(B.MNR_INV_TP_CD, 'DS', TTL_LSS_BIL_AMT)) DS_EXP
        ,SUM(DECODE(B.MNR_INV_TP_CD, 'DS', MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(TO_CHAR(A.TTL_LSS_DT, 'YYYYMM'), B.CURR_CD, 'USD', B.TTL_LSS_BIL_AMT))) DS_USD_EXP
        ,SUM(DECODE(B.MNR_INV_TP_CD, 'DS', B.DPC_VAL_AMT)) - SUM(DECODE(B.MNR_INV_TP_CD, 'DV', B.TTL_LSS_BIL_AMT)) DS_VAL
#end
        ,SUM(DECODE(B.MNR_INV_TP_CD, 'SC', 1)) SC_EQ_QTY
        ,SUM(DECODE(B.MNR_INV_TP_CD, 'SC', B.DPC_VAL_AMT)) SC_DV_VAL
        ,SUM(DECODE(B.MNR_INV_TP_CD, 'SC', TTL_LSS_INCM_AMT)) + SUM(DECODE(B.MNR_INV_TP_CD, 'SC', NVL(B.TTL_LSS_EXPN_AMT,0))) SC_EXP
        ,SUM(DECODE(B.MNR_INV_TP_CD, 'SC', B.DPC_VAL_AMT)) - SUM(DECODE(B.MNR_INV_TP_CD, 'DV', B.TTL_LSS_BIL_AMT)) SC_VAL
        ,SUM(DECODE(B.MNR_INV_TP_CD, 'IR', 1)) IR_EQ_QTY
        ,SUM(DECODE(B.MNR_INV_TP_CD, 'IR', B.DPC_VAL_AMT)) IR_DV_VAL
        ,SUM(DECODE(B.MNR_INV_TP_CD, 'IR', TTL_LSS_EXPN_AMT)) IR_EXP  
        ,SUM(DECODE(B.MNR_INV_TP_CD, 'IR', B.DPC_VAL_AMT)) - SUM(DECODE(B.MNR_INV_TP_CD, 'DV', B.TTL_LSS_BIL_AMT)) IR_VAL       
		,TO_CHAR(MAX(A.ACC_DT), 'yyyy-mm-dd') ACC_DT
        ,A.ACC_FLG
        ,A.ACC_VSL_CD
        ,A.ACC_SKD_VOY_NO
        ,A.ACC_SKD_DIR_CD
        ,A.ACC_PORT_CD
  FROM MNR_TTL_LSS_RQST_HDR A, MNR_TTL_LSS_RQST_DTL B
#if (${work_type} == 'collection')
     , CLT_PARAM C
#end
 WHERE A.TTL_LSS_NO = B.TTL_LSS_NO
#if (${work_type} == 'collection')
   AND C.TTL_LSS_NO(+) = B.TTL_LSS_NO
   AND C.TTL_LSS_DTL_SEQ(+) IN B.TTL_LSS_DTL_SEQ
#end
#if (${in_search_dt_tp} == 'R')
   AND A.RQST_DT BETWEEN GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd], TO_DATE(@[in_st_dt], 'yyyy-mm-dd'),MNR_COMMON_PKG.MNR_GET_HOOFC_FNC()) AND GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd], TO_DATE(@[in_end_dt], 'yyyy-mm-dd'),MNR_COMMON_PKG.MNR_GET_HOOFC_FNC())+0.99999    
#elseif (${in_search_dt_tp} == 'T')
   AND A.TTL_LSS_DT BETWEEN TO_DATE(@[in_st_dt], 'yyyy-mm-dd') AND TO_DATE(@[in_end_dt], 'yyyy-mm-dd')+0.99999
#elseif (${in_search_dt_tp} == 'C')
   AND A.TTL_LSS_CFM_DT BETWEEN GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd],TO_DATE(@[in_st_dt], 'yyyy-mm-dd'),MNR_COMMON_PKG.MNR_GET_HOOFC_FNC()) AND GLOBALDATE_PKG.TIME_CONV_OFC_FNC(@[user_ofc_cd], TO_DATE(@[in_end_dt], 'yyyy-mm-dd'),MNR_COMMON_PKG.MNR_GET_HOOFC_FNC())+0.99999
#end 
#if (${work_type} == 'collection')
   #if (${rhq_ofc_cd} != 'NYCRA')		
	   #if (${in_ofc_cd_tp} == 'R')
	      AND (A.RQST_OFC_CD = @[in_rqst_ofc_cd]  OR A.RESPB_OFC_CD = @[in_rqst_ofc_cd])  
	   #else 
	      AND A.APRO_OFC_CD = @[in_rqst_ofc_cd]
	   #end 
   #else
	   #if (${in_ofc_cd_tp} == 'R')
		  AND (A.RQST_OFC_CD IN (SELECT OFC_CD
                           FROM MNR_OFC_GEN_INFO
                          WHERE COST_CD = 'RPRINV'
                            AND MNR_GRP_TP_CD = 'OFC')
    	   OR A.RESPB_OFC_CD IN (SELECT OFC_CD
                           FROM MNR_OFC_GEN_INFO
                          WHERE COST_CD = 'RPRINV'
                            AND MNR_GRP_TP_CD = 'OFC'))
	   #else 
	      AND (A.APRO_OFC_CD IN (SELECT OFC_CD
                           FROM MNR_OFC_GEN_INFO
                          WHERE COST_CD = 'RPRINV'
                            AND MNR_GRP_TP_CD = 'OFC'))	
	   #end  
   #end
   #if (${in_status_tp} == 'P')
     AND A.TTL_LSS_STS_CD IN ('HA','HC')
   #else 
     AND A.TTL_LSS_STS_CD IN ('HE')
   #end 
#elseif (${work_type} == 'management')
AND A.TTL_LSS_STS_CD IN ('HR', 'AA')
AND A.APRO_OFC_CD = @[in_rqst_ofc_cd]
#end
#if (${in_ttl_lss_no} != '')
        AND A.TTL_LSS_NO IN (
                #foreach ($userTtlNo IN ${ttlNos})
                        #if($velocityCount < $ttlNos.size())
                                '$userTtlNo',
                        #else
                                '$userTtlNo'
                        #end
                #end                      
        )
#end
#if (${in_rqst_eq_no} != '')
	AND A.TTL_LSS_NO IN ( SELECT DISTINCT TTL_LSS_NO 
							FROM MNR_TTL_LSS_RQST_DTL
							WHERE RQST_EQ_NO IN (
								#foreach ($user_eq_no IN ${eqNos})
									#if($velocityCount < $eqNos.size())
										'$user_eq_no',
									#else
										'$user_eq_no'
									#end
								#end
								)
						)
#end
GROUP BY A.TTL_LSS_NO
        ,A.ACC_DT
        ,A.ACC_FLG
        ,A.ACC_VSL_CD
        ,A.ACC_SKD_VOY_NO
        ,A.ACC_SKD_DIR_CD
        ,A.ACC_PORT_CD			]]></sql>
			<params>
				<param name="user_ofc_cd" type="12" value="" out="N"/>
				<param name="in_st_dt" type="12" value="" out="N"/>
				<param name="in_end_dt" type="12" value="" out="N"/>
				<param name="in_rqst_ofc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
