<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="OnhireApprovalDBDAOsearchEqrReqListValidationDataRSQL">
			<desc><![CDATA[EQR Req List의 typs별 total 과 실제 저장된 type별 totla 과 비교하여 같지 않은 경우는 에러 처리를 한다.]]></desc>
			<sql><![CDATA[
WITH LV_REQ_LIST  AS
(
SELECT A.LSE_RQST_NO,
       B.CNTR_TPSZ_CD,
       B.CNTR_QTY
FROM   EQR_CTRL_ONH_PLN_APRO A, EQR_CTRL_ONH_PLN_APRO_QTY B
WHERE A.CRE_DT > SYSDATE - 15
AND   A.ONH_PLN_YRWK=B.ONH_PLN_YRWK
AND   A.LCC_CD = B.LCC_CD
AND   A.EQ_LSTM_CD = B.EQ_LSTM_CD
AND   A.LSE_PLN_SEQ = B.LSE_PLN_SEQ
AND   A.LSE_RQST_NO =@[reqno]
),
EQR_RQST_LIST_TOTAL AS
(
SELECT A.LSE_RQST_NO REQNO,
 #foreach($key IN ${cntr_tpsz_cd})
    #if($velocityCount < $cntr_tpsz_cd.size())
       SUM(DECODE(A.CNTR_TPSZ_CD,'$key',A.CNTR_QTY,0)) QTY$key,
    #else
       SUM(DECODE(A.CNTR_TPSZ_CD,'$key',A.CNTR_QTY,0)) QTY$key
    #end
 #end

FROM LV_REQ_LIST A
GROUP BY A.LSE_RQST_NO
ORDER BY LSE_RQST_NO
),
LSE_RQST_LIST_TOTAL AS
(
SELECT
      LSE_RQST_NO REQNO,
       #foreach($key IN ${cntr_tpsz_cd})
           #if($velocityCount < $cntr_tpsz_cd.size())
               SUM(DECODE(TPSZ, '$key', QTY, 0)) QTY_$key,
           #else
               SUM(DECODE(TPSZ, '$key', QTY, 0)) QTY_$key
           #end
       #end
FROM (
SELECT B.CNTR_TPSZ_CD TPSZ,
B.ONH_QTY QTY,
A.LSE_RQST_NO
FROM LSE_ONH_APRO A,
LSE_ONH_APRO_QTY B
WHERE A.CNTR_ONH_AUTH_NO = B.CNTR_ONH_AUTH_NO
AND A.AGMT_CTY_CD = B.AGMT_CTY_CD
AND A.AGMT_SEQ = B.AGMT_SEQ
AND A.DELT_FLG = 'N'
AND A.LSE_RQST_NO = @[reqno] 
)
GROUP BY LSE_RQST_NO
)

SELECT 
      A.REQNO,
      CASE WHEN
      #foreach($key IN ${cntr_tpsz_cd})
           #if($velocityCount < $cntr_tpsz_cd.size())
                A.QTY$key < QTY_$key OR
           #else
                 A.QTY$key < QTY_$key 
           #end
       #end
      THEN 'E'
      ELSE 'SU'
      END REUSTT_FLG
FROM EQR_RQST_LIST_TOTAL A,
     LSE_RQST_LIST_TOTAL B
WHERE A.REQNO = B.REQNO			]]></sql>
			<params>
				<param name="reqno" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
