<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ContainerMovementMgtDBDAOModifyLastBkgNoUSQL">
			<desc><![CDATA[Last booking No를 update하기 위한 작업]]></desc>
			<sql><![CDATA[
UPDATE CTM_MOVEMENT CTM 
SET CTM.LST_BKG_NO = @[last_bkg_no],
  CTM.LST_BL_NO = @[last_bl_no],
  CTM.UPD_USR_ID = 'LSTBKG'
WHERE CTM.CNTR_NO = @[cntr_no]
  AND (CTM.LST_BKG_NO IS NULL OR CTM.LST_BKG_NO <> @[last_bkg_no] OR CTM.LST_BL_NO IS NULL OR CTM.LST_BL_NO <> @[last_bl_no])
  AND CTM.CNMV_YR || TO_CHAR(CTM.CNMV_SEQ, '00000') || CTM.CNMV_SPLIT_NO
        >= CASE WHEN @[bkg_cgo_tp_cd] = 'F'
                  THEN NVL(
                         (SELECT /*+ INDEX_ASC(MOV XFN1CTM_MOVEMENT) */
                            MOV.CNMV_YR || TO_CHAR(MOV.CNMV_SEQ, '00000') || MOV.CNMV_SPLIT_NO
                          FROM CTM_MOVEMENT MOV
                          WHERE MOV.CNTR_NO = CTM.CNTR_NO
                            AND MOV.CNMV_CYC_NO = @[cnmv_cyc_no]
                            AND MOV.MVMT_STS_CD IN ('OP', 'OC')
                            AND ROWNUM = 1
                         ),
                         NVL(
                           (SELECT /*+ INDEX_ASC(MOV XFN1CTM_MOVEMENT) */
                              MOV.CNMV_YR || TO_CHAR(MOV.CNMV_SEQ, '00000') || MOV.CNMV_SPLIT_NO
                            FROM CTM_MOVEMENT MOV
                            WHERE MOV.CNTR_NO = CTM.CNTR_NO
                              AND MOV.CNMV_CYC_NO = (TO_NUMBER(@[cnmv_cyc_no]) - 1)
                              AND MOV.MVMT_STS_CD IN ('OP', 'OC')
                              AND ROWNUM = 1
                           ),
                           (SELECT /*+ INDEX_ASC(MOV XFN1CTM_MOVEMENT) */
                              MOV.CNMV_YR || TO_CHAR(MOV.CNMV_SEQ, '00000') || MOV.CNMV_SPLIT_NO
                            FROM CTM_MOVEMENT MOV
                            WHERE MOV.CNTR_NO = CTM.CNTR_NO
                              AND MOV.CNMV_CYC_NO = @[cnmv_cyc_no]
                              AND ROWNUM = 1
                           )
                         )
                       )
                ELSE NVL(
                       (SELECT /*+ INDEX_ASC(MOV XFN1CTM_MOVEMENT) */
                          MOV.CNMV_YR || TO_CHAR(MOV.CNMV_SEQ, '00000') || MOV.CNMV_SPLIT_NO
                        FROM CTM_MOVEMENT MOV
                        WHERE MOV.CNTR_NO = CTM.CNTR_NO
                          AND MOV.CNMV_CYC_NO = @[cnmv_cyc_no]
                          AND MOV.MVMT_STS_CD = 'VL'
                          AND ROWNUM = 1
                       ),
                       NVL(
                         (SELECT /*+ INDEX_ASC(MOV XFN1CTM_MOVEMENT) */
                            MOV.CNMV_YR || TO_CHAR(MOV.CNMV_SEQ, '00000') || MOV.CNMV_SPLIT_NO
                          FROM CTM_MOVEMENT MOV
                          WHERE MOV.CNTR_NO = CTM.CNTR_NO
                            AND MOV.CNMV_CYC_NO = (TO_NUMBER(@[cnmv_cyc_no]) - 1)
                            AND MOV.MVMT_STS_CD = 'VL'
                            AND ROWNUM = 1
                         ),
                         (SELECT /*+ INDEX_ASC(MOV XFN1CTM_MOVEMENT) */
                            MOV.CNMV_YR || TO_CHAR(MOV.CNMV_SEQ, '00000') || MOV.CNMV_SPLIT_NO
                          FROM CTM_MOVEMENT MOV
                          WHERE MOV.CNTR_NO = CTM.CNTR_NO
                            AND MOV.CNMV_CYC_NO = @[cnmv_cyc_no]
                            AND ROWNUM = 1
                         )
                       )
                     )
           END
  AND CTM.CNMV_YR || TO_CHAR(CTM.CNMV_SEQ, '00000') || CTM.CNMV_SPLIT_NO
        <= NVL(
             (SELECT /*+ INDEX_ASC(MOV XFN1CTM_MOVEMENT) */
                MOV.CNMV_YR || TO_CHAR(MOV.CNMV_SEQ, '00000') || MOV.CNMV_SPLIT_NO
              FROM CTM_MOVEMENT MOV
              WHERE MOV.CNTR_NO = CTM.CNTR_NO
                AND MOV.CNMV_CYC_NO = @[cnmv_cyc_no]
                AND MOV.MVMT_STS_CD = 'MT'
                AND ROWNUM = 1
             ),
             (SELECT /*+ INDEX_DESC(MOV XFN1CTM_MOVEMENT) */
                MOV.CNMV_YR || TO_CHAR(MOV.CNMV_SEQ, '00000') || MOV.CNMV_SPLIT_NO
              FROM CTM_MOVEMENT MOV
              WHERE MOV.CNTR_NO = CTM.CNTR_NO
                AND MOV.CNMV_CYC_NO = @[cnmv_cyc_no]
                AND ROWNUM = 1
             )
           )			]]></sql>
			<params>
				<param name="last_bkg_no" type="12" value="" out="N"/>
				<param name="last_bl_no" type="12" value="" out="N"/>
				<param name="cntr_no" type="12" value="" out="N"/>
				<param name="bkg_cgo_tp_cd" type="12" value="" out="N"/>
				<param name="cnmv_cyc_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
