<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ChassisMgsetInvoiceDBDAOsearchCHSSCNOReportDataRSQL">
			<desc><![CDATA[S/C NO 단위의 CHASS AMOUNT 데이터 조회
2014-07-02 CHM-201430891, SQL 수정 (김기철-설계, 신용찬-코딩)]]></desc>
			<sql><![CDATA[
WITH LV_CHSS_LIST AS
(
    SELECT A.INV_SC_NO,
           SUBSTR(A.SC_CTRT_PTY_CD0,1,1) AS SC_CUST_TP_CD,
           SUBSTR(A.SC_CTRT_PTY_CD0,2) AS SC_CTRT_PTY_CD,
           DECODE(SUBSTR(A.SC_CTRT_PTY_CD0,1,1),'N',A.ACT_CUST_CD0,SUBSTR(A.SC_CTRT_PTY_CD0,2)) AS ACT_CUST_CD,
           A.COST_YRMON,
           A.SCC_CD,
           A.YD_CD,
           A.INV_BKG_TERM_CD,
           A.INV_BKG_NO, 
           A.INV_CUST_EQ_NO,
           A.EQ_FM_MVMT_CD,
           A.BND_CD,
           A.EQ_EXPT_FLG,
           A.EQ_FM_MVMT_DT,       
           A.PAY_LSE_CHG_TTL_AMT
    FROM
    (
        SELECT 
               INV_SC_NO,
               B.AGMT_ACT_CNT_CD||B.AGMT_ACT_CUST_SEQ ACT_CUST_CD0,
               (
                   SELECT M.RVIS_CNTR_CUST_TP_CD||Z.CUST_CNT_CD||Z.CUST_SEQ
                   FROM  PRI_SP_HDR P
                        ,PRI_SP_CTRT_PTY Z 
                        ,MDM_CUSTOMER M
                   WHERE A.INV_SC_NO          = P.SC_NO
                   AND   P.PROP_NO            = Z.PROP_NO
                   AND   Z.PRC_CTRT_PTY_TP_CD = 'C'
                   AND   Z.CUST_CNT_CD        = M.CUST_CNT_CD
                   AND   Z.CUST_SEQ           = M.CUST_SEQ
                   AND   A.EQ_FM_MVMT_CD      <> 'MT'
                   AND   LTRIM(A.INV_BKG_TERM_CD) IS NOT NULL
                   AND   B.BKG_NO IS NOT NULL
                   AND   ROWNUM=1
               ) SC_CTRT_PTY_CD0,
               NVL(C.SCC_CD, 'XXXXX') SCC_CD,
			   A.EQ_FM_YD_CD YD_CD,
               COST_YRMON,
               A.INV_BKG_TERM_CD,
               A.INV_BKG_NO,
               A.INV_CUST_EQ_NO,
               A.EQ_FM_MVMT_CD,
               A.EQ_BKG_IO_BND_CD AS BND_CD,
               A.EQ_EXPT_FLG,
               A.EQ_FM_MVMT_DT,       
               NVL(DECODE(A.CHG_CD, 'PDM', A.PAY_LSE_CHG_TTL_AMT,
                                    'ONT', A.PAY_LSE_CHG_TTL_AMT,
                                    'TAX', A.PAY_TAX_AMT,
                                    'CRD', A.PAY_CR_AMT
                   ),0) PAY_LSE_CHG_TTL_AMT
                  
        FROM CGM_LSE_CHG_DTL A
            ,MDM_LOCATION C
            ,BKG_BOOKING B
        WHERE A.AGMT_SEQ > 50000
        AND   A.EQ_KND_CD               = 'Z'
        AND   A.PAY_LSE_CHG_STS_CD      = 'C' 
        AND   SUBSTR(A.EQ_FM_YD_CD,1,5) = C.LOC_CD(+)
        AND   A.INV_BKG_NO              = B.BKG_NO(+)
        AND   A.COST_YRMON BETWEEN @[from_bse_dt] AND @[to_bse_dt]

  #if (${search_sc_no} != '')
      -- S/C NO
  	AND   A.INV_SC_NO IN (
  		 #foreach($key IN ${arr_sc_cd})
  		  	#if($velocityCount < $arr_sc_cd.size())
  				'$key', 
  			#else 
  				'$key' 
  			#end 
  		#end 
  			           )
  #end

  #if (${search_yd_cd} != '')
      -- Yard Code
  	AND   A.EQ_FM_YD_CD IN (
  		 #foreach($key IN ${arr_yd_cd})
  		  	#if($velocityCount < $arr_yd_cd.size())
  				'$key', 
  			#else 
  				'$key' 
  			#end 
  		#end 
  			           )
  #end
/* 추가영역 시작 CHM-201640200 */                                           
    UNION ALL
        SELECT 
               EQ_TO_SC_NO INV_SC_NO,
               B.AGMT_ACT_CNT_CD||B.AGMT_ACT_CUST_SEQ ACT_CUST_CD0,
               (
                   SELECT M.RVIS_CNTR_CUST_TP_CD||Z.CUST_CNT_CD||Z.CUST_SEQ
                   FROM  PRI_SP_HDR P
                        ,PRI_SP_CTRT_PTY Z 
                        ,MDM_CUSTOMER M
                   WHERE A.EQ_TO_SC_NO        = P.SC_NO
                   AND   P.PROP_NO            = Z.PROP_NO
                   AND   Z.PRC_CTRT_PTY_TP_CD = 'C'
                   AND   Z.CUST_CNT_CD        = M.CUST_CNT_CD
                   AND   Z.CUST_SEQ           = M.CUST_SEQ
                   AND   LTRIM(A.EQ_TO_BKG_TERM_CD) IS NOT NULL
                   AND   B.BKG_NO IS NOT NULL
                   AND   ROWNUM=1
               ) SC_CTRT_PTY_CD0,
               NVL(C.SCC_CD, 'XXXXX') SCC_CD,
			   A.EQ_TO_YD_CD YD_CD,
               COST_YRMON,
               A.EQ_TO_BKG_TERM_CD INV_BKG_TERM_CD,
               A.EQ_TO_BKG_NO INV_BKG_NO,
               A.INV_CUST_EQ_NO,
               A.EQ_FM_MVMT_CD,
               A.EQ_BKG_IO_BND_CD AS BND_CD,
               A.EQ_EXPT_FLG,
               A.EQ_FM_MVMT_DT,       
               NVL(DECODE(A.CHG_CD, 'PDM', A.PAY_LSE_CHG_TTL_AMT,
                                    'ONT', A.PAY_LSE_CHG_TTL_AMT,
                                    'TAX', A.PAY_TAX_AMT,
                                    'CRD', A.PAY_CR_AMT
                   ),0) PAY_LSE_CHG_TTL_AMT
                  
        FROM CGM_LSE_CHG_DTL A
            ,MDM_LOCATION C
            ,BKG_BOOKING B
        WHERE A.AGMT_SEQ > 50000
        AND   A.EQ_KND_CD               = 'Z'
        AND   A.PAY_LSE_CHG_STS_CD      = 'C' 
        AND   SUBSTR(A.EQ_TO_YD_CD,1,5) = C.LOC_CD(+)
        AND   A.EQ_TO_BKG_NO            = B.BKG_NO(+)
        AND   A.INV_BKG_NO is NULL
        AND   A.COST_YRMON BETWEEN @[from_bse_dt] AND @[to_bse_dt]

  #if (${search_sc_no} != '')
      -- S/C NO
  	AND   A.EQ_TO_SC_NO IN (
  		 #foreach($key IN ${arr_sc_cd})
  		  	#if($velocityCount < $arr_sc_cd.size())
  				'$key', 
  			#else 
  				'$key' 
  			#end 
  		#end 
  			           )
  #end

  #if (${search_yd_cd} != '')
      -- Yard Code
  	AND   A.EQ_TO_YD_CD IN (
  		 #foreach($key IN ${arr_yd_cd})
  		  	#if($velocityCount < $arr_yd_cd.size())
  				'$key', 
  			#else 
  				'$key' 
  			#end 
  		#end 
  			           )
  #end
/* 추가영역 끝 CHM-201640200 */  
    ) A
)

,LV_CHSS_AMT AS
(
    SELECT INV_SC_NO,
           SC_CTRT_PTY_CD,
           SC_CUST_TP_CD,
           ACT_CUST_CD,
           NVL(A.SCC_CD, 'XXXXX') SCC_CD,
		   YD_CD,
           COST_YRMON,
           INV_BKG_TERM_CD,
           BND_CD,
           EQ_EXPT_FLG,
           SUM(PAY_LSE_CHG_TTL_AMT) CHSS_AMT,
           COUNT(DISTINCT INV_BKG_NO||INV_CUST_EQ_NO) CHSS_QTY
    FROM LV_CHSS_LIST A
    GROUP BY INV_SC_NO
            ,SC_CTRT_PTY_CD
            ,SC_CUST_TP_CD
            ,ACT_CUST_CD
            ,A.SCC_CD
			,YD_CD
            ,COST_YRMON
            ,INV_BKG_TERM_CD
            ,EQ_EXPT_FLG
            ,BND_CD 
                
)

SELECT INV_SC_NO SC_NO,
       SC_CTRT_PTY_CD CUST_CD,
       (
          SELECT B.CUST_LGL_ENG_NM
          FROM   MDM_CUSTOMER B
          WHERE  SUBSTR(SC_CTRT_PTY_CD,1,2) = B.CUST_CNT_CD
          AND    SUBSTR(SC_CTRT_PTY_CD,3)   = B.CUST_SEQ
       ) CUST_NM,
       (
          SELECT INTG_CD_VAL_DESC
          FROM COM_INTG_CD_DTL
          WHERE INTG_CD_ID     = 'CD00697'
          AND INTG_CD_VAL_CTNT = SC_CUST_TP_CD
       ) CUST_KIND,
       ACT_CUST_CD CUST_ACT_CD,
       (
          SELECT B.CUST_LGL_ENG_NM
          FROM   MDM_CUSTOMER B
          WHERE  SUBSTR(ACT_CUST_CD,1,2) = B.CUST_CNT_CD
          AND    SUBSTR(ACT_CUST_CD,3) =   B.CUST_SEQ
       ) CUST_ACT_NM,
       COST_YRMON YEARMONTH,
       SCC_CD,
	   YD_CD,
       BND_CD BOUND_CD,
       INV_BKG_TERM_CD BL_TERM,
       EQ_EXPT_FLG AS EXEMPT,
       '' BILL_DAY,
       '' BILL_DAY_AVG,       
       CHSS_AMT AMT_RENT,
       CHSS_QTY AMT_BOX,
       DECODE(CHSS_QTY, 0, 0, ROUND(CHSS_AMT/CHSS_QTY,2)) AMT_AVG
FROM  LV_CHSS_AMT
GROUP BY INV_SC_NO
        ,SC_CTRT_PTY_CD
        ,SC_CUST_TP_CD
        ,ACT_CUST_CD
        ,SCC_CD
        ,YD_CD
        ,COST_YRMON
        ,INV_BKG_TERM_CD
        ,EQ_EXPT_FLG
        ,BND_CD
        ,CHSS_AMT
        ,CHSS_QTY
ORDER BY INV_SC_NO
        ,SC_CTRT_PTY_CD
        ,SC_CUST_TP_CD
        ,ACT_CUST_CD
        ,COST_YRMON
        ,SCC_CD
		,YD_CD
        ,BND_CD
        ,INV_BKG_TERM_CD
        ,EQ_EXPT_FLG			]]></sql>
			<params>
				<param name="from_bse_dt" type="12" value="" out="N"/>
				<param name="to_bse_dt" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
