<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="InvoiceIssueCollectionMgtDBDAOSearchBookingVtInvoiceRSQL">
			<desc><![CDATA[InvoiceIssueCollectionMgtDBDAOSearchBookingVtInvoiceRSQL]]></desc>
			<sql><![CDATA[
select  T.*
       ,''														as DMDT_INV_STS_NM
	   ,''														as DMDT_AR_IF_CD
	   ,''														as AR_IF_DT
	   ,'' 														as AR_IF_OFC_CD
	   ,'' 														as AR_IF_USR_ID
	   ,'' 														as AR_IF_USR_NM
	   ,''														as CR_INV_NO
	   ,''														as INV_RMK2
	   ,0														as AFT_INV_ADJ_AMT
	   ,1														as INV_XCH_RT
       ,TAX_RTO													as INV_TAX_RTO
       ,case when nvl(TAX_RTO, 0) = 0
			 then 0
             else INV_CHG_AMT/TAX_RTO
        end														as TAX_AMT
       ,case when nvl(TAX_RTO, 0) = 0
             then INV_CHG_AMT
             else INV_CHG_AMT + INV_CHG_AMT/TAX_RTO
        end 													as INV_AMT
	   ,to_char(sysdate, 'YYYYMMDD') 							as ISSUE_DAY
	   ,''														as INV_PRT_FLG
	   ,'' 														as CR_AR_YN
	   ,T.ACT_PAYR_CNT_CD || lpad(T.ACT_PAYR_SEQ, 6, '0') 		as PAYER_CD
	   ,decode
	   (
			(
				select  DMDT_PAYR_NM                                                                                                                                            
				  from  DMT_PAYR_INFO                                                                                                                                             
				 where  SYS_AREA_GRP_ID  = 
						(
							select  SYS_AREA_GRP_ID                                                                                                               
							  from  COM_SYS_AREA_GRP_ID                                                                                                             
							 where  CNT_CD = 
									(
										select  substr(LOC_CD, 1, 2)                                                                                          
										  from  MDM_ORGANIZATION                                                                                                
										 where  OFC_CD = T.CRE_OFC_CD
									)
							   and  CO_IND_CD = 'H'
						)
				   and CUST_CNT_CD = T.ACT_PAYR_CNT_CD                                                                                                                            
				   and CUST_SEQ    = T.ACT_PAYR_SEQ
			)
			,null
			,(
				decode
				(
					(
						select  LOCL_NM                                                                                                                                     
						  from  MDM_CR_CUST                                                                                                                                   
						 where  CUST_CNT_CD = T.ACT_PAYR_CNT_CD                                                                                                              
						   and  CUST_SEQ    = T.ACT_PAYR_SEQ                                                                                                                   
						   and  LOCL_NM is not null
					)
				   ,null
				  ,(
						select  case when T.ACT_PAYR_CNT_CD = '00' 
									then (
											select  VNDR_LGL_ENG_NM                                                                             
											  from  MDM_VendOR                                                                                                 
											 where  VNDR_SEQ = T.ACT_PAYR_SEQ                                                                                 
											   and  VNDR_LGL_ENG_NM is not null
										  )  
								else (
										select  CUST_LGL_ENG_NM                                                                                                                
										  from  MDM_CUSTOMER                                                                                                                     
										 where  CUST_CNT_CD = T.ACT_PAYR_CNT_CD                                                                                                 
										   and  CUST_SEQ    = T.ACT_PAYR_SEQ                                                                                                     
										   and  CUST_LGL_ENG_NM is not null
									  )
								end MDM_NAME                                                                                                                                
						  from  DUAL
					)
				   ,(
						select  LOCL_NM                                                                                                                                    
						  from  MDM_CR_CUST                                                                                                                                   
						 where  CUST_CNT_CD = T.ACT_PAYR_CNT_CD                                                                                                              
						   and  CUST_SEQ    = T.ACT_PAYR_SEQ                                                                                                                   
						   and  LOCL_NM is not null
					) 
				)                                                                                                                                                    
			)
		   ,(
				select  DMDT_PAYR_NM                                                                                                                                             
				  from  DMT_PAYR_INFO                                                                                                                                              
				 where  SYS_AREA_GRP_ID = 
						(
							select  SYS_AREA_GRP_ID                                                                                                                
							  from  COM_SYS_AREA_GRP_ID                                                                                                               
							 where  CNT_CD = 
									(
										select  substr(LOC_CD, 1, 2)                                                                                            
										  from  MDM_ORGANIZATION                                                                                                  
										 where  OFC_CD = T.CRE_OFC_CD
									)                                                                                           
							   and  CO_IND_CD = 'H'
						)
				   and  CUST_CNT_CD = T.ACT_PAYR_CNT_CD
				   and  CUST_SEQ    = T.ACT_PAYR_SEQ
			)
		)  								as ACT_PAYR_CUST_NM        -- E-mail Sendìš© Customer

  from  (
			select  T1.DMDT_INV_NO
				   ,to_char(max(T1.CRE_DT), 'YYYY-MM-DD')	    				as CRE_DT
				   ,max(T1.CRE_OFC_CD)                          				as CRE_OFC_CD
				   ,max(T1.DMDT_INV_STS_CD)                     				as DMDT_INV_STS_CD
				   ,max(T1.DMDT_VT_INV_STS_CD)                  				as DMDT_VT_INV_STS_CD

				   ,max(T1.BKG_NO)												as BKG_NO
				   ,max(T1.BL_NO)												as BL_NO
				   ,max(T1.DMDT_TRF_CD)											as DMDT_TRF_CD
				   ,max(T3.SC_NO)												as SC_NO
				   ,max(T3.RFA_NO)												as RFA_NO
								
				   ,max(T1.VSL_CD) || max(T1.SKD_VOY_NO) || max(T1.SKD_DIR_CD)	as VVD_CD
								
				   ,max(T1.POR_CD)												as POR_CD
				   ,max(T1.POL_CD)												as POL_CD
				   ,max(T1.POD_CD)												as POD_CD
				   ,max(T1.DEL_CD)												as DEL_CD
								
				   ,max(T1.ACT_PAYR_CNT_CD)										as ACT_PAYR_CNT_CD
				   ,max(T1.ACT_PAYR_SEQ)										as ACT_PAYR_SEQ

				   ,max(T1.BKG_RCV_TERM_CD ) || '/' || max(T1.BKG_DE_TERM_CD)	as RD
				   ,'' 															as PAYR_CNTC_PNT_PHN_NO
				   ,'' 															as PAYR_CNTC_PNT_FAX_NO
				   ,'' 															as PAYR_CNTC_PNT_EML
				   
				#if (${caller} == '4016')
				   ,max(T1.DMDT_PAYR_CNTC_PNT_NM)								as DMDT_PAYR_CNTC_PNT_NM
				   ,lpad(max(T1.VNDR_SEQ), 6, '0') 								as TRUCKER_CD
				#else 
				   ,'' 															as DMDT_PAYR_CNTC_PNT_NM
				   ,lpad(max(T4.VNDR_SEQ), 6, '0')                              as TRUCKER_CD
				#end

				   ,max(T1.CUST_CNTC_PNT_SEQ)									as CUST_CNTC_PNT_SEQ

				   ,max(T4.BZC_TRF_CURR_CD)										as CHG_CURR_CD
				   ,max(T4.BZC_TRF_CURR_CD)										as INV_CURR_CD

				   ,sum(nvl(T4.ORG_CHG_AMT,     0))								as MN_ORG_CHG_AMT
				   ,sum(nvl(T4.SC_RFA_EXPT_AMT, 0)) 							as DMDT_EXPT_AMT
				   ,sum(nvl(T4.AFT_EXPT_DC_AMT, 0))								as CHG_DC_AMT	   
				   ,sum(nvl(T4.BIL_AMT, 		0))								as MN_BIL_AMT

				   ,COUNT(*)													as CNTR_CNT
				   ,0															as DC_AMT
                   ,sum(nvl(T4.BIL_AMT, 0))										as INV_CHG_AMT

				   ,max(T1.INV_REF_NO)											as INV_REF_NO
				   ,max(T2.SYS_AREA_GRP_ID)										as SVR_ID
				   ,max(T1.CXL_RMK)												as INV_RMK1
				   ,max(T1.IDA_EXPN_TAX_RT)										as IDA_EXPN_TAX_RT
				   ,max(T1.IDA_EXPN_TAX)										as IDA_EXPN_TAX
				   ,max(T1.IDA_EDU_TAX_RT)										as IDA_EDU_TAX_RT
				   ,max(T1.IDA_EDU_TAX)											as IDA_EDU_TAX
				   ,max(T1.IDA_HIGH_EDU_TAX_RT)									as IDA_HIGH_EDU_TAX_RT
				   ,max(T1.IDA_HIGH_EDU_TAX)									as IDA_HIGH_EDU_TAX
					   
				   ,max(T1.TAX_RTO)												as TAX_RTO
			  from  DMT_INV_MN 			T1
				   ,DMT_INV_DTL 		T2
				   ,DMT_CHG_BKG_CNTR	T3
				   ,DMT_CHG_CALC    	T4
				   
			 where  T1.DMDT_INV_NO         = @[s_invoice_no]
			   and  T1.CRE_OFC_CD 	       = @[ofc_cd]
			   and  T1.DMDT_TRF_CD         = @[s_dmdt_trf_cd]
			   and  T1.DMDT_INV_STS_CD     = 'X'
			   and  T1.DMDT_VT_INV_STS_CD  = 'C'
			   
			   and  T1.DMDT_INV_NO 	       = T2.DMDT_INV_NO
			   and  T1.CRE_OFC_CD          = T2.CRE_OFC_CD
			   
			   and  T2.SYS_AREA_GRP_ID     = T3.SYS_AREA_GRP_ID
			   and  T2.CNTR_NO             = T3.CNTR_NO
			   and  T2.CNTR_CYC_NO         = T3.CNTR_CYC_NO
			   --and  T1.BKG_NO			   = T3.BKG_NO
			   
			   and  T2.SYS_AREA_GRP_ID     = T4.SYS_AREA_GRP_ID
			   and  T2.CNTR_NO             = T4.CNTR_NO
			   and  T2.CNTR_CYC_NO         = T4.CNTR_CYC_NO
			   and  T2.DMDT_TRF_CD         = T4.DMDT_TRF_CD
			   and  T2.DMDT_CHG_LOC_DIV_CD = T4.DMDT_CHG_LOC_DIV_CD
			   and  T2.CHG_SEQ 			   = T4.CHG_SEQ
               AND  T4.DMDT_CHG_STS_CD IN ( 'F','C' )
			   
			group by T1.DMDT_INV_NO
		) T			]]></sql>
			<params>
				<param name="s_invoice_no" type="12" value="" out="N"/>
				<param name="ofc_cd" type="12" value="" out="N"/>
				<param name="s_dmdt_trf_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
