<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ChargeCalculationDBDAOSearchChargeDeletionRequestRSQL">
			<desc><![CDATA[Request 된 Charge Deletion 정보를 수정한다.]]></desc>
			<sql><![CDATA[
select  distinct
	    C.SYS_AREA_GRP_ID 										as SVR_ID
       ,C.CNTR_CYC_NO
       ,C.DMDT_CHG_LOC_DIV_CD
       ,C.DMDT_TRF_CD
       ,B.BKG_NO
       ,C.OFC_CD
       ,C.CHG_SEQ
       ,(
			select  INTG_CD_VAL_DP_DESC
			  from  COM_INTG_CD_DTL
             where  INTG_CD_ID = 'CD03382'
               and  INTG_CD_VAL_CTNT = DD.DMDT_DELT_RQST_STS_CD
        )														as CHG_DELT_PROC_STS		--// R:Request, B:BB Approval, E:BB Reject, Q:RHQ Approval, F:RHQ Reject, H:HO Approval, G:HO Reject
	   ,case 
			when DD.DELT_SPEC_RSN_RMK_SEQ is null 
				then 'N'
				else 'Y' 
        end														as DELT_SPEC_RSN_RMK_YN
	   ,DD.DELT_SPEC_RSN_RMK_SEQ
       ,C.DMDT_CHG_STS_CD
       ,C.CNTR_NO
       ,B.CNTR_TPSZ_CD
       ,DD.RQST_USR_ID
       ,DD.RQST_OFC_CD
       ,DD.RQST_DT
       ,DD.DMDT_CHG_DELT_RSN_CD
       ,DD.DMDT_CHG_DELT_SPEC_RSN_CD
       ,DD.DELT_SPEC_RSN_RMK_SEQ
	   ,( 
			select  INTG_CD_VAL_DP_DESC
			  from  COM_INTG_CD_DTL
             where  INTG_CD_ID = 'CD01965'
               and  INTG_CD_VAL_CTNT = DD.DMDT_CHG_DELT_RSN_CD
        )  														as DELT_RSN_DESC
       ,DD.DELT_SEQ
       ,DD.DELT_RMK AS CORR_RMK
       ,C.FM_MVMT_YD_CD
       ,C.TO_MVMT_YD_CD
       ,C.FM_MVMT_STS_CD
       ,C.TO_MVMT_STS_CD	
       ,C.FT_DYS
       ,C.FX_FT_OVR_DYS
       ,to_char(C.FM_MVMT_DT, 'YYYYMMDD') 						as FM_MVMT_DT
       ,to_char(C.TO_MVMT_DT, 'YYYYMMDD') 						as TO_MVMT_DT
       ,to_char(C.FT_CMNC_DT, 'YYYYMMDD') 						as FT_CMNC_DT
       ,to_char(C.FT_END_DT, 'YYYYMMDD') 						as FT_END_DT	
       ,C.BZC_TRF_CURR_CD
       ,C.ORG_CHG_AMT
       ,C.SC_RFA_EXPT_AMT
       ,C.AFT_EXPT_DC_AMT
       ,C.BIL_AMT	
       ,decode(C.CHG_SEQ, 1, 'G', 'B') 							as GEN_BAL
       ,nvl(B.SOC_FLG, 'N') AS SOC_FLG
       ,case
		when C.DMDT_TRF_CD='DMIF' and C.TO_MVMT_STS_CD = 'ID' then 'L'
        when C.DMDT_TRF_CD='DMIF' and C.TO_MVMT_STS_CD not in ('ID','CS','DR') then 'I'
        when C.DMDT_TRF_CD='DMOF' and C.DMDT_CHG_LOC_DIV_CD <> 'POL' then 'L'
        when C.DMDT_TRF_CD='DMOF' and C.DMDT_CHG_LOC_DIV_CD = 'POL' then 'I'
	    end 													as LI
	   ,(
			select  nvl(HLG_TP_CD, 'N')      /* 'C'ARRIER, 'M'ERCHANT, 'N'ULL */
			  from  BKG_EUR_TRO
    	     where  BKG_NO	= B.BKG_NO
    	       and  IO_BND_CD	= substr(C.DMDT_TRF_CD, 3, 1)    /* IN/OUT BOUND */
    	       and  nvl(CXL_FLG, 'N')    = 'N'
    	       and  CNTR_NO	= C.CNTR_NO
    	       and	ROWNUM = 1
        ) 														as CH
	   ,(	
			select  'Y' 	  
			  from  DUAL
			 where  exists
					(
						select  BDD.RLSE_STS_CD
						  from  BKG_DO BDO
            		           ,BKG_DO_DTL BDD
    		             where  BDO.BKG_NO = BDD.BKG_NO
    	                   and  BDO.BKG_NO = B.BKG_NO
    		               and  BDD.RLSE_STS_CD in ('R', 'I')) 
        ) 														as D_O
	   ,(	
			select  BDD.EVNT_OFC_CD
			  from  BKG_DO     BDO
				   ,BKG_DO_DTL BDD
			 where  BDO.BKG_NO = BDD.BKG_NO
   		       and  BDO.BKG_NO = B.BKG_NO
    	       and  BDD.RLSE_STS_CD in ('R', 'I')
    	       and  ROWNUM = 1 
        ) 														as RLSE_OFC
	   ,(
			select  BR.CLT_OFC_CD   
			  from  BKG_RATE BR 
			 where  BR.BKG_NO = B.BKG_NO 
	    ) 														as CLT_OFC_CD	
	   ,nvl(C.OFC_TRNS_FLG, 'N') 								as OFC_TRNS_FLG
	   ,(	
			select  'C'   
			  from  DUAL
			 where  exists
					(
						select  1
    		              from  BKG_ROLL_OVR R
						 where  R.BKG_NO = B.BKG_NO
    		               and  R.ROLL_OVR_RSN_CD IN ( 'C','H' )
					)
		) 														as ROLL_OVR
	   ,C.DMDT_INV_NO
	   ,(
			select  to_char(IM.CRE_DT, 'YYYYMMDD') 
			  from  DMT_INV_MN 	IM
			       ,DMT_INV_DTL ID
	         where  IM.BKG_NO	= B.BKG_NO 
	           and  IM.DMDT_INV_NO = ID.DMDT_INV_NO
	           and  IM.CRE_OFC_CD  = ID.CRE_OFC_CD
	           and  IM.DMDT_INV_STS_CD = 'I'   
	           and  ID.CNTR_NO  = DD.CNTR_NO
	           and  ID.CNTR_CYC_NO = DD.CNTR_CYC_NO
	           and  ID.DMDT_TRF_CD = DD.DMDT_TRF_CD
	           and  ID.DMDT_CHG_LOC_DIV_CD = DD.DMDT_CHG_LOC_DIV_CD
	           and  ID.CHG_SEQ = DD.CHG_SEQ      
		) 														as ISS_DT
	   ,(
			select  IM.INV_CURR_CD    
			  from  DMT_INV_MN 	IM
			       ,DMT_INV_DTL ID
		     where  IM.BKG_NO	= B.BKG_NO 
               and  IM.DMDT_INV_NO(+)= ID.DMDT_INV_NO
	           and  IM.CRE_OFC_CD(+) = ID.CRE_OFC_CD
	           and  IM.DMDT_INV_STS_CD = 'I' 
               and  ID.CNTR_NO  = DD.CNTR_NO
               and  ID.CNTR_CYC_NO = DD.CNTR_CYC_NO
               and  ID.DMDT_TRF_CD = DD.DMDT_TRF_CD
               and  ID.DMDT_CHG_LOC_DIV_CD = DD.DMDT_CHG_LOC_DIV_CD
               and  ID.CHG_SEQ = DD.CHG_SEQ   
		) 														as INV_CURR_CD
	   ,(
			select  ID.CNTR_INV_AMT 
			  from  DMT_INV_MN 	IM
			       ,DMT_INV_DTL ID
			 where  IM.BKG_NO	= B.BKG_NO 
               and  IM.DMDT_INV_NO(+) = ID.DMDT_INV_NO
	           and  IM.CRE_OFC_CD(+) = ID.CRE_OFC_CD
	           and  IM.DMDT_INV_STS_CD = 'I'
               and  ID.CNTR_NO  = DD.CNTR_NO
               and  ID.CNTR_CYC_NO = DD.CNTR_CYC_NO
               and  ID.DMDT_TRF_CD = DD.DMDT_TRF_CD
               and  ID.DMDT_CHG_LOC_DIV_CD = DD.DMDT_CHG_LOC_DIV_CD
               and  ID.CHG_SEQ = DD.CHG_SEQ    
		) 														as CNTR_INV_AMT
	   ,(
			select IM.DMDT_AR_IF_CD
			  from   DMT_INV_MN IM
					,DMT_INV_DTL ID
			 where  IM.BKG_NO	= B.BKG_NO 
               and  IM.DMDT_INV_NO(+) = ID.DMDT_INV_NO
	           and  IM.CRE_OFC_CD(+) = ID.CRE_OFC_CD
	           and  IM.DMDT_INV_STS_CD = 'I'
               and  ID.CNTR_NO  = DD.CNTR_NO
               and  ID.CNTR_CYC_NO = DD.CNTR_CYC_NO
               and  ID.DMDT_TRF_CD = DD.DMDT_TRF_CD
               and  ID.DMDT_CHG_LOC_DIV_CD = DD.DMDT_CHG_LOC_DIV_CD
               and  ID.CHG_SEQ = DD.CHG_SEQ    
		)														as DMDT_AR_IF_CD
	   ,case
			when decode(@[chg_delt_path_cd], 'BBG', 1, 'RHQ', 2, 'HDO', 3, 0) >= 
				 (
					select  max(CHG_DELT_PATH_LVL)
					  from  DMT_CHG_DELT_PATH
					 where  SYS_AREA_GRP_ID        = DD.SYS_AREA_GRP_ID
					   and  CNTR_NO                = DD.CNTR_NO
					   and  CNTR_CYC_NO            = DD.CNTR_CYC_NO
					   and  DMDT_TRF_CD            = DD.DMDT_TRF_CD
					   and  DMDT_CHG_LOC_DIV_CD    = DD.DMDT_CHG_LOC_DIV_CD
					   and  CHG_SEQ                = DD.CHG_SEQ
					   and  CHG_OFC_CD             = DD.CHG_OFC_CD
					   and  DELT_SEQ               = DD.DELT_SEQ
					   and  (CHG_DELT_PATH_CPLS_FLG = 'Y' or CHG_DELT_STS_CD in ('A', 'J'))
				 ) 
				 then 
				 (
					case 
						when @[chg_delt_path_cd] = 'RHQ' and DD.RQST_OFC_CD in ('ATLSC', 'CHISC', 'HOUSC', 'LGBSC', 'SFOSO', 'NYCSC', 'OREBS', 'PDXSO', 'SEASC', 'PHXSA') then
							case when @[chg_delt_usr_id] IN ( SELECT ATTR_CTNT1 FROM DMT_HRD_CDG_CTNT WHERE HRD_CDG_ID = 'USA_DELT_USER_LIST' ) then 'Y' else 'N' end
						else
							'Y'
					end
				 )
			else
			(
				select  case
							when count(1) > 0 then
								case 
									when @[chg_delt_path_cd] = 'RHQ' and DD.RQST_OFC_CD in ('ATLSC', 'CHISC', 'HOUSC', 'LGBSC', 'SFOSO', 'NYCSC', 'OREBS', 'PDXSO', 'SEASC', 'PHXSA') then
										case when @[chg_delt_usr_id] IN ( SELECT ATTR_CTNT1 FROM DMT_HRD_CDG_CTNT WHERE HRD_CDG_ID = 'USA_DELT_USER_LIST' ) then 'Y' else 'N' end
									else
										'Y'
								end								
							else
								'N'
						end
				  from  DMT_CHG_DELT_PATH
				 where  SYS_AREA_GRP_ID        = DD.SYS_AREA_GRP_ID
				   and  CNTR_NO                = DD.CNTR_NO
				   and  CNTR_CYC_NO            = DD.CNTR_CYC_NO
				   and  DMDT_TRF_CD            = DD.DMDT_TRF_CD
				   and  DMDT_CHG_LOC_DIV_CD    = DD.DMDT_CHG_LOC_DIV_CD
				   and  CHG_SEQ                = DD.CHG_SEQ
				   and  CHG_OFC_CD             = DD.CHG_OFC_CD
				   and  DELT_SEQ               = DD.DELT_SEQ
				   and  CHG_DELT_PATH_CD       = @[chg_delt_path_cd]
				   and  CHG_DELT_PATH_LVL     >= decode(DD.DMDT_DELT_RQST_STS_CD, 'R', 1, 'B', 1, 'E', 1, 'Q', 2, 'F', 2, 'H', 3, 'G', 3, 0)
				   and  CHG_DELT_PATH_CPLS_FLG = 'Y'
			)
		end													as CHG_DELT_USR_YN		--// Charge Deletion 요청에 대해 승인권한자인지 여부를 나타낸다.
       ,B.VSL_CD || B.SKD_VOY_NO || B.SKD_DIR_CD			as VVD_CD

  from  DMT_CHG_DELT_RQST_APRO 	DD
       ,DMT_CHG_BKG_CNTR 		B
       ,DMT_CHG_CALC 			C
 where  DD.SYS_AREA_GRP_ID 		= C.SYS_AREA_GRP_ID
   and  DD.CNTR_NO         		= C.CNTR_NO
   and  DD.CNTR_CYC_NO     		= C.CNTR_CYC_NO
   and  DD.DMDT_TRF_CD      	= C.DMDT_TRF_CD
   and  DD.DMDT_CHG_LOC_DIV_CD 	= C.DMDT_CHG_LOC_DIV_CD
   and  DD.CHG_SEQ 				= C.CHG_SEQ
   and  DD.CHG_OFC_CD           = C.OFC_CD
   and  DD.DELT_SEQ             = 
        (
			select  max(DELT_SEQ)
              from  DMT_CHG_DELT_RQST_APRO
			 where  SYS_AREA_GRP_ID 	= DD.SYS_AREA_GRP_ID
			   and  CNTR_NO         	= DD.CNTR_NO
			   and  CNTR_CYC_NO     	= DD.CNTR_CYC_NO
			   and  DMDT_TRF_CD      	= DD.DMDT_TRF_CD
			   and  DMDT_CHG_LOC_DIV_CD = DD.DMDT_CHG_LOC_DIV_CD
			   and  CHG_SEQ 			= DD.CHG_SEQ
			   and  CHG_OFC_CD          = DD.CHG_OFC_CD
               AND  DMDT_DELT_RQST_STS_CD != 'C'
        )
   and  B.SYS_AREA_GRP_ID		= C.SYS_AREA_GRP_ID
   and  B.CNTR_NO         		= C.CNTR_NO
   and  B.CNTR_CYC_NO     		= C.CNTR_CYC_NO
   and  C.DMDT_CHG_LOC_DIV_CD <> 'SZP'
   and  not (C.DUL_TP_EXPT_FLG  = 'Y' AND substr(C.DMDT_TRF_CD, 1, 1) = 'D')

	#if (${dmdt_trf_cd} != '')   
   and  DD.DMDT_TRF_CD           = @[dmdt_trf_cd]
	#end

	#if (${chg_delt_proc_sts} != '')   
   and  DD.DMDT_DELT_RQST_STS_CD = @[chg_delt_proc_sts]
    #else
   and  DD.DMDT_DELT_RQST_STS_CD in ('R', 'B', 'E', 'Q', 'F', 'H', 'G')	--// R:Request, B:BB Approval, E:BB Reject, Q:RHQ Approval, F:RHQ Reject, H:HO Approval, G:HO Reject
	#end

	#if (${apro_ofc_cd} != 'SELBB' && ${apro_ofc_cd} != 'TYOBB')
	-- 2014.01.15 [CHM-201428544] Approval Office in ( SELBB/TYOBB 는 RHQ 레벨 ) 일 경우는 산하 Office를 Check 할 필요 없이  Approval Office만 확인하도록 한다.
   and  DD.CHG_OFC_CD in 
		(
		  #foreach( $chg_ofc_cd in ${ofc_cd_list} )
			#if($velocityCount < $ofc_cd_list.size()) '$chg_ofc_cd', #else '$chg_ofc_cd' #end
		  #end
		)
	#end

   and  DD.RQST_DT between to_date(replace(@[fm_dt],'-',''), 'yyyymmdd') AND to_date(replace(@[to_dt],'-',''), 'yyyymmdd') + 0.99999
	
	#if (${bkg_no} != '')	
   and  B.BKG_NO in 
		(
		  #foreach( $bkg_cd in ${bkg_no_list} )
			#if($velocityCount < $bkg_no_list.size()) '$bkg_cd', #else '$bkg_cd' #end
		  #end
		)
	#end

	#if (${vvd_cd} != '')	
    and  B.VSL_CD     = substr(@[vvd_cd], 1, 4)
    and  B.SKD_VOY_NO = substr(@[vvd_cd], 5, 4)
    and  B.SKD_DIR_CD = substr(@[vvd_cd], 9)
    #end

order by B.BKG_NO, C.CNTR_NO			]]></sql>
			<params>
				<param name="chg_delt_path_cd" type="12" value="" out="N"/>
				<param name="chg_delt_usr_id" type="12" value="" out="N"/>
				<param name="dmdt_trf_cd" type="12" value="" out="N"/>
				<param name="chg_delt_proc_sts" type="12" value="" out="N"/>
				<param name="fm_dt" type="12" value="" out="N"/>
				<param name="to_dt" type="12" value="" out="N"/>
				<param name="vvd_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
