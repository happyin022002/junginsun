<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ARInvoiceInquiryDBDAOsearchVIEBookingListByDateRSQL">
			<desc><![CDATA[ARInvoiceInquiryDBDAOsearchVIEBookingListByDateRSQL]]></desc>
			<sql><![CDATA[
SELECT MN2.BKG_OFC
      ,MN2.TRK_VVD
      ,MN2.FST_VVD
      ,MN2.BL_NO
      ,MN2.BKG_NO
      ,MN2.SAIL_DT
      ,MN2.POR
      ,MN2.POL
      ,MN2.POD
      ,MN2.DEL
      ,MN2.PRE
      ,MN2.CUST_NM
      ,MN2.CUST_CD
      ,MN2.CUST_E_NM
      ,MN2.OFT
      ,MN2.S_CHG
      ,MN2.BD2
      ,MN2.BD4
      ,MN2.BD5
      ,MN2.BR2
      ,MN2.BR4
      ,MN2.BR5
      ,MN2.BOTH
      ,SUM(DECODE(BC.CNTR_TPSZ_CD, 'D2', DECODE(BC.CNTR_NO, NULL, 0, 1), 0)) D2
      ,SUM(DECODE(BC.CNTR_TPSZ_CD, 'D4', DECODE(BC.CNTR_NO, NULL, 0, 1), 0)) D4
      ,SUM(DECODE(BC.CNTR_TPSZ_CD, 'D5', DECODE(BC.CNTR_NO, NULL, 0, 1), 0)) D5
      ,SUM(DECODE(BC.CNTR_TPSZ_CD, 'R2', DECODE(BC.CNTR_NO, NULL, 0, 1), 0)) R2
      ,SUM(DECODE(BC.CNTR_TPSZ_CD, 'R4', DECODE(BC.CNTR_NO, NULL, 0, 1), 0)) R4
      ,SUM(DECODE(BC.CNTR_TPSZ_CD, 'R5', DECODE(BC.CNTR_NO, NULL, 0, 1), 0)) R5
      ,SUM(DECODE(BC.CNTR_TPSZ_CD, 'D2', 0,'D4', 0,'D5', 0,'R2', 0,'R4', 0,'R5', 0, DECODE(BC.CNTR_NO, NULL, 0, 1))) OTH
FROM  
(
         SELECT MN1.BKG_OFC
              ,MN1.TRK_VVD
              ,MN1.FST_VVD
              ,MN1.BL_NO
              ,MN1.BKG_NO
              ,MN1.SAIL_DT
              ,MN1.POR
              ,MN1.POL
              ,MN1.POD
              ,MN1.DEL
              ,MN1.PRE
              ,MN1.CUST_NM
              ,MN1.CUST_CD
              ,MN1.CUST_E_NM
              ,MN1.OFT
              ,MN1.S_CHG
              ,MAX(DECODE(BQ.CNTR_TPSZ_CD, 'D2', BQ.OP_CNTR_QTY, 0)) BD2
              ,MAX(DECODE(BQ.CNTR_TPSZ_CD, 'D4', BQ.OP_CNTR_QTY, 0)) BD4
              ,MAX(DECODE(BQ.CNTR_TPSZ_CD, 'D5', BQ.OP_CNTR_QTY, 0)) BD5
              ,MAX(DECODE(BQ.CNTR_TPSZ_CD, 'R2', BQ.OP_CNTR_QTY, 0)) BR2
              ,MAX(DECODE(BQ.CNTR_TPSZ_CD, 'R4', BQ.OP_CNTR_QTY, 0)) BR4
              ,MAX(DECODE(BQ.CNTR_TPSZ_CD, 'R5', BQ.OP_CNTR_QTY, 0)) BR5
              ,MAX(DECODE(BQ.CNTR_TPSZ_CD, 'D2', 0,'D4', 0,'D5', 0,'R2', 0,'R4', 0,'R5', 0, BQ.OP_CNTR_QTY)) BOTH        
         FROM 
        (
            SELECT MN.BKG_OFC
                  ,MN.TRK_VVD
                  ,NVL(MN.FST_VVD, MN.TRK_VVD) FST_VVD
                  ,MN.BL_NO
                  ,MN.BKG_NO
                  ,MN.SAIL_DT
                  ,MN.POR
                  ,MN.POL
                  ,MN.POD
                  ,MN.DEL
                  ,MN.PRE
                  ,MN.CUST_NM
                  ,MN.CUST_CD
                  ,MN.CUST_E_NM
                  , ROUND(SUM(DECODE(RT.CHG_CD,'OFT', RT.CHG_AMT/GMXR1.USD_LOCL_XCH_RT, 0 )),2) OFT
                  , ROUND(SUM(DECODE(RT.CHG_CD,'OFT', 0, RT.CHG_AMT/GMXR1.USD_LOCL_XCH_RT)),2) S_CHG              
            FROM      
            (SELECT   A.BKG_OFC_CD BKG_OFC
                  , (SELECT BV1.VSL_CD||BV1.SKD_VOY_NO||BV1.SKD_DIR_CD
                     FROM BKG_VVD BV1
                     WHERE BV1.BKG_NO = A.BKG_NO
                      AND  BV1.VSL_PRE_PST_CD = 'T' 
                      AND  ROWNUM = 1 ) TRK_VVD
                --  , (SELECT BV2.VSL_CD||BV2.SKD_VOY_NO||BV2.SKD_DIR_CD
                --     FROM  BKG_VVD BV2 
                --     WHERE BV2.BKG_NO = A.BKG_NO
                --     AND BV2.VSL_PRE_PST_CD = 'U'
                --     AND BV2.VSL_SEQ = (SELECT MIN(V2.VSL_SEQ) 
                --                         FROM BKG_VVD V2
                --                        WHERE V2.BKG_NO = A.BKG_NO 
                --                         AND  V2.VSL_PRE_PST_CD = 'U')) FST_VVD
                  , (SELECT /*+ INDEX( BV2 XPKBKG_VVD ) */
                            BV2.VSL_CD||BV2.SKD_VOY_NO||BV2.SKD_DIR_CD 
                     FROM  BKG_VVD BV2
                     WHERE BV2.BKG_NO = A.BKG_NO  AND  ROWNUM = 1) FST_VVD
                  , A.BL_NO BL_NO
                  , A.BKG_NO BKG_NO
                  , TO_CHAR(B.VPS_ETD_DT, 'YYYYMMDD') SAIL_DT
                  , A.POR_CD POR
                  , A.POL_CD POL
                  , A.POD_CD POD
                  , A.DEL_CD DEL
                  , (SELECT  BV3.POD_CD PRE   --20100513 POL에서 POD로 변경
                     FROM  BKG_VVD BV3
                     WHERE BV3.BKG_NO = A.BKG_NO
                     AND BV3.VSL_PRE_PST_CD = 'S'
                     AND VSL_SEQ = (SELECT MAX(VSL_SEQ)
                                    FROM  BKG_VVD V3
                                    WHERE V3.BKG_NO = A.BKG_NO 
                                    AND   V3.VSL_PRE_PST_CD = 'S' ) )  PRE 
                  , REPLACE(C.CUST_NM, chr(13)||chr(10),'') CUST_NM
                  , C.CUST_CNT_CD||LPAD(C.CUST_SEQ, 6, '0') CUST_CD
                  , D.CUST_LGL_ENG_NM CUST_E_NM
                  FROM  BKG_BOOKING A
                      , BKG_VVD BV4
                      , VSK_VSL_PORT_SKD B
                      , BKG_CUSTOMER C
                      , MDM_CUSTOMER D
                  WHERE A.BKG_NO       = BV4.BKG_NO
                  AND SUBSTR(A.POR_CD, 1, 2) = SUBSTR(BV4.POL_CD, 1, 2)
                  AND BV4.VSL_CD     = B.VSL_CD
                  AND BV4.SKD_VOY_NO = B.SKD_VOY_NO
                  AND BV4.SKD_DIR_CD = B.SKD_DIR_CD
                  AND BV4.POL_CD     = B.VPS_PORT_CD
                  AND B.VPS_PORT_CD LIKE @[port]||'%'
                  AND BV4.POL_CD  LIKE @[port]||'%'
                  AND B.VPS_ETD_DT BETWEEN TO_DATE( REPLACE(@[frDate],'-',''), 'YYYYMMDD' ) AND TO_DATE( REPLACE(@[toDate],'-',''), 'YYYYMMDD' )+0.999999
                  AND B.CLPT_IND_SEQ = 1
                  AND A.BKG_NO       = C.BKG_NO
                  AND C.BKG_CUST_TP_CD ='S'
                  AND C.CUST_CNT_CD  = D.CUST_CNT_CD
                  AND C.CUST_SEQ     = D.CUST_SEQ
                  AND A.BKG_STS_CD in ('S','F')
                  ) MN
                  , BKG_CHG_RT RT
                  , GL_MON_XCH_RT GMXR1 
            WHERE  MN.BKG_NO = RT.BKG_NO
             -- AND RT.FRT_TERM_CD = 'P'  2010.03.10 제외  BY HJS이상희  CLT김현화
              AND EXISTS (SELECT 'X'
                              FROM   MDM_CHARGE
                              WHERE  REP_CHG_CD IN ('BAF', 'CAF', 'OFT', 'CST', 'REV') -- CST, REV 추가
                              AND    CHG_CD = RT.CHG_CD
                          UNION ALL
                             SELECT 'X'
                            FROM   MDM_CHARGE
                            WHERE  REP_CHG_CD IN ('SLC', 'REV', 'CST') --REV, CST 추가
                            AND    CHG_CD IN ('GOH', 'HAN', 'PSC', 'EBC', 'WRS')
                            AND    CHG_CD = RT.CHG_CD)
            AND GMXR1.ACCT_XCH_RT_YRMON = SUBSTR(MN.SAIL_DT, 1, 6)
            AND GMXR1.ACCT_XCH_RT_LVL = '1'
            AND GMXR1.CURR_CD  = RT.CURR_CD       
            AND RT.FRT_INCL_XCLD_DIV_CD ='N'     
            GROUP BY MN.BKG_OFC
                  ,MN.TRK_VVD
                  ,MN.FST_VVD
                  ,MN.BL_NO
                  ,MN.BKG_NO
                  ,MN.SAIL_DT
                  ,MN.POR
                  ,MN.POL
                  ,MN.POD
                  ,MN.DEL
                  ,MN.PRE
                  ,MN.CUST_NM
                  ,MN.CUST_CD
                  ,MN.CUST_E_NM                  
            )MN1
            , BKG_QUANTITY BQ
           WHERE MN1.BKG_NO = BQ.BKG_NO(+)
        GROUP BY  MN1.BKG_OFC
                 ,MN1.TRK_VVD
                 ,MN1.FST_VVD
                 ,MN1.BL_NO
                 ,MN1.BKG_NO
                 ,MN1.SAIL_DT
                 ,MN1.POR
                 ,MN1.POL
                 ,MN1.POD
                 ,MN1.DEL
                 ,MN1.PRE
                 ,MN1.CUST_NM
                 ,MN1.CUST_CD
                 ,MN1.CUST_E_NM
                 ,MN1.OFT
                 ,MN1.S_CHG
   )MN2
   , BKG_CONTAINER BC
WHERE  MN2.BKG_NO = BC.BKG_NO(+)
GROUP BY   MN2.BKG_OFC
        ,MN2.TRK_VVD
        ,MN2.FST_VVD
        ,MN2.BL_NO
        ,MN2.BKG_NO
        ,MN2.SAIL_DT
        ,MN2.POR
        ,MN2.POL
        ,MN2.POD
        ,MN2.DEL
        ,MN2.PRE
        ,MN2.CUST_NM
        ,MN2.CUST_CD
        ,MN2.CUST_E_NM
        ,MN2.OFT
        ,MN2.S_CHG
        ,MN2.BD2
        ,MN2.BD4
        ,MN2.BD5
        ,MN2.BR2
        ,MN2.BR4
        ,MN2.BR5
        ,MN2.BOTH			]]></sql>
			<params>
				<param name="port" type="12" value="" out="N"/>
				<param name="frDate" type="12" value="" out="N"/>
				<param name="toDate" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
