<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ARInvoiceInquiryDBDAOInvoiceIssueDateVORSQL">
			<desc><![CDATA[   ]]></desc>
			<sql><![CDATA[
#if (${svr_id} == 'KOR') 
    SELECT A.ISS_DT,
           A.AR_OFC_CD,
           DECODE(B.IO_BND_CD, 'O', 'O/B', 'I', 'I/B') IO_BND_CD,
           B.BL_SRC_NO,
           B.VSL_CD||B.SKD_VOY_NO||B.SKD_DIR_CD VVD,
           A.ACT_CUST_CNT_CD ||'-'||LPAD(A.ACT_CUST_SEQ, 6, '0') CUST_CD,
           B.CURR_CD,
           B.INV_XCH_RT,
           A.CRE_USR_ID CRE_USR_ID1,
           A.INV_NO,
           '' AUTO_INV_ISS_FLG,
           '' REV_TP_CD,
           '' AR_IF_NO,
           B.SAIL_ARR_DT,
           B.POL_CD,
           B.POD_CD,
           SUM(B.CHG_AMT) CHG_AMT,
           ROUND(SUM(B.CHG_AMT)*B.INV_XCH_RT, 0) LOCAL_TOTAL,
           A.CRE_USR_ID CRE_USR_ID2,
           C.DP_PRCS_KNT DP_PRCS_KNT,
           0 DP_PRCS_KNT_LOCAL
    FROM INV_AR_KR_ISS A,
         INV_AR_KR_ISS_CHG B,
         MDM_CURRENCY C
    WHERE A.INV_NO = B.INV_NO
      AND A.INV_SEQ = B.INV_SEQ
      AND C.CURR_CD = B.CURR_CD
    #if (${inv_no} != '')
      AND A.INV_NO = @[inv_no]
    #end
    #if (${bl_src_no} != '')
      AND B.BL_SRC_NO = @[bl_src_no]
    #end
    #if ((${iss_fm_dt} != '') && (${iss_to_dt} != ''))
      AND A.ISS_DT BETWEEN REPLACE(@[iss_fm_dt],'-','') AND REPLACE(@[iss_to_dt],'-','')
    #end
    #if (${office} != '')
      AND A.AR_OFC_CD = @[office] -- OFFICE
    #else 
      AND A.AR_OFC_CD IN ( SELECT OFC_CD -- OFC ALL 선택시 적용..  
                             FROM MDM_ORGANIZATION
                            WHERE AR_HD_QTR_OFC_CD = ( SELECT AR_HD_QTR_OFC_CD
                                                         FROM MDM_ORGANIZATION
                                                        WHERE OFC_CD = ( SELECT AR_OFC_CD
                                                                           FROM MDM_ORGANIZATION
                                                                          WHERE OFC_CD = @[user_ofc_cd]))
                              AND OFC_CD = AR_OFC_CD )
    #end
    #if (${cust_cnt_cd} != '')
      AND A.ACT_CUST_CNT_CD = @[cust_cnt_cd]
    #end
    #if (${cust_seq} != '')
      AND A.ACT_CUST_SEQ = @[cust_seq]
    #end
    #if (${vsl_cd} != '')
      AND B.VSL_CD = @[vsl_cd]
    #end
    #if (${skd_voy_no} != '')
      AND B.SKD_VOY_NO = @[skd_voy_no]
    #end
    #if (${skd_dir_cd} != '')
      AND B.SKD_DIR_CD = @[skd_dir_cd]
    #end
    #if (${bound} != 'A')
      AND B.IO_BND_CD = @[bound]
    #if ((${bound} == 'I') && (${port} != ''))
      AND B.POD_CD = @[port]
    #elseif ((${bound} == 'O') && (${port} != ''))
      AND B.POL_CD = @[port]
    #end
    #else
    #if (${port} != '')
      AND ((B.IO_BND_CD = 'I' AND B.POD_CD = @[port]) OR (B.IO_BND_CD = 'O' AND B.POL_CD = @[port]))
    #end
    #end
    #if (${usr_id} != '')
      AND A.CRE_USR_ID = @[usr_id]
    #end
      AND A.INV_SEQ = ( SELECT MAX(INV_SEQ)
                          FROM INV_AR_KR_ISS
                         WHERE AR_OFC_CD = A.AR_OFC_CD
                           AND INV_NO = A.INV_NO)
    GROUP BY A.ISS_DT, A.AR_OFC_CD, A.INV_NO, B.BL_SRC_NO, A.AR_OFC_CD, B.IO_BND_CD, A.ACT_CUST_CNT_CD ||'-'||LPAD(A.ACT_CUST_SEQ, 6, '0'), B.CURR_CD, B.VSL_CD||B.SKD_VOY_NO||B.SKD_DIR_CD, B.SAIL_ARR_DT, B.POL_CD, B.POD_CD, B.INV_XCH_RT, A.CRE_USR_ID, C.DP_PRCS_KNT
    ORDER BY A.ISS_DT, A.INV_NO

#else

    #if (${office} == 'BOMSC' && ${tax_inv_flg} == 'Y')
        SELECT ISS_OFC_CD
             , ISS_OFC_GST_NO
             , BKG_NO
             , SEZ_FLG
             , CUST_GST_NO
             , CUST_NM
             , INV_NO
             , ORG_INV_NO
             , ISS_DT
             , INV_TTL_LOCL_AMT
             , ISS_OFC_STE_CD
             , CUST_STE_CD
             , RVS_CHG_FLG
             , POR_CNT_CD
             , DEL_CNT_CD
             , IDA_SAC_CD
             , SUM(TAXABLE_AMT) AS TAXABLE_AMT
             , IDA_IGST_RTO
             , IDA_CGST_RTO
             , IDA_SGST_RTO
             , IDA_UGST_RTO
             , SUM(IDA_IGST_AMT) AS IDA_IGST_AMT
             , SUM(IDA_CGST_AMT) AS IDA_CGST_AMT
             , SUM(IDA_SGST_AMT) AS IDA_SGST_AMT
             , SUM(IDA_UGST_AMT) AS IDA_UGST_AMT
             , SUM(TTL_AMT) AS TTL_AMT
        FROM (
                SELECT C.IDA_ISS_OFC_CD                         AS ISS_OFC_CD
                     , (SELECT Q.IDA_GST_RGST_NO
                        FROM MDM_ORGANIZATION P,
                             MDM_CUSTOMER Q
                        WHERE P.OFC_CD = C.IDA_ISS_OFC_CD
                        AND P.REP_CUST_CNT_CD = Q.CUST_CNT_CD
                        AND P.REP_CUST_SEQ = Q.CUST_SEQ)        AS ISS_OFC_GST_NO
                     , C.BKG_NO                                 AS BKG_NO
                     , NVL(C.IDA_SPCL_ECN_ZN_UT_FLG, 'N')       AS SEZ_FLG
                     , C.IDA_GST_RGST_NO                        AS CUST_GST_NO
                     , E.CUST_LGL_ENG_NM                        AS CUST_NM
                     , C.INV_NO                                 AS INV_NO
                     -- 2018.05.24 인도지역 Split Invoice Issue 기능 보완 
                     , NVL((SELECT DECODE(NVL(C.IDA_ISS_TP_CD, 'P'), 'C', MAX(INV_NO), 'D', MAX(INV_NO), '')
                            FROM INV_AR_MN
                            WHERE AR_OFC_CD = C.AR_OFC_CD
                            AND BL_SRC_NO = C.BL_SRC_NO
                            AND ACT_CUST_CNT_CD = C.ACT_CUST_CNT_CD
                            AND ACT_CUST_SEQ = C.ACT_CUST_SEQ
                            AND NVL(IDA_ISS_TP_CD, 'P') = 'T'),
                           (SELECT DECODE(NVL(C.IDA_ISS_TP_CD, 'P'), 'C', MAX(INV_NO), 'D', MAX(INV_NO), '')
                            FROM INV_AR_SPLIT_ISS
                            WHERE AR_OFC_CD = C.AR_OFC_CD
                            AND BL_SRC_NO = C.BL_SRC_NO
                            AND ACT_CUST_CNT_CD = C.ACT_CUST_CNT_CD
                            AND ACT_CUST_SEQ = C.ACT_CUST_SEQ
                            AND NVL(IDA_ISS_TP_CD, 'P') = 'T')) AS ORG_INV_NO
                     , C.ISS_DT                                 AS ISS_DT
                     , (SELECT SUM(INV_TTL_LOCL_AMT)
                        FROM INV_AR_MN
                        WHERE AR_OFC_CD = C.AR_OFC_CD
                        AND BL_SRC_NO = C.BL_SRC_NO
                        AND INV_NO = C.INV_NO)                  AS INV_TTL_LOCL_AMT
                     , (SELECT   R.IDA_STE_CD 
                        FROM     MDM_ORGANIZATION P 
                               , MDM_LOCATION Q 
                               , MDM_STATE R
                        WHERE    P.LOC_CD = Q.LOC_CD 
                        AND      Q.CNT_CD = R.CNT_CD 
                        AND      Q.STE_CD = R.STE_CD 
                        AND      P.OFC_CD = C.IDA_ISS_OFC_CD)   AS ISS_OFC_STE_CD
                     , C.IDA_STE_CD                             AS CUST_STE_CD
                     , (SELECT DECODE(Q.IDA_GST_RGST_NO, '', 'Yes', 'No')
                        FROM MDM_ORGANIZATION P,
                             MDM_CUSTOMER Q
                        WHERE P.OFC_CD = C.IDA_ISS_OFC_CD
                        AND P.REP_CUST_CNT_CD = Q.CUST_CNT_CD
                        AND P.REP_CUST_SEQ = Q.CUST_SEQ)  		AS RVS_CHG_FLG
                     , SUBSTR(C.POR_CD, 1, 2)                   AS POR_CNT_CD
                     , SUBSTR(C.DEL_CD, 1, 2)                   AS DEL_CNT_CD
                     , B.IDA_SAC_CD                             AS IDA_SAC_CD
                     , ROUND(B.CHG_AMT * B.INV_XCH_RT, 2)       AS TAXABLE_AMT
                     , TO_CHAR(B.IDA_IGST_RTO, 'FM90.0')||'%'   AS IDA_IGST_RTO
                     , TO_CHAR(B.IDA_CGST_RTO, 'FM90.0')||'%'   AS IDA_CGST_RTO
                     , TO_CHAR(B.IDA_SGST_RTO, 'FM90.0')||'%'   AS IDA_SGST_RTO
                     , TO_CHAR(B.IDA_UGST_RTO, 'FM90.0')||'%'   AS IDA_UGST_RTO
                     , B.IDA_IGST_AMT                           AS IDA_IGST_AMT
                     , B.IDA_CGST_AMT                           AS IDA_CGST_AMT
                     , B.IDA_SGST_AMT                           AS IDA_SGST_AMT
                     , B.IDA_UGST_AMT                           AS IDA_UGST_AMT
                     , ROUND(B.CHG_AMT * B.INV_XCH_RT, 2) + B.IDA_IGST_AMT + B.IDA_CGST_AMT + B.IDA_SGST_AMT + B.IDA_UGST_AMT AS TTL_AMT
                FROM INV_AR_ISS_DTL A,
                     INV_AR_CHG B,
                     INV_AR_MN C,
                     INV_AR_ISS D,
                     MDM_CUSTOMER E
                WHERE A.AR_IF_NO = B.AR_IF_NO
                AND A.CHG_SEQ = B.CHG_SEQ
                AND B.AR_IF_NO = C.AR_IF_NO
                AND A.INV_NO = D.INV_NO
                AND D.INV_NO = C.INV_NO
                AND D.INV_SEQ = 1
                AND E.CUST_CNT_CD = C.ACT_CUST_CNT_CD
                AND E.CUST_SEQ = C.ACT_CUST_SEQ
                AND NVL(C.INV_DELT_DIV_CD, 'N') <> 'Y'
                AND NVL(C.IDA_ISS_TP_CD, 'P') <> 'P'
                AND B.IDA_SAC_CD IS NOT NULL
                #if (${inv_no} != '')
                    AND A.INV_NO = @[inv_no]
                #end
                #if (${bl_src_no} != '')
                    AND C.BL_SRC_NO = @[bl_src_no]
                #end
                #if ((${iss_fm_dt} != '') && (${iss_to_dt} != ''))
                    AND D.ISS_DT BETWEEN REPLACE(@[iss_fm_dt],'-','') AND REPLACE(@[iss_to_dt],'-','')
                #end
                #if (${iss_ofc_cd} != '')
                    AND C.IDA_ISS_OFC_CD = @[iss_ofc_cd]
                #end
                #if (${office} != '')
                    AND C.AR_OFC_CD = @[office]
					AND D.ISS_OFC_CD IN (SELECT OFC_CD
                                         FROM MDM_ORGANIZATION
                                         WHERE AR_OFC_CD = (SELECT AR_OFC_CD
                                                            FROM MDM_ORGANIZATION
                                                            WHERE OFC_CD = @[office]))
                #end
                #if (${cust_cnt_cd} != '')
                    AND C.ACT_CUST_CNT_CD = @[cust_cnt_cd]
                #end
                #if (${cust_seq} != '')
                    AND C.ACT_CUST_SEQ = @[cust_seq]
                #end
                #if (${rev_type} != 'A')
                    AND C.REV_TP_CD = @[rev_type]
                #end
                #if (${vsl_cd} != '')
                    AND C.VSL_CD = @[vsl_cd]
                #end
                #if (${skd_voy_no} != '')
                    AND C.SKD_VOY_NO = @[skd_voy_no]
                #end
                #if (${skd_dir_cd} != '')
                    AND C.SKD_DIR_CD = @[skd_dir_cd]
                #end
                #if (${scope} != '')
                    AND C.SVC_SCP_CD = @[scope]
                #end
                #if (${bound} != 'A')
                    AND C.IO_BND_CD = @[bound]
                    #if ((${bound} == 'I') && (${port} != ''))
                        AND C.POD_CD = @[port]
                    #elseif ((${bound} == 'O') && (${port} != ''))
                        AND C.POL_CD = @[port]
                    #end
                #else
                    #if (${port} != '')
                        AND ((C.IO_BND_CD = 'I' AND C.POD_CD = @[port]) OR (C.IO_BND_CD = 'O' AND C.POL_CD = @[port]))
                    #end
                #end
                #if (${usr_id} != '')
                    AND D.CRE_USR_ID = @[usr_id]
                #end  
                
                UNION ALL
                
                -- 2018.05.24 인도지역 Split Invoice Issue 기능 보완 
                SELECT C.IDA_ISS_OFC_CD                         AS ISS_OFC_CD
                     , (SELECT Q.IDA_GST_RGST_NO
                        FROM MDM_ORGANIZATION P,
                             MDM_CUSTOMER Q
                        WHERE P.OFC_CD = C.IDA_ISS_OFC_CD
                        AND P.REP_CUST_CNT_CD = Q.CUST_CNT_CD
                        AND P.REP_CUST_SEQ = Q.CUST_SEQ)        AS ISS_OFC_GST_NO
                     , C.BKG_NO                                 AS BKG_NO
                     , NVL(C.IDA_SPCL_ECN_ZN_UT_FLG, 'N')       AS SEZ_FLG
                     , C.IDA_GST_RGST_NO                        AS CUST_GST_NO
                     , E.CUST_LGL_ENG_NM                        AS CUST_NM
                     , C.INV_NO                                 AS INV_NO
                     , NVL((SELECT DECODE(NVL(C.IDA_ISS_TP_CD, 'P'), 'C', MAX(INV_NO), 'D', MAX(INV_NO), '')
                            FROM INV_AR_MN
                            WHERE AR_OFC_CD = C.AR_OFC_CD
                            AND BL_SRC_NO = C.BL_SRC_NO
                            AND ACT_CUST_CNT_CD = C.ACT_CUST_CNT_CD
                            AND ACT_CUST_SEQ = C.ACT_CUST_SEQ
                            AND NVL(IDA_ISS_TP_CD, 'P') = 'T'),
                           (SELECT DECODE(NVL(C.IDA_ISS_TP_CD, 'P'), 'C', MAX(INV_NO), 'D', MAX(INV_NO), '')
                            FROM INV_AR_SPLIT_ISS
                            WHERE AR_OFC_CD = C.AR_OFC_CD
                            AND BL_SRC_NO = C.BL_SRC_NO
                            AND ACT_CUST_CNT_CD = C.ACT_CUST_CNT_CD
                            AND ACT_CUST_SEQ = C.ACT_CUST_SEQ
                            AND NVL(IDA_ISS_TP_CD, 'P') = 'T')) AS ORG_INV_NO
                     , C.ISS_DT                                 AS ISS_DT
                     , (SELECT SUM(ROUND(CHG_AMT * INV_XCH_RT, 2) + IDA_IGST_AMT + IDA_CGST_AMT + IDA_SGST_AMT + IDA_UGST_AMT)
                        FROM INV_AR_SPLIT_ISS_CHG
                        WHERE INV_NO = C.INV_NO
                        AND IDA_SAC_CD IS NOT NULL)             AS INV_TTL_LOCL_AMT
                     , (SELECT   R.IDA_STE_CD 
                        FROM     MDM_ORGANIZATION P 
                               , MDM_LOCATION Q 
                               , MDM_STATE R
                        WHERE    P.LOC_CD = Q.LOC_CD 
                        AND      Q.CNT_CD = R.CNT_CD 
                        AND      Q.STE_CD = R.STE_CD 
                        AND      P.OFC_CD = C.IDA_ISS_OFC_CD)   AS ISS_OFC_STE_CD
                     , C.IDA_STE_CD                             AS CUST_STE_CD
                     , (SELECT DECODE(Q.IDA_GST_RGST_NO, '', 'Yes', 'No')
                        FROM MDM_ORGANIZATION P,
                             MDM_CUSTOMER Q
                        WHERE P.OFC_CD = C.IDA_ISS_OFC_CD
                        AND P.REP_CUST_CNT_CD = Q.CUST_CNT_CD
                        AND P.REP_CUST_SEQ = Q.CUST_SEQ)  		AS RVS_CHG_FLG
                     , SUBSTR(A.POR_CD, 1, 2)                   AS POR_CNT_CD
                     , SUBSTR(A.DEL_CD, 1, 2)                   AS DEL_CNT_CD
                     , B.IDA_SAC_CD                             AS IDA_SAC_CD
                     , ROUND(B.CHG_AMT * B.INV_XCH_RT, 2)       AS TAXABLE_AMT
                     , TO_CHAR(B.IDA_IGST_RTO, 'FM90.0')||'%'   AS IDA_IGST_RTO
                     , TO_CHAR(B.IDA_CGST_RTO, 'FM90.0')||'%'   AS IDA_CGST_RTO
                     , TO_CHAR(B.IDA_SGST_RTO, 'FM90.0')||'%'   AS IDA_SGST_RTO
                     , TO_CHAR(B.IDA_UGST_RTO, 'FM90.0')||'%'   AS IDA_UGST_RTO
                     , B.IDA_IGST_AMT                           AS IDA_IGST_AMT
                     , B.IDA_CGST_AMT                           AS IDA_CGST_AMT
                     , B.IDA_SGST_AMT                           AS IDA_SGST_AMT
                     , B.IDA_UGST_AMT                           AS IDA_UGST_AMT
                     , ROUND(B.CHG_AMT * B.INV_XCH_RT, 2) + B.IDA_IGST_AMT + B.IDA_CGST_AMT + B.IDA_SGST_AMT + B.IDA_UGST_AMT AS TTL_AMT
                FROM INV_AR_MN A,
                     INV_AR_SPLIT_ISS_CHG B,
                     INV_AR_SPLIT_ISS C,
                     MDM_CUSTOMER E
                WHERE A.AR_IF_NO = C.AR_IF_NO
                AND C.INV_NO = B.INV_NO
                AND C.INV_SEQ = B.INV_SEQ
                AND C.INV_SEQ = 1
                AND E.CUST_CNT_CD = C.ACT_CUST_CNT_CD
                AND E.CUST_SEQ = C.ACT_CUST_SEQ
                AND NVL(C.IDA_ISS_TP_CD, 'P') <> 'P'
                AND B.IDA_SAC_CD IS NOT NULL
                #if (${inv_no} != '')
                    AND C.INV_NO = @[inv_no]
                #end
                #if (${bl_src_no} != '')
                    AND C.BL_SRC_NO = @[bl_src_no]
                #end
                #if ((${iss_fm_dt} != '') && (${iss_to_dt} != ''))
                    AND C.ISS_DT BETWEEN REPLACE(@[iss_fm_dt],'-','') AND REPLACE(@[iss_to_dt],'-','')
                #end
                #if (${iss_ofc_cd} != '')
                    AND C.IDA_ISS_OFC_CD = @[iss_ofc_cd]
                #end
                #if (${office} != '')
                    AND C.AR_OFC_CD = @[office]
                #end
                #if (${cust_cnt_cd} != '')
                    AND C.ACT_CUST_CNT_CD = @[cust_cnt_cd]
                #end
                #if (${cust_seq} != '')
                    AND C.ACT_CUST_SEQ = @[cust_seq]
                #end
                /* Split issue 에서는 rev type 구분 불가능
                #if (${rev_type} != 'A')
                    AND C.REV_TP_CD = @[rev_type]
                #end
                */
                #if (${vsl_cd} != '')
                    AND A.VSL_CD = @[vsl_cd]
                #end
                #if (${skd_voy_no} != '')
                    AND A.SKD_VOY_NO = @[skd_voy_no]
                #end
                #if (${skd_dir_cd} != '')
                    AND A.SKD_DIR_CD = @[skd_dir_cd]
                #end
                #if (${scope} != '')
                    AND A.SVC_SCP_CD = @[scope]
                #end
                #if (${bound} != 'A')
                    AND A.IO_BND_CD = @[bound]
                    #if ((${bound} == 'I') && (${port} != ''))
                        AND A.POD_CD = @[port]
                    #elseif ((${bound} == 'O') && (${port} != ''))
                        AND A.POL_CD = @[port]
                    #end
                #else
                    #if (${port} != '')
                        AND ((A.IO_BND_CD = 'I' AND A.POD_CD = @[port]) OR (A.IO_BND_CD = 'O' AND A.POL_CD = @[port]))
                    #end
                #end
                #if (${usr_id} != '')
                    AND C.CRE_USR_ID = @[usr_id]
                #end  
             )
        GROUP BY ISS_OFC_CD
               , ISS_OFC_GST_NO
               , BKG_NO
               , SEZ_FLG
               , CUST_GST_NO
               , CUST_NM
               , INV_NO
               , ORG_INV_NO
               , ISS_DT
               , INV_TTL_LOCL_AMT
               , ISS_OFC_STE_CD
               , CUST_STE_CD
               , RVS_CHG_FLG
               , POR_CNT_CD
               , DEL_CNT_CD
               , IDA_SAC_CD
               , IDA_IGST_RTO
               , IDA_CGST_RTO
               , IDA_SGST_RTO
               , IDA_UGST_RTO
        HAVING SUM(TTL_AMT) <> 0
        ORDER BY INV_NO, IDA_SAC_CD 
    #else
        SELECT ISS_DT,
               AR_OFC_CD,
               IO_BND_CD,
               BL_SRC_NO,
               VVD,
               CUST_CD,
               CURR_CD,
               INV_XCH_RT,
               CRE_USR_ID1,
               INV_NO,
               CASE WHEN (SELECT NVL(AUTO_INV_ISS_FLG,'N') FROM INV_AR_ISS WHERE INV_NO = AA.INV_NO AND ISS_DT = AA.ISS_DT  AND ROWNUM =1) ='Y' THEN 'A'  ELSE 'M'  END  AUTO_INV_ISS_FLG,
               REV_TP_CD,
               AR_IF_NO,
               SAIL_ARR_DT,
               POL_CD,
               POD_CD,
               CHG_AMT,
               LOCAL_TOTAL,
               CRE_USR_ID2,
               DP_PRCS_KNT,
               DP_PRCS_KNT_LOCAL,
               --2017.08.01 인도 GST 세법 변경 관련 보완
               IDA_CGST_AMT,
               IDA_SGST_AMT,
               IDA_UGST_AMT,
               IDA_IGST_AMT
         FROM(
                SELECT /*+ ALL_ROWS */D.ISS_DT,
                               C.AR_OFC_CD,
                               DECODE(C.IO_BND_CD, 'I', 'I/B', 'O', 'O/B') IO_BND_CD,
                               C.BL_SRC_NO,
                               C.VSL_CD||C.SKD_VOY_NO||C.SKD_DIR_CD VVD,
                               C.ACT_CUST_CNT_CD||'-'||LPAD(C.ACT_CUST_SEQ, 6, '0') CUST_CD,
                               B.CURR_CD,
                               B.INV_XCH_RT,
                               D.CRE_USR_ID CRE_USR_ID1,
                               A.INV_NO,
                               C.REV_TP_CD||C.REV_SRC_CD REV_TP_CD,
                               C.AR_IF_NO,
                               C.SAIL_ARR_DT,
                               C.POL_CD,
                               C.POD_CD,
                               SUM(B.CHG_AMT) CHG_AMT,
                               ROUND(SUM(B.CHG_AMT)*B.INV_XCH_RT, E.DP_PRCS_KNT) LOCAL_TOTAL,
                               D.CRE_USR_ID CRE_USR_ID2,
                               F.DP_PRCS_KNT DP_PRCS_KNT,
                               E.DP_PRCS_KNT DP_PRCS_KNT_LOCAL,
                               --2017.08.01 인도 GST 세법 변경 관련 보완
                               SUM(B.IDA_CGST_AMT) IDA_CGST_AMT,
                               SUM(B.IDA_SGST_AMT) IDA_SGST_AMT,
                               SUM(B.IDA_UGST_AMT) IDA_UGST_AMT,
                               SUM(B.IDA_IGST_AMT) IDA_IGST_AMT
                          FROM INV_AR_ISS_DTL A,
                               INV_AR_CHG B,
                               INV_AR_MN C,
                               INV_AR_ISS D,
                               MDM_CURRENCY E,
                               MDM_CURRENCY F
                         WHERE A.AR_IF_NO = B.AR_IF_NO
                           AND A.CHG_SEQ = B.CHG_SEQ
                           AND B.AR_IF_NO = C.AR_IF_NO
                           AND A.INV_NO = D.INV_NO
                           AND D.INV_SEQ = 1
                           AND E.CURR_CD = C.LOCL_CURR_CD
                           AND F.CURR_CD = B.CURR_CD
                #if (${inv_no} != '')
                           AND A.INV_NO = @[inv_no]
                #end
                #if (${bl_src_no} != '')
                           AND C.BL_SRC_NO = @[bl_src_no]
                #end
                #if ((${iss_fm_dt} != '') && (${iss_to_dt} != ''))
                           AND D.ISS_DT BETWEEN REPLACE(@[iss_fm_dt],'-','') AND REPLACE(@[iss_to_dt],'-','')
                #end
                #if (${iss_ofc_cd} != '')
                           AND D.ISS_OFC_CD = @[iss_ofc_cd]
                #else
                #if (${office} != '')
                           AND D.ISS_OFC_CD IN ( SELECT OFC_CD
                                                   FROM MDM_ORGANIZATION
                                                  WHERE AR_OFC_CD = ( SELECT AR_OFC_CD
                                                                        FROM MDM_ORGANIZATION
                                                                       WHERE OFC_CD = @[office]))
                #else 
                           AND D.ISS_OFC_CD IN ( SELECT OFC_CD -- OFC ALL 선택시 적용..  
                                                  FROM MDM_ORGANIZATION
                                                 WHERE AR_HD_QTR_OFC_CD = ( SELECT AR_HD_QTR_OFC_CD
                                                                              FROM MDM_ORGANIZATION
                                                                             WHERE OFC_CD = ( SELECT AR_OFC_CD
                                                                                                FROM MDM_ORGANIZATION
                                                                                               WHERE OFC_CD = @[user_ofc_cd])))
                #end
                #end
                #if (${office} != '')
                           AND C.AR_OFC_CD = @[office] -- OFFICE
                #else 
                           AND C.AR_OFC_CD IN ( SELECT OFC_CD -- OFC ALL 선택시 적용..  
                                                  FROM MDM_ORGANIZATION
                                                 WHERE AR_HD_QTR_OFC_CD = ( SELECT AR_HD_QTR_OFC_CD
                                                                              FROM MDM_ORGANIZATION
                                                                             WHERE OFC_CD = ( SELECT AR_OFC_CD
                                                                                                FROM MDM_ORGANIZATION
                                                                                               WHERE OFC_CD = @[user_ofc_cd]))
                                                   AND OFC_CD = AR_OFC_CD )
                #end
                           AND NVL(C.INV_DELT_DIV_CD, 'N') <> 'Y'
                #if (${cust_cnt_cd} != '')
                           AND C.ACT_CUST_CNT_CD = @[cust_cnt_cd]
                #end
                #if (${cust_seq} != '')
                           AND C.ACT_CUST_SEQ = @[cust_seq]
                #end
                #if (${rev_type} != 'A')
                           AND C.REV_TP_CD = @[rev_type]
                #end
                #if (${vsl_cd} != '')
                           AND C.VSL_CD = @[vsl_cd]
                #end
                #if (${skd_voy_no} != '')
                           AND C.SKD_VOY_NO = @[skd_voy_no]
                #end
                #if (${skd_dir_cd} != '')
                           AND C.SKD_DIR_CD = @[skd_dir_cd]
                #end
                #if (${scope} != '')
                           AND C.SVC_SCP_CD = @[scope]
                #end
                #if (${bound} != 'A')
                           AND C.IO_BND_CD = @[bound]
                #if ((${bound} == 'I') && (${port} != ''))
                           AND C.POD_CD = @[port]
                #elseif ((${bound} == 'O') && (${port} != ''))
                           AND C.POL_CD = @[port]
                #end
                #else
                #if (${port} != '')
                           AND ((C.IO_BND_CD = 'I' AND C.POD_CD = @[port]) OR (C.IO_BND_CD = 'O' AND C.POL_CD = @[port]))
                #end
                #end
                #if (${usr_id} != '')
                           AND D.CRE_USR_ID = @[usr_id]
                #end
                         GROUP BY D.ISS_DT, C.AR_OFC_CD, C.VSL_CD||C.SKD_VOY_NO||C.SKD_DIR_CD, C.ACT_CUST_CNT_CD||'-'||LPAD(C.ACT_CUST_SEQ, 6, '0'), B.CURR_CD, B.INV_XCH_RT, D.CRE_USR_ID, A.INV_NO, C.SAIL_ARR_DT, C.POL_CD, C.POD_CD, B.INV_XCH_RT, D.CRE_USR_ID, F.DP_PRCS_KNT, E.DP_PRCS_KNT, C.AR_IF_NO, C.IO_BND_CD, C.REV_TP_CD||C.REV_SRC_CD, C.BL_SRC_NO	   
                -- ORDER BY D.ISS_DT, A.INV_NO

                UNION ALL
                
                SELECT /*+ ALL_ROWS */
                               B.ISS_DT,
                               B.AR_OFC_CD,
                               DECODE(A.IO_BND_CD, 'I', 'I/B', 'O', 'O/B') IO_BND_CD,
                               B.BL_SRC_NO,
                               A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD VVD,
                               B.ACT_CUST_CNT_CD||'-'||LPAD(B.ACT_CUST_SEQ, 6, '0') CUST_CD,
                               C.CURR_CD,
                               C.INV_XCH_RT,
                               B.CRE_USR_ID CRE_USR_ID1,
                               B.INV_NO,
                               A.REV_TP_CD||A.REV_SRC_CD REV_TP_CD,
                               A.AR_IF_NO,
                               A.SAIL_ARR_DT,
                               A.POL_CD,
                               A.POD_CD,
                               SUM(C.CHG_AMT) CHG_AMT,
                               ROUND(SUM(C.CHG_AMT)*C.INV_XCH_RT, E.DP_PRCS_KNT) LOCAL_TOTAL,
                               B.CRE_USR_ID CRE_USR_ID2,
                               F.DP_PRCS_KNT DP_PRCS_KNT,
                               E.DP_PRCS_KNT DP_PRCS_KNT_LOCAL,
                               --2017.08.01 인도 GST 세법 변경 관련 보완
                               -- 2018.05.24 인도지역 Split Invoice Issue 기능 보완
                               SUM(C.IDA_CGST_AMT) IDA_CGST_AMT,
                               SUM(C.IDA_SGST_AMT) IDA_SGST_AMT,
                               SUM(C.IDA_UGST_AMT) IDA_UGST_AMT,
                               SUM(C.IDA_IGST_AMT) IDA_IGST_AMT		   
                          FROM 
                               INV_AR_MN A,
                               ( SELECT INV_NO,INV_SEQ,AR_OFC_CD,ACT_CUST_CNT_CD,ACT_CUST_SEQ,INV_RMK,
                                        INV_REF_NO,HJS_STF_CTNT,ISS_DT,BL_SRC_NO,BKG_NO,CRE_USR_ID,CRE_DT,
                                        AR_IF_NO,INV_SPLIT_ISS_WRK_NO
                                 FROM   INV_AR_SPLIT_ISS
                                 WHERE  ISS_DT BETWEEN REPLACE(@[iss_fm_dt],'-','') AND REPLACE(@[iss_to_dt],'-','')
                                 AND    AR_OFC_CD = @[office]
                                 #if (${office} != 'BOMSC')     -- 2018.05.24 인도지역 Split Invoice Issue 기능 보완
                                 AND   (AR_OFC_CD, BL_SRC_NO, INV_SPLIT_ISS_WRK_NO) IN (
                                                                            SELECT AR_OFC_CD, BL_SRC_NO, MAX(INV_SPLIT_ISS_WRK_NO)
                                                                            FROM   INV_AR_SPLIT_ISS
                                                                            WHERE  INV_SPLIT_ISS_WRK_NO IS NOT NULL
                                                                            GROUP BY AR_OFC_CD, BL_SRC_NO)
                                 #end
                                ) B,
                               INV_AR_SPLIT_ISS_CHG C,
                               MDM_CURRENCY E,
                               MDM_CURRENCY F
                         WHERE 1=1
                           AND A.AR_IF_NO = B.AR_IF_NO
                           AND B.INV_NO   = C.INV_NO
                           AND B.INV_SEQ = 1
                           AND E.CURR_CD = A.LOCL_CURR_CD
                           AND F.CURR_CD = C.CURR_CD
                #if (${inv_no} != '')
                           AND B.INV_NO = @[inv_no]
                #end
                #if (${bl_src_no} != '')
                           AND B.BL_SRC_NO = @[bl_src_no]
                           #if (${office} != 'BOMSC')       -- 2018.05.24 인도지역 Split Invoice Issue 기능 보완
                           AND B.INV_SPLIT_ISS_WRK_NO = (SELECT MAX(INV_SPLIT_ISS_WRK_NO) FROM INV_AR_SPLIT_ISS WHERE AR_OFC_CD = @[office] AND BL_SRC_NO = @[bl_src_no])
                           #end
                #end
                #if ((${iss_fm_dt} != '') && (${iss_to_dt} != ''))
                           AND B.ISS_DT BETWEEN REPLACE(@[iss_fm_dt],'-','') AND REPLACE(@[iss_to_dt],'-','')
                           -- 한 BL로 여러번 Split 했을경우 전부조회됨.
                #end
                #if (${iss_ofc_cd} != '')
                           AND B.AR_OFC_CD = @[iss_ofc_cd]
                #else
                #if (${office} != '')
                           AND B.AR_OFC_CD IN ( SELECT OFC_CD
                                                   FROM MDM_ORGANIZATION
                                                  WHERE AR_OFC_CD = ( SELECT AR_OFC_CD
                                                                        FROM MDM_ORGANIZATION
                                                                       WHERE OFC_CD = @[office])) 
                #else 
                           AND B.AR_OFC_CD IN ( SELECT OFC_CD -- OFC ALL 선택시 적용..  
                                                  FROM MDM_ORGANIZATION
                                                 WHERE AR_HD_QTR_OFC_CD = ( SELECT AR_HD_QTR_OFC_CD
                                                                              FROM MDM_ORGANIZATION
                                                                             WHERE OFC_CD = ( SELECT AR_OFC_CD
                                                                                                FROM MDM_ORGANIZATION
                                                                                               WHERE OFC_CD = @[user_ofc_cd])))
                #end
                #end
                #if (${office} != '')
                           AND A.AR_OFC_CD = @[office] -- OFFICE
                #else 
                           AND A.AR_OFC_CD IN ( SELECT OFC_CD -- OFC ALL 선택시 적용..  
                                                  FROM MDM_ORGANIZATION
                                                 WHERE AR_HD_QTR_OFC_CD = ( SELECT AR_HD_QTR_OFC_CD
                                                                              FROM MDM_ORGANIZATION
                                                                             WHERE OFC_CD = ( SELECT AR_OFC_CD
                                                                                                FROM MDM_ORGANIZATION
                                                                                               WHERE OFC_CD = @[user_ofc_cd]))
                                                   AND OFC_CD = AR_OFC_CD )
                #end
                           AND NVL(A.INV_DELT_DIV_CD, 'N') <> 'Y'
                #if (${cust_cnt_cd} != '')
                           AND B.ACT_CUST_CNT_CD = @[cust_cnt_cd]
                #end
                #if (${cust_seq} != '')
                           AND B.ACT_CUST_SEQ = @[cust_seq]
                #end
                #if (${rev_type} != 'A')
                           AND A.REV_TP_CD = @[rev_type]
                #end
                #if (${vsl_cd} != '')
                           AND A.VSL_CD = @[vsl_cd]
                #end
                #if (${skd_voy_no} != '')
                           AND A.SKD_VOY_NO = @[skd_voy_no]
                #end
                #if (${skd_dir_cd} != '')
                           AND A.SKD_DIR_CD = @[skd_dir_cd]
                #end
                #if (${scope} != '')
                           AND A.SVC_SCP_CD = @[scope]
                #end
                #if (${bound} != 'A')
                           AND A.IO_BND_CD = @[bound]
                #if ((${bound} == 'I') && (${port} != ''))
                           AND A.POD_CD = @[port]
                #elseif ((${bound} == 'O') && (${port} != ''))
                           AND A.POL_CD = @[port]
                #end
                #else
                #if (${port} != '')
                           AND ((A.IO_BND_CD = 'I' AND A.POD_CD = @[port]) OR (A.IO_BND_CD = 'O' AND A.POL_CD = @[port]))  
                #end
                #end
                #if (${usr_id} != '')
                           AND A.CRE_USR_ID = @[usr_id]
                #end
                         GROUP BY B.ISS_DT, B.AR_OFC_CD, A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD, B.ACT_CUST_CNT_CD||'-'||LPAD(B.ACT_CUST_SEQ, 6, '0'), C.CURR_CD, C.INV_XCH_RT, B.CRE_USR_ID, B.INV_NO, A.SAIL_ARR_DT, A.POL_CD, A.POD_CD, C.INV_XCH_RT, B.CRE_USR_ID, F.DP_PRCS_KNT, E.DP_PRCS_KNT, A.AR_IF_NO, A.IO_BND_CD, A.REV_TP_CD||A.REV_SRC_CD, B.BL_SRC_NO	   
                 ORDER BY ISS_DT,INV_NO
         ) AA        
    #end
#end			]]></sql>
			<params>
				<param name="inv_no" type="12" value="" out="N"/>
				<param name="bl_src_no" type="12" value="" out="N"/>
				<param name="iss_fm_dt" type="12" value="" out="N"/>
				<param name="iss_to_dt" type="12" value="" out="N"/>
				<param name="office" type="12" value="" out="N"/>
				<param name="user_ofc_cd" type="12" value="" out="N"/>
				<param name="cust_cnt_cd" type="12" value="" out="N"/>
				<param name="cust_seq" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="bound" type="12" value="" out="N"/>
				<param name="port" type="12" value="" out="N"/>
				<param name="usr_id" type="12" value="" out="N"/>
				<param name="iss_ofc_cd" type="12" value="" out="N"/>
				<param name="rev_type" type="12" value="" out="N"/>
				<param name="scope" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
