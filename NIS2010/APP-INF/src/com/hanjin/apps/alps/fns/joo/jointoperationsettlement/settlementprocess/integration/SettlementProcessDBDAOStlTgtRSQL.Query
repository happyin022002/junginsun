<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="SettlementProcessDBDAOStlTgtRSQL">
			<desc><![CDATA[Settlement Target 페이지 조회]]></desc>
			<sql><![CDATA[
WITH SLT_TGT AS ( 
    SELECT
         J.REV_YRMON
        ,J.REV_YRMON_SEQ
        ,S.REV_SEQ
        ,J.TRD_CD
        ,J.CRR_CD
        ,J.RLANE_CD
        ,J.RE_DIVR_CD
        ,J.VSL_CD
        ,J.SKD_VOY_NO
        ,J.SKD_DIR_CD
        ,J.LST_LODG_PORT_CD AS VPS_PORT_CD
        ,'' AS YD_CD
        ,'' AS CLPT_IND_SEQ
        ,'' AS RDR_FLG
        ,J.N1ST_LODG_PORT_ETD_DT AS VPS_ETD_DT
        ,J.ACCT_CD
        ,J.JO_STL_JB_CD
        ,J.JO_STL_STS_CD            --Maual Setting
        ,'S/H' AS JO_STL_ITM_CD
        ,DECODE(J.FNL_BSA_QTY,NULL,J.BSA_QTY,J.FNL_BSA_QTY) 			  AS BSA_QTY
        ,DECODE(J.FNL_BSA_SLT_PRC ,NULL,J.BSA_SLT_PRC,J.FNL_BSA_SLT_PRC ) AS BSA_SLT_PRC    
		,S.FNL_BSA_QTY 
		,S.FNL_BSA_SLT_PRC 
        ,NVL(S.LOCL_CURR_CD,'USD') AS LOCL_CURR_CD
        ,S.STL_LOCL_AMT
        ,S.STL_RMK
        ,'S/H' AS JO_STL_TGT_ITM_CD
        ,J.ESTM_STL_AMT         --추정금액
        ,J.ACT_STL_AMT          --정산금액
        ,'' AS RF_SCG_STL_TP_CD     --T(TDR), R(RDR), I(User INPUT)
        ,1 AS LEV
        ,MIN(J.VSL_CD || J.SKD_VOY_NO || J.SKD_DIR_CD || J.REV_YRMON) OVER (PARTITION BY J.VSL_CD || J.SKD_VOY_NO || J.SKD_DIR_CD) AS VVD_ETD_GROUP
        ,(
			SELECT NVL(MAX(J3.ACCT_YRMON),'999912') AS ACCT_YRMON FROM JOO_STL_TGT J2, JOO_SETTLEMENT J3
			WHERE J2.REV_YRMON = S.REV_YRMON
			AND J2.REV_YRMON_SEQ = S.REV_YRMON_SEQ
            AND J2.REV_SEQ = S.REV_SEQ
			AND J2.ACCT_YRMON = J3.ACCT_YRMON(+)
			AND J2.STL_VVD_SEQ = J3.STL_VVD_SEQ(+)
			AND J2.STL_SEQ = J3.STL_SEQ(+)
          ) ACCT_YRMON   
        ,S.STL_VVD_SEQ
        ,S.STL_SEQ 
        ,S.STL_TGT_FLG
        ,S.STL_TGT_FLG AS STL_TGT_FLG2
        ,S.STL_CLZ_FLG 
        ,J.REV_DIR_CD
        ,'' AS TML
        ,NULL AS REV_BSA_QTY
        ,NULL AS REV_BSA_SLT_PRC
        ,NULL AS REV_ENBL_FLG 
        ,'Y' AS REV_SHW_FLG
        ,NULL AS REV_CRR_CD
        ,NULL AS N2ND_REV_BSA_QTY
        ,NULL AS N2ND_REV_BSA_SLT_PRC
        ,NULL AS N2ND_REV_ENBL_FLG
        ,NULL AS N2ND_REV_CRR_CD
        ,NULL AS N3RD_REV_BSA_QTY
        ,NULL AS N3RD_REV_BSA_SLT_PRC
        ,NULL AS N3RD_REV_ENBL_FLG
        ,NULL AS N3RD_REV_CRR_CD    
        ,NULL AS REV_CHK
        ,NULL AS N2ND_REV_CHK
        ,NULL AS N3RD_REV_CHK  
    FROM (
			SELECT 
                 J.REV_YRMON
                ,J.REV_YRMON_SEQ
                ,J.TRD_CD
                ,J.CRR_CD
                ,J.RLANE_CD
                ,J.RE_DIVR_CD
                ,J.VSL_CD
                ,J.SKD_VOY_NO
                ,J.SKD_DIR_CD
                ,J.LST_LODG_PORT_CD
                ,J.N1ST_LODG_PORT_ETD_DT
                ,J.ACCT_CD
                ,J.JO_STL_JB_CD
                ,J.JO_STL_STS_CD        
                ,J.BSA_QTY
                ,J.FNL_BSA_QTY
                ,J.BSA_SLT_PRC
                ,J.FNL_BSA_SLT_PRC
                ,J.ESTM_STL_AMT         
                ,J.ACT_STL_AMT          
                ,J.REV_DIR_CD 
                ,J.JO_FSH_FLG
			FROM JOO_SLT_TGT J
			WHERE 1=1
			AND J.JO_FSH_FLG = '1'
		    AND J.REV_YRMON BETWEEN REPLACE(@[rev_yrmon_fr],'-','') AND REPLACE(@[rev_yrmon_to],'-','')
		    #if (${re_divr_cd} != '')			
		    AND J.RE_DIVR_CD = @[re_divr_cd]
		    #end
		    #if (${jo_crr_cd} != '')
		    AND J.CRR_CD = @[jo_crr_cd]
		    #end
		    #if (${trd_cd} != '')
		    AND J.TRD_CD    = @[trd_cd]
		    #end
		    #if (${rlane_cd} != '')
		    AND J.RLANE_CD  = @[rlane_cd]
		    #end
		    #if (${vvd} != '')
			AND (J.VSL_CD || J.SKD_VOY_NO || J.SKD_DIR_CD)	LIKE @[vvd] || '%'
		    #end
		 ) J
		 ,(
			SELECT 
                 S.FNL_BSA_QTY 
                ,S.FNL_BSA_SLT_PRC 
                ,S.LOCL_CURR_CD
                ,S.STL_LOCL_AMT
                ,S.STL_RMK
                ,S.STL_VVD_SEQ
                ,S.STL_SEQ 
                ,S.STL_TGT_FLG
                ,S.STL_CLZ_FLG              
                ,S.REV_YRMON
                ,S.REV_YRMON_SEQ
                ,S.REV_SEQ
                ,S.TRD_CD
                ,S.CRR_CD
                ,S.RLANE_CD
                ,S.VSL_CD
                ,S.SKD_VOY_NO
                ,S.SKD_DIR_CD			
            FROM JOO_STL_TGT S
            WHERE 1=1
        	AND S.JO_STL_ITM_CD  = 'S/H'
		    AND S.REV_YRMON BETWEEN REPLACE(@[rev_yrmon_fr],'-','') AND REPLACE(@[rev_yrmon_to],'-','')
		    #if (${re_divr_cd} != '')			
		    AND S.RE_DIVR_CD = @[re_divr_cd]
		    #end
		    #if (${jo_crr_cd} != '')
		    AND S.CRR_CD = @[jo_crr_cd]
		    #end
		    #if (${trd_cd} != '')
		    AND S.TRD_CD    = @[trd_cd]
		    #end
		    #if (${rlane_cd} != '')
		    AND S.RLANE_CD  = @[rlane_cd]
		    #end
		    #if (${vvd} != '')
			AND (S.VSL_CD || S.SKD_VOY_NO || S.SKD_DIR_CD)	LIKE @[vvd] || '%'
		    #end  
		 ) S
    WHERE 1=1
    AND J.JO_FSH_FLG = '1'
    AND J.REV_YRMON = S.REV_YRMON(+)
    AND J.REV_YRMON_SEQ = S.REV_YRMON_SEQ(+)
	AND J.TRD_CD = S.TRD_CD(+)
	AND J.CRR_CD = S.CRR_CD(+)
 	AND J.RLANE_CD = S.RLANE_CD(+)
    AND J.VSL_CD = S.VSL_CD(+)
    AND J.SKD_VOY_NO = S.SKD_VOY_NO(+)
    AND J.SKD_DIR_CD = S.SKD_DIR_CD(+)
), STL_TGT AS (    
	SELECT 
         S.REV_YRMON
        ,S.REV_YRMON_SEQ
        ,S.REV_SEQ
        ,S.TRD_CD
        ,S.CRR_CD
        ,S.RLANE_CD
        ,S.RE_DIVR_CD
        ,S.VSL_CD
        ,S.SKD_VOY_NO
        ,S.SKD_DIR_CD
        ,S.VPS_PORT_CD
        ,S.YD_CD
        ,S.CLPT_IND_SEQ
        ,S.RDR_FLG
        ,S.VPS_ETD_DT
        ,S.ACCT_CD
        ,S.JO_STL_JB_CD
        ,S.JO_STL_STS_CD
        ,S.JO_STL_ITM_CD
        ,S.BSA_QTY
        ,S.BSA_SLT_PRC
        ,S.FNL_BSA_QTY
        ,S.FNL_BSA_SLT_PRC
        ,S.LOCL_CURR_CD
        ,S.STL_LOCL_AMT
        ,S.STL_RMK
        ,S.JO_STL_TGT_ITM_CD
--        ,S.ESTM_STL_AMT
--        ,S.ACT_STL_AMT
--        ,S.RF_SCG_STL_TP_CD
        ,S.LEV
        ,S.VVD_ETD_GROUP
        ,S.ACCT_YRMON
        ,S.STL_VVD_SEQ
        ,S.STL_SEQ
        ,S.STL_TGT_FLG
        ,S.STL_TGT_FLG2
        ,S.STL_CLZ_FLG
        ,S.REV_DIR_CD
        ,S.TML
        ,S.REV_BSA_QTY
        ,S.REV_BSA_SLT_PRC
        ,S.REV_ENBL_FLG
        ,S.REV_SHW_FLG
        ,S.REV_CRR_CD
        ,S.N2ND_REV_BSA_QTY
        ,S.N2ND_REV_BSA_SLT_PRC
        ,S.N2ND_REV_ENBL_FLG
        ,S.N2ND_REV_CRR_CD
        ,S.N3RD_REV_BSA_QTY
        ,S.N3RD_REV_BSA_SLT_PRC
        ,S.N3RD_REV_ENBL_FLG
        ,S.N3RD_REV_CRR_CD
        ,S.REV_CHK
        ,S.N2ND_REV_CHK
        ,S.N3RD_REV_CHK    
    FROM SLT_TGT S
    UNION ALL
	SELECT 
         S.REV_YRMON
        ,S.REV_YRMON_SEQ
        ,S.REV_SEQ
        ,S.TRD_CD
        ,S.CRR_CD
        ,S.RLANE_CD
        ,S.RE_DIVR_CD
        ,S.VSL_CD
        ,S.SKD_VOY_NO
        ,S.SKD_DIR_CD
        ,S.VPS_PORT_CD
        ,S.YD_CD
        ,S.CLPT_IND_SEQ
        ,S.RDR_FLG
        ,S.VPS_ETD_DT
        ,S.ACCT_CD
        ,S.JO_STL_JB_CD
        ,S.JO_STL_STS_CD
        ,S.JO_STL_ITM_CD
        ,S.BSA_QTY
        ,S.BSA_SLT_PRC
        ,S.FNL_BSA_QTY
        ,S.FNL_BSA_SLT_PRC
        ,S.LOCL_CURR_CD
        ,S.STL_LOCL_AMT
        ,S.STL_RMK
        ,'S/H' AS JO_STL_TGT_ITM_CD
--        ,NULL AS ESTM_STL_AMT
--        ,0 AS ACT_STL_AMT
--        ,S.RF_SCG_STL_TP_CD
        ,1 AS LEV
        ,MIN(VSL_CD || SKD_VOY_NO || SKD_DIR_CD || REV_YRMON) OVER (PARTITION BY VSL_CD || SKD_VOY_NO || SKD_DIR_CD) AS VVD_ETD_GROUP 
        ,S.ACCT_YRMON
        ,S.STL_VVD_SEQ
        ,S.STL_SEQ
        ,S.STL_TGT_FLG
        ,S.STL_TGT_FLG AS STL_TGT_FLG2
        ,S.STL_CLZ_FLG
        ,S.REV_DIR_CD
        ,'' AS TML
        ,NULL AS REV_BSA_QTY
        ,NULL AS REV_BSA_SLT_PRC
        ,NULL AS REV_ENBL_FLG 
        ,S.REV_SHW_FLG
        ,NULL AS REV_CRR_CD
        ,NULL AS N2ND_REV_BSA_QTY
        ,NULL AS N2ND_REV_BSA_SLT_PRC
        ,NULL AS N2ND_REV_ENBL_FLG
        ,NULL AS N2ND_REV_CRR_CD
        ,NULL AS N3RD_REV_BSA_QTY
        ,NULL AS N3RD_REV_BSA_SLT_PRC
        ,NULL AS N3RD_REV_ENBL_FLG
        ,NULL AS N3RD_REV_CRR_CD    
        ,NULL AS REV_CHK
        ,NULL AS N2ND_REV_CHK
        ,NULL AS N3RD_REV_CHK    
    FROM JOO_STL_TGT S    
    WHERE 1=1
    AND S.REV_SHW_FLG IN ('A','C','S')
    AND S.JO_STL_ITM_CD  = 'S/H'
		    AND S.REV_YRMON BETWEEN REPLACE(@[rev_yrmon_fr],'-','') AND REPLACE(@[rev_yrmon_to],'-','')
		    #if (${re_divr_cd} != '')			
		    AND S.RE_DIVR_CD = @[re_divr_cd]
		    #end
		    #if (${jo_crr_cd} != '')
		    AND S.CRR_CD = @[jo_crr_cd]
		    #end
		    #if (${trd_cd} != '')
		    AND S.TRD_CD    = @[trd_cd]
		    #end
		    #if (${rlane_cd} != '')
		    AND S.RLANE_CD  = @[rlane_cd]
		    #end
		    #if (${vvd} != '')
			AND (S.VSL_CD || S.SKD_VOY_NO || S.SKD_DIR_CD)	LIKE @[vvd] || '%'
		    #end  
), STL_TGT2 AS ( 
    SELECT  
         S.REV_YRMON
        ,S.REV_YRMON_SEQ
        ,S.REV_SEQ
        ,S.TRD_CD
        ,S.CRR_CD
        ,S.RLANE_CD
        ,S.RE_DIVR_CD
        ,S.VSL_CD
        ,S.SKD_VOY_NO
        ,S.SKD_DIR_CD
        ,S.VPS_PORT_CD
        ,S.YD_CD
        ,S.CLPT_IND_SEQ
        ,S.RDR_FLG
        ,S.VPS_ETD_DT
        ,S.ACCT_CD
        ,S.JO_STL_JB_CD
        ,S.JO_STL_STS_CD
        ,S.JO_STL_ITM_CD
        ,S.BSA_QTY
        ,S.BSA_SLT_PRC
        ,S.FNL_BSA_QTY
        ,S.FNL_BSA_SLT_PRC
        ,S.LOCL_CURR_CD
        ,S.STL_LOCL_AMT
        ,S.STL_RMK
        ,S.JO_STL_TGT_ITM_CD
--        ,S.ESTM_STL_AMT
--        ,S.ACT_STL_AMT
--        ,S.RF_SCG_STL_TP_CD
        ,S.LEV
        ,S.VVD_ETD_GROUP
        ,S.ACCT_YRMON
        ,S.STL_VVD_SEQ
        ,S.STL_SEQ
        ,S.STL_TGT_FLG
        ,S.STL_TGT_FLG2
        ,S.STL_CLZ_FLG
        ,S.REV_DIR_CD
        ,S.TML
        ,S.REV_BSA_QTY
        ,S.REV_BSA_SLT_PRC
        ,S.REV_ENBL_FLG
        ,S.REV_SHW_FLG
        ,S.REV_CRR_CD
        ,S.N2ND_REV_BSA_QTY
        ,S.N2ND_REV_BSA_SLT_PRC
        ,S.N2ND_REV_ENBL_FLG
        ,S.N2ND_REV_CRR_CD
        ,S.N3RD_REV_BSA_QTY
        ,S.N3RD_REV_BSA_SLT_PRC
        ,S.N3RD_REV_ENBL_FLG
        ,S.N3RD_REV_CRR_CD
        ,S.REV_CHK
        ,S.N2ND_REV_CHK
        ,S.N3RD_REV_CHK      
    FROM STL_TGT S
    ORDER BY VVD_ETD_GROUP, VPS_ETD_DT, LEV, REV_YRMON_SEQ, REV_SEQ ASC          
)    
SELECT 
     ROWNUM AS SEQ_NO
    ,REV_YRMON
    ,REV_YRMON_SEQ
    ,REV_SEQ
    ,TRD_CD
    ,CRR_CD
    ,RLANE_CD
    ,RE_DIVR_CD
    ,VSL_CD
    ,SKD_VOY_NO
    ,SKD_DIR_CD
    ,VPS_PORT_CD
    ,YD_CD
    ,CLPT_IND_SEQ
    ,RDR_FLG
    ,VPS_ETD_DT
    ,ACCT_CD
    ,JO_STL_JB_CD
    ,JO_STL_STS_CD
    ,JO_STL_ITM_CD
    ,BSA_QTY
    ,BSA_SLT_PRC
    ,FNL_BSA_QTY
    ,FNL_BSA_SLT_PRC
    ,LOCL_CURR_CD
    ,STL_LOCL_AMT
    ,STL_RMK
    ,JO_STL_TGT_ITM_CD
    ,NULL AS ESTM_STL_AMT
    ,NULL AS ACT_STL_AMT
    ,NULL AS RF_SCG_STL_TP_CD
    ,LEV
    ,VVD_ETD_GROUP
    ,NVL(ACCT_YRMON,'999912') AS ACCT_YRMON
    ,STL_VVD_SEQ
    ,STL_SEQ
    ,STL_TGT_FLG
    ,STL_TGT_FLG2
    ,STL_CLZ_FLG
    ,REV_DIR_CD
    ,TML
    ,REV_BSA_QTY
    ,REV_BSA_SLT_PRC
    ,REV_ENBL_FLG
    ,REV_SHW_FLG
    ,REV_CRR_CD
    ,N2ND_REV_BSA_QTY
    ,N2ND_REV_BSA_SLT_PRC
    ,N2ND_REV_ENBL_FLG
    ,N2ND_REV_CRR_CD
    ,N3RD_REV_BSA_QTY
    ,N3RD_REV_BSA_SLT_PRC
    ,N3RD_REV_ENBL_FLG
    ,N3RD_REV_CRR_CD
    ,REV_CHK
    ,N2ND_REV_CHK
    ,N3RD_REV_CHK	
FROM STL_TGT2			]]></sql>
			<params>
				<param name="rev_yrmon_fr" type="12" value="" out="N"/>
				<param name="rev_yrmon_to" type="12" value="" out="N"/>
				<param name="re_divr_cd" type="12" value="" out="N"/>
				<param name="jo_crr_cd" type="12" value="" out="N"/>
				<param name="trd_cd" type="12" value="" out="N"/>
				<param name="rlane_cd" type="12" value="" out="N"/>
				<param name="vvd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
