<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CarrierSettlementProcessDBDAOGetUsedSlotInfoRSQL">
			<desc><![CDATA[OUS RDR Rgeion 정보변경시 Used Slot 정보를 가져온다.]]></desc>
			<sql><![CDATA[
WITH CRR_MST AS (
  SELECT B.JO_CRR_CD
    FROM JOO_STL_VVD A,
         (
  		   SELECT DECODE(@[re_divr_cd], 'E', 'SML', @[jo_crr_cd]) AS JO_CRR_CD, TO_DATE('99991231','YYYYMMDD') AS EFF_ETA_DT
  		     FROM DUAL
  
  		   UNION  ALL
  
  		   SELECT JO_N2ND_CRR_CD AS JO_CRR_CD, EFF_ETA_DT
  		     FROM JOO_CRR_MRG A
  		    WHERE A.DELT_FLG       = 'N'
  		      AND A.ACCTG_CRR_CD   = @[jo_crr_cd]
  		      AND A.JO_N1ST_CRR_CD = DECODE(@[re_divr_cd], 'E', 'SML', @[jo_crr_cd])
  		      AND A.TRD_CD         = @[trd_cd]
  		      AND A.RLANE_CD       = @[rlane_cd]
         ) B
   WHERE A.BZC_PORT_ETA_DT <= B.EFF_ETA_DT
     AND A.ACCT_YRMON    = REPLACE(@[acct_yrmon],'-','')
     AND A.JO_CRR_CD     = @[jo_crr_cd]
     AND A.TRD_CD        = @[trd_cd]
     AND A.RLANE_CD      = @[rlane_cd]
     AND A.RE_DIVR_CD    = @[re_divr_cd]
     AND A.JO_STL_ITM_CD = @[jo_stl_itm_cd]
     AND A.JO_MNU_NM    IN ('RDR','TDR')
     AND A.JO_STL_CFM_CD = 'Y'
     AND A.VSL_CD        = @[vsl_cd]
     AND A.SKD_VOY_NO    = @[skd_voy_no]
     AND A.SKD_DIR_CD    = @[skd_dir_cd]
     AND A.REV_DIR_CD    = @[rev_dir_cd]
)
#if (${ioc_cd} == 'O')
SELECT PORT_CD AS FM_PORT_CD, 
       SUM(DECODE(FLG,'1',TEU,0)) AS USD_SLT_BSA_QTY,
       SUM(DECODE(FLG,'1',WGT,0)) AS USD_SLT_WGT,
       SUM(DECODE(FLG,'2',TEU,0)) AS FNL_HJS_BSA_QTY,
       SUM(DECODE(FLG,'2',WGT,0)) AS FNL_BSA_WGT
FROM   (
       SELECT '1' AS FLG, H.PORT_CD, U.SLOT_QTY AS TEU, U.WEIGHT AS WGT
         FROM  RDR_HEADER H, 
               (
               SELECT VSL_CD, VOY_NO, DIR_CD, REGION, SLOT_QTY, WEIGHT
                 FROM RDR_UTILIZE 
                WHERE OPR_CD IN (SELECT JO_CRR_CD FROM CRR_MST) 
               ) U
        WHERE  H.VSL_CD  = U.VSL_CD(+)
          AND  H.VOY_NO  = U.VOY_NO(+)
          AND  H.DIR_CD  = U.DIR_CD(+)
          AND  H.REGION  = U.REGION(+)
          AND  H.VSL_CD  = @[vsl_cd] 
          AND  H.VOY_NO  = @[skd_voy_no] 
          AND  H.DIR_CD  = @[skd_dir_cd] 
          AND  H.REGION  = @[sconti_cd]

        UNION  ALL
        
       SELECT '2' AS FLG, H.PORT_CD, A.BSA_SLOT AS TEU, A.BSA_WGT AS WGT
         FROM  RDR_HEADER H, 
               (
               SELECT VSL_CD, VOY_NO, DIR_CD, REGION, BSA_SLOT, BSA_WGT
                 FROM RDR_ALLOCATION
                WHERE OPR_CD IN (SELECT JO_CRR_CD FROM CRR_MST) 
               ) A
        WHERE  H.VSL_CD  = A.VSL_CD(+)
          AND  H.VOY_NO  = A.VOY_NO(+)
          AND  H.DIR_CD  = A.DIR_CD(+)
          AND  H.REGION  = A.REGION(+)
          AND  H.VSL_CD  = @[vsl_cd] 
          AND  H.VOY_NO  = @[skd_voy_no] 
          AND  H.DIR_CD  = @[skd_dir_cd] 
          AND  H.REGION  = @[sconti_cd]
       )
GROUP BY PORT_CD
#elseif (${ioc_cd} == 'I')
SELECT PORT_CD AS FM_PORT_CD, 
       SUM(DECODE(FLG,'1',TEU,0)) AS USD_SLT_BSA_QTY,
       SUM(DECODE(FLG,'1',WGT,0)) AS USD_SLT_WGT,
       SUM(DECODE(FLG,'2',TEU,0)) AS FNL_HJS_BSA_QTY,
       SUM(DECODE(FLG,'2',WGT,0)) AS FNL_BSA_WGT
FROM   (
       SELECT '1' AS FLG, H.PORT_CD, S.QTY AS TEU, S.WEIGHT AS WGT
         FROM  RDR_HEADER  H,
               (
               SELECT VSL_CD, VOY_NO, DIR_CD, REGION, POL, QTY, WEIGHT
                 FROM RDR_SUMMARY
                WHERE OPR_CD IN (SELECT JO_CRR_CD FROM CRR_MST) 
                  AND STATUS = 'IP'
               ) S
        WHERE H.VSL_CD  = S.VSL_CD(+)
          AND H.VOY_NO  = S.VOY_NO(+)
          AND H.DIR_CD  = S.DIR_CD(+)
          AND H.REGION  = S.REGION(+)
          AND H.PORT_CD = S.POL   (+)
          AND H.VSL_CD  = @[vsl_cd] 
          AND H.VOY_NO  = @[skd_voy_no] 
          AND H.DIR_CD  = @[skd_dir_cd] 
          AND H.REGION  = @[sconti_cd]
          
        UNION  ALL
        
       SELECT '2' AS FLG, H.PORT_CD, A.BSA_SLOT AS TEU, A.BSA_WGT AS WGT
         FROM RDR_HEADER     H, 
               (
               SELECT VSL_CD, VOY_NO, DIR_CD, REGION, BSA_SLOT, BSA_WGT
                 FROM RDR_ALLOCATION
                WHERE OPR_CD IN (SELECT JO_CRR_CD FROM CRR_MST) 
               ) A
        WHERE H.VSL_CD  = A.VSL_CD(+)
          AND H.VOY_NO  = A.VOY_NO(+)
          AND H.DIR_CD  = A.DIR_CD(+)
          AND H.REGION  = A.REGION(+)
          AND H.VSL_CD  = @[vsl_cd] 
          AND H.VOY_NO  = @[skd_voy_no] 
          AND H.DIR_CD  = @[skd_dir_cd] 
          AND H.REGION  = @[sconti_cd]
       )
GROUP BY PORT_CD
#end			]]></sql>
			<params>
				<param name="re_divr_cd" type="12" value="R" out="N"/>
				<param name="jo_crr_cd" type="12" value="COS" out="N"/>
				<param name="trd_cd" type="12" value="" out="N"/>
				<param name="rlane_cd" type="12" value="PNSTP" out="N"/>
				<param name="acct_yrmon" type="12" value="" out="N"/>
				<param name="jo_stl_itm_cd" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="HJWS" out="N"/>
				<param name="skd_voy_no" type="12" value="0092" out="N"/>
				<param name="skd_dir_cd" type="12" value="E" out="N"/>
				<param name="rev_dir_cd" type="12" value="" out="N"/>
				<param name="sconti_cd" type="12" value="A" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
