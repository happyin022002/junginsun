<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="InvoiceIssueDBDAOremoveInvArIssSndForSysClearDSQL">
			<desc><![CDATA[Issue 동작 중에 Sys Clear 동작이 발생한  Send 정보를 삭제한다.]]></desc>
			<sql><![CDATA[
MERGE INTO INV_AR_ISS_SND T
USING   (
        SELECT  INV_NO       -- 삭제 대상 Invoice 정보
        FROM    (
                SELECT  T12.INV_NO, INV_IN_DEL_IF_CNT, COUNT(DISTINCT T12.AR_IF_NO) AS INV_IN_TTL_IF_CNT --Invoice 내에 포함된 있는 전체 A/R IF 갯수
                FROM    (
                        SELECT T02.INV_NO, COUNT(DISTINCT T01.AR_IF_NO) AS INV_IN_DEL_IF_CNT             --Invoice 내에 포함된 Rollback 대상 A/R IF 갯수
                        FROM   INV_AR_MN        T01
                               , INV_AR_ISS_DTL T02
                        WHERE  1=1
                        AND    T01.AR_IF_NO     = T02.AR_IF_NO
                        AND    T01.INV_CLR_FLG  = 'Y'
                        AND    T01.AR_IF_NO IN (
                                              SELECT AR_IF_NO
                                              FROM   INV_AR_ISS_FTR
                                              WHERE  INV_ISS_WRK_NO = @[wrk_no]
                                              GROUP BY AR_IF_NO
                                              )
                        GROUP BY T02.INV_NO
                        ) T11, INV_AR_ISS_DTL T12
                WHERE   T11.INV_NO  = T12.INV_NO
                GROUP BY T12.INV_NO, INV_IN_DEL_IF_CNT
                )
        WHERE  INV_IN_TTL_IF_CNT = INV_IN_DEL_IF_CNT    -- Invoice 내에 포함되여 있는 전체 A/F IF 개수와 Invocie 내 Sys Clear 갯수가 동일할 경우 삭제 대상이 됨
        ) S
ON      (T.INV_NO = S.INV_NO)
WHEN MATCHED THEN UPDATE SET ERR_DESC = 'DELETE'
                  DELETE WHERE (T.INV_NO = S.INV_NO)			]]></sql>
			<params>
				<param name="wrk_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
