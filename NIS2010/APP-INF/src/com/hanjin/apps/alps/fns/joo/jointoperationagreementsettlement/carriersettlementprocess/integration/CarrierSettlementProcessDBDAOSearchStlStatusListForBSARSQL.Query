<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CarrierSettlementProcessDBDAOSearchStlStatusListForBSARSQL">
			<desc><![CDATA[DESC Enter..]]></desc>
			<sql><![CDATA[
/*2010.03.24 GL_ESTM_REV_VVD 기준으로 변경*/
/*권한은 필요없음*/
WITH AR_MST AS (
     SELECT DISTINCT
            A.REV_YRMON, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD, A.RLANE_CD
     FROM   GL_ESTM_REV_VVD A
     WHERE  A.REV_YRMON   >= REPLACE(@[acct_yrmon_fr],'-','')
     AND    A.REV_YRMON   <= REPLACE(@[acct_yrmon_to],'-','')
     AND    A.SKD_DIR_CD IN ('N','E','W','S')
     AND    A.ESTM_IOC_DIV_CD = DECODE(SUBSTR(A.RLANE_CD, -2), 'IA', 'IA', 'IE', 'IE', 'IM', 'IM', 'TA','OO', 'TP','OO', 'AE','OO')
     AND    A.RLANE_CD LIKE '%'||SUBSTR(@[trd_cd],1,2)
#if(${rlane_cd} != '')
     AND    A.RLANE_CD  = @[rlane_cd]
#end
)
SELECT 
--       B.ACCT_YRMON,
       A.REV_YRMON AS COST_YRMON, 
       B.JO_CRR_CD,
       A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD||A.REV_DIR_CD AS VVD,
       B.TRD_CD,
       A.RLANE_CD,
       B.BSA_R_AMT,
       B.JOO_R_AMT,
       B.DIFF_R_YN,
       B.BSA_E_AMT,
       B.JOO_E_AMT,
       B.DIFF_E_YN
FROM   AR_MST A, 
      (
       SELECT
       --       JOO.ACCT_YRMON,
              NVL(JOO.REV_YRMON, COA.REV_YRMON) AS COST_YRMON,
              NVL(JOO.JO_CRR_CD, COA.JO_CRR_CD) AS JO_CRR_CD,
              NVL(JOO.VSL_CD    ,COA.VSL_CD    ) AS VSL_CD,
              NVL(JOO.SKD_VOY_NO,COA.SKD_VOY_NO) AS SKD_VOY_NO,
              NVL(JOO.SKD_DIR_CD,COA.SKD_DIR_CD) AS SKD_DIR_CD,
              NVL(JOO.REV_DIR_CD,COA.REV_DIR_CD) AS REV_DIR_CD,
       --       NVL(JOO.VSL_CD||JOO.SKD_VOY_NO||JOO.SKD_DIR_CD||JOO.REV_DIR_CD, COA.VSL_CD||COA.SKD_VOY_NO||COA.SKD_DIR_CD||COA.REV_DIR_CD) AS VVD,
              NVL(JOO.TRD_CD, COA.TRD_CD) AS TRD_CD,
              NVL(JOO.RLANE_CD, COA.RLANE_CD) AS RLANE_CD,
              NVL(SUM(COA.BSA_R_AMT),0) AS BSA_R_AMT,
              NVL(SUM(JOO.JOO_R_AMT),0) AS JOO_R_AMT,
              CASE WHEN NVL(SUM(COA.BSA_R_AMT),0) <> NVL(SUM(JOO.JOO_R_AMT),0) THEN 'Y' ELSE 'N' END DIFF_R_YN,
              NVL(SUM(COA.BSA_E_AMT),0) AS BSA_E_AMT,
              NVL(SUM(JOO.JOO_E_AMT),0) AS JOO_E_AMT,
              CASE WHEN NVL(SUM(COA.BSA_E_AMT),0) <> NVL(SUM(JOO.JOO_E_AMT),0) THEN 'Y' ELSE 'N' END DIFF_E_YN
       FROM   (
              SELECT
                     A.REV_YRMON, B.CRR_CD AS JO_CRR_CD, B.TRD_CD, A.RLANE_CD, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD,
                     SUM(CASE WHEN B.BSA_OP_JB_CD IN ('001','002','0004') THEN B.CRR_PERF_AMT ELSE 0 END) AS BSA_R_AMT,
                     SUM(CASE WHEN B.BSA_OP_JB_CD IN ('000','003','0005') THEN B.CRR_PERF_AMT ELSE 0 END) AS BSA_E_AMT
              FROM   AR_MST A,
                     BSA_VVD_CRR_PERF B,
                    (
                     SELECT JO_CRR_CD, RLANE_CD
                     FROM   JOO_CRR_AUTH
                     WHERE  DELT_FLG = 'N'
#if (${ofc_cd} != '')
                     AND    AUTH_OFC_CD = @[ofc_cd]
#end                   
                     GROUP  BY JO_CRR_CD, RLANE_CD 
                    ) C
              WHERE  A.VSL_CD     = B.VSL_CD     
              AND    A.SKD_VOY_NO = B.SKD_VOY_NO 
              AND    A.SKD_DIR_CD = B.SKD_DIR_CD 
              AND    A.RLANE_CD   = B.RLANE_CD   
              AND    B.CRR_CD     = C.JO_CRR_CD
              AND    B.RLANE_CD   = C.RLANE_CD
              AND    B.TRD_CD     = @[trd_cd]
#if (${rlane_cd} != '')
              AND    B.RLANE_CD   = @[rlane_cd]
#end              
              AND    B.CRR_PERF_AMT <> 0
              GROUP  BY
                     A.REV_YRMON, B.CRR_CD, B.TRD_CD, A.RLANE_CD, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD
              ) COA FULL OUTER JOIN
              (
              SELECT A.REV_YRMON, J.JO_CRR_CD, J.TRD_CD, A.RLANE_CD, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.REV_DIR_CD, 
                     J.JOO_R_AMT, J.JOO_E_AMT
              FROM   AR_MST A,
                     (
                     SELECT
                            J.JO_CRR_CD, J.TRD_CD, J.RLANE_CD, J.VSL_CD, J.SKD_VOY_NO, J.SKD_DIR_CD, J.REV_DIR_CD,
                            SUM(DECODE(J.RE_DIVR_CD,'R',J.STL_LOCL_AMT,0)) AS JOO_R_AMT,
                            SUM(DECODE(J.RE_DIVR_CD,'E',J.STL_LOCL_AMT,0)) AS JOO_E_AMT
                     FROM   JOO_SETTLEMENT  J,
                            JOO_STL_CMB_DTL D,
                            JOO_STL_CMB     C
                     WHERE  J.ACCT_YRMON    = D.ACCT_YRMON
                     AND    J.STL_VVD_SEQ   = D.STL_VVD_SEQ
                     AND    J.STL_SEQ       = D.STL_SEQ
                     AND    D.ACCT_YRMON    = C.ACCT_YRMON
                     AND    D.JO_CRR_CD     = C.JO_CRR_CD
                     AND    D.STL_CMB_SEQ   = C.STL_CMB_SEQ
                     AND    D.RE_DIVR_CD    = C.RE_DIVR_CD
                     AND    J.CMB_CFM_FLG   = 'Y'
                     AND    C.SLP_SER_NO    IS NOT NULL
                     AND    J.JO_STL_ITM_CD = 'S/H'
                     AND    J.TRD_CD        = @[trd_cd]
#if (${rlane_cd} != '')
                     AND    J.RLANE_CD      = @[rlane_cd]
#end              
                     AND    NVL(C.RVS_CMB_FLG ,'N') = 'N'
                     AND    NVL(C.RJCT_CMB_FLG,'N') = 'N'
                     AND    J.STL_LOCL_AMT <> 0
                     GROUP  BY
                            J.JO_CRR_CD, J.TRD_CD, J.RLANE_CD, J.VSL_CD, J.SKD_VOY_NO, J.SKD_DIR_CD, J.REV_DIR_CD              
                     ) J,
                    (
                     SELECT JO_CRR_CD, RLANE_CD
                     FROM   JOO_CRR_AUTH
                     WHERE  DELT_FLG = 'N'
#if (${ofc_cd} != '')
                     AND    AUTH_OFC_CD = @[ofc_cd]
#end                   
                     GROUP  BY JO_CRR_CD, RLANE_CD 
                    ) C
              WHERE  A.VSL_CD     = J.VSL_CD    
              AND    A.SKD_VOY_NO = J.SKD_VOY_NO
              AND    A.SKD_DIR_CD = J.SKD_DIR_CD
              AND    A.REV_DIR_CD = J.REV_DIR_CD
              AND    J.JO_CRR_CD  = C.JO_CRR_CD
              AND    J.RLANE_CD   = C.RLANE_CD
              ) JOO
              ON  (COA.VSL_CD     = JOO.VSL_CD
              AND  COA.SKD_VOY_NO = JOO.SKD_VOY_NO
              AND  COA.SKD_DIR_CD = JOO.SKD_DIR_CD
              AND  COA.REV_DIR_CD = JOO.REV_DIR_CD
              AND  COA.JO_CRR_CD  = JOO.JO_CRR_CD
              AND  COA.TRD_CD     = JOO.TRD_CD
              AND  COA.RLANE_CD   = JOO.RLANE_CD
              )
       GROUP  BY
              NVL(JOO.REV_YRMON, COA.REV_YRMON), NVL(JOO.JO_CRR_CD, COA.JO_CRR_CD),
              NVL(JOO.VSL_CD, COA.VSL_CD), NVL(JOO.SKD_VOY_NO, COA.SKD_VOY_NO), NVL(JOO.SKD_DIR_CD, COA.SKD_DIR_CD), NVL(JOO.REV_DIR_CD, COA.REV_DIR_CD),
              NVL(JOO.TRD_CD, COA.TRD_CD), NVL(JOO.RLANE_CD, COA.RLANE_CD)
       ) B
WHERE  A.VSL_CD     = B.VSL_CD    (+) 
AND    A.SKD_VOY_NO = B.SKD_VOY_NO(+) 
AND    A.SKD_DIR_CD = B.SKD_DIR_CD(+) 
AND    A.REV_DIR_CD = B.REV_DIR_CD(+) 
AND    A.RLANE_CD   = B.RLANE_CD  (+) 
ORDER  BY 4			]]></sql>
			<params>
				<param name="acct_yrmon_fr" type="12" value="200909" out="N"/>
				<param name="acct_yrmon_to" type="12" value="200909" out="N"/>
				<param name="trd_cd" type="12" value="AES" out="N"/>
				<param name="rlane_cd" type="12" value="AEXAE" out="N"/>
				<param name="ofc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
