<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="InvoiceIssueDBDAOCHNReissuedInvoiceListVORSQL">
			<desc><![CDATA[   ]]></desc>
			<sql><![CDATA[
SELECT	A.INV_NO
        ,A.BKG_NO
        ,A.ACT_CUST_CNT_CD
        ,A.VVD
        ,A.IO_BND_CD
        ,A.POR_CD
        ,A.POL_CD
        ,A.POD_CD
        ,A.DEL_CD
        ,A.SAIL_ARR_DT
        ,A.ISS_DT
		,A.AR_OFC_CD
        ,A.INV_XCH_RT
        ,A.CURR_CD
		,A.INV_TTL_LOCL_AMT
FROM	(		
		SELECT  C.INV_NO
		        ,A.BKG_NO
		        ,A.ACT_CUST_CNT_CD||LPAD(ACT_CUST_SEQ,6,'0') ACT_CUST_CNT_CD
		        ,A.VSL_CD||SKD_VOY_NO||SKD_DIR_CD VVD
		        ,DECODE(A.IO_BND_CD,'I','I/B','O/B') IO_BND_CD
		        ,A.POR_CD
		        ,A.POL_CD
		        ,A.POD_CD
		        ,A.DEL_CD
		        ,A.SAIL_ARR_DT
		        ,D.ISS_DT
				,A.AR_OFC_CD
		        ,B.INV_XCH_RT		        
				#if (${cur_cd} == 'USD') 
					,@[cur_cd] CURR_CD
					,SUM(DECODE(B.CURR_CD,'USD',B.CHG_AMT,'CNY',DECODE(A.USD_XCH_RT,0,0,B.CHG_AMT/A.USD_XCH_RT),DECODE(A.USD_XCH_RT,0,0,(B.CHG_AMT*INV_XCH_RT)/A.USD_XCH_RT))) INV_TTL_LOCL_AMT
				#elseif (${cur_cd} == 'CNY') 
					,@[cur_cd] CURR_CD
					,SUM(DECODE(B.CURR_CD,'USD',B.CHG_AMT*A.USD_XCH_RT,'CNY',B.CHG_AMT,B.CHG_AMT*INV_XCH_RT)) INV_TTL_LOCL_AMT
				#else 
					,DECODE(B.CURR_CD,'USD','USD','CNY') CURR_CD
					,SUM(DECODE(B.CURR_CD,'USD',B.CHG_AMT,'CNY',DECODE(A.USD_XCH_RT,0,0,B.CHG_AMT/A.USD_XCH_RT),DECODE(A.USD_XCH_RT,0,0,(B.CHG_AMT*INV_XCH_RT)/A.USD_XCH_RT))) INV_TTL_LOCL_AMT
				#end
		FROM    INV_AR_MN A, INV_AR_CHG B
		        ,INV_AR_ISS_DTL C, INV_AR_ISS D
		WHERE   A.AR_IF_NO = B.AR_IF_NO
		AND     B.AR_IF_NO = C.AR_IF_NO(+)
		AND     B.CHG_SEQ = C.CHG_SEQ(+)
		AND     C.INV_NO = D.INV_NO
		AND     D.INV_SEQ = (SELECT MAX(K.INV_SEQ) FROM INV_AR_ISS K
		                        WHERE   K.INV_NO = D.INV_NO)
		AND     NVL(A.INV_DELT_DIV_CD,'N') <> 'Y'
		AND     B.INV_ISS_FLG = 'Y'
		AND     A.BL_SRC_NO = @[bl_no]
		AND     A.AR_OFC_CD = @[ofc_cd]
		GROUP BY C.INV_NO
		        ,A.BKG_NO
		        ,A.ACT_CUST_CNT_CD||LPAD(ACT_CUST_SEQ,6,'0')
		        ,A.VSL_CD||SKD_VOY_NO||SKD_DIR_CD
		        ,DECODE(A.IO_BND_CD,'I','I/B','O/B') 
		        ,A.POR_CD
		        ,A.POL_CD
		        ,A.POD_CD
		        ,A.DEL_CD
		        ,A.SAIL_ARR_DT
		        ,D.ISS_DT
				,A.AR_OFC_CD
		        ,B.INV_XCH_RT
				#if (${cur_cd} != 'USD' and ${cur_cd} != 'CNY') 
		        ,B.CURR_CD
				#end
)A
ORDER BY A.INV_NO			]]></sql>
			<params>
				<param name="cur_cd" type="12" value="" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
				<param name="ofc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
