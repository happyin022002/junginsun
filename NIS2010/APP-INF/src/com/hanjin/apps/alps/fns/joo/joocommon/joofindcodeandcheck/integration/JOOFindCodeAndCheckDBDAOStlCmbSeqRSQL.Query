<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="JOOFindCodeAndCheckDBDAOStlCmbSeqRSQL">
			<desc><![CDATA[JOO_STL_CMB에서 ACCT_YRMON, JO_CRR_CD로 DISTINCT 한 STL_CMB_SEQ를 조회한다.]]></desc>
			<sql><![CDATA[
SELECT
 A.CODE
,A.NAME
/*
,(SELECT CASE WHEN COUNT(1) > 0 THEN 'Y'
              ELSE 
                  CASE WHEN TO_CHAR(CODE) || NAME = TO_CHAR(CODE) THEN 'Y'
                       ELSE 'N'
                       END
              END
  FROM AP_INV_HDR AP WHERE AP.CSR_NO = A.NAME AND AP.RQST_APRO_STEP_FLG = 'Y') AS APPROVAL
*/
FROM
(
SELECT
       A.STL_CMB_SEQ AS CODE,
       MAX(A.SLP_TP_CD||A.SLP_FUNC_CD||A.SLP_OFC_CD||TO_CHAR(TO_DATE(A.SLP_ISS_DT,'YYYYMMDD'),'RRMMDD')||A.SLP_SER_NO) AS NAME
FROM   JOO_STL_CMB A
WHERE  A.ACCT_YRMON  = REPLACE(@[super_cd2],'-','')
AND    A.JO_CRR_CD   = @[super_cd1]
AND    A.RVS_CMB_FLG  = 'N' 
AND    A.RJCT_CMB_FLG = 'N'
--CSR Creation시에는 combined된 data중 rlane에 Read 권한만 있는 자료는 나와서는 안된다.
--Write 권한이 있는 것만 나온다
AND    EXISTS (
         SELECT 1
         FROM   JOO_STL_CMB_DTL X,
                JOO_SETTLEMENT  Y,
                JOO_CRR_AUTH    Z
         WHERE  X.ACCT_YRMON  = A.ACCT_YRMON
         AND    X.JO_CRR_CD   = A.JO_CRR_CD
         AND    X.STL_CMB_SEQ = A.STL_CMB_SEQ
         AND    X.RE_DIVR_CD  = A.RE_DIVR_CD
         AND    X.ACCT_YRMON  = Y.ACCT_YRMON
         AND    X.STL_VVD_SEQ = Y.STL_VVD_SEQ
         AND    X.STL_SEQ     = Y.STL_SEQ
         AND    Y.JO_CRR_CD   = Z.JO_CRR_CD
         AND    Y.RLANE_CD    = Z.RLANE_CD
         AND    Z.AUTH_OFC_CD = @[ofc_cd]
         AND    Z.DELT_FLG    = 'N'
         AND    Z.JO_CRR_AUTH_CD = 'W'
         )
#if (${code} != '')
AND    A.RE_DIVR_CD  = @[code]
#end
GROUP  BY 
       STL_CMB_SEQ
) A			]]></sql>
			<params>
				<param name="super_cd2" type="12" value="2009-05" out="N"/>
				<param name="super_cd1" type="12" value="COS" out="N"/>
				<param name="ofc_cd" type="12" value="SELFAR" out="N"/>
				<param name="code" type="12" value="R" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
