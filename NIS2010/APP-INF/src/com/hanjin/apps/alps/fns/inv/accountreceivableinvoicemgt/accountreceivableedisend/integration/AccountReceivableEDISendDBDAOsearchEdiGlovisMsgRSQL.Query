<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="AccountReceivableEDISendDBDAOsearchEdiGlovisMsgRSQL">
			<desc><![CDATA[glovis 취소 전송 메세지 만들기]]></desc>
			<sql><![CDATA[
SELECT SEQNUM
, '$$$MSGSTART:E811                GLOVIS              FRTINV    '||'INV'||TO_CHAR(SYSDATE,'YYYYMMDDHH24MM')||TO_CHAR(TRUNC(DBMS_RANDOM.VALUE()*100000)) AS INTERNAL_HEADER
, 'FRTINV'||'E811                ' || 'GLOVIS'            AS HEADER
, '1.00'                        AS MSGVER
, MSGNUM                        AS MSGNUM
, INVYMD                        AS SNDDAT
, HDR_STR
||CHR(10)||'INVNUM:' || INVNUM
||CHR(10)||'MSGGUB:' || MSGGUB
||CHR(10)||'AIRSEA:' || AIRSEA
||CHR(10)||'INOUTC:' || INOUTC
||CHR(10)||'CSTCOD:' || CSTCOD
||CHR(10)||'CSTNAM:' || CSTNAM
||CHR(10)||'CSTTYP:' || CSTTYP
||CHR(10)||'REGNUM:' || REGNUM
||CHR(10)||'INVYMD:' || INVYMD
||CHR(10)||'SNDEML:' || SNDEML
||CHR(10)||'SNDNAM:' || SNDNAM
||CHR(10)||'SNDPHN:' || SNDPHN
||CHR(10)||'RCVEML:' || RCVEML
||CHR(10)||'RCVNAM:' || RCVNAM
||CHR(10)||
HDR_END                         AS HDR_MSG

, DTL_STR
||CHR(10)||'SEQNUM:' || SEQNUM     
||CHR(10)||'FBLNUM:' || FBLNUM     
||CHR(10)||'FRTCOD:' || FRTCOD     
||CHR(10)||'FRTNAM:' || FRTNAM     
||CHR(10)||'AGRCUR:' || AGRCUR     
||CHR(10)||'PKGUNT:' || PKGUNT     
||CHR(10)||'UNTPRC:' || UNTPRC     
||CHR(10)||'PKGCNT:' || PKGCNT     
||CHR(10)||'FRTAMT:' || FRTAMT     
||CHR(10)||'EXCRAT:' || EXCRAT     
||CHR(10)||'WONAMT:' || WONAMT     
||CHR(10)||'VATAMT:' || VATAMT     
||CHR(10)||'INVCUR:' || INVCUR     
||CHR(10)||'DETRMK:' || DETRMK     
||CHR(10)|| 
DTL_END AS DETAIL_MSG
FROM    (/*T01*/
SELECT  ROW_NUMBER() OVER(ORDER BY T2.CHG_SEQ)                                      AS SEQNUM
        , '{INV_HEADER'                                                             AS HDR_STR
        , '}INV_HEADER'                                                             AS HDR_END
        , T1.GLOVIS_EDI_MSG_NO                                                      AS MSGNUM
        , T1.INV_NO||DECODE(T1.INV_SEQ,0,'',T1.INV_SEQ)                             AS INVNUM
        , DECODE(@[cxl_flg], 'Y', 'D', 'A')                                         AS MSGGUB
        , 'S'                                                                       AS AIRSEA
        , T1.IO_BND_CD                                                              AS INOUTC
        , 'E811'                                                                    AS CSTCOD
        , T5.LOCL_NM                                                                AS CSTNAM
        , 'L'                                                                       AS CSTTYP
        , T6.CUST_RGST_NO                                                           AS REGNUM
        , TO_CHAR(SYSDATE, 'YYYYMMDD')                                              AS INVYMD
        , @[usr_eml]                                                                AS SNDEML
        , @[usr_id]                                                                 AS SNDNAM
        , 0                                                                         AS SNDPHN
        , @[cust_eml]                                                               AS RCVEML
        , @[cust_nm]                                                                AS RCVNAM
        , '{INV_DETAIL'                                                             AS DTL_STR
        , '}INV_DETAIL'                                                             AS DTL_END
        , 'SMLM'||BL_SRC_NO                                                         AS FBLNUM
        , NVL(T2.CHG_CD,
              (
              SELECT    CUST_CD_VAL_CTNT
              FROM      INV_EDI_INTG_CD_DTL
              WHERE     INTG_CD_ID      = 'CD00001'
              AND       HJS_CD_VAL_CTNT = 'XXX'
              )
          )                                                                         AS FRTCOD
        , NVL(T2.CHG_CD_DESC,
              (
              SELECT    CUST_CD_VAL_DESC
              FROM      INV_EDI_INTG_CD_DTL
              WHERE     INTG_CD_ID      = 'CD00001'
              AND       HJS_CD_VAL_CTNT = 'XXX'
              )
          )                                                                         AS FRTNAM
        , DECODE(T2.CURR_CD||T2.EUR_GUBUN, 'USDY', 'EUR', T2.CURR_CD)               AS AGRCUR
        , T2.PER_TP_CD                                                              AS PKGUNT
        , T2.TRF_RT_AMT                                                             AS UNTPRC
        , T2.RAT_AS_CNTR_QTY                                                        AS PKGCNT
        , DECODE(T2.CURR_CD||T2.EUR_GUBUN, 'USDY'
                  , ROUND((T2.CHG_AMT * T2.INV_XCH_RT) / T2.EURO_LOCL_XCH_RT, 2)
                  , T2.CHG_AMT                                        )             AS FRTAMT
        , DECODE(T2.CURR_CD||T2.EUR_GUBUN, 'USDY'
                  , T2.EURO_LOCL_XCH_RT
                  , T2.INV_XCH_RT                                     )             AS EXCRAT
        , DECODE(T2.CURR_CD||T2.EUR_GUBUN, 'USDY'
                  , ROUND(ROUND((T2.CHG_AMT * T2.INV_XCH_RT) / T2.EURO_LOCL_XCH_RT, 2) * T2.EURO_LOCL_XCH_RT, 0)
                  , ROUND(T2.CHG_AMT  * T2.INV_XCH_RT , 0)            )             AS WONAMT 
        , ''                                                                        AS VATAMT
        , DECODE(T2.CURR_CD, 'KRW', 'K', 'U')                                       AS INVCUR
        , ''                                                                        AS DETRMK
FROM    INV_EDI_GLOVIS_HDR  T1,
        MDM_CR_CUST         T5,
        MDM_CUSTOMER        T6,
        (SELECT   B.CUST_CD_VAL_CTNT AS CHG_CD
                , B.CUST_CD_VAL_DESC AS CHG_CD_DESC
                , C.CUST_CD_VAL_CTNT AS PER_TP_CD
                , A.TRF_RT_AMT, A.RAT_AS_CNTR_QTY, A.CHG_AMT
                , CASE WHEN (A.CURR_CD = 'USD' AND NVL(A.EURO_LOCL_XCH_RT, 0) > 0 ) THEN
                    'Y'                        -- EUR일 경우 EURO_LOCL_XCH_RT 값이 입력된다.
                  ELSE
                    'N'
                  END AS EUR_GUBUN             -- 2011.08.29
                , A.INV_XCH_RT
                , A.EURO_LOCL_XCH_RT           -- EUR일 경우 EURO_LOCL_XCH_RT 값이 입력된다.
                , A.AR_IF_NO, A.IF_SEQ, A.CURR_CD, A.CHG_SEQ
         FROM   INV_EDI_GLOVIS_CHG  A
              , INV_EDI_INTG_CD_DTL B
              , INV_EDI_INTG_CD_DTL C
         WHERE  A.CHG_CD           = B.HJS_CD_VAL_CTNT (+)
         AND    B.INTG_CD_ID (+)   = 'CD00001'
         AND    A.PER_TP_CD        = C.HJS_CD_VAL_CTNT
         AND    C.INTG_CD_ID       = 'CD00002'
         AND    A.AR_IF_NO         = @[ar_if_no]
         AND    A.IF_SEQ           = @[if_seq]
        )   T2      
WHERE   1=1
AND     T1.AR_IF_NO         = T2.AR_IF_NO   (+)
AND     T1.IF_SEQ           = T2.IF_SEQ     (+)
AND     T1.CUST_CNT_CD      = T5.CUST_CNT_CD(+)
AND     T1.CUST_SEQ         = T5.CUST_SEQ   (+)
AND     T1.CUST_CNT_CD      = T6.CUST_CNT_CD(+)
AND     T1.CUST_SEQ         = T6.CUST_SEQ   (+)
AND     T1.AR_IF_NO         = @[ar_if_no]
AND     T1.IF_SEQ           = @[if_seq]
) T01			]]></sql>
			<params>
				<param name="cxl_flg" type="12" value="" out="N"/>
				<param name="usr_eml" type="12" value="" out="N"/>
				<param name="usr_id" type="12" value="" out="N"/>
				<param name="cust_eml" type="12" value="" out="N"/>
				<param name="cust_nm" type="12" value="" out="N"/>
				<param name="ar_if_no" type="12" value="" out="N"/>
				<param name="if_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
