<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BookingARCreationDBDAOsearchDueDateByWeekCustPayDayRSQL">
			<desc><![CDATA[searchDueDateByWeekCustPayDay]]></desc>
			<sql><![CDATA[
SELECT CASE WHEN SUBSTR(DUE_DT1,7,2) = '31'  THEN 
	TO_CHAR(LAST_DAY(TO_DATE(SUBSTR(DUE_DT1,1,6),'YYYYMM')),'YYYYMMDD')
WHEN SUBSTR(DUE_DT1,5,2) = '02' AND TO_NUMBER(SUBSTR(DUE_DT1,7,2)) > 28 THEN
	TO_CHAR(LAST_DAY(TO_DATE(SUBSTR(DUE_DT1,1,6),'YYYYMM')),'YYYYMMDD')
ELSE
	DUE_DT1
END  DUE_DT
FROM(   
	SELECT CASE WHEN @[col_pay_1] IS NULL AND @[col_pay_2] IS NULL AND @[col_pay_3] IS NULL AND @[col_pay_4] IS NULL AND @[col_pay_5] IS NULL
                         THEN @[due_dt]
    WHEN TO_NUMBER(SUBSTRB( @[due_dt],-2)) > GREATEST(NVL(TO_NUMBER(@[col_pay_1]),0), NVL(TO_NUMBER(@[col_pay_2]),0), NVL(TO_NUMBER(@[col_pay_3]),0), NVL(TO_NUMBER(@[col_pay_4]),0), NVL(TO_NUMBER(@[col_pay_5]),0)) 
                         THEN TO_CHAR(NEXT_DAY(TO_DATE(@[due_dt],'YYYYMMDD'),TO_NUMBER(@[pay_wk_dy_cd])),'YYYYMMDD')
    ELSE SUBSTRB( @[due_dt],1,6)||TRIM(TO_CHAR(LEAST(NVL(TO_NUMBER(PAY_DT_DY1_NEW),99), NVL(TO_NUMBER(PAY_DT_DY2_NEW),99), NVL(TO_NUMBER(PAY_DT_DY3_NEW),99),NVL(TO_NUMBER(PAY_DT_DY4_NEW),99),NVL(TO_NUMBER(PAY_DT_DY5_NEW),99)),'09'))
	END DUE_DT1
	FROM (
	SELECT          
        SUBSTRB( @[due_dt],-2)
       ,@[col_pay_1]
       ,@[col_pay_2]
       ,@[col_pay_3]
       ,@[col_pay_4] 
       ,@[col_pay_5]
       ,CASE WHEN NVL(TO_NUMBER(@[col_pay_1]),0) >= TO_NUMBER(SUBSTRB(@[due_dt],-2)) THEN NVL(TO_NUMBER(@[col_pay_1]),0) END PAY_DT_DY1_NEW   
       ,CASE WHEN NVL(TO_NUMBER(@[col_pay_2]),0) >= TO_NUMBER(SUBSTRB(@[due_dt],-2)) THEN NVL(TO_NUMBER(@[col_pay_2]),0) END PAY_DT_DY2_NEW
       ,CASE WHEN NVL(TO_NUMBER(@[col_pay_3]),0) >= TO_NUMBER(SUBSTRB(@[due_dt],-2)) THEN NVL(TO_NUMBER(@[col_pay_3]),0) END PAY_DT_DY3_NEW
       ,CASE WHEN NVL(TO_NUMBER(@[col_pay_4]),0) >= TO_NUMBER(SUBSTRB(@[due_dt],-2)) THEN NVL(TO_NUMBER(@[col_pay_4]),0) END PAY_DT_DY4_NEW
	   ,CASE WHEN NVL(TO_NUMBER(@[col_pay_5]),0) >= TO_NUMBER(SUBSTRB(@[due_dt],-2)) THEN NVL(TO_NUMBER(@[col_pay_5]),0) END PAY_DT_DY5_NEW 
	FROM MDM_CR_CUST
	WHERE PAY_TP_CD ='W' 
    AND CUST_CNT_CD  = @[cust_cnt_cd]
	AND CUST_SEQ = CASE WHEN REGEXP_INSTR(@[cust_seq], '[[:alpha:]]', 1, 1) = 0 THEN
                         TO_NUMBER(@[cust_seq])
                    ELSE
                         -999999 
                    END
	AND  NVL(SUB_SYS_NM,'MDM') <> 'ERP' ))			]]></sql>
			<params>
				<param name="col_pay_1" type="12" value="" out="N"/>
				<param name="col_pay_2" type="12" value="" out="N"/>
				<param name="col_pay_3" type="12" value="" out="N"/>
				<param name="col_pay_4" type="12" value="" out="N"/>
				<param name="col_pay_5" type="12" value="" out="N"/>
				<param name="due_dt" type="12" value="" out="N"/>
				<param name="pay_wk_dy_cd" type="12" value="" out="N"/>
				<param name="cust_cnt_cd" type="12" value="" out="N"/>
				<param name="cust_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
