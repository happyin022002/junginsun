<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BookingARCreationDBDAOSearchWhfDiffCheckRSQL">
			<desc><![CDATA[BKG과 INV간 WHF 금액 Diff Check
]]></desc>
			<sql><![CDATA[
WITH INV_WHF AS (
                SELECT MN.BL_SRC_NO, MN.AR_OFC_CD, MN.IO_BND_CD, CHG.CURR_CD, CHG.CHG_CD, SUM(CHG.CHG_AMT) CHG_AMT, MAX(MN.WHF_DECL_NO) WHF_DECL_NO
                FROM   INV_AR_MN MN,
                       INV_AR_CHG CHG
                WHERE  MN.AR_IF_NO = CHG.AR_IF_NO
                AND    MN.BL_SRC_NO = @[bkg_no]
                AND    MN.INV_DELT_DIV_CD <> 'Y'
                AND    MN.REV_TP_CD <> 'M'
                AND    CHG.CHG_CD = 'WHF'
                GROUP BY MN.BL_SRC_NO, MN.AR_OFC_CD, MN.IO_BND_CD, CHG.CURR_CD, CHG.CHG_CD
            )
SELECT  DECODE(SUM(WHF_DIFF), 0, 'N', 'Y') WHF_DIFF_CHK
FROM    (
            SELECT 
                   INV.BL_SRC_NO,
                   INV.AR_OFC_CD,
                   INV.IO_BND_CD,
                   INV.CURR_CD,
                   INV.CHG_CD,
                   INV.CHG_AMT,
                   INV.WHF_DECL_NO,
                   
                   CASE WHEN LENGTH(INV.WHF_DECL_NO) > 0 THEN
                        NVL(((SELECT SUM(CHG_AMT) FROM INV_WHF WHERE WHF_DECL_NO IS NOT NULL)-KR_WHF.NEW_CHG_AMT),0)
                   ELSE 
                        NVL((INV.CHG_AMT-BKG_WHF.CHG_AMT),0)
                   END WHF_DIFF
            FROM   INV_WHF INV,
                   (
                    SELECT  BL_NO,  SUM(NEW_CHG_AMT) NEW_CHG_AMT --,   MAX(WHF_DECL_NO) MAX_WHF_DECL_NO, WHF_BND_CD,
                    FROM    BKG_KR_WHF_RT
                    WHERE   BL_NO = @[bkg_no]
                    AND     WHF_DECL_NO IS NOT NULL
                    GROUP BY BL_NO--, WHF_BND_CD
                   ) KR_WHF,
                   (
                    SELECT  BKG_NO, FRT_TERM_CD, CHG_CD, CURR_CD, SUM(CHG_AMT) CHG_AMT
                    FROM    BKG_CHG_RT
                    WHERE   BKG_NO = @[bkg_no]
                    AND     CHG_CD = 'WHF'
                    GROUP BY BKG_NO, FRT_TERM_CD, CHG_CD, CURR_CD
                   ) BKG_WHF
            WHERE  INV.BL_SRC_NO = KR_WHF.BL_NO(+)
            AND    INV.BL_SRC_NO = BKG_WHF.BKG_NO(+)
            AND    INV.CHG_AMT <> 0
       )			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
