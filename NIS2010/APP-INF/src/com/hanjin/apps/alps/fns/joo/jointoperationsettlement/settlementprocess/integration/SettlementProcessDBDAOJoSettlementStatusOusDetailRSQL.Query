<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="SettlementProcessDBDAOJoSettlementStatusOusDetailRSQL">
			<desc><![CDATA[Jo 미정산 현황 - OUS/RF/OTHER(Detail)]]></desc>
			<sql><![CDATA[
WITH OUS_TGT AS (
    SELECT 
           J.REV_YRMON
          ,J.REV_YRMON_SEQ
          ,J.TRD_CD
          ,J.RLANE_CD
          ,A4.CRR_CD
          ,J.RE_DIVR_CD
          ,J.VSL_CD
          ,J.SKD_VOY_NO
          ,J.SKD_DIR_CD
          ,J.VPS_PORT_CD
          ,J.YD_CD
          ,J.CLPT_IND_SEQ
	      ,TO_CHAR(J.VPS_ETD_DT,'YYYYMMDDHH24MISS') AS VPS_ETD_DT           
          ,DECODE(L.LEV,'1','OUS','2','R/F','3','OTH') AS JO_STL_ITM_CD   
          ,MIN(J.VSL_CD || J.SKD_VOY_NO || J.SKD_DIR_CD || TO_CHAR(J.VPS_ETD_DT,'YYYYMMDDHH24MI')) OVER (PARTITION BY J.VSL_CD || J.SKD_VOY_NO || J.SKD_DIR_CD) AS VVD_ETD_GROUP	
    FROM (
            SELECT LEVEL AS LEV
            FROM DUAL CONNECT BY LEVEL <= 3
         ) L
         ,JOO_LODG_TGT J
         ,BSA_VVD_CRR_PERF A4             
    WHERE 1=1
    AND J.STL_TGT_FLG = '1'
    AND J.STL_CLZ_FLG = '0'
	AND (J.REV_YRMON >= '201510' AND J.REV_YRMON <= REPLACE(@[rev_yrmon],'-',''))
    AND J.VSL_CD     = A4.VSL_CD(+) 
    AND J.SKD_VOY_NO = A4.SKD_VOY_NO(+) 
    AND J.SKD_DIR_CD = A4.SKD_DIR_CD(+) 
    AND J.TRD_CD     = A4.TRD_CD(+) 
    AND J.RLANE_CD   = A4.RLANE_CD(+) 
	#if (${re_divr_cd} == 'R')
    AND J.CRR_CD     = A4.CRR_CD(+)
	AND A4.BSA_OP_JB_CD IN ('001','002','004')
	#else
	AND A4.BSA_OP_JB_CD IN ('000','003','005')
    #end
    AND A4.CRR_CD(+)  != 'SML' 
    AND A4.CRR_BSA_CAPA > 0   
	#if (${trd_cd}!= '')
		   AND   J.TRD_CD        =  @[trd_cd]  
	#end
	#if (${rlane_cd}!= '')
		   AND   J.RLANE_CD      =  @[rlane_cd]  
	#end
	#if (${jo_crr_cd}!= '')
		   AND   J.CRR_CD     	 =  @[jo_crr_cd]  
	#end
	#if (${re_divr_cd}!= '')
		   AND   J.RE_DIVR_CD    =  @[re_divr_cd]  
	#end
	#if (${skd_dir_cd}!= '')
		   AND   J.SKD_DIR_CD    =  @[skd_dir_cd]  
	#end
	#if (${vvd_cd}!= '')
		   AND   J.VSL_CD||J.SKD_VOY_NO||J.SKD_DIR_CD like @[vvd_cd]||'%'
	#end	
)
, OUS_TGT2 AS (
    SELECT  T.TRD_CD
           ,T.RLANE_CD
           ,T.CRR_CD
           ,T.RE_DIVR_CD
           ,T.VSL_CD
           ,T.SKD_VOY_NO
           ,T.SKD_DIR_CD
           ,T.VPS_PORT_CD AS PORT
           ,SUBSTR(T.YD_CD,6,2) AS TML
           ,T.CLPT_IND_SEQ AS IND
           ,T.JO_STL_ITM_CD
           ,DECODE(NVL(S.STL_TGT_FLG,'0') + NVL(S.STL_CLZ_FLG,'0'),1,1,2,1,0) AS TGT_FLG
           ,T.VVD_ETD_GROUP 
           ,T.VPS_ETD_DT
           ,S.REV_YRMON
           ,S.REV_YRMON_SEQ
    FROM OUS_TGT T, JOO_STL_TGT S
    WHERE 1=1
    AND T.REV_YRMON = S.REV_YRMON(+)
    AND T.REV_YRMON_SEQ = S.REV_YRMON_SEQ(+)
    AND T.JO_STL_ITM_CD = S.JO_STL_ITM_CD(+)
), OUS_TGT3 AS (
SELECT 
            MAX(T.REV_YRMON) AS REV_YRMON
           ,T.TRD_CD
           ,T.RLANE_CD
           ,T.CRR_CD
           ,T.RE_DIVR_CD
           ,T.VSL_CD        AS VSL
           ,T.SKD_VOY_NO    AS VOY
           ,T.SKD_DIR_CD    AS DIR
           ,T.PORT
           ,T.TML
           ,T.IND
           ,T.VVD_ETD_GROUP 
           ,T.VPS_ETD_DT
           ,T.VSL_CD || T.SKD_VOY_NO || T.SKD_DIR_CD AS VVD
           ,MAX(DECODE(T.JO_STL_ITM_CD,'OUS',T.TGT_FLG,0)) AS OUS
           ,MAX(DECODE(T.JO_STL_ITM_CD,'R/F',T.TGT_FLG,0)) AS RF
           ,MAX(DECODE(T.JO_STL_ITM_CD,'OTH',T.TGT_FLG,0)) AS OTHER
           ,MAX(T.REV_YRMON_SEQ) AS REV_YRMON_SEQ
FROM OUS_TGT2 T
GROUP BY 
            T.TRD_CD
           ,T.RLANE_CD
           ,T.CRR_CD
           ,T.RE_DIVR_CD
           ,T.VSL_CD
           ,T.SKD_VOY_NO
           ,T.SKD_DIR_CD
           ,T.PORT
           ,T.TML
           ,T.IND
           ,T.VVD_ETD_GROUP 
           ,T.VPS_ETD_DT
)
SELECT
  AA.SEQ_NO AS SEQ
 ,AA.REV_YRMON
 ,AA.TRD_CD 		
 ,AA.RLANE_CD
 ,AA.CRR_CD
 ,AA.RE_DIVR_CD
 ,AA.VSL  			
 ,AA.VOY  			
 ,AA.DIR 			
 ,AA.PORT 			
 ,AA.TML 			
 ,AA.IND 			
 ,'' AS RMK_TP 		
 ,( 
    SELECT  
     MAX(DECODE(J.JO_STL_ITM_CD,'OUS',STL_RMK ,'')) || ' ' || 
     MAX(DECODE(J.JO_STL_ITM_CD,'R/F',STL_RMK ,'')) || ' ' || 
     MAX(DECODE(J.JO_STL_ITM_CD,'OTH',STL_RMK ,'')) AS STL_RMK 
    FROM JOO_STL_TGT J
    WHERE 1=1
    AND J.REV_YRMON_SEQ = AA.REV_YRMON_SEQ
    AND (J.STL_TGT_FLG = 0 AND STL_CLZ_FLG = 0)
  ) AS RMK 	
,(  SELECT J.STL_PIC_NM FROM JOO_STL_PIC J
    WHERE J.TRD_CD = AA.TRD_CD
	AND J.CRR_CD = AA.CRR_CD
	AND J.RLANE_CD = AA.RLANE_CD
	AND J.RE_DIVR_CD = AA.RE_DIVR_CD
 ) PIC 
 ,DECODE(AA.OUS,'1','X','0','O') AS OUS
 ,DECODE(AA.RF,'1','X','0','O') AS RF 			
 ,DECODE(AA.OTHER,'1','X','0','O') AS OTHER 
FROM
(
    SELECT
      ROWNUM AS SEQ_NO
     ,A.*
    FROM
    (
        SELECT *
        FROM OUS_TGT3       
        WHERE 1=1
        AND OUS * RF * OTHER = 0
        ORDER BY SUBSTR(VVD_ETD_GROUP, 10), VVD, VPS_ETD_DT
    ) A    
) AA
#if (${page_no} != '')
WHERE SEQ_NO BETWEEN 1 + ((@[page_no]-1)*@[pagerows]) AND (@[page_no]*@[pagerows])
#end			]]></sql>
			<params>
				<param name="rev_yrmon" type="12" value="" out="N"/>
				<param name="trd_cd" type="12" value="" out="N"/>
				<param name="rlane_cd" type="12" value="" out="N"/>
				<param name="jo_crr_cd" type="12" value="" out="N"/>
				<param name="re_divr_cd" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="vvd_cd" type="12" value="" out="N"/>
				<param name="page_no" type="12" value="" out="N"/>
				<param name="pagerows" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
