<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="JointOperationConsultationDBDAOCsrListRSQL">
			<desc><![CDATA[JOO_CSR List 조회 (APRO_FLG =' N' 인것만)]]></desc>
			<sql><![CDATA[
SELECT
       A.SLP_TP_CD||A.SLP_FUNC_CD||A.SLP_OFC_CD||TO_CHAR(TO_DATE(A.SLP_ISS_DT,'YYYYMMDD'),'RRMMDD')||A.SLP_SER_NO AS CSR_NO,
       A.SLP_ISS_DT,
	   TO_CHAR(A.EFF_DT,'YYYYMMDD') AS EFF_DT,
       A.CSR_LOCL_CURR_CD,
       A.CSR_LOCL_AMT,
       B.USR_NM AS ISSUER,
       A.CSR_DESC,
       C.LST_APRO_FLG
FROM   JOO_CSR           A,
       COM_USER          B,
       (
       SELECT
              A.APRO_RQST_NO,
              B.CSR_NO,
              A.APSTS_CD,
              NVL(C.APSTS_CD, 'P') AS P_APSTS_CD,
              --최종결재자여부
              CASE WHEN C.APRO_RQST_SEQ = (
                             SELECT /*+INDEX_DESC(X XPKCOM_APRO_RQST_ROUT)*/
                                    X.APRO_RQST_SEQ
                             FROM   COM_APRO_RQST_ROUT X
                             WHERE  X.APRO_RQST_NO = C.APRO_RQST_NO
                             AND    X.DELT_FLG     = 'N'
                             AND    ROWNUM = 1)
                   THEN 'Y' ELSE 'N'
              END AS LST_APRO_FLG
         FROM COM_APRO_RQST_HDR  A,
              COM_APRO_CSR_DTL   B,
              COM_APRO_RQST_ROUT C
        WHERE NVL(A.DELT_FLG, 'N') = 'N'
          AND NVL(B.DELT_FLG, 'N') = 'N'
          AND NVL(C.DELT_FLG, 'N') = 'N'
          AND A.SUB_SYS_CD         = 'JOO'
          AND NVL(A.APSTS_CD,'P')  = 'P'
          AND NVL(C.APSTS_CD,'P')  = 'P'
          AND A.APRO_RQST_NO  = B.APRO_RQST_NO
          AND A.APRO_RQST_NO  = C.APRO_RQST_NO
          AND A.CRNT_APRO_SEQ = C.APRO_RQST_SEQ
          AND C.APRO_USR_ID   = @[cre_usr_id]
        ) C
WHERE  A.CRE_USR_ID  = B.USR_ID(+)
AND    A.SLP_TP_CD||A.SLP_FUNC_CD||A.SLP_OFC_CD||TO_CHAR(TO_DATE(A.SLP_ISS_DT,'YYYYMMDD'),'RRMMDD')||A.SLP_SER_NO = C.CSR_NO
AND    A.APRO_FLG    = 'N'
AND    A.CXL_FLG     = 'N'
AND    EXISTS (
        SELECT 1
        FROM   JOO_SLIP        X,
               JOO_SETTLEMENT  Z,
               JOO_CRR_AUTH    Y
        WHERE  X.ACCT_YRMON  = Z.ACCT_YRMON
        AND    X.STL_VVD_SEQ = Z.STL_VVD_SEQ
        AND    X.STL_SEQ     = Z.STL_SEQ
        AND    X.DR_CR_CD    = 'DR'
        AND    Z.JO_CRR_CD   = Y.JO_CRR_CD
        AND    Z.RLANE_CD    = Y.RLANE_CD
        AND    X.SLP_TP_CD   = A.SLP_TP_CD
        AND    X.SLP_FUNC_CD = A.SLP_FUNC_CD
        AND    X.SLP_OFC_CD  = A.SLP_OFC_CD
        AND    X.SLP_ISS_DT  = A.SLP_ISS_DT
        AND    X.SLP_SER_NO  = A.SLP_SER_NO
        --201407 민정호 10만불 때문에 조회조건 삭제
        --AND    Y.AUTH_OFC_CD = slp_ofc_cd
        AND    Y.JO_CRR_AUTH_CD IN ('W','R')
        AND    Y.DELT_FLG    = 'N'
       )

#if (${csr_no} == '')
	#if (${if_flg} == '0')
AND    A.SLP_ISS_DT  <= REPLACE(@[slp_iss_dt],'-','')
	#else
AND    A.EFF_DT  <= TO_DATE(REPLACE(@[slp_iss_dt],'-',''),'YYYYMMDD')
	#end
#else
AND    A.SLP_TP_CD   = SUBSTR(@[csr_no], 1,2)
AND    A.SLP_FUNC_CD = SUBSTR(@[csr_no], 3,1)
AND    A.SLP_OFC_CD  = DECODE(LENGTH(@[csr_no]),20,SUBSTR(@[csr_no],4,6),SUBSTR(@[csr_no],4,5))
AND    A.SLP_ISS_DT  = TO_CHAR(TO_DATE(DECODE(LENGTH(@[csr_no]),20,SUBSTR(@[csr_no],10,6),SUBSTR(@[csr_no],9,6)),'RRMMDD'),'YYYYMMDD')
AND    A.SLP_SER_NO  = DECODE(LENGTH(@[csr_no]),20,SUBSTR(@[csr_no],16),SUBSTR(@[csr_no],15))
#end
ORDER  BY 1			]]></sql>
			<params>
				<param name="cre_usr_id" type="12" value="dev056" out="N"/>
				<param name="slp_iss_dt" type="12" value="20100129" out="N"/>
				<param name="csr_no" type="12" value="06SSELFAR10012900001" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
