<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TonnageTaxStandardProfitConclusionDBDAOTaxableAmountIFStatusVORSQL">
			<desc><![CDATA[Taxable Amount I/F Status popup 조회]]></desc>
			<sql><![CDATA[
SELECT TRD_CD
      ,TONG_ITM_CD
      ,CFM_FLG
      ,CFM_USR_ID
      ,N1ST_CFM_DT
      ,CFM_DT
FROM (      
        SELECT X.TRD_CD
              ,X.TRD_NUM
              ,X.CODE             TONG_ITM_CD
              ,NVL(Y.CFM_FLG,'N') CFM_FLG
              ,Y.CFM_USR_ID
              ,Y.N1ST_CFM_DT
              ,Y.CFM_DT
              ,X.SEQ
        FROM   (
                SELECT *
                FROM   (
                        SELECT 1 AS SEQ, 'NRT' CODE
                        FROM    DUAL
                        UNION
                        SELECT 3 AS SEQ, 'USE' CODE
                        FROM    DUAL
                        UNION
                        SELECT 2 AS SEQ, 'DYS' CODE
                        FROM    DUAL
                ) A, 
                (
                  SELECT TRD_CD, ROWNUM TRD_NUM 
                  FROM ( 
                        SELECT DISTINCT(TRD_CD) TRD_CD
                        FROM TOT_PORT_STL_AMT
                        WHERE STL_YRMON = @[stl_yrmon]
                          AND TONG_STL_BAT_JB_SEQ = (SELECT MAX(TONG_STL_BAT_JB_SEQ) FROM TOT_PORT_STL_AMT WHERE STL_YRMON = @[stl_yrmon])
                        ORDER BY TRD_CD  
                        )                    
                ) B
        ) X,
        (SELECT A.TRD_CD
              ,A.TONG_ITM_CD
              ,A.CFM_USR_ID
              ,A.CFM_FLG
              ,A.CFM_DT
              , DECODE(B.N1ST_CFM_DT, NULL, A.N1ST_CFM_DT,B.N1ST_CFM_DT)  N1ST_CFM_DT
        FROM   
                    (SELECT  TRD_CD
                        ,   TONG_ITM_CD
                        ,   CFM_USR_ID
                        ,   CFM_FLG
                        ,   CFM_DT
                        ,   N1ST_CFM_DT
                    FROM TOT_STL_CFM 
                    WHERE TONG_STL_BAT_JB_SEQ = (SELECT MAX(TONG_STL_BAT_JB_SEQ) FROM TOT_PORT_STL_AMT WHERE STL_YRMON = @[stl_yrmon])
                      AND STL_YRMON = @[stl_yrmon]
                    ) A,
                    
                     (SELECT TRD_CD
                        ,   TONG_ITM_CD
                        ,   CFM_USR_ID
                        ,   CFM_FLG
                        ,   N1ST_CFM_DT
                    FROM TOT_STL_CFM
                    WHERE TONG_STL_BAT_JB_SEQ = (SELECT MIN(TONG_STL_BAT_JB_SEQ) FROM TOT_PORT_STL_AMT WHERE STL_YRMON = @[stl_yrmon])
                      AND STL_YRMON = @[stl_yrmon]
                    ) B 
        WHERE A.TRD_CD = B.TRD_CD (+)
          AND A.TONG_ITM_CD = B.TONG_ITM_CD (+)
         ) Y 
        WHERE X.CODE = Y.TONG_ITM_CD(+)
        AND   X.TRD_CD = Y.TRD_CD(+)
        
        
        UNION ALL
        
        SELECT TRD_CD
              , 99 TRD_NUM
              ,TONG_ITM_CD
              ,CFM_FLG
              ,CFM_USR_ID
              ,MIN(N1ST_CFM_DT)  N1ST_CFM_DT
              ,MAX(CFM_DT)       CFM_DT
              , 1  SEQ
        FROM (
              SELECT 'ERP I/F'     TRD_CD
                    ,''            TONG_ITM_CD   
                    ,'Y'           CFM_FLG
                    ,CRE_USR_ID    CFM_USR_ID
                    ,CRE_DT        N1ST_CFM_DT
                    ,CRE_DT        CFM_DT
              FROM TOT_ERP_IF
              WHERE STL_YRMON = @[stl_yrmon]
                AND 0 < (SELECT COUNT(*) FROM TOT_ERP_IF WHERE STL_YRMON =@[stl_yrmon])
              )  
        GROUP BY  TRD_CD, TONG_ITM_CD, CFM_FLG, CFM_USR_ID
          
        UNION ALL
        SELECT 'ERP I/F'     TRD_CD
              , 99 TRD_NUM
              ,''            TONG_ITM_CD   
              ,'N'           CFM_FLG
              ,''            CFM_USR_ID
              ,NULL            N1ST_CFM_DT
              ,NULL          CFM_DT
              , 1  SEQ
        FROM DUAL
        WHERE 0 = (SELECT COUNT(*) FROM TOT_ERP_IF WHERE STL_YRMON = @[stl_yrmon])
)
ORDER BY TRD_NUM, SEQ ASC			]]></sql>
			<params>
				<param name="stl_yrmon" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
