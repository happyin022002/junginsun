<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TonnageTaxStandardProfitConclusionDBDAONonFeederVvdCalculationVOCSQL">
			<desc><![CDATA[2012.01.27 이준범 [CHM-201113807-01]
제목 : ALPS 톤세 시스템 기능보완 - T/TAX Recalculation
내용 : 1) T/Tax Recalculated 옆에 Lane이 추가 되면 추가된 선박만 재배치 할 수 있게 처리
         2) T/Tax Recalculated 작업 후, 변경된 내역을 표시해주는 팝업창 또는 화면을 추가하여
           변경사항 확인할 수 있게 처리]]></desc>
			<sql><![CDATA[
INSERT INTO TOT_VVD_STL_AMT
(        
  STL_YRMON	                    
 ,TONG_STL_BAT_JB_SEQ	           
 ,VSL_CD	                       
 ,LDB_CAPA_QTY	            
 ,BSA_CAPA	                
 ,ACT_BSA_CAPA	            
 ,VSL_DZND_CAPA	            
 ,CHTR_BSA_CAPA	            
 ,USG_RT	                  
 ,FM_VVD_STL_DT	            
 ,TO_VVD_STL_DT	            
 ,NRT_WGT	                  
 ,PER_TON_REV               
 ,TONG_FLET_TP_CD           
 ,VOY_DYS                   
 ,TONG_TAX_AMT              
 ,NRT_TONG_TAX_AMT          
 ,CRE_DT                    
 ,CRE_USR_ID                
 ,UPD_DT                    
 ,UPD_USR_ID                
)
SELECT A.STL_YRMON
      ,NVL((SELECT /*+INDEX_DESC(X XPKTOT_VVD_STL_AMT)*/ X.TONG_STL_BAT_JB_SEQ  FROM TOT_VVD_STL_AMT X WHERE STL_YRMON = @[stl_yrmon]AND ROWNUM =1),1)
      ,A.VSL_CD
      ,MAX(A.LDB_CAPA_QTY)
      ,MAX(A.BSA_CAPA)
      ,SUM(A.ACT_BSA_CAPA)
      ,0 
      ,MAX(A.CHTR_BSA_CAPA)
      ,MAX(A.USG_RT)
      ,TO_DATE(DECODE(MAX(A.TRD_CD),'ZZZ',@[stl_yrmon]||'01','YYY',@[stl_yrmon]||'01',TO_CHAR(MIN(A.ETD_DT),'YYYYMMDD')), 'YYYYMMDD')
      ,TO_DATE(DECODE(MAX(A.TRD_CD),'ZZZ',TO_CHAR(TO_DATE(@[stl_yrmon]||'01','YYYYMMDD')+SUM(A.VOY_DYS)+1,'YYYYMMDD'),'YYY',TO_CHAR(TO_DATE(@[stl_yrmon]||'01','YYYYMMDD')+SUM(A.VOY_DYS)+1,'YYYYMMDD'),TO_CHAR(MAX(A.ETD_DT),'YYYYMMDD')), 'YYYYMMDD')
      ,MAX(A.NRT_WGT)
      ,MAX(A.PER_TON_REV)
      ,( SELECT MAX(TONG_FLET_TP_CD) FROM TOT_VESSEL WHERE STL_YR = @[stl_yrmon]AND VSL_CD = A.VSL_CD AND TONG_FLET_TP_CD NOT IN ('L','E'))
      ,SUM(A.VOY_DYS)
      ,SUM(TRUNC(A.TONG_TAX_AMT,0))
      ,0 NRT_TONG_TAX_AMT 
      ,SYSDATE      
      ,@[cre_usr_id]
      ,SYSDATE
      ,@[cre_usr_id]      
 FROM TOT_PORT_STL_AMT A
WHERE A.STL_YRMON = @[stl_yrmon]
  AND A.TONG_STL_BAT_JB_SEQ = (SELECT MAX(TONG_STL_BAT_JB_SEQ) FROM TOT_PORT_STL_AMT WHERE STL_YRMON= @[stl_yrmon])
  AND A.VSL_CD = @[vsl_cd]
GROUP BY A.STL_YRMON, A.VSL_CD			]]></sql>
			<params>
				<param name="stl_yrmon" type="12" value="" out="N"/>
				<param name="cre_usr_id" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
