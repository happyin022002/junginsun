<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="JointOperationConsultationDBDAOCsrVORSQL">
			<desc><![CDATA[   ]]></desc>
			<sql><![CDATA[
SELECT
       A.SLP_TP_CD||A.SLP_FUNC_CD||A.SLP_OFC_CD||TO_CHAR(TO_DATE(A.SLP_ISS_DT,'YYYYMMDD'),'RRMMDD')||A.SLP_SER_NO AS CSR_NO
      ,A.SLP_TP_CD
      ,A.SLP_FUNC_CD
      ,A.SLP_OFC_CD
      ,A.SLP_ISS_DT
      ,A.SLP_SER_NO
      ,A.VNDR_SEQ
      ,A.CUST_CNT_CD
      ,A.CUST_SEQ
      ,A.SLP_ISS_OFC_CD
      ,A.CSR_DESC
      ,A.CSR_LOCL_CURR_CD
      ,A.CSR_LOCL_AMT
      ,A.CSR_USD_AMT
      ,TO_CHAR(A.EFF_DT,'YYYYMMDD') AS EFF_DT
      ,A.EVID_TP_CD
      ,A.APRO_FLG
      ,TO_CHAR(A.APRO_DT,'YYYYMMDDHH24MISS') AS APRO_DT
      ,A.CXL_FLG
      ,A.CXL_DESC
      ,A.CSR_OFFST_NO
      ,A.DDCT_FLG
      ,A.DDCT_LOCL_AMT
      ,A.DDCT_DESC
      ,A.RQST_LOCL_AMT
      ,TO_CHAR(A.RQST_DT,'YYYYMMDD') AS RQST_DT
      ,A.CSR_TP_CD
      ,A.SLP_ISS_RGN_CD
      ,A.SLP_ISS_INTER_CO_CD
      ,A.RVS_CSR_FLG
      ,A.ORG_SLP_TP_CD
      ,A.ORG_SLP_FUNC_CD
      ,A.ORG_SLP_OFC_CD
      ,A.ORG_SLP_ISS_DT
      ,A.ORG_SLP_SER_NO
      ,D.ACCT_YRMON
      ,D.JO_CRR_CD
      ,D.STL_CMB_SEQ
      ,D.RE_DIVR_CD
      ,D.RVS_CMB_FLG
      ,TO_CHAR(A.CRE_DT,'YYYYMMDDHH24MISS') AS CRE_DT
      ,A.CRE_USR_ID
      ,TO_CHAR(A.UPD_DT,'YYYYMMDDHH24MISS') AS UPD_DT
      ,A.UPD_USR_ID
      ,B.USR_NM AS ISSUER
      ,C.INTG_CD_VAL_DP_DESC AS EVID_TP_NM
      ,CASE WHEN A.SLP_TP_CD = '06' THEN
              ''||LPAD(A.VNDR_SEQ,6,'0')
            WHEN A.SLP_TP_CD = '18' THEN
              A.CUST_CNT_CD||LPAD(A.CUST_SEQ,6,'0')
            ELSE ''
            END AS VNDR_CUST_SEQ
      ,CASE WHEN A.SLP_TP_CD = '06' THEN
              NVL((SELECT VNDR_LGL_ENG_NM FROM MDM_VENDOR   X WHERE X.VNDR_SEQ    = A.VNDR_SEQ),'')
            WHEN A.SLP_TP_CD = '18' THEN
              NVL((SELECT CUST_LGL_ENG_NM FROM MDM_CUSTOMER X WHERE X.CUST_CNT_CD = A.CUST_CNT_CD AND X.CUST_SEQ = A.CUST_SEQ),'')
            ELSE ''
            END AS LGL_ENG_NM
      ,NVL(E.CLZ_STS_CD,'C') AS CLZ_STS_CD
      ,A.RJCT_CSR_FLG
      ,D.RJCT_CMB_FLG
      ,'' AS RCV_ERR_RSN
      ,'' AS EFF_DT_FR
      ,'' AS EFF_DT_TO
      ,'' AS AUTH_OFC_CD
       -- 같은 CSR의 rlane별로 Read와 ,Write권한이 같이 있을 수 있나 있다는 가정하에 섞여있으면 Read가 우선하도록 하기 위해 Min를 썼다.
      ,NVL((
         SELECT MIN(Z.JO_CRR_AUTH_CD)
         FROM   JOO_STL_CMB_DTL X,
                JOO_SETTLEMENT  Y,
                JOO_CRR_AUTH    Z
         WHERE  X.ACCT_YRMON  = Y.ACCT_YRMON
         AND    X.STL_VVD_SEQ = Y.STL_VVD_SEQ
         AND    X.STL_SEQ     = Y.STL_SEQ
         AND    Y.JO_CRR_CD   = Z.JO_CRR_CD
         AND    Y.RLANE_CD    = Z.RLANE_CD
         AND    Z.DELT_FLG    = 'N'
         AND    Z.AUTH_OFC_CD = @[auth_ofc_cd]
         AND    X.ACCT_YRMON  = D.ACCT_YRMON
         AND    X.JO_CRR_CD   = D.JO_CRR_CD
         AND    X.STL_CMB_SEQ = D.STL_CMB_SEQ
         AND    X.RE_DIVR_CD  = D.RE_DIVR_CD),'R') AUTH_CD
       -- csr reject시 필요한 flag
      ,'' AS IF_FLG
      ,'' AS APRO_STEP -- REVERSE 결재선 지정시 필요함 
      ,X.LST_APRO_FLG -- 최종결재자여부
      ,X.APRO_RQST_NO
      ,X.APRO_RQST_SEQ
      ,(
           SELECT CASE WHEN
				    ROUND(NVL(A.CSR_LOCL_AMT/ DECODE(A.CSR_LOCL_CURR_CD,'USD',1, 
           									                                   (SELECT NVL(EX1.USD_LOCL_XCH_RT, 1) 
                                            								    FROM GL_MON_XCH_RT EX1
								                                                WHERE EX1.CURR_CD = A.CSR_LOCL_CURR_CD
                                 								                AND EX1.ACCT_XCH_RT_YRMON = TO_CHAR(SYSDATE,'YYYYMM')
							                                                    AND EX1.ACCT_XCH_RT_LVL = '1')
                               		               )
                ,0),2) > 100000 THEN 'Y'
                ELSE 'N'
                END
    	    FROM DUAL
    	) AS URG_PAY_YN
	   ,A.AGMT_DOC_NO
	   ,A.AGMT_DOC_DESC
       ,(SELECT COUNT(1) CNT FROM JOO_CSR_ATCH_FILE FL WHERE FL.CSR_NO = @[csr_no]) ATCH_FILE_CNT
       ,(SELECT COUNT(1) CNT FROM JOO_CSR_AGMT_DOC DC WHERE DC.CSR_NO = @[csr_no]) GW_CTRT_CNT
FROM   JOO_CSR  A,
       COM_USER B,
       COM_INTG_CD_DTL C,
       JOO_STL_CMB D,
       --EFF.DT 마감여부
         (
         SELECT CLZ_STS_CD, SLP_TP_CD, SLP_FUNC_CD, SLP_OFC_CD, SLP_ISS_DT, SLP_SER_NO
         FROM   (
		         SELECT '1' AS SEQ, A.SLP_TP_CD, A.SLP_FUNC_CD, A.SLP_OFC_CD, A.SLP_ISS_DT, A.SLP_SER_NO,
		                MAX(X.CLZ_STS_CD) CLZ_STS_CD
		         FROM   AP_PERIOD X,
		                JOO_CSR   A
		         WHERE  A.SLP_TP_CD     = SUBSTR(@[csr_no], 1,2)
                 AND    A.SLP_FUNC_CD   = SUBSTR(@[csr_no], 3,1)
                 AND    A.SLP_OFC_CD    = DECODE(LENGTH(@[csr_no]),20,SUBSTR(@[csr_no],4,6),SUBSTR(@[csr_no],4,5))
                 AND    A.SLP_ISS_DT    = TO_CHAR(TO_DATE(DECODE(LENGTH(@[csr_no]),20,SUBSTR(@[csr_no],10,6),SUBSTR(@[csr_no],9,6)),'RRMMDD'),'YYYYMMDD')
                 AND    A.SLP_SER_NO    = DECODE(LENGTH(@[csr_no]),20,SUBSTR(@[csr_no],16),SUBSTR(@[csr_no],15))
		         AND    X.SYS_DIV_CD   =  DECODE(X.AR_AP_DIV_CD,'R','18','19')
		         AND    X.EFF_YRMON    = TO_CHAR(A.EFF_DT,'YYYYMM')
		         AND    X.AR_AP_DIV_CD = 'R'
		         AND    X.OFC_CD = (SELECT X.AP_OFC_CD
						                    FROM   MDM_ORGANIZATION X
						                    WHERE  X.OFC_CD = A.SLP_OFC_CD)
                 GROUP  BY A.SLP_TP_CD, A.SLP_FUNC_CD, A.SLP_OFC_CD, A.SLP_ISS_DT, A.SLP_SER_NO
		         UNION  ALL
		         SELECT '2' AS SEQ, A.SLP_TP_CD, A.SLP_FUNC_CD, A.SLP_OFC_CD, A.SLP_ISS_DT, A.SLP_SER_NO,
		                MAX(X.CLZ_STS_CD) CLZ_STS_CD
		         FROM   AP_PERIOD X,
		                JOO_CSR   A
		         WHERE  A.SLP_TP_CD     = SUBSTR(@[csr_no], 1,2)
                 AND    A.SLP_FUNC_CD   = SUBSTR(@[csr_no], 3,1)
                 AND    A.SLP_OFC_CD    = DECODE(LENGTH(@[csr_no]),20,SUBSTR(@[csr_no],4,6),SUBSTR(@[csr_no],4,5))
                 AND    A.SLP_ISS_DT    = TO_CHAR(TO_DATE(DECODE(LENGTH(@[csr_no]),20,SUBSTR(@[csr_no],10,6),SUBSTR(@[csr_no],9,6)),'RRMMDD'),'YYYYMMDD')
                 AND    A.SLP_SER_NO    = DECODE(LENGTH(@[csr_no]),20,SUBSTR(@[csr_no],16),SUBSTR(@[csr_no],15))
		         AND    X.SYS_DIV_CD   = DECODE(X.AR_AP_DIV_CD,'R','18','19')
		         AND    X.EFF_YRMON    = TO_CHAR(A.EFF_DT,'YYYYMM')
		         AND    X.AR_AP_DIV_CD = 'R'
		         AND    X.OFC_CD = (SELECT X.AR_HD_QTR_OFC_CD
						                    FROM   MDM_ORGANIZATION X,
						                           MDM_ORGANIZATION Y
						                    WHERE  X.OFC_CD = Y.AP_OFC_CD
						                    AND    Y.OFC_CD = A.SLP_OFC_CD)
                 GROUP  BY A.SLP_TP_CD, A.SLP_FUNC_CD, A.SLP_OFC_CD, A.SLP_ISS_DT, A.SLP_SER_NO
		         ORDER  BY 1
                ) X
         WHERE  CLZ_STS_CD IS NOT NULL
         AND    ROWNUM = 1
         ) E,
       (
       SELECT
              A.APRO_RQST_NO,
              B.CSR_NO,
              C.APRO_RQST_SEQ,
              A.APSTS_CD,
              NVL(C.APSTS_CD, 'P') AS P_APSTS_CD,
              CASE WHEN C.APRO_RQST_SEQ = (
                             SELECT /*+INDEX_DESC(X XPKCOM_APRO_RQST_ROUT)*/
                                    X.APRO_RQST_SEQ
                             FROM   COM_APRO_RQST_ROUT X
                             WHERE  X.APRO_RQST_NO = C.APRO_RQST_NO
                             AND    X.DELT_FLG     = 'N'
                             AND    ROWNUM = 1)
                   THEN 'Y' ELSE 'N'
              END AS LST_APRO_FLG
         FROM COM_APRO_RQST_HDR  A,
              COM_APRO_CSR_DTL   B,
              COM_APRO_RQST_ROUT C
        WHERE NVL(A.DELT_FLG, 'N') = 'N'
          AND NVL(B.DELT_FLG, 'N') = 'N'
          AND NVL(C.DELT_FLG, 'N') = 'N'
          AND A.SUB_SYS_CD         = 'JOO'
          AND NVL(A.APSTS_CD,'P')  = 'P'
          AND NVL(C.APSTS_CD,'P')  = 'P'
          AND A.APRO_RQST_NO  = B.APRO_RQST_NO
          AND A.APRO_RQST_NO  = C.APRO_RQST_NO
          AND A.CRNT_APRO_SEQ = C.APRO_RQST_SEQ
          AND C.APRO_USR_ID   = @[cre_usr_id]
          AND B.CSR_NO        = @[csr_no]
        ) X
WHERE  A.CRE_USR_ID    = B.USR_ID(+)
AND    A.EVID_TP_CD    = C.INTG_CD_VAL_CTNT(+)
AND    C.INTG_CD_ID(+) = 'CD01745'
AND    A.SLP_TP_CD     = D.SLP_TP_CD
AND    A.SLP_FUNC_CD   = D.SLP_FUNC_CD
AND    A.SLP_OFC_CD    = D.SLP_OFC_CD
AND    A.SLP_ISS_DT    = D.SLP_ISS_DT
AND    A.SLP_SER_NO    = D.SLP_SER_NO
AND    A.SLP_TP_CD     = E.SLP_TP_CD  (+)
AND    A.SLP_FUNC_CD   = E.SLP_FUNC_CD(+)
AND    A.SLP_OFC_CD    = E.SLP_OFC_CD (+) 
AND    A.SLP_ISS_DT    = E.SLP_ISS_DT (+)
AND    A.SLP_SER_NO    = E.SLP_SER_NO (+)
AND    A.SLP_TP_CD||A.SLP_FUNC_CD||A.SLP_OFC_CD||TO_CHAR(TO_DATE(A.SLP_ISS_DT,'YYYYMMDD'),'RRMMDD')||A.SLP_SER_NO = X.CSR_NO
AND    A.SLP_TP_CD     = SUBSTR(@[csr_no], 1,2)
AND    A.SLP_FUNC_CD   = SUBSTR(@[csr_no], 3,1)
AND    A.SLP_OFC_CD    = DECODE(LENGTH(@[csr_no]),20,SUBSTR(@[csr_no],4,6),SUBSTR(@[csr_no],4,5))
AND    A.SLP_ISS_DT    = TO_CHAR(TO_DATE(DECODE(LENGTH(@[csr_no]),20,SUBSTR(@[csr_no],10,6),SUBSTR(@[csr_no],9,6)),'RRMMDD'),'YYYYMMDD')
AND    A.SLP_SER_NO    = DECODE(LENGTH(@[csr_no]),20,SUBSTR(@[csr_no],16),SUBSTR(@[csr_no],15))			]]></sql>
			<params>
				<param name="auth_ofc_cd" type="12" value="SELFAR" out="N"/>
				<param name="csr_no" type="12" value="06SSELFAR09101400001" out="N"/>
				<param name="cre_usr_id" type="12" value="dev056" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
