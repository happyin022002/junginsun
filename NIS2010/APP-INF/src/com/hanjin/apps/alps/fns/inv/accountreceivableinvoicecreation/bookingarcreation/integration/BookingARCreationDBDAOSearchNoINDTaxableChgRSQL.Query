<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BookingARCreationDBDAOSearchNoINDTaxableChgRSQL">
			<desc><![CDATA[Search No IND Taxable Chg]]></desc>
			<sql><![CDATA[
SELECT Q.AR_IF_NO
     , P.IDA_GST_DIV_CD IND_GST_TP_CD
     , (SELECT DP_PRCS_KNT FROM MDM_CURRENCY WHERE CURR_CD = P.LOCL_CURR_CD) DP_PRCS_KNT
     , P.USD_XCH_RT
FROM (SELECT BL_SRC_NO, IDA_ISS_TP_CD, IDA_GST_DIV_CD, USD_XCH_RT, LOCL_CURR_CD
      FROM INV_AR_MN
      WHERE AR_IF_NO = (SELECT MAX(A.AR_IF_NO)
                        FROM INV_AR_MN A,
                             INV_AR_ISS_DTL B
                        WHERE B.AR_IF_NO = A.AR_IF_NO
                        AND B.INV_NO = @[inv_no]
                        AND A.REV_TP_CD <> 'M')) P,
     INV_AR_MN Q,
     INV_AR_CHG R
WHERE P.BL_SRC_NO = Q.BL_SRC_NO
AND Q.AR_OFC_CD <> 'BOMSC'
AND Q.AR_IF_NO = R.AR_IF_NO
AND Q.INV_DELT_DIV_CD <> 'Y'
AND Q.REV_TP_CD <> 'M'
AND Q.IO_BND_CD = 'O'
AND R.CHG_CD IN ('CLN', 'CMF', 'DCH', 'DIH', 'DTH', 'ITR', 'MUC', 'NST')
AND (P.IDA_ISS_TP_CD IN ('P', 'T') OR (P.IDA_ISS_TP_CD IN ('C', 'D') AND Q.IDA_INV_NO IS NULL))
AND EXISTS (SELECT 'X'
            FROM (SELECT B.CURR_CD, SUM(B.CHG_AMT) TAXABLE_SUM, COUNT(DISTINCT B.CURR_CD) OVER() CURR_CNT
                  FROM INV_AR_MN A,
                       INV_AR_CHG B,
                       INV_AR_ISS_DTL C
                  WHERE A.AR_IF_NO = B.AR_IF_NO
                  AND B.AR_IF_NO = C.AR_IF_NO
                  AND B.CHG_SEQ = C.CHG_SEQ
                  AND C.INV_NO = @[inv_no]
                  AND A.REV_TP_CD <> 'M'
                  AND B.IDA_SAC_CD IS NOT NULL
				  AND (B.IDA_CGST_AMT + B.IDA_SGST_AMT + B.IDA_IGST_AMT + B.IDA_UGST_AMT) <> 0
                  GROUP BY B.CURR_CD) S,
                 (SELECT B.CURR_CD, SUM(DECODE(A.INV_DELT_DIV_CD, 'N', B.TRF_RT_AMT, B.TRF_RT_AMT * (-1))) GST_TRF_SUM, COUNT(DISTINCT B.CURR_CD) OVER() CURR_CNT
                  FROM INV_AR_MN A,
                       INV_AR_CHG B,
                       INV_AR_ISS_DTL C
                  WHERE A.AR_IF_NO = B.AR_IF_NO
                  AND B.AR_IF_NO = C.AR_IF_NO
                  AND B.CHG_SEQ = C.CHG_SEQ
                  AND C.INV_NO = @[inv_no]
                  AND A.REV_TP_CD <> 'M'
                  AND B.CHG_CD IN ('GST', 'STO')
                  GROUP BY B.CURR_CD) T
            WHERE (S.CURR_CD = T.CURR_CD AND S.TAXABLE_SUM <> T.GST_TRF_SUM)
			OR S.CURR_CNT <> T.CURR_CNT)			]]></sql>
			<params>
				<param name="inv_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
