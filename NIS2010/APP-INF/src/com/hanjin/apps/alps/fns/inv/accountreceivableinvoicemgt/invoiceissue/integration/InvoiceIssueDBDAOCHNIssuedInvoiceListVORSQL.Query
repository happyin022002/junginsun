<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="InvoiceIssueDBDAOCHNIssuedInvoiceListVORSQL">
			<desc><![CDATA[   ]]></desc>
			<sql><![CDATA[
SELECT	'' INV_NO
		,TB.BKG_NO
		,TB.FRT_USD
		,TB.EX_RATE
		,TB.EQV_USD
		,TB.CHG_USD
		,TB.TOT_USD
		,TB.AR_IF_NO
		,TB.BL_SRC_NO
		,TB.IO_BND_CD
		,TB.CURR_CD
FROM	(
	#if (${curr_cd} == 'USD') 
		SELECT  A.BKG_NO
                ,SUM(A.FRT_USD) FRT_USD
                ,A.EX_RATE
                ,SUM(A.EQV_USD) EQV_USD
                ,SUM(A.CHG_USD) CHG_USD
                ,SUM(A.EQV_USD+A.CHG_USD) TOT_USD
				,A.AR_IF_NO
				,A.BL_SRC_NO
				,A.IO_BND_CD
				,'USD' CURR_CD
        FROM    (
                SELECT  MAX(A.BKG_NO) BKG_NO
                        ,A.BL_SRC_NO, A.ACT_CUST_CNT_CD, A.ACT_CUST_SEQ, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.IO_BND_CD
                        ,SUM(DECODE(B.CURR_CD,'USD',B.CHG_AMT,0)) FRT_USD
                        ,1 EX_RATE
                        ,SUM(DECODE(B.CURR_CD,'USD',B.CHG_AMT,0)) EQV_USD
                        ,SUM(DECODE(B.CURR_CD,'USD',0,'CNY',DECODE(A.USD_XCH_RT,0,0,B.CHG_AMT/A.USD_XCH_RT),DECODE(A.USD_XCH_RT,0,0,(B.CHG_AMT*INV_XCH_RT)/A.USD_XCH_RT))) CHG_USD
						,MAX(B.AR_IF_NO) AR_IF_NO
                FROM    INV_AR_MN A, INV_AR_CHG B
                WHERE   A.AR_IF_NO = B.AR_IF_NO       
                AND     NVL(A.INV_DELT_DIV_CD,'N') <> 'Y'
                AND     A.BL_INV_CFM_DT IS NOT NULL
                AND     B.INV_ISS_FLG = 'N'
                AND     A.BL_SRC_NO = @[bl_no]
                AND     A.AR_OFC_CD = @[ofc_cd]
                AND     A.AR_IF_NO = (SELECT MAX(K.AR_IF_NO) FROM INV_AR_MN K WHERE K.BL_SRC_NO = A.BL_SRC_NO AND K.AR_OFC_CD = A.AR_OFC_CD)
                GROUP BY A.BL_SRC_NO,A.ACT_CUST_CNT_CD, A.ACT_CUST_SEQ, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.IO_BND_CD
        ) A          
		GROUP BY    A.BL_SRC_NO,A.BKG_NO, A.ACT_CUST_CNT_CD, A.ACT_CUST_SEQ, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.IO_BND_CD,A.EX_RATE,A.AR_IF_NO
	#elseif (${curr_cd} == 'CNY') 
		SELECT  A.BKG_NO
		        ,SUM(A.FRT_USD) FRT_USD
		        --,MAX(DECODE(A.EX_RATE, 1, 0,A.EX_RATE)) EX_RATE
				,MAX(A.EX_RATE) EX_RATE
		        ,SUM(A.EQV_USD) EQV_USD
		        ,SUM(A.CHG_USD) CHG_USD
		        ,SUM(A.EQV_USD+A.CHG_USD) TOT_USD
				,A.AR_IF_NO
				,A.BL_SRC_NO
				,A.IO_BND_CD
				,'CNY' CURR_CD
		FROM    (
		        SELECT  MAX(A.BKG_NO) BKG_NO
                        ,A.BL_SRC_NO, A.ACT_CUST_CNT_CD, A.ACT_CUST_SEQ, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.IO_BND_CD
		                ,SUM(DECODE(B.CURR_CD,'USD',B.CHG_AMT,0)) FRT_USD
		                ,MAX(A.USD_XCH_RT) EX_RATE
		                ,SUM(DECODE(B.CURR_CD,'USD',B.CHG_AMT*A.USD_XCH_RT,0)) EQV_USD
		                ,SUM(DECODE(B.CURR_CD,'USD',0,'CNY',B.CHG_AMT,B.CHG_AMT*INV_XCH_RT)) CHG_USD
						,MAX(B.AR_IF_NO) AR_IF_NO
		        FROM    INV_AR_MN A, INV_AR_CHG B
		        WHERE   A.AR_IF_NO = B.AR_IF_NO       
		        AND     NVL(A.INV_DELT_DIV_CD,'N') <> 'Y'
		        AND     A.BL_INV_CFM_DT IS NOT NULL
		        AND     B.INV_ISS_FLG = 'N'
		        AND     A.BL_SRC_NO = @[bl_no]
                AND     A.AR_OFC_CD = @[ofc_cd]
                AND     A.AR_IF_NO = (SELECT MAX(K.AR_IF_NO) FROM INV_AR_MN K WHERE K.BL_SRC_NO = A.BL_SRC_NO AND K.AR_OFC_CD = A.AR_OFC_CD)
		        GROUP BY A.BL_SRC_NO,A.ACT_CUST_CNT_CD, A.ACT_CUST_SEQ, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.IO_BND_CD
		) A          
		GROUP BY    A.BL_SRC_NO,A.BKG_NO, A.ACT_CUST_CNT_CD, A.ACT_CUST_SEQ, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.IO_BND_CD,A.EX_RATE,A.AR_IF_NO
	#else 
		SELECT  A.BKG_NO
		        ,DECODE(A.CURR_CD,'USD','1','2') CURR_GB
		        ,SUM(A.FRT_USD) FRT_USD
		        ,MIN(DECODE(A.CURR_CD,'USD',1,A.EX_RATE)) EX_RATE				
		        ,SUM(A.EQV_USD) EQV_USD
		        ,SUM(A.CHG_USD) CHG_USD
		        ,SUM(A.EQV_USD+A.CHG_USD) TOT_USD
				,A.AR_IF_NO
				,A.BL_SRC_NO
				,A.IO_BND_CD
				,DECODE(A.CURR_CD,'USD','USD','CNY') CURR_CD
		FROM    (
		        SELECT  MAX(A.BKG_NO) BKG_NO
                        ,A.BL_SRC_NO, A.ACT_CUST_CNT_CD, A.ACT_CUST_SEQ, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.IO_BND_CD
		                ,B.CURR_CD                                
		                ,SUM(DECODE(B.CURR_CD,'USD',B.CHG_AMT,0)) FRT_USD
		                ,DECODE(B.CURR_CD,'USD',1,A.USD_XCH_RT) EX_RATE
		                ,SUM(DECODE(B.CURR_CD,'USD',B.CHG_AMT,0)) EQV_USD
                        ,SUM(DECODE(B.CURR_CD,'USD',0,'CNY',DECODE(A.USD_XCH_RT,0,0,B.CHG_AMT/A.USD_XCH_RT),DECODE(A.USD_XCH_RT,0,0,(B.CHG_AMT*INV_XCH_RT)/A.USD_XCH_RT))) CHG_USD
						,MAX(B.AR_IF_NO) AR_IF_NO
		        FROM    INV_AR_MN A, INV_AR_CHG B
		        WHERE   A.AR_IF_NO = B.AR_IF_NO       
		        AND     NVL(A.INV_DELT_DIV_CD,'N') <> 'Y'
		        AND     A.BL_INV_CFM_DT IS NOT NULL
		        AND     B.INV_ISS_FLG = 'N'
		        AND     A.BL_SRC_NO = @[bl_no]
                AND     A.AR_OFC_CD = @[ofc_cd]
                AND     A.AR_IF_NO = (SELECT MAX(K.AR_IF_NO) FROM INV_AR_MN K WHERE K.BL_SRC_NO = A.BL_SRC_NO AND K.AR_OFC_CD = A.AR_OFC_CD)
                GROUP BY A.BL_SRC_NO,A.ACT_CUST_CNT_CD, A.ACT_CUST_SEQ, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.IO_BND_CD, B.CURR_CD,A.USD_XCH_RT
		) A          
        GROUP BY A.BL_SRC_NO,A.BKG_NO,A.ACT_CUST_CNT_CD, A.ACT_CUST_SEQ, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.IO_BND_CD, DECODE(A.CURR_CD,'USD','1','2'),DECODE(A.CURR_CD,'USD','USD','CNY'),A.AR_IF_NO
		ORDER BY DECODE(A.CURR_CD,'USD','1','2')
	#end
) TB			]]></sql>
			<params>
				<param name="bl_no" type="12" value="" out="N"/>
				<param name="ofc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
