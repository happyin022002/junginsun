<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TonnageTaxStandardProfitConclusionDBDAOTaxableAmountForCreationIFVORSQL">
			<desc><![CDATA[tot_erp_if로 연동하기 위해 추가할 데이터 조회]]></desc>
			<sql><![CDATA[
SELECT A.STL_YRMON                       STL_YRMON
      ,(SELECT NVL(MAX(BAT_JB_SEQ),0)+1 FROM TOT_ERP_IF WHERE SUBSTR(STL_YRMON, 1, 4) = SUBSTR(@[stl_yrmon], 1, 4))     BAT_JB_SEQ   
      ,A.VSL_CD
      ,A.VSL_ENG_NM   
      ,A.NRT_WGT
      ,A.USG_RT
      ,A.VOY_DYS
      ,A.TONG_TAX_AMT
      ,A.TONG_FLET_TP_CD
      ,A.PER_TON_REV
      ,A.CTRT_DYS
      ,A.VSL_RGST_CNT_CD
      ,A.VVD_RMK
      ,@[cre_usr_id]                     CRE_USR_ID
      ,@[cre_usr_id]                    UPD_USR_ID
      
FROM (
          SELECT   
          A.STL_YRMON  
          ,A.VSL_CD
          ,D.VSL_ENG_NM   
          ,A.NRT_WGT
          ,A.USG_RT
          ,A.VOY_DYS
          ,A.TONG_TAX_AMT
          ,A.TONG_FLET_TP_CD
          ,A.PER_TON_REV
          ,TRUNC((B.CTRT_END_DT - B.CTRT_ST_DT)/365 ,1)     CTRT_DYS
          ,D.VSL_RGST_CNT_CD
          ,C.REMARK                                VVD_RMK

          FROM TOT_VVD_STL_AMT A, 
               (SELECT VSL_CD
                      ,STL_YR
                      ,TONG_FLET_TP_CD
                      ,MAX(VSL_SEQ) VSL_SEQ
                      ,MAX(CTRT_ST_DT)  CTRT_ST_DT
                      ,NVL(MAX(CTRT_END_DT),TO_DATE(TO_CHAR(SYSDATE,'YYYY-MM-DD'),'YYYY-MM-DD'))  CTRT_END_DT
                FROM TOT_VESSEL B
                WHERE STL_YR = SUBSTR(@[stl_yrmon], 1, 4)
                  AND TONG_FLET_TP_CD = (SELECT MAX(TONG_FLET_TP_CD) FROM TOT_VESSEL T WHERE T.STL_YR = B.STL_YR AND T.VSL_CD = B.VSL_CD AND T.DELT_FLG <> 'Y' AND T.TONG_FLET_TP_CD NOT IN ('E'))
                  AND TONG_FLET_TP_CD NOT IN (/*'T',*/'E')
                GROUP BY VSL_CD,STL_YR,TONG_FLET_TP_CD) B   
              ,(SELECT X.STL_YRMON
                     , X.VSL_CD
                     , X.TONG_STL_BAT_JB_SEQ
                     , SUBSTR(SYS_CONNECT_BY_PATH(X.RMK,' || '),5) AS REMARK
                    
                FROM
                (SELECT STL_YRMON ,VSL_CD, TONG_STL_BAT_JB_SEQ,SKD_VOY_NO,SKD_DIR_CD, MAX(VSL_CD||SKD_VOY_NO||SKD_DIR_CD) RMK
                , COUNT(*) OVER(PARTITION BY STL_YRMON, VSL_CD, TONG_STL_BAT_JB_SEQ) CNT
                ,ROW_NUMBER() OVER(PARTITION BY STL_YRMON, VSL_CD, TONG_STL_BAT_JB_SEQ ORDER BY VSL_CD)SEQ
                
                FROM TOT_PORT_STL_AMT
                WHERE STL_YRMON = @[stl_yrmon]
                  AND VSL_CD NOT IN ('SP01','SP02','SP03','SP04','SP05','SP06','SP07','SP08','SP09','SP10','SP11','SP12','SP13','SP14','SP15','SP16','SP17','SP18')
                  AND TONG_STL_BAT_JB_SEQ = (SELECT MAX(TONG_STL_BAT_JB_SEQ) FROM TOT_VVD_STL_AMT WHERE STL_YRMON = @[stl_yrmon] AND NVL(TONG_FLET_TP_CD,'C') <> 'F')
                  GROUP BY STL_YRMON, VSL_CD, TONG_STL_BAT_JB_SEQ,SKD_VOY_NO,SKD_DIR_CD
                  ORDER BY RMK) X
                WHERE X.SEQ = X.CNT
                START WITH X.SEQ = 1
                CONNECT BY PRIOR X.SEQ+1 = X.SEQ
                AND PRIOR X.STL_YRMON = X.STL_YRMON
                AND PRIOR X.VSL_CD = X.VSL_CD
                AND PRIOR X.TONG_STL_BAT_JB_SEQ = X.TONG_STL_BAT_JB_SEQ
                ) C, MDM_VSL_CNTR D
          WHERE  A.STL_YRMON = @[stl_yrmon]
            AND  NVL(A.TONG_FLET_TP_CD,'C') <> 'F'
            AND  A.VSL_CD        =  B.VSL_CD(+)
            AND  SUBSTR(A.STL_YRMON, 1, 4) = B.STL_YR(+)
            AND  A.TONG_STL_BAT_JB_SEQ = (SELECT MAX(TONG_STL_BAT_JB_SEQ) FROM TOT_VVD_STL_AMT WHERE STL_YRMON  = @[stl_yrmon] AND NVL(TONG_FLET_TP_CD,'C') <> 'F')
            AND A.VSL_CD = C.VSL_CD(+)
            AND A.STL_YRMON = C.STL_YRMON(+)
            AND A.TONG_STL_BAT_JB_SEQ = C.TONG_STL_BAT_JB_SEQ(+)
            AND A.VSL_CD = D.VSL_CD(+) 
          UNION ALL
          SELECT   
          A.STL_YRMON  
          ,A.VSL_CD
          ,A.VSL_CD VSL_ENG_NM   
          ,A.NRT_WGT
          ,TRUNC(NVL(A.TONG_TAX_AMT/DECODE((A.PER_TON_REV*A.VOY_DYS),0,NULL,(A.PER_TON_REV*A.VOY_DYS)),0)*100,2)  USG_RT
          ,A.VOY_DYS
          ,A.TONG_TAX_AMT
          , A.TONG_FLET_TP_CD
          ,A.PER_TON_REV
          ,TRUNC((B.CTRT_END_DT - B.CTRT_ST_DT)/365 ,1)     CTRT_DYS
          ,D.VSL_RGST_CNT_CD
          ,C.REMARK                                VVD_RMK

          FROM TOT_VVD_STL_AMT A, 
               (SELECT VSL_CD
                      ,STL_YR
                      ,TONG_FLET_TP_CD
                      ,MAX(VSL_SEQ) VSL_SEQ
                      ,MAX(CTRT_ST_DT)  CTRT_ST_DT
                      ,NVL(MAX(CTRT_END_DT),TO_DATE(TO_CHAR(SYSDATE,'YYYY-MM-DD'),'YYYY-MM-DD'))  CTRT_END_DT
                FROM TOT_VESSEL B
                WHERE STL_YR = SUBSTR(@[stl_yrmon], 1, 4)
                  AND TONG_FLET_TP_CD = (SELECT MAX(TONG_FLET_TP_CD) FROM TOT_VESSEL T WHERE T.STL_YR = B.STL_YR AND T.VSL_CD = B.VSL_CD AND T.DELT_FLG <> 'Y' AND T.TONG_FLET_TP_CD NOT IN ('E'))
                  AND TONG_FLET_TP_CD NOT IN (/*'T',*/'E')
                GROUP BY VSL_CD,STL_YR,TONG_FLET_TP_CD) B   
              ,(SELECT X.STL_YRMON
                     , X.VSL_CD
                     , X.TONG_STL_BAT_JB_SEQ
                     , SUBSTR(SYS_CONNECT_BY_PATH(X.RMK,' || '),5) AS REMARK
                    
                FROM
                (SELECT STL_YRMON ,VSL_CD, TONG_STL_BAT_JB_SEQ,SKD_VOY_NO,SKD_DIR_CD, MAX(VSL_CD||SKD_VOY_NO||SKD_DIR_CD) RMK
                , COUNT(*) OVER(PARTITION BY STL_YRMON, VSL_CD, TONG_STL_BAT_JB_SEQ) CNT
                ,ROW_NUMBER() OVER(PARTITION BY STL_YRMON, VSL_CD, TONG_STL_BAT_JB_SEQ ORDER BY VSL_CD)SEQ
                
                FROM TOT_PORT_STL_AMT
                WHERE STL_YRMON = @[stl_yrmon]
                  AND VSL_CD IN ('SP01','SP02','SP03','SP04','SP05','SP06','SP07','SP08','SP09','SP10','SP11','SP12','SP13','SP14','SP15','SP16','SP17','SP18')
                  AND TONG_STL_BAT_JB_SEQ = (SELECT MAX(TONG_STL_BAT_JB_SEQ) FROM TOT_VVD_STL_AMT WHERE STL_YRMON = @[stl_yrmon] AND TONG_FLET_TP_CD ='F')
                  GROUP BY STL_YRMON, VSL_CD, TONG_STL_BAT_JB_SEQ,SKD_VOY_NO,SKD_DIR_CD
                  ORDER BY RMK) X
                WHERE X.SEQ = X.CNT
                START WITH X.SEQ = 1
                CONNECT BY PRIOR X.SEQ+1 = X.SEQ
                AND PRIOR X.STL_YRMON = X.STL_YRMON
                AND PRIOR X.VSL_CD = X.VSL_CD
                AND PRIOR X.TONG_STL_BAT_JB_SEQ = X.TONG_STL_BAT_JB_SEQ
                ) C, MDM_VSL_CNTR D
          WHERE  A.STL_YRMON = @[stl_yrmon]
            AND  A.TONG_FLET_TP_CD = 'F'
            AND  A.VSL_CD        =  B.VSL_CD(+)
            AND  SUBSTR(A.STL_YRMON, 1, 4) = B.STL_YR(+)
            AND  A.TONG_STL_BAT_JB_SEQ = (SELECT MAX(TONG_STL_BAT_JB_SEQ) FROM TOT_VVD_STL_AMT WHERE STL_YRMON  = @[stl_yrmon] AND TONG_FLET_TP_CD ='F')
            AND A.VSL_CD = C.VSL_CD(+)
            AND A.STL_YRMON = C.STL_YRMON(+)
            AND A.TONG_STL_BAT_JB_SEQ = C.TONG_STL_BAT_JB_SEQ(+)
            AND A.VSL_CD = D.VSL_CD(+)                   
) A			]]></sql>
			<params>
				<param name="stl_yrmon" type="12" value="200901" out="N"/>
				<param name="cre_usr_id" type="12" value="DEV056" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
