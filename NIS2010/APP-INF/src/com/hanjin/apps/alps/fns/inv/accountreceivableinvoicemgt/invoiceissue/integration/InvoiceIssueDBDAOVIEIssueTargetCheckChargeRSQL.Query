<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="InvoiceIssueDBDAOVIEIssueTargetCheckChargeRSQL">
			<desc><![CDATA[Invoice Main, Invoice Charge 테이블에서 INV TYPE  별 charge 조건으로 Select]]></desc>
			<sql><![CDATA[
SELECT SUBSTR(XMLAGG(XMLELEMENT(A, ',' ||CHG_CD) ORDER BY CHG_CD).EXTRACT( '//text()'), 2) CHG_CD
  FROM (SELECT DISTINCT B.CHG_CD
         FROM (SELECT A.*,
                      ROWNUM
                 FROM INV_AR_MN A 
                WHERE 1=1
                  AND A.AR_OFC_CD = @[ar_ofc_cd]
#if (${io_bnd_cd} != '')
		          AND A.IO_BND_CD = @[io_bnd_cd]
#end
                  AND A.BL_INV_CFM_DT IS NOT NULL
#if (${cust_cnt_cd} != '')
                  AND EXISTS (SELECT 'X'
                                FROM INV_AR_MN
                               WHERE DECODE(@[dt_opt], 'G', BL_INV_CFM_DT, 'S', SAIL_ARR_DT) BETWEEN @[from_dt] AND @[to_dt]
                                 AND A.BL_SRC_NO = BL_SRC_NO
                                 AND A.AR_OFC_CD = AR_OFC_CD)
#end
                                 AND NVL(A.INV_DELT_DIV_CD, 'N') <> 'Y'
#if (${vvd_cd} != '')
                                 AND A.VSL_CD = SUBSTR(@[vvd_cd],1,4)
 		                         AND A.SKD_VOY_NO = SUBSTR(@[vvd_cd],5,4)
		                         AND A.SKD_DIR_CD = SUBSTR(@[vvd_cd],9,1)
#end
#if (${svc_scp_cd} != '')
		                         AND A.SVC_SCP_CD = @[svc_scp_cd]
#end
#if (${port_cd} != '')
		                         AND DECODE(A.IO_BND_CD,'I',A.POL_CD, A.POD_CD ) = @[port_cd]
#end
#if (${cust_cnt_cd} != '')
                                 AND A.ACT_CUST_CNT_CD = @[cust_cnt_cd]
#end
#if (${cust_seq} != '')
                                 AND A.ACT_CUST_SEQ = TO_NUMBER(@[cust_seq])
#end
#if (${bl_nos} != '')
		                         AND A.BL_SRC_NO IN (${bl_nos})
#end
/*
                                 AND NOT EXISTS (SELECT 'X'
                                                   FROM MDM_ORGANIZATION
                                                  WHERE MDM_ORGANIZATION.REP_CUST_CNT_CD = A.ACT_CUST_CNT_CD
                                                    AND MDM_ORGANIZATION.REP_CUST_SEQ = A.ACT_CUST_SEQ ) 
*/
					) A,
                      INV_AR_CHG B
                WHERE A.AR_IF_NO = B.AR_IF_NO
                  AND B.INV_ISS_FLG ='N'
#if (${inv_type} == 'FRT')
                  AND A.REV_TP_CD <> 'M'	
                  AND (((B.CHG_CD NOT IN ('DHF','OBS','VDT') OR NVL(B.CURR_CD, ' ') <> 'VND') AND	
                          B.CHG_CD NOT IN ('OTH','DTH', 'DDC','VTT','THC','ORC','DTC','REF','VRT','SLF','VST', 'CLN','VCT', 'VET', 'VFT', 'TVA')
                          )
                       OR ((B.CHG_CD = 'OTH' AND A.IO_BND_CD = 'I') OR
                           (B.CHG_CD = 'DTH' AND A.IO_BND_CD = 'O') OR
                           (B.CHG_CD = 'DDC' AND A.IO_BND_CD = 'O')
                          )
                      )
                  AND NOT EXISTS(SELECT 1 FROM DUAL WHERE B.CHG_CD = 'DDF'	
                                                      AND A.IO_BND_CD = 'I'	
                                                      AND B.CURR_CD = 'VND')
				  AND NOT EXISTS(SELECT 1 FROM DUAL WHERE B.CHG_CD = 'EIS' AND A.IO_BND_CD = 'I' )
                  AND NOT EXISTS(SELECT 1 FROM DUAL WHERE B.CHG_CD = 'BCC' )
                  AND NOT EXISTS(SELECT 1 FROM DUAL WHERE B.CHG_CD IN ('PCS','VPT'))
                  AND NOT EXISTS(SELECT 1 FROM DUAL WHERE B.CHG_CD = 'MCF' AND B.CURR_CD IN ('VND','USD'))
                  AND NOT EXISTS(SELECT 1 FROM DUAL WHERE B.CHG_CD = 'CFC' AND B.CURR_CD IN ('VND','USD'))
                  AND NOT EXISTS(SELECT 1 FROM DUAL WHERE B.CHG_CD = 'LBP' AND A.IO_BND_CD = 'O' AND B.CURR_CD = 'VND')
                  AND NOT EXISTS(SELECT 1 FROM DUAL WHERE B.CHG_CD = 'BLR' AND A.IO_BND_CD = 'O' AND B.CURR_CD = 'VND')
                  AND NOT EXISTS(SELECT 1 FROM DUAL WHERE B.CHG_CD = 'TAC' AND B.CURR_CD = 'VND')
#elseif (${inv_type} == 'THC')
                  AND A.REV_TP_CD <> 'M'
                  AND ((B.CHG_CD = 'OTH' AND A.IO_BND_CD = 'O') OR
                      (B.CHG_CD = 'DTH' AND A.IO_BND_CD = 'I') OR
                      (B.CHG_CD = 'DDC' AND A.IO_BND_CD = 'I') OR 
                      (B.CHG_CD ='VTT') OR
                      (B.CHG_CD ='THC') OR
                      (B.CHG_CD ='ORC'))
#elseif (${inv_type} == 'DHF')
                  AND (B.CHG_CD IN ('OBS','DHF','VDT') OR
  		              (B.CHG_CD = 'DDF' AND A.IO_BND_CD ='I'))
                  AND B.CURR_CD ='VND'
#elseif (${inv_type} == 'DMR')
                  AND A.REV_TP_CD = 'M'
                  AND B.CHG_CD IN ('DMR','DTC','TVA','IVA')
				  AND B.AR_IF_NO IN (SELECT AR_IF_NO FROM INV_AR_CHG  WHERE AR_IF_NO = B.AR_IF_NO AND CHG_CD IN ('DMR','DTC'))
#elseif (${inv_type} == 'MNR')
                  AND A.REV_TP_CD = 'M'
                  AND B.CHG_CD IN ('RPC','TVA')
                  AND B.AR_IF_NO IN   (SELECT AR_IF_NO FROM INV_AR_CHG  WHERE AR_IF_NO = B.AR_IF_NO AND CHG_CD = 'RPC')
#elseif (${inv_type} == 'MRI')
                  AND A.REV_TP_CD = 'M'
                  AND ((B.CHG_CD IN ('DHF','OBS','RPC') AND 
                      NVL(B.CURR_CD, ' ') <> 'VND') OR
                      (B.CHG_CD  NOT IN ('OTH','DTH','DDC','DHF','OBS',
                                         'DMR', 'DTC', 'RPC','SLF','CLN','VDT','VTT','VST','VCT','PCS','VPT')))
#elseif (${inv_type} == 'SLF')
                  AND A.REV_TP_CD <> 'M'
                  AND B.CHG_CD IN ('SLF','VST')
#elseif (${inv_type} == 'CLN')
                  AND A.REV_TP_CD <> 'M'
                  AND B.CHG_CD IN ('CLN','VCT')
#elseif (${inv_type} == 'REF')
-- 2010-07-19 TYPE REF 추가	
-- 2111-11-22 REF charge가 MRI로 발생되기 때문에 REVENUE TYPE 체크가 의미 없어서 삭제하기로 함
                  AND B.CHG_CD IN ('REF','VRT')
				  AND B.CURR_CD = 'USD'
#elseif (${inv_type} == 'ETC')
				  AND (  (B.CHG_CD IN ('EIS','VET') AND A.IO_BND_CD = 'I')
                      OR (B.CHG_CD IN ('TVA') AND A.IO_BND_CD = 'O' AND B.CURR_CD = 'USD')
                      OR (B.CHG_CD IN ('BCC','PCS','VPT'))
                      OR (B.CHG_CD IN ('MCF') AND B.CURR_CD IN ('VND','USD'))
                      OR (B.CHG_CD IN ('CFC','VFT') AND B.CURR_CD IN ('VND','USD'))
	      			  OR (B.CHG_CD IN ('LBP','TVA') AND A.IO_BND_CD = 'O' AND B.CURR_CD = 'VND')
	      			  OR (B.CHG_CD IN ('TAC','TVA') AND B.CURR_CD = 'VND')
		              OR (B.CHG_CD IN ('BLR','TVA') AND  A.IO_BND_CD = 'O' AND B.CURR_CD = 'VND')
	    		  )
#end
            GROUP BY A.BL_SRC_NO, B.CURR_CD, B.CHG_CD ) BB,
	   INV_EDI_INTG_CD_DTL Y
 WHERE BB.CHG_CD = Y.HJS_CD_VAL_CTNT(+)
   AND CUST_CD_VAL_DESC IS NULL
   AND INTG_CD_ID(+) = 'CD00003'			]]></sql>
			<params>
				<param name="ar_ofc_cd" type="12" value="" out="N"/>
				<param name="io_bnd_cd" type="12" value="" out="N"/>
				<param name="dt_opt" type="12" value="" out="N"/>
				<param name="from_dt" type="12" value="" out="N"/>
				<param name="to_dt" type="12" value="" out="N"/>
				<param name="vvd_cd" type="12" value="" out="N"/>
				<param name="svc_scp_cd" type="12" value="" out="N"/>
				<param name="port_cd" type="12" value="" out="N"/>
				<param name="cust_cnt_cd" type="12" value="" out="N"/>
				<param name="cust_seq" type="2" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
