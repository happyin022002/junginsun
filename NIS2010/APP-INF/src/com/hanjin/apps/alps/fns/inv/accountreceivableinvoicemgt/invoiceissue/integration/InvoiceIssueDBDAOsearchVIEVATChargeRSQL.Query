<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="InvoiceIssueDBDAOsearchVIEVATChargeRSQL">
			<desc><![CDATA[.searchVIEVATCharge]]></desc>
			<sql><![CDATA[
SELECT CASE WHEN VAT_CNT > 0 AND SUM_VAT_AMT <> 0 THEN 'Y'
                                                  ELSE 'N'
       END VAT_EXIST
#if (${inv_type} == 'ETC')
	  ,A.CHG_CD 
	  ,B.CHG_CD CHG_CD_ISS
FROM (SELECT DISTINCT DECODE(B.CHG_CD, 'EIS', 'VET','VFT','VFT','VPT','VPT','TVA') CHG_CD
    	 FROM INV_AR_MN A, INV_AR_CHG B
     	 WHERE A.AR_IF_NO = B.AR_IF_NO
       		AND A.BL_SRC_NO = @[bl_no]
       		AND A.AR_OFC_CD = @[ar_ofc_cd]
       		AND A.BL_INV_CFM_DT IS NOT NULL
       		AND (B.CHG_CD = 'EIS' AND A.IO_BND_CD = 'I' 
            OR (B.CHG_CD IN ('BCC','PCS','VPT'))                                                                                                                                                        
            OR (B.CHG_CD IN ('MCF','VFT') AND B.CURR_CD IN ('VND','USD'))                                                                                                                                                        
            OR (B.CHG_CD = 'LBP' AND A.IO_BND_CD = 'O' AND B.CURR_CD = 'VND')                                                                                                                                                                                     
            OR (B.CHG_CD = 'TAC' AND B.CURR_CD = 'VND')
			OR (B.CHG_CD = 'BLR' AND  A.IO_BND_CD = 'O' AND B.CURR_CD = 'VND'))
       		) A
,(SELECT COUNT(*) VAT_CNT, SUM(B.CHG_AMT) SUM_VAT_AMT, B.CHG_CD
FROM INV_AR_MN A, INV_AR_CHG B
 WHERE A.AR_IF_NO = B.AR_IF_NO
   AND A.BL_SRC_NO = @[bl_no]
   AND A.AR_OFC_CD = @[ar_ofc_cd]
   AND A.BL_INV_CFM_DT IS NOT NULL
   AND B.INV_ISS_FLG = 'N'
   AND B.CHG_CD in ('TVA','VET','VFT','VPT')
   GROUP BY B.CHG_CD
   ) B
WHERE A.CHG_CD = B.CHG_CD(+)
ORDER BY A.CHG_CD DESC
#else 
    ,'' CHG_CD
	,'' CHG_CD_ISS
		FROM (
SELECT COUNT(*) VAT_CNT, SUM(B.CHG_AMT) SUM_VAT_AMT
FROM INV_AR_MN A, INV_AR_CHG B
 WHERE A.AR_IF_NO = B.AR_IF_NO
   AND A.BL_SRC_NO = @[bl_no]
   AND A.AR_OFC_CD = @[ar_ofc_cd]
   AND A.BL_INV_CFM_DT IS NOT NULL
   /* 베트남은 CHARGE별로 이슈를 하기 때문에 INV_AR_MN 테이블의 ISSUE FLAG 로는 해당 TYPW별로 이슈 여부를 알 수 없기 때문에 INV_AR_CHG 테이블에서 체크를 함 */
   AND B.INV_ISS_FLG = 'N'
#end
   #if (${inv_type} == 'THC')
       AND A.REV_TP_CD <> 'M'
       AND B.CHG_CD = 'VTT')
   #end
   /* DHF TYPE 은 REVENUE TYPE CODE 가 B,C 와 M TYPE 이 섞여 있는 경우가 있다고 해서 REV_TP_CD 비교를 하지 않음  */
   #if (${inv_type} == 'DHF')
        AND B.CHG_CD = 'VDT')
   #end
   #if (${inv_type} == 'SLF')
       AND A.REV_TP_CD <> 'M'
       AND B.CHG_CD = 'VST')
   #end
   #if (${inv_type} == 'CLN')
       AND A.REV_TP_CD <> 'M'
       AND B.CHG_CD = 'VCT')
   #end
   #if (${inv_type} == 'REF')
       AND A.REV_TP_CD <> 'M'
       AND B.CHG_CD = 'VRT')
   #end			]]></sql>
			<params>
				<param name="bl_no" type="12" value="" out="N"/>
				<param name="ar_ofc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
