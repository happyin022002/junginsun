<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TonnageTaxFillingDBDAOSearchHiringOutAndLayingUpSummaryRSQL">
			<desc><![CDATA[대선선박과 계선선박의 내역을 조회한다.]]></desc>
			<sql><![CDATA[
SELECT TRADE,
  LANE_CD,
  VSL_CD,
  VSL_ENG_NM,
  NET_RGST_TONG_WGT,
  ETD_START,
  CASE WHEN DIFF = 999 THEN TO_CHAR(TO_DATE(ETD_END, 'YYYYMMDD')+DAY, 'YYYYMMDD') ELSE ETD_END END ETD_END,
  USAGE,
  DAY,
  AMOUNT,
  PER_TON_REV,
  LEAD(VSL_CD) OVER (
    ORDER BY VSL_CD, LANE_CD, ETD_START) AS NEXT_VSL_CD,
  LEAD(ETD_START) OVER (
    ORDER BY VSL_CD, LANE_CD, ETD_START) AS NEXT_ETD_START,
  TO_CHAR(TO_DATE(ETD_END, 'YYYYMMDD') + 1, 'YYYYMMDD') ETD_END_NEXT_DAY
FROM (
    SELECT TRADE,
      LANE_CD,
      VSL_CD,
      VSL_ENG_NM,
      NET_RGST_TONG_WGT,
      ETD_DT ETD_START ,
      NVL(TO_CHAR(TO_DATE(ETD_LEAD, 'YYYYMMDD') - 1, 'YYYYMMDD'), ETD_DT) ETD_END,
      100 USAGE,
      DAY,
      TRUNC(PER_TON_REV * DAY) AMOUNT,
      PER_TON_REV,
      DECODE(NVL(DECODE(DAY - (TO_DATE(ETD_LEAD, 'YYYYMMDD') - TO_DATE(ETD_DT, 'YYYYMMDD')), 0, 0, DAY - (TO_DATE(ETD_LEAD, 'YYYYMMDD') - TO_DATE(ETD_DT, 'YYYYMMDD'))), 999), 999, 999, 0) DIFF
    FROM (
        SELECT A.VSL_CD,
          A.LDB_CAPA_QTY,
          A.BSA_CAPA,
          A.ACT_BSA_CAPA,
          SUM(A.VOY_DYS) DAY,
          TO_CHAR(A.ETD_DT, 'YYYYMMDD') ETD_DT,
          A.TONG_TAX_AMT,
          LEAD(TO_CHAR(A.ETD_DT, 'YYYYMMDD')) OVER (PARTITION BY A.VSL_CD
            ORDER BY TO_CHAR(A.ETD_DT,
                  'YYYYMMDD')) ETD_LEAD,
          A.CHTR_BSA_CAPA,
          C.VSL_ENG_NM,
          C.NET_RGST_TONG_WGT,
          D.PER_TON_REV,
          MAX(A.SLAN_CD) LANE_CD,
          MAX(A.TRD_CD) TRADE
        FROM TOT_PORT_STL_AMT A,
          MDM_VSL_CNTR C,
          TOT_VVD_STL_AMT D,
          (
            SELECT MAX( TONG_STL_BAT_JB_SEQ ) TONG_STL_BAT_JB_SEQ,
              STL_YRMON
            FROM TOT_PORT_STL_AMT
            WHERE STL_YRMON BETWEEN @[year]||'01' AND @[year]||'12'
            AND PORT_CD NOT IN ('FFFFF')
            GROUP BY STL_YRMON ) B
        WHERE A.STL_YRMON = B.STL_YRMON
          AND A.TONG_STL_BAT_JB_SEQ = B.TONG_STL_BAT_JB_SEQ
          AND A.STL_YRMON = D.STL_YRMON
          AND A.TONG_STL_BAT_JB_SEQ = D.TONG_STL_BAT_JB_SEQ
          AND A.VSL_CD = D.VSL_CD
          AND A.PORT_CD IN ('ZZZZZ',
              'YYYYY')
          AND A.VSL_CD = C.VSL_CD
        GROUP BY A.VSL_CD, A.LDB_CAPA_QTY, A.BSA_CAPA, A.ACT_BSA_CAPA, TO_CHAR(A.ETD_DT, 'YYYYMMDD'), A.TONG_TAX_AMT, A.CHTR_BSA_CAPA, C.VSL_ENG_NM, C.NET_RGST_TONG_WGT, D.PER_TON_REV
        ORDER BY A.VSL_CD, TO_CHAR(A.ETD_DT, 'YYYYMMDD') )
    ORDER BY VSL_CD, LANE_CD, ETD_DT )
ORDER BY VSL_CD, LANE_CD, ETD_START			]]></sql>
			<params>
				<param name="year" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
