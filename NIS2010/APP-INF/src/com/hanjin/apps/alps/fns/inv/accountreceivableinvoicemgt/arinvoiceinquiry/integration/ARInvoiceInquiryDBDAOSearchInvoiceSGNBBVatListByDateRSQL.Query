<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ARInvoiceInquiryDBDAOSearchInvoiceSGNBBVatListByDateRSQL">
			<desc><![CDATA[DESC Enter..]]></desc>
			<sql><![CDATA[
SELECT  A.INV_TYPE
        ,A.ISS_DT
        ,A.INV_NO
        ,A.ACT_INV_NO
        ,A.ACT_CUST_CD
        ,NVL(G.LOCL_NM, E.CUST_LGL_ENG_NM) CUST_LGL_ENG_NM
        ,E.CUST_RGST_NO
        ,rtrim(XMLAGG(XMLELEMENT(A, BL_SRC_NO, ',') ORDER BY A.INV_NO,A.BL_SRC_NO).EXTRACT( '//text()'), ',') BL_SRC_NO  
        ,ROUND(SUM(A.NET_AMT),0) NET_AMT
        ,ROUND(SUM(A.VAT_AMT),0) VAT_AMT
        ,ROUND((SUM(A.NET_AMT) + SUM(A.VAT_AMT)),0) GROSS_AMT
        ,ROUND(ROUND((SUM(A.NET_AMT) + SUM(A.VAT_AMT)),0) / A.INV_XCH_RT2, 2) USD_AMT  -- 2012.03.20 USD AMOUNT = GROSS AMOUNT * DAILY 환율
        ,A.INV_XCH_RT2 INV_XCH_RT
        ,A.IO_BND_CD
        ,A.UPD_USR_ID             
FROM    (        
        SELECT  DECODE(SUBSTR(C.INV_NO,1,1),'T','THC','H','DHF','F','FRT','D','DMR','R','ADV','M','MRI','S','SLF','C','CLN', 'E', 'REF', 'X', 'ETC') INV_TYPE
                ,C.ISS_DT
                ,C.INV_NO
                ,C.ACT_INV_NO
                ,(SELECT K1.ACT_CUST_CNT_CD||'-'||LPAD(K1.ACT_CUST_SEQ,6,'0')
                    FROM INV_AR_MN K1 
                    WHERE K1.AR_IF_NO = (SELECT MAX(K2.AR_IF_NO) FROM INV_AR_ISS_DTL K2
                                         WHERE K2.INV_NO = C.INV_NO)
                 ) ACT_CUST_CD
                ,C.BL_SRC_NO                
                 ,NVL((CASE  WHEN SUBSTR(C.INV_NO, 1,1) ='D' THEN SUM(DECODE(C.CHG_CD, 'TVA',0, 'IVA',0, C.CHG_AMT) * DECODE(C.CURR_CD, 'USD', C.INV_XCH_RT2, C.INV_XCH_RT))
                             WHEN SUBSTR(C.INV_NO, 1,1) ='M' THEN SUM(DECODE(C.CHG_CD, 'TVA',0, 'IVA',0, C.CHG_AMT) * DECODE(C.CURR_CD, 'USD', C.INV_XCH_RT2, C.INV_XCH_RT))
                             WHEN SUBSTR(C.INV_NO, 1,1) ='T' THEN SUM(DECODE(C.CHG_CD, 'VTT',0, C.CHG_AMT) * DECODE(C.CURR_CD, 'USD', C.INV_XCH_RT2, C.INV_XCH_RT))
                             WHEN SUBSTR(C.INV_NO, 1,1) ='S' THEN SUM(DECODE(C.CHG_CD, 'VST',0, C.CHG_AMT) * DECODE(C.CURR_CD, 'USD', C.INV_XCH_RT2, C.INV_XCH_RT))
                             WHEN SUBSTR(C.INV_NO, 1,1) ='C' THEN SUM(DECODE(C.CHG_CD, 'VCT',0, C.CHG_AMT) * DECODE(C.CURR_CD, 'USD', C.INV_XCH_RT2, C.INV_XCH_RT))
                             WHEN SUBSTR(C.INV_NO, 1,1) ='R' THEN SUM(C.CHG_AMT * DECODE(C.CURR_CD, 'USD', C.INV_XCH_RT2, C.INV_XCH_RT)) *0.975
                             WHEN SUBSTR(C.INV_NO, 1,1) ='H' THEN SUM(DECODE(C.CHG_CD, 'VDT',0, C.CHG_AMT) * DECODE(C.CURR_CD, 'USD', C.INV_XCH_RT2, C.INV_XCH_RT))
                             WHEN SUBSTR(C.INV_NO, 1,1) ='F' THEN SUM(C.CHG_AMT * DECODE(C.CURR_CD, 'USD', C.INV_XCH_RT2, C.INV_XCH_RT))     -- 2012.03.09
                             WHEN SUBSTR(C.INV_NO, 1,1) ='E' THEN SUM(DECODE(C.CHG_CD, 'VRT', 0, C.CHG_AMT) * C.INV_XCH_RT2)     -- 2012.03.09
                             WHEN SUBSTR(C.INV_NO, 1,1) ='X' THEN SUM(DECODE(C.CHG_CD, 'TVA',0, 'VET',0, C.CHG_AMT) * DECODE(C.CURR_CD, 'USD', C.INV_XCH_RT2, C.INV_XCH_RT))     -- 2012.03.09
                             ELSE SUM(C.CHG_AMT * DECODE(C.CURR_CD, 'USD',1, C.INV_XCH_RT/C.INV_XCH_RT2))
                        END  ),0)  NET_AMT
                ,NVL((CASE  WHEN SUBSTR(C.INV_NO, 1,1) ='F' THEN 0
                        WHEN SUBSTR(C.INV_NO, 1,1) ='R' THEN SUM(C.CHG_AMT * DECODE(C.CURR_CD, 'USD', C.INV_XCH_RT2, C.INV_XCH_RT)) * 0.025
                        WHEN SUBSTR(C.INV_NO, 1,1) ='D' THEN (SUM(DECODE(C.CHG_CD, 'TVA',0, 'IVA',0, C.CHG_AMT) * DECODE(C.CURR_CD, 'USD', C.INV_XCH_RT2, C.INV_XCH_RT))/ 0.95*0.05) -- (SUM(C.CHG_AMT* DECODE(C.CURR_CD, 'USD', C.INV_XCH_RT2, C.INV_XCH_RT)))
                        WHEN SUBSTR(C.INV_NO, 1,1) ='M' THEN SUM(DECODE(C.CHG_CD,'TVA',C.CHG_AMT,'IVA',C.CHG_AMT, 0) * DECODE(C.CURR_CD, 'USD', C.INV_XCH_RT2, C.INV_XCH_RT))
                        WHEN SUBSTR(C.INV_NO, 1,1) ='H' THEN SUM(DECODE(C.CHG_CD, 'VDT',0, C.CHG_AMT) * DECODE(C.CURR_CD, 'USD', C.INV_XCH_RT2, C.INV_XCH_RT)) / 0.95 * 0.05     -- 2012.03.09
                        WHEN SUBSTR(C.INV_NO, 1,1) ='T' THEN CASE WHEN C.ISS_DT < '20100101' THEN SUM(DECODE(C.CHG_CD,'VTT',0, C.CHG_AMT))* DECODE(C.CURR_CD, 'USD', C.INV_XCH_RT2, C.INV_XCH_RT) / 0.975*0.025
                                                                  ELSE SUM(DECODE(C.CHG_CD,'VTT',0,C.CHG_AMT)* DECODE(C.CURR_CD, 'USD', C.INV_XCH_RT2, C.INV_XCH_RT)) / 0.95*0.05 
                                                                  END 
                        WHEN SUBSTR(C.INV_NO, 1,1) ='S' THEN SUM(DECODE(C.CHG_CD, 'VST',0, C.CHG_AMT) * DECODE(C.CURR_CD, 'USD', C.INV_XCH_RT2, C.INV_XCH_RT)) / 0.95 * 0.05     -- 2012.03.09
                        WHEN SUBSTR(C.INV_NO, 1,1) ='C' THEN SUM(DECODE(C.CHG_CD, 'VCT',0, C.CHG_AMT) * DECODE(C.CURR_CD, 'USD', C.INV_XCH_RT2, C.INV_XCH_RT)) / 0.95 * 0.05     -- 2012.03.09
                        WHEN SUBSTR(C.INV_NO, 1,1) ='E' THEN SUM(DECODE(C.CHG_CD, 'VRT', 0, C.CHG_AMT) * C.INV_XCH_RT2) / 0.95 * 0.05     -- 2012.03.09
                        WHEN SUBSTR(C.INV_NO, 1,1) ='X' THEN SUM(DECODE(C.CHG_CD, 'TVA',0, 'VET',0, C.CHG_AMT) * DECODE(C.CURR_CD, 'USD', C.INV_XCH_RT2, C.INV_XCH_RT)) / 0.95 * 0.05    -- 2012.03.09
                        ELSE ROUND(sum(C.CHG_AMT), 0)
                        END),0) VAT_AMT
                ,C.INV_XCH_RT
				,C.INV_XCH_RT2
                ,DECODE(C.IO_BND_CD,'O','O/B','I/B') IO_BND_CD
                ,C.UPD_USR_ID
            FROM (    
                        SELECT  A.INV_NO
                                ,A.ISS_DT
                                ,A.ACT_INV_NO
                                ,D.BL_SRC_NO
                                ,C.CHG_CD
                                ,(CASE WHEN (SUBSTR(A.INV_NO, 1,1)= 'H' OR SUBSTR(A.INV_NO, 1,1)= 'C') AND (C.CURR_CD <> 'VND' AND C.CURR_CD <> 'USD') THEN C.CHG_AMT/G.USD_LOCL_XCH_RT*H.USD_LOCL_XCH_RT 
                                            WHEN (SUBSTR(A.INV_NO, 1,1)= 'F' OR SUBSTR(A.INV_NO, 1,1)= 'T' OR SUBSTR(A.INV_NO, 1,1)= 'D' OR SUBSTR(A.INV_NO, 1,1)= 'R' OR SUBSTR(A.INV_NO, 1,1)= 'M' OR SUBSTR(A.INV_NO, 1,1)= 'S') AND (C.CURR_CD <> 'VND' AND C.CURR_CD <> 'USD') THEN C.CHG_AMT/G.USD_LOCL_XCH_RT                    
                                            ELSE C.CHG_AMT END) CHG_AMT
                                ,C.CURR_CD
                                ,F.INV_XCH_RT INV_XCH_RT2
                                ,C.INV_XCH_RT
                                ,D.IO_BND_CD
                                ,A.UPD_USR_ID
                                ,G.USD_LOCL_XCH_RT -- USD_LOCL_XCH_RT
                                ,H.USD_LOCL_XCH_RT -- VND_LOCL_XCH_RT
                        FROM    INV_AR_ISS A
                                ,INV_AR_ISS_DTL B
                                ,INV_AR_CHG C
                                ,INV_AR_MN D
                                ,INV_CUST_AND_DLY_XCH_RT F
                                ,GL_MON_XCH_RT G
                                ,GL_MON_XCH_RT H
                        WHERE   A.INV_NO = B.INV_NO
                        AND     A.INV_SEQ = 1
                        AND     B.AR_IF_NO = C.AR_IF_NO
                        AND     B.CHG_SEQ = C.CHG_SEQ
                        AND     C.AR_IF_NO = D.AR_IF_NO
                        AND     F.IO_BND_CD = D.IO_BND_CD
                        AND     F.LOCL_CURR_CD = D.LOCL_CURR_CD
                        AND     F.CUST_CNT_CD = 'XX'
                        AND     F.CUST_SEQ = '0'
                        AND     F.CHG_CURR_CD = 'USD'
                        AND     G.ACCT_XCH_RT_LVL = '1'
                        AND     G.CURR_CD = C.CURR_CD
                        AND     G.ACCT_XCH_RT_YRMON = SUBSTR(D.SAIL_DT,0,6)
                        AND     H.ACCT_XCH_RT_LVL = '1'
                        AND     H.CURR_CD = 'VND'
                        AND     H.ACCT_XCH_RT_YRMON = SUBSTR(D.SAIL_DT,0,6)
                        AND     A.ISS_DT BETWEEN F.FM_DT AND F.TO_DT
		         		AND     F.AR_OFC_CD = D.AR_OFC_CD
		         		AND     D.INV_DELT_DIV_CD <>'Y'
		         		AND     A.ISS_DT BETWEEN REPLACE(@[iss_fm_dt], '-', '') AND REPLACE(@[iss_to_dt], '-', '')
		         		AND     A.ISS_OFC_CD IN (SELECT OFC_CD
		                                           FROM MDM_ORGANIZATION
		                                          WHERE AR_OFC_CD = @[office])
		         		AND 	D.AR_OFC_CD = @[office]
						#if (${act_cust_cnt_cd} != '')
			  			AND 	D.ACT_CUST_CNT_CD = @[act_cust_cnt_cd]
						#end
						#if (${act_cust_seq} != '')
			  			AND 	D.ACT_CUST_SEQ = @[act_cust_seq]
						#end
						#if (${vsl_cd} != '')
			  			AND 	D.VSL_CD = @[vsl_cd]
						#end
						#if (${skd_voy_no} != '')
			  			AND 	D.SKD_VOY_NO = @[skd_voy_no]
						#end
						#if (${skd_dir_cd} != '')
			  			AND 	D.SKD_DIR_CD = @[skd_dir_cd]
						#end
						#if (${bound} != '')  
			  			AND 	D.IO_BND_CD = @[bound]
						#if ((${bound} == 'I') && (${port} != ''))
			  			AND 	D.POD_CD = @[port]
						#elseif ((${bound} == 'O') && (${port} != ''))
			  			AND 	D.POL_CD = @[port]
						#end
						#else
						#if (${port} != '')
			  			AND 	((D.IO_BND_CD = 'I' AND D.POD_CD = @[port]) OR (D.IO_BND_CD = 'O' AND D.POL_CD = @[port]))
						#end
						#end
						#if (${categories} != '')
							#if (${categories} == 'HJS')
							AND C.CHG_CD NOT IN ('SLF','CLN')
							#else
							AND C.CHG_CD IN ('SLF','CLN')
							#end
						#end
            ) C                     
        GROUP BY DECODE(SUBSTR(C.INV_NO,1,1),'T','THC','H','DHF','F','FRT','D','DMR','R','ADV','M','MRI','S','SLF','C','CLN')
                ,C.ISS_DT
                ,C.INV_NO
                ,C.ACT_INV_NO
                ,C.BL_SRC_NO
                ,C.INV_XCH_RT2
                ,C.IO_BND_CD
                ,C.UPD_USR_ID 
                ,C.CURR_CD 
                ,C.INV_XCH_RT 
) A,  MDM_CUSTOMER E, MDM_CR_CUST G
    WHERE   SUBSTR(A.ACT_CUST_CD,0,2) = E.CUST_CNT_CD(+)
    AND     TO_NUMBER(SUBSTR(A.ACT_CUST_CD,4,7)) = E.CUST_SEQ(+)
    AND     SUBSTR(A.ACT_CUST_CD,0,2) = G.CUST_CNT_CD(+)
    AND     TO_NUMBER(SUBSTR(A.ACT_CUST_CD,4,7)) = G.CUST_SEQ(+)
    GROUP BY A.INV_TYPE
        ,A.ISS_DT
        ,A.INV_NO
        ,A.ACT_INV_NO
        ,A.ACT_CUST_CD
        ,NVL(G.LOCL_NM, E.CUST_LGL_ENG_NM)
        ,E.CUST_RGST_NO
        ,A.INV_XCH_RT2
        ,A.IO_BND_CD
        ,A.UPD_USR_ID  
    ORDER BY INV_TYPE, ISS_DT, INV_NO			]]></sql>
			<params>
				<param name="iss_fm_dt" type="12" value="" out="N"/>
				<param name="iss_to_dt" type="12" value="" out="N"/>
				<param name="office" type="12" value="" out="N"/>
				<param name="act_cust_cnt_cd" type="12" value="" out="N"/>
				<param name="act_cust_seq" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="bound" type="12" value="" out="N"/>
				<param name="port" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
