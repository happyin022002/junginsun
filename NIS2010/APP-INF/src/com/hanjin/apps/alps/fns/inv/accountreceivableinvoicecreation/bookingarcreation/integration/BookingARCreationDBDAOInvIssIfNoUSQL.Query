<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BookingARCreationDBDAOInvIssIfNoUSQL">
			<desc><![CDATA[InvIssIfNo]]></desc>
			<sql><![CDATA[
MERGE INTO INV_AR_MN X
USING (
SELECT B.AR_IF_NO
       ,CASE WHEN B.DUE_DT_LAST  > TO_CHAR(LAST_DAY(TO_DATE(SUBSTR(B.DUE_DT_LAST,1,6),'YYYYMM')),'YYYYMMDD') THEN TO_CHAR(LAST_DAY(TO_DATE(SUBSTR(B.DUE_DT_LAST,1,6),'YYYYMM')),'YYYYMMDD')
             ELSE B.DUE_DT_LAST
        END DUE_DT_LAST  
  FROM (
SELECT B.AR_IF_NO
      ,CASE WHEN OTS_SMRY_CD = 'INV' THEN
                                           CASE WHEN PAY_DT_DY1 IS NULL AND PAY_DT_DY2 IS NULL AND PAY_DT_DY3 IS NULL AND PAY_DT_DY4 IS NULL
                                                 THEN DUE_DT
                                                WHEN TO_NUMBER(SUBSTRB(DUE_DT,-2)) > GREATEST(NVL(TO_NUMBER(PAY_DT_DY1),0), NVL(TO_NUMBER(PAY_DT_DY2),0), NVL(TO_NUMBER(PAY_DT_DY3),0), NVL(TO_NUMBER(PAY_DT_DY4),0)) 
                                                THEN TO_CHAR(ADD_MONTHS(TO_DATE(SUBSTRB(DUE_DT,1,6),'YYYYMM'),1),'YYYYMM')||TRIM(TO_CHAR(LEAST(NVL(TO_NUMBER(PAY_DT_DY1),99), NVL(TO_NUMBER(PAY_DT_DY2),99), NVL(TO_NUMBER(PAY_DT_DY3),99), NVL(TO_NUMBER(PAY_DT_DY4),99)),'09'))
                                                ELSE SUBSTRB(DUE_DT,1,6)||TRIM(TO_CHAR(LEAST(NVL(TO_NUMBER(PAY_DT_DY1_NEW),99), NVL(TO_NUMBER(PAY_DT_DY2_NEW),99), NVL(TO_NUMBER(PAY_DT_DY3_NEW),99),NVL(TO_NUMBER(PAY_DT_DY4_NEW),99)),'09'))
                                           END 
             ELSE (SELECT P.DUE_DT FROM INV_AR_MN P WHERE P.AR_IF_NO = B.MAX_AR_IF_NO) 
       END DUE_DT_LAST                                    
  FROM (
        SELECT A.*
               ,SUBSTRB(DUE_DT,-2)
               ,CASE WHEN NVL(TO_NUMBER(PAY_DT_DY1),0) >= TO_NUMBER(SUBSTRB(DUE_DT,-2)) THEN NVL(TO_NUMBER(PAY_DT_DY1),0) END PAY_DT_DY1_NEW   
               ,CASE WHEN NVL(TO_NUMBER(PAY_DT_DY2),0) >= TO_NUMBER(SUBSTRB(DUE_DT,-2)) THEN NVL(TO_NUMBER(PAY_DT_DY2),0) END PAY_DT_DY2_NEW
               ,CASE WHEN NVL(TO_NUMBER(PAY_DT_DY3),0) >= TO_NUMBER(SUBSTRB(DUE_DT,-2)) THEN NVL(TO_NUMBER(PAY_DT_DY3),0) END PAY_DT_DY3_NEW
               ,CASE WHEN NVL(TO_NUMBER(PAY_DT_DY4),0) >= TO_NUMBER(SUBSTRB(DUE_DT,-2)) THEN NVL(TO_NUMBER(PAY_DT_DY4),0) END PAY_DT_DY4_NEW  
          FROM (
                SELECT  CASE WHEN CUST_CR_FLG = 'Y'
                        THEN CASE WHEN REV_TP_CD = 'M' OR TRSP_RQST_ORD_FLG = 'Y' 
                             THEN CASE WHEN NVL(B.CUST_CR_DUE_DT_DIV_CD,'S') ='S'
                                        THEN TO_CHAR(CASE WHEN E.AR_IF_NO IS NULL THEN TO_DATE(SAIL_ARR_DT,'YYYYMMDD')
                                                           ELSE TO_DATE(@[iss_dt],'YYYYMMDD')
                                                     END      
                                               + CASE WHEN CUST_CR_FLG = 'Y' AND IO_BND_CD = 'O' THEN DECODE(NVL(B.OB_CR_TERM_DYS,0),0,NVL(C.OB_CR_TERM_DYS,0),NVL(B.OB_CR_TERM_DYS,0))                                                                                    
                                                      WHEN CUST_CR_FLG = 'Y' AND IO_BND_CD = 'I' THEN DECODE(NVL(B.IB_CR_TERM_DYS,0),0,NVL(C.IB_CR_TERM_DYS,0),NVL(B.IB_CR_TERM_DYS,0))   
                                                      WHEN CUST_CR_FLG = 'N' AND IO_BND_CD = 'O' THEN NVL(C.OB_CR_TERM_DYS,0)                                                                                                           
                                                      WHEN CUST_CR_FLG = 'N' AND IO_BND_CD = 'I' THEN DECODE(A.AR_OFC_CD, 'BOMSC', DECODE(A.DEL_CD, 'INDEL', 25, 'INLDH', 25,  NVL(C.IB_CR_TERM_DYS,0)))
                                                 END,'YYYYMMDD') 
                                       ELSE TO_CHAR(TO_DATE(@[iss_dt],'YYYYMMDD') 
                                               + CASE WHEN CUST_CR_FLG = 'Y' AND IO_BND_CD = 'O' THEN DECODE(NVL(B.OB_CR_TERM_DYS,0),0,NVL(C.OB_CR_TERM_DYS,0),NVL(B.OB_CR_TERM_DYS,0))                                                                                    
                                                      WHEN CUST_CR_FLG = 'Y' AND IO_BND_CD = 'I' THEN DECODE(NVL(B.IB_CR_TERM_DYS,0),0,NVL(C.IB_CR_TERM_DYS,0),NVL(B.IB_CR_TERM_DYS,0))   
                                                      WHEN CUST_CR_FLG = 'N' AND IO_BND_CD = 'O' THEN NVL(C.OB_CR_TERM_DYS,0)                                                                                                           
                                                      WHEN CUST_CR_FLG = 'N' AND IO_BND_CD = 'I' THEN DECODE(A.AR_OFC_CD, 'BOMSC', DECODE(A.DEL_CD, 'INDEL', 25, 'INLDH', 25,  NVL(C.IB_CR_TERM_DYS,0)))
                                                 END,'YYYYMMDD')                                                   
                                  END               
                             ELSE CASE WHEN NVL(B.CUST_CR_DUE_DT_DIV_CD,'S') ='S' 
                                        THEN TO_CHAR(TO_DATE(SAIL_ARR_DT,'YYYYMMDD') 
                                               + CASE WHEN CUST_CR_FLG = 'Y' AND IO_BND_CD = 'O' THEN DECODE(NVL(B.OB_CR_TERM_DYS,0),0,NVL(C.OB_CR_TERM_DYS,0),NVL(B.OB_CR_TERM_DYS,0))                                                                                    
                                                      WHEN CUST_CR_FLG = 'Y' AND IO_BND_CD = 'I' THEN DECODE(NVL(B.IB_CR_TERM_DYS,0),0,NVL(C.IB_CR_TERM_DYS,0),NVL(B.IB_CR_TERM_DYS,0))   
                                                      WHEN CUST_CR_FLG = 'N' AND IO_BND_CD = 'O' THEN NVL(C.OB_CR_TERM_DYS,0)                                                                                                           
                                                      WHEN CUST_CR_FLG = 'N' AND IO_BND_CD = 'I' THEN DECODE(A.AR_OFC_CD, 'BOMSC', DECODE(A.DEL_CD, 'INDEL', 25, 'INLDH', 25,  NVL(C.IB_CR_TERM_DYS,0)))
                                                 END,'YYYYMMDD') 
                                       ELSE TO_CHAR(TO_DATE(@[iss_dt],'YYYYMMDD') 
                                               + CASE WHEN CUST_CR_FLG = 'Y' AND IO_BND_CD = 'O' THEN DECODE(NVL(B.OB_CR_TERM_DYS,0),0,NVL(C.OB_CR_TERM_DYS,0),NVL(B.OB_CR_TERM_DYS,0))                                                                                    
                                                      WHEN CUST_CR_FLG = 'Y' AND IO_BND_CD = 'I' THEN DECODE(NVL(B.IB_CR_TERM_DYS,0),0,NVL(C.IB_CR_TERM_DYS,0),NVL(B.IB_CR_TERM_DYS,0))   
                                                      WHEN CUST_CR_FLG = 'N' AND IO_BND_CD = 'O' THEN NVL(C.OB_CR_TERM_DYS,0)                                                                                                           
                                                      WHEN CUST_CR_FLG = 'N' AND IO_BND_CD = 'I' THEN DECODE(A.AR_OFC_CD, 'BOMSC', DECODE(A.DEL_CD, 'INDEL', 25, 'INLDH', 25,  NVL(C.IB_CR_TERM_DYS,0)))
                                                 END,'YYYYMMDD')  
                                  END 
                             END
                        ELSE A.DUE_DT              
                        END DUE_DT
                        ,B.PAY_DT_DY1, B.PAY_DT_DY2, B.PAY_DT_DY3, B.PAY_DT_DY4
                        ,B.CUST_CNT_CD
                        ,B.CUST_SEQ
                        ,D.OTS_SMRY_CD
                        ,A.INV_DELT_DIV_CD
                        ,A.AR_IF_NO
                        ,MAX(CASE WHEN NVL(A.INV_DELT_DIV_CD,'N') <> 'Y'THEN A.AR_IF_NO END) OVER (PARTITION BY A.BL_SRC_NO,A.AR_OFC_CD) MAX_AR_IF_NO 
                  FROM INV_AR_MN A,MDM_CR_CUST B,MDM_ORGANIZATION C,INV_AR_STUP_OFC D,
                       (SELECT AR_IF_NO
                          FROM INV_AR_ISS_FTR A
                         WHERE INV_ISS_WRK_NO = @[wrk_no]
                           AND BL_SRC_NO IN (SELECT BL_SRC_NO
                                               FROM (SELECT BL_SRC_NO,AR_IF_NO 
                                                           ,COUNT(*) OVER (PARTITION BY BL_SRC_NO) CNT 
                                                       FROM (SELECT DISTINCT BL_SRC_NO,AR_IF_NO 
                                                               FROM INV_AR_ISS_FTR   
                                                              WHERE INV_ISS_WRK_NO = @[wrk_no] ) 
                                                     )
                                              WHERE CNT = 1  
                                             )
                       ) E                  
                 WHERE A.ACT_CUST_CNT_CD = B.CUST_CNT_CD(+)
                   AND A.ACT_CUST_SEQ = B.CUST_SEQ(+)
                   AND A.AR_OFC_CD = C.OFC_CD(+)
                   AND A.AR_OFC_CD = D.AR_OFC_CD(+)
                   AND A.AR_IF_NO = E.AR_IF_NO(+)   
            		#if (${rev_type} != '')
						#if (${rev_type} == 'M')     
   						AND A.REV_TP_CD = 'M'
						#elseif (${rev_type} == 'F')     
   						AND A.REV_TP_CD <> 'M'
						#end
					#end
                   AND A.AR_IF_NO IN (  SELECT V1.AR_IF_NO 
                                          FROM INV_AR_ISS_FTR V1
                                         WHERE INV_ISS_WRK_NO = @[wrk_no] 
                                         GROUP BY V1.ACT_CUST_CNT_CD
                                             , V1.ACT_CUST_SEQ
                                             , V1.VSL_CD
                                             , V1.SKD_VOY_NO
                                             , V1.SKD_DIR_CD
                                             , V1.IO_BND_CD
                                             , V1.PORT_CD
                                             , V1.SVC_SCP_CD
                                        #if (${inv_mlt_bl_iss_flg} != 'Y') 
                                             , V1.BL_SRC_NO
                                        #end
                                             , V1.INV_ISS_TP_CD
                                             , V1.INV_SPLIT_CD
                                             , V1.USD_XCH_RT
                                             , V1.AR_OFC_CD
                                             , V1.AR_IF_NO 
                                     )
                ) A
      ) B ) B GROUP BY B.AR_IF_NO, B.DUE_DT_LAST ) Y
    ON (    X.AR_IF_NO = Y.AR_IF_NO )      
  WHEN MATCHED THEN UPDATE SET X.DUE_DT = Y.DUE_DT_LAST 
                              ,X.INV_ISS_FLG ='Y'
                              --,X.INV_CLR_FLG ='N'   
                              ,X.UPD_USR_ID = @[user_id]
                              ,X.UPD_DT = SYSDATE
							  ,X.ISS_DT = TO_CHAR(TO_DATE(@[iss_dt],'YYYYMMDD'),'YYYYMMDD')
							  #if (${ofc_cd} == 'DXBSC')
							  ,X.INV_NO = (SELECT MAX(K.INV_NO) FROM INV_AR_ISS_DTL K WHERE K.AR_IF_NO = Y.AR_IF_NO 
                    						AND SUBSTR(K.INV_NO,4) = (SELECT MAX(SUBSTR(M.INV_NO,4)) FROM INV_AR_ISS_DTL M WHERE M.AR_IF_NO = K.AR_IF_NO) )
							  #elseif (${ofc_cd} == 'BOMSC')		--2017.07.20 인도 GST 세법 변경 관련 보완
							  ,X.INV_NO = (SELECT MAX(INV_NO) FROM INV_AR_ISS_DTL WHERE INV_NO LIKE TRIM(REPLACE(@[ind_iss_tp_cd], 'T', '')||SUBSTR(@[login_ofc_cd], 1, 4)||TO_CHAR(GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC(@[login_ofc_cd]), 'YYMM'))||'%'  AND AR_IF_NO = Y.AR_IF_NO)
							  #else
							  ,X.INV_NO = (SELECT MAX(INV_NO) FROM INV_AR_ISS_DTL WHERE AR_IF_NO = Y.AR_IF_NO)
							  #end			]]></sql>
			<params>
				<param name="iss_dt" type="12" value="" out="N"/>
				<param name="wrk_no" type="12" value="" out="N"/>
				<param name="user_id" type="12" value="" out="N"/>
				<param name="ind_iss_tp_cd" type="12" value="" out="N"/>
				<param name="login_ofc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
