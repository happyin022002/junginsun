<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="SettlementProcessDBDAOJoSettlementStatusTotalRSQL">
			<desc><![CDATA[미정산 VVD 조회(Slot Hire)]]></desc>
			<sql><![CDATA[
SELECT
CEIL(COUNT(1)/TO_NUMBER(@[pagerows])) AS TOT_PAGE_CNT
FROM
(
	SELECT
      ROWNUM AS SEQ_NO  
	 ,AAA.*
	FROM
	(
		SELECT
		   AA.*
		FROM
		(
			SELECT
				 A.*       
				,CASE WHEN A.fnl_bsa_qty >= 0 AND A.fnl_bsa_slt_prc >= 0 THEN
						CASE WHEN (A.fnl_bsa_qty*A.fnl_bsa_slt_prc) = ACT_STL_AMT THEN 'S'
							 ELSE 'U'
							 END
					  ELSE
						CASE WHEN (A.BSA_QTY*A.BSA_SLT_PRC) = ACT_STL_AMT THEN 'S'
							 ELSE 'U'
							 END 
					  END jo_stl_sts_cd2                 
			FROM
			(
				SELECT 
					 NVL(J.REV_YRMON,J2.REV_YRMON) AS REV_YRMON
					,NVL(J.CRR_CD,J2.CRR_CD) AS CRR_CD
					,NVL(J.RLANE_CD,J2.RLANE_CD) AS RLANE_CD
					,NVL(J.JO_STL_JB_CD,J2.JO_STL_JB_CD) AS JO_STL_JB_CD       -- Hidden       
					,NVL(J.ACCT_CD,J2.ACCT_CD) AS ACCT_CD
					,J.BSA_QTY
					,J.BSA_SLT_PRC
					,J.ESTM_STL_TTL_AMT AS ESTM_STL_AMT
					,CASE WHEN J.ACT_STL_AMT = 0 THEN
                                                            (
                                                                SELECT 
                                                                    NVL(SUM(CASE WHEN LENGTH(E.SLP_TP_CD||E.SLP_FUNC_CD||E.SLP_OFC_CD||TO_CHAR(TO_DATE(E.SLP_ISS_DT,'YYYYMMDD'),'RRMMDD')||E.SLP_SER_NO) > 0 THEN A.STL_LOCL_AMT
                                                                             ELSE 0
                                                                             END
                                                                        ),0) AS STL_LOCL_AMT
                                                                FROM    JOO_SETTLEMENT  A
                                                                       ,JOO_STL_DTL     B
                                                                       ,JOO_STL_CMB_DTL D
                                                                       ,JOO_STL_CMB     E       
                                                                       ,JOO_CSR R
                                                                WHERE  A.ACCT_YRMON  = B.ACCT_YRMON (+) 
                                                                AND    A.STL_VVD_SEQ = B.STL_VVD_SEQ(+)
                                                                AND    A.STL_SEQ     = B.STL_SEQ    (+)
                                                                AND    A.TRD_CD = J.TRD_CD
                                                                AND    A.JO_CRR_CD = J.CRR_CD
                                                                AND    A.RE_DIVR_CD = J.RE_DIVR_CD
                                                                AND    A.JO_STL_ITM_CD = 'S/H'
                                                                AND    A.VSL_CD = J.VSL_CD
                                                                AND    A.SKD_VOY_NO = J.SKD_VOY_NO
                                                                AND    A.SKD_DIR_CD = J.SKD_DIR_CD
                                                                AND    E.RVS_CMB_FLG  = 'N'
                                                                AND    E.RJCT_CMB_FLG = 'N'
                                                                AND    A.ACCT_YRMON  = D.ACCT_YRMON
                                                                AND    A.STL_VVD_SEQ = D.STL_VVD_SEQ
                                                                AND    A.STL_SEQ     = D.STL_SEQ
                                                                AND    E.ACCT_YRMON  = D.ACCT_YRMON
                                                                AND    E.JO_CRR_CD   = D.JO_CRR_CD
                                                                AND    E.STL_CMB_SEQ = D.STL_CMB_SEQ
                                                                AND    E.RE_DIVR_CD  = D.RE_DIVR_CD
                                                                AND    E.SLP_SER_NO IS NOT NULL
                                                                AND    NVL(E.RVS_CMB_FLG ,'N') = 'N'
                                                                AND    NVL(E.RJCT_CMB_FLG,'N') = 'N'
                                                                AND    E.SLP_FUNC_CD = R.SLP_FUNC_CD
                                                                AND    E.SLP_OFC_CD = R.SLP_OFC_CD
                                                                AND    E.SLP_ISS_DT = R.SLP_ISS_DT
                                                                AND    E.SLP_SER_NO = R.SLP_SER_NO    
                                                            ) 
                                               ELSE J.ACT_STL_AMT
                                               END AS act_stl_amt     
					,J2.fnl_bsa_qty
					,J2.fnl_bsa_slt_prc
					,J2.jo_stl_sts_cd
					,J2.STL_LOCL_AMT AS STL_AMT	
				FROM ( SELECT J.*
					   FROM JOO_SLT_LIST J
					   WHERE 1=1
#if (${trd_cd}!= '')
       AND   J.TRD_CD        =  @[trd_cd]  
#end
#if (${rlane_cd}!= '')
       AND   J.RLANE_CD      =  @[rlane_cd]  
#end
#if (${jo_crr_cd}!= '')
       AND   J.CRR_CD     =  @[jo_crr_cd]  
#end
#if (${re_divr_cd}!= '')
       AND   J.RE_DIVR_CD    =  @[re_divr_cd]  
#end
#if (${skd_dir_cd}!= '')
       AND   J.SKD_DIR_CD    =  @[skd_dir_cd]  
#end
#if (${vvd_cd}!= '')
	   AND   J.VSL_CD||J.SKD_VOY_NO||J.SKD_DIR_CD like @[vvd_cd]||'%'
#end	
					 ) J    
					 FULL OUTER JOIN 
					 ( SELECT J2.*, S.STL_LOCL_AMT
					   FROM JOO_SLT_TGT J2, JOO_STL_TGT S	
					   WHERE 1=1
#if (${trd_cd}!= '')
       AND   J2.TRD_CD        =  @[trd_cd]  
#end
#if (${rlane_cd}!= '')
       AND   J2.RLANE_CD      =  @[rlane_cd]  
#end
#if (${jo_crr_cd}!= '')
       AND   J2.CRR_CD     =  @[jo_crr_cd]  
#end
#if (${re_divr_cd}!= '')
       AND   J2.RE_DIVR_CD    =  @[re_divr_cd]  
#end
#if (${skd_dir_cd}!= '')
       AND   J2.SKD_DIR_CD    =  @[skd_dir_cd]  
#end
#if (${vvd_cd}!= '')
	   AND   J2.VSL_CD||J2.SKD_VOY_NO||J2.SKD_DIR_CD like @[vvd_cd]||'%'
#end
                       AND J2.REV_YRMON = S.REV_YRMON(+)
					   AND J2.REV_YRMON_SEQ = S.REV_YRMON_SEQ(+)	                   	
					 ) J2
				ON ( J.TRD_CD    = J2.TRD_CD
				AND J.CRR_CD    = J2.CRR_CD
				AND J.RLANE_CD  = J2.RLANE_CD
				AND J.RE_DIVR_CD = J2.RE_DIVR_CD 
				AND J.VSL_CD     = J2.VSL_CD
				AND J.SKD_VOY_NO = J2.SKD_VOY_NO
				AND J.SKD_DIR_CD = J2.SKD_DIR_CD
				AND J.JO_STL_JB_CD = J2.JO_STL_JB_CD 
					)
			) A, JOO_CARRIER B   
			WHERE 1=1
            AND A.CRR_CD   = B.JO_CRR_CD(+)
            AND A.RLANE_CD = B.RLANE_CD(+)
		 ) AA
	 ) AAA
	 WHERE 1=1
     AND AAA.JO_STL_STS_CD2 = 'U' AND NVL(AAA.JO_STL_STS_CD,' ') != 'M' 
     AND (AAA.REV_YRMON >= '201510' AND AAA.REV_YRMON <= REPLACE(@[rev_yrmon],'-',''))
) AAAA			]]></sql>
			<params>
				<param name="pagerows" type="12" value="" out="N"/>
				<param name="trd_cd" type="12" value="" out="N"/>
				<param name="rlane_cd" type="12" value="" out="N"/>
				<param name="jo_crr_cd" type="12" value="" out="N"/>
				<param name="re_divr_cd" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="vvd_cd" type="12" value="" out="N"/>
				<param name="rev_yrmon" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
