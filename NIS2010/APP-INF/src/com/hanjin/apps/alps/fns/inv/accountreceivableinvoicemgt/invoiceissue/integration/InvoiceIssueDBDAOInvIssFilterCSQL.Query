<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="InvoiceIssueDBDAOInvIssFilterCSQL">
			<desc><![CDATA[InvIssFilter]]></desc>
			<sql><![CDATA[
INSERT INTO INV_AR_ISS_FTR
(TMP_ISS_NO 
,INV_ISS_WRK_NO,ACT_CUST_CNT_CD,ACT_CUST_SEQ,VSL_CD,SKD_VOY_NO,SKD_DIR_CD,IO_BND_CD,PORT_CD,SVC_SCP_CD,BL_SRC_NO,INV_SPLIT_CD,USD_XCH_RT     
,INV_ISS_TP_CD,AR_IF_NO,CHG_CD,CURR_CD,AR_OFC_CD,CRE_USR_ID,UPD_USR_ID, RVS_CHG_FLG ) 
SELECT INV_AR_ISS_TMP_SEQ.NEXTVAL
	,INV_ISS_WRK_NO
    ,ACT_CUST_CNT_CD
    ,ACT_CUST_SEQ
    ,VSL_CD
    ,SKD_VOY_NO
    ,SKD_DIR_CD
    ,IO_BND_CD
    ,PORT_CD
    ,SVC_SCP_CD
    ,BL_SRC_NO
    ,INV_SPLIT_CD
    ,USD_XCH_RT
    ,INV_ISS_TP_CD 
    ,AR_IF_NO   
    ,CHG_CD
    ,CURR_CD
    ,AR_OFC_CD
    ,USR_ID
    ,USR_ID 
    ,RVS_CHG_FLG  
 FROM
(SELECT 
	@[wrk_no] AS INV_ISS_WRK_NO
    , A.ACT_CUST_CNT_CD
    , A.ACT_CUST_SEQ
    , A.VSL_CD
    , A.SKD_VOY_NO
    , A.SKD_DIR_CD
    , A.IO_BND_CD
    , DECODE(A.IO_BND_CD, 'I', A.POD_CD, A.POL_CD) PORT_CD
    , A.SVC_SCP_CD
#if (${inv_mlt_bl_iss_flg} != 'Y') 
    , A.BL_SRC_NO AS BL_SRC_NO
#else
    ,'' AS BL_SRC_NO
#end
    , NVL(DECODE(A.INV_SPLIT_CD, 'C','*', A.INV_SPLIT_CD),'*') INV_SPLIT_CD
    , A.USD_XCH_RT
#if (${ar_ofc_cd2} == 'BOMSC' && (${ind_iss_tp_cd} == 'C' || ${ind_iss_tp_cd} == 'D')) 		--2017.07.20 인도 GST 세법 변경 관련 보완
    , 'S' INV_ISS_TP_CD
#else
    , I.INV_ISS_TP_CD 
#end
    , A.AR_IF_NO   
    , G.CHG_CD
    , G.CURR_CD
    , A.AR_OFC_CD
    , @[user_id] AS USR_ID
    , NVL(A.RVS_CHG_FLG,'N') AS RVS_CHG_FLG               
 FROM INV_AR_MN A
    , MDM_CUSTOMER F  
    , INV_AR_CHG G    
    , INV_AR_STUP_OFC I
WHERE A.AR_OFC_CD = @[ar_ofc_cd2]
#if (${bl_nos} != '') 
   AND A.BL_SRC_NO IN (${bl_nos})
#end
#if (${from_dt} != '' && ${to_dt} != '') 
	#if (${dt_option} == 'G') 
		AND A.BL_INV_CFM_DT BETWEEN REPLACE(@[from_dt],'-','') AND REPLACE(@[to_dt],'-','')
    #else
	  	AND A.UPD_DT >= TO_DATE(REPLACE(@[from_dt],'-',''), 'YYYYMMDD') AND A.UPD_DT < TO_DATE(REPLACE(@[to_dt],'-',''), 'YYYYMMDD') + 1
		AND A.UPD_USR_ID = @[user_id]
    #end  
#end                                                           
#if (${cust_cnt_cd} != '') 
   AND A.ACT_CUST_CNT_CD = @[cust_cnt_cd]
#end
#if (${cust_seq} != '') 
   AND A.ACT_CUST_SEQ = @[cust_seq]
#end
#if (${if_user_id} != '') 
   AND A.UPD_USR_ID = @[if_user_id]
#end
#if (${vvd} != '') 
   AND A.VSL_CD = SUBSTR(@[vvd], 1, 4)
   AND A.SKD_VOY_NO = SUBSTR(@[vvd], 5, 4) 
   AND A.SKD_DIR_CD = SUBSTR(@[vvd], 9, 1)
#end
#if (${port} != '') 
  AND DECODE(A.IO_BND_CD, 'I', A.POD_CD, A.POL_CD) = @[port]
#end
#if (${scp} != '') 
   AND A.SVC_SCP_CD = @[scp]
#end
#if (${bnd} != 'A' && ${bnd} != '')     
   AND A.IO_BND_CD = @[bnd]
#end
#if (${rev_type} != '')
	#if (${rev_type} == 'M')     
   	AND A.REV_TP_CD = 'M'
	#elseif (${rev_type} == 'F')     
   	AND A.REV_TP_CD <> 'M'
	#end
#end
  AND A.AR_IF_NO = G.AR_IF_NO
#if (${inv_dup_flg} != 'Y') 
  AND A.INV_ISS_FLG = 'N'   
#end
  AND A.AR_OFC_CD = I.AR_OFC_CD
  AND NVL(A.INV_DELT_DIV_CD, 'N') <> 'Y' 
#if (${ar_ofc_cd2} == 'BOMSC') 			--2017.07.20 인도 GST 세법 변경 관련 보완
    #if (${ind_iss_tp_cd} == 'C') 
        AND 0 > (SELECT SUM(INV_TTL_LOCL_AMT)
                 FROM INV_AR_MN
                 WHERE AR_OFC_CD = A.AR_OFC_CD
                 AND BL_SRC_NO = A.BL_SRC_NO
				 AND ACT_CUST_CNT_CD = A.ACT_CUST_CNT_CD
				 AND ACT_CUST_SEQ = A.ACT_CUST_SEQ
				 AND VSL_CD = A.VSL_CD
				 AND SKD_VOY_NO = A.SKD_VOY_NO
				 AND SKD_DIR_CD = A.SKD_DIR_CD
				 AND IO_BND_CD = A.IO_BND_CD
				 AND DECODE(IO_BND_CD, 'O', POL_CD, POD_CD) = DECODE(A.IO_BND_CD, 'O', A.POL_CD, A.POD_CD)
				 AND SVC_SCP_CD = A.SVC_SCP_CD
                 AND INV_ISS_FLG = 'N'
				 -- 2018.05.16 인도지역 Split Invoice Issue 기능 보완 
				 AND NVL(IDA_INV_SPLIT_FLG, 'N') = 'N')
    #elseif (${ind_iss_tp_cd} == 'D')
        AND 0 <= (SELECT SUM(INV_TTL_LOCL_AMT)
                  FROM INV_AR_MN
                  WHERE AR_OFC_CD = A.AR_OFC_CD
                  AND BL_SRC_NO = A.BL_SRC_NO
				  AND ACT_CUST_CNT_CD = A.ACT_CUST_CNT_CD
				  AND ACT_CUST_SEQ = A.ACT_CUST_SEQ
				  AND VSL_CD = A.VSL_CD
				  AND SKD_VOY_NO = A.SKD_VOY_NO
				  AND SKD_DIR_CD = A.SKD_DIR_CD
				  AND IO_BND_CD = A.IO_BND_CD
				  AND DECODE(IO_BND_CD, 'O', POL_CD, POD_CD) = DECODE(A.IO_BND_CD, 'O', A.POL_CD, A.POD_CD)
				  AND SVC_SCP_CD = A.SVC_SCP_CD
                  AND INV_ISS_FLG = 'N'
				  -- 2018.05.16 인도지역 Split Invoice Issue 기능 보완 
			 	  AND NVL(IDA_INV_SPLIT_FLG, 'N') = 'N')
    #end
#end
  AND NOT EXISTS ( SELECT 'X'
                   FROM INV_AR_MN
                  WHERE BL_SRC_NO = A.BL_SRC_NO
                    AND AR_OFC_CD = A.AR_OFC_CD
					AND NVL(INV_DELT_DIV_CD, 'N') <> 'Y' 
                    AND BL_INV_CFM_DT IS NULL )
  AND NOT EXISTS ( SELECT 'X'
                       FROM INV_AR_MN
                      WHERE BL_SRC_NO = A.BL_SRC_NO
                        AND AR_OFC_CD = A.AR_OFC_CD
                        AND USD_XCH_RT = 0
                        AND NVL(INV_DELT_DIV_CD, 'N') <> 'Y'
                    #if (${inv_dup_flg} != 'Y')
                        AND INV_ISS_FLG = 'N'
                    #end
                  )
  AND (A.ACT_CUST_CNT_CD,A.ACT_CUST_SEQ) NOT IN (SELECT (DECODE(A.REV_TP_CD||A.REV_SRC_CD,'MTH','XX','MTP','XX', S2.REP_CUST_CNT_CD)),S2.REP_CUST_SEQ
                                                  FROM INV_AR_STUP_OFC S1
                                                      ,MDM_ORGANIZATION S2
                                                 WHERE S1.AR_OFC_CD = @[ar_ofc_cd2]
                                                   AND S1.OTS_SMRY_CD <> 'BL'
                                                   AND S1.AR_OFC_CD = S2.AR_OFC_CD
                                                   AND S2.REP_CUST_CNT_CD IS NOT NULL
                                                   AND S2.REP_CUST_SEQ IS NOT NULL
                                                   AND S2.DELT_FLG = 'N')
  AND A.ACT_CUST_CNT_CD = F.CUST_CNT_CD
  AND A.ACT_CUST_SEQ    = F.CUST_SEQ
  AND NVL(F.CNTR_DIV_FLG, 'N') = 'Y'
  AND F.DELT_FLG <> 'Y'
#if (${ots_smry_cd} == 'BL')
  AND  EXISTS (SELECT 'X'
                 FROM INV_AR_MN MN, INV_AR_CHG CHG
                WHERE MN.BL_SRC_NO = A.BL_SRC_NO
                  AND MN.AR_OFC_CD = A.AR_OFC_CD
                  AND MN.ACT_CUST_CNT_CD = A.ACT_CUST_CNT_CD
                  AND MN.ACT_CUST_SEQ    = A.ACT_CUST_SEQ
                  AND MN.VSL_CD          = A.VSL_CD
                  AND MN.SKD_VOY_NO      = A.SKD_VOY_NO
                  AND MN.SKD_DIR_CD      = A.SKD_DIR_CD
                  AND MN.IO_BND_CD       = A.IO_BND_CD
                  AND MN.USD_XCH_RT      = A.USD_XCH_RT
                  AND DECODE(MN.IO_BND_CD, 'I', MN.POD_CD, MN.POL_CD) = DECODE(A.IO_BND_CD, 'I', A.POD_CD, A.POL_CD)
                  AND MN.SVC_SCP_CD = A.SVC_SCP_CD
                  AND MN.AR_IF_NO   = CHG.AR_IF_NO
                  AND NVL(DECODE(MN.INV_SPLIT_CD, 'C','*', MN.INV_SPLIT_CD),'*') = NVL(DECODE(A.INV_SPLIT_CD, 'C','*', A.INV_SPLIT_CD),'*')
                GROUP BY MN.BL_SRC_NO, MN.ACT_CUST_CNT_CD,MN.ACT_CUST_SEQ,
                         MN.VSL_CD ,MN.SKD_VOY_NO,  MN.SKD_DIR_CD,
                         MN.IO_BND_CD,MN.USD_XCH_RT, DECODE(MN.IO_BND_CD, 'I', MN.POD_CD, MN.POL_CD),
                         MN.SVC_SCP_CD,
                         CHG.CURR_CD, CHG.CHG_CD,
                         NVL(DECODE(MN.INV_SPLIT_CD, 'C','*', MN.INV_SPLIT_CD),'*'),
						 NVL(MN.RVS_CHG_FLG,'N')
               HAVING SUM(CHG.CHG_AMT) <> 0 )
#end
#if (${ar_ofc_cd2} == 'BOMSC') 			--2017.07.20 인도 GST 세법 변경 관련 보완
    #if (${ind_iss_tp_cd} == 'C' || ${ind_iss_tp_cd} == 'D')
        AND (EXISTS (SELECT 'X'
                     FROM INV_AR_MN
                     WHERE AR_OFC_CD = A.AR_OFC_CD
                     AND BL_SRC_NO = A.BL_SRC_NO
                     AND NVL(IDA_ISS_TP_CD, 'P') = 'T')
		-- 2018.05.16 인도지역 Split Invoice Issue 기능 보완 
			 OR EXISTS (SELECT 'X'
                    	FROM INV_AR_MN
                    	WHERE AR_OFC_CD = A.AR_OFC_CD
                    	AND BL_SRC_NO = A.BL_SRC_NO
                    	AND NVL(IDA_INV_SPLIT_FLG, 'N') = 'Y'))
		AND NVL(IDA_INV_SPLIT_FLG, 'N') = 'N'
    #end
#end
 GROUP BY A.ACT_CUST_CNT_CD
        , A.ACT_CUST_SEQ
        , A.VSL_CD
        , A.SKD_VOY_NO
        , A.SKD_DIR_CD
        , A.IO_BND_CD
        , DECODE(A.IO_BND_CD, 'I', A.POD_CD, A.POL_CD)
        , A.SVC_SCP_CD
    #if (${inv_mlt_bl_iss_flg} != 'Y')
        , A.BL_SRC_NO
    #else
        ,''
    #end
        , NVL(DECODE(A.INV_SPLIT_CD, 'C','*', A.INV_SPLIT_CD),'*')
        , A.USD_XCH_RT
    #if (${ar_ofc_cd2} == 'BOMSC' && (${ind_iss_tp_cd} == 'C' || ${ind_iss_tp_cd} == 'D')) 		--2017.07.20 인도 GST 세법 변경 관련 보완
    	, 'S'
	#else
    	, I.INV_ISS_TP_CD 
	#end
        , A.AR_IF_NO
        , G.CHG_CD
        , G.CURR_CD
        , A.AR_OFC_CD
        , @[user_id]
        , @[user_id]
        , NVL(A.RVS_CHG_FLG,'N'))			]]></sql>
			<params>
				<param name="wrk_no" type="12" value="" out="N"/>
				<param name="user_id" type="12" value="" out="N"/>
				<param name="ar_ofc_cd2" type="12" value="" out="N"/>
				<param name="from_dt" type="12" value="" out="N"/>
				<param name="to_dt" type="12" value="" out="N"/>
				<param name="cust_cnt_cd" type="12" value="" out="N"/>
				<param name="cust_seq" type="12" value="" out="N"/>
				<param name="if_user_id" type="12" value="" out="N"/>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="port" type="12" value="" out="N"/>
				<param name="scp" type="12" value="" out="N"/>
				<param name="bnd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
