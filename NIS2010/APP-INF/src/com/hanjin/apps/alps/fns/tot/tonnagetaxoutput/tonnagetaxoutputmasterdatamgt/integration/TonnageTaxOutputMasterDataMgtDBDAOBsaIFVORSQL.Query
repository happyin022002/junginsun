<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TonnageTaxOutputMasterDataMgtDBDAOBsaIFVORSQL">
			<desc><![CDATA[BSA Creation by vessel voyage 인터페이스 데이터 조회]]></desc>
			<sql><![CDATA[
/*2009.11.05 by 박효숙 차장     charter BSA 로직삭제*/

SELECT /*+ ORDERED USE_NL(F M) */ 
			F.STL_YRMON
			, DECODE(F.TRD_CD,NULL, T.TRD_CD,F.TRD_CD)    TRD_CD
			,F.SLAN_CD
			,F.VSL_CD
			,F.SKD_VOY_NO
			,F.SKD_DIR_CD
			,M.NET_RGST_TONG_WGT    NRT_WGT
			,M.INTL_TONG_CERTI_FLG
			,CASE WHEN L.VSL_SVC_TP_CD = 'S' THEN
              (SELECT DECODE(M.CNTR_DZN_CAPA,NULL,B.LDB_CAPA_QTY,0,B.LDB_CAPA_QTY,M.CNTR_DZN_CAPA) 
               FROM   MDM_VSL_CNTR M
               WHERE  M.VSL_CD = F.VSL_CD
              )
             ELSE DECODE(F.LDB_CAPA_QTY,NULL,B.LDB_CAPA_QTY,0,B.LDB_CAPA_QTY,F.LDB_CAPA_QTY)
             END LDB_CAPA_QTY
			,F.FNL_HJS_BSA_CAPA
			,F.CRR_BSA_CAPA
			,F.TONG_BSA_CAPA
FROM (
			SELECT  /*+ ORDERED USE_NL(F C) */ @[stl_yrmon] STL_YRMON
					, C.TRD_CD
					, F.VSL_SLAN_CD          SLAN_CD
					, F.VSL_CD
					, F.SKD_VOY_NO
					, F.SKD_DIR_CD
					, C.VSL_CAPA            LDB_CAPA_QTY
					, C.FNL_HJS_BSA_CAPA
					, 0 CRR_BSA_CAPA
					, C.FNL_HJS_BSA_CAPA  TONG_BSA_CAPA     
			  FROM (
			        SELECT /*+ ORDERED USE_NL(V L) */ V.VSL_SLAN_CD, V.VSL_CD, V.SKD_VOY_NO, V.SKD_DIR_CD     
			          FROM VSK_VSL_SKD V
			             , MDM_VSL_SVC_LANE L
			            
			         WHERE (V.VSL_CD, V.SKD_VOY_NO, V.SKD_DIR_CD) IN (
			                                                        SELECT /*+ index(V1) */ VSL_CD,SKD_VOY_NO,SKD_DIR_CD 
			                                                        FROM VSK_VSL_PORT_SKD V1
			        		                                            WHERE VPS_ETD_DT BETWEEN TO_DATE(@[stl_yrmon] ||'01','yyyymmdd') and last_day(to_date(@[stl_yrmon],'yyyymm'))+0.99999
			        		                                              AND NVL(SKD_CNG_STS_CD,'N') <> 'S'
			        		                                              AND TURN_PORT_IND_CD NOT IN ('V','D',DECODE(NVL(TURN_SKD_VOY_NO,''),'','V','F')) 
			        		                                              AND VPS_PORT_CD NOT IN ('PAPAC','EGSUZ')
			           		                                         )                                      
			           AND L.VSL_SVC_TP_CD IN ('J','S','I')      /* NON FEEDER 조건*/
			           AND V.VSL_SLAN_CD = L.VSL_SLAN_CD	
			           AND V.VSL_SLAN_CD IN ( SELECT  L.VSL_SLAN_CD
			                                  FROM TOT_LANE L
			                                       ,TOT_LANE_TRD T
			                                  WHERE L.STL_YRMON = @[stl_yrmon]
			                                    AND L.DELT_FLG = 'N'
			                                    AND T.LANE_SEQ = '1'
			                                    AND L.STL_YRMON = T.STL_YRMON
			                                    AND L.VSL_SLAN_CD = T.VSL_SLAN_CD)
			           AND NVL(L.DELT_FLG,'N') = 'N'
			     ) F LEFT OUTER JOIN BSA_VVD_MST C                                         
			     ON EXISTS (    SELECT 'X' FROM MAS_MON_VVD D
			                    WHERE  D.VSL_CD = C.VSL_CD
			                    AND D.SKD_VOY_NO = C.SKD_VOY_NO
			                    AND D.DIR_CD = C.SKD_DIR_CD
			                    and D.TRD_CD = C.TRD_CD
			                    and D.DELT_FLG = 'N' 
			                    and D.RLANE_CD = C.RLANE_CD )
			     AND F.VSL_CD = C.VSL_CD
			     AND F.SKD_VOY_NO = C.SKD_VOY_NO
			     AND F.SKD_DIR_CD = C.SKD_DIR_CD 
			     AND SUBSTR(C.RLANE_CD,0,3) = F.VSL_SLAN_CD
			     AND C.RLANE_CD IS NOT NULL
			        
			) F, MDM_VSL_CNTR M
			   , (SELECT  VSL_SLAN_CD , TRD_CD  FROM TOT_LANE_TRD WHERE STL_YRMON = @[stl_yrmon] AND LANE_SEQ = '1') T 
			   , (SELECT VSL_CD , SKD_VOY_NO, SKD_DIR_CD, SLAN_CD, TRD_CD , LDB_CAPA_QTY FROM TOT_BSA  WHERE STL_YRMON = TO_CHAR(ADD_MONTHS(TO_DATE(@[stl_yrmon],'YYYYMM'),-1),'YYYYMM')) B
               , MDM_VSL_SVC_LANE L
WHERE F.VSL_CD = M.VSL_CD(+)
  AND F.SLAN_CD = T.VSL_SLAN_CD(+)
  AND F.VSL_CD = B.VSL_CD (+)
  AND F.SKD_VOY_NO = B.SKD_VOY_NO (+)
  AND F.SKD_DIR_CD = B.SKD_DIR_CD (+)
  AND F.SLAN_CD = B.SLAN_CD (+)
  AND F.TRD_CD = B.TRD_CD (+)
  AND F.SLAN_CD = L.VSL_SLAN_CD(+)			]]></sql>
			<params>
				<param name="stl_yrmon" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
