<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="SettlementProcessDBDAOStlTgtOusRSQL">
			<desc><![CDATA[Settlement Taget OUS 조회]]></desc>
			<sql><![CDATA[
WITH OUS_TGT AS (
    SELECT
         J.REV_YRMON
        ,J.REV_YRMON_SEQ
        ,J.TRD_CD
        ,J.CRR_CD
        ,J.RLANE_CD
        ,J.RE_DIVR_CD
        ,J.VSL_CD
        ,J.SKD_VOY_NO
        ,J.SKD_DIR_CD
        ,J.VPS_PORT_CD
        ,J.YD_CD
        ,J.CLPT_IND_SEQ
        ,J.RDR_FLG
        ,J.VPS_ETD_DT
        ,J.JO_STL_JB_CD
        ,DECODE(L.LEV,'1','OUS','2','R/F','3','OTH') AS JO_STL_ITM_CD
        ,J.RF_SCG_STL_TP_CD     --T(TDR), R(RDR), I(User INPUT)
        ,L.LEV
        ,MIN(J.VSL_CD || J.SKD_VOY_NO || J.SKD_DIR_CD || J.REV_YRMON) OVER (PARTITION BY J.VSL_CD || J.SKD_VOY_NO || J.SKD_DIR_CD) AS VVD_ETD_GROUP        
        ,J.REV_DIR_CD
        ,SUBSTR(J.YD_CD,6,2) AS TML		
        ,DECODE(L.LEV,'1',J.FNL_OVR_USD_SLT_KNT,'0')                 AS OUS_KNT
		,DECODE(L.LEV,'2',J.RF_CNTR_20FT_KNT+J.RF_CNTR_40FT_KNT,'0') AS RF_KNT        
    FROM 
    (
        SELECT LEVEL AS LEV
        FROM DUAL CONNECT BY LEVEL <= 3
    ) L
    ,(
			SELECT 
                 J.REV_YRMON
                ,J.REV_YRMON_SEQ
                ,J.TRD_CD
                ,J.CRR_CD
                ,J.RLANE_CD
                ,J.RE_DIVR_CD
                ,J.VSL_CD
                ,J.SKD_VOY_NO
                ,J.SKD_DIR_CD
                ,J.VPS_PORT_CD
                ,J.YD_CD
                ,J.CLPT_IND_SEQ
                ,J.RDR_FLG
                ,J.VPS_ETD_DT
                ,J.JO_STL_JB_CD
                ,J.RF_SCG_STL_TP_CD     --T(TDR), R(RDR), I(User INPUT)
                ,J.REV_DIR_CD
                ,J.FNL_OVR_USD_SLT_KNT
                ,J.RF_CNTR_20FT_KNT
                ,J.RF_CNTR_40FT_KNT
            FROM JOO_LODG_TGT J
			WHERE 1=1
		    AND J.STL_TGT_FLG = '1'
		    AND J.STL_CLZ_FLG = '0'
            AND J.REV_YRMON BETWEEN REPLACE(@[rev_yrmon_fr],'-','') AND REPLACE(@[rev_yrmon_to],'-','')
		    #if (${re_divr_cd} != '')			
		    AND J.RE_DIVR_CD = @[re_divr_cd]
		    #end
		    #if (${trd_cd} != '')
		    AND J.TRD_CD    = @[trd_cd]
		    #end
		    #if (${rlane_cd} != '')
		    AND J.RLANE_CD  = @[rlane_cd]
		    #end
		    #if (${vvd} != '')
		    AND J.VSL_CD || J.SKD_VOY_NO || J.SKD_DIR_CD LIKE @[vvd] || '%'
		    #end
	  ) J
), OUS_TGT2 AS (
    SELECT 
     O.REV_YRMON
    ,O.REV_YRMON_SEQ
    ,O.TRD_CD
    ,@[jo_crr_cd] CRR_CD
    ,O.RLANE_CD
    ,O.RE_DIVR_CD
    ,O.VSL_CD
    ,O.SKD_VOY_NO
    ,O.SKD_DIR_CD
    ,O.VPS_PORT_CD
    ,O.YD_CD
    ,O.CLPT_IND_SEQ
    ,O.RDR_FLG
    ,O.VPS_ETD_DT
    ,O.JO_STL_JB_CD
    ,O.JO_STL_ITM_CD
    ,O.RF_SCG_STL_TP_CD
    ,O.LEV
    ,O.VVD_ETD_GROUP
    ,O.REV_DIR_CD
    ,O.TML
    ,O.OUS_KNT
    ,O.RF_KNT
    ,(
        SELECT
            MAX(B.JO_ESTM_ACCT_CD) ACCT_CD
        FROM  JOO_STL_ITM A, JOO_STL_ITM_ACCT B
        WHERE A.JO_STL_ITM_CD = B.JO_STL_ITM_CD
        AND A.JO_STL_ITM_CD = O.JO_STL_ITM_CD
        AND B.RE_DIVR_CD = O.RE_DIVR_CD
        GROUP BY
                 A.JO_STL_ITM_CD
                ,A.JO_STL_ITM_NM
                ,A.JO_AUTO_CRE_FLG
                ,A.JO_MNL_CRE_FLG			
     ) AS ACCT_CD
        ,S.REV_SEQ
        ,S.ACCT_YRMON
        ,S.STL_VVD_SEQ
        ,S.STL_SEQ
        -----------------
        ,S.JO_STL_STS_CD
        ,S.BSA_SLT_PRC
        ,S.FNL_BSA_QTY 
        ,S.FNL_BSA_SLT_PRC 
        ,NVL(S.LOCL_CURR_CD,'USD') AS LOCL_CURR_CD
        ,S.STL_LOCL_AMT
        ,S.STL_RMK
        ,S.JO_STL_TGT_ITM_CD
        ,S.REV_BSA_QTY
        ,S.REV_BSA_SLT_PRC
        ,S.REV_ENBL_FLG 
        ,S.REV_SHW_FLG
        ,S.REV_CRR_CD
        ,S.N2ND_REV_BSA_QTY
        ,S.N2ND_REV_BSA_SLT_PRC
        ,S.N2ND_REV_ENBL_FLG
        ,S.N2ND_REV_CRR_CD
        ,S.N3RD_REV_BSA_QTY
        ,S.N3RD_REV_BSA_SLT_PRC
        ,S.N3RD_REV_ENBL_FLG
        ,S.N3RD_REV_CRR_CD    
        ,S.REV_ENBL_FLG AS REV_CHK
        ,S.N2ND_REV_ENBL_FLG AS N2ND_REV_CHK
        ,S.N3RD_REV_ENBL_FLG AS N3RD_REV_CHK
        ,S.STL_TGT_FLG
        ,S.STL_TGT_FLG AS STL_TGT_FLG2
        ,S.STL_CLZ_FLG        
        ,DECODE(O.JO_STL_ITM_CD,'OUS',O.OUS_KNT,'R/F',O.RF_KNT,S.BSA_QTY) AS BSA_QTY        
     -----------------
    FROM OUS_TGT O, (SELECT S.* 
						 FROM JOO_STL_TGT S 
						 WHERE 1=1
			             AND S.REV_YRMON BETWEEN REPLACE(@[rev_yrmon_fr],'-','') AND REPLACE(@[rev_yrmon_to],'-','')
					     #if (${re_divr_cd} != '')			
			  		     AND S.RE_DIVR_CD = @[re_divr_cd]
			 		     #end
		    			 #if (${trd_cd} != '')
		    			 AND S.TRD_CD    = @[trd_cd]
		    			 #end
		      			 #if (${rlane_cd} != '')
		    			 AND S.RLANE_CD  = @[rlane_cd]
					     #end
		    			 #if (${vvd} != '')
		      			 AND S.VSL_CD || S.SKD_VOY_NO || S.SKD_DIR_CD LIKE @[vvd] || '%'
		    			 #end
						 #if (${ous_yn} == '' && ${rf_yn} == ''&& ${dg_yn} == '' )
							AND S.JO_STL_ITM_CD IN ('OUS','R/F','OTH')
						 #else
						    AND (
							    1!=1
								#if (${ous_yn} == 'Y')
								    OR S.JO_STL_ITM_CD = 'OUS'
								#end
								#if (${rf_yn} == 'Y')
								    OR S.JO_STL_ITM_CD = 'R/F'
								#end
								#if (${dg_yn} == 'Y')
								    OR S.JO_STL_ITM_CD = 'OTH'
								#end
							    )
							#if (${ous_yn} == 'N' && ${rf_yn} == 'N'&& ${dg_yn} == 'N' )
								AND S.JO_STL_ITM_CD IN ('OUS','R/F','OTH')
							#end
						 #end						  	
						 ) S
    WHERE 1=1
    AND O.REV_YRMON = S.REV_YRMON(+)
    AND O.REV_YRMON_SEQ = S.REV_YRMON_SEQ(+)
    AND O.JO_STL_ITM_CD = S.JO_STL_ITM_CD(+)
	#if (${ous_yn} == '' && ${rf_yn} == ''&& ${dg_yn} == '' )
		AND O.JO_STL_ITM_CD IN ('OUS','R/F','OTH')
	#else
	    AND (
	    1!=1
		#if (${ous_yn} == 'Y')
	    OR O.JO_STL_ITM_CD = 'OUS'
		#end
		#if (${rf_yn} == 'Y')
	    OR O.JO_STL_ITM_CD = 'R/F'
		#end
		#if (${dg_yn} == 'Y')
	    OR O.JO_STL_ITM_CD = 'OTH'
		#end
	    )
		#if (${ous_yn} == 'N' && ${rf_yn} == 'N'&& ${dg_yn} == 'N' )
		AND O.JO_STL_ITM_CD IN ('OUS','R/F','OTH')
		#end
	#end
),OUS_TGT3 AS (
 SELECT 
     O.REV_YRMON
    ,O.REV_YRMON_SEQ
    ,O.TRD_CD
    ,O.CRR_CD
    ,O.RLANE_CD
    ,O.RE_DIVR_CD
    ,O.VSL_CD
    ,O.SKD_VOY_NO
    ,O.SKD_DIR_CD
    ,O.VPS_PORT_CD
    ,O.YD_CD
    ,O.CLPT_IND_SEQ
    ,O.RDR_FLG
    ,O.VPS_ETD_DT
    ,O.JO_STL_JB_CD
    ,O.JO_STL_ITM_CD
    ,O.RF_SCG_STL_TP_CD
    ,O.LEV
    ,O.VVD_ETD_GROUP
    ,O.REV_DIR_CD
    ,O.TML
    ,O.OUS_KNT
    ,O.RF_KNT
    ,O.ACCT_CD
    ,O.REV_SEQ
    ,O.ACCT_YRMON
    ,O.STL_VVD_SEQ
    ,O.STL_SEQ
    -----------------
    ,O.JO_STL_STS_CD
    ,O.BSA_SLT_PRC
    ,O.FNL_BSA_QTY 
    ,O.FNL_BSA_SLT_PRC 
    ,O.LOCL_CURR_CD
    ,O.STL_LOCL_AMT
    ,O.STL_RMK
    ,O.JO_STL_TGT_ITM_CD
    ,O.REV_BSA_QTY
    ,O.REV_BSA_SLT_PRC
    ,O.REV_ENBL_FLG 
    ,O.REV_SHW_FLG
    ,O.REV_CRR_CD
    ,O.N2ND_REV_BSA_QTY
    ,O.N2ND_REV_BSA_SLT_PRC
    ,O.N2ND_REV_ENBL_FLG
    ,O.N2ND_REV_CRR_CD
    ,O.N3RD_REV_BSA_QTY
    ,O.N3RD_REV_BSA_SLT_PRC
    ,O.N3RD_REV_ENBL_FLG
    ,O.N3RD_REV_CRR_CD    
    ,O.REV_CHK
    ,O.N2ND_REV_CHK
    ,O.N3RD_REV_CHK
    ,O.STL_TGT_FLG
    ,O.STL_TGT_FLG2
    ,O.STL_CLZ_FLG        
    ,O.BSA_QTY        
FROM OUS_TGT2 O
UNION ALL
    SELECT 
     S.REV_YRMON
    ,S.REV_YRMON_SEQ
    ,S.TRD_CD
    ,S.CRR_CD
    ,S.RLANE_CD
    ,S.RE_DIVR_CD
    ,S.VSL_CD
    ,S.SKD_VOY_NO
    ,S.SKD_DIR_CD
    ,S.VPS_PORT_CD
    ,S.YD_CD
    ,S.CLPT_IND_SEQ
    ,S.RDR_FLG
    ,S.VPS_ETD_DT
    ,S.JO_STL_JB_CD
    ,S.JO_STL_ITM_CD
    ,S.RF_SCG_STL_TP_CD
    ,DECODE(S.JO_STL_ITM_CD,'OUS',1,'R/F',2,'OTH',3) AS LEV
    ,S.VSL_CD || S.SKD_VOY_NO || S.SKD_DIR_CD || S.REV_YRMON AS VVD_ETD_GROUP        
    ,S.REV_DIR_CD
    ,SUBSTR(S.YD_CD,6,2) AS TML
    ,DECODE(S.JO_STL_ITM_CD,'OUS',BSA_QTY,'0') AS OUS_KNT 
    ,DECODE(S.JO_STL_ITM_CD,'R/F',BSA_QTY,'0') AS RF_KNT
    ,S.ACCT_CD
    ,S.REV_SEQ
    ,S.ACCT_YRMON
    ,S.STL_VVD_SEQ
    ,S.STL_SEQ
    -----------------
    ,S.JO_STL_STS_CD
    ,S.BSA_SLT_PRC
    ,S.FNL_BSA_QTY 
    ,S.FNL_BSA_SLT_PRC 
    ,NVL(S.LOCL_CURR_CD,'USD') AS LOCL_CURR_CD
    ,S.STL_LOCL_AMT
    ,S.STL_RMK
    ,S.JO_STL_TGT_ITM_CD
    ,S.REV_BSA_QTY
    ,S.REV_BSA_SLT_PRC
    ,S.REV_ENBL_FLG 
    ,S.REV_SHW_FLG
    ,S.REV_CRR_CD
    ,S.N2ND_REV_BSA_QTY
    ,S.N2ND_REV_BSA_SLT_PRC
    ,S.N2ND_REV_ENBL_FLG
    ,S.N2ND_REV_CRR_CD
    ,S.N3RD_REV_BSA_QTY
    ,S.N3RD_REV_BSA_SLT_PRC
    ,S.N3RD_REV_ENBL_FLG
    ,S.N3RD_REV_CRR_CD    
    ,S.REV_ENBL_FLG AS REV_CHK
    ,S.N2ND_REV_ENBL_FLG AS N2ND_REV_CHK
    ,S.N3RD_REV_ENBL_FLG AS N3RD_REV_CHK
    ,S.STL_TGT_FLG
    ,S.STL_TGT_FLG AS STL_TGT_FLG2
    ,S.STL_CLZ_FLG        
    ,S.BSA_QTY       
FROM JOO_STL_TGT S 
WHERE 1=1
AND S.REV_SHW_FLG IN ('A','C','S')
			             AND S.REV_YRMON BETWEEN REPLACE(@[rev_yrmon_fr],'-','') AND REPLACE(@[rev_yrmon_to],'-','')
					     #if (${re_divr_cd} != '')			
			  		     AND S.RE_DIVR_CD = @[re_divr_cd]
			 		     #end
		    			 #if (${jo_crr_cd} != '')
		    			 AND S.CRR_CD = @[jo_crr_cd]
		    			 #end
		    			 #if (${trd_cd} != '')
		    			 AND S.TRD_CD    = @[trd_cd]
		    			 #end
		      			 #if (${rlane_cd} != '')
		    			 AND S.RLANE_CD  = @[rlane_cd]
					     #end
		    			 #if (${vvd} != '')
		      			 AND S.VSL_CD || S.SKD_VOY_NO || S.SKD_DIR_CD LIKE @[vvd] || '%'
		    			 #end
						 #if (${ous_yn} == '' && ${rf_yn} == ''&& ${dg_yn} == '' )
							AND S.JO_STL_ITM_CD IN ('OUS','R/F','OTH')
						 #else
						    AND (
							    1!=1
								#if (${ous_yn} == 'Y')
								    OR S.JO_STL_ITM_CD = 'OUS'
								#end
								#if (${rf_yn} == 'Y')
								    OR S.JO_STL_ITM_CD = 'R/F'
								#end
								#if (${dg_yn} == 'Y')
								    OR S.JO_STL_ITM_CD = 'OTH'
								#end
							    )
							#if (${ous_yn} == 'N' && ${rf_yn} == 'N'&& ${dg_yn} == 'N' )
								AND S.JO_STL_ITM_CD IN ('OUS','R/F','OTH')
							#end
						 #end						  	
), OUS_TGT4 AS (
    SELECT   
         REV_YRMON
        ,REV_YRMON_SEQ
        ,TRD_CD
        ,CRR_CD
        ,RLANE_CD
        ,RE_DIVR_CD
        ,VSL_CD
        ,SKD_VOY_NO
        ,SKD_DIR_CD
        ,VPS_PORT_CD
        ,YD_CD
        ,CLPT_IND_SEQ
        ,RDR_FLG
        ,VPS_ETD_DT
        ,JO_STL_JB_CD
        ,JO_STL_ITM_CD
        ,RF_SCG_STL_TP_CD
        ,LEV
        ,VVD_ETD_GROUP
        ,REV_DIR_CD
        ,TML
        ,OUS_KNT 
        ,RF_KNT
        ,ACCT_CD
        ,REV_SEQ
        ,ACCT_YRMON
        ,STL_VVD_SEQ
        ,STL_SEQ
        ,JO_STL_STS_CD
        ,BSA_SLT_PRC
        ,FNL_BSA_QTY 
        ,FNL_BSA_SLT_PRC 
        ,LOCL_CURR_CD
        ,STL_LOCL_AMT
        ,STL_RMK
        ,JO_STL_TGT_ITM_CD
        ,REV_BSA_QTY
        ,REV_BSA_SLT_PRC
        ,REV_ENBL_FLG 
        ,REV_SHW_FLG
        ,REV_CRR_CD
        ,N2ND_REV_BSA_QTY
        ,N2ND_REV_BSA_SLT_PRC
        ,N2ND_REV_ENBL_FLG
        ,N2ND_REV_CRR_CD
        ,N3RD_REV_BSA_QTY
        ,N3RD_REV_BSA_SLT_PRC
        ,N3RD_REV_ENBL_FLG
        ,N3RD_REV_CRR_CD    
        ,REV_CHK
        ,N2ND_REV_CHK
        ,N3RD_REV_CHK
        ,STL_TGT_FLG
        ,STL_TGT_FLG2
        ,STL_CLZ_FLG        
        ,BSA_QTY  
    FROM OUS_TGT3
    ORDER BY VVD_ETD_GROUP, VPS_ETD_DT, LEV, REV_YRMON_SEQ, REV_SEQ ASC        
)
SELECT 
     ROWNUM AS SEQ_NO
    ,REV_YRMON
    ,REV_YRMON_SEQ
    ,REV_SEQ
    ,TRD_CD
    ,CRR_CD
    ,RLANE_CD
    ,RE_DIVR_CD
    ,VSL_CD
    ,SKD_VOY_NO
    ,SKD_DIR_CD
    ,VPS_PORT_CD
    ,YD_CD
    ,CLPT_IND_SEQ
    ,RDR_FLG
    ,VPS_ETD_DT
    ,ACCT_CD
    ,JO_STL_JB_CD
    ,JO_STL_STS_CD
    ,JO_STL_ITM_CD
    ,BSA_QTY
    ,BSA_SLT_PRC
    ,FNL_BSA_QTY
    ,FNL_BSA_SLT_PRC
    ,LOCL_CURR_CD
    ,STL_LOCL_AMT
    ,STL_RMK
    ,JO_STL_TGT_ITM_CD
    ,NULL AS ESTM_STL_AMT
    ,NULL AS ACT_STL_AMT
    ,RF_SCG_STL_TP_CD
    ,LEV
    ,VVD_ETD_GROUP
    ,NVL(ACCT_YRMON,'999912') AS ACCT_YRMON
    ,STL_VVD_SEQ
    ,STL_SEQ
    ,STL_TGT_FLG
    ,STL_TGT_FLG2
    ,STL_CLZ_FLG
    ,REV_DIR_CD
    ,TML
    ,REV_BSA_QTY
    ,REV_BSA_SLT_PRC
    ,REV_ENBL_FLG
    ,NVL(REV_SHW_FLG,'Y') AS REV_SHW_FLG
    ,REV_CRR_CD
    ,N2ND_REV_BSA_QTY
    ,N2ND_REV_BSA_SLT_PRC
    ,N2ND_REV_ENBL_FLG
    ,N2ND_REV_CRR_CD
    ,N3RD_REV_BSA_QTY
    ,N3RD_REV_BSA_SLT_PRC
    ,N3RD_REV_ENBL_FLG
    ,N3RD_REV_CRR_CD
    ,NVL(REV_CHK, 0) REV_CHK
    ,NVL(N2ND_REV_CHK, 0) N2ND_REV_CHK
    ,NVL(N3RD_REV_CHK, 0) N3RD_REV_CHK
FROM OUS_TGT4			]]></sql>
			<params>
				<param name="rev_yrmon_fr" type="12" value="" out="N"/>
				<param name="rev_yrmon_to" type="12" value="" out="N"/>
				<param name="re_divr_cd" type="12" value="" out="N"/>
				<param name="trd_cd" type="12" value="" out="N"/>
				<param name="rlane_cd" type="12" value="" out="N"/>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="jo_crr_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
