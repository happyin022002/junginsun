<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CarrierSettlementProcessDBDAORobSummary5RSQL">
			<desc><![CDATA[Movement에서 POL, Movement POD(Movement에서 POD가 없을 경우, Booking에서 POL이 잘 못 된 경우, Movement에서 날짜 잘 못 된 경우 수정)]]></desc>
			<sql><![CDATA[
WITH PRE_VVD AS (  
	SELECT DISTINCT 
	   VSL_CD
	  ,TURN_SKD_VOY_NO AS SKD_VOY_NO
	  ,TURN_SKD_DIR_CD AS SKD_DIR_CD
	FROM VSK_VSL_PORT_SKD
	WHERE 1=1
	AND LEVEL <= FLOOR(TO_NUMBER('3')/2)
	AND (TURN_SKD_VOY_NO IS NOT NULL OR TURN_SKD_DIR_CD IS NOT NULL) START WITH VSL_CD = SUBSTR(@[in_vvd_cd],1,4)
	AND SKD_VOY_NO = SUBSTR(@[in_vvd_cd],5,4)
	AND SKD_DIR_CD = SUBSTR(@[in_vvd_cd],9,1)
	AND TURN_PORT_IND_CD IN ('Y','N') CONNECT BY PRIOR TURN_SKD_VOY_NO = SKD_VOY_NO
	AND PRIOR TURN_SKD_DIR_CD = SKD_DIR_CD
	AND PRIOR VSL_CD = VSL_CD
	AND TURN_PORT_IND_CD IN ('Y','N')
	AND LEVEL <= FLOOR(TO_NUMBER('3')/2)
)
, NEXT_VOY_NO_CNT AS (  
		SELECT  
		 COUNT(AA.SKD_VOY_NO) AS SKD_VOY_NO_CNT  
		FROM  
		(  
				SELECT         
				A.*  
				FROM  
				(  
					SELECT  
					VSL_CD, SKD_VOY_NO, SKD_DIR_CD, MAX(VPS_ETD_DT) AS VPS_ETD_DT  
					FROM VSK_VSL_PORT_SKD  
					WHERE VSL_CD = SUBSTR(@[in_vvd_cd],1,4)  
					AND SKD_VOY_NO >= SUBSTR(@[in_vvd_cd],5,4)  
					AND TURN_PORT_IND_CD IN ('Y','N')  
					GROUP BY VSL_CD, SKD_VOY_NO, SKD_DIR_CD  
				) A   
				WHERE 1=1  
				AND VPS_ETD_DT >=  ( SELECT MAX(VPS_ETD_DT)   
									  FROM VSK_VSL_PORT_SKD  
									  WHERE VSL_CD = SUBSTR(@[in_vvd_cd],1,4)  
									  AND SKD_VOY_NO = SUBSTR(@[in_vvd_cd],5,4)  
								  )                  
				ORDER BY VPS_ETD_DT ASC  
		) AA  
		WHERE ROWNUM =1   
)   
,NEXT_VOY_NO AS (  
	SELECT CASE WHEN (SELECT SKD_VOY_NO_CNT FROM NEXT_VOY_NO_CNT) > 0 THEN (  
																			   SELECT  
																				 AA.SKD_VOY_NO  
																			   FROM  
																			   (  
																						SELECT         
																						A.*  
																						FROM  
																						(  
																							SELECT  
																							VSL_CD, SKD_VOY_NO, SKD_DIR_CD, MAX(VPS_ETD_DT) AS VPS_ETD_DT  
																							FROM VSK_VSL_PORT_SKD  
																							WHERE VSL_CD = SUBSTR(@[in_vvd_cd],1,4)  
																							AND SKD_VOY_NO >= SUBSTR(@[in_vvd_cd],5,4)  
																							AND TURN_PORT_IND_CD IN ('Y','N')  
																							GROUP BY VSL_CD, SKD_VOY_NO, SKD_DIR_CD  
																						) A   
																						WHERE 1=1  
																						AND VPS_ETD_DT >=  ( SELECT MAX(VPS_ETD_DT)   
																											  FROM VSK_VSL_PORT_SKD  
																											  WHERE VSL_CD = SUBSTR(@[in_vvd_cd],1,4)  
																											  AND SKD_VOY_NO = SUBSTR(@[in_vvd_cd],5,4)  
																										  )                  
																						ORDER BY VPS_ETD_DT ASC  
																				) AA  
																				WHERE ROWNUM =1    
																			)  
																			  
				ELSE SUBSTR(@[in_vvd_cd],5,4)   
				END SKD_VOY_NO  
	FROM DUAL     
)  
, CTM_MOVEMENT2 AS (
    SELECT *
    FROM CTM_MOVEMENT A
    WHERE 1=1
    AND A.CRNT_VSL_CD = SUBSTR(@[in_vvd_cd],1,4)
    AND (A.CRNT_SKD_VOY_NO >= SUBSTR(@[in_vvd_cd],5,4) AND A.CRNT_SKD_VOY_NO <= (SELECT SKD_VOY_NO FROM NEXT_VOY_NO))              
)
, JOO_CNTR_MVMT_EVNT_DT2 AS (
    SELECT J.*
    FROM CTM_MOVEMENT A, JOO_CNTR_MVMT_EVNT_DT J
    WHERE 1=1
    AND A.CRNT_VSL_CD = SUBSTR(@[in_vvd_cd],1,4)
    AND (A.CRNT_SKD_VOY_NO >= SUBSTR(@[in_vvd_cd],5,4) AND A.CRNT_SKD_VOY_NO <= (SELECT SKD_VOY_NO FROM NEXT_VOY_NO))              
    AND A.CNTR_NO = J.CNTR_NO
    AND A.CNMV_YR = J.CNMV_YR
    AND A.CNMV_ID_NO = J.CNMV_ID_NO
)
, CTM_MOVEMENT3 AS (
    SELECT *
    FROM CTM_MOVEMENT A
    WHERE 1=1
    AND A.CRNT_VSL_CD       = (SELECT VSL_CD FROM PRE_VVD)
    AND A.CRNT_SKD_VOY_NO   = (SELECT SKD_VOY_NO FROM PRE_VVD)
    AND A.CRNT_SKD_DIR_CD   = (SELECT SKD_DIR_CD FROM PRE_VVD)
)
, CTM_LIST AS (
        SELECT
		 SUBSTR(@[in_vvd_cd],1,4) 	 AS VSL_CD
		,SUBSTR(@[in_vvd_cd],5,4)    AS	SKD_VOY_NO
		,SUBSTR(@[in_vvd_cd],9,1)  	 AS SKD_DIR_CD    
        ,AA.CNTR_NO
        ,MAX(DECODE(AA.MVMT_STS_CD,'VL',AA.CNTR_TPSZ_CD,'')) AS CNTR_TPSZ_CD
        ,MIN(DECODE(AA.MVMT_STS_CD,'VL',AA.CNMV_EVNT_DT,'')) AS CNMV_EVNT_DT_VL_MIN
        ,NVL(MIN(DECODE(AA.MVMT_STS_CD,'VD',AA.CNMV_EVNT_DT,'')),TO_DATE('999912312359','YYYYMMDDHH24MISS')) AS CNMV_EVNT_DT_VD_MIN
        ,MAX(DECODE(AA.MVMT_STS_CD,'VL',AA.CNMV_EVNT_DT,'')) AS CNMV_EVNT_DT_VL_MAX
        ,NVL(MAX(DECODE(AA.MVMT_STS_CD,'VD',AA.CNMV_EVNT_DT,'')),TO_DATE('999912312359','YYYYMMDDHH24MISS')) AS CNMV_EVNT_DT_VD_MAX
        ,MAX(DECODE(AA.MVMT_STS_CD,'VL',AA.BKG_NO,AA.BKG_NO)) AS BKG_NO
        ,MAX(DECODE(AA.MVMT_STS_CD,'VL',AA.BL_NO,AA.BL_NO)) AS BL_NO         
        ,MIN(DECODE(AA.MVMT_STS_CD,'VL',TO_CHAR(AA.CNMV_EVNT_DT,'YYYYMMDDHH24MISS') || AA.ORG_YD_CD,'')) AS POL2_MIN
        ,MIN(DECODE(AA.MVMT_STS_CD,'VD',TO_CHAR(AA.CNMV_EVNT_DT,'YYYYMMDDHH24MISS') || AA.ORG_YD_CD,'')) AS POD2_MIN    
        ,MAX(DECODE(AA.MVMT_STS_CD,'VL',TO_CHAR(AA.CNMV_EVNT_DT,'YYYYMMDDHH24MISS') || AA.ORG_YD_CD,'')) AS POL2_MAX
        ,MAX(DECODE(AA.MVMT_STS_CD,'VD',TO_CHAR(AA.CNMV_EVNT_DT,'YYYYMMDDHH24MISS') || AA.ORG_YD_CD,'')) AS POD2_MAX    
        ,MAX(AA.CNTR_WGT)       AS CNTR_WGT
        ,MAX(AA.CNTR_VOL_QTY)   AS CNTR_VOL_QTY 
        ,MAX(AA.RCV_TERM_CD)  	AS RCV_TERM_CD 
        ,MAX(AA.DE_TERM_CD)   	AS DE_TERM_CD          
        ,MAX(AA.DCGO_FLG)       AS DCGO_FLG
        ,MAX(AA.RC_FLG)         AS RC_FLG
        ,MAX(AA.AWK_CGO_FLG)    AS AWK_CGO_FLG
        ,MAX(AA.RD_CGO_FLG)     AS RD_CGO_FLG         
        ,MAX(AA.HNGR_FLG)       AS HNGR_FLG       
        FROM
        (
            SELECT   A.CNTR_NO
                    ,A.CNTR_TPSZ_CD
                    ,A.MVMT_STS_CD
                    ,A.CNMV_EVNT_DT
                    ,A.CRNT_VSL_CD
                    ,A.CRNT_SKD_VOY_NO
                    ,A.CRNT_SKD_DIR_CD
			        ,(SELECT BKG.BKG_NO FROM BKG_BOOKING BKG WHERE BKG.BKG_NO = A.BKG_NO AND NVL(BKG.BKG_STS_CD,' ') NOT IN ('X','A')) AS BKG_NO
			        ,(SELECT BKG.BL_NO FROM BKG_BOOKING BKG WHERE BKG.BKG_NO = A.BKG_NO AND NVL(BKG.BKG_STS_CD,' ') NOT IN ('X','A')) AS BL_NO
                    ,A.ORG_YD_CD
                    ,CNTR.CNTR_WGT
                    ,CNTR.CNTR_VOL_QTY     
                    ,CNTR.RCV_TERM_CD
                    ,CNTR.DE_TERM_CD                    
                    ,CNTR.DCGO_FLG
                    ,CNTR.RC_FLG
                    ,CNTR.AWK_CGO_FLG
                    ,CNTR.RD_CGO_FLG
                    ,CNTR.HNGR_FLG  
            FROM 
                (
                    SELECT 
                         A.CNTR_NO
                        ,A.CNTR_TPSZ_CD
                        ,A.MVMT_STS_CD
                        ,DECODE(J.CNMV_DT,NULL,A.CNMV_EVNT_DT,J.CNMV_DT) CNMV_EVNT_DT
                        ,A.CRNT_VSL_CD
                        ,A.CRNT_SKD_VOY_NO
                        ,A.CRNT_SKD_DIR_CD
                        ,CASE WHEN A.LST_BKG_NO IS NULL THEN A.BKG_NO
                            WHEN SUBSTR(A.LST_BKG_NO, 1, 9) != SUBSTR(A.BKG_NO, 1, 9) THEN A.BKG_NO
                         ELSE A.LST_BKG_NO
                         END AS BKG_NO
                        ,A.ORG_YD_CD
                    FROM CTM_MOVEMENT2 A, JOO_CNTR_MVMT_EVNT_DT2 J
                    WHERE 1=1
                    AND A.CNTR_NO = J.CNTR_NO(+)
                    AND A.CNMV_YR = J.CNMV_YR(+)
                    AND A.CNMV_ID_NO = J.CNMV_ID_NO(+)                
                ) A
               , BKG_CONTAINER CNTR
            WHERE 1=1 
	#if (${in_dcgo_flg} == '' && ${in_rc_flg} == '' && ${in_awk_cgo_flg} == '' && ${in_bb_cgo_flg} == '' && ${in_stwg_cd} == '' && ${in_hot_de_flg} == '' && ${in_rd_cgo_flg} == '' && ${in_soc_flg} == '' && ${in_prct_flg} == '' && ${in_hngr_flg} == '')
		AND '1' = '1'
	#else
		AND ( '1' = '2' 
		#if (${in_dcgo_flg} != '' ) 
			OR CNTR.DCGO_FLG = @[in_dcgo_flg]
		#end
		#if (${in_rc_flg} != '' ) 
			OR CNTR.RC_FLG = @[in_rc_flg]
		#end
		#if (${in_awk_cgo_flg} != '' ) 
			OR CNTR.AWK_CGO_FLG = @[in_awk_cgo_flg]
		#end
		#if (${in_bb_cgo_flg} != '' ) 
			OR CNTR.BB_CGO_FLG = @[in_bb_cgo_flg]
		#end
		#if (${in_stwg_cd} != '' ) 
			OR BKG.STWG_CD IS NOT NULL
		#end
		#if (${in_hot_de_flg} != '' ) 
			OR BKG.HOT_DE_FLG = @[in_hot_de_flg]
		#end
		#if (${in_rd_cgo_flg} != '' ) 
			OR CNTR.RD_CGO_FLG = @[in_rd_cgo_flg]
		#end
		#if (${in_soc_flg} != '' ) 
			OR CNTR.SOC_FLG = @[in_soc_flg]
		#end
		#if (${in_prct_flg} != '' ) 
			OR BKG.PRCT_FLG = @[in_prct_flg]
		#end
		#if (${in_hngr_flg} != '' ) 
			OR CNTR.HNGR_FLG = @[in_hngr_flg]
		#end
		)
	#end
            AND A.BKG_NO = CNTR.BKG_NO(+)
            AND A.CNTR_NO = CNTR.CNTR_NO(+)  
            UNION
            SELECT   A.CNTR_NO
                    ,A.CNTR_TPSZ_CD            
                    ,A.MVMT_STS_CD
                    ,A.CNMV_EVNT_DT
                    ,A.CRNT_VSL_CD
                    ,A.CRNT_SKD_VOY_NO
                    ,A.CRNT_SKD_DIR_CD
			        ,(SELECT BKG.BKG_NO FROM BKG_BOOKING BKG WHERE BKG.BKG_NO = A.BKG_NO AND NVL(BKG.BKG_STS_CD,' ') NOT IN ('X','A')) AS BKG_NO
			        ,(SELECT BKG.BL_NO FROM BKG_BOOKING BKG WHERE BKG.BKG_NO = A.BKG_NO AND NVL(BKG.BKG_STS_CD,' ') NOT IN ('X','A')) AS BL_NO
                    ,A.ORG_YD_CD
                    ,CNTR.CNTR_WGT
                    ,CNTR.CNTR_VOL_QTY     
                    ,CNTR.RCV_TERM_CD
                    ,CNTR.DE_TERM_CD                    
                    ,CNTR.DCGO_FLG
                    ,CNTR.RC_FLG
                    ,CNTR.AWK_CGO_FLG
                    ,CNTR.RD_CGO_FLG
                    ,CNTR.HNGR_FLG  
            FROM 
                (
                    SELECT 
                         A.CNTR_NO
                        ,A.CNTR_TPSZ_CD
                        ,A.MVMT_STS_CD
                        ,DECODE(J.CNMV_DT,NULL,A.CNMV_EVNT_DT,J.CNMV_DT) CNMV_EVNT_DT
                        ,A.CRNT_VSL_CD
                        ,A.CRNT_SKD_VOY_NO
                        ,A.CRNT_SKD_DIR_CD
                        ,CASE WHEN A.LST_BKG_NO IS NULL THEN A.BKG_NO
                            WHEN SUBSTR(A.LST_BKG_NO, 1, 9) != SUBSTR(A.BKG_NO, 1, 9) THEN A.BKG_NO
                         ELSE A.LST_BKG_NO
                         END AS BKG_NO
                        ,A.ORG_YD_CD
                    FROM CTM_MOVEMENT3 A, JOO_CNTR_MVMT_EVNT_DT2 J
                    WHERE 1=1
                    AND A.CNTR_NO    = J.CNTR_NO(+)
                    AND A.CNMV_YR    = J.CNMV_YR(+)
                    AND A.CNMV_ID_NO = J.CNMV_ID_NO(+)                
                ) A            
                , BKG_CONTAINER CNTR
            WHERE 1=1
	#if (${in_dcgo_flg} == '' && ${in_rc_flg} == '' && ${in_awk_cgo_flg} == '' && ${in_bb_cgo_flg} == '' && ${in_stwg_cd} == '' && ${in_hot_de_flg} == '' && ${in_rd_cgo_flg} == '' && ${in_soc_flg} == '' && ${in_prct_flg} == '' && ${in_hngr_flg} == '')
		AND '1' = '1'
	#else
		AND ( '1' = '2' 
		#if (${in_dcgo_flg} != '' ) 
			OR CNTR.DCGO_FLG = @[in_dcgo_flg]
		#end
		#if (${in_rc_flg} != '' ) 
			OR CNTR.RC_FLG = @[in_rc_flg]
		#end
		#if (${in_awk_cgo_flg} != '' ) 
			OR CNTR.AWK_CGO_FLG = @[in_awk_cgo_flg]
		#end
		#if (${in_bb_cgo_flg} != '' ) 
			OR CNTR.BB_CGO_FLG = @[in_bb_cgo_flg]
		#end
		#if (${in_stwg_cd} != '' ) 
			OR BKG.STWG_CD IS NOT NULL
		#end
		#if (${in_hot_de_flg} != '' ) 
			OR BKG.HOT_DE_FLG = @[in_hot_de_flg]
		#end
		#if (${in_rd_cgo_flg} != '' ) 
			OR CNTR.RD_CGO_FLG = @[in_rd_cgo_flg]
		#end
		#if (${in_soc_flg} != '' ) 
			OR CNTR.SOC_FLG = @[in_soc_flg]
		#end
		#if (${in_prct_flg} != '' ) 
			OR BKG.PRCT_FLG = @[in_prct_flg]
		#end
		#if (${in_hngr_flg} != '' ) 
			OR CNTR.HNGR_FLG = @[in_hngr_flg]
		#end
		)
	#end
            AND A.BKG_NO = CNTR.BKG_NO(+)
            AND A.CNTR_NO = CNTR.CNTR_NO(+)    
        ) AA    
        GROUP BY AA.CNTR_NO
)      
,VPS_ETD AS (
	SELECT T1.VPS_ETD_DT
	FROM VSK_VSL_PORT_SKD T1
	WHERE 1=1
	AND T1.VSL_CD     = SUBSTR(@[in_vvd_cd],1,4)
	AND T1.SKD_VOY_NO = SUBSTR(@[in_vvd_cd],5,4)
	AND T1.SKD_DIR_CD = SUBSTR(@[in_vvd_cd],9,1)  
	AND T1.VPS_PORT_CD = @[in_pol_cd]
	AND T1.CLPT_IND_SEQ = @[pol_split_no]
	AND T1.YD_CD = @[in_pol_cd] || @[in_pol_yd_cd]
)
,CTM_LIST1 AS (
    SELECT 
     C.VSL_CD
    ,C.SKD_VOY_NO
    ,C.SKD_DIR_CD
    ,C.CNTR_NO
    ,C.CNTR_TPSZ_CD
    ,C.BKG_NO
    ,C.BL_NO
    ,CASE WHEN (SELECT VPS_ETD_DT FROM VPS_ETD) > CNMV_EVNT_DT_VL_MIN AND (SELECT VPS_ETD_DT FROM VPS_ETD) < CNMV_EVNT_DT_VD_MIN THEN POL2_MIN
          WHEN (SELECT VPS_ETD_DT FROM VPS_ETD) > CNMV_EVNT_DT_VL_MAX AND (SELECT VPS_ETD_DT FROM VPS_ETD) < CNMV_EVNT_DT_VD_MAX THEN POL2_MAX
          ELSE POL2_MIN
          END POL2
    ,CASE WHEN (SELECT VPS_ETD_DT FROM VPS_ETD) > CNMV_EVNT_DT_VL_MIN AND (SELECT VPS_ETD_DT FROM VPS_ETD) < CNMV_EVNT_DT_VD_MIN THEN POD2_MIN
          WHEN (SELECT VPS_ETD_DT FROM VPS_ETD) > CNMV_EVNT_DT_VL_MAX AND (SELECT VPS_ETD_DT FROM VPS_ETD) < CNMV_EVNT_DT_VD_MAX THEN POD2_MAX
          ELSE POD2_MIN
          END POD2  
    ,C.CNTR_WGT
    ,C.CNTR_VOL_QTY     
    ,C.RCV_TERM_CD
    ,C.DE_TERM_CD                    
    ,C.DCGO_FLG
    ,C.RC_FLG
    ,C.AWK_CGO_FLG
    ,C.RD_CGO_FLG
    ,C.HNGR_FLG 
    ,CASE WHEN (SELECT VPS_ETD_DT FROM VPS_ETD) > CNMV_EVNT_DT_VL_MIN AND (SELECT VPS_ETD_DT FROM VPS_ETD) < CNMV_EVNT_DT_VD_MIN THEN CNMV_EVNT_DT_VL_MIN
          WHEN (SELECT VPS_ETD_DT FROM VPS_ETD) > CNMV_EVNT_DT_VL_MAX AND (SELECT VPS_ETD_DT FROM VPS_ETD) < CNMV_EVNT_DT_VD_MAX THEN CNMV_EVNT_DT_VL_MAX
          ELSE CNMV_EVNT_DT_VL_MIN
          END CNMV_EVNT_DT_VL
    ,CASE WHEN (SELECT VPS_ETD_DT FROM VPS_ETD) > CNMV_EVNT_DT_VL_MIN AND (SELECT VPS_ETD_DT FROM VPS_ETD) < CNMV_EVNT_DT_VD_MIN THEN CNMV_EVNT_DT_VD_MIN
          WHEN (SELECT VPS_ETD_DT FROM VPS_ETD) > CNMV_EVNT_DT_VL_MAX AND (SELECT VPS_ETD_DT FROM VPS_ETD) < CNMV_EVNT_DT_VD_MAX THEN CNMV_EVNT_DT_VD_MAX
          ELSE CNMV_EVNT_DT_VL_MIN
          END CNMV_EVNT_DT_VD     
    FROM CTM_LIST C
) 
, CTM_LIST2 AS (
    SELECT  C.*
			,SUBSTR(C.POL2,15,7) AS POL
			,SUBSTR(C.POD2,15,7) AS POD
    FROM CTM_LIST1 C
    WHERE 1=1
    AND TO_NUMBER(TO_CHAR(C.CNMV_EVNT_DT_VL,'YYYYMMDDHH24MISS')) <= TO_NUMBER((SELECT TO_CHAR(VPS_ETD_DT,'YYYYMMDDHH24MISS') FROM VPS_ETD))  
    AND TO_NUMBER(TO_CHAR(C.CNMV_EVNT_DT_VD,'YYYYMMDDHH24MISS')) >= TO_NUMBER((SELECT TO_CHAR(VPS_ETD_DT,'YYYYMMDDHH24MISS') FROM VPS_ETD))   
) 
, CTM_LIST3 AS (
SELECT 
  C.VSL_CD
 ,C.SKD_VOY_NO
 ,C.SKD_DIR_CD
 ,C.CNTR_NO
 ,C.CNTR_TPSZ_CD
 ,C.CNMV_EVNT_DT_VL
 ,C.CNMV_EVNT_DT_VD
 ,C.BKG_NO
 ,C.BL_NO
 ,C.POL
 ,C.POD
 ,C.CNTR_WGT
 ,C.CNTR_VOL_QTY
 ,C.RCV_TERM_CD
 ,C.DE_TERM_CD
 ,C.DCGO_FLG
 ,C.RC_FLG
 ,C.AWK_CGO_FLG
 ,C.RD_CGO_FLG
 ,C.HNGR_FLG
    ,MAX(CASE WHEN TO_NUMBER(TO_CHAR(C.CNMV_EVNT_DT_VL,'YYYYMMDDHH24MISS')) >= TO_NUMBER(TO_CHAR(V.VPS_ETA_DT,'YYYYMMDDHH24MISS')) AND 
                   TO_NUMBER(TO_CHAR(C.CNMV_EVNT_DT_VL,'YYYYMMDDHH24MISS')) <= TO_NUMBER(TO_CHAR(V.VPS_ETD_DT,'YYYYMMDDHH24MISS')) 
      THEN V.CLPT_IND_SEQ
      ELSE '0'
      END) AS POL_CLPT_IND_SEQ 
FROM CTM_LIST2 C, VSK_VSL_PORT_SKD V
WHERE 1=1
AND C.VSL_CD = V.VSL_CD(+)
AND C.SKD_VOY_NO = V.SKD_VOY_NO(+)
AND C.SKD_DIR_CD = V.SKD_DIR_CD(+) 
AND C.POL = V.YD_CD(+)
GROUP BY
  C.VSL_CD
 ,C.SKD_VOY_NO
 ,C.SKD_DIR_CD
 ,C.CNTR_NO
 ,C.CNTR_TPSZ_CD
 ,C.CNMV_EVNT_DT_VL
 ,C.CNMV_EVNT_DT_VD
 ,C.BKG_NO
 ,C.BL_NO
 ,C.POL
 ,C.POD
 ,C.CNTR_WGT
 ,C.CNTR_VOL_QTY
 ,C.RCV_TERM_CD
 ,C.DE_TERM_CD
 ,C.DCGO_FLG
 ,C.RC_FLG
 ,C.AWK_CGO_FLG
 ,C.RD_CGO_FLG
 ,C.HNGR_FLG
)
, ROB_LIST AS (
	SELECT	
		CNTR_NO, 
		CNTR_TPSZ_CD, 
		CNTR_WGT, 
		TO_CHAR(A_CNTR_WGT,'9,999,990.000') A_CNTR_WGT,
		ROUND((round(nvl(ACT_WGT, 0) * decode(substr(CNTR_TPSZ_CD, 2, 1), '2', 1, 2) / TOT, 2) + 
        NVL(CNTR_VOL_QTY, 1) * DECODE(NVL(MST_TARE,0), 0, DECODE(NVL(MDM_TARE,0), 0, 0, MDM_TARE), MST_TARE))/1000, 2) E_CNTR_WGT,
		POL_CD,
		POL_YD_CD,
		POD_CD,
		POD_YD_CD,        
		A_POL_CD, 
		POL_NOD_CD,
		A_POD_CD,    
		POD_NOD_CD,    
		RCV_TERM_CD,
		DE_TERM_CD,
		TS_CD,	
		BKG_CGO_TP_CD,
		HOT_DE_FLG,
		'' SPCL_CGO_DESC_TYPE,
		'' SPCL_CGO_DESC
		,SLAN_CD
		,DCGO_FLG
		,RC_FLG
		,AWK_CGO_FLG
		,PRCT_FLG
		,RD_CGO_FLG
		,HNGR_FLG    
		,VVD_CD
		,BKG_NO
		,POL_YD_CD2
        ,POD_YD_CD2 
        ,POL_CLPT_IND_SEQ         
   	    ,POD_CLPT_IND_SEQ    
	FROM (
            SELECT      
                 CTM.CNTR_NO
                ,CTM.CNTR_TPSZ_CD            
                ,CTM.CNTR_WGT  A_CNTR_WGT
                ,ROUND(CTM.CNTR_WGT/1000,0) CNTR_WGT
                ,DOC.ACT_WGT
                ,(
                    SELECT SUM(DECODE(SUBSTR(CNTR_TPSZ_CD,2,1),'2',1,2)) TOT 
                    FROM BKG_CONTAINER BC
                    WHERE BC.BKG_NO = BKG.BKG_NO
                ) TOT
                ,DECODE(NVL(CTM.CNTR_VOL_QTY, 0), 0, 1, CTM.CNTR_VOL_QTY) CNTR_VOL_QTY   
                ,(SELECT NVL(SPEC.TARE_WGT, 0) MST_WGT
			      FROM MST_CONTAINER MST,
				       MST_CNTR_SPEC SPEC
			      WHERE MST.CNTR_NO = CTM.CNTR_NO
			      AND MST.CNTR_SPEC_NO = SPEC.CNTR_SPEC_NO ) MST_TARE
		        ,(SELECT NVL(MDM.CNTR_TPSZ_TARE_WGT, 0) MDM_WGT
                  FROM MDM_CNTR_TP_SZ MDM         
                  WHERE MDM.CNTR_TPSZ_CD = CTM.CNTR_TPSZ_CD  
			    ) MDM_TARE            
                ,SUBSTR(CTM.POL,1,5) AS POL_CD
                ,SUBSTR(CTM.POL,6,2) AS POL_YD_CD
                ,SUBSTR(CTM.POD,1,5) AS POD_CD
                ,SUBSTR(CTM.POD,6,2) AS POD_YD_CD                        
                ,'' AS A_POL_CD     /* BKG */      
                ,'' AS POL_NOD_CD   /* BKG */      
                ,'' AS A_POD_CD     /* BKG */      
                ,'' AS POD_NOD_CD   /* BKG */          
                ,CTM.RCV_TERM_CD        
                ,CTM.DE_TERM_CD        
                ,DECODE(BKG.POL_CD,SUBSTR(CTM.POL,1,5),'L','T') TS_CD 
                ,BKG.BKG_CGO_TP_CD
                ,BKG.HOT_DE_FLG        
				,(	SELECT SLAN_CD FROM BKG_VVD B
					WHERE 1=1
					AND B.VSL_CD = CTM.VSL_CD
					AND B.SKD_VOY_NO = CTM.SKD_VOY_NO
					AND B.SKD_DIR_CD = CTM.SKD_DIR_CD
					AND ROWNUM = 1						
				  ) AS SLAN_CD
                ,CTM.DCGO_FLG
                ,CTM.RC_FLG
                ,CTM.AWK_CGO_FLG
                ,BKG.PRCT_FLG   
                ,CTM.RD_CGO_FLG RD_CGO_FLG         
                ,CTM.HNGR_FLG
                ,'' AS VVD_CD                 
                ,CTM.BKG_NO
                ,CTM.POL AS POL_YD_CD2  
                ,CTM.POD AS POD_YD_CD2
                ,CTM.BL_NO
                ,'' AS VSL_SEQ 
                ,CTM.POL_CLPT_IND_SEQ 
                ,'' AS POD_CLPT_IND_SEQ  
                ,CTM.CNMV_EVNT_DT_VL
                ,CTM.CNMV_EVNT_DT_VD
            FROM     CTM_LIST3 CTM
                    ,BKG_BOOKING BKG
                    ,BKG_BL_DOC DOC
                    ,MDM_LOCATION MDM        
            WHERE 1=1
            AND CTM.BKG_NO = BKG.BKG_NO
            AND BKG.BKG_STS_CD  <> 'S'	    
            AND CTM.BKG_NO = DOC.BKG_NO	
            AND NVL(BKG.BKG_STS_CD,' ') NOT IN ('X','A')	
            AND MDM.LOC_CD = BKG.DEL_CD    
	) TB1
)
, ROB_LIST2 AS (
SELECT 
     CNTR_NO
    ,SUM(E_CNTR_WGT)    AS E_CNTR_WGT		/* E.WGT(T) SUM */
    ,MAX(CNTR_TPSZ_CD)  AS CNTR_TPSZ_CD
    ,MAX(BKG_CGO_TP_CD) AS BKG_CGO_TP_CD
    ,MAX(AWK_CGO_FLG)   AS AWK_CGO_FLG    
    ,MAX(POL_CD)	    AS POL_CD
    ,MAX(POL_YD_CD)	    AS POL_YD_CD  
    ,MAX(POL_CLPT_IND_SEQ)	    AS POL_CLPT_IND_SEQ  
    ,MAX(RC_FLG)        AS RC_FLG
    ,MAX(DCGO_FLG)      AS DCGO_FLG
    ,MAX(SLAN_CD)       AS SLAN_CD
FROM ROB_LIST R
GROUP BY CNTR_NO
)
, NEXT_VVD AS (
SELECT
     AA.VSL_CD
    ,AA.SKD_VOY_NO
    ,AA.SKD_DIR_CD
    FROM
    (
            SELECT       
            A.*
            FROM
            (
                SELECT
                VSL_CD, SKD_VOY_NO, SKD_DIR_CD, MAX(VPS_ETD_DT) AS VPS_ETD_DT
                FROM VSK_VSL_PORT_SKD
                WHERE VSL_CD = SUBSTR(@[in_vvd_cd],1,4)
                AND SKD_VOY_NO >= SUBSTR(@[in_vvd_cd],5,4)
                AND TURN_PORT_IND_CD IN ('Y','N')
                GROUP BY VSL_CD, SKD_VOY_NO, SKD_DIR_CD
            ) A 
            WHERE 1=1
            AND VPS_ETD_DT >  ( SELECT MAX(VPS_ETD_DT) 
                                  FROM VSK_VSL_PORT_SKD
                                  WHERE VSL_CD = SUBSTR(@[in_vvd_cd],1,4)
                                  AND SKD_VOY_NO = SUBSTR(@[in_vvd_cd],5,4)
                                  AND SKD_DIR_CD = SUBSTR(@[in_vvd_cd],9,1)
                              )                
            ORDER BY VPS_ETD_DT ASC
    ) AA
    WHERE ROWNUM =1    
), CTM AS (
    SELECT *
    FROM CTM_MOVEMENT A  
    WHERE 1=1
    AND A.MVMT_STS_CD IN ('VL','VD')
    AND (
            (  A.CRNT_VSL_CD = (SELECT VSL_CD FROM PRE_VVD) AND A.CRNT_SKD_VOY_NO = (SELECT SKD_VOY_NO FROM PRE_VVD) AND A.CRNT_SKD_DIR_CD = (SELECT SKD_DIR_CD FROM PRE_VVD) )
            OR
            (  A.CRNT_VSL_CD = SUBSTR(@[in_vvd_cd],1,4) AND A.CRNT_SKD_VOY_NO = SUBSTR(@[in_vvd_cd],5,4) AND A.CRNT_SKD_DIR_CD = SUBSTR(@[in_vvd_cd],9,1) )        
            OR        
            (  A.CRNT_VSL_CD = (SELECT VSL_CD FROM NEXT_VVD) AND A.CRNT_SKD_VOY_NO = (SELECT SKD_VOY_NO FROM NEXT_VVD) AND A.CRNT_SKD_DIR_CD = (SELECT SKD_DIR_CD FROM NEXT_VVD) )
        )  
), MVMT_DT AS (
    SELECT
     AA.CNTR_NO, CNMV_YR, CNMV_ID_NO, MVMT_STS_CD, CNMV_EVNT_DT, ORG_YD_CD, CRNT_VSL_CD, CRNT_SKD_VOY_NO, CRNT_SKD_DIR_CD     
    ,MAX(CLPT_IND_SEQ2) AS CLPT_IND_SEQ2
    ,MAX(CLPT_IND_SEQ3) AS CLPT_IND_SEQ3
    ,MAX(CNMV_DT) AS CNMV_DT
    FROM
    (
        SELECT 
             A.CNTR_NO
            ,A.CNMV_YR
            ,A.CNMV_ID_NO
            ,A.MVMT_STS_CD
            ,A.CNMV_EVNT_DT
            ,A.ORG_YD_CD
            ,A.CRNT_VSL_CD
            ,A.CRNT_SKD_VOY_NO
            ,A.CRNT_SKD_DIR_CD
            ,V.VPS_ETA_DT     
            ,V.VPS_ETD_DT
            ,V.CLPT_IND_SEQ
            ,V.YD_CD        
            ,(  CASE WHEN TO_NUMBER(TO_CHAR(A.CNMV_EVNT_DT,'YYYYMMDDHH24MISS')) >= TO_NUMBER(TO_CHAR(V.VPS_ETA_DT,'YYYYMMDDHH24MISS'))    AND 
                          TO_NUMBER(TO_CHAR(A.CNMV_EVNT_DT,'YYYYMMDDHH24MISS')) <= TO_NUMBER(TO_CHAR(V.VPS_ETD_DT,'YYYYMMDDHH24MISS')) 
                     THEN V.CLPT_IND_SEQ
                     ELSE '0'
                     END 
             ) CLPT_IND_SEQ2            
            ,J.CLPT_IND_SEQ AS CLPT_IND_SEQ3
            ,J.CNMV_DT
        FROM CTM A, VSK_VSL_PORT_SKD V, JOO_CNTR_MVMT_EVNT_DT J
        WHERE 1=1 
        AND A.CNTR_NO = J.CNTR_NO(+)
        AND A.CNMV_YR = J.CNMV_YR(+)
        AND A.CNMV_ID_NO = J.CNMV_ID_NO(+)    
        AND V.VSL_CD = A.CRNT_VSL_CD
        AND V.SKD_VOY_NO = A.CRNT_SKD_VOY_NO
        AND V.SKD_DIR_CD = A.CRNT_SKD_DIR_CD
        AND V.VPS_PORT_CD = SUBSTR(A.ORG_YD_CD,1,5)
        AND V.YD_CD = A.ORG_YD_CD     
		     ) AA
     WHERE 1=1
     GROUP BY CNTR_NO, CNMV_YR, CNMV_ID_NO, MVMT_STS_CD, CNMV_EVNT_DT, ORG_YD_CD, CRNT_VSL_CD, CRNT_SKD_VOY_NO, CRNT_SKD_DIR_CD
), MVMT_DT2 AS (  
    SELECT DISTINCT
         A.CNTR_NO
        ,A.CNMV_YR
        ,A.CNMV_ID_NO
        ,A.MVMT_STS_CD
        ,A.CNMV_EVNT_DT
        ,A.ORG_YD_CD
        ,A.CRNT_VSL_CD
        ,A.CRNT_SKD_VOY_NO
        ,A.CRNT_SKD_DIR_CD
        ,A.CLPT_IND_SEQ2
        ,A.CLPT_IND_SEQ3
        ,DECODE(A.CLPT_IND_SEQ2,'0',CNMV_DT,A.CNMV_EVNT_DT) AS CNMV_DT
    FROM MVMT_DT A
)
, MVMT_DT3 AS (
    SELECT CASE WHEN COUNT(1) = 0 THEN 'P'
                ELSE 'NP'
                END PASS
    FROM MVMT_DT2 M
    WHERE M.CNMV_DT IS NULL
)
SELECT
     '1' AS sub_chk
    ,JR.JO_BSA_TEU_QTY   AS ALL_TEU
    ,JR.CGO_TON_WGT      AS ALL_WGT
    ,'IST'  AS source
    ,JR.jo_20ft_sub_teu_qty   
    ,JR.jo_20ft_n1st_rto   
    ,JR.jo_40ft_sub_teu_qty   
    ,JR.jo_40ft_n1st_rto   
    ,JR.jo_45ft_sub_teu_qty   
    ,JR.Jo_45ft_n1st_rto   
    ,JR.jo_45ft_n2nd_rto       
    ,JR.jo_rnd_rule_lvl   
    ,JR.JO_TON_TEU_QTY AS teu_qty
    ,R.*
    ,NVL((
        SELECT SUM(B.OVR_VOID_SLT_QTY)
        FROM   BKG_AWK_CGO B
        WHERE 1=1
        AND B.BKG_NO IN (SELECT BKG_NO FROM ROB_LIST)   
    ),0)*2 AS ak_void  
    ,(SELECT PASS FROM MVMT_DT3) AS PASS    
FROM
(
    SELECT 
         SUM(E_CNTR_WGT)  AS GRAND_TTL_WGT
		,SUM(
		CASE WHEN INSTR(R.CNTR_TPSZ_CD,'2') >0 AND (R.BKG_CGO_TP_CD='A' OR R.BKG_CGO_TP_CD='B' OR R.BKG_CGO_TP_CD='F') THEN 1 
		     WHEN INSTR(R.CNTR_TPSZ_CD,'2') >0 AND (R.BKG_CGO_TP_CD='P' OR R.BKG_CGO_TP_CD='R') THEN 0
		     ELSE 0 END                                     
		) AS full_20
		,SUM(
		CASE WHEN INSTR(R.CNTR_TPSZ_CD,'2') >0 AND (R.BKG_CGO_TP_CD='A' OR R.BKG_CGO_TP_CD='B' OR R.BKG_CGO_TP_CD='F') THEN 0
		     WHEN INSTR(R.CNTR_TPSZ_CD,'2') >0 AND (R.BKG_CGO_TP_CD='P' OR R.BKG_CGO_TP_CD='R') THEN 1
		     ELSE 0 END                                                                 
		) AS mt_20
		,SUM(
		CASE WHEN INSTR(R.CNTR_TPSZ_CD,'4') >0 AND (R.BKG_CGO_TP_CD='A' OR R.BKG_CGO_TP_CD='B' OR R.BKG_CGO_TP_CD='F') THEN 1 
		     WHEN INSTR(R.CNTR_TPSZ_CD,'4') >0 AND (R.BKG_CGO_TP_CD='P' OR R.BKG_CGO_TP_CD='R') THEN 0
		     ELSE 0 END                                                                 
		) AS full_40
		,SUM(
		CASE WHEN INSTR(R.CNTR_TPSZ_CD,'4') >0 AND (R.BKG_CGO_TP_CD='A' OR R.BKG_CGO_TP_CD='B' OR R.BKG_CGO_TP_CD='F') THEN 0
		     WHEN INSTR(R.CNTR_TPSZ_CD,'4') >0 AND (R.BKG_CGO_TP_CD='P' OR R.BKG_CGO_TP_CD='R') THEN 1
		     ELSE 0 END                                                                 
		) AS mt_40    
		,SUM(
		CASE WHEN INSTR(R.CNTR_TPSZ_CD,'3') >0 AND (R.BKG_CGO_TP_CD='A' OR R.BKG_CGO_TP_CD='B' OR R.BKG_CGO_TP_CD='F') THEN 1 
		     WHEN INSTR(R.CNTR_TPSZ_CD,'3') >0 AND (R.BKG_CGO_TP_CD='P' OR R.BKG_CGO_TP_CD='R') THEN 0
		     ELSE 0 END                                                                 
		) AS hc_ld_20    
		,SUM(
		CASE WHEN INSTR(R.CNTR_TPSZ_CD,'3') >0 AND (R.BKG_CGO_TP_CD='A' OR R.BKG_CGO_TP_CD='B' OR R.BKG_CGO_TP_CD='F') THEN 0 
		     WHEN INSTR(R.CNTR_TPSZ_CD,'3') >0 AND (R.BKG_CGO_TP_CD='P' OR R.BKG_CGO_TP_CD='R') THEN 1
		     ELSE 0 END                                                                 
		) AS hc_bsa_20        
		,SUM(
		CASE WHEN INSTR(R.CNTR_TPSZ_CD,'5') >0 AND (R.BKG_CGO_TP_CD='A' OR R.BKG_CGO_TP_CD='B' OR R.BKG_CGO_TP_CD='F') THEN 1 
		     WHEN INSTR(R.CNTR_TPSZ_CD,'5') >0 AND (R.BKG_CGO_TP_CD='P' OR R.BKG_CGO_TP_CD='R') THEN 0
             WHEN INSTR(R.CNTR_TPSZ_CD,'9') >0 AND (R.BKG_CGO_TP_CD='A' OR R.BKG_CGO_TP_CD='B' OR R.BKG_CGO_TP_CD='F') THEN 1 
             WHEN INSTR(R.CNTR_TPSZ_CD,'9') >0 AND (R.BKG_CGO_TP_CD='P' OR R.BKG_CGO_TP_CD='R') THEN 0
		     ELSE 0 END                                                                 
		) AS hc_ld_40
		,SUM(
		CASE WHEN INSTR(R.CNTR_TPSZ_CD,'5') >0 AND (R.BKG_CGO_TP_CD='A' OR R.BKG_CGO_TP_CD='B' OR R.BKG_CGO_TP_CD='F') THEN 0
		     WHEN INSTR(R.CNTR_TPSZ_CD,'5') >0 AND (R.BKG_CGO_TP_CD='P' OR R.BKG_CGO_TP_CD='R') THEN 1
             WHEN INSTR(R.CNTR_TPSZ_CD,'9') >0 AND (R.BKG_CGO_TP_CD='A' OR R.BKG_CGO_TP_CD='B' OR R.BKG_CGO_TP_CD='F') THEN 0
		     WHEN INSTR(R.CNTR_TPSZ_CD,'9') >0 AND (R.BKG_CGO_TP_CD='P' OR R.BKG_CGO_TP_CD='R') THEN 1             
		     ELSE 0 END                                                                 
		) AS hc_bsa_40            
		,SUM(
		CASE WHEN INSTR(R.CNTR_TPSZ_CD,'7') >0 AND (R.BKG_CGO_TP_CD='A' OR R.BKG_CGO_TP_CD='B' OR R.BKG_CGO_TP_CD='F') THEN 1 
		     WHEN INSTR(R.CNTR_TPSZ_CD,'7') >0 AND (R.BKG_CGO_TP_CD='P' OR R.BKG_CGO_TP_CD='R') THEN 0
		     ELSE 0 END                                                                 
		) AS hc_ld_45    
		,SUM(
		CASE WHEN INSTR(R.CNTR_TPSZ_CD,'7') >0 AND (R.BKG_CGO_TP_CD='A' OR R.BKG_CGO_TP_CD='B' OR R.BKG_CGO_TP_CD='F') THEN 0
		     WHEN INSTR(R.CNTR_TPSZ_CD,'7') >0 AND (R.BKG_CGO_TP_CD='P' OR R.BKG_CGO_TP_CD='R') THEN 1
		     ELSE 0 END                                                                 
		) AS hc_bsa_45     
        ,SUM(DECODE(R.AWK_CGO_FLG,'Y',1,0)) AS ak_unit
        --,'0' AS ak_void
        ,SUM(
            CASE WHEN INSTR(R.CNTR_TPSZ_CD, '2') > 0 AND DECODE(R.POL_CD || R.RC_FLG,@[in_pol_cd] || 'Y',1,0) = 1 THEN 1
            ELSE 0 END
         ) 	AS rf_20_qty
        ,SUM(
            CASE WHEN INSTR(R.CNTR_TPSZ_CD, '2') = 0 AND DECODE(R.POL_CD || R.RC_FLG,@[in_pol_cd] || 'Y',1,0) = 1 THEN 1
            ELSE 0 END
         ) 	AS rf_40_qty
	    ,SUM(
            CASE WHEN INSTR(R.CNTR_TPSZ_CD, '2') > 0 AND DECODE(R.RC_FLG,'Y',1,0) = 1 THEN 1
            ELSE 0 END
         ) AS rf_rdr_20
	    ,SUM(
            CASE WHEN INSTR(R.CNTR_TPSZ_CD, '2') = 0 AND DECODE(R.RC_FLG,'Y',1,0) = 1 THEN 1
            ELSE 0 END
        ) AS rf_rdr_40
        ,SUM(
            CASE WHEN INSTR(R.CNTR_TPSZ_CD, '2') > 0 AND DECODE(R.POL_CD || R.DCGO_FLG,@[in_pol_cd] || 'Y',1,0) = 1 THEN 1
            ELSE 0 END
         ) 	AS dg_20
        ,SUM(
            CASE WHEN INSTR(R.CNTR_TPSZ_CD, '2') = 0 AND DECODE(R.POL_CD || R.DCGO_FLG,@[in_pol_cd] || 'Y',1,0) = 1 THEN 1
            ELSE 0 END
         ) 	AS dg_40
        ,'0' AS mt_teu
        ,'0' AS mt_wt   
        ,R.SLAN_CD
    FROM ROB_LIST2 R
    GROUP BY R.SLAN_CD
) R, (SELECT * FROM JOO_ROB_RTO WHERE SKD_DIR_CD = SUBSTR(@[in_vvd_cd],9,1)) JR
WHERE 1=1
AND R.SLAN_CD = JR.SLAN_CD			]]></sql>
			<params>
				<param name="in_vvd_cd" type="12" value="" out="N"/>
				<param name="in_dcgo_flg" type="12" value="" out="N"/>
				<param name="in_rc_flg" type="12" value="" out="N"/>
				<param name="in_awk_cgo_flg" type="12" value="" out="N"/>
				<param name="in_bb_cgo_flg" type="12" value="" out="N"/>
				<param name="in_hot_de_flg" type="12" value="" out="N"/>
				<param name="in_rd_cgo_flg" type="12" value="" out="N"/>
				<param name="in_soc_flg" type="12" value="" out="N"/>
				<param name="in_prct_flg" type="12" value="" out="N"/>
				<param name="in_hngr_flg" type="12" value="" out="N"/>
				<param name="in_pol_cd" type="12" value="" out="N"/>
				<param name="pol_split_no" type="12" value="" out="N"/>
				<param name="in_pol_yd_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
