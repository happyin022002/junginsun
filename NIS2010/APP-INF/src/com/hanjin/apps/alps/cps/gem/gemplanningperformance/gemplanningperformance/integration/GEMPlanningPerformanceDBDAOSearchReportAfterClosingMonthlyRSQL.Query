<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="GEMPlanningPerformanceDBDAOSearchReportAfterClosingMonthlyRSQL">
			<desc><![CDATA[조회 대상/기간에 대하여 월별 배정 비용 리포트-해외배정비용현황 송부 참조용 Report]]></desc>
			<sql><![CDATA[
SELECT RSLT_YRMON
      ,DECODE(SUBSTR(RSLT_YRMON,5,2),'01','Jan','02','Feb','03','Mar','04','Apr','05','May','06','Jun','07','Jul','08','Aug','09','Sep','10','Oct','11','Nov','12','Dec')||'-'||SUBSTR(RSLT_YRMON,3,2) RSLT_YRMON01
      ,L_3
      ,OFC_CD
      ,LOCL_CURR_CD
      ,USD_LOCL_XCH_RT
      ,LCL_SAL
      ,LCL_NON_SAL
      ,USD_SAL
      ,USD_NON_SAL
  FROM (
        SELECT A.RSLT_YRMON      
              ,B.PRNT_OFC_CD AS L_3
              ,A.OFC_CD
              ,B.LOCL_CURR_CD
              ,MAX(C.USD_LOCL_XCH_RT) AS USD_LOCL_XCH_RT
              ,SUM(DECODE(D.SALY_FLG, 'Y', A.GEN_EXPN_INIT_AMT/B.RQST_UT_VAL, 0)) + SUM(DECODE(D.SALY_FLG, 'Y', A.GEN_EXPN_ADD_AMT/B.RQST_UT_VAL, 0)) + SUM(DECODE(D.SALY_FLG, 'Y', A.GEN_EXPN_TRNS_AMT/B.RQST_UT_VAL, 0)) AS LCL_SAL
              ,SUM(DECODE(D.SALY_FLG, 'N', A.GEN_EXPN_INIT_AMT/B.RQST_UT_VAL, 0)) + SUM(DECODE(D.SALY_FLG, 'N', A.GEN_EXPN_ADD_AMT/B.RQST_UT_VAL, 0)) + SUM(DECODE(D.SALY_FLG, 'N', A.GEN_EXPN_TRNS_AMT/B.RQST_UT_VAL, 0)) AS LCL_NON_SAL
              ,SUM(DECODE(D.SALY_FLG, 'Y', A.GEN_EXPN_INIT_AMT/C.USD_LOCL_XCH_RT, 0)) + SUM(DECODE(D.SALY_FLG, 'Y', A.GEN_EXPN_ADD_AMT/C.USD_LOCL_XCH_RT, 0)) + SUM(DECODE(D.SALY_FLG, 'Y', A.GEN_EXPN_TRNS_AMT/C.USD_LOCL_XCH_RT, 0)) AS USD_SAL
              ,SUM(DECODE(D.SALY_FLG, 'N', A.GEN_EXPN_INIT_AMT/C.USD_LOCL_XCH_RT, 0)) + SUM(DECODE(D.SALY_FLG, 'N', A.GEN_EXPN_ADD_AMT/C.USD_LOCL_XCH_RT, 0)) + SUM(DECODE(D.SALY_FLG, 'N', A.GEN_EXPN_TRNS_AMT/C.USD_LOCL_XCH_RT, 0)) AS USD_NON_SAL
          FROM GEM_RSLT_SMRY A
              ,GEM_OFFICE B
              ,GEM_XCH_RT C
              ,GEM_EXPENSE D
              ,GEM_EXPN_GRP_V E
         WHERE A.RSLT_YRMON BETWEEN @[from_rslt_yrmon] AND @[to_rslt_yrmon]
           AND A.OFC_CO_DIV_CD = 'O'   
           AND A.OFC_CD = B.OFC_CD
           AND B.RGN_OFC_FLG = 'Y'
           AND A.RSLT_YRMON = C.ACCT_XCH_RT_YRMON
           AND B.LOCL_CURR_CD = C.CURR_CD
           AND C.GEN_EXPN_XCH_RT_DIV_CD = 'M' 
           AND A.GEN_EXPN_CD = D.GEN_EXPN_CD
           AND A.GEN_EXPN_CD BETWEEN DECODE (@[sch_expense_from], '', '111111', @[sch_expense_from]) AND DECODE (@[sch_expense_to], '', '999999', @[sch_expense_to])
           AND A.GEN_EXPN_CD = E.GEN_EXPN_CD
           #if (${sch_expense_group} != '') 
           AND E.GEM_EXPN_GRP_CD1 = @[sch_expense_group]
           #end           
           #if(${sch_tic_cd} != '')
           AND E.TIC_CD = @[sch_tic_cd]
           #end
        GROUP BY A.RSLT_YRMON      
              ,B.PRNT_OFC_CD
              ,B.LOCL_CURR_CD
              ,A.OFC_CD
      )
#if(${sls_ofc_div_cd} != '')
   	WHERE OFC_CD IN (
	SELECT OFC_CD      
  	FROM GEM_OFC_HIS
	START WITH OFC_CD IN (    
        SELECT DISTINCT L_4 CODE
          FROM GEM_OFC_LEVEL_V
         WHERE 1=1
		   #if(${sls_ofc_div_cd} != '')
           AND RGN_OFC_FLG LIKE @[sls_ofc_div_cd]||'%'
		   #end		
		   #if(${ofc_lvl1} != '' && ${ofc_lvl2} != '' && ${ofc_lvl3} != '') 
		   AND L_4 LIKE @[ofc_lvl3]||'%' 
		   #end
		   #if(${ofc_lvl1} != '' && ${ofc_lvl2} != '' && ${ofc_lvl3} == '') 
		   AND L_3 LIKE @[ofc_lvl2]||'%' 
		   #end
		   #if(${ofc_lvl1} != '' && ${ofc_lvl2} == '' && ${ofc_lvl3} == '') 
		   AND L_2 LIKE @[ofc_lvl1]||'%' 
		   #end
	)
	CONNECT BY PRIOR OFC_CD = BFR_OFC_CD
    )
#end  
ORDER BY RSLT_YRMON
        ,L_3
        ,OFC_CD      
			]]></sql>
			<params>
				<param name="from_rslt_yrmon" type="12" value="" out="N"/>
				<param name="to_rslt_yrmon" type="12" value="" out="N"/>
				<param name="sch_expense_from" type="12" value="" out="N"/>
				<param name="sch_expense_to" type="12" value="" out="N"/>
				<param name="sch_expense_group" type="12" value="" out="N"/>
				<param name="sch_tic_cd" type="12" value="" out="N"/>
				<param name="sls_ofc_div_cd" type="12" value="" out="N"/>
				<param name="ofc_lvl3" type="12" value="" out="N"/>
				<param name="ofc_lvl2" type="12" value="" out="N"/>
				<param name="ofc_lvl1" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
