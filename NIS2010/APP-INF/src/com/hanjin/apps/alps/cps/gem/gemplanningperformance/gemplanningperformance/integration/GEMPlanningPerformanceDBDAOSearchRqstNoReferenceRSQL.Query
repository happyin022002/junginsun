<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="GEMPlanningPerformanceDBDAOSearchRqstNoReferenceRSQL">
			<desc><![CDATA[집행단위에서 수립한 비용계획에 대한 Rquest Number 를 조회한다
2010.11.05 [CHM-201006871-01] 이준범
1) Request expense 후 Reject된 데이터를 Initial 기능에서 수정할 수 있는 로직 오류 발생 확인
2) Request expense  Initial 기능에서는 Request 상태인 데이터만 조회하도록 기존 오류 보완]]></desc>
			<sql><![CDATA[
SELECT  A.GEN_EXPN_RQST_NO
       ,A.GEN_EXPN_RQST_SEQ
       ,A.FR_GEN_EXPN_CD
       ,A.TO_GEN_EXPN_CD
       ,NVL(A.FR_GEN_EXPN_ITM_NO,A.TO_GEN_EXPN_ITM_NO) FR_GEN_EXPN_ITM_NO
       ,A.TO_GEN_EXPN_ITM_NO
       ,A.FR_OFC_CD
       ,A.TO_OFC_CD
       ,A.FR_AMT
       ,A.TO_AMT
       ,A.CRE_USR_ID
       ,A.CRE_USR_ID
       ,A.REQ_UPD_DT
       ,B.LOCL_CURR_CD FR_CURR_CD       
       ,C.LOCL_CURR_CD TO_CURR_CD
       ,B.RQST_UT_VAL FR_UT_VAL  
       ,C.RQST_UT_VAL TO_UT_VAL 
FROM
         (
         SELECT  A.GEN_EXPN_RQST_NO
                ,A.GEN_EXPN_RQST_SEQ
                ,MAX(DECODE(A.GEN_EXPN_TRNS_DIV_CD,'F',A.GEN_EXPN_CD ,'')) FR_GEN_EXPN_CD
                ,MAX(DECODE(A.GEN_EXPN_TRNS_DIV_CD,'T',A.GEN_EXPN_CD ,'')) TO_GEN_EXPN_CD
                ,MAX(DECODE(A.GEN_EXPN_TRNS_DIV_CD,'F',A.GEN_EXPN_ITM_NO ,'')) FR_GEN_EXPN_ITM_NO
                ,MAX(DECODE(A.GEN_EXPN_TRNS_DIV_CD,'T',A.GEN_EXPN_ITM_NO ,'')) TO_GEN_EXPN_ITM_NO
                ,MAX(DECODE(A.GEN_EXPN_TRNS_DIV_CD,'F',A.OFC_CD ,'')) FR_OFC_CD
                ,MAX(DECODE(A.GEN_EXPN_TRNS_DIV_CD,'T',A.OFC_CD ,'')) TO_OFC_CD
                ,MAX(DECODE(A.GEN_EXPN_TRNS_DIV_CD,'F',A.JAN_AMT + A.FEB_AMT + A.MAR_AMT + A.APR_AMT + A.MAY_AMT + A.JUN_AMT + A.JUL_AMT + A.AUG_AMT + A.SEP_AMT + A.OCT_AMT + A.NOV_AMT + A.DEC_AMT ,'')) FR_AMT
                ,MAX(DECODE(A.GEN_EXPN_TRNS_DIV_CD,'T',A.JAN_AMT + A.FEB_AMT + A.MAR_AMT + A.APR_AMT + A.MAY_AMT + A.JUN_AMT + A.JUL_AMT + A.AUG_AMT + A.SEP_AMT + A.OCT_AMT + A.NOV_AMT + A.DEC_AMT ,'')) TO_AMT
                ,MAX(C.CRE_USR_ID) CRE_USR_ID
                ,MAX(C.CRE_DT) CRE_DT
			    ,MAX(TO_CHAR(C.UPD_DT,'YYYYMMDDHH24MISS')) REQ_UPD_DT
         FROM    GEM_APRO_STEP A , GEM_ITEM B ,GEM_REQUEST C
         WHERE   1=1
             AND A.GEN_EXPN_RQST_NO = B.GEN_EXPN_RQST_NO
             AND B.GEN_EXPN_RQST_NO = C.GEN_EXPN_RQST_NO
             AND A.OFC_CD = B.OFC_CD
			 AND A.GEN_EXPN_CD = B.GEN_EXPN_CD
			 AND A.GEN_EXPN_ITM_NO = B.GEN_EXPN_ITM_NO
			 AND A.GEN_EXPN_TRNS_DIV_CD = B.GEN_EXPN_TRNS_DIV_CD
			 AND A.GEN_EXPN_RQST_SEQ = A.GEN_EXPN_RQST_SEQ
             AND A.GEN_EXPN_APRO_STEP_CD = B.CRNT_GEN_EXPN_APRO_STEP_CD
             #if (${prg_id} == '0002') 
             AND B.OFC_CD = @[rqst_ofc_cd]
             #else
             AND B.GEN_EXPN_APRO_AUTH_OFC_CD = @[rqst_ofc_cd]
             AND B.CRNT_GEN_EXPN_APSTS_CD = 'RQ'
             #end              
             AND C.PLN_YRMON LIKE @[pln_yrmon] || '%'  
			 #if (${prg_id} == '') 
             AND C.RQST_OFC_CD = @[rqst_ofc_cd]
             AND C.CRE_USR_ID = @[cre_usr_id]
		     #end

			 #if (${auth_flg} == 'YNYN') 
		     AND  B.CRNT_GEN_EXPN_APRO_STEP_CD IN ('RQ','HQ','TC')
		     #end

			 #if (${auth_flg} == 'YNYY') 
             -- YNYY 사무국
             AND  B.CRNT_GEN_EXPN_APRO_STEP_CD = 'CO'
             AND  B.CRNT_GEN_EXPN_APSTS_CD <> 'AP'
		     #end			

#if (${gen_expn_rqst_tp_cd} != '') 
             AND C.GEN_EXPN_RQST_TP_CD IN (${gen_expn_rqst_tp_cd})
#end
         GROUP BY A.GEN_EXPN_RQST_NO , A.GEN_EXPN_RQST_SEQ
) A , GEM_OFFICE B , GEM_OFFICE C
WHERE B.OFC_CD(+) = A.FR_OFC_CD 
  AND C.OFC_CD(+) = A.TO_OFC_CD
ORDER BY A.CRE_DT DESC, 
A.GEN_EXPN_RQST_NO ,
A.GEN_EXPN_RQST_SEQ ,
A.FR_GEN_EXPN_ITM_NO			]]></sql>
			<params>
				<param name="rqst_ofc_cd" type="12" value="" out="N"/>
				<param name="pln_yrmon" type="12" value="" out="N"/>
				<param name="cre_usr_id" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
