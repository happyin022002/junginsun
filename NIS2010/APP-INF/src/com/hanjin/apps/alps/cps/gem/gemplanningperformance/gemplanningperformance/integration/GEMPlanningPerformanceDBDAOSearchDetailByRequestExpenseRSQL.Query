<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="GEMPlanningPerformanceDBDAOSearchDetailByRequestExpenseRSQL">
			<desc><![CDATA[CPS_GEM_0019_02 관련 Request expense of Initial Data조회
2010.10.26 이준범 [CHM-201006703-01]
1) 해당 메뉴
   -  GEM > Report > Detaill _ Yearly Expense (After/Before Closing
2) 조건
  - Year : 2011
  - Condition : Request expense of Initial
  - Target : Initial (Summarized)
3) 보완내용 
  - 리포트의 Y, AC 열에 본사팀 승인 건 Data도 보여줄것
    * Y열   : Next Year Planning(USD) / RQST /RHQ l BU
    * AC열 : Next Year Planning(LCL) / RQST /RHQ l BU 
    * 본사팀 승인 data는 아래에 포함되어 있슴
      - Z열   : Next Year Planning(USD) / RQST /OFC
      - AD열 : Next Year Planning(LCL) / RQST /OFC
2010.12.17 진마리아[CHM-201007600-01]
비용 데이터 검색 기준을 3년간 1번이라도 사용된 경우가 모두 포함되고 Office div가 변경된 경우도 모두 조회되도록 로직 변경
2011.01.31 이준범[CHM-201108626-01]
요청사항 : SELPLL- >SELLIC  관련 문제 연관 해소
보완내역 : 조직 변경으로 인한 조직 코드 변경시 과거 데이터를 조회 할 수 있도록
               History Table(GEM_OFC_HIS) 검색하도록 SQL 수정  
Ticket ID : CHM-201221037, 2012.11.14
설계자 : 강환
개발자 : 원종규
Title : 일부 법인 비용주관팀 로직 변경에 따른 조회(inquiry/Report) 기능 보완 요청
Description : 터미널, 물류_BU 산하 법인의 비용주관팀 심의/조정 기능이 기존 각 비용주관팀(TIC)에서 SELPLI로 변경됨에 따라
               ALPS GEM 시스템의 비용주관팀 조정 
2014.10.23 이준범 [CHM-201432508-01]
요청사항: [GEM] 결산작업을 위한 데이터 업데이트 지원
보완: SELPLI 하드코딩 부분 삭제 ]]></desc>
			<sql><![CDATA[
SELECT X.OFC_EXPN 
      ,X.LOCL_CURR_CD
      ,X.RQST_UT_VAL
      ,X.YRMON
      ,X.OFC_CD
      ,X.OFC_CO_DIV_CD
      ,X.RHQ_OFC_CD
      ,X.RGN_OFC_FLG
      ,X.SLS_OFC_FLG
      ,X.GEN_EXPN_CD      
      ,X.EXPN_NAME
      ,X.TIC_CD
      ,X.LVL1_NAME
      ,X.LVL2_NAME
      ,Y.EX_RATE_PLAN_PRE
      ,Y.EX_RATE_AVG
      ,Y.EX_RATE_PLAN
      ,X.PERF_USD_YEAR1
      ,X.PERF_USD_AMT1
      ,X.PERF_USD_YEAR2
      ,X.PERF_USD_AMT2
      ,X.PERF_USD_YEAR3
      ,X.PERF_USD_AMT3
      ,X.ASSI_USD_YEAR1
      ,X.ASSI_USD_AMT1
      ,X.ASSI_USD_YEAR2
      ,X.ASSI_USD_AMT2
      ,X.PLAN_USD_COM_AMT
      ,X.PLAN_USD_TIC_AMT
      ,X.PLAN_USD_RHQ_AMT
      ,X.PLAN_USD_OFC_AMT
      ,X.PLAN_LCL_COM_AMT
      ,X.PLAN_LCL_TIC_AMT
      ,X.PLAN_LCL_RHQ_AMT
      ,X.PLAN_LCL_OFC_AMT
      ,X.PERF_LCL_YEAR1
      ,X.PERF_LCL_EST_AMT
      ,X.PERF_LCL_PFM_AMT
      ,X.PERF_LCL_PLAN_AMT
      ,X.PERF_LCL_YEAR2
      ,X.PERF_LCL_AMT2
      ,X.PERF_LCL_YEAR3
      ,X.PERF_LCL_AMT3
      ,X.ASSI_LCL_YEAR1
      ,X.ASSI_LCL_AMT1
      ,X.ASSI_LCL_YEAR2
      ,X.ASSI_LCL_AMT2
      ,X.ASSI_LCL_YEAR3
      ,X.ASSI_LCL_AMT3
FROM (
SELECT A.OFC_CD||A.GEN_EXPN_CD OFC_EXPN 
      ,DECODE(@[sch_cur], 'LCL', C.LOCL_CURR_CD, 'KRW', 'KRW', 'USD', 'USD') LOCL_CURR_CD
      ,C.LOCL_CURR_CD AS CURR_CD
      ,DECODE(@[sch_cur], 'LCL', C.RQST_UT_VAL, 'KRW', '1000', 'USD', '1' ) RQST_UT_VAL
      ,A.YRMON
      ,A.OFC_CD
      ,A.OFC_CO_DIV_CD
      ,CASE WHEN GEN_EXPN_OFC_LVL = '4' AND B.OFC_CD <> C.PRNT_OFC_CD THEN C.PRNT_OFC_CD END RHQ_OFC_CD
      ,C.RGN_OFC_FLG
      ,D.SALY_FLG AS SLS_OFC_FLG
      ,D.GEN_EXPN_CD      
      ,DECODE(@[sch_lang], 'K', D.KRN_ABBR_NM, 'E', D.ENG_ABBR_NM) EXPN_NAME
      ,D.TIC_CD
      ,DECODE(@[sch_lang], 'K', D.KRN_ABBR_NM_1, 'E', D.ENG_ABBR_NM_1) LVL1_NAME
      ,DECODE(@[sch_lang], 'K', D.KRN_ABBR_NM_2, 'E', D.ENG_ABBR_NM_2) LVL2_NAME
      ,B.YM_1 PERF_USD_YEAR1
      ,B.CONV_PPFM_AMT_1 PERF_USD_AMT1
      ,B.YM_2 PERF_USD_YEAR2
      ,B.CONV_PPFM_AMT_2 PERF_USD_AMT2
      ,B.YM_3 PERF_USD_YEAR3
      ,B.CONV_PPFM_AMT_3 PERF_USD_AMT3
      ,B.YM_3 ASSI_USD_YEAR1
      ,B.CONV_PPLAN_AMT_1 ASSI_USD_AMT1
      ,B.YM_3 ASSI_USD_YEAR2
      ,B.CONV_PPLAN_AMT_2 ASSI_USD_AMT2
      ,A.CO_USD_AMT PLAN_USD_COM_AMT
      ,A.TC_USD_AMT PLAN_USD_TIC_AMT
      ,DECODE(A.HQ_USD_AMT, 0, A.RQ_USD_AMT, A.HQ_USD_AMT) PLAN_USD_RHQ_AMT
      ,A.RQ_USD_AMT PLAN_USD_OFC_AMT
      ,A.CO_AMT PLAN_LCL_COM_AMT
      ,A.TC_AMT PLAN_LCL_TIC_AMT
      ,DECODE(A.HQ_AMT, 0, A.RQ_AMT, A.HQ_AMT) PLAN_LCL_RHQ_AMT
      ,A.RQ_AMT PLAN_LCL_OFC_AMT
      ,B.YM_3 PERF_LCL_YEAR1
      ,B.EST_AMT PERF_LCL_EST_AMT
      ,B.PPFM_AMT_3 PERF_LCL_PFM_AMT
      ,B.PPLAN_AMT PERF_LCL_PLAN_AMT
      ,B.YM_1 PERF_LCL_YEAR2
      ,B.PPFM_AMT_1 PERF_LCL_AMT2
      ,B.YM_2 PERF_LCL_YEAR3
      ,B.PPFM_AMT_2 PERF_LCL_AMT3
      ,B.YM_1 ASSI_LCL_YEAR1
      ,B.PLAN_AMT_1 ASSI_LCL_AMT1
      ,B.YM_2 ASSI_LCL_YEAR2
      ,B.PLAN_AMT_2 ASSI_LCL_AMT2
      ,B.YM_3 ASSI_LCL_YEAR3
      ,B.PLAN_AMT_3 ASSI_LCL_AMT3
  FROM (
        SELECT @[sch_yrmon] YRMON
              ,B.OFC_CD
              ,B.GEN_EXPN_CD
              ,B.OFC_CO_DIV_CD
              ,SUM(CASE WHEN A.GEN_EXPN_APRO_STEP_CD = DECODE(@[sch_app_div_gbn], 'ALL', 'RQ', 'RQ', 'RQ', '') AND A.GEN_EXPN_APSTS_CD = 'AP' THEN A.JAN_AMT + A.FEB_AMT + A.MAR_AMT + A.APR_AMT + A.MAY_AMT + A.JUN_AMT + A.JUL_AMT + A.AUG_AMT + A.SEP_AMT + A.OCT_AMT + A.NOV_AMT + A.DEC_AMT ELSE 0 END) RQ_AMT
              ,SUM(CASE WHEN A.GEN_EXPN_APRO_STEP_CD = DECODE(@[sch_app_div_gbn], 'ALL', 'HQ', 'HQ', 'HQ', '') AND A.GEN_EXPN_APSTS_CD = 'AP' THEN A.JAN_AMT + A.FEB_AMT + A.MAR_AMT + A.APR_AMT + A.MAY_AMT + A.JUN_AMT + A.JUL_AMT + A.AUG_AMT + A.SEP_AMT + A.OCT_AMT + A.NOV_AMT + A.DEC_AMT ELSE 0 END) HQ_AMT
              ,SUM(CASE WHEN A.GEN_EXPN_APRO_STEP_CD = DECODE(@[sch_app_div_gbn], 'ALL', 'TC', 'TC', 'TC', '') AND A.GEN_EXPN_APSTS_CD = 'AP' THEN A.JAN_AMT + A.FEB_AMT + A.MAR_AMT + A.APR_AMT + A.MAY_AMT + A.JUN_AMT + A.JUL_AMT + A.AUG_AMT + A.SEP_AMT + A.OCT_AMT + A.NOV_AMT + A.DEC_AMT ELSE 0 END) TC_AMT
              ,SUM(CASE WHEN A.GEN_EXPN_APRO_STEP_CD = DECODE(@[sch_app_div_gbn], 'ALL', 'CO', 'CO', 'CO', '') AND A.GEN_EXPN_APSTS_CD = 'AP' THEN A.JAN_AMT + A.FEB_AMT + A.MAR_AMT + A.APR_AMT + A.MAY_AMT + A.JUN_AMT + A.JUL_AMT + A.AUG_AMT + A.SEP_AMT + A.OCT_AMT + A.NOV_AMT + A.DEC_AMT ELSE 0 END) CO_AMT
              ,SUM(CASE WHEN A.GEN_EXPN_APRO_STEP_CD = DECODE(@[sch_app_div_gbn], 'ALL', 'RQ', 'RQ', 'RQ', '') AND A.GEN_EXPN_APSTS_CD = 'AP' THEN A.CONV_JAN_AMT + A.CONV_FEB_AMT + A.CONV_MAR_AMT + A.CONV_APR_AMT + A.CONV_MAY_AMT + A.CONV_JUN_AMT + A.CONV_JUL_AMT + A.CONV_AUG_AMT + A.CONV_SEP_AMT + A.CONV_OCT_AMT + A.CONV_NOV_AMT + A.CONV_DEC_AMT ELSE 0 END) RQ_USD_AMT
              ,SUM(CASE WHEN A.GEN_EXPN_APRO_STEP_CD = DECODE(@[sch_app_div_gbn], 'ALL', 'HQ', 'HQ', 'HQ', '') AND A.GEN_EXPN_APSTS_CD = 'AP' THEN A.CONV_JAN_AMT + A.CONV_FEB_AMT + A.CONV_MAR_AMT + A.CONV_APR_AMT + A.CONV_MAY_AMT + A.CONV_JUN_AMT + A.CONV_JUL_AMT + A.CONV_AUG_AMT + A.CONV_SEP_AMT + A.CONV_OCT_AMT + A.CONV_NOV_AMT + A.CONV_DEC_AMT ELSE 0 END) HQ_USD_AMT
              ,SUM(CASE WHEN A.GEN_EXPN_APRO_STEP_CD = DECODE(@[sch_app_div_gbn], 'ALL', 'TC', 'TC', 'TC', '') AND A.GEN_EXPN_APSTS_CD = 'AP' THEN A.CONV_JAN_AMT + A.CONV_FEB_AMT + A.CONV_MAR_AMT + A.CONV_APR_AMT + A.CONV_MAY_AMT + A.CONV_JUN_AMT + A.CONV_JUL_AMT + A.CONV_AUG_AMT + A.CONV_SEP_AMT + A.CONV_OCT_AMT + A.CONV_NOV_AMT + A.CONV_DEC_AMT ELSE 0 END) TC_USD_AMT
              ,SUM(CASE WHEN A.GEN_EXPN_APRO_STEP_CD = DECODE(@[sch_app_div_gbn], 'ALL', 'CO', 'CO', 'CO', '') AND A.GEN_EXPN_APSTS_CD = 'AP' THEN A.CONV_JAN_AMT + A.CONV_FEB_AMT + A.CONV_MAR_AMT + A.CONV_APR_AMT + A.CONV_MAY_AMT + A.CONV_JUN_AMT + A.CONV_JUL_AMT + A.CONV_AUG_AMT + A.CONV_SEP_AMT + A.CONV_OCT_AMT + A.CONV_NOV_AMT + A.CONV_DEC_AMT ELSE 0 END) CO_USD_AMT
          FROM (      
                SELECT SUBSTR(A.PLN_YRMON,1,4) YRMON
                      ,B.OFC_CD
                      ,B.GEN_EXPN_CD
                      ,C.OFC_CO_DIV_CD
                      ,B.GEN_EXPN_APRO_STEP_CD
                      ,B.GEN_EXPN_APSTS_CD
                      ,B.JAN_AMT
                      ,B.FEB_AMT
                      ,B.MAR_AMT
                      ,B.APR_AMT
                      ,B.MAY_AMT
                      ,B.JUN_AMT
                      ,B.JUL_AMT
                      ,B.AUG_AMT
                      ,B.SEP_AMT
                      ,B.OCT_AMT
                      ,B.NOV_AMT
                      ,B.DEC_AMT
                      ,DECODE(@[sch_cur], 'KRW', (((B.JAN_AMT*C.RQST_UT_VAL)/1000)/D.USD_LOCL_XCH_RT) * D.USD_KRW_XCH_RT
                                        , 'USD', (B.JAN_AMT*C.RQST_UT_VAL)/D.USD_LOCL_XCH_RT 
                                        , 'LCL', (B.JAN_AMT*C.RQST_UT_VAL)/D.USD_LOCL_XCH_RT ) CONV_JAN_AMT
                      ,DECODE(@[sch_cur], 'KRW', (((B.FEB_AMT*C.RQST_UT_VAL)/1000)/D.USD_LOCL_XCH_RT) * D.USD_KRW_XCH_RT
                                        , 'USD', (B.FEB_AMT*C.RQST_UT_VAL)/D.USD_LOCL_XCH_RT
                                        , 'LCL', (B.FEB_AMT*C.RQST_UT_VAL)/D.USD_LOCL_XCH_RT ) CONV_FEB_AMT
                      ,DECODE(@[sch_cur], 'KRW', (((B.MAR_AMT*C.RQST_UT_VAL)/1000)/D.USD_LOCL_XCH_RT) * D.USD_KRW_XCH_RT
                                        , 'USD', (B.MAR_AMT*C.RQST_UT_VAL)/D.USD_LOCL_XCH_RT
                                        , 'LCL', (B.MAR_AMT*C.RQST_UT_VAL)/D.USD_LOCL_XCH_RT ) CONV_MAR_AMT
                      ,DECODE(@[sch_cur], 'KRW', (((B.APR_AMT*C.RQST_UT_VAL)/1000)/D.USD_LOCL_XCH_RT) * D.USD_KRW_XCH_RT
                                        , 'USD', (B.APR_AMT*C.RQST_UT_VAL)/D.USD_LOCL_XCH_RT
                                        , 'LCL', (B.APR_AMT*C.RQST_UT_VAL)/D.USD_LOCL_XCH_RT ) CONV_APR_AMT
                      ,DECODE(@[sch_cur], 'KRW', (((B.MAY_AMT*C.RQST_UT_VAL)/1000)/D.USD_LOCL_XCH_RT) * D.USD_KRW_XCH_RT
                                        , 'USD', (B.MAY_AMT*C.RQST_UT_VAL)/D.USD_LOCL_XCH_RT
                                        , 'LCL', (B.MAY_AMT*C.RQST_UT_VAL)/D.USD_LOCL_XCH_RT ) CONV_MAY_AMT
                      ,DECODE(@[sch_cur], 'KRW', (((B.JUN_AMT*C.RQST_UT_VAL)/1000)/D.USD_LOCL_XCH_RT) * D.USD_KRW_XCH_RT
                                        , 'USD', (B.JUN_AMT*C.RQST_UT_VAL)/D.USD_LOCL_XCH_RT
                                        , 'LCL', (B.JUN_AMT*C.RQST_UT_VAL)/D.USD_LOCL_XCH_RT ) CONV_JUN_AMT
                      ,DECODE(@[sch_cur], 'KRW', (((B.JUL_AMT*C.RQST_UT_VAL)/1000)/D.USD_LOCL_XCH_RT) * D.USD_KRW_XCH_RT
                                        , 'USD', (B.JUL_AMT*C.RQST_UT_VAL)/D.USD_LOCL_XCH_RT
                                        , 'LCL', (B.JUL_AMT*C.RQST_UT_VAL)/D.USD_LOCL_XCH_RT ) CONV_JUL_AMT
                      ,DECODE(@[sch_cur], 'KRW', (((B.AUG_AMT*C.RQST_UT_VAL)/1000)/D.USD_LOCL_XCH_RT) * D.USD_KRW_XCH_RT
                                        , 'USD', (B.AUG_AMT*C.RQST_UT_VAL)/D.USD_LOCL_XCH_RT
                                        , 'LCL', (B.AUG_AMT*C.RQST_UT_VAL)/D.USD_LOCL_XCH_RT ) CONV_AUG_AMT
                      ,DECODE(@[sch_cur], 'KRW', (((B.SEP_AMT*C.RQST_UT_VAL)/1000)/D.USD_LOCL_XCH_RT) * D.USD_KRW_XCH_RT
                                        , 'USD', (B.SEP_AMT*C.RQST_UT_VAL)/D.USD_LOCL_XCH_RT
                                        , 'LCL', (B.SEP_AMT*C.RQST_UT_VAL)/D.USD_LOCL_XCH_RT ) CONV_SEP_AMT                   
                      ,DECODE(@[sch_cur], 'KRW', (((B.OCT_AMT*C.RQST_UT_VAL)/1000)/D.USD_LOCL_XCH_RT) * D.USD_KRW_XCH_RT
                                        , 'USD', (B.OCT_AMT*C.RQST_UT_VAL)/D.USD_LOCL_XCH_RT
                                        , 'LCL', (B.OCT_AMT*C.RQST_UT_VAL)/D.USD_LOCL_XCH_RT ) CONV_OCT_AMT
                      ,DECODE(@[sch_cur], 'KRW', (((B.NOV_AMT*C.RQST_UT_VAL)/1000)/D.USD_LOCL_XCH_RT) * D.USD_KRW_XCH_RT
                                        , 'USD', (B.NOV_AMT*C.RQST_UT_VAL)/D.USD_LOCL_XCH_RT
                                        , 'LCL', (B.NOV_AMT*C.RQST_UT_VAL)/D.USD_LOCL_XCH_RT ) CONV_NOV_AMT
                      ,DECODE(@[sch_cur], 'KRW', (((B.DEC_AMT*C.RQST_UT_VAL)/1000)/D.USD_LOCL_XCH_RT) * D.USD_KRW_XCH_RT
                                        , 'USD', (B.DEC_AMT*C.RQST_UT_VAL)/D.USD_LOCL_XCH_RT
                                        , 'LCL', (B.DEC_AMT*C.RQST_UT_VAL)/D.USD_LOCL_XCH_RT ) CONV_DEC_AMT   
                  FROM (
                        SELECT B.GEN_EXPN_RQST_NO
                              ,B.OFC_CD
                              ,B.GEN_EXPN_CD
                              ,B.GEN_EXPN_ITM_NO
                              ,B.GEN_EXPN_TRNS_DIV_CD
                              ,B.GEN_EXPN_RQST_SEQ
                              ,A.PLN_YRMON
                          FROM (
                                SELECT GEN_EXPN_RQST_NO
                                      ,PLN_YRMON
                                  FROM GEM_REQUEST
                                 WHERE PLN_YRMON = @[sch_yrmon]||'00' 
                                   AND GEN_EXPN_RQST_TP_CD = 'EI'
                               ) A
                              ,GEM_ITEM B
                         WHERE A.GEN_EXPN_RQST_NO = B.GEN_EXPN_RQST_NO
                       ) A
                      ,GEM_APRO_STEP B
                      ,GEM_OFFICE C
                      ,GEM_XCH_RT D
                 WHERE 1=1
                   AND A.GEN_EXPN_RQST_NO = B.GEN_EXPN_RQST_NO
                   AND A.OFC_CD           = B.OFC_CD
                   AND A.GEN_EXPN_CD      = B.GEN_EXPN_CD
                   AND A.GEN_EXPN_ITM_NO  = B.GEN_EXPN_ITM_NO
                   AND A.GEN_EXPN_TRNS_DIV_CD = B.GEN_EXPN_TRNS_DIV_CD
                   AND A.GEN_EXPN_RQST_SEQ = B.GEN_EXPN_RQST_SEQ
                   AND B.OFC_CD = C.OFC_CD
                   AND C.LOCL_CURR_CD = D.CURR_CD
                   AND D.ACCT_XCH_RT_YRMON = A.PLN_YRMON
                   AND D.GEN_EXPN_XCH_RT_DIV_CD = 'I'
               ) A
              ,(
                SELECT DISTINCT 
                       OFC_CD
                      ,GEN_EXPN_CD
                      ,OFC_CO_DIV_CD
                  FROM GEM_RSLT_SMRY
                 WHERE RSLT_YRMON BETWEEN TO_CHAR(@[sch_yrmon]-'3'||'01') AND @[sch_yrmon]||'12'
                UNION
                SELECT B.OFC_CD
                      ,B.GEN_EXPN_CD
                      ,C.OFC_CO_DIV_CD
                  FROM (
                        SELECT GEN_EXPN_RQST_NO
                              ,PLN_YRMON
                          FROM GEM_REQUEST
                         WHERE PLN_YRMON = @[sch_yrmon] ||'00' 
                           AND GEN_EXPN_RQST_TP_CD = 'EI'
                       ) A
                      ,GEM_ITEM B
                      ,GEM_OFFICE C
                 WHERE A.GEN_EXPN_RQST_NO = B.GEN_EXPN_RQST_NO
                   AND B.OFC_CD = C.OFC_CD              
               ) B
          WHERE A.OFC_CD(+) = B.OFC_CD
            AND A.GEN_EXPN_CD(+) = B.GEN_EXPN_CD
            AND A.OFC_CO_DIV_CD(+) = B.OFC_CO_DIV_CD                 
      GROUP BY B.OFC_CD
              ,B.GEN_EXPN_CD
              ,B.OFC_CO_DIV_CD
       ) A
      ,(
        SELECT @[sch_yrmon] YRMON
              ,B.OFC_CD
              ,B.GEN_EXPN_CD
              ,B.OFC_CO_DIV_CD
              ,SUM(A.CONV_PPLAN_AMT_1) CONV_PPLAN_AMT_1
              ,SUM(A.CONV_PPLAN_AMT_2) CONV_PPLAN_AMT_2
              ,SUM(DECODE(A.YYYY, @[sch_yrmon]-'3', YYYY)) YM_1
              ,SUM(A.CONV_PPFM_AMT_1) CONV_PPFM_AMT_1   
              ,SUM(DECODE(A.YYYY, @[sch_yrmon]-'2', YYYY)) YM_2
              ,SUM(A.CONV_PPFM_AMT_2) CONV_PPFM_AMT_2  
              ,SUM(DECODE(A.YYYY, @[sch_yrmon]-'1', YYYY)) YM_3
              ,SUM(A.CONV_PPFM_AMT_3 + A.CONV_PPLAN_AMT) CONV_PPFM_AMT_3
              ,SUM(A.EST_AMT) EST_AMT
              ,SUM(A.PPFM_AMT_3) PPFM_AMT_3
              ,SUM(A.PPLAN_AMT) PPLAN_AMT
              ,SUM(A.PPFM_AMT_1) PPFM_AMT_1
              ,SUM(A.PPFM_AMT_2) PPFM_AMT_2
              ,SUM(A.PLAN_AMT_1) PLAN_AMT_1
              ,SUM(A.PLAN_AMT_2) PLAN_AMT_2
              ,SUM(A.PLAN_AMT_3) PLAN_AMT_3              
          FROM (
                SELECT YYYY
                      ,OFC_CD
                      ,GEN_EXPN_CD
                      ,OFC_CO_DIV_CD
                      ,SUM(DECODE(YYYY, @[sch_yrmon]-'3', PLAN_AMT, 0 )) PLAN_AMT_1
                      ,SUM(DECODE(YYYY, @[sch_yrmon]-'2', PLAN_AMT, 0 )) PLAN_AMT_2
                      ,SUM(DECODE(YYYY, @[sch_yrmon]-'1', PLAN_AMT, 0 )) PLAN_AMT_3
                      ,SUM(DECODE(YYYY, @[sch_yrmon]-'3', PPFM_AMT, 0 )) PPFM_AMT_1
                      ,SUM(DECODE(YYYY, @[sch_yrmon]-'2', PPFM_AMT, 0 )) PPFM_AMT_2
                      ,SUM(DECODE(YYYY, @[sch_yrmon]-'1', PPFM_AMT, 0 )) PPFM_AMT_3
                      ,SUM(DECODE(YYYY, @[sch_yrmon]-'1', PPLAN_AMT, 0 )) PPLAN_AMT
                      ,SUM(DECODE(YYYY, @[sch_yrmon]-'1', EST_AMT, 0 )) EST_AMT
                      ,SUM(DECODE(YYYY, @[sch_yrmon]-'3', CONV_PPFM_AMT, 0 )) CONV_PPFM_AMT_1
                      ,SUM(DECODE(YYYY, @[sch_yrmon]-'2', CONV_PPFM_AMT, 0 )) CONV_PPFM_AMT_2
                      ,SUM(DECODE(YYYY, @[sch_yrmon]-'1', CONV_PPFM_AMT, 0 )) CONV_PPFM_AMT_3
                      ,SUM(DECODE(YYYY, @[sch_yrmon]-'1', CONV_PPLAN_AMT, 0 )) CONV_PPLAN_AMT
                      ,SUM(DECODE(YYYY, @[sch_yrmon]-'1', CONV_PPLAN_AMT_1, 0 )) CONV_PPLAN_AMT_1
                      ,SUM(DECODE(YYYY, @[sch_yrmon]-'1', CONV_PPLAN_AMT_2, 0 )) CONV_PPLAN_AMT_2
                  FROM (
                        SELECT SUBSTR(A.RSLT_YRMON,1,4) YYYY
                              ,A.OFC_CD
                              ,A.GEN_EXPN_CD
                              ,A.OFC_CO_DIV_CD
                              ,(A.PLAN_AMT/A.RQST_UT_VAL) PLAN_AMT
                              ,DECODE(A.PPFM_AMT, 0, 0
                                                , DECODE(@[sch_cur], 'KRW', ((A.PPFM_AMT/1000)/B.USD_LOCL_XCH_RT) * B.USD_KRW_XCH_RT 
                                                                   , 'USD', A.PPFM_AMT/B.USD_LOCL_XCH_RT 
                                                                   , 'LCL', A.PPFM_AMT/B.USD_LOCL_XCH_RT ) ) CONV_PPFM_AMT
                              ,(A.PPFM_AMT/A.RQST_UT_VAL) PPFM_AMT
                              ,DECODE(A.PPLAN_AMT, 0, 0
                                                , DECODE(@[sch_cur], 'KRW', ((A.PPLAN_AMT/1000)/B.USD_LOCL_XCH_RT) * B.USD_KRW_XCH_RT 
                                                                   , 'USD', A.PPLAN_AMT/B.USD_LOCL_XCH_RT
                                                                   , 'LCL', A.PPLAN_AMT/B.USD_LOCL_XCH_RT ) ) CONV_PPLAN_AMT                             
                              ,(A.PPLAN_AMT/A.RQST_UT_VAL) PPLAN_AMT
                              ,DECODE(A.PLAN_AMT, 0, 0
                                                , DECODE(@[sch_cur], 'KRW', ((A.PLAN_AMT/1000)/C.USD_LOCL_XCH_RT) * C.USD_KRW_XCH_RT 
                                                                   , 'USD', A.PLAN_AMT/C.USD_LOCL_XCH_RT
                                                                   , 'LCL', A.PLAN_AMT/C.USD_LOCL_XCH_RT ) )  CONV_PPLAN_AMT_1
                              ,DECODE(A.PLAN_AMT, 0, 0
                                                , DECODE(@[sch_cur], 'KRW', ((A.PLAN_AMT/1000)/D.USD_LOCL_XCH_RT) * D.USD_KRW_XCH_RT
                                                                   , 'USD', A.PLAN_AMT/D.USD_LOCL_XCH_RT 
                                                                   , 'LCL', A.PLAN_AMT/D.USD_LOCL_XCH_RT ) ) CONV_PPLAN_AMT_2                              
                              ,(A.PPFM_AMT/A.RQST_UT_VAL) + (A.PPLAN_AMT/A.RQST_UT_VAL) EST_AMT
                          FROM (
                                SELECT RSLT_YRMON
                                      ,OFC_CD
                                      ,GEN_EXPN_CD
                                      ,OFC_CO_DIV_CD
                                      ,LOCL_CURR_CD
                                      ,RQST_UT_VAL
                                      ,PLAN_AMT
                                      ,CASE WHEN RSLT_YRMON <= YRMON THEN SLP_PERF_AMT ELSE 0 END PPFM_AMT
                                      ,CASE WHEN RSLT_YRMON >  YRMON THEN PLAN_AMT     ELSE 0 END PPLAN_AMT
                                  FROM (
                                        SELECT A.RSLT_YRMON
                                              ,A.OFC_CD
                                              ,A.GEN_EXPN_CD
                                              ,A.OFC_CO_DIV_CD
                                              ,B.LOCL_CURR_CD
                                              ,B.RQST_UT_VAL
                                              ,SUM(A.GEN_EXPN_INIT_AMT) + SUM(A.GEN_EXPN_ADD_AMT) + SUM(A.GEN_EXPN_TRNS_AMT) PLAN_AMT
                                              ,SUM(A.SLP_PERF_AMT) SLP_PERF_AMT
                                              ,( SELECT MAX(CLZ_YRMON) FROM GEM_MON_CLZ WHERE CLZ_YRMON LIKE @[sch_yrmon]-'1'||'%' AND CLZ_DIV_CD = 'IN' AND CLZ_FLG = 'Y' ) AS YRMON                                              
                                          FROM GEM_RSLT_SMRY A
                                              ,GEM_OFFICE B
                                         WHERE A.RSLT_YRMON BETWEEN @[sch_yrmon]-'3'||'01' AND @[sch_yrmon]||'12'
                                           AND A.OFC_CD = B.OFC_CD 
                                      GROUP BY A.RSLT_YRMON
                                              ,A.OFC_CD
                                              ,A.GEN_EXPN_CD
                                              ,A.OFC_CO_DIV_CD
                                              ,B.LOCL_CURR_CD
                                              ,B.RQST_UT_VAL   
                                       )
                               ) A
                              ,(
                                SELECT A.YRMON
                                      ,A.CURR_CD
                                      ,CASE WHEN A.YRMON <= A.CLZ_YRMON THEN B.USD_LOCL_XCH_RT ELSE C.USD_LOCL_XCH_RT END USD_LOCL_XCH_RT
                                      ,CASE WHEN A.YRMON <= A.CLZ_YRMON THEN B.LOCL_KRW_XCH_RT ELSE C.LOCL_KRW_XCH_RT END LOCL_KRW_XCH_RT
                                      ,CASE WHEN A.YRMON <= A.CLZ_YRMON THEN B.USD_KRW_XCH_RT ELSE C.USD_KRW_XCH_RT END USD_KRW_XCH_RT
                                  FROM (
                                        SELECT B.YRMON
                                              ,A.CURR_CD
                                              ,( SELECT MAX(CLZ_YRMON) FROM GEM_MON_CLZ WHERE CLZ_YRMON LIKE @[sch_yrmon]-'1'||'%' AND CLZ_DIV_CD = 'IN' AND CLZ_FLG = 'Y' ) AS CLZ_YRMON
                                          FROM (
                                                SELECT DISTINCT CURR_CD 
                                                  FROM GEM_XCH_RT
                                                 WHERE ACCT_XCH_RT_YRMON LIKE @[sch_yrmon]-'1'||'%'
                                               )A
                                              ,(
                                                SELECT @[sch_yrmon]-'1'||TRIM(TO_CHAR(ROWNUM,'00')) YRMON
                                                  FROM DUAL 
                                               CONNECT BY LEVEL <= 12
                                               ) B           
                                       ) A
                                      ,GEM_XCH_RT B
                                      ,GEM_XCH_RT C
                                 WHERE A.YRMON   = B.ACCT_XCH_RT_YRMON(+)
                                   AND A.CURR_CD = B.CURR_CD(+)
                                   AND B.GEN_EXPN_XCH_RT_DIV_CD(+) = 'M'
                                   AND A.CURR_CD = C.CURR_CD(+)
                                   AND C.ACCT_XCH_RT_YRMON(+) = @[sch_yrmon]-'1'||'00'
                                   AND C.GEN_EXPN_XCH_RT_DIV_CD(+) = 'I' 
                                 UNION ALL
                                 SELECT ACCT_XCH_RT_YRMON
                                       ,CURR_CD
                                       ,USD_LOCL_XCH_RT
                                       ,LOCL_KRW_XCH_RT
                                       ,USD_KRW_XCH_RT
                                   FROM GEM_XCH_RT
                                  WHERE ACCT_XCH_RT_YRMON BETWEEN @[sch_yrmon]-'3'||'01' AND @[sch_yrmon]-'2'||'12'
                                    AND GEN_EXPN_XCH_RT_DIV_CD = 'M'
                                    AND DELT_FLG = 'N'          
                               ) B
                              ,GEM_XCH_RT C
                              ,GEM_XCH_RT D    
                         WHERE A.RSLT_YRMON   = B.YRMON            
                           AND A.LOCL_CURR_CD = B.CURR_CD
                           AND A.LOCL_CURR_CD = C.CURR_CD(+)
                           AND A.LOCL_CURR_CD = D.CURR_CD(+)
                           AND C.ACCT_XCH_RT_YRMON(+) = @[sch_yrmon]-'1'||'00'
                           AND C.GEN_EXPN_XCH_RT_DIV_CD(+) = 'I'
                           AND C.DELT_FLG(+) = 'N'
                           AND D.ACCT_XCH_RT_YRMON(+) = @[sch_yrmon]||'00'
                           AND D.GEN_EXPN_XCH_RT_DIV_CD(+) = 'I'
                           AND D.DELT_FLG(+) = 'N' 
                        )
                  GROUP BY YYYY
                          ,OFC_CD
                          ,GEN_EXPN_CD
                          ,OFC_CO_DIV_CD
               ) A
              ,(
                SELECT DISTINCT 
                       OFC_CD
                      ,GEN_EXPN_CD
                      ,OFC_CO_DIV_CD
                  FROM GEM_RSLT_SMRY
                 WHERE RSLT_YRMON BETWEEN TO_CHAR(@[sch_yrmon]-'3'||'01') AND @[sch_yrmon]||'12'
                UNION
                SELECT B.OFC_CD
                      ,B.GEN_EXPN_CD
                      ,C.OFC_CO_DIV_CD
                  FROM (
                        SELECT GEN_EXPN_RQST_NO
                              ,PLN_YRMON
                          FROM GEM_REQUEST
                         WHERE PLN_YRMON = @[sch_yrmon]||'00' 
                           AND GEN_EXPN_RQST_TP_CD = 'EI'
                       ) A
                      ,GEM_ITEM B
                      ,GEM_OFFICE C
                 WHERE A.GEN_EXPN_RQST_NO = B.GEN_EXPN_RQST_NO
                   AND B.OFC_CD = C.OFC_CD              
               ) B
          WHERE A.OFC_CD(+) = B.OFC_CD
            AND A.GEN_EXPN_CD(+) = B.GEN_EXPN_CD
            AND A.OFC_CO_DIV_CD(+) = B.OFC_CO_DIV_CD                   
         GROUP BY B.OFC_CD
                 ,B.GEN_EXPN_CD
                 ,B.OFC_CO_DIV_CD
      ) B
     ,GEM_OFFICE C
     ,GEM_EXPN_GRP_V D
 WHERE A.YRMON = B.YRMON
   AND A.OFC_CD= B.OFC_CD
   AND A.GEN_EXPN_CD = B.GEN_EXPN_CD
   AND A.OFC_CO_DIV_CD = B.OFC_CO_DIV_CD
   AND B.OFC_CD = C.OFC_CD(+)
   AND B.GEN_EXPN_CD = D.GEN_EXPN_CD(+)     
#if(${auth_flg} == 'YNYN')
	   AND ( B.OFC_CD IN (SELECT OFC_CD      
	                        FROM GEM_OFC_HIS
	                  START WITH OFC_CD IN (@[auth_ofc_cd])
	            CONNECT BY PRIOR OFC_CD = BFR_OFC_CD ) 
       OR D.TIC_CD = @[auth_ofc_cd] )
#end

#if(${auth_flg} == 'YYYN')
   AND ( B.OFC_CD IN ( SELECT OFC_CD      
                         FROM GEM_OFC_HIS
                   START WITH OFC_CD IN ( SELECT L_4 
                                            FROM GEM_OFC_LEVEL_V 
                                           WHERE L_3 = @[auth_ofc_cd] )
             CONNECT BY PRIOR OFC_CD = BFR_OFC_CD ) OR D.TIC_CD = @[auth_ofc_cd] )   
#end

 ) X
,(
  SELECT A.CURR_CD
        ,DECODE(@[sch_cur], 'KRW', A.LOCL_KRW_XCH_RT/A.CURR_CNT, A.USD_LOCL_XCH_RT/A.CURR_CNT ) EX_RATE_AVG
        ,DECODE(@[sch_cur], 'KRW', C.LOCL_KRW_XCH_RT, C.USD_LOCL_XCH_RT ) EX_RATE_PLAN_PRE
        ,DECODE(@[sch_cur], 'KRW', D.LOCL_KRW_XCH_RT, D.USD_LOCL_XCH_RT ) EX_RATE_PLAN
    FROM (
        SELECT CURR_CD
              ,SUM(USD_LOCL_XCH_RT) USD_LOCL_XCH_RT
              ,SUM(LOCL_KRW_XCH_RT) LOCL_KRW_XCH_RT
              ,MAX(CURR_CNT) CURR_CNT
          FROM (
                SELECT ACCT_XCH_RT_YRMON
                      ,CURR_CD
                      ,USD_LOCL_XCH_RT
                      ,LOCL_KRW_XCH_RT
                      ,COUNT(CURR_CD) OVER (PARTITION BY SUBSTR(ACCT_XCH_RT_YRMON,1,4), CURR_CD) AS CURR_CNT
                  FROM GEM_XCH_RT
                 WHERE ACCT_XCH_RT_YRMON LIKE @[sch_yrmon]-'1'||'%'
                   AND GEN_EXPN_XCH_RT_DIV_CD = 'M'
               )
       GROUP BY CURR_CD    
         ) A
        ,GEM_XCH_RT C
        ,GEM_XCH_RT D
   WHERE A.CURR_CD = C.CURR_CD(+)
     AND A.CURR_CD = D.CURR_CD(+)
     AND C.ACCT_XCH_RT_YRMON(+) = @[sch_yrmon]-'1'||'00'
     AND C.GEN_EXPN_XCH_RT_DIV_CD(+) = 'I'
     AND C.DELT_FLG(+) = 'N'
     AND D.ACCT_XCH_RT_YRMON(+) = @[sch_yrmon]||'00'
     AND D.GEN_EXPN_XCH_RT_DIV_CD(+) = 'I'
     AND D.DELT_FLG(+) = 'N'
 ) Y
WHERE 1=1
  AND X.CURR_CD = Y.CURR_CD
  AND X.OFC_CD IN (SELECT     OFC_CD
                   FROM       GEM_OFC_HIS
                   START WITH OFC_CD IN (SELECT DISTINCT L_4 CODE
                                         FROM            GEM_OFC_LEVEL_V
                                         WHERE           1 = 1
                                         #if(${sch_hohq_gbn} != '')
                                         AND             RGN_OFC_FLG = @[sch_hohq_gbn]
                                         #end
                                         #if(${sch_lvl3} != '' && ${ofc_expn_cd} != '') AND L_4 = @[sch_lvl3] #end	
                                         #if(${sch_lvl1} != '' && ${sch_lvl2} != '' && ${sch_lvl3} != '' && ${ofc_expn_cd} == '' ) AND L_4 = @[sch_lvl3] #end
                                         #if(${sch_lvl1} != '' && ${sch_lvl2} != '' && ${sch_lvl3} == '') AND L_3 = @[sch_lvl2] #end
                                         #if(${sch_lvl1} != '' && ${sch_lvl2} == '' && ${sch_lvl3} == '') AND L_2 = @[sch_lvl1] #end	
                                         #if(${sch_lvl3} == '' && ${ofc_expn_cd} != '') AND L_4 = @[ofc_expn_cd] #end	  
                                      )
                   CONNECT BY PRIOR OFC_CD = BFR_OFC_CD)
AND   X.GEN_EXPN_CD IN (SELECT L_4
                        FROM   GEM_EXPN_LEVEL_V
                        WHERE  1 = 1
                        AND    L_4 BETWEEN DECODE (@[sch_expense_from], '', '111111', @[sch_expense_from]) AND DECODE (@[sch_expense_to], '', '999999', @[sch_expense_to])
                        #if (${sch_expense_group} != '')
                        AND    L_1 = @[sch_expense_group]
                        #end
                       )
#if (${sch_tic_cd} != '')
       AND X.TIC_CD = @[sch_tic_cd]
#end
#if (${sch_slay_flg} != '')
AND   X.SLS_OFC_FLG = @[sch_slay_flg]
#end
#if(${sch_com_div} != '')
AND   X.OFC_CO_DIV_CD = @[sch_com_div]
#end
ORDER BY X.OFC_EXPN			]]></sql>
			<params>
				<param name="sch_cur" type="12" value="" out="N"/>
				<param name="sch_lang" type="12" value="" out="N"/>
				<param name="sch_yrmon" type="12" value="" out="N"/>
				<param name="sch_app_div_gbn" type="12" value="" out="N"/>
				<param name="auth_ofc_cd" type="12" value="" out="N"/>
				<param name="sch_hohq_gbn" type="12" value="" out="N"/>
				<param name="sch_lvl3" type="12" value="" out="N"/>
				<param name="sch_lvl2" type="12" value="" out="N"/>
				<param name="sch_lvl1" type="12" value="" out="N"/>
				<param name="ofc_expn_cd" type="12" value="" out="N"/>
				<param name="sch_expense_from" type="12" value="" out="N"/>
				<param name="sch_expense_to" type="12" value="" out="N"/>
				<param name="sch_expense_group" type="12" value="" out="N"/>
				<param name="sch_tic_cd" type="12" value="" out="N"/>
				<param name="sch_slay_flg" type="12" value="" out="N"/>
				<param name="sch_com_div" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
