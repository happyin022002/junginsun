<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="UserRoleApprovalDBDAOSearchRoleAuthAproRSQL">
			<desc><![CDATA[Reqeust한 Role을 search 한다.]]></desc>
			<sql><![CDATA[
select a.apro_rqst_no,
a.rqst_usr_id,
(select b.usr_nm from com_user b where b.usr_id = a.rqst_usr_id and rownum=1 ) rqst_usr_nm,
(select b.usr_eml from com_user b where b.usr_id = a.rqst_usr_id and rownum=1 ) rqst_usr_eml,
a.rqst_ofc_cd,
a.rqst_st_dt,
a.rqst_st_dt_hr,
a.role_module,
a.usr_role_cd,
a.usr_role_nm,
a.rqst_rmk,
a.apro_rqst_seq,
a.apsts_cd,
a.apro_rmk
from (
    select hdr.apro_rqst_no,
      hdr.rqst_usr_id,
      hdr.rqst_ofc_cd,
      to_char(hdr.rqst_st_dt, 'YYYY-MM-DD') as rqst_st_dt,
      to_char(hdr.rqst_st_dt, 'YYYY/MM/DD HH24:mi:ss') as rqst_st_dt_hr,
      substr(dtl.usr_role_cd, 1, 3) as role_module,
      dtl.usr_role_cd,
      urole.usr_role_nm,
      hdr.rqst_rmk,
      rout.apro_rqst_seq,
      rout.apsts_cd,
      rout.apro_rmk
    from com_apro_role_rqst_hdr hdr,
      com_apro_role_dtl dtl,
      com_apro_role_rqst_rout rout,
      com_usr_role urole
    where 1 =1
      and hdr.apro_rqst_no = dtl.apro_rqst_no
      and dtl.apro_rqst_no = rout.apro_rqst_no
      and dtl.usr_role_cd = urole.usr_role_cd
      and rout.apsts_cd = 'P'
    order by rout.apro_rqst_no desc, rout.apro_rqst_seq desc ) a
where 1=1
#if(${usr_auth_tp_cd} != 'A') 
and role_module in (
    select role_module
    from (
        select distinct substr(b.pgm_no, 0, 3) role_module
        from com_user a,
          com_usr_pgm_mtch b
        where a.usr_id = b.usr_id
          and a.usr_auth_tp_cd = 'S'
          and NVL(a.use_flg, 'Y') = 'Y'
          and length(b.pgm_no) = 3
          and a.usr_id = @[usr_id]
        )a
    group by a.role_module)
#end
#if(${apro_rqst_no} != '')
and apro_rqst_no in (
#foreach($rqst_no IN ${apro_rqst_no})
	#if($velocityCount < $apro_rqst_no.size())
		'$rqst_no', 
	#else 
		'$rqst_no' 
	#end 
#end
)
order by a.role_module
#end			]]></sql>
			<params>
				<param name="usr_id" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
