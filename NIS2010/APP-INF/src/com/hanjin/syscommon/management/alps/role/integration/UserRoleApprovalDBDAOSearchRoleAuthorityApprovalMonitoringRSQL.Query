<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="UserRoleApprovalDBDAOSearchRoleAuthorityApprovalMonitoringRSQL">
			<desc><![CDATA[DESC Enter..]]></desc>
			<sql><![CDATA[
SELECT  HDR.RQST_USR_ID,
        HDR.RQST_USR_NM,
        HDR.RQST_OFC_CD,
        TO_CHAR(HDR.RQST_ST_DT, 'YYYY-MM-DD') AS RQST_ST_DT,
        DECODE(ROUT.APSTS_CD, 'P', '', TO_CHAR(ROUT.APRO_DT, 'YYYY-MM-DD')) AS APRO_DT,
        HDR.ROLE_MODULE,
		(SELECT wm_concat(usr_nm) FROM com_user a WHERE usr_id in (SELECT usr_id FROM com_usr_pgm_mtch WHERE pgm_no = HDR.ROLE_MODULE) and a.usr_auth_tp_cd = 'S' and a.use_flg = 'Y') ROLE_AUTH,
		-- Oracle 11g Upgrade 시 wm_concat(usr_nm) 을 ListAgg(usr_nm, ',') WITHIN GROUP(ORDER BY rownum) 로 변경
        DECODE(ROUT.APSTS_CD, 'C',HDR.USR_ROLE_CD,'') USR_ROLE_CD,
        ROUT.APSTS_CD,
		DECODE(ROUT.APSTS_CD, 'P','',ROUT.APRO_USR_NM||'\n'||(SELECT USR_EML FROM COM_USER CU WHERE CU.USR_ID = ROUT.APRO_USR_ID)) APRO_USR_ID, 
        ROUT.APRO_RMK,
        HDR.RQST_RMK,
        ROUT.APRO_RQST_NO,
		(DECODE(ROUT.APSTS_CD, 'P',HDR.USR_ROLE_CD,NVL((select DTL2.USR_ROLE_CD from COM_APRO_ROLE_DTL DTL2 where  ROUT.APRO_RQST_NO = DTL2.APRO_RQST_NO and  DTL2.APSTS_CD <> 'P'),HDR.USR_ROLE_CD))) AS ORG_USR_ROLE_CD     
FROM
    (
    SELECT  HDR.APRO_RQST_NO, 
            HDR.RQST_USR_ID,
            HDR.RQST_USR_NM,
            HDR.RQST_OFC_CD,
            HDR.RQST_ST_DT,
            HDR.RQST_RMK,
            DTL.USR_ROLE_CD,
            SUBSTR(DTL.USR_ROLE_CD,1,3) AS ROLE_MODULE
    FROM    COM_APRO_ROLE_RQST_HDR HDR, COM_APRO_ROLE_DTL DTL 
    WHERE   HDR.APRO_RQST_NO = DTL.APRO_RQST_NO
		#if (${date_fm} != '' && ${date_to} != '')
            AND HDR.RQST_ST_DT BETWEEN TO_DATE(@[date_fm], 'YYYY-MM-DD') AND TO_DATE(@[date_to], 'YYYY-MM-DD') + 0.99999
		#end 
		#if (${rqst_ofc_cd} != '')
		   AND HDR.RQST_OFC_CD LIKE @[rqst_ofc_cd]||'%'
		#end
		#if (${rqst_usr_id} != '')
		   AND HDR.RQST_USR_ID LIKE @[rqst_usr_id]||'%'
		#end 
		#if (${usr_role_cd} != '')
		   AND DTL.USR_ROLE_CD LIKE @[usr_role_cd]||'%'
		#end 
		   ) HDR,
    COM_APRO_ROLE_RQST_ROUT ROUT
WHERE 1 = 1
    AND HDR.APRO_RQST_NO = ROUT.APRO_RQST_NO
		#if (${apsts_cd} != '')
		   AND ROUT.APSTS_CD = @[apsts_cd]
		#end 
		#if (${role_module} != '')
		   AND ROLE_MODULE in ('${role_module}')
		#end
ORDER BY ROUT.APRO_RQST_NO DESC			]]></sql>
			<params>
				<param name="date_fm" type="12" value="" out="N"/>
				<param name="date_to" type="12" value="" out="N"/>
				<param name="rqst_ofc_cd" type="12" value="" out="N"/>
				<param name="rqst_usr_id" type="12" value="" out="N"/>
				<param name="usr_role_cd" type="12" value="" out="N"/>
				<param name="apsts_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
