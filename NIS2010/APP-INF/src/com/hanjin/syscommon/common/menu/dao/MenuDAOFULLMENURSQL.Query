<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="MenuDAOFULLMENURSQL">
			<desc><![CDATA[select full menu list]]></desc>
			<sql><![CDATA[
WITH T1 AS (
    SELECT /*+ MATERIALIZE */
	  A.MNU_CFG_CD,
      A.PRNT_PGM_NO,
      A.CHD_PGM_NO,
      A.PGM_LVL_VAL,
      A.DP_SEQ ,
      B.PGM_NO,
      B.PGM_NM,
      B.PGM_URL,
      B.PGM_LVL_DIV_CD,
      B.POPUP_FLG,
      'Y' AUTH_YN
    FROM COM_MNU_CFG A,
      COM_PROGRAM B
    WHERE A.MNU_CFG_CD = @[mnu_cfg_cd]
      AND A.CHD_PGM_NO = B.PGM_NO
      AND B.PGM_TP_CD = '00'
      AND B.USE_FLG = 'Y'
      AND B.POPUP_FLG = 'N'
      AND B.PGM_MNU_DIV_CD = '01'
    UNION ALL
    SELECT A.MNU_CFG_CD,
      A.PRNT_PGM_NO,
      A.CHD_PGM_NO,
      A.PGM_LVL_VAL,
      A.DP_SEQ ,
      B.PGM_NO,
      B.PGM_NM,
      C.PGM_URL,
      B.PGM_LVL_DIV_CD,
      B.POPUP_FLG,
      DECODE(C.PGM_URL, NULL, 'N', 'Y') AUTH_YN
    FROM COM_MNU_CFG A,
      COM_PROGRAM B,
      (
        SELECT AUTH.PGM_NO,
          AUTH.PGM_NM,
          AUTH.PGM_URL,
          AUTH.PGM_LVL_DIV_CD,
          AUTH.POPUP_FLG
        FROM (
            SELECT /*+ USE_HASH(BA BB BC BD) ORDERED */ DISTINCT BA.PGM_NO,
              BA.PGM_NM,
              BA.PGM_URL,
              BA.PGM_LVL_DIV_CD,
              BA.POPUP_FLG
            FROM COM_PROGRAM BA,
              COM_PGM_ROLE BB,
              COM_USR_ROLE BC,
              COM_USR_ROLE_MTCH BD
            WHERE BA.PGM_TP_CD = '00'
              AND BA.USE_FLG = 'Y'
              AND BA.POPUP_FLG = 'N'
              AND BA.PGM_MNU_DIV_CD = '02'
              AND BA.PGM_NO = BB.PGM_NO
              AND BB.USR_ROLE_CD = BC.USR_ROLE_CD
              AND BC.USR_ROLE_CD = BD.USR_ROLE_CD
              AND BD.USR_ID = @[usr_id]
            UNION
            SELECT BB.PGM_NO,
              BB.PGM_NM,
              BB.PGM_URL,
              bb.pgm_lvl_div_cd,
              bb.popup_flg
            FROM COM_PROGRAM BB,
              COM_USR_PGM_MTCH CC
            WHERE BB.PGM_NO = CC.PGM_NO
              AND BB.PGM_TP_CD = '00'
              AND BB.USE_FLG = 'Y'
              AND NVL(BB.POPUP_FLG, 'N') != 'Y'
              AND CC.ADD_FLG = 'Y'
              AND CC.USR_ID = @[usr_id]
            UNION
			SELECT /*+ LEADING( CC ) */ BB.PGM_NO,
              BB.PGM_NM,
              BB.PGM_URL,
              bb.pgm_lvl_div_cd,
              bb.popup_flg
            FROM COM_PROGRAM BB,
              COM_PGM_ROLE CC
            WHERE BB.PGM_NO = CC.PGM_NO
              AND CC.USR_ROLE_CD = SUBSTR(@[prnt_pgm_no], 5, 3)||'99'
            MINUS
            SELECT BB.PGM_NO,
              BB.PGM_NM,
              BB.PGM_URL,
              bb.pgm_lvl_div_cd,
              bb.popup_flg
            FROM COM_PROGRAM BB,
              COM_USR_PGM_MTCH CC
            WHERE BB.PGM_NO = CC.PGM_NO
              AND BB.PGM_TP_CD = '00'
              AND BB.USE_FLG = 'Y'
              AND NVL(BB.POPUP_FLG, 'N') != 'Y'
              AND CC.ADD_FLG = 'N'
              AND CC.USR_ID = @[usr_id] ) AUTH,
          COM_OFC_PGM_MTCH OFC
        WHERE OFC.OFC_CD=@[ofc_cd]
          AND AUTH.PGM_NO = OFC.PGM_NO ) C
    WHERE A.MNU_CFG_CD = @[mnu_cfg_cd]
      AND A.CHD_PGM_NO = B.PGM_NO
      AND B.USE_FLG = 'Y'
      AND B.POPUP_FLG = 'N'
      AND B.PGM_MNU_DIV_CD = '02'
      AND B.PGM_NO = C.PGM_NO(+) )
SELECT A.LVL,
       A.CHD_PGM_NO,
       A.PGM_NM,
       A.DP_SEQ,
       NVL(B.CHILD_CNT, 0) AS CHILD_CNT,
       A.CHILD_MAX_LEN,
       A.PRNT_PGM_NO,
       A.PGM_URL,
       A.POPUP_FLG,
       A.AUTH_YN,
       A.RN
  FROM 
    ( SELECT ROWNUM RN,
      S.*
      FROM (
	  SELECT LEVEL AS LVL,
      CHD_PGM_NO,
      PGM_NM,
      DP_SEQ,
      0 AS CHILD_MAX_LEN,
      PRNT_PGM_NO,
      PGM_URL,
      POPUP_FLG,
      AUTH_YN
    FROM T1 START WITH PRNT_PGM_NO = @[prnt_pgm_no] CONNECT BY PRIOR CHD_PGM_NO = PRNT_PGM_NO
      AND LEVEL <= @[level]
    ORDER SIBLINGS BY DP_SEQ ) S
	) A,
    ( SELECT PRNT_PGM_NO, COUNT(DISTINCT CHD_PGM_NO) AS CHILD_CNT
        FROM T1
      GROUP BY PRNT_PGM_NO      
    ) B
 WHERE A.CHD_PGM_NO = B.PRNT_PGM_NO(+)
 order by A.RN			]]></sql>
			<params>
				<param name="mnu_cfg_cd" type="12" value="001" out="N"/>
				<param name="usr_id" type="12" value="NIS2010" out="N"/>
				<param name="prnt_pgm_no" type="12" value="NIS-000-000" out="N"/>
				<param name="ofc_cd" type="12" value="" out="N"/>
				<param name="level" type="12" value="6" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
