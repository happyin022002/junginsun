-- 첫번째 CASE : SHUTTLE의 FROM이 변경되어 결과적으로 WD의 TO_NODE가 변경된 CASE
--               이럴 경우 SHUTTLE 발생 전 TO_NODE를 변경함
--               SHUTTLE 발생전 WD 의 TO_NODE를 변경하는 것이 맞는지
--               아니면 WD의 TO는 놔두고 SUTTLE을 추가 하는 것이 맞는지는 TRS파트에 문의할 것!!!
--:COP_NO	String	COSA7606601189
--:PCTL_NO	String	B0706060000039820001
--:ACT_GRP_SEQ	String	410
--:TO_NOD	String	KRPUSYK
--
-- 두번째 CASE : TS PORT의 SHUTTLE이 FM_NOD, TO_NOD가 모두 변경된 CASE 
--               이럴 경우 ACT_GRP_SEQ를 따져서 해당 구간에 SHUTTLE을 추가 하여
--               앞뒤를 연결시켜 준다.
--:PCTL_NO	String	G0706210003461130001
--:COP_NO	String	CHAN7615703500
--:ACT_GRP_SEQ	String	410
--:TO_NOD	String	TWKHHYL

-- 세번째 CASE : OCN의 WD 구간을 TD SHUTTLE로 변경해서 SO를 낸 CASE
--               이럴 경우 배로 운송되야하는 OCN 구간 TD SHUTTLE로 낸 것은 받아 줄 수 없음으로 
--               결과를 RETURN하지 않는다.
--:PCTL_NO	String	R0706160000003360001
--:COP_NO	String	CSLC7607608433
--:ACT_GRP_SEQ	String	420
--:TO_NOD	String	KRPUSYL

----------------------------
SELECT TS_STRING 
FROM 
(
    WITH TBL AS 
    (
        SELECT FM_NOD_CD,
        (CASE WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N1ST_POD_CD --, N2ND_POD_CD,N3RD_POD_CD
                                                        FROM PRD_OCN_ROUT
                                                        WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                        (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                        WHERE PCTL_NO = :PCTL_NO 
                                                                        AND PCTL_IO_BND_CD ='T'
                                                                        AND ROWNUM = 1 )
                                                          AND N1ST_POD_CD =DEST_LOC_CD)
                          THEN 'TS1@*TS2@*TS3@*POD@*'||TO_NOD_CD
              WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N1ST_POD_CD 
                                                        FROM PRD_OCN_ROUT
                                                        WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                        (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                        WHERE PCTL_NO = :PCTL_NO 
                                                                        AND PCTL_IO_BND_CD ='T'
                                                                        AND ROWNUM = 1 ))
                          THEN 'TS1@*'||TO_NOD_CD
              WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N2ND_POD_CD
                                                        FROM PRD_OCN_ROUT
                                                        WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                        (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                        WHERE PCTL_NO = :PCTL_NO 
                                                                        AND PCTL_IO_BND_CD ='T'
                                                                        AND ROWNUM = 1 )
                                                          AND N2ND_POD_CD = DEST_LOC_CD)
                          THEN 'TS2@*TS3@*POD@*'||TO_NOD_CD
              WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N2ND_POD_CD 
                                                        FROM PRD_OCN_ROUT
                                                        WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                        (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                        WHERE PCTL_NO = :PCTL_NO 
                                                                        AND PCTL_IO_BND_CD ='T'
                                                                        AND ROWNUM = 1 ))
                          THEN 'TS2@*'||TO_NOD_CD
              WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N3RD_POD_CD 
                                                        FROM PRD_OCN_ROUT
                                                        WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                        (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                        WHERE PCTL_NO = :PCTL_NO 
                                                                        AND PCTL_IO_BND_CD ='T'
                                                                        AND ROWNUM = 1 )
                                                         AND N3RD_POD_CD = DEST_LOC_CD)
                          THEN 'TS3@*POD@*'||TO_NOD_CD
              WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N3RD_POD_CD 
                                                        FROM PRD_OCN_ROUT
                                                        WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                        (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                        WHERE PCTL_NO = :PCTL_NO 
                                                                        AND PCTL_IO_BND_CD ='T'
                                                                        AND ROWNUM = 1 ))
                          THEN 'TS3@*'||TO_NOD_CD
              WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N4TH_POD_CD 
                                                        FROM PRD_OCN_ROUT
                                                        WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                        (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                        WHERE PCTL_NO = :PCTL_NO 
                                                                        AND PCTL_IO_BND_CD ='T'
                                                                        AND ROWNUM = 1 )
                                                         AND N4TH_POD_CD = DEST_LOC_CD)
                          THEN 'POD@*'||TO_NOD_CD                          
         ELSE TO_NOD_CD
         END ) TO_NOD_CD,
        (CASE WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N1ST_POD_CD 
                                                        FROM PRD_OCN_ROUT
                                                        WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                        (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                        WHERE PCTL_NO = :PCTL_NO 
                                                                        AND PCTL_IO_BND_CD ='T'
                                                                        AND ROWNUM = 1 ))
                          THEN ''
              WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N2ND_POD_CD 
                                                        FROM PRD_OCN_ROUT
                                                        WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                        (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                        WHERE PCTL_NO = :PCTL_NO 
                                                                        AND PCTL_IO_BND_CD ='T'
                                                                        AND ROWNUM = 1 ))
                          THEN ''
             WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N3RD_POD_CD 
                                                        FROM PRD_OCN_ROUT
                                                        WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                        (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                        WHERE PCTL_NO = :PCTL_NO 
                                                                        AND PCTL_IO_BND_CD ='T'
                                                                        AND ROWNUM = 1 ))
                          THEN ''
             WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N4TH_POD_CD 
                                                        FROM PRD_OCN_ROUT
                                                        WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                        (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                        WHERE PCTL_NO = :PCTL_NO 
                                                                        AND PCTL_IO_BND_CD ='T'
                                                                        AND ROWNUM = 1 ))
                          THEN ''                          
         ELSE TRSP_CRR_MOD_CD
         END ) TRSP_CRR_MOD_CD,
         (CASE WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N1ST_POD_CD
                                                        FROM PRD_OCN_ROUT
                                                        WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                        (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                        WHERE PCTL_NO = :PCTL_NO 
                                                                        AND PCTL_IO_BND_CD ='T'
                                                                        AND ROWNUM = 1 ))
                          THEN NULL
              WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N2ND_POD_CD 
                                                        FROM PRD_OCN_ROUT
                                                        WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                        (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                        WHERE PCTL_NO = :PCTL_NO 
                                                                        AND PCTL_IO_BND_CD ='T'
                                                                        AND ROWNUM = 1 ))
                          THEN NULL
             WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N3RD_POD_CD 
                                                        FROM PRD_OCN_ROUT
                                                        WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                        (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                        WHERE PCTL_NO = :PCTL_NO 
                                                                        AND PCTL_IO_BND_CD ='T'
                                                                        AND ROWNUM = 1 ))
                          THEN NULL
             WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N4TH_POD_CD 
                                                        FROM PRD_OCN_ROUT
                                                        WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                        (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                        WHERE PCTL_NO = :PCTL_NO 
                                                                        AND PCTL_IO_BND_CD ='T'
                                                                        AND ROWNUM = 1 ))
                          THEN NULL                          
         ELSE VNDR_SEQ
         END ) VNDR_SEQ,
         RK,RK2
        FROM (
            SELECT FM_NOD_CD,TO_NOD_CD,DECODE(VNDR_SEQ,NULL,'XX',TRSP_CRR_MOD_CD) TRSP_CRR_MOD_CD,
                   NVL(TO_CHAR(VNDR_SEQ),'XXXXXX') VNDR_SEQ,
                   DENSE_RANK () OVER (ORDER BY COST_ACT_GRP_SEQ) RK, 
                   DENSE_RANK () OVER (PARTITION BY SUBSTR(TO_NOD_CD,1,5)  ORDER BY COST_ACT_GRP_SEQ) RK2 
            FROM (
 
                SELECT -- SO에 의해 변경될 NOD TP가 B, M인 경우 기존 LINK 변경
                (CASE WHEN FM_NOD_CD <> LAG (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                       AND SO_FLG ='N' AND LAG ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                       AND ( LAG (TO_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) IN   ('B','M')
                             OR COST_ACT_GRP_SEQ NOT IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                WHERE PCTL_NO = :PCTL_NO 
                                                AND PCTL_IO_BND_CD ='T'
                                                AND PCTL_WTR_DIV_CD IN ('W','V') ) )
                      THEN LAG (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                      ELSE FM_NOD_CD 
                      
                END ) 
                FM_NOD_CD,
                (CASE WHEN TO_NOD_CD <> LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                       AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                       AND ( LEAD (FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) IN   ('B','M')
                             OR COST_ACT_GRP_SEQ NOT IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                WHERE PCTL_NO = :PCTL_NO 
                                                AND PCTL_IO_BND_CD ='T'
                                                AND PCTL_WTR_DIV_CD IN ('W','V') ) )
                      THEN LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                      ELSE TO_NOD_CD
                END )
                TO_NOD_CD,
                (CASE WHEN FM_NOD_CD <> LAG (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                       AND SO_FLG ='N' AND LAG ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                       AND ( LAG (TO_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) IN   ('B','M')
                             OR COST_ACT_GRP_SEQ NOT IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                WHERE PCTL_NO = :PCTL_NO 
                                                AND PCTL_IO_BND_CD ='T'
                                                AND PCTL_WTR_DIV_CD IN ('W','V') ) )
                      THEN 'XX'
                      WHEN TO_NOD_CD <> LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                       AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                       AND ( LEAD (FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) IN   ('B','M')
                             OR COST_ACT_GRP_SEQ NOT IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                WHERE PCTL_NO = :PCTL_NO 
                                                AND PCTL_IO_BND_CD ='T'
                                                AND PCTL_WTR_DIV_CD IN ('W','V') ) )
                      THEN 'XX'
                      ELSE TRSP_CRR_MOD_CD 
                      
                END )
                TRSP_CRR_MOD_CD,
                (CASE WHEN FM_NOD_CD <> LAG (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                       AND SO_FLG ='N' AND LAG ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                       AND ( LAG (TO_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) IN   ('B','M')
                             OR COST_ACT_GRP_SEQ NOT IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                WHERE PCTL_NO = :PCTL_NO 
                                                AND PCTL_IO_BND_CD ='T'
                                                AND PCTL_WTR_DIV_CD IN ('W','V') ) )
                      THEN NULL
                      WHEN TO_NOD_CD <> LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                       AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                       AND ( LEAD (FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) IN   ('B','M')
                             OR COST_ACT_GRP_SEQ NOT IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                WHERE PCTL_NO = :PCTL_NO 
                                                AND PCTL_IO_BND_CD ='T'
                                                AND PCTL_WTR_DIV_CD IN ('W','V') ) )
                      THEN NULL
                      ELSE VNDR_SEQ 
                      
                END )
                VNDR_SEQ,
                COST_ACT_GRP_SEQ,
                SO_FLG
                FROM (
                   SELECT FM_NOD_CD, FM_TP_CD, TO_NOD_CD, TO_TP_CD, TRSP_CRR_MOD_CD, VNDR_SEQ,COST_ACT_GRP_SEQ, SO_FLG
                   FROM (
                    SELECT (CASE WHEN FM_NOD_CD = LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)  
                                  AND TO_NOD_CD = LEAD (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) 
                                  AND SO_FLG ='N'  THEN 'XXXXXXX'
                                  
                                 WHEN FM_NOD_CD = LAG (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)  
                                  AND TO_NOD_CD = LAG (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) 
                                  AND SO_FLG ='N'  THEN 'XXXXXXX'
                                 ELSE FM_NOD_CD
                            END)
                           FM_NOD_CD,
                                  
                           FM_TP_CD,
                           TO_NOD_CD,
                           TO_TP_CD,
                           TRSP_CRR_MOD_CD,
                           VNDR_SEQ,
                           COST_ACT_GRP_SEQ,
                           SO_FLG
                    FROM (            
                        SELECT FM_NOD_CD, N1.NOD_TP_CD FM_TP_CD, 
                        TO_NOD_CD, N2.NOD_TP_CD TO_TP_CD, TRSP_CRR_MOD_CD,VNDR_SEQ,COST_ACT_GRP_SEQ,'Y' SO_FLG 
                        FROM TRS_TRSP_SVC_ORD T, PRD_NODE N1,PRD_NODE N2 
                        WHERE T.COP_NO = :COP_NO 
                         AND T.TRSP_BND_CD ='T' 
                         AND NVL(T.DELT_FLG,'N') <> 'Y' 
                         AND T.FM_NOD_CD = N1.NOD_CD 
                         AND T.TO_NOD_CD = N2.NOD_CD 
                        UNION ALL 
                        SELECT ORG_NOD_CD,ORG_NOD_TP_CD ,DEST_NOD_CD,DEST_NOD_TP_CD,TRSP_MOD_CD,N1ST_VNDR_SEQ,COST_ACT_GRP_SEQ,'N' 
                        FROM PRD_PROD_CTL_ROUT_DTL  D
                        WHERE PCTL_NO = :PCTL_NO 
                        AND NOD_LNK_DIV_CD ='L' 
                        AND PCTL_IO_BND_CD ='T' 
                        AND COST_ACT_GRP_SEQ NOT BETWEEN :ACT_GRP_SEQ
                                                AND NVL((SELECT MAX(COST_ACT_GRP_SEQ) 
                                                     FROM PRD_PROD_CTL_ROUT_DTL 
                                                     WHERE PCTL_NO = :PCTL_NO
                                                     AND DEST_NOD_CD =:TO_NOD 
                                                     AND COST_ACT_GRP_SEQ > :ACT_GRP_SEQ),:ACT_GRP_SEQ) 
                        AND COST_ACT_GRP_SEQ NOT IN 
                                           ( SELECT COST_ACT_GRP_SEQ 
                                             FROM TRS_TRSP_SVC_ORD 
                                             WHERE COP_NO = :COP_NO 
                                             AND TRSP_BND_CD ='T' 
                                             AND NVL(DELT_FLG,'N') <> 'Y') 
                        ORDER BY 7  
                    )
                   )
                   WHERE FM_NOD_CD <> 'XXXXXXX'
                   ORDER BY 7 
                ) 
                UNION  
                SELECT -- SO에 의해 변경될 NOD TP가 B, M인 경우 기존 LINK 변경
                (CASE WHEN TO_NOD_CD <> LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                       AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                       AND ( 'B' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                           AND 'M' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) )
                       AND  COST_ACT_GRP_SEQ IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                WHERE PCTL_NO = :PCTL_NO 
                                                AND PCTL_IO_BND_CD ='T'
                                                AND PCTL_WTR_DIV_CD IN ('W','V') ) 
                      THEN TO_NOD_CD
                      WHEN FM_NOD_CD <> LAG (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                       AND SO_FLG ='N' AND LAG ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                       AND ( LAG (TO_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) IN   ('B','M')
                             OR COST_ACT_GRP_SEQ NOT IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                WHERE PCTL_NO = :PCTL_NO 
                                                AND PCTL_IO_BND_CD ='T'
                                                AND PCTL_WTR_DIV_CD IN ('W','V') ) )
                      THEN LAG (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                      ELSE FM_NOD_CD 
                      
                END ) 
                FM_NOD_CD ,
                (CASE WHEN TO_NOD_CD <> LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                       AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                       AND ( 'B' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                           AND 'M' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) )
                       AND  COST_ACT_GRP_SEQ IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                WHERE PCTL_NO = :PCTL_NO 
                                                AND PCTL_IO_BND_CD ='T'
                                                AND PCTL_WTR_DIV_CD IN ('W','V') ) 
                      THEN LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                     WHEN TO_NOD_CD <> LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                       AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                       AND ( LEAD (FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) IN   ('B','M')
                             OR COST_ACT_GRP_SEQ NOT IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                WHERE PCTL_NO = :PCTL_NO 
                                                AND PCTL_IO_BND_CD ='T'
                                                AND PCTL_WTR_DIV_CD IN ('W','V') ) )
                      THEN LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                      
                      ELSE TO_NOD_CD
                END )
                TO_NOD_CD,
                (CASE WHEN TO_NOD_CD <> LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                       AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                       AND ( 'B' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                           AND 'M' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) )
                       AND  COST_ACT_GRP_SEQ IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                WHERE PCTL_NO = :PCTL_NO 
                                                AND PCTL_IO_BND_CD ='T'
                                                AND PCTL_WTR_DIV_CD IN ('W','V') ) 
                      THEN 'XX'
                      ELSE TRSP_CRR_MOD_CD 
                      
                END )
                TRSP_CRR_MOD_CD,
                (CASE WHEN TO_NOD_CD <> LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                       AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                       AND ( 'B' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                           AND 'M' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) )
                       AND  COST_ACT_GRP_SEQ IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                WHERE PCTL_NO = :PCTL_NO 
                                                AND PCTL_IO_BND_CD ='T'
                                                AND PCTL_WTR_DIV_CD IN ('W','V') ) 
                      THEN NULL
                      ELSE VNDR_SEQ 
                      
                END )
                VNDR_SEQ,
                (CASE WHEN TO_NOD_CD <> LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                       AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                       AND ( 'B' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                           AND 'M' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) )
                       AND  COST_ACT_GRP_SEQ IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                WHERE PCTL_NO = :PCTL_NO 
                                                AND PCTL_IO_BND_CD ='T'
                                                AND PCTL_WTR_DIV_CD IN ('W','V') ) 
                      THEN COST_ACT_GRP_SEQ + 5
                      ELSE COST_ACT_GRP_SEQ 
                      
                END )
                COST_ACT_GRP_SEQ,
                (CASE WHEN TO_NOD_CD <> LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                       AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                       AND ( 'B' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                           AND 'M' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) )
                       AND  COST_ACT_GRP_SEQ IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                WHERE PCTL_NO = :PCTL_NO 
                                                AND PCTL_IO_BND_CD ='T'
                                                AND PCTL_WTR_DIV_CD IN ('W','V') ) 
                      THEN 'N'
                      ELSE SO_FLG 
                      
                END )
                SO_FLG
                FROM (
                   SELECT FM_NOD_CD, FM_TP_CD, TO_NOD_CD, TO_TP_CD, TRSP_CRR_MOD_CD, VNDR_SEQ,COST_ACT_GRP_SEQ, SO_FLG
                   FROM (
                    SELECT (CASE WHEN FM_NOD_CD = LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)  
                                  AND TO_NOD_CD = LEAD (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) 
                                  AND SO_FLG ='N'  THEN 'XXXXXXX'
                                  
                                 WHEN FM_NOD_CD = LAG (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)  
                                  AND TO_NOD_CD = LAG (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) 
                                  AND SO_FLG ='N'  THEN 'XXXXXXX'
                                 ELSE FM_NOD_CD
                            END)
                           FM_NOD_CD,
                                  
                           FM_TP_CD,
                           TO_NOD_CD,
                           TO_TP_CD,
                           TRSP_CRR_MOD_CD,
                           VNDR_SEQ,
                           COST_ACT_GRP_SEQ,
                           SO_FLG
                    FROM (            
                        SELECT FM_NOD_CD, N1.NOD_TP_CD FM_TP_CD, 
                        TO_NOD_CD, N2.NOD_TP_CD TO_TP_CD, TRSP_CRR_MOD_CD,VNDR_SEQ,COST_ACT_GRP_SEQ,'Y' SO_FLG 
                        FROM TRS_TRSP_SVC_ORD T, PRD_NODE N1,PRD_NODE N2 
                        WHERE T.COP_NO = :COP_NO 
                         AND T.TRSP_BND_CD ='T' 
                         AND NVL(T.DELT_FLG,'N') <> 'Y' 
                         AND T.FM_NOD_CD = N1.NOD_CD 
                         AND T.TO_NOD_CD = N2.NOD_CD 
                        UNION ALL 
                        SELECT ORG_NOD_CD,ORG_NOD_TP_CD ,DEST_NOD_CD,DEST_NOD_TP_CD,TRSP_MOD_CD,N1ST_VNDR_SEQ,COST_ACT_GRP_SEQ,'N' 
                        FROM PRD_PROD_CTL_ROUT_DTL  D
                        WHERE PCTL_NO = :PCTL_NO 
                        AND NOD_LNK_DIV_CD ='L' 
                        AND PCTL_IO_BND_CD ='T' 
                        AND COST_ACT_GRP_SEQ NOT BETWEEN :ACT_GRP_SEQ
                                                AND NVL((SELECT MAX(COST_ACT_GRP_SEQ) 
                                                     FROM PRD_PROD_CTL_ROUT_DTL 
                                                     WHERE PCTL_NO = :PCTL_NO
                                                     AND DEST_NOD_CD =:TO_NOD 
                                                     AND COST_ACT_GRP_SEQ > :ACT_GRP_SEQ),:ACT_GRP_SEQ) 
                        AND COST_ACT_GRP_SEQ NOT IN 
                                           ( SELECT COST_ACT_GRP_SEQ 
                                             FROM TRS_TRSP_SVC_ORD 
                                             WHERE COP_NO = :COP_NO 
                                             AND TRSP_BND_CD ='T' 
                                             AND NVL(DELT_FLG,'N') <> 'Y') 
                        ORDER BY 7  
                    )
                   )
                   WHERE FM_NOD_CD <> 'XXXXXXX'
                   ORDER BY 7 
                )      
                UNION 
                SELECT  -- 두개의 앞뒤 LNK의 SO가 발행되고 둘 사이의 LNK가 안되는 경우  연결 LNK 추가
                (CASE WHEN TO_NOD_CD <> LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                       AND SO_FLG ='Y' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                      THEN TO_NOD_CD
                      ELSE 'XXXXXXX'
                END )
                FM_NOD_CD,
                (CASE WHEN TO_NOD_CD <> LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                       AND SO_FLG ='Y' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                      THEN LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                      ELSE 'XXXXXXX'
                END )
                TO_NOD_CD,
                (CASE WHEN TO_NOD_CD <> LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                       AND SO_FLG ='Y' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                      THEN 'XX'
                      ELSE 'XX'
                END )
                TRSP_CRR_MOD_CD,
                NULL
                VNDR_SEQ,
                (CASE WHEN TO_NOD_CD <> LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                       AND SO_FLG ='Y' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                      THEN COST_ACT_GRP_SEQ + 5
                      ELSE NULL
                END )
                COST_ACT_GRP_SEQ,
                (CASE WHEN TO_NOD_CD <> LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                       AND SO_FLG ='Y' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                      THEN 'N'
                      ELSE NULL
                END )
                SO_FLG
                FROM (
                   SELECT FM_NOD_CD, FM_TP_CD, TO_NOD_CD, TO_TP_CD, TRSP_CRR_MOD_CD, VNDR_SEQ,COST_ACT_GRP_SEQ, SO_FLG
                   FROM (
                    SELECT (CASE WHEN FM_NOD_CD = LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)  
                                  AND TO_NOD_CD = LEAD (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) 
                                  AND SO_FLG ='N'  THEN 'XXXXXXX'
                                  
                                 WHEN FM_NOD_CD = LAG (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)  
                                  AND TO_NOD_CD = LAG (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) 
                                  AND SO_FLG ='N'  THEN 'XXXXXXX'
                                 ELSE FM_NOD_CD
                            END)
                           FM_NOD_CD,
                                  
                           FM_TP_CD,
                           TO_NOD_CD,
                           TO_TP_CD,
                           TRSP_CRR_MOD_CD,
                           VNDR_SEQ,
                           COST_ACT_GRP_SEQ,
                           SO_FLG
                    FROM (            
                        SELECT FM_NOD_CD, N1.NOD_TP_CD FM_TP_CD, 
                        TO_NOD_CD, N2.NOD_TP_CD TO_TP_CD, TRSP_CRR_MOD_CD,VNDR_SEQ,COST_ACT_GRP_SEQ,'Y' SO_FLG 
                        FROM TRS_TRSP_SVC_ORD T, PRD_NODE N1,PRD_NODE N2 
                        WHERE T.COP_NO = :COP_NO 
                         AND T.TRSP_BND_CD ='T' 
                         AND NVL(T.DELT_FLG,'N') <> 'Y' 
                         AND T.FM_NOD_CD = N1.NOD_CD 
                         AND T.TO_NOD_CD = N2.NOD_CD 
                        UNION ALL 
                        SELECT ORG_NOD_CD,ORG_NOD_TP_CD ,DEST_NOD_CD,DEST_NOD_TP_CD,TRSP_MOD_CD,N1ST_VNDR_SEQ,COST_ACT_GRP_SEQ,'N' 
                        FROM PRD_PROD_CTL_ROUT_DTL  D
                        WHERE PCTL_NO = :PCTL_NO 
                        AND NOD_LNK_DIV_CD ='L' 
                        AND PCTL_IO_BND_CD ='T' 
                        AND COST_ACT_GRP_SEQ NOT BETWEEN :ACT_GRP_SEQ
                                                AND NVL((SELECT MAX(COST_ACT_GRP_SEQ) 
                                                     FROM PRD_PROD_CTL_ROUT_DTL 
                                                     WHERE PCTL_NO = :PCTL_NO
                                                     AND DEST_NOD_CD =:TO_NOD 
                                                     AND COST_ACT_GRP_SEQ > :ACT_GRP_SEQ),:ACT_GRP_SEQ) 
                        AND COST_ACT_GRP_SEQ NOT IN 
                                           ( SELECT COST_ACT_GRP_SEQ 
                                             FROM TRS_TRSP_SVC_ORD 
                                             WHERE COP_NO = :COP_NO 
                                             AND TRSP_BND_CD ='T' 
                                             AND NVL(DELT_FLG,'N') <> 'Y') 
                        ORDER BY 7  
                    )
                   )
                   WHERE FM_NOD_CD <> 'XXXXXXX'
                   ORDER BY 7 
                )                
            ) WHERE FM_NOD_CD NOT LIKE 'X%X'
        ) )
    SELECT   
    'POL'||REPLACE(MAX(                        
                   SYS_CONNECT_BY_PATH(
                   DECODE(SUBSTR(TBL.TO_NOD_CD,1,2),'TS','','PO','',
                   TBL.TRSP_CRR_MOD_CD||'@*'||
                   LPAD(TBL.VNDR_SEQ,6,0)||'@*')||     
                   DECODE(RK,1,TBL.FM_NOD_CD||'@*'||TBL.TO_NOD_CD,TBL.TO_NOD_CD) , '-')),'@*','-') TS_STRING
    FROM TBL
    START WITH RK = 1
    CONNECT BY PRIOR RK  = RK -1
)
WHERE TS_STRING LIKE 'POL-%TS1-%TS2-%TS3-%POD-%'
;

---------------------------------------------------------------------------------------------------------------
SELECT TS_STRING 
FROM 
(
    SELECT (CASE WHEN INSTR(TS_STRING,'POD-') > 0  THEN TS_STRING
                 ELSE TS_STRING||'POD-'||(SELECT /*+ INDEX_DESC (PRD_PROD_CTL_ROUT_DTL XPPRD_PROD_CTL_ROUT_DTL) */  DEST_NOD_CD
                                          FROM PRD_PROD_CTL_ROUT_DTL 
                                          WHERE PCTL_NO =:PCTL_NO 
                                          AND PCTL_IO_BND_CD ='T'
                                          AND ROWNUM =1)
           END ) TS_STRING
    FROM 
    (
        WITH TBL AS 
        (
            SELECT FM_NOD_CD,
            (CASE WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N1ST_POD_CD --, N2ND_POD_CD,N3RD_POD_CD
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 )
                                                              AND N1ST_POD_CD =DEST_LOC_CD)
                              THEN 'TS1@*TS2@*TS3@*POD@*'||TO_NOD_CD
                  WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N1ST_POD_CD 
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 ))
                              THEN 'TS1@*'||TO_NOD_CD
                  WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N2ND_POD_CD
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 )
                                                              AND N2ND_POD_CD = DEST_LOC_CD)
                              THEN 'TS2@*TS3@*POD@*'||TO_NOD_CD
                  WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N2ND_POD_CD 
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 ))
                              THEN 'TS2@*'||TO_NOD_CD
                  WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N3RD_POD_CD 
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 )
                                                             AND N3RD_POD_CD = DEST_LOC_CD)
                              THEN 'TS3@*POD@*'||TO_NOD_CD
                  WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N3RD_POD_CD 
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 ))
                              THEN 'TS3@*'||TO_NOD_CD
                  WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N4TH_POD_CD 
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 )
                                                             AND N4TH_POD_CD = DEST_LOC_CD)
                              THEN 'POD@*'||TO_NOD_CD                          
             ELSE TO_NOD_CD
             END ) TO_NOD_CD,
            (CASE WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N1ST_POD_CD 
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 ))
                              THEN ''
                  WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N2ND_POD_CD 
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 ))
                              THEN ''
                 WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N3RD_POD_CD 
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 ))
                              THEN ''
                 WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N4TH_POD_CD 
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 ))
                              THEN ''                          
             ELSE TRSP_CRR_MOD_CD
             END ) TRSP_CRR_MOD_CD,
             (CASE WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N1ST_POD_CD
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 ))
                              THEN NULL
                  WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N2ND_POD_CD 
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 ))
                              THEN NULL
                 WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N3RD_POD_CD 
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 ))
                              THEN NULL
                 WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N4TH_POD_CD 
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 ))
                              THEN NULL                          
             ELSE VNDR_SEQ
             END ) VNDR_SEQ,
             RK,RK2
            FROM (
                SELECT FM_NOD_CD,TO_NOD_CD,DECODE(VNDR_SEQ,NULL,'XX',TRSP_CRR_MOD_CD) TRSP_CRR_MOD_CD,
                       NVL(TO_CHAR(VNDR_SEQ),'XXXXXX') VNDR_SEQ,
                       DENSE_RANK () OVER (ORDER BY COST_ACT_GRP_SEQ) RK, 
                       DENSE_RANK () OVER (PARTITION BY SUBSTR(TO_NOD_CD,1,5)  ORDER BY COST_ACT_GRP_SEQ) RK2 
                FROM (
     
                    SELECT -- SO에 의해 변경될 NOD TP가 B, M인 경우 기존 LINK 변경
                    (CASE WHEN FM_NOD_CD <> LAG (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='N' AND LAG ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                           AND ( LAG (TO_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) IN   ('B','M')
                                 OR COST_ACT_GRP_SEQ NOT IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                    WHERE PCTL_NO = :PCTL_NO 
                                                    AND PCTL_IO_BND_CD ='T'
                                                    AND PCTL_WTR_DIV_CD IN ('W','V') ) )
                          THEN LAG (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                          ELSE FM_NOD_CD 
                          
                    END ) 
                    FM_NOD_CD,
                    (CASE WHEN TO_NOD_CD <> LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                           AND ( LEAD (FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) IN   ('B','M')
                                 OR COST_ACT_GRP_SEQ NOT IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                    WHERE PCTL_NO = :PCTL_NO 
                                                    AND PCTL_IO_BND_CD ='T'
                                                    AND PCTL_WTR_DIV_CD IN ('W','V') ) )
                          THEN LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                          ELSE TO_NOD_CD
                    END )
                    TO_NOD_CD,
                    (CASE WHEN FM_NOD_CD <> LAG (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='N' AND LAG ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                           AND ( LAG (TO_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) IN   ('B','M')
                                 OR COST_ACT_GRP_SEQ NOT IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                    WHERE PCTL_NO = :PCTL_NO 
                                                    AND PCTL_IO_BND_CD ='T'
                                                    AND PCTL_WTR_DIV_CD IN ('W','V') ) )
                          THEN 'XX'
                          WHEN TO_NOD_CD <> LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                           AND ( LEAD (FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) IN   ('B','M')
                                 OR COST_ACT_GRP_SEQ NOT IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                    WHERE PCTL_NO = :PCTL_NO 
                                                    AND PCTL_IO_BND_CD ='T'
                                                    AND PCTL_WTR_DIV_CD IN ('W','V') ) )
                          THEN 'XX'
                          ELSE TRSP_CRR_MOD_CD 
                          
                    END )
                    TRSP_CRR_MOD_CD,
                    (CASE WHEN FM_NOD_CD <> LAG (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='N' AND LAG ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                           AND ( LAG (TO_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) IN   ('B','M')
                                 OR COST_ACT_GRP_SEQ NOT IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                    WHERE PCTL_NO = :PCTL_NO 
                                                    AND PCTL_IO_BND_CD ='T'
                                                    AND PCTL_WTR_DIV_CD IN ('W','V') ) )
                          THEN NULL
                          WHEN TO_NOD_CD <> LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                           AND ( LEAD (FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) IN   ('B','M')
                                 OR COST_ACT_GRP_SEQ NOT IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                    WHERE PCTL_NO = :PCTL_NO 
                                                    AND PCTL_IO_BND_CD ='T'
                                                    AND PCTL_WTR_DIV_CD IN ('W','V') ) )
                          THEN NULL
                          ELSE VNDR_SEQ 
                          
                    END )
                    VNDR_SEQ,
                    COST_ACT_GRP_SEQ,
                    SO_FLG
                    FROM (
                       SELECT FM_NOD_CD, FM_TP_CD, TO_NOD_CD, TO_TP_CD, TRSP_CRR_MOD_CD, VNDR_SEQ,COST_ACT_GRP_SEQ, SO_FLG
                       FROM (
                        SELECT (CASE WHEN FM_NOD_CD = LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)  
                                      AND TO_NOD_CD = LEAD (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) 
                                      AND SO_FLG ='N'  THEN 'XXXXXXX'
                                      
                                     WHEN FM_NOD_CD = LAG (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)  
                                      AND TO_NOD_CD = LAG (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) 
                                      AND SO_FLG ='N'  THEN 'XXXXXXX'
                                     ELSE FM_NOD_CD
                                END)
                               FM_NOD_CD,
                                      
                               FM_TP_CD,
                               TO_NOD_CD,
                               TO_TP_CD,
                               TRSP_CRR_MOD_CD,
                               VNDR_SEQ,
                               COST_ACT_GRP_SEQ,
                               SO_FLG
                        FROM (            
                            SELECT FM_NOD_CD, N1.NOD_TP_CD FM_TP_CD, 
                            TO_NOD_CD, N2.NOD_TP_CD TO_TP_CD, TRSP_CRR_MOD_CD,VNDR_SEQ,COST_ACT_GRP_SEQ,'Y' SO_FLG 
                            FROM TRS_TRSP_SVC_ORD T, PRD_NODE N1,PRD_NODE N2 
                            WHERE T.COP_NO = :COP_NO 
                             AND T.TRSP_BND_CD ='T' 
                             AND NVL(T.DELT_FLG,'N') <> 'Y' 
                             AND T.FM_NOD_CD = N1.NOD_CD 
                             AND T.TO_NOD_CD = N2.NOD_CD 
                            UNION ALL 
                            SELECT ORG_NOD_CD,ORG_NOD_TP_CD ,DEST_NOD_CD,DEST_NOD_TP_CD,TRSP_MOD_CD,N1ST_VNDR_SEQ,COST_ACT_GRP_SEQ,'N' 
                            FROM PRD_PROD_CTL_ROUT_DTL  D
                            WHERE PCTL_NO = :PCTL_NO 
                            AND NOD_LNK_DIV_CD ='L' 
                            AND PCTL_IO_BND_CD ='T' 
                            AND COST_ACT_GRP_SEQ NOT BETWEEN :ACT_GRP_SEQ
                                                    AND NVL((SELECT MAX(COST_ACT_GRP_SEQ) 
                                                         FROM PRD_PROD_CTL_ROUT_DTL 
                                                         WHERE PCTL_NO = :PCTL_NO
                                                         AND DEST_NOD_CD =:TO_NOD 
                                                         AND COST_ACT_GRP_SEQ > :ACT_GRP_SEQ),:ACT_GRP_SEQ) 
                            AND COST_ACT_GRP_SEQ NOT IN 
                                               ( SELECT COST_ACT_GRP_SEQ 
                                                 FROM TRS_TRSP_SVC_ORD 
                                                 WHERE COP_NO = :COP_NO 
                                                 AND TRSP_BND_CD ='T' 
                                                 AND NVL(DELT_FLG,'N') <> 'Y') 
                            ORDER BY 7  
                        )
                       )
                       WHERE FM_NOD_CD <> 'XXXXXXX'
                       ORDER BY 7 
                    ) 
                    UNION  
                    SELECT -- SO에 의해 변경될 NOD TP가 B, M인 경우 기존 LINK 변경
                    (CASE WHEN TO_NOD_CD <> LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                           AND ( 'B' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                               AND 'M' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) )
                           AND  COST_ACT_GRP_SEQ IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                    WHERE PCTL_NO = :PCTL_NO 
                                                    AND PCTL_IO_BND_CD ='T'
                                                    AND PCTL_WTR_DIV_CD IN ('W','V') ) 
                          THEN TO_NOD_CD
                          WHEN FM_NOD_CD <> LAG (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='N' AND LAG ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                           AND ( LAG (TO_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) IN   ('B','M')
                                 OR COST_ACT_GRP_SEQ NOT IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                    WHERE PCTL_NO = :PCTL_NO 
                                                    AND PCTL_IO_BND_CD ='T'
                                                    AND PCTL_WTR_DIV_CD IN ('W','V') ) )
                          THEN LAG (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                          ELSE FM_NOD_CD 
                          
                    END ) 
                    FM_NOD_CD ,
                    (CASE WHEN TO_NOD_CD <> LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                           AND ( 'B' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                               AND 'M' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) )
                           AND  COST_ACT_GRP_SEQ IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                    WHERE PCTL_NO = :PCTL_NO 
                                                    AND PCTL_IO_BND_CD ='T'
                                                    AND PCTL_WTR_DIV_CD IN ('W','V') ) 
                          THEN LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                         WHEN TO_NOD_CD <> LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                           AND ( LEAD (FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) IN   ('B','M')
                                 OR COST_ACT_GRP_SEQ NOT IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                    WHERE PCTL_NO = :PCTL_NO 
                                                    AND PCTL_IO_BND_CD ='T'
                                                    AND PCTL_WTR_DIV_CD IN ('W','V') ) )
                          THEN LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                          
                          ELSE TO_NOD_CD
                    END )
                    TO_NOD_CD,
                    (CASE WHEN TO_NOD_CD <> LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                           AND ( 'B' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                               AND 'M' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) )
                           AND  COST_ACT_GRP_SEQ IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                    WHERE PCTL_NO = :PCTL_NO 
                                                    AND PCTL_IO_BND_CD ='T'
                                                    AND PCTL_WTR_DIV_CD IN ('W','V') ) 
                          THEN 'XX'
                          ELSE TRSP_CRR_MOD_CD 
                          
                    END )
                    TRSP_CRR_MOD_CD,
                    (CASE WHEN TO_NOD_CD <> LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                           AND ( 'B' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                               AND 'M' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) )
                           AND  COST_ACT_GRP_SEQ IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                    WHERE PCTL_NO = :PCTL_NO 
                                                    AND PCTL_IO_BND_CD ='T'
                                                    AND PCTL_WTR_DIV_CD IN ('W','V') ) 
                          THEN NULL
                          ELSE VNDR_SEQ 
                          
                    END )
                    VNDR_SEQ,
                    (CASE WHEN TO_NOD_CD <> LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                           AND ( 'B' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                               AND 'M' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) )
                           AND  COST_ACT_GRP_SEQ IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                    WHERE PCTL_NO = :PCTL_NO 
                                                    AND PCTL_IO_BND_CD ='T'
                                                    AND PCTL_WTR_DIV_CD IN ('W','V') ) 
                          THEN COST_ACT_GRP_SEQ + 5
                          ELSE COST_ACT_GRP_SEQ 
                          
                    END )
                    COST_ACT_GRP_SEQ,
                    (CASE WHEN TO_NOD_CD <> LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                           AND ( 'B' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                               AND 'M' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) )
                           AND  COST_ACT_GRP_SEQ IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                    WHERE PCTL_NO = :PCTL_NO 
                                                    AND PCTL_IO_BND_CD ='T'
                                                    AND PCTL_WTR_DIV_CD IN ('W','V') ) 
                          THEN 'N'
                          ELSE SO_FLG 
                          
                    END )
                    SO_FLG
                    FROM (
                       SELECT FM_NOD_CD, FM_TP_CD, TO_NOD_CD, TO_TP_CD, TRSP_CRR_MOD_CD, VNDR_SEQ,COST_ACT_GRP_SEQ, SO_FLG
                       FROM (
                        SELECT (CASE WHEN FM_NOD_CD = LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)  
                                      AND TO_NOD_CD = LEAD (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) 
                                      AND SO_FLG ='N'  THEN 'XXXXXXX'
                                      
                                     WHEN FM_NOD_CD = LAG (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)  
                                      AND TO_NOD_CD = LAG (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) 
                                      AND SO_FLG ='N'  THEN 'XXXXXXX'
                                     ELSE FM_NOD_CD
                                END)
                               FM_NOD_CD,
                                      
                               FM_TP_CD,
                               TO_NOD_CD,
                               TO_TP_CD,
                               TRSP_CRR_MOD_CD,
                               VNDR_SEQ,
                               COST_ACT_GRP_SEQ,
                               SO_FLG
                        FROM (            
                            SELECT FM_NOD_CD, N1.NOD_TP_CD FM_TP_CD, 
                            TO_NOD_CD, N2.NOD_TP_CD TO_TP_CD, TRSP_CRR_MOD_CD,VNDR_SEQ,COST_ACT_GRP_SEQ,'Y' SO_FLG 
                            FROM TRS_TRSP_SVC_ORD T, PRD_NODE N1,PRD_NODE N2 
                            WHERE T.COP_NO = :COP_NO 
                             AND T.TRSP_BND_CD ='T' 
                             AND NVL(T.DELT_FLG,'N') <> 'Y' 
                             AND T.FM_NOD_CD = N1.NOD_CD 
                             AND T.TO_NOD_CD = N2.NOD_CD 
                            UNION ALL 
                            SELECT ORG_NOD_CD,ORG_NOD_TP_CD ,DEST_NOD_CD,DEST_NOD_TP_CD,TRSP_MOD_CD,N1ST_VNDR_SEQ,COST_ACT_GRP_SEQ,'N' 
                            FROM PRD_PROD_CTL_ROUT_DTL  D
                            WHERE PCTL_NO = :PCTL_NO 
                            AND NOD_LNK_DIV_CD ='L' 
                            AND PCTL_IO_BND_CD ='T' 
                            AND COST_ACT_GRP_SEQ NOT BETWEEN :ACT_GRP_SEQ
                                                    AND NVL((SELECT MAX(COST_ACT_GRP_SEQ) 
                                                         FROM PRD_PROD_CTL_ROUT_DTL 
                                                         WHERE PCTL_NO = :PCTL_NO
                                                         AND DEST_NOD_CD =:TO_NOD 
                                                         AND COST_ACT_GRP_SEQ > :ACT_GRP_SEQ),:ACT_GRP_SEQ) 
                            AND COST_ACT_GRP_SEQ NOT IN 
                                               ( SELECT COST_ACT_GRP_SEQ 
                                                 FROM TRS_TRSP_SVC_ORD 
                                                 WHERE COP_NO = :COP_NO 
                                                 AND TRSP_BND_CD ='T' 
                                                 AND NVL(DELT_FLG,'N') <> 'Y') 
                            ORDER BY 7  
                        )
                       )
                       WHERE FM_NOD_CD <> 'XXXXXXX'
                       ORDER BY 7 
                    )      
                    UNION 
                    SELECT  -- 두개의 앞뒤 LNK의 SO가 발행되고 둘 사이의 LNK가 안되는 경우  연결 LNK 추가
                    (CASE WHEN TO_NOD_CD <> LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='Y' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                          THEN TO_NOD_CD
                          ELSE 'XXXXXXX'
                    END )
                    FM_NOD_CD,
                    (CASE WHEN TO_NOD_CD <> LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='Y' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                          THEN LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                          ELSE 'XXXXXXX'
                    END )
                    TO_NOD_CD,
                    (CASE WHEN TO_NOD_CD <> LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='Y' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                          THEN 'XX'
                          ELSE 'XX'
                    END )
                    TRSP_CRR_MOD_CD,
                    NULL
                    VNDR_SEQ,
                    (CASE WHEN TO_NOD_CD <> LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='Y' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                          THEN COST_ACT_GRP_SEQ + 5
                          ELSE NULL
                    END )
                    COST_ACT_GRP_SEQ,
                    (CASE WHEN TO_NOD_CD <> LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='Y' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                          THEN 'N'
                          ELSE NULL
                    END )
                    SO_FLG
                    FROM (
                       SELECT FM_NOD_CD, FM_TP_CD, TO_NOD_CD, TO_TP_CD, TRSP_CRR_MOD_CD, VNDR_SEQ,COST_ACT_GRP_SEQ, SO_FLG
                       FROM (
                        SELECT (CASE WHEN FM_NOD_CD = LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)  
                                      AND TO_NOD_CD = LEAD (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) 
                                      AND SO_FLG ='N'  THEN 'XXXXXXX'
                                      
                                     WHEN FM_NOD_CD = LAG (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)  
                                      AND TO_NOD_CD = LAG (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) 
                                      AND SO_FLG ='N'  THEN 'XXXXXXX'
                                     ELSE FM_NOD_CD
                                END)
                               FM_NOD_CD,
                                      
                               FM_TP_CD,
                               TO_NOD_CD,
                               TO_TP_CD,
                               TRSP_CRR_MOD_CD,
                               VNDR_SEQ,
                               COST_ACT_GRP_SEQ,
                               SO_FLG
                        FROM (            
                            SELECT FM_NOD_CD, N1.NOD_TP_CD FM_TP_CD, 
                            TO_NOD_CD, N2.NOD_TP_CD TO_TP_CD, TRSP_CRR_MOD_CD,VNDR_SEQ,COST_ACT_GRP_SEQ,'Y' SO_FLG 
                            FROM TRS_TRSP_SVC_ORD T, PRD_NODE N1,PRD_NODE N2 
                            WHERE T.COP_NO = :COP_NO 
                             AND T.TRSP_BND_CD ='T' 
                             AND NVL(T.DELT_FLG,'N') <> 'Y' 
                             AND T.FM_NOD_CD = N1.NOD_CD 
                             AND T.TO_NOD_CD = N2.NOD_CD 
                            UNION ALL 
                            SELECT ORG_NOD_CD,ORG_NOD_TP_CD ,DEST_NOD_CD,DEST_NOD_TP_CD,TRSP_MOD_CD,N1ST_VNDR_SEQ,COST_ACT_GRP_SEQ,'N' 
                            FROM PRD_PROD_CTL_ROUT_DTL  D
                            WHERE PCTL_NO = :PCTL_NO 
                            AND NOD_LNK_DIV_CD ='L' 
                            AND PCTL_IO_BND_CD ='T' 
                            AND COST_ACT_GRP_SEQ NOT BETWEEN :ACT_GRP_SEQ
                                                    AND NVL((SELECT MAX(COST_ACT_GRP_SEQ) 
                                                         FROM PRD_PROD_CTL_ROUT_DTL 
                                                         WHERE PCTL_NO = :PCTL_NO
                                                         AND DEST_NOD_CD =:TO_NOD 
                                                         AND COST_ACT_GRP_SEQ > :ACT_GRP_SEQ),:ACT_GRP_SEQ) 
                            AND COST_ACT_GRP_SEQ NOT IN 
                                               ( SELECT COST_ACT_GRP_SEQ 
                                                 FROM TRS_TRSP_SVC_ORD 
                                                 WHERE COP_NO = :COP_NO 
                                                 AND TRSP_BND_CD ='T' 
                                                 AND NVL(DELT_FLG,'N') <> 'Y') 
                            ORDER BY 7  
                        )
                       )
                       WHERE FM_NOD_CD <> 'XXXXXXX'
                       ORDER BY 7 
                    )                
                ) WHERE FM_NOD_CD NOT LIKE 'X%X'
            ) )
        SELECT   
        'POL'||REPLACE(MAX(                        
                       SYS_CONNECT_BY_PATH(
                       DECODE(SUBSTR(TBL.TO_NOD_CD,1,2),'TS','','PO','',
                       TBL.TRSP_CRR_MOD_CD||'@*'||
                       LPAD(TBL.VNDR_SEQ,6,0)||'@*')||     
                       DECODE(RK,1,TBL.FM_NOD_CD||'@*'||TBL.TO_NOD_CD,TBL.TO_NOD_CD) , '-')),'@*','-') TS_STRING
        FROM TBL
        START WITH RK = 1
        CONNECT BY PRIOR RK  = RK -1
    )
)
WHERE TS_STRING LIKE 'POL-%TS1-%TS2-%TS3-%POD-%'
;

-------------------------------------------------------
SELECT REPLACE(TS_STRING,'--','-') TS_STRING
FROM 
(
    SELECT (CASE WHEN INSTR(TS_STRING,'POD-') > 0  THEN TS_STRING
                 WHEN INSTR(TS_STRING,'TS1-') <= 0 THEN TS_STRING||'-TS1-TS2-TS3-POD-'||(SELECT /*+ INDEX_DESC (PRD_PROD_CTL_ROUT_DTL XPKPRD_PROD_CTL_ROUT_DTL) */  DEST_NOD_CD
                                                                                         FROM PRD_PROD_CTL_ROUT_DTL 
                                                                                         WHERE PCTL_NO =:PCTL_NO 
                                                                                         AND PCTL_IO_BND_CD ='T'
                                                                                         AND ROWNUM =1)
                 WHEN INSTR(TS_STRING,'TS2-') <= 0 THEN TS_STRING||'-TS2-TS3-POD-'||(SELECT /*+ INDEX_DESC (PRD_PROD_CTL_ROUT_DTL XPKPRD_PROD_CTL_ROUT_DTL) */  DEST_NOD_CD
                                                                                     FROM PRD_PROD_CTL_ROUT_DTL 
                                                                                     WHERE PCTL_NO =:PCTL_NO 
                                                                                     AND PCTL_IO_BND_CD ='T'
                                                                                     AND ROWNUM =1)
                 WHEN INSTR(TS_STRING,'TS3-') <= 0 THEN TS_STRING||'-TS3-POD-'||(SELECT /*+ INDEX_DESC (PRD_PROD_CTL_ROUT_DTL XPKPRD_PROD_CTL_ROUT_DTL) */  DEST_NOD_CD
                                                                                 FROM PRD_PROD_CTL_ROUT_DTL 
                                                                                 WHERE PCTL_NO =:PCTL_NO 
                                                                                 AND PCTL_IO_BND_CD ='T'
                                                                                 AND ROWNUM =1)    
        
    
                 ELSE TS_STRING||'-POD-'||(SELECT /*+ INDEX_DESC (PRD_PROD_CTL_ROUT_DTL XPPRD_PROD_CTL_ROUT_DTL) */  DEST_NOD_CD
                                          FROM PRD_PROD_CTL_ROUT_DTL 
                                          WHERE PCTL_NO =:PCTL_NO 
                                          AND PCTL_IO_BND_CD ='T'
                                          AND ROWNUM =1)
           END ) TS_STRING
    FROM 
    (
        WITH TBL AS 
        (
            SELECT FM_NOD_CD,
            (CASE WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N1ST_POD_CD --, N2ND_POD_CD,N3RD_POD_CD
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 )
                                                              AND N1ST_POD_CD =DEST_LOC_CD)
                              THEN 'TS1@*TS2@*TS3@*POD@*'||TO_NOD_CD
                  WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N1ST_POD_CD 
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 ))
                              THEN 'TS1@*'||TO_NOD_CD
                  WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N2ND_POD_CD
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 )
                                                              AND N2ND_POD_CD = DEST_LOC_CD)
                              THEN 'TS2@*TS3@*POD@*'||TO_NOD_CD
                  WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N2ND_POD_CD 
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 ))
                              THEN 'TS2@*'||TO_NOD_CD
                  WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N3RD_POD_CD 
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 )
                                                             AND N3RD_POD_CD = DEST_LOC_CD)
                              THEN 'TS3@*POD@*'||TO_NOD_CD
                  WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N3RD_POD_CD 
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 ))
                              THEN 'TS3@*'||TO_NOD_CD
                  WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N4TH_POD_CD 
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 )
                                                             AND N4TH_POD_CD = DEST_LOC_CD)
                              THEN 'POD@*'||TO_NOD_CD                          
             ELSE TO_NOD_CD
             END ) TO_NOD_CD,
            (CASE WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N1ST_POD_CD 
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 ))
                              THEN ''
                  WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N2ND_POD_CD 
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 ))
                              THEN ''
                 WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N3RD_POD_CD 
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 ))
                              THEN ''
                 WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N4TH_POD_CD 
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 ))
                              THEN ''                          
             ELSE TRSP_CRR_MOD_CD
             END ) TRSP_CRR_MOD_CD,
             (CASE WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N1ST_POD_CD
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 ))
                              THEN NULL
                  WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N2ND_POD_CD 
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 ))
                              THEN NULL
                 WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N3RD_POD_CD 
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 ))
                              THEN NULL
                 WHEN RK2 = 1 AND SUBSTR(TO_NOD_CD,1,5) = (SELECT N4TH_POD_CD 
                                                            FROM PRD_OCN_ROUT
                                                            WHERE (ORG_LOC_CD , DEST_LOC_CD , ROUT_SEQ )= 
                                                                            (SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                                            WHERE PCTL_NO = :PCTL_NO 
                                                                            AND PCTL_IO_BND_CD ='T'
                                                                            AND ROWNUM = 1 ))
                              THEN NULL                          
             ELSE VNDR_SEQ
             END ) VNDR_SEQ,
             RK,RK2
            FROM (
                SELECT FM_NOD_CD,TO_NOD_CD,DECODE(VNDR_SEQ,NULL,'XX',TRSP_CRR_MOD_CD) TRSP_CRR_MOD_CD,
                       NVL(TO_CHAR(VNDR_SEQ),'XXXXXX') VNDR_SEQ,
                       DENSE_RANK () OVER (ORDER BY COST_ACT_GRP_SEQ) RK, 
                       DENSE_RANK () OVER (PARTITION BY SUBSTR(TO_NOD_CD,1,5)  ORDER BY COST_ACT_GRP_SEQ) RK2 
                FROM (
     
                    SELECT -- SO에 의해 변경될 NOD TP가 B, M인 경우 기존 LINK 변경
                    (CASE WHEN FM_NOD_CD <> LAG (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='N' AND LAG ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                           AND ( LAG (TO_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) IN   ('B','M')
                                 OR COST_ACT_GRP_SEQ NOT IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                    WHERE PCTL_NO = :PCTL_NO 
                                                    AND PCTL_IO_BND_CD ='T'
                                                    AND PCTL_WTR_DIV_CD IN ('W','V') ) )
                          THEN LAG (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                          ELSE FM_NOD_CD 
                          
                    END ) 
                    FM_NOD_CD,
                    (CASE WHEN TO_NOD_CD <> LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                           AND ( LEAD (FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) IN   ('B','M')
                                 OR COST_ACT_GRP_SEQ NOT IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                    WHERE PCTL_NO = :PCTL_NO 
                                                    AND PCTL_IO_BND_CD ='T'
                                                    AND PCTL_WTR_DIV_CD IN ('W','V') ) )
                          THEN LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                          ELSE TO_NOD_CD
                    END )
                    TO_NOD_CD,
                    (CASE WHEN FM_NOD_CD <> LAG (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='N' AND LAG ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                           AND ( LAG (TO_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) IN   ('B','M')
                                 OR COST_ACT_GRP_SEQ NOT IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                    WHERE PCTL_NO = :PCTL_NO 
                                                    AND PCTL_IO_BND_CD ='T'
                                                    AND PCTL_WTR_DIV_CD IN ('W','V') ) )
                          THEN 'XX'
                          WHEN TO_NOD_CD <> LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                           AND ( LEAD (FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) IN   ('B','M')
                                 OR COST_ACT_GRP_SEQ NOT IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                    WHERE PCTL_NO = :PCTL_NO 
                                                    AND PCTL_IO_BND_CD ='T'
                                                    AND PCTL_WTR_DIV_CD IN ('W','V') ) )
                          THEN 'XX'
                          ELSE TRSP_CRR_MOD_CD 
                          
                    END )
                    TRSP_CRR_MOD_CD,
                    (CASE WHEN FM_NOD_CD <> LAG (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='N' AND LAG ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                           AND ( LAG (TO_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) IN   ('B','M')
                                 OR COST_ACT_GRP_SEQ NOT IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                    WHERE PCTL_NO = :PCTL_NO 
                                                    AND PCTL_IO_BND_CD ='T'
                                                    AND PCTL_WTR_DIV_CD IN ('W','V') ) )
                          THEN NULL
                          WHEN TO_NOD_CD <> LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                           AND ( LEAD (FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) IN   ('B','M')
                                 OR COST_ACT_GRP_SEQ NOT IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                    WHERE PCTL_NO = :PCTL_NO 
                                                    AND PCTL_IO_BND_CD ='T'
                                                    AND PCTL_WTR_DIV_CD IN ('W','V') ) )
                          THEN NULL
                          ELSE VNDR_SEQ 
                          
                    END )
                    VNDR_SEQ,
                    COST_ACT_GRP_SEQ,
                    SO_FLG
                    FROM (
                       SELECT FM_NOD_CD, FM_TP_CD, TO_NOD_CD, TO_TP_CD, TRSP_CRR_MOD_CD, VNDR_SEQ,COST_ACT_GRP_SEQ, SO_FLG
                       FROM (
                        SELECT (CASE WHEN FM_NOD_CD = LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)  
                                      AND TO_NOD_CD = LEAD (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) 
                                      AND SO_FLG ='N'  THEN 'XXXXXXX'
                                      
                                     WHEN FM_NOD_CD = LAG (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)  
                                      AND TO_NOD_CD = LAG (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) 
                                      AND SO_FLG ='N'  THEN 'XXXXXXX'
                                     ELSE FM_NOD_CD
                                END)
                               FM_NOD_CD,
                                      
                               FM_TP_CD,
                               TO_NOD_CD,
                               TO_TP_CD,
                               TRSP_CRR_MOD_CD,
                               VNDR_SEQ,
                               COST_ACT_GRP_SEQ,
                               SO_FLG
                        FROM (            
                            SELECT FM_NOD_CD, N1.NOD_TP_CD FM_TP_CD, 
                            TO_NOD_CD, N2.NOD_TP_CD TO_TP_CD, TRSP_CRR_MOD_CD,VNDR_SEQ,COST_ACT_GRP_SEQ,'Y' SO_FLG 
                            FROM TRS_TRSP_SVC_ORD T, PRD_NODE N1,PRD_NODE N2 
                            WHERE T.COP_NO = :COP_NO 
                             AND T.TRSP_BND_CD ='T' 
                             AND NVL(T.DELT_FLG,'N') <> 'Y' 
                             AND T.FM_NOD_CD = N1.NOD_CD 
                             AND T.TO_NOD_CD = N2.NOD_CD 
                            UNION ALL 
                            SELECT ORG_NOD_CD,ORG_NOD_TP_CD ,DEST_NOD_CD,DEST_NOD_TP_CD,TRSP_MOD_CD,N1ST_VNDR_SEQ,COST_ACT_GRP_SEQ,'N' 
                            FROM PRD_PROD_CTL_ROUT_DTL  D
                            WHERE PCTL_NO = :PCTL_NO 
                            AND NOD_LNK_DIV_CD ='L' 
                            AND PCTL_IO_BND_CD ='T' 
                            AND COST_ACT_GRP_SEQ NOT BETWEEN :ACT_GRP_SEQ
                                                    AND NVL((SELECT MAX(COST_ACT_GRP_SEQ) 
                                                         FROM PRD_PROD_CTL_ROUT_DTL 
                                                         WHERE PCTL_NO = :PCTL_NO
                                                         AND DEST_NOD_CD =:TO_NOD 
                                                         AND COST_ACT_GRP_SEQ > :ACT_GRP_SEQ),:ACT_GRP_SEQ) 
                            AND COST_ACT_GRP_SEQ NOT IN 
                                               ( SELECT COST_ACT_GRP_SEQ 
                                                 FROM TRS_TRSP_SVC_ORD 
                                                 WHERE COP_NO = :COP_NO 
                                                 AND TRSP_BND_CD ='T' 
                                                 AND NVL(DELT_FLG,'N') <> 'Y') 
                            ORDER BY 7  
                        )
                       )
                       WHERE FM_NOD_CD <> 'XXXXXXX'
                       ORDER BY 7 
                    ) 
                    UNION  
                    SELECT -- SO에 의해 변경될 NOD TP가 B, M인 경우 기존 LINK 변경
                    (CASE WHEN TO_NOD_CD <> LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                           AND ( 'B' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                               AND 'M' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) )
                           AND  COST_ACT_GRP_SEQ IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                    WHERE PCTL_NO = :PCTL_NO 
                                                    AND PCTL_IO_BND_CD ='T'
                                                    AND PCTL_WTR_DIV_CD IN ('W','V') ) 
                          THEN TO_NOD_CD
                          WHEN FM_NOD_CD <> LAG (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='N' AND LAG ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                           AND ( LAG (TO_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) IN   ('B','M')
                                 OR COST_ACT_GRP_SEQ NOT IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                    WHERE PCTL_NO = :PCTL_NO 
                                                    AND PCTL_IO_BND_CD ='T'
                                                    AND PCTL_WTR_DIV_CD IN ('W','V') ) )
                          THEN LAG (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                          ELSE FM_NOD_CD 
                          
                    END ) 
                    FM_NOD_CD ,
                    (CASE WHEN TO_NOD_CD <> LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                           AND ( 'B' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                               AND 'M' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) )
                           AND  COST_ACT_GRP_SEQ IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                    WHERE PCTL_NO = :PCTL_NO 
                                                    AND PCTL_IO_BND_CD ='T'
                                                    AND PCTL_WTR_DIV_CD IN ('W','V') ) 
                          THEN LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                         WHEN TO_NOD_CD <> LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                           AND ( LEAD (FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) IN   ('B','M')
                                 OR COST_ACT_GRP_SEQ NOT IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                    WHERE PCTL_NO = :PCTL_NO 
                                                    AND PCTL_IO_BND_CD ='T'
                                                    AND PCTL_WTR_DIV_CD IN ('W','V') ) )
                          THEN LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                          
                          ELSE TO_NOD_CD
                    END )
                    TO_NOD_CD,
                    (CASE WHEN TO_NOD_CD <> LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                           AND ( 'B' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                               AND 'M' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) )
                           AND  COST_ACT_GRP_SEQ IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                    WHERE PCTL_NO = :PCTL_NO 
                                                    AND PCTL_IO_BND_CD ='T'
                                                    AND PCTL_WTR_DIV_CD IN ('W','V') ) 
                          THEN 'XX'
                          ELSE TRSP_CRR_MOD_CD 
                          
                    END )
                    TRSP_CRR_MOD_CD,
                    (CASE WHEN TO_NOD_CD <> LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                           AND ( 'B' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                               AND 'M' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) )
                           AND  COST_ACT_GRP_SEQ IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                    WHERE PCTL_NO = :PCTL_NO 
                                                    AND PCTL_IO_BND_CD ='T'
                                                    AND PCTL_WTR_DIV_CD IN ('W','V') ) 
                          THEN NULL
                          ELSE VNDR_SEQ 
                          
                    END )
                    VNDR_SEQ,
                    (CASE WHEN TO_NOD_CD <> LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                           AND ( 'B' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                               AND 'M' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) )
                           AND  COST_ACT_GRP_SEQ IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                    WHERE PCTL_NO = :PCTL_NO 
                                                    AND PCTL_IO_BND_CD ='T'
                                                    AND PCTL_WTR_DIV_CD IN ('W','V') ) 
                          THEN COST_ACT_GRP_SEQ + 5
                          ELSE COST_ACT_GRP_SEQ 
                          
                    END )
                    COST_ACT_GRP_SEQ,
                    (CASE WHEN TO_NOD_CD <> LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='N' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                           AND ( 'B' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)
                               AND 'M' <> LEAD ( FM_TP_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) )
                           AND  COST_ACT_GRP_SEQ IN (SELECT COST_ACT_GRP_SEQ FROM PRD_PROD_CTL_ROUT_DTL
                                                    WHERE PCTL_NO = :PCTL_NO 
                                                    AND PCTL_IO_BND_CD ='T'
                                                    AND PCTL_WTR_DIV_CD IN ('W','V') ) 
                          THEN 'N'
                          ELSE SO_FLG 
                          
                    END )
                    SO_FLG
                    FROM (
                       SELECT FM_NOD_CD, FM_TP_CD, TO_NOD_CD, TO_TP_CD, TRSP_CRR_MOD_CD, VNDR_SEQ,COST_ACT_GRP_SEQ, SO_FLG
                       FROM (
                        SELECT (CASE WHEN FM_NOD_CD = LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)  
                                      AND TO_NOD_CD = LEAD (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) 
                                      AND SO_FLG ='N'  THEN 'XXXXXXX'
                                      
                                     WHEN FM_NOD_CD = LAG (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)  
                                      AND TO_NOD_CD = LAG (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) 
                                      AND SO_FLG ='N'  THEN 'XXXXXXX'
                                     ELSE FM_NOD_CD
                                END)
                               FM_NOD_CD,
                                      
                               FM_TP_CD,
                               TO_NOD_CD,
                               TO_TP_CD,
                               TRSP_CRR_MOD_CD,
                               VNDR_SEQ,
                               COST_ACT_GRP_SEQ,
                               SO_FLG
                        FROM (            
                            SELECT FM_NOD_CD, N1.NOD_TP_CD FM_TP_CD, 
                            TO_NOD_CD, N2.NOD_TP_CD TO_TP_CD, TRSP_CRR_MOD_CD,VNDR_SEQ,COST_ACT_GRP_SEQ,'Y' SO_FLG 
                            FROM TRS_TRSP_SVC_ORD T, PRD_NODE N1,PRD_NODE N2 
                            WHERE T.COP_NO = :COP_NO 
                             AND T.TRSP_BND_CD ='T' 
                             AND NVL(T.DELT_FLG,'N') <> 'Y' 
                             AND T.FM_NOD_CD = N1.NOD_CD 
                             AND T.TO_NOD_CD = N2.NOD_CD 
                            UNION ALL 
                            SELECT ORG_NOD_CD,ORG_NOD_TP_CD ,DEST_NOD_CD,DEST_NOD_TP_CD,TRSP_MOD_CD,N1ST_VNDR_SEQ,COST_ACT_GRP_SEQ,'N' 
                            FROM PRD_PROD_CTL_ROUT_DTL  D
                            WHERE PCTL_NO = :PCTL_NO 
                            AND NOD_LNK_DIV_CD ='L' 
                            AND PCTL_IO_BND_CD ='T' 
                            AND COST_ACT_GRP_SEQ NOT BETWEEN :ACT_GRP_SEQ
                                                    AND NVL((SELECT MAX(COST_ACT_GRP_SEQ) 
                                                         FROM PRD_PROD_CTL_ROUT_DTL 
                                                         WHERE PCTL_NO = :PCTL_NO
                                                         AND DEST_NOD_CD =:TO_NOD 
                                                         AND COST_ACT_GRP_SEQ > :ACT_GRP_SEQ),:ACT_GRP_SEQ) 
                            AND COST_ACT_GRP_SEQ NOT IN 
                                               ( SELECT COST_ACT_GRP_SEQ 
                                                 FROM TRS_TRSP_SVC_ORD 
                                                 WHERE COP_NO = :COP_NO 
                                                 AND TRSP_BND_CD ='T' 
                                                 AND NVL(DELT_FLG,'N') <> 'Y') 
                            ORDER BY 7  
                        )
                       )
                       WHERE FM_NOD_CD <> 'XXXXXXX'
                       ORDER BY 7 
                    )      
                    UNION 
                    SELECT  -- 두개의 앞뒤 LNK의 SO가 발행되고 둘 사이의 LNK가 안되는 경우  연결 LNK 추가
                    (CASE WHEN TO_NOD_CD <> LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='Y' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                          THEN TO_NOD_CD
                          ELSE 'XXXXXXX'
                    END )
                    FM_NOD_CD,
                    (CASE WHEN TO_NOD_CD <> LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='Y' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                          THEN LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                          ELSE 'XXXXXXX'
                    END )
                    TO_NOD_CD,
                    (CASE WHEN TO_NOD_CD <> LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='Y' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                          THEN 'XX'
                          ELSE 'XX'
                    END )
                    TRSP_CRR_MOD_CD,
                    NULL
                    VNDR_SEQ,
                    (CASE WHEN TO_NOD_CD <> LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='Y' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                          THEN COST_ACT_GRP_SEQ + 5
                          ELSE NULL
                    END )
                    COST_ACT_GRP_SEQ,
                    (CASE WHEN TO_NOD_CD <> LEAD ( FM_NOD_CD,1) OVER (ORDER BY COST_ACT_GRP_SEQ)
                           AND SO_FLG ='Y' AND LEAD ( SO_FLG,1) OVER (ORDER BY COST_ACT_GRP_SEQ) ='Y'
                          THEN 'N'
                          ELSE NULL
                    END )
                    SO_FLG
                    FROM (
                       SELECT FM_NOD_CD, FM_TP_CD, TO_NOD_CD, TO_TP_CD, TRSP_CRR_MOD_CD, VNDR_SEQ,COST_ACT_GRP_SEQ, SO_FLG
                       FROM (
                        SELECT (CASE WHEN FM_NOD_CD = LEAD (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)  
                                      AND TO_NOD_CD = LEAD (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) 
                                      AND SO_FLG ='N'  THEN 'XXXXXXX'
                                      
                                     WHEN FM_NOD_CD = LAG (FM_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ)  
                                      AND TO_NOD_CD = LAG (TO_NOD_CD,1) OVER ( ORDER BY COST_ACT_GRP_SEQ) 
                                      AND SO_FLG ='N'  THEN 'XXXXXXX'
                                     ELSE FM_NOD_CD
                                END)
                               FM_NOD_CD,
                                      
                               FM_TP_CD,
                               TO_NOD_CD,
                               TO_TP_CD,
                               TRSP_CRR_MOD_CD,
                               VNDR_SEQ,
                               COST_ACT_GRP_SEQ,
                               SO_FLG
                        FROM (            
                            SELECT FM_NOD_CD, N1.NOD_TP_CD FM_TP_CD, 
                            TO_NOD_CD, N2.NOD_TP_CD TO_TP_CD, TRSP_CRR_MOD_CD,VNDR_SEQ,COST_ACT_GRP_SEQ,'Y' SO_FLG 
                            FROM TRS_TRSP_SVC_ORD T, PRD_NODE N1,PRD_NODE N2 
                            WHERE T.COP_NO = :COP_NO 
                             AND T.TRSP_BND_CD ='T' 
                             AND NVL(T.DELT_FLG,'N') <> 'Y' 
                             AND T.FM_NOD_CD = N1.NOD_CD 
                             AND T.TO_NOD_CD = N2.NOD_CD 
                            UNION ALL 
                            SELECT ORG_NOD_CD,ORG_NOD_TP_CD ,DEST_NOD_CD,DEST_NOD_TP_CD,TRSP_MOD_CD,N1ST_VNDR_SEQ,COST_ACT_GRP_SEQ,'N' 
                            FROM PRD_PROD_CTL_ROUT_DTL  D
                            WHERE PCTL_NO = :PCTL_NO 
                            AND NOD_LNK_DIV_CD ='L' 
                            AND PCTL_IO_BND_CD ='T' 
                            AND COST_ACT_GRP_SEQ NOT BETWEEN :ACT_GRP_SEQ
                                                    AND NVL((SELECT MAX(COST_ACT_GRP_SEQ) 
                                                         FROM PRD_PROD_CTL_ROUT_DTL 
                                                         WHERE PCTL_NO = :PCTL_NO
                                                         AND DEST_NOD_CD =:TO_NOD 
                                                         AND COST_ACT_GRP_SEQ > :ACT_GRP_SEQ),:ACT_GRP_SEQ) 
                            AND COST_ACT_GRP_SEQ NOT IN 
                                               ( SELECT COST_ACT_GRP_SEQ 
                                                 FROM TRS_TRSP_SVC_ORD 
                                                 WHERE COP_NO = :COP_NO 
                                                 AND TRSP_BND_CD ='T' 
                                                 AND NVL(DELT_FLG,'N') <> 'Y') 
                            ORDER BY 7  
                        )
                       )
                       WHERE FM_NOD_CD <> 'XXXXXXX'
                       ORDER BY 7 
                    )                
                ) WHERE FM_NOD_CD NOT LIKE 'X%X'
            ) )
        SELECT   
        'POL'||REPLACE(MAX(                        
                       SYS_CONNECT_BY_PATH(
                       DECODE(SUBSTR(TBL.TO_NOD_CD,1,2),'TS','','PO','',
                       TBL.TRSP_CRR_MOD_CD||'@*'||
                       LPAD(TBL.VNDR_SEQ,6,0)||'@*')||     
                       DECODE(RK,1,TBL.FM_NOD_CD||'@*'||TBL.TO_NOD_CD,TBL.TO_NOD_CD) , '-')),'@*','-') TS_STRING
        FROM TBL
        START WITH RK = 1
        CONNECT BY PRIOR RK  = RK -1
    )
)
WHERE TS_STRING LIKE 'POL-%TS1-%TS2-%TS3-%POD-%'
;