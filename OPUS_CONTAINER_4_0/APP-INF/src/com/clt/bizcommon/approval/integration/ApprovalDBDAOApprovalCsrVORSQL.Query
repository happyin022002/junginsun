<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ApprovalDBDAOApprovalCsrVORSQL">
			<desc><![CDATA[Csr의 목록을 가져온다.]]></desc>
			<sql><![CDATA[
SELECT T.APRO_RQST_NO      	
     , T.CRNT_APRO_SEQ		
     , T.APSTS_CD  		
     , T.SUB_SYS_CD 				
     , T.RQST_ST_DT 		
     , T.COST_OFC_CD 		
     , T.CSR_NO  		
     , T.INV_KNT 		
     , T.VNDR_SEQ 		
     , T.PAY_DUE_DT		
     , T.CURR_CD  				
     , T.APRO_TTL_AMT  		
     , T.APRO_RMK  		
     , T.APPYN  
     , '' FRST_APRO_USR_ID
     , '' APRO_STEP
     , '' APRO_SEQ_KEY		
     , '' USR_ID
     , '' USR_NM
     , '' OFC_CD
     , '' APRO_RQST_SEQ
     , '' INV_SUB_SYS_CD
  FROM (
        SELECT ROW_NUMBER() OVER (ORDER BY RQST_ST_DT DESC) no  	
             , A.APRO_RQST_NO             
	         , A.CRNT_APRO_SEQ
             , DECODE(A.APSTS_CD, 'P', 'Processing', 'R', 'Disapproved', DECODE(D.IF_FLG,'E','Error','Approved')) APSTS_CD
	         , A.SUB_SYS_CD          	 
	         , TO_CHAR(A.RQST_ST_DT, 'YYYY-MM-DD') RQST_ST_DT          	 
	         , B.COST_OFC_CD          	 
	         , B.CSR_NO          	 
	         , B.INV_KNT          	 
	         , TO_CHAR(B.VNDR_SEQ, '000000') VNDR_SEQ          	 
	         , B.PAY_DUE_DT          	 
	         , B.CURR_CD          	 
	         , B.APRO_TTL_AMT          	 
	         , DECODE(NVL(C.APSTS_CD, ''), '', 'N', 'Y') APPYN         	 
	         , DECODE(D.IF_FLG,'E','I/F Error : '||D.IF_ERR_RSN,C.APRO_RMK) APRO_RMK  
	      FROM COM_APRO_RQST_HDR  A
	         , COM_APRO_CSR_DTL   B
	         , COM_APRO_RQST_ROUT C
             , AP_INV_HDR D
	     WHERE 1 = 1  
	       AND A.SUB_SYS_CD <> 'JOO'										
	       AND NVL(A.DELT_FLG, 'N') <> 'Y'    

           #if (${sub_sys_cd} != '')
           AND A.SUB_SYS_CD = @[sub_sys_cd]
           #end   

		   AND A.APRO_RQST_NO = B.APRO_RQST_NO
    	   AND A.APRO_RQST_NO = C.APRO_RQST_NO
           AND B.CSR_NO = D.CSR_NO

           #if (${status} == 'P') 
           AND A.APSTS_CD = 'P'
           AND A.CRNT_APRO_SEQ = C.APRO_RQST_SEQ
           #elseif (${status} == 'C') 
           AND NVL(C.APSTS_CD, ' ') = 'C' AND D.IF_FLG = 'Y'
           #elseif (${status} == 'R')
           AND NVL(C.APSTS_CD, ' ') = 'R'
           #elseif (${status} == 'E')
           AND D.IF_FLG = 'E' 
           #else
           AND A.CRNT_APRO_SEQ >= C.APRO_RQST_SEQ
           #end

           #if (${status} != 'P')
           AND EXISTS (SELECT 'A' FROM TES_TML_SO_HDR TTSH WHERE TTSH.CSR_NO = B.CSR_NO AND NVL(TTSH.DELT_FLG, 'N') <> 'Y'
                       UNION ALL
                       SELECT 'A' FROM TRS_TRSP_INV_WRK TTIW WHERE TTIW.CSR_NO = B.CSR_NO AND NVL(TTIW.DELT_FLG, 'N') <> 'Y'
                       UNION ALL
                       SELECT 'A' FROM TRS_TRSP_RAIL_INV_WRK TTRIW WHERE TTRIW.CSR_NO = B.CSR_NO AND NVL(TTRIW.DELT_FLG, 'N') <> 'Y'
                       UNION ALL
                       SELECT 'A' FROM ACM_AGN_COMM AAC WHERE AAC.CSR_NO = B.CSR_NO
                       UNION ALL
                       SELECT 'A' FROM ACM_AGN_OTR_COMM AAOC, AP_INV_HDR AIH WHERE AAOC.CSR_NO = B.CSR_NO AND B.CSR_NO = AIH.CSR_NO
                       AND    (A.APSTS_CD = 'P' OR (NVL(C.APSTS_CD, ' ') = 'C' AND D.IF_FLG = 'Y' AND AIH.RCV_ERR_FLG IS NULL))
                       UNION ALL
                       SELECT 'A' FROM ACM_FF_CMPN AFC WHERE AFC.CSR_NO = B.CSR_NO
                       UNION ALL
                       SELECT 'A' FROM ACM_SPCL_CMPN ACMS WHERE ACMS.CSR_NO = B.CSR_NO
                       UNION ALL
                       SELECT 'A' FROM AP_PAY_INV API WHERE API.CSR_NO = B.CSR_NO AND NVL(API.DELT_FLG, 'N') <> 'Y')
           #end

           AND C.APRO_OFC_CD = @[ofc_cd]

           #if (${sdate} != '')
           AND TO_CHAR(A.RQST_ST_DT, 'YYYY-MM-DD') >= @[sdate]
           #end  

           #if (${edate} != '')
           AND TO_CHAR(A.RQST_ST_DT, 'YYYY-MM-DD') <= @[edate]
           #end           
           
       ) T			]]></sql>
			<params>
				<param name="sub_sys_cd" type="12" value="" out="N"/>
				<param name="ofc_cd" type="12" value="" out="N"/>
				<param name="sdate" type="12" value="" out="N"/>
				<param name="edate" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
