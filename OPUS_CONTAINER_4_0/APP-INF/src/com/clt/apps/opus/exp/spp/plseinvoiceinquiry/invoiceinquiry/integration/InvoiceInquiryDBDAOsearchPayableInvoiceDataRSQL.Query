<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="InvoiceInquiryDBDAOsearchPayableInvoiceDataRSQL">
			<desc><![CDATA[searchPayableInvoiceData]]></desc>
			<sql><![CDATA[
SELECT T1.VNDR_SEQ
	  ,(SELECT VNDR_LGL_ENG_NM FROM MDM_VENDOR WHERE VNDR_SEQ = T1.VNDR_SEQ) AS VNDR_NM 
      ,T2.LSTM_CD
      ,T2.INV_NO
      ,T2.CURR_CD
      ,SUM(T2.TTL_COST_AMT) TTL_COST_AMT
      ,CASE WHEN ( T1.INV_STS_CD = 'P' OR T1.INV_STS_CD = 'E')  AND T3.IF_FLG = 'E' AND T3.IF_ERR_RSN IS NOT NULL THEN 'Sending Error' 
            WHEN ( T1.INV_STS_CD = 'P' OR T1.INV_STS_CD = 'E')  AND T3.IF_FLG = 'Y' AND T3.IF_ERR_RSN IS NOT NULL THEN 'Sending'
            WHEN ( T1.INV_STS_CD = 'P' OR T1.INV_STS_CD = 'E')  AND T3.IF_FLG = 'Y' AND T3.IF_ERR_RSN IS NULL THEN (SELECT C.INTG_CD_VAL_DP_DESC
                                                                                                                      FROM COM_INTG_CD_DTL C
                                                                                                                     WHERE C.INTG_CD_ID = 'CD02355'
                                                                                                                       AND C.INTG_CD_VAL_CTNT = T1.INV_STS_CD ) 
            WHEN T1.INV_STS_CD <> 'P' AND T1.INV_STS_CD <> 'E' THEN (SELECT C.INTG_CD_VAL_DP_DESC
                                                                       FROM COM_INTG_CD_DTL C
                                                                      WHERE C.INTG_CD_ID = 'CD02355'
                                                                        AND C.INTG_CD_VAL_CTNT = T1.INV_STS_CD ) END LSE_INV_APSTS_CD
      ,TO_CHAR(T1.AP_PAY_DT,'YYYYMMDD') AP_PAY_DT
	  ,SUM(T2.PAY_RNTL_COST_AMT) PAY_RNTL_COST_AMT
      ,@[str_dt] STR_DT  --'20090101'
      ,@[end_dt] END_DT  --'20090131'
 FROM AP_PAY_INV T1,
      LSE_PAY_RNTL_CHG T2,
	  AP_INV_HDR T3
WHERE 1=1
  AND T1.INV_NO = T2.INV_NO
  AND T1.CSR_NO = T3.CSR_NO(+)
  AND T2.IF_RGST_NO = DECODE(T2.IF_RGST_NO, NULL, NULL, T1.INV_RGST_NO)
  AND T1.VNDR_SEQ = T2.VNDR_SEQ
#if (${vndr_seq} != '') 
  AND T1.VNDR_SEQ = @[vndr_seq]  --'105028'
#end

  AND T1.INV_SUB_SYS_CD = 'LSE'
  AND T1.DELT_FLG = 'N'
#if( ${inv_no}!='' )
  AND T2.INV_NO = @[inv_no]
#else
	#if( ${str_dt}!='' && ${end_dt}!='' )
	  AND T1.INV_EFF_DT >= TO_DATE(REPLACE(@[str_dt],'-',''),'YYYYMMDD') AND T1.INV_EFF_DT < TO_DATE(REPLACE(@[end_dt],'-',''),'YYYYMMDD')+1  -- '20090101'  '20090131'
	#end
	
	#if (${lstm_cd_key} != "" ) 
	  AND T2.LSTM_CD IN ( 
	                      #foreach($key IN ${lstm_cd})
	                          #if($velocityCount < $lstm_cd.size())
	                              '$key',
	                          #else
	                              '$key'
	                          #end
	                      #end 
	                    )
	#end
#end
group by T1.VNDR_SEQ,T2.LSTM_CD,T2.INV_NO,T2.CURR_CD,T1.INV_STS_CD,T3.IF_FLG, T3.IF_ERR_RSN,TO_CHAR(T1.AP_PAY_DT,'YYYYMMDD')
UNION ALL
SELECT 	A.VNDR_SEQ
		,(SELECT VNDR_LGL_ENG_NM FROM MDM_VENDOR WHERE VNDR_SEQ = A.VNDR_SEQ) AS VNDR_NM 
  	    ,D.LSTM_CD
  		,A.INV_NO
  		,A.CURR_CD
  		,SUM(A.PAY_AMT ) TTL_COST_AMT
		, CASE
		    WHEN ( B.INV_STS_CD = 'P'
		      OR B.INV_STS_CD = 'E')
		    AND C.IF_FLG = 'E'
		    AND C.IF_ERR_RSN IS NOT NULL THEN 'Sending Error'
		    WHEN ( B.INV_STS_CD = 'P'
		      OR B.INV_STS_CD = 'E')
		    AND C.IF_FLG = 'Y'
		    AND C.IF_ERR_RSN IS NOT NULL THEN 'Sending'
		    WHEN ( B.INV_STS_CD = 'P'
		      OR B.INV_STS_CD = 'E')
		    AND C.IF_FLG = 'Y'
		    AND C.IF_ERR_RSN IS NULL THEN (
		    SELECT C.INTG_CD_VAL_DP_DESC
		    FROM COM_INTG_CD_DTL C
		    WHERE C.INTG_CD_ID = 'CD02355'
		      AND C.INTG_CD_VAL_CTNT = B.INV_STS_CD )
		    WHEN B.INV_STS_CD <> 'P'
		    AND B.INV_STS_CD <> 'E' THEN (
		    SELECT C.INTG_CD_VAL_DP_DESC
		    FROM COM_INTG_CD_DTL C
		    WHERE C.INTG_CD_ID = 'CD02355'
		      AND C.INTG_CD_VAL_CTNT = B.INV_STS_CD )
		  END LSE_INV_APSTS_CD
      ,TO_CHAR(B.AP_PAY_DT,'YYYYMMDD') AP_PAY_DT
      ,SUM(A.PAY_AMT ) PAY_RNTL_COST_AMT
      ,@[str_dt] STR_DT
      ,@[end_dt] END_DT
FROM LSE_OP_LSE A ,
  AP_PAY_INV B ,
  AP_INV_HDR C ,
  LSE_AGREEMENT D
WHERE A.AGMT_CTY_CD = D.AGMT_CTY_CD
  AND A.AGMT_SEQ = D.AGMT_SEQ
  AND A.INV_NO = B.INV_NO
  AND B.CSR_NO = C.CSR_NO(+)
  AND A.IF_RGST_NO = DECODE(A.IF_RGST_NO, NULL, NULL, B.INV_RGST_NO)
  AND B.INV_SUB_SYS_CD = 'LSE'
#if (${vndr_seq} != '') 
  AND A.VNDR_SEQ = @[vndr_seq]
#end  

#if( ${inv_no}!='' )
  AND  A.INV_NO = @[inv_no]
#else
	#if( ${str_dt}!='' && ${end_dt}!='' )
	  AND B.INV_EFF_DT >= TO_DATE(REPLACE(@[str_dt],'-',''),'YYYYMMDD') AND B.INV_EFF_DT < TO_DATE(REPLACE(@[end_dt],'-',''),'YYYYMMDD')+1
	#end
	
	#if (${lstm_cd_key} != "" ) 
	  AND D.LSTM_CD IN ( 
	                      #foreach($key IN ${lstm_cd})
	                          #if($velocityCount < $lstm_cd.size())
	                              '$key',
	                          #else
	                              '$key'
	                          #end
	                      #end 
	                    )
	#end
#end
GROUP BY A.VNDR_SEQ,
  	  D.LSTM_CD,
  	  A.INV_NO,
  	  A.CURR_CD,
  	  B.INV_STS_CD,
  	  C.IF_FLG,
  	  C.IF_ERR_RSN,
  	  TO_CHAR(B.AP_PAY_DT,'YYYYMMDD')
#if (${vndr_seq} != '') 
	ORDER BY INV_NO
#else 
	ORDER BY VNDR_SEQ
#end			]]></sql>
			<params>
				<param name="str_dt" type="12" value="20090101" out="N"/>
				<param name="end_dt" type="12" value="20090130" out="N"/>
				<param name="vndr_seq" type="12" value="105028" out="N"/>
				<param name="inv_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
