<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="OnhireBalanceDBDAOsearchPlanAndApprovalRSQL">
			<desc><![CDATA[Retrieve LT/ST/OW Plan & Approval ]]></desc>
			<sql><![CDATA[
-- LT/ST/OW Plan & Approval 
SELECT A.LSE_RQST_NO
      ,A.ONH_ORD_YR
      ,A.ONH_PLN_YRWK
      ,A.ONH_PKUP_YRWK
      ,A.RCC_CD
      ,A.LCC_CD
      ,A.EQ_LSTM_CD
      ,A.LSE_PLN_SEQ -- HIDDEN
      ,NVL(SUM(DECODE(B.CNTR_TPSZ_CD, 'D2', B.CNTR_QTY)),0) D2_QTY
      ,NVL(SUM(DECODE(B.CNTR_TPSZ_CD, 'D4', B.CNTR_QTY)),0) D4_QTY
      ,NVL(SUM(DECODE(B.CNTR_TPSZ_CD, 'D5', B.CNTR_QTY)),0) D5_QTY
      ,NVL(SUM(DECODE(B.CNTR_TPSZ_CD, 'D7', B.CNTR_QTY)),0) D7_QTY
      ,NVL(SUM(DECODE(B.CNTR_TPSZ_CD, 'R2', B.CNTR_QTY)),0) R2_QTY
      ,NVL(SUM(DECODE(B.CNTR_TPSZ_CD, 'R5', B.CNTR_QTY)),0) R5_QTY
      ,NVL(SUM(DECODE(B.CNTR_TPSZ_CD, 'R9', B.CNTR_QTY)),0) R9_QTY
      ,NVL(SUM(DECODE(B.CNTR_TPSZ_CD, 'O2', B.CNTR_QTY)),0) O2_QTY
      ,NVL(SUM(DECODE(B.CNTR_TPSZ_CD, 'O4', B.CNTR_QTY)),0) O4_QTY
      ,NVL(SUM(DECODE(B.CNTR_TPSZ_CD, 'O5', B.CNTR_QTY)),0) O5_QTY
      ,NVL(SUM(DECODE(B.CNTR_TPSZ_CD, 'S2', B.CNTR_QTY)),0) S2_QTY
      ,NVL(SUM(DECODE(B.CNTR_TPSZ_CD, 'S4', B.CNTR_QTY)),0) S4_QTY
      ,NVL(SUM(DECODE(B.CNTR_TPSZ_CD, 'F2', B.CNTR_QTY)),0) F2_QTY
      ,NVL(SUM(DECODE(B.CNTR_TPSZ_CD, 'F4', B.CNTR_QTY)),0) F4_QTY
      ,NVL(SUM(DECODE(B.CNTR_TPSZ_CD, 'F5', B.CNTR_QTY)),0) F5_QTY
      ,NVL(SUM(DECODE(B.CNTR_TPSZ_CD, 'A2', B.CNTR_QTY)),0) A2_QTY
      ,NVL(SUM(DECODE(B.CNTR_TPSZ_CD, 'A4', B.CNTR_QTY)),0) A4_QTY      
      
      ,C.CNTR_ONH_AUTH_NO
      ,C.MFT_YR
      ,C.AGMT_CTY_CD||C.AGMT_SEQ AGMT_NO
      ,C.ONH_LOC_CD
      
      ,CASE WHEN A.LSE_RQST_NO IS NULL     AND C.CNTR_ONH_AUTH_NO IS NULL     THEN 'S'
            WHEN A.LSE_RQST_NO IS NOT NULL AND C.CNTR_ONH_AUTH_NO IS NULL     THEN 'R'
            WHEN A.LSE_RQST_NO IS NOT NULL AND C.CNTR_ONH_AUTH_NO IS NOT NULL THEN 'A'
       END STS_CD  -- HIDDEN

      ,CASE WHEN A.LSE_RQST_NO IS NULL     AND C.CNTR_ONH_AUTH_NO IS NULL     THEN 'Saved'
            WHEN A.LSE_RQST_NO IS NOT NULL AND C.CNTR_ONH_AUTH_NO IS NULL     THEN 'Requested'
            WHEN A.LSE_RQST_NO IS NOT NULL AND C.CNTR_ONH_AUTH_NO IS NOT NULL THEN 'Approved'
       END STS_NM   
              
FROM  EQR_CTRL_ONH_PLN_APRO        A
    , EQR_CTRL_ONH_PLN_APRO_QTY    B
    ,(SELECT LSE_RQST_NO 
           , CNTR_ONH_AUTH_NO
           , MFT_YR
           , AGMT_CTY_CD
           , AGMT_SEQ AGMT_NO
           , AGMT_SEQ
           , ONH_LOC_CD
      FROM   LSE_ONH_APRO 
      WHERE  DELT_FLG  = 'N'  ) C
WHERE A.ONH_PLN_YRWK = B.ONH_PLN_YRWK
AND   A.LCC_CD       = B.LCC_CD
AND   A.EQ_LSTM_CD   = B.EQ_LSTM_CD
AND   A.LSE_PLN_SEQ  = B.LSE_PLN_SEQ    
AND   A.LSE_RQST_NO  = C.LSE_RQST_NO(+)

-- WEEK
#if(${div_flag} == '1') -- APPROVAL WEEK
AND   A.ONH_PLN_YRWK = @[yrwk]

#elseif(${div_flag} == '2') -- APPROVAL WEEK - PERIOD
  #if(${periodtp} == 'W') -- PERIOD WEEK
AND   A.ONH_PLN_YRWK BETWEEN @[fmperiod] AND @[toperiod]
  #else -- PERIOD MONTH
AND   A.ONH_PLN_YRWK BETWEEN ( SELECT MIN(PLN_YR)||MIN(PLN_WK) FMPERIOD 
                               FROM   EQR_WK_PRD
                               WHERE  PLN_YR  = SUBSTR(@[fmperiod],1,4)
                               AND    PLN_MON = SUBSTR(@[fmperiod],5,6) )
                     AND     ( SELECT MIN(PLN_YR)||MAX(PLN_WK) TOPERIOD 
                               FROM   EQR_WK_PRD
                               WHERE  PLN_YR  = SUBSTR(@[toperiod],1,4)
                               AND    PLN_MON = SUBSTR(@[toperiod],5,6) )
  #end

#elseif(${div_flag} == '3') -- PICK-UP WEEK
AND   A.ONH_PKUP_YRWK = @[yrwk_pkup]

#elseif(${div_flag} == '4') -- PICK-UP WEEK - PERIOD
  #if(${periodtp_pkup} == 'W') -- PERIOD WEEK
AND   A.ONH_PKUP_YRWK BETWEEN @[fmperiod_pkup] AND @[toperiod_pkup]
  #else -- PERIOD MONTH
AND   A.ONH_PKUP_YRWK BETWEEN ( SELECT MIN(PLN_YR)||MIN(PLN_WK) FMPERIOD 
                               FROM   EQR_WK_PRD
                               WHERE  PLN_YR  = SUBSTR(@[fmperiod_pkup],1,4)
                               AND    PLN_MON = SUBSTR(@[fmperiod_pkup],5,6) )
                     AND     ( SELECT MIN(PLN_YR)||MAX(PLN_WK) TOPERIOD 
                               FROM   EQR_WK_PRD
                               WHERE  PLN_YR  = SUBSTR(@[toperiod_pkup],1,4)
                               AND    PLN_MON = SUBSTR(@[toperiod_pkup],5,6) )
  #end

#end


-- LOCATION
AND   A.LCC_CD IN (
                     SELECT LCC_CD 
                     FROM MDM_EQ_ORZ_CHT
                     WHERE 1=1
#if(${rcc_cd} != '' && ${rcc_cd} != 'ALL')
                     AND   RCC_CD = @[rcc_cd] -- RCC
#end
#if(${lcc_cd} != '' && ${lcc_cd} != 'ALL')
                     AND   LCC_CD = @[lcc_cd] -- LCC
#end
                  )

-- STATUS
-- R
#if(${sts_cd} == 'R')
AND (A.LSE_RQST_NO IS NOT NULL AND C.CNTR_ONH_AUTH_NO IS NULL) 
-- S
#elseif(${sts_cd} == 'S')
AND (A.LSE_RQST_NO IS NULL AND C.CNTR_ONH_AUTH_NO IS NULL) 
---- A
#elseif(${sts_cd} == 'A')
AND (A.LSE_RQST_NO IS NOT NULL AND C.CNTR_ONH_AUTH_NO IS NOT NULL)                   
#end

GROUP BY A.LSE_RQST_NO
        ,A.ONH_ORD_YR
        ,A.ONH_PLN_YRWK
        ,A.ONH_PKUP_YRWK
        ,A.RCC_CD
        ,A.LCC_CD
        ,A.EQ_LSTM_CD
        ,A.LSE_PLN_SEQ
        ,C.CNTR_ONH_AUTH_NO
        ,C.MFT_YR
        ,C.AGMT_CTY_CD||C.AGMT_SEQ
        ,C.ONH_LOC_CD
        
ORDER BY A.ONH_PLN_YRWK
        ,A.RCC_CD
        ,A.LCC_CD
        ,A.EQ_LSTM_CD
        ,A.LSE_PLN_SEQ			]]></sql>
			<params>
				<param name="yrwk" type="12" value="" out="N"/>
				<param name="fmperiod" type="12" value="" out="N"/>
				<param name="toperiod" type="12" value="" out="N"/>
				<param name="yrwk_pkup" type="12" value="" out="N"/>
				<param name="fmperiod_pkup" type="12" value="" out="N"/>
				<param name="toperiod_pkup" type="12" value="" out="N"/>
				<param name="rcc_cd" type="12" value="" out="N"/>
				<param name="lcc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
