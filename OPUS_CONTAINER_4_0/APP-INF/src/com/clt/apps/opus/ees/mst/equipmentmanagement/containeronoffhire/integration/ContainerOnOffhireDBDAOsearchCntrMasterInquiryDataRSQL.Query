<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ContainerOnOffhireDBDAOsearchCntrMasterInquiryDataRSQL">
			<desc><![CDATA[Container Master Inquiry
2010.10.21 남궁진호 [CHM-201006508-01] LT,ST Term일경우 Reefer Unit Info를 MST_CONTAINER에서 조회한다.기존엔 MST_CNTR_LOT에서 모두조회함
2010.12.27 진마리아 [CHM-201007809-01] RF_TP_CD을 COM_INTG_CD_DTL에서 조회한다.
2016.07.20 전지연 [CSR-#15678] Hawk : MST - (SOLAS VGM related topic) Allow update TareWeight & Payload with Container # level : Gross weight, Pay Load 추가]]></desc>
			<sql><![CDATA[
WITH PPARAM
AS 
(SELECT /*+ INDEX( A XPKMST_CONTAINER) */
     CNTR_NO 
 FROM 
	MST_CONTAINER A
 WHERE 1 = 1
##${cntr_no}
#if ($cntr_no.length() == 10)
 AND   A.CNTR_NO LIKE @[cntr_no] || '%'
#end 
##${cntr_no}
#if ($cntr_no.length() != 10) 
 AND   A.CNTR_NO = @[cntr_no]
#end 
 AND NVL(CNMV_DT, SYSDATE) 
               = NVL((
                SELECT 
					MAX(CNMV_DT) 
                FROM 
					MST_CONTAINER 
                WHERE 1 = 1   
      ##${cntr_no}
      #if ($cntr_no.length() == 10) 
                AND   CNTR_NO LIKE @[cntr_no] || '%'
      #end 
      ##${cntr_no}
      #if ($cntr_no.length() != 10) 
                AND   CNTR_NO = @[cntr_no]
      #end 
               ), SYSDATE)
 AND ROWNUM = 1 
)
SELECT 
     A.CNTR_NO, A.PLST_FLR_FLG, A.CHK_DGT, A.ACIAC_DIV_CD, A.CNTR_TPSZ_CD, A.CNTR_TPSZ_ISO_CD, A.CNTR_MTRL_CD
   , A.TARE_WGT, A.CNTR_SPEC_NO, A.TARE_WGT_LBS, A.CNTR_GRS_WGT, A.CNTR_GRS_WGT_LBS, A.PAY_LOAD, A.PAY_LOAD_LBS,A.LSTM_CD
   , A.MFTR_VNDR_SEQ AS VNDR_ABBR_NM, A.MFTR_VNDR_ABBR_NM AS VNDR_LGL_ENG_NM
   , A.MFT_DT, A.D2_PAYLD_FLG, A.RF_TP_CD, A.CNMV_STS_CD, A.CRNT_YD_CD, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.CNMV_DT
   , A.FULL_FLG, A.DMG_FLG, A.IMDT_EXT_FLG, A.CNTR_HNGR_RCK_CD, A.MNR_HNGR_BAR_TP_CD, A.CNTR_HNGR_BAR_ATCH_KNT
   , A.DISP_FLG, A.UCLM_LS, A.ONH_DT, A.ONH_DT_OLD, A.ONH_CNTR_STS_CD, A.ONH_AGMT_NO, A.VNDR_SEQ, A.LESSOR_NM, A.DPC_VAL
   , A.CRE_DT, A.CRE_USR_ID, A.UPD_DT, A.UPD_USR_ID
   , B.SUB_LSTM_CD, B.CNTR_STS_EVNT_DT, B.CNTR_STS_EVNT_DT_OLD, B.CNTR_STS_CD, B.EXIT_AGMT_NO, B.EXIT_VNDR_SEQ, B.EXIT_VNDR_ENG_NM
   , B.DPP_TP_CD, B.DPP_AMT, B.RNTL_CHG_AMT1, B.OFF_HIRE_AVAIL, B.LSE_VNDR_URL
   , COM_CONSTANTMGR_PKG.COM_getCompanyName_FNC() AS CNTR_USE_CO_CD
   , NVL(( SELECT COM_CONSTANTMGR_PKG.COM_getCompanyName_FNC()
             FROM MNR_TTL_LSS_RQST_HDR TH
                , MNR_TTL_LSS_RQST_DTL TD
                , MST_CONTAINER MC
            WHERE 1                   = 1
              AND    TH.TTL_LSS_STS_CD = 'HA'
              AND    TH.TTL_LSS_NO      = TD.TTL_LSS_NO
              AND    TD.RQST_EQ_NO    = A.CNTR_NO
              AND    A.CNTR_NO       = MC.CNTR_NO
              AND    MC.ONH_DT < TH.TTL_LSS_DT
              AND    ROWNUM            = 1), DECODE(A.CNTR_STS_CD||A.CNMV_STS_CD||A.ACIAC_DIV_CD, 'OWNMTInactive', 'Not Receiving', A.LESSOR_NM) 
        ) AS OWNR_CO_CD,
--	CASE WHEN A.LSTM_CD IN ('LT','ST','OF','SB','MU') THEN 
--		(DECODE(CNTR_STS_EVNT_DT_OLD, NULL, TRUNC(SYSDATE)+1, TRUNC(CNTR_STS_EVNT_DT_OLD)+1) - TRUNC(ONH_DT_OLD)) * B.RNTL_CHG_AMT1
--	ELSE 0 END AS RNTL_CHG_AMT,
    
	DECODE(MST_COMMON_PKG.MST_HO_OFC_CHK_FNC(@[usr_ofc_cd]),
	'Y',
		CASE WHEN A.LSTM_CD IN ('LT','ST','OF','SB','MU') THEN 
    		(DECODE(CNTR_STS_EVNT_DT_OLD, NULL, TRUNC(SYSDATE)+1, TRUNC(CNTR_STS_EVNT_DT_OLD)+1) - TRUNC(ONH_DT_OLD)) * B.RNTL_CHG_AMT1
		ELSE 0 END,
	'N', '')
	AS RNTL_CHG_AMT,

	C.BKG_NO1,
	C.BKG_NO2,
	C.BKG_NO3,
--	DECODE(CNTR_STS_EVNT_DT_OLD, NULL, TRUNC(SYSDATE)+1, TRUNC(CNTR_STS_EVNT_DT_OLD)+1) - TRUNC(ONH_DT_OLD) USING_DAYS,
	DECODE(MST_COMMON_PKG.MST_HO_OFC_CHK_FNC(@[usr_ofc_cd]),
		'Y',DECODE(CNTR_STS_EVNT_DT_OLD, NULL, TRUNC(SYSDATE)+1, TRUNC(CNTR_STS_EVNT_DT_OLD)+1) - TRUNC(ONH_DT_OLD),
		'N','')
	AS USING_DAYS,
	
	MNR_COMMON_PKG.MNR_GET_RPRCOST_FNC('U',P.CNTR_NO) COST_AMT,
	L.CERTI_NO,
	L.APRO_CSC_NO,
	L.APRO_TIR_NO,
	(SELECT NVL(VNDR_ABBR_NM, VNDR_LGL_ENG_NM) 
	 FROM MDM_VENDOR 
	 WHERE VNDR_SEQ = CASE WHEN A.LSTM_CD='LT' OR A.LSTM_CD = 'ST' THEN A.RF_MKR_SEQ ELSE L.RF_MKR_SEQ END
	)AS RF_MKR_SEQ,
	CASE WHEN A.LSTM_CD='LT' OR A.LSTM_CD = 'ST' THEN A.RF_MDL_NM ELSE L.RF_MDL_NM END AS RF_MDL_NM,
	CASE WHEN A.LSTM_CD='LT' OR A.LSTM_CD = 'ST' THEN A.RF_RFR_NO ELSE L.RF_RFR_NO END AS RF_RFR_NO,
	CASE WHEN A.LSTM_CD='LT' OR A.LSTM_CD = 'ST' THEN A.MIN_TEMP ELSE L.MIN_TEMP END AS MIN_TEMP,
	CASE WHEN A.LSTM_CD='LT' OR A.LSTM_CD = 'ST' THEN A.MAX_TEMP ELSE L.MAX_TEMP END AS MAX_TEMP,
--    MST_COMMON_PKG.MST_RU_LBL_GET_FNC(A.CNTR_NO) AS RSTR_USG_LBL_NM
	MST_COMMON_PKG.MST_RU_TP_GET_FNC(A.CNTR_NO) AS RSTR_USG_LBL_TP,
    MST_COMMON_PKG.MST_RU_VAL_GET_FNC(A.CNTR_NO) AS RSTR_USG_LBL_DESC,
	(SELECT INTG_CD_VAL_DP_DESC FROM COM_INTG_CD_DTL WHERE INTG_CD_ID   = 'CD30023' AND INTG_CD_VAL_CTNT = A.RF_HUMID_CTRL_VAL_CD) AS RF_HUMID_CTRL_VAL_CD,
    A.RF_CMPR_CTNT,
    A.CNTR_AUTH_NO, 
	A.CNTR_OFFH_AUTH_NO
FROM 
	( 
		SELECT 
			A.CNTR_NO,
			A.PLST_FLR_FLG,
			SUBSTR(A.CNTR_NO,11) CHK_DGT,
			DECODE(A.ACIAC_DIV_CD, 'I', 'Inactive','A','Active') ACIAC_DIV_CD,
			A.CNTR_TPSZ_CD,
			B.CNTR_TPSZ_ISO_CD,
			A.CNTR_MTRL_CD,
			E.CNTR_SPEC_NO, 
			RTRIM(TO_CHAR(ROUND(TO_NUMBER(E.TARE_WGT), 3), 'FM9999999999999990D000'), '.') TARE_WGT,
			RTRIM(TO_CHAR(ROUND(TO_NUMBER(E.TARE_WGT) * 2.2046, 3), 'FM9999999999999990D000'), '.') TARE_WGT_LBS,
            RTRIM(TO_CHAR(ROUND(TO_NUMBER(E.CNTR_GRS_WGT), 3), 'FM9999999999999990D000'), '.') CNTR_GRS_WGT,
			RTRIM(TO_CHAR(ROUND(TO_NUMBER(E.CNTR_GRS_WGT) * 2.2046, 3), 'FM9999999999999990D000'), '.') CNTR_GRS_WGT_LBS,
            RTRIM(TO_CHAR(ROUND(TO_NUMBER(E.PAY_LOAD), 3), 'FM9999999999999990D000'), '.') PAY_LOAD,
			RTRIM(TO_CHAR(ROUND(TO_NUMBER(E.PAY_LOAD) * 2.2046, 3), 'FM9999999999999990D000'), '.') PAY_LOAD_LBS,
			A.LSTM_CD,
			C.VNDR_ABBR_NM,
			C.VNDR_LGL_ENG_NM,
			TO_CHAR(A.MFT_DT, 'YYYY-MM-DD') MFT_DT,
			A.D2_PAYLD_FLG,
			--DECODE(A.RF_TP_CD,'H','HU','C','CA','M','MG','D','DF','') RF_TP_CD,
			(SELECT S.INTG_CD_VAL_DP_DESC ||' (' ||S.INTG_CD_VAL_DESC || ')' AS RF_TP_CD
		     FROM   COM_INTG_CD_DTL S
			 WHERE	S.INTG_CD_VAL_CTNT = A.RF_TP_CD
			 AND    S.INTG_CD_ID       = 'CD01085'	) RF_TP_CD,
			A.CNMV_STS_CD,
			A.CRNT_YD_CD,
			A.VSL_CD,
			A.SKD_VOY_NO,
			A.SKD_DIR_CD,
			TO_CHAR(A.CNMV_DT, 'YYYY-MM-DD HH24:MI') CNMV_DT,
			A.FULL_FLG,
			A.DMG_FLG,
			A.IMDT_EXT_FLG,
			(	SELECT INTG_CD_VAL_DP_DESC
				FROM COM_INTG_CD_DTL
				WHERE INTG_CD_ID ='CD02012'
				AND INTG_CD_VAL_CTNT = A.CNTR_HNGR_RCK_CD
			) CNTR_HNGR_RCK_CD,
			A.MNR_HNGR_BAR_TP_CD, --
			A.CNTR_HNGR_BAR_ATCH_KNT,
			A.DISP_FLG,
			A.UCLM_LS_DIV_CD UCLM_LS, 
			TO_CHAR(A.ONH_DT, 'YYYY-MM-DD') ONH_DT,
			A.ONH_DT ONH_DT_OLD,
			A.ONH_CNTR_STS_CD,
			MST_COMMON_PKG.MST_AGMT_NO_CONV_FNC(A.AGMT_CTY_CD, A.AGMT_SEQ) ONH_AGMT_NO,
			D.VNDR_SEQ,
			D.VNDR_LGL_ENG_NM LESSOR_NM,
			MNR_COMMON_PKG.MNR_CAL_DV_FNC('U',A.CNTR_NO,TO_CHAR(SYSDATE,'YYYYMMDD')) DPC_VAL,
			A.RF_MKR_SEQ,
			A.RF_MDL_NM,
			A.RF_RFR_NO,
			A.MIN_TEMP,
			A.MAX_TEMP,
			TO_CHAR(A.CRE_DT, 'YYYY-MM-DD') CRE_DT,
			A.CRE_USR_ID,
			TO_CHAR(A.UPD_DT, 'YYYY-MM-DD') UPD_DT,
			A.UPD_USR_ID,
			A.RF_HUMID_CTRL_VAL_CD,
            A.RF_CMPR_CTNT,
            A.CNTR_STS_CD,
            A.LOT_PLN_YR,
            A.LOT_LOC_CD,
            A.LOT_SEQ,
            C.VNDR_SEQ AS MFTR_VNDR_SEQ,
            C.VNDR_ABBR_NM AS MFTR_VNDR_ABBR_NM,
            A.CNTR_AUTH_NO,
			A.CNTR_OFFH_AUTH_NO
		FROM 
			MST_CONTAINER A,
			MDM_CNTR_TP_SZ B,
			(
	    	SELECT 
	    		BB.VNDR_ABBR_NM,
	       		BB.VNDR_LGL_ENG_NM,
	       		BB.VNDR_SEQ
	    	FROM
	       		MST_CONTAINER AA, 
	       		MDM_VENDOR BB,
	       		PPARAM P
	    	WHERE AA.CNTR_NO = P.CNTR_NO
	    	AND   AA.MFTR_VNDR_SEQ = BB.VNDR_SEQ
			) C,
			(
			SELECT
				AA.VNDR_SEQ,
				BB.VNDR_LGL_ENG_NM
			FROM 
				MST_CONTAINER AA,
				MDM_VENDOR BB,
				PPARAM P
			WHERE AA.CNTR_NO    = P.CNTR_NO
			AND   AA.VNDR_SEQ   = BB.VNDR_SEQ
			) D,
			(SELECT MST_SPEC_FNC('TARE', C.CNTR_NO) TARE_WGT,
                    MST_SPEC_FNC('GRSS', C.CNTR_NO) CNTR_GRS_WGT,
                    MST_SPEC_FNC('PAYL', C.CNTR_NO) PAY_LOAD,
                    B.CNTR_SPEC_NO
               FROM MST_CNTR_SPEC B,
                    MST_CONTAINER C,
                    PPARAM P,
MDM_CNTR_TP_SZ A
              WHERE 1 = 1
                AND C.CNTR_NO = P.CNTR_NO
                AND C.CNTR_SPEC_NO = B.CNTR_SPEC_NO(+)
                AND C.CNTR_TPSZ_CD = A.CNTR_TPSZ_CD(+)
            ) E,
			PPARAM P   
		WHERE 1 = 1
		AND A.CNTR_NO				=	P.CNTR_NO
		AND B.CNTR_TPSZ_CD	=	A.CNTR_TPSZ_CD
		AND A.MFTR_VNDR_SEQ	=	C.VNDR_SEQ(+)
		AND A.VNDR_SEQ			=	D.VNDR_SEQ(+)
	)A,
	(
		SELECT 
	       CASE WHEN C.ACIAC_DIV_CD = 'I' THEN 
	           CASE WHEN B.CNTR_STS_CD IN ('SBO', 'MUO', 'SBI', 'MUI') THEN D.LSTM_CD
	           ELSE C.LSTM_CD END
	       ELSE C.LSTM_CD END SUB_LSTM_CD,
	       CASE WHEN B.CNTR_STS_CD IN ('LSO', 'SBO', 'DIO', 'MUO', 'LST', 'SRO', 'SLD', 'SCR', 'DON', 'TLL')
	       THEN TO_CHAR(B.CNTR_STS_EVNT_DT, 'YYYY-MM-DD') 
	       ELSE '' END CNTR_STS_EVNT_DT,
	       CASE WHEN B.CNTR_STS_CD IN ('LSO', 'SBO', 'DIO', 'MUO', 'LST', 'SRO', 'SLD', 'SCR', 'DON', 'TLL')
	       THEN B.CNTR_STS_EVNT_DT
	       ELSE NULL END  CNTR_STS_EVNT_DT_OLD,
	       CASE WHEN B.CNTR_STS_CD IN ('LSO', 'SBO', 'DIO', 'MUO', 'LST', 'SRO', 'SLD', 'SCR', 'DON', 'TLL')
	       THEN B.CNTR_STS_CD
	       ELSE '' END CNTR_STS_CD,
	       CASE WHEN B.CNTR_STS_CD IN ('LSO', 'SBO', 'DIO', 'MUO', 'LST', 'SRO', 'SLD', 'SCR', 'DON', 'TLL')
	       THEN MST_COMMON_PKG.MST_AGMT_NO_CONV_FNC(B.AGMT_CTY_CD, B.AGMT_SEQ) 
	       ELSE '' END EXIT_AGMT_NO,
	       CASE WHEN B.CNTR_STS_CD IN ('LSO', 'SBO', 'DIO', 'MUO', 'LST', 'SRO', 'SCR', 'DON', 'TLL')
	            THEN TO_CHAR(E.VNDR_SEQ)
	       WHEN B.CNTR_STS_CD IN ('SLD') 
	            THEN DECODE(NVL(B.CUST_CNT_CD,'0'), '0', '', B.CUST_CNT_CD||B.CUST_SEQ)
	       ELSE '' END EXIT_VNDR_SEQ,
	       CASE WHEN B.CNTR_STS_CD IN ('LSO', 'SBO', 'DIO', 'MUO', 'LST', 'SRO', 'SCR', 'DON', 'TLL')
	            THEN E.VNDR_LGL_ENG_NM
	       WHEN B.CNTR_STS_CD IN ('SLD') 
	            THEN DECODE(NVL(B.CUST_CNT_CD,'0'), '0', B.CUST_NM, (SELECT CUST_LGL_ENG_NM FROM MDM_CUSTOMER WHERE CUST_CNT_CD = B.CUST_CNT_CD AND CUST_SEQ = B.CUST_SEQ))
	       ELSE '' END EXIT_VNDR_ENG_NM,
	       NVL(MST_COMMON_PKG.MST_LSE_AGMT_RT_GET_FNC(C.AGMT_CTY_CD, C.AGMT_SEQ, 'DPP',C.CNTR_TPSZ_CD, C.ONH_YD_CD), 0) DPP_TP_CD,
	       NVL(MST_COMMON_PKG.MST_LSE_AGMT_RT_GET_FNC(C.AGMT_CTY_CD, C.AGMT_SEQ, 'DPC',C.CNTR_TPSZ_CD, C.ONH_YD_CD), 0) AS DPP_AMT,
	      NVL(MST_COMMON_PKG.MST_LSE_AGMT_RT_GET_FNC(C.AGMT_CTY_CD, C.AGMT_SEQ, 'PDM',C.CNTR_TPSZ_CD, C.ONH_YD_CD), 0) AS RNTL_CHG_AMT1,
	      CASE WHEN C.ACIAC_DIV_CD = 'A' AND C.LSTM_CD = 'LT' THEN
	          CASE WHEN TRUNC(SYSDATE) - ( SELECT /*+ INDEX_DESC (A XPKLSE_AGMT_VER) */ TRUNC(EXP_DT)
										   FROM LSE_AGMT_VER A
										   WHERE  A.AGMT_CTY_CD = C.AGMT_CTY_CD
										   AND    A.AGMT_SEQ    = C.AGMT_SEQ
										   AND    ROWNUM = 1
	                            		 ) > 0
	          	   THEN  'Offhire Available !!!'
	          	   ELSE '' 
			  END
	      WHEN C.ACIAC_DIV_CD = 'A' AND C.LSTM_CD IN ('ST', 'SI', 'OF', 'MI') THEN
	          CASE WHEN TRUNC(SYSDATE)  > TRUNC(C.ONH_DT) + (NVL(C.MIN_ONH_DYS,0) - 1)
	                   THEN  'Offhire Available !!!'
	              ELSE '' END
	       ELSE '' END OFF_HIRE_AVAIL,
	       C.CNTR_NO,
	       D.LSE_VNDR_URL
		FROM
			(
			SELECT 
				A.LST_STS_SEQ MAX_STS_SEQ, 
				A.CNTR_NO
			FROM
				MST_CONTAINER A,
				PPARAM P
			WHERE 1 = 1
			AND    A.CNTR_NO = P.CNTR_NO
			) A, 
			MST_CNTR_STS_HIS B, 
			MST_CONTAINER C, 
			LSE_AGREEMENT D,
			MDM_VENDOR E
		WHERE A.CNTR_NO     = B.CNTR_NO(+)
		AND   A.MAX_STS_SEQ = B.CNTR_STS_SEQ(+)
		AND   C.CNTR_NO     = A.CNTR_NO
		AND   D.AGMT_CTY_CD(+) = B.AGMT_CTY_CD
		AND   D.AGMT_SEQ(+)    = B.AGMT_SEQ
		AND   D.VNDR_SEQ    = E.VNDR_SEQ(+)
	) B,
	(
	SELECT
    	MAX(DECODE(RN, 1, BKG_NO)) BKG_NO1,
    	MAX(DECODE(RN, 2, BKG_NO)) BKG_NO2,
    	MAX(DECODE(RN, 3, BKG_NO)) BKG_NO3
	FROM 
		(
    	SELECT ROWNUM RN,BKG_NO
    	FROM
        	(
        	SELECT /*+ INDEX_DESC(A XAK11CTM_MOVEMENT) */  
				A.BKG_NO, 
				CNMV_EVNT_DT EVNT_DT
        	FROM 
				CTM_MOVEMENT A , 
				PPARAM P , 
				MST_CONTAINER B
        	WHERE 1 = 1
        	AND B.CNTR_NO = P.CNTR_NO
        	AND A.CNTR_NO = P.CNTR_NO
        	AND B.CNMV_CYC_NO =A.CNMV_CYC_NO
        	AND A.BKG_CGO_TP_CD IN('F','R')
        	AND  ROWNUM=1
        	UNION ALL
        	SELECT /*+ INDEX_DESC(A XAK11CTM_MOVEMENT) */  
				A.BKG_NO, 
				MAX(CNMV_EVNT_DT) EVNT_DT
        	FROM 
				CTM_MOVEMENT A , 
				PPARAM P , 
				MST_CONTAINER B
        	WHERE 1 = 1
	        AND B.CNTR_NO = P.CNTR_NO
    	    AND A.CNTR_NO = P.CNTR_NO
        	AND B.CNMV_CYC_NO > A.CNMV_CYC_NO
        	AND A.MVMT_STS_CD IN('VD')
        	AND A.BKG_CGO_TP_CD IN('F','R')
        	AND ROWNUM <= 10
        	GROUP BY A.BKG_NO
        	ORDER BY EVNT_DT DESC
        	) 
    	)
	)C,
	PPARAM P,
	MST_CNTR_LOT L
WHERE A.CNTR_NO      = B.CNTR_NO
AND   A.LOT_PLN_YR   = L.LOT_PLN_YR(+)
AND   A.LOT_LOC_CD   = L.LOT_LOC_CD(+)
AND   A.CNTR_TPSZ_CD = L.CNTR_TPSZ_CD(+)
AND   A.LOT_SEQ      = L.LOT_SEQ(+)
AND   ROWNUM = 1			]]></sql>
			<params>
				<param name="cntr_no" type="12" value="" out="N"/>
				<param name="usr_ofc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
