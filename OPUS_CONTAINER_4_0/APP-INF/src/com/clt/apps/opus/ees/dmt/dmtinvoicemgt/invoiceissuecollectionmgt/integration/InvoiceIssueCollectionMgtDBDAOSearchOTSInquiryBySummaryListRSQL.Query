<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="InvoiceIssueCollectionMgtDBDAOSearchOTSInquiryBySummaryListRSQL">
			<desc><![CDATA[INVOICE 생성 및 징수관리
EES_DMT_4009
Outstanding Inquiry by Customer N Issue
이성훈
SungHoon, Lee]]></desc>
			<sql><![CDATA[
SELECT PA.PAYERC
       ,PA.PAYERN
       ,PA.INVOCN
       ,PA.INVOCR
       ,PA.BLLAMT
       ,PA.TAXAMT
       ,PA.TOTAMT
       ,PA.USEFLG
       ,SUM(DECODE(PB.TARFTP,'DMIF',1,0)) AS DMIFYN
       ,SUM(DECODE(PB.TARFTP,'DTIC',1,0)) AS DTICYN
       ,SUM(DECODE(PB.TARFTP,'DMOF',1,0)) AS DMOFYN
       ,SUM(DECODE(PB.TARFTP,'DTOC',1,0)) AS DTOCYN
       ,SUM(DECODE(PB.TARFTP,'CTIC',1,0)) AS CTICYN
       ,SUM(DECODE(PB.TARFTP,'CTOC',1,0)) AS CTOCYN
FROM
(

SELECT
		DECODE( M.ACT_PAYR_CNT_CD , '00' , '' , M.ACT_PAYR_CNT_CD )||TO_CHAR( M.ACT_PAYR_SEQ , 'FM000000' )	PAYERC,
        REPLACE( NVL( U.CUST_LGL_ENG_NM , V.VNDR_LGL_ENG_NM ) , '/' , '_' )									PAYERN,         /* PAYER NAME - CUSTOMER NAME OR VENDOR NAME */
        NVL( COUNT(*) , 0 )                                         										INVOCN,         /* INVOICE 개수 */
        M.INV_CURR_CD                                               										INVOCR,         /* INVOICE CURRENCY */
        NVL( SUM( M.INV_CHG_AMT ) , 0 )                             BLLAMT,         /* TOTAL INVOICE BILLING AMOUNT */
        NVL( SUM( M.TAX_AMT ) , 0 )                                 TAXAMT,         /* TOTAL INVOICE TAX AMOUNT */
        NVL( SUM( M.INV_AMT ) , 0 )                                 TOTAMT,         /* TOTAL INVOICE AMOUNT = TOTAL BILLING AMOUNT + TOTAL TAX AMOUNT */
		DECODE ( NVL( U.CUST_LGL_ENG_NM , 'A' ) , 'A' , V.DELT_FLG , U.DELT_FLG ) USEFLG
FROM
        DMT_INV_MN      M,
        MDM_CUSTOMER    U,
        MDM_VENDOR      V
		, MDM_ORGANIZATION MO
WHERE   
        M.CRE_DT  BETWEEN TO_DATE(@[frdt], 'YYYY-MM-DD') 
                      AND TO_DATE(@[todt], 'YYYY-MM-DD') + .99999                     /* INVOICE ISSUE DATE */

	#if ( ${isof} != '' )
	AND M.CRE_OFC_CD IN (
	    #foreach( $cre_ofc_cd_p in ${tempISOFList}) 
	        #if($velocityCount < $tempISOFList.size()) 
	           '$cre_ofc_cd_p', 
	        #else 
	           '$cre_ofc_cd_p' 
	        #end 
	    #end
	    )
	#end

AND     M.DMDT_INV_STS_CD =   'I'                                                   /* NOT CANCELED INVOICE */
AND     M.CRE_OFC_CD = MO.OFC_CD
AND     MO.AR_HD_QTR_OFC_CD = @[h_rhq_off]

#if ( ${arif} != '' )
	#if(${ar_if_cnt} > 0)
	AND ( 
		M.DMDT_AR_IF_CD IN (
	    #foreach( $dmdt_ar_if_cd_p in ${tempARIFList}) 
	        #if($velocityCount < $tempARIFList.size()) 
	           '$dmdt_ar_if_cd_p', 
	        #else 
	           '$dmdt_ar_if_cd_p' 
	        #end 
	    #end
		)
		#if (${s_ar_if_l_yn} != '')	
			OR (M.DMDT_AR_IF_CD = 'H' AND M.INV_HLD_RSN_CD = 'LIT')
		#end
	)
	#else
		#if (${s_ar_if_l_yn} != '')	
	AND (M.DMDT_AR_IF_CD = 'H' AND M.INV_HLD_RSN_CD = 'LIT')
		#else
	AND M.DMDT_AR_IF_CD = @[arif]
		#end
	#end
#end

AND     M.ACT_PAYR_CNT_CD   =   U.CUST_CNT_CD(+)                                    /* PAYER NAME 가져오기 위해 OUTER JOIN */
AND     M.ACT_PAYR_SEQ     =    U.CUST_SEQ(+)
AND     M.ACT_PAYR_SEQ      =   V.VNDR_SEQ(+)

	#if ( ${tftp} != 'A' )
	AND M.DMDT_TRF_CD IN (
	    #foreach( $dmdt_trf_cd_p in ${tempTFTPList}) 
	        #if($velocityCount < $tempTFTPList.size()) 
	           '$dmdt_trf_cd_p', 
	        #else 
	           '$dmdt_trf_cd_p' 
	        #end 
	    #end
	    )
	#end
AND     M.ACT_PAYR_CNT_CD     =   DECODE(LENGTH(@[payc]), 8, NVL(SUBSTR(@[payc], 1, 2), M.ACT_PAYR_CNT_CD), 6, M.ACT_PAYR_CNT_CD, M.ACT_PAYR_CNT_CD)
AND     M.ACT_PAYR_SEQ        =   DECODE(LENGTH(@[payc]), 8, NVL(SUBSTR(@[payc], 3, 6), M.ACT_PAYR_SEQ), 6, @[payc], M.ACT_PAYR_SEQ)

AND     (   /* ------------------------------------------------------------------- SC NO */
            M.SC_NO     =   NVL( SUBSTR( @[scno], 1, 10), M.SC_NO)
            OR
            NVL(M.SC_NO, ' ') = NVL( SUBSTR( @[scno], 1, 10), ' ')
        )
AND     (   /* ------------------------------------------------------------------- RFA NO */
            M.RFA_NO     =   NVL( SUBSTR( @[rfan], 1, 10), M.RFA_NO)
            OR
            NVL(M.RFA_NO, ' ') = NVL( SUBSTR( @[rfan], 1, 10), ' ')
        )

#if ( ${cuno} != '' )
AND     M.BKG_NO    IN   (
                            SELECT  BKG_NO
                            FROM    BKG_CUSTOMER    BC
                            WHERE BC.CUST_CNT_CD = DECODE(LENGTH(@[cuno]), 8, NVL(SUBSTR(@[cuno], 1, 2), BC.CUST_CNT_CD), 6, BC.CUST_CNT_CD, BC.CUST_CNT_CD)
                            AND BC.CUST_SEQ = DECODE(LENGTH(@[cuno]), 8, NVL(SUBSTR(@[cuno], 3, 6), BC.CUST_SEQ), 6, @[cuno], BC.CUST_SEQ)
	#if ( ${cutp} != 'A,S,C,N' )
	AND BKG_CUST_TP_CD IN (
	    #foreach( $bkg_cust_tp_cd_p in ${tempCUTPList}) 
	        #if($velocityCount < $tempCUTPList.size()) 
	           '$bkg_cust_tp_cd_p', 
	        #else 
	           '$bkg_cust_tp_cd_p' 
	        #end 
	    #end
	    )
	#else
	AND BKG_CUST_TP_CD IN ( 'S','C','N' )
	#end
                         )

#end
GROUP BY    DECODE(M.ACT_PAYR_CNT_CD, '00', '', M.ACT_PAYR_CNT_CD)||TO_CHAR( M.ACT_PAYR_SEQ , 'FM000000' ), NVL(U.CUST_LGL_ENG_NM, V.VNDR_LGL_ENG_NM), M.INV_CURR_CD, --M.DMDT_TRF_CD ,
DECODE ( NVL( U.CUST_LGL_ENG_NM , 'A' ) , 'A' , V.DELT_FLG , U.DELT_FLG )
) PA,
(	/*------------------------------------- PAYER TARIFF -------------------------------------------------*/
SELECT DISTINCT
	DECODE( M.ACT_PAYR_CNT_CD , '00' , '' , M.ACT_PAYR_CNT_CD )||TO_CHAR( M.ACT_PAYR_SEQ , 'FM000000' )	PAYERC,
	REPLACE( NVL( U.CUST_LGL_ENG_NM , V.VNDR_LGL_ENG_NM ) , '/' , '_' )									PAYERN,         /* PAYER NAME - CUSTOMER NAME OR VENDOR NAME */
	DECODE ( NVL( U.CUST_LGL_ENG_NM , 'A' ) , 'A' , V.DELT_FLG , U.DELT_FLG ) USEFLG,
	M.DMDT_TRF_CD                                               TARFTP
FROM
        DMT_INV_MN      M,
        MDM_CUSTOMER    U,
        MDM_VENDOR      V
		, MDM_ORGANIZATION MO
WHERE   
        M.CRE_DT  BETWEEN TO_DATE(@[frdt], 'YYYY-MM-DD') 
                      AND TO_DATE(@[todt], 'YYYY-MM-DD') + .99999                     /* INVOICE ISSUE DATE */

	#if ( ${isof} != '' )
	AND M.CRE_OFC_CD IN (
	    #foreach( $cre_ofc_cd_p in ${tempISOFList}) 
	        #if($velocityCount < $tempISOFList.size()) 
	           '$cre_ofc_cd_p', 
	        #else 
	           '$cre_ofc_cd_p' 
	        #end 
	    #end
	    )
	#end

AND     M.DMDT_INV_STS_CD =   'I'                                                   /* NOT CANCELED INVOICE */
AND     M.CRE_OFC_CD = MO.OFC_CD
AND     MO.AR_HD_QTR_OFC_CD = @[h_rhq_off]

#if ( ${arif} != '' )
	#if(${ar_if_cnt} > 0)
	AND ( 
		M.DMDT_AR_IF_CD IN (
	    #foreach( $dmdt_ar_if_cd_p in ${tempARIFList}) 
	        #if($velocityCount < $tempARIFList.size()) 
	           '$dmdt_ar_if_cd_p', 
	        #else 
	           '$dmdt_ar_if_cd_p' 
	        #end 
	    #end
		)
		#if (${s_ar_if_l_yn} != '')	
			OR (M.DMDT_AR_IF_CD = 'H' AND M.INV_HLD_RSN_CD = 'LIT')
		#end
	)
	#else
		#if (${s_ar_if_l_yn} != '')	
	AND (M.DMDT_AR_IF_CD = 'H' AND M.INV_HLD_RSN_CD = 'LIT')
		#else
	AND M.DMDT_AR_IF_CD = @[arif]
		#end
	#end
#end

AND     M.ACT_PAYR_CNT_CD   =   U.CUST_CNT_CD(+)                                    /* PAYER NAME 가져오기 위해 OUTER JOIN */
AND     M.ACT_PAYR_SEQ     =    U.CUST_SEQ(+)
AND     M.ACT_PAYR_SEQ      =   V.VNDR_SEQ(+)

	#if ( ${tftp} != 'A' )
	AND M.DMDT_TRF_CD IN (
	    #foreach( $dmdt_trf_cd_p in ${tempTFTPList}) 
	        #if($velocityCount < $tempTFTPList.size()) 
	           '$dmdt_trf_cd_p', 
	        #else 
	           '$dmdt_trf_cd_p' 
	        #end 
	    #end
	    )
	#end
AND     M.ACT_PAYR_CNT_CD     =   DECODE(LENGTH(@[payc]), 8, NVL(SUBSTR(@[payc], 1, 2), M.ACT_PAYR_CNT_CD), 6, M.ACT_PAYR_CNT_CD, M.ACT_PAYR_CNT_CD)
AND     M.ACT_PAYR_SEQ        =   DECODE(LENGTH(@[payc]), 8, NVL(SUBSTR(@[payc], 3, 6), M.ACT_PAYR_SEQ), 6, @[payc], M.ACT_PAYR_SEQ)

AND     (   /* ------------------------------------------------------------------- SC NO */
            M.SC_NO     =   NVL( SUBSTR( @[scno], 1, 10), M.SC_NO)
            OR
            NVL(M.SC_NO, ' ') = NVL( SUBSTR( @[scno], 1, 10), ' ')
        )
AND     (   /* ------------------------------------------------------------------- RFA NO */
            M.RFA_NO     =   NVL( SUBSTR( @[rfan], 1, 10), M.RFA_NO)
            OR
            NVL(M.RFA_NO, ' ') = NVL( SUBSTR( @[rfan], 1, 10), ' ')
        )

#if ( ${cuno} != '' )
AND     M.BKG_NO    IN   (
                            SELECT  BKG_NO
                            FROM    BKG_CUSTOMER    BC
                            WHERE BC.CUST_CNT_CD = DECODE(LENGTH(@[cuno]), 8, NVL(SUBSTR(@[cuno], 1, 2), BC.CUST_CNT_CD), 6, BC.CUST_CNT_CD, BC.CUST_CNT_CD)
                            AND BC.CUST_SEQ = DECODE(LENGTH(@[cuno]), 8, NVL(SUBSTR(@[cuno], 3, 6), BC.CUST_SEQ), 6, @[cuno], BC.CUST_SEQ)
	#if ( ${cutp} != 'A,S,C,N' )
	AND BKG_CUST_TP_CD IN (
	    #foreach( $bkg_cust_tp_cd_p in ${tempCUTPList}) 
	        #if($velocityCount < $tempCUTPList.size()) 
	           '$bkg_cust_tp_cd_p', 
	        #else 
	           '$bkg_cust_tp_cd_p' 
	        #end 
	    #end
	    )
	#else
	AND BKG_CUST_TP_CD IN ( 'S','C','N' )
	#end
                         )

#end

) PB
WHERE PA.PAYERC=PB.PAYERC
GROUP BY PA.PAYERC
       ,PA.PAYERN
       ,PA.INVOCN
       ,PA.INVOCR
       ,PA.BLLAMT
       ,PA.TAXAMT
       ,PA.TOTAMT
       ,PA.USEFLG
ORDER BY PA.PAYERC			]]></sql>
			<params>
				<param name="frdt" type="12" value="" out="N"/>
				<param name="todt" type="12" value="" out="N"/>
				<param name="h_rhq_off" type="12" value="" out="N"/>
				<param name="arif" type="12" value="" out="N"/>
				<param name="payc" type="12" value="" out="N"/>
				<param name="scno" type="12" value="" out="N"/>
				<param name="rfan" type="12" value="" out="N"/>
				<param name="cuno" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
