<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ChargeAmountDiscountMgtDBDAOSearchChargeCalculationListRSQL">
			<desc><![CDATA[After Booking 승인처리시 After Booking 계산 대상 조회를 위한 쿼리]]></desc>
			<sql><![CDATA[
SELECT	ADJ_RQST_DTL.AFT_EXPT_DAR_NO
	,	CHG_CALC.SYS_AREA_GRP_ID SVR_ID
	,	CHG_CALC.CNTR_NO
	, 	CHG_CALC.CNTR_CYC_NO
	, 	CHG_CALC.DMDT_TRF_CD
	, 	CHG_CALC.DMDT_CHG_LOC_DIV_CD
	, 	CHG_CALC.CHG_SEQ
	, 	CHG_CNTR.BKG_NO
 	, 	CHG_CNTR.BL_NO
 	, 	CHG_CNTR.VSL_CD
 	, 	CHG_CNTR.SKD_VOY_NO
 	, 	CHG_CNTR.SKD_DIR_CD
 	, 	CHG_CALC.CUST_CNT_CD
 	, 	CHG_CALC.CUST_SEQ
 	, 	CHG_CALC.ACT_CNT_CD
 	, 	CHG_CALC.ACT_CUST_SEQ
 	, 	SUBSTR(CHG_CALC.DMDT_TRF_CD, 3, 1) IO_BND_CD
 	, 	CHG_CNTR.CNTR_TPSZ_CD
 	, 	TO_CHAR(CHG_CALC.FM_MVMT_DT, 'YYYYMMDDHH24MI') FM_MVMT_DT
 	, 	CHG_CALC.FM_MVMT_YD_CD
 	, 	CHG_CALC.FM_MVMT_STS_CD
 	, 	TO_CHAR(CHG_CALC.TO_MVMT_DT, 'YYYYMMDDHH24MI') AS TO_MVMT_DT
 	, 	CHG_CALC.TO_MVMT_YD_CD
 	, 	CHG_CALC.TO_MVMT_STS_CD
 	, 	CHG_CALC.DMDT_CHG_STS_CD
 	, 	NVL(CHG_CALC.OFC_TRNS_FLG, 'N') AS OFC_TRNS_FLG
 	, 	CHG_CALC.OFC_CD
 	, 	CHG_CALC.OFC_RHQ_CD
 	, 	NVL(CHG_CALC.DUL_TP_EXPT_FLG, 'N') AS DUL_TP_EXPT_FLG
 	, 	CHG_CALC.CORR_RMK
	, 	CHG_CALC.DMDT_INV_NO
 	, 	TO_CHAR(CHG_CALC.WEB_MTY_DT, 'YYYYMMDD') WEB_MTY_DT
	,	DECODE(CHG_CALC.DMDT_TRF_CD, 'DMIF', FT_END_DT, '') AS DEM_FT_END_DT
	,	DECODE(CHG_CALC.DMDT_TRF_CD, 'DTIC', FT_END_DT, '') AS DET_FT_END_DT
	,	DECODE(CHG_CALC.DMDT_TRF_CD, 'DTIC', FX_FT_OVR_DYS, '') AS DET_FT_OVR_DYS
	,	CHG_CALC.CXL_BKG_CHG_FLG

FROM 	DMT_AFT_BKG_ADJ_RQST_DTL ADJ_RQST_DTL
 	, 	DMT_CHG_BKG_CNTR CHG_CNTR
 	, 	DMT_CHG_CALC CHG_CALC
 	, 	DMT_INV_MN INV_MN

WHERE 	ADJ_RQST_DTL.AFT_EXPT_DAR_NO = @[aft_expt_dar_no]
	AND ADJ_RQST_DTL.BKG_NO 		 = CHG_CNTR.BKG_NO
	AND CHG_CNTR.SYS_AREA_GRP_ID 	 = CHG_CALC.SYS_AREA_GRP_ID
	AND CHG_CNTR.CNTR_NO 			 = CHG_CALC.CNTR_NO
	AND CHG_CNTR.CNTR_CYC_NO 		 = CHG_CALC.CNTR_CYC_NO
	AND ADJ_RQST_DTL.DMDT_TRF_CD 	 = CHG_CALC.DMDT_TRF_CD
	AND	(
			(ADJ_RQST_DTL.EACH_CNTR_FLG = 'N')
		OR
			(
				ADJ_RQST_DTL.EACH_CNTR_FLG = 'Y'
    		   	AND  
				(CHG_CALC.SYS_AREA_GRP_ID, CHG_CALC.CNTR_NO, CHG_CALC.CNTR_CYC_NO, CHG_CALC.DMDT_TRF_CD, CHG_CALC.DMDT_CHG_LOC_DIV_CD, CHG_CALC.CHG_SEQ)
				IN
				(
					SELECT	SYS_AREA_GRP_ID, CNTR_NO, CNTR_CYC_NO, DMDT_TRF_CD, DMDT_CHG_LOC_DIV_CD, CHG_SEQ 
					FROM	DMT_AFT_BKG_CNTR
					WHERE	AFT_EXPT_DAR_NO = @[aft_expt_dar_no]
						AND (
								CNTR_CHG_DC_AMT > 0
		       	        	 OR CNTR_CHG_DC_RTO > 0
	        	    	     OR FT_ADD_DYS      > 0
    	           			 OR FT_TTL_DYS      > 0
			               	)
				)  
			)
		)
	AND CHG_CALC.DMDT_CHG_STS_CD NOT IN ('P', 'T')
	AND CHG_CALC.DMDT_INV_NO = INV_MN.DMDT_INV_NO(+)
	AND CHG_CALC.DMDT_TRF_CD = INV_MN.DMDT_TRF_CD(+)
	AND CHG_CALC.DMDT_CHG_LOC_DIV_CD NOT IN ('TSP', 'SZP')
	AND CHG_CALC.CHG_SEQ = 1			]]></sql>
			<params>
				<param name="aft_expt_dar_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
