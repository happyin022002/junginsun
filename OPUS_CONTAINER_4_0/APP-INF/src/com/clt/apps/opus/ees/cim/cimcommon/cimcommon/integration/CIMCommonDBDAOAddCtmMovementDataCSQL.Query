<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CIMCommonDBDAOAddCtmMovementDataCSQL">
			<desc><![CDATA[CIM모듈에서 CTM Movement 데이타 insert]]></desc>
			<sql><![CDATA[
INSERT INTO CTM_MOVEMENT (
        FCNTR_FLG,  
        OB_CNTR_FLG,
        VNDR_SEQ,
        SPCL_CGO_FLG,
        BKG_NO,
        BKG_KNT,
        BL_NO,
        CNTR_DISP_FLG,
        IMDT_EXT_FLG,
        CNTR_XCH_CD,
        CNMV_CO_CD,
        GMT_DT,
        CRE_USR_ID,
        UPD_USR_ID,
        USR_NM,
        CRE_DT,
        CRE_LOCL_DT,
        UPD_DT,
        UPD_LOCL_DT,
        CNTR_NO,
        CNMV_YR,
        CNMV_ID_NO,
        CNMV_SEQ,
        CNMV_SPLIT_NO,
        MVMT_STS_CD,
        BKG_CGO_TP_CD,
        CNMV_CYC_NO,
        CNMV_EVNT_DT,
        DEST_YD_CD,
        INP_YD_CD,
        ORG_YD_CD,
        CHSS_NO,
        MGST_NO,
        CNTR_DMG_FLG,
        CRNT_VSL_CD,
        CRNT_SKD_VOY_NO,
        CRNT_SKD_DIR_CD,
        TRNK_VSL_CD,
        TRNK_SKD_VOY_NO,
        TRNK_SKD_DIR_CD,
        CNTR_TPSZ_CD,
        MVMT_CRE_TP_CD,
        SYS_AREA_GRP_ID,
        OFC_CD,
        CNTR_ACT_CD,
        CNMV_RMK,
        CNTR_SEAL_NO,
        CNMV_LVL_NO,
        BKG_RCV_TERM_CD,
        MVMT_INP_TP_CD,
        CTRT_OFC_CTY_CD,
        CTRT_SEQ,
        MVMT_TRSP_MOD_CD,
        MVMT_EDI_TP_CD,
        MVMT_EDI_MSG_TP_ID,
        MVMT_EDI_MSG_AREA_CD,
        MVMT_EDI_MSG_YRMONDY,
        MVMT_EDI_MSG_SEQ,
        PRE_STS_FLG,
        CALL_SGN_NO,
        LLOYD_NO,
        WO_NO,
        EDI_VVD_CD,
        TIR_NO,
        MTY_PLN_NO,
        MTY_REPO_NO,
        EDI_CRR_NO,
        TRSP_DOC_NO,
        OSCA_BKG_FLG,
        RSTR_USG_LBL_NM_DESC,
        RSTR_USG_LBL_VAL_DESC,
        CNMV_GDT,
        MTY_REPO_VL_RMK       
)            
SELECT
          DECODE(SUB.MVMT_STS_CD, 'OP', 'N', NVL(@[fcntr_flg], 'N')) AS FCNTR_FLG
        , NVL(@[ob_cntr_flg], 'N') AS OB_CNTR_FLG  
        , DECODE (EM.VNDR_SEQ, 'null', '', EM.VNDR_SEQ) AS VNDR_SEQ
        , NVL((SELECT BB.DCGO_FLG FROM CIM_BOOKING_V BB WHERE BB.BKG_NO = @[bkg_no] AND ROWNUM = 1), 'N') AS SPCL_CGO_FLG
        , @[bkg_no]  AS BKG_NO                                                                                                 -- ''  AS BKG_NO
        , DECODE(@[bkg_no], NULL, 0, 1) AS BKG_CNT
        , @[bkg_no]  AS BL_NO
        , 'N'  AS CNTR_DISP_FLG
        , 'N'  AS IMDT_EXT_FLG
        , ''  AS CNTR_XCH_CD
        , COM_CONSTANTMGR_PKG.COM_GETCOMPANYCODE_FNC()  AS  CNMV_CO_CD
        , GLOBALDATE_PKG.TIME_CONV_FNC (SUBSTR (@[org_yd_cd], 0, 5 ), SYSDATE, 'GMT' ) AS GMT_DT
        , @[cre_usr_id] AS CRE_USR_ID                                                                                   -- '' AS CRE_USR_ID
        , @[upd_usr_id] AS UPD_USR_ID                                                                                   -- '' AS UPD_USR_ID
        , NVL(@[usr_nm],'') AS USR_NM
        , SYSDATE AS CRE_DT
        , GLOBALDATE_PKG.TIME_LOCAL_FNC(SUBSTR (@[org_yd_cd], 0, 5 )) AS CRE_LOCL_DT
        , SYSDATE AS UPD_DT
        , GLOBALDATE_PKG.TIME_LOCAL_FNC(SUBSTR (@[org_yd_cd], 0, 5 )) AS UPD_LOCL_DT
        , SUB.CNTR_NO AS CNTR_NO
        , SUB.CNMV_YR AS CNMV_YR
        , SUB.CNMV_ID_NO AS CNMV_ID_NO
        , SUB.CNMV_SEQ AS CNMV_SEQ
        , SUB.CNMV_SPLIT_NO AS CNMV_SPLIT_NO
        , SUB.MVMT_STS_CD AS MVMT_STS_CD                                           --EM.EDI_MVMT_STS_CD AS MVMT_STS_CD
        , NVL(@[bkg_cgo_tp_cd],'') AS BKG_CGO_TP_CD
        , CASE WHEN @[cnmv_cyc_no] in (NULL, 9999, 0, 9998) THEN
           DECODE(@[bkg_no], NULL, NULL
                      , NVL(  (SELECT MAX(SM.CNMV_CYC_NO)
                                 FROM CTM_MOVEMENT SM
                                WHERE SM.CNTR_NO = MC.CNTR_NO
                                  AND SM.BKG_NO  = @[bkg_no]
                               )
                             , (SELECT MAX(SM.CNMV_CYC_NO)+ 1
                                  FROM CTM_MOVEMENT SM
                                         WHERE SM.CNTR_NO = MC.CNTR_NO
                                   AND EXISTS ( SELECT 'X'
                                                  FROM CIM_BKG_CNTR_V SC
                                                 WHERE NVL(SC.CNMV_CYC_NO, 0) IN (0, 9998, 9999)
                                                   AND SM.CNTR_NO     = SC.CNTR_NO
                                                               AND SC.BKG_NO      = @[bkg_no]
                                                   AND ROWNUM         = 1)
                                ) 
                             )                         
            )
          ELSE
             @[cnmv_cyc_no]
          END AS CNMV_CYC_NO
        , SUB.CNMV_EVNT_DT AS CNMV_EVNT_DT     -- TO_DATE (EM.EVNT_DT, 'YYYY-MM-DD HH24:MI') AS CNMV_EVNT_DT
        , @[dest_yd_cd] AS DEST_YD_CD                                                                           -- '' AS DEST_YD_CD 
        , @[org_yd_cd] AS INP_YD_CD                                                                            -- EM.EVNT_YD_CD AS INP_YD_CD 
        , @[org_yd_cd] AS ORG_YD_CD                                                                             -- EM.EVNT_YD_CD AS ORG_YD_CD
        , @[chss_no]   AS CHSS_NO
        , @[mgst_no]    AS MGST_NO
        , NVL(SUB.CNTR_DMG_FLG, 'N') AS CNTR_DMG_FLG
        , @[crnt_vsl_cd]    AS CRNT_VSL_CD                                                              -- EM.CRNT_VSL_CD    AS CRNT_VSL_CD  
        , @[crnt_skd_voy_no]  AS CRNT_SKD_VOY_NO                                                        -- EM.CRNT_SKD_VOY_NO  AS CRNT_SKD_VOY_NO 
        , @[crnt_skd_dir_cd]    AS CRNT_SKD_DIR_CD                                              -- EM.CRNT_SKD_DIR_CD    AS CRNT_SKD_DIR_CD
        , (SELECT BB.VSL_CD FROM CIM_BOOKING_V BB WHERE BB.BKG_NO = @[bkg_no] AND ROWNUM = 1) AS TRNK_VSL_CD
        , (SELECT BB.SKD_VOY_NO FROM CIM_BOOKING_V BB WHERE BB.BKG_NO = @[bkg_no] AND ROWNUM = 1) AS TRNK_SKD_VOY_NO
        , (SELECT BB.SKD_DIR_CD FROM CIM_BOOKING_V BB WHERE BB.BKG_NO = @[bkg_no] AND ROWNUM = 1) AS TRNK_SKD_DIR_CD
        , MC.CNTR_TPSZ_CD AS CNTR_TPSZ_CD
        , NVL(@[mvmt_cre_tp_cd],'') AS MVMT_CRE_TP_CD
        ,(SELECT SYS_AREA_GRP_ID
            FROM COM_SYS_AREA_GRP_ID
           WHERE CNT_CD    = SUBSTR(@[org_yd_cd], 1, 2)
             AND CO_IND_CD = 'H'
            AND ROWNUM    = 1) AS CNTR_SVR_ID
        , (SELECT MY.OFC_CD
             FROM MDM_YARD MY
            WHERE MY.YD_CD = @[org_yd_cd]
              AND ROWNUM   = 1) AS OFC_CD                   -- '' AS OFC_CD
        , DECODE (EM.EDI_MVMT_STS_CD, 'XX', 'I', 'A' )  AS CNTR_ACT_CD
        , @[cnmv_rmk] AS CNMV_RMK                   -- '' AS CNMV_RMK
        , @[cntr_seal_no] AS CNTR_SEAL_NO  -- '' AS CNTR_SEAL_NO 입력
        , NVL((SELECT CNMV_LVL_NO
                FROM CTM_MVMT_SEQ
                WHERE BKG_CGO_TP_CD = @[bkg_cgo_tp_cd] 
                AND MVMT_STS_CD     = @[cnmv_evnt_cd]
                AND ROWNUM          = 1)
              , (SELECT MAX(SCM.CNMV_LVL_NO)+1
                   FROM CTM_MOVEMENT SCM
                  WHERE SCM.CNTR_NO     = SUB.CNTR_NO
                    AND SCM.CNMV_CYC_NO = @[cnmv_cyc_no])  
             ) AS CNMV_LVL_NO
        , '' AS BKG_RCV_TERM_CD
        , DECODE(@[mvmt_edi_tp_cd], NULL, 'MAN', 'EDI') AS MVMT_INP_TP_CD
        , (SELECT SMC.AGMT_CTY_CD FROM MST_CONTAINER SMC WHERE SMC.CNTR_NO = SUB.CNTR_NO AND ROWNUM = 1) CTRT_OFC_CTY_CD
        , (SELECT SMC.AGMT_SEQ FROM MST_CONTAINER SMC WHERE SMC.CNTR_NO = SUB.CNTR_NO AND ROWNUM = 1) AS CTRT_SEQ
        , @[mvmt_trsp_mod_cd]       AS MVMT_TRSP_MOD_CD                       -- '' AS MVMT_TRSP_MOD_CD
        , SUB.MVMT_EDI_TP_CD        AS MVMT_EDI_TP_CD                           -- '' AS MVMT_EDI_TP_CD
        , SUB.MVMT_EDI_MSG_TP_ID    AS MVMT_EDI_MSG_TP_ID                   -- '' AS MVMT_EDI_MSG_TP_ID
        , SUB.MVMT_EDI_MSG_AREA_CD  AS MVMT_EDI_MSG_AREA_CD               -- '' AS MVMT_EDI_MSG_AREA_CD
        , SUB.MVMT_EDI_MSG_YRMONDY  AS MVMT_EDI_MSG_YRMONDY               -- '' AS MVMT_EDI_MSG_YRMONDY
        , SUB.MVMT_EDI_MSG_SEQ      AS MVMT_EDI_MSG_SEQ                               -- '' AS MVMT_EDI_MSG_SEQ
        , 'N' AS PRE_STS_FLG
        , @[call_sgn_no] AS CALL_SGN_NO                                                 -- '' AS CALL_SGN_NO
        , @[lloyd_no] AS LLOYD_NO                                                               -- '' AS LLOYD_NO
        , @[wo_no] AS WO_NO                                                                             -- '' AS WO_NO  -- 입력
        , @[edi_vvd_cd] AS EDI_VVD_CD                                                   -- '' AS EDI_VVD_CD
        , @[tir_no] AS TIR_NO                                                                   -- '' AS TIR_NO -- 입력
        , @[mty_pln_no] AS MTY_PLN_NO                                                   -- '' AS MTY_PLN_NO -- 입력
        , @[mty_repo_no] AS MTY_REPO_NO                                                 -- '' AS MTY_REPO_NO -- 입력
        , @[edi_crr_no] AS EDI_CRR_NO                                                   -- '' AS EDI_CRR_NO -- 입력
        , @[trsp_doc_no] AS TRSP_DOC_NO                                                 -- '' AS TRSP_DOC_NO -- 입력
        , @[osca_bkg_flg] AS OSCA_BKG_FLG                                               -- '' AS OSCA_BKG_FLG
        , MST_COMMON_PKG.MST_RU_TP_GET_FNC(EM.CNTR_NO) AS RSTR_USG_LBL_NM_DESC
        , MST_COMMON_PKG.MST_RU_VAL_GET_FNC(EM.CNTR_NO) AS RSTR_USG_LBL_VAL_DESC
        , GLOBALDATE_PKG.TIME_CONV_FNC (SUBSTR (@[org_yd_cd], 0, 5 ), SUB.CNMV_EVNT_DT, 'GMT' )
        , 'UPDATED BY SYSTEM('||TO_CHAR(SYSDATE, 'YYYY.MM.DD HH24:MI:SS')||')' AS MTY_REPO_VL_RMK
FROM       CTM_MVMT_EDI_MSG EM
        ,  MST_CONTAINER MC
        , (SELECT   SUB.CNTR_NO
                  , SUB.CNMV_YR
                  , DECODE(LVL.LVL, 1, SUB.MVMT_STS_CD, DECODE(@[fcntr_flg], 'Y', 'IC', 'MT')) AS MVMT_STS_CD
                  , DECODE(SUB.LST_FLG, 'Y', SUB.CNMV_SEQ + LVL.LVL, SUB.CNMV_SEQ) AS CNMV_SEQ
                  , (SUB.CNMV_ID_NO + LVL.LVL ) AS CNMV_ID_NO
                  , TO_CHAR(DECODE(SUB.LST_FLG, 'Y', ' '
                                                   , NVL((SELECT MAX(TO_NUMBER(CHK.CNMV_SPLIT_NO))
                                                            FROM CTM_MOVEMENT CHK
                                                           WHERE REGEXP_INSTR(CHK.CNMV_SPLIT_NO,'[^0-9]') = 0
                                                             AND SUB.CNTR_NO  = CHK.CNTR_NO
                                                             AND SUB.CNMV_YR  = CHK.CNMV_YR
                                                             AND SUB.CNMV_SEQ = CHK.CNMV_SEQ), 0) + LVL.LVL
                                   )
                           ) AS CNMV_SPLIT_NO
                  , DECODE(LVL.LVL, 1, TO_DATE (@[cnmv_evnt_dt], 'YYYY-MM-DD HH24:MI')
                                  , TO_DATE (@[cnmv_evnt_dt], 'YYYY-MM-DD HH24:MI') + 0.00009
                           ) AS CNMV_EVNT_DT
                  , @[mvmt_edi_tp_cd]         AS MVMT_EDI_TP_CD
                  , @[mvmt_edi_msg_tp_id]     AS MVMT_EDI_MSG_TP_ID
                  , @[mvmt_edi_msg_area_cd]   AS MVMT_EDI_MSG_AREA_CD
                  , @[mvmt_edi_msg_yrmondy]   AS MVMT_EDI_MSG_YRMONDY
                  , @[mvmt_edi_msg_seq]       AS MVMT_EDI_MSG_SEQ
                  , @[cntr_dmg_flg]           AS CNTR_DMG_FLG
             FROM 
                     (SELECT CNTR_NO
                           , CNMV_YR
                           , CNMV_SEQ
                           , CNMV_ID_NO
                           , MVMT_STS_CD
                           , LST_FLG
                       FROM ( 
                            SELECT     P.CNTR_NO
                                    ,  'N' AS LST_FLG
                                    ,  P.MVMT_STS_CD AS MVMT_STS_CD
                                    ,  TO_CHAR(P.CNMV_EVNT_DT, 'YYYY') AS CNMV_YR
                                    ,  NVL(MAX(CM.CNMV_SEQ), 1)        AS CNMV_SEQ
                                    ,  MAX(NVL((SELECT NVL(MAX(SCM.CNMV_ID_NO), 0)
                                                  FROM CTM_MOVEMENT SCM
                                                 WHERE SCM.CNTR_NO = P.CNTR_NO
                                                   AND SCM.CNMV_YR = TO_CHAR(P.CNMV_EVNT_DT, 'YYYY')
                                                 GROUP BY SCM.CNTR_NO, SCM.CNMV_YR), NVL(CM.CNMV_ID_NO, 0) ))   AS CNMV_ID_NO
                            FROM CTM_MOVEMENT CM
                               , (SELECT @[cntr_no]                AS CNTR_NO
                                       , TO_DATE (@[cnmv_evnt_dt], 'YYYY-MM-DD HH24:MI')  AS CNMV_EVNT_DT
                                       , @[mvmt_sts_cd] AS MVMT_STS_CD
                                    FROM DUAL) P
                            WHERE P.CNTR_NO                        = CM.CNTR_NO
                            AND    TO_CHAR(P.CNMV_EVNT_DT, 'YYYY') = CM.CNMV_YR
                            AND    P.CNMV_EVNT_DT > CM.CNMV_EVNT_DT
                            GROUP BY P.CNTR_NO, TO_CHAR(P.CNMV_EVNT_DT, 'YYYY')
                            UNION ALL
                            SELECT 
                                       P.CNTR_NO
                                    ,  'Y' AS LST_FLG
                                    ,  P.MVMT_STS_CD AS MVMT_STS_CD
                                    ,  TO_CHAR(P.CNMV_EVNT_DT, 'YYYY') CNMV_YR
                                    ,  NVL(MAX(CM.CNMV_SEQ), 0)       AS CNMV_SEQ
                                    ,  NVL(MAX(CM.CNMV_ID_NO), 0)     AS CNMV_ID_NO
                            FROM CTM_MOVEMENT CM
                              , (SELECT @[cntr_no]                AS CNTR_NO
                                      , TO_DATE (@[cnmv_evnt_dt], 'YYYY-MM-DD HH24:MI')  AS CNMV_EVNT_DT
                                      , @[mvmt_sts_cd] AS MVMT_STS_CD
                                   FROM DUAL) P
                            WHERE P.CNTR_NO                        = CM.CNTR_NO(+)
                            AND    TO_CHAR(P.CNMV_EVNT_DT, 'YYYY') = CM.CNMV_YR(+)
                            GROUP BY P.CNTR_NO, TO_CHAR(P.CNMV_EVNT_DT, 'YYYY')
                     )
                    WHERE ROWNUM = 1
                    ORDER BY LST_FLG) SUB
                    , (SELECT LEVEL LVL
                        FROM DUAL
                        CONNECT BY LEVEL < DECODE(@[mvmt_sts_cd], 'VD', 3, 2)
                      ) LVL   
      ) SUB
WHERE SUB.CNTR_NO              = EM.CNTR_NO(+)
  AND SUB.MVMT_EDI_TP_CD       = EM.MVMT_EDI_TP_CD(+)
  AND SUB.MVMT_EDI_MSG_TP_ID   = EM.MVMT_EDI_MSG_TP_ID(+)
  AND SUB.MVMT_EDI_MSG_AREA_CD = EM.MVMT_EDI_MSG_AREA_CD(+)
  AND SUB.MVMT_EDI_MSG_YRMONDY = EM.MVMT_EDI_MSG_YRMONDY(+)
  AND SUB.MVMT_EDI_MSG_SEQ     = EM.MVMT_EDI_MSG_SEQ(+)
  AND SUB.CNTR_NO              = MC.CNTR_NO			]]></sql>
			<params>
				<param name="fcntr_flg" type="12" value="" out="N"/>
				<param name="ob_cntr_flg" type="12" value="" out="N"/>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="org_yd_cd" type="12" value="" out="N"/>
				<param name="cre_usr_id" type="12" value="" out="N"/>
				<param name="upd_usr_id" type="12" value="" out="N"/>
				<param name="usr_nm" type="12" value="" out="N"/>
				<param name="bkg_cgo_tp_cd" type="12" value="" out="N"/>
				<param name="cnmv_cyc_no" type="12" value="" out="N"/>
				<param name="dest_yd_cd" type="12" value="" out="N"/>
				<param name="chss_no" type="12" value="" out="N"/>
				<param name="mgst_no" type="12" value="" out="N"/>
				<param name="crnt_vsl_cd" type="12" value="" out="N"/>
				<param name="crnt_skd_voy_no" type="12" value="" out="N"/>
				<param name="crnt_skd_dir_cd" type="12" value="" out="N"/>
				<param name="mvmt_cre_tp_cd" type="12" value="" out="N"/>
				<param name="cnmv_rmk" type="12" value="" out="N"/>
				<param name="cntr_seal_no" type="12" value="" out="N"/>
				<param name="cnmv_evnt_cd" type="12" value="" out="N"/>
				<param name="mvmt_edi_tp_cd" type="12" value="" out="N"/>
				<param name="mvmt_trsp_mod_cd" type="12" value="" out="N"/>
				<param name="call_sgn_no" type="12" value="" out="N"/>
				<param name="lloyd_no" type="12" value="" out="N"/>
				<param name="wo_no" type="12" value="" out="N"/>
				<param name="edi_vvd_cd" type="12" value="" out="N"/>
				<param name="tir_no" type="12" value="" out="N"/>
				<param name="mty_pln_no" type="12" value="" out="N"/>
				<param name="mty_repo_no" type="12" value="" out="N"/>
				<param name="edi_crr_no" type="12" value="" out="N"/>
				<param name="trsp_doc_no" type="12" value="" out="N"/>
				<param name="osca_bkg_flg" type="12" value="" out="N"/>
				<param name="cnmv_evnt_dt" type="12" value="" out="N"/>
				<param name="mvmt_edi_msg_tp_id" type="12" value="" out="N"/>
				<param name="mvmt_edi_msg_area_cd" type="12" value="" out="N"/>
				<param name="mvmt_edi_msg_yrmondy" type="12" value="" out="N"/>
				<param name="mvmt_edi_msg_seq" type="12" value="" out="N"/>
				<param name="cntr_dmg_flg" type="12" value="" out="N"/>
				<param name="cntr_no" type="12" value="" out="N"/>
				<param name="mvmt_sts_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
