<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="LeaseReportDBDAOSubLeaseOutContainerDetailRSQL">
			<desc><![CDATA[Sub Lease 자사장비 및 Mis Use 타사장비의 상세내역을 조회합니다.
2010.12.01 박명신 [CHM-201007443-01] REF_NO 항목 추가
2010.12.13 신자영 [CHM-201007442-01] LT일때 Per-Diem LCC로 변경]]></desc>
			<sql><![CDATA[
SELECT  ROW_SEQ
        , CNTR_NO, CNTR_STS_CD, CNTR_TPSZ_CD, LSTM_CD 
        , CNTR_STS_EVNT_DT, CNTR_RTN_EVNT_DT, RCC_CD, LCC_CD, SCC_CD, LOC_CD
        , YD_CD, RTN_YD_CD, CNTRY_CD
        , LSI_AGMT_CTY_CD, LSI_AGMT_SEQ, LSI_AGMT_NO, LSI_REF_NO
        , AGMT_CTY_CD    , AGMT_SEQ    , AGMT_NO    , REF_NO
        , APPROVAL_NO, VNDR_SEQ, VNDR_ABBR_NM, CNTR_FULL_FLG
        , RNTL_CHG_FREE_DYS
--        , TTL_USE_DYS
		,DECODE(MST_COMMON_PKG.MST_HO_OFC_CHK_FNC(@[usr_ofc_cd])
 				,'Y',TTL_USE_DYS 
 				,'N','') AS TTL_USE_DYS
--      , DECODE(SIGN(PDM_AMT), -1, 0, PDM_AMT) AS PDM_AMT
		,DECODE(MST_COMMON_PKG.MST_HO_OFC_CHK_FNC(@[usr_ofc_cd])
 				,'Y',DECODE(SIGN(PDM_AMT), -1, 0, PDM_AMT) 
 				,'N','') AS PDM_AMT
		, LON_AMT, LOF_AMT, DOC_AMT
--      , NVL(DECODE(SIGN(PDM_AMT), -1, 0, PDM_AMT), 0) + LON_AMT + LOF_AMT + DOC_AMT AS TTL_AMT
		,DECODE(MST_COMMON_PKG.MST_HO_OFC_CHK_FNC(@[usr_ofc_cd])
 				,'Y',NVL(DECODE(SIGN(PDM_AMT), -1, 0, PDM_AMT), 0) + LON_AMT + LOF_AMT + DOC_AMT 
 				,'N','') AS TTL_AMT
FROM   (SELECT /*+ ORDERED */ 
               ROWNUM                                                                     AS ROW_SEQ
               , B.CNTR_NO, B.CNTR_STS_CD, A.CNTR_TPSZ_CD, A.LSTM_CD
               , B.RCC_CD, B.LCC_CD, B.SCC_CD, B.YD_CD, B.LOC_CD
               , TO_CHAR(B.CNTR_STS_EVNT_DT,'YYYYMMDD')                                 AS CNTR_STS_EVNT_DT 
               , (SELECT /*+ INDEX_ASC(SUB XAK1MST_CNTR_STS_HIS) */
                                TO_CHAR(SUB.CNTR_STS_EVNT_DT,'YYYYMMDD')    
                     FROM MST_CNTR_STS_HIS SUB
                    WHERE B.CNTR_NO                   = SUB.CNTR_NO
                       AND SUB.CNTR_STS_CD           = DECODE(B.CNTR_STS_CD, 'SBO', 'SBI', 'MUI')
                        AND SUB.CNTR_LSTM_CNG_FLG = 'N'
                         AND B.CNTR_STS_EVNT_DT     <= SUB.CNTR_STS_EVNT_DT
                         AND ROWNUM          = 1) AS CNTR_RTN_EVNT_DT              
               , SUBSTR(B.LOC_CD,1,2)                                                     AS CNTRY_CD
               , A.AGMT_CTY_CD AS LSI_AGMT_CTY_CD, A.AGMT_SEQ AS LSI_AGMT_SEQ, A.AGMT_CTY_CD||LPAD(A.AGMT_SEQ, 6, '0')     AS LSI_AGMT_NO, F.REF_NO AS LSI_REF_NO
               , B.AGMT_CTY_CD                   , B.AGMT_SEQ                , B.AGMT_CTY_CD||LPAD(B.AGMT_SEQ, 6, '0')     AS AGMT_NO    , C.REF_NO
#if (${cntr_sts_cd} == '(SB|MU)O' || ${cntr_sts_cd} == 'SBO' || ${cntr_sts_cd} == 'MUO')
	#if (${lst_sts_flg} == '01')		
	, A.CNTR_OFFH_AUTH_NO                                                    AS APPROVAL_NO
	#else
	, B.CNTR_OFFH_AUTH_NO                                                    AS APPROVAL_NO
	#end
#else
	#if (${lst_sts_flg} == '01')		
	, A.CNTR_AUTH_NO                                                    AS APPROVAL_NO
	#else
	, B.CNTR_AUTH_NO                                                    AS APPROVAL_NO
	#end
#end
               , C.VNDR_SEQ, SUBSTR(NVL(D.VNDR_ABBR_NM, D.VNDR_SEQ),0,8)                 AS VNDR_ABBR_NM
               , B.CNTR_FULL_FLG
               , B.RNTL_CHG_FREE_DYS
               , (SELECT /*+ INDEX_ASC(SUB XAK1MST_CNTR_STS_HIS) */
                                SUB.YD_CD
                     FROM MST_CNTR_STS_HIS SUB
                    WHERE B.CNTR_NO                   = SUB.CNTR_NO
                       AND SUB.CNTR_STS_CD           = DECODE(B.CNTR_STS_CD, 'SBO', 'SBI', 'MUI')
                        AND SUB.CNTR_LSTM_CNG_FLG = 'N'
                         AND B.CNTR_STS_EVNT_DT     <= SUB.CNTR_STS_EVNT_DT 
                         AND ROWNUM          = 1) AS RTN_YD_CD                
                 , TRUNC(NVL((SELECT /*+ INDEX_ASC(SUB XAK1MST_CNTR_STS_HIS) */
                                            SUB.CNTR_STS_EVNT_DT  
                                   FROM MST_CNTR_STS_HIS SUB 
                                  WHERE B.CNTR_NO                   = SUB.CNTR_NO
                                     AND SUB.CNTR_STS_CD           = DECODE(B.CNTR_STS_CD, 'SBO', 'SBI', 'MUI')
                                     AND SUB.CNTR_LSTM_CNG_FLG = 'N'
                                     AND B.CNTR_STS_EVNT_DT     <= SUB.CNTR_STS_EVNT_DT
                                      AND ROWNUM          = 1
                                  ), TRUNC(SYSDATE)) - B.CNTR_STS_EVNT_DT)+1 AS TTL_USE_DYS                 
              , ((TRUNC(NVL((SELECT /*+ INDEX_ASC(SUB XAK1MST_CNTR_STS_HIS) */
                                            SUB.CNTR_STS_EVNT_DT
                                   FROM MST_CNTR_STS_HIS SUB
                                  WHERE B.CNTR_NO                   = SUB.CNTR_NO
                                     AND SUB.CNTR_STS_CD           = DECODE(B.CNTR_STS_CD, 'SBO', 'SBI', 'MUI')
                                     AND SUB.CNTR_LSTM_CNG_FLG = 'N'
                                     AND B.CNTR_STS_EVNT_DT     <= SUB.CNTR_STS_EVNT_DT
                                      AND ROWNUM          = 1              
                                 ),SYSDATE) - B.CNTR_STS_EVNT_DT  - NVL(B.RNTL_CHG_FREE_DYS , 0))) + 1)
                * MST_COMMON_PKG.MST_LSE_AGMT_RT_GET_FNC(B.AGMT_CTY_CD, B.AGMT_SEQ, 'PDM', A.CNTR_TPSZ_CD, B.YD_CD) AS PDM_AMT
               , NVL(B.CNTR_LFT_CHG_AMT,0) AS LON_AMT
               , NVL((SELECT /*+ INDEX_ASC(SUB XAK1MST_CNTR_STS_HIS) */
                                SUB.CNTR_LFT_CHG_AMT
                     FROM MST_CNTR_STS_HIS SUB
                    WHERE B.CNTR_NO                   = SUB.CNTR_NO
                       AND SUB.CNTR_STS_CD           = DECODE(B.CNTR_STS_CD, 'SBO', 'SBI', 'MUI')
                        AND SUB.CNTR_LSTM_CNG_FLG = 'N'
                         AND B.CNTR_STS_EVNT_DT     <= SUB.CNTR_STS_EVNT_DT
                         AND ROWNUM          = 1), 0)   AS LOF_AMT       
                 , NVL((SELECT /*+ INDEX_ASC(SUB XAK1MST_CNTR_STS_HIS) */
                                SUB.CNTR_DRFF_CR_AMT
                     FROM MST_CNTR_STS_HIS SUB
                    WHERE B.CNTR_NO                   = SUB.CNTR_NO
                       AND SUB.CNTR_STS_CD           = DECODE(B.CNTR_STS_CD, 'SBO', 'SBI', 'MUI')
                        AND SUB.CNTR_LSTM_CNG_FLG = 'N'
                         AND B.CNTR_STS_EVNT_DT     <= SUB.CNTR_STS_EVNT_DT
                         AND ROWNUM          = 1), 0)   AS DOC_AMT       
        FROM    MST_CONTAINER    A,
                MST_CNTR_STS_HIS B,
                LSE_AGREEMENT    C,
                MDM_VENDOR       D,
                LSE_AGREEMENT    F
#if (${cntr_sts_cd} == '(SB|MU)O' || ${cntr_sts_cd} == 'SBO' || ${cntr_sts_cd} == 'MUO')
#else
              , MST_CNTR_STS_HIS E
#end
        WHERE   A.CNTR_NO      = B.CNTR_NO
        AND     B.AGMT_CTY_CD  = C.AGMT_CTY_CD
        AND     B.AGMT_SEQ     = C.AGMT_SEQ
        AND     C.VNDR_SEQ     = D.VNDR_SEQ
        AND     A.AGMT_CTY_CD  = F.AGMT_CTY_CD
        AND     A.AGMT_SEQ     = F.AGMT_SEQ
#if (${cntr_sts_cd} == '(SB|MU)O' || ${cntr_sts_cd} == 'SBO' || ${cntr_sts_cd} == 'MUO')
	#if (${lst_sts_flg} == '01')
        AND     B.CNTR_STS_SEQ = ( SELECT /*+ INDEX_DESC(SUB XAK1MST_CNTR_STS_HIS) */ 
                                                 SUB.CNTR_STS_SEQ
                                     FROM MST_CNTR_STS_HIS SUB
                                    WHERE SUB.CNTR_NO               = A.CNTR_NO
                                      AND SUB.CNTR_STS_CD           = A.CNTR_STS_CD                                                                                       
                                      AND SUB.CNTR_LSTM_CNG_FLG     = 'N'
                                      AND ROWNUM                    = 1)
		#if(${cntr_onh_auth_no} != '')
			AND   A.CNTR_OFFH_AUTH_NO = @[cntr_onh_auth_no]
		#end
	    #if (${cntr_sts_cd} == '(SB|MU)O' )
           AND		A.CNTR_STS_CD IN('SBO','MUO')
	    #else
           AND		A.CNTR_STS_CD = @[cntr_sts_cd]
	    #end
    #else
        AND     B.CNTR_LSTM_CNG_FLG  = 'N'
		#if(${cntr_onh_auth_no} != '')
			AND   B.CNTR_OFFH_AUTH_NO = @[cntr_onh_auth_no]
		#end
	#end
	
	#if (${cntr_sts_cd} == '(SB|MU)O' )
        AND		B.CNTR_STS_CD IN('SBO','MUO')
	#else
        AND		B.CNTR_STS_CD = @[cntr_sts_cd]
	#end
	#if (${total_flg} != 'Y')
		#if (${loc_tp} == '0' && ${loc_cd} != '')
	        AND     B.RCC_CD = @[loc_cd]
		#elseif (${loc_tp} == '1' && ${loc_cd} != '')
	        AND     SUBSTR(B.LOC_CD,1,2) = @[loc_cd]
		#elseif (${loc_tp} == '2' && ${loc_cd} != '')
	        AND     B.LCC_CD = @[loc_cd]
		#elseif (${loc_tp} == '3' && ${loc_cd} != '')
	        AND     B.SCC_CD = @[loc_cd]
		#elseif (${loc_tp} == '4' && ${loc_cd} != '')
	        AND     B.YD_CD LIKE @[loc_cd] || '%'
		#elseif (${loc_tp} == '5' && ${loc_cd} != '')
	        AND     SUBSTR(B.LOC_CD,1,2) = @[loc_cd]
		#end
	#else
	    #if     (${loc_tp} == '2' && ${loc_cd} != '')
	        AND     B.RCC_CD = @[loc_cd]
		#elseif (${loc_tp} == '3' && ${loc_cd} != '')
	        AND     B.LCC_CD = @[loc_cd]
		#elseif (${loc_tp} == '4' && ${loc_cd} != '')
	        AND     B.SCC_CD = @[loc_cd]
		#elseif (${loc_tp} == '5' && ${loc_cd} != '')
	        AND     SUBSTR(B.LOC_CD,1,2) = @[loc_cd]
		#end
	#end
	#if (${str_evnt_dt} != '')
        AND     B.CNTR_STS_EVNT_DT BETWEEN TO_DATE(@[str_evnt_dt],'YYYYMMDD')  
        AND 	TO_DATE(@[end_evnt_dt],'YYYYMMDD')
	#end
	#if (${agmt_seq} != '')
        AND     B.AGMT_CTY_CD = @[agmt_cty_cd]
        AND     B.AGMT_SEQ    = @[agmt_seq]
	#end
	#if (${cntr_full_flg} != '')
        AND     B.CNTR_FULL_FLG = @[cntr_full_flg]
	#end
#else
        AND     B.CNTR_NO             = E.CNTR_NO
        AND     B.CNTR_STS_SEQ        = ( SELECT /*+ INDEX_DESC(SUB XAK1MST_CNTR_STS_HIS) */ 
                                                 SUB.CNTR_STS_SEQ
                                            FROM MST_CNTR_STS_HIS SUB
                                           WHERE SUB.CNTR_NO               = A.CNTR_NO                                                                                          
                                             AND SUB.CNTR_STS_CD           = SUBSTR(E.CNTR_STS_CD, 1, 2)||'O'
                                             AND SUB.CNTR_LSTM_CNG_FLG     = 'N'
                                             AND ROWNUM                    = 1)
        AND     E.CNTR_LSTM_CNG_FLG   = 'N'
	#if (${lst_sts_flg} == '01')
		#if(${cntr_onh_auth_no} != '')
			AND   A.CNTR_AUTH_NO = @[cntr_onh_auth_no]
		#end
    	AND     A.LST_STS_SEQ = E.CNTR_STS_SEQ
	#else
		#if(${cntr_onh_auth_no} != '')
			AND   B.CNTR_AUTH_NO = @[cntr_onh_auth_no]
		#end
	#end
	#if (${cntr_sts_cd} == '(SB|MU)I' )
		AND		E.CNTR_STS_CD IN('SBI','MUI')
	#else
		AND		E.CNTR_STS_CD = @[cntr_sts_cd]
	#end
	#if (${loc_tp} == '0' && ${loc_cd} != '')
        AND     E.RCC_CD = @[loc_cd]
	#elseif (${loc_tp} == '1' && ${loc_cd} != '')
        AND     SUBSTR(E.LOC_CD,1,2) = @[loc_cd]
	#elseif (${loc_tp} == '2' && ${loc_cd} != '')
        AND     E.LCC_CD = @[loc_cd]
	#elseif (${loc_tp} == '3' && ${loc_cd} != '')
        AND     E.SCC_CD = @[loc_cd]
	#elseif (${loc_tp} == '4' && ${loc_cd} != '')
        AND     E.YD_CD = @[loc_cd]
	#elseif (${loc_tp} == '5' && ${loc_cd} != '')
        AND     SUBSTR(E.LOC_CD,1,2) = @[loc_cd]
	#end
	#if (${str_evnt_dt} != '')
        AND     E.CNTR_STS_EVNT_DT BETWEEN TO_DATE(@[str_evnt_dt],'YYYYMMDD') AND 	TO_DATE(@[end_evnt_dt],'YYYYMMDD')
	#end
	#if (${agmt_seq} != '')
        AND     E.AGMT_CTY_CD 	= @[agmt_cty_cd]
        AND     E.AGMT_SEQ    	= @[agmt_seq]
	#end
	#if (${cntr_full_flg} != '')
        AND     E.CNTR_FULL_FLG = @[cntr_full_flg]
	#end
#end		
#if (${lstm_soc_tp} == '03')
        AND     A.LSTM_CD = 'SH'
#elseif (${lstm_soc_tp} == '02')
        AND     A.LSTM_CD 			<> 'SH'
#end  
#if (${vndr_seq} != '')
        AND     C.VNDR_SEQ 			= @[vndr_seq]
#end
#if (${onh_free_dys} != '')
	AND @[onh_free_dys] <= DECODE(MST_COMMON_PKG.MST_HO_OFC_CHK_FNC(@[usr_ofc_cd])
 				,'Y', 
		TRUNC(NVL((SELECT /*+ INDEX_ASC(SUB XAK1MST_CNTR_STS_HIS) */
                                            SUB.CNTR_STS_EVNT_DT
                                   FROM MST_CNTR_STS_HIS SUB
                                  WHERE B.CNTR_NO                   = SUB.CNTR_NO
                                     AND SUB.CNTR_STS_CD           = DECODE(B.CNTR_STS_CD, 'SBO', 'SBI', 'MUI')
                                     AND SUB.CNTR_LSTM_CNG_FLG = 'N'
                                     AND B.CNTR_STS_EVNT_DT     <= SUB.CNTR_STS_EVNT_DT
                                      AND ROWNUM          = 1
                                  ), TRUNC(SYSDATE)) - B.CNTR_STS_EVNT_DT)+1
 				,'N','')
#end
#if (${lstm_cd} != '')
        AND     A.LSTM_CD IN (
   	#foreach($key IN ${lstm_cd_seq})
   		#if($velocityCount < $lstm_cd_seq.size())
   			'$key',
   		#else
   			'$key'
   		#end
   	#end
                )
#end
#if (${cntr_tpsz_cd} != '')
        AND     A.CNTR_TPSZ_CD IN (
   	#foreach($key IN ${cntr_tpsz_cd_seq})
   		#if($velocityCount < $cntr_tpsz_cd_seq.size())
   			'$key',
   		#else
   			'$key'
   		#end
   	#end
                )
#end
)
#if (${startno} != '') 
WHERE 	ROW_SEQ BETWEEN @[startno] AND @[endno]
#end			]]></sql>
			<params>
				<param name="usr_ofc_cd" type="12" value="" out="N"/>
				<param name="cntr_onh_auth_no" type="12" value="" out="N"/>
				<param name="cntr_sts_cd" type="12" value="" out="N"/>
				<param name="loc_cd" type="12" value="" out="N"/>
				<param name="str_evnt_dt" type="12" value="" out="N"/>
				<param name="end_evnt_dt" type="12" value="" out="N"/>
				<param name="agmt_cty_cd" type="12" value="" out="N"/>
				<param name="agmt_seq" type="2" value="" out="N"/>
				<param name="cntr_full_flg" type="12" value="" out="N"/>
				<param name="vndr_seq" type="2" value="" out="N"/>
				<param name="onh_free_dys" type="2" value="" out="N"/>
				<param name="startno" type="2" value="" out="N"/>
				<param name="endno" type="2" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
