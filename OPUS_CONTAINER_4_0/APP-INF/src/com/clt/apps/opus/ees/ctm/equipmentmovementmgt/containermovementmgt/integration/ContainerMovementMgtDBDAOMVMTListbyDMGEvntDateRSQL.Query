<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ContainerMovementMgtDBDAOMVMTListbyDMGEvntDateRSQL">
			<desc><![CDATA[DMG Flagging/Unflagging Date 보다 같거나 나중인 MVMT List]]></desc>
			<sql><![CDATA[
SELECT CNMV_YR,
	   CNMV_ID_NO, 
	   ORG_YD_CD,
	   CNTR_TPSZ_CD,
       TO_CHAR (CNMV_EVNT_DT, 'YYYYMMDDHH24MI') AS CNTR_EVNT_DT,
	MVMT_CRE_TP_CD,
	MVMT_STS_CD,
	#if (${last_flg} == 'N')
	#if (${cntr_dmg_flg} == 'N')
	CASE WHEN DMG_FLG_DT IS NOT NULL AND (SELECT CNMV_EVNT_DT
                                        FROM CTM_MOVEMENT
                                        WHERE 1=1
                                        AND CNTR_NO = @[cntr_no]
                                        AND CNTR_DMG_FLG = 'Y'
                                        AND CNMV_EVNT_DT > TO_DATE (@[evnt_dt], 'YYYYMMDDHH24MISS')
                                        AND ROWNUM=1) > CNMV_EVNT_DT THEN ''
         ELSE (SELECT TO_CHAR(CNMV_EVNT_DT, 'YYYYMMDDHH24MI')
              FROM CTM_MOVEMENT
              WHERE 1=1
              AND CNTR_NO = @[cntr_no]
              AND CNTR_DMG_FLG = 'Y'
              AND CNMV_EVNT_DT > TO_DATE (@[evnt_dt], 'YYYYMMDDHH24MISS')
              AND ROWNUM=1)
       END AS NEXT_EVNT_DT,
	#end
	#else
	CASE WHEN DMG_FLG_DT IS NOT NULL 
              AND CNTR_DMG_FLG = 'Y' 
              AND DMG_FLG_DT > TO_DATE (@[evnt_dt], 'YYYYMMDDHH24MISS')
             THEN TO_CHAR(DMG_FLG_DT, 'YYYYMMDDHH24MI')
             WHEN DMG_UNFLG_DT IS NOT NULL 
              AND CNTR_DMG_FLG = 'N' 
              AND DMG_UNFLG_DT > TO_DATE (@[evnt_dt], 'YYYYMMDDHH24MISS')
             THEN TO_CHAR(DMG_UNFLG_DT, 'YYYYMMDDHH24MI')
         ELSE ''
       END AS NEXT_EVNT_DT,
	#end
	CNTR_DMG_FLG,
	   TO_CHAR (DMG_FLG_DT, 'YYYYMMDDHH24MI') AS DMG_FLG_DT,
	   TO_CHAR (DMG_UNFLG_DT, 'YYYYMMDDHH24MI') AS DMG_UNFLG_DT,
	CASE WHEN CNTR_DMG_FLG = 'Y' AND DMG_FLG_DT < TO_DATE (@[evnt_dt], 'YYYYMMDDHH24MISS') THEN 1
        WHEN CNTR_DMG_FLG = 'Y' AND DMG_FLG_DT >= TO_DATE (@[evnt_dt], 'YYYYMMDDHH24MISS') THEN 0
        WHEN CNTR_DMG_FLG = 'N' THEN 2
    END DMG
FROM CTM_MOVEMENT
WHERE 1=1
AND CNTR_NO = @[cntr_no]
AND CNMV_YR||TO_CHAR(CNMV_SEQ,'0000')||CNMV_SPLIT_NO >= (SELECT MAX(CNMV_YR||TO_CHAR(CNMV_SEQ,'0000')||CNMV_SPLIT_NO)
        FROM CTM_MOVEMENT
        WHERE 1=1
        AND CNTR_NO = @[cntr_no]
        AND ORG_YD_CD = @[evnt_yard]
        AND CNMV_EVNT_DT <= TO_DATE (@[evnt_dt], 'YYYYMMDDHH24MISS')
        AND NVL(MVMT_CRE_TP_CD, 'Z') != 'C')
#if (${last_flg} == 'N')
AND CNMV_EVNT_DT <= (SELECT MAX(CNMV_EVNT_DT)
                    FROM CTM_MOVEMENT
                    WHERE 1=1
                    AND CNTR_NO = @[cntr_no]
                    AND CNMV_EVNT_DT > TO_DATE (@[evnt_dt], 'YYYYMMDDHH24MISS')
					#if (${cntr_dmg_flg} == 'N')
                    AND NVL(DMG_FLG_DT, CNMV_EVNT_DT) <= TO_DATE (@[evnt_dt], 'YYYYMMDDHH24MISS'))
					#else
					AND CNTR_DMG_FLG = 'N'
                    AND ROWNUM=1)
					#end
#end
ORDER BY CNMV_YR, CNMV_SEQ, CNMV_SPLIT_NO			]]></sql>
			<params>
				<param name="cntr_no" type="12" value="" out="N"/>
				<param name="evnt_dt" type="12" value="" out="N"/>
				<param name="evnt_yard" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
