<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CodSimulateDBDAOSearchRepoPlanPreInfoRSQL">
			<desc><![CDATA[CodSimulateDBDAOSearchRepoPlanPreInfoRSQL]]></desc>
			<sql><![CDATA[
SELECT
     PLN_YRWK,
     PAST_REPO_PLN_FLG,
     LAND_CD,
     VVD,
     FM_ECC_CD_TMP,
     FM_ETD_DT,
     FM_YARD,
     TO_ECC_CD_TMP,
     TO_ETB_DT,
     TO_YARD,
     SUM(QTY) AS TOTAL,
#foreach (${key} in ${arrtpszcd})
     MAX(DECODE(TP, '$key', QTY, 0)) AS ${key},
#end
     @[repo_pln_id] AS REPO_PLN_ID,
     SUBSTR(VVD, 0, 4) AS VSL_CD,
     SUBSTR(VVD, 5, 4) AS SKD_VOY_NO,
     SUBSTR(VVD, 9, 1) AS SKD_DIR_CD,
     FM_ECC_CD_TMP AS FM_ECC_CD,
     TO_ECC_CD_TMP AS TO_ECC_CD,
     FM_ECC_CD_TMP AS FM_ECC_CD_TMP1,
     FM_ETD_DT AS FM_ETD_DT1,
     TO_ECC_CD_TMP AS TO_ECC_CD_TMP1,
     TO_ETB_DT AS TO_ETB_DT1,
     'N' AS FM_ECC_CD_FLG,
     'N' AS TO_ECC_CD_FLG,
#foreach (${key} in ${arrtpszcd})
     DECODE(MAX(DECODE(TP, '$key', QTY, 0)), 0, 'N', 'Y') AS ${key}_FLAG,
#end
#foreach (${key} in ${arrtpszcd})
     LAND_CD||VVD||FM_ECC_CD_TMP||'$key'||DECODE(PAST_REPO_PLN_FLG , 'Y' , '1','0') AS SUM_CNTP_CODE${key},
#end
     '' AS PRE_PLN_TS_FLG,
     '0' AS PLN_SEQ,
     '0' AS PLN_SEQ1

FROM (
    SELECT /*+ NO_QUERY_TRANSFORMATION */
      (SELECT PLN_YR||PLN_WK
         FROM EQR_WK_PRD
        WHERE TO_CHAR(VL.ETB, 'YYYYMMDD') BETWEEN WK_ST_DT AND WK_END_DT) AS PLN_YRWK,
      '1' PAST_REPO_PLN_FLG,
      VL.LANE AS LAND_CD,
      VL.VSL||VL.VOY||VL.DIR AS VVD,
      VL.FM_ECC_CD AS FM_ECC_CD_TMP ,
      VL.ETD AS FM_ETD_DT,
      VL.FM_YD_CD AS FM_YARD,
      VL.TPSZ AS TP,
      VL.TO_ECC_CD AS TO_ECC_CD_TMP,
      VL.ETB AS TO_ETB_DT,
      VL.TO_YD_CD AS TO_YARD,
      VL.QTY
    FROM (
        SELECT AA.FM_ECC_CD FM_ECC_CD,
          AA.FM_YD_CD FM_YD_CD,
          AA.VSL_LANE_CD LANE,
          AA.VSL_CD VSL,
          AA.SKD_VOY_NO VOY,
          AA.SKD_DIR_CD DIR,
          AA.CNTR_TPSZ_CD TPSZ,
          MAX(BB.VPS_ETD_DT) ETD,
          SUBSTR(AA.PLN_YRWK, 1, 6) PLN_YRWK,
          AA.TO_ECC_CD,
          AA.TO_YD_CD TO_YD_CD,
          MAX(DECODE(CC.VPS_ETB_DT, null, to_date(substr(AA.PLN_YRWK, 7, 8), 'yyyymmdd'), CC.VPS_ETB_DT)) ETB,
          TO_NUMBER(SUBSTR(AA.PLN_YRWK, 15)) QTY
        FROM (
            SELECT FM_ECC_CD,
              FM_YD_CD,
              VSL_LANE_CD ,
              VSL_CD,
              SKD_VOY_NO,
              SKD_DIR_CD,
              CNTR_TPSZ_CD,
              TO_ECC_CD,
              TO_YD_CD,
              MAX(PLN_YRWK||to_char(VPS_ETB_DT, 'yyyymmdd')||TO_CHAR(CNTR_QTY)) PLN_YRWK
            FROM (
                SELECT B.VPS_PORT_CD FM_ECC_CD,
                  A.FM_YD_CD,
                  A.VSL_LANE_CD ,
                  A.VSL_CD,
                  A.SKD_VOY_NO,
                  A.SKD_DIR_CD,
                  A.CNTR_TPSZ_CD,
                  B.VPS_ETD_DT,
                  A.PLN_YRWK,
                  A.TO_ECC_CD,
                  A.TO_YD_CD,
                  DECODE(C.VPS_ETB_DT, NULL , DECODE(C.VPS_ETA_DT, NULL, C.VPS_ETD_DT, C.VPS_ETA_DT), C.VPS_ETB_DT) VPS_ETB_DT ,
                  SUM(A.CNTR_QTY) CNTR_QTY
                FROM (
                    SELECT (
                        SELECT ECC_CD
                        FROM MDM_EQ_ORZ_CHT
                        WHERE SCC_CD = SUBSTR(A.FM_YD_CD, 1, 5)) FM_ECC_CD,
                      A.FM_YD_CD,
                      A.VSL_LANE_CD,
                      A.VSL_CD,
                      A.SKD_VOY_NO,
                      A.SKD_DIR_CD,
                      DECODE(B.CNTR_TPSZ_CD, 'A2', 'F2', 'A4', 'F4', 'S2', 'O2', 'S4', 'O4', 'F5', 'F4', B.CNTR_TPSZ_CD) CNTR_TPSZ_CD,
                      A.FM_ETD_DT,
                      A.PLN_YRWK,
                      (
                        SELECT ECC_CD
                        FROM MDM_EQ_ORZ_CHT
                        WHERE SCC_CD = SUBSTR(A.TO_YD_CD, 1, 5)) TO_ECC_CD,
                      A.TO_YD_CD,
                      B.CNTR_QTY
                    FROM EQR_VSL_LODG_DCHG_EXE_PLN A,
                      EQR_VSL_EXE_PLN_QTY B
                    WHERE A.REPO_PLN_ID = B.REPO_PLN_ID
                      AND A.PLN_YRWK = B.PLN_YRWK
                      AND A.PLN_SEQ = B.PLN_SEQ
                      AND A.REF_ID = B.REF_ID
                      AND A.REPO_PLN_ID IN (
                        SELECT 'REPO' || aa || 'W001'
                        FROM (
                            SELECT PLN_YR||PLN_WK aa
                            FROM EQR_WK_PRD
                            WHERE PLN_YR||PLN_WK <= SUBSTR(@[repo_pln_id], 5, 6)
                            ORDER BY PLN_YR||PLN_WK DESC )
                        WHERE ROWNUM < 8)
                      AND A.REPO_MTY_BKG_FLG = 'Y'
                      AND A.SPLIT_REPO_PLN_FLG ='N'
                      AND B.CNTR_QTY > 0
                      AND TO_CHAR(A.FM_ETD_DT, 'YYYYMMDD') >= (
                        SELECT WK_ST_DT
                        FROM EQR_WK_PRD
                        WHERE PLN_YR||PLN_WK = SUBSTR(@[repo_pln_id], 5, 6) ) ) A,
                  VSK_VSL_PORT_SKD B,
                  VSK_VSL_PORT_SKD C
                WHERE A.FM_ECC_CD = B.VPS_PORT_CD
                  AND A.VSL_CD = B.VSL_CD
                  AND A.SKD_VOY_NO = B.SKD_VOY_NO
                  AND A.SKD_DIR_CD = B.SKD_DIR_CD
                  AND A.TO_ECC_CD = C.VPS_PORT_CD
                  AND A.VSL_CD = C.VSL_CD
                  AND A.SKD_VOY_NO = C.SKD_VOY_NO
                  AND A.SKD_DIR_CD = C.SKD_DIR_CD
                GROUP BY B.VPS_PORT_CD, A.FM_YD_CD, A.VSL_LANE_CD , A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.CNTR_TPSZ_CD, B.VPS_ETD_DT, A.PLN_YRWK, A.TO_ECC_CD, A.TO_YD_CD, C.VPS_ETA_DT , C.VPS_ETB_DT , C.VPS_ETD_DT
                UNION ALL
                SELECT DISTINCT FM_ECC_CD,
                  FM_YD_CD,
                  VSL_LANE_CD,
                  VSL_CD,
                  SKD_VOY_NO,
                  SKD_DIR_CD,
                  CNTR_TPSZ_CD,
                  FM_ETD_DT,
                  PLN_YRWK,
                  TO_ECC_CD,
                  TO_YD_CD,
                  MAX(VPS_ETB_DT) OVER(PARTITION BY FM_ECC_CD, VSL_LANE_CD, VSL_CD, SKD_VOY_NO, SKD_DIR_CD, CNTR_TPSZ_CD, FM_ETD_DT, PLN_YRWK, TO_ECC_CD) ,
                  CNTR_QTY
                FROM (
                    SELECT A.FM_ECC_CD,
                      A.FM_YD_CD,
                      A.VSL_LANE_CD,
                      A.VSL_CD,
                      A.SKD_VOY_NO,
                      A.SKD_DIR_CD,
                      A.CNTR_TPSZ_CD,
                      A.FM_ETD_DT,
                      A.PLN_YRWK,
                      A.TO_ECC_CD,
                      A.TO_YD_CD,
                      DECODE(B.VPS_ETB_DT, NULL , DECODE(B.VPS_ETA_DT, NULL, B.VPS_ETD_DT, B.VPS_ETA_DT), B.VPS_ETB_DT) VPS_ETB_DT,
                      SUM(A.CNTR_QTY) CNTR_QTY
                    FROM (
                        SELECT (
                            SELECT ECC_CD
                            FROM MDM_EQ_ORZ_CHT
                            WHERE SCC_CD = SUBSTR(A.FM_YD_CD, 1, 5)) FM_ECC_CD,
                          A.FM_YD_CD,
                          A.VSL_LANE_CD,
                          A.VSL_CD,
                          A.SKD_VOY_NO,
                          A.SKD_DIR_CD,
                          DECODE(B.CNTR_TPSZ_CD, 'A2', 'F2', 'A4', 'F4', 'S2', 'O2', 'S4', 'O4', 'F5', 'F4', CNTR_TPSZ_CD) CNTR_TPSZ_CD,
                          A.FM_ETD_DT,
                          A.PLN_YRWK,
                          (
                            SELECT ECC_CD
                            FROM MDM_EQ_ORZ_CHT
                            WHERE SCC_CD = SUBSTR(A.TO_YD_CD, 1, 5)) TO_ECC_CD,
                          A.TO_YD_CD,
                          B.CNTR_QTY
                        FROM EQR_VSL_LODG_DCHG_EXE_PLN A,
                          EQR_VSL_EXE_PLN_QTY B
                        WHERE A.REPO_PLN_ID= B.REPO_PLN_ID
                          AND A.PLN_YRWK = B.PLN_YRWK
                          AND A.PLN_SEQ = B.PLN_SEQ
                          AND A.REF_ID = B.REF_ID
                          AND A.REPO_PLN_ID IN (
                            SELECT 'REPO' || aa || 'W001'
                            FROM (
                                SELECT PLN_YR||PLN_WK aa
                                FROM EQR_WK_PRD
                                WHERE PLN_YR||PLN_WK <= SUBSTR(@[repo_pln_id], 5, 6)
                                ORDER BY PLN_YR||PLN_WK DESC )
                            WHERE ROWNUM < 8)
                          AND A.REPO_MTY_BKG_FLG = 'Y'
                          AND A.SPLIT_REPO_PLN_FLG ='N'
                          AND B.CNTR_QTY > 0
                          AND TO_CHAR(A.FM_ETD_DT, 'YYYYMMDD') < (
                            SELECT WK_ST_DT
                            FROM EQR_WK_PRD
                            WHERE PLN_YR||PLN_WK = SUBSTR(@[repo_pln_id], 5, 6) ) ) A,
                      VSK_VSL_PORT_SKD B
                    WHERE A.VSL_CD = B.VSL_CD
                      AND A.SKD_VOY_NO = B.SKD_VOY_NO
                      AND A.SKD_DIR_CD = B.SKD_DIR_CD
                      AND A.TO_ECC_CD = B.VPS_PORT_CD
                      AND TO_CHAR(VPS_ETB_DT, 'YYYYMMDD') >= (
                        SELECT WK_ST_DT
                        FROM EQR_WK_PRD
                        WHERE PLN_YR||PLN_WK = SUBSTR(@[repo_pln_id], 5, 6) )
                    GROUP BY A.FM_ECC_CD, A.FM_YD_CD, A.VSL_LANE_CD, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.CNTR_TPSZ_CD, A.FM_ETD_DT, A.PLN_YRWK, A.TO_ECC_CD, A.TO_YD_CD, B.VPS_ETB_DT , B.VPS_ETA_DT , B.VPS_ETD_DT
                    UNION
                    SELECT FM_ECC_CD,
                      FM_YD_CD,
                      VSL_LANE_CD,
                      VSL_CD,
                      SKD_VOY_NO,
                      SKD_DIR_CD,
                      CNTR_TPSZ_CD,
                      FM_ETD_DT,
                      PLN_YRWK,
                      TO_ECC_CD,
                      TO_YD_CD,
                      TO_ETB_DT,
                      SUM(CNTR_QTY) CNTR_QTY
                    FROM (
                        SELECT (
                            SELECT ECC_CD
                            FROM MDM_EQ_ORZ_CHT
                            WHERE SCC_CD = SUBSTR(A.FM_YD_CD, 1, 5)) FM_ECC_CD,
                          A.FM_YD_CD,
                          A.VSL_LANE_CD,
                          A.VSL_CD,
                          A.SKD_VOY_NO,
                          A.SKD_DIR_CD,
                          DECODE(B.CNTR_TPSZ_CD, 'A2', 'F2', 'A4', 'F4', 'S2', 'O2', 'S4', 'O4', 'F5', 'F4', CNTR_TPSZ_CD) CNTR_TPSZ_CD,
                          A.FM_ETD_DT,
                          A.PLN_YRWK,
                          (
                            SELECT ECC_CD
                            FROM MDM_EQ_ORZ_CHT
                            WHERE SCC_CD = SUBSTR(A.TO_YD_CD, 1, 5)) TO_ECC_CD,
                          A.TO_YD_CD,
                          A.TO_ETB_DT,
                          B.CNTR_QTY
                        FROM EQR_VSL_LODG_DCHG_EXE_PLN A,
                          EQR_VSL_EXE_PLN_QTY B
                        WHERE A.REPO_PLN_ID= B.REPO_PLN_ID
                          AND A.PLN_YRWK = B.PLN_YRWK
                          AND A.PLN_SEQ = B.PLN_SEQ
                          AND A.REF_ID = B.REF_ID
                          AND A.REPO_PLN_ID IN (
                            SELECT 'REPO' || aa || 'W001'
                            FROM (
                                SELECT PLN_YR||PLN_WK aa
                                FROM EQR_WK_PRD
                                WHERE PLN_YR||PLN_WK <= SUBSTR(@[repo_pln_id], 5, 6)
                                ORDER BY PLN_YR||PLN_WK DESC )
                            WHERE ROWNUM < 8)
                          AND A.REPO_MTY_BKG_FLG = 'Y'
                          AND A.SPLIT_REPO_PLN_FLG ='N'
                          AND B.CNTR_QTY > 0
                          AND TO_CHAR(A.TO_ETB_DT, 'YYYYMMDD') >= (
                            SELECT WK_ST_DT
                            FROM EQR_WK_PRD
                            WHERE PLN_YR||PLN_WK = SUBSTR(@[repo_pln_id], 5, 6) )
                          AND TO_CHAR(A.FM_ETD_DT, 'YYYYMMDD') < (
                            SELECT WK_ST_DT
                            FROM EQR_WK_PRD
                            WHERE PLN_YR||PLN_WK = SUBSTR(@[repo_pln_id], 5, 6) ) )
                    GROUP BY FM_ECC_CD, FM_YD_CD, VSL_LANE_CD, VSL_CD, SKD_VOY_NO, SKD_DIR_CD, CNTR_TPSZ_CD, FM_ETD_DT, PLN_YRWK, TO_ECC_CD, TO_YD_CD, TO_ETB_DT )
                UNION ALL
                SELECT FM_ECC_CD,
                  FM_YD_CD,
                  VSL_LANE_CD,
                  VSL_CD,
                  SKD_VOY_NO,
                  SKD_DIR_CD,
                  CNTR_TPSZ_CD,
                  FM_ETD_DT,
                  PLN_YRWK,
                  TO_ECC_CD,
                  TO_YD_CD,
                  TO_ETB_DT,
                  SUM(CNTR_QTY) CNTR_QTY
                FROM (
                    SELECT A.FM_ECC_CD,
                      A.FM_YD_CD,
                      A.VSL_LANE_CD,
                      A.VSL_CD,
                      A.SKD_VOY_NO,
                      A.SKD_DIR_CD,
                      DECODE(B.CNTR_TPSZ_CD, 'A2', 'F2', 'A4', 'F4', 'S2', 'O2', 'S4', 'O4', 'F5', 'F4', B.CNTR_TPSZ_CD) CNTR_TPSZ_CD,
                      A.FM_ETD_DT,
                      A.PLN_YRWK,
                      A.TO_ECC_CD,
                      A.TO_YD_CD,
                      A.TO_ETB_DT,
                      B.CNTR_QTY
                    FROM EQR_VSL_LODG_DCHG_PLN A,
                      EQR_VSL_LODG_DCHG_PLN_QTY B
                    WHERE A.REPO_PLN_ID = B.REPO_PLN_ID
                      AND A.PLN_YRWK = B.PLN_YRWK
                      AND A.PLN_SEQ = B.PLN_SEQ
                      AND A.REPO_PLN_ID IN (
                        SELECT 'REPO' || aa || 'W001'
                        FROM (
                            SELECT PLN_YR||PLN_WK aa
                            FROM EQR_WK_PRD
                            WHERE PLN_YR||PLN_WK <= SUBSTR(@[repo_pln_id], 5, 6)
                            ORDER BY PLN_YR||PLN_WK DESC )
                        WHERE ROWNUM < 8)
                      AND CNTR_QTY > 0
                      AND B.COD_SIM_FLG ='Y'
                      AND B.COD_DCHG_PLN_FLG ='Y'
                      AND TO_CHAR(A.TO_ETB_DT, 'YYYYMMDD') >= (
                        SELECT WK_ST_DT
                        FROM EQR_WK_PRD
                        WHERE PLN_YR||PLN_WK = SUBSTR(@[repo_pln_id], 5, 6) ) )
                GROUP BY FM_ECC_CD, FM_YD_CD, VSL_LANE_CD, VSL_CD, SKD_VOY_NO, SKD_DIR_CD, CNTR_TPSZ_CD, FM_ETD_DT, PLN_YRWK, TO_ECC_CD, TO_YD_CD, TO_ETB_DT )
            GROUP BY FM_ECC_CD, FM_YD_CD, VSL_LANE_CD, VSL_CD, SKD_VOY_NO, SKD_DIR_CD, CNTR_TPSZ_CD, TO_ECC_CD, TO_YD_CD ) AA,
          VSK_VSL_PORT_SKD BB,
          VSK_VSL_PORT_SKD CC
        WHERE AA.VSL_CD = BB.VSL_CD
          AND AA.VSL_CD = CC.VSL_CD(+)
          AND AA.SKD_VOY_NO = BB.SKD_VOY_NO
          AND AA.SKD_VOY_NO = CC.SKD_VOY_NO(+)
          AND AA.SKD_DIR_CD = BB.SKD_DIR_CD
          AND AA.SKD_DIR_CD = CC.SKD_DIR_CD(+)
          AND AA.FM_ECC_CD = BB.VPS_PORT_CD
          AND AA.TO_ECC_CD = CC.VPS_PORT_CD(+)
        GROUP BY AA.FM_ECC_CD, AA.FM_YD_CD, AA.VSL_LANE_CD , AA.VSL_CD, AA.SKD_VOY_NO, AA.SKD_DIR_CD, AA.CNTR_TPSZ_CD, SUBSTR(AA.PLN_YRWK, 1, 6), AA.TO_ECC_CD, AA.TO_YD_CD, TO_NUMBER(SUBSTR(AA.PLN_YRWK, 15)) ) VL,
      (
        SELECT VSL_CD,
          SKD_VOY_NO,
          SKD_DIR_CD,
          VPS_PORT_CD,
          MAX(DECODE(VPS_ETB_DT, NULL , DECODE(VPS_ETA_DT , NULL, VPS_ETD_DT , VPS_ETA_DT) , VPS_ETB_DT)) VPS_ETB_DT
        FROM VSK_VSL_PORT_SKD
        GROUP BY VSL_CD, SKD_VOY_NO, SKD_DIR_CD, VPS_PORT_CD ) V
    WHERE VL.VSL = V.VSL_CD
      AND VL.VOY = V.SKD_VOY_NO
      AND VL.DIR = V.SKD_DIR_CD
      AND VL.FM_ECC_CD = V.VPS_PORT_CD )
group by PLN_YRWK, PAST_REPO_PLN_FLG, LAND_CD, VVD, FM_ECC_CD_TMP, FM_ETD_DT, FM_YARD, TO_ECC_CD_TMP, TO_ETB_DT, TO_YARD
ORDER BY 1, 3, 4			]]></sql>
			<params>
				<param name="repo_pln_id" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
