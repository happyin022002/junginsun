<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="DemandNoteSendDBDAOSearchDemandNoteByGroupRSQL">
			<desc><![CDATA[SearchDemandNoteByGroup]]></desc>
			<sql><![CDATA[
SELECT   VVD_CD
        ,LOC
        ,CNTR_TPSZ_CD
        ,FM_MVMT_DT
        ,TO_MVMT_DT
        ,FT_CMNC_DT
        ,FT_END_DT
        ,FM_MVMT_DT_RD
        ,TO_MVMT_DT_RD
        ,FT_CMNC_DT_RD
        ,FT_END_DT_RD
        ,FT_DYS
        ,FX_FT_OVR_DYS
        ,BKG_NO
        ,BL_NO
        ,CNTR_NO
        ,DMDT_CHG_STS_CD
        ,OFC_CD
        ,FM_MVMT_YD_CD
        ,PORT
        ,DMDT_TRF_CD
        ,DECODE(
			(CASE WHEN LENGTH(PAYER_CD) = 8 THEN  
           			CASE WHEN SUBSTR(PAYER_CD, 1, 2) = '00' 
                     	THEN SUBSTR(PAYER_CD, 3) ELSE PAYER_CD END 
           			ELSE PAYER_CD END) , '000000','',
			(CASE WHEN LENGTH(PAYER_CD) = 8 THEN  
           			CASE WHEN SUBSTR(PAYER_CD, 1, 2) = '00' 
                     	THEN SUBSTR(PAYER_CD, 3) ELSE PAYER_CD END 
           		ELSE PAYER_CD END)
			) AS PAYER_CD
        ,PAYER_NM
        ,SHIPPER_CD
        ,SHIPPER_NM
        ,CNEE_CD
        ,CNEE_NM
        ,NTFY_CD
        ,NTFY_NM
        ,AR_ACT_CD
        ,AR_ACT_NM
        ,SVC_PROVDR_CD
        ,SVC_PROVDR_NM
        ,SC_NO
        ,RFA_NO
        ,AR_CURR_CD AS INV_CURR_CD
        ,BIL_AMT AS INV_CHG_AMT
        ,ORG_CHG_AMT AS INV_ORG_AMT
        ,DC_AMT AS INV_DC_AMT
        ,ORG_CURR_CD
        ,ORG_CHG_AMT
        ,EXPT_AMT
        ,DC_AMT
        ,BIL_AMT
        ,AR_XCH_RT AS INV_XCH_RT
        ,SVR_ID
        ,CNTR_CYC_NO
        ,DMDT_CHG_LOC_DIV_CD
        ,CHG_SEQ
        ,DMDT_INV_NO
        ,VSL_CD
        ,SKD_VOY_NO
        ,SKD_DIR_CD
        ,POL_CD
        ,POD_CD
    FROM (SELECT B.VSL_CD
                 || B.SKD_VOY_NO
                 || B.SKD_DIR_CD AS VVD_CD
                ,CASE
                    WHEN C.DMDT_TRF_CD IN ('DMIF', 'DMOF')
                       THEN SUBSTR (C.FM_MVMT_YD_CD
                                   ,1
                                   ,5
                                   )
                    WHEN C.DMDT_TRF_CD IN ('DTIC', 'CTIC')
                       THEN B.DEL_CD
                    ELSE B.POR_CD
                 END AS LOC
                ,B.CNTR_TPSZ_CD
                ,TO_CHAR (C.FM_MVMT_DT
                         ,'YYYYMMDD'
                         ,'NLS_DATE_LANGUAGE = American'
                         ) AS FM_MVMT_DT
                ,TO_CHAR (C.TO_MVMT_DT
                         ,'YYYYMMDD'
                         ,'NLS_DATE_LANGUAGE = American'
                         ) AS TO_MVMT_DT
                ,TO_CHAR (C.FT_CMNC_DT
                         ,'YYYYMMDD'
                         ,'NLS_DATE_LANGUAGE = American'
                         ) AS FT_CMNC_DT
                ,TO_CHAR (C.FT_END_DT
                         ,'YYYYMMDD'
                         ,'NLS_DATE_LANGUAGE = American'
                         ) AS FT_END_DT
                ,TO_CHAR (C.FM_MVMT_DT
                         ,'DDMonYY'
                         ,'NLS_DATE_LANGUAGE = American'
                         ) AS FM_MVMT_DT_RD
                ,TO_CHAR (C.TO_MVMT_DT
                         ,'DDMonYY'
                         ,'NLS_DATE_LANGUAGE = American'
                         ) AS TO_MVMT_DT_RD
                ,TO_CHAR (C.FT_CMNC_DT
                         ,'DDMonYY'
                         ,'NLS_DATE_LANGUAGE = American'
                         ) AS FT_CMNC_DT_RD
                ,TO_CHAR (C.FT_END_DT
                         ,'DDMonYY'
                         ,'NLS_DATE_LANGUAGE = American'
                         ) AS FT_END_DT_RD
                ,C.FT_DYS
                ,C.FX_FT_OVR_DYS
                ,B.BKG_NO
                ,B.BL_NO
                ,C.CNTR_NO
                ,C.DMDT_CHG_STS_CD
                ,C.OFC_CD
                ,C.FM_MVMT_YD_CD
                ,DECODE (SUBSTR (C.DMDT_TRF_CD
                                ,3
                                ,1
                                )
                        ,'O', B.POR_CD
                        ,B.DEL_CD
                        ) AS PORT
                ,C.DMDT_TRF_CD
				,DECODE (C.ACT_CNT_CD,'00', '',C.ACT_CNT_CD)
        		         || TO_CHAR (C.ACT_CUST_SEQ, 'FM000000') AS PAYER_CD
                ,CASE
                    WHEN C.DMDT_TRF_CD = 'DTIC'
                    AND INSTR (NVL (B.POD_CD, '  '), 'US') = 1
                       THEN (SELECT MV.VNDR_LGL_ENG_NM
                               FROM MDM_VENDOR MV
                              WHERE MV.VNDR_SEQ = C.VNDR_SEQ)
                    WHEN C.DMDT_TRF_CD = 'DTOC'
                    AND INSTR (NVL (B.POL_CD, '  '), 'US') = 1
                       THEN (SELECT MV.VNDR_LGL_ENG_NM
                               FROM MDM_VENDOR MV
                              WHERE MV.VNDR_SEQ = C.VNDR_SEQ)
                    WHEN C.DMDT_TRF_CD IN ('DMIF', 'CTIC')
                     OR (    C.DMDT_TRF_CD = 'DTIC'
                         AND INSTR (NVL (B.POD_CD, '  '), 'US') <> 1
                        )
                       THEN (SELECT MC.CUST_LGL_ENG_NM
                               FROM MDM_CUSTOMER MC
                              WHERE MC.CUST_CNT_CD = C.ACT_CNT_CD
                                AND MC.CUST_SEQ = C.ACT_CUST_SEQ)
                    WHEN C.DMDT_TRF_CD IN ('DMOF', 'CTOC')
                     OR (    C.DMDT_TRF_CD = 'DTOC'
                         AND INSTR (NVL (B.POL_CD, '  '), 'US') <> 1
                        )
                       THEN REPLACE (BS.CUST_NM
                                    , CHR (13)
                                      || CHR (10)
                                    ,' '
                                    )
                 END AS PAYER_NM
                , BS.CUST_CNT_CD
                  || TRIM (TO_CHAR (BS.CUST_SEQ, '000000')) SHIPPER_CD
                ,REPLACE (BS.CUST_NM
                         , CHR (13)
                           || CHR (10)
                         ,' '
                         ) SHIPPER_NM
                ,DECODE (BC.CUST_CNT_CD
                         || TRIM (TO_CHAR (BC.CUST_SEQ, '000000'))
                        ,'000000', NULL
                        , BC.CUST_CNT_CD
                          || TRIM (TO_CHAR (BC.CUST_SEQ, '000000'))
                        ) CNEE_CD
                ,REPLACE (BC.CUST_NM
                         , CHR (13)
                           || CHR (10)
                         ,' '
                         ) CNEE_NM
                ,DECODE (BN.CUST_CNT_CD
                         || TRIM (TO_CHAR (BN.CUST_SEQ, '000000'))
                        ,'000000', NULL
                        , BN.CUST_CNT_CD
                          || TRIM (TO_CHAR (BN.CUST_SEQ, '000000'))
                        ) NTFY_CD
                ,NVL (RTRIM (REPLACE (REPLACE (BN.CUST_NM
                                              ,'"'
                                              ,''
                                              )
                                     , CHR (13)
                                       || CHR (10)
                                     ,' '
                                     ))
                     ,'-') NTFY_NM
                , (SELECT I.ACT_CUST_CNT_CD
                          || TRIM (TO_CHAR (ACT_CUST_SEQ, '000000'))
                     FROM INV_AR_MN I
                    WHERE I.BKG_NO = B.BKG_NO
                      AND I.IO_BND_CD = SUBSTR (C.DMDT_TRF_CD
                                               ,3
                                               ,1
                                               )
                      AND AR_IF_NO =
                             (SELECT MAX (AR_IF_NO)
                                FROM INV_AR_MN
                               WHERE BKG_NO = B.BKG_NO
                                 AND IO_BND_CD = SUBSTR (C.DMDT_TRF_CD
                                                        ,3
                                                        ,1
                                                        ))
                      AND ROWNUM = 1) AS AR_ACT_CD
                , (SELECT MC.CUST_LGL_ENG_NM
                     FROM MDM_CUSTOMER MC
                         ,INV_AR_MN I
                    WHERE MC.CUST_CNT_CD = I.ACT_CUST_CNT_CD
                      AND MC.CUST_SEQ = I.ACT_CUST_SEQ
                      AND I.BKG_NO = B.BKG_NO
                      AND I.IO_BND_CD = SUBSTR (C.DMDT_TRF_CD
                                               ,3
                                               ,1
                                               )
                      AND AR_IF_NO =
                             (SELECT MAX (AR_IF_NO)
                                FROM INV_AR_MN
                               WHERE BKG_NO = B.BKG_NO
                                 AND IO_BND_CD = SUBSTR (C.DMDT_TRF_CD
                                                        ,3
                                                        ,1
                                                        ))
                      AND ROWNUM = 1) AS AR_ACT_NM
                ,DECODE (TRIM (TO_CHAR (C.VNDR_SEQ, '000000'))
                        ,'000000', NULL
                        ,TRIM (TO_CHAR (C.VNDR_SEQ, '000000'))
                        ) AS SVC_PROVDR_CD
                , (SELECT MV.VNDR_LGL_ENG_NM
                     FROM MDM_VENDOR MV
                    WHERE MV.VNDR_SEQ = C.VNDR_SEQ) AS SVC_PROVDR_NM
                ,B.SC_NO
                ,B.RFA_NO
                ,C.BZC_TRF_CURR_CD AS ORG_CURR_CD
                ,C.ORG_CHG_AMT AS ORG_CHG_AMT
                ,C.SC_RFA_EXPT_AMT AS EXPT_AMT
                ,C.AFT_EXPT_DC_AMT AS DC_AMT
                ,C.BIL_AMT
                ,C.SYS_AREA_GRP_ID AS SVR_ID
                ,C.CNTR_CYC_NO
                ,C.DMDT_CHG_LOC_DIV_CD
                ,C.CHG_SEQ
                ,CASE WHEN (SELECT AR_OFC_CD FROM MDM_ORGANIZATION WHERE OFC_CD = @[ofc_cd]) IN ('SGNBB', 'SAOBB', 'MTRBS', 'TORBB', 'VANBS', 'MEXBA') THEN 'USD'
          			  ELSE (SELECT AR_CURR_CD FROM MDM_ORGANIZATION WHERE OFC_CD = @[ofc_cd])
          			   END  AS AR_CURR_CD
                ,1 AS AR_XCH_RT
                ,C.BZC_TRF_CURR_CD
                ,C.DMDT_INV_NO
                ,B.VSL_CD
                ,B.SKD_VOY_NO
                ,B.SKD_DIR_CD
                ,B.POL_CD
                ,B.POD_CD
            FROM DMT_CHG_BKG_CNTR B
                ,DMT_CHG_CALC C
                ,BKG_CUSTOMER BS
                ,BKG_CUSTOMER BC
                ,BKG_CUSTOMER BN
           WHERE B.SYS_AREA_GRP_ID = C.SYS_AREA_GRP_ID
             AND B.CNTR_NO = C.CNTR_NO
             AND B.CNTR_CYC_NO = C.CNTR_CYC_NO
             AND B.BKG_NO = BS.BKG_NO(+)
             AND BS.BKG_CUST_TP_CD(+) = 'S'
             AND B.BKG_NO = BC.BKG_NO(+)
             AND BC.BKG_CUST_TP_CD(+) = 'C'
             AND B.BKG_NO = BN.BKG_NO(+)
             AND BN.BKG_CUST_TP_CD(+) = 'N'
             AND C.OFC_CD = @[s_ofc_cd]
             AND C.DMDT_TRF_CD = @[s_dmdt_trf_cd]
#if (${dmdt_chg_sts_cds} != '') 
   			AND C.DMDT_CHG_STS_CD IN (
        		#foreach( $chg_sts_cd in ${chg_sts_cd_list} )
            		#if($velocityCount < $chg_sts_cd_list.size()) '$chg_sts_cd', #else '$chg_sts_cd' #end
        		#end
        		) 
#end 

#if (${s_bkg_no} != '')	
   			AND B.BKG_NO IN (
					#foreach( $bkg_cd in ${bkg_no_list} )
						#if($velocityCount < $bkg_no_list.size()) '$bkg_cd', #else '$bkg_cd' #end
					#end
					)
#end
) X
ORDER BY X.BKG_NO
        ,X.CNTR_NO			]]></sql>
			<params>
				<param name="ofc_cd" type="12" value="" out="N"/>
				<param name="s_ofc_cd" type="12" value="" out="N"/>
				<param name="s_dmdt_trf_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
