<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="PerformanceReportDBDAOsearchPMFCByAgreementTariffDataRSQL">
			<desc><![CDATA[조회 - [EES_MNR_0236] MNR PFMC by Agreement/Tariff]]></desc>
			<sql><![CDATA[
SELECT A.TRF_NO
	     , B.COST_GRP_CD
	     , (SELECT MNR_CD_DP_DESC FROM MNR_GEN_CD WHERE PRNT_CD_ID = 'CC' AND MNR_CD_ID = B.COST_GRP_CD) AS COST_GRP_NM
	     , B.EQ_CMPO_CD
	     , B.EQ_RPR_CD
	     , B.TRF_DIV_CD
	     , C.AR_HD_QTR_OFC_CD
	     , A.RQST_OFC_CD
	     , MNR_COMMON_PKG.MNR_CONV_PARTNER_CD_FNC(A.VNDR_SEQ) AS VNDR_SEQ
	     , (SELECT VNDR_LGL_ENG_NM FROM MDM_VENDOR WHERE VNDR_SEQ = A.VNDR_SEQ) AS VNDR_NM
	     , B.RPR_LBR_HRS
	     , DECODE(@[curr_cd], 'Y', 'USD', A.CURR_CD) CURR_CD
	     , B.MTRL_RECO_AMT
         , MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(TO_CHAR(SYSDATE, 'YYYYMM'), A.CURR_CD, DECODE(@[curr_cd], 'Y', 'USD', A.CURR_CD), B.MTRL_COST_AMT) MTRL_COST_AMT
	     , A.MNR_TRF_STS_CD
	     , (SELECT MNR_CD_DP_DESC FROM MNR_GEN_CD WHERE PRNT_CD_ID = 'CD00007' AND MNR_CD_ID = A.MNR_TRF_STS_CD) AS MNR_TRF_STS_NM
	     , MNR_COMMON_PKG.MNR_CONV_AGMT_NO_FNC(D.AGMT_OFC_CTY_CD, D.AGMT_SEQ) AS AGMT_NO
         , DECODE(@[curr_cd], 'Y', 'USD', D.CURR_CD) AGMT_CURR_CD
	     , MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(TO_CHAR(SYSDATE, 'YYYYMM'), D.CURR_CD, DECODE(@[curr_cd], 'Y', 'USD', D.CURR_CD), E.AGMT_RT_AMT) AGMT_RT_AMT    
	 FROM MNR_RPR_TRF_HDR A
	     , MNR_RPR_TRF_DTL B
	     , MDM_ORGANIZATION C
	     , (SELECT    TRF_NO
	             	, MAX(AGMT_OFC_CTY_CD) AGMT_OFC_CTY_CD
					, MAX(AGMT_SEQ) AGMT_SEQ 
					, MAX(AGMT_VER_NO) AGMT_VER_NO
					, MAX(CURR_CD) CURR_CD
	         FROM MNR_AGMT_HDR 
	        WHERE AGMT_LST_VER_FLG = 'Y'
	          AND SYSDATE BETWEEN EFF_DT AND EXP_DT
	        GROUP BY TRF_NO
	        )D
         , (SELECT AGMT_OFC_CTY_CD
                 , AGMT_SEQ
                 , AGMT_VER_NO
                 , AGMT_RT_AMT
              FROM MNR_AGMT_RT
             WHERE MNR_RT_TP_CD = 'NR'
               AND COST_DTL_CD = 'NR'
               AND SUBSTR(COST_CD,0,4) = @[cost_grp_cd]
            )E      
	 WHERE A.TRF_NO           = B.TRF_NO
	   AND A.RQST_OFC_CD      = C.OFC_CD
	   AND A.TRF_NO           = D.TRF_NO(+)
       AND D.AGMT_OFC_CTY_CD  = E.AGMT_OFC_CTY_CD
       AND D.AGMT_SEQ         = E.AGMT_SEQ
       AND D.AGMT_VER_NO      = E.AGMT_VER_NO
       AND A.MNR_TRF_KND_CD = 'LCL'
       AND B.COST_GRP_CD      = @[cost_grp_cd]
       AND C.AR_HD_QTR_OFC_CD = @[ar_hd_qtr_ofc_cd]
	   #if (${rqst_ofc_cd} != 'A') 
       AND A.RQST_OFC_CD = @[rqst_ofc_cd]
       #end
       #if (${vndr_seq} != '') 
       AND A.VNDR_SEQ = @[vndr_seq]
       #end
       #if (${eq_cmpo_cd} != '' && ${eq_cmpo_cd} != 'A') 
       AND B.EQ_CMPO_CD = @[eq_cmpo_cd]
       #end
       #if (${eq_rpr_cd} != '' && ${eq_rpr_cd} != 'A') 
       AND B.EQ_RPR_CD = @[eq_rpr_cd]
       #end
       #if (${trf_div_cd} != '' && ${trf_div_cd} != 'A') 
       AND B.TRF_DIV_CD = @[trf_div_cd]
       #end
       #if (${mnr_trf_sts_cd} != '' && ${mnr_trf_sts_cd} != 'A') 
       AND A.MNR_TRF_STS_CD = @[mnr_trf_sts_cd]
       #else
       AND A.MNR_TRF_STS_CD IN ('HE','HA')
       #end
     ORDER BY A.TRF_NO DESC			]]></sql>
			<params>
				<param name="curr_cd" type="12" value="" out="N"/>
				<param name="cost_grp_cd" type="12" value="" out="N"/>
				<param name="ar_hd_qtr_ofc_cd" type="12" value="" out="N"/>
				<param name="rqst_ofc_cd" type="12" value="" out="N"/>
				<param name="vndr_seq" type="12" value="" out="N"/>
				<param name="eq_cmpo_cd" type="12" value="" out="N"/>
				<param name="eq_rpr_cd" type="12" value="" out="N"/>
				<param name="trf_div_cd" type="12" value="" out="N"/>
				<param name="mnr_trf_sts_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
