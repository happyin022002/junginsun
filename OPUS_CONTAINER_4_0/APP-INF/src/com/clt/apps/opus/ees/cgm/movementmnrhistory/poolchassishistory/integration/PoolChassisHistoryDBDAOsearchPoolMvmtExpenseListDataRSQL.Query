<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="PoolChassisHistoryDBDAOsearchPoolMvmtExpenseListDataRSQL">
			<desc><![CDATA[   ]]></desc>
			<sql><![CDATA[
SELECT AAA.CHSS_POOL_CD ,
  AAA.MVMT_DT ,
  AAA.CHSS_POOL_NM ,
  AAA.EST_AMOUNT ,
  AAA.INV_AMOUNT ,
  CASE
    WHEN AAA.EST_AMOUNT- AAA.INV_AMOUNT >=0 THEN (AAA.EST_AMOUNT- AAA.INV_AMOUNT)
    ELSE 0
  END AS CREDIT ,
  CASE
    WHEN AAA.INV_AMOUNT- AAA.EST_AMOUNT >=0 THEN (AAA.INV_AMOUNT- AAA.EST_AMOUNT)
    ELSE 0
      END AS DEBIT      
      FROM (
    SELECT AA.CHSS_POOL_CD ,
      AA.MVMT_DT ,
      AA.CHSS_POOL_NM ,
      AA.INV_AMOUNT ,
      AA.OWN_CHSS_USD_DYS ,
      AA.RATE ,
      AA.OWN_CHSS_USD_DYS * AA.RATE EST_AMOUNT
    FROM (
        SELECT MAX(CHK) ,
          INV.CHSS_POOL_CD ,
          INV.MVMT_DT ,
          B.CHSS_POOL_NM ,
          NVL( MAX(INV.OWN_CHSS_USD_DYS ),0) OWN_CHSS_USD_DYS ,
          NVL( MAX(INV.INV_AMT),0) INV_AMOUNT ,
          NVL( MAX(RATE),0) RATE
        FROM (
                        SELECT '2' CHK ,
                        B.CHSS_POOL_CD AS CHSS_POOL_CD ,
                        A.COST_YRMON AS MVMT_DT ,
                        SUM(A.POOL_CHSS_USD_DYS) AS OWN_CHSS_USD_DYS,
              NULL INV_AMT,
              NULL RATE
            FROM CGM_POOL_CHSS_USD_DYS_SMRY A ,
              CGM_CHSS_POOL_LOC_MTCH B
                        WHERE 1=1
                        AND SUBSTR(A.ONH_YD_CD, 1, 5) = B.OWN_POOL_LOC_CD
                        AND A.COST_YRMON BETWEEN TO_CHAR(TO_DATE(REPLACE(@[mvmt_dt_fr],'-',''),'YYYYMM' ),'YYYYMM') 
                                             AND TO_CHAR(TO_DATE(REPLACE(@[mvmt_dt_to],'-',''),'YYYYMM' ),'YYYYMM')
                        AND B.CHSS_POOL_CD IN (${chss_pool_cd})
                        
                        GROUP BY b.CHSS_POOL_CD, A.COST_YRMON
                        
                        UNION 
                        
            SELECT '1' CHK ,
              A.CHSS_POOL_CD AS CHSS_POOL_CD ,
              A.COST_YRMON AS MVMT_DT ,
              NULL OWN_CHSS_USD_DYS ,
              SUM(A.CHG_SMRY_AMT) ,
              MAX(B.RATE)
            FROM CGM_PAY_INV A,
              (
                SELECT CHSS_POOL_CD,
                  COST_YRMON,
                  MAX(RATE) RATE
                                             FROM (
                                                SELECT A.PAY_INV_SEQ ,
                                                A.CHSS_POOL_CD ,
                                                COST_YRMON ,
                                                SUM(B.POOL_BSRT_AMT) RATE
                        FROM CGM_PAY_INV A ,
                             CGM_PAY_INV_POOL_DTL B
                                                WHERE A.CHSS_POOL_CD IN (${chss_pool_cd})
                                                AND A.COST_YRMON >= TO_CHAR(TO_DATE(@[mvmt_dt_fr],'YYYY-MM' ),'YYYYMM')
                                                AND A.COST_YRMON <= TO_CHAR(TO_DATE(@[mvmt_dt_to],'YYYY-MM' ),'YYYYMM')
                                                AND A.PAY_INV_SEQ = B.PAY_INV_SEQ 
                                                GROUP BY A.PAY_INV_SEQ,A.CHSS_POOL_CD, A.COST_YRMON )
                                              GROUP BY CHSS_POOL_CD,COST_YRMON )  B
                        WHERE  1=1
                          AND A.CHSS_POOL_CD IN (${chss_pool_cd})
                         AND A.COST_YRMON >= TO_CHAR(TO_DATE(@[mvmt_dt_fr],'YYYY-MM' ),'YYYYMM')
                        AND A.COST_YRMON <= TO_CHAR(TO_DATE(@[mvmt_dt_to],'YYYY-MM' ),'YYYYMM')
                        AND A.CHSS_POOL_CD = B.CHSS_POOL_CD
                        AND A.COST_YRMON  = B.COST_YRMON 
                        GROUP BY A.CHSS_POOL_CD,A.COST_YRMON ) INV ,
             	 CGM_CHSS_POOL B
                 WHERE INV.CHSS_POOL_CD = B.CHSS_POOL_CD
                GROUP BY INV.MVMT_DT,INV.CHSS_POOL_CD,B.CHSS_POOL_NM
                ORDER BY INV.MVMT_DT

              ) AA

  ) AAA			]]></sql>
			<params>
				<param name="mvmt_dt_fr" type="12" value="" out="N"/>
				<param name="mvmt_dt_to" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
