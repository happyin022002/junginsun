<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="MTYEquipmentForecastDBDAOsearchMtyBalanceListRSQL">
			<desc><![CDATA[지점별로 향후 2~3 weeks의 예상 MTY 장비 Supply & Demand를 항목별로 입력/수정/ 조회하며, MTY Balance를 예상하는 화면]]></desc>
			<sql><![CDATA[
WITH LV_DUMMY_ITEM AS
(
    SELECT LEVEL TP_CD, @[fcast_yrwk] FCAST_YRWK0, @[loc_cd] LOC_CD, 
           (SELECT /*+ INDEX_DESC(A XPKEQR_WK_PRD) */ PLN_YR||PLN_WK
            FROM EQR_WK_PRD A
            WHERE PLN_YR||PLN_WK < @[fcast_yrwk]
            AND   ROWNUM = 1) INP_YRWK
    FROM DUAL
    CONNECT BY LEVEL < =4
)
, LV_DUMMY_WEEK AS
(
    SELECT /*+ INDEX(A XPKEQR_WK_PRD) */ ROWNUM WK_SEQ,PLN_YR||PLN_WK AS FCAST_YRWK
    FROM EQR_WK_PRD A
    WHERE PLN_YR||PLN_WK >= @[fcast_yrwk]
    AND   ROWNUM <=3
)
, LV_DUMMY_FNL AS
(
    SELECT A.TP_CD,A.FCAST_YRWK0, B.FCAST_YRWK,A.LOC_CD,A.INP_YRWK
    FROM LV_DUMMY_ITEM A,LV_DUMMY_WEEK B
)
,LV_YD_LIST AS
(
	SELECT C.YD_CD, A.SCC_CD
	FROM MDM_EQ_ORZ_CHT A,MDM_LOCATION B,MDM_YARD C
	WHERE A.ECC_CD = @[loc_cd]
	AND   A.SCC_CD = B.SCC_CD
	AND   B.LOC_CD = C.LOC_CD
)

SELECT 
    DP_SEQ
    ,TITLE
    ,ITEM
    ,FCAST_YRWK0
    ,TP_CD

    ,D2_FCAST_QTY+D4_FCAST_QTY+D5_FCAST_QTY+D7_FCAST_QTY+R2_FCAST_QTY+R5_FCAST_QTY+O2_FCAST_QTY+S2_FCAST_QTY+O4_FCAST_QTY+S4_FCAST_QTY+F2_FCAST_QTY+A2_FCAST_QTY+F4_FCAST_QTY+A4_FCAST_QTY+F5_FCAST_QTY   G_TOTAL
    ,D2_FCAST_QTY+D4_FCAST_QTY+D5_FCAST_QTY+D7_FCAST_QTY   D_TOTAL
    ,D2_FCAST_QTY D2_FCAST_QTY
    ,D4_FCAST_QTY D4_FCAST_QTY
    ,D5_FCAST_QTY D5_FCAST_QTY
    ,D7_FCAST_QTY D7_FCAST_QTY
    ,R2_FCAST_QTY+R5_FCAST_QTY+O2_FCAST_QTY+S2_FCAST_QTY+O4_FCAST_QTY+S4_FCAST_QTY+F2_FCAST_QTY+A2_FCAST_QTY+F4_FCAST_QTY+A4_FCAST_QTY+F5_FCAST_QTY S_TOTAL
    
    ,R2_FCAST_QTY R2_FCAST_QTY   
    ,R5_FCAST_QTY R5_FCAST_QTY 
    ,O2_FCAST_QTY O2_FCAST_QTY
    ,S2_FCAST_QTY S2_FCAST_QTY 
    ,O4_FCAST_QTY O4_FCAST_QTY 
    ,S4_FCAST_QTY S4_FCAST_QTY  
    ,F2_FCAST_QTY F2_FCAST_QTY 
    ,A2_FCAST_QTY A2_FCAST_QTY 
    ,F4_FCAST_QTY F4_FCAST_QTY 
    ,A4_FCAST_QTY A4_FCAST_QTY 
    ,F5_FCAST_QTY F5_FCAST_QTY
  	,(SELECT /*+ INDEX_DESC(A XPKEQR_WK_PRD) */ PLN_YR||PLN_WK
      FROM EQR_WK_PRD A
      WHERE PLN_YR||PLN_WK < @[fcast_yrwk]
      AND   ROWNUM = 1) INP_YRWK
	,(SELECT @[loc_cd] LOC_CD FROM DUAL P) LOC_CD     
FROM
(
    SELECT 
        A.DP_SEQ
        ,A.TITLE
        ,A.ITEM
        ,'' IMAGE_BUTTON
        ,A.FCAST_YRWK0
        ,A.TP_CD
        
        , A.D2_FCAST_QTY
        , A.D4_FCAST_QTY
        , A.D5_FCAST_QTY
        , A.D7_FCAST_QTY
        , A.R2_FCAST_QTY
        , A.R5_FCAST_QTY
        , A.O2_FCAST_QTY
        , A.S2_FCAST_QTY
        , A.O4_FCAST_QTY
        , A.S4_FCAST_QTY
        , A.F2_FCAST_QTY
        , A.A2_FCAST_QTY
        , A.F4_FCAST_QTY
        , A.A4_FCAST_QTY
        , A.F5_FCAST_QTY
    FROM
        (
        SELECT B.TP_CD DP_SEQ
               ,DECODE(B.TP_CD, 1,'Sound MT','Damage MT') TITLE
               ,DECODE(B.TP_CD, 1,'Sound MT','Damage MT') ITEM
               ,B.FCAST_YRWK0
               ,B.TP_CD
               ,NVL(D2_FCAST_QTY,0) D2_FCAST_QTY
               ,NVL(D4_FCAST_QTY,0) D4_FCAST_QTY
               ,NVL(D5_FCAST_QTY,0) D5_FCAST_QTY
               ,NVL(D7_FCAST_QTY,0) D7_FCAST_QTY
               ,NVL(R2_FCAST_QTY,0) R2_FCAST_QTY
               ,NVL(R5_FCAST_QTY,0) R5_FCAST_QTY
               ,NVL(O2_FCAST_QTY,0) O2_FCAST_QTY
               ,NVL(S2_FCAST_QTY,0) S2_FCAST_QTY
               ,NVL(O4_FCAST_QTY,0) O4_FCAST_QTY
               ,NVL(S4_FCAST_QTY,0) S4_FCAST_QTY
               ,NVL(F2_FCAST_QTY,0) F2_FCAST_QTY
               ,NVL(A2_FCAST_QTY,0) A2_FCAST_QTY
               ,NVL(F4_FCAST_QTY,0) F4_FCAST_QTY
               ,NVL(A4_FCAST_QTY,0) A4_FCAST_QTY
               ,NVL(F5_FCAST_QTY,0) F5_FCAST_QTY
               
        FROM 
            (SELECT  A.DMG_FLG
                     ,SUM(DECODE(A.CNTR_TPSZ_CD,'D2',CNTR_QTY,0)) D2_FCAST_QTY
                     ,SUM(DECODE(A.CNTR_TPSZ_CD,'D4',CNTR_QTY,0)) D4_FCAST_QTY
                     ,SUM(DECODE(A.CNTR_TPSZ_CD,'D5',CNTR_QTY,0)) D5_FCAST_QTY
                     ,SUM(DECODE(A.CNTR_TPSZ_CD,'D7',CNTR_QTY,0)) D7_FCAST_QTY
                     ,SUM(DECODE(A.CNTR_TPSZ_CD,'R2',CNTR_QTY,0)) R2_FCAST_QTY
                     ,SUM(DECODE(A.CNTR_TPSZ_CD,'R5',CNTR_QTY,0)) R5_FCAST_QTY
                     ,SUM(DECODE(A.CNTR_TPSZ_CD,'O2',CNTR_QTY,0)) O2_FCAST_QTY
                     ,SUM(DECODE(A.CNTR_TPSZ_CD,'S2',CNTR_QTY,0)) S2_FCAST_QTY
                     ,SUM(DECODE(A.CNTR_TPSZ_CD,'O4',CNTR_QTY,0)) O4_FCAST_QTY
                     ,SUM(DECODE(A.CNTR_TPSZ_CD,'S4',CNTR_QTY,0)) S4_FCAST_QTY
                     ,SUM(DECODE(A.CNTR_TPSZ_CD,'F2',CNTR_QTY,0)) F2_FCAST_QTY
                     ,SUM(DECODE(A.CNTR_TPSZ_CD,'A2',CNTR_QTY,0)) A2_FCAST_QTY
                     ,SUM(DECODE(A.CNTR_TPSZ_CD,'F4',CNTR_QTY,0)) F4_FCAST_QTY
                     ,SUM(DECODE(A.CNTR_TPSZ_CD,'A4',CNTR_QTY,0)) A4_FCAST_QTY
                     ,SUM(DECODE(A.CNTR_TPSZ_CD,'F5',CNTR_QTY,0)) F5_FCAST_QTY 
            FROM  CIM_ETC_INVT A
            WHERE A.CO_CD (+)='O'
            AND   A.INVT_USE_TP_CD(+) = '1'
            AND   A.BSE_DT (+)= @[fcast_yrwk]
            AND   A.LOC_CD(+) = @[loc_cd]
            GROUP BY A.DMG_FLG), LV_DUMMY_ITEM  B
        WHERE DECODE(DMG_FLG(+),'Y',2,1) = B.TP_CD
        AND   B.TP_CD IN(1,2)
        UNION ALL
        SELECT   DECODE(A.DP_SEQ,1,3,2,4,3,8,4,9,5,16,7,20,9,27,11,31) DP_SEQ,
    
                 DECODE(A.DP_SEQ,1,'Supply',2,'Supply',3,'Demand',4,'Demand',
                                 5,'Supply',7,'Demand', 9,'Supply',11,'Demand') TITLE,
        
                 DECODE(A.DP_SEQ,1,'I/B FCST',2,'I/B Remaining (F~S)',3,'O/B FCST',4,'O/B Remaining (F~S)',
                                 5,'I/B FCST',7,'O/B FCST', 9,'I/B FCST',11,'O/B FCST') ITEM
                 ,A.FCAST_YRWK
                 ,A.TP_CD
                 ,A.D2_FCAST_QTY
                 ,A.D4_FCAST_QTY
                 ,A.D5_FCAST_QTY
                 ,A.D7_FCAST_QTY
                 ,A.R2_FCAST_QTY
                 ,A.R5_FCAST_QTY
                 ,A.O2_FCAST_QTY
                 ,A.S2_FCAST_QTY
                 ,A.O4_FCAST_QTY
                 ,A.S4_FCAST_QTY
                 ,A.F2_FCAST_QTY
                 ,A.A2_FCAST_QTY
                 ,A.F4_FCAST_QTY
                 ,A.A4_FCAST_QTY
                 ,A.F5_FCAST_QTY                 
        FROM
            (SELECT 
                 ROW_NUMBER() OVER (ORDER BY B.FCAST_YRWK,B.TP_CD) DP_SEQ,
                 B.FCAST_YRWK0,1,
                 B.FCAST_YRWK,
                 B.TP_CD
                 ,NVL(A.D2_FCAST_QTY,0) D2_FCAST_QTY
                 ,NVL(A.D4_FCAST_QTY,0) D4_FCAST_QTY
                 ,NVL(A.D5_FCAST_QTY,0) D5_FCAST_QTY
                 ,NVL(A.D7_FCAST_QTY,0) D7_FCAST_QTY
                 ,NVL(A.R2_FCAST_QTY,0) R2_FCAST_QTY
                 ,NVL(A.R5_FCAST_QTY,0) R5_FCAST_QTY
                 ,NVL(A.O2_FCAST_QTY,0) O2_FCAST_QTY
                 ,NVL(A.S2_FCAST_QTY,0) S2_FCAST_QTY
                 ,NVL(A.O4_FCAST_QTY,0) O4_FCAST_QTY
                 ,NVL(A.S4_FCAST_QTY,0) S4_FCAST_QTY
                 ,NVL(A.F2_FCAST_QTY,0) F2_FCAST_QTY
                 ,NVL(A.A2_FCAST_QTY,0) A2_FCAST_QTY
                 ,NVL(A.F4_FCAST_QTY,0) F4_FCAST_QTY
                 ,NVL(A.A4_FCAST_QTY,0) A4_FCAST_QTY
                 ,NVL(A.F5_FCAST_QTY,0) F5_FCAST_QTY
            FROM EQR_MTY_BAL_RPT A , LV_DUMMY_FNL B
            WHERE A.CO_CD(+) = 'O'
            AND   A.LOC_CD(+) = B.LOC_CD
            AND   A.INP_YRWK(+) = B.INP_YRWK
            AND   A.FCAST_YRWK(+) = B.FCAST_YRWK
            AND   A.MTY_BAL_TP_CD(+) = B.TP_CD) A
        WHERE A.FCAST_YRWK0 = A.FCAST_YRWK 
        OR    (A.FCAST_YRWK0 <> A.FCAST_YRWK  AND A.TP_CD IN(1,3))
        UNION ALL
        SELECT DECODE(A.DP_SEQ,1,6,2,7,3,12,4,18,5,19,6,23,7,29,8,30,9,34) DP_SEQ
              ,DECODE(A.TP_CD,1,'Supply',2,'Supply',4,'Demand') TITLE
              ,DECODE(A.TP_CD,1,'OW&On-hire',2,'+ Others',4,'- Others') ITEM
              ,A.FCAST_YRWK,A.TP_CD
              ,A.D2_FCAST_QTY
              ,A.D4_FCAST_QTY
              ,A.D5_FCAST_QTY
              ,A.D7_FCAST_QTY
              ,A.R2_FCAST_QTY
              ,A.R5_FCAST_QTY
              ,A.O2_FCAST_QTY
              ,A.S2_FCAST_QTY
              ,A.O4_FCAST_QTY
              ,A.S4_FCAST_QTY
              ,A.F2_FCAST_QTY
              ,A.A2_FCAST_QTY
              ,A.F4_FCAST_QTY
              ,A.A4_FCAST_QTY
              ,A.F5_FCAST_QTY       
        FROM(
            SELECT   ROW_NUMBER() OVER (ORDER BY B.FCAST_YRWK,B.TP_CD) DP_SEQ
                    ,B.FCAST_YRWK
                    ,B.TP_CD
                    ,NVL(SUM(A.D2_FCAST_QTY),0) D2_FCAST_QTY
                    ,NVL(SUM(A.D4_FCAST_QTY),0) D4_FCAST_QTY
                    ,NVL(SUM(A.D5_FCAST_QTY),0) D5_FCAST_QTY
                    ,NVL(SUM(A.D7_FCAST_QTY),0) D7_FCAST_QTY
                    ,NVL(SUM(A.R2_FCAST_QTY),0) R2_FCAST_QTY
                    ,NVL(SUM(A.R5_FCAST_QTY),0) R5_FCAST_QTY
                    ,NVL(SUM(A.O2_FCAST_QTY),0) O2_FCAST_QTY
                    ,NVL(SUM(A.S2_FCAST_QTY),0) S2_FCAST_QTY
                    ,NVL(SUM(A.O4_FCAST_QTY),0) O4_FCAST_QTY
                    ,NVL(SUM(A.S4_FCAST_QTY),0) S4_FCAST_QTY
                    ,NVL(SUM(A.F2_FCAST_QTY),0) F2_FCAST_QTY
                    ,NVL(SUM(A.A2_FCAST_QTY),0) A2_FCAST_QTY
                    ,NVL(SUM(A.F4_FCAST_QTY),0) F4_FCAST_QTY
                    ,NVL(SUM(A.A4_FCAST_QTY),0) A4_FCAST_QTY
                    ,NVL(SUM(A.F5_FCAST_QTY),0) F5_FCAST_QTY
            FROM  EQR_MTY_BAL_RPT_OTR A , LV_DUMMY_FNL B
            WHERE A.CO_CD(+) = 'O'
            AND   A.LOC_CD(+) = B.LOC_CD
            AND   A.INP_YRWK(+) = B.INP_YRWK
            AND   A.FCAST_YRWK(+) = B.FCAST_YRWK
            AND   A.MTY_BAL_OTR_TP_CD(+) = B.TP_CD
            AND   B.TP_CD IN(1,2,4)
            GROUP BY  B.FCAST_YRWK,B.TP_CD
            ) A
        UNION ALL
        SELECT    DP_SEQ
                 ,'Demand', 'Repo In', A.FCAST_YRWK FCAST_YRWK0, 1
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'D2',CNTR_QTY,0)) D2_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'D4',CNTR_QTY,0)) D4_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'D5',CNTR_QTY,0)) D5_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'D7',CNTR_QTY,0)) D7_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'R2',CNTR_QTY,0)) R2_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'R5',CNTR_QTY,0)) R5_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'O2',CNTR_QTY,0)) O2_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'S2',CNTR_QTY,0)) S2_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'O4',CNTR_QTY,0)) O4_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'S4',CNTR_QTY,0)) S4_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'F2',CNTR_QTY,0)) F2_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'A2',CNTR_QTY,0)) A2_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'F4',CNTR_QTY,0)) F4_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'A4',CNTR_QTY,0)) A4_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'F5',CNTR_QTY,0)) F5_FCAST_QTY
        FROM
            (
              SELECT DECODE(D.SEQ,1,5,2,17,3,28) DP_SEQ
                    ,D.FCAST_YRWK
                    ,A.CNTR_TPSZ_CD, SUM(A.CNTR_QTY) CNTR_QTY
              FROM   LV_YD_LIST Y, EQR_MTY_REPO_LAND_IB_V A, (SELECT /*+ INDEX(A XPKEQR_WK_PRD) */ 
                                                                  ROWNUM AS SEQ,PLN_YR||PLN_WK, WK_ST_DT, WK_END_DT, @[fcast_yrwk] FCAST_YRWK , @[loc_cd] LOC_CD
                                                              FROM EQR_WK_PRD A
                                                              WHERE PLN_YR||PLN_WK >= @[fcast_yrwk]
                                                              AND   PLN_YR >= SUBSTR(@[fcast_yrwk],1,4)
                                                              AND   ROWNUM <=3) D
              WHERE A.TO_ETA_DT BETWEEN TO_DATE(D.WK_ST_DT,'YYYYMMDD') AND TO_DATE(D.WK_END_DT,'YYYYMMDD')+0.99999
              AND   A.TO_YD_CD= Y.YD_CD
              AND   A.CNTR_QTY > 0
              GROUP BY D.SEQ,D.FCAST_YRWK,A.CNTR_TPSZ_CD
              UNION ALL
            SELECT DECODE(D.SEQ,1,5,2,17,3,28) DP_SEQ
                  ,D.FCAST_YRWK
                  ,A.CNTR_TPSZ_CD, SUM(A.CNTR_QTY) CNTR_QTY
            FROM   LV_YD_LIST Y, EQR_MTY_REPO_VSL_IB_V A,  (SELECT /*+ INDEX(A XPKEQR_WK_PRD) */ 
                                                                ROWNUM AS SEQ,PLN_YR||PLN_WK, WK_ST_DT, WK_END_DT, @[fcast_yrwk] FCAST_YRWK ,@[loc_cd] LOC_CD
                                                            FROM EQR_WK_PRD A
                                                            WHERE PLN_YR||PLN_WK >= @[fcast_yrwk]
                                                            AND   PLN_YR >= SUBSTR(@[fcast_yrwk],1,4)
                                                            AND   ROWNUM <=3) D--,LV_REPO_PLN_ID E
            WHERE A.TO_ETA_DT BETWEEN TO_DATE(D.WK_ST_DT,'YYYYMMDD') AND TO_DATE(D.WK_END_DT,'YYYYMMDD')+0.99999
			AND   DECODE(A.TYPE_CD,'P',A.TO_ECC_CD,'1') = DECODE(A.TYPE_CD,'P',@[loc_cd],'1')
            AND   A.TO_YD_CD= Y.YD_CD
            AND   A.CNTR_QTY > 0
            --AND   DECODE(A.TYPE_CD,'1',A.REPO_PLN_ID,'1') >= DECODE(A.TYPE_CD,'1',E.REPO_PLN_ID,'0')
            AND   DECODE(A.TYPE_CD,'P',A.REPO_PLN_ID,'1') = DECODE(A.TYPE_CD,'P',@[repo_pln_id],'1')
            GROUP BY D.SEQ,D.FCAST_YRWK,A.CNTR_TPSZ_CD            
            UNION ALL
            SELECT   DECODE(LEVEL,1,5,2,17,3,28) DP_SEQ
                    ,@[fcast_yrwk] FCAST_YRWK0
                    ,'D2' CNTR_TPSZ_CD
                    , 0 CNTR_QTY
            FROM DUAL
            CONNECT BY LEVEL <=3
            ) A
        GROUP BY DP_SEQ,FCAST_YRWK
        UNION ALL
        SELECT    DP_SEQ
                 ,'Demand', 'Repo Out', A.FCAST_YRWK FCAST_YRWK0, 1
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'D2',CNTR_QTY,0)) D2_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'D4',CNTR_QTY,0)) D4_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'D5',CNTR_QTY,0)) D5_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'D7',CNTR_QTY,0)) D7_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'R2',CNTR_QTY,0)) R2_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'R5',CNTR_QTY,0)) R5_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'O2',CNTR_QTY,0)) O2_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'S2',CNTR_QTY,0)) S2_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'O4',CNTR_QTY,0)) O4_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'S4',CNTR_QTY,0)) S4_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'F2',CNTR_QTY,0)) F2_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'A2',CNTR_QTY,0)) A2_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'F4',CNTR_QTY,0)) F4_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'A4',CNTR_QTY,0)) A4_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'F5',CNTR_QTY,0)) F5_FCAST_QTY
        FROM
            (
            SELECT /*+ ordered use_nl(D Y A) */  
				   DECODE(D.SEQ,1,10,2,21,3,32) DP_SEQ
                  ,D.FCAST_YRWK
                  ,A.CNTR_TPSZ_CD, SUM(A.CNTR_QTY) CNTR_QTY
            FROM  (SELECT /*+ INDEX(A XPKEQR_WK_PRD) */ 
                        ROWNUM AS SEQ,PLN_YR||PLN_WK, WK_ST_DT, WK_END_DT, @[fcast_yrwk] FCAST_YRWK , @[loc_cd] LOC_CD
                   FROM EQR_WK_PRD A
                   WHERE PLN_YR||PLN_WK >= @[fcast_yrwk]
                   AND   PLN_YR >= SUBSTR(@[fcast_yrwk],1,4)
                   AND   ROWNUM <=3) D, LV_YD_LIST Y, EQR_MTY_REPO_OB_V A
            WHERE A.FM_ETD_DT BETWEEN TO_DATE(D.WK_ST_DT,'YYYYMMDD') AND TO_DATE(D.WK_END_DT,'YYYYMMDD')+0.99999
            AND   A.FM_YD_CD= Y.YD_CD
            AND   A.CNTR_QTY > 0
            GROUP BY D.SEQ,D.FCAST_YRWK,A.CNTR_TPSZ_CD
            
            UNION ALL
            SELECT   DECODE(LEVEL,1,10,2,21,3,32) DP_SEQ
                    ,@[fcast_yrwk] FCAST_YRWK0
                    ,'D2' CNTR_TPSZ_CD
                    , 0 CNTR_QTY
            FROM DUAL
            CONNECT BY LEVEL <=3
            ) A
        GROUP BY DP_SEQ,FCAST_YRWK        
        UNION ALL
        SELECT    DP_SEQ
                 ,'Demand', 'Off-hire', A.FCAST_YRWK FCAST_YRWK0, 1
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'D2',CNTR_QTY,0)) D2_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'D4',CNTR_QTY,0)) D4_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'D5',CNTR_QTY,0)) D5_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'D7',CNTR_QTY,0)) D7_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'R2',CNTR_QTY,0)) R2_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'R5',CNTR_QTY,0)) R5_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'O2',CNTR_QTY,0)) O2_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'S2',CNTR_QTY,0)) S2_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'O4',CNTR_QTY,0)) O4_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'S4',CNTR_QTY,0)) S4_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'F2',CNTR_QTY,0)) F2_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'A2',CNTR_QTY,0)) A2_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'F4',CNTR_QTY,0)) F4_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'A4',CNTR_QTY,0)) A4_FCAST_QTY
                 ,SUM(DECODE(A.CNTR_TPSZ_CD,'F5',CNTR_QTY,0)) F5_FCAST_QTY
        FROM
            (
            SELECT  DECODE(C.SEQ,1,11,2,22,3,33) DP_SEQ
                   ,C.FCAST_YRWK
                   ,A.CNTR_TPSZ_CD, COUNT(A.MTY_RTN_YD_CD) CNTR_QTY
            FROM  LSE_AVAL_OFFH A, MDM_EQ_ORZ_CHT B, (SELECT /*+ INDEX(A XPKEQR_WK_PRD) */ 
                                                             ROWNUM AS SEQ,A.PLN_YR||A.PLN_WK, A.WK_ST_DT, A.WK_END_DT, @[fcast_yrwk] FCAST_YRWK ,@[loc_cd] LOC_CD
                                                      FROM  EQR_WK_PRD A
                                                      WHERE A.PLN_YR||A.PLN_WK >= @[fcast_yrwk]
                                                      AND   A.PLN_YR >= SUBSTR(@[fcast_yrwk],1,4)
                                                      AND   ROWNUM <=3) C  ,MST_CONTAINER D 
            WHERE A.OFFH_DUE_DT BETWEEN C.WK_ST_DT AND C.WK_END_DT
            AND   A.OFFH_STS_CD = 'C'
            AND   SUBSTR(A.MTY_RTN_YD_CD,1,5) = B.SCC_CD
            AND   B.ECC_CD = C.LOC_CD
            AND   A.CNTR_NO = D.CNTR_NO
            AND   D.ACIAC_DIV_CD = 'A'
            AND   D.IMDT_EXT_FLG = 'N'
            AND   DECODE(A.CNTR_FULL_FLG,'Y','1',D.FULL_FLG)  = DECODE(A.CNTR_FULL_FLG,'Y','1','N')  -- OFF 대상 선정시 MTY 였다가 현재 FULL 로 바뀐 것은 제외
            GROUP BY C.SEQ,C.FCAST_YRWK,A.CNTR_TPSZ_CD
            UNION ALL
            SELECT   DECODE(LEVEL,1,11,2,22,3,33) DP_SEQ
                    ,@[fcast_yrwk] FCAST_YRWK0
                    ,'D2' CNTR_TPSZ_CD
                    , 0 CNTR_QTY
            FROM DUAL
            CONNECT BY LEVEL <=3
            ) A
        GROUP BY DP_SEQ,FCAST_YRWK    
        UNION ALL
            SELECT DECODE(WK_SEQ,1,13,2,24,3,35) DP_SEQ, 'MTY Balance', 'MTY Balance' ,'2000929' FCAST_YRWK0, 1
                       ,0 D2_QTY
                       ,0 D4_QTY
                       ,0 D5_QTY
                       ,0 D7_QTY
                       ,0 R2_QTY
                       ,0 R5_QTY
                       ,0 O2_QTY
                       ,0 S2_QTY
                       ,0 O4_QTY
                       ,0 S4_QTY
                       ,0 F2_QTY
                       ,0 A2_QTY
                       ,0 F4_QTY
                       ,0 A4_QTY
                       ,0 F5_QTY
            FROM LV_DUMMY_WEEK
        UNION ALL
            SELECT DECODE(WK_SEQ,2,14,3,25) DP_SEQ,FCAST_YRWK, FCAST_YRWK ,'2000929' FCAST_YRWK0, 1
                       ,0 D2_QTY
                       ,0 D4_QTY
                       ,0 D5_QTY
                       ,0 D7_QTY
                       ,0 R2_QTY
                       ,0 R5_QTY
                       ,0 O2_QTY
                       ,0 S2_QTY
                       ,0 O4_QTY
                       ,0 S4_QTY
                       ,0 F2_QTY
                       ,0 A2_QTY
                       ,0 F4_QTY
                       ,0 A4_QTY
                       ,0 F5_QTY
            FROM LV_DUMMY_WEEK
            WHERE WK_SEQ > 1
        
    	UNION ALL
    		SELECT DECODE(WK_SEQ,2,15,3,26) DP_SEQ,'Estimated Sound MT', 'Estimated Sound MT' ,FCAST_YRWK, 1
                       ,0 D2_QTY
                       ,0 D4_QTY
                       ,0 D5_QTY
                       ,0 D7_QTY
                       ,0 R2_QTY
                       ,0 R5_QTY
                       ,0 O2_QTY
                       ,0 S2_QTY
                       ,0 O4_QTY
                       ,0 S4_QTY
                       ,0 F2_QTY
                       ,0 A2_QTY
                       ,0 F4_QTY
                       ,0 A4_QTY
                       ,0 F5_QTY    		
    		FROM LV_DUMMY_WEEK
    		WHERE WK_SEQ > 1
    
    ) A
    ORDER BY DP_SEQ
)			]]></sql>
			<params>
				<param name="fcast_yrwk" type="12" value="" out="N"/>
				<param name="loc_cd" type="12" value="" out="N"/>
				<param name="repo_pln_id" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
