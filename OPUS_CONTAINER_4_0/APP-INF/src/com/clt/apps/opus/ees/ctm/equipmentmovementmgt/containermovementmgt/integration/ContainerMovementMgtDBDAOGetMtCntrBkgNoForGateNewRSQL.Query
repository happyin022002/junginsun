<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ContainerMovementMgtDBDAOGetMtCntrBkgNoForGateNewRSQL">
			<desc><![CDATA[--------------------------------------------------------
History
2010.10.18 김상수 [CHM-201006479-01] B.Bulk화물 Movement를 Logic 변경(MT->Full)
                  - 현재 B.Bulk화물의 컨테이너는 MT로 VL 처리되기 때문에 FULL VL이 아니라
                    EMPTY VL without bkg으로 VL 생성되고 있는 건을 Mt->Full로 변경해서
                    자동생성 로직이 탈수있도록 소스수정
                  - 현재 자동생성시 이전 상태가 MT이고 현재는 full VL이므로 업무상 error로
                    분류되는 로직을 MT이고 Full VL이면 OP,OC가 자동생성되게 변경.
                    그러나 BreakBulk도 아니면서 OP,OC없이 생성된 full VL도 있을 수 있으므로
                    이를 막기위해 bkg cntr테이블의 BB column을 다시 check하는 로직추가
]]></desc>
			<sql><![CDATA[
SELECT BKG_NO
FROM (SELECT B.BKG_NO, A.CNMV_CYC_NO
  FROM BKG_CONTAINER A,
       BKG_BOOKING B
#if (${bkg_cgo_tp_cd} == 'R')
       , BKG_VVD V
#end
 WHERE A.CNTR_NO = @[cntr_no]
   AND A.CNMV_CYC_NO =
          (SELECT MAX (CNMV_CYC_NO)
             FROM BKG_CONTAINER BC,
                  BKG_BOOKING BO
            WHERE BC.CNTR_NO = @[cntr_no]
              AND BC.BKG_NO = BO.BKG_NO
              AND NVL (BO.BKG_STS_CD, '') NOT IN ('X', 'S', 'A')
              AND BC.CNMV_CYC_NO <> DECODE (@[gate_io_cd], 'UV', 9999, 0)
#if (${bkg_cgo_tp_cd} != 'R')
              AND BC.CNMV_CYC_NO = DECODE (@[gate_io_cd], 'AE', 9999, BC.CNMV_CYC_NO)
#end
         #if (${bkg_cgo_tp_cd} == 'F')
              AND BC.BB_CGO_FLG = 'Y'
         #end
              )
   AND A.BKG_NO = B.BKG_NO
#if (${bkg_cgo_tp_cd} == 'R')
   AND A.BKG_NO = V.BKG_NO
#end
   AND NVL (B.BKG_STS_CD, '') NOT IN ('X', 'S', 'A')
   AND B.BKG_CGO_TP_CD = @[bkg_cgo_tp_cd]
#if (${bkg_cgo_tp_cd} == 'R')
   AND DECODE (@[gate_io_cd], 'AE', V.POL_CD, V.POD_CD) = SUBSTR (@[event_yard], 1, 5)
#else
   AND DECODE (@[gate_io_cd], 'AE', B.POL_CD, B.POD_CD) = SUBSTR (@[event_yard], 1, 5)
#end
   AND ROWNUM = 1
UNION
SELECT B.BKG_NO, A.CNMV_CYC_NO
  FROM CTM_BKG_CNTR A,
       CTM_BOOKING B
#if (${bkg_cgo_tp_cd} == 'R')
       , CTM_BKG_VVD V
#end
 WHERE A.CNTR_NO = @[cntr_no]
   AND A.CNMV_CYC_NO =
          (SELECT MAX (CNMV_CYC_NO)
             FROM CTM_BKG_CNTR BC,
                  CTM_BOOKING BO
            WHERE BC.CNTR_NO = @[cntr_no]
              AND BC.BKG_NO = BO.BKG_NO
			  AND BC.CNMV_CYC_NO <> 9998
              AND NVL (BO.BKG_STS_CD, '') NOT IN ('X', 'S', 'A')
#if (${bkg_cgo_tp_cd} != 'P')
              AND BC.CNMV_CYC_NO <> DECODE (@[gate_io_cd], 'UV', 9999, 0)
#end
#if (${bkg_cgo_tp_cd} != 'R')
              AND BC.CNMV_CYC_NO = DECODE (@[gate_io_cd], 'AE', 9999, BC.CNMV_CYC_NO)
#end
         #if (${bkg_cgo_tp_cd} == 'F')
              AND BC.BB_CGO_FLG = 'Y'
         #end
              )
   AND A.BKG_NO = B.BKG_NO
#if (${bkg_cgo_tp_cd} == 'R')
   AND A.BKG_NO = V.BKG_NO
#end
   AND NVL (B.BKG_STS_CD, '') NOT IN ('X', 'S', 'A')
   AND B.BKG_CGO_TP_CD = @[bkg_cgo_tp_cd]
#if (${bkg_cgo_tp_cd} == 'R')
   AND DECODE (@[gate_io_cd], 'AE', V.POL_CD, V.POD_CD) = SUBSTR (@[event_yard], 1, 5)
#else
   AND DECODE (@[gate_io_cd], 'AE', B.POL_CD, B.POD_CD) = SUBSTR (@[event_yard], 1, 5)
#end
   AND ROWNUM = 1
ORDER BY CNMV_CYC_NO DESC )
WHERE ROWNUM=1			]]></sql>
			<params>
				<param name="cntr_no" type="12" value="" out="N"/>
				<param name="gate_io_cd" type="12" value="" out="N"/>
				<param name="bkg_cgo_tp_cd" type="12" value="" out="N"/>
				<param name="event_yard" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
