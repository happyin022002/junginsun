<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="GeneralCodeSearchMgtDBDAOsearchUnitPriceDataRSQL">
			<desc><![CDATA[searchUnitPriceData]]></desc>
			<sql><![CDATA[
WITH TEMP_DROP AS (
    SELECT  A.TRF_EFF_YR, A.TRF_EFF_QTR_NO, A.MNR_DISP_TRF_SEQ, A.EQ_KND_CD, 
            A.EQ_TPSZ_CD, A.LOC_CD, B.SCC_CD, B.LCC_CD, B.RCC_CD, A.CURR_CD, 
            A.MNR_DISP_TRF_AMT, A.MNR_TRF_RMK , A.UPD_DT       
    FROM    MNR_DISP_TRF A,
           (SELECT  A.LOC_CD, A.RGN_CD, A.SCC_CD, A.EQ_CTRL_OFC_CD,
                    C.LCC_CD, C.ECC_CD, C.RCC_CD
            FROM    MDM_LOCATION A,  
                    MDM_EQ_ORZ_CHT C        
            WHERE   A.SCC_CD = C.SCC_CD
            AND     NVL(A.DELT_FLG, 'N') <> 'Y'
            ) B
            WHERE A.TRF_EFF_YR = SUBSTR(REPLACE(@[request_dt],'-',''), 1,4)
             AND  A.TRF_EFF_QTR_NO = TO_CHAR(TO_DATE(REPLACE(@[request_dt],'-',''),'YYYYMMDD'), 'Q')
             AND  A.EQ_TPSZ_CD = @[eq_tpsz_cd]
             AND  A.LOC_CD = B.LOC_CD
)   
SELECT  A.MATCH_TYPE,
        A.MATCH_CNT,
		CASE WHEN TD.CURR_CD = @[curr_cd] THEN TD.MNR_DISP_TRF_AMT
             ELSE MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(SUBSTR(REPLACE(@[request_dt],'-',''), 1,6), 'USD', @[curr_cd], NVL(A.MNR_DISP_TRF_TOT,0)) END AS MNR_DISP_TRF_TOT, 
        CASE WHEN TD.CURR_CD = @[curr_cd] THEN TD.MNR_DISP_TRF_AMT
             ELSE MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(SUBSTR(REPLACE(@[request_dt],'-',''), 1,6), 'USD', @[curr_cd], NVL(A.MNR_DISP_TRF_AVG,0)) END AS MNR_DISP_TRF_AVG,  
        @[curr_cd] AS CURR_CD              
FROM   (
        SELECT  'LOC_CD' AS MATCH_TYPE, COUNT(*) AS MATCH_CNT,
                SUM(MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(SUBSTR(REPLACE(@[request_dt],'-',''), 1,6), CURR_CD, 'USD', NVL(MNR_DISP_TRF_AMT,0))) AS MNR_DISP_TRF_TOT,                                                                           
                AVG(MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(SUBSTR(REPLACE(@[request_dt],'-',''), 1,6), CURR_CD, 'USD', NVL(MNR_DISP_TRF_AMT,0))) AS MNR_DISP_TRF_AVG
        FROM    TEMP_DROP A
        WHERE   A.LOC_CD = SUBSTR(@[crnt_yd_cd], 1, 5)
        UNION ALL
        SELECT  'SCC_CD' AS MATCH_TYPE, COUNT(*) AS MATCH_CNT,
                SUM(MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(SUBSTR(REPLACE(@[request_dt],'-',''), 1,6), CURR_CD, 'USD', NVL(MNR_DISP_TRF_AMT,0))) AS MNR_DISP_TRF_TOT,                                                                           
                AVG(MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(SUBSTR(REPLACE(@[request_dt],'-',''), 1,6), CURR_CD, 'USD', NVL(MNR_DISP_TRF_AMT,0))) AS MNR_DISP_TRF_AVG
        FROM    TEMP_DROP A
        WHERE   A.SCC_CD = (SELECT  C.SCC_CD
                            FROM    MDM_LOCATION A, MDM_EQ_ORZ_CHT C     
                            WHERE   A.SCC_CD = C.SCC_CD
                            AND     NVL(A.DELT_FLG, 'N') <> 'Y'
                            AND     A.LOC_CD = SUBSTR(@[crnt_yd_cd], 1, 5))                
        UNION ALL
        SELECT  'LCC_CD' AS MATCH_TYPE, COUNT(*) AS MATCH_CNT,
                SUM(MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(SUBSTR(REPLACE(@[request_dt],'-',''), 1,6), CURR_CD, 'USD', NVL(MNR_DISP_TRF_AMT,0))) AS MNR_DISP_TRF_TOT,                                                                           
                AVG(MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(SUBSTR(REPLACE(@[request_dt],'-',''), 1,6), CURR_CD, 'USD', NVL(MNR_DISP_TRF_AMT,0))) AS MNR_DISP_TRF_AVG
        FROM    TEMP_DROP A 
        WHERE   A.LCC_CD = (SELECT  C.LCC_CD
                            FROM    MDM_LOCATION A, MDM_EQ_ORZ_CHT C        
                            WHERE   A.SCC_CD = C.SCC_CD
                            AND     NVL(A.DELT_FLG, 'N') <> 'Y'
                            AND     A.LOC_CD = SUBSTR(@[crnt_yd_cd], 1, 5))                       
        UNION ALL
        SELECT  'RCC_CD' AS MATCH_TYPE, COUNT(*) AS MATCH_CNT,
                 SUM(MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(SUBSTR(REPLACE(@[request_dt],'-',''), 1,6), CURR_CD, 'USD', NVL(MNR_DISP_TRF_AMT,0))) AS MNR_DISP_TRF_TOT,                                                                           
                 AVG(MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(SUBSTR(REPLACE(@[request_dt],'-',''), 1,6), CURR_CD, 'USD', NVL(MNR_DISP_TRF_AMT,0))) AS MNR_DISP_TRF_AVG
        FROM    TEMP_DROP A 
        WHERE   A.RCC_CD = (SELECT  C.RCC_CD
                            FROM    MDM_LOCATION A, MDM_EQ_ORZ_CHT C        
                            WHERE   A.SCC_CD = C.SCC_CD
                            AND     NVL(A.DELT_FLG, 'N') <> 'Y'
                            AND     A.LOC_CD = SUBSTR(@[crnt_yd_cd], 1, 5))                    
        ) A, TEMP_DROP TD
WHERE   A.MATCH_CNT > 0
AND     ROWNUM = 1			]]></sql>
			<params>
				<param name="request_dt" type="12" value="" out="N"/>
				<param name="eq_tpsz_cd" type="12" value="" out="N"/>
				<param name="curr_cd" type="12" value="" out="N"/>
				<param name="crnt_yd_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
