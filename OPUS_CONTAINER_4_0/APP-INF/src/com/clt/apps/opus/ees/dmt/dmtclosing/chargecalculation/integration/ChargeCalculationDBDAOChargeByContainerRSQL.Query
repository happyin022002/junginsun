<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ChargeCalculationDBDAOChargeByContainerRSQL">
			<desc><![CDATA[ChargeCalculationDBDAOChargeByContainerRSQL.Query]]></desc>
			<sql><![CDATA[
SELECT
	 C.SYS_AREA_GRP_ID AS SVR_ID
    ,C.CNTR_NO
    ,B.CNTR_TPSZ_CD
    ,C.CNTR_CYC_NO
    ,C.DMDT_TRF_CD
    ,C.DMDT_CHG_LOC_DIV_CD
    ,DECODE(C.CHG_SEQ, 1, 'G', 'B') AS CHG_TYPE
    ,C.CHG_SEQ
    ,C.DMDT_CHG_STS_CD
	,(  SELECT INTG_CD_VAL_DP_DESC
    	FROM COM_INTG_CD_DTL
    	WHERE INTG_CD_ID = 'CD01967'
    	AND	INTG_CD_VAL_CTNT = C.DMDT_CHG_STS_CD
	 ) DMDT_CHG_STS_DESC
    ,B.BKG_NO
    ,B.BL_NO
    ,C.DMDT_INV_NO
    ,IM.DMDT_AR_IF_CD
    ,B.VSL_CD || B.SKD_VOY_NO || B.SKD_DIR_CD AS VVD_CD
    ,TO_CHAR(V.VPS_ETA_DT,'YYYY-MM-DD') AS VPS_ETA_DT
    ,TO_CHAR(V.VPS_ETB_DT,'YYYY-MM-DD') AS VPS_ETB_DT
    ,TO_CHAR(V.VPS_ETD_DT,'YYYY-MM-DD') AS VPS_ETD_DT    
    ,BK.PRE_RLY_PORT_CD
	,BK.PST_RLY_PORT_CD
	,B.POR_CD
	,B.POL_CD
	,B.POD_CD
	,B.DEL_CD
	,B.BKG_RCV_TERM_CD || '/' || B.BKG_DE_TERM_CD AS RD_TERM_CD    
    ,(	SELECT	/*+ INDEX_DESC(BKG_EUR_TRO XPKBKG_EUR_TRO) */ NVL(HLG_TP_CD, 'N')
		FROM	BKG_EUR_TRO
		WHERE	BKG_NO				= B.BKG_NO
			AND	IO_BND_CD			= SUBSTR(C.DMDT_TRF_CD, 3, 1)
			AND	NVL(CXL_FLG, 'N')	= 'N'
			AND	CNTR_NO	= C.CNTR_NO
			AND ROWNUM = 1
	) AS CH    
    ,B.SC_NO
    ,B.RFA_NO
    ,DECODE( BK.AGMT_ACT_CNT_CD||TRIM(TO_CHAR(BK.AGMT_ACT_CUST_SEQ, '000000')),'000000', NULL
        	,BK.AGMT_ACT_CNT_CD||TRIM(TO_CHAR(BK.AGMT_ACT_CUST_SEQ, '000000')) ) AS ACUST
    ,B.CMDT_CD
	,(	SELECT CMDT_NM
		FROM  MDM_COMMODITY
		WHERE  CMDT_CD = B.CMDT_CD
	) AS CMDT_NM,
	B.REP_CMDT_CD,
	(	SELECT REP_CMDT_NM
		FROM  MDM_REP_CMDT
		WHERE  REP_CMDT_CD = B.REP_CMDT_CD
	) AS REP_CMDT_NM
	,B.SLS_OFC_CD
	,(	SELECT  BDD.EVNT_OFC_CD                    
	    FROM    BKG_DO     BDO,
		    	BKG_DO_DTL BDD
	    WHERE BDO.BKG_NO        = BDD.BKG_NO
	    AND   BDO.BKG_NO        = B.BKG_NO
	    AND   BDD.RLSE_STS_CD IN ('R', 'I')
	    AND ROWNUM = 1
	) AS RLSE_OFC
	,TO_CHAR((
	SELECT  BDD.EVNT_DT
	FROM    BKG_DO     BDO,
    	    BKG_DO_DTL BDD
	WHERE BDO.BKG_NO        = BDD.BKG_NO
	AND   BDO.BKG_NO        = B.BKG_NO
	AND   BDD.RLSE_STS_CD IN ('R', 'I')
	AND ROWNUM = 1),'YYYY-MM-DD HH24:MI'
	) AS RLSE_DT
    ,C.OFC_CD
	,C.OFC_RHQ_CD
    ,TO_CHAR(C.FM_MVMT_DT, 'YYYY-MM-DD') FM_MVMT_DT
    ,TO_CHAR(C.TO_MVMT_DT, 'YYYY-MM-DD') TO_MVMT_DT
    ,C.FM_MVMT_YD_CD
    ,C.TO_MVMT_YD_CD
    ,C.FM_MVMT_STS_CD
    ,C.TO_MVMT_STS_CD
	,C.WEB_IND_FLG
	,DECODE(C.WEB_IND_FLG, 'Y', TO_CHAR(NVL(C.WEB_MTY_DT, C.TO_MVMT_DT), 'YYYY-MM-DD'), TO_CHAR(C.WEB_MTY_DT, 'YYYY-MM-DD')) AS WEB_MTY_DT
	,DECODE(C.WEB_IND_FLG, 'Y', TO_CHAR(NVL(C.WEB_MTY_DT, C.TO_MVMT_DT) + 7, 'YYYY-MM-DD'), TO_CHAR(C.WEB_MTY_DT + 7, 'YYYY-MM-DD')) AS GRACE_END_DT
    ,TO_CHAR(C.FT_CMNC_DT, 'YYYY-MM-DD') FT_CMNC_DT
    ,TO_CHAR(C.FT_END_DT, 'YYYY-MM-DD') FT_END_DT
    ,C.FT_DYS
    ,C.FX_FT_OVR_DYS
    ,C.ORG_FT_OVR_DYS
	,DECODE(B.DMDT_CNTR_TP_CD, 'D', 'DRY', 'R', 'REEFER', 'F', 'FLAT RACK', 'O', 'OPEN TOP', 'T', 'TANK', 'S', 'S.Open Top', 'A', 'A.Flatrack') DMDT_CNTR_TP_CD
    ,B.DMDT_BKG_CGO_TP_CD   
    ,C.BZC_TRF_CURR_CD
    ,C.AFT_EXPT_DC_AMT
    ,C.BIL_AMT
    ,C.CORR_RMK
	,C.BZC_TRF_SEQ
	,C.BZC_TRF_GRP_SEQ
	,C.RFA_EXPT_DAR_NO
	,C.RFA_EXPT_MAPG_SEQ
	,C.RFA_EXPT_VER_SEQ
	,C.RFA_RQST_DTL_SEQ
	,C.SC_EXPT_VER_SEQ
	,C.SC_EXPT_GRP_SEQ
	,C.FX_FT_OVR_DYS
	,C.BZC_TRF_CURR_CD
	,C.DMDT_TRF_APLY_TP_CD
	,(
	CASE
    WHEN C.DMDT_TRF_APLY_TP_CD='G' THEN
        (
		SELECT DECODE(C.DMDT_CHG_LOC_DIV_CD, 'TSP', 'N|N|N', XCLD_SAT_FLG || '|' || XCLD_SUN_FLG || '|' ||XCLD_HOL_FLG) 
        FROM    DMT_TRF_GRP
        WHERE SYS_AREA_GRP_ID = C.SYS_AREA_GRP_ID
        AND DMDT_TRF_CD = C.DMDT_TRF_CD
        AND TRF_SEQ     = C.BZC_TRF_SEQ
        AND TRF_GRP_SEQ = C.BZC_TRF_GRP_SEQ
		)        
    WHEN C.DMDT_TRF_APLY_TP_CD='B' THEN
        (
		SELECT DECODE(C.DMDT_CHG_LOC_DIV_CD, 'TSP', 'N|N|N', XCLD_SAT_FLG || '|' || XCLD_SUN_FLG || '|' ||XCLD_HOL_FLG) 
        FROM    DMT_RFA_EXPT_TRF_DTL
        WHERE RFA_EXPT_DAR_NO	= C.RFA_EXPT_DAR_NO
        AND RFA_EXPT_MAPG_SEQ	= C.RFA_EXPT_MAPG_SEQ
        AND RFA_EXPT_VER_SEQ	= C.RFA_EXPT_VER_SEQ
        AND RFA_RQST_DTL_SEQ	= C.RFA_RQST_DTL_SEQ
		AND CVRG_CMB_SEQ		= 1
		)
    WHEN C.DMDT_TRF_APLY_TP_CD='S' THEN
        (
		SELECT DECODE(C.DMDT_CHG_LOC_DIV_CD, 'TSP', 'N|N|N', XCLD_SAT_FLG || '|' || XCLD_SUN_FLG || '|' ||XCLD_HOL_FLG) 
        FROM    DMT_SC_EXPT_GRP S, PRI_SP_HDR H
        WHERE   S.PROP_NO = H.PROP_NO
        AND     H.SC_NO = C.SC_NO
        AND     S.SC_EXPT_VER_SEQ = C.SC_EXPT_VER_SEQ
        AND     S.SC_EXPT_GRP_SEQ = C.SC_EXPT_GRP_SEQ
		)
	END
	) AS XCLD_FLGS
    ,BS.CUST_CNT_CD || TRIM(TO_CHAR(BS.CUST_SEQ, '000000')) SHIPPER_CD
    ,REPLACE(BS.CUST_NM, CHR(13) || CHR(10), ' ') SHIPPER_NM
    ,DECODE(BC.CUST_CNT_CD || TRIM(TO_CHAR(BC.CUST_SEQ, '000000')), '000000', NULL, BC.CUST_CNT_CD || TRIM(TO_CHAR(BC.CUST_SEQ, '000000'))) CNEE_CD
    ,REPLACE(BC.CUST_NM, CHR(13) || CHR(10), ' ') CNEE_NM
    ,DECODE(BN.CUST_CNT_CD || TRIM(TO_CHAR(BN.CUST_SEQ, '000000')), '000000', NULL, BN.CUST_CNT_CD || TRIM(TO_CHAR(BN.CUST_SEQ, '000000'))) NTFY_CD
    ,NVL(RTRIM(REPLACE(REPLACE(BN.CUST_NM, CHR(34), ''), CHR(13)||CHR(10), ' ')), '-') NTFY_NM
    ,DECODE(TRIM(TO_CHAR(C.VNDR_SEQ, '000000')), '000000', NULL, TRIM(TO_CHAR(C.VNDR_SEQ, '000000'))) AS SVC_PROVDR_CD
    ,MV.VNDR_LGL_ENG_NM SVC_PROVDR_NM
	,C.OFC_TRNS_FLG
	,(	SELECT 'S'
		FROM DUAL
		WHERE EXISTS (
		SELECT 1
		FROM BKG_ROLL_OVR R
		WHERE R.BKG_NO = B.BKG_NO
		AND R.ROLL_OVR_RSN_CD = 'S' )
	) AS ROLL_OVR
    ,C.DUL_TP_EXPT_FLG
    ,C.CXL_BKG_CHG_FLG
    ,NVL(IM.CRE_OFC_CD, C.OFC_CD) AS CRE_OFC_CD

FROM 
	#if (${est_mk} == 'P') 
		DMT_CHG_PRE_CALC_BKG_CNTR	B
        ,DMT_CHG_PRE_CALC           C
	#else
		DMT_CHG_BKG_CNTR    B
        ,DMT_CHG_CALC       C
	#end
        ,VSK_VSL_PORT_SKD   V
        ,DMT_INV_MN         IM
        ,BKG_BOOKING        BK
        ,MDM_VENDOR         MV
        ,BKG_CUSTOMER       BS
        ,BKG_CUSTOMER       BC
        ,BKG_CUSTOMER       BN

WHERE	B.SYS_AREA_GRP_ID	=   C.SYS_AREA_GRP_ID
AND		B.CNTR_NO			=   C.CNTR_NO
AND		B.CNTR_CYC_NO		=   C.CNTR_CYC_NO
AND		B.BKG_NO			=   BK.BKG_NO
AND		B.VSL_CD			=   V.VSL_CD(+)
AND		B.SKD_VOY_NO		=   V.SKD_VOY_NO(+)
AND		B.SKD_DIR_CD		=   V.SKD_DIR_CD(+)
AND		DECODE(SUBSTR(@[dmdt_trf_cd], 3, 1),'I', B.POD_CD, B.POL_CD) =	V.VPS_PORT_CD(+)
AND		C.VNDR_SEQ			=   MV.VNDR_SEQ (+)
AND		C.DMDT_INV_NO       =   IM.DMDT_INV_NO(+)
AND     B.BKG_NO			 =	 BS.BKG_NO(+)
AND     BS.BKG_CUST_TP_CD(+) =   'S'
AND     B.BKG_NO             =   BC.BKG_NO(+)
AND     BC.BKG_CUST_TP_CD(+) =   'C'
AND     B.BKG_NO             =   BN.BKG_NO(+)
AND     BN.BKG_CUST_TP_CD(+) =   'N'
AND		C.SYS_AREA_GRP_ID	=	@[svr_id]
AND		C.CNTR_NO       	=	@[cntr_no]
AND		C.CNTR_CYC_NO   	=	@[cntr_cyc_no]
AND 	C.DMDT_TRF_CD		=	@[dmdt_trf_cd]
AND 	C.DMDT_CHG_LOC_DIV_CD = @[dmdt_chg_loc_div_cd]
AND 	C.CHG_SEQ			=	@[chg_seq]
AND		NOT (C.DUL_TP_EXPT_FLG  = 'Y' AND SUBSTR(C.DMDT_TRF_CD, 1, 1) = 'D')
AND		C.DMDT_CHG_LOC_DIV_CD <> 'SZP'			]]></sql>
			<params>
				<param name="dmdt_trf_cd" type="12" value="" out="N"/>
				<param name="svr_id" type="12" value="" out="N"/>
				<param name="cntr_no" type="12" value="" out="N"/>
				<param name="cntr_cyc_no" type="12" value="" out="N"/>
				<param name="dmdt_chg_loc_div_cd" type="12" value="" out="N"/>
				<param name="chg_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
