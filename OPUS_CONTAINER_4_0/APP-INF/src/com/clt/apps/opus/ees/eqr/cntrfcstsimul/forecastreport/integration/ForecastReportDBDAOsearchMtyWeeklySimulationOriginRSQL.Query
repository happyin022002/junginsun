<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ForecastReportDBDAOsearchMtyWeeklySimulationOriginRSQL">
			<desc><![CDATA[해당 셀의 원래 값을 찾아온다]]></desc>
			<sql><![CDATA[
--  1.정의 : 현재데이터 조회
--  2.변수
--    :loc_grp_cd
--    :loc_cd
--    :week       - 화면타이틀의 WEEK와 일치함.
--    :cntr_tpsz

#if(${sim_tp_cd} == 'RO')
-- REPO OUT 조회
SELECT WEEK
      ,LOC_CD
      ,LOC_GRP_CD
      ,CNTR_TPSZ_CD
      ,NVL(SUM(CNTR_QTY), 0) AS CNTR_QTY
FROM
(              
    -- REPO OUT 조회       
    SELECT A.FCAST_YRWK WEEK
          ,A.LOC_CD
          ,A.LOC_GRP_CD
          ,B.INTG_CD_VAL_CTNT CNTR_TPSZ_CD 
          ,CASE WHEN B.INTG_CD_VAL_CTNT='D2' THEN NVL(A.D2_FCAST_QTY,0)
                WHEN B.INTG_CD_VAL_CTNT='D4' THEN NVL(A.D4_FCAST_QTY,0)       
                WHEN B.INTG_CD_VAL_CTNT='D5' THEN NVL(A.D5_FCAST_QTY,0)       
                WHEN B.INTG_CD_VAL_CTNT='D7' THEN NVL(A.D7_FCAST_QTY,0)       
                WHEN B.INTG_CD_VAL_CTNT='R2' THEN NVL(A.R2_FCAST_QTY,0)       
                WHEN B.INTG_CD_VAL_CTNT='R5' THEN NVL(A.R5_FCAST_QTY,0)       
                WHEN B.INTG_CD_VAL_CTNT='R9' THEN NVL(A.R9_FCAST_QTY,0)       
                WHEN B.INTG_CD_VAL_CTNT='O2' THEN NVL(A.O2_FCAST_QTY,0)       
                WHEN B.INTG_CD_VAL_CTNT='O4' THEN NVL(A.O4_FCAST_QTY,0)       
                WHEN B.INTG_CD_VAL_CTNT='S2' THEN NVL(A.S2_FCAST_QTY,0)       
                WHEN B.INTG_CD_VAL_CTNT='S4' THEN NVL(A.S4_FCAST_QTY,0)       
                WHEN B.INTG_CD_VAL_CTNT='F2' THEN NVL(A.F2_FCAST_QTY,0)       
                WHEN B.INTG_CD_VAL_CTNT='F4' THEN NVL(A.F4_FCAST_QTY,0)       
                WHEN B.INTG_CD_VAL_CTNT='F5' THEN NVL(A.F5_FCAST_QTY,0)       
                WHEN B.INTG_CD_VAL_CTNT='A2' THEN NVL(A.A2_FCAST_QTY,0)       
                WHEN B.INTG_CD_VAL_CTNT='A4' THEN NVL(A.A4_FCAST_QTY,0)       
                END CNTR_QTY  
    FROM EQR_CTRL_BAL_RPT_REPO_OUT A
        ,COM_INTG_CD_DTL B    
    WHERE A.LOC_GRP_CD    = @[loc_grp_cd] --L/E/S
    AND   A.LOC_CD        = @[loc_cd] 
    AND   A.INP_YRWK      = (
                                SELECT WEEK
                                FROM
                                (
                                    SELECT PLN_YR||PLN_WK WEEK
                                    FROM EQR_WK_PRD 
                                    WHERE PLN_YR||PLN_WK < @[week]
                                    ORDER BY PLN_YR||PLN_WK DESC
                                )
                                WHERE ROWNUM=1    
                            )             
    AND   A.FCAST_YRWK    = @[week]        
    AND   B.INTG_CD_ID    = 'CD00830'
    
) 
WHERE CNTR_TPSZ_CD = UPPER(@[cntr_tpsz])
GROUP BY WEEK 
        ,LOC_CD
        ,LOC_GRP_CD
        ,CNTR_TPSZ_CD 

#elseif(${sim_tp_cd} == 'OF')
-- OP FORECAST
SELECT WEEK
      ,LOC_CD
      ,LOC_GRP_CD
      ,CNTR_TPSZ_CD
      ,NVL(CNTR_QTY, 0) AS CNTR_QTY
FROM
(                  
    -- 동일한 FCAST_YRWK 중에 가장 최근 INP_YRWK 의 데이터 를 찾음 
    SELECT ROW_NUMBER() OVER(PARTITION BY A.FCAST_YRWK, A.LOC_CD, A.LOC_GRP_CD, B.INTG_CD_VAL_CTNT ORDER BY INP_YRWK DESC) RN
          ,A.FCAST_YRWK WEEK
          ,A.INP_YRWK
          ,A.LOC_CD
          ,A.LOC_GRP_CD
          ,B.INTG_CD_VAL_CTNT CNTR_TPSZ_CD 
          ,CASE WHEN B.INTG_CD_VAL_CTNT='D2' THEN NVL(SUM(D2_FCAST_QTY),0) 
                WHEN B.INTG_CD_VAL_CTNT='D4' THEN NVL(SUM(D4_FCAST_QTY),0)       
                WHEN B.INTG_CD_VAL_CTNT='D5' THEN NVL(SUM(D5_FCAST_QTY),0)       
                WHEN B.INTG_CD_VAL_CTNT='D7' THEN NVL(SUM(D7_FCAST_QTY),0)       
                WHEN B.INTG_CD_VAL_CTNT='R2' THEN NVL(SUM(R2_FCAST_QTY),0)       
                WHEN B.INTG_CD_VAL_CTNT='R5' THEN NVL(SUM(R5_FCAST_QTY),0)       
                WHEN B.INTG_CD_VAL_CTNT='R9' THEN NVL(SUM(R9_FCAST_QTY),0)       
                WHEN B.INTG_CD_VAL_CTNT='O2' THEN NVL(SUM(O2_FCAST_QTY),0)       
                WHEN B.INTG_CD_VAL_CTNT='O4' THEN NVL(SUM(O4_FCAST_QTY),0)       
                WHEN B.INTG_CD_VAL_CTNT='S2' THEN NVL(SUM(S2_FCAST_QTY),0)       
                WHEN B.INTG_CD_VAL_CTNT='S4' THEN NVL(SUM(S4_FCAST_QTY),0)       
                WHEN B.INTG_CD_VAL_CTNT='F2' THEN NVL(SUM(F2_FCAST_QTY),0)       
                WHEN B.INTG_CD_VAL_CTNT='F4' THEN NVL(SUM(F4_FCAST_QTY),0)       
                WHEN B.INTG_CD_VAL_CTNT='F5' THEN NVL(SUM(F5_FCAST_QTY),0)       
                WHEN B.INTG_CD_VAL_CTNT='A2' THEN NVL(SUM(A2_FCAST_QTY),0)       
                WHEN B.INTG_CD_VAL_CTNT='A4' THEN NVL(SUM(A4_FCAST_QTY),0)       
                END CNTR_QTY   
    FROM EQR_CTRL_MTY_BAL_RPT A
        ,COM_INTG_CD_DTL B     
    WHERE A.CO_CD         = 'H'
    AND   A.MTY_BAL_TP_CD = '3'         --OUT FORECAST
    AND   A.LOC_GRP_CD    = @[loc_grp_cd] --L/E/S
    AND   A.LOC_CD        = @[loc_cd]              
    AND   A.FCAST_YRWK    = @[week] 
    AND   B.INTG_CD_ID    = 'CD00830'
    GROUP BY A.FCAST_YRWK
            ,A.INP_YRWK 
            ,A.LOC_CD
            ,A.LOC_GRP_CD
            ,B.INTG_CD_VAL_CTNT    
) 
WHERE CNTR_TPSZ_CD = UPPER(@[cntr_tpsz])
AND   RN = 1 -- 동일한 FCAST_YRWK 중에 가장 최근 INP_YRWK 의 데이터 를 찾음 

#elseif(${sim_tp_cd} == 'IF')
-- MG FORECAST
SELECT WEEK
      ,LOC_CD
      ,LOC_GRP_CD
      ,CNTR_TPSZ_CD
      ,NVL(CNTR_QTY, 0)  AS CNTR_QTY
FROM
(                    
    -- 동일한 FCAST_YRWK 중에 가장 최근 INP_YRWK 의 데이터 를 찾음 
    SELECT ROW_NUMBER() OVER(PARTITION BY A.FCAST_YRWK, A.LOC_CD, A.LOC_GRP_CD, B.INTG_CD_VAL_CTNT ORDER BY INP_YRWK DESC) RN
          ,A.FCAST_YRWK WEEK
          ,A.INP_YRWK
          ,A.LOC_CD
          ,A.LOC_GRP_CD
          ,B.INTG_CD_VAL_CTNT CNTR_TPSZ_CD 
          ,CASE WHEN B.INTG_CD_VAL_CTNT='D2' THEN NVL(SUM(D2_FCAST_QTY),0) 
                WHEN B.INTG_CD_VAL_CTNT='D4' THEN NVL(SUM(D4_FCAST_QTY),0)       
                WHEN B.INTG_CD_VAL_CTNT='D5' THEN NVL(SUM(D5_FCAST_QTY),0)       
                WHEN B.INTG_CD_VAL_CTNT='D7' THEN NVL(SUM(D7_FCAST_QTY),0)       
                WHEN B.INTG_CD_VAL_CTNT='R2' THEN NVL(SUM(R2_FCAST_QTY),0)       
                WHEN B.INTG_CD_VAL_CTNT='R5' THEN NVL(SUM(R5_FCAST_QTY),0)       
                WHEN B.INTG_CD_VAL_CTNT='R9' THEN NVL(SUM(R9_FCAST_QTY),0)       
                WHEN B.INTG_CD_VAL_CTNT='O2' THEN NVL(SUM(O2_FCAST_QTY),0)       
                WHEN B.INTG_CD_VAL_CTNT='O4' THEN NVL(SUM(O4_FCAST_QTY),0)       
                WHEN B.INTG_CD_VAL_CTNT='S2' THEN NVL(SUM(S2_FCAST_QTY),0)       
                WHEN B.INTG_CD_VAL_CTNT='S4' THEN NVL(SUM(S4_FCAST_QTY),0)       
                WHEN B.INTG_CD_VAL_CTNT='F2' THEN NVL(SUM(F2_FCAST_QTY),0)       
                WHEN B.INTG_CD_VAL_CTNT='F4' THEN NVL(SUM(F4_FCAST_QTY),0)       
                WHEN B.INTG_CD_VAL_CTNT='F5' THEN NVL(SUM(F5_FCAST_QTY),0)       
                WHEN B.INTG_CD_VAL_CTNT='A2' THEN NVL(SUM(A2_FCAST_QTY),0)       
                WHEN B.INTG_CD_VAL_CTNT='A4' THEN NVL(SUM(A4_FCAST_QTY),0)       
                END CNTR_QTY    
    FROM EQR_CTRL_MTY_BAL_RPT A
        ,COM_INTG_CD_DTL B        
    WHERE A.CO_CD         = 'H'
    AND   A.MTY_BAL_TP_CD = '1'         --(MG)IF FORECAST
    AND   A.LOC_GRP_CD    = @[loc_grp_cd] --L/E/S
    AND   A.LOC_CD        = @[loc_cd]          
    AND   A.FCAST_YRWK    = @[week] 
    AND   B.INTG_CD_ID    = 'CD00830'
    GROUP BY A.FCAST_YRWK 
            ,A.INP_YRWK
            ,A.LOC_CD
            ,A.LOC_GRP_CD
            ,B.INTG_CD_VAL_CTNT             
) 
WHERE CNTR_TPSZ_CD = UPPER(@[cntr_tpsz])
AND   RN = 1 -- 동일한 FCAST_YRWK 중에 가장 최근 INP_YRWK 의 데이터 를 찾음 

#end			]]></sql>
			<params>
				<param name="loc_grp_cd" type="12" value="" out="N"/>
				<param name="loc_cd" type="12" value="" out="N"/>
				<param name="week" type="12" value="" out="N"/>
				<param name="cntr_tpsz" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
