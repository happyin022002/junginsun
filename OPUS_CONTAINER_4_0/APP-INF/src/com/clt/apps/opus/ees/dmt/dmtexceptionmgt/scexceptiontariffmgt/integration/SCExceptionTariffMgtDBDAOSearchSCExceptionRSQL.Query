<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="SCExceptionTariffMgtDBDAOSearchSCExceptionRSQL">
			<desc><![CDATA[S/C 별 DEM/DET 등록된 특별 계약 내용을 조회]]></desc>
			<sql><![CDATA[
SELECT
		A.PROP_NO
,       A.SC_EXPT_VER_SEQ
,       A.SC_EXPT_GRP_SEQ
,       A.DMDT_TRF_CD
,       TO_CHAR(A.EFF_DT, 'YYYY-MM-DD') AS EFF_DT
,       TO_CHAR(A.EXP_DT, 'YYYY-MM-DD') AS EXP_DT
,       A.DMDT_CNTR_CGO_TP_CD
,       B.CVRG_MULTI
,		B.CVRG_MULTI AS CURR_CVRG_MULTI
,		B.CVRG_SEQ
,       B.CNT_CD
,       B.RGN_CD
,       B.STE_CD
,       B.LOC_CD
,		DECODE(A.FT_FLG, 'Y', '1', '0') AS FT_FLG
,		DECODE(A.FT_ADJ_FLG, 'Y', 'M', DECODE(A.FT_FLG, 'Y', 'S', '')) AS FT_TIR
,		CASE WHEN A.FT_FLG = 'Y' AND A.FT_ADD_FLG = 'Y' THEN A.FT_ADD_DYS END AS FT_ADD_DYS
,		CASE WHEN A.FT_FLG = 'Y' AND A.FT_ADD_FLG = 'N' THEN A.FT_ADD_DYS END AS FT_TOT_DYS
,       DECODE(A.XCLD_SAT_FLG, 'Y', '1', '0') AS XCLD_SAT_FLG
,       DECODE(A.XCLD_SUN_FLG, 'Y', '1', '0') AS XCLD_SUN_FLG
,       DECODE(A.XCLD_HOL_FLG, 'Y', '1', '0') AS XCLD_HOL_FLG
,       A.SC_EXPT_FM_CONTI_CD
,       A.SC_EXPT_FM_CNT_CD
,       A.SC_EXPT_FM_RGN_CD
,       A.SC_EXPT_FM_STE_CD
,       A.SC_EXPT_FM_LOC_CD
,       A.FNL_DEST_CNT_CD
,       A.FNL_DEST_RGN_CD
,       A.FNL_DEST_STE_CD
,       A.FNL_DEST_LOC_CD
,       A.RCV_DE_TERM_CD
,       SUBSTR(A.EXPT_TRF_RMK, 0, 50) AS EXPT_TRF_RMK
,		A.EXPT_TRF_RMK FULL_EXPT_TRF_RMK
,		A.CURR_CD
,		A.RT_CHK_FLG
,		CASE
			WHEN A.RT_CHK_FLG = 'Y' THEN 'Y'
			WHEN A.CURR_CD IS NOT NULL OR A.CURR_CD <> '' THEN 'Y'
			WHEN (
					SELECT	COUNT(*)
					FROM	DMT_SC_EXPT_RT_ADJ
					WHERE	PROP_NO = A.PROP_NO
						AND	SC_EXPT_VER_SEQ = A.SC_EXPT_VER_SEQ
						AND SC_EXPT_GRP_SEQ = A.SC_EXPT_GRP_SEQ
				) > 0 THEN 'Y'
			ELSE 'N'
		END AS RT_CHK

FROM    DMT_SC_EXPT_GRP A, 
            (
				SELECT	PROP_NO
						, SC_EXPT_VER_SEQ
						, SC_EXPT_GRP_SEQ
						, CVRG_SEQ
						, CASE WHEN CVRG_MULTI < 2 THEN 'S' ELSE 'M' END CVRG_MULTI
        				, CASE WHEN CVRG_MULTI < 2 THEN CNT_CD ELSE '' END CNT_CD
        				, CASE WHEN CVRG_MULTI < 2 THEN RGN_CD ELSE '' END RGN_CD
        				, CASE WHEN CVRG_MULTI < 2 THEN STE_CD ELSE '' END STE_CD
        				, CASE WHEN CVRG_MULTI < 2 THEN LOC_CD ELSE '' END LOC_CD

				FROM	(
							SELECT	COUNT(CVRG_SEQ) OVER (PARTITION BY PROP_NO, SC_EXPT_VER_SEQ, SC_EXPT_GRP_SEQ) CVRG_MULTI
									, ROW_NUMBER () OVER (PARTITION BY PROP_NO, SC_EXPT_VER_SEQ, SC_EXPT_GRP_SEQ ORDER BY SC_EXPT_GRP_SEQ, CVRG_SEQ) SEQ
            						, PROP_NO, SC_EXPT_VER_SEQ, SC_EXPT_GRP_SEQ, CVRG_SEQ, CNT_CD, RGN_CD, STE_CD, LOC_CD
        
    						FROM    DMT_SC_EXPT_CVRG
    						WHERE   PROP_NO 		= @[prop_no] 
								AND SC_EXPT_VER_SEQ = @[sc_expt_ver_seq]

								#if(${sc_expt_grp_seq} != '')
								AND SC_EXPT_GRP_SEQ = @[sc_expt_grp_seq]
								#end
    					)
				WHERE SEQ < 2
            ) B

WHERE   A.PROP_NO 			= @[prop_no]
    AND A.SC_EXPT_VER_SEQ 	= @[sc_expt_ver_seq]

	#if(${sc_expt_grp_seq} != '')
	AND A.SC_EXPT_GRP_SEQ = @[sc_expt_grp_seq]
	#end

	AND A.DELT_FLG 			= 'N'
    AND A.PROP_NO 			= B.PROP_NO
    AND A.SC_EXPT_VER_SEQ 	= B.SC_EXPT_VER_SEQ
    AND A.SC_EXPT_GRP_SEQ 	= B.SC_EXPT_GRP_SEQ

ORDER BY A.SC_EXPT_GRP_SEQ ASC			]]></sql>
			<params>
				<param name="prop_no" type="12" value="" out="N"/>
				<param name="sc_expt_ver_seq" type="12" value="" out="N"/>
				<param name="sc_expt_grp_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
