<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ContainerOnOffhireDBDAOSearchCntrStatusUpdateHistoryDataRSQL">
			<desc><![CDATA[searchCntrStatusUpdateHistoryData]]></desc>
			<sql><![CDATA[
WITH PARAM
AS (
(SELECT /*+ INDEX( A XPKMST_CONTAINER) */
                 CNTR_NO 
                 FROM MST_CONTAINER A
                 WHERE 1 = 1
                 ##${cntr_no}
                 #if ($cntr_no.length() == 10) 
                 AND   A.CNTR_NO LIKE @[cntr_no] || '%'
                 #end 
                 ##${cntr_no} 
                 #if ($cntr_no.length() != 10) 
                 AND   A.CNTR_NO = @[cntr_no]
                 #end 
                 AND CNMV_DT = (
                               SELECT MAX(CNMV_DT) 
                               FROM MST_CONTAINER 
                               WHERE 1 = 1
                               ##${cntr_no}
                               #if ($cntr_no.length() == 10) 
                               AND   CNTR_NO LIKE @[cntr_no] || '%'
                               #end 
                               ##${cntr_no}
                               #if ($cntr_no.length() != 10) 
                               AND   CNTR_NO = @[cntr_no]
                               #end 
                               )
                 AND ROWNUM = 1 
))
SELECT
	A.CNTR_STS_CD
	,TO_CHAR(A.CNTR_STS_EVNT_DT, 'YYYY-MM-DD') CNTR_STS_EVNT_DT
	,A.YD_CD
    ,A.AGMT_CTY_CD
    ,A.AGMT_SEQ
	,B.LSTM_CD
	,B.REF_NO,
	 CASE WHEN A.CNTR_STS_CD IN ('SLD') 
	      THEN DECODE(NVL(A.CUST_CNT_CD,'0'), '0', '', A.CUST_CNT_CD||A.CUST_SEQ)
	 ELSE TO_CHAR(B.VNDR_SEQ) END VNDR_SEQ,
	 CASE WHEN A.CNTR_STS_CD IN ('SLD') 
	      THEN DECODE(NVL(A.CUST_CNT_CD,'0'), '0', A.CUST_NM, (SELECT CUST_LGL_ENG_NM FROM MDM_CUSTOMER WHERE CUST_CNT_CD = A.CUST_CNT_CD AND CUST_SEQ = A.CUST_SEQ))
	 ELSE C.VNDR_LGL_ENG_NM END VNDR_LGL_ENG_NM
	,A.DIR_ITCHG_VNDR_SEQ
    ,(SELECT VNDR_LGL_ENG_NM FROM MDM_VENDOR WHERE VNDR_SEQ = A.DIR_ITCHG_VNDR_SEQ) DIR_VNDR_LGL_ENG_NM
	,A.OFC_CD
	,A.CNTR_OLD_VAN_FLG
   ,CASE WHEN A.CNTR_PKUP_CHG_AMT > 0 THEN
      A.CNTR_PKUP_CHG_AMT 
   ELSE  0 END CNTR_PKUP_CHG_AMT
   ,CASE WHEN A.CNTR_PKUP_CHG_AMT < 0 THEN
      A.CNTR_PKUP_CHG_AMT * (-1)
   ELSE 0 END CNTR_PKUP_CR_CHG_AMT
	,A.CNTR_MIN_ONH_DYS
	,A.RNTL_CHG_FREE_DYS
	,A.CNTR_DIR_ITCHG_FEE_AMT
   ,CASE WHEN A.CNTR_DRFF_CR_AMT > 0 THEN
      A.CNTR_DRFF_CR_AMT 
   ELSE  0 END CNTR_DRFF_AMT
   ,CASE WHEN A.CNTR_DRFF_CR_AMT < 0 THEN
      A.CNTR_DRFF_CR_AMT * (-1)
   ELSE 0 END CNTR_DRFF_CR_AMT   
	,A.CNTR_LFT_CHG_AMT
	,A.CNTR_LSTM_CNG_FLG
	,TO_CHAR(A.CRE_DT, 'YYYY-MM-DD HH24:MI') CRE_DT
	,TO_CHAR(A.UPD_DT, 'YYYY-MM-DD HH24:MI') UPD_DT
	,A.CNTR_STS_RMK
    ,D.CNMV_STS_CD MVMT_STS_CD
    ,A.CNTR_STS_SEQ
    ,A.CURR_CD
    ,TO_CHAR(GLOBALDATE_PKG.TIME_LOCAL_FNC(SUBSTR(A.YD_CD, 1, 5)) , 'YYYY-MM-DD') TIME_LOCAL
    ,CASE WHEN A.CNTR_STS_CD = 'LSI' AND 
          	   D.CNMV_STS_CD = 'MT' AND 
              NVL((SELECT TO_NUMBER(SUBSTR(MAX(TO_CHAR(CRE_DT,'YYYYMMDDHH24MISS')||LTRIM(TO_CHAR(CNMV_CYC_NO,'0000'))), 15))
               FROM BKG_CONTAINER 
               WHERE CNTR_NO = P.CNTR_NO),88888888) != 9999 THEN 'O'
      ELSE 'X' END DEL_FLG
    , DECODE((SELECT MIN(SUB.CNTR_STS_SEQ)
              FROM MST_CNTR_STS_HIS SUB
              WHERE A.CNTR_NO = SUB.CNTR_NO), A.CNTR_STS_SEQ, 'Y', 'N') AS INIT_FLG
	,A.PRNR_STS_SEQ
	,MST_COMMON_PKG.MST_DATA_ACSS_CHK_FNC(@[usr_ofc_cd], A.YD_CD) AS CHK_FLG
    ,MST_AUTH_FNC('DATE', @[usr_ofc_cd], A.CNTR_NO, A.CNTR_STS_SEQ) DATE_FLG
    ,MST_AUTH_FNC('AGMT', @[usr_ofc_cd], A.CNTR_NO, A.CNTR_STS_SEQ) AGMT_FLG
    ,MST_AUTH_FNC('DELT', @[usr_ofc_cd], A.CNTR_NO, A.CNTR_STS_SEQ) DELT_FLG
    , (SELECT /*+ INDEX_DESC(CM XUK1CTM_MOVEMENT) */
              CM.CNMV_YR
         FROM CTM_MOVEMENT CM
        WHERE A.CNTR_NO = CM.CNTR_NO
           AND A.YD_CD     = CM.ORG_YD_CD
           AND TO_CHAR(A.CNTR_STS_EVNT_DT, 'YYYYMMDD') = TO_CHAR(CM.CNMV_EVNT_DT, 'YYYYMMDD')
           AND A.CNTR_STS_CD  = DECODE(CM.MVMT_STS_CD||TRIM(CM.MVMT_CRE_TP_CD), 'XXC', 'LSO', CM.CNMV_RMK)
           AND SUBSTR(REPLACE(CM.MVMT_STS_CD||TRIM(CM.MVMT_CRE_TP_CD), 'XXC', 'E'), -1) = 'E'
           AND ROWNUM                = 1) CNMV_YR
   , (SELECT /*+ INDEX_DESC(CM XUK1CTM_MOVEMENT) */
              CM.CNMV_ID_NO
         FROM CTM_MOVEMENT CM
        WHERE A.CNTR_NO = CM.CNTR_NO
           AND A.YD_CD     = CM.ORG_YD_CD
           AND TO_CHAR(A.CNTR_STS_EVNT_DT, 'YYYYMMDD') = TO_CHAR(CM.CNMV_EVNT_DT, 'YYYYMMDD')
           AND A.CNTR_STS_CD  = DECODE(CM.MVMT_STS_CD||TRIM(CM.MVMT_CRE_TP_CD), 'XXC', 'LSO', CM.CNMV_RMK)
           AND SUBSTR(REPLACE(CM.MVMT_STS_CD||TRIM(CM.MVMT_CRE_TP_CD), 'XXC', 'E'), -1) = 'E'
           AND ROWNUM                = 1) CNMV_ID_NO 
   , (SELECT TO_CHAR(TRUNC(NVL(MAX(SM.CNMV_EVNT_DT), SYSDATE - 10000)), 'YYYYMMDD')
       FROM CTM_MOVEMENT SM
      WHERE  A.CNTR_NO               = SM.CNTR_NO
        AND  CASE WHEN A.CNTR_STS_CD IN ('LSI', 'OWN', 'SBI', 'MUI') THEN
                       TRUNC(A.CNTR_STS_EVNT_DT)
                  ELSE
                       TRUNC(A.CNTR_STS_EVNT_DT)+0.99999
             END > SM.CNMV_EVNT_DT
        AND  SUBSTR(REPLACE(SM.MVMT_STS_CD||TRIM(SM.MVMT_CRE_TP_CD), 'XXC', 'E'), -1) != 'E'
     ) CHK_FM_DT
     , (SELECT TO_CHAR(TRUNC(NVL(MIN(SM.CNMV_EVNT_DT), SYSDATE)), 'YYYYMMDD')
       FROM CTM_MOVEMENT SM
      WHERE  A.CNTR_NO               = SM.CNTR_NO
        AND  CASE WHEN A.CNTR_STS_CD IN ('LSI', 'OWN', 'SBI', 'MUI') THEN
                       TRUNC(A.CNTR_STS_EVNT_DT)
                  ELSE
                       TRUNC(A.CNTR_STS_EVNT_DT)+0.99999
             END < SM.CNMV_EVNT_DT
        AND  SUBSTR(REPLACE(SM.MVMT_STS_CD||TRIM(SM.MVMT_CRE_TP_CD), 'XXC', 'E'), -1) != 'E'
     ) CHK_TO_DT
     , NVL((SELECT TO_CHAR(ATH.PKUP_FM_DT, 'YYYYMMDD')
        FROM LSE_ONH_APRO ATH
       WHERE ATH.CNTR_ONH_AUTH_NO IN (A.CNTR_AUTH_NO, A.CNTR_OFFH_AUTH_NO)
         AND  A.CNTR_STS_CD     IN ('LSI', 'SBO', 'MUO')
         AND  ROWNUM            = 1), '19000101') AS PKUP_FM_DT
     , NVL((SELECT TO_CHAR(ATH.PKUP_DUE_DT, 'YYYYMMDD')
        FROM LSE_ONH_APRO ATH
       WHERE ATH.CNTR_ONH_AUTH_NO IN (A.CNTR_AUTH_NO, A.CNTR_OFFH_AUTH_NO)
         AND  A.CNTR_STS_CD     IN ('LSI', 'SBO', 'MUO')
         AND  ROWNUM            = 1), TO_CHAR(SYSDATE, 'YYYYMMDD')) AS PKUP_TO_DT    
FROM 
   MST_CNTR_STS_HIS A,
   LSE_AGREEMENT B,
   MDM_VENDOR C,
   MST_CONTAINER D,
   PARAM P
WHERE 1 = 1
AND A.CNTR_NO     = P.CNTR_NO
AND B.AGMT_CTY_CD(+) = A.AGMT_CTY_CD
AND B.AGMT_SEQ(+)    = A.AGMT_SEQ
AND C.VNDR_SEQ(+)    = B.VNDR_SEQ
AND D.CNTR_NO     = A.CNTR_NO
ORDER BY A.CNTR_STS_EVNT_DT, A.CNTR_STS_SEQ			]]></sql>
			<params>
				<param name="cntr_no" type="12" value="" out="N"/>
				<param name="usr_ofc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
