<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="RepairMgtDBDAOsearchEstimateSMRListDataRSQL">
			<desc><![CDATA[searchEstimateSMRListData]]></desc>
			<sql><![CDATA[
SELECT 
RSV.RQST_EQ_NO,
RSV.RPR_RQST_SEQ,
RSV.RPR_RQST_VER_NO,
RSV.RPR_RQST_LST_VER_FLG,
RSV.EQ_KND_CD,
RSV.EQ_TPSZ_CD,
MNR_COMMON_PKG.MNR_CONV_PARTNER_CD_FNC(RSV.VNDR_SEQ) AS VNDR_SEQ,
RSV.VNDR_NM,
#if (${rqst_type} == 'rqst_cre')
	RSV.RPR_STS_CD,	
#else
	(CASE
    WHEN NVL(RSV.EQ_DMG_TP_CD,'N') = 'Y'  THEN 'HW'
    WHEN RSV.RPR_STS_CD = 'HR' THEN DECODE(RSV.COST_OFC_CD,RSV.APRO_OFC_CD,RSV.RPR_STS_CD,'HU')
    ELSE RSV.RPR_STS_CD
    END) AS RPR_STS_CD,  
#end
RSV.RPR_DTL_STS_CD,
RSV.RQST_REF_NO,
RSV.MNR_INP_TP_CD,
RSV.COST_OFC_CD,
TO_CHAR(GLOBALDATE_PKG.TIME_CONV_OFC_FNC(MNR_COMMON_PKG.MNR_GET_HOOFC_FNC(),RSV.RQST_DT,@[cur_ofc_cd]),'YYYY-MM-DD') AS RQST_DT,
RSV.RQST_USR_ID,
RSV.MNR_MEAS_UT_CD,
RSV.APRO_OFC_CD,
TO_CHAR(GLOBALDATE_PKG.TIME_CONV_OFC_FNC(MNR_COMMON_PKG.MNR_GET_HOOFC_FNC(),RSV.APRO_DT,@[cur_ofc_cd]),'YYYY-MM-DD') AS APRO_DT,
RSV.APRO_USR_ID,
RSV.RPR_OFFH_FLG,
TO_CHAR(RSV.RPR_RSLT_DT,'YYYY-MM-DD') AS RPR_RSLT_DT,
RSV.CURR_CD,
RSV.RPR_YD_CD,
TO_CHAR(RSV.EQ_DMG_DT,'YYYY-MM-DD') AS EQ_DMG_DT,
RSV.EQ_DMG_TP_CD,
RSV.RPR_WRK_TP_CD,
RSV.MNR_EDI_NM,
RSV.N3PTY_FLG,
RSV.IF_TRC_SEQ,
RSV.N3PTY_BIL_TTL_AMT,
RSV.DISP_FLG,
RSV.DISP_NO,
RSV.DISP_DTL_SEQ,
RSV.FILE_SEQ,
RSV.MNR_RPR_RMK,
RSV.EDI_ID,
RSV.MNR_ORD_OFC_CTY_CD,
RSV.MNR_ORD_SEQ,
RSV.AGMT_OFC_CTY_CD,
RSV.AGMT_SEQ,
RSV.AGMT_VER_NO,
RSV.CRE_USR_ID,
TO_CHAR(GLOBALDATE_PKG.TIME_CONV_OFC_FNC(MNR_COMMON_PKG.MNR_GET_HOOFC_FNC(),RSV.CRE_DT,@[cur_ofc_cd]),'YYYY-MM-DD') AS CRE_DT,
RSV.UPD_USR_ID,
TO_CHAR(GLOBALDATE_PKG.TIME_CONV_OFC_FNC(MNR_COMMON_PKG.MNR_GET_HOOFC_FNC(),RSV.UPD_DT,@[cur_ofc_cd]),'YYYY-MM-DD') AS UPD_DT,
NVL2((MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC (TO_CHAR(SYSDATE, 'YYYYMM'),RSV.CURR_CD_MGI, RSV.CURR_CD, RSV.AUTO_AMT))
,DECODE((MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC (TO_CHAR(SYSDATE, 'YYYYMM'),RSV.CURR_CD_MGI, RSV.CURR_CD, RSV.AUTO_AMT)),0,-1,(MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(TO_CHAR(SYSDATE, 'YYYYMM'),RSV.CURR_CD_MGI, RSV.CURR_CD, RSV.AUTO_AMT))),
-1) AS AUTO_AMT,
NVL2(MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC (TO_CHAR(SYSDATE, 'YYYYMM'),RSV.CURR_CD_MGI, RSV.CURR_CD, RSV.APPOVAL_AMT)
,DECODE(MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC (TO_CHAR(SYSDATE, 'YYYYMM'),RSV.CURR_CD_MGI, RSV.CURR_CD, RSV.APPOVAL_AMT),0,9999999999999,MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC (TO_CHAR(SYSDATE, 'YYYYMM'),RSV.CURR_CD_MGI, RSV.CURR_CD, RSV.APPOVAL_AMT)),
9999999999999) AS APPOVAL_AMT,
RSV.UPPR_OFC_CD,
RSV.TRSM_MOD_CD,
RSV.TRF_NO,
MNR_COMMON_PKG.MNR_CONV_AGMT_NO_FNC(RSV.AGMT_OFC_CTY_CD, RSV.AGMT_SEQ) AS AGMT_NO,
RSV.AGMT_OFC_CD,
RSV.MNR_VRFY_TP_CD,
RSV.DMG_FLAG,
RSV.IMM_EXT,
RSV.TOTAL_AMT,
RSV.MNR_MEAS_UT_NM
FROM
(
	SELECT 
       MRH.RQST_EQ_NO,
       MRH.RPR_RQST_SEQ,
       MRH.RPR_RQST_VER_NO,
       MRH.RPR_RQST_LST_VER_FLG,
       MRH.EQ_KND_CD,
       MRH.EQ_TPSZ_CD,
       MRH.VNDR_SEQ,
       MDV.VNDR_LGL_ENG_NM AS VNDR_NM,
       MRH.RPR_STS_CD,
       MRH.RPR_DTL_STS_CD,
       MRH.RQST_REF_NO,
       MRH.MNR_INP_TP_CD,
       MRH.COST_OFC_CD,
       MRH.RQST_DT AS RQST_DT,
       MRH.RQST_USR_ID,
       MRH.MNR_MEAS_UT_CD,
       MRH.APRO_OFC_CD,
       MRH.APRO_DT AS APRO_DT,
       MRH.APRO_USR_ID,
       MRH.RPR_OFFH_FLG,
       MRH.RPR_RSLT_DT,
       MRH.CURR_CD,
       NVL(MRH.RPR_YD_CD,MSV.CRNT_YD_CD) AS RPR_YD_CD,
       MRH.EQ_DMG_DT,
       MRH.EQ_DMG_TP_CD,
       MRH.RPR_WRK_TP_CD,
       MRH.MNR_EDI_NM,
       MRH.N3PTY_FLG,
       MRH.IF_TRC_SEQ,
       MRH.N3PTY_BIL_TTL_AMT,
       MRH.DISP_FLG,
       MRH.DISP_NO,
       MRH.DISP_DTL_SEQ,
       MRH.FILE_SEQ,
       MRH.MNR_RPR_RMK,
       MPA.EDI_ID,
       MRH.MNR_ORD_OFC_CTY_CD,
       MRH.MNR_ORD_SEQ,
       MRH.AGMT_OFC_CTY_CD,
       MRH.AGMT_SEQ,
       MRH.AGMT_VER_NO,
       MRH.CRE_USR_ID,
       MRH.CRE_DT AS CRE_DT,
       MRH.UPD_USR_ID,
       MRH.UPD_DT AS UPD_DT,
       MGI.CURR_CD CURR_CD_MGI,
       DECODE(SIGN(SYSDATE - MGI.EFF_DT),
              1,
              MGI.AFT_AUTO_APRO_AMT,
              MGI.BFR_AUTO_APRO_AMT) AUTO_AMT,
       DECODE(SIGN(SYSDATE - MGI.EFF_DT),
              1,
              MGI.AFT_SELF_AUTH_AMT,
              MGI.BFR_SELF_AUTH_AMT) APPOVAL_AMT,
       MGI.UPPR_OFC_CD,
       MPA.TRSM_MOD_CD,
       MAH.TRF_NO, 
       MAH.AGMT_OFC_CD,
       NVL(MSV.DMG_FLAG,'N') DMG_FLAG,
       MSV.IMM_EXT,      
       (SELECT MAX(DECODE(MRD.MNR_VRFY_TP_CD, 'AA', 'SS', MRD.MNR_VRFY_TP_CD))
          FROM MNR_RPR_RQST_DTL MRD
         WHERE MRD.RQST_EQ_NO = MRH.RQST_EQ_NO
           AND MRD.RPR_RQST_SEQ = MRH.RPR_RQST_SEQ
           AND MRD.RPR_RQST_VER_NO = MRH.RPR_RQST_VER_NO) MNR_VRFY_TP_CD,
       (SELECT SUM(MRD.MNR_WRK_AMT)
          FROM MNR_RPR_RQST_DTL MRD
         WHERE MRD.RQST_EQ_NO = MRH.RQST_EQ_NO
           AND MRD.RPR_RQST_SEQ = MRH.RPR_RQST_SEQ
           AND MRD.RPR_RQST_VER_NO = MRH.RPR_RQST_VER_NO) TOTAL_AMT,
       (SELECT GD.MNR_CD_DP_DESC     
	  FROM MNR_RPR_TRF_HDR TH,MNR_GEN_CD GD
	  WHERE TH.MNR_MEAS_UT_CD = GD.MNR_CD_ID
	  AND GD.PRNT_CD_ID = 'CD00010'
	  AND MAH.TRF_NO = TH.TRF_NO 
	  AND ROWNUM = 1
	) AS MNR_MEAS_UT_NM 
  FROM MNR_RPR_RQST_HDR MRH, MNR_OFC_GEN_INFO MGI,MDM_VENDOR MDV,MNR_AGMT_HDR MAH,MNR_PARTNER MPA,MNR_EQ_STS_V MSV
 WHERE 1 = 1
       AND MGI.MNR_GRP_TP_CD(+) = 'RPR'
	   #if (${rqst_type} == 'rqst_cre')
	   AND MGI.OFC_CD(+) = MRH.COST_OFC_CD
	   #else
	   AND MGI.OFC_CD(+) = MRH.APRO_OFC_CD
	   #end
	   AND MGI.EQ_KND_CD(+) = MRH.EQ_KND_CD
	   AND MGI.COST_CD(+) = 'MR' || DECODE(MRH.EQ_KND_CD,'U',DECODE(SUBSTR(MRH.EQ_TPSZ_CD, 1, 1), 'R', 'R', 'D'),MRH.EQ_KND_CD)
	   #if (${rqst_type} == 'rqst_cre')
	   AND MRH.COST_OFC_CD = @[cost_ofc_cd]
	   #else
	   AND MRH.APRO_OFC_CD = @[apro_ofc_cd]	
	   #end
	   #if (${rqst_type} == 'rqst_cre')
	        #if (${curr_sys} == 'ALP')	
	    	AND MRH.RPR_STS_CD IN ('HS','HJ','HO','HC')
	        #else
		    AND MRH.RPR_STS_CD IN ('SS','HJ','HO','SC')
			AND MRH.VNDR_SEQ = TO_NUMBER(@[vndr_seq])
		    #end
	   #else
	   AND MRH.RPR_STS_CD IN ('HR','SR')
	   		#if (${is_edi} == 'Y') 
				AND MRH.MNR_INP_TP_CD = 'E'
			#else
				AND MRH.MNR_INP_TP_CD <> 'E'
			#end	
	   #end
	   AND MRH.VNDR_SEQ = MDV.VNDR_SEQ
	   AND MRH.RPR_RQST_LST_VER_FLG = 'Y'
	   AND MAH.AGMT_OFC_CTY_CD = MRH.AGMT_OFC_CTY_CD
	   AND MAH.AGMT_SEQ = MRH.AGMT_SEQ
	   AND MAH.AGMT_LST_VER_FLG = 'Y'
	   AND MPA.MNR_GRP_TP_CD = 'RPR'
	   AND MPA.MNR_PRNR_SEQ = MRH.VNDR_SEQ
	   AND MPA.CTRL_OFC_CD  = MRH.COST_OFC_CD
	   AND MRH.RQST_EQ_NO = MSV.EQ_NO(+)
) RSV
WHERE 1 = 1
#if (${rqst_type} != 'rqst_cre')
	#if (${is_edi} == 'N') 
		AND NVL2((MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC (TO_CHAR(SYSDATE, 'YYYYMM'),RSV.CURR_CD_MGI, RSV.CURR_CD, RSV.AUTO_AMT))
            ,DECODE((MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC (TO_CHAR(SYSDATE, 'YYYYMM'),RSV.CURR_CD_MGI, RSV.CURR_CD, RSV.AUTO_AMT)),0,-1,(MNR_COMMON_PKG.MNR_CAL_CURR_RATE_FNC(TO_CHAR(SYSDATE, 'YYYYMM'),RSV.CURR_CD_MGI, RSV.CURR_CD, RSV.AUTO_AMT))),
            -1) < RSV.TOTAL_AMT
	#end
#end
ORDER BY RSV.EQ_DMG_TP_CD DESC			]]></sql>
			<params>
				<param name="cur_ofc_cd" type="12" value="" out="N"/>
				<param name="cost_ofc_cd" type="12" value="" out="N"/>
				<param name="apro_ofc_cd" type="12" value="" out="N"/>
				<param name="vndr_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
