<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ChargeCalculationDBDAOSearchChargeDeletionRequestRSQL">
			<desc><![CDATA[Request 된 Charge Deletion 정보를 수정한다.]]></desc>
			<sql><![CDATA[
SELECT DISTINCT
	 C.SYS_AREA_GRP_ID AS SVR_ID
    ,C.CNTR_CYC_NO
    ,C.DMDT_CHG_LOC_DIV_CD
    ,C.DMDT_TRF_CD
    ,B.BKG_NO
	,C.OFC_CD
    ,C.CHG_SEQ
	,C.DMDT_CHG_STS_CD
    ,C.CNTR_NO
    ,B.CNTR_TPSZ_CD
	,DD.RQST_USR_ID
	,DD.RQST_OFC_CD
	,DD.RQST_DT
	,DD.DMDT_CHG_DELT_RSN_CD
    ,( SELECT INTG_CD_VAL_DP_DESC
       FROM COM_INTG_CD_DTL
       WHERE INTG_CD_ID = 'CD01965'
       AND INTG_CD_VAL_CTNT = DD.DMDT_CHG_DELT_RSN_CD
      ) DELT_RSN_DESC
    ,DD.DELT_SEQ
	,DD.DELT_RMK AS CORR_RMK
    ,C.FM_MVMT_YD_CD
    ,C.TO_MVMT_YD_CD
    ,C.FM_MVMT_STS_CD
    ,C.TO_MVMT_STS_CD	
    ,C.FT_DYS
    ,C.FX_FT_OVR_DYS
    ,TO_CHAR(C.FM_MVMT_DT, 'YYYYMMDD') FM_MVMT_DT
    ,TO_CHAR(C.TO_MVMT_DT, 'YYYYMMDD') TO_MVMT_DT
    ,TO_CHAR(C.FT_CMNC_DT, 'YYYYMMDD') FT_CMNC_DT
    ,TO_CHAR(C.FT_END_DT, 'YYYYMMDD') FT_END_DT	
    ,C.BZC_TRF_CURR_CD
    ,C.ORG_CHG_AMT
    ,C.SC_RFA_EXPT_AMT
    ,C.AFT_EXPT_DC_AMT
    ,C.BIL_AMT	
	,DECODE(C.CHG_SEQ, 1, 'G', 'B' 	) AS GEN_BAL
	,NVL(B.SOC_FLG, 'N') AS SOC_FLG
    ,CASE
        WHEN C.DMDT_TRF_CD='DMIF' AND C.TO_MVMT_STS_CD='ID' THEN 'L'
        WHEN C.DMDT_TRF_CD='DMIF' AND C.TO_MVMT_STS_CD NOT IN ('ID','CS','DR') THEN 'I'
        WHEN C.DMDT_TRF_CD='DMOF' AND C.DMDT_CHG_LOC_DIV_CD<>'POL' THEN 'L'
        WHEN C.DMDT_TRF_CD='DMOF' AND C.DMDT_CHG_LOC_DIV_CD='POL' THEN 'I'
	END AS LI
    ,(	SELECT NVL(HLG_TP_CD, 'N')      /* 'C'ARRIER, 'M'ERCHANT, 'N'ULL */
    	FROM BKG_EUR_TRO
    	WHERE BKG_NO	= B.BKG_NO
    	AND  IO_BND_CD	= SUBSTR(C.DMDT_TRF_CD, 3, 1)    /* IN/OUT BOUND */
    	AND  NVL(CXL_FLG, 'N')    = 'N'
    	AND  CNTR_NO	= C.CNTR_NO
		AND	 ROWNUM = 1
    ) AS CH
    ,(	SELECT 'Y' 	FROM DUAL
    	WHERE EXISTS (SELECT  BDD.RLSE_STS_CD
    	              FROM    BKG_DO BDO,
            		          BKG_DO_DTL BDD
    		          WHERE BDO.BKG_NO = BDD.BKG_NO
    	              AND   BDO.BKG_NO = B.BKG_NO
    		          AND   BDD.RLSE_STS_CD IN ('R', 'I')) 
	) AS D_O
    ,(	SELECT  BDD.EVNT_OFC_CD
    	FROM    BKG_DO     BDO,
            	BKG_DO_DTL BDD
    	WHERE BDO.BKG_NO        = BDD.BKG_NO
   		AND   BDO.BKG_NO        = B.BKG_NO
    	AND   BDD.RLSE_STS_CD IN ('R', 'I')
    	AND ROWNUM = 1 
	) AS RLSE_OFC
	, (select BR.CLT_OFC_CD FROM BKG_RATE BR where BR.BKG_NO = B.BKG_NO ) as CLT_OFC_CD	
	,NVL(C.OFC_TRNS_FLG, 'N') AS OFC_TRNS_FLG
    ,(	SELECT 'S' FROM DUAL
    	WHERE EXISTS (SELECT 1
    		          FROM  BKG_ROLL_OVR R
    		          WHERE R.BKG_NO = B.BKG_NO
    		          AND   R.ROLL_OVR_RSN_CD = 'S' )
	) AS ROLL_OVR
    ,C.DMDT_INV_NO
    ,(SELECT  TO_CHAR(IM.CRE_DT, 'YYYYMMDD') 
      FROM DMT_INV_MN IM, DMT_INV_DTL ID
      WHERE IM.BKG_NO	= B.BKG_NO 
      AND   IM.DMDT_INV_NO = ID.DMDT_INV_NO
	  AND   IM.CRE_OFC_CD  = ID.CRE_OFC_CD
	  AND   IM.DMDT_INV_STS_CD = 'I'   
      AND   ID.CNTR_NO  = DD.CNTR_NO
      AND   ID.CNTR_CYC_NO = DD.CNTR_CYC_NO
      AND   ID.DMDT_TRF_CD = DD.DMDT_TRF_CD
      AND   ID.DMDT_CHG_LOC_DIV_CD = DD.DMDT_CHG_LOC_DIV_CD
      AND   ID.CHG_SEQ = DD.CHG_SEQ      ) AS ISS_DT
	,(SELECT IM.INV_CURR_CD    
      FROM DMT_INV_MN IM, DMT_INV_DTL ID
      WHERE IM.BKG_NO	= B.BKG_NO 
      AND   IM.DMDT_INV_NO(+)= ID.DMDT_INV_NO
	  AND   IM.CRE_OFC_CD(+) = ID.CRE_OFC_CD
	  AND   IM.DMDT_INV_STS_CD = 'I' 
      AND   ID.CNTR_NO  = DD.CNTR_NO
      AND   ID.CNTR_CYC_NO = DD.CNTR_CYC_NO
      AND   ID.DMDT_TRF_CD = DD.DMDT_TRF_CD
      AND   ID.DMDT_CHG_LOC_DIV_CD = DD.DMDT_CHG_LOC_DIV_CD
      AND   ID.CHG_SEQ = DD.CHG_SEQ   ) AS INV_CURR_CD
	,(SELECT ID.CNTR_INV_AMT 
      FROM  DMT_INV_MN IM, DMT_INV_DTL ID
      WHERE IM.BKG_NO	= B.BKG_NO 
      AND   IM.DMDT_INV_NO(+)	= ID.DMDT_INV_NO
	  AND   IM.CRE_OFC_CD(+)		= ID.CRE_OFC_CD
	  AND   IM.DMDT_INV_STS_CD = 'I'
      AND   ID.CNTR_NO  = DD.CNTR_NO
      AND   ID.CNTR_CYC_NO = DD.CNTR_CYC_NO
      AND   ID.DMDT_TRF_CD = DD.DMDT_TRF_CD
      AND   ID.DMDT_CHG_LOC_DIV_CD = DD.DMDT_CHG_LOC_DIV_CD
      AND   ID.CHG_SEQ = DD.CHG_SEQ    ) AS CNTR_INV_AMT
	,(SELECT IM.DMDT_AR_IF_CD
      FROM  DMT_INV_MN IM, DMT_INV_DTL ID
      WHERE IM.BKG_NO	= B.BKG_NO 
      AND   IM.DMDT_INV_NO(+)	= ID.DMDT_INV_NO
	  AND   IM.CRE_OFC_CD(+)		= ID.CRE_OFC_CD
	  AND   IM.DMDT_INV_STS_CD = 'I'
      AND   ID.CNTR_NO  = DD.CNTR_NO
      AND   ID.CNTR_CYC_NO = DD.CNTR_CYC_NO
      AND   ID.DMDT_TRF_CD = DD.DMDT_TRF_CD
      AND   ID.DMDT_CHG_LOC_DIV_CD = DD.DMDT_CHG_LOC_DIV_CD
      AND   ID.CHG_SEQ = DD.CHG_SEQ    )AS DMDT_AR_IF_CD
FROM DMT_CHG_DELT_RQST_APRO DD
    ,DMT_CHG_BKG_CNTR B
    ,DMT_CHG_CALC C
WHERE DD.SYS_AREA_GRP_ID = C.SYS_AREA_GRP_ID
AND   DD.CNTR_NO         = C.CNTR_NO
AND   DD.CNTR_CYC_NO     = C.CNTR_CYC_NO
AND   DD.DMDT_TRF_CD      =   C.DMDT_TRF_CD
AND   DD.DMDT_CHG_LOC_DIV_CD = C.DMDT_CHG_LOC_DIV_CD
AND   DD.CHG_SEQ = C.CHG_SEQ
AND   B.SYS_AREA_GRP_ID	= C.SYS_AREA_GRP_ID
AND   B.CNTR_NO         = C.CNTR_NO
AND   B.CNTR_CYC_NO     = C.CNTR_CYC_NO
AND   C.DMDT_CHG_LOC_DIV_CD <> 'SZP'
AND NOT (C.DUL_TP_EXPT_FLG  = 'Y' AND SUBSTR(C.DMDT_TRF_CD, 1, 1) = 'D')
AND   DD.DMDT_DELT_RQST_STS_CD = 'R'
AND   DD.CHG_OFC_CD IN (
  #foreach( $chg_ofc_cd in ${ofc_cd_list} )
	#if($velocityCount < $ofc_cd_list.size()) '$chg_ofc_cd', #else '$chg_ofc_cd' #end
  #end
)
AND   DD.RQST_DT  BETWEEN TO_DATE(REPLACE(@[fm_dt],'-',''), 'yyyymmdd') AND TO_DATE(REPLACE(@[to_dt],'-',''), 'yyyymmdd') + 0.99999
#if (${bkg_no} != '')	
AND B.BKG_NO IN (
  #foreach( $bkg_cd in ${bkg_no_list} )
    #if($velocityCount < $bkg_no_list.size()) '$bkg_cd', #else '$bkg_cd' #end
  #end
)
#end
AND  DD.APRO_OFC_CD = @[apro_ofc_cd]			]]></sql>
			<params>
				<param name="fm_dt" type="12" value="" out="N"/>
				<param name="to_dt" type="12" value="" out="N"/>
				<param name="apro_ofc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
