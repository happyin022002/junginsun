<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ChargeAmountDiscountMgtDBDAOSearchBookingDataInBookingRSQL">
			<desc><![CDATA[DAR No. 나 B/L No. 입력시 Booking 테이블에서 Booking 정보를 조회하는 쿼리]]></desc>
			<sql><![CDATA[
SELECT	TVVD
	, 	POR_CD
	, 	POL_CD
	, 	POD_CD
	,	DEL_CD
	, 	RD
    ,   DCGO_FLG
	,	RC_FLG
	, 	AWK_CGO_FLG
	,	BB_CGO_FLG
	, 	RD_CGO_FLG
	, 	SOC_FLG
	, 	CMDT_CD
	,	CMDT_NM
	,	SC_NO
	,	RFA_NO
	,	BKG_NO
	,	BL_NO
	,	DECODE(NVL(RP_CUST_CD, ''), '', SP_CUST_CD, RP_CUST_CD) CUST_CD
	,	DECODE(NVL(RP_CUST_CD, ''), '', SP_CUST_NM, RP_CUST_NM) CUST_NM

FROM	(
			SELECT  ROWNUM IDX
				,	BOOKING.VSL_CD || BOOKING.SKD_VOY_NO || BOOKING.SKD_DIR_CD TVVD
			    ,   BOOKING.POR_CD
			    ,   BOOKING.POL_CD
			    ,   BOOKING.POD_CD
			    ,   BOOKING.DEL_CD
			    ,   BOOKING.RCV_TERM_CD || '/' || BOOKING.DE_TERM_CD RD
			    ,   DECODE(BOOKING.DCGO_FLG, 'N', '', BOOKING.DCGO_FLG) DCGO_FLG
			    ,   DECODE(BOOKING.RC_FLG, 'N', '', BOOKING.RC_FLG) RC_FLG
			    ,   DECODE(BOOKING.AWK_CGO_FLG, 'N', '', BOOKING.AWK_CGO_FLG) AWK_CGO_FLG
			    ,   DECODE(BOOKING.BB_CGO_FLG, 'N', '', BOOKING.BB_CGO_FLG) BB_CGO_FLG
				, 	DECODE(BOOKING.RD_CGO_FLG, 'N', '', BOOKING.RD_CGO_FLG) RD_CGO_FLG
				, 	DECODE(BOOKING.SOC_FLG, 'N', '', BOOKING.SOC_FLG) SOC_FLG
				,	BOOKING.BKG_NO
				,	BOOKING.BL_NO
				,	BOOKING.SC_NO
				,	BOOKING.RFA_NO
	            ,   RP_MN.CTRT_CUST_CNT_CD || LPAD(RP_MN.CTRT_CUST_SEQ, 6, '0') RP_CUST_CD
	            ,   (
						SELECT	CUST_LGL_ENG_NM 
						FROM 	MDM_CUSTOMER 
						WHERE	CUST_CNT_CD = RP_MN.CTRT_CUST_CNT_CD 
							AND CUST_SEQ = RP_MN.CTRT_CUST_SEQ
					) RP_CUST_NM
	            ,   SP_PTY.CUST_CNT_CD || LPAD(SP_PTY.CUST_SEQ, 6, '0') SP_CUST_CD
	            ,   (
						SELECT	CUST_LGL_ENG_NM 
						FROM	MDM_CUSTOMER 
						WHERE	CUST_CNT_CD = SP_PTY.CUST_CNT_CD 
							AND CUST_SEQ = SP_PTY.CUST_SEQ 
					) SP_CUST_NM
				, 	BOOKING.CMDT_CD
			    ,	CMDT.CMDT_NM

			FROM	BKG_BOOKING BOOKING
				,	MDM_COMMODITY CMDT
				,   PRI_RP_HDR RP_HDR
				,   PRI_RP_MN RP_MN
				,   PRI_SP_HDR SP_HDR
				,   PRI_SP_CTRT_PTY SP_PTY

			WHERE   
				#if(${bkg_no} != '')
					BOOKING.BKG_NO = @[bkg_no]
				#else
					BOOKING.BKG_NO = (SELECT BKG_NO FROM BKG_BOOKING WHERE BL_NO = @[bl_no])
				#end
				AND BOOKING.CMDT_CD = CMDT.CMDT_CD
				AND BOOKING.RFA_NO = RP_HDR.RFA_NO(+)
				AND RP_HDR.PROP_NO = RP_MN.PROP_NO(+)
				AND	(
						RP_MN.AMDT_SEQ IS NULL
						OR
						(
							RP_MN.AMDT_SEQ =
							(
								SELECT 	/*+ INDEX_DESC(PRI_RP_MN XPKPRI_RP_MN) */AMDT_SEQ
								FROM	PRI_RP_MN
								WHERE	PROP_NO = RP_MN.PROP_NO
									AND	ROWNUM = 1
							)
						)
					)
				AND BOOKING.SC_NO = SP_HDR.SC_NO(+)
				AND SP_HDR.PROP_NO = SP_PTY.PROP_NO(+)
				AND (
						(
							SP_PTY.PRC_CTRT_PTY_TP_CD IS NULL AND SP_PTY.AMDT_SEQ IS NULL
						)
						OR 
						(
							SP_PTY.PRC_CTRT_PTY_TP_CD = 'C' 
							AND 
							SP_PTY.AMDT_SEQ = 
							(
								SELECT	/*+ INDEX_DESC(PRI_SP_CTRT_PTY XPKPRI_SP_CTRT_PTY) */AMDT_SEQ 
								FROM	PRI_SP_CTRT_PTY 
								WHERE 	PROP_NO = SP_PTY.PROP_NO
									AND	PRC_CTRT_PTY_TP_CD = 'C'
									AND	ROWNUM = 1
							)				
						)  
					)		
		)
WHERE IDX = 1			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
