<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CIMCommonDBDAOSearchMovementEdiErrListByContainerRSQL">
			<desc><![CDATA[Container Movement History EDI Error 조회]]></desc>
			<sql><![CDATA[
WITH PARAM
AS (SELECT  @[p_cntrno]||@[check_digit] AS CNTR_NO FROM DUAL)
SELECT CNTR_NO				
        , INP_DT
        , INP_TP_CD
        , STATUS
        , MVMT_STS_CD
        , MVMT_CRE_TP_CD
        , ORG_YD_CD
        , CNMV_EVNT_DT
        , CNMV_CYC_NO
        , BKG_NO
        , EDI_BKG_NO
        , OSCA_BKG_FLG
        , VVD_CD
        , REF_NO
        , FCNTR_FLG
        , OB_CNTR_FLG
        , BKG_CGO_TP_CD
        , CNTR_SEAL_NO
        , EDI_GATE_IO_CD
        , CNTR_FULL_STS_CD
        , MVMT_EDI_SGHT_CD
        , CALL_SGN_NO
        , RTY_KNT
        , MVMT_EDI_RMK 
		, VNDR_SEQ
        , BKG_KNT
        , CNTR_DMG_FLG
        , CHSS_NO
        , MGST_NO
        , DEST_YD_CD
        , LLOYD_NO
        , WO_NO
        , EDI_VVD_CD
        , TIR_NO
        , MTY_PLN_NO
        , MTY_REPO_NO
        , EDI_CRR_NO
        , TRSP_DOC_NO
		, CRNT_VSL_CD
        , CRNT_SKD_VOY_NO
        , CRNT_SKD_DIR_CD
        , CNMV_RMK        
        , MVMT_EDI_MSG_AREA_CD  
        , MVMT_EDI_MSG_SEQ      
        , MVMT_EDI_MSG_TP_ID    
        , MVMT_EDI_MSG_YRMONDY  
        , MVMT_EDI_TP_CD   
		, MVMT_TRSP_MOD_CD
        , OFC_CD
        , UPD_USR_ID
        , CRE_USR_ID   
		, CHK_FLG
		, USR_NM
		, CNMV_YR
		, CNMV_SEQ
		, CNMV_ID_NO
FROM (
            SELECT  CM.CNTR_NO
                    ,  TO_CHAR(NVL(EM.CRE_LOCL_DT, CM.CRE_LOCL_DT), 'YYYY-MM-DD HH24:MI') AS INP_DT
                    ,  DECODE(CM.MVMT_CRE_TP_CD, 'A', 'AUTO'
                    	,  DECODE(CM.MVMT_INP_TP_CD, 'MAN', 'MANUAL'
                    		,  DECODE(CM.MVMT_CRE_TP_CD, 'A', ''
								, DECODE(CM.MVMT_EDI_TP_CD, 'A1', '322', SUBSTR(EM.FLT_FILE_REF_NO, 1, 3))
									  )
                              	  )
                              ) AS INP_TP_CD 
                    ,  'O.K' AS STATUS
                    ,  CM.MVMT_STS_CD
                    ,  CM.MVMT_CRE_TP_CD           
                    ,  CM.ORG_YD_CD
                    ,  TO_CHAR (CM.CNMV_EVNT_DT, 'YYYY-MM-DD HH24:MI') AS CNMV_EVNT_DT
                    ,  CM.CNMV_CYC_NO AS CNMV_CYC_NO
                    ,  CM.BKG_NO
                    ,  NULL AS EDI_BKG_NO
                    ,  CM.OSCA_BKG_FLG        
                    ,  CM.CRNT_VSL_CD||CM.CRNT_SKD_VOY_NO||CM.CRNT_SKD_DIR_CD AS VVD_CD
                    ,  CM.MTY_PLN_NO AS REF_NO    
                    ,  CM.FCNTR_FLG
                    ,  CM.OB_CNTR_FLG
                    ,  CM.BKG_CGO_TP_CD
                    ,  TRIM (CM.CNTR_SEAL_NO) AS CNTR_SEAL_NO
                    , EM.EDI_GATE_IO_CD
                    , EM.CNTR_FULL_STS_CD
                    , EM.MVMT_EDI_SGHT_CD
                    , EM.CALL_SGN_NO
                    , EM.RTY_KNT
                    ,  EM.MVMT_EDI_RMK  AS MVMT_EDI_RMK                   
                    , TO_CHAR(CM.CNMV_EVNT_DT, 'YYYYMMDDHH24MISS')
                     ||TO_CHAR(CM.CNMV_YR, '0000')
                     ||TO_CHAR(CM.CNMV_SEQ, '0000')
                     ||NVL(CM.CNMV_SPLIT_NO, 'XX') AS SORT_KEY
					, EM.VNDR_SEQ
                    , EM.BKG_KNT
                    , EM.CNTR_DMG_FLG
                    , EM.CHSS_NO
                    , EM.MGST_NO
                    , EM.DEST_YD_CD
                    , EM.LLOYD_NO
                    , EM.WO_NO
                    , EM.EDI_VVD_CD
                    , EM.TIR_NO
                    , EM.MTY_PLN_NO
                    , EM.MTY_REPO_NO
                    , EM.EDI_CRR_NO
                    , EM.TRSP_DOC_NO             
					, EM.CRNT_VSL_CD
                    , EM.CRNT_SKD_VOY_NO
                    , EM.CRNT_SKD_DIR_CD
                    , EM.CNMV_RMK                    
                    , EM.MVMT_EDI_MSG_AREA_CD  
                    , EM.MVMT_EDI_MSG_SEQ      
                    , EM.MVMT_EDI_MSG_TP_ID    
                    , EM.MVMT_EDI_MSG_YRMONDY  
                    , EM.MVMT_EDI_TP_CD   
					, EM.MVMT_TRSP_MOD_CD
                    , CM.OFC_CD
                    , CM.UPD_USR_ID
                    , CM.CRE_USR_ID
					, 'N' AS CHK_FLG
					, TRIM(CM.USR_NM) AS USR_NM
					, CM.CNMV_YR
					, CM.CNMV_SEQ
					, CM.CNMV_ID_NO
            FROM CTM_MOVEMENT CM
                  , CTM_MVMT_EDI_MSG EM
                  , PARAM P
            WHERE CM.CNTR_NO = EM.CNTR_NO(+)
            AND    CM.MVMT_EDI_MSG_YRMONDY = EM.MVMT_EDI_MSG_YRMONDY(+)
            AND    CM.MVMT_EDI_MSG_SEQ     = EM.MVMT_EDI_MSG_SEQ(+)
            AND    P.CNTR_NO = CM.CNTR_NO
			AND     CM.CNMV_EVNT_DT BETWEEN TO_DATE(REPLACE (@[s_event_date1], '-', ''),'YYYYMMDD') AND TO_DATE(REPLACE (@[s_event_date2], '-', ''), 'YYYYMMDD')+ 0.99999
            UNION ALL
            SELECT  EM.CNTR_NO
                    ,  TO_CHAR (EM.CRE_LOCL_DT, 'YYYY-MM-DD HH24:MI') AS INP_DT
                    ,  SUBSTR(EM.FLT_FILE_REF_NO, 1, 3) AS INP_TP_CD 
                    ,  'ERROR' AS STATUS
                    ,  EM.EDI_MVMT_STS_CD
                    ,  NULL  AS MVMT_CRE_TP_CD           
                    ,  EM.EVNT_YD_CD AS ORG_YD_CD
                    ,  TO_CHAR (EM.EVNT_DT, 'YYYY-MM-DD HH24:MI') AS CNMV_EVNT_DT
                    ,  NULL AS CNMV_CYC_NO
                    ,  EM.BKG_NO
                    ,  EM.EDI_BKG_NO
                    ,  EM.OSCA_BKG_FLG        
                    ,  EM.CRNT_VSL_CD||EM.CRNT_SKD_VOY_NO||EM.CRNT_SKD_DIR_CD AS VVD_CD
                    ,  EM.MTY_PLN_NO AS REF_NO    
                    ,  DECODE(EM.CNTR_FULL_STS_CD, 'F', 'Y') AS FCNTR_FLG
                    ,  NULL AS OB_CNTR_FLG
                    ,  NULL AS BKG_CGO_TP_CD
                    ,  TRIM (EM.CNTR_SEAL_NO) AS CNTR_SEAL_NO
                    , EM.EDI_GATE_IO_CD
                    , EM.CNTR_FULL_STS_CD
                    , EM.MVMT_EDI_SGHT_CD
                    , EM.CALL_SGN_NO
                    , EM.RTY_KNT
                    , EM.MVMT_EDI_RMK
                    , TO_CHAR(EM.EVNT_DT, 'YYYYMMDDHH24MISS')
                     ||'0000'
                     ||'0000'
                     ||'XX' AS SORT_KEY
					, EM.VNDR_SEQ
                    , EM.BKG_KNT
                    , EM.CNTR_DMG_FLG
                    , EM.CHSS_NO
                    , EM.MGST_NO
                    , EM.DEST_YD_CD
                    , EM.LLOYD_NO
                    , EM.WO_NO
                    , EM.EDI_VVD_CD
                    , EM.TIR_NO
                    , EM.MTY_PLN_NO
                    , EM.MTY_REPO_NO
                    , EM.EDI_CRR_NO
                    , EM.TRSP_DOC_NO  
					, EM.CRNT_VSL_CD
                    , EM.CRNT_SKD_VOY_NO
                    , EM.CRNT_SKD_DIR_CD
                    , EM.CNMV_RMK                    
                    , EM.MVMT_EDI_MSG_AREA_CD  
                    , EM.MVMT_EDI_MSG_SEQ      
                    , EM.MVMT_EDI_MSG_TP_ID    
                    , EM.MVMT_EDI_MSG_YRMONDY  
                    , EM.MVMT_EDI_TP_CD     
					, EM.MVMT_TRSP_MOD_CD
                    , EM.OFC_CD
                    , EM.UPD_USR_ID
                    , EM.CRE_USR_ID
					, CASE WHEN EM.mvmt_edi_rmk = 'OK.PROCESSED' THEN 'N'
                           WHEN EM.mvmt_edi_rmk = 'The same data already existed!' THEN 'N'
                      ELSE
                           CASE WHEN SUBSTR(UPPER(EM.MVMT_EDI_RMK), 1, 7) = 'ALREADY' THEN 
                                'N'
                           ELSE
                                'Y'
                           END 
                      END  AS CHK_FLG
					, '' AS USR_NM
					, '' AS CNMV_YR
					, 0 AS CNMV_SEQ
					, 0 AS CNMV_ID_NO
            FROM CTM_MVMT_EDI_MSG EM, PARAM P
            WHERE 1 = 1
            AND    P.CNTR_NO = EM.CNTR_NO
            AND    EM.MVMT_EDI_RSLT_CD NOT IN ( 'Y', 'D')
			AND     EM.EVNT_DT BETWEEN TO_DATE(REPLACE (@[s_event_date1], '-', ''),'YYYYMMDD') AND TO_DATE(REPLACE (@[s_event_date2], '-', ''), 'YYYYMMDD')+ 0.99999
       )
ORDER BY SORT_KEY			]]></sql>
			<params>
				<param name="p_cntrno" type="12" value="" out="N"/>
				<param name="check_digit" type="12" value="" out="N"/>
				<param name="s_event_date1" type="12" value="" out="N"/>
				<param name="s_event_date2" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
