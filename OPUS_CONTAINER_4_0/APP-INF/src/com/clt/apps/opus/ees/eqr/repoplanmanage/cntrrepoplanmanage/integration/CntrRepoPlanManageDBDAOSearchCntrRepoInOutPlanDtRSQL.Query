<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CntrRepoPlanManageDBDAOSearchCntrRepoInOutPlanDtRSQL">
			<desc><![CDATA[<EES_EQR_0052 최적화된 REPO InOut 계획 수량 조회/수정>
EQR_VSL_LODG_DCHG_PLN, EQR_INLND_TRSP_PLN 테이블에서 in/out 정보 조회

<Change History>
1	2009.08.24	Lee ByoungHun	최초작성
2	2010.01.11	Lee ByoungHun	TypeBy가 ECC 이외의 경우에는 PLN_SEQ를 Group By에서 제외한다.]]></desc>
			<sql><![CDATA[
SELECT
    PLN_YRWK
    , TRSP_MOD_CD
    , VSL_LANE_CD
    , VVD
    , FM_ECC_CD FM_ECC_CD_TMP
    , FM_ETD_DT
    , TO_ECC_CD TO_ECC_CD_TMP
    , TO_ETA_DT
    , TS
    , '' TOTAL_VOL
    #foreach ($key in ${arrCntrTpszCd})
        ,SUM(DECODE ( CNTR_TPSZ_CD , '$key' , CNTR_QTY ))    ${key}CNTR_QTY
    #end
    , '' TOTAL_COST
    #foreach ($key in ${arrCntrTpszCd})
        ,SUM(DECODE ( CNTR_TPSZ_CD , '$key' , LODG_DCHG_COST_AMT))       ${key}LODG_DCHG_COST_AMT
    #end
    , REPO_PLN_ID
    , TABLENM
    , FM_ECC_CD
    , TO_ECC_CD
    , PAST_REPO_PLN_FLG
	-- ECC이외의 경우에는 PLN_SEQ를 Group By 에서 제외한다.
	#if ((${fmtoat2} == '1' && ${fmtypeby_2} == 'E' && ${totypeby_2} == 'E') || (${fmtoat2} == '2' && ${attypeby_2} == 'E'))
    	, PLN_SEQ
	#else
		, 0 PLN_SEQ
	#end
FROM (
    SELECT
        REPO_PLN_ID
        , PLN_YRWK
        , TRSP_MOD_CD
        , VSL_LANE_CD
        , VVD
        , FM_ETD_DT
        , TO_ETA_DT
        , TABLENM
        ,  ''
        , TS
        , PAST_REPO_PLN_FLG
        ,(
            SELECT
            #if (${fmtoat2} == '1')
                #if (${fmtypeby_2} == 'R')
                    RCC_CD
                #elseif (${fmtypeby_2} == 'C')
                    CNT_CD
                #elseif(${fmtypeby_2} == 'L')
                    LCC_CD
                #else
                    ECC_CD
                #end
            #else
                #if (${attypeby_2} == 'R')
                    RCC_CD
                #elseif (${attypeby_2} == 'C')
                    CNT_CD
                #elseif(${attypeby_2} == 'L')
                    LCC_CD
                #else
                    ECC_CD
                #end
            #end
            FROM EQR_ECC_MST
            WHERE FM_ECC_CD = ECC_CD
        ) FM_ECC_CD
        ,(
            SELECT
            #if (${fmtoat2} == '1')
                #if (${totypeby_2} == 'R')
                    RCC_CD
                #elseif (${totypeby_2} == 'C')
                    CNT_CD
                #elseif(${totypeby_2} == 'L')
                    LCC_CD
                #else
                    ECC_CD
                #end
            #else
                #if (${attypeby_2} == 'R')
                    RCC_CD
                #elseif (${attypeby_2} == 'C')
                    CNT_CD
                #elseif(${attypeby_2} == 'L')
                    LCC_CD
                #else
                    ECC_CD
                #end
            #end
            FROM EQR_ECC_MST
            WHERE TO_ECC_CD = ECC_CD
        ) TO_ECC_CD
        , CNTR_TPSZ_CD
        , CNTR_QTY
        , LODG_DCHG_COST_AMT
        , UPD_USR_ID
        , UPD_DT
        , CRE_DT
        , ROW_NUMBER() OVER (
            PARTITION BY
                PLN_YRWK
                , TRSP_MOD_CD
                , VSL_LANE_CD
                , VVD
                , FM_ECC_CD
                , FM_ETD_DT
                , TO_ECC_CD
                , TO_ETA_DT
                , CNTR_TPSZ_CD
            ORDER BY ROWNUM
        ) RUMM
        , PLN_SEQ
    FROM (
        SELECT
            PLN.REPO_PLN_ID
            , PLN.PLN_YRWK
            , TRSP_MOD_CD
            , VSL_LANE_CD
            , VSL_CD||SKD_VOY_NO||SKD_DIR_CD VVD
            , FM_ECC_CD
            , TO_ECC_CD
            , TO_CHAR(FM_ETD_DT,'YYYY-MM-DD HH24:MI:SS', 'NLS_DATE_LANGUAGE=AMERICAN') FM_ETD_DT
            , TO_CHAR(TO_ETB_DT,'YYYY-MM-DD HH24:MI:SS', 'NLS_DATE_LANGUAGE=AMERICAN') TO_ETA_DT
            , 'EQR_VSL_LODG_DCHG_PLN' TABLENM
            , LDIS_TS_FLG  TS
            , PAST_REPO_PLN_FLG
            , CNTR_TPSZ_CD
            , CNTR_QTY
            , LODG_DCHG_COST_AMT
            , PLN.UPD_USR_ID
            , PLN.UPD_DT
            , PLN.CRE_DT
            , PLN.PLN_SEQ
        FROM
            EQR_VSL_LODG_DCHG_PLN PLN
            , EQR_VSL_LODG_DCHG_PLN_QTY QTY
            #if (${fmtoat2} == '1')
                ,(SELECT ECC_CD FROM EQR_ECC_MST WHERE 1 = 1
                #if ($arrFmEccCd.size() > 0)
                    #if (${fmtype_2} == 'R')
                        AND RCC_CD
                    #elseif (${fmtype_2} == 'L')
                        AND LCC_CD
                    #else
                        AND ECC_CD
                    #end
                    IN(
                        #foreach ($key in ${arrFmEccCd})
                            #if($velocityCount < $arrFmEccCd.size())
                            '$key',
                            #else
                            '$key'
                            #end
                        #end
                    )) C,
                #else
                    ) C,
                #end
            #else
                #if ($arrAtEccCd.size() > 0)
                ,(SELECT ECC_CD FROM EQR_ECC_MST WHERE 1 = 1
                    #if (${attype_2} == 'R')
                        AND RCC_CD
                    #elseif (${attype_2} == 'L')
                        AND LCC_CD
                    #else
                        AND ECC_CD
                    #end
                    IN(
                        #foreach ($key in ${arrAtEccCd})
                            #if($velocityCount < $arrAtEccCd.size())
                            '$key',
                            #else
                            '$key'
                            #end
                        #end
                    )) C
                #end
            #end
            #if (${fmtoat2} == '1')
                (SELECT ECC_CD FROM EQR_ECC_MST WHERE 1 = 1
                #if ($arrToEccCd.size() > 0)
                    #if (${totype_2} == 'R')
                        AND RCC_CD
                    #elseif (${totype_2} == 'L')
                        AND LCC_CD
                    #else
                        AND ECC_CD
                    #end
                    IN(
                        #foreach ($key in ${arrToEccCd})
                            #if($velocityCount < $arrToEccCd.size())
                            '$key',
                            #else
                            '$key'
                            #end
                        #end
                    )) D
                #else
                    ) D
                #end
            #end
        WHERE
            PLN.REPO_PLN_ID = @[repo_pln_Id]
            AND PLN.REPO_PLN_ID = QTY.REPO_PLN_ID
            AND PLN.PLN_YRWK = QTY.PLN_YRWK
            AND PLN.PLN_SEQ = QTY.PLN_SEQ
            #if (${item_2} != '' && $arrItem.size() > 0)
                AND TRSP_MOD_CD IN (
                    #foreach ($key in ${arrItem})
                        #if($velocityCount < $arrItem.size())
                        '$key',
                        #else
                        '$key'
                        #end
                    #end
                )
            #end
            #if (${lane_2} != '' && $arrIane.size() > 0)
                AND VSL_LANE_CD IN (
                    #foreach ($key in ${arrIane})
                        #if($velocityCount < $arrIane.size())
                        '$key',
                        #else
                        '$key'
                        #end
                    #end
                )
            #end
            #if (${vvd_2} != '' && $arrVvd.size() > 0)
                AND VSL_CD||SKD_VOY_NO||SKD_DIR_CD IN (
                    #foreach ($key in ${arrVvd})
                        #if($velocityCount < $arrVvd.size())
                        '$key',
                        #else
                        '$key'
                        #end
                    #end
                )
            #end
            #if (${fmtoat2} == '1')
                AND FM_ECC_CD = C.ECC_CD AND TO_ECC_CD = D.ECC_CD
            #else
                #if (${attype_2} != '')
                    AND (FM_ECC_CD = C.ECC_CD OR TO_ECC_CD = C.ECC_CD)
                #end
            #end
            AND (
                #if (${fmtoat2} == '1')
                    #if (${fmFmPlnYrWk} != '')
                        PLN.PLN_YRWK BETWEEN @[fmFmPlnYrWk] AND @[fmToPlnYrWk]
                    #end
                    #if (${toFmPlnYrWk} != '')
                        #if (${fmFmPlnYrWk} != '')
                            AND
                        #end
                        TO_CHAR(TO_ETB_DT,'YYYYMMDD') BETWEEN
                        (SELECT WK_ST_DT FROM EQR_WK_PRD WHERE PLN_YR || PLN_WK = @[toFmPlnYrWk] )
                        AND
                        (SELECT WK_END_DT FROM EQR_WK_PRD WHERE PLN_YR || PLN_WK = @[toToPlnYrWk] )
                    #end
                #else
                    PLN.PLN_YRWK BETWEEN @[fmFmPlnYrWk] AND @[fmToPlnYrWk]
                    OR TO_CHAR(TO_ETB_DT,'YYYYMMDD') BETWEEN
                    (SELECT WK_ST_DT FROM EQR_WK_PRD WHERE PLN_YR || PLN_WK = @[toFmPlnYrWk] )
                    AND
                    (SELECT WK_END_DT FROM EQR_WK_PRD WHERE PLN_YR || PLN_WK = @[toToPlnYrWk] )
                #end
            )
        #if ($arrCntrTpszCd.size() > 0)
            AND CNTR_TPSZ_CD IN(
            #foreach ($key in ${arrCntrTpszCd})
                #if($velocityCount < $arrCntrTpszCd.size())
                '$key',
                #else
                '$key'
                #end
            #end
            )
        #end
        ORDER BY
            PLN_YRWK DESC
    ) E
)
GROUP BY
    RUMM
    , REPO_PLN_ID
    , PLN_YRWK
    , TRSP_MOD_CD
    , VSL_LANE_CD
    , VVD
    , FM_ECC_CD
    , FM_ETD_DT
    , TO_ECC_CD
    , TO_ETA_DT
    , TABLENM
    , TS
    , PAST_REPO_PLN_FLG
	-- ECC이외의 경우에는 PLN_SEQ를 Group By 에서 제외한다.
	#if ((${fmtoat2} == '1' && ${fmtypeby_2} == 'E' && ${totypeby_2} == 'E') || (${fmtoat2} == '2' && ${attypeby_2} == 'E'))
    	, PLN_SEQ
	#end

UNION ALL

SELECT
    PLN_YRWK
    , TRSP_MOD_CD
    , VSL_LANE_CD
    , VVD
    , FM_ECC_CD FM_ECC_CD_TMP
    , FM_ETD_DT
    , TO_ECC_CD TO_ECC_CD_TMP
    , TO_ETA_DT
    , TS
    , '' TOTAL_VOL
    #foreach ($key in ${arrCntrTpszCd})
        ,SUM(DECODE ( CNTR_TPSZ_CD , '$key' , CNTR_QTY ))    ${key}CNTR_QTY
    #end
    , '' TOTAL_COST
    #foreach ($key in ${arrCntrTpszCd})
        ,SUM(DECODE ( CNTR_TPSZ_CD , '$key' , TRSP_COST_AMT))       ${key}LODG_DCHG_COST_AMT
    #end
    , REPO_PLN_ID
    , TABLENM
    , FM_ECC_CD
    , TO_ECC_CD
    , PAST_REPO_PLN_FLG
	-- ECC이외의 경우에는 PLN_SEQ를 Group By 에서 제외한다.
	#if ((${fmtoat2} == '1' && ${fmtypeby_2} == 'E' && ${totypeby_2} == 'E') || (${fmtoat2} == '2' && ${attypeby_2} == 'E'))
    	, PLN_SEQ
	#else
		, 0 PLN_SEQ
	#end
FROM (
    SELECT
        REPO_PLN_ID
        , PLN_YRWK
        , TRSP_MOD_CD
        , VSL_LANE_CD
        , VVD
        , FM_ETD_DT
        , TO_ETA_DT
        , TABLENM
        , TS
        , PAST_REPO_PLN_FLG
        ,(
        SELECT
        #if (${fmtoat2} == '1')
            #if (${fmtypeby_2} == 'R')
                RCC_CD
            #elseif (${fmtypeby_2} == 'C')
                CNT_CD
            #elseif(${fmtypeby_2} == 'L')
                LCC_CD
            #else
                ECC_CD
            #end
        #else
            #if (${attypeby_2} == 'R')
                RCC_CD
            #elseif (${attypeby_2} == 'C')
                CNT_CD
            #elseif(${attypeby_2} == 'L')
                LCC_CD
            #else
                ECC_CD
            #end
        #end
            FROM EQR_ECC_MST
            WHERE FM_ECC_CD = ECC_CD
        ) FM_ECC_CD
        ,(
            SELECT
            #if (${fmtoat2} == '1')
                #if (${totypeby_2} == 'R')
                    RCC_CD
                #elseif (${totypeby_2} == 'C')
                    CNT_CD
                #elseif(${totypeby_2} == 'L')
                    LCC_CD
                #else
                    ECC_CD
                #end
            #else
                #if (${attypeby_2} == 'R')
                    RCC_CD
                #elseif (${attypeby_2} == 'C')
                    CNT_CD
                #elseif(${attypeby_2} == 'L')
                    LCC_CD
                #else
                    ECC_CD
                #end
            #end
            FROM EQR_ECC_MST
            WHERE TO_ECC_CD = ECC_CD
        ) TO_ECC_CD
        , CNTR_TPSZ_CD
        , CNTR_QTY
        , TRSP_COST_AMT
        , UPD_USR_ID
        , UPD_DT
        , CRE_DT
        , ROW_NUMBER() OVER (
            PARTITION BY
                PLN_YRWK
                , TRSP_MOD_CD
                , VSL_LANE_CD
                , VVD
                , FM_ECC_CD
                , FM_ETD_DT
                , TO_ECC_CD
                , TO_ETA_DT
                , CNTR_TPSZ_CD
                , PAST_REPO_PLN_FLG
            ORDER BY ROWNUM
        ) RUMM
        , PLN_SEQ
    FROM (
        SELECT
            PLN.REPO_PLN_ID
            , PLN.PLN_YRWK
            , TRSP_MOD_CD
            , '' VSL_LANE_CD
            , '' VVD
            , FM_ECC_CD
            , TO_ECC_CD
            , FM_YRWK 		FM_ETD_DT
            , TO_YRWK 		TO_ETA_DT
            , 'EQR_INLND_TRSP_PLN' TABLENM
            , '' TS
            , PAST_REPO_PLN_FLG
            , CNTR_TPSZ_CD
            , CNTR_QTY
            , TRSP_COST_AMT
            , PLN.UPD_USR_ID
            , PLN.UPD_DT
            , PLN.CRE_DT
            , PLN.PLN_SEQ
        FROM
            EQR_INLND_TRSP_PLN PLN
            , EQR_INLND_TRSP_PLN_QTY QTY
            #if (${fmtoat2} == '1')
                ,(SELECT ECC_CD FROM EQR_ECC_MST WHERE 1 = 1
                #if ($arrFmEccCd.size() > 0)
                    #if (${fmtype_2} == 'R')
                        AND RCC_CD
                    #elseif (${fmtype_2} == 'L')
                        AND LCC_CD
                    #else
                        AND ECC_CD
                    #end
                    IN(
                        #foreach ($key in ${arrFmEccCd})
                            #if($velocityCount < $arrFmEccCd.size())
                            '$key',
                            #else
                            '$key'
                            #end
                        #end
                    )) C,
                #else
                    ) C,
                #end
            #else
                #if ($arrAtEccCd.size() > 0)
                ,(SELECT ECC_CD FROM EQR_ECC_MST WHERE 1 = 1
                    #if (${attype_2} == 'R')
                        AND RCC_CD
                    #elseif (${attype_2} == 'L')
                        AND LCC_CD
                    #else
                        AND ECC_CD
                    #end
                    IN(
                        #foreach ($key in ${arrAtEccCd})
                            #if($velocityCount < $arrAtEccCd.size())
                            '$key',
                            #else
                            '$key'
                            #end
                        #end
                    )) C
                #end
            #end
            #if (${fmtoat2} == '1')
                (SELECT ECC_CD FROM EQR_ECC_MST WHERE 1 = 1
                #if ($arrToEccCd.size() > 0)
                    #if (${totype_2} == 'R')
                        AND RCC_CD
                    #elseif (${totype_2} == 'L')
                        AND LCC_CD
                    #else
                        AND ECC_CD
                    #end
                    IN(
                        #foreach ($key in ${arrToEccCd})
                            #if($velocityCount < $arrToEccCd.size())
                            '$key',
                            #else
                            '$key'
                            #end
                        #end
                    )) D
                #else
                    ) D
                #end
            #end
        WHERE
            PLN.REPO_PLN_ID = @[repo_pln_Id]
            AND PLN.REPO_PLN_ID = QTY.REPO_PLN_ID
            AND PLN.PLN_YRWK = QTY.PLN_YRWK
            AND PLN.PLN_SEQ = QTY.PLN_SEQ
            #if (${item_2} != '' && $arrItem.size() > 0)
                AND TRSP_MOD_CD IN (
                    #foreach ($key in ${arrItem})
                        #if($velocityCount < $arrItem.size())
                        '$key',
                        #else
                        '$key'
                        #end
                    #end
                )
            #end
            #if (${lane_2} != '')
                AND 1 = 2
            #end
            #if (${vvd_2} != '')
                AND 1 = 2
            #end
            #if (${fmtoat2} == '1')
                AND FM_ECC_CD = C.ECC_CD AND TO_ECC_CD = D.ECC_CD
            #else
                #if (${attype_2} != '')
                    AND (FM_ECC_CD = C.ECC_CD OR TO_ECC_CD = C.ECC_CD)
                #end
            #end
            AND (
                #if (${fmtoat2} == '1')
                    #if (${fmFmPlnYrWk} != '')
                        PLN.PLN_YRWK BETWEEN @[fmFmPlnYrWk] AND @[fmToPlnYrWk]
                    #end
                    #if (${toFmPlnYrWk} != '')
                        #if (${fmFmPlnYrWk} != '')
                            AND
                        #end
                        TO_YRWK BETWEEN @[toFmPlnYrWk] AND @[toToPlnYrWk]
                    #end
                #else
                    PLN.PLN_YRWK BETWEEN @[fmFmPlnYrWk] AND @[fmToPlnYrWk]
                    OR TO_YRWK BETWEEN @[toFmPlnYrWk] AND @[toToPlnYrWk]
                #end
            )
            #if ($arrCntrTpszCd.size() > 0)
                AND CNTR_TPSZ_CD IN(
                #foreach ($key in ${arrCntrTpszCd})
                    #if($velocityCount < $arrCntrTpszCd.size())
                    '$key',
                    #else
                    '$key'
                    #end
                #end
                )
            #end
        ORDER BY
            PLN_YRWK DESC
    ) E
)
GROUP BY
    RUMM
    , REPO_PLN_ID
    , PLN_YRWK
    , TRSP_MOD_CD
    , VSL_LANE_CD
    , VVD
    , FM_ECC_CD
    , FM_ETD_DT
    , TO_ECC_CD
    , TO_ETA_DT
    , TABLENM
    , TS
    , PAST_REPO_PLN_FLG
	-- ECC이외의 경우에는 PLN_SEQ를 Group By 에서 제외한다.
	#if ((${fmtoat2} == '1' && ${fmtypeby_2} == 'E' && ${totypeby_2} == 'E') || (${fmtoat2} == '2' && ${attypeby_2} == 'E'))
    	, PLN_SEQ
	#end
ORDER BY
    PLN_YRWK
    , TRSP_MOD_CD
    , VSL_LANE_CD
    , VVD
    , FM_ECC_CD
    , TO_ECC_CD			]]></sql>
			<params>
				<param name="repo_pln_Id" type="12" value="" out="N"/>
				<param name="fmFmPlnYrWk" type="12" value="" out="N"/>
				<param name="fmToPlnYrWk" type="12" value="" out="N"/>
				<param name="toFmPlnYrWk" type="12" value="" out="N"/>
				<param name="toToPlnYrWk" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
