<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CgmSendDBDAOsearchChassisShipMentFlatFileRSQL">
			<desc><![CDATA[CgmSendDBDAOsearchChassisShipMentFlatFileRSQL]]></desc>
			<sql><![CDATA[
WITH PARAM AS 
/* INBOUND */
  (SELECT 'IM' IMEX,
               BK.BL_NO,
               TO_CHAR(GLOBALDATE_PKG.TIME_CONV_OFC_FNC(BK.BKG_OFC_CD, BK.BKG_CRE_DT, 'GMT'), 'YYYYMMDDHH24MI') BL_DT,
               BK.BKG_NO BKG_NO,
               '' BKG_DT,
               ' ' TRANS_TP,
               (CASE WHEN (SELECT DECODE(MAX(BT.BKG_NO), NULL, 'MH' , 'CH')
                                   FROM BKG_TRO BT
                                  WHERE BT.BKG_NO = BK.BKG_NO
                                    AND BT.IO_BND_CD = 'I') = 'CH' THEN 'CH'
                    WHEN BK.DE_TERM_CD = 'D' THEN 'CH'
               ELSE 'MH' 
               END) MD,
               TO_CHAR(VS.VPS_ETA_DT, 'YYYYMMDDHH24MI') ETA,
               TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC(BK.POD_CD, VS.VPS_ETA_DT, 'GMT'), 'YYYYMMDDHH24MI') ETA_GMT,
               '' ETD,
               '' ETD_GMT,
               BK.POD_CD ARR_LOC,
               '' DEP_LOC,
               BC.CNTR_NO CNTR_NO,
               SUBSTR(BC.CNTR_NO, 11, 1) CNTR_CHK,
               BC.CNTR_TPSZ_CD CNTR_TP,
               (SELECT BCU.CUST_CNT_CD||TRIM(TO_CHAR(BCU.CUST_SEQ, 'FM000000'))
                  FROM BKG_CUSTOMER BCU
                 WHERE BK.BKG_NO = BCU.BKG_NO
                   AND BCU.BKG_CUST_TP_CD = 'S') SHPR_CD,
               (SELECT BCU.CUST_NM
                  FROM BKG_CUSTOMER BCU
                 WHERE BK.BKG_NO = BCU.BKG_NO
                   AND BCU.BKG_CUST_TP_CD = 'S') SHPR_NM,
               (SELECT BCU.CUST_CNT_CD||TRIM(TO_CHAR(BCU.CUST_SEQ, 'FM000000'))
                  FROM BKG_CUSTOMER BCU
                 WHERE BK.BKG_NO = BCU.BKG_NO
                   AND BCU.BKG_CUST_TP_CD = 'F') FW_CD,
               (SELECT BCU.CUST_NM
                  FROM BKG_CUSTOMER BCU
                 WHERE BK.BKG_NO = BCU.BKG_NO
                   AND BCU.BKG_CUST_TP_CD = 'F') FW_NM,
               (SELECT BCU.CUST_CNT_CD||TRIM(TO_CHAR(BCU.CUST_SEQ, 'FM000000'))
                  FROM BKG_CUSTOMER BCU
                 WHERE BK.BKG_NO = BCU.BKG_NO
                   AND BCU.BKG_CUST_TP_CD = 'C') CNEE_CD,
               (SELECT BCU.CUST_NM
                  FROM BKG_CUSTOMER BCU
                 WHERE BK.BKG_NO = BCU.BKG_NO
                   AND BCU.BKG_CUST_TP_CD = 'C') CNEE_NM,
               BK.POD_CD DEST_IM,
               '' DEST_EX,
               BK.FULL_PKUP_YD_CD EQREL,
               '' EQRTN,
               BK.SLAN_CD POD_SVC,
               '' POL_SVC,
               BK.VSL_CD POD_VSL,
               '' POL_VSL,
               BK.SKD_VOY_NO POD_VOY,
               '' POL_VOY,
               DECODE(BK.SC_NO, NULL, NVL(BK.RFA_NO, BK.TAA_NO), BK.SC_NO) CONTRACT,
               CD.NOD_CD
          FROM BKG_BOOKING BK,
               BKG_CONTAINER BC,
               BKG_VVD BV,
               VSK_VSL_PORT_SKD VS,
               SCE_COP_HDR CH,
               SCE_COP_DTL CD
         WHERE 1 = 1
           AND BK.BKG_NO = BC.BKG_NO
           AND BK.POD_CD = BV.POD_CD
           AND BK.BKG_NO = BV.BKG_NO
           AND BV.VSL_CD = VS.VSL_CD
           AND BV.SKD_VOY_NO = VS.SKD_VOY_NO
           AND BV.SKD_DIR_CD = VS.SKD_DIR_CD
           AND BV.POD_CD = VS.VPS_PORT_CD
           AND BV.POD_CLPT_IND_SEQ = VS.CLPT_IND_SEQ
           AND BC.BKG_NO = CH.BKG_NO
           AND BC.CNTR_NO = CH.CNTR_NO
           AND CH.COP_NO = CD.COP_NO
           AND BV.VSL_PRE_PST_CD = 'T'
           AND BK.POD_CD LIKE 'US%'
           AND BK.BKG_STS_CD <> 'X'
           AND BK.BKG_CGO_TP_CD = 'F'
           AND CD.ACT_CD IN ('FITYAD',
                       'FITYDO',
                       'FITSAD',
                       'FITMAD',
                       'FITMDO',
                       'FITRAD',
                       'FITRDO',
                       'FITZAD')
           AND VS.VPS_ETA_DT BETWEEN TRUNC(SYSDATE)- 7 AND TRUNC(SYSDATE) + 0.99999  
         UNION
SELECT 'IM' IMEX,
               BK.BL_NO,
               TO_CHAR(GLOBALDATE_PKG.TIME_CONV_OFC_FNC(BK.BKG_OFC_CD, BK.BKG_CRE_DT, 'GMT'), 'YYYYMMDDHH24MI') BL_DT,
               BK.BKG_NO BKG_NO,
               '' BKG_DT,
               ' ' TRANS_TP,
               (CASE WHEN (SELECT DECODE(MAX(BT.BKG_NO), NULL, 'MH' , 'CH')
                                   FROM BKG_TRO BT
                                  WHERE BT.BKG_NO = BK.BKG_NO
                                    AND BT.IO_BND_CD = 'I') = 'CH' THEN 'CH'
                    WHEN BK.DE_TERM_CD = 'D' THEN 'CH'
               ELSE 'MH' 
               END) MD,
               TO_CHAR(VS.VPS_ETA_DT, 'YYYYMMDDHH24MI') ETA,
               TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC(BK.POD_CD, VS.VPS_ETA_DT, 'GMT'), 'YYYYMMDDHH24MI') ETA_GMT,
               '' ETD,
               '' ETD_GMT,
               BK.POD_CD ARR_LOC,
               '' DEP_LOC,
               BC.CNTR_NO CNTR_NO,
               SUBSTR(BC.CNTR_NO, 11, 1) CNTR_CHK,
               BC.CNTR_TPSZ_CD CNTR_TP,
               (SELECT BCU.CUST_CNT_CD||TRIM(TO_CHAR(BCU.CUST_SEQ, 'FM000000'))
                  FROM BKG_CUSTOMER BCU
                 WHERE BK.BKG_NO = BCU.BKG_NO
                   AND BCU.BKG_CUST_TP_CD = 'S') SHPR_CD,
               (SELECT BCU.CUST_NM
                  FROM BKG_CUSTOMER BCU
                 WHERE BK.BKG_NO = BCU.BKG_NO
                   AND BCU.BKG_CUST_TP_CD = 'S') SHPR_NM,
               (SELECT BCU.CUST_CNT_CD||TRIM(TO_CHAR(BCU.CUST_SEQ, 'FM000000'))
                  FROM BKG_CUSTOMER BCU
                 WHERE BK.BKG_NO = BCU.BKG_NO
                   AND BCU.BKG_CUST_TP_CD = 'F') FW_CD,
               (SELECT BCU.CUST_NM
                  FROM BKG_CUSTOMER BCU
                 WHERE BK.BKG_NO = BCU.BKG_NO
                   AND BCU.BKG_CUST_TP_CD = 'F') FW_NM,
               (SELECT BCU.CUST_CNT_CD||TRIM(TO_CHAR(BCU.CUST_SEQ, 'FM000000'))
                  FROM BKG_CUSTOMER BCU
                 WHERE BK.BKG_NO = BCU.BKG_NO
                   AND BCU.BKG_CUST_TP_CD = 'C') CNEE_CD,
               (SELECT BCU.CUST_NM
                  FROM BKG_CUSTOMER BCU
                 WHERE BK.BKG_NO = BCU.BKG_NO
                   AND BCU.BKG_CUST_TP_CD = 'C') CNEE_NM,
               BK.POD_CD DEST_IM,
               '' DEST_EX,
               BK.FULL_PKUP_YD_CD EQREL,
               '' EQRTN,
               BK.SLAN_CD POD_SVC,
               '' POL_SVC,
               BK.VSL_CD POD_VSL,
               '' POL_VSL,
               BK.SKD_VOY_NO POD_VOY,
               '' POL_VOY,
               DECODE(BK.SC_NO, NULL, NVL(BK.RFA_NO, BK.TAA_NO), BK.SC_NO) CONTRACT,
               CD.NOD_CD
          FROM BKG_BOOKING BK,
               BKG_CONTAINER BC,
               BKG_VVD BV,
               VSK_VSL_PORT_SKD VS,
               SCE_COP_HDR CH,
               SCE_COP_DTL CD
         WHERE 1 = 1
           AND BK.BKG_NO = BC.BKG_NO
           AND BK.POD_CD = BV.POD_CD
           AND BK.BKG_NO = BV.BKG_NO
           AND BV.VSL_CD = VS.VSL_CD
           AND BV.SKD_VOY_NO = VS.SKD_VOY_NO
           AND BV.SKD_DIR_CD = VS.SKD_DIR_CD
           AND BV.POD_CD = VS.VPS_PORT_CD
           AND BV.POD_CLPT_IND_SEQ = VS.CLPT_IND_SEQ
           AND BC.BKG_NO = CH.BKG_NO
           AND BC.CNTR_NO = CH.CNTR_NO
           AND CH.COP_NO = CD.COP_NO
           AND BV.VSL_PRE_PST_CD = 'T'
           AND BK.DEL_CD LIKE 'US%'
           AND BK.BKG_STS_CD <> 'X'
           AND BK.BKG_CGO_TP_CD = 'F'
           AND CD.ACT_CD IN ('FITYAD',
                       'FITYDO',
                       'FITSAD',
                       'FITMAD',
                       'FITMDO',
                       'FITRAD',
                       'FITRDO',
                       'FITZAD')
          AND VS.VPS_ETA_DT BETWEEN TRUNC(SYSDATE)- 7 AND TRUNC(SYSDATE) + 0.99999
         UNION 
/* OUTBOUND */
SELECT 'EX' IMEX,
               '' BL_NO,
               '' BL_DT,
               BK.BKG_NO,
               TO_CHAR(GLOBALDATE_PKG.TIME_CONV_OFC_FNC(BK.BKG_OFC_CD, BK.BKG_CRE_DT, 'GMT'), 'YYYYMMDDHH24MI') BKG_DT,
               ' ' TRANS_TP,
               (CASE WHEN (SELECT DECODE(MAX(BT.BKG_NO), NULL, 'MH' , 'CH')
                                   FROM BKG_TRO BT
                                  WHERE BT.BKG_NO = BK.BKG_NO
                                    AND BT.IO_BND_CD = 'O') = 'CH' THEN 'CH'
                    WHEN BK.RCV_TERM_CD = 'D' THEN 'CH'
               ELSE 'MH' 
               END) MD,
               '' ETA,
               '' ETA_GMT,
               TO_CHAR(VS.VPS_ETD_DT, 'YYYYMMDDHH24MI') ETD,
               TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC(BK.POL_CD, VS.VPS_ETD_DT, 'GMT'), 'YYYYMMDDHH24MI') ETD_GMT,
               '' ARR_LOC,
               BK.POL_CD DEP_LOC,
               BC.CNTR_NO CNTR_NO,
               SUBSTR(BC.CNTR_NO, 11, 1) CNTR_CHK,
               BC.CNTR_TPSZ_CD CNTR_TP,
               (SELECT BCU.CUST_CNT_CD||TRIM(TO_CHAR(BCU.CUST_SEQ, 'FM000000'))
                  FROM BKG_CUSTOMER BCU
                 WHERE BK.BKG_NO = BCU.BKG_NO
                   AND BCU.BKG_CUST_TP_CD = 'S') SHPR_CD,
               (SELECT BCU.CUST_NM
                  FROM BKG_CUSTOMER BCU
                 WHERE BK.BKG_NO = BCU.BKG_NO
                   AND BCU.BKG_CUST_TP_CD = 'S') SHPR_NM,
               (SELECT BCU.CUST_CNT_CD||TRIM(TO_CHAR(BCU.CUST_SEQ, 'FM000000'))
                  FROM BKG_CUSTOMER BCU
                 WHERE BK.BKG_NO = BCU.BKG_NO
                   AND BCU.BKG_CUST_TP_CD = 'F') FW_CD,
               (SELECT BCU.CUST_NM
                  FROM BKG_CUSTOMER BCU
                 WHERE BK.BKG_NO = BCU.BKG_NO
                   AND BCU.BKG_CUST_TP_CD = 'F') FW_NM,
               (SELECT BCU.CUST_CNT_CD||TRIM(TO_CHAR(BCU.CUST_SEQ, 'FM000000'))
                  FROM BKG_CUSTOMER BCU
                 WHERE BK.BKG_NO = BCU.BKG_NO
                   AND BCU.BKG_CUST_TP_CD = 'C') CNEE_CD,
               (SELECT BCU.CUST_NM
                  FROM BKG_CUSTOMER BCU
                 WHERE BK.BKG_NO = BCU.BKG_NO
                   AND BCU.BKG_CUST_TP_CD = 'C') CNEE_NM,
               '' DEST_IM,
               BK.POL_CD DEST_EX,
               '' EQREL,
               BK.FULL_RTN_YD_CD EQRTN,
               '' POD_SVC,
               BK.SLAN_CD POL_SVC,
               '' POD_VSL,
               BK.VSL_CD POL_VSL,
               '' POD_VOY,
               BK.SKD_VOY_NO POL_VOY,
               DECODE(BK.SC_NO, NULL, NVL(BK.RFA_NO, BK.TAA_NO), BK.SC_NO) CONTRACT,
               CD.NOD_CD
          FROM BKG_BOOKING BK,
               BKG_CONTAINER BC,
               BKG_VVD BV,
               VSK_VSL_PORT_SKD VS,
               SCE_COP_HDR CH,
               SCE_COP_DTL CD -- CGM_POOL_LOC_MTCH 
         WHERE 1 = 1
           AND BK.BKG_NO = BC.BKG_NO
           AND BK.POL_CD = BV.POL_CD
           AND BK.BKG_NO = BV.BKG_NO
           AND BV.VSL_CD = VS.VSL_CD(+)
           AND BV.SKD_VOY_NO = VS.SKD_VOY_NO(+)
           AND BV.SKD_DIR_CD = VS.SKD_DIR_CD(+)
           AND BV.POL_CD = VS.VPS_PORT_CD(+)
           AND BV.POL_CLPT_IND_SEQ = VS.CLPT_IND_SEQ(+)
           AND BC.BKG_NO = CH.BKG_NO
           AND BC.CNTR_NO = CH.CNTR_NO
           AND CH.COP_NO = CD.COP_NO
           AND BV.VSL_PRE_PST_CD = 'T'
           AND BK.POR_CD LIKE 'US%'
           AND BK.BKG_STS_CD <> 'X'
           AND BK.BKG_CGO_TP_CD = 'F'
           AND CD.ACT_CD IN ('FOTRAD',
                       'FOTRDO',
                       'FOTMAD',
                       'FOTMDO',
                       'FOTSDO',
                       'FOTYAD',
                       'FOTYDO',
                       'MOTZAD')
           AND DECODE(BK.BKG_STS_CD, 'A', TRUNC(SYSDATE) , VS.VPS_ETD_DT) >= TRUNC(SYSDATE)
         UNION
SELECT 'EX' IMEX,
               '' BL_NO,
               '' BL_DT,
               BK.BKG_NO,
               TO_CHAR(GLOBALDATE_PKG.TIME_CONV_OFC_FNC(BK.BKG_OFC_CD, BK.BKG_CRE_DT, 'GMT'), 'YYYYMMDDHH24MI') BKG_DT,
               ' ' TRANS_TP,
               (CASE WHEN (SELECT DECODE(MAX(BT.BKG_NO), NULL, 'MH' , 'CH')
                                   FROM BKG_TRO BT
                                  WHERE BT.BKG_NO = BK.BKG_NO
                                    AND BT.IO_BND_CD = 'O') = 'CH' THEN 'CH'
                    WHEN BK.RCV_TERM_CD = 'D' THEN 'CH'
               ELSE 'MH' 
               END) MD,
               '' ETA,
               '' ETA_GMT,
               TO_CHAR(VS.VPS_ETD_DT, 'YYYYMMDDHH24MI') ETD,
               TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC(BK.POL_CD, VS.VPS_ETD_DT, 'GMT'), 'YYYYMMDDHH24MI') ETD_GMT,
               '' ARR_LOC,
               BK.POL_CD DEP_LOC,
               BC.CNTR_NO CNTR_NO,
               SUBSTR(BC.CNTR_NO, 11, 1) CNTR_CHK,
               BC.CNTR_TPSZ_CD CNTR_TP,
               (SELECT BCU.CUST_CNT_CD||TRIM(TO_CHAR(BCU.CUST_SEQ, 'FM000000'))
                  FROM BKG_CUSTOMER BCU
                 WHERE BK.BKG_NO = BCU.BKG_NO
                   AND BCU.BKG_CUST_TP_CD = 'S') SHPR_CD,
               (SELECT BCU.CUST_NM
                  FROM BKG_CUSTOMER BCU
                 WHERE BK.BKG_NO = BCU.BKG_NO
                   AND BCU.BKG_CUST_TP_CD = 'S') SHPR_NM,
               (SELECT BCU.CUST_CNT_CD||TRIM(TO_CHAR(BCU.CUST_SEQ, 'FM000000'))
                  FROM BKG_CUSTOMER BCU
                 WHERE BK.BKG_NO = BCU.BKG_NO
                   AND BCU.BKG_CUST_TP_CD = 'F') FW_CD,
               (SELECT BCU.CUST_NM
                  FROM BKG_CUSTOMER BCU
                 WHERE BK.BKG_NO = BCU.BKG_NO
                   AND BCU.BKG_CUST_TP_CD = 'F') FW_NM,
               (SELECT BCU.CUST_CNT_CD||TRIM(TO_CHAR(BCU.CUST_SEQ, 'FM000000'))
                  FROM BKG_CUSTOMER BCU
                 WHERE BK.BKG_NO = BCU.BKG_NO
                   AND BCU.BKG_CUST_TP_CD = 'C') CNEE_CD,
               (SELECT BCU.CUST_NM
                  FROM BKG_CUSTOMER BCU
                 WHERE BK.BKG_NO = BCU.BKG_NO
                   AND BCU.BKG_CUST_TP_CD = 'C') CNEE_NM,
               '' DEST_IM,
               BK.POL_CD DEST_EX,
               '' EQREL,
               BK.FULL_RTN_YD_CD EQRTN,
               '' POD_SVC,
               BK.SLAN_CD POL_SVC,
               '' POD_VSL,
               BK.VSL_CD POL_VSL,
               '' POD_VOY,
               BK.SKD_VOY_NO POL_VOY,
               DECODE(BK.SC_NO, NULL, NVL(BK.RFA_NO, BK.TAA_NO), BK.SC_NO) CONTRACT,
               CD.NOD_CD
          FROM BKG_BOOKING BK,
               BKG_CONTAINER BC,
               BKG_VVD BV,
               VSK_VSL_PORT_SKD VS,
               SCE_COP_HDR CH,
               SCE_COP_DTL CD -- CGM_POOL_LOC_MTCH 
         WHERE 1 = 1
           AND BK.BKG_NO = BC.BKG_NO
           AND BK.POL_CD = BV.POL_CD
           AND BK.BKG_NO = BV.BKG_NO
           AND BV.VSL_CD = VS.VSL_CD(+)
           AND BV.SKD_VOY_NO = VS.SKD_VOY_NO(+)
           AND BV.SKD_DIR_CD = VS.SKD_DIR_CD(+)
           AND BV.POL_CD = VS.VPS_PORT_CD(+)
           AND BV.POL_CLPT_IND_SEQ = VS.CLPT_IND_SEQ(+)
           AND BC.BKG_NO = CH.BKG_NO
           AND BC.CNTR_NO = CH.CNTR_NO
           AND CH.COP_NO = CD.COP_NO
           AND BV.VSL_PRE_PST_CD = 'T'
           AND BK.POL_CD LIKE 'US%'
           AND BK.BKG_STS_CD <> 'X'
           AND BK.BKG_CGO_TP_CD = 'F'
           AND CD.ACT_CD IN ('FOTRAD',
                       'FOTRDO',
                       'FOTMAD',
                       'FOTMDO',
                       'FOTSDO',
                       'FOTYAD',
                       'FOTYDO',
                       'MOTZAD')
           AND DECODE(BK.BKG_STS_CD, 'A', TRUNC(SYSDATE) , VS.VPS_ETD_DT) >= TRUNC(SYSDATE)
)
SELECT DISTINCT A.*
  FROM 
(SELECT PL.EDI_ID RECEIVER,
       P.IMEX,
       PL.CHSS_POOL_CD AS POOL_CD,
       P.BL_NO,
       P.BL_DT,
       DECODE(P.IMEX, 'IM', DECODE(P.BKG_NO, P.BL_NO, NULL, P.BKG_NO), P.BKG_NO) BKG_NO,
       P.BKG_DT,
       P.TRANS_TP,
       P.MD 'MODE',
       P.ETA,
       P.ETA_GMT,
       P.ETD,
       P.ETD_GMT,
       P.ARR_LOC,
       P.DEP_LOC,
       P.CNTR_NO,
       P.CNTR_CHK,
       P.CNTR_TP,
       P.SHPR_CD,
       REPLACE(REPLACE(P.SHPR_NM, CHR(10), ''), CHR(12), '') SHPR_NM,
       P.FW_CD,
       REPLACE(REPLACE(P.FW_NM, CHR(10), ''), CHR(12), '') FW_NM,
       P.CNEE_CD,
       REPLACE(REPLACE(P.CNEE_NM, CHR(10), ''), CHR(12), '') CNEE_NM,
       P.DEST_IM,
       P.DEST_EX,
       P.EQREL,
       P.EQRTN,
       P.POD_SVC,
       P.POL_SVC,
       P.POD_VSL,
       P.POL_VSL,
       P.POD_VOY,
       P.POL_VOY,
       P.CONTRACT
  FROM PARAM P, CGM_POOL_CHSS_LOC PL
 WHERE 1 = 1
   AND P.NOD_CD LIKE 'US%'
   AND P.NOD_CD = PL.OWN_YD_CD
   AND PL.POOL_MGMT_CO_CD IS NOT NULL
) A
WHERE 1=1
  AND RECEIVER = @[fw_cd]
  AND POOL_CD = @[fw_nm]			]]></sql>
			<params>
				<param name="fw_cd" type="12" value="" out="N"/>
				<param name="fw_nm" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
