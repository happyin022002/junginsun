<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CntrRepoExecutionPlanEstablishDBDAOSearchRepoExePlanRSQL">
			<desc><![CDATA[Repo Plan Search]]></desc>
			<sql><![CDATA[
SELECT
	E.TRSP_MOD_CD 	ITEM
	,E.VSL_CD||E.SKD_VOY_NO ||E.SKD_DIR_CD			VVD
	,E.VSL_LANE_CD 			LANE
	,E.FM_YD_CD 	FRLOC
    ,TO_CHAR(E.FM_ETD_DT, 'YYYYMMDD') 		ETD
    ,E.TO_YD_CD 	TOLOC
    ,TO_CHAR(E.TO_ETA_DT, 'YYYYMMDD') 		ETA
	,'' EQ_REPO_PURP_CD
	,E.EXE_ISS_FLG SOSEND
    ,E.REPO_MTY_BKG_FLG REPOBKG
	,CASE WHEN E.MTY_BKG_NO IS NULL THEN 
          'EXECUTION'
     ELSE 
          (SELECT CASE SPLIT_FLG
        		WHEN 'Y' THEN 'SPLIT BKG'
        		WHEN 'N' THEN 'REPO BKG'
				ELSE ''
            END
  			FROM BKG_BOOKING
 				WHERE 1=1
   			AND BKG_NO = E.MTY_BKG_NO)
     END DIV
	
	,E.MTY_BKG_NO
	,E.REF_ID    
	,'' AS MIDDLE_POINT
	#if ( ${volsec} == '' || ${volsec4} != '-1')
	,0 TOTALTEUVOL
	#end
	#if ( ${volsec} == '' || ${volsec1} != '-1')
	,0 TOTALTEUATTACH 
	#end
	#if ( ${volsec} == '' || ${volsec2} != '-1')
	,0 TOTALTEUWORKORDER
	#end
	#if ( ${volsec} == '' || ${volsec3} != '-1')
	,0 TOTALTEUMVMT
	#end	

	#if ( ${volsec} == '' || ${volsec4} != '-1')
    ,
	#foreach(${key} in ${tpszArr})
		NVL(MAX(DECODE(E.CNTR_TPSZ_CD, '${key}', E.CNTR_QTY)),0)
		#if($velocityCount < $tpszArr.size())
			+
		#end
    #end
	 TOTALVOL 
	#end
	#if ( ${volsec} == '' || ${volsec1} != '-1')
	,(SELECT COUNT(*) FROM EQR_EXE_PLN_CNTR WHERE REPO_PLN_ID = @[repoPlanID] AND PLN_SEQ = E.PLN_SEQ AND PLN_YRWK=E.PLN_YRWK) TOTALATTACH 
	#end
	#if ( ${volsec} == '' || ${volsec2} != '-1')
	, 0 TOTALWORKORDER 
	#end
	#if ( ${volsec} == '' || ${volsec3} != '-1')
	, 0 TOTALMVMT
	#end

	#foreach(${key} in ${tpszArr})
		#if ( ${volsec} == '' || ${volsec4} != '-1')
		,NVL(MAX(DECODE(E.CNTR_TPSZ_CD, '${key}', E.CNTR_QTY)),0)    ${key}VOL 
		#end
   	 	#if ( ${volsec} == '' || ${volsec1} != '-1')
		,(
		SELECT COUNT(CNTR_NO) FROM EQR_EXE_PLN_CNTR WHERE REPO_PLN_ID = @[repoPlanID]
		AND PLN_YRWK = E.PLN_YRWK
		AND PLN_SEQ = E.PLN_SEQ
		AND REF_ID = E.REF_ID
		AND CNTR_TPSZ_CD = '${key}'
	  	) ${key}ATTACH
		#end
		#if ( ${volsec} == '' || ${volsec2} != '-1')
    	,0 ${key}WORKORDER
		#end
		#if ( ${volsec} == '' || ${volsec3} != '-1')
    	,0 ${key}MVMT
		#end
	#end
    , (SELECT OFC_CD FROM COM_USER WHERE USR_ID = (SELECT UPD_USR_ID FROM EQR_REPO_EXE_PLN WHERE REPO_PLN_ID =  @[repoPlanID] AND PLN_YRWK = PLN_YRWK AND PLN_SEQ = PLN_SEQ AND REF_ID = REF_ID AND ROWNUM=1)) OFC_CD  
	, (SELECT UPD_USR_ID FROM COM_USER WHERE USR_ID = (SELECT UPD_USR_ID FROM EQR_REPO_EXE_PLN WHERE REPO_PLN_ID =  @[repoPlanID] AND PLN_YRWK = PLN_YRWK AND PLN_SEQ = PLN_SEQ AND REF_ID = REF_ID AND ROWNUM=1)) UPD_USR_ID  
	, TO_CHAR((SELECT UPD_DT FROM COM_USER WHERE USR_ID = (SELECT UPD_USR_ID FROM EQR_REPO_EXE_PLN WHERE REPO_PLN_ID =  @[repoPlanID] AND PLN_YRWK = PLN_YRWK AND PLN_SEQ = PLN_SEQ AND REF_ID = REF_ID AND ROWNUM=1)),'YYYY-MM-DD') UPD_DT 
    ,E.PLN_YRWK
	,E.REPO_PLN_ID 	-- HIDDEN
	,1 SORTNUM    	-- HIDDEN
    ,'' WEEKFROMDATE
	,'' WEEKTODATE
	,'' WEEKMAXDATE
	,E.VSL_CD
	,E.SKD_DIR_CD
	,E.SKD_VOY_NO
	,'H'		 		COMPANY    -- E.CO_CD
	,''	ALLLOCCD
	,E.PAST_REPO_PLN_FLG
	,'' SPLITREPOPLNFLG
	,(SELECT DISTINCT RCC_CD FROM EQR_ECC_MST WHERE ECC_CD = SUBSTR(E.FM_YD_CD,1,5)) FM_RCC
	,(SELECT DISTINCT RCC_CD FROM EQR_ECC_MST WHERE ECC_CD = SUBSTR(E.TO_YD_CD,1,5)) TO_RCC     -- To   ecc's RCC
    ,(SELECT DISTINCT LCC_CD FROM EQR_ECC_MST WHERE ECC_CD = SUBSTR(E.FM_YD_CD,1,5)) FM_LCC     -- From ecc's LCC
    ,(SELECT DISTINCT LCC_CD FROM EQR_ECC_MST WHERE ECC_CD = SUBSTR(E.TO_YD_CD,1,5)) TO_LCC     -- To   ecc's LCC
	,SUBSTR(E.FM_YD_CD,1,5) FM_ECC    
    ,SUBSTR(E.TO_YD_CD,1,5) TO_ECC  
	,'' AS   TPSZNO
    ,E.PLN_SEQ 
FROM
    (
    SELECT
        A.PLN_YRWK
        ,A.PLN_SEQ
        ,A.CO_CD
        ,A.TRSP_MOD_CD
        ,B.ECC_CD FM_ECC
        ,C.ECC_CD TO_ECC
        ,Q.CNTR_TPSZ_CD
        ,A.REPO_PLN_ID
		,A.REF_ID
        ,A.PAST_REPO_PLN_FLG
        ,Q.TRSP_COST_AMT
        ,Q.CNTR_QTY
        ,A.FM_YD_CD
        ,A.FM_ETD_DT
        ,A.TO_YD_CD
        ,A.TO_ETA_DT
        ,A.VSL_CD
        ,A.SKD_VOY_NO
        ,A.SKD_DIR_CD
        ,A.VSL_LANE_CD
        ,SUM(Q.CNTR_QTY) MAX_QTY
		,A.MTY_BKG_NO
		,A.REPO_MTY_BKG_FLG
		,A.EXE_ISS_FLG
    FROM
        EQR_REPO_EXE_PLN A,
        EQR_REPO_EXE_PLN_QTY Q,
        MDM_EQ_ORZ_CHT B,
        MDM_EQ_ORZ_CHT C,
        MDM_LOCATION E,
        MDM_LOCATION F
    WHERE
        A.REPO_PLN_ID = Q.REPO_PLN_ID
        AND A.PLN_YRWK = Q.PLN_YRWK
        AND A.PLN_SEQ = Q.PLN_SEQ
        AND A.REF_ID = Q.REF_ID
        AND SUBSTR(A.FM_YD_CD, 0, 5) = E.LOC_CD
        AND E.SCC_CD = B.SCC_CD
        AND SUBSTR(A.TO_YD_CD, 0, 5) = F.LOC_CD
        AND F.SCC_CD = C.SCC_CD
        AND   A.REPO_PLN_ID = @[repoPlanID]
        AND   A.PLN_YRWK BETWEEN @[fromWeek] AND @[toWeek]
    GROUP BY
        A.PLN_YRWK
        ,A.PLN_SEQ
        ,A.CO_CD
        ,A.TRSP_MOD_CD
        ,B.ECC_CD
        ,C.ECC_CD
        ,Q.CNTR_TPSZ_CD
        ,A.REPO_PLN_ID
        ,A.PAST_REPO_PLN_FLG
        ,Q.TRSP_COST_AMT
        ,Q.CNTR_QTY
        ,A.FM_YD_CD
        ,A.FM_ETD_DT
        ,A.TO_YD_CD
        ,A.TO_ETA_DT
        ,A.VSL_CD
        ,A.SKD_VOY_NO
        ,A.SKD_DIR_CD
        ,A.VSL_LANE_CD
		,A.REF_ID
		,A.MTY_BKG_NO
		,A.REPO_MTY_BKG_FLG
		,A.EXE_ISS_FLG
        ) E
WHERE 1=1
    AND   E.REPO_PLN_ID = @[repoPlanID]
    AND   E.PLN_YRWK BETWEEN @[fromWeek] AND @[toWeek]
	#if ( ${mtyBkgNo} != '' )
		AND E.MTY_BKG_NO = @[mtyBkgNo]
	#end
	#if ( ${refId} != '' )
		AND E.REF_ID = @[refId]
	#end
	#if (${vvdStrArr} != '')
		AND E.VSL_CD||E.SKD_VOY_NO||E.SKD_DIR_CD	IN ( ${vvdStrArr} )
	#end
GROUP BY
    E.PLN_YRWK
    ,E.PLN_SEQ
    ,E.CO_CD
    ,E.FM_YD_CD 	
    ,E.FM_ETD_DT 		
    ,E.TO_YD_CD 	
    ,E.TO_ETA_DT 	
    ,E.TRSP_MOD_CD
    ,E.REPO_PLN_ID
    ,E.PAST_REPO_PLN_FLG
    ,E.VSL_CD
    ,E.SKD_VOY_NO
    ,E.SKD_DIR_CD
    ,E.VSL_LANE_CD
	,E.REF_ID
	,E.MTY_BKG_NO
	,E.REPO_MTY_BKG_FLG
	,E.EXE_ISS_FLG
ORDER BY E.PLN_SEQ ASC			]]></sql>
			<params>
				<param name="repoPlanID" type="12" value="1" out="N"/>
				<param name="fromWeek" type="12" value="2" out="N"/>
				<param name="toWeek" type="12" value="3" out="N"/>
				<param name="mtyBkgNo" type="12" value="1" out="N"/>
				<param name="refId" type="12" value="1" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
