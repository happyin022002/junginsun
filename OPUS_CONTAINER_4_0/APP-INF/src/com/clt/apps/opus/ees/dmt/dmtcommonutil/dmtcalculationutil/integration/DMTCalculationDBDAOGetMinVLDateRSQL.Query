<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="DMTCalculationDBDAOGetMinVLDateRSQL">
			<desc><![CDATA[getMinVLDate]]></desc>
			<sql><![CDATA[
SELECT  /*+ INDEX (S XFN1CTM_MOVEMENT) */
        TO_CHAR (CNMV_EVNT_DT, 'RRRRMMDD') RTN_DTG_EFFT_DT
FROM    CTM_MOVEMENT S
WHERE   CNTR_NO	    = @[cntr_no]
AND     MVMT_STS_CD	= @[mvmt_sts_cd]
AND     (CNMV_YR || TO_CHAR (CNMV_SEQ, '0000') || CNMV_SPLIT_NO ) >
        (
        -- NO = 1 이 우선이지만, 1번이 없을 수 있기 때문에 NO = 2를 조회하지만, 
        -- 결과 ROW_NUMBER() 함수에서 첫번째로 리턴 받은 것을 사용한다.
        SELECT  INDEX_KEY
        FROM    (
                SELECT  ROW_NUMBER() OVER (ORDER BY NO) AS NO, INDEX_KEY
                FROM    (
                        -- 조회 시작점을 찾는 Query 이다. 
                        -- OP 이후 최초 발생하는 OC를 찾기 위해 이전 VD 위치를 찾는 Query 이다.
                        SELECT /*+ INDEX_DESC (S XAK11CTM_MOVEMENT) */
                                1 AS NO, CNMV_YR || TO_CHAR (CNMV_SEQ, '0000') || CNMV_SPLIT_NO AS INDEX_KEY
                        FROM    CTM_MOVEMENT S	
                        WHERE   CNTR_NO	    = @[cntr_no]
                        AND     CNMV_CYC_NO	< @[cnmv_cyc_no]
#if (${start_mvmt_sts_cd} == 'VD') 
                        AND     MVMT_STS_CD	IN ( 'ID', 'MT' )
#else
                        AND     MVMT_STS_CD = @[start_mvmt_sts_cd]
#end
                        AND     ROWNUM      = 1
                        UNION ALL
                        -- (1 AS NO) ( START_MVMT_STS ) 에 대한 값을 없을 경우에
                        -- (2 AS NO)의 의미없을 값을 리턴 받기 위해 사용. (최초 발생하는 Cycle 인 때 (1 AS NO) 값이 없을 수 있기 때문.
                        SELECT  2 AS NO, '2008 0001' AS INDEX_KEY FROM DUAL
                        )
                WHERE   1=1
                )
        WHERE   1=1
        AND     NO  = 1
        )
AND     ROWNUM      = 1			]]></sql>
			<params>
				<param name="cntr_no" type="12" value="" out="N"/>
				<param name="mvmt_sts_cd" type="12" value="" out="N"/>
				<param name="cnmv_cyc_no" type="12" value="" out="N"/>
				<param name="start_mvmt_sts_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
