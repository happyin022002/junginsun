<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="SPCLCmpnApprovalDBDAOSearchSPCLCmpnCSRHeaderRSQL">
			<desc><![CDATA[SearchSPCLCmpnCSRHeader]]></desc>
			<sql><![CDATA[
SELECT
(--/* 3.GET CSR_NO */
SELECT '08'|| A.CSR_AMT_CD ||@[ap_ofc_cd]||SUBSTR(TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC('KRPUS',SYSDATE, 'USNYC' ),'YYYYMMDD'),3,4)||TO_CHAR(
        NVL(MAX(TO_NUMBER(SUBSTR(CSR_NO,LENGTH(CSR_NO)-3)))+1,1001) ,'FM0000') AS CSR_NO
FROM AP_CSR_NO 
WHERE CSR_NO LIKE '08'|| A.CSR_AMT_CD ||@[ap_ofc_cd]||SUBSTR(TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC('KRPUS',SYSDATE, 'USNYC' ),'YYYYMMDD'),3,4)||'%'
) AS CSR_NO
, DECODE(SIGN(A.CSR_AMT),-1,'CREDIT','STANDARD') AS CSR_TP_CD
, NVL(REPLACE(@[inv_dt], '-'),TO_CHAR(SYSDATE,'YYYYMMDD')) AS INV_DT
, NVL(REPLACE(@[inv_dt], '-'),TO_CHAR(SYSDATE,'YYYYMMDD')) AS INV_TERM_DT
--,'20120523' AS GL_DT 
, @[vndr_seq] AS VNDR_NO
, ROUND(A.CSR_AMT,2) AS CSR_AMT  
, 0 AS PAY_AMT
, null AS PAY_DT
, A.CURR_CD AS CSR_CURR_CD
, '3' AS VNDR_TERM_NM
, C.INV_DESC
, 'Invoices' AS ATTR_CATE_NM
, null AS ATTR_CTNT1, null AS ATTR_CTNT2, null AS ATTR_CTNT3, null AS ATTR_CTNT4, null AS ATTR_CTNT5, null AS ATTR_CTNT6, null AS ATTR_CTNT7
, TO_CHAR(sysdate,'yyyymmddhh24miss') AS ATTR_CTNT8, null AS ATTR_CTNT9, @[usr_nm] AS ATTR_CTNT10
, null AS ATTR_CTNT11, null AS ATTR_CTNT12, null AS ATTR_CTNT13, null AS ATTR_CTNT14, null AS ATTR_CTNT15, null AS GLO_ATTR_CTNT1
, null AS GLO_ATTR_CTNT2, null AS GLO_ATTR_CTNT3, null AS GLO_ATTR_CTNT4, null AS GLO_ATTR_CTNT5, null AS GLO_ATTR_CTNT6, null AS GLO_ATTR_CTNT7
, null AS GLO_ATTR_CTNT8, null AS GLO_ATTR_CTNT9, null AS GLO_ATTR_CTNT10, null AS GLO_ATTR_CTNT11, null AS GLO_ATTR_CTNT12, null AS GLO_ATTR_CTNT13
, null AS GLO_ATTR_CTNT14, null AS GLO_ATTR_CTNT15, null AS GLO_ATTR_CTNT16, null AS GLO_ATTR_CTNT17, null AS GLO_ATTR_CTNT18
, D.SRC_CTNT AS SRC_CTNT--srcCtnt
, C.PAY_MZD_LU_CD --payMzdLuCd
, D.PAY_GRP_LU_CD --payGrpLuCd
, '01' AS COA_CO_CD
, D.COA_RGN_CD --coaRgnCd
, D.COA_CTR_CD --coaCtrCd
,'210111' AS COA_ACCT_CD, '0000000000' AS COA_VVD_CD
, C.COA_INTER_COMPY_CD AS COA_INTER_CO_CD--coaIntrCmpyCd
, '000000' AS COA_FTU_N1ST_CD, '000000' AS COA_FTU_N2ND_CD, null AS PPD_NO, null AS PPD_DTRB_NO, null AS PPD_APLY_AMT, null AS PPD_GL_DT
, 'Y' AS APRO_FLG, 'N' AS TAX_DECL_FLG, null AS ERR_CSR_NO, null AS IF_FLG, null AS IF_DT, null AS IF_ERR_RSN, 'N' AS PPAY_APLY_FLG
, @[ap_ofc_cd] AS TJ_OFC_CD --ap_ofc_cd
, null AS ACT_XCH_RT, null AS IMP_ERR_FLG, null AS RCV_ERR_FLG, null AS TAX_CURR_XCH_FLG, @[usr_eml] AS USR_EML--userEm
, null AS IMP_ERR_RSN, null AS RCV_ERR_RSN, null AS FTU_USE_CTNT1, null AS FTU_USE_CTNT2, null AS FTU_USE_CTNT3, null AS FTU_USE_CTNT4, null AS FTU_USE_CTNT5
, SYSDATE AS CRE_DT, @[usr_id] AS CRE_USR_ID, SYSDATE AS EAI_EVNT_DT
, D.AR_HD_QTR_OFC_CD
, @[ap_ofc_cd] AS AP_OFC_CD
, D.OFC_ENG_NM AS APRO_OFC_NM
, @[vndr_seq] AS VNDR_SEQ
, @[cust_cnt_seq] AS CUST_CNT_SEQ
, @[date_div] AS DATE_DIV
, @[date_fm] AS DATE_FM
, @[date_to] AS DATE_TO
, @[inv_tax_rt] AS INV_TAX_RT
, @[asa_no] AS ASA_NO
, E.ASA_CURR_CD
, E.ASA_CNT

FROM
--/* 7.GET CSR_AMOUNT */
(SELECT 
        CASE
        WHEN MAX(C.OFF_SET_FLG) = 'Y'
        THEN 0
        ELSE NVL(ROUND(SUM(A.PAY_IF_AMT + (A.PAY_IF_AMT * NVL(@[inv_tax_rt], 0) / 100)), 2),0) 
        END AS CSR_AMT,
        CASE 
        WHEN NVL(ROUND(SUM(A.PAY_IF_AMT + (A.PAY_IF_AMT * NVL(@[inv_tax_rt], 0) / 100)), 2),0) >= 0 
        THEN 'S'
        ELSE 'C' END CSR_AMT_CD,
        MAX(A.CURR_CD) AS CURR_CD
 FROM ACM_SPCL_CMPN A, ACM_AGN_BKG_INFO B,
    ( SELECT DECODE(NVL(SO_IF_CD,' '),'O','Y','N') AS OFF_SET_FLG
      FROM MDM_ORGANIZATION
      WHERE OFC_CD = @[ap_ofc_cd] ) C 
WHERE A.VNDR_SEQ = @[vndr_seq]
  AND A.CUST_CNT_CD||TO_CHAR(A.CUST_SEQ,'FM000000') = @[cust_cnt_seq]
  AND A.AP_OFC_CD = @[ap_ofc_cd]
--  /* 날짜 조회 조건 */   
#if(${date_div} == 'C')      
   AND A.IF_DT IS NULL
   AND B.BKG_CRE_DT     
BETWEEN TO_DATE(REPLACE(@[date_fm],'-', ''),'YYYYMMDD')  
   AND TO_DATE(REPLACE(@[date_to],'-', ''),'YYYYMMDD')+0.99999     
#elseif(${date_div} == 'E') 
   AND A.IF_DT IS NULL
   AND A.VSL_DEP_DT     
BETWEEN TO_DATE(REPLACE(@[date_fm],'-', ''),'YYYYMMDD')  
   AND TO_DATE(REPLACE(@[date_to],'-', ''),'YYYYMMDD')+0.99999     
#elseif(${date_div} == 'I')  
   AND A.IF_DT  
BETWEEN TO_DATE(REPLACE(@[date_fm],'-', ''),'YYYYMMDD')  
   AND TO_DATE(REPLACE(@[date_to],'-', ''),'YYYYMMDD')+0.99999     
#end
  AND A.SPCL_CMPN_STS_CD = 'CS'
  AND NVL(A.PAY_CHK_FLG,'N') = 'Y'
  AND A.BKG_NO       = B.BKG_NO 
  AND A.CRE_USR_ID != 'COST' 
  AND B.BL_NO IS NOT NULL 
--  AND A.CSR_NO        = '08SNYCNA12051610001' 
  AND (A.BKG_NO, A.SPCL_CMPN_SEQ) IN  
      (SELECT BKG_NO, SPCL_CMPN_SEQ
         FROM ACM_SPCL_CMPN 
         WHERE SPCL_CMPN_STS_CD = 'CS'
           AND NVL(A.PAY_CHK_FLG,'N') = 'Y'
         /* 날짜 조회 조건 */       
#if(${date_div} == 'C')      
           AND IF_DT IS NULL 
           AND B.BKG_CRE_DT      
       BETWEEN TO_DATE(REPLACE(@[date_fm],'-', ''),'YYYYMMDD')    
           AND TO_DATE(REPLACE(@[date_to],'-', ''),'YYYYMMDD')+0.99999      
#elseif(${date_div} == 'E') 
           AND IF_DT IS NULL 
           AND A.VSL_DEP_DT      
       BETWEEN TO_DATE(REPLACE(@[date_fm],'-', ''),'YYYYMMDD')    
           AND TO_DATE(REPLACE(@[date_to],'-', ''),'YYYYMMDD')+0.99999      
#elseif(${date_div} == 'I')  
           AND A.IF_DT   
       BETWEEN TO_DATE(REPLACE(@[date_fm],'-', ''),'YYYYMMDD')    
           AND TO_DATE(REPLACE(@[date_to],'-', ''),'YYYYMMDD')+0.99999      
#end
--          AND CSR_NO     = '08SNYCNA12051610001' 
          AND VNDR_SEQ = @[vndr_seq] --:vndr_seq        
          AND CUST_CNT_CD||TO_CHAR(CUST_SEQ,'FM000000') = @[cust_cnt_seq]
      )
) A,
(
--/* GET VNDR_TERM_NM, COA_INTER_COMPY_CD, INV_DESC, PAY_MZD_LU_CD */
SELECT GEN_PAY_TERM_CD, 
       NVL(LTRIM(SUBS_CO_CD),'00') AS COA_INTER_COMPY_CD, 
       NVL(LTRIM(VNDR_LOCL_LANG_NM),VNDR_LGL_ENG_NM) AS INV_DESC,
       PAY_MZD_CD AS PAY_MZD_LU_CD
  FROM MDM_VENDOR 
 WHERE VNDR_SEQ = @[vndr_seq]
) C,
(
--/* 8.GET PAY_GRP_LU_CD, SRC_CTNT, COA_RGN_CD, COA_CTR_CD */
 SELECT --DECODE(B.CONTI_CD,'M','CMS CHECK(O/EXP)','E','CMS WIRE','WIRE') AS PAY_MZD_LU_CD,        
        CASE A.SO_IF_CD
        WHEN 'O'
        THEN @[ap_ofc_cd]||'_ZERO PAYMENT'
        ELSE @[ap_ofc_cd]||'_BROKERAGE'
        END           AS PAY_GRP_LU_CD,       
        DECODE(A.SO_IF_CD, 'O', 'COMMISSION', 'BROKERAGE') AS SRC_CTNT,       
        NVL(A.FINC_RGN_CD,'00') AS COA_RGN_CD,
        A.AP_CTR_CD AS COA_CTR_CD,
        A.AR_HD_QTR_OFC_CD,
		A.OFC_ENG_NM 
 FROM MDM_ORGANIZATION A, MDM_LOCATION B 
WHERE A.OFC_CD = @[ap_ofc_cd]
  AND A.LOC_CD = B.LOC_CD(+)
  AND NVL(A.DELT_FLG,'N') = 'N'
) D,
 ( ---- CHECK ASA_CURR_CD vs INVOICE_CURR_CD,  INV_DT vs ASA_FROM_TO_DT
   SELECT
          MAX (A.CURR) AS ASA_CURR_CD,
          SUM (B.CNT)  AS ASA_CNT
     FROM
        (     SELECT
                     CURR_CD AS CURR
                FROM SAR_ASA_MST
               WHERE ASA_NO = @[asa_no]
        ) A,
        (     SELECT
                     COUNT(*) AS CNT
                FROM SAR_ASA_MST
               WHERE ASA_NO = @[asa_no]
                 AND REPLACE (@[inv_dt], '-', '')
             BETWEEN ASA_PRD_FM_DT
                 AND ASA_PRD_TO_DT
        ) B
 ) E			]]></sql>
			<params>
				<param name="ap_ofc_cd" type="12" value="" out="N"/>
				<param name="inv_dt" type="12" value="" out="N"/>
				<param name="vndr_seq" type="12" value="" out="N"/>
				<param name="usr_nm" type="12" value="" out="N"/>
				<param name="usr_eml" type="12" value="" out="N"/>
				<param name="usr_id" type="12" value="" out="N"/>
				<param name="cust_cnt_seq" type="12" value="" out="N"/>
				<param name="date_div" type="12" value="" out="N"/>
				<param name="date_fm" type="12" value="" out="N"/>
				<param name="date_to" type="12" value="" out="N"/>
				<param name="inv_tax_rt" type="12" value="" out="N"/>
				<param name="asa_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
