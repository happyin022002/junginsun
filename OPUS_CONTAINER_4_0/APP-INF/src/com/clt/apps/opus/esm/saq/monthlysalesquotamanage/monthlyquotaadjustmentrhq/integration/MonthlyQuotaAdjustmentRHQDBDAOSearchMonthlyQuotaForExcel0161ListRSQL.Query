<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="MonthlyQuotaAdjustmentRHQDBDAOSearchMonthlyQuotaForExcel0161ListRSQL">
			<desc><![CDATA[QuotaForExcel 목록 조회]]></desc>
			<sql><![CDATA[
WITH INPUT_PARAMS AS
(
    SELECT   @[mqta_step_cd] MQTA_STEP_CD
            ,@[bse_yr] BSE_YR
            ,@[bse_qtr_cd] BSE_QTR_CD
            ,@[trd_cd] TRD_CD
            ,@[dir_cd] DIR_CD
            ,@[mqta_ver_no] MQTA_VER_NO
            ,@[gline_ver_no] GLINE_VER_NO
            ,@[unit] UNIT
    FROM    DUAL
), WITH_TGT_VVD_ADJ AS
(
    SELECT   ADJ.BSE_YR
            ,ADJ.BSE_QTR_CD
            ,ADJ.TRD_CD
            ,ADJ.RLANE_CD
            ,ADJ.DIR_CD
            ,ADJ.SPRT_GRP_CD
            ,ADJ.BSA_GRP_CD
            ,ADJ.BSE_MON
            ,MIN(ADJ.FNL_BSA_CAPA)                                          BSA
            ,COUNT(DISTINCT ADJ.VSL_CD||ADJ.SKD_VOY_NO||ADJ.SKD_DIR_CD)     VOYAGE
    FROM     SAQ_MON_TGT_VVD_ADJ    ADJ
            ,INPUT_PARAMS           INP
    WHERE   1=1
    AND     ADJ.BSE_YR          = INP.BSE_YR
    AND     ADJ.BSE_QTR_CD      = INP.BSE_QTR_CD
    AND     ADJ.GLINE_VER_NO    = INP.GLINE_VER_NO
    AND     ADJ.TRD_CD          = INP.TRD_CD
    AND     ADJ.DIR_CD          = INP.DIR_CD
    GROUP BY ADJ.BSE_YR
            ,ADJ.BSE_QTR_CD
            ,ADJ.TRD_CD
            ,ADJ.RLANE_CD
            ,ADJ.DIR_CD
            ,ADJ.SPRT_GRP_CD
            ,ADJ.BSA_GRP_CD
            ,ADJ.BSE_MON
)
SELECT   LPAD(ROWNUM, 4, 0)             RN
        ,EDITABLE
        ,MQTA_STEP_CD
        ,BSE_YR
        ,BSE_QTR_CD
        ,TRD_CD
        ,SUB_TRD_CD
        ,RLANE_CD
        ,DIR_CD
        ,MQTA_VER_NO
        ,LANE_GRP
        ,BSE_MON
        ,POL_CD
        ,POD_CD
        ,VOYAGE
        ,BSA
        ,AQ_CD
        ,RGN_OFC_CD
        ,UNIT
        ,LOD_QTY
        ,GRS_REV
        ,ROUND(GRS_RPB_REV, 5) AS GRS_RPB_REV
        ,RA_CM_UC_AMT
        ,CMPB
        ,RA_OPFIT_UC_AMT
        ,OPB
FROM    (
            SELECT   A.MQTA_STEP_CD
                    ,A.BSE_YR                                                   BSE_YR
                    ,A.BSE_QTR_CD                                               BSE_QTR_CD
                    ,A.TRD_CD                                                   TRD_CD
                    ,A.SUB_TRD_CD                                               SUB_TRD_CD
                    ,A.RLANE_CD                                                 RLANE_CD
                    ,A.DIR_CD                                                   DIR_CD
                    ,A.MQTA_VER_NO                                              MQTA_VER_NO
                    ,A.SPRT_GRP_CD||A.BSA_GRP_CD                                LANE_GRP
                    ,A.BSE_MON                                                  BSE_MON

#if (${mqtaStepCd} == '08') 
	                    ,A.POL_CD                                                   POL_CD
	                    ,A.POD_CD                                                   POD_CD
#else 
	                    ,'00000'                                                    POL_CD
	                    ,'00000'                                                    POD_CD
#end

                    ,ADJ.VOYAGE                                                 VOYAGE
                    ,DECODE(INP.UNIT, 'T', ADJ.BSA  , 'F', ADJ.BSA / 2)         BSA

#if (${mqtaStepCd} == '08') 
	                    ,A.SLS_AQ_CD                                               AQ_CD
	                    ,A.SLS_RGN_OFC_CD                                          RGN_OFC_CD
#elseif (${mqtaStepCd} == '04') 
	                    ,A.CTRT_AQ_CD                                              AQ_CD
	                    ,A.CTRT_RGN_OFC_CD                                         RGN_OFC_CD
#else 
	                    ,''                                                        AQ_CD
	                    ,''                                                        RGN_OFC_CD
#end

                    ,DECODE(INP.UNIT, 'T', 'TEU'      , 'F', 'FEU')             UNIT
                    ,DECODE(INP.UNIT, 'T', A.LOD_QTY  , 'F', A.LOD_QTY / 2)     LOD_QTY
                    ,A.LOD_QTY * A.GRS_RPB_REV                                  GRS_REV
                    ,DECODE(INP.UNIT, 'T', A.GRS_RPB_REV , 'F', A.GRS_RPB_REV * 2)                                           GRS_RPB_REV
                    ,DECODE(INP.UNIT, 'T', A.CM_UC_AMT, 'F', A.CM_UC_AMT *2)                                                 RA_CM_UC_AMT
                    ,DECODE(INP.UNIT, 'T', A.GRS_RPB_REV - A.CM_UC_AMT, 'F', (A.GRS_RPB_REV - A.CM_UC_AMT) * 2)              CMPB
                    ,DECODE(INP.UNIT, 'T', A.RA_OPFIT_UC_AMT, 'F', A.RA_OPFIT_UC_AMT * 2)                                    RA_OPFIT_UC_AMT
                    ,DECODE(INP.UNIT, 'T', A.GRS_RPB_REV - A.RA_OPFIT_UC_AMT, 'F', (A.GRS_RPB_REV - A.RA_OPFIT_UC_AMT) * 2)  OPB
                    ,DECODE(A.SPRT_GRP_CD||A.BSA_GRP_CD,
                            MIN(A.SPRT_GRP_CD||A.BSA_GRP_CD)
                                OVER(PARTITION BY    A.MQTA_STEP_CD
                                                    ,A.BSE_YR
                                                    ,A.BSE_QTR_CD
                                                    ,A.TRD_CD
                                                    ,A.DIR_CD
                                                    ,A.MQTA_VER_NO
                                                    ,A.RLANE_CD
                                                    ,A.SPRT_GRP_CD
#if (${mqtaStepCd} == '08') 
	                                                    ,A.SLS_RGN_OFC_CD
#elseif (${mqtaStepCd} == '04') 
	                                                    ,A.CTRT_RGN_OFC_CD
#end

                                                    ,A.BSE_MON
                                                    ), 'Y', 'N')    EDITABLE

#if (${mqtaStepCd} == '08') 
	            FROM     SAQ_MON_QTA_LOD_TGT    A
		                ,SAQ_MON_QTA_PORT_SEQ   POL 
	                    ,SAQ_MON_QTA_PORT_SEQ   POD 
#elseif (${mqtaStepCd} == '04') 
	            FROM     SAQ_MON_QTA_RHQ        A
#else 
	            FROM     SAQ_MON_QTA_TRD        A
#end

                    ,INPUT_PARAMS           INP
                    ,WITH_TGT_VVD_ADJ       ADJ
            WHERE   1=1
            AND     A.MQTA_STEP_CD    = INP.MQTA_STEP_CD
            AND     A.BSE_YR          = INP.BSE_YR
            AND     A.BSE_QTR_CD      = INP.BSE_QTR_CD
            AND     A.TRD_CD          = INP.TRD_CD
            AND     A.DIR_CD          = INP.DIR_CD
            AND     A.MQTA_VER_NO     = INP.MQTA_VER_NO
            AND     A.BSE_YR          = ADJ.BSE_YR
            AND     A.BSE_QTR_CD      = ADJ.BSE_QTR_CD
            AND     A.TRD_CD          = ADJ.TRD_CD
            AND     A.RLANE_CD        = ADJ.RLANE_CD
            AND     A.DIR_CD          = ADJ.DIR_CD
            AND     A.SPRT_GRP_CD     = ADJ.SPRT_GRP_CD
            AND     A.BSA_GRP_CD      = ADJ.BSA_GRP_CD
            AND     A.BSE_MON         = ADJ.BSE_MON
#if (${mqtaStepCd} == '08') 
				AND     POL.BSE_YR(+)       = A.BSE_YR		
				AND     POL.BSE_QTR_CD(+)   = A.BSE_QTR_CD   
				AND     POL.GLINE_VER_NO(+) = @[gline_ver_no]                
				AND     POL.TRD_CD(+)       = A.TRD_CD       
				AND     POL.DIR_CD(+)       = A.DIR_CD       
				AND     POL.RLANE_CD(+)     = A.RLANE_CD     
				AND     POL.SPRT_GRP_CD(+)  = A.SPRT_GRP_CD  
				AND     POL.BSA_GRP_CD(+)   = A.BSA_GRP_CD   
				AND     POL.PORT_CD(+)      = A.POL_CD       
				AND     POD.BSE_YR(+)       = A.BSE_YR       
				AND     POD.BSE_QTR_CD(+)   = A.BSE_QTR_CD   
				AND     POD.GLINE_VER_NO(+) = @[gline_ver_no]                
				AND     POD.TRD_CD(+)       = A.TRD_CD       
				AND     POD.DIR_CD(+)       = A.DIR_CD       
				AND     POD.RLANE_CD(+)     = A.RLANE_CD     
				AND     POD.SPRT_GRP_CD(+)  = A.SPRT_GRP_CD  
				AND     POD.BSA_GRP_CD(+)   = A.BSA_GRP_CD   
				AND     POD.PORT_CD(+)      = A.POD_CD		
#end
            ORDER BY A.MQTA_STEP_CD
                    ,A.BSE_YR
                    ,A.BSE_QTR_CD
                    ,A.BSE_MON
                    ,A.SUB_TRD_CD
                    ,DECODE(A.RLANE_CD,'RBCCO','ZZ',SUBSTR(A.RLANE_CD,-2))
                    ,A.RLANE_CD
                    ,A.SPRT_GRP_CD||A.BSA_GRP_CD
#if (${mqtaStepCd} == '08') 
	                    ,POL.PORT_SEQ
	                    ,A.POL_CD
	                    ,POD.PORT_SEQ
	                    ,A.POD_CD
	                    ,DECODE(NVL(A.SLS_AQ_CD, 99), '99', 99, 11)||A.SLS_AQ_CD
	                    ,A.SLS_RGN_OFC_CD
#elseif (${mqtaStepCd} == '04') 
	                    ,DECODE(NVL(A.CTRT_AQ_CD, 99), '99', 99, 11)||A.CTRT_AQ_CD
	                    ,A.CTRT_RGN_OFC_CD
#end
        )
WHERE 1=1
AND   EDITABLE = 'Y'			]]></sql>
			<params>
				<param name="mqta_step_cd" type="12" value="" out="N"/>
				<param name="bse_yr" type="12" value="" out="N"/>
				<param name="bse_qtr_cd" type="12" value="" out="N"/>
				<param name="trd_cd" type="12" value="" out="N"/>
				<param name="dir_cd" type="12" value="" out="N"/>
				<param name="mqta_ver_no" type="12" value="" out="N"/>
				<param name="gline_ver_no" type="12" value="" out="N"/>
				<param name="unit" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
