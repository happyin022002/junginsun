<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="LogisticsRPTDBDAOSearchLogisticsRPT0081ListVO2RSQL">
			<desc><![CDATA[Logistics Exp. by Office [ESM_COA_0081화면] 쿼리2
2010.12.13 이윤정[CHM-201007143-01] Fuel Surcharge Code 분리 요건]]></desc>
			<sql><![CDATA[
SELECT P_REPORT
    ,RHQ_CD
    ,CTRL_OFC_CD
    ,COA_GET_CD_NM_FNC('CD01065', DECODE(COST_ACT_GRP_TP_CD, 'N', 'TM', 'TR')) LGS_KPI_COST_GRP_NM
    ,COA_GET_CD_NM_FNC(DECODE(P_KPITYPE, '1', 'CD01064', 'CD00950'), KPI_CD) KPI_NM
    ,COST_IO_BND_CD IN_OUT
    ,VOL
    ,STND_COST_NM
    ,AMT TOTAL_COST
    ,AMT / DECODE(VOL, 0, 1, VOL) UNIT_COST
    FROM (SELECT 	D2.P_REPORT
           ,D2.RHQ_CD
           ,D2.CTRL_OFC_CD
           ,D2.COST_IO_BND_CD
           ,D2.COST_ACT_GRP_TP_CD
           ,D2.P_KPITYPE
           ,D2.KPI_CD
           ,D2.VOL
           ,D1.STND_COST_CD
           ,D1.STND_COST_NM
           ,DECODE(D1.STND_COST_CD
           			,'51101011', BZC_STVG_AMT
           			,'51101071', OTR_CY_HNDL_AMT
           			,'51101021', TS_STVG_AMT
           			,'51101031', DCK_CY_HNDL_AMT
           			,'51101051', CGO_HNDL_AMT
           			,'51101041', FCNTR_STO_AMT
           			,'51101061', MISC_CGO_HNDL_AMT
           			,'51301011', FCNTR_TRSP_RAIL_DIR_AMT
           			,'51301021', FCNTR_TRSP_RAIL_TRK_AMT
           			,'51301031', FCNTR_TRSP_TRK_DIR_AMT
           			,'51301041', FCNTR_TRSP_WTR_DIR_AMT
           			,'51301051', FCNTR_TRSP_WTR_RAIL_AMT
           			,'51301061', FCNTR_TRSP_WTR_TRK_AMT
           			,'51301081', MISC_FCNTR_TRSP_AMT
					,'51301091', FCNTR_TRSP_FUEL_SCG_AMT  -- 추가           			
           			,0) AMT
           FROM (SELECT  ROWNUM RN
        				,STND_COST_CD
        				,STND_COST_NM
        		   FROM COA_STND_ACCT
        		  WHERE SGRP_COST_CD IN ('CVFS', 'CVTR', 'CVIP')       			
        		 ) D1
                  ,(SELECT  
                            C1.P_REPORT
                           ,DECODE(C1.P_REPORT, '1', 'X', C6.OFC_N3RD_LVL_CD) RHQ_CD  /*RHQ, Control OFFICE에서만 보여준다.*/
                           ,DECODE(C1.P_REPORT, '3', C6.OFC_N5TH_LVL_CD, 'X') CTRL_OFC_CD  /*Control OFFICE에서만 보여준다.*/
                           ,CASE C5.COST_ACT_GRP_CD 
                         		WHEN 'PRWD' THEN 'O' 
                         		WHEN 'POWD' THEN 'I'
                         		WHEN 'TRWD' THEN 'C' 
                         		ELSE C5.COST_IO_BND_CD 
                            END AS COST_IO_BND_CD
                          ,C5.COST_ACT_GRP_TP_CD
                          ,C1.P_KPITYPE
                          ,DECODE(C1.P_KPITYPE, '1', 
                                    DECODE(C5.STTL_FLG, 'Y', 'ST', C5.LGS_KPI_MN_CD), 
                                    DECODE(C5.STTL_FLG, 'Y', 'SHTL', C5.LGS_KPI_CD)
                            ) KPI_CD							/*Shuttle의 경우*/
                          ,SUM(NVL(C5.CNTR_QTY, 0)) VOL
                          ,SUM(BZC_STVG_AMT) BZC_STVG_AMT
                          ,SUM(OTR_CY_HNDL_AMT) OTR_CY_HNDL_AMT
                          ,SUM(TS_STVG_AMT) TS_STVG_AMT
                          ,SUM(DCK_CY_HNDL_AMT) DCK_CY_HNDL_AMT
                          ,SUM(CGO_HNDL_AMT) CGO_HNDL_AMT
                          ,SUM(FCNTR_STO_AMT) FCNTR_STO_AMT
                          ,SUM(MISC_CGO_HNDL_AMT) MISC_CGO_HNDL_AMT
                          ,SUM(FCNTR_TRSP_RAIL_DIR_AMT) FCNTR_TRSP_RAIL_DIR_AMT
                          ,SUM(FCNTR_TRSP_RAIL_TRK_AMT) FCNTR_TRSP_RAIL_TRK_AMT
                          ,SUM(FCNTR_TRSP_TRK_DIR_AMT) FCNTR_TRSP_TRK_DIR_AMT
                          ,SUM(FCNTR_TRSP_WTR_DIR_AMT) FCNTR_TRSP_WTR_DIR_AMT
                          ,SUM(FCNTR_TRSP_WTR_RAIL_AMT) FCNTR_TRSP_WTR_RAIL_AMT
                          ,SUM(FCNTR_TRSP_WTR_TRK_AMT) FCNTR_TRSP_WTR_TRK_AMT
                          ,SUM(MISC_FCNTR_TRSP_AMT) MISC_FCNTR_TRSP_AMT
                          ,SUM(FCNTR_TRSP_FUEL_SCG_AMT) FCNTR_TRSP_FUEL_SCG_AMT                          
                    FROM (SELECT  @[f_year] P_YEAR
                                 ,@[s_cost_yrmon2] P_SCOST_MON
                                 ,@[f_fm_mon] P_FM_MON
                                 ,@[f_to_mon] P_TO_MON
                                 ,@[f_sls_mon] P_SLS_MON
                                 ,@[s_cost_wk2] P_SCOST_WEEK
                                 ,@[f_fm_wk] P_FM_WEEK
                                 ,@[f_to_wk] P_TO_WEEK
                                 ,@[f_report] P_REPORT
                                 ,NVL(@[s_rhq_cd], @[f_rhq_cd]) P_RHQ_CD
                                 ,NVL(@[s_cntr_ofc_cd], @[f_ctrl_ofc_cd]) P_CTRL_OFC_CD
                                 ,@[f_in_out] P_INOUT
                                 ,NVL(@[s_lgs_kpi_cost_grp_cd], @[f_lgs_kpi_cost_grp_cd]) P_COST_ACT_GRP_TP_CD
                                 ,@[f_kpi_type] P_KPITYPE
                                 ,DECODE(@[f_kpi_type], '1', NVL(@[s_kpi_cd], @[f_lgs_mn_kpi_cd]), '') P_LGS_KPI_MN_CD
                                 ,DECODE(@[f_kpi_type], '2', NVL(@[s_kpi_cd], @[f_lgs_kpi_cd]), '') P_LGS_KPI_CD
                                 ,@[f_incld_mt] P_INCLD_MT
                                 ,DECODE(NVL(@[s_kpi_cd], @[f_lgs_mn_kpi_cd]), 'ST', 'Y', 'N') P_MN_SHTL   /*맨앞이 세팅할넘 p_lgs_kpi_mn_cd*/
                                 ,DECODE(NVL(@[s_kpi_cd], @[f_lgs_kpi_cd]), 'SHTL', 'Y', 'N') P_SHTL  	   /*맨앞이 세팅할넘 p_lgs_kpi_cd*/
                         FROM DUAL) C1
    	                           ,COA_MON_VVD C2
    	                           ,COA_RGST_BKG C3
    	                           ,COA_BKG_LGS_SMRY C5
    	                           ,COA_OFC_LVL C6
                         WHERE 1 = 1
                         
    					#if (${f_chkprd} == 'W') 
                        	#if (${s_cost_yrmon2} != '')
                          		AND SLS_YRMON = P_YEAR||P_SCOST_MON
                          		AND COST_WK = C1.P_SCOST_WEEK	
                        	#elseif (${s_cost_yrmon2} == '' && ${f_sls_mon} == '')  
                          		AND SLS_YRMON LIKE P_YEAR||'%' 
                          		AND COST_WK BETWEEN C1.P_FM_WEEK AND C1.P_TO_WEEK
                        	#elseif (${s_cost_yrmon2} == '' && ${f_sls_mon} != '')  
                          		AND SLS_YRMON LIKE P_YEAR||P_SLS_MON
                          		AND COST_WK BETWEEN C1.P_FM_WEEK AND C1.P_TO_WEEK
                        	#end
                        #elseif (${f_chkprd} == 'M')
                            #if (${s_cost_yrmon2} != '')
                              	AND C2.COST_YRMON = C1.P_YEAR||C1.P_SCOST_MON 
                            #else
                              	AND C2.COST_YRMON BETWEEN C1.P_YEAR||C1.P_FM_MON AND C1.P_YEAR||C1.P_TO_MON
                            #end
                        #end
    
                      	#if (${f_lgs_kpi_cd} != '' && ${f_kpi_type} == '2')
          	       			#if (${f_lgs_kpi_cd} == 'SHTL')
        			        	AND C5.STTL_FLG = 'Y'
                   			#else
    			            	AND C5.LGS_KPI_CD = C1.P_LGS_KPI_CD
        			    	#end   
                 		#end
    
                        #if (${f_lgs_mn_kpi_cd} != '' && ${f_kpi_type} == '1')
        		       		#if (${f_lgs_mn_kpi_cd} == 'ST' ||${s_kpi_cd} == 'ST')
    	      		      		AND C5.STTL_FLG = 'Y'
          		     		#else
    		              		AND C5.LGS_KPI_MN_CD = C1.P_LGS_KPI_MN_CD
        				   #end   
                  		#end
    
                      	#if (${s_kpi_cd} != '')
                           #if (${f_kpi_type} == '2')
                              #if (${s_kpi_cd} == 'SHTL')
                                  AND C5.STTL_FLG = 'Y'
                              #else
                                  AND C5.LGS_KPI_CD = C1.P_LGS_KPI_CD
                              #end
                          #elseif(${f_kpi_type} == '1')
                              #if (${f_lgs_mn_kpi_cd} == 'ST' || ${s_kpi_cd} == 'ST')
                                  AND C5.STTL_FLG = 'Y'
                              #else
                                  AND C5.LGS_KPI_MN_CD = C1.P_LGS_KPI_MN_CD
                              #end
                           #end
                       #end
    
                       #if (${f_incld_mt} == '')
                          	AND C5.COST_ACT_GRP_CD  NOT IN ('NIBC','NOBC')
                       #end
    
                      #if (${f_rhq_cd} != '' || ${s_rhq_cd} != '')                          
                              AND C6.OFC_N2ND_LVL_CD = C1.P_RHQ_CD
                  	  #end
    
                      #if (${f_ctrl_ofc_cd} != '' || ${s_cntr_ofc_cd} != '')
                         AND C6.OFC_N5TH_LVL_CD = C1.P_CTRL_OFC_CD
                      #end
    
                	  #if (${f_lgs_kpi_cost_grp_cd} != '' || ${s_lgs_kpi_cost_grp_cd} != '')
                         AND C5.COST_ACT_GRP_TP_CD = C1.P_COST_ACT_GRP_TP_CD
                      #end
    
                      #if (${f_in_out} != '')
                         AND CASE C5.COST_ACT_GRP_CD
    	                     WHEN 'PRWD' THEN 'O'
                             WHEN 'POWD' THEN 'I'
                             WHEN 'TRWD' THEN 'C'
                             ELSE C5.COST_IO_BND_CD
                             	END = @[f_in_out]
                      #end
    
                          AND C3.BKG_STS_CD IN('F', 'S')
                          AND C3.BL_NO_TP IN('M', '0')
                          AND C2.DELT_FLG NOT IN('Y')
                          AND C3.BKG_CGO_TP_CD NOT IN('P')
                          AND C2.VSL_CD = C3.VSL_CD
                          AND C2.SKD_VOY_NO = C3.SKD_VOY_NO
                          AND C2.DIR_CD = C3.DIR_CD
                          AND C2.TRD_CD = C3.TRD_CD
                          AND C2.RLANE_CD = C3.RLANE_CD
                          AND C2.IOC_CD = C3.IOC_CD
                          AND C3.BKG_NO = C5.BKG_NO
                          AND C5.CTRL_OFC_CD = C6.OFC_CD
              
                      #if (${f_chkprd} == 'W')
                          AND C2.SLS_YRMON BETWEEN C6.OFC_APLY_FM_YRMON  and C6.OFC_APLY_TO_YRMON 
                      #elseif (${f_chkprd} == 'M')
                          AND C2.COST_YRMON BETWEEN C6.OFC_APLY_FM_YRMON  and C6.OFC_APLY_TO_YRMON 
                      #end    
    
             GROUP BY C1.P_REPORT
                     ,DECODE(C1.P_REPORT, '1', 'X', C6.OFC_N3RD_LVL_CD)
                     ,DECODE(C1.P_REPORT, '3', C6.OFC_N5TH_LVL_CD, 'X')
                     ,CASE C5.COST_ACT_GRP_CD 
                     		WHEN 'PRWD' THEN 'O' 
                     		WHEN 'POWD' THEN 'I'
                     		WHEN 'TRWD' THEN 'C' 
                     		ELSE C5.COST_IO_BND_CD 
                        END
                     ,C5.COST_ACT_GRP_TP_CD
                     ,C1.P_KPITYPE
                     ,DECODE(C1.P_KPITYPE, '1', 
                                  DECODE(C5.STTL_FLG, 'Y', 'ST', C5.LGS_KPI_MN_CD), 
                                  DECODE(C5.STTL_FLG, 'Y', 'SHTL', C5.LGS_KPI_CD)
                       )
              ) D2
    )
    WHERE  AMT  > 0			]]></sql>
			<params>
				<param name="f_year" type="12" value="" out="N"/>
				<param name="s_cost_yrmon2" type="12" value="" out="N"/>
				<param name="f_fm_mon" type="12" value="" out="N"/>
				<param name="f_to_mon" type="12" value="" out="N"/>
				<param name="f_sls_mon" type="12" value="" out="N"/>
				<param name="s_cost_wk2" type="12" value="" out="N"/>
				<param name="f_fm_wk" type="12" value="" out="N"/>
				<param name="f_to_wk" type="12" value="" out="N"/>
				<param name="f_report" type="12" value="" out="N"/>
				<param name="s_rhq_cd" type="12" value="" out="N"/>
				<param name="f_rhq_cd" type="12" value="" out="N"/>
				<param name="s_cntr_ofc_cd" type="12" value="" out="N"/>
				<param name="f_ctrl_ofc_cd" type="12" value="" out="N"/>
				<param name="f_in_out" type="12" value="" out="N"/>
				<param name="s_lgs_kpi_cost_grp_cd" type="12" value="" out="N"/>
				<param name="f_lgs_kpi_cost_grp_cd" type="12" value="" out="N"/>
				<param name="f_kpi_type" type="12" value="" out="N"/>
				<param name="s_kpi_cd" type="12" value="" out="N"/>
				<param name="f_lgs_mn_kpi_cd" type="12" value="" out="N"/>
				<param name="f_lgs_kpi_cd" type="12" value="" out="N"/>
				<param name="f_incld_mt" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
