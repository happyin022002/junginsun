<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="AncsManifestListDownloadDBDAOsearchAncsCstmsVvdListRSQL">
			<desc><![CDATA[s]]></desc>
			<sql><![CDATA[
SELECT   A.*, NVL (B.TTL_COUNT, 0) AS BKG_COUNT,
         NVL(C.TTL_COUNT, 0) AS DNLD_COUNT, D.EDI_STS, D.SND_DT,
		 NVL (B.TTL_COUNT, 0) - NVL(C.TTL_COUNT, 0) AS DIFF,
         D.SND_USR_ID, D.RCV_DT
       , NVL((SELECT 'Y'  
         FROM BKG_CSTMS_CD_CONV_CTNT
         WHERE CNT_CD = 'EU'
         AND CSTMS_DIV_ID = 'EU_STF'
         AND DELT_FLG = 'N'
         AND ATTR_CTNT1 = @[upd_usr_id]
         AND ROWNUM = 1), 'N') AS EU_STF_FLG
    FROM ( SELECT A.SLAN_CD AS SLAN_CD,
               A.VSL_CD || A.SKD_VOY_NO || A.SKD_DIR_CD AS VVD,
               D.SVC_RQST_NO AS SSR_NO,
               DECODE (D.VSL_CD, NULL, C.VSL_ENG_NM, D.VVD_NM) AS VVD_NM,
               DECODE (D.VSL_CD, NULL, 'L', LLOYD_TP_CD) AS LLOYD_TP_CD,
               DECODE (D.VSL_CD, NULL, C.LLOYD_NO, D.LLOYD_NO) AS LLOYD_NO,
               DECODE (D.VSL_CD, NULL, A.VPS_ETA_DT, D.ETA_DT) AS ETA_DT,
               DECODE (D.VSL_CD, NULL, 'N', D.ANR_MSG_STS_CD) AS MSG_STS_CD,
               A.VPS_PORT_CD AS PORT_CD
          FROM VSK_VSL_PORT_SKD A,
               VSK_VSL_SKD B,
               MDM_VSL_CNTR C,
               BKG_CSTMS_ANR_VVD D,
               BKG_HRD_CDG_CTNT E,
               BKG_CSTMS_CD_CONV_CTNT F
         WHERE 1=1
           AND A.VPS_ETA_DT >= TO_DATE (@[s_vps_eta_dt], 'YYYY-MM-DD')
           AND A.VPS_ETA_DT < TO_DATE (@[e_vps_eta_dt], 'YYYY-MM-DD') + 1
           
           #if (${vvd} != '')
				   AND A.VSL_CD        =  SUBSTR( @[vvd],1,4 )
				   AND A.SKD_VOY_NO    =  SUBSTR( @[vvd],5,4 )
				   AND A.SKD_DIR_CD    =  SUBSTR( @[vvd],9,1 )
				   #end
           
           AND E.HRD_CDG_ID = 'ANR_CSTMS_SLAN_CD'
           AND A.SLAN_CD = E.ATTR_CTNT1
           AND A.SKD_DIR_CD = DECODE (E.ATTR_CTNT2, 'A', A.SKD_DIR_CD, 'W')
           AND B.VSL_CD = A.VSL_CD
           AND B.SKD_VOY_NO = A.SKD_VOY_NO
           AND B.SKD_DIR_CD = A.SKD_DIR_CD
           AND C.VSL_CD = A.VSL_CD

           AND A.VPS_PORT_CD = F.ATTR_CTNT1
           AND F.CNT_CD = 'BE'
           AND F.CSTMS_DIV_ID  = 'EUR_BE_PORT_LIST'
           AND F.CSTMS_DIV_ID_SEQ > 0
           AND F.DELT_FLG = 'N'

           
           #if (${svc_rqst_no} != '') 
				   AND D.SVC_RQST_NO   = @[svc_rqst_no]
				   #end
				   
				   #if (${msg_sts_cd} != 'L') 
				   AND D.ANR_MSG_STS_CD = @[msg_sts_cd]
				   #end 
           
           AND D.VSL_CD(+) = A.VSL_CD
           AND D.SKD_VOY_NO(+) = A.SKD_VOY_NO
           AND D.SKD_DIR_CD(+) = A.SKD_DIR_CD ) A, 
         ( SELECT   A.VVD AS VVD, COUNT (C.BKG_NO) AS TTL_COUNT
            FROM ( SELECT A.SLAN_CD AS SLAN_CD,
               A.VSL_CD || A.SKD_VOY_NO || A.SKD_DIR_CD AS VVD,
               D.SVC_RQST_NO AS SSR_NO,
               DECODE (D.VSL_CD, NULL, C.VSL_ENG_NM, D.VVD_NM) AS VVD_NM,
               DECODE (D.VSL_CD, NULL, 'L', LLOYD_TP_CD) AS LLOYD_TP_CD,
               DECODE (D.VSL_CD, NULL, C.LLOYD_NO, D.LLOYD_NO) AS LLOYD_NO,
               DECODE (D.VSL_CD, NULL, A.VPS_ETA_DT, D.ETA_DT) AS ETA_DT,
               DECODE (D.VSL_CD, NULL, 'N', D.ANR_MSG_STS_CD) AS MSG_STS_CD,
               A.VPS_PORT_CD AS PORT_CD
          FROM VSK_VSL_PORT_SKD A,
               VSK_VSL_SKD B,
               MDM_VSL_CNTR C,
               BKG_CSTMS_ANR_VVD D,
               BKG_HRD_CDG_CTNT E,
               BKG_CSTMS_CD_CONV_CTNT F
         WHERE 1=1
           AND A.VPS_ETA_DT >= TO_DATE (@[s_vps_eta_dt], 'YYYY-MM-DD')
           AND A.VPS_ETA_DT < TO_DATE (@[e_vps_eta_dt], 'YYYY-MM-DD') + 1
           
           AND A.VPS_PORT_CD = F.ATTR_CTNT1
           AND F.CNT_CD = 'BE'
           AND F.CSTMS_DIV_ID  = 'EUR_BE_PORT_LIST'
           AND F.CSTMS_DIV_ID_SEQ > 0
           AND F.DELT_FLG = 'N'


           #if (${vvd} != '')
				   AND A.VSL_CD        =  SUBSTR( @[vvd],1,4 )
				   AND A.SKD_VOY_NO    =  SUBSTR( @[vvd],5,4 )
				   AND A.SKD_DIR_CD    =  SUBSTR( @[vvd],9,1 )
				   #end
           
           AND E.HRD_CDG_ID = 'ANR_CSTMS_SLAN_CD'
           AND A.SLAN_CD = E.ATTR_CTNT1
           AND A.SKD_DIR_CD = DECODE (E.ATTR_CTNT2, 'A', A.SKD_DIR_CD, 'W')
           AND B.VSL_CD = A.VSL_CD
           AND B.SKD_VOY_NO = A.SKD_VOY_NO
           AND B.SKD_DIR_CD = A.SKD_DIR_CD
           AND C.VSL_CD = A.VSL_CD
           
           #if (${svc_rqst_no} != '') 
				   AND D.SVC_RQST_NO   = @[svc_rqst_no]
				   #end
				   
				   #if (${msg_sts_cd} != 'L') 
				   AND D.ANR_MSG_STS_CD = @[msg_sts_cd]
				   #end 
           
           AND D.VSL_CD(+) = A.VSL_CD
           AND D.SKD_VOY_NO(+) = A.SKD_VOY_NO
           AND D.SKD_DIR_CD(+) = A.SKD_DIR_CD ) A, BKG_VVD B, BKG_BOOKING C
           WHERE B.VSL_CD = SUBSTR (A.VVD, 1, 4)
             AND B.SKD_VOY_NO = SUBSTR (A.VVD, 5, 4)
             AND B.SKD_DIR_CD = SUBSTR (A.VVD, 9, 1)
             AND B.POD_CD = A.PORT_CD
             AND C.BKG_NO = B.BKG_NO
             AND C.BKG_STS_CD <> 'X'
             AND C.BKG_CGO_TP_CD IN ('F', 'B')
        GROUP BY A.VVD ) B, 
        (SELECT   A.VVD AS VVD, COUNT (B.BL_NO) AS TTL_COUNT
            FROM ( SELECT A.SLAN_CD AS SLAN_CD,
               A.VSL_CD || A.SKD_VOY_NO || A.SKD_DIR_CD AS VVD,
               D.SVC_RQST_NO AS SSR_NO,
               DECODE (D.VSL_CD, NULL, C.VSL_ENG_NM, D.VVD_NM) AS VVD_NM,
               DECODE (D.VSL_CD, NULL, 'L', LLOYD_TP_CD) AS LLOYD_TP_CD,
               DECODE (D.VSL_CD, NULL, C.LLOYD_NO, D.LLOYD_NO) AS LLOYD_NO,
               DECODE (D.VSL_CD, NULL, A.VPS_ETA_DT, D.ETA_DT) AS ETA_DT,
               DECODE (D.VSL_CD, NULL, 'N', D.ANR_MSG_STS_CD) AS MSG_STS_CD,
               A.VPS_PORT_CD AS PORT_CD
          FROM VSK_VSL_PORT_SKD A,
               VSK_VSL_SKD B,
               MDM_VSL_CNTR C,
               BKG_CSTMS_ANR_VVD D,
               BKG_HRD_CDG_CTNT E,
               BKG_CSTMS_CD_CONV_CTNT F
         WHERE 1=1
           AND A.VPS_ETA_DT >= TO_DATE (@[s_vps_eta_dt], 'YYYY-MM-DD')
           AND A.VPS_ETA_DT < TO_DATE (@[e_vps_eta_dt], 'YYYY-MM-DD') + 1

           AND A.VPS_PORT_CD = F.ATTR_CTNT1
           AND F.CNT_CD = 'BE'
           AND F.CSTMS_DIV_ID  = 'EUR_BE_PORT_LIST'
           AND F.CSTMS_DIV_ID_SEQ > 0
           AND F.DELT_FLG = 'N'
           
           #if (${vvd} != '')
				   AND A.VSL_CD        =  SUBSTR( @[vvd],1,4 )
				   AND A.SKD_VOY_NO    =  SUBSTR( @[vvd],5,4 )
				   AND A.SKD_DIR_CD    =  SUBSTR( @[vvd],9,1 )
				   #end
           
           AND E.HRD_CDG_ID = 'ANR_CSTMS_SLAN_CD'
           AND A.SLAN_CD = E.ATTR_CTNT1
           AND A.SKD_DIR_CD = DECODE (E.ATTR_CTNT2, 'A', A.SKD_DIR_CD, 'W')
           AND B.VSL_CD = A.VSL_CD
           AND B.SKD_VOY_NO = A.SKD_VOY_NO
           AND B.SKD_DIR_CD = A.SKD_DIR_CD
           AND C.VSL_CD = A.VSL_CD
           
           #if (${svc_rqst_no} != '') 
				   AND D.SVC_RQST_NO   = @[svc_rqst_no]
				   #end
				   
				   #if (${msg_sts_cd} != 'L') 
				   AND D.ANR_MSG_STS_CD = @[msg_sts_cd]
				   #end 
           
           AND D.VSL_CD(+) = A.VSL_CD
           AND D.SKD_VOY_NO(+) = A.SKD_VOY_NO
           AND D.SKD_DIR_CD(+) = A.SKD_DIR_CD ) A, BKG_CSTMS_ANR_BL B
           WHERE B.VSL_CD = SUBSTR (A.VVD, 1, 4)
             AND B.SKD_VOY_NO = SUBSTR (A.VVD, 5, 4)
             AND B.SKD_DIR_CD = SUBSTR (A.VVD, 9, 1)
        GROUP BY A.VVD) C, 
        ( SELECT B.VSL_CD || B.SKD_VOY_NO || B.SKD_DIR_CD AS VVD,
               
--      NVL(B.EDI_SND_STS_CD, 'N') || NVL(B.EDI_RCV_STS_CD, 'N') AS EDI_STS,
               C.ATTR_CTNT2 AS EDI_STS, B.SND_DT AS SND_DT,
               B.EDI_SND_USR_ID AS SND_USR_ID, B.RCV_DT AS RCV_DT
          FROM ( SELECT A.SLAN_CD AS SLAN_CD,
               A.VSL_CD || A.SKD_VOY_NO || A.SKD_DIR_CD AS VVD,
               D.SVC_RQST_NO AS SSR_NO,
               DECODE (D.VSL_CD, NULL, C.VSL_ENG_NM, D.VVD_NM) AS VVD_NM,
               DECODE (D.VSL_CD, NULL, 'L', LLOYD_TP_CD) AS LLOYD_TP_CD,
               DECODE (D.VSL_CD, NULL, C.LLOYD_NO, D.LLOYD_NO) AS LLOYD_NO,
               DECODE (D.VSL_CD, NULL, A.VPS_ETA_DT, D.ETA_DT) AS ETA_DT,
               DECODE (D.VSL_CD, NULL, 'N', D.ANR_MSG_STS_CD) AS MSG_STS_CD,
               A.VPS_PORT_CD AS PORT_CD
          FROM VSK_VSL_PORT_SKD A,
               VSK_VSL_SKD B,
               MDM_VSL_CNTR C,
               BKG_CSTMS_ANR_VVD D,
               BKG_HRD_CDG_CTNT E,
               BKG_CSTMS_CD_CONV_CTNT F
         WHERE 1=1
           AND A.VPS_ETA_DT >= TO_DATE (@[s_vps_eta_dt], 'YYYY-MM-DD')
           AND A.VPS_ETA_DT < TO_DATE (@[e_vps_eta_dt], 'YYYY-MM-DD') + 1
           
           AND A.VPS_PORT_CD = F.ATTR_CTNT1
           AND F.CNT_CD = 'BE'
           AND F.CSTMS_DIV_ID  = 'EUR_BE_PORT_LIST'
           AND F.CSTMS_DIV_ID_SEQ > 0
           AND F.DELT_FLG = 'N'

           #if (${vvd} != '')
				   AND A.VSL_CD        =  SUBSTR( @[vvd],1,4 )
				   AND A.SKD_VOY_NO    =  SUBSTR( @[vvd],5,4 )
				   AND A.SKD_DIR_CD    =  SUBSTR( @[vvd],9,1 )
				   #end
           
           AND E.HRD_CDG_ID = 'ANR_CSTMS_SLAN_CD'
           AND A.SLAN_CD = E.ATTR_CTNT1
           AND A.SKD_DIR_CD = DECODE (E.ATTR_CTNT2, 'A', A.SKD_DIR_CD, 'W')
           AND B.VSL_CD = A.VSL_CD
           AND B.SKD_VOY_NO = A.SKD_VOY_NO
           AND B.SKD_DIR_CD = A.SKD_DIR_CD
           AND C.VSL_CD = A.VSL_CD
           
           #if (${svc_rqst_no} != '') 
				   AND D.SVC_RQST_NO   = @[svc_rqst_no]
				   #end
				   
				   #if (${msg_sts_cd} != 'L') 
				   AND D.ANR_MSG_STS_CD = @[msg_sts_cd]
				   #end 
           
           AND D.VSL_CD(+) = A.VSL_CD
           AND D.SKD_VOY_NO(+) = A.SKD_VOY_NO
           AND D.SKD_DIR_CD(+) = A.SKD_DIR_CD ) A,
               BKG_CSTMS_ANR_EDI_HIS B,
               BKG_HRD_CDG_CTNT C
         WHERE B.MSG_TP_CD = 'R'                                     -- CUSREP
           AND B.ANR_DECL_NO = A.SSR_NO || LLOYD_TP_CD || LLOYD_NO
           AND B.VSL_CD = SUBSTR (A.VVD, 1, 4)
           AND B.SKD_VOY_NO = SUBSTR (A.VVD, 5, 4)
           AND B.SKD_DIR_CD = SUBSTR (A.VVD, 9, 1)
           AND B.REF_SEQ =
                  (SELECT MAX (C.REF_SEQ)
                     FROM BKG_CSTMS_ANR_EDI_HIS C
                    WHERE C.MSG_TP_CD = B.MSG_TP_CD
                      AND C.ANR_DECL_NO = B.ANR_DECL_NO
                      AND C.VSL_CD = B.VSL_CD
                      AND C.SKD_VOY_NO = B.SKD_VOY_NO
                      AND C.SKD_DIR_CD = B.SKD_DIR_CD)
           AND C.HRD_CDG_ID(+) = 'ANR_CSTMS_EDI_STS_CD'
           AND C.ATTR_CTNT1(+) =
                     NVL (B.EDI_SND_STS_CD, 'N')
                     || NVL (B.EDI_RCV_STS_CD, 'N') ) D
   WHERE B.VVD(+) = A.VVD 
   AND C.VVD(+) = A.VVD 
   AND D.VVD(+) = A.VVD
   #if (${bkg_count} != 'A') 
       #if (${bkg_count} == 'N')
	       AND ( (B.TTL_COUNT > 0) AND (B.TTL_COUNT <> C.TTL_COUNT) )
       #end
       #if (${bkg_count} == 'F')
	       AND ( (B.TTL_COUNT = 0) OR (B.TTL_COUNT = C.TTL_COUNT) )    
       #end
   #end
ORDER BY A.ETA_DT ASC			]]></sql>
			<params>
				<param name="upd_usr_id" type="12" value="" out="N"/>
				<param name="s_vps_eta_dt" type="12" value="" out="N"/>
				<param name="e_vps_eta_dt" type="12" value="" out="N"/>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="svc_rqst_no" type="12" value="" out="N"/>
				<param name="msg_sts_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
