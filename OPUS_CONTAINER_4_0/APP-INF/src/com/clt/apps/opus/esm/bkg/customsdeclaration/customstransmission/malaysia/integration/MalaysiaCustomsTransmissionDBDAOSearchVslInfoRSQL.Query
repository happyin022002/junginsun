<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="MalaysiaCustomsTransmissionDBDAOSearchVslInfoRSQL">
			<desc><![CDATA[2012.02.02 변종건 [CHM-201215473-01] Malaysis (MYTPP) Customs Manifest 전송 기능 추가 요청]]></desc>
			<sql><![CDATA[
SELECT    @[e_i_ind] E_I_IND
         ,@[trsm_sts] STATUS
         ,P.VSL_CD||P.SKD_VOY_NO||P.SKD_DIR_CD VVD
         ,DECODE(@[e_i_ind], 'I', P.IB_CSSM_VOY_NO, OB_CSSM_VOY_NO) CON_VVD ------------------------  
         ,NVL(V.VSL_ENG_NM,' ') VSL_FULLNAME
         ,V.LLOYD_NO VSL_AUTH_NO
         ,V.VSL_RGST_CNT_CD VSL_NATION_CD
         ,P.VPS_PORT_CD PORT
         ,L.LOC_NM PORT_NM
         ,TO_CHAR(P.VPS_ETA_DT,'YYYYMMDD') ETA
         ,TO_CHAR(P.VPS_ETD_DT,'YYYYMMDD') ETD
         ,(SELECT VVD1.VSL_CD||VVD1.SKD_VOY_NO||VVD1.SKD_DIR_CD
            FROM BKG_VVD VVD1,
              (
                SELECT BKG_NO,
                  POD_CD
                FROM BKG_VVD
                WHERE BKG_NO = @[bkg_no]
                  AND VSL_CD = SUBSTR(@[vvd],1,4)
                  AND SKD_VOY_NO = SUBSTR(@[vvd],5,4)
                  AND SKD_DIR_CD = SUBSTR(@[vvd],9,1)
                  AND DECODE(@[e_i_ind], 'E', POL_CD, POD_CD) = DECODE(@[e_i_ind], 'E', @[input_pol_cd], @[input_pod_cd])
                       ) VVD2
            WHERE VVD1.BKG_NO = @[bkg_no]
              AND VVD1.POL_CD = VVD2.POD_CD)TS_VVD

         ,(SELECT VSL_ENG_NM
            FROM MDM_VSL_CNTR
            WHERE VSL_CD = (
            SELECT VVD1.VSL_CD
            FROM BKG_VVD VVD1,
              (
                SELECT BKG_NO,
                  POD_CD
                FROM BKG_VVD
                WHERE BKG_NO = @[bkg_no]
                  AND VSL_CD = SUBSTR(@[vvd],1,4)
                  AND SKD_VOY_NO = SUBSTR(@[vvd],5,4)
                  AND SKD_DIR_CD = SUBSTR(@[vvd],9,1)
                  AND  DECODE(@[e_i_ind], 'E', POL_CD, POD_CD) = DECODE(@[e_i_ind], 'E', @[input_pol_cd], @[input_pod_cd])) VVD2
            WHERE VVD1.BKG_NO = @[bkg_no]
              AND VVD1.POL_CD = VVD2.POD_CD
              ))TS_VSL_FULLNAME

         ,(SELECT VSL_RGST_CNT_CD
            FROM MDM_VSL_CNTR
            WHERE VSL_CD = (
            SELECT VVD1.VSL_CD
            FROM BKG_VVD VVD1,
              (
                SELECT BKG_NO,
                  POD_CD
                FROM BKG_VVD
                WHERE BKG_NO = @[bkg_no]
                  AND VSL_CD = SUBSTR(@[vvd],1,4)
                  AND SKD_VOY_NO = SUBSTR(@[vvd],5,4)
                  AND SKD_DIR_CD = SUBSTR(@[vvd],9,1)
                  AND  DECODE(@[e_i_ind], 'E', POL_CD, POD_CD) = DECODE(@[e_i_ind], 'E', @[input_pol_cd], @[input_pod_cd]) ) VVD2
            WHERE VVD1.BKG_NO = @[bkg_no]
              AND VVD1.POL_CD = VVD2.POD_CD
              ))TS_VSL_NATION_CD

         ,( SELECT CVY_REF_NO
             FROM BKG_VSL_DCHG_YD D
             WHERE (D.VSL_CD,
                   D.SKD_VOY_NO,
                   D.SKD_DIR_CD,
                   D.PORT_CD) = (
                 SELECT VVD1.VSL_CD, VVD1.SKD_VOY_NO, VVD1.SKD_DIR_CD, VVD1.POD_CD
                 FROM BKG_VVD VVD1,
                   (
                     SELECT BKG_NO,
                       POD_CD
                     FROM BKG_VVD
                     WHERE BKG_NO = @[bkg_no]
                       AND VSL_CD = SUBSTR(@[vvd],1,4)
                       AND SKD_VOY_NO = SUBSTR(@[vvd],5,4)
                       AND SKD_DIR_CD = SUBSTR(@[vvd],9,1)
                       AND  DECODE(@[e_i_ind], 'E', POL_CD, POD_CD) = DECODE(@[e_i_ind], 'E', @[input_pol_cd], @[input_pod_cd]) ) VVD2
                 WHERE VVD1.BKG_NO = @[bkg_no]
                   AND VVD1.POL_CD = VVD2.POD_CD ))TS_VSL_SCN

#if (${ts_tp_cd} == 'T')
         ,'T' TS_TP_CD
#else 
         ,'L' TS_TP_CD
#end
		 ,(SELECT CVY_REF_NO 
             FROM BKG_VSL_DCHG_YD D 
            where D.VSL_CD     = SUBSTR(@[vvd],1,4)
              AND D.SKD_VOY_NO = SUBSTR(@[vvd],5,4)
              AND D.SKD_DIR_CD = SUBSTR(@[vvd],9,1)
			#if (${e_i_ind} == 'E')
			  AND D.PORT_CD = @[input_pol_cd]        --Mode=Outbound 조건
			#else
			  AND D.PORT_CD = @[input_pod_cd]        --Mode=Inbound 조건
			#end              
			  and ROWNUM = 1 ) VSL_CALL_NO
FROM      VSK_VSL_PORT_SKD P, MDM_VSL_CNTR V, MDM_LOCATION L
WHERE     1 = 1
AND       P.VSL_CD = SUBSTR(@[vvd],1,4)
AND       P.SKD_VOY_NO = SUBSTR(@[vvd],5,4)
AND       P.SKD_DIR_CD = SUBSTR(@[vvd],9,1)
#if (${e_i_ind} == 'E')
AND       P.VPS_PORT_CD = @[input_pol_cd]        --Mode=Outbound 조건
#else
AND       P.VPS_PORT_CD = @[input_pod_cd]        --Mode=Inbound 조건
#end
AND       L.LOC_CD=P.VPS_PORT_CD
AND       V.VSL_CD(+) = P.VSL_CD			]]></sql>
			<params>
				<param name="e_i_ind" type="12" value="" out="N"/>
				<param name="trsm_sts" type="12" value="" out="N"/>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="input_pol_cd" type="12" value="" out="N"/>
				<param name="input_pod_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
