<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TransshipmentMgtDBDAOsearchVvdDetailForPortAssignRSQL">
			<desc><![CDATA[Search Booking VVD Detail for Group VVD/Port Assign]]></desc>
			<sql><![CDATA[
WITH SORTED_VVD AS ( 
	SELECT 	BKG_NO
			,VSL_PRE_PST_CD
			,VSL_SEQ
			,RANK() OVER(PARTITION BY BKG_NO ORDER BY VSL_PRE_PST_CD, VSL_SEQ) AS VVD_ORDER
        	,SLAN_CD
			,VSL_CD
			,SKD_VOY_NO
			,SKD_DIR_CD
			,OP_CD
			,POL_CLPT_IND_SEQ
			,POL_CD
			,POL_YD_CD
			,POD_CLPT_IND_SEQ
			,POD_CD
			,POD_YD_CD
	FROM BKG_VVD VVD
	WHERE 0=0
	AND EXISTS(
		SELECT *
		FROM BKG_VVD VVD_COND
		INNER JOIN BKG_BOOKING BKG
		ON VVD_COND.BKG_NO = BKG.BKG_NO
		WHERE VVD.BKG_NO=VVD_COND.BKG_NO
		#if (${vvd}!='')
			AND VVD_COND.VSL_CD = SUBSTR(@[vvd] ,1,4)
			AND VVD_COND.SKD_VOY_NO = SUBSTR(@[vvd] ,5,4)
			AND VVD_COND.SKD_DIR_CD = SUBSTR(@[vvd] ,9,1)

    		#if(${pol} !='')
				AND VVD_COND.POL_CD = @[pol]
			#end
    		#if(${pol_yd_cd} !='')
				AND SUBSTR(VVD_COND.POL_YD_CD,6,2) = @[pol_yd_cd]
			#end
			#if (${pod}!='')
				AND VVD_COND.POD_CD = @[pod]
			#end
    		#if(${pod_yd_cd} !='')
				AND SUBSTR(VVD_COND.POD_YD_CD,6,2) = @[pod_yd_cd]
			#end

		#end

		AND BKG.BKG_STS_CD NOT IN ('X','S')

		#if (${bkg_ofc_cd}!='')
			AND BKG.BKG_OFC_CD = @[bkg_ofc_cd]
		#end

	)
	#if (${bkgNos} != '')
		AND VVD.BKG_NO IN (
			#foreach($multiBkgNoVal IN ${bkgNos})        
				#if($velocityCount < $bkgNos.size()) '$multiBkgNoVal', #else '$multiBkgNoVal' #end
			#end
		)
	#end
)
SELECT 	BKG.BKG_NO
		,BKG.BL_NO
		,BKG.POR_CD
		,BKG.POR_NOD_CD
		,BKG.POL_CD
		,BKG.POL_NOD_CD
		,BKG.POD_CD
		,BKG.POD_NOD_CD
		,BKG.DEL_CD
		,BKG.DEL_NOD_CD
		,BKG.RCV_TERM_CD
		,BKG.DE_TERM_CD
		,BKG.MTY_PKUP_YD_CD
		,BKG.ORG_TRNS_MOD_CD
		,BKG.DEST_TRNS_MOD_CD
		,TVVD.VSL_CD||TVVD.SKD_VOY_NO||TVVD.SKD_DIR_CD TVVD
		,TO_CHAR(BKG.MTY_PKUP_DT,'YYYY-MM-DD') MTY_PKUP_DT
		,BKG.FULL_RTN_YD_CD
		,VVD1.POL_CD POL_CD1
		,VVD1.POL_YD_CD POL_YD_CD1
		,VVD1.POL_CLPT_IND_SEQ POL_CLPT_IND_SEQ1
		,VVD1.VSL_CD||VVD1.SKD_VOY_NO||VVD1.SKD_DIR_CD VVD1
		,VVD1.POD_CD POD_CD1
		,VVD1.POD_YD_CD POD_YD_CD1
		,VVD1.POD_CLPT_IND_SEQ POD_CLPT_IND_SEQ1
		,VVD2.POL_CD POL_CD2
		,VVD2.POL_YD_CD POL_YD_CD2
		,VVD2.POL_CLPT_IND_SEQ POL_CLPT_IND_SEQ2
		,VVD2.VSL_CD||VVD2.SKD_VOY_NO||VVD2.SKD_DIR_CD VVD2
		,VVD2.POD_CD POD_CD2
		,VVD2.POD_YD_CD POD_YD_CD2
		,VVD2.POD_CLPT_IND_SEQ POD_CLPT_IND_SEQ2
		,VVD3.POL_CD POL_CD3
		,VVD3.POL_YD_CD POL_YD_CD3
		,VVD3.POL_CLPT_IND_SEQ POL_CLPT_IND_SEQ3
		,VVD3.VSL_CD||VVD3.SKD_VOY_NO||VVD3.SKD_DIR_CD VVD3
		,VVD3.POD_CD POD_CD3
		,VVD3.POD_YD_CD POD_YD_CD3
		,VVD3.POD_CLPT_IND_SEQ POD_CLPT_IND_SEQ3
		,VVD4.POL_CD POL_CD4
		,VVD4.POL_YD_CD POL_YD_CD4
		,VVD4.POL_CLPT_IND_SEQ POL_CLPT_IND_SEQ4
		,VVD4.VSL_CD||VVD4.SKD_VOY_NO||VVD4.SKD_DIR_CD VVD4
		,VVD4.POD_CD POD_CD4
		,VVD4.POD_YD_CD POD_YD_CD4
		,VVD4.POD_CLPT_IND_SEQ POD_CLPT_IND_SEQ4

		,NVL(BKG.POR_CD,'')||'|'||NVL(BKG.POL_NOD_CD,'')||'|'||NVL(BKG.POD_NOD_CD,'')||'|'||NVL(BKG.DEL_CD,'')
         ||'|'||NVL(TVVD.VSL_CD,'')||NVL(TVVD.SKD_VOY_NO,'')||NVL(TVVD.SKD_DIR_CD,'')
		 ||'|'||NVL(PRE.VSL_CD,'')||NVL(PRE.SKD_VOY_NO,'')||NVL(PRE.SKD_DIR_CD,'')||'|'||NVL(PRE.POD_YD_CD,'')
		 ||'|'||NVL(POST.VSL_CD,'')||NVL(POST.SKD_VOY_NO,'')||NVL(POST.SKD_DIR_CD,'')||'|'||NVL(POST.POL_YD_CD,'')
		 ROUTE_KEY
		,       NVL(VVD1.POL_YD_CD,'')||'|'||NVL(VVD1.VSL_CD||VVD1.SKD_VOY_NO||VVD1.SKD_DIR_CD,'')||'|'||VVD1.POD_YD_CD
         ||'|'||NVL(VVD2.POL_YD_CD,'')||'|'||NVL(VVD2.VSL_CD||VVD2.SKD_VOY_NO||VVD2.SKD_DIR_CD,'')||'|'||VVD2.POD_YD_CD
         ||'|'||NVL(VVD3.POL_YD_CD,'')||'|'||NVL(VVD3.VSL_CD||VVD3.SKD_VOY_NO||VVD3.SKD_DIR_CD,'')||'|'||VVD3.POD_YD_CD
         ||'|'||NVL(VVD4.POL_YD_CD,'')||'|'||NVL(VVD4.VSL_CD||VVD4.SKD_VOY_NO||VVD4.SKD_DIR_CD,'')||'|'||VVD4.POD_YD_CD
		 VVD_KEY
		,CASE WHEN VVD1.VSL_PRE_PST_CD = 'T' THEN '1'
		      WHEN VVD2.VSL_PRE_PST_CD = 'T' THEN '2'
		      WHEN VVD3.VSL_PRE_PST_CD = 'T' THEN '3'
		      WHEN VVD4.VSL_PRE_PST_CD = 'T' THEN '4'
		      ELSE '' END TVVD_SEQ

FROM SORTED_VVD VVD1
INNER JOIN BKG_BOOKING BKG
	ON VVD1.BKG_NO=BKG.BKG_NO
INNER JOIN SORTED_VVD TVVD
	ON VVD1.BKG_NO = TVVD.BKG_NO
	AND TVVD.VSL_PRE_PST_CD = 'T'
LEFT OUTER JOIN SORTED_VVD VVD2
	ON VVD1.BKG_NO = VVD2.BKG_NO
	AND VVD2.VVD_ORDER = 2
LEFT OUTER JOIN SORTED_VVD VVD3
	ON VVD1.BKG_NO = VVD3.BKG_NO
	AND VVD3.VVD_ORDER = 3
LEFT OUTER JOIN SORTED_VVD VVD4
	ON VVD1.BKG_NO = VVD4.BKG_NO
	AND VVD4.VVD_ORDER = 4
LEFT OUTER JOIN SORTED_VVD PRE
	ON VVD1.BKG_NO = PRE.BKG_NO
	AND PRE.VSL_PRE_PST_CD = 'S'
	AND TVVD.POL_CD = PRE.POD_CD
LEFT OUTER JOIN SORTED_VVD POST
	ON VVD1.BKG_NO = POST.BKG_NO
	AND POST.VSL_PRE_PST_CD = 'U'
	AND TVVD.POD_CD = POST.POL_CD

WHERE 0=0
AND VVD1.VVD_ORDER = 1

ORDER BY 
	BKG.POR_CD
	,BKG.POL_NOD_CD
	,BKG.POD_NOD_CD
	,BKG.DEL_CD
	,NVL(TVVD.VSL_CD,'')||NVL(TVVD.SKD_VOY_NO,'')||NVL(TVVD.SKD_DIR_CD,'')
	,NVL(PRE.VSL_CD,'')||NVL(PRE.SKD_VOY_NO,'')||NVL(PRE.SKD_DIR_CD,'')
	,NVL(PRE.POD_YD_CD,'')
	,NVL(POST.VSL_CD,'')||NVL(POST.SKD_VOY_NO,'')||NVL(POST.SKD_DIR_CD,'')
	,NVL(POST.POL_YD_CD,'')
	,BKG.BKG_NO			]]></sql>
			<params>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="pol" type="12" value="" out="N"/>
				<param name="pol_yd_cd" type="12" value="" out="N"/>
				<param name="pod" type="12" value="" out="N"/>
				<param name="pod_yd_cd" type="12" value="" out="N"/>
				<param name="bkg_ofc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
