<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="AGNCommApprovalDBDAOASearchGNCommApprovalMasterListRSQL">
			<desc><![CDATA[AGNCommApprovalMaster
2016.05.18 #13041 Insert CSR Creation Date column in all CSR I/F screens 
- CSR_CRT_DT add]]></desc>
			<sql><![CDATA[
SELECT A.AUD_NO,
       A.AGN_CD,
       A.VNDR_SEQ,
       (SELECT VNDR_LGL_ENG_NM FROM MDM_VENDOR M WHERE M.VNDR_SEQ = A.VNDR_SEQ AND M.DELT_FLG = 'N') AS VNDR_NM,
       A.VVD_CNT,
       A.CURR_CD,
       A.NET_AMT,
       A.VAT,
       A.TTL_AMT,
       A.CSR_NO,
       A.APRO_DT,
       A.IF_DT,
       CASE B.IF_FLG
         WHEN 'Y' THEN 'Success'
         ELSE
         CASE SUBSTR(B.IF_ERR_RSN, 0, 20)
           WHEN 'Duplicate CSR Number' THEN 'Already Interfaced'
           ELSE B.IF_ERR_RSN
         END
       END AS IF_FLG_MSG,
       CASE B.RCV_ERR_FLG
         WHEN 'Y' THEN 'Success'
         ELSE B.RCV_ERR_RSN
       END AS RCV_ERR_FLG_MSG,
       CASE SUBSTR(B.IF_ERR_RSN, 0, 20)
         WHEN 'Duplicate CSR Number' THEN 'Y'
         ELSE B.IF_FLG
       END AS IF_FLG,
       B.RCV_ERR_FLG,
       B.PAY_AMT,
       B.PAY_DT,
       B.PAY_MZD_LU_CD,
       B.CRE_DT      AS CSR_CRE_DT,
       C.RQST_USR_ID AS RQST_USR_ID,
       C.RQST_USR_NM AS RQST_USR_NM,
       C.APRO_USR_ID AS APRO_USR_ID,
       C.APRO_USR_NM AS APRO_USR_NM
  FROM (SELECT AUD_NO,
               AGN_CD,
               VNDR_SEQ,
               COUNT(DISTINCT AC_VSL_CD||AC_SKD_VOY_NO||AC_SKD_DIR_CD||AC_REV_DIR_CD) AS VVD_CNT,
               CURR_CD,
               ROUND(NVL(SUM(PAY_IF_AMT), 0), 2) AS NET_AMT,
               ROUND(NVL(AVG(INV_TAX_RT), 0), 2) AS VAT,
               ROUND(SUM(PAY_IF_AMT + (PAY_IF_AMT * NVL(INV_TAX_RT, 0) / 100)), DECODE(CURR_CD, 'JPY', 0, 2)) AS TTL_AMT,
               CSR_NO,
               TO_CHAR(APRO_DT, 'YYYYMMDD') AS APRO_DT,
               TO_CHAR(IF_DT, 'YYYYMMDD') AS IF_DT
          FROM ACM_AGN_COMM
         WHERE 1=1
           AND AGN_CD = @[agn_cd]
#if(${ac_sts_cd} == 'AS')
           AND AC_STS_CD = 'AS'
#elseif(${ac_sts_cd} == 'PS')
           AND AC_STS_CD IN ( 'PS', 'IF' )
#elseif(${ac_sts_cd} == 'IC')
           AND AC_STS_CD = @[ac_sts_cd]
#end
           AND CRE_USR_ID <> 'COST' -- 2007.05.07 이전데이터는 검색대상에서 제외
#if(${ac_sts_cd} == 'AS')
           AND AUD_DT          >= TO_DATE(REPLACE(@[date_fm],'-', ''),'YYYYMMDD')
           AND AUD_DT          <  TO_DATE(REPLACE(@[date_to],'-', ''),'YYYYMMDD') + 1  -- AS(Audit Success)
#elseif(${ac_sts_cd} == 'PS')
           AND (
                (APRO_DT BETWEEN TO_DATE(REPLACE(@[date_fm],'-', ''),'YYYYMMDD') AND TO_DATE(REPLACE(@[date_to],'-', ''),'YYYYMMDD') + 1 ) -- PS
             OR (IF_DT   BETWEEN TO_DATE(REPLACE(@[date_fm],'-', ''),'YYYYMMDD') AND TO_DATE(REPLACE(@[date_to],'-', ''),'YYYYMMDD') + 1 ) -- IF
                )
#elseif(${ac_sts_cd} == 'IC')
           AND UPD_DT           >= TO_DATE(REPLACE(@[date_fm],'-', ''),'YYYYMMDD')
           AND UPD_DT           <  TO_DATE(REPLACE(@[date_to],'-', ''),'YYYYMMDD') + 1  -- IF(Interface Success)
#end
         GROUP BY AUD_NO,
               AGN_CD,
               VNDR_SEQ,
               CURR_CD,
               CSR_NO,
               TO_CHAR(APRO_DT, 'YYYYMMDD'),
               TO_CHAR(IF_DT, 'YYYYMMDD') 
UNION ALL 

SELECT AUD_NO,
               AGN_CD,
               VNDR_SEQ,
               COUNT(DISTINCT AC_VSL_CD||AC_SKD_VOY_NO||AC_SKD_DIR_CD||AC_REV_DIR_CD) AS VVD_CNT,
               CURR_CD,
               ROUND(NVL(SUM(PAY_IF_AMT), 0), 2) AS NET_AMT,
               ROUND(NVL(AVG(INV_TAX_RT), 0), 2) AS VAT,
               ROUND(SUM(PAY_IF_AMT + (PAY_IF_AMT * NVL(INV_TAX_RT, 0) / 100)), DECODE(CURR_CD, 'JPY', 0, 2)) AS TTL_AMT,
               CSR_NO,
               TO_CHAR(APRO_DT, 'YYYYMMDD') AS APRO_DT,
               TO_CHAR(IF_DT, 'YYYYMMDD') AS IF_DT
          FROM ACM_AGN_OTR_COMM
         WHERE 1=1
           AND AGN_CD = @[agn_cd]
#if(${ac_sts_cd} == 'AS')
           AND AC_STS_CD = 'AS'
#elseif(${ac_sts_cd} == 'PS')
           AND AC_STS_CD IN ( 'PS', 'IF' )
#elseif(${ac_sts_cd} == 'IC')
           AND AC_STS_CD = @[ac_sts_cd]
#end
           AND CRE_USR_ID <> 'COST' -- 2007.05.07 이전데이터는 검색대상에서 제외
#if(${ac_sts_cd} == 'AS')
           AND AUD_DT          >= TO_DATE(REPLACE(@[date_fm],'-', ''),'YYYYMMDD')
           AND AUD_DT          <  TO_DATE(REPLACE(@[date_to],'-', ''),'YYYYMMDD') + 1  -- AS(Audit Success)
#elseif(${ac_sts_cd} == 'PS')
           AND (
                (APRO_DT BETWEEN TO_DATE(REPLACE(@[date_fm],'-', ''),'YYYYMMDD') AND TO_DATE(REPLACE(@[date_to],'-', ''),'YYYYMMDD') + 1 ) -- PS
             OR (IF_DT   BETWEEN TO_DATE(REPLACE(@[date_fm],'-', ''),'YYYYMMDD') AND TO_DATE(REPLACE(@[date_to],'-', ''),'YYYYMMDD') + 1 ) -- IF
                )
#elseif(${ac_sts_cd} == 'IC')
           AND UPD_DT           >= TO_DATE(REPLACE(@[date_fm],'-', ''),'YYYYMMDD')
           AND UPD_DT           <  TO_DATE(REPLACE(@[date_to],'-', ''),'YYYYMMDD') + 1  -- IF(Interface Success)
#end
         GROUP BY AUD_NO,
               AGN_CD,
               VNDR_SEQ,
               CURR_CD,
               CSR_NO,
               TO_CHAR(APRO_DT, 'YYYYMMDD'),
               TO_CHAR(IF_DT, 'YYYYMMDD') 
		) A,
       AP_INV_HDR B,
       (SELECT H.RQST_USR_ID AS RQST_USR_ID
             , H.RQST_USR_NM AS RQST_USR_NM
             , R.APRO_USR_ID AS APRO_USR_ID
             , R.APRO_USR_NM AS APRO_USR_NM
             , D.CSR_NO      AS CSR_NO
          FROM COM_APRO_RQST_HDR H
             , COM_APRO_RQST_ROUT R
             , COM_APRO_CSR_DTL D
         WHERE 1=1
           AND H.APRO_RQST_NO = R.APRO_RQST_NO
           AND H.CRNT_APRO_SEQ = R.APRO_RQST_SEQ
           AND R.APRO_RQST_NO = D.APRO_RQST_NO
		) C
 WHERE A.CSR_NO = B.CSR_NO(+)
   AND B.CSR_NO = C.CSR_NO(+)
#if(${ac_sts_cd} == 'IE')
   AND B.IF_FLG = 'E'
#end
 ORDER BY 1			]]></sql>
			<params>
				<param name="agn_cd" type="12" value="" out="N"/>
				<param name="ac_sts_cd" type="12" value="" out="N"/>
				<param name="date_fm" type="12" value="" out="N"/>
				<param name="date_to" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
