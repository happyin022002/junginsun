<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="StatusReportDBDAOSearchVgmHistoryRSQL">
			<desc><![CDATA[Search VGM History]]></desc>
			<sql><![CDATA[
SELECT DENSE_RANK() OVER(
         ORDER BY MST.VGM_CRE_GLO_DT) VGM_SEQ, MST.*
FROM ((SELECT BB.BKG_NO,
	          VGM.CNTR_NO,
	   		  TO_CHAR(DECODE(VGM.WGT_TP_CD,'V',ROUND(DECODE(VGM.WGT_UT_CD,'KGS',VGM.VGM_WGT ,'LBS', VGM.VGM_WGT * 0.453592,NULL),3)
                                     	  ,'C',ROUND(DECODE(VGM.WGT_UT_CD,'KGS',VGM.VGM_WGT ,'LBS', VGM.VGM_WGT * 0.453592,NULL),3)+MST_SPEC_FNC('TARE', VGM.CNTR_NO)),'FM9999999990.000') VGM_WGT,
	          'KGS' WGT_UT_CD,
              VGM.ESIG_CO_NM,
              VGM.USR_ID,
              NVL(VGM.IF_FLG, 'N') IF_FLG,
              TO_CHAR(VGM.VGM_CRE_LOCL_DT, 'YYYY-MM-DD HH24:MI') VGM_CRE_LOCL_DT,
              TO_CHAR(VGM.VGM_CRE_GDT, 'YYYY-MM-DD HH24:MI') VGM_CRE_GLO_DT,
              '' XTER_VGM_DOC_ID,
              VGM_SEQ XTER_VGM_RQST_SEQ
	     FROM BKG_XTER_VGM VGM,
			  BKG_CONTAINER BC,
			  BKG_BOOKING BB
	    WHERE BB.BKG_NO = @[bkg_no]
          AND SUBSTR(VGM.BKG_NO,1,10) = SUBSTR(BB.BKG_NO,1,10)
          AND BB.BKG_NO = BC.BKG_NO
          AND BC.CNTR_NO = VGM.CNTR_NO
          AND VGM.ACT_TP_CD = 'I'
		UNION
	   SELECT BB.BKG_NO,
	          VGM.CNTR_NO,
	   		  TO_CHAR(DECODE(VGM.WGT_TP_CD,'V',ROUND(DECODE(VGM.WGT_UT_CD,'KGS',VGM.VGM_WGT ,'LBS', VGM.VGM_WGT * 0.453592,NULL),3)
                                     	  ,'C',ROUND(DECODE(VGM.WGT_UT_CD,'KGS',VGM.VGM_WGT ,'LBS', VGM.VGM_WGT * 0.453592,NULL),3)+MST_SPEC_FNC('TARE', VGM.CNTR_NO)),'FM9999999990.000') VGM_WGT,
	          'KGS' WGT_UT_CD,
              VGM.ESIG_CO_NM,
              VGM.USR_ID,
              NVL(VGM.IF_FLG, 'N') IF_FLG,
              TO_CHAR(VGM.VGM_CRE_LOCL_DT, 'YYYY-MM-DD HH24:MI') VGM_CRE_LOCL_DT,
              TO_CHAR(VGM.VGM_CRE_GDT, 'YYYY-MM-DD HH24:MI') VGM_CRE_GLO_DT,
              '' XTER_VGM_DOC_ID,
              VGM_SEQ XTER_VGM_RQST_SEQ
	     FROM BKG_XTER_VGM VGM,
			  BKG_CONTAINER BC,
			  BKG_BOOKING BB,
			  BKG_BOOKING TGT_BKG
	    WHERE BB.BKG_NO = @[bkg_no]
          AND BB.VSL_CD = TGT_BKG.VSL_CD
          AND BB.SKD_VOY_NO = TGT_BKG.SKD_VOY_NO
          AND BB.SKD_DIR_CD = TGT_BKG.SKD_DIR_CD
          AND BB.POL_CD = TGT_BKG.POL_CD
          AND BB.POD_CD = TGT_BKG.POD_CD
          AND VGM.BKG_NO = TGT_BKG.BKG_NO
          AND BB.BKG_NO = BC.BKG_NO
          AND BC.CNTR_NO = VGM.CNTR_NO
          AND VGM.ACT_TP_CD = 'I'
		UNION
		SELECT BB.BKG_NO,
	          VGM.CNTR_NO,
	   		  TO_CHAR(DECODE(VGM.WGT_TP_CD,'V',ROUND(DECODE(VGM.WGT_UT_CD,'KGS',VGM.VGM_WGT ,'LBS', VGM.VGM_WGT * 0.453592,NULL),3)
                                     	  ,'C',ROUND(DECODE(VGM.WGT_UT_CD,'KGS',VGM.VGM_WGT ,'LBS', VGM.VGM_WGT * 0.453592,NULL),3)+MST_SPEC_FNC('TARE', VGM.CNTR_NO)),'FM9999999990.000') VGM_WGT,
	          'KGS' WGT_UT_CD,
              VGM.ESIG_CO_NM,
              VGM.USR_ID,
              NVL(VGM.IF_FLG, 'N') IF_FLG,
              TO_CHAR(VGM.VGM_CRE_LOCL_DT, 'YYYY-MM-DD HH24:MI') VGM_CRE_LOCL_DT,
              TO_CHAR(VGM.VGM_CRE_GDT, 'YYYY-MM-DD HH24:MI') VGM_CRE_GLO_DT,
              '' XTER_VGM_DOC_ID,
              VGM_SEQ XTER_VGM_RQST_SEQ
	     FROM BKG_XTER_VGM VGM,
			  BKG_CONTAINER BC,
			  BKG_BOOKING BB
	    WHERE BB.BKG_NO = @[bkg_no]
		  AND BB.BKG_NO = BC.BKG_NO
          AND VGM.BKG_NO = BC.XTER_VGM_DOC_ID 
          AND BC.XTER_SNDR_ID = 'WEB'
          AND BC.CNTR_NO = VGM.CNTR_NO
		  AND BC.XTER_VGM_RQST_SEQ = VGM.VGM_SEQ
		  AND BC.XTER_VGM_USR_ID = VGM.USR_ID
          AND VGM.ACT_TP_CD = 'I'
		)
       UNION ALL
      (SELECT REFNO.REF_NO,
        	  BXVR.CNTR_NO,
	          TO_CHAR(ROUND(DECODE(BXVR.WGT_UT_CD,'KGS',BXVR.VGM_WGT ,'LBS', BXVR.VGM_WGT * 0.453592,NULL),3),'FM9999999990.000') VGM_WGT,
	          'KGS' WGT_UT_CD,
	          (SELECT VGM_CUST_CNTC_NM 
                 FROM BKG_XTER_VGM_CUST 
                WHERE BXVR.XTER_SNDR_ID = XTER_SNDR_ID
                  AND BXVR.XTER_VGM_DOC_ID = XTER_VGM_DOC_ID
                  AND BXVR.XTER_VGM_RQST_SEQ = XTER_VGM_RQST_SEQ
                  AND BXVR.CNTR_NO = CNTR_NO 
                  AND VGM_CUST_CNTC_TP_CD = 'RP'
                  AND ROWNUM = 1
              ) ESIG_CO_NM,
              BXVR.XTER_SNDR_ID USR_ID,
              NVL(BXVR.VGM_UPLD_STS_CD,'N') IF_FLG,
        	  TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC('KRPUS',BXVR.UPD_DT,(SELECT POL_CD FROM BKG_BOOKING WHERE BKG_NO = REFNO.REF_NO)),'YYYY-MM-DD HH24:MI') VGM_CRE_LOCL_DT,
	          TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC('KRPUS',BXVR.UPD_DT,'GMT'), 'YYYY-MM-DD HH24:MI') VGM_CRE_GLO_DT,
              BXVR.XTER_VGM_DOC_ID,
              BXVR.XTER_VGM_RQST_SEQ
	     FROM BKG_XTER_VGM_RQST BXVR,
              BKG_XTER_VGM_REF_NO REFNO,
			  BKG_CONTAINER BC,
			  BKG_BOOKING BB
		WHERE 1=1
          AND BXVR.XTER_SNDR_ID = REFNO.XTER_SNDR_ID
		  AND BXVR.XTER_VGM_DOC_ID = REFNO.XTER_VGM_DOC_ID
		  AND BXVR.XTER_VGM_RQST_SEQ = REFNO.XTER_VGM_RQST_SEQ
		  AND BXVR.CNTR_NO = REFNO.CNTR_NO
		  AND NVL(REFNO.XTER_REF_SEQ, 0) = NVL((SELECT MAX(XTER_REF_SEQ)
        								          FROM BKG_XTER_VGM_REF_NO
								                 WHERE REFNO.XTER_SNDR_ID = XTER_SNDR_ID
								 				   AND REFNO.XTER_VGM_DOC_ID = XTER_VGM_DOC_ID
								                   AND REFNO.XTER_VGM_RQST_SEQ = XTER_VGM_RQST_SEQ
								                   AND REFNO.CNTR_NO = CNTR_NO
												   AND REFNO.REF_NO = REF_NO
												   AND XTER_REF_TP_CD IN ('BN','BM')), 0)
		  AND BB.BKG_NO = @[bkg_no]
		  AND SUBSTR(REFNO.REF_NO,1,10) = SUBSTR(BB.BKG_NO,1,10)
		  AND BC.BKG_NO = BB.BKG_NO
		  AND REFNO.CNTR_NO = BC.CNTR_NO
		  AND NVL(BXVR.VGM_ACK_RSPN_CD,'X') <> 'R'
		UNION
	   SELECT REFNO.REF_NO,
        	  BXVR.CNTR_NO,
	          TO_CHAR(ROUND(DECODE(BXVR.WGT_UT_CD,'KGS',BXVR.VGM_WGT ,'LBS', BXVR.VGM_WGT * 0.453592,NULL),3),'FM9999999990.000') VGM_WGT,
	          'KGS' WGT_UT_CD,
	          (SELECT VGM_CUST_CNTC_NM 
                 FROM BKG_XTER_VGM_CUST 
                WHERE BXVR.XTER_SNDR_ID = XTER_SNDR_ID
                  AND BXVR.XTER_VGM_DOC_ID = XTER_VGM_DOC_ID
                  AND BXVR.XTER_VGM_RQST_SEQ = XTER_VGM_RQST_SEQ
                  AND BXVR.CNTR_NO = CNTR_NO 
                  AND VGM_CUST_CNTC_TP_CD = 'RP'
                  AND ROWNUM = 1
              ) ESIG_CO_NM,
              BXVR.XTER_SNDR_ID USR_ID,
             NVL(BXVR.VGM_UPLD_STS_CD,'N') IF_FLG,
        	  TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC('KRPUS',BXVR.UPD_DT,(SELECT POL_CD FROM BKG_BOOKING WHERE BKG_NO = REFNO.REF_NO)),'YYYY-MM-DD HH24:MI') VGM_CRE_LOCL_DT,
	          TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC('KRPUS',BXVR.UPD_DT,'GMT'), 'YYYY-MM-DD HH24:MI') VGM_CRE_GLO_DT,
              BXVR.XTER_VGM_DOC_ID,
              BXVR.XTER_VGM_RQST_SEQ
	     FROM BKG_XTER_VGM_RQST BXVR,
              BKG_XTER_VGM_REF_NO REFNO,
			  BKG_CONTAINER BC,
			  BKG_BOOKING BB,
			  BKG_BOOKING TGT_BKG
		WHERE 1=1
          AND BXVR.XTER_SNDR_ID = REFNO.XTER_SNDR_ID
		  AND BXVR.XTER_VGM_DOC_ID = REFNO.XTER_VGM_DOC_ID
		  AND BXVR.XTER_VGM_RQST_SEQ = REFNO.XTER_VGM_RQST_SEQ
		  AND BXVR.CNTR_NO = REFNO.CNTR_NO
		  AND NVL(REFNO.XTER_REF_SEQ, 0) = NVL((SELECT MAX(XTER_REF_SEQ)
        								          FROM BKG_XTER_VGM_REF_NO
								                 WHERE REFNO.XTER_SNDR_ID = XTER_SNDR_ID
								 				   AND REFNO.XTER_VGM_DOC_ID = XTER_VGM_DOC_ID
								                   AND REFNO.XTER_VGM_RQST_SEQ = XTER_VGM_RQST_SEQ
								                   AND REFNO.CNTR_NO = CNTR_NO
												   AND REFNO.REF_NO = REF_NO
												   AND XTER_REF_TP_CD IN ('BN','BM')), 0)
		  AND BB.BKG_NO = @[bkg_no]
          AND BB.VSL_CD = TGT_BKG.VSL_CD
          AND BB.SKD_VOY_NO = TGT_BKG.SKD_VOY_NO
          AND BB.SKD_DIR_CD = TGT_BKG.SKD_DIR_CD
          AND BB.POL_CD = TGT_BKG.POL_CD
          AND BB.POD_CD = TGT_BKG.POD_CD
          AND REFNO.REF_NO = TGT_BKG.BKG_NO
          AND BB.BKG_NO = BC.BKG_NO
          AND BC.CNTR_NO = REFNO.CNTR_NO
		  AND NVL(BXVR.VGM_ACK_RSPN_CD,'X') <> 'R'
		UNION
		SELECT REFNO.REF_NO,
        	  BXVR.CNTR_NO,
	          TO_CHAR(ROUND(DECODE(BXVR.WGT_UT_CD,'KGS',BXVR.VGM_WGT ,'LBS', BXVR.VGM_WGT * 0.453592,NULL),3),'FM9999999990.000') VGM_WGT,
	          'KGS' WGT_UT_CD,
	          (SELECT VGM_CUST_CNTC_NM 
                 FROM BKG_XTER_VGM_CUST 
                WHERE BXVR.XTER_SNDR_ID = XTER_SNDR_ID
                  AND BXVR.XTER_VGM_DOC_ID = XTER_VGM_DOC_ID
                  AND BXVR.XTER_VGM_RQST_SEQ = XTER_VGM_RQST_SEQ
                  AND BXVR.CNTR_NO = CNTR_NO 
                  AND VGM_CUST_CNTC_TP_CD = 'RP'
                  AND ROWNUM = 1
              ) ESIG_CO_NM,
              BXVR.XTER_SNDR_ID USR_ID,
              NVL(BXVR.VGM_UPLD_STS_CD,'N') IF_FLG,
        	  TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC('KRPUS',BXVR.UPD_DT,(SELECT POL_CD FROM BKG_BOOKING WHERE BKG_NO = REFNO.REF_NO)),'YYYY-MM-DD HH24:MI') VGM_CRE_LOCL_DT,
	          TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC('KRPUS',BXVR.UPD_DT,'GMT'), 'YYYY-MM-DD HH24:MI') VGM_CRE_GLO_DT,
              BXVR.XTER_VGM_DOC_ID,
              BXVR.XTER_VGM_RQST_SEQ
	     FROM BKG_XTER_VGM_RQST BXVR,
              BKG_XTER_VGM_REF_NO REFNO,
			  BKG_CONTAINER BC,
			  BKG_BOOKING BB
		WHERE 1=1
          AND BXVR.XTER_SNDR_ID = REFNO.XTER_SNDR_ID
		  AND BXVR.XTER_VGM_DOC_ID = REFNO.XTER_VGM_DOC_ID
		  AND BXVR.XTER_VGM_RQST_SEQ = REFNO.XTER_VGM_RQST_SEQ
		  AND BXVR.CNTR_NO = REFNO.CNTR_NO
		  AND NVL(REFNO.XTER_REF_SEQ, 0) = NVL((SELECT MAX(XTER_REF_SEQ)
        								          FROM BKG_XTER_VGM_REF_NO
								                 WHERE REFNO.XTER_SNDR_ID = XTER_SNDR_ID
								 				   AND REFNO.XTER_VGM_DOC_ID = XTER_VGM_DOC_ID
								                   AND REFNO.XTER_VGM_RQST_SEQ = XTER_VGM_RQST_SEQ
								                   AND REFNO.CNTR_NO = CNTR_NO
												   AND REFNO.REF_NO = REF_NO
												   AND XTER_REF_TP_CD IN ('BN','BM')), 0)
		  AND BB.BKG_NO = @[bkg_no]
		  AND BC.BKG_NO = BB.BKG_NO
          AND BC.XTER_SNDR_ID = BXVR.XTER_SNDR_ID 
          AND BC.XTER_VGM_DOC_ID = BXVR.XTER_VGM_DOC_ID 
          AND BC.XTER_VGM_RQST_SEQ = BXVR.XTER_VGM_RQST_SEQ 
          AND BC.CNTR_NO = BXVR.CNTR_NO
		  AND NVL(BXVR.VGM_ACK_RSPN_CD,'X') <> 'R'
		)
	   UNION ALL
	   SELECT DOC.BKG_NO,
        	  'VGM CLOSE' CNTR_NO,
  	          'VGM CLOSE' VGM_WGT,
	          'VGM CLOSE' WGT_UT_CD,
  	          'VGM CLOSE' ESIG_CO_NM,
	          DOC.EVNT_USR_ID USR_ID,
	          'VGM CLOSE' IF_FLG,
	          TO_CHAR(DOC.EVNT_DT, 'YYYY-MM-DD HH24:MI') VGM_CRE_LOCL_DT,
			  TO_CHAR(DOC.EVNT_GDT, 'YYYY-MM-DD HH24:MI') VGM_CRE_GLO_DT,
              '' XTER_VGM_DOC_ID,
              0 XTER_VGM_RQST_SEQ
		 FROM BKG_DOC_PROC_SKD DOC
	    WHERE DOC.BKG_NO = @[bkg_no]
	      AND DOC.BKG_DOC_PROC_TP_CD = 'VGMCLZ'
	   UNION ALL
	   SELECT NTC.BKG_NO,
			  NTC.CNTR_NO,
			  'VERMAS EDI'||' ( TP ID : '||NTC.EDI_ID||' )' VGM_WGT,
			  'VERMAS EDI'||' ( TP ID : '||NTC.EDI_ID||' )' WGT_UT_CD,
			  'VERMAS EDI'||' ( TP ID : '||NTC.EDI_ID||' )' ESIG_CO_NM,
			  NTC.SND_USR_ID USR_ID,
			  'VERMAS EDI'||' ( TP ID : '||NTC.EDI_ID||' )' IF_FLG,
			  TO_CHAR(NTC.SND_DT, 'YYYY-MM-DD HH24:MI') VGM_CRE_LOCL_DT,
			  TO_CHAR(NTC.SND_GDT, 'YYYY-MM-DD HH24:MI') VGM_CRE_GLO_DT,
              '' XTER_VGM_DOC_ID,
              0 XTER_VGM_RQST_SEQ
		 FROM BKG_NTC_HIS NTC
		WHERE NTC.BKG_NO = @[bkg_no]
		  AND NTC.NTC_KND_CD IN ('VC','VP','VT','VM')
	   UNION ALL
	   SELECT NTC.BKG_NO,
			  '301 EDI'||' ( TP ID : '||NTC.EDI_ID||' )' CNTR_NO,
			  '301 EDI'||' ( TP ID : '||NTC.EDI_ID||' )' VGM_WGT,
			  '301 EDI'||' ( TP ID : '||NTC.EDI_ID||' )' WGT_UT_CD,
			  '301 EDI'||' ( TP ID : '||NTC.EDI_ID||' )' ESIG_CO_NM,
			  NTC.SND_USR_ID USR_ID,
			  '301 EDI'||' ( TP ID : '||NTC.EDI_ID||' )' IF_FLG,
			  TO_CHAR(NTC.SND_DT, 'YYYY-MM-DD HH24:MI') VGM_CRE_LOCL_DT,
			  TO_CHAR(NTC.SND_GDT, 'YYYY-MM-DD HH24:MI') VGM_CRE_GLO_DT,
              '' XTER_VGM_DOC_ID,
              0 XTER_VGM_RQST_SEQ
		 FROM BKG_NTC_HIS NTC
		WHERE NTC.BKG_NO = @[bkg_no]
		  AND NTC.NTC_KND_CD IN ('3C','3P','3M')
	) MST
 ORDER BY 1 DESC			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
