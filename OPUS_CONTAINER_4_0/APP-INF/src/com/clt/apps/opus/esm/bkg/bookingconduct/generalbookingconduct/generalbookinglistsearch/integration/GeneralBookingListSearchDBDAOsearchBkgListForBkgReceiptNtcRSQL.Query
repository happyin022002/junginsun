<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="GeneralBookingListSearchDBDAOsearchBkgListForBkgReceiptNtcRSQL">
			<desc><![CDATA[searchBkgListForBkgReceiptNtc]]></desc>
			<sql><![CDATA[
WITH SKD AS (
	SELECT BK.FULL_RTN_YD_CD, BK.BKG_NO, SKD.SLAN_CD SLAN_CD, VVD.SKD_DIR_CD SLAN_DIR_CD
				   			  , CASE WHEN DCGO_FLG = 'Y' THEN 'DG'
									 WHEN RC_FLG   = 'Y' THEN 'RF'
				   					 WHEN DCGO_FLG = 'N' AND RC_FLG = 'N' AND AWK_CGO_FLG = 'N' AND BB_CGO_FLG = 'N' THEN 'DR'
				   					 ELSE 'AL' END CGO_TP_CD
				   			  , VPS_ETB_DT
				   			  , VPS_ETD_DT
				   			  , pol_nod_cd
							  , NVL(VVD.POL_CLPT_IND_SEQ, 1) AS CLPT_IND_SEQ
				   			  , VVD.VSL_CD||VVD.SKD_VOY_NO||VVD.SKD_DIR_CD AS VVD
						   FROM BKG_BOOKING BK, BKG_VVD VVD, VSK_VSL_PORT_SKD SKD
				   		  WHERE BK.BKG_NO = VVD.BKG_NO
				   			AND BK.POL_CD = VVD.POL_CD
				   			AND VVD.VSL_PRE_PST_CD IN ('S', 'T')
							AND VVD.VSL_CD	   NOT IN ('COXX','COYY','COZZ')
				   			AND VVD.VSL_CD     = SKD.VSL_CD
				   			AND VVD.SKD_VOY_NO = SKD.SKD_VOY_NO
				   			AND VVD.SKD_DIR_CD = SKD.SKD_DIR_CD
				   			AND VVD.POL_CD     = SKD.VPS_PORT_CD
				   			AND NVL(VVD.POL_CLPT_IND_SEQ, 1) = SKD.CLPT_IND_SEQ
				   			AND 'X' != BK.BKG_STS_CD 
				   			AND BK.BKG_CGO_TP_CD <> 'P'
							#if (''!=${bkg_no}) AND @[bkg_no] = BK.BKG_NO #end
							#if (''!=${bkg_from_dt}) AND BK.BKG_CRE_DT > TO_DATE(@[bkg_from_dt],'yyyy-mm-dd') #end
							#if (''!=${bkg_to_dt}) AND BK.BKG_CRE_DT < TO_DATE(@[bkg_to_dt],'yyyy-mm-dd') + 1 #end
							#if (''!=${bkg_ofc_cd}) AND @[bkg_ofc_cd] = BK.BKG_OFC_CD #end
							#if (''!=${bkg_staff}) AND @[bkg_staff] = BK.DOC_USR_ID #end
							#if ('All'!=${bkg_status} && ''!=${bkg_status}) AND @[bkg_status] = BK.BKG_STS_CD #end
							#if ('All'!=${bkg_kind} && ''!=${bkg_kind}) AND @[bkg_kind] = BK.XTER_BKG_RQST_CD #end
							#if (''!=${vvd}) AND VVD.VSL_CD     = SUBSTR(@[vvd], 1, 4)
											 AND VVD.SKD_VOY_NO = SUBSTR(@[vvd], 5, 4)
											 AND VVD.SKD_DIR_CD = SUBSTR(@[vvd], 9, 1)
							#end
							#if (''!=${por_cd}) AND @[por_cd] = BK.POR_CD #end
							#if (''!=${pol_cd}) AND BK.POL_CD like @[pol_cd]||'%'
								#if (''!=${pol_yd_cd}) AND BK.POL_NOD_CD = @[pol_cd]||@[pol_yd_cd] #end
							#end
							#if (''!=${pod_cd}) AND BK.POD_CD like @[pod_cd]||'%'
								#if (''!=${pod_yd_cd}) AND BK.POD_NOD_CD = @[pod_cd]||@[pod_yd_cd] #end
							#end
							#if (''!=${del_cd}) AND @[del_cd] = BK.DEL_CD #end
							#if (''!=${sales_ofc}) AND @[sales_ofc] = BK.OB_SLS_OFC_CD #end
							#if (''!=${sales_rep}) AND @[sales_rep] = BK.OB_SREP_CD #end
							#if (''!=${full_rtn_yd_cd}) AND @[full_rtn_yd_cd] = BK.FULL_RTN_YD_CD #end

)

SELECT DISTINCT
	   BKG.FULL_RTN_YD_CD,
       BKG.BKG_NO,
	   BKG.EDI_HLD_FLG,
       BKG.BKG_STS_CD AS STATUS,
       BKG.XTER_BKG_RQST_CD AS KIND,
       CST.CUST_CNT_CD||LPAD(CST.CUST_SEQ,6,0) AS SHIPPER_CODE,
       REPLACE(CST.CUST_NM, CHR(10), ' ') AS SHIPPER_NAME,
       NVL2(FFC.CUST_CNT_CD,FFC.CUST_CNT_CD||LPAD(FFC.CUST_SEQ,6,0),NULL) AS FF_CD,
       NVL(FAX.NTC_FAX_NO,CTT.CNTC_PSON_FAX_NO) AS FAX,
       NVL(EML.NTC_EML,CTT.CNTC_PSON_EML) AS EML,
       to_char((select sys_set_dt from bkg_clz_tm clz where clz.bkg_no = bkg.bkg_no AND CLZ_TP_CD = 'R'), 'yyyy-mm-dd hh24:mi') AS CARGO_CCT,
       (CASE WHEN (SELECT /*+index_asc(scd XPKSCE_COP_DTL) */ decode(BKG.POL_CD,SUBSTR(SCD.NOD_CD,1,5),'Y','N')
                            FROM SCE_COP_HDR SCH
                                 ,SCE_COP_DTL SCD
                            WHERE SCH.BKG_NO = BKG.BKG_NO
                            AND SCH.COP_NO = SCD.COP_NO
                            AND SCD.ACT_CD LIKE 'F%AD'
                            AND rownum = 1) = 'N' THEN
                  
              to_char((SELECT NVL(PRD_GET_INLND_CCT_FNC(BK.PCTL_NO)
              ,(SELECT /*+INDEX_DESC(DTL XPKPRD_PROD_CTL_ROUT_DTL)*/
                                                                   DTL.ARR_ST_DT
                                                            FROM PRD_PROD_CTL_ROUT_DTL DTL, PRD_INLND_ROUT_MST O
                                                            WHERE DTL.PCTL_NO = BK.PCTL_NO
                                                            AND DTL.PCTL_IO_BND_CD = 'O'
                                                            AND DTL.ROUT_ORG_NOD_CD = O.ROUT_ORG_NOD_CD
                                                            AND DTL.ROUT_DEST_NOD_CD = O.ROUT_DEST_NOD_CD
                                                            AND DTL.ROUT_SEQ = O.ROUT_SEQ
                                                            AND DTL.ORG_NOD_CD = O.FULL_RTN_YD_CD
                                                            AND DTL.ROUT_SEQ > 0
                                                            AND DTL.NOD_LNK_DIV_CD = 'N'
                                                            AND ROWNUM = 1
                                                            UNION ALL
                                                            SELECT /*+INDEX_DESC(DTL XPKPRD_PROD_CTL_ROUT_DTL)*/
                                                                 DTL.ARR_ST_DT
                                                            FROM PRD_PROD_CTL_ROUT_DTL DTL
                                                            WHERE DTL.PCTL_NO = BK.PCTL_NO
                                                            AND DTL.PCTL_IO_BND_CD = 'O'
                                                            AND DTL.ROUT_SEQ = 0
                                                            AND ROWNUM = 1)
                          )  FROM BKG_BOOKING BK WHERE BK.BKG_NO = BKG.BKG_NO) , 'yyyy-mm-dd hh24:mi') 
           ELSE (select to_char(PRD_COMMON_PKG.PRD_GET_CCT_BY_BKG_FNC(BKG.BKG_NO), 'yyyy-mm-dd hh24:mi') 
        				            from SKD
        				            WHERE SKD.BKG_NO =BKG.BKG_NO )                         
            END)  AS CARGO_CCT_CNG,
       to_char((select mnl_set_dt from bkg_clz_tm clz where clz.bkg_no = bkg.bkg_no AND CLZ_TP_CD = 'R'), 'yyyy-mm-dd hh24:mi') AS CARGO_CCT_MNL,
       to_char((select sys_set_dt from bkg_clz_tm clz where clz.bkg_no = bkg.bkg_no AND CLZ_TP_CD = 'T'), 'yyyy-mm-dd hh24:mi') AS CCT,
	   to_char(((select PRD_COMMON_PKG.PRD_GET_CCT_BY_BKG_FNC(BKG.BKG_NO)
				   from SKD
				  WHERE SKD.BKG_NO =BKG.BKG_NO)),'yyyy-mm-dd hh24:mi') AS CCT_CNG,
       to_char((select mnl_set_dt from bkg_clz_tm clz where clz.bkg_no = bkg.bkg_no AND CLZ_TP_CD = 'T'), 'yyyy-mm-dd hh24:mi') AS CCT_MNL,
	   to_char((select nvl(mnl_set_dt, sys_set_dt) from bkg_clz_tm clz where clz.bkg_no = bkg.bkg_no AND CLZ_TP_CD = 'D'), 'yyyy-mm-dd hh24:mi') AS DOC_CCT,
       BKG.VSL_CD||BKG.SKD_VOY_NO||BKG.SKD_DIR_CD AS TVVD,
       BKG.POR_CD AS POR,
       BKG.EQ_CTRL_OFC_CD AS EQ_OFC,
       BKG.POL_CD AS POL,
       BKG.POD_CD AS POD,
       BKG.DEL_CD AS DEL,
       BKG.DOC_USR_ID AS BKG_STAFF,
       CTT.CNTC_PSON_NM AS CONTACT_PIC,
       (SELECT INTG_CD_VAL_DP_DESC
        FROM   COM_INTG_CD_DTL
        WHERE  'CD02396' = INTG_CD_ID
        AND    INTG_CD_VAL_CTNT =
               NVL2(FSI.FAX_PROC_STS_CD,
               DECODE(FSI.FAX_PROC_STS_CD,1,2,2,2,3,2,4,2,5,3,6,4,1),
               NVL2(FAX.BKG_NTC_SND_RSLT_CD,
               DECODE(FAX.BKG_NTC_SND_RSLT_CD,4,2,5,3,6,4,1),1)) ) AS FAX_RESULT,
       NVL (FSI.XPT_ERR_MSG, FSI.XPT_ERR_DTL_MSG) AS FAX_ERR,
       --TO_CHAR(NVL (FSI.XPT_DT,NVL(FSI.UPD_DT,FAX.SND_RQST_DT)),'yyyy-mm-dd hh24:mi') AS FAX_DATE,
       TO_CHAR(NVL (FAX.SND_RQST_DT,NVL(FSI.XPT_DT,FSI.UPD_DT)),'yyyy-mm-dd hh24:mi') AS FAX_DATE,
       (SELECT INTG_CD_VAL_DP_DESC
        FROM   COM_INTG_CD_DTL
        WHERE  'CD02396' = INTG_CD_ID
        AND    INTG_CD_VAL_CTNT =
               NVL2(ESI.EML_PROC_STS_CD,
               DECODE(ESI.EML_PROC_STS_CD,1,2,2,2,3,3,4,4,1),
               NVL2(EML.BKG_NTC_SND_RSLT_CD,
               DECODE(EML.BKG_NTC_SND_RSLT_CD,3,3,4,4,1),1)) ) AS EML_RESULT,
       ESI.EML_ERR_MSG AS EML_ERR,
       --TO_CHAR(NVL (ESI.EML_DT,EML.SND_RQST_DT),'yyyy-mm-dd hh24:mi') AS EML_DATE,
       TO_CHAR(NVL (EML.SND_RQST_DT,ESI.EML_DT),'yyyy-mm-dd hh24:mi') AS EML_DATE,
       NVL((SELECT /*+ INDEX(A2 XPKBKG_CUSTOMER) */
				   A3.RCT_NTC_RMK
            FROM   BKG_BOOKING A1,
                   BKG_CUSTOMER A2,
                   BKG_RPT_ITM_STUP A3
            WHERE  A1.BKG_NO = BKG.BKG_NO
            AND    A1.BKG_OFC_CD = A3.BKG_OFC_CD
            AND    A1.BKG_NO = A2.BKG_NO
            AND    A2.BKG_CUST_TP_CD IN ('S', 'F')
            AND    A2.CUST_CNT_CD = A3.CUST_CNT_CD
            AND    A2.CUST_SEQ = A3.CUST_SEQ
			AND    rownum = 1),
           (SELECT A2.RCT_NTC_RMK
            FROM   BKG_BOOKING A1,
                   BKG_RPT_ITM_STUP A2
            WHERE  A1.BKG_NO = BKG.BKG_NO
            AND    A1.BKG_OFC_CD = A2.BKG_OFC_CD
            AND    A2.CUST_CNT_CD IS NULL
            AND    A2.CUST_SEQ IS NULL)) REMARK
  FROM BKG_BOOKING BKG,
       BKG_VVD VVD,
       BKG_CUSTOMER CST,
       BKG_CUSTOMER FFC,
       BKG_CNTC_PSON CTT,
       BKG_BL_ISS ISS,
       BKG_BL_DOC DOC,
       BKG_CUSTOMER CST2,
       BKG_NTC_HIS FAX,
       BKG_NTC_HIS EML,
       COM_FAX_SND_INFO FSI,
       COM_EML_SND_INFO ESI
 WHERE BKG.BKG_NO = CST.BKG_NO
   AND 'S' = CST.BKG_CUST_TP_CD
   AND BKG.BKG_NO = FFC.BKG_NO(+)
   AND 'F' = FFC.BKG_CUST_TP_CD(+)
   AND BKG.BKG_NO = CTT.BKG_NO(+)
   AND 'BK' = CTT.BKG_CNTC_PSON_TP_CD(+)
   AND BKG.BKG_NO = ISS.BKG_NO(+)
   AND BKG.BKG_NO = DOC.BKG_NO(+)
   AND 'X' != BKG.BKG_STS_CD 
   AND BKG.BKG_NO = VVD.BKG_NO
   AND VVD.VSL_PRE_PST_CD IN ('S','T')
   AND CST2.BKG_NO = BKG.BKG_NO
   AND BKG.BKG_NO = FAX.BKG_NO(+)
   AND 'F' = FAX.NTC_VIA_CD(+)
   AND 'BK' = FAX.NTC_KND_CD(+)
   AND BKG.BKG_CGO_TP_CD <> 'P'
   AND NVL(FAX.HIS_SEQ,1) = 
       NVL((SELECT MAX(HIS_SEQ) FROM BKG_NTC_HIS
        WHERE BKG_NO = FAX.BKG_NO
        AND 'F' = NTC_VIA_CD
        AND 'BK' = NTC_KND_CD),1)
   AND BKG.BKG_NO = EML.BKG_NO(+)
   AND 'M' = EML.NTC_VIA_CD(+)
   AND 'BK' = EML.NTC_KND_CD(+)
   AND NVL(EML.HIS_SEQ,1) =
       NVL((SELECT MAX(HIS_SEQ) FROM BKG_NTC_HIS
        WHERE BKG_NO = EML.BKG_NO
        AND 'M' = NTC_VIA_CD
        AND 'BK' = NTC_KND_CD),1)
   AND FAX.SND_ID = FSI.FAX_SND_NO(+)
   AND EML.SND_ID = ESI.EML_SND_NO(+)
   #if (''!=${bkg_no})
   AND @[bkg_no] = BKG.BKG_NO
   #end
   #if (${multiBkgNo} != '')
   AND BKG.BKG_NO IN (
   	#foreach($multiBkgNoVal IN ${multiBkgNo})
    	#if($velocityCount < $multiBkgNo.size()) '$multiBkgNoVal', #else '$multiBkgNoVal' #end
    #end
   )
   #end
   #if (''!=${bkg_from_dt})
   AND BKG.BKG_CRE_DT > TO_DATE(@[bkg_from_dt],'yyyy-mm-dd')
   #end
   #if (''!=${bkg_to_dt})
   AND BKG.BKG_CRE_DT < TO_DATE(@[bkg_to_dt],'yyyy-mm-dd') + 1
   #end
   #if (''!=${bkg_ofc_cd})
   AND @[bkg_ofc_cd] = BKG.BKG_OFC_CD
   #end
   #if (''!=${bkg_staff})
   AND @[bkg_staff] = BKG.DOC_USR_ID
   #end
   #if ('All'!=${bkg_status} && ''!=${bkg_status})
   AND @[bkg_status] = BKG.BKG_STS_CD
   #end
   #if ('All'!=${bkg_kind} && ''!=${bkg_kind})
   AND @[bkg_kind] = BKG.XTER_BKG_RQST_CD
   #end
   #if (''!=${vvd})
   AND VVD.VSL_CD     = SUBSTR(@[vvd], 1, 4)
   AND VVD.SKD_VOY_NO = SUBSTR(@[vvd], 5, 4)
   AND VVD.SKD_DIR_CD = SUBSTR(@[vvd], 9, 1)
   #end
   #if (''!=${por_cd})
   AND @[por_cd] = BKG.POR_CD
   #end
   #if (''!=${pol_cd})
   AND BKG.POL_CD like @[pol_cd]||'%'
		   #if (''!=${pol_yd_cd})
		   AND BKG.POL_NOD_CD = @[pol_cd]||@[pol_yd_cd]
		   #end
   #end
   #if (''!=${pod_cd})
   AND BKG.POD_CD like @[pod_cd]||'%'
	     #if (''!=${pod_yd_cd})
	     AND BKG.POD_NOD_CD = @[pod_cd]||@[pod_yd_cd]
	     #end
   #end
   #if (''!=${del_cd})
   AND @[del_cd] = BKG.DEL_CD
   #end
   #if (''!=${sales_ofc})
   AND @[sales_ofc] = BKG.OB_SLS_OFC_CD
   #end
   #if (''!=${sales_rep})
   AND @[sales_rep] = BKG.OB_SREP_CD
   #end
   #if ('All'!=${cust_tp_cd} && ''!=${cust_tp_cd})
   AND @[cust_tp_cd] = CST2.BKG_CUST_TP_CD
   #end
   #if (''!=${cust_cnt_cd})
   AND CST2.CUST_CNT_CD = SUBSTR(@[cust_cnt_cd], 1, 2)
   #end
   #if (''!=${cust_seq})
   AND CST2.CUST_SEQ = TO_NUMBER(@[cust_seq])
   #end
   #if (''!=${cust_nm})
   AND CST2.CUST_NM LIKE @[cust_nm]||'%'
   #end
   #if ('All'!=${fax_proc_sts_cd})
   AND NVL2(FSI.FAX_PROC_STS_CD,
       DECODE(FSI.FAX_PROC_STS_CD,1,2,2,2,3,2,4,2,5,3,6,4,1),
       NVL2(FAX.BKG_NTC_SND_RSLT_CD,
       DECODE(FAX.BKG_NTC_SND_RSLT_CD,4,2,5,3,6,4,1),1)) = @[fax_proc_sts_cd]
   #end
   #if ('All'!=${eml_proc_sts_cd})
   AND NVL2(ESI.EML_PROC_STS_CD,
       DECODE(ESI.EML_PROC_STS_CD,1,2,2,2,3,3,4,4,1),
       NVL2(EML.BKG_NTC_SND_RSLT_CD,
       DECODE(EML.BKG_NTC_SND_RSLT_CD,3,3,4,4,1),1)) = @[eml_proc_sts_cd]
   #end
   #if (''!=${full_rtn_yd_cd})
   AND BKG.FULL_RTN_YD_CD = @[full_rtn_yd_cd]
   #end
   #if ('Y'!=${edi_hld_flg})
   AND BKG.EDI_HLD_FLG = 'N'
   #end			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="bkg_from_dt" type="12" value="" out="N"/>
				<param name="bkg_to_dt" type="12" value="" out="N"/>
				<param name="bkg_ofc_cd" type="12" value="SELSC" out="N"/>
				<param name="bkg_staff" type="12" value="" out="N"/>
				<param name="bkg_status" type="12" value="" out="N"/>
				<param name="bkg_kind" type="12" value="" out="N"/>
				<param name="vvd" type="12" value="HNPH0087E" out="N"/>
				<param name="por_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="CNYIT" out="N"/>
				<param name="pol_yd_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="pod_yd_cd" type="12" value="" out="N"/>
				<param name="del_cd" type="12" value="" out="N"/>
				<param name="sales_ofc" type="12" value="" out="N"/>
				<param name="sales_rep" type="12" value="" out="N"/>
				<param name="full_rtn_yd_cd" type="12" value="" out="N"/>
				<param name="cust_tp_cd" type="12" value="" out="N"/>
				<param name="cust_cnt_cd" type="12" value="" out="N"/>
				<param name="cust_seq" type="12" value="" out="N"/>
				<param name="cust_nm" type="12" value="" out="N"/>
				<param name="fax_proc_sts_cd" type="12" value="" out="N"/>
				<param name="eml_proc_sts_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
