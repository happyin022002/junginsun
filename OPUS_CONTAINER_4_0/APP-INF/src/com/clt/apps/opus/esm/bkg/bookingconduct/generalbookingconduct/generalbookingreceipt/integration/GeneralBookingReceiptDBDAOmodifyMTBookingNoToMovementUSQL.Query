<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="GeneralBookingReceiptDBDAOmodifyMTBookingNoToMovementUSQL">
			<desc><![CDATA[CTM Movement내 Booking No를 Update 하는 Query]]></desc>
			<sql><![CDATA[
UPDATE CTM_MOVEMENT MN
SET  (MN.BKG_NO, MN.BL_NO
     , MN.CRNT_VSL_CD, MN.CRNT_SKD_VOY_NO, MN.CRNT_SKD_DIR_CD
     , MN.TRNK_VSL_CD, MN.TRNK_SKD_VOY_NO, MN.TRNK_SKD_DIR_CD
     ) = ( SELECT BB.BKG_NO, BB.BKG_NO
                   , BB.VSL_CD, BB.SKD_VOY_NO, BB.SKD_DIR_CD
                   , BB.VSL_CD, BB.SKD_VOY_NO, BB.SKD_DIR_CD
             FROM BKG_BOOKING BB
            WHERE BB.BKG_NO = @[bkg_no]
              AND ROWNUM    = 1
          )
     , BKG_KNT  = 1
     , MTY_REPO_VL_RMK = 'UPDATED BY BKG UPDATE SCREEN('||TO_CHAR(SYSDATE, 'YYYY.MM.DD HH24:MI:SS')||')'
     , UPD_DT   = SYSDATE
     , UPD_USR_ID = @[upd_usr_id]
WHERE (MN.CNTR_NO, MN.CNMV_YR, MN.CNMV_ID_NO)
IN (     
        SELECT CM.CNTR_NO, CM.CNMV_YR, CM.CNMV_ID_NO
        FROM CTM_MOVEMENT CM
        WHERE CM.MVMT_STS_CD        = 'VL'
        AND   CM.BKG_CGO_TP_CD      = 'P'
        AND   NVL(CM.BKG_NO, 'XX') != @[bkg_no]
        AND   (CM.CNTR_NO, CM.ORG_YD_CD, CM.CRNT_VSL_CD) IN (SELECT BC.CNTR_NO
                                                                  , BB.POL_NOD_CD
                                                                  , BB.VSL_CD
                                                               FROM BKG_BOOKING BB
                                                                 ,  BKG_CONTAINER BC
                                                              WHERE BB.BKG_NO = BC.BKG_NO
                                                                AND BB.BKG_STS_CD      = 'F'
                                                                AND BB.BKG_CGO_TP_CD   = 'P'
                                                                AND BB.BKG_NO          = @[bkg_no])
        AND EXISTS (SELECT 'Y'
                      FROM VSK_VSL_PORT_SKD SK
                         , BKG_BOOKING BB
                     WHERE BB.BKG_NO     = @[bkg_no]
                       AND BB.VSL_CD     = SK.VSL_CD
                       AND BB.SKD_VOY_NO = SK.SKD_VOY_NO
                       AND BB.SKD_DIR_CD = SK.SKD_DIR_CD
                       AND BB.POL_CD     = SK.VPS_PORT_CD
                       AND SK.VPS_ETD_DT BETWEEN CM.CNMV_EVNT_DT - 14  AND CM.CNMV_EVNT_DT + 14
                       AND ROWNUM        = 1)
        UNION ALL
        SELECT CM.CNTR_NO, CM.CNMV_YR, CM.CNMV_ID_NO
        FROM CTM_MOVEMENT CM
        WHERE CM.MVMT_STS_CD        = 'VD'
        AND   CM.BKG_CGO_TP_CD      = 'P'
        AND   NVL(CM.BKG_NO, 'XX') != @[bkg_no]
        AND   (CM.CNTR_NO, CM.ORG_YD_CD, CM.CRNT_VSL_CD) IN (SELECT BC.CNTR_NO
                                                                  , BB.POD_NOD_CD
                                                                  , BB.VSL_CD
                                                               FROM BKG_BOOKING BB
                                                                 ,  BKG_CONTAINER BC
                                                              WHERE BB.BKG_NO = BC.BKG_NO
                                                                AND BB.BKG_STS_CD      = 'F'
                                                                AND BB.BKG_CGO_TP_CD   = 'P'
                                                                AND BB.BKG_NO          = @[bkg_no])
        AND EXISTS (SELECT 'Y'
                      FROM VSK_VSL_PORT_SKD SK
                         , BKG_BOOKING BB
                     WHERE BB.BKG_NO     = @[bkg_no]
                       AND BB.VSL_CD     = SK.VSL_CD
                       AND BB.SKD_VOY_NO = SK.SKD_VOY_NO
                       AND BB.SKD_DIR_CD = SK.SKD_DIR_CD
                       AND BB.POD_CD     = SK.VPS_PORT_CD
                       AND SK.VPS_ETA_DT BETWEEN CM.CNMV_EVNT_DT - 14  AND CM.CNMV_EVNT_DT + 14
                       AND ROWNUM        = 1)  
        UNION ALL
        SELECT CM.CNTR_NO, CM.CNMV_YR, CM.CNMV_ID_NO
        FROM CTM_MOVEMENT CM
        WHERE CM.MVMT_STS_CD        = 'MT'
        AND   CM.BKG_CGO_TP_CD      = 'P'
        AND   NVL(CM.BKG_NO, 'XX') != @[bkg_no]
        AND   (CM.CNTR_NO, CM.CNMV_EVNT_DT, CM.ORG_YD_CD, CM.TRNK_VSL_CD, CM.TRNK_SKD_VOY_NO, CM.TRNK_SKD_DIR_CD)
             IN (SELECT SM.CNTR_NO, SM.CNMV_EVNT_DT, SM.ORG_YD_CD, SM.TRNK_VSL_CD, SM.TRNK_SKD_VOY_NO, SM.TRNK_SKD_DIR_CD
                   FROM CTM_MOVEMENT SM
                  WHERE SM.MVMT_STS_CD      = 'VD'
                    AND SM.BKG_CGO_TP_CD   = 'P'
                    AND (SM.CNTR_NO, SM.ORG_YD_CD, SM.CRNT_VSL_CD) IN (SELECT BC.CNTR_NO
                                                                            , BB.POD_NOD_CD
                                                                            , BB.VSL_CD
                                                                         FROM BKG_BOOKING BB
                                                                           ,  BKG_CONTAINER BC
                                                                        WHERE BB.BKG_NO = BC.BKG_NO
                                                                          AND BB.BKG_STS_CD      = 'F'
                                                                          AND BB.BKG_CGO_TP_CD   = 'P'
                                                                          AND BB.BKG_NO          = @[bkg_no])
                    AND EXISTS (SELECT 'Y'
                                  FROM VSK_VSL_PORT_SKD SK
                                     , BKG_BOOKING BB
                                 WHERE BB.BKG_NO     = @[bkg_no]
                                   AND BB.VSL_CD     = SK.VSL_CD
                                   AND BB.SKD_VOY_NO = SK.SKD_VOY_NO
                                   AND BB.SKD_DIR_CD = SK.SKD_DIR_CD
                                   AND BB.POD_CD     = SK.VPS_PORT_CD
                                   AND SK.VPS_ETA_DT BETWEEN SM.CNMV_EVNT_DT - 14  AND SM.CNMV_EVNT_DT + 14
                                   AND ROWNUM        = 1)  
               )
   )			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="upd_usr_id" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
