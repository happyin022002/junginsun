<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="SpacecontrolinquiryDBDAOsearchSpaceControlInquiryNoShowSummaryListRSQL">
			<desc><![CDATA[searchSpaceControlInquiryNoShowSummaryList]]></desc>
			<sql><![CDATA[
WITH PARAMS AS (
    SELECT @[type]   AS TYPE    ,
           @[year]   AS P_YEAR  ,
           @[month]  AS P_MONTH ,
           @[week]   AS P_WEEK  ,
           @[rhq]    AS RHQ_CD  ,
           @[office] AS OFC_CD  ,
           @[trade]  AS TRD_CD  ,
           @[lane]   AS RLANE_CD,
           @[vvd]    AS VVD
      FROM DUAL
)
, vvds AS (
    SELECT 1 AS FLG    ,
           P.TYPE      ,
           V.RLANE_CD  ,
           V.VSL_CD    ,
           V.SKD_VOY_NO,
           V.DIR_CD    ,
           V.TRD_CD    ,
           P.P_YEAR AS COST_YR,
           V.COST_WK   ,
           P.RHQ_CD    ,
           P.OFC_CD
      FROM COA_MON_VVD V,
           PARAMS      P
     WHERE V.IOC_CD     = 'O'
       AND V.RLANE_CD  <> 'RBCCO'
       AND V.DELT_FLG   = 'N'
       AND V.RLANE_CD   = P.RLANE_CD
       AND V.SUB_TRD_CD > ' '
       AND V.TRD_CD     = P.TRD_CD
       AND SUBSTR(V.SLS_YRMON, 1, 4)||V.COST_WK = P.P_YEAR||P.P_WEEK
       AND P.RLANE_CD IS NOT NULL
       AND P.P_WEEK   IS NOT NULL
       AND P.VVD      IS NULL
    UNION ALL
    SELECT 2 AS FLG    ,
           P.TYPE      ,
           V.RLANE_CD  ,
           V.VSL_CD    ,
           V.SKD_VOY_NO,
           V.DIR_CD    ,
           V.TRD_CD    ,
           P.P_YEAR AS COST_YR,
           V.COST_WK   ,
           P.RHQ_CD    ,
           P.OFC_CD
      FROM COA_MON_VVD V,
           PARAMS      P
     WHERE V.IOC_CD    = 'O'
       AND V.RLANE_CD <> 'RBCCO'
       AND V.DELT_FLG  = 'N'
       AND V.TRD_CD    = P.TRD_CD
       AND SUBSTR(V.SLS_YRMON, 1, 4)||V.COST_WK = P.P_YEAR||P.P_WEEK
       AND P.RLANE_CD IS NULL
       AND P.TRD_CD   IS NOT NULL
       AND P.P_WEEK   IS NOT NULL
       AND P.VVD      IS NULL
    UNION ALL
    SELECT 3 AS FLG    ,
           P.TYPE      ,
           V.RLANE_CD  ,
           V.VSL_CD    ,
           V.SKD_VOY_NO,
           V.DIR_CD    ,
           V.TRD_CD    ,
           P.P_YEAR AS COST_YR,
           V.COST_WK   ,
           P.RHQ_CD    ,
           P.OFC_CD
      FROM COA_MON_VVD V,
           PARAMS      P
     WHERE SUBSTR(V.SLS_YRMON, 1, 4)||V.COST_WK = P.P_YEAR||P.P_WEEK
       AND V.IOC_CD    = 'O'
       AND V.RLANE_CD <> 'RBCCO'
       AND V.DELT_FLG  = 'N'
       AND P.TRD_CD IS NULL
       AND P.P_WEEK IS NOT NULL
       AND P.VVD    IS NULL
    UNION ALL
    SELECT 4 AS FLG    ,
           P.TYPE      ,
           V.RLANE_CD  ,
           V.VSL_CD    ,
           V.SKD_VOY_NO,
           V.DIR_CD    ,
           V.TRD_CD    ,
           P.P_YEAR AS COST_YR,
           V.COST_WK   ,
           P.RHQ_CD    ,
           P.OFC_CD
      FROM COA_MON_VVD V,
           PARAMS      P
     WHERE V.VSL_CD     = SUBSTR(P.VVD, 1, 4)
       AND V.SKD_VOY_NO = SUBSTR(P.VVD, 5, 4)
       AND V.DIR_CD     = SUBSTR(P.VVD, 9, 1)
       AND V.IOC_CD     = 'O'
       AND V.DELT_FLG   = 'N'
       AND P.VVD IS NOT NULL
    UNION ALL
    SELECT 5 AS FLG    ,
           P.TYPE      ,
           V.RLANE_CD  ,
           V.VSL_CD    ,
           V.SKD_VOY_NO,
           V.DIR_CD    ,
           V.TRD_CD    ,
           P.P_YEAR AS COST_YR,
           V.COST_WK   ,
           P.RHQ_CD    ,
           P.OFC_CD
      FROM COA_MON_VVD V,
           PARAMS      P
     WHERE V.IOC_CD    = 'O'
       AND V.RLANE_CD <> 'RBCCO'
       AND V.DELT_FLG  = 'N'
       AND SUBSTR(V.SLS_YRMON, 1, 4)||V.COST_WK IN ( SELECT P.COST_YR||P.COST_WK
                                                       FROM ( SELECT DECODE(MON, '01', FDT, (FDT + CASE
                                                                                                        WHEN TO_CHAR(FDT, 'D') < 5 THEN TO_CHAR(FDT, 'D') * -1 + 1
                                                                                                                                   ELSE 8 - TO_CHAR(FDT, 'D')
                                                                                                    END)
                                                                     ) AS FDT,
                                                                     (LDT + CASE
                                                                                 WHEN TO_CHAR(LDT, 'D') < 4 THEN TO_CHAR(LDT, 'D') * -1 - 6
                                                                                                            ELSE TO_CHAR(LDT, 'D') * -1 + 1
                                                                             END
                                                                     ) AS LDT
                                                                FROM ( SELECT TO_DATE(DECODE(S.P_MONTH, '', '', TO_DATE(S.P_YEAR||S.P_MONTH||'01', 'YYYYMMDD'))) AS FDT,
                                                                              TO_DATE(DECODE(S.P_MONTH, '', '', TRUNC(LAST_DAY(TO_DATE(S.P_YEAR||S.P_MONTH||'01', 'YYYYMMDD'))))) AS LDT,
                                                                              S.P_MONTH AS MON
                                                                         FROM PARAMS S )
                                                            ) D,
                                                            COA_WK_PRD P
                                                      WHERE P.COST_YR IN (TO_CHAR(D.LDT, 'YYYY'), TO_CHAR(D.FDT, 'YYYY'))
                                                        AND P.SLS_FM_DT BETWEEN TO_CHAR(D.FDT, 'YYYYMMDD') AND TO_CHAR(D.LDT, 'YYYYMMDD')
                                                   )
       AND P.P_MONTH IS NOT NULL
       AND P.P_WEEK  IS NULL
       AND P.TRD_CD  IS NULL
       AND P.VVD     IS NULL
    UNION ALL
    SELECT 6 AS FLG   ,
          P.TYPE      ,
          V.RLANE_CD  ,
          V.VSL_CD    ,
          V.SKD_VOY_NO,
          V.DIR_CD    ,
          V.TRD_CD    ,
          P.P_YEAR AS COST_YR,
          V.COST_WK   ,
          P.RHQ_CD    ,
          P.OFC_CD
     FROM COA_MON_VVD V,
          PARAMS      P
    WHERE V.IOC_CD = 'O'
      AND V.RLANE_CD <> 'RBCCO'
      AND V.DELT_FLG = 'N'
      AND V.TRD_CD = P.TRD_CD
      AND SUBSTR(V.SLS_YRMON, 1, 4)||V.COST_WK IN ( SELECT P.COST_YR||P.COST_WK
                                                      FROM ( SELECT DECODE(MON, '01', FDT, (FDT + CASE
                                                                                                       WHEN TO_CHAR(FDT, 'D') < 5 THEN TO_CHAR(FDT, 'D') * -1 + 1
                                                                                                                                  ELSE 8 - TO_CHAR(FDT, 'D')
                                                                                                   END)
                                                                    ) AS FDT,
                                                                    (LDT + CASE
                                                                                WHEN TO_CHAR(LDT, 'D') < 4 THEN TO_CHAR(LDT, 'D') * -1 - 6
                                                                                                           ELSE TO_CHAR(LDT, 'D') * -1 + 1
                                                                            END
                                                                    ) AS LDT
                                                               FROM ( SELECT TO_DATE(DECODE(S.P_MONTH, '', '', TO_DATE(S.P_YEAR||S.P_MONTH||'01', 'YYYYMMDD'))) AS FDT,
                                                                             TO_DATE(DECODE(S.P_MONTH, '', '', TRUNC(LAST_DAY(TO_DATE(S.P_YEAR||S.P_MONTH||'01', 'YYYYMMDD'))))) AS LDT,
                                                                             S.P_MONTH AS MON
                                                                        FROM PARAMS S )
                                                           ) D,
                                                           COA_WK_PRD P
                                                     WHERE P.COST_YR IN (TO_CHAR(D.LDT, 'YYYY'), TO_CHAR(D.FDT, 'YYYY'))
                                                       AND P.SLS_FM_DT BETWEEN TO_CHAR(D.FDT, 'YYYYMMDD') AND TO_CHAR(D.LDT, 'YYYYMMDD')
                                                  )
      AND P.P_MONTH  IS NOT NULL
      AND P.P_WEEK   IS NULL
      AND P.RLANE_CD IS NULL
      AND P.TRD_CD   IS NOT NULL
      AND P.VVD      IS NULL
   UNION ALL
   SELECT 7 AS FLG    ,
          P.TYPE      ,
          V.RLANE_CD  ,
          V.VSL_CD    ,
          V.SKD_VOY_NO,
          V.DIR_CD    ,
          V.TRD_CD    ,
          P.P_YEAR AS COST_YR,
          V.COST_WK   ,
          P.RHQ_CD    ,
          P.OFC_CD
     FROM COA_MON_VVD V,
          PARAMS      P
    WHERE V.IOC_CD    = 'O'
      AND V.RLANE_CD <> 'RBCCO'
      AND V.DELT_FLG  = 'N'
      AND V.RLANE_CD  = P.RLANE_CD
      AND V.TRD_CD    = P.TRD_CD
      AND SUBSTR(V.SLS_YRMON, 1, 4)||V.COST_WK IN ( SELECT P.COST_YR||P.COST_WK
                                                      FROM ( SELECT DECODE(MON, '01', FDT, (FDT + CASE
                                                                                                       WHEN TO_CHAR(FDT, 'D') < 5 THEN TO_CHAR(FDT, 'D') * -1 + 1
                                                                                                                                  ELSE 8 - TO_CHAR(FDT, 'D')
                                                                                                   END)
                                                                    ) AS FDT,
                                                                    (LDT + CASE
                                                                                WHEN TO_CHAR(LDT, 'D') < 4 THEN TO_CHAR(LDT, 'D') * -1 - 6
                                                                                                           ELSE TO_CHAR(LDT, 'D') * -1 + 1
                                                                            END
                                                                    ) AS LDT
                                                               FROM ( SELECT TO_DATE(DECODE(S.P_MONTH, '', '', TO_DATE(S.P_YEAR||S.P_MONTH||'01', 'YYYYMMDD'))) AS FDT,
                                                                             TO_DATE(DECODE(S.P_MONTH, '', '', TRUNC(LAST_DAY(TO_DATE(S.P_YEAR||S.P_MONTH||'01', 'YYYYMMDD'))))) AS LDT,
                                                                             S.P_MONTH AS MON
                                                                        FROM PARAMS S )
                                                           ) D,
                                                           COA_WK_PRD P
                                                     WHERE P.COST_YR IN (TO_CHAR(D.LDT, 'YYYY'), TO_CHAR(D.FDT, 'YYYY'))
                                                       AND P.SLS_FM_DT BETWEEN TO_CHAR(D.FDT, 'YYYYMMDD') AND TO_CHAR(D.LDT, 'YYYYMMDD')
                                                  )
      AND P.P_MONTH  IS NOT NULL
      AND P.P_WEEK   IS NULL
      AND P.RLANE_CD IS NOT NULL
      AND P.VVD      IS NULL
)
, NSHW_DATA_OFC AS (
    SELECT R.ALOC_DDCT_BSE_CD,
           R.OFC_KND_CD     ,
           R.TRD_CD         ,
           R.RLANE_CD       ,
           R.DIR_CD         ,
           R.VSL_CD         ,
           R.SKD_VOY_NO     ,
           R.SKD_DIR_CD     ,
           R.SLS_RHQ_CD     ,
           SUBSTR(R.SLS_AQ_CD, 4, 3) AS SLS_AQ_CD,
           R.SLS_RGN_OFC_CD,
           R.SLS_OFC_CD    ,
           P.COST_WK       ,
           DECODE(P.TYPE, '3', 'M', 'D') AS TYPE,
           SUM(R.FCAST_LOD_QTY) AS FCAST_LOD_QTY,
           SUM(R.ALOC_LOD_QTY)  AS ALOC_LOD_QTY ,
           SUM(R.BKG_LOD_QTY)   AS BKG_LOD_QTY  ,
           (SPC_GET_NSHW_SHRTFLL_FNC(DECODE(P.TYPE, '3', 'M', 'D'), SUM(R.FCAST_LOD_QTY), SUM(R.ALOC_LOD_QTY), SUM(R.BKG_LOD_QTY))) AS SHORTFALL
      FROM SPC_NSHW_RSLT R,
           VVDS          P
     WHERE R.ALOC_DDCT_BSE_CD = P.TYPE
       AND R.OFC_KND_CD       = '3'
       AND R.RLANE_CD         = P.RLANE_CD
       AND R.DIR_CD           = P.DIR_CD
       AND R.VSL_CD           = P.VSL_CD
       AND R.SKD_VOY_NO       = P.SKD_VOY_NO
       AND R.SKD_DIR_CD       = P.DIR_CD
       AND (P.RHQ_CD IS NULL OR R.SLS_RHQ_CD     = P.RHQ_CD)
       AND (P.OFC_CD IS NULL OR R.SLS_RGN_OFC_CD = P.OFC_CD)
  GROUP BY R.ALOC_DDCT_BSE_CD,
           R.OFC_KND_CD      ,
           R.TRD_CD          ,
           R.RLANE_CD        ,
           R.DIR_CD          ,
           R.VSL_CD          ,
           R.SKD_VOY_NO      ,
           R.SKD_DIR_CD      ,
           R.SLS_RHQ_CD      ,
           SUBSTR(R.SLS_AQ_CD, 4, 3),
           R.SLS_RGN_OFC_CD  ,
           R.SLS_OFC_CD      ,
           P.COST_WK         ,
           DECODE(P.TYPE, '3', 'M', 'D')
)
, NSHW_DATA AS (
    SELECT NVL(R.SLS_AQ_CD, R.SLS_RHQ_CD) AS AQ_CD ,
           R.SLS_RGN_OFC_CD               AS OFC_CD,
           R.TRD_CD,
           SUM(R.FCAST_LOD_QTY) AS FCAST_LOD_QTY,
           SUM(R.ALOC_LOD_QTY)  AS ALOC_LOD_QTY ,
           SUM(R.BKG_LOD_QTY)   AS BKG_LOD_QTY  ,
           SUM(SHORTFALL)       AS SHORTFALL
      FROM NSHW_DATA_OFC R
  GROUP BY NVL(R.SLS_AQ_CD, R.SLS_RHQ_CD),
           R.SLS_RGN_OFC_CD,
           R.TRD_CD        ,
           R.TYPE
)
, TRADES AS (
    SELECT DISTINCT
           TRD_CD
      FROM NSHW_DATA
)
, OFFICES AS (
    SELECT DISTINCT
           AQ_CD ,
           OFC_CD
      FROM NSHW_DATA
)
, TRD_OFC AS (
    SELECT AQ_CD ,
           OFC_CD,
           TRD_CD
      FROM TRADES  T,
           OFFICES O
)
  SELECT MAX(AQ_CD)         AS AQ_CD        ,
         MAX(OFC_CD)        AS OFC_CD       ,
         MAX(TRD_CD)        AS TRD_CD       ,
         MAX(FCAST_LOD_QTY) AS FCAST_LOD_QTY,
         0   AS SHORTFALL,
         '0' AS RATIO    ,
         0   AS LVL
    FROM (
            SELECT MIN(COST_WK) AS AQ_CD ,
                   MAX(COST_WK) AS OFC_CD,
                   '' AS TRD_CD,
                   0  AS FCAST_LOD_QTY
              FROM VVDS
            UNION ALL
            SELECT '' AS AQ_CD ,
                   '' AS OFC_CD,
                      MAX(DECODE(ROWNUM, 1, TRD_CD, ''))
                   || MAX(DECODE(ROWNUM, 2, '|'||TRD_CD, ''))
                   || MAX(DECODE(ROWNUM, 3, '|'||TRD_CD, ''))
                   || MAX(DECODE(ROWNUM, 4, '|'||TRD_CD, ''))
                   || MAX(DECODE(ROWNUM, 5, '|'||TRD_CD, '')) AS TRD_CD,
                   COUNT(1) AS FCAST_LOD_QTY
              FROM TRADES
         )
  UNION ALL
  SELECT AQ_CD        ,
         OFC_CD       ,
         TRD_CD       ,
         FCAST_LOD_QTY,
         SHORTFALL    ,
         TO_CHAR(ROUND(RATIO, 2), 'FM99990.00') AS RATIO,
         LVL
    FROM (
            SELECT NVL(O.AQ_CD, 'G.TTL') AS AQ_CD,
                   DECODE(O.AQ_CD, NULL, 'G.TTL', NVL(O.OFC_CD, 'S.TTL')) AS OFC_CD,
                   NVL(O.TRD_CD, 'TTL') AS TRD_CD,
                   SUM(NVL(N.FCAST_LOD_QTY, 0)) AS FCAST_LOD_QTY,
                   SUM(NVL(N.SHORTFALL, 0))     AS SHORTFALL    ,
                   DECODE(SUM(NVL(N.FCAST_LOD_QTY, 0)), 0, 0, SUM(NVL(N.SHORTFALL, 0)) / SUM(NVL(N.FCAST_LOD_QTY, 0)) * 100) AS RATIO,
                   DECODE(O.OFC_CD, NULL, DECODE(O.AQ_CD, NULL, 0, 1), 2) AS LVL
              FROM TRD_OFC   O,
                   NSHW_DATA N
             WHERE N.OFC_CD(+) = O.OFC_CD
               AND N.TRD_CD(+) = O.TRD_CD
          GROUP BY GROUPING SETS(
                                  (O.AQ_CD, O.OFC_CD, O.TRD_CD),
                                  (O.AQ_CD, O.TRD_CD),
                                  (O.AQ_CD, O.OFC_CD),
                                  (O.AQ_CD),
                                  (O.TRD_CD),
                                  ()
                                )
          ORDER BY DECODE(O.AQ_CD, 'DNC', '1', 'DSC', '2', 'DKJ', '3', 'DSA', '4', 'DPI', '5', '6'),
                   NVL(O.AQ_CD , 'ZZZZZZ'),
                   NVL(O.OFC_CD, 'ZZZZZ' ),
                   NVL(O.TRD_CD, 'ZZZ')
         )			]]></sql>
			<params>
				<param name="type" type="12" value="" out="N"/>
				<param name="year" type="12" value="" out="N"/>
				<param name="month" type="12" value="" out="N"/>
				<param name="week" type="12" value="" out="N"/>
				<param name="rhq" type="12" value="" out="N"/>
				<param name="office" type="12" value="" out="N"/>
				<param name="trade" type="12" value="" out="N"/>
				<param name="lane" type="12" value="" out="N"/>
				<param name="vvd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
