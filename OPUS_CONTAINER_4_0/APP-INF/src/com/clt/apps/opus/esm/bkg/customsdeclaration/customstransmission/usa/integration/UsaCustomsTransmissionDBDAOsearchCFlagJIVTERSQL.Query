<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="UsaCustomsTransmissionDBDAOsearchCFlagJIVTERSQL">
			<desc><![CDATA[C-Flag : I -> J -> V -> T -> E 순서]]></desc>
			<sql><![CDATA[
SELECT CASE WHEN DECODE(@[icr_code], '1J', @[old_c_flag], 'J') = 'J'
                 AND BL.PCK_QTY = SUM(DECODE(TB.ENTR_NO, 'ETC', TB.J_QTY, 0))
                 AND EXISTS 
                 (
                  SELECT 'X'
                    FROM BKG_CSTMS_ADV_RSLT A
                   WHERE A.BL_NO = BL.BL_NO
                     AND NVL(A.RSND_FLG, 'N') <> 'Y'
                     AND A.BL_NVOCC_TP_CD = 'M'
                     AND A.CSTMS_SEQ > (
                                        SELECT MAX(CSTMS_SEQ)
                                          FROM BKG_CSTMS_ADV_RSLT B
                                         WHERE B.CNT_CD = A.CNT_CD
                                           AND B.BL_NO= A.BL_NO
                                           AND B.DSPO_CD = '1J'
                                           AND NVL(B.RSND_FLG, 'N') <> 'Y'
                                           AND B.BL_NVOCC_TP_CD = 'M'
                                           -- 최종 1J 를 찾아서
                                           -- 해당 Insert 된 seq 이전 데이터 중..
                                           AND B.CSTMS_SEQ < (
                                                              SELECT MAX(CSTMS_SEQ)
                                                                FROM BKG_CSTMS_ADV_RSLT C
                                                               WHERE C.CNT_CD = A.CNT_CD
                                                                 AND C.BL_NO= A.BL_NO
                                                                 AND NVL(C.RSND_FLG, 'N') <> 'Y'
                                                                 AND C.BL_NVOCC_TP_CD = 'M'
                                                             )
                                       )
                     -- 최종 1J 이후 11,12,13 이 있어야 I 가 됨.
                     AND A.DSPO_CD IN ('11','12','13')
                 ) THEN 'I'
            WHEN DECODE(@[icr_code], '54', DECODE(BL.MF_STS_CD, 'D', 0, BL.PCK_QTY), BL.PCK_QTY)
                 = SUM(DECODE(TB.ENTR_NO, COM_ConstantMgr_PKG.COM_getCompanyCode_FNC(), TB.J_QTY, 0)) THEN 'J'
            WHEN DECODE(@[icr_code], '1J', @[old_c_flag], ' ') <> 'J'
                 AND DECODE(@[icr_code], '54', DECODE(BL.MF_STS_CD, 'D', 0, BL.PCK_QTY), BL.PCK_QTY)
                     = SUM(DECODE(TB.ENTR_NO, 'ETC', TB.J_QTY, 0)) THEN 'V'
            WHEN BL.USA_LST_LOC_CD = @[cus_loc]
                 AND DECODE(@[icr_code], '54', DECODE(BL.MF_STS_CD, 'D', 0, BL.PCK_QTY), BL.PCK_QTY)
                     = SUM(DECODE(TB.ENTR_NO, COM_ConstantMgr_PKG.COM_getCompanyCode_FNC(), DECODE(TB.ENTR_TP_NO, '62', TB.J_QTY, 0), 0)) THEN 'T'
            WHEN BL.CSTMS_POD_CD = @[cus_loc]
                 AND DECODE(@[icr_code], '54', DECODE(BL.MF_STS_CD, 'D', 0, BL.PCK_QTY), BL.PCK_QTY)
                     = SUM(DECODE(TB.ENTR_NO, COM_ConstantMgr_PKG.COM_getCompanyCode_FNC(), DECODE(TB.ENTR_TP_NO, '63', TB.J_QTY, 0), 0)) THEN 'E'
            ELSE 'N'
       END C_FLAG
  FROM (
        SELECT NVL(SUM(DECODE(CD.CSTMS_DIV_ID, 'CARGO_RLS_J_CD', RS.CNTR_QTY) * DECODE(CD.ATTR_CTNT2, 'MINUS', -1, 1)  ),0) J_QTY
              ,DECODE(SUBSTR(RS.ENTR_NO, 1, 3), BKG_GET_BKG_CTMS_CD_FNC('US','AMS_ASGN_CO_CD',1,1)  , COM_ConstantMgr_PKG.COM_getCompanyCode_FNC(), 'ETC') AS ENTR_NO
              ,RS.ENTR_TP_NO
          FROM BKG_CSTMS_ADV_RSLT RS
              ,BKG_CSTMS_CD_CONV_CTNT CD
         WHERE RS.CNT_CD        = 'US'
           AND RS.BL_NO         = @[bl_no]
           AND RS.CNT_CD         = CD.CNT_CD(+)
           AND RS.DSPO_CD         = CD.ATTR_CTNT3(+)
           AND NVL(RS.RSND_FLG, 'N') <> 'Y'
           AND RS.BL_NVOCC_TP_CD = 'M'
      GROUP BY DECODE(SUBSTR(RS.ENTR_NO, 1, 3), BKG_GET_BKG_CTMS_CD_FNC('US','AMS_ASGN_CO_CD',1,1) , COM_ConstantMgr_PKG.COM_getCompanyCode_FNC(), 'ETC'), ENTR_TP_NO
       ) TB
      ,BKG_CSTMS_ADV_BL BL
 WHERE BL.CNT_CD = 'US'
   AND BL.BL_NO  = @[bl_no]
GROUP BY BL.BL_NO, BL.PCK_QTY, BL.USA_LST_LOC_CD, BL.CSTMS_POD_CD, BL.MF_STS_CD			]]></sql>
			<params>
				<param name="icr_code" type="12" value="" out="N"/>
				<param name="old_c_flag" type="12" value="" out="N"/>
				<param name="cus_loc" type="12" value="" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
