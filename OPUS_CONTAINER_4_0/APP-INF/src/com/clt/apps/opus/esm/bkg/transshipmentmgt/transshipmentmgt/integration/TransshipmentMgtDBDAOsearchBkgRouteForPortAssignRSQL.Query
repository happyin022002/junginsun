<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TransshipmentMgtDBDAOsearchBkgRouteForPortAssignRSQL">
			<desc><![CDATA[조건에 맞는 Booking을 route 별로 group으로 조회한다.]]></desc>
			<sql><![CDATA[
select 
		 por_cd
		, pol_nod_cd pol_cd
        , pod_nod_cd pod_cd
		, del_cd
        , count(1) bkg_count
        , tvvd
        , pre_vvd
        , pre_relay
        , post_vvd
        , post_relay
        , (select VPS_RMK 
             from vsk_vsl_port_skd in_vvd
            where in_vvd.vsl_cd     = substr(@[vvd], 1, 4)
              and in_vvd.skd_voy_no = substr(@[vvd], 5, 4)
              and in_vvd.skd_dir_cd = substr(@[vvd], 9, 1)
              and in_vvd.vps_port_cd= in_pod --[portCd]
              and rownum = 1) rmk
        , nvl(por_cd,'')||'|'||nvl(pol_nod_cd,'')||'|'||nvl(pod_nod_cd,'')||'|'||nvl(del_cd,'')||'|'||nvl(tvvd,'')
          ||'|'||nvl(pre_vvd,'')||'|'||nvl(pre_relay,'')||'|'||nvl(post_vvd,'')||'|'||nvl(post_relay,'') route_key
  from (select bk.bkg_no
				, bk.por_cd
                , bk.pol_nod_cd
                , bk.pod_nod_cd
				, bk.del_cd
                , tvvd.vsl_cd||tvvd.skd_voy_no||tvvd.skd_dir_cd tvvd
                , (select pre_vvd.vsl_cd||pre_vvd.skd_voy_no||pre_vvd.skd_dir_cd 
                     from bkg_vvd pre_vvd
                    where bk.bkg_no   = pre_vvd.bkg_no
                      and 'S'         = pre_vvd.vsl_pre_pst_cd 
                      and tvvd.pol_cd = pre_vvd.pod_cd
					  and rownum      = 1) pre_vvd
                , (select pre_vvd.pod_yd_cd
                     from bkg_vvd pre_vvd
                    where bk.bkg_no   = pre_vvd.bkg_no
                      and 'S'         = pre_vvd.vsl_pre_pst_cd
                      and tvvd.pol_cd = pre_vvd.pod_cd
					  and rownum      = 1) pre_relay
                , (select post_vvd.vsl_cd||post_vvd.skd_voy_no||post_vvd.skd_dir_cd 
                     from bkg_vvd post_vvd
                    where bk.bkg_no   = post_vvd.bkg_no
                      and 'U'         = post_vvd.vsl_pre_pst_cd
                      and tvvd.pod_cd = post_vvd.pol_cd
					  and rownum      = 1) post_vvd
                , (select post_vvd.pol_yd_cd
                     from bkg_vvd post_vvd
                    where bk.bkg_no   = post_vvd.bkg_no
                      and 'U'         = post_vvd.vsl_pre_pst_cd
                      and tvvd.pod_cd = post_vvd.pol_cd
					  and rownum      = 1) post_relay
		#if (${vvd}!='')
		        ,in_vvd.pod_cd AS in_pod
        #else
		        ,'' AS in_pod
        #end
          from bkg_booking bk
                , bkg_vvd tvvd  
		#if (${vvd}!='')
                , bkg_vvd in_vvd  
        #end
         where bk.bkg_no = tvvd.bkg_no           
           and bk.bkg_sts_cd NOT IN ('X','S')
           and 'T'       = tvvd.vsl_pre_pst_cd
		#if (${vvd}!='')
           and exists (
		       select *
		       from bkg_vvd vvd
			   where bk.bkg_no = vvd.bkg_no
               and vvd.vsl_cd     = substr(@[vvd], 1, 4)
               and vvd.skd_voy_no = substr(@[vvd], 5, 4)
               and vvd.skd_dir_cd = substr(@[vvd], 9, 1)
  		       #if(${pol} !='')
			       and vvd.pol_cd = @[pol]
		       #end 
  		       #if(${pol_yd_cd} !='')
			       and substr(vvd.pol_yd_cd,6,2) = @[pol_yd_cd]
		       #end 
  		       #if(${pod} !='')
			       and vvd.pod_cd = @[pod]
		       #end 
  		       #if(${pod_yd_cd} !='')
			       and substr(vvd.pod_yd_cd,6,2) = @[pod_yd_cd]
		       #end 
           )
           and bk.bkg_no         = in_vvd.bkg_no
           and in_vvd.vsl_cd     = substr(@[vvd], 1, 4)
           and in_vvd.skd_voy_no = substr(@[vvd], 5, 4)
           and in_vvd.skd_dir_cd = substr(@[vvd], 9, 1)
        #end

		#if (${bkg_ofc_cd}!='')
		   and bk.bkg_ofc_cd = @[bkg_ofc_cd]
        #end
		#if (${bkgNos} != '')
			AND bk.bkg_no IN (
				#foreach($multiBkgNoVal IN ${bkgNos})        
					#if($velocityCount < $bkgNos.size()) '$multiBkgNoVal', #else '$multiBkgNoVal' #end
				#end
			)
		#end
        )        
-- where trim(pre_relay||post_relay) is not null
   where 1=1

 group by 
	     por_cd
		, pol_nod_cd
        , pod_nod_cd
		, del_cd
        , tvvd
        , pre_vvd
        , pre_relay
        , post_vvd
        , post_relay
        , in_pod
order by pol_cd
		, pol_nod_cd
        , pod_nod_cd
		, del_cd
        , tvvd
        , pre_vvd
        , pre_relay
        , post_vvd
        , post_relay			]]></sql>
			<params>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="pol" type="12" value="" out="N"/>
				<param name="pol_yd_cd" type="12" value="" out="N"/>
				<param name="pod" type="12" value="" out="N"/>
				<param name="pod_yd_cd" type="12" value="" out="N"/>
				<param name="bkg_ofc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
