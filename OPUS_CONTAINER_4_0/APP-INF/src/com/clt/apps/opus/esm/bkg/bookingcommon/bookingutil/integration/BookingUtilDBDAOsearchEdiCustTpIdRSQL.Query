<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BookingUtilDBDAOsearchEdiCustTpIdRSQL">
			<desc><![CDATA[searchEdiCustTpId]]></desc>
			<sql><![CDATA[
SELECT 
#if (${tp_cd} == 'B') 
		nvl((select bhcc.attr_ctnt3 
            from bkg_hrd_cdg_ctnt bhcc 
            where bhcc.hrd_cdg_id = 'CUSTOMER_301U' 
            and bhcc.attr_ctnt1 = EDI_RECEIVE_ID 
            and bhcc.attr_ctnt2 = REF_CODE
            and rownum = 1), GROUP_EDI_ID) GROUP_ID
#else
    GROUP_EDI_ID GROUP_ID
#end
	, EDI_RECEIVE_ID RCV_ID
	, REF_CODE
  FROM 
    (SELECT BKG_NO
        , MIN(RANK) RANK
        , GROUP_EDI_ID
        , EDI_RECEIVE_ID
        , REF_CODE
      FROM 
        (SELECT  BK.BKG_NO
                , MIN(TP_RANK.RANK) RANK
                , edi_BY_CUST.group_edi_id
                , edi_BY_CUST.EDI_RECEIVE_ID
                , DECODE(@[tp_cd], 'D', 'D', edi_BY_CUST.cnt_cd||edi_BY_CUST.cust_seq) AS ref_code
          FROM BKG_CUSTOMER CUST
                , BKG_BOOKING BK
                , (SELECT GRP.ESVC_GRP_CD           GROUP_EDI_ID
                         , GRP.CUST_TRD_PRNR_ID     EDI_RECEIVE_ID
                         , grp_cUST.CNT_CD   
                         , grp_cUST.CUST_SEQ 
                   FROM BKG_EDI_GRP_CUST grp_cUST, BKG_EDI_GRP GRP
                  WHERE GRP.ESVC_GRP_CD         = grp_cUST.ESVC_GRP_CD
                    AND GRP.CO_CD               = grp_cUST.CO_CD
                    AND GRP.ESVC_GRP_DELT_FLG   = 'N'
                    AND grp_cUST.cnt_Cd         > ' '
                    AND grp_cUST.cust_seq       > 0
                    AND grp_cUST.DELT_FLG       = 'N'
#if (${tp_cd} == 'B') 
                    -- tpCd = 'B'
                    AND grp_cUST.BKG_CFM_FLG    = 'Y'
	#if (${auto_manual_flg} == 'Y') 
                    --autoManualCd = 'Y'
                    AND grp_cust.BKG_CFM_AUTO_FLG = 'Y' 
                    AND 1 = 2
	#end
#end

#if (${tp_cd} == 'D') 
                    -- tpCd = 'D'
                    AND grp_cust.bl_drft_flg    = 'Y'       
	#if (${auto_manual_flg} == 'Y') 
                    --autoManualCd = 'Y'
                    AND grp_cust.BL_DRFT_AUTO_FLG = 'Y'                             
	#end
#end
                    ) EDI_BY_CUST               
                , (SELECT 'S' RCV_TP, '1SH' RANK FROM DUAL 
                   UNION SELECT 'C' RCV_TP, '2CN' RANK FROM DUAL 
                   UNION SELECT 'N' RCV_TP, '3NF' RANK FROM DUAL 
                   UNION SELECT 'F' RCV_TP, '4FF' RANK FROM DUAL 
                   UNION SELECT 'A' RCV_TP, '5AN' RANK FROM DUAL 
                   UNION SELECT 'E' RCV_TP, '6EX' RANK FROM DUAL) TP_RANK
         WHERE EDI_BY_CUST.CNT_CD   = CUST.CUST_CNT_CD 
           AND EDI_BY_CUST.CUST_SEQ = CUST.CUST_SEQ
           AND BK.BKG_NO            = CUST.BKG_NO
           AND CUST.BKG_CUST_TP_CD = TP_RANK.RCV_TP
           and bk.bkg_no = @[bkg_no]
         GROUP BY bk.bkg_no
                , edi_BY_CUST.group_edi_id
                , edi_BY_CUST.EDI_RECEIVE_ID
                , edi_BY_CUST.cnt_cd||edi_BY_CUST.cust_seq
         UNION
          SELECT bk.bkg_no
                , '7SC' RANK
                , edi_BY_SC.group_edi_iD
                , edi_BY_SC.EDI_RECEIVE_ID
                , DECODE(@[tp_cd], 'D', 'D', edi_BY_SC.sc_no) AS ref_code
          FROM BKG_BOOKING BK
                , (SELECT  GRP.ESVC_GRP_CD           GROUP_EDI_ID
                         , GRP.CUST_TRD_PRNR_ID     EDI_RECEIVE_ID
                         , grp_cUST.SC_NO
                   FROM BKG_EDI_GRP GRP, BKG_EDI_GRP_CUST grp_cUST
                  WHERE GRP.ESVC_GRP_CD         = grp_cUST.ESVC_GRP_CD
                    AND GRP.CO_CD               = grp_cUST.CO_CD      
                    AND GRP.ESVC_GRP_DELT_FLG   = 'N'
                    and grp_cUST.sc_no          > ' '              
                    AND grp_cUST.DELT_FLG       = 'N'
#if (${tp_cd} == 'B') 
                    -- tpCd = 'B'
                    AND grp_cUST.BKG_CFM_FLG    = 'Y'
	#if (${auto_manual_flg} == 'Y') 
                    --autoManualCd = 'Y'
                    AND grp_cust.BKG_CFM_AUTO_FLG = 'Y' 
                    AND 1 = 2
	#end
#end

#if (${tp_cd} == 'D') 
                    -- tpCd = 'D'
                    AND grp_cust.bl_drft_flg    = 'Y'       
	#if (${auto_manual_flg} == 'Y') 
                    --autoManualCd = 'Y'
                    AND grp_cust.BL_DRFT_AUTO_FLG = 'Y'     
	#end                        
#end

                    ) EDI_BY_SC
         WHERE EDI_BY_SC.SC_NO  = BK.SC_NO
           and bk.bkg_no = @[bkg_no]
#if (${tp_cd} == 'B')
          UNION 
           SELECT MST.BKG_NO
                  ,'8EB' RANK
                  ,'' group_edi_iD
                  ,(SELECT BHCC.ATTR_CTNT3
                    FROM BKG_HRD_CDG_CTNT BHCC
                    WHERE BHCC.HRD_CDG_ID = 'CUSTOMER_301_EDI_ID'
                    AND   BHCC.ATTR_CTNT2 = CASE WHEN MST.XTER_SNDR_ID <> 'PEGASUS' THEN MST.XTER_SNDR_ID
                                            ELSE (SELECT BHCC1.ATTR_CTNT2 FROM BKG_HRD_CDG_CTNT BHCC1
                                                                          WHERE BHCC1.HRD_CDG_ID = 'CUSTOMER_301_EDI_ID'
                                                                          AND BHCC1.ATTR_CTNT1 = MST.PGSS_EDI_ID) END
                    AND ROWNUM = 1) AS EDI_RECEIVE_ID
                  ,'' AS ref_code
           FROM BKG_XTER_RQST_MST MST
           WHERE MST.BKG_NO = @[bkg_no]
           AND MST.DOC_TP_CD = 'B'
           AND MST.BKG_UPLD_STS_CD = 'F'
           AND MST.XTER_RQST_VIA_CD <> 'WEB'
           AND MST.XTER_RQST_SEQ = (SELECT MAX(MST1.XTER_RQST_SEQ) FROM BKG_XTER_RQST_MST MST1 WHERE MST.XTER_SNDR_ID = MST1.XTER_SNDR_ID 
                                                                   AND MST.BKG_NO = MST1.BKG_NO
                                                                   AND MST1.DOC_TP_CD = 'B'
                                                                   AND MST1.BKG_UPLD_STS_CD = 'F'
                                                                   AND MST1.XTER_RQST_VIA_CD <> 'WEB')
           and not exists (SELECT 'X'
                            from bkg_ntc_his ntc
                           where ntc.bkg_no = MST.bkg_no
                             and ntc.ntc_via_cd = 'E'
                             and ntc.edi_id = (SELECT BHCC.ATTR_CTNT3
                                               FROM BKG_HRD_CDG_CTNT BHCC
                                               WHERE BHCC.HRD_CDG_ID = 'CUSTOMER_301_EDI_ID'
                                               AND   BHCC.ATTR_CTNT2 = CASE WHEN MST.XTER_SNDR_ID <> 'PEGASUS' THEN MST.XTER_SNDR_ID
                                                                       ELSE (SELECT BHCC1.ATTR_CTNT2 FROM BKG_HRD_CDG_CTNT BHCC1
                                                                             WHERE BHCC1.HRD_CDG_ID = 'CUSTOMER_301_EDI_ID'
                                                                             AND BHCC1.ATTR_CTNT1 = MST.PGSS_EDI_ID) END
                                               AND ROWNUM = 1)
                             and ntc.ntc_knd_cd = 'BK'
							 and (select bb.bkg_sts_cd from bkg_booking bb where bb.bkg_no = @[bkg_no]) <> 'X'
		                   )
          UNION
          SELECT BB.BKG_NO
                 ,'9UB' RANK
                 ,BHCC.ATTR_CTNT3 group_edi_iD
                 ,BHCC.ATTR_CTNT1 AS EDI_RECEIVE_ID
                 ,BHCC.ATTR_CTNT2 AS ref_code
          FROM BKG_BOOKING BB
               ,BKG_HRD_CDG_CTNT BHCC
          WHERE BB.BKG_NO = @[bkg_no]
          AND BHCC.HRD_CDG_ID = 'CUSTOMER_301U'
          AND EXISTS (SELECT 'X' FROM BKG_CUSTOMER BC WHERE BC.BKG_NO = BB.BKG_NO
                                                      AND BC.CUST_CNT_CD||BC.CUST_SEQ = BHCC.ATTR_CTNT2)
          AND NOT EXISTS (SELECT 'X' FROM BKG_XTER_RQST_MST MST WHERE MST.BKG_NO = BB.BKG_NO
                                                                AND MST.DOC_TP_CD = 'B'
                                                                AND MST.BKG_UPLD_STS_CD = 'F'
                                                                AND BHCC.ATTR_CTNT1 = CASE WHEN MST.XTER_SNDR_ID <> 'PEGASUS' THEN MST.XTER_SNDR_ID
                                                                                      ELSE (SELECT BHCC1.ATTR_CTNT2 
                                                                                              FROM BKG_HRD_CDG_CTNT BHCC1
                                                                                             WHERE BHCC1.HRD_CDG_ID = 'CUSTOMER_301_EDI_ID'
                                                                                               AND BHCC1.ATTR_CTNT1 = MST.PGSS_EDI_ID
                                                                                               AND ROWNUM = 1) END
                                                                AND MST.XTER_RQST_VIA_CD <> 'WEB')
          AND NOT EXISTS (SELECT 'X'
                          from bkg_ntc_his ntc
                          where ntc.bkg_no = BB.bkg_no
                          and ntc.ntc_via_cd = 'E'
                          and ntc.edi_id = BHCC.ATTR_CTNT1
                          and ntc.ntc_knd_cd = 'BK'
						  and bb.bkg_sts_cd <> 'X')                                                        
#end
           )
     GROUP BY BKG_NO
        , GROUP_EDI_ID
        , EDI_RECEIVE_ID
        , ref_code) mst, bkg_booking bk
  where bk.bkg_no = mst.bkg_no 
#if (${auto_manual_flg} == 'Y') 
--autoManualCd = 'Y'
    and not exists (select 'X'
                      from bkg_ntc_his ntc
                     where ntc.bkg_no = bk.bkg_no
                       and ntc.ntc_via_cd = 'E'
                       and ntc.edi_id = edi_receive_id
	#if (${tp_cd} == 'B') 
                       -- tpCd = 'B'
                       and ntc.ntc_knd_cd = 'BK'
					   and bk.bkg_sts_cd <> 'X'
	#end
	#if (${tp_cd} == 'D')
                       -- tpCd = 'D'
                       and ntc.ntc_knd_cd = 'BL'
	#end
                       and rownum = 1)
	#if (${tp_cd} == 'D') 
    and exists (select 'x'
                  from bkg_chg_rt rt
                 where rt.bkg_no = bk.bkg_no
                   and rt.chg_cd = 'OFT')
	#end
	#if (${tp_cd} == 'B') 
    and not exists (SELECT 'X' FROM MDM_LOCATION ML 
                    WHERE ML.LOC_CD = BK.POL_CD AND ML.CONTI_CD = 'E' 
                    AND (BK.DCGO_FLG = 'Y' OR BK.RC_FLG = 'Y' OR BK.AWK_CGO_FLG = 'Y' OR BK.BKG_WT_CHK_FLG = 'Y')
                    AND (BK.BKG_STS_CD <> 'F' OR BK.BKG_WT_CHK_FLG = 'Y')
                   ) 
	#end
#end			]]></sql>
			<params>
				<param name="tp_cd" type="12" value="" out="N"/>
				<param name="bkg_no" type="12" value="CANX2035004" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
