<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="SalesRPTDBDAOSearchRPTbyOfc070List11RSQL">
			<desc><![CDATA[Office Report-vs QTA
@SJH.20140814 : COA_BKG_EXPN_DTL_WK -> COA_BKG_EXPN_DTL]]></desc>
			<sql><![CDATA[
SELECT 	''	
#if(${f_ofc_sts} =='Y')
  ,OFC_CD1		
  ,OFC_CD2		
#end
/* Report */		
#if(${f_rpt_item} =='T')
  ,TRD_CD 
#elseif (${f_rpt_item} =='S')
  ,TRD_CD 
  ,SUB_TRD_CD 
#elseif (${f_rpt_item} =='L')
  ,TRD_CD 
  ,SUB_TRD_CD 
  ,RLANE_CD 
#elseif (${f_rpt_item} =='V')
  ,TRD_CD 
  ,SUB_TRD_CD 
  ,RLANE_CD 
  ,VSL_CD 
  ,SKD_VOY_NO 
  ,DIR_CD 			
#end		
/* Directory Display */
#if(${f_rpt_item} !='V' && ${f_dir_sts} =='Y')
  ,DIR_CD 
#end
		
  ,CURR_LOAD        ,PREV_LOAD  
  ,PREV_REV         ,CURR_REV  
  ,PREV_CM          ,CURR_CM    
  ,DECODE(PREV_LOAD,0,0, PREV_REV/PREV_LOAD) AS PREV_RPB 
  ,DECODE(CURR_LOAD,0,0, CURR_REV/CURR_LOAD) AS CURR_RPB 
  ,DECODE(PREV_LOAD,0,0, PREV_CM/PREV_LOAD) AS PREV_CMB 
  ,DECODE(CURR_LOAD,0,0, CURR_CM/CURR_LOAD) AS CURR_CMB 
  ,PREV_BSA_CAPA 
  ,CURR_BSA_CAPA 
  ,DECODE(PREV_BSA_CAPA,0,0, PREV_LOAD/PREV_BSA_CAPA*100) AS PREV_LF 
  ,DECODE(CURR_BSA_CAPA,0,0, CURR_LOAD/CURR_BSA_CAPA*100) AS CURR_LF 
  ,DECODE(PREV_LOAD,  0,0,((CURR_LOAD-PREV_LOAD)    /ABS(PREV_LOAD))  *100)    AS LOAD_CHNG  
  ,DECODE(PREV_REV,   0,0,((CURR_REV-PREV_REV)      /ABS(PREV_REV))   *100)    AS REV_CHNG  
  ,DECODE(PREV_CM,    0,0,((CURR_CM-PREV_CM)        /ABS(PREV_CM))    *100)    AS CM_CHNG  

  ,CURR_BSA_CAPA-PREV_BSA_CAPA                                                 AS BSA_CAPA_CHNG  
  ,DECODE(CURR_BSA_CAPA  ,0,0,CURR_LOAD/CURR_BSA_CAPA*100)-DECODE(PREV_BSA_CAPA,0,0,PREV_LOAD/PREV_BSA_CAPA*100) AS LF_CHNG 
  
  ,DECODE(CURR_LOAD,0,0,CURR_REV/CURR_LOAD)-DECODE(PREV_LOAD,0,0,PREV_REV/PREV_LOAD) AS RPB_CHNG  
  ,DECODE(CURR_LOAD, 0,0,CURR_CM/CURR_LOAD)-DECODE(PREV_LOAD, 0,0,PREV_CM/PREV_LOAD) AS CMB_CHNG  
  ,ROUND((CURR_LOAD-PREV_LOAD)*DECODE(PREV_LOAD,0,0,PREV_REV/PREV_LOAD), 5)                                            AS BY_LOAD_GREV  
  ,ROUND((DECODE(CURR_LOAD,0,0,CURR_REV/CURR_LOAD)-DECODE(PREV_LOAD,0,0,PREV_REV/PREV_LOAD))*CURR_LOAD, 5)             AS BY_RPB_GREV  
  ,ROUND((CURR_LOAD-PREV_LOAD)*(DECODE(PREV_LOAD,0,0,PREV_CM_COST/PREV_LOAD)), 5)                                      AS BY_LOAD_COST  
  ,ROUND(((DECODE(CURR_LOAD,0,0,CURR_CM_COST/CURR_LOAD))-(DECODE(PREV_LOAD,0,0,PREV_CM_COST/PREV_LOAD)))*CURR_LOAD, 5) AS BY_CPB_COST  
  ,ROUND(NVL(RATIO_TO_REPORT(PREV_LOAD) OVER(),0)*100 , 5)                                                               AS PREV_LOAD_SHARE  
  ,ROUND(NVL(RATIO_TO_REPORT(CURR_LOAD) OVER(),0)*100 , 5)                                                               AS CURR_LOAD_SHARE  
  ,ROUND(NVL(RATIO_TO_REPORT(PREV_CM)   OVER(),0)*100 , 5)                                                               AS PREV_CM_SHARE  
  ,ROUND(NVL(RATIO_TO_REPORT(CURR_CM)   OVER(),0)*100 , 5)                                                               AS CURR_CM_SHARE   
		
FROM ( 
    SELECT '' 				
 	#if(${f_ofc_sts} =='Y')
       ,ofc_cd1		
       ,ofc_cd2		
	#end  	
	#if(${f_rpt_item} =='T')
        ,TRD_CD 
    #elseif (${f_rpt_item} =='S')
        ,TRD_CD 
        ,SUB_TRD_CD 
    #elseif (${f_rpt_item} =='L')
        ,TRD_CD 
        ,SUB_TRD_CD 
        ,RLANE_CD 
    #elseif (${f_rpt_item} =='V')
        ,TRD_CD 
        ,SUB_TRD_CD 
        ,RLANE_CD 
        ,VSL_CD 
        ,SKD_VOY_NO 
        ,DIR_CD 
    #end		
		
	#if(${f_rpt_item} !='V' && ${f_dir_sts} =='Y')
        ,DIR_CD 
    #end
		
        ,NVL(SUM(DECODE(B1.COST_WK, SUBSTR(@[f_prev_week], 5, 2), BKG_QTY)),0)             AS PREV_LOAD
        ,NVL(SUM(DECODE(B1.COST_WK, SUBSTR(@[f_curr_week], 5, 2), BKG_QTY)),0)             AS CURR_LOAD
        ,NVL(SUM(DECODE(B1.COST_WK, SUBSTR(@[f_prev_week], 5, 2), FR_REV)),0)              AS PREV_REV
        ,NVL(SUM(DECODE(B1.COST_WK, SUBSTR(@[f_curr_week], 5, 2), FR_REV)),0)              AS CURR_REV
        ,NVL(SUM(DECODE(B1.COST_WK, SUBSTR(@[f_prev_week], 5, 2), TOT_REV - CM_COST)),0)   AS PREV_CM
        ,NVL(SUM(DECODE(B1.COST_WK, SUBSTR(@[f_curr_week], 5, 2), TOT_REV - CM_COST)),0)   AS CURR_CM        
        ,NVL(SUM(DECODE(B1.COST_WK, SUBSTR(@[f_prev_week], 5, 2), VVD_BSA_CAPA)),0)                 AS PREV_BSA_CAPA
        ,NVL(SUM(DECODE(B1.COST_WK, SUBSTR(@[f_curr_week], 5, 2), VVD_BSA_CAPA)),0)                 AS CURR_BSA_CAPA
        ,NVL(SUM(DECODE(B1.COST_WK, SUBSTR(@[f_prev_week], 5, 2), CM_COST)),0)                      AS PREV_CM_COST
        ,NVL(SUM(DECODE(B1.COST_WK, SUBSTR(@[f_curr_week], 5, 2), CM_COST)),0)                      AS CURR_CM_COST
		
    FROM ( 
        SELECT  
          /*+ USE_HASH(A2, A1, A3, A4) PARALLEL(A2, 4) */ 
          '' 		  
		  #if(${f_ofc_sts} =='Y')
		      #if(${f_ofc_lvl1} =='1') 
		        ,A4.OFC_N1ST_LVL_CD 
		      #elseif (${f_ofc_lvl1} =='2')
		        ,A4.OFC_N2ND_LVL_CD 
		      #elseif (${f_ofc_lvl1} =='3')
		        ,A4.OFC_N3RD_LVL_CD
		      #elseif (${f_ofc_lvl1} =='4')
		        ,A4.OFC_N4TH_LVL_CD
		      #elseif (${f_ofc_lvl1} =='5')
		        ,A4.OFC_N5TH_LVL_CD
		      #elseif (${f_ofc_lvl1} =='6')
		        ,A4.OFC_N6TH_LVL_CD
		      #elseif (${f_ofc_lvl1} =='7')
		        ,A4.OFC_N7TH_LVL_CD
		      #end OFC_CD1
		      
		      #if(${f_ofc_lvl2} =='1') 
		        ,A4.OFC_N1ST_LVL_CD 
		      #elseif (${f_ofc_lvl2} =='2')
		        ,A4.OFC_N2ND_LVL_CD 
		      #elseif (${f_ofc_lvl2} =='3')
		        ,A4.OFC_N3RD_LVL_CD
		      #elseif (${f_ofc_lvl2} =='4')
		        ,A4.OFC_N4TH_LVL_CD
		      #elseif (${f_ofc_lvl2} =='5')
		        ,A4.OFC_N5TH_LVL_CD
		      #elseif (${f_ofc_lvl2} =='6')
		        ,A4.OFC_N6TH_LVL_CD
		      #elseif (${f_ofc_lvl2} =='7')
		        ,A4.OFC_N7TH_LVL_CD
		      #end OFC_CD2
		  #end		
          ,A1.TRD_CD 
          ,A1.SUB_TRD_CD 
          ,A1.RLANE_CD 
          ,A1.VSL_CD 
          ,A1.SKD_VOY_NO 
          ,A1.DIR_CD 
          ,NVL(A3.LOD_SPL_CNG_FLG,'N') AS LOD_SPL_CNG_FLG  
          ,A1.COST_WK   
          ,DECODE(NVL(A3.LOD_SPL_CNG_FLG,'N'), 'Y', SUM(DECODE(SUBSTR(A2.CNTR_TPSZ_CD,-1,1),'2',NVL(A2.BKG_QTY,0),NVL(A2.BKG_QTY,0)*2))  
                                            , 'N', MAX(A1.VVD_BSA_CAPA))        AS VVD_BSA_CAPA  
          ,NVL(SUM(DECODE(SUBSTR(A2.CNTR_TPSZ_CD,-1,1),'2',NVL(A2.BKG_QTY,0),NVL(A2.BKG_QTY,0)*2)),0) AS BKG_QTY  
          ,NVL(SUM(A2.BKG_REV+A2.BKG_OFT_REV),0)                                        AS FR_REV  
          ,NVL(SUM(A2.BKG_REV+A2.BKG_OFT_REV+A2.BKG_MISC_REV+A2.SCR_CHG_REV),0)         AS TOT_REV  
          ,NVL(SUM(A2.DMDT_COM_AMT),0)                                                  AS DMDT  		
          ,NVL(SUM(A2.PA_CM_COST_TTL_AMT),0) AS CM_COST  				 		
        FROM 
           COA_BKG_EXPN_DTL A2                   	
          ,COA_MON_VVD A1 
          ,COA_LANE_RGST A3 
          ,COA_OFC_LVL A4             
        WHERE A1.TRD_CD              = A2.TRD_CD 
          AND A1.RLANE_CD            = A2.RLANE_CD 
          AND A1.IOC_CD              = A2.IOC_CD 
          AND A1.VSL_CD              = A2.VSL_CD 
          AND A1.SKD_VOY_NO          = A2.SKD_VOY_NO 
          AND A1.DIR_CD              = A2.DIR_CD           
          AND SUBSTR(A1.SLS_YRMON,1,4) || A1.COST_WK BETWEEN @[f_prev_week] AND @[f_curr_week] 
		  AND SUBSTR(A1.SLS_YRMON,1,4) || A1.COST_WK = SUBSTR(A2.SLS_YRMON,1,4) || A2.COST_WK
		  AND A1.SLS_YRMON          = A2.SLS_YRMON
		  AND A1.COST_WK            = A2.COST_WK		  
		  AND A1.TRD_CD              = A3.TRD_CD 
          AND A1.RLANE_CD            = A3.RLANE_CD 
          AND A1.IOC_CD              = A3.IOC_CD 
          AND A1.DIR_CD              = A3.DIR_CD 
          AND A2.SLS_YRMON           BETWEEN A4.OFC_APLY_FM_YRMON AND A4.OFC_APLY_TO_YRMON           
          #if(${f_ofc_vw} =='C')
			AND A2.AGMT_SGN_OFC_CD = A4.OFC_CD
		  #elseif (${f_ofc_vw} =='L')
			AND A2.SLS_OFC_CD = A4.OFC_CD
		  #else
			AND 1 = 0
		  #end
		  
          AND NVL(A1.DELT_FLG,'N')   = 'N' 
  		#if(${f_bkg_sts} =='Y')
  		      AND A2.BKG_STS_CD        IN ('F','S','W') 
  		#else                                         
            AND A2.BKG_STS_CD        IN ('F','S') 
        #end      
          AND A2.BKG_CGO_TP_CD       <> 'P' 
          AND A2.BL_NO_TP            IN ('M','0') 
                    			
		#if(${f_ofc_cd} !='')
		  #if(${f_excl_sts} =='')
          AND DECODE('${f_ofc_lvl1}', '1', A4.OFC_N1ST_LVL_CD, '2', A4.OFC_N2ND_LVL_CD, '3', A4.OFC_N3RD_LVL_CD, '4', A4.OFC_N4TH_LVL_CD, '5', A4.OFC_N5TH_LVL_CD, '6', A4.OFC_N6TH_LVL_CD, '7', A4.OFC_N7TH_LVL_CD) = '${f_ofc_cd}'  
			#else
          AND A4.OFC_CD = '${f_ofc_cd}'  
			#end
		#end	

		#if(${f_ofc_lvl1}=='6' || ${f_ofc_lvl1}=='7')
    		AND A4.OFC_LVL = '${f_ofc_lvl1}'
  		#else
    		AND A4.OFC_LVL < '9'
  		#end
	
        GROUP BY 	'' 
/*	Office Display */		
		#if(${f_ofc_sts} =='Y')
		      #if(${f_ofc_lvl1} =='1') 
		        ,A4.OFC_N1ST_LVL_CD 
		      #elseif (${f_ofc_lvl1} =='2')
		        ,A4.OFC_N2ND_LVL_CD 
		      #elseif (${f_ofc_lvl1} =='3')
		        ,A4.OFC_N3RD_LVL_CD
		      #elseif (${f_ofc_lvl1} =='4')
		        ,A4.OFC_N4TH_LVL_CD
		      #elseif (${f_ofc_lvl1} =='5')
		        ,A4.OFC_N5TH_LVL_CD
		      #elseif (${f_ofc_lvl1} =='6')
		        ,A4.OFC_N6TH_LVL_CD
		      #elseif (${f_ofc_lvl1} =='7')
		        ,A4.OFC_N7TH_LVL_CD
		      #end 
		      
		      #if(${f_ofc_lvl2} =='1') 
		        ,A4.OFC_N1ST_LVL_CD 
		      #elseif (${f_ofc_lvl2} =='2')
		        ,A4.OFC_N2ND_LVL_CD 
		      #elseif (${f_ofc_lvl2} =='3')
		        ,A4.OFC_N3RD_LVL_CD
		      #elseif (${f_ofc_lvl2} =='4')
		        ,A4.OFC_N4TH_LVL_CD
		      #elseif (${f_ofc_lvl2} =='5')
		        ,A4.OFC_N5TH_LVL_CD
		      #elseif (${f_ofc_lvl2} =='6')
		        ,A4.OFC_N6TH_LVL_CD
		      #elseif (${f_ofc_lvl2} =='7')
		        ,A4.OFC_N7TH_LVL_CD
		      #end 
		#end
          ,A1.COST_WK  	
          ,A1.TRD_CD 
          ,A1.SUB_TRD_CD 
          ,A1.RLANE_CD 
          ,A1.VSL_CD 
          ,A1.SKD_VOY_NO 
          ,A1.DIR_CD 
/*	Directory Display */		
		#if(${f_rpt_item} !='V' && ${f_dir_sts} =='Y')
          ,A1.DIR_CD 
    	#end	
          ,A3.LOD_SPL_CNG_FLG 
          ,A1.VVD_BSA_CAPA 		
      ) b1  
    GROUP BY '' 
		#if(${f_ofc_sts} =='Y')
      ,OFC_CD1		
      ,OFC_CD2		
		#end
		
		#if(${f_rpt_item} =='T')
      ,TRD_CD 
    #elseif (${f_rpt_item} =='S')
      ,TRD_CD 
      ,SUB_TRD_CD 
    #elseif (${f_rpt_item} =='L')
      ,TRD_CD 
      ,SUB_TRD_CD 
      ,RLANE_CD 
    #elseif (${f_rpt_item} =='V')
      ,TRD_CD 
      ,SUB_TRD_CD 
      ,RLANE_CD 
      ,VSL_CD 
      ,SKD_VOY_NO 
      ,DIR_CD 			
    #end	
		
 /* Directory Display */
		#if(${f_rpt_item} !='V' && ${f_dir_sts} =='Y')
		  ,DIR_CD 
		#end
  )
ORDER BY ''
  #if(${f_ofc_sts} =='Y')
  ,OFC_CD1		
  ,OFC_CD2		
  #end
  /* Report */		
  #if(${f_rpt_item} =='T')
    ,TRD_CD 
  #elseif (${f_rpt_item} =='S')
    ,TRD_CD 
    ,SUB_TRD_CD 
  #elseif (${f_rpt_item} =='L')
    ,TRD_CD 
    ,SUB_TRD_CD 
    ,RLANE_CD 
  #elseif (${f_rpt_item} =='V')
    ,TRD_CD 
    ,SUB_TRD_CD 
    ,RLANE_CD 
    ,VSL_CD 
    ,SKD_VOY_NO 
    ,DIR_CD 			
  #end			]]></sql>
			<params>
				<param name="f_prev_week" type="12" value="" out="N"/>
				<param name="f_curr_week" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
