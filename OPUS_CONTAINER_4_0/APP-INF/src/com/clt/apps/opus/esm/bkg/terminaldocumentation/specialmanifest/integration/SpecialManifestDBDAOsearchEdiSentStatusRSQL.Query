<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="SpecialManifestDBDAOsearchEdiSentStatusRSQL">
			<desc><![CDATA[EDI전송 결과를 조회 해 온다.]]></desc>
			<sql><![CDATA[
SELECT
#if (${ui_type} == 'ESM_BKG_0965') 
       (SELECT CASE WHEN TOT.SND_TOT_CNT > 0
                    THEN DECODE(TOT.SND_TOT_CNT, TOT.RCV_ACP_CNT, 'SUCCESS', 'FAIL')
                    ELSE ''
                END ACK_RCV_STS_CD
          FROM (SELECT COUNT(B.EDI_RSPN_SEQ) AS SND_TOT_CNT
                      ,COUNT(C.RCV_LOG_SEQ)  AS RCV_ACP_CNT
                  FROM BKG_CSTMS_EUR_DG_SND      A
                      ,BKG_CSTMS_EUR_DG_EDI_RSPN B
                      ,BKG_CSTMS_EUR_DG_RCV      C
                 WHERE A.EUR_EDI_MSG_TP_ID = 'IFD'
                   AND A.EUR_DG_DECL_TP_CD = @[d_type]
                   AND A.VSL_CD            = SUBSTR(@[vvd_cd], 1, 4)
                   AND A.SKD_VOY_NO        = SUBSTR(@[vvd_cd], 5, 4)
                   AND A.SKD_DIR_CD        = SUBSTR(@[vvd_cd], 9, 1)
                   AND A.PORT_CD           = @[port_cd]
                   AND A.EUR_EDI_MSG_TP_ID = B.EUR_EDI_MSG_TP_ID
                   AND A.MSG_SND_NO        = B.MSG_SND_NO
                   AND B.EUR_EDI_MSG_TP_ID = C.EUR_EDI_MSG_TP_ID(+)
                   AND B.MSG_SND_NO        = C.MSG_RCV_NO(+)
                   AND C.ACK_RCV_STS_CD(+) = 'A'
                   AND A.MSG_SND_NO        = (SELECT MAX(A.MSG_SND_NO)
                                                FROM BKG_CSTMS_EUR_DG_SND A
                                               WHERE A.EUR_EDI_MSG_TP_ID = 'IFD'
                                                 AND A.EUR_DG_DECL_TP_CD = @[d_type]
                                                 AND A.VSL_CD            = SUBSTR(@[vvd_cd], 1, 4)
                                                 AND A.SKD_VOY_NO        = SUBSTR(@[vvd_cd], 5, 4)
                                                 AND A.SKD_DIR_CD        = SUBSTR(@[vvd_cd], 9, 1)
                                                 AND A.PORT_CD           = @[port_cd]
                                             )
               ) TOT
       ) ACK_RCV_STS_CD
#else
       (SELECT CASE WHEN S.MSG_SND_NO IS NULL THEN ''
                    WHEN S.MSG_SND_NO IS NOT NULL AND R.MSG_RCV_NO IS NULL THEN 'P'
                    ELSE R.ACK_RCV_STS_CD
                 END ACK_RCV_STS_CD
          FROM BKG_CSTMS_EUR_DG_SND S
              ,BKG_CSTMS_EUR_DG_RCV R
         WHERE S.MSG_SND_NO = R.MSG_RCV_NO(+)
           AND S.EUR_EDI_MSG_TP_ID = 'IFD'
           AND (S.MSG_SND_NO, R.RCV_LOG_SEQ) = (SELECT MSG_RCV_NO, MAX(RCV_LOG_SEQ)
                                                  FROM BKG_CSTMS_EUR_DG_RCV
                                                 WHERE MSG_RCV_NO = (SELECT MAX(MSG_SND_NO)
                                                                       FROM BKG_CSTMS_EUR_DG_SND
                                                                      WHERE EUR_DG_DECL_TP_CD = @[d_type]
                                                                        AND VSL_CD            = SUBSTR(@[vvd_cd], 1, 4)
                                                                        AND SKD_VOY_NO        = SUBSTR(@[vvd_cd], 5, 4)
                                                                        AND SKD_DIR_CD        = SUBSTR(@[vvd_cd], 9, 1)
                                                                        AND PORT_CD           = @[port_cd]
                                                                        AND EUR_EDI_MSG_TP_ID ='IFD'
                                                                    )
                                                 GROUP BY MSG_RCV_NO
                                               )
       ) ACK_RCV_STS_CD
#end
  FROM DUAL
			]]></sql>
			<params>
				<param name="d_type" type="12" value="" out="N"/>
				<param name="vvd_cd" type="12" value="" out="N"/>
				<param name="port_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
