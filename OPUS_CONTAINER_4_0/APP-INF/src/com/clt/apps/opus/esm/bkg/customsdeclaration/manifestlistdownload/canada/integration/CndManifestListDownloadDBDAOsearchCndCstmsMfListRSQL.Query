<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CndManifestListDownloadDBDAOsearchCndCstmsMfListRSQL">
			<desc><![CDATA[searchCndCstmsMfList]]></desc>
			<sql><![CDATA[
SELECT  TB.VSL_CD || TB.SKD_VOY_NO || TB.SKD_DIR_CD AS VVD
       ,TB.POL_CD
       ,TB.POD_CD
       ,(SELECT TO_CHAR(Z1.VPS_ETD_DT, 'yyyy-mm-dd hh24:mi') 
           FROM VSK_VSL_PORT_SKD Z1
          WHERE Z1.VSL_CD       = TB.VSL_CD
            AND Z1.SKD_VOY_NO   = TB.SKD_VOY_NO
            AND Z1.SKD_DIR_CD   = TB.SKD_DIR_CD
            AND Z1.VPS_PORT_CD  = TB.POL_CD
            AND Z1.CLPT_IND_SEQ = '1'
            AND ROWNUM = 1
        ) AS VPS_ETD_DT
       ,(SELECT TO_CHAR(Z1.VPS_ETA_DT, 'yyyy-mm-dd hh24:mi') 
           FROM VSK_VSL_PORT_SKD Z1
          WHERE Z1.VSL_CD       = TB.VSL_CD
            AND Z1.SKD_VOY_NO   = TB.SKD_VOY_NO
            AND Z1.SKD_DIR_CD   = TB.SKD_DIR_CD
            AND Z1.VPS_PORT_CD  = TB.POD_CD
            AND Z1.CLPT_IND_SEQ = '1'
            AND ROWNUM = 1
        ) AS VPS_ETA_DT
       ,(SELECT MAX(CASE WHEN LOG.TRNK_MNL_BDR_FLG = 'Y'  THEN 'Y'
                         WHEN LOG.TRNK_AUTO_BDR_FLG = 'Y' THEN 'Y'
                         WHEN LOG.TRNK_BDR_FLG = 'Y'      THEN 'Y'
                         ELSE 'N'
                     END)
           FROM BKG_VVD_BDR_LOG LOG
          WHERE TB.VSL_CD         = LOG.VSL_CD
            AND TB.SKD_VOY_NO     = LOG.SKD_VOY_NO
            AND TB.SKD_DIR_CD     = LOG.SKD_DIR_CD
            AND TB.POL_CD         = LOG.POL_CD
            AND TB.POD_CD         = LOG.POD_CD
        ) AS BDR_FLG
       ,(SELECT MAX(CASE WHEN LOG.TRNK_MNL_BDR_FLG = 'Y'  THEN TO_CHAR(LOG.TRNK_MNL_BDR_DT,  'yyyy-mm-dd hh24:mi')
                         WHEN LOG.TRNK_AUTO_BDR_FLG = 'Y' THEN TO_CHAR(LOG.TRNK_AUTO_BDR_DT, 'yyyy-mm-dd hh24:mi')
                         WHEN LOG.TRNK_BDR_FLG = 'Y'      THEN TO_CHAR(LOG.TRNK_ESTM_BDR_DT, 'yyyy-mm-dd hh24:mi')
                     END)
           FROM BKG_VVD_BDR_LOG LOG
          WHERE TB.VSL_CD         = LOG.VSL_CD
            AND TB.SKD_VOY_NO     = LOG.SKD_VOY_NO
            AND TB.SKD_DIR_CD     = LOG.SKD_DIR_CD
            AND TB.POL_CD         = LOG.POL_CD
            AND TB.POD_CD         = LOG.POD_CD
        ) AS BDR_DT
       ,SUM(TB.FUL_CNT) AS FUL_CNT
       ,SUM(TB.EMP_CNT) AS EMP_CNT
       ,SUM(TB.TOT_HBL) AS TOT_HBL
       ,(SELECT MIN(CLPT_SEQ)
           FROM VSK_VSL_PORT_SKD
          WHERE VPS_PORT_CD LIKE 'CA%' 
            AND VSL_CD     = TB.VSL_CD
            AND SKD_VOY_NO = TB.SKD_VOY_NO
            AND SKD_DIR_CD = TB.SKD_DIR_CD
            AND	NVL(SKD_CNG_STS_CD, ' ') <> 'S'
            AND CLPT_SEQ >= (SELECT	MAX(CLPT_SEQ) --POL
                               FROM	VSK_VSL_PORT_SKD
                              WHERE	VSL_CD		= TB.VSL_CD
                                AND	SKD_VOY_NO	= TB.SKD_VOY_NO
                                AND	SKD_DIR_CD	= TB.SKD_DIR_CD
                                AND	VPS_PORT_CD	= TB.POL_CD
                                AND NVL(TURN_PORT_IND_CD, ' ') NOT IN ('D', 'V', 'F')
                                AND VT_ADD_CALL_FLG IS NULL
                                AND	NVL(SKD_CNG_STS_CD, ' ') <> 'S')
        )AS CLPT_SEQ
	   ,NVL((SELECT 'Y'  
       FROM BKG_CSTMS_CD_CONV_CTNT
       WHERE CNT_CD = 'US'
       AND CSTMS_DIV_ID = 'NA_STAFF'
       AND DELT_FLG = 'N'
       AND ATTR_CTNT1 = @[upd_usr_id]
       AND ROWNUM = 1), 'N') AS NA_STF_FLG
  FROM  (
        SELECT  VVD.VSL_CD
               ,VVD.SKD_VOY_NO
               ,VVD.SKD_DIR_CD
               ,VVD.POL_CD
               ,VVD.POD_CD
               ,DECODE(BKG.BKG_CGO_TP_CD, 'P', 0, 1) AS FUL_CNT
               ,DECODE(BKG.BKG_CGO_TP_CD, 'P', 1, 0) AS EMP_CNT
               ,(SELECT COUNT(*) 
                   FROM BKG_HBL 
                  WHERE BKG_NO = BKG.BKG_NO 
                    AND CNTR_MF_NO > ' '
                    AND BKG.CND_CSTMS_FILE_CD = '1'
                ) AS TOT_HBL
          FROM  BKG_VVD VVD 
               ,BKG_BOOKING BKG
         WHERE  VVD.BKG_NO        = BKG.BKG_NO
           AND  VVD.VSL_CD        = @[vsl_cd]
           AND  VVD.SKD_VOY_NO    = @[skd_voy_no]
           AND  VVD.SKD_DIR_CD    = @[skd_dir_cd]
           AND  BKG.BKG_STS_CD IN ('F','W')
#if (${pol_cd} != '') 
           AND  VVD.POL_CD = @[pol_cd]
#end
#if (${pod_cd} != '') 
           AND  VVD.POD_CD = @[pod_cd]
#end
#if (${bkg_cgo_tp_cd} == 'F') 
           AND  BKG.BKG_CGO_TP_CD IN ('F', 'R')
#end
#if (${bkg_cgo_tp_cd} == 'P')
           AND  BKG.BKG_CGO_TP_CD = 'P'
#end
           AND  BKG.BL_NO IS NOT NULL
           AND	VVD.POD_CD IN
           (SELECT VPS_PORT_CD --POD
              FROM VSK_VSL_PORT_SKD
             WHERE VSL_CD     = VVD.VSL_CD
               AND SKD_VOY_NO = VVD.SKD_VOY_NO
               AND SKD_DIR_CD = VVD.SKD_DIR_CD
               AND CLPT_SEQ >= (SELECT MIN(CLPT_SEQ) --CA PORT
                                  FROM VSK_VSL_PORT_SKD
                                 WHERE VSL_CD     = VVD.VSL_CD
                                   AND SKD_VOY_NO = VVD.SKD_VOY_NO
                                   AND SKD_DIR_CD = VVD.SKD_DIR_CD
                                   AND VPS_PORT_CD LIKE 'CA%'
                                   AND NVL(SKD_CNG_STS_CD, ' ') <> 'S'
                                   AND CLPT_SEQ >= (SELECT MAX(CLPT_SEQ) --POL
                                                      FROM VSK_VSL_PORT_SKD
                                                     WHERE VSL_CD     = VVD.VSL_CD
                                                       AND SKD_VOY_NO = VVD.SKD_VOY_NO
                                                       AND SKD_DIR_CD = VVD.SKD_DIR_CD
                                                       AND VPS_PORT_CD LIKE VVD.POL_CD
                                                       AND NVL(TURN_PORT_IND_CD, ' ') NOT IN ('D', 'V', 'F')
                                                       AND VT_ADD_CALL_FLG IS NULL
                                                       AND NVL(SKD_CNG_STS_CD, ' ') <> 'S') ) )
           AND SUBSTR(VVD.POL_CD, 1, 2) <> 'CA'--POL이 CANADA일 때는 제외
        ) TB
GROUP BY TB.VSL_CD
        ,TB.SKD_VOY_NO
        ,TB.SKD_DIR_CD
        ,TB.POL_CD
        ,TB.POD_CD			]]></sql>
			<params>
				<param name="upd_usr_id" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
