<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CargoReleaseOrderDBDAOsearchUsCgoRlseList2RSQL">
			<desc><![CDATA[...]]></desc>
			<sql><![CDATA[
SELECT 
	 BL_NO
	,BKG_NO
	,PCS_QTY
	,VVD_CD
	,POD_CD
	,DEL_CD
	,HUB_CD
	,LAST_UP_DT
	,FRT_CLT_FLG
	,F_LAST_DT
	,OBL_RDEM_FLG
	,O_LAST_DT
	,CSTMS_CLR_CD
	,C_LAST_DT
	,TML_SND
	,TML_LAST_DT
	,PRT_IND
	,CUST_NM
	,INTER_RMK
	,DO_HLD_FLG
	,OBL_TTL_KNT

FROM (
		SELECT 
 			   RANK
			  ,ROW_NUMBER() OVER (PARTITION BY BKG_NO ORDER BY RANK ASC) RNUM
			  ,BL_NO
		      ,BKG_NO
			  ,PCS_QTY
			  ,VVD_CD
			  ,POD_CD
			  ,DEL_CD
			  ,HUB_CD
			  ,LAST_UP_DT
			  ,FRT_CLT_FLG
		      ,F_LAST_DT
			  ,OBL_RDEM_FLG
			  ,O_LAST_DT
			  ,CSTMS_CLR_CD
			  ,C_LAST_DT
			  ,TML_SND
			  ,TML_LAST_DT
			  ,PRT_IND
			  ,CUST_NM
			  ,INTER_RMK
			  ,DO_HLD_FLG
			  ,OBL_TTL_KNT

		FROM (

			SELECT /*+ LEADING(M) USE_NL(M N O P Q R) */  
			       1 RANK,
			       M.BL_NO,
			       P.BKG_NO,
			       N.PCK_QTY PCS_QTY,
			       N.VSL_CD||N.SKD_VOY_NO||N.SKD_DIR_CD VVD_CD,
			       NVL(P.POD_CD, N.CSTMS_PORT_CD) AS POD_CD,
			       N.DEL_CD,
			       N.HUB_LOC_CD HUB_CD,
			       M.LAST_UP_DT,
			       M.FRT_CLT_FLG,
			       M.F_LAST_DT,
			       M.OBL_RDEM_FLG,
			       M.O_LAST_DT,
			       M.CSTMS_CLR_CD,
			       M.C_LAST_DT,
			       M.MRN_TML_EDI_SND_CD TML_SND,
			       M.TML_LAST_DT,
			       ' '  PRT_IND,
			           SUBSTR(REPLACE(REPLACE(O.CUST_NM, CHR(34), CHR(34)||CHR(34)), CHR(10), ' '), 1, 20) CUST_NM,
			       Q.INTER_RMK,
			       NVL(Q.DO_HLD_FLG,'N') AS DO_HLD_FLG,
			       R.BL_CPY_KNT AS OBL_TTL_KNT
			  FROM
			      (
			             SELECT  /*+ USE_NL(A C) */
			               C.BL_NO,
			               TO_CHAR(GREATEST(NVL(C.FRT_CLT_LST_DT,TO_DATE('00010101000001','YYYYMMDDHH24MISS')),
			                                NVL(C.OBL_RDEM_LST_DT,TO_DATE('00010101000001','YYYYMMDDHH24MISS')),
			                                NVL(C.CSTMS_CLR_LST_DT,TO_DATE('00010101000001','YYYYMMDDHH24MISS'))),'DDMonRR HH24:MI', 'NLS_DATE_LANGUAGE=ENGLISH') LAST_UP_DT,
			               C.FRT_CLT_FLG,
			               TO_CHAR(C.FRT_CLT_LST_DT, 'DDMonRR HH24:MI', 'NLS_DATE_LANGUAGE=ENGLISH') F_LAST_DT,
			               C.OBL_RDEM_FLG,
			               TO_CHAR(C.OBL_RDEM_LST_DT, 'DDMonRR HH24:MI', 'NLS_DATE_LANGUAGE=ENGLISH') O_LAST_DT,
			               C.CSTMS_CLR_CD,
			               TO_CHAR(C.CSTMS_CLR_LST_DT, 'DDMonRR HH24:MI', 'NLS_DATE_LANGUAGE=ENGLISH') C_LAST_DT,
			               C.MRN_TML_EDI_SND_CD,
			               TO_CHAR(C.MRN_TML_EDI_LST_SND_DT, 'DDMonRR HH24:MI', 'NLS_DATE_LANGUAGE=ENGLISH') TML_LAST_DT,
			               ROWNUM
			               FROM 
			             BKG_CGO_RLSE C
			      ) M,
			       BKG_CSTMS_ADV_BL   N,
			       BKG_CSTMS_ADV_CUST O,
			       BKG_BOOKING        P,
			       BKG_DO_REF         Q,
			       BKG_BL_ISS         R
			 WHERE N.CNT_CD(+)     = 'US'
			 
			 #if (${vvd} != '') 
			   AND N.VSL_CD     = SUBSTR(@[vvd], 1,4)
			   AND N.SKD_VOY_NO = SUBSTR(@[vvd], 5,4)
			   AND N.SKD_DIR_CD = SUBSTR(@[vvd], 9,1)
			 
			
			#end
			
			#if (${pod_cd} != '')   
			   AND N.POD_CD     = @[pod_cd]
			#end
			
			#if (${del_cd} != '')
			   AND N.DEL_CD     = @[del_cd]
			#end
			   
			#if (${hub_loc_cd} != '')
			   AND N.HUB_LOC_CD = @[hub_loc_cd]
			#end
			#if (${mrn_tml_edi_snd_cd} != '')
			   AND DECODE(NVL(M.MRN_TML_EDI_SND_CD,'N'), 'R', 'Y', 'N') = @[mrn_tml_edi_snd_cd] 
			#end
			#if (${frt_clt_flg} != '')
			   AND DECODE(NVL(M.FRT_CLT_FLG       ,'N'), 'Y', 'Y', 'N') = @[frt_clt_flg]
			#end
			#if (${obl_rdem_flg} != '')
			   AND DECODE(NVL(M.OBL_RDEM_FLG      ,'N'), 'Y', 'Y', 'N') = @[obl_rdem_flg]
			#end
			#if (${cstms_clr_cd} != '')
			   AND (CASE WHEN @[cstms_clr_cd] = 'J' THEN M.CSTMS_CLR_CD
			          ELSE DECODE(M.CSTMS_CLR_CD,'E','Y','J','Y','T','Y','I','Y','W','Y','Y','Y','N') 
			     END) = @[cstms_clr_cd]
			#end
			  
			 
			   AND M.BL_NO  = N.BL_NO(+)
			   AND O.CNT_CD(+) = 'US'
			   AND M.BL_NO  = O.BL_NO(+)
			   AND O.BKG_CUST_TP_CD = 'C'
			   AND M.BL_NO  = P.BL_NO
			   AND P.BKG_NO = Q.BKG_NO(+)
			   AND R.BKG_NO(+) = P.BKG_NO
			
			
            UNION 
		         SELECT
		               2 RANK,
		               BKG.BL_NO,
		               BKG.BKG_NO,
		               DOC.PCK_QTY,
		               VVD.VSL_CD||VVD.SKD_VOY_NO||VVD.SKD_DIR_CD,
		               BKG.POD_CD,
		               BKG.DEL_CD,
		               '',
		               TO_CHAR(GREATEST(NVL(RLSE.FRT_CLT_LST_DT,TO_DATE('000101010001','YYYYMMDDHH24MI')),
				                                NVL(RLSE.OBL_RDEM_LST_DT,TO_DATE('000101010001','YYYYMMDDHH24MI')),
				                                NVL(RLSE.CSTMS_CLR_LST_DT,TO_DATE('000101010001','YYYYMMDDHH24MI'))),'DDMonRR HH24:MI','NLS_DATE_LANGUAGE=ENGLISH') LAST_UP_DT,
				       RLSE.FRT_CLT_FLG FRT_CLT_FLG,
				       TO_CHAR(RLSE.FRT_CLT_LST_DT,'DDMonRR HH24:MI','NLS_DATE_LANGUAGE=ENGLISH') F_LAST_DT,          
				       RLSE.OBL_RDEM_FLG OBL_RDEM_FLG,
				       TO_CHAR(RLSE.OBL_RDEM_LST_DT,'DDMonRR HH24:MI','NLS_DATE_LANGUAGE=ENGLISH') O_LAST_DT,
				       NVL(RLSE.CSTMS_CLR_CD,'X') CSTMS_CLR_CD,
				       TO_CHAR(RLSE.CSTMS_CLR_LST_DT,'DDMonRR HH24:MI','NLS_DATE_LANGUAGE=ENGLISH') C_LAST_DT,
  	                   RLSE.MRN_TML_EDI_SND_CD TML_SND,
					   TO_CHAR(RLSE.MRN_TML_EDI_LST_SND_DT,'DDMonRR HH24:MI','NLS_DATE_LANGUAGE=ENGLISH') TML_LAST_DT,
		               '',
		               CUST.CUST_NM CUST_NM,
				       DREF.INTER_RMK,
				       NVL(DREF.DO_HLD_FLG,'N') AS DO_HLD_FLG,
		               0
		            FROM BKG_VVD VVD
		               , BKG_BOOKING BKG
		               , BKG_CGO_RLSE RLSE
		               , BKG_DO_REF  DREF
		               , BKG_BL_ISS  ISS
   					   , BKG_CUSTOMER  CUST
				       , BKG_BL_DOC  DOC
		           WHERE 1=1
		          #if (${vvd} != '') 
		             AND VVD.VSL_CD     = SUBSTR(@[vvd], 1,4)
		  			 AND VVD.SKD_VOY_NO = SUBSTR(@[vvd], 5,4)
		  			 AND VVD.SKD_DIR_CD = SUBSTR(@[vvd], 9,1)
		          #end
		
		          #if (${pod_cd} != '')   
		             AND VVD.POD_CD     = @[pod_cd]
		          #end
		
				  #if (${del_cd} != '')
         		     AND BKG.DEL_CD     = @[del_cd]
		          #end
		   
		         
		#if (${mrn_tml_edi_snd_cd} != '')
		   AND DECODE(NVL(RLSE.MRN_TML_EDI_SND_CD,'N'), 'R', 'Y', 'N') = @[mrn_tml_edi_snd_cd] 
		#end
		#if (${frt_clt_flg} != '')
		   AND DECODE(NVL(RLSE.FRT_CLT_FLG       ,'N'), 'Y', 'Y', 'N') = @[frt_clt_flg]
		#end
		#if (${obl_rdem_flg} != '')
		   AND DECODE(NVL(RLSE.OBL_RDEM_FLG      ,'N'), 'Y', 'Y', 'N') = @[obl_rdem_flg]
		#end
		#if (${cstms_clr_cd} != '')
		   AND (CASE WHEN @[cstms_clr_cd] = 'J' THEN RLSE.CSTMS_CLR_CD
		          ELSE DECODE(RLSE.CSTMS_CLR_CD,'E','Y','J','Y','T','Y','I','Y','W','Y','Y','Y','N') 
		     END) = @[cstms_clr_cd]
		#end
		            AND VVD.BKG_NO     = BKG.BKG_NO
		            AND BKG.BKG_STS_CD <> 'X'
		            AND BKG.BL_NO      = RLSE.BL_NO(+)
		            AND BKG.BKG_NO      = DREF.BKG_NO(+)
		            AND BKG.BKG_NO      = ISS.BKG_NO(+)
    AND BKG.BKG_NO     = CUST.BKG_NO(+)
    AND CUST.BKG_CUST_TP_CD(+) ='C'
    AND BKG.BKG_NO     = DOC.BKG_NO(+)
    AND BKG.BKG_NO      = ISS.BKG_NO(+)
    AND BKG.BKG_NO     = CUST.BKG_NO(+)
    AND CUST.BKG_CUST_TP_CD(+) ='C'
    AND BKG.BKG_NO     = DOC.BKG_NO(+)
		
		)
           ) 
	WHERE RNUM = 1			]]></sql>
			<params>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="del_cd" type="12" value="" out="N"/>
				<param name="hub_loc_cd" type="12" value="" out="N"/>
				<param name="mrn_tml_edi_snd_cd" type="12" value="" out="N"/>
				<param name="frt_clt_flg" type="12" value="" out="N"/>
				<param name="obl_rdem_flg" type="12" value="" out="N"/>
				<param name="cstms_clr_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
