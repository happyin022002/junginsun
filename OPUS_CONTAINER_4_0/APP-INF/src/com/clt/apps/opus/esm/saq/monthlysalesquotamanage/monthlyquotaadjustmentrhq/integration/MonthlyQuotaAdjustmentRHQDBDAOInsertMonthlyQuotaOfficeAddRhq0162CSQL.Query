<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="MonthlyQuotaAdjustmentRHQDBDAOInsertMonthlyQuotaOfficeAddRhq0162CSQL">
			<desc><![CDATA[DAOCSQL]]></desc>
			<sql><![CDATA[
INSERT INTO SAQ_MON_QTA_RHQ (
                 MQTA_STEP_CD, BSE_YR         , BSE_QTR_CD  , TRD_CD         ,
                 DIR_CD      , MQTA_VER_NO    , RLANE_CD    , SPRT_GRP_CD    ,
                 BSA_GRP_CD  , CTRT_RGN_OFC_CD, BSE_MON     , SUB_TRD_CD     ,
                 CTRT_RHQ_CD , CTRT_AQ_CD     , LOD_QTY     , GRS_RPB_REV    ,
                 CM_UC_AMT   , OPFIT_UC_AMT   , RA_CM_UC_AMT, RA_OPFIT_UC_AMT,
                 OFC_ADD_FLG , CRE_USR_ID     , CRE_DT      , UPD_USR_ID     ,
                 UPD_DT )
 WITH INPUT_PARAMS AS (
                    SELECT @[mqta_step_cd] AS MQTA_STEP_CD,
                           @[bse_yr] AS BSE_YR      ,
                           @[bse_qtr_cd] AS BSE_QTR_CD  ,
                           @[trd_cd] AS TRD_CD      ,
                           @[dir_cd] AS DIR_CD      ,
                           @[mqta_ver_no] AS MQTA_VER_NO ,
                           @[rhq_cd] AS RHQ_CD      ,
                           @[rlane_cd] AS RLANE_CD    ,
                           @[rgn_ofc_cd] AS RGN_OFC_CD  ,
                           @[aq_cd] AS AQ_CD       ,
                           @[sub_trd_cd] AS SUB_TRD_CD
                    FROM DUAL )
   SELECT C.MQTA_STEP_CD, C.BSE_YR    , C.BSE_QTR_CD , C.TRD_CD    , C.DIR_CD    ,
          C.MQTA_VER_NO , C.RLANE_CD  , C.SPRT_GRP_CD, C.BSA_GRP_CD, C.RGN_OFC_CD,
          C.BSE_MON     , B.SUB_TRD_CD, B.RHQ_CD     , B.AQ_CD     ,
          0 AS LOD_QTY, 0 AS GRS_RPB_REV,
          DECODE(SUM(LOD_QTY), 0, 0, SUM(LOD_QTY * CM_UC_AMT)       / SUM(LOD_QTY)) AS CM_UC_AMT      ,
          DECODE(SUM(LOD_QTY), 0, 0, SUM(LOD_QTY * OPFIT_UC_AMT)    / SUM(LOD_QTY)) AS OPFIT_UC_AMT   ,
          DECODE(SUM(LOD_QTY), 0, 0, SUM(LOD_QTY * RA_CM_UC_AMT)    / SUM(LOD_QTY)) AS RA_CM_UC_AMT   ,
          DECODE(SUM(LOD_QTY), 0, 0, SUM(LOD_QTY * RA_OPFIT_UC_AMT) / SUM(LOD_QTY)) AS RA_OPFIT_UC_AMT,
          'Y' AS OFC_ADD_FLG, @[cre_usr_id] AS CRE_USR_ID, SYSDATE, @[upd_usr_id] AS UPD_USR_ID, SYSDATE
     FROM SAQ_MON_QTA_OFC_ADD_MIX A,
          INPUT_PARAMS            B,
          (
				   --전체 경우의 수
            SELECT A.MQTA_STEP_CD, A.BSE_YR     , A.BSE_QTR_CD, A.TRD_CD     ,
                   A.DIR_CD      , C.MQTA_VER_NO, A.RLANE_CD  , C.SPRT_GRP_CD,
                   C.BSA_GRP_CD  , B.RGN_OFC_CD , A.BSE_MON
              FROM SAQ_MON_QTA_RHQ A,
                   INPUT_PARAMS    B,
                   (
                     SELECT DISTINCT SPRT_GRP_CD, BSA_GRP_CD, BSE_MON, C.MQTA_VER_NO
                       FROM SAQ_MON_QTA_RHQ A,
                            INPUT_PARAMS    B,
									-- 해당 Version을 모두 가져오는 로직
                            (
                              SELECT A.MQTA_VER_NO
                                FROM SAQ_MON_QTA_STEP_VER A,
                                     INPUT_PARAMS         B
                               WHERE A.MQTA_STEP_CD = B.MQTA_STEP_CD
                                 AND A.BSE_YR       = B.BSE_YR
                                 AND A.BSE_QTR_CD   = B.BSE_QTR_CD
                                 AND A.TRD_CD       = B.TRD_CD
                                 AND A.DIR_CD       = B.DIR_CD
                                 AND A.CRE_OFC_CD   = B.RHQ_CD  ) C
                        WHERE A.MQTA_STEP_CD = B.MQTA_STEP_CD
                          AND A.BSE_YR       = B.BSE_YR
                          AND A.BSE_QTR_CD   = B.BSE_QTR_CD
                          AND A.TRD_CD       = B.TRD_CD
                          AND A.DIR_CD       = B.DIR_CD
                          AND A.MQTA_VER_NO  = C.MQTA_VER_NO
                          AND A.RLANE_CD     = B.RLANE_CD
                     GROUP BY A.MQTA_STEP_CD, A.BSE_YR, A.BSE_QTR_CD, A.TRD_CD, A.DIR_CD, C.MQTA_VER_NO,
                              A.RLANE_CD, SPRT_GRP_CD, BSA_GRP_CD, CTRT_RGN_OFC_CD, BSE_MON ) C
             WHERE A.MQTA_STEP_CD    = B.MQTA_STEP_CD
               AND A.BSE_YR          = B.BSE_YR
               AND A.BSE_QTR_CD      = B.BSE_QTR_CD
               AND A.TRD_CD          = B.TRD_CD
               AND A.DIR_CD          = B.DIR_CD
               AND A.MQTA_VER_NO     = C.MQTA_VER_NO
               AND A.RLANE_CD        = B.RLANE_CD
               AND A.BSE_MON         = C.BSE_MON
          GROUP BY A.MQTA_STEP_CD, A.BSE_YR, A.BSE_QTR_CD, A.TRD_CD, A.DIR_CD, C.MQTA_VER_NO,
                   A.RLANE_CD, C.SPRT_GRP_CD, C.BSA_GRP_CD, B.RGN_OFC_CD, A.BSE_MON
				   -- 현재 존재하는 경우의 수
             MINUS
            SELECT A.MQTA_STEP_CD, A.BSE_YR     , A.BSE_QTR_CD, A.TRD_CD     ,
                   A.DIR_CD      , A.MQTA_VER_NO, A.RLANE_CD  , C.SPRT_GRP_CD,
                   C.BSA_GRP_CD  , B.RGN_OFC_CD , A.BSE_MON
              FROM SAQ_MON_QTA_RHQ A,
                   INPUT_PARAMS    B,
                   (
                     SELECT DISTINCT SPRT_GRP_CD, BSA_GRP_CD, BSE_MON, C.MQTA_VER_NO
                       FROM SAQ_MON_QTA_RHQ A,
                            INPUT_PARAMS    B,
                            (
                              SELECT A.MQTA_VER_NO
                                FROM SAQ_MON_QTA_STEP_VER A,
                                     INPUT_PARAMS         B
                               WHERE A.MQTA_STEP_CD = B.MQTA_STEP_CD
                                 AND A.BSE_YR       = B.BSE_YR
                                 AND A.BSE_QTR_CD   = B.BSE_QTR_CD
                                 AND A.TRD_CD       = B.TRD_CD
                                 AND A.DIR_CD       = B.DIR_CD
                                 AND A.CRE_OFC_CD   = B.RHQ_CD  ) C
                      WHERE A.MQTA_STEP_CD = B.MQTA_STEP_CD
                        AND A.BSE_YR       = B.BSE_YR
                        AND A.BSE_QTR_CD   = B.BSE_QTR_CD
                        AND A.TRD_CD       = B.TRD_CD
                        AND A.DIR_CD       = B.DIR_CD
                        AND A.MQTA_VER_NO  = C.MQTA_VER_NO
                        AND A.RLANE_CD     = B.RLANE_CD
                   GROUP BY A.MQTA_STEP_CD, A.BSE_YR, A.BSE_QTR_CD, A.TRD_CD, A.DIR_CD, C.MQTA_VER_NO,
                            A.RLANE_CD, SPRT_GRP_CD, BSA_GRP_CD, CTRT_RGN_OFC_CD, BSE_MON ) C
             WHERE A.MQTA_STEP_CD    = B.MQTA_STEP_CD
               AND A.BSE_YR          = B.BSE_YR
               AND A.BSE_QTR_CD      = B.BSE_QTR_CD
               AND A.TRD_CD          = B.TRD_CD
               AND A.DIR_CD          = B.DIR_CD
               AND A.MQTA_VER_NO     = C.MQTA_VER_NO
               AND A.RLANE_CD        = B.RLANE_CD
               AND A.CTRT_RGN_OFC_CD = B.RGN_OFC_CD
               AND A.BSA_GRP_CD      = C.BSA_GRP_CD
               AND A.SPRT_GRP_CD     = C.SPRT_GRP_CD
          GROUP BY A.MQTA_STEP_CD, A.BSE_YR, A.BSE_QTR_CD, A.TRD_CD, A.DIR_CD, A.MQTA_VER_NO,
                   A.RLANE_CD, C.SPRT_GRP_CD, C.BSA_GRP_CD, B.RGN_OFC_CD, A.BSE_MON ) C
    WHERE A.BSE_YR          = C.BSE_YR
      AND A.BSE_QTR_CD      = C.BSE_QTR_CD
      AND A.TRD_CD          = C.TRD_CD
      AND A.DIR_CD          = C.DIR_CD
      AND A.RLANE_CD        = C.RLANE_CD
      AND A.CTRT_RGN_OFC_CD = B.RGN_OFC_CD
 GROUP BY C.MQTA_STEP_CD, C.BSE_YR, C.BSE_QTR_CD, C.TRD_CD, C.DIR_CD, C.MQTA_VER_NO,
          C.RLANE_CD, C.SPRT_GRP_CD, C.BSA_GRP_CD, C.RGN_OFC_CD, C.BSE_MON			]]></sql>
			<params>
				<param name="mqta_step_cd" type="12" value="" out="N"/>
				<param name="bse_yr" type="12" value="" out="N"/>
				<param name="bse_qtr_cd" type="12" value="" out="N"/>
				<param name="trd_cd" type="12" value="" out="N"/>
				<param name="dir_cd" type="12" value="" out="N"/>
				<param name="mqta_ver_no" type="12" value="" out="N"/>
				<param name="rhq_cd" type="12" value="" out="N"/>
				<param name="rlane_cd" type="12" value="" out="N"/>
				<param name="rgn_ofc_cd" type="12" value="" out="N"/>
				<param name="aq_cd" type="12" value="" out="N"/>
				<param name="sub_trd_cd" type="12" value="" out="N"/>
				<param name="cre_usr_id" type="12" value="" out="N"/>
				<param name="upd_usr_id" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
