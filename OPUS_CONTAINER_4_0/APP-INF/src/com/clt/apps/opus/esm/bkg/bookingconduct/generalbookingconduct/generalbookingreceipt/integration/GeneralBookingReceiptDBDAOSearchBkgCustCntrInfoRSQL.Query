<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="GeneralBookingReceiptDBDAOSearchBkgCustCntrInfoRSQL">
			<desc><![CDATA[]]></desc>
			<sql><![CDATA[
#if (${sc_no} != '') 

WITH VALID AS (
	SELECT 
		PROP_NO,
        MAX(AMDT_SEQ) AMDT_SEQ
	FROM PRI_SP_MN
	WHERE PROP_STS_CD = 'F'
	GROUP BY PROP_NO
	)
SELECT HDR.SC_NO,
       CUST.PROP_NO,
       CUST.AMDT_SEQ,
       CUST.PRC_CTRT_PTY_TP_CD,
       CUST.CUST_CNT_CD,
       CUST.CUST_SEQ,
	   (SELECT CUST_LGL_ENG_NM FROM MDM_CUSTOMER WHERE CUST_CNT_CD = NVL(CUST.CUST_CNT_CD, 'xx') AND CUST_SEQ = CUST.CUST_SEQ AND DELT_FLG = 'N') AS CUST_LGL_ENG_NM,
       CUST_TP.PRC_CTRT_CUST_TP_CD
FROM VALID,
     PRI_SP_HDR HDR, 
     PRI_SP_MN MN,
     PRI_SP_CTRT_PTY CUST,
     PRI_SP_CTRT_CUST_TP CUST_TP
WHERE HDR.SC_NO = @[sc_no]
  AND HDR.PROP_NO = MN.PROP_NO
  AND MN.PROP_NO = VALID.PROP_NO
  AND MN.AMDT_SEQ = VALID.AMDT_SEQ
  AND MN.PROP_NO = CUST.PROP_NO
  AND MN.AMDT_SEQ = CUST.AMDT_SEQ
  AND CUST.PRC_CTRT_PTY_TP_CD  = 'C'
  AND CUST.PROP_NO = CUST_TP.PROP_NO
  AND CUST.AMDT_SEQ = CUST_TP.AMDT_SEQ
  AND CUST.PRC_CTRT_PTY_TP_CD = CUST_TP.PRC_CTRT_PTY_TP_CD
  AND (CUST.CUST_CNT_CD, CUST.CUST_SEQ) NOT IN (SELECT ATTR_CTNT1 AS CUST_CNT_CD,ATTR_CTNT2 AS CUST_SEQ FROM BKG_HRD_CDG_CTNT WHERE	HRD_CDG_ID = 'BKG_DMY_CUST')
#elseif (${rfa_no} != '') 

WITH VALID AS (
	SELECT 
		PROP_NO,
        MAX(AMDT_SEQ) AMDT_SEQ
	FROM PRI_RP_MN
    WHERE PROP_STS_CD = 'A'
  	GROUP BY PROP_NO
	)
SELECT HDR.RFA_NO,
       MN.PROP_NO,
       MN.AMDT_SEQ,
       MN.CTRT_CUST_CNT_CD AS CUST_CNT_CD,
       MN.CTRT_CUST_SEQ AS CUST_SEQ,
	   ( SELECT CUST_LGL_ENG_NM FROM MDM_CUSTOMER WHERE CUST_CNT_CD = NVL(MN.CTRT_CUST_CNT_CD, 'xx') AND CUST_SEQ = MN.CTRT_CUST_SEQ AND DELT_FLG = 'N') AS CUST_LGL_ENG_NM,
       MN.PRC_CTRT_CUST_TP_CD
FROM VALID, PRI_RP_HDR HDR, PRI_RP_MN MN
WHERE HDR.RFA_NO = @[rfa_no]
AND HDR.PROP_NO = MN.PROP_NO
AND MN.PROP_NO = VALID.PROP_NO
AND MN.AMDT_SEQ = VALID.AMDT_SEQ
AND (MN.CTRT_CUST_CNT_CD, MN.CTRT_CUST_SEQ) NOT IN (SELECT ATTR_CTNT1 AS CUST_CNT_CD,ATTR_CTNT2 AS CUST_SEQ FROM BKG_HRD_CDG_CTNT WHERE	HRD_CDG_ID = 'BKG_DMY_CUST')
#elseif (${taa_no} != '') 

WITH VALID AS (
	SELECT 
		TAA_PROP_NO,
        MAX(AMDT_SEQ) AMDT_SEQ
	FROM PRI_TAA_MN
  	WHERE CFM_FLG = 'Y'
  	GROUP BY TAA_PROP_NO
	)
SELECT HDR.TAA_NO,
       MN.TAA_PROP_NO,
       MN.AMDT_SEQ,
       MN.CTRT_CUST_CNT_CD AS CUST_CNT_CD,
       MN.CTRT_CUST_SEQ AS CUST_SEQ,
	  (SELECT CUST_LGL_ENG_NM FROM MDM_CUSTOMER WHERE CUST_CNT_CD = NVL(MN.CTRT_CUST_CNT_CD, 'xx') AND CUST_SEQ = MN.CTRT_CUST_SEQ AND DELT_FLG = 'N') AS CUST_LGL_ENG_NM,
       MN.PRC_CTRT_CUST_TP_CD
FROM VALID, PRI_TAA_HDR HDR, PRI_TAA_MN MN
WHERE HDR.TAA_NO = @[taa_no]
AND HDR.TAA_PROP_NO = MN.TAA_PROP_NO
AND MN.TAA_PROP_NO = VALID.TAA_PROP_NO
AND MN.AMDT_SEQ = VALID.AMDT_SEQ
AND (MN.CTRT_CUST_CNT_CD, MN.CTRT_CUST_SEQ) NOT IN (SELECT ATTR_CTNT1 AS CUST_CNT_CD,ATTR_CTNT2 AS CUST_SEQ FROM BKG_HRD_CDG_CTNT WHERE	HRD_CDG_ID = 'BKG_DMY_CUST')
#end			]]></sql>
			<params>
				<param name="sc_no" type="12" value="" out="N"/>
				<param name="rfa_no" type="12" value="" out="N"/>
				<param name="taa_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
