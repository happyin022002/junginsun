<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ArrivalNoticeDBDAOsearchArrNtcCustListRSQL">
			<desc><![CDATA[672-2]]></desc>
			<sql><![CDATA[
/** 672-2 */
SELECT /*+ ORDERED */
       DECODE(BKGM.CHG_DP_FLG, 'Y', '1', '0')   				AS CHG_DP_FLG
     , BKGM.BL_NO       										AS BL_NO   
     , BKGM.BKG_CUST_TP_CD      								AS BKG_CUST_TP_CD
     , NVL(DECODE(IS_AN,'N','N','Y'),'N')                       AS IS_AN
     , DECODE(BKGM.CONTI_CD,'M',BKGM.SC_NO,'') 					AS SC_NO    -- POD의 CONTIENT 가 AMERICA인 경우에만 보여주고
     , BKGM.DEL_CD      										AS DEL_CD
     , BKGM.VAL_CD      										AS VAL_CD
     , EVALUATION_YN      										AS EVALUATION_YN
     , NVL(ANTC.VSL_INFO_SET_FLG,'N') 							AS VSL_INFO_SET_FLG --BKGM.MTCH_FLG
     , BKGM.CUST_CNT_CD || DECODE(BKGM.CUST_SEQ, 0, NULL, NULL, NULL, LPAD(BKGM.CUST_SEQ, 6, '0'))  AS CUST_CD
     , BKGM.CUST_CNT_CD      									AS CUST_CNT_CD
     , BKGM.CUST_SEQ      										AS CUST_SEQ
     , BKGM.CUST_NM      										AS CUST_NM
     , BKGM.CUST_ADDR      										AS CUST_ADDR
     , BKGM.CUST_FAX_NO      									AS CUST_FAX_NO
     , DECODE(BKGM.IB_CMDT_FLG,'1','',DTC1.FAX_NO)  			AS FAX1
     , DECODE(BKGM.IB_CMDT_FLG,'1','',DTC2.FAX_NO)  			AS FAX2
     , DECODE(BKGM.IB_CMDT_FLG,'1','',DTB1.FAX_NO)  			AS FAX3
     , DECODE(BKGM.IB_CMDT_FLG,'1','',DTB2.FAX_NO)  			AS FAX4
     , DECODE(BKGM.IB_CMDT_FLG,'1','',DTAN.FAX_NO)  			AS FAX5
     , NVL(DTC1.FAX_SND_FLG,'Y')								AS FAX_SND_FLG1
     , NVL(DTC2.FAX_SND_FLG,'Y') 								AS FAX_SND_FLG2
     , NVL(DTB1.FAX_SND_FLG,'Y')  								AS FAX_SND_FLG3
     , NVL(DTB2.FAX_SND_FLG,'Y')  								AS FAX_SND_FLG4
     , NVL(DTAN.FAX_SND_FLG,'Y')  								AS FAX_SND_FLG5
     , BKGM.CUST_EML  										    AS CUST_EML
     , DECODE(BKGM.IB_CMDT_FLG,'1','',DTC1.NTC_EML)             AS EML1 
     , DECODE(BKGM.IB_CMDT_FLG,'1','',DTC2.NTC_EML)             AS EML2
     , DECODE(BKGM.IB_CMDT_FLG,'1','',DTB1.NTC_EML)             AS EML3
     , DECODE(BKGM.IB_CMDT_FLG,'1','',DTB2.NTC_EML)             AS EML4
     , DECODE(BKGM.IB_CMDT_FLG,'1','',DTAN.NTC_EML)             AS EML5
     , NVL(DTC1.EML_SND_FLG,'Y')  								AS EML_SND_FLG1
     , NVL(DTC2.EML_SND_FLG,'Y')  								AS EML_SND_FLG2
     , NVL(DTB1.EML_SND_FLG,'Y')  								AS EML_SND_FLG3
     , NVL(DTB2.EML_SND_FLG,'Y')  								AS EML_SND_FLG4
     , NVL(DTAN.EML_SND_FLG,'Y')  								AS EML_SND_FLG5
     , BKGM.VSL_CD || BKGM.SKD_VOY_NO || BKGM.SKD_DIR_CD 		AS VVD
     , BKGM.BKG_NO                                              AS BKG_NO
     , BKGM.IS_VALIDATED                                        AS IS_VALIDATED
     , BKGM.ROW_COUNT                                           AS ROW_COUNT
     , BKGM.IB_CMDT_FLG                                         AS IB_CMDT_FLG
     --수정용도
   	 ,''                                                        AS CUST_CNTC_TP_CD
   	 ,''                                                        AS FAX_NO
   	 ,''                                                        AS NTC_EML
   	 ,''                                                        AS CRE_USR_ID
     ,''                                                        AS UPD_USR_ID
 FROM ( SELECT /*+ ALL_ROWS */
               BKGM.BKG_NO
             , BKGM.DEL_CD
             , NVL(BKGM.SC_NO,BKGM.RFA_NO) SC_NO  
             ,( SELECT CONTI_CD 
                FROM MDM_LOCATION 
                WHERE LOC_CD=BKGM.POD_CD ) CONTI_CD   
             , BVVD.VSL_CD 
             , BVVD.SKD_VOY_NO
             , BVVD.SKD_DIR_CD
             , BKGM.BL_NO  
             , BCST.BKG_CUST_TP_CD
             ,(SELECT NVL(CUST_NM||CUST_ADDR,'N') 
               FROM BKG_CUSTOMER
               WHERE BKG_NO=BKGM.BKG_NO AND BKG_CUST_TP_CD='A' ) IS_AN  -- ALSO NOTIFY 존재유무
             , BCST.AN_SND_FLG AS IS_VALIDATED
             , BCST.CUST_CNT_CD
             , BCST.CUST_SEQ
             , NVL(BCST.IB_CUST_NM,BCST.CUST_NM)  AS CUST_NM
             , NVL(BCST.IB_CUST_ADDR,BCST.CUST_ADDR) AS CUST_ADDR
             , DECODE(BCST.VAL_CD, 'X', NULL, BCST.VAL_CD) AS VAL_CD -- X(Auto-Cancel)은 Evaluation하지 않은 것으로 처리
             , BCST.CUST_FAX_NO
             , BCST.CUST_EML
             , 'C1' CNTC_TP_C1
             , 'C2' CNTC_TP_C2
             , 'B1' CNTC_TP_B1
             , 'B2' CNTC_TP_B2
             , 'AN' CNTC_TP_AN
              , BCST.CHG_DP_FLG
              , DECODE(BCST.AN_SND_FLG, 'Y', DECODE( BCST.MTCH_FLG,'Y','A', BCST.VAL_CD)  -- X(Auto-Cancel)은 AN_SND_FLG가 N이므로 변경 불필요
                                           , 'No' ) AS EVALUATION_YN
             , 1 AS ROW_NUM
             , 1 AS ROW_COUNT
             , (SELECT COUNT(1)
                  FROM BKG_IB_CMDT_CNTC CMDT 
                 WHERE CMDT.OFC_CD = @[ofc_cd]
                   AND CMDT.CUST_CNT_CD = BCST.CUST_CNT_CD
                   AND CMDT.CUST_SEQ = BCST.CUST_SEQ
                   AND CMDT.DELT_FLG ='N'
                   AND ROWNUM = 1 ) AS IB_CMDT_FLG
         FROM VSK_VSL_PORT_SKD VSKD
            , BKG_VVD BVVD
            , BKG_BOOKING BKGM
            , BKG_CUSTOMER BCST
        WHERE 1 = 1
#if (${sch_tp} == 'V') 
          AND BVVD.VSL_CD     = SUBSTR(@[vvd], 1,4) 
          AND BVVD.SKD_VOY_NO = SUBSTR(@[vvd], 5,4)
          AND BVVD.SKD_DIR_CD = SUBSTR(@[vvd], 9,1)
          AND BVVD.POD_CD     = @[pod_cd] -- (OPTIONAL 3)
#elseif (${sch_tp} == 'D') 
          AND VSKD.VPS_ETA_DT 
              BETWEEN TO_DATE(@[vps_eta_dt_start], 'YYYY-MM-DD') 
                  AND TO_DATE(@[vps_eta_dt_end], 'YYYY-MM-DD') +0.99999  -- DURATION (OPTIONAL 2)
          AND VSKD.VPS_PORT_CD = @[pod_cd] -- (OPTIONAL 3)
#elseif (${sch_tp} == 'B') 
          AND BKGM.BL_NO = @[bl_no]  -- BL NO (OPTIONAL 5-1)
#else
          AND 1 = 0
#end
#if (${sch_tp} != 'B' && ${del_cd} != '') 
          AND BKGM.DEL_CD LIKE LPAD(@[del_cd], 2, '-') || '%'  -- DELIVERY PORT CD (OPTIONAL 4)
#end
#if (${sch_tp} != 'B' && ${pol_cd} != '') 
          AND BKGM.POL_CD = @[pol_cd]
#end
#if (${sc_no} != '')
        AND BKGM.SC_NO = @[sc_no]
#end
#if (${cust_nm} != '') 
          AND (UPPER(BCST.CUST_NM) like '%' || UPPER(@[cust_nm]) || '%'   -- name
               
              )
#end
#if (${cust_cnt_cd} != '') 
          AND (   BCST.CUST_CNT_CD = @[cust_cnt_cd] )
#end
#if (${cust_seq} != '')
          AND (   BCST.CUST_SEQ = @[cust_seq] )
#end
#if (${cust_ref_no} != '') 
          AND (BKGM.BKG_NO) IN (SELECT BR.BKG_NO
                                  FROM BKG_REFERENCE BR
                                 WHERE BR.BKG_REF_TP_CD = 'BKPO'
                                   AND BR.BKG_NO = BKGM.BKG_NO
                                   AND BR.CUST_REF_NO_CTNT  = @[cust_ref_no]  -- 고객이 요청하는 번호 (0ptional 8)
                               ) -- BKG REFERENCE NUMBER -- (OPTIONAL END )
#end
#if (${sch_tp} == 'D') 
          AND BVVD.VSL_CD = VSKD.VSL_CD    -- Join의 방향성 때문에 Duration인 경우와 아닌 경우를 분리함
          AND BVVD.SKD_VOY_NO = VSKD.SKD_VOY_NO
          AND BVVD.SKD_DIR_CD = VSKD.SKD_DIR_CD
          AND BVVD.POD_CD = VSKD.VPS_PORT_CD
          AND BVVD.POD_CLPT_IND_SEQ = VSKD.CLPT_IND_SEQ
#else
          AND BVVD.VSL_CD = VSKD.VSL_CD(+)   -- Duration이 아닌경우에는 데이터를 추출하기 위하여 해당과 같이 처리한다.
          AND BVVD.SKD_VOY_NO = VSKD.SKD_VOY_NO(+)
          AND BVVD.SKD_DIR_CD = VSKD.SKD_DIR_CD(+)
          AND BVVD.POD_CD = VSKD.VPS_PORT_CD(+)
          AND BVVD.POD_CLPT_IND_SEQ = VSKD.CLPT_IND_SEQ(+)
#end
          AND BKGM.BKG_NO =BVVD.BKG_NO      
#if ( ${ts_flg} != 'Y')     
          AND BKGM.POD_CD = BVVD.POD_CD
#else
          AND BKGM.PST_RLY_PORT_CD = BVVD.POD_CD
#end 
          AND BKGM.BKG_STS_CD NOT IN( 'X', 'S')
          AND BKGM.BL_NO IS NOT NULL
          AND BKGM.BKG_CGO_TP_CD IN ('F', 'R')
          AND BCST.BKG_NO = BKGM.BKG_NO
          AND BCST.BKG_CUST_TP_CD IN ('C', 'N')
          AND (
                   (BKGM.SAM_CNEE_NTFY_FLG = 'N' 
                    AND BKGM.CUST_TO_ORD_FLG = 'N' -- Consignee, Notify둘다 생성
                   )
                OR (BKGM.SAM_CNEE_NTFY_FLG = 'Y'  -- Notify는 Consignee와 같으므로 Consignee만 생성
                    AND BCST.BKG_CUST_TP_CD = 'C'
                   )
                OR (BKGM.CUST_TO_ORD_FLG = 'Y'    -- Notify에게 연락하므로 Notify만 생성
                    AND BCST.BKG_CUST_TP_CD = 'N'
                   )
              )
          AND NVL(BCST.VAL_CD, '*') <> 'S'  -- SKIP은 NOTICE를 발송하지 않는다.
         ORDER BY BKGM.BL_NO, BCST.BKG_CUST_TP_CD
       ) BKGM
     , BKG_ARR_NTC ANTC
     , BKG_ARR_NTC_DTL DTC1
     , BKG_ARR_NTC_DTL DTC2
     , BKG_ARR_NTC_DTL DTB1
     , BKG_ARR_NTC_DTL DTB2
     , BKG_ARR_NTC_DTL DTAN
 WHERE 1 = 1
#if (${is_validated} != '') 
   AND IS_VALIDATED = @[is_validated]
#end
   AND ANTC.BKG_NO(+) = BKGM.BKG_NO
   AND DTC1.BKG_NO(+)          = BKGM.BKG_NO
   AND DTC1.BKG_CUST_TP_CD(+)  = BKGM.BKG_CUST_TP_CD
   AND DTC1.CUST_CNTC_TP_CD(+) = BKGM.CNTC_TP_C1
   AND DTC2.BKG_NO(+)          = BKGM.BKG_NO
   AND DTC2.BKG_CUST_TP_CD(+)  = BKGM.BKG_CUST_TP_CD
   AND DTC2.CUST_CNTC_TP_CD(+) = BKGM.CNTC_TP_C2 
   AND DTB1.BKG_NO(+)          = BKGM.BKG_NO 
   AND DTB1.BKG_CUST_TP_CD(+)  = BKGM.BKG_CUST_TP_CD
   AND DTB1.CUST_CNTC_TP_CD(+) = BKGM.CNTC_TP_B1 
   AND DTB2.BKG_NO(+)          = BKGM.BKG_NO
   AND DTB2.BKG_CUST_TP_CD(+)  = BKGM.BKG_CUST_TP_CD
   AND DTB2.CUST_CNTC_TP_CD(+) = BKGM.CNTC_TP_B2
   AND DTAN.BKG_NO(+)          = BKGM.BKG_NO
   AND DTAN.BKG_CUST_TP_CD(+)  = BKGM.BKG_CUST_TP_CD
   AND DTAN.CUST_CNTC_TP_CD(+) = BKGM.CNTC_TP_AN			]]></sql>
			<params>
				<param name="ofc_cd" type="12" value="" out="N"/>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="vps_eta_dt_start" type="12" value="" out="N"/>
				<param name="vps_eta_dt_end" type="12" value="" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
				<param name="del_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="sc_no" type="12" value="" out="N"/>
				<param name="cust_nm" type="12" value="" out="N"/>
				<param name="cust_cnt_cd" type="12" value="" out="N"/>
				<param name="cust_seq" type="12" value="" out="N"/>
				<param name="cust_ref_no" type="12" value="" out="N"/>
				<param name="is_validated" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
