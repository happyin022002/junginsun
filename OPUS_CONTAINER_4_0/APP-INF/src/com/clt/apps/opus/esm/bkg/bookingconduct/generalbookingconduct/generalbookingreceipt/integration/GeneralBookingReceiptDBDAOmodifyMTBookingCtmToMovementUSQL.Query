<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="GeneralBookingReceiptDBDAOmodifyMTBookingCtmToMovementUSQL">
			<desc><![CDATA[Movement 정보를 Update한다.]]></desc>
			<sql><![CDATA[
UPDATE CTM_MOVEMENT MV
SET (MV.BKG_NO, MV.BL_NO
     , MV.CRNT_VSL_CD, MV.CRNT_SKD_VOY_NO, MV.CRNT_SKD_DIR_CD
     , MV.TRNK_VSL_CD, MV.TRNK_SKD_VOY_NO, MV.TRNK_SKD_DIR_CD
     ) = ( SELECT BB.BKG_NO, BB.BKG_NO
                   , BB.VSL_CD, BB.SKD_VOY_NO, BB.SKD_DIR_CD
                   , BB.VSL_CD, BB.SKD_VOY_NO, BB.SKD_DIR_CD
             FROM BKG_BOOKING BB
            WHERE BB.BKG_NO = @[bkg_no]
              AND ROWNUM    = 1
          )
     , BKG_KNT  = 1
     , MTY_REPO_VL_RMK = 'UPDATED BY BKG UPDATE SCREEN('||TO_CHAR(SYSDATE, 'YYYY.MM.DD HH24:MI:SS')||')'
     , UPD_DT   = SYSDATE
     , UPD_USR_ID = @[upd_usr_id]
WHERE (MV.CNTR_NO, MV.CNMV_YR, MV.CNMV_SEQ, MV.CNMV_SPLIT_NO)
IN ( SELECT SUB.CNTR_NO
     	, SUBSTR(SUB.VL_ROW, 1, 4) AS CNMV_YR
        , SUBSTR(SUB.VL_ROW, 5, 5) AS CNMV_SEQ
        , SUBSTR(SUB.VL_ROW, 10, 3) AS CNMV_SPLIT_NO
     FROM
        ( SELECT CM.CNTR_NO
             , ( SELECT /*+ INDEX_DESC(SCM XUK1CTM_MOVEMENT) */
                       SCM.CNMV_YR||TRIM(TO_CHAR(SCM.CNMV_SEQ, '00000'))||SCM.CNMV_SPLIT_NO
                 FROM CTM_MOVEMENT SCM
                 WHERE CM.CNTR_NO = SCM.CNTR_NO
                 AND SCM.MVMT_STS_CD = 'VL'
                 AND SCM.CRNT_VSL_CD = 'XXXX'
                 AND SCM.BKG_CGO_TP_CD = 'P'
                 AND SUBSTR(SCM.ORG_YD_CD, 1, 5)   = BB.POL_CD
                 AND SCM.CNMV_EVNT_DT BETWEEN CM.CNMV_EVNT_DT - 70 AND CM.CNMV_EVNT_DT
                 AND CM.CNMV_EVNT_DT >= SCM.CNMV_EVNT_DT
                 AND ROWNUM = 1) AS VL_ROW
          FROM CTM_MOVEMENT CM
             , BKG_BOOKING BB
          WHERE CM.MVMT_STS_CD = 'VD'
          AND    BB.BKG_NO = CM.BKG_NO
          AND    BB.BKG_NO = @[bkg_no]
        ) SUB
     WHERE SUB.VL_ROW IS NOT NULL
  )			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="1" out="N"/>
				<param name="upd_usr_id" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
