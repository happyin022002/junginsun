<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="MonthlyQuotaGuidelineDBDAOMonthlyQuotaTradeInfo0076CSQL">
			<desc><![CDATA[SAQ_MON_QTA_TRD Insert]]></desc>
			<sql><![CDATA[
INSERT INTO SAQ_MON_QTA_TRD (
            MQTA_STEP_CD    ,
            BSE_YR          ,
            BSE_QTR_CD      ,
            TRD_CD          ,
            DIR_CD          ,
            MQTA_VER_NO     ,
            RLANE_CD        ,
            SPRT_GRP_CD     ,
            BSA_GRP_CD      ,
            CTRT_RHQ_CD     ,
            BSE_MON         ,
            SUB_TRD_CD      ,
            LOD_QTY         ,
            GRS_RPB_REV     ,
            CM_UC_AMT       ,
            OPFIT_UC_AMT    ,
            RA_CM_UC_AMT    ,
            RA_OPFIT_UC_AMT ,
            CRE_USR_ID      ,
            CRE_DT          ,
            UPD_USR_ID      ,
            UPD_DT )         
SELECT      /*+ ORDERED USE_HASH(VER, ADJ, MRS) INDEX(MRS XPKSAQ_MON_MDL_RSLT_OFC_SMRY)*/      
            '01'                                                            AS MQTA_STEP_CD,   
            VER.BSE_YR                                                                      ,  
            VER.BSE_QTR_CD                                                                  ,  
            MRS.TRD_CD                                                                      ,  
            MRS.DIR_CD                                                                      ,  
            VER.MQTA_VER_NO                                                 AS MQTA_VER_NO  ,  
            MRS.RLANE_CD                                                                    ,  
            ADJ.SPRT_GRP_CD                                                                 ,  
            ADJ.BSA_GRP_CD                                                                  ,  
            MRS.CTRT_RHQ_CD                                                                 ,  
            MRS.BSE_MON                                                                     ,  
            MRS.SUB_TRD_CD                                                                  ,  
            SUM(MRS.LOD_QTY)                                
                /COUNT(DISTINCT ADJ.VSL_CD||ADJ.SKD_VOY_NO||ADJ.SKD_DIR_CD) AS LOD_QTY      ,  
            SUM(MRS.GRS_RPB_REV*MRS.LOD_QTY)	  /SUM(MRS.LOD_QTY)           AS GRS_RPB_REV  ,  
            SUM(MRS.CM_UC_AMT*MRS.LOD_QTY)		  /SUM(MRS.LOD_QTY)           AS CM_UC_AMT    ,  
            SUM(MRS.OPFIT_UC_AMT*MRS.LOD_QTY)	  /SUM(MRS.LOD_QTY)           AS OPFIT_UC_AMT ,  
            SUM(MRS.RA_CM_UC_AMT*MRS.LOD_QTY)	  /SUM(MRS.LOD_QTY)           AS RA_CM_UC_AMT ,  
            SUM(MRS.RA_OPFIT_UC_AMT*MRS.LOD_QTY)  /SUM(MRS.LOD_QTY)           AS RA_OPFIT_UC_AMT,
            @[user_id]                                                      AS CRE_USR_ID   ,  
            SYSDATE                                                         AS CRE_DT       ,  
            @[user_id]                                                      AS UPD_USR_ID   ,  
            SYSDATE                                                         AS UPD_DT          
FROM        (                                                         
            SELECT  -- YQTA_VER_NO                                    
                    BSE_YR      ,
                    BSE_QTR_CD  ,
                    TRD_CD      ,
                    DIR_CD      ,
                    GLINE_VER_NO,                                     
                    MAX(MQTA_VER_NO) AS MQTA_VER_NO                   
            FROM    SAQ_MON_QTA_STEP_VER                              
            WHERE   MQTA_STEP_CD    = '01'                            
            AND     BSE_YR          = @[year]                         
            AND     BSE_QTR_CD      = @[bse_qtr_cd]                   
            AND     GLINE_VER_NO    = @[version]                      
            GROUP BY
                    BSE_YR      , 
                    BSE_QTR_CD  , 
                    TRD_CD      , 
                    DIR_CD      , 
                    GLINE_VER_NO 
            ) VER,                                  
            SAQ_MON_TGT_VVD_ADJ     ADJ,            
            SAQ_MON_MDL_CTRT_SMRY   MRS             
WHERE  ADJ.BSE_YR           = VER.BSE_YR            
AND    ADJ.BSE_QTR_CD       = VER.BSE_QTR_CD        
AND    ADJ.TRD_CD           = VER.TRD_CD            
AND    ADJ.DIR_CD           = VER.DIR_CD            
AND    ADJ.GLINE_VER_NO     = VER.GLINE_VER_NO      
AND    MRS.MQTA_MDL_VER_NO  = @[mqta_mdl_ver_no]    
AND    MRS.BSE_MON          = ADJ.BSE_MON           
AND    MRS.TRD_CD           = ADJ.TRD_CD            
AND    MRS.RLANE_CD         = ADJ.RLANE_CD          
AND    MRS.DIR_CD           = ADJ.DIR_CD            
AND    MRS.VSL_CD           = ADJ.VSL_CD            
AND    MRS.SKD_VOY_NO       = ADJ.SKD_VOY_NO        
AND    MRS.SKD_DIR_CD       = ADJ.SKD_DIR_CD        
GROUP BY                                            
        VER.BSE_YR,                                 
        VER.BSE_QTR_CD,                             
        MRS.TRD_CD,                                 
        MRS.DIR_CD,                                 
        VER.MQTA_VER_NO,                            
        MRS.RLANE_CD,                               
        ADJ.SPRT_GRP_CD,                            
        ADJ.BSA_GRP_CD,                             
        MRS.CTRT_RHQ_CD,                            
        MRS.BSE_MON,                                
        MRS.BSE_YR,                                 
        MRS.SUB_TRD_CD			]]></sql>
			<params>
				<param name="user_id" type="12" value="" out="N"/>
				<param name="year" type="12" value="" out="N"/>
				<param name="bse_qtr_cd" type="12" value="" out="N"/>
				<param name="version" type="12" value="" out="N"/>
				<param name="mqta_mdl_ver_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
