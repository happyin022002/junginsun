<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CommonDBDAOAddBkgSokeupCalcCSQL">
			<desc><![CDATA[CommonDBDAOAddBkgSokeupCalcCSQL
[SJH.20140818] BKG 소급 대상 수정
'P'상태의 경우 UPDATE하지 않도록 쿼리 수정]]></desc>
			<sql><![CDATA[
MERGE INTO COA_BKG_COST_CALC K USING
(
SELECT BKG_NO, COA_BAT_RMK, CRE_USR_ID 
FROM COA_BKG_RTRO_HIS 
WHERE BKG_NO IN (
#if($expVal.size() != 0)
	#foreach(${key} in ${expVal})
		#if($velocityCount < $expVal.size())
                            '${key}',
                        #else
                            '${key}'
        #end
    #end
#end
)
AND COA_BAT_SEQ = @[max_seq]
) B2
ON( K.BKG_NO = B2.BKG_NO)              
WHEN NOT MATCHED THEN
         INSERT
                (                
                        K.BKG_NO
                      , K.COA_BAT_CD
                      , K.COA_BAT_SEQ
                      , K.COA_BAT_DT
                      , K.COA_BAT_RMK
                      , K.COA_MNL_BAT_SEQ
                      , K.CRE_USR_ID
                      , K.CRE_DT
                      , K.UPD_USR_ID
                      , K.UPD_DT
                )
                VALUES
                (
                        B2.BKG_NO
                      , 'E' -- HARD CODING
                      , '2' -- HARD CODING
                      , SYSDATE
                      , B2.COA_BAT_RMK
                      , '0' -- HARD CODING
                      , B2.CRE_USR_ID
                      , SYSDATE
                      , B2.CRE_USR_ID
                      , SYSDATE            
                )
WHEN MATCHED THEN
UPDATE SET
K.COA_BAT_CD = DECODE(K.COA_BAT_CD, 'P', K.COA_BAT_CD, 'E'), --'P' 상태인 BKG은 UPDATE 하지 않는다.
K.COA_BAT_SEQ = DECODE(K.COA_BAT_CD, 'P', K.COA_BAT_SEQ, '2'),
K.COA_BAT_DT = DECODE(K.COA_BAT_CD, 'P', K.COA_BAT_DT, SYSDATE),
K.COA_BAT_RMK = DECODE(K.COA_BAT_CD, 'P', K.COA_BAT_RMK, B2.COA_BAT_RMK),
K.COA_MNL_BAT_SEQ = DECODE(K.COA_BAT_CD, 'P', K.COA_MNL_BAT_SEQ, '0'),
K.UPD_DT = DECODE(K.COA_BAT_CD, 'P', K.UPD_DT, SYSDATE),
K.UPD_USR_ID = DECODE(K.COA_BAT_CD, 'P', K.UPD_USR_ID, B2.CRE_USR_ID)			]]></sql>
			<params>
				<param name="max_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
