<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="PSASpecialManifestDBDAOpsaSearchCntrCgoByCntrBaseRSQL">
			<desc><![CDATA[]]></desc>
			<sql><![CDATA[
SELECT @[msg_snd_no] AS MSG_SND_NO,
       BVD.CNTR_CGO_SEQ AS ITEM_NBR,
       BVD.OUT_IMDG_PCK_QTY1 AS PKG_QTY,
       BVD.OUT_IMDG_PCK_QTY1 AS OUTPKG_QTY,
       BVD.IN_IMDG_PCK_QTY1 AS INPKG_QTY,
       BVD.OUT_IMDG_PCK_CD1 AS PKG_TP,
       BVD.OUT_IMDG_PCK_CD1 AS OUTPKG_TP,
       BVD.IN_IMDG_PCK_CD1 AS INPKG_TP,
       -- BVD.TTL_PCK_DESC AS PKG_DESC,
       -- BVD.EUR_PCK_DESC AS PKG_DESC,
       (SELECT IMDG_PCK_DESC
          FROM SCG_IMDG_PCK_CD
         WHERE IMDG_PCK_CD = BVD.OUT_IMDG_PCK_CD1
           AND IMDG_PCK_TP_CD = 'O'
           AND DELT_FLG = 'N') AS PKG_DESC,
       -- DECODE('SGSIN', NULL,BVD.TTL_PCK_DESC) AS OUTPKG_DESC,
       -- BVD.EUR_OUTR_PCK_DESC AS OUTPKG_DESC,
       BVD.TTL_PCK_DESC AS OUTPKG_DESC,
       DECODE(NULL, NULL, BVD.TTL_PCK_DESC) AS INPKG_DESC,
       --BVD.EUR_INR_PCK_DESC AS INPKG_DESC,
       BVD.HZD_DESC AS HAZ_CONT,
       BVD.PRP_SHP_NM AS PROP_SHIP_NM,
       BVD.IMDG_CLSS_CD AS IMO_CLASS,
       SIUN.IMDG_COMP_GRP_CD AS IMO_COMP,
       BVD.EMER_RSPN_GID_NO AS IMO_PAGE,
       BVD.IMDG_UN_NO AS UN_NBR,
       BVD.IMDG_UN_NO_SEQ AS UN_NBR_SEQ,
       BVD.FLSH_PNT_CDO_TEMP AS FLASH,
       'CEL' AS FLASH_UNIT,
       BVD.IMDG_PCK_GRP_CD AS PKG_GROUP,
       BVD.EMS_NO AS EMS_NBR,
       '' AS MFAG,
       --BVD.MFAG_NO AS MFAG,    -- 위험물 긴급의료 조치표(MFAG:MEDICAL FIRST AID GUIDE FOR USE IN ACCIDENTS INVOLVING DANGEROUS GOODS)상의 식별 번호
       '' AS ESPN,
       --BVD.XTD_STAY_PRMT_NO AS ESPN,    - ANTWERP세관에서 허가한 CARGO 신고 기간 연장 번호 예)080124-03-3101
       SIUN.IMDG_MRN_POLUT_CD AS POLLUTANT,
       BVD.IMDG_LMT_QTY_FLG AS IMO_LIMIT,
       BVD.HCDG_FLG AS HCDG,
       BVD.GRS_WGT AS GROSSWGT,
       'KGM' AS GROSSWGT_UNIT,
       BVD.NET_WGT AS NETWGT,
       'KGM' AS NETWGT_UNIT,
       BVD.NET_EXPLO_WGT AS NW_EXPLOSIVE,
       'KGM' AS NW_EXP_UNIT,
       BVD.CNTR_NO AS CNTRNBR,
       '' AS STOWPOS,
       BVD.IMDG_SUBS_RSK_LBL_CD1 AS SUB_CLASS1,
       BVD.IMDG_SUBS_RSK_LBL_CD2 AS SUB_CLASS2,
       BVD.IMDG_SUBS_RSK_LBL_CD3 AS SUB_CLASS3,
       BVD.IMDG_SUBS_RSK_LBL_CD4 AS SUB_CLASS4,
       BVD.BKG_NO,
       BVD.BL_NO,
       BVD.POL_CD,
       BVD.POD_CD,
       BVD.VSL_CD||BVD.SKD_VOY_NO||BVD.SKD_DIR_CD AS VVD_CD

  FROM

       SCG_IMDG_UN_NO SIUN,
       (SELECT DECODE(LAG(BK.BL_NO) OVER (ORDER BY BK.BL_NO, BV.POL_CD, BV.POD_CD, BDC.CNTR_NO), BK.BL_NO, 0, 1) AS SEQ,
               COUNT(DISTINCT BDC.CNTR_NO) OVER() AS CNTR_CNT,
               BV.BKG_NO,
               BK.BL_NO,
               BV.POL_CD,
               BV.POD_CD,
               BV.VSL_CD,
               BV.SKD_VOY_NO,
               BV.SKD_DIR_CD,
               BDC.CNTR_NO,
               BDC.CNTR_CGO_SEQ,
               BDC.CNTR_TPSZ_CD,
               SIUN.IMDG_COMP_GRP_CD,
               BDC.IMDG_UN_NO,
               BDC.IMDG_UN_NO_SEQ,
               BDC.IMDG_CLSS_CD,
               '' AS DG_SHORT_NM,
               BDC.DG_CNTR_SEQ,
               BDC.FLSH_PNT_CDO_TEMP,
               BDC.IMDG_PCK_GRP_CD,
               BDC.IN_IMDG_PCK_QTY1,
               BDC.IN_IMDG_PCK_CD1,
               BDC.OUT_IMDG_PCK_QTY1,
               BDC.OUT_IMDG_PCK_CD1,
               BDC.EMS_NO,
               BDC.NET_WGT,
               BDC.GRS_WGT,
               BDC.PRP_SHP_NM,
               BDC.HZD_DESC,
               BDC.IMDG_SUBS_RSK_LBL_CD1,
               BDC.IMDG_SUBS_RSK_LBL_CD2,
               BDC.IMDG_SUBS_RSK_LBL_CD3,
               BDC.IMDG_SUBS_RSK_LBL_CD4,
               BDC.MRN_POLUT_FLG,
               BDC.IMDG_LMT_QTY_FLG,
               BDC.HCDG_FLG,
               BDC.NET_EXPLO_WGT,
               D.TTL_PCK_DESC,
               BDC.EMER_RSPN_GID_NO

          FROM BKG_VVD BV,
               BKG_DG_CGO BDC,
               BKG_BOOKING BK,
               SCG_IMDG_UN_NO SIUN,
               BKG_BL_DOC D

         WHERE 1=1
           AND BV.VSL_CD = SUBSTR(@[vvd_cd], 1, 4)
           AND BV.SKD_VOY_NO = SUBSTR(@[vvd_cd], 5, 4)
           AND BV.SKD_DIR_CD = SUBSTR(@[vvd_cd], 9, 1)
           AND BV.POL_CD IN (SELECT VPS_PORT_CD
                               FROM VSK_VSL_PORT_SKD
                              WHERE VSL_CD = SUBSTR(@[vvd_cd], 1, 4)
                                AND SKD_VOY_NO = SUBSTR(@[vvd_cd], 5, 4)
                                AND SKD_DIR_CD = SUBSTR(@[vvd_cd], 9, 1)
                                AND CLPT_SEQ <= (SELECT MIN(CLPT_SEQ)
                                       FROM VSK_VSL_PORT_SKD
                                      WHERE VSL_CD = SUBSTR(@[vvd_cd], 1, 4)
                                        AND SKD_VOY_NO = SUBSTR(@[vvd_cd], 5, 4)
                                        AND SKD_DIR_CD = SUBSTR(@[vvd_cd], 9, 1)
                                        AND VPS_PORT_CD = @[port_cd])
                                AND NVL(SKD_CNG_STS_CD, 'X') <> 'S')
           AND BV.POD_CD IN (SELECT VPS_PORT_CD
                               FROM VSK_VSL_PORT_SKD
                              WHERE VSL_CD = SUBSTR(@[vvd_cd], 1, 4)
                                AND SKD_VOY_NO = SUBSTR(@[vvd_cd], 5, 4)
                                AND SKD_DIR_CD = SUBSTR(@[vvd_cd], 9, 1)
                                AND CLPT_SEQ >= (SELECT MIN(CLPT_SEQ)
                                       FROM VSK_VSL_PORT_SKD
                                      WHERE VSL_CD = SUBSTR(@[vvd_cd], 1, 4)
                                        AND SKD_VOY_NO = SUBSTR(@[vvd_cd], 5, 4)
                                        AND SKD_DIR_CD = SUBSTR(@[vvd_cd], 9, 1)
                                        AND VPS_PORT_CD = @[port_cd])
                                AND CLPT_SEQ < (SELECT NVL(MIN(V2.CLPT_SEQ), 50)
                                       FROM VSK_VSL_PORT_SKD V1,
                                            VSK_VSL_PORT_SKD V2
                                      WHERE 1=1
                                        AND V1.VSL_CD = SUBSTR(@[vvd_cd], 1, 4)
                                        AND V1.SKD_VOY_NO = SUBSTR(@[vvd_cd], 5, 4)
                                        AND V1.SKD_DIR_CD = SUBSTR(@[vvd_cd], 9, 1)
                                        AND V1.VSL_CD = V2.VSL_CD
                                        AND V1.SKD_VOY_NO = V2.SKD_VOY_NO
                                        AND V1.SKD_DIR_CD = V2.SKD_DIR_CD
                                        AND NVL(V1.SKD_CNG_STS_CD, 'X') = 'O'
                                        AND NVL(V2.SKD_CNG_STS_CD, 'X') = 'A'
                                        AND V1.CLPT_SEQ < V2.CLPT_SEQ)
                                AND NVL(SKD_CNG_STS_CD, 'X') <> 'S')
           AND BV.BKG_NO = BK.BKG_NO
           AND BV.BKG_NO = BDC.BKG_NO
           AND BDC.IMDG_UN_NO = SIUN.IMDG_UN_NO(+)
           AND BDC.IMDG_UN_NO_SEQ = SIUN.IMDG_UN_NO_SEQ(+)
           AND BK.DCGO_FLG = 'Y'
           AND BK.BKG_STS_CD <> 'X'
           AND D.BKG_NO = BV.BKG_NO
           AND BK.BL_NO = @[bl_no]) BVD

 WHERE 1=1
   AND BVD.IMDG_UN_NO = SIUN.IMDG_UN_NO(+)
   AND BVD.IMDG_UN_NO_SEQ = SIUN.IMDG_UN_NO_SEQ(+)

 ORDER BY CNTR_NO,
          CNTR_CGO_SEQ			]]></sql>
			<params>
				<param name="msg_snd_no" type="12" value="" out="N"/>
				<param name="vvd_cd" type="12" value="" out="N"/>
				<param name="port_cd" type="12" value="" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
