<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="RFAReportDBDAORsltSearchRFAListVORSQL">
			<desc><![CDATA[RFA Retrieve]]></desc>
			<sql><![CDATA[
WITH
RA  AS
(
SELECT  RS.SVC_SCP_CD           ,
        RH.RFA_NO               ,
        RM.AMDT_SEQ             ,
        RM.PRC_CTRT_CUST_TP_CD  ,
        RM.CTRT_CUST_CNT_CD     ,
        RM.CTRT_CUST_SEQ        ,
        ( SELECT A.CUST_LGL_ENG_NM FROM MDM_CUSTOMER A WHERE A.CUST_CNT_CD = RM.CTRT_CUST_CNT_CD AND A.CUST_SEQ = RM.CTRT_CUST_SEQ ) CUST_NM ,
        RS.PROP_SCP_OFC_CD      ,
        RS.PROP_SCP_SREP_CD     ,
        RD.CTRT_EFF_DT          ,
        RD.CTRT_EXP_DT          
FROM    PRI_RP_HDR     RH  ,
        PRI_RP_MN      RM  ,
        PRI_RP_SCP_MN  RS  ,
        PRI_RP_SCP_DUR RD
WHERE   RM.PROP_NO       = RH.PROP_NO
AND     RM.PROP_STS_CD   = 'A'
AND     RS.PROP_NO       = RM.PROP_NO
AND     RS.AMDT_SEQ      = RM.AMDT_SEQ
AND     RD.PROP_NO       = RS.PROP_NO
AND     RD.AMDT_SEQ      = RS.AMDT_SEQ
AND     RD.SVC_SCP_CD    = RS.SVC_SCP_CD
#if (${rfa_no} != '')
AND     RH.RFA_NO             LIKE @[rfa_no] || '%' -- RFA No
#end
#if (${prc_ctrt_cust_tp_cd} != '') 
AND    RM.PRC_CTRT_CUST_TP_CD = @[prc_ctrt_cust_tp_cd] -- Customer Type
#end
#if (${prop_scp_srep_cd} != '') 
AND    RS.PROP_SCP_SREP_CD    = @[prop_scp_srep_cd] -- S.Rep : RESPB_SREP_CD
#end
#if (${prop_scp_ofc_cd} != '') 
AND    RS.PROP_SCP_OFC_CD     = @[prop_scp_ofc_cd] -- Contract Office : RESPB_SLS_OFC_CD
#end
#if (${svc_scp_cd} != '') 
AND    RS.SVC_SCP_CD          = @[svc_scp_cd] -- SVC Scope
#end
AND    RS.EFF_DT              <= TO_DATE(@[exp_dt], 'YYYY-MM-DD') -- Effective Date(To) or Access Date
AND    RS.EXP_DT              >= TO_DATE(@[eff_dt], 'YYYY-MM-DD') -- Effective Date(From) or Access Date
#if (${customer_code} == 'C' && ${ctrt_cust_cnt_cd} != '' && ${ctrt_cust_seq} != '') -- Customer
AND    RM.CTRT_CUST_CNT_CD = @[ctrt_cust_cnt_cd] -- Customer
AND    RM.CTRT_CUST_SEQ    = @[ctrt_cust_seq] -- Customer
#end
#if (${customer_code} == 'A' && ${ctrt_cust_cnt_cd} != '' && ${ctrt_cust_seq} != '') -- Actual Customer
AND    EXISTS  (
                SELECT  'X'
                FROM    PRI_RP_SCP_RT_ACT_CUST  AC
                WHERE   AC.PROP_NO     = RS.PROP_NO
                AND     AC.AMDT_SEQ    = RS.AMDT_SEQ
                AND     AC.SVC_SCP_CD  = RS.SVC_SCP_CD
                AND     AC.CUST_CNT_CD = @[ctrt_cust_cnt_cd] -- Actual Customer
                AND     AC.CUST_SEQ    = @[ctrt_cust_seq] -- Actual Customer
               )
#end
#if (${customer_code} == 'F' && ${ctrt_cust_cnt_cd} != '' && ${ctrt_cust_seq} != '')  -- Affiliate
AND    EXISTS  (
                SELECT  'X'
                FROM    PRI_RP_AFIL AF
                WHERE   AF.PROP_NO     = RM.PROP_NO
                AND     AF.AMDT_SEQ    = RM.AMDT_SEQ
                AND     AF.CUST_CNT_CD = @[ctrt_cust_cnt_cd] -- Affiliate
                AND     AF.CUST_SEQ    = @[ctrt_cust_seq] -- Affiliate
               )
#end
)
SELECT  SVC_SCP_CD          ,
        RFA_NO              ,
        AMDT_SEQ AS AMDT_SEQ ,
        PRC_CTRT_CUST_TP_CD ,
		(SELECT INTG_CD_VAL_DP_DESC FROM COM_INTG_CD_DTL WHERE INTG_CD_ID = 'CD00779' AND INTG_CD_VAL_CTNT = A.PRC_CTRT_CUST_TP_CD) AS PRC_CTRT_CUST_TP_NM ,
        CTRT_CUST_CNT_CD    ,
        CTRT_CUST_SEQ       ,
	    CTRT_CUST_CNT_CD || LPAD(CTRT_CUST_SEQ,6,0) AS CODE ,
        CUST_NM             ,
        PROP_SCP_OFC_CD     ,
        PROP_SCP_SREP_CD    ,
        TO_CHAR(CTRT_EFF_DT,'YYYY-MM-DD') AS CTRT_EFF_DT ,
        TO_CHAR(CTRT_EXP_DT,'YYYY-MM-DD') AS CTRT_EXP_DT ,
        '' AS EFF_DT        , -- param
        '' AS EXP_DT        , -- param
        '' AS CUSTOMER_CODE   -- param
FROM    RA  A
WHERE   NOT EXISTS (
                     SELECT  'X'
                     FROM   RA B
                     WHERE  B.RFA_NO     = A.RFA_NO
                     AND    B.SVC_SCP_CD = A.SVC_SCP_CD
                     AND    B.AMDT_SEQ   > A.AMDT_SEQ
                    )
ORDER BY
          SVC_SCP_CD  ,
          RFA_NO			]]></sql>
			<params>
				<param name="rfa_no" type="12" value="" out="N"/>
				<param name="prc_ctrt_cust_tp_cd" type="12" value="" out="N"/>
				<param name="prop_scp_srep_cd" type="12" value="" out="N"/>
				<param name="prop_scp_ofc_cd" type="12" value="" out="N"/>
				<param name="svc_scp_cd" type="12" value="" out="N"/>
				<param name="exp_dt" type="12" value="" out="N"/>
				<param name="eff_dt" type="12" value="" out="N"/>
				<param name="ctrt_cust_cnt_cd" type="12" value="" out="N"/>
				<param name="ctrt_cust_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
