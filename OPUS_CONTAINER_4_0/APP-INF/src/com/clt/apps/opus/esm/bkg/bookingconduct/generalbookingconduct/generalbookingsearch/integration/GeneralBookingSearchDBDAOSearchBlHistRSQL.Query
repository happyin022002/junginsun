<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="GeneralBookingSearchDBDAOSearchBlHistRSQL">
			<desc><![CDATA[GeneralBookingSearchDBDAOSearchBlHistRSQL]]></desc>
			<sql><![CDATA[
SELECT mst.his_seq
		,DTL.HIS_DTL_SEQ
		, (SELECT ATTR_CTNT2 
          FROM BKG_HRD_CDG_CTNT 
         WHERE HRD_CDG_ID = 'HIST_UI_NAME' 
           AND ATTR_CTNT1 = MST.BKG_HIS_ISS_UI_ID) ITEM_HDR
        , DTL.HIS_CATE_NM
        , CASE  WHEN REPLACE(DTL.PRE_CTNT,CHR(13),'☞') LIKE '%☞%' THEN 'View Detail'
              WHEN LENGTHB(DTL.PRE_CTNT) > 200 THEN 'View Detail'
              ELSE DTL.PRE_CTNT
          END PRE_CTNT
        , DTL.PRE_CTNT PRE_CTNT_ORG
        , CASE  WHEN REPLACE(DTL.CRNT_CTNT,CHR(13),'☞') LIKE '%☞%' THEN 'View Detail'
              WHEN LENGTHB(DTL.CRNT_CTNT) > 200 THEN 'View Detail'
              ELSE DTL.CRNT_CTNT
          END CRNT_CTNT
        , DTL.CRNT_CTNT CRNT_CTNT_ORG
        , NVL(USR.USR_NM, MST.CRE_USR_ID) AS CRE_USR_ID
        , (SELECT OFC_CD FROM COM_USER WHERE UPPER(USR_ID) = UPPER(MST.CRE_USR_ID) AND USE_FLG = 'Y' AND ROWNUM = 1 ) OFFICE
        , TO_CHAR(DECODE(DTL.HIS_CATE_NM,'EXPORT INFORMATION-USA',DTL.UPD_DT,MST.EVNT_DT), 'YYYY-MM-DD HH24:MI') CRE_DT
--		, TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC(BKG_COM_USER_LOC_FNC(MST.CRE_USR_ID), DECODE(DTL.HIS_CATE_NM,'EXPORT INFORMATION-USA',DTL.UPD_DT,MST.EVNT_DT), 'GMT'), 'YYYY-MM-DD HH24:MI') GMT_DT
--        Batch call AutoratingTaxCalculate Hard Coding 'TAXBATCH'
		, CASE WHEN MST.CRE_USR_ID='TAXBATCH' THEN TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC('KRPUS', DECODE(DTL.HIS_CATE_NM,'EXPORT INFORMATION-USA',DTL.UPD_DT,MST.EVNT_DT), 'GMT'), 'YYYY-MM-DD HH24:MI')
		  ELSE TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC(BKG_COM_USER_LOC_FNC(MST.CRE_USR_ID), DECODE(DTL.HIS_CATE_NM,'EXPORT INFORMATION-USA',DTL.UPD_DT,MST.EVNT_DT), 'GMT'), 'YYYY-MM-DD HH24:MI')
		  END GMT_DT
		, MST.CORR_NO
  FROM BKG_HIS_MST MST
     , BKG_HIS_DTL DTL
     , COM_USER USR
 WHERE MST.BKG_NO  = DTL.BKG_NO
   AND MST.HIS_SEQ = DTL.HIS_SEQ
   AND UPPER(MST.CRE_USR_ID) = UPPER(USR.USR_ID(+))
   AND MST.BKG_NO = @[bkg_no]
   AND NVL(MST.CORR_NO, 'X') <> 'TMP0000001'
   AND UPPER(NVL(DTL.CRNT_CTNT,'TMP')) NOT IN ('SEE CUSTOMER INFORMATION TAB', 'SEE FREIGHT & CHARGE TAB')
 --ORDER BY MST.HIS_SEQ, HIS_DTL_SEQ
UNION ALL 

SELECT  (SELECT MAX(MST.HIS_SEQ)+1 FROM BKG_HIS_MST MST WHERE MST.BKG_NO = @[bkg_no]
                                 AND NVL(MST.CORR_NO, 'X') <> 'TMP0000001' 
                                 AND MST.EVNT_DT < TO_DATE(DECODE(XDT.BY_SEQ,1,T.DOWNLOAD_DT,T.MF_SND_DT),'YYYY-MM-DD HH24:MI')) AS his_seq 
,	    0  as HIS_DTL_SEQ
,	    DECODE(SUBSTR(T.PORT,0,2),'US','USAMS','CA','Canada ACI',T.PORT)	AS ITEM_HDR
,       T.PORT_NM AS HIS_CATE_NM
,	    '' PRE_CTNT
,	    '' PRE_CTNT_ORG
--,       DECODE(XDT.BY_SEQ,1,T.DOWNLOAD_FLAG,T.CUST_STATUS) AS CRNT_CTNT
,       DECODE(XDT.BY_SEQ,1,T.DOWNLOAD_FLAG,NVL(T.CUST_STATUS_NM,'Manifest Transmit')) AS CRNT_CTNT
,	    '' CRNT_CTNT_ORG
,		NVL((SELECT USR.USR_NM  
               FROM COM_USER USR 
              WHERE UPPER(USR.USR_ID) = UPPER(DECODE(XDT.BY_SEQ, 1, T.DOWN_USR_ID, T.SEND_USER_ID))
                AND NVL(USE_FLG, 'Y') = 'Y'
                AND ROWNUM = 1),DECODE(XDT.BY_SEQ, 1, T.DOWN_USR_ID, T.SEND_USER_ID))  CRE_USR_ID
,       DECODE(XDT.BY_SEQ, 1, T.DOWN_OFC_NM, T.SEND_OFC_NM) AS OFC_NM
,       DECODE(XDT.BY_SEQ,1,T.DOWNLOAD_DT,T.MF_SND_DT) AS MF_SND_DT
,       DECODE(XDT.BY_SEQ,1,T.GMT_DOWNLOAD_DT,T.GMT_MF_SND_DT) AS GMT_DT
,       ''  CORR_NO

FROM  ( 
SELECT CS.CSTMS_PORT_CD AS PORT
      ,(SELECT M.LOC_NM
        FROM   MDM_LOCATION M
        WHERE  M.LOC_CD = CS.CSTMS_PORT_CD) PORT_NM
      ,DECODE(IF_DT,NULL,'','DownLoad') DOWNLOAD_FLAG
      --,TO_CHAR(IF_DT, 'YYYY-MM-DD HH24:MI') DOWNLOAD_DT
	  ,TO_CHAR(IF_DT, 'YYYY-MM-DD HH24:MI') DOWNLOAD_DT
  	  ,TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC('USNYC',IF_DT, 'GMT'), 'YYYY-MM-DD HH24:MI') GMT_DOWNLOAD_DT
      ,CS.CSTMS_MF_TP_CD CUST_STATUS
      ,(SELECT B.INTG_CD_VAL_DESC
        FROM   COM_INTG_CD_DTL B
        WHERE  INTG_CD_ID = 'CD02235' AND
               B.INTG_CD_VAL_CTNT = CS.CSTMS_MF_TP_CD) CUST_STATUS_NM
      ,TO_CHAR(DECODE(CS.CSTMS_MF_TP_CD,'MI',CS.MF_SND_DT,CS.AMDT_SND_DT),'YYYY-MM-DD HH24:MI') MF_SND_DT
      ,TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC('USNYC',DECODE(CS.CSTMS_MF_TP_CD,'MI',CS.MF_SND_DT,CS.AMDT_SND_DT), 'GMT'), 'YYYY-MM-DD HH24:MI') GMT_MF_SND_DT 
      ,CS.CRE_USR_ID AS DOWN_USR_ID
      ,U.CRE_USR_ID AS SEND_USER_ID
      ,(SELECT OFC.OFC_CD FROM COM_USER OFC WHERE OFC.USR_ID = CS.CRE_USR_ID) AS DOWN_OFC_NM
      ,(SELECT OFC.OFC_CD FROM COM_USER OFC WHERE OFC.USR_ID = U.CRE_USR_ID) AS SEND_OFC_NM
FROM   BKG_CSTMS_ADV_BL CS,
	   ( SELECT DISTINCT L.CNT_CD,
						 L.SND_DT AS SND_DATE,
						 L.TRSM_MSG_TP_ID,
						 L.SND_USR_ID CRE_USR_ID,
						 L.SND_USR_OFC_CD OFC_CD,
						 E.BL_NO
		 FROM BKG_CSTMS_ADV_SND_LOG L,
			  BKG_CSTMS_ADV_EDI_BL_RSPN E
		 WHERE 1=1
		   AND L.CNT_CD = E.CNT_CD(+)
		   AND L.CRR_BAT_NO = E.CRR_BAT_NO(+)
		   AND L.IO_BND_CD ='I'
		   AND E.BL_NO = (SELECT BL_NO FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no] )
		   AND L.SND_DT IN (SELECT MAX(SND_DT)
							FROM BKG_CSTMS_ADV_SND_LOG L,
								 BKG_CSTMS_ADV_EDI_BL_RSPN E
						    WHERE L.IO_BND_CD = 'I'
							  AND L.CNT_CD = E.CNT_CD(+)
							  AND L.CRR_BAT_NO = E.CRR_BAT_NO(+)
							  AND E.BL_NO = (SELECT BL_NO FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no] )
						    )
		) U
WHERE  CS.BL_NO = (SELECT BL_NO FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no] )
  AND  CS.BL_NO = U.BL_NO
) T
,(SELECT ROWNUM BY_SEQ
        FROM   DUAL
        CONNECT BY LEVEL <= 2) XDT

UNION ALL
SELECT  999999  AS HIS_SEQ,
     1  as HIS_DTL_SEQ,
        
        'WEB B/L' ITEM_HDR,
        'INTERNET AUTH' HIS_CATE_NM,
        '' PRE_CTNT, 
        '' PRE_CTNT_ORG, 
        'AUTHORIZED' CRNT_CTNT,
        'AUTHORIZED' CRNT_CTNT_ORG,
        AUTH_USR_ID CRE_USR_ID,
        AUTH_OFC_CD OFFICE,
        TO_CHAR(AUTH_DT,'YYYY-MM-DD HH24:MI') CRE_DT, 
        NULL GMT_DT,
        '' CORR_NO
FROM BKG_INET_BL_PRN_AUTH
WHERE BKG_NO = @[bkg_no]
AND AUTH_USR_ID IS NOT NULL
AND AUTH_OFC_CD IS NOT NULL
AND AUTH_DT IS NOT NULL
AND PRN_CUST_TP_CD <> 'O'
UNION ALL
SELECT  DISTINCT 999999 AS HIS_SEQ,
     1  as HIS_DTL_SEQ,
        'WEB B/L' ITEM_HDR,
        'CANCEL AUTH' HIS_CATE_NM,
        '' PRE_CTNT, 
        '' PRE_CTNT_ORG, 
        'CANCELED' CRNT_CTNT,
        'CANCELED' CRNT_CTNT_ORG,
        DELT_USR_ID CRE_USR_ID,
        DELT_OFC_CD OFFICE,
        TO_CHAR(DELT_DT,'YYYY-MM-DD HH24:MI') CRE_DT, 
        NULL GMT_DT,
        '' CORR_NO
FROM BKG_INET_BL_PRN_AUTH
WHERE BKG_NO = @[bkg_no]
AND DELT_FLG = 'Y'
AND PRN_CUST_TP_CD <> 'O'
UNION ALL
SELECT  999999  AS HIS_SEQ,
     1  as HIS_DTL_SEQ,
        'WEB B/L' ITEM_HDR,
        'WEB B/L PRINT' HIS_CATE_NM,
        '' PRE_CTNT, 
        '' PRE_CTNT_ORG, 
        'Print-1ST' CRNT_CTNT,
        'Print-1ST' CRNT_CTNT_ORG,
        PRN_USR_ID CRE_USR_ID,
        '' OFFICE,
        TO_CHAR(N1ST_PRN_DT,'YYYY-MM-DD HH24:MI') CRE_DT, 
        NULL GMT_DT,
        '' CORR_NO
FROM BKG_INET_BL_PRN_AUTH
WHERE BKG_NO = @[bkg_no]
AND N1ST_PRN_DT IS NOT NULL
AND PRN_CUST_TP_CD <> 'O'
UNION ALL
SELECT  999999  AS HIS_SEQ,
     1  as HIS_DTL_SEQ,
        'WEB B/L' ITEM_HDR,
        'WEB B/L PRINT' HIS_CATE_NM,
        '' PRE_CTNT, 
        '' PRE_CTNT_ORG, 
        'Print-2nd' CRNT_CTNT,
        'Print-2nd' CRNT_CTNT_ORG,
        PRN_USR_ID CRE_USR_ID,
        '' OFFICE,
        TO_CHAR(N2ND_PRN_DT,'YYYY-MM-DD HH24:MI') CRE_DT, 
        NULL GMT_DT,
        '' CORR_NO
FROM BKG_INET_BL_PRN_AUTH
WHERE BKG_NO =@[bkg_no]
AND N2ND_PRN_DT IS NOT NULL
AND PRN_CUST_TP_CD <> 'O'
UNION ALL
SELECT  999999  AS HIS_SEQ,
     1  as HIS_DTL_SEQ,
        'WEB B/L' ITEM_HDR,
        'SWB B/L PRINT' HIS_CATE_NM,
        '' PRE_CTNT, 
        '' PRE_CTNT_ORG, 
        'SWB PRINTED' CRNT_CTNT,
        'SWB PRINTED' CRNT_CTNT_ORG,
        PRN_USR_ID CRE_USR_ID,
        '' OFFICE,
        TO_CHAR(WBL_PRN_DT,'YYYY-MM-DD HH24:MI') CRE_DT, 
        NULL GMT_DT,
        '' CORR_NO
FROM BKG_INET_BL_PRN_AUTH
WHERE BKG_NO =@[bkg_no]
AND PRN_CUST_TP_CD ='W'
AND WBL_PRN_DT IS NOT NULL 
ORDER BY HIS_SEQ, HIS_DTL_SEQ, CRE_DT -- web내역 순서 조정을 위한 추가

--ORDER BY   T.PORT,XDT.BY_SEQ			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="AARY3310011" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
