<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="PlanningInquiryDBDAOSearchPlanningQtaIasSectorRSQL">
			<desc><![CDATA[Planning QTA Inquiry for IAS Sector를 조회한다. Yearly, Quarterly 공통]]></desc>
			<sql><![CDATA[
SELECT A1.BSE_TP_CD
      ,A1.BSE_YR
      ,A1.BSE_QTR_CD
      ,(SELECT INTG_CD_VAL_DP_DESC AS NAME
        FROM COM_INTG_CD_DTL
        WHERE INTG_CD_ID  = 'CD00940'
        AND INTG_CD_VAL_CTNT = A1.OFC_VW_CD) OFC_VW_CD
      ,A1.TRD_CD
      ,A1.SUB_TRD_CD
      ,A1.RLANE_CD
      ,A1.DIR_CD
      ,SUM(A1.LOD_QTY) AS LOD_QTY
      ,DECODE(SUM(A1.LOD_QTY),0,0, SUM(A1.LOD_QTY * A1.GRS_RPB_REV)/SUM(A1.LOD_QTY)) AS REV_RPB
      ,SUM(A1.LOD_QTY * A1.GRS_RPB_REV) AS GRS_REV
      ,SUM(A1.PA_CM_UC_AMT * A1.LOD_QTY) PA_CM_COST
      ,SUM(A1.RA_CM_UC_AMT * A1.LOD_QTY) RA_CM_COST
      ,DECODE(SUM(A1.LOD_QTY),0,0, (SUM(A1.PA_CM_UC_AMT * A1.LOD_QTY) / SUM(A1.LOD_QTY))) AS PA_CMCB
      ,DECODE(SUM(A1.LOD_QTY),0,0, (SUM(A1.RA_CM_UC_AMT * A1.LOD_QTY) / SUM(A1.LOD_QTY))) AS RA_CMCB
      ,SUM(A1.LOD_QTY * A1.GRS_RPB_REV) - SUM(A1.PA_CM_UC_AMT * A1.LOD_QTY) AS PA_CM
      ,SUM(A1.LOD_QTY * A1.GRS_RPB_REV) - SUM(A1.RA_CM_UC_AMT * A1.LOD_QTY) AS RA_CM
      ,DECODE(SUM(A1.LOD_QTY),0,0, (SUM(A1.LOD_QTY * A1.GRS_RPB_REV) - SUM(A1.PA_CM_UC_AMT*A1.LOD_QTY))/SUM(A1.LOD_QTY)) AS PA_CMPB
      ,DECODE(SUM(A1.LOD_QTY),0,0, (SUM(A1.LOD_QTY * A1.GRS_RPB_REV) - SUM(A1.RA_CM_UC_AMT*A1.LOD_QTY))/SUM(A1.LOD_QTY)) AS RA_CMPB  
--      ,A1.VSL_CD
--      ,A1.SKD_VOY_NO
--      ,A1.SKD_DIR_CD
#if (${f_ofc_lvl} == '02')   
      ,A1.RHQ_CD
#elseif (${f_ofc_lvl} == '03') 
      ,A1.RHQ_CD
      ,A1.RGN_OFC_CD
#end
#if (${f_chk_pair} == 'Y')
      ,A1.POL_CD
      ,A1.POD_CD
      ,DECODE(NVL(A2.CSQ_MN_SCTR_FLG, 'N'), 'Y', 'Main', 'N', 'Sector') CSQ_MN_SCTR_FLG
#end
      ,A3.VVD_CNT
      ,A3.TOT_BSA_CAPA
      ,A3.BSE_MON
FROM CSQ_SCTR_CFM_QTA A1
#if (${f_chk_pair} == 'Y')
     ,CSQ_SCTR_PAIR_MGMT A2
#end
     ,(SELECT BSE_TP_CD
              ,BSE_YR
              ,BSE_QTR_CD
              ,TRD_CD
              ,RLANE_CD
              ,DIR_CD
              ,VSL_CD
              ,SKD_VOY_NO
              ,SKD_DIR_CD
              ,COUNT(BSE_MON) OVER(PARTITION BY BSE_YR,TRD_CD,RLANE_CD,DIR_CD,BSE_MON) AS VVD_CNT
              ,SUM(FNL_BSA_CAPA) OVER(PARTITION BY BSE_YR,TRD_CD,RLANE_CD,DIR_CD,BSE_MON) AS TOT_BSA_CAPA
              ,BSE_MON
              ,SUB_TRD_CD
              ,FNL_BSA_CAPA
        FROM CSQ_QTA_TGT_VVD 
        WHERE 1=1
        AND BSE_TP_CD = @[f_bse_tp_cd]
        AND BSE_YR = @[f_bse_yr]
        AND BSE_QTR_CD = DECODE(@[f_bse_tp_cd], 'Y', '00', @[f_bse_qtr_cd])
        AND TRD_CD       = @[f_trd_cd]
        AND DELT_FLG     = 'N'
--        AND PF_SVC_TP_CD IS NOT NULL
#if (${f_sub_trd_cd} != '' && ${f_sub_trd_cd} != 'All')
        AND SUB_TRD_CD = @[f_sub_trd_cd]
#end
#if (${f_rlane_cd} != '' && ${f_rlane_cd} != 'All')
        AND RLANE_CD   = @[f_rlane_cd]
#end
#if (${f_fm_mon} != '' && ${f_to_mon} != '')
        AND BSE_MON BETWEEN ${f_fm_mon} AND ${f_to_mon}
#end
#if (${f_dir_cd} != '' && ${f_dir_cd} != 'All')
        AND DIR_CD     = @[f_dir_cd]
#end
        ) A3
               
WHERE 1=1
AND A1.QTA_RLSE_VER_NO = DECODE(@[f_bse_tp_cd], 'Y', SUBSTR(@[f_bse_yr], 3)||'0001', SUBSTR(@[f_bse_yr], 3)||@[f_bse_qtr_cd]||'01')
AND A1.BSE_TP_CD = @[f_bse_tp_cd]
AND A1.BSE_YR = @[f_bse_yr]
AND A1.BSE_QTR_CD = DECODE(@[f_bse_tp_cd], 'Y', '00', @[f_bse_qtr_cd])
AND A1.OFC_VW_CD = @[f_ofc_vw_cd]
#if (${f_rlane_cd} != '' && ${f_rlane_cd} != 'All')
AND A1.RLANE_CD = @[f_rlane_cd]
#end
#if (${f_dir_cd} != '' && ${f_dir_cd} != 'All')
AND A1.DIR_CD   = @[f_dir_cd]
#end
#if (${f_ofc_lvl} != '01' && ${f_rhq_cd} != '' && ${f_rhq_cd} != 'All')
   AND A1.RHQ_CD          = @[f_rhq_cd]
#end
#if (${f_ofc_lvl} == '03' && ${f_rgn_ofc_cd} != '' && ${f_rgn_ofc_cd} != 'All')
   AND A1.RGN_OFC_CD      = @[f_rgn_ofc_cd]
#end
#if (${f_pol_cd} != '' && ${f_pol_cd} != 'All')
AND A1.POL_CD = @[f_pol_cd]
#end
#if (${f_pod_cd} != '' && ${f_pod_cd} != 'All')
AND A1.POD_CD = @[f_pod_cd]
#end
#if (${f_chk_pair} == 'Y')
#if (${f_csq_mn_sctr_flg} != '' && ${f_csq_mn_sctr_flg} != 'All')
AND NVL(A2.CSQ_MN_SCTR_FLG, 'N') = @[f_csq_mn_sctr_flg]
#end
AND A1.BSE_TP_CD  = A2.BSE_TP_CD
AND A1.BSE_YR     = A2.BSE_YR
AND A1.BSE_QTR_CD = A2.BSE_QTR_CD
AND A1.RLANE_CD   = A2.RLANE_CD
AND A1.DIR_CD     = A2.DIR_CD
AND A1.PF_GRP_CD  = A2.PF_GRP_CD
AND A1.POL_CD     = A2.POL_CD
AND A1.POD_CD     = A2.POD_CD
#end

AND A1.BSE_TP_CD  = A3.BSE_TP_CD
AND A1.BSE_YR     = A3.BSE_YR
AND A1.BSE_QTR_CD = A3.BSE_QTR_CD
AND A1.SUB_TRD_CD = A3.SUB_TRD_CD
AND A1.RLANE_CD   = A3.RLANE_CD
AND A1.DIR_CD     = A3.DIR_CD
AND A1.VSL_CD     = A3.VSL_CD
AND A1.SKD_VOY_NO = A3.SKD_VOY_NO
AND A1.SKD_DIR_CD = A3.SKD_DIR_CD

GROUP BY A1.BSE_TP_CD
      ,A1.BSE_YR
      ,A1.BSE_QTR_CD
      ,A1.OFC_VW_CD
      ,A1.RLANE_CD
      ,A1.DIR_CD
      ,A3.BSE_MON
      ,A3.VVD_CNT
      ,A3.TOT_BSA_CAPA
      ,A1.TRD_CD
      ,A1.SUB_TRD_CD
#if (${f_ofc_lvl} == '02')   
      ,A1.RHQ_CD
#elseif (${f_ofc_lvl} == '03') 
      ,A1.RHQ_CD
      ,A1.RGN_OFC_CD
#end
#if (${f_chk_pair} == 'Y')
      ,A1.POL_CD
      ,A1.POD_CD
      ,A1.POL_CALL_SEQ
      ,A1.POD_CALL_SEQ
      ,CSQ_MN_SCTR_FLG
#end
--      ,A1.VSL_CD
--      ,A1.SKD_VOY_NO
--      ,A1.SKD_DIR_CD
ORDER BY SUB_TRD_CD
       , RLANE_CD
       , DIR_CD
       , BSE_MON
#if (${f_ofc_lvl} == '02')  
	   , RHQ_CD
#elseif (${f_ofc_lvl} == '03') 
       , RHQ_CD, RGN_OFC_CD
#end			]]></sql>
			<params>
				<param name="f_bse_tp_cd" type="12" value="" out="N"/>
				<param name="f_bse_yr" type="12" value="" out="N"/>
				<param name="f_bse_qtr_cd" type="12" value="" out="N"/>
				<param name="f_trd_cd" type="12" value="" out="N"/>
				<param name="f_sub_trd_cd" type="12" value="" out="N"/>
				<param name="f_rlane_cd" type="12" value="" out="N"/>
				<param name="f_dir_cd" type="12" value="" out="N"/>
				<param name="f_ofc_vw_cd" type="12" value="" out="N"/>
				<param name="f_rhq_cd" type="12" value="" out="N"/>
				<param name="f_rgn_ofc_cd" type="12" value="" out="N"/>
				<param name="f_pol_cd" type="12" value="" out="N"/>
				<param name="f_pod_cd" type="12" value="" out="N"/>
				<param name="f_csq_mn_sctr_flg" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
