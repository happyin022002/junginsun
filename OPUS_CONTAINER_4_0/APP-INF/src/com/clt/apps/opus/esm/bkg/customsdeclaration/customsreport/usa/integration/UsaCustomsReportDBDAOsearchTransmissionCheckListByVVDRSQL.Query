<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="UsaCustomsReportDBDAOsearchTransmissionCheckListByVVDRSQL">
			<desc><![CDATA[dwkim, 0359 Manifest Status 조회용]]></desc>
			<sql><![CDATA[
SELECT DENSE_RANK() OVER(ORDER BY MBL_NO, AMS_FILE_NO) SEQ
      ,GUBUN
      ,AMS_FILE_NO
      ,M_F
      ,FILER
      ,MBL_NO
      ,O_POL -- BKG POL
      ,T_POL -- VVD POL
      ,T_POD -- VVD POD
      ,T_VVD -- BKG_VVD
      ,STS
      ,(SELECT NVL(MAX('Y'), 'N')
          FROM BKG_CSTMS_ADV_SND_LOG E
         WHERE E.CNT_CD = 'US'
           AND E.IO_BND_CD = 'I'
           AND E.TRSM_MSG_TP_ID = 'MI'
           AND E.VSL_CD     = A.VSL_CD
           AND E.SKD_VOY_NO = A.SKD_VOY_NO
           AND E.SKD_DIR_CD = A.SKD_DIR_CD
           AND E.POL_CD     = A.POL_CD
           AND E.POD_CD     = A.POD_CD
       ) AS V_MI
      ,MI
      ,VVD -- US VVD
      ,SENT_TIME
      ,CURR_STAGE
      ,UPDATE_DT
      ,B_OFC
      ,CNTR_NO
      ,MF_STS
      ,USER_ACTION
      ,T_VVD2
      ,T_POL2
      ,FILER2
      ,' ' TMP1
      ,' ' TMP2
      ,' ' TMP3
  FROM (SELECT '00' GUBUN
              ,B.BL_NO AMS_FILE_NO
              ,'M' M_F
              ,B.USA_CSTMS_FILE_CD FILER
              ,B.BL_NO MBL_NO
              ,B.POL_CD O_POL
              ,A.POL_CD T_POL
              ,A.POD_CD T_POD
              ,A.VSL_CD || A.SKD_VOY_NO || A.SKD_DIR_CD T_VVD
              ,B.BKG_STS_CD STS
              ,DECODE(F.MF_SND_DT, NULL, 'N', 'Y') MI
              ,F.VSL_CD || F.SKD_VOY_NO || F.SKD_DIR_CD VVD
              ,TO_CHAR(F.MF_SND_DT, 'YYYY-MM-DD HH24:MI') SENT_TIME
              ,F.CSTMS_MF_TP_CD CURR_STAGE
              ,DECODE(F.CSTMS_MF_TP_CD, 'MI', TO_CHAR(F.MF_SND_DT, 'YYYY-MM-DD HH24:MI'), 'AI', TO_CHAR(F.AMDT_SND_DT, 'YYYY-MM-DD HH24:MI')) UPDATE_DT
              ,B.BKG_OFC_CD B_OFC
              ,D.CNTR_NO CNTR_NO
              ,CASE WHEN F.MF_SND_DT IS NOT NULL AND F.AMDT_SND_DT IS NULL THEN
                         'Sent By MI'
                    WHEN F.MF_SND_DT IS NOT NULL AND F.AMDT_SND_DT IS NOT NULL THEN
                         'Sent By MI'
                    WHEN F.MF_SND_DT IS NULL AND F.AMDT_SND_DT IS NOT NULL THEN
                         'Added By AI'
                    WHEN F.MF_SND_DT IS NULL AND F.AMDT_SND_DT IS NULL THEN
                         'Un-Manifested'
                    ELSE 'Error'
                END MF_STS
              ,CASE WHEN F.VSL_CD IS NULL THEN
                         'ADD'
                    ELSE 'None'
                END USER_ACTION
              ,'' T_VVD2, '' T_POL2, '' FILER2
              ,A.VSL_CD
              ,A.SKD_VOY_NO
              ,A.SKD_DIR_CD
              ,A.POL_CD
              ,A.POD_CD
              ,B.BKG_NO
         FROM BKG_VVD A
             ,BKG_BOOKING B
             ,BKG_BL_DOC C
             ,BKG_CONTAINER D
             ,BKG_CSTMS_ADV_BL F
        WHERE A.VSL_CD                = SUBSTR(@[vvd], 1, 4)
          AND A.SKD_VOY_NO            = SUBSTR(@[vvd], 5, 4)
          AND A.SKD_DIR_CD            = SUBSTR(@[vvd], 9, 1)
#if (${pol} != '')
          AND A.POL_CD                = @[pol]
#end
#if (${pod} != '')
          AND A.POD_CD               = @[pod]
#end
          AND B.BKG_NO                = A.BKG_NO
          AND B.BKG_CGO_TP_CD         IN ('R', 'F')
          AND B.BKG_STS_CD            <> 'X'
#if (${bofc} != '')
          AND B.BKG_OFC_CD            = @[bofc]
#end
          AND C.BKG_NO                = B.BKG_NO
          AND D.BKG_NO(+)             = C.BKG_NO
          AND F.CNT_CD(+)             = 'US'
          AND F.BL_NO(+)              = B.BL_NO
    UNION ALL
        SELECT TO_CHAR(G.HBL_SEQ)
              ,G.CNTR_MF_NO AMS_FILE_NO
              ,'H'
              ,'0' FILER
              ,B.BL_NO MBL_NO
              ,B.POL_CD O_POL
              ,A.POL_CD T_POL
              ,A.POD_CD T_POD
              ,A.VSL_CD || A.SKD_VOY_NO || A.SKD_DIR_CD T_VVD
              ,B.BKG_STS_CD STS
              ,DECODE(F.MF_SND_DT, NULL, 'N', 'Y') MI
              ,F.VSL_CD || F.SKD_VOY_NO || F.SKD_DIR_CD VVD
              ,TO_CHAR(F.MF_SND_DT, 'YYYY-MM-DD HH24:MI') SENT_TIME
              ,F.CSTMS_MF_TP_CD CURR_STAGE
              ,DECODE(F.CSTMS_MF_TP_CD, 'MI', TO_CHAR(F.MF_SND_DT, 'YYYY-MM-DD HH24:MI'), 'AI', TO_CHAR(F.AMDT_SND_DT, 'YYYY-MM-DD HH24:MI')) UPDATE_DT
              ,B.BKG_OFC_CD B_OFC
              ,D.CNTR_NO CNTR_NO
              ,CASE WHEN F.MF_SND_DT IS NOT NULL AND F.AMDT_SND_DT IS NULL THEN
                         'Sent By MI'
                    WHEN F.MF_SND_DT IS NOT NULL AND F.AMDT_SND_DT IS NOT NULL THEN
                         'Sent By MI'
                    WHEN F.MF_SND_DT IS NULL AND F.AMDT_SND_DT IS NOT NULL THEN
                         'Added By AI'
                    WHEN F.MF_SND_DT IS NULL AND F.AMDT_SND_DT IS NULL THEN
                         'Un-Manifested'
                    ELSE 'Error'
                END MF_STS
              ,CASE WHEN F.VSL_CD IS NULL THEN
                         'ADD'
                    ELSE 'None'
                END USER_ACTION
              ,'' t_vvd2, '' t_pol2, '' filer2
              ,A.VSL_CD
              ,A.SKD_VOY_NO
              ,A.SKD_DIR_CD
              ,A.POL_CD
              ,A.POD_CD
              ,B.BKG_NO
          FROM BKG_VVD A
              ,BKG_BOOKING B
              ,BKG_BL_DOC C
              ,BKG_HBL G
              ,BKG_CNTR_MF_DESC D
              ,BKG_CSTMS_ADV_BL F
         WHERE A.VSL_CD                = SUBSTR(@[vvd], 1, 4)
           AND A.SKD_VOY_NO            = SUBSTR(@[vvd], 5, 4)
           AND A.SKD_DIR_CD            = SUBSTR(@[vvd], 9, 1)
#if (${pol} != '')
           AND A.POL_CD                = @[pol]
#end
#if (${pod} != '')
           AND A.POD_CD                = @[pod]
#end
           AND B.BKG_NO                = A.BKG_NO
           AND B.BKG_CGO_TP_CD            IN ('R', 'F')
           AND B.BKG_STS_CD            <> 'X'
#if (${bofc} != '')
           AND B.BKG_OFC_CD            = @[bofc]
#end
           AND C.BKG_NO                = B.BKG_NO
           --as-IS에서는 아래 조건이 사용되나, TO-BE에서 다운로드 화면과 조회수량이 차이가 나므로 아래 조건을 블록한다.
           -- 20100531 블록을 다시 활성화
           AND B.USA_CSTMS_FILE_CD     = '1'
           AND G.BKG_NO                = C.BKG_NO
           AND F.CNT_CD(+)                = 'US'
           AND F.BL_NO(+)                = G.CNTR_MF_NO
           AND F.BKG_NO(+)                = G.BKG_NO
           AND D.BKG_NO(+)                = G.BKG_NO
           AND D.CNTR_MF_NO(+)            = G.CNTR_MF_NO
      ) A
     ,(SELECT A.CNT_CD
              ,A.SND_DATE
              ,A.VSL_CD
              ,A.SKD_VOY_NO
              ,A.SKD_DIR_CD
              ,A.POL_CD
              ,A.POD_CD
              ,A.CSTMS_PORT_CD
              ,A.BL_NO
              ,B.MF_SND_DT
              ,B.AMDT_SND_DT
              ,B.CSTMS_MF_TP_CD
         FROM (SELECT DISTINCT
                       L.CNT_CD
                      ,L.IO_BND_CD
                      ,L.SND_DT AS SND_DATE
                      ,L.TRSM_MSG_TP_ID
                      ,L.VSL_CD || L.SKD_VOY_NO || L.SKD_DIR_CD AS VVD
                      ,L.VSL_CD
                      ,L.SKD_VOY_NO
                      ,L.SKD_DIR_CD
                      ,NVL(E.POL_CD, L.POL_CD) AS POL_CD
                      ,NVL(E.POD_CD, L.POD_CD) AS POD_CD
                      ,L.CSTMS_PORT_CD
                      ,CASE WHEN TRSM_MSG_TP_ID = 'MI' THEN ''
                            ELSE E.BL_NO
                       END BL_NO
                 FROM BKG_CSTMS_ADV_SND_LOG     L
                     ,BKG_CSTMS_ADV_EDI_BL_RSPN E
                WHERE 1=1
                  AND L.CNT_CD = E.CNT_CD(+)
                  AND L.CRR_BAT_NO = E.CRR_BAT_NO(+)
                  AND L.CNT_CD = 'US'
                  AND L.IO_BND_CD = 'I'
                  AND L.VSL_CD     = SUBSTR(@[vvd], 1, 4)
                  AND L.SKD_VOY_NO = SUBSTR(@[vvd], 5, 4)
                  AND L.SKD_DIR_CD = SUBSTR(@[vvd], 9, 1)
            ) A
            ,BKG_CSTMS_ADV_BL B
            WHERE 1=1
            AND A.CNT_CD    = B.CNT_CD(+)
            AND A.BL_NO     = B.BL_NO(+)
            AND A.VSL_CD        = B.VSL_CD(+)
            AND A.SKD_VOY_NO    = B.SKD_VOY_NO(+)
            AND A.SKD_DIR_CD    = B.SKD_DIR_CD(+)
            AND A.POL_CD = B.CSTMS_POL_CD(+)
            AND A.POD_CD = B.CSTMS_POD_CD(+)  
       ) HIS
      ,VSK_VSL_PORT_SKD SKD
 WHERE 1 = 1
   AND A.VSL_CD = SKD.VSL_CD
   AND A.SKD_VOY_NO = SKD.SKD_VOY_NO
   AND A.SKD_DIR_CD = SKD.SKD_DIR_CD
   AND A.T_POD      = SKD.VPS_PORT_CD
   AND SKD.CLPT_IND_SEQ = 1
   AND SKD.CLPT_SEQ >= @[min_seq]
#if (${allerror} != 'ALL')
   AND VVD != T_VVD
#end
#if (${blmi} == 'Manifested')
   AND (mf_sts = 'Sent By MI' OR mf_sts = 'Added By AI')
#elseif (${blmi} != '')
   AND mf_sts = @[blmi]
#end
   AND NOT EXISTS (SELECT 'Y'
                    FROM BKG_BOOKING
                    WHERE FM_BKG_NO = A.BKG_NO
                    AND BL_NO_TP = '9'
                  )
   AND A.VSL_CD     = HIS.VSL_CD(+)
   AND A.SKD_VOY_NO = HIS.SKD_VOY_NO(+)
   AND A.SKD_DIR_CD = HIS.SKD_DIR_CD(+)
   AND A.MBL_NO     = HIS.BL_NO(+)
ORDER BY MBL_NO, GUBUN			]]></sql>
			<params>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="pol" type="12" value="" out="N"/>
				<param name="pod" type="12" value="" out="N"/>
				<param name="bofc" type="12" value="" out="N"/>
				<param name="min_seq" type="12" value="" out="N"/>
				<param name="blmi" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
