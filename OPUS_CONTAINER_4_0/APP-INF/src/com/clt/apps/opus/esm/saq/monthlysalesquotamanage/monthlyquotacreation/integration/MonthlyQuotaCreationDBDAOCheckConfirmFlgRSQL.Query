<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="MonthlyQuotaCreationDBDAOCheckConfirmFlgRSQL">
			<desc><![CDATA[Base Data Confirm 전에 Office, Lane 이 잘못된 경우가 있을 경우 먼저 처리하도록 체크 한다]]></desc>
			<sql><![CDATA[
SELECT CASE WHEN MAX(CNT1) > 0 AND MAX(CNT2) > 0 THEN 'OL' 
                 WHEN MAX(CNT1) = 0 AND MAX(CNT2) > 0 THEN 'L' 
                 WHEN MAX(CNT1) > 0 AND MAX(CNT2) = 0 THEN 'O' ELSE 'Y' END AS CNF_YN 
  FROM 
       (SELECT COUNT(MQTA_MDL_VER_NO) AS CNT1 
            , 0 AS CNT2 
            , 0 AS GRP 
         FROM 
              (SELECT T1.MQTA_MDL_VER_NO 
                   , T1.CTRT_RHQ_CD 
                   , T1.CTRT_OFC_CD 
                   , T1.SLS_RHQ_CD 
                   , T1.SLS_OFC_CD 
                   , 'Y' AS CTRT_FLG 
                   , '' AS SLS_FLG 
                FROM SAQ_MON_FCAST_TRNS T1 
                   , SAQ_ORGANIZATION_V T2 
               WHERE 1=1 
                     AND T1.MQTA_MDL_VER_NO = @[mqta_mdl_ver_no]  
                     AND T1.CTRT_OFC_CD = T2.OFC_CD (+) 
                     AND 'N' = T2.DELT_FLG (+) 
                     AND T2.OFC_CD IS NULL 
                     AND 
                     ( 
                         T1.FCAST_TRNS_STS_CD = '0' 
                         OR T1.FCAST_TRNS_STS_CD IS NULL 
                     ) 
                  UNION ALL 
              SELECT T1.MQTA_MDL_VER_NO 
                   , T1.CTRT_RHQ_CD 
                   , T1.CTRT_OFC_CD 
                   , T1.SLS_RHQ_CD 
                   , T1.SLS_OFC_CD 
                   , '' AS CTRT_FLG 
                   , 'Y' AS SLS_FLG 
                FROM SAQ_MON_FCAST_TRNS T1 
                   , SAQ_ORGANIZATION_V T2 
               WHERE 1=1 
                     AND T1.MQTA_MDL_VER_NO = @[mqta_mdl_ver_no]  
                     AND T1.SLS_OFC_CD = T2.OFC_CD (+) 
                     AND 'N' = T2.DELT_FLG (+) 
                     AND T2.OFC_CD IS NULL 
                     AND 
                     ( 
                         T1.FCAST_TRNS_STS_CD = '0' 
                         OR T1.FCAST_TRNS_STS_CD IS NULL 
                     ) 
              ) 
           UNION ALL 
       SELECT 0 AS CNT1 
            , COUNT(MQTA_MDL_VER_NO) AS CNT2 
            , 0 AS GRP 
         FROM 
              (SELECT NVL(T1.MQTA_MDL_VER_NO, SUBSTR(T2.BSE_YR, 3,2)||BSE_QTR_CD||'01') AS MQTA_MDL_VER_NO 
                   , NVL(T1.TRD_CD, T2.TRD_CD) AS TRD_CD 
                   , NVL(T1.SUB_TRD_CD, T2.SUB_TRD_CD) AS SUB_TRD_CD 
                   , NVL(T1.RLANE_CD, T2.RLANE_CD) AS ORG_RLANE_CD 
                   , NVL(T1.RLANE_CD, T2.RLANE_CD) AS RLANE_CD 
                   , DECODE(T1.RLANE_CD, NULL, 'BLUE', DECODE(T2.RLANE_CD, NULL, 'RED', 'ALL')) AS ROW_CLR 
                FROM 
                     (SELECT MQTA_MDL_VER_NO 
                          , TRD_CD 
                          , SUB_TRD_CD 
                          , IOC_CD 
                          , RLANE_CD 
                          , RLANE_CD AS ORG_RLANE_CD 
                       FROM SAQ_MON_FCAST_TRNS 
                      WHERE 1=1 
                            AND MQTA_MDL_VER_NO = @[mqta_mdl_ver_no]  
                            AND 
                            ( 
                                FCAST_TRNS_STS_CD = '0' 
                                OR FCAST_TRNS_STS_CD IS NULL 
                            ) 
                      GROUP BY MQTA_MDL_VER_NO 
                          , TRD_CD 
                          , SUB_TRD_CD 
                          , IOC_CD 
                          , RLANE_CD 
                     ) T1 
                 FULL OUTER JOIN 
                     (SELECT BSE_YR 
                          , BSE_QTR_CD 
                          , TRD_CD 
                          , SUB_TRD_CD 
                          , RLANE_CD 
                       FROM SAQ_MON_TGT_VVD 
                      WHERE 1=1 
                            AND DELT_FLG = 'N' 
                            AND TGT_VVD_STS_CD = 'N'
                            AND BSE_YR = @[year] 
                            AND BSE_QTR_CD = @[bse_qtr_cd]               
                      GROUP BY BSE_YR 
                          , BSE_QTR_CD 
                          , TRD_CD 
                          , SUB_TRD_CD 
                          , RLANE_CD 
                     ) T2 
                     ON ( 
                         T1.MQTA_MDL_VER_NO = SUBSTR(T2.BSE_YR, 3,2)||BSE_QTR_CD||'01' 
                         AND T1.TRD_CD = T2.TRD_CD 
                         AND T1.SUB_TRD_CD = T2.SUB_TRD_CD 
                         AND T1.RLANE_CD = T2.RLANE_CD 
                     ) 
              ) 
        WHERE 1=1 
              AND ROW_CLR IN ('RED', 'BLUE') 
       ) 
 GROUP BY GRP			]]></sql>
			<params>
				<param name="mqta_mdl_ver_no" type="12" value="" out="N"/>
				<param name="year" type="12" value="" out="N"/>
				<param name="bse_qtr_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
