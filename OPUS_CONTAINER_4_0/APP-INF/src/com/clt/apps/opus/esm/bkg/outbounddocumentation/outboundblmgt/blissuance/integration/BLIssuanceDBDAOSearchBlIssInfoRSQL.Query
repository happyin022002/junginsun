<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BLIssuanceDBDAOSearchBlIssInfoRSQL">
			<desc><![CDATA[B/L Issue 정보 조회]]></desc>
			<sql><![CDATA[
SELECT 
  M.BKG_NO ,
  BL_NO||DECODE(M.BL_ISS_TP_CD,'W','W',DECODE(SURRENDER, 'Y', 'S', '')) AS BL_NO,
  TVVD ,
  BKG_STS ,
  BDR ,
  SHPR_NAME ,
  SHPR_ADDRESS ,
  F_FWD_NAME ,
  F_FWD_ADDRESS ,
  VESSEL_DIRECTION ,
  PRE_CARRIAGE_BY ,
  NVL(POR_CODE, NPOR_CODE) AS POR_CODE ,
  NVL(UPPER(POR_NAME), UPPER(NPOR_NAME)) AS POR_NAME ,
  NVL(POL_CODE, NPOL_CODE) AS POL_CODE ,
  NVL(UPPER(POL_NAME), UPPER(NPOL_NAME)) AS POL_NAME ,
  NVL(POD_CODE, NPOD_CODE) AS POD_CODE ,
  NVL(UPPER(POD_NAME), UPPER(NPOD_NAME)) AS POD_NAME ,
  NVL(DEL_CODE, NDEL_CODE) AS DEL_CODE ,
  NVL(UPPER(DEL_NAME), UPPER(NDEL_NAME)) AS DEL_NAME ,
  MOVE_TYPE ,
  FINAL_DEST ,
  PPD_CONFIRM ,
  TRD_PPD_CONFIRM ,
  CCT_CONFIRM ,
  TRD_CCT_CONFIRM ,
  BL_READY_CHECKBOX ,
  BL_READY_BY ,
  TO_CHAR(BL_READY_DATE, 'YYYY-MM-DD') BL_READY_DATE ,
  BL_READY_OFFICE ,
  BL_READY_TYPE ,  
  ON_BOARD_TYPE ,
  TO_CHAR(ON_BOARD_DATE, 'YYYY-MM-DD') ON_BOARD_DATE ,
  
  BL_PROOFBYSHIPPER_CHECKBOX,
  BL_PROOFBYSHIPPER_OFFICE,
  BL_PROOFBYSHIPPER_BY,
  BL_PROOFBYSHIPPER_DATE,
 (SELECT CNTC_PSON_EML FROM BKG_CNTC_PSON WHERE BKG_NO=@[bkg_no] AND BKG_CNTC_PSON_TP_CD = 'BL') AS CNTC_PSON_EML,

  BL_ISSUEBL_TYPE ,
  BL_ISSUE_NO ,
  BL_CPY_NO ,
  TO_CHAR(BL_ISSUE_DATE, 'YYYY-MM-DD') BL_ISSUE_DATE ,
  BL_ISSUE_RELEASE ,
  BL_ISSUE_AT ,
  BL_ISSUE_BY ,
  ISSUED ,
  RELEASED ,
  CUST_TO_ORD_FLG ,
--  CASE WHEN (
--    select count(bkg_no)
--    from BKG_CHG_RT
--    where bkg_no=M.BKG_NO) > 0
--  OR (
--    select COUNT(bkg_no)
--    from bkg_rate
--    where bkg_no = M.BKG_NO
--      and rt_bl_tp_cd in ('C',
--          'B')) > 0
--  OR (
--    select COUNT(bkg_no)
--    from bkg_booking
--    where bkg_no = M.BKG_NO
--      and chn_agn_cd is not null) > 0 THEN 'Y' ELSE 'N' END ISSUED_ENABLE ,
DECODE(ORG_PPD_RCV_UPD_OFC_CD,null,   
	(
    SELECT PPD_RCV_OFC_CD
    FROM BKG_RATE
    WHERE BKG_NO= @[bkg_no]),ORG_PPD_RCV_UPD_OFC_CD ) PPD_RCV_USER_OFFICE ,
  PPD_RCV_USER_ID ,
  PPD_RCV_DT ,
DECODE(ORG_N3PTY_PPD_UPD_OFC_CD,null, 
	(
    SELECT N3PTY_RCV_OFC_CD
    FROM BKG_CHG_RT
    WHERE BKG_NO= @[bkg_no]
      AND FRT_TERM_CD = 'P'
      AND ROWNUM =1),ORG_N3PTY_PPD_UPD_OFC_CD) TRD_PPD_RCV_USER_OFFICE ,
  TRD_PPD_RCV_USER_ID ,
  TRD_PPD_RCV_DT ,
DECODE(DEST_CLT_RCV_UPD_OFC_CD,null, 
	(
    SELECT CLT_OFC_CD
    FROM BKG_RATE
    WHERE BKG_NO= @[bkg_no]),DEST_CLT_RCV_UPD_OFC_CD) CCT_RCV_USER_OFFICE ,
  CCT_RCV_USER_ID ,
  CCT_RCV_DT ,
DECODE(DEST_N3PTY_CLT_UPD_OFC_CD,null, 
	(
    SELECT N3PTY_RCV_OFC_CD
    FROM BKG_CHG_RT
    WHERE BKG_NO= @[bkg_no]
      AND FRT_TERM_CD = 'C'
      AND ROWNUM =1),DEST_N3PTY_CLT_UPD_OFC_CD) TRD_CCT_RCV_USER_OFFICE ,
  TRD_CCT_RCV_USER_ID ,
  TRD_CCT_RCV_DT ,
  NVL(O_BLRECEIVE_TYPE, DECODE(NVL(O_BLRECEIVE_AT, '*'), '*', BL_ISSUEBL_TYPE, NVL(BL_ISSUEBL_TYPE, 'B'))) AS O_BLRECEIVE_TYPE ,
  O_BLRECEIVE_NO ,
  TO_CHAR(O_BLRECEIVE_DATE, 'YYYY-MM-DD') O_BLRECEIVE_DATE ,
  O_BLRECEIVE_AT ,
  O_BLRECEIVE_BY ,
  SURRENDER ,
  DO_ISSUE_NO ,
  TO_CHAR(DO_ISSUE_DATE, 'YYYY-MM-DD') DO_ISSUE_DATE ,
  DO_ISSUE_AT ,
  DO_ISSUE_BY ,
  PRINT_OPTION ,
  AUTH_FLAG ,
  INTERNET_AUTH ,  
  DOC_REQUEST_FLAG ,
  OBL_PRN_FLG ,
  TO_CHAR(POL_ETD_DT, 'YYYY-MM-DD') POL_ETD_DT ,
  TO_CHAR(C.CGO_RCV_DT, 'YYYY-MM-DD') CGO_RCV_DT,
  CASE WHEN (
    select count(bkg_no)
    from BKG_CHG_RT
    where bkg_no=M.BKG_NO) > 0
  OR (
    select COUNT(bkg_no)
    from bkg_rate
    where bkg_no = M.BKG_NO
      and rt_bl_tp_cd in ('C', 'B')) > 0
  OR (
    select COUNT(bkg_no)
    from bkg_booking
    where bkg_no = M.BKG_NO
      and chn_agn_cd is not null) > 0 THEN 'Y' ELSE 'N' END flg_rate ,
  CASE WHEN (
    select count(c.bkg_no)
    from bkg_bl_mk_desc C, BKG_BL_DOC B
    where c.bkg_no = M.BKG_NO
      and c.bkg_no = B.BKG_NO
      and (B.PCK_QTY IS NOT NULL AND B.PCK_QTY  <> 0 )
	  and (B.ACT_WGT IS NOT NULL AND B.ACT_WGT  <> 0 ) 
      and B.CSTMS_DESC IS not null) > 0 THEN 'Y' ELSE 'N' END flg_md ,
  PPD_CONFIRM AS flg_ppd ,
  CUST_TO_ORD_FLG AS flg_to_order ,
  CASE WHEN do_issue_no != ' ' THEN 'Y' ELSE 'N' END flg_do,
  OBL_ISS_RMK,
  INET_CTRL_PTY_NM,
  DECODE(INET_CTRL_PTY_NO,0,'', LPAD(INET_CTRL_PTY_NO,6,'0')) INET_CTRL_PTY_NO,
  INET_CTRL_PTY_CUST_NM,
  M.BL_ISS_TP_CD BL_ISS_TP_CD,
  NVL(M.BL_MV_TP_PRN_FLG,'Y') AS BL_MV_TP_PRN_FLG,
  NVL(M.RCV_DE_TERM_PRN_FLG,'Y') AS RCV_DE_TERM_PRN_FLG,
  M.RQST_BL_TP_CD RQST_BL_TP_CD,
  M.ISS_SAVE_FLG
FROM (
    SELECT BL.BKG_NO AS BKG_NO ,
      BL.BDR_FLG AS BDR ,
      BL.VSL_NM AS VESSEL_DIRECTION ,
      BL.PRE_VSL_NM AS PRE_CARRIAGE_BY ,
      BL.POR_CD AS POR_CODE ,
      BL.POR_NM AS POR_NAME ,
      BL.POL_CD AS POL_CODE ,
      BL.POL_NM AS POL_NAME ,
      BL.POD_CD AS POD_CODE ,
      BL.POD_NM AS POD_NAME ,
      BL.DEL_CD AS DEL_CODE ,
      BL.DEL_NM AS DEL_NAME ,
      BL.BL_MV_TP_NM AS MOVE_TYPE ,
      BL.FNL_DEST_NM AS FINAL_DEST ,
      ISS.ORG_PPD_RCV_CD AS PPD_CONFIRM ,
      ISS.ORG_N3PTY_PPD_CD AS TRD_PPD_CONFIRM ,
      ISS.DEST_CLT_RCV_CD AS CCT_CONFIRM ,
      ISS.DEST_N3PTY_CLT_CD AS TRD_CCT_CONFIRM ,
      ISS.BL_RDY_FLG AS BL_READY_CHECKBOX ,
      ISS.BL_RDY_USR_ID AS BL_READY_BY ,
      ISS.BL_RDY_DT AS BL_READY_DATE ,
      ISS.BL_RDY_OFC_CD AS BL_READY_OFFICE ,
      ISS.BL_RDY_TP_CD AS BL_READY_TYPE ,
	  ISS.ORG_PPD_RCV_UPD_OFC_CD,
	  ISS.ORG_N3PTY_PPD_UPD_OFC_CD,
	  ISS.DEST_CLT_RCV_UPD_OFC_CD,
	  ISS.DEST_N3PTY_CLT_UPD_OFC_CD,
      BL.BL_OBRD_TP_CD AS ON_BOARD_TYPE ,
      BL.BL_OBRD_DT AS ON_BOARD_DATE ,
	  ISS.BL_CPY_KNT AS BL_ISSUE_NO ,
      ISS.BL_CPY_NO AS BL_CPY_NO ,
      ISS.OBL_ISS_DT AS BL_ISSUE_DATE ,
      ISS.OBL_RLSE_FLG AS BL_ISSUE_RELEASE ,
      DECODE(ISS.OBL_ISS_OFC_CD, NULL, BKG.BKG_OFC_CD, ISS.OBL_ISS_OFC_CD) AS BL_ISSUE_AT , 
      ISS.OBL_ISS_USR_ID AS BL_ISSUE_BY ,
      ISS.OBL_ISS_FLG AS ISSUED ,
      ISS.OBL_RLSE_FLG AS RELEASED ,
      ISS.ORG_PPD_RCV_UPD_USR_ID AS PPD_RCV_USER_ID ,
      ISS.ORG_PPD_RCV_UPD_DT AS PPD_RCV_DT ,
      ISS.ORG_N3PTY_PPD_UPD_USR_ID AS TRD_PPD_RCV_USER_ID ,
      ISS.ORG_N3PTY_PPD_UPD_DT AS TRD_PPD_RCV_DT ,
      ISS.DEST_CLT_RCV_UPD_USR_ID AS CCT_RCV_USER_ID ,
      ISS.DEST_CLT_RCV_UPD_DT AS CCT_RCV_DT ,
      ISS.DEST_N3PTY_CLT_UPD_USR_ID AS TRD_CCT_RCV_USER_ID ,
      ISS.DEST_N3PTY_CLT_UPD_DT AS TRD_CCT_RCV_DT ,
      CASE WHEN ISS.OTR_DOC_CGOR_FLG = 'Y' THEN 'L' ELSE BKG.BL_TP_CD END O_BLRECEIVE_TYPE ,
      ISS.OBL_RDEM_KNT AS O_BLRECEIVE_NO ,
      CASE WHEN ISS.OTR_DOC_CGOR_FLG = 'Y' THEN ISS.OTR_DOC_RCV_DT ELSE ISS.OBL_RDEM_DT END O_BLRECEIVE_DATE ,
      CASE WHEN ISS.OTR_DOC_CGOR_FLG = 'Y' THEN ISS.OTR_DOC_RCV_OFC_CD ELSE ISS.OBL_RDEM_OFC_CD END O_BLRECEIVE_AT ,
      CASE WHEN ISS.OTR_DOC_CGOR_FLG = 'Y' THEN ISS.OTR_DOC_RCV_USR_ID ELSE ISS.OBL_RDEM_USR_ID END O_BLRECEIVE_BY ,
      ISS.OBL_SRND_FLG AS SURRENDER ,
      ISS.BL_PRF_SHPR_FLG AS BL_PROOFBYSHIPPER_CHECKBOX,
      ISS.BL_PRF_SHPR_OFC_CD AS BL_PROOFBYSHIPPER_OFFICE,
      ISS.BL_PRF_SHPR_USR_ID AS BL_PROOFBYSHIPPER_BY,
	  ISS.OBL_ISS_RMK,
      TO_CHAR(ISS.BL_PRF_SHPR_DT, 'YYYY-MM-DD') BL_PROOFBYSHIPPER_DATE ,
      (
        SELECT DOT_PRN_FLG
        FROM BKG_USR_DFLT_SET
        WHERE USR_ID = @[usr_id] ) AS PRINT_OPTION ,
      CASE WHEN ISS.RQST_BL_TP_CD != NULL THEN 'Y' WHEN ISS.OBL_RT_INCL_KNT != NULL THEN 'Y' WHEN ISS.OBL_RT_XCLD_KNT != NULL THEN 'Y' WHEN ISS.OBL_TTL_KNT != NULL THEN 'Y' WHEN ISS.NON_NEGO_RT_INCL_KNT != NULL THEN 'Y' WHEN ISS.NON_NEGO_RT_XCLD_KNT != NULL THEN 'Y' WHEN ISS.CPY_TTL_KNT != NULL THEN 'Y' WHEN ISS.RQST_ISS_PLC_NM != NULL THEN 'Y' WHEN ISS.RQST_ISS_DT != NULL THEN 'Y' WHEN ISS.BL_DE_TO_CD != NULL THEN 'Y' WHEN ISS.BL_DE_MZD_CD != NULL THEN 'Y' WHEN ISS.BL_DOC_RQST_RMK != NULL THEN 'Y' ELSE 'N' END DOC_REQUEST_FLAG ,
            (SELECT CASE WHEN COUNT(USR_ID) > 0 THEN 'Y' ELSE 'N' END AUTH_FLAG
               FROM BKG_INET_AUTH
              WHERE USR_ID= @[usr_id] AND DELT_FLG='N') AUTH_FLAG ,
            ISS.OBL_INET_FLG AS INTERNET_AUTH ,      
            DECODE(INET_FLG, 'Y', 'Y', ISS.OBL_PRN_FLG) OBL_PRN_FLG,
			ISS.INET_CTRL_PTY_NM,
			ISS.INET_CTRL_PTY_NO,
			(SELECT CUST_LGL_ENG_NM 
			 FROM MDM_CUSTOMER 
			 WHERE CUST_CNT_CD = ISS.INET_CTRL_PTY_NM 
			   AND CUST_SEQ = ISS.INET_CTRL_PTY_NO 
               AND ROWNUM =1 ) INET_CTRL_PTY_CUST_NM,
		ISS.BL_ISS_TP_CD AS BL_ISS_TP_CD,
        BL.BL_MV_TP_PRN_FLG,
        BL.RCV_DE_TERM_PRN_FLG,
		ISS.RQST_BL_TP_CD AS RQST_BL_TP_CD,
		DECODE(ISS.BKG_NO,NULL,'N','Y') ISS_SAVE_FLG
    FROM BKG_BL_DOC BL,
      	 BKG_BL_ISS ISS,
		 BKG_BOOKING BKG,
		 (SELECT BKG.BKG_NO, DECODE(NVL(INET.BKG_NO, '*'), '*', 'N', 'Y') INET_FLG
          FROM BKG_BOOKING BKG,
                (SELECT BKG_NO, MAX(INFO_SEQ) INFO_SEQ
                FROM BKG_INET_BL_PRN_AUTH
                WHERE BKG_NO = @[bkg_no]
                AND DELT_FLG = 'N'
                AND N1ST_PRN_DT IS NOT NULL
                GROUP BY BKG_NO) INET
          WHERE BKG.BKG_NO = @[bkg_no]
            AND BKG.BKG_NO = INET.BKG_NO(+)
          ) AUTH
    WHERE BKG.BKG_NO = BL.BKG_NO
	  AND BL.BKG_NO = ISS.BKG_NO(+)
      AND BL.BKG_NO = @[bkg_no]
      AND BKG.BKG_NO = AUTH.BKG_NO ) M ,
  (
    SELECT *
    FROM (
        SELECT BKG_NO ,
          BL_NO ,
		  BL_TP_CD ,
          VSL_CD || SKD_VOY_NO || SKD_DIR_CD AS TVVD ,
          BKG_STS_CD AS BKG_STS ,
          BL_TP_CD AS BL_ISSUEBL_TYPE ,
          POR_CD AS NPOR_CODE,
          CUST_TO_ORD_FLG ,
          (
            SELECT LOC_NM
            FROM MDM_LOCATION
            WHERE LOC_CD =POR_CD) AS NPOR_NAME ,
          POL_CD AS NPOL_CODE ,
          (
            SELECT LOC_NM
            FROM MDM_LOCATION
            WHERE LOC_CD =POL_CD) AS NPOL_NAME ,
          POD_CD AS NPOD_CODE ,
          (
            SELECT LOC_NM
            FROM MDM_LOCATION
            WHERE LOC_CD =POD_CD) AS NPOD_NAME ,
          DEL_CD AS NDEL_CODE ,
          (
            SELECT LOC_NM
            FROM MDM_LOCATION
            WHERE LOC_CD =DEL_CD) AS NDEL_NAME ,
          (
            SELECT SKD.VPS_ETD_DT
            FROM VSK_VSL_PORT_SKD SKD,
              (
                SELECT VSL_CD,
                  SKD_VOY_NO,
                  SKD_DIR_CD,
                  POL_CD,
                  POL_CLPT_IND_SEQ
                FROM BKG_VVD
                WHERE BKG_NO = @[bkg_no]
                  AND VSL_PRE_PST_CD||VSL_SEQ = (
                    SELECT MIN(VSL_PRE_PST_CD||VSL_SEQ)
                    FROM BKG_VVD
                    WHERE BKG_NO = @[bkg_no]) ) VVD
            WHERE SKD.VSL_CD = VVD.VSL_CD
              AND SKD.SKD_VOY_NO = VVD.SKD_VOY_NO
              AND SKD.SKD_DIR_CD = VVD.SKD_DIR_CD
              AND SKD.VPS_PORT_CD = VVD.POL_CD
              AND SKD.CLPT_IND_SEQ = VVD.POL_CLPT_IND_SEQ ) AS POL_ETD_DT
        FROM BKG_BOOKING BKG
        WHERE BKG_NO = @[bkg_no] ) BKG,
      (
        SELECT MAX(BKG_NO) BKG_NO,
          MAX(DECODE(BKG_CUST_TP_CD, 'S', CUST_NM, '')) AS SHPR_NAME,
          MAX(DECODE(BKG_CUST_TP_CD, 'S', CUST_ADDR, '')) AS SHPR_ADDRESS,
          MAX(DECODE(BKG_CUST_TP_CD, 'F', CUST_NM, '')) AS F_FWD_NAME,
          MAX(DECODE(BKG_CUST_TP_CD, 'F', CUST_ADDR, '')) AS F_FWD_ADDRESS
        FROM (
            SELECT BKG_NO,
              BKG_CUST_TP_CD,
              CUST_NM ,
              CUST_ADDR
            FROM BKG_CUSTOMER
            WHERE BKG_NO = @[bkg_no]
              AND BKG_CUST_TP_CD IN ('S',
                  'F') ) ) CUS,
(
SELECT DTL.BKG_NO,
(SELECT DO_NO FROM BKG_DO WHERE BKG_NO = DTL.BKG_NO  AND RLSE_SEQ= DTL.RLSE_SEQ ) AS DO_ISSUE_NO,
EVNT_DT AS DO_ISSUE_DATE,
EVNT_OFC_CD AS DO_ISSUE_AT,
EVNT_USR_ID AS DO_ISSUE_BY
FROM BKG_DO_DTL DTL,
  BKG_BOOKING BKG
WHERE DTL.BKG_NO = @[bkg_no]
  AND BKG.BKG_NO = DTL.BKG_NO
  AND DTL.RLSE_STS_CD = DECODE(SUBSTR(BKG.DEL_CD, 1, 2), 'JP', 'D', 'R')
  
UNION ALL
SELECT BKG.BKG_NO,
  '' AS DO_ISSUE_NO,
  CGO.MRN_TML_EDI_LST_SND_DT AS DO_ISSUE_DATE,
  '' AS DO_ISSUE_AT,
  '' AS DO_ISSUE_BY
FROM BKG_BOOKING BKG,
  BKG_CGO_RLSE CGO,
  BKG_CSTMS_ADV_BL AMS
WHERE BKG.BKG_NO = @[bkg_no]
  AND BKG.BL_NO = CGO.BL_NO
  AND CGO.FRT_CLT_FLG = 'Y'
  AND CGO.OBL_RDEM_FLG = 'Y'
  AND CGO.CSTMS_CLR_CD = 'Y'
  AND CGO.BL_NO = AMS.BL_NO
  AND AMS.CNT_CD = 'US'
) DO

    WHERE BKG.BKG_NO = CUS.BKG_NO(+)
      AND BKG.BKG_NO = DO.BKG_NO(+)
) S,
(SELECT MAX(CGO_RCV_DT) AS CGO_RCV_DT FROM BKG_CONTAINER
WHERE BKG_NO = @[bkg_no]
) C			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="usr_id" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
