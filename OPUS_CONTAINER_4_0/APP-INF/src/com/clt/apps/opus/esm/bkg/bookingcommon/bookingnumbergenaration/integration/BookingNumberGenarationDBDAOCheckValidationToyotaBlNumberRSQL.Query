<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BookingNumberGenarationDBDAOCheckValidationToyotaBlNumberRSQL">
			<desc><![CDATA[booking number조회]]></desc>
			<sql><![CDATA[
SELECT *
FROM (
  	SELECT 2 CHECK_SEQ, 'BL_ISSUE' CHECK_MO, COUNT(*)  --BLOCK
 	FROM BKG_BL_ISS BBI
  	WHERE BBI.BKG_NO = @[bkg_no]
  	AND BBI.OBL_ISS_FLG = 'Y'
  	HAVING COUNT(*)>0
  	UNION ALL
  	SELECT 5 CHECK_SEQ, 'DMT_ISSUE' CHECK_MO, COUNT(*)  --BLOCK  
    FROM DMT_CHG_CALC
   	WHERE (SYS_AREA_GRP_ID, CNTR_NO, CNTR_CYC_NO) IN
         (select SYS_AREA_GRP_ID, CNTR_NO, CNTR_CYC_NO
            from dmt_chg_bkg_cntr
           WHERE BKG_NO = @[bkg_no]
         )
    AND DMDT_CHG_STS_CD = 'I'
  	HAVING COUNT(*)>0   
  	UNION ALL
  	SELECT 1 CHECK_SEQ, 'BKG_RATE', COUNT(*)
  	FROM BKG_CHG_RT BCR
  	WHERE BCR.BKG_NO = @[bkg_no]
  	HAVING COUNT(*)>0
  	UNION ALL
  	SELECT 6 CHECK_SEQ, 'DMT_CHARGE' CHECK_MO, COUNT(*)  --SOFT WARNING
    FROM DMT_CHG_CALC
   	WHERE (SYS_AREA_GRP_ID, CNTR_NO, CNTR_CYC_NO) IN
         (select SYS_AREA_GRP_ID, CNTR_NO, CNTR_CYC_NO
            from dmt_chg_bkg_cntr
           WHERE BKG_NO = @[bkg_no])
  	HAVING COUNT(*)>0   
	UNION ALL
	SELECT 3 CHECK_SEQ, 'already downloaded', COUNT(*)
	--china
	from (
	SELECT DISTINCT AA.BL_NO
	FROM BKG_CSTMS_CHN_BL AA
	WHERE AA.BL_NO = @[bl_no]
	MINUS
	SELECT DISTINCT a.bl_no
	FROM BKG_CSTMS_CHN_BL A,
	  BKG_CSTMS_CHN_SND_LOG_BL B,
	  BKG_CSTMS_CHN_SND_LOG C
	WHERE A.BL_NO        = @[bl_no]
	AND A.Bl_no          = B.Bl_no
	AND b.EDI_REF_ID     = c.EDI_REF_ID
	AND c.TRSM_MSG_TP_ID = '3'
	--japan(24)
	UNION
	SELECT DISTINCT AA.BL_NO
	FROM BKG_CSTMS_ADV_JP_BL AA
	WHERE AA.BL_NO = @[bl_no]
	MINUS
	SELECT DISTINCT a.bl_no
	FROM BKG_CSTMS_ADV_JP_SND_LOG A
	WHERE A.BL_NO       = @[bl_no]
	AND a.JP_SND_LOG_ID = 'CMR'
	AND a.LOG_SEQ       = 1
	--Australia
	UNION
	SELECT BL_NO
	FROM BKG_CSTMS_AUS_SND_LOG
	WHERE BL_NO = @[bl_no]
	AND rownum  = 1
	--Bangladesh
	UNION
	SELECT BL_NO
	FROM BKG_CSTMS_BD_CNTR
	WHERE BL_NO = @[bl_no]
	AND rownum  = 1
	--India
	UNION
	SELECT BL_NO
	FROM BKG_CSTMS_IDA_BL
	WHERE BL_NO = @[bl_no]
	AND rownum  = 1
	--Japan
	UNION
	SELECT BL_NO
	FROM BKG_CSTMS_JP_BL
	WHERE BL_NO = @[bl_no]
	AND JP_BL_STS_CD <> 'D'
	AND rownum  = 1
	--Korea
	UNION
	SELECT BL_NO
	FROM BKG_CSTMS_KR_BL
	WHERE BL_NO = @[bl_no]
	AND rownum  = 1 
	UNION
	-- US
	SELECT BL_NO
	FROM BKG_CSTMS_ADV_BL
	WHERE 1 = 1
	AND CNT_CD     = 'US'
	AND MF_STS_CD <> 'D'
	AND BL_NO      = @[bl_no] 
	UNION
	--BR
	SELECT BL_NO FROM BKG_CSTMS_BRZ_BL WHERE BL_NO = @[bl_no] 
	UNION
	-- BE
	SELECT BL_NO FROM BKG_CSTMS_ANR_BL WHERE BL_NO = @[bl_no]
	UNION
	-- NL
	SELECT BL_NO FROM BKG_CSTMS_RTM_BL WHERE BL_NO = @[bl_no]
	UNION
	-- EU DG
	SELECT BL_NO FROM BKG_CSTMS_EUR_DG WHERE BL_NO = @[bl_no]
	UNION
	-- ENS
	SELECT BL_NO FROM BKG_CSTMS_EUR_BL WHERE BL_NO = @[bl_no]
	UNION
	-- EXS
	SELECT BL_NO FROM BKG_CSTMS_EUR_IO_BL WHERE BL_NO = @[bl_no]
	UNION
	-- CA
	SELECT BL_NO FROM BKG_CSTMS_ADV_BL WHERE 1= 1 AND CNT_CD = 'CA' AND BL_NO = @[bl_no]
	UNION
	-- AR
	SELECT BL_NO FROM BKG_CSTMS_ARG_BL WHERE BL_NO = @[bl_no]
	)
	HAVING COUNT(*)>0       
ORDER BY CHECK_SEQ        
)
WHERE ROWNUM = 1			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
