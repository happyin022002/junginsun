<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="KorManifestListDBDAOsearchBkgDgVVDInfoRSQL">
			<desc><![CDATA[VVD 기본 정보를 Retrieve]]></desc>
			<sql><![CDATA[
SELECT	MRN.MRN_NO||MRN.MRN_CHK_NO||CHR(9)||  /* MRN */ 
		MRN.VSL_CD||MRN.SKD_VOY_NO||MRN.SKD_DIR_CD||CHR(9)||
		0||CHR(9)||
		MAX(
			MRN.PORT_CD||CHR(9)||
			MRN.IO_BND_CD||CHR(9)||
			V.VSL_ENG_NM||CHR(9)|| /* VSL FULL NAME */
			V.CALL_SGN_NO||CHR(9)||  /* CALL SIGN */
			NULL||CHR(9)||	/*	SEND DATE	*/
			NULL||CHR(9)||	/*	SEND DATE	*/
			NULL||CHR(9)||	/*	DOC	NO	*/
			DECODE(MRN.PORT_CD,'KRPUS', '020', 'KRINC', '030', 'KRPTK', '031', 'KRKAN', '622', 'KRGIN', '050')||CHR(9)|| /* AUTHORITY */
			DECODE(MRN.IO_BND_CD, 'I', '01', '02')||CHR(9)|| /* IO */
			0||CHR(9)||	/*	IN CNT	입항횟수	*/
			TO_CHAR(ETA, 'YYYY-MM-DD HH24:MI')||CHR(9)|| /* ARRIVAL DATE */
			'01'||CHR(9)||	/*	TRANS CODE	*/
            DECODE(MRN.PORT_CD,'KRPUS','BS-G-4122','KRKAN','YS-G-2013','KRINC','IC-G-1048','KRPTK','PT-K-1107','KRUSN','US-G-0901','KRGIN','GI-G-1003','BS-G-4122')||CHR(9)|| /* Discharge  Company Code */
 			DECODE(MRN.PORT_CD,'KRPUS','㈜한진해운 신항만','KRKAN','㈜한진해운 광양터미널','KRINC','㈜ 인천컨테이너터미널','KRPTK','㈜ 평택컨테인너 터미널','KRUSN','㈜ 동방울산신항컨테이너 터미널','KRGIN','한진해운경인터미널','㈜한진해운 신항만')||CHR(9)|| /* DSCH Com */
			@[total_cntr]||CHR(9)||	/*	TOTAL CNTR	*/
			@[total_wgt]||CHR(9)||	/*	TOTAL WEIGHT	*/
			DECODE(MRN.IO_BND_CD, 'I', '1', '2')||CHR(9)||	/*	JOB CODE 1	*/
			@[job_code2]||CHR(9)||	/*	JOB CODE2	*/
			TO_CHAR(ETA, 'YYYY-MM-DD HH24:MI')||CHR(9)||		/*	FROM DATE	*/
			TO_CHAR(ETD, 'YYYY-MM-DD HH24:MI')||CHR(9)||		/*	TO DATE	*/
			CASE WHEN MRN.IO_BND_CD = 'O' AND MRN.PORT_CD = 'KRPTK' THEN ''
            ELSE PRE_PORT END ||CHR(9)||	/*	PREVIOUS PORT	*/
			NULL||CHR(9)||		/*	PORT AREA		*/
			NULL||CHR(9)||		/*	PORT ANCH		*/
			NULL||CHR(9)||		/*	PORT DESC	*/
			@[substance]||CHR(9)||		/*	SUBSTANCE	*/
			SUI.USR_NM||' '||SUI.XTN_PHN_NO			/*	CONTACT	*/
		)||CHR(9)||
		@[pol_cd]||CHR(9)||		/* ADD 시킬경우 INDICATOR로 사용 */
		@[pod_cd]||CHR(9)||		/* ADD 시킬경우 INDICATOR로 사용 */
		MAX(DECODE(MRN.IO_BND_CD, 'I', TO_CHAR(ETA, 'YYYY-MM-DD HH24:MI'), TO_CHAR(ETD, 'YYYY-MM-DD HH24:MI')))||CHR(9)||0 DATA
FROM	BKG_CSTMS_KR_MF_REF_NO MRN, MDM_VSL_CNTR V, COM_USER SUI,
		(	SELECT	VPS.VSL_CD VSL, VPS.SKD_VOY_NO VOY, VPS.SKD_DIR_CD DIR,
					VPS.VPS_PORT_CD PORT,	VPS2.VPS_PORT_CD	PRE_PORT,
					VPS.VPS_ETA_DT ETA,
					VPS.VPS_ETD_DT	ETD
			FROM	VSK_VSL_PORT_SKD  VPS, VSK_VSL_PORT_SKD  VPS2
			WHERE	VPS.VSL_CD					=	SUBSTR(@[vvd],1,4)
			AND		VPS.SKD_VOY_NO		     	=	SUBSTR(@[vvd],5,4)
			AND		VPS.SKD_DIR_CD				=	SUBSTR(@[vvd],9,1)
			AND		VPS.VPS_PORT_CD				=	DECODE(@[io_bnd_cd], 'O', @[pol_cd], @[pod_cd])
			AND		NVL(VPS.SKD_CNG_STS_CD,' ')	<>	'S'
			AND		(VPS.CLPT_IND_SEQ			=	'1' OR VPS.CLPT_IND_SEQ =   '2') 
			AND		VPS.VSL_CD					=	VPS2.VSL_CD(+)
			AND		VPS.SKD_VOY_NO			    =	VPS2.SKD_VOY_NO(+)
			AND		VPS.SKD_DIR_CD				=	VPS2.SKD_DIR_CD(+)
			AND		VPS.CLPT_IND_SEQ			=	VPS2.CLPT_IND_SEQ(+)
			AND		VPS.CLPT_SEQ	-	1	    =	VPS2.CLPT_SEQ(+)
			AND		ROWNUM	=	1
		)
WHERE	VSL				=	MRN.VSL_CD
AND		VOY				=	MRN.SKD_VOY_NO
AND		DIR				=	MRN.SKD_DIR_CD
AND		PORT			=	MRN.PORT_CD
AND		MRN.IO_BND_CD	=	@[io_bnd_cd]
AND		SUI.USR_ID		=	@[user_id]
AND  	VSL				=	V.VSL_CD
GROUP BY MRN.MRN_NO, MRN.MRN_CHK_NO, MRN.VSL_CD, MRN.SKD_VOY_NO, MRN.SKD_DIR_CD			]]></sql>
			<params>
				<param name="total_cntr" type="12" value="" out="N"/>
				<param name="total_wgt" type="12" value="" out="N"/>
				<param name="job_code2" type="12" value="" out="N"/>
				<param name="substance" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="io_bnd_cd" type="12" value="" out="N"/>
				<param name="user_id" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
