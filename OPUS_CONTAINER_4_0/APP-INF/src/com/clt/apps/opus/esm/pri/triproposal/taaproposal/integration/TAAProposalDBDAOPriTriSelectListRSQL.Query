<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TAAProposalDBDAOPriTriSelectListRSQL">
			<desc><![CDATA[TAA TRI Select List]]></desc>
			<sql><![CDATA[
WITH TRI AS (
    SELECT TR.TRI_PROP_NO
         , TR.AMDT_SEQ
         , TM.TRF_PFX_CD
         , TM.TRF_NO
         , TM.TRI_NO
         , TM.CMDT_CD
         , (SELECT MC.CMDT_NM
            FROM MDM_COMMODITY MC
            WHERE MC.CMDT_CD = TM.CMDT_CD) AS CMDT_NM
         , TR.RAT_UT_CD
         , TR.PRC_CGO_TP_CD
         , TR.CURR_CD
         , TR.FNL_FRT_RT_AMT
         , TR.NOTE_CTNT
         , TR.NOTE_CONV_MAPG_ID
         , TR.EFF_DT
         , TR.EXP_DT
         , TR.PUB_DT
    FROM PRI_TRI_MN TM
       , PRI_TRI_RT TR
    WHERE 1=1
#if (${frm_tri_no} != '') 
    AND   TM.TRI_NO = REPLACE(@[frm_tri_no], '-', '')
#end
    AND   TM.TRF_PFX_CD = @[frm_trf_pfx_cd]
    AND   TM.TRF_NO = @[frm_trf_no]
#if (${frm_cmdt_cd} != '') 
    AND   TM.CMDT_CD = @[frm_cmdt_cd]
#end
    AND   TR.TRI_PROP_NO = TM.TRI_PROP_NO
    AND   TR.AMDT_SEQ = (SELECT MAX(TT.AMDT_SEQ)
                         FROM PRI_TRI_RT TT
                         WHERE TT.TRI_PROP_NO = TR.TRI_PROP_NO
                         AND   TT.PROP_STS_CD = 'F')
)

#if (${frm_org_pnt_loc_cd} != '' || ${frm_dest_pnt_loc_cd} != '' || ${frm_org_via_port_cd} != '' || ${frm_dest_via_port_cd} != '') 
SELECT *
FROM (
#end
SELECT TA.TRI_PROP_NO
     , TA.AMDT_SEQ
     , TA.TRF_PFX_CD
     , TA.TRF_NO
     , TA.TRI_NO
     , TA.CMDT_CD
     , TA.CMDT_NM
     , PO.ORG_PNT_LOC_CD
     , PD.DEST_PNT_LOC_CD
     , VO.ORG_VIA_PORT_CD
     , VD.DEST_VIA_PORT_CD
     , PN.ORG_PNT_LOC_NM
     , PM.DEST_PNT_LOC_NM
     , VN.ORG_VIA_PORT_NM
     , VM.DEST_VIA_PORT_NM
     , TA.RAT_UT_CD
     , TA.PRC_CGO_TP_CD
     , TA.CURR_CD
     , TA.FNL_FRT_RT_AMT
     , TA.NOTE_CTNT
     , TA.NOTE_CONV_MAPG_ID
     , TO_CHAR(TA.EFF_DT, 'YYYYMMDD') AS EFF_DT
     , TO_CHAR(TA.EXP_DT, 'YYYYMMDD') AS EXP_DT
     , TO_CHAR(TA.PUB_DT, 'YYYYMMDD') AS PUB_DT
FROM TRI TA
   , (
        SELECT TRI_PROP_NO
             , SUBSTR(MAX(SYS_CONNECT_BY_PATH(ROUT_PNT_LOC_CD,', ')), 3) AS ORG_PNT_LOC_CD
        FROM (
                SELECT RO.TRI_PROP_NO
                     , RO.ORG_DEST_TP_CD
                     , RO.ROUT_PNT_SEQ
                     , RO.ROUT_PNT_LOC_CD
                     , DENSE_RANK() OVER (PARTITION BY RO.TRI_PROP_NO, RO.ORG_DEST_TP_CD ORDER BY RO.TRI_PROP_NO, RO.ORG_DEST_TP_CD, RO.ROUT_PNT_SEQ, RO.ROUT_PNT_LOC_CD) AS SEQ
                FROM PRI_TRI_RT_ROUT_PNT RO
                   , TRI TR
                WHERE 1=1
                AND   RO.TRI_PROP_NO = TR.TRI_PROP_NO
                AND   RO.ORG_DEST_TP_CD = 'O'
        )
        START WITH SEQ = 1
        CONNECT BY PRIOR TRI_PROP_NO = TRI_PROP_NO
               AND PRIOR ORG_DEST_TP_CD = ORG_DEST_TP_CD
               AND PRIOR SEQ = SEQ -1
        GROUP BY TRI_PROP_NO
   ) PO
   , (
        SELECT TRI_PROP_NO
             , SUBSTR(MAX(SYS_CONNECT_BY_PATH(ROUT_PNT_LOC_CD,', ')), 3) AS DEST_PNT_LOC_CD
        FROM (
                SELECT RD.TRI_PROP_NO
                     , RD.ORG_DEST_TP_CD
                     , RD.ROUT_PNT_SEQ
                     , RD.ROUT_PNT_LOC_CD
                     , DENSE_RANK() OVER (PARTITION BY RD.TRI_PROP_NO, RD.ORG_DEST_TP_CD ORDER BY RD.TRI_PROP_NO, RD.ORG_DEST_TP_CD, RD.ROUT_PNT_SEQ, RD.ROUT_PNT_LOC_CD) AS SEQ
                FROM PRI_TRI_RT_ROUT_PNT RD
                   , TRI TR
                WHERE 1=1
                AND   RD.TRI_PROP_NO = TR.TRI_PROP_NO
                AND   RD.ORG_DEST_TP_CD = 'D'
        )
        START WITH SEQ = 1
        CONNECT BY PRIOR TRI_PROP_NO = TRI_PROP_NO
               AND PRIOR ORG_DEST_TP_CD = ORG_DEST_TP_CD
               AND PRIOR SEQ = SEQ -1
        GROUP BY TRI_PROP_NO
   ) PD
   , (
        SELECT TRI_PROP_NO
             , SUBSTR(MAX(SYS_CONNECT_BY_PATH(ROUT_VIA_PORT_CD,', ')), 3) ORG_VIA_PORT_CD
        FROM (
                SELECT VO.TRI_PROP_NO
                     , VO.ORG_DEST_TP_CD
                     , VO.ROUT_VIA_SEQ
                     , VO.ROUT_VIA_PORT_CD
                     , DENSE_RANK() OVER (PARTITION BY VO.TRI_PROP_NO, VO.ORG_DEST_TP_CD ORDER BY VO.TRI_PROP_NO, VO.ORG_DEST_TP_CD, VO.ROUT_VIA_SEQ, VO.ROUT_VIA_PORT_CD) AS SEQ
                FROM PRI_TRI_RT_ROUT_VIA VO
                   , TRI TR
                WHERE 1=1
                AND   VO.TRI_PROP_NO = TR.TRI_PROP_NO
                AND   VO.ORG_DEST_TP_CD = 'O'
        )
        START WITH SEQ = 1
        CONNECT BY PRIOR TRI_PROP_NO = TRI_PROP_NO
               AND PRIOR ORG_DEST_TP_CD = ORG_DEST_TP_CD
               AND PRIOR SEQ = SEQ -1
        GROUP BY TRI_PROP_NO
   ) VO
   , (
        SELECT TRI_PROP_NO
             , SUBSTR(MAX(SYS_CONNECT_BY_PATH(ROUT_VIA_PORT_CD,', ')), 3) DEST_VIA_PORT_CD
        FROM (
                SELECT VD.TRI_PROP_NO
                     , VD.ORG_DEST_TP_CD
                     , VD.ROUT_VIA_SEQ
                     , VD.ROUT_VIA_PORT_CD
                     , DENSE_RANK() OVER (PARTITION BY VD.TRI_PROP_NO, VD.ORG_DEST_TP_CD ORDER BY VD.TRI_PROP_NO, VD.ORG_DEST_TP_CD, VD.ROUT_VIA_SEQ, VD.ROUT_VIA_PORT_CD) AS SEQ
                FROM PRI_TRI_RT_ROUT_VIA VD
                   , TRI TR
                WHERE 1=1
                AND   VD.TRI_PROP_NO = TR.TRI_PROP_NO
                AND   VD.ORG_DEST_TP_CD = 'D'
        )
        START WITH SEQ = 1
        CONNECT BY PRIOR TRI_PROP_NO = TRI_PROP_NO
               AND PRIOR ORG_DEST_TP_CD = ORG_DEST_TP_CD
               AND PRIOR SEQ = SEQ -1
        GROUP BY TRI_PROP_NO
   ) VD
   , (
        SELECT TRI_PROP_NO
--             , SUBSTR(MAX(SYS_CONNECT_BY_PATH(LOC_NM,'|')), 2) AS ORG_PNT_LOC_NM
             , SUBSTR(MAX(SYS_CONNECT_BY_PATH(LOC_NM || DECODE(TERM_NM, NULL, '', '(' || TERM_NM || ')') 
                                                     || DECODE(TRANS_MODE_NM, NULL, '', '(' || TRANS_MODE_NM || ')'), '|')), 2) AS ORG_PNT_LOC_NM
        FROM (
                SELECT TP.TRI_PROP_NO
                     , TP.ORG_DEST_TP_CD
                     , TP.ROUT_PNT_SEQ
                     , TP.ROUT_PNT_LOC_CD
                     , ML.LOC_NM
                     , (SELECT TM.INTG_CD_VAL_DP_DESC
                        FROM  COM_INTG_CD_DTL TM
                        WHERE TM.INTG_CD_ID = 'CD02138'
                        AND   TM.INTG_CD_VAL_CTNT = TP.RCV_DE_TERM_CD) AS TERM_NM
                     , (SELECT TM.INTG_CD_VAL_DP_DESC
                        FROM  COM_INTG_CD_DTL TM
                        WHERE TM.INTG_CD_ID = 'CD01720'
                        AND   TM.INTG_CD_VAL_CTNT = TP.PRC_TRSP_MOD_CD) AS TRANS_MODE_NM
                     , DENSE_RANK() OVER (PARTITION BY TP.TRI_PROP_NO, TP.ORG_DEST_TP_CD ORDER BY TP.TRI_PROP_NO, TP.ORG_DEST_TP_CD, TP.ROUT_PNT_SEQ, TP.ROUT_PNT_LOC_CD) AS SEQ
                FROM PRI_TRI_RT_ROUT_PNT TP
                   , TRI TR
                   , MDM_LOCATION ML
                WHERE 1=1
                AND   TP.TRI_PROP_NO = TR.TRI_PROP_NO
                AND   TP.ORG_DEST_TP_CD = 'O'
                AND   ML.LOC_CD = TP.ROUT_PNT_LOC_CD
        )
        START WITH SEQ = 1
        CONNECT BY PRIOR TRI_PROP_NO = TRI_PROP_NO
               AND PRIOR ORG_DEST_TP_CD = ORG_DEST_TP_CD
               AND PRIOR SEQ = SEQ - 1
        GROUP BY TRI_PROP_NO
   ) PN
   , (
        SELECT TRI_PROP_NO
--             , SUBSTR(MAX(SYS_CONNECT_BY_PATH(LOC_NM,'|')), 2) AS DEST_PNT_LOC_NM
             , SUBSTR(MAX(SYS_CONNECT_BY_PATH(LOC_NM || DECODE(TERM_NM, NULL, '', '(' || TERM_NM || ')') 
                                                     || DECODE(TRANS_MODE_NM, NULL, '', '(' || TRANS_MODE_NM || ')'), '|')), 2) AS DEST_PNT_LOC_NM
        FROM (
                SELECT TP.TRI_PROP_NO
                     , TP.ORG_DEST_TP_CD
                     , TP.ROUT_PNT_SEQ
                     , TP.ROUT_PNT_LOC_CD
                     , ML.LOC_NM
                     , (SELECT TM.INTG_CD_VAL_DP_DESC
                        FROM  COM_INTG_CD_DTL TM
                        WHERE TM.INTG_CD_ID = 'CD02139'
                        AND   TM.INTG_CD_VAL_CTNT = TP.RCV_DE_TERM_CD) AS TERM_NM
                     , (SELECT TM.INTG_CD_VAL_DP_DESC
                        FROM  COM_INTG_CD_DTL TM
                        WHERE TM.INTG_CD_ID = 'CD01720'
                        AND   TM.INTG_CD_VAL_CTNT = TP.PRC_TRSP_MOD_CD) AS TRANS_MODE_NM
                     , DENSE_RANK() OVER (PARTITION BY TP.TRI_PROP_NO, TP.ORG_DEST_TP_CD ORDER BY TP.TRI_PROP_NO, TP.ORG_DEST_TP_CD, TP.ROUT_PNT_SEQ, TP.ROUT_PNT_LOC_CD) AS SEQ
                FROM PRI_TRI_RT_ROUT_PNT TP
                   , TRI TR
                   , MDM_LOCATION ML
                WHERE 1=1
                AND   TP.TRI_PROP_NO = TR.TRI_PROP_NO
                AND   TP.ORG_DEST_TP_CD = 'D'
                AND   ML.LOC_CD = TP.ROUT_PNT_LOC_CD
        )
        START WITH SEQ = 1
        CONNECT BY PRIOR TRI_PROP_NO = TRI_PROP_NO
               AND PRIOR ORG_DEST_TP_CD = ORG_DEST_TP_CD
               AND PRIOR SEQ = SEQ - 1
        GROUP BY TRI_PROP_NO
   ) PM
   , (
        SELECT TRI_PROP_NO
             , SUBSTR(MAX(SYS_CONNECT_BY_PATH(LOC_NM,'|')), 2) ORG_VIA_PORT_NM
        FROM (
                SELECT VI.TRI_PROP_NO
                     , VI.ORG_DEST_TP_CD
                     , VI.ROUT_VIA_SEQ
                     , VI.ROUT_VIA_PORT_CD
                     , ML.LOC_NM
                     , DENSE_RANK() OVER (PARTITION BY VI.TRI_PROP_NO, VI.ORG_DEST_TP_CD ORDER BY VI.TRI_PROP_NO, VI.ORG_DEST_TP_CD, VI.ROUT_VIA_SEQ, VI.ROUT_VIA_PORT_CD) AS SEQ
                FROM PRI_TRI_RT_ROUT_VIA VI
                   , TRI TR
                   , MDM_LOCATION ML
                WHERE 1=1
                AND   VI.TRI_PROP_NO = TR.TRI_PROP_NO
                AND   VI.ORG_DEST_TP_CD = 'O'
                AND   ML.LOC_CD = VI.ROUT_VIA_PORT_CD
        )
        START WITH SEQ = 1
        CONNECT BY PRIOR TRI_PROP_NO = TRI_PROP_NO
               AND PRIOR ORG_DEST_TP_CD = ORG_DEST_TP_CD
               AND PRIOR SEQ = SEQ -1
        GROUP BY TRI_PROP_NO
   ) VN
   , (
        SELECT TRI_PROP_NO
             , SUBSTR(MAX(SYS_CONNECT_BY_PATH(LOC_NM,'|')), 2) DEST_VIA_PORT_NM
        FROM (
                SELECT VI.TRI_PROP_NO
                     , VI.ORG_DEST_TP_CD
                     , VI.ROUT_VIA_SEQ
                     , VI.ROUT_VIA_PORT_CD
                     , ML.LOC_NM
                     , DENSE_RANK() OVER (PARTITION BY VI.TRI_PROP_NO, VI.ORG_DEST_TP_CD ORDER BY VI.TRI_PROP_NO, VI.ORG_DEST_TP_CD, VI.ROUT_VIA_SEQ, VI.ROUT_VIA_PORT_CD) AS SEQ
                FROM PRI_TRI_RT_ROUT_VIA VI
                   , TRI TR
                   , MDM_LOCATION ML
                WHERE 1=1
                AND   VI.TRI_PROP_NO = TR.TRI_PROP_NO
                AND   VI.ORG_DEST_TP_CD = 'D'
                AND   ML.LOC_CD = VI.ROUT_VIA_PORT_CD
        )
        START WITH SEQ = 1
        CONNECT BY PRIOR TRI_PROP_NO = TRI_PROP_NO
               AND PRIOR ORG_DEST_TP_CD = ORG_DEST_TP_CD
               AND PRIOR SEQ = SEQ -1
        GROUP BY TRI_PROP_NO
   ) VM
WHERE 1=1
AND   PO.TRI_PROP_NO(+) = TA.TRI_PROP_NO
AND   PD.TRI_PROP_NO(+) = TA.TRI_PROP_NO
AND   VO.TRI_PROP_NO(+) = TA.TRI_PROP_NO
AND   VD.TRI_PROP_NO(+) = TA.TRI_PROP_NO
AND   PN.TRI_PROP_NO(+) = TA.TRI_PROP_NO
AND   PM.TRI_PROP_NO(+) = TA.TRI_PROP_NO
AND   VN.TRI_PROP_NO(+) = TA.TRI_PROP_NO
AND   VM.TRI_PROP_NO(+) = TA.TRI_PROP_NO
AND   TA.EXP_DT >= SYSDATE
ORDER BY TA.TRI_NO
#if (${frm_org_pnt_loc_cd} != '' || ${frm_dest_pnt_loc_cd} != '' || ${frm_org_via_port_cd} != '' || ${frm_dest_via_port_cd} != '') 
)
WHERE 1=1
#if (${frm_org_pnt_loc_cd} != '') 
AND   ORG_PNT_LOC_CD LIKE '%'||@[frm_org_pnt_loc_cd]||'%'
#end
#if (${frm_dest_pnt_loc_cd} != '') 
AND   DEST_PNT_LOC_CD LIKE '%'||@[frm_dest_pnt_loc_cd]||'%'
#end
#if (${frm_org_via_port_cd} != '') 
AND   ORG_VIA_PORT_CD LIKE '%'||@[frm_org_via_port_cd]||'%'
#end
#if (${frm_dest_via_port_cd} != '') 
AND   DEST_VIA_PORT_CD LIKE '%'||@[frm_dest_via_port_cd]||'%'
#end
#end			]]></sql>
			<params>
				<param name="frm_tri_no" type="12" value="" out="N"/>
				<param name="frm_trf_pfx_cd" type="12" value="" out="N"/>
				<param name="frm_trf_no" type="12" value="" out="N"/>
				<param name="frm_cmdt_cd" type="12" value="" out="N"/>
				<param name="frm_org_pnt_loc_cd" type="12" value="" out="N"/>
				<param name="frm_dest_pnt_loc_cd" type="12" value="" out="N"/>
				<param name="frm_org_via_port_cd" type="12" value="" out="N"/>
				<param name="frm_dest_via_port_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
