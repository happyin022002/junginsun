<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="DominicanManifestDownloadDBDAOsearchDominicanManifestListRSQL">
			<desc><![CDATA[searchDominicanManifestList]]></desc>
			<sql><![CDATA[
SELECT TT.*
       ,SUBSTR(TT.Spcl_Cgo_Desc_TMP, 1, LENGTH(TT.Spcl_Cgo_Desc_TMP) - 3) AS Spcl_Cgo_Desc
       ,CASE WHEN INSTR(SUBSTR(TT.Spcl_Cgo_Desc_TMP, 1, LENGTH(TT.Spcl_Cgo_Desc_TMP) - 3), '/') > 0  
                THEN 'M'
                ELSE spcl_Cgo_Desc_Type_tmp
        END AS spcl_Cgo_Desc_Type
                
       
FROM (
    SELECT T.*

          ,(         
               CASE WHEN DG_Spcl_Cgo_Desc IS NOT NULL THEN DG_Spcl_Cgo_Desc || ' / ' ELSE '' END
            || CASE WHEN AW_Spcl_Cgo_Desc IS NOT NULL THEN AW_Spcl_Cgo_Desc || ' / ' ELSE '' END
            || CASE WHEN RC_Spcl_Cgo_Desc IS NOT NULL THEN RC_Spcl_Cgo_Desc || ' / ' ELSE '' END
            || CASE WHEN PC_Spcl_Cgo_Desc IS NOT NULL THEN PC_Spcl_Cgo_Desc || ' / ' ELSE '' END
            || CASE WHEN RD_Spcl_Cgo_Desc IS NOT NULL THEN RD_Spcl_Cgo_Desc || ' / ' ELSE '' END
            || CASE WHEN HG_Spcl_Cgo_Desc IS NOT NULL THEN HG_Spcl_Cgo_Desc || ' / ' ELSE '' END
           ) Spcl_Cgo_Desc_TMP                
          
         ,( SELECT DECODE(NVL(MAX(SO.BKG_NO), 'N'), 'N', 'N', 'Y') AS woFlg
                FROM TRS_TRSP_SVC_ORD SO
                ,TRS_TRSP_WRK_ORD WO
                WHERE 1=1
                AND SO.TRSP_WO_OFC_CTY_CD = WO.TRSP_WO_OFC_CTY_CD
                AND SO.TRSP_WO_SEQ = WO.TRSP_WO_SEQ
                AND SO.TRSP_SO_STS_CD = 'I'
                AND NVL(SO.DELT_FLG,'N') = 'N'
                AND SO.BKG_NO = T.BKG_NO
                AND SO.EQ_NO = T.CNTR_NO
                AND ROWNUM = 1
                AND SO.TO_NOD_CD LIKE T.POD_CD||'%'
           ) WO_FLG
           ,ROUND((round(nvl(ACT_WGT, 0) * decode(substr(CNTR_TPSZ_CD, 2, 1), '2', 1, 2) / TOT) +
            NVL(CNTR_VOL_QTY, 1)* decode(nvl(mst_tare,0), 0, decode(nvl(mdm_tare,0), 0, 2500, mdm_tare), mst_tare))/1000) E_CNTR_WGT
    FROM (
        SELECT CNTR.CNTR_NO,
               CNTR.CNTR_TPSZ_CD,
               SEAL.CNTR_SEAL_NO,
               SEAL.SEAL_KND_CD,
               SEAL.SEAL_PTY_TP_CD,

               
               MAX(CNTR.CNTR_WGT) A_CNTR_WGT,
               ROUND(CNTR.CNTR_WGT/1000, 0) CNTR_WGT,
               DOC.ACT_WGT,
               CNTR.PCK_QTY,
               BKG.BKG_NO,
               BKG.BL_NO||BKG.BL_TP_CD BL_NO,
               BKG.POR_CD,
               BKG.POL_CD A_POL_CD,
               BKG.POD_CD A_POD_CD,
               BKG.DEL_CD,
               BKG.BLCK_STWG_CD,
               CNTR.RCV_TERM_CD,
               CNTR.DE_TERM_CD,
               DECODE(BKG.POD_CD, VVD.POD_CD, 'L', 'T') TS_CD,
               BKG.BKG_CGO_TP_CD,
               BKG.HOT_DE_FLG,
               DECODE(BKG.CUST_TO_ORD_FLG, 'Y', REPLACE(TRANSLATE(NVL(BCN.CUST_NM, ' '), CHR(13)||CHR(10), ' '), '''', ' '), REPLACE(TRANSLATE(NVL(MAX(BCC.CUST_NM), ' '), CHR(13)||CHR(10), ' '), '''', ' ')) CUST_NM,
               CNTR.SOC_FLG,
               BKG.STWG_CD,
               CM.HAMO_TRF_CD,
               CM.CMDT_HS_CD,
               CNTR.CNTR_VOL_QTY,
               (SELECT SUM(DECODE(SUBSTR(CNTR_TPSZ_CD, 2, 1), '2', 1, 2)) TOT
                  FROM BKG_CONTAINER BC
                 WHERE BC.BKG_NO = BKG.BKG_NO ) TOT,
               CNTR.PCK_TP_CD,
               SUBSTR(BKG.POR_NOD_CD, 6, 2) POR_NOD_CD,
               SUBSTR(BKG.POL_NOD_CD, 6, 2) POL_NOD_CD,
               SUBSTR(BKG.POD_NOD_CD, 6, 2) POD_NOD_CD,
               SUBSTR(BKG.DEL_NOD_CD, 6, 2) DEL_NOD_CD,
               BKG.CUST_TO_ORD_FLG,
               VVD.POL_CD,
               SUBSTR(VVD.POL_YD_CD, 6, 2) POL_YD_CD,
               VVD.POD_CD,
               SUBSTR(VVD.POD_YD_CD, 6, 2) POD_YD_CD,
               CNTR.MEAS_QTY*1000 MEAS_QTY,

               CNTR.DCGO_FLG,
               CNTR.RC_FLG,
               CNTR.AWK_CGO_FLG,
               CNTR.RD_CGO_FLG,
               BKG.PRCT_FLG,
               CNTR.HNGR_FLG,
               
               CASE WHEN CNTR.DCGO_FLG = 'Y' THEN 'D'
                    WHEN CNTR.RC_FLG = 'Y' THEN 'R'
                    WHEN CNTR.AWK_CGO_FLG = 'Y' THEN 'A'
                    WHEN BKG.PRCT_FLG = 'Y' THEN 'P'
                    WHEN CNTR.RD_CGO_FLG = 'Y' THEN 'RD'
                    WHEN CNTR.HNGR_FLG = 'Y' THEN 'GOH'
                    ELSE ''
               END AS spcl_Cgo_Desc_Type_TMP,
               
               CASE WHEN CNTR.DCGO_FLG = 'Y' 
                    THEN 
                        (
                            SELECT	
                                'Cls:'||NVL(IMDG_CLSS_CD,' ')||' UN:'||NVL(IMDG_UN_NO,' ')||DECODE(NVL(TRIM(HCDG_FLG), 'N'), 'Y', ' HCDG', '') SPCL_CGO_DESC
                            FROM	BKG_DG_CGO
                            WHERE	BKG_NO   = BKG.BKG_NO
                            AND	CNTR_NO      = CNTR.CNTR_NO
                            AND	ROWNUM       = 1                    
                        )
                    ELSE ''
               END AS DG_Spcl_Cgo_Desc,
               
               CASE WHEN CNTR.AWK_CGO_FLG = 'Y' 
                    THEN 
                        (
                            SELECT	TO_CHAR(NVL(CDO_TEMP,0),9990.9)||'C'  SPCL_CGO_DESC
                            FROM	BKG_RF_CGO
                            WHERE	BKG_NO   = BKG.BKG_NO
                            AND	CNTR_NO      = CNTR.CNTR_NO
                            AND	ROWNUM       = 1                 
                        )
                    ELSE ''
               END AS AW_Spcl_Cgo_Desc,

               CASE WHEN CNTR.RC_FLG = 'Y' 
                    THEN 
                        (
                            SELECT	'F:'||TO_CHAR(NVL(OVR_FWRD_LEN,0))||'/'||
                                    'B:'||TO_CHAR(NVL(OVR_BKWD_LEN,0))||'/'||
                                    'H:'||TO_CHAR(NVL(OVR_HGT,0))||'/'||
                                    'P:'||TO_CHAR(NVL(OVR_LF_LEN,0))||'/'||
                                    'S:'||TO_CHAR(NVL(OVR_RT_LEN,0))  SPCL_CGO_DESC
                            FROM	BKG_AWK_CGO
                            WHERE	BKG_NO   = BKG.BKG_NO
                            AND	CNTR_NO      = CNTR.CNTR_NO
                            AND	ROWNUM = 1
                        )
                    ELSE ''
               END AS RC_Spcl_Cgo_Desc,
               
               CASE WHEN BKG.PRCT_FLG = 'Y' 
                    THEN 'Precaution cargo'
                    ELSE ''
               END AS PC_Spcl_Cgo_Desc,
                
               CASE WHEN CNTR.RD_CGO_FLG = 'Y' 
                    THEN 'Reefer Dry'
                    ELSE ''
               END AS RD_Spcl_Cgo_Desc,

               CASE WHEN CNTR.HNGR_FLG = 'Y' 
                    THEN 'Hanger'
                    ELSE ''
               END AS HG_Spcl_Cgo_Desc,

            (SELECT /*+ INDEX_DESC(CTM_MOVEMENT XAK12CTM_MOVEMENT) */
                  nvl(DEST_YD_CD, NVL(ORG_YD_CD, ' ')) ORG_YD_CD
                  FROM CTM_MOVEMENT
                 WHERE CNTR_NO = CNTR.CNTR_NO
                   AND MVMT_STS_CD = 'IC'
                   AND CNMV_YR = to_char(sysdate, 'YYYY')
                   AND ROWNUM = 1 ) ORG_YD_CD,
               (SELECT /*+ INDEX_DESC(CTM_MOVEMENT XAK12CTM_MOVEMENT) */
                  to_char(CNMV_EVNT_DT, 'YYYY-MM-DD HH24:MI:SS') CNMV_EVNT_DT
                  FROM CTM_MOVEMENT
                 WHERE CNTR_NO = CNTR.CNTR_NO
                   AND MVMT_STS_CD = 'IC'
                   AND CNMV_YR = to_char(sysdate, 'YYYY')
                   AND ROWNUM =1 ) CNMV_EVNT_DT,
               
    --           MAX(CNTR.RD_CGO_FLG) RD_CGO_FLG, 

               MAX(DOC.CSTMS_DESC) CSTMS_DESC,
               
               (SELECT MAX(NVL(SPEC.TARE_WGT, 0)) MST_WGT
                FROM MST_CONTAINER MST,
                MST_CNTR_SPEC SPEC
                WHERE MST.CNTR_NO = CNTR.CNTR_NO
                AND MST.CNTR_SPEC_NO = SPEC.CNTR_SPEC_NO ) MST_TARE,
               (
                SELECT MAX(NVL(MDM.CNTR_TPSZ_TARE_WGT, 0)) MDM_WGT
                FROM MDM_CNTR_TP_SZ MDM
                WHERE MDM.CNTR_TPSZ_CD = CNTR.CNTR_TPSZ_CD
                ) MDM_TARE
                
          FROM BKG_BOOKING BKG,
               BKG_CONTAINER CNTR,
               BKG_BL_DOC DOC,
               BKG_VVD VVD,
               BKG_VVD BKGVVD,
               BKG_CUSTOMER BCS,
               BKG_CUSTOMER BCC,
               BKG_CUSTOMER BCN,
               BKG_CNTR_MF_DESC CM,
               
               BKG_CNTR_SEAL_NO SEAL,
               
               MDM_LOCATION MDM ,

               MDM_LOCATION POR ,
               MDM_LOCATION APOL ,
               MDM_LOCATION APOD ,
               MDM_LOCATION BPOL ,
               MDM_LOCATION BPOD ,
               MDM_LOCATION DEL
         WHERE VVD.VSL_CD = SUBSTR(@[vvd], 1, 4)
           AND VVD.SKD_VOY_NO = SUBSTR(@[vvd], 5, 4)
           AND VVD.SKD_DIR_CD = SUBSTR(@[vvd], 9, 1)
           AND BKG.BKG_NO = BKGVVD.BKG_NO
           AND BKG.BKG_STS_CD <> 'S'
           AND BKG.POR_CD = POR.LOC_CD(+)
           AND BKG.POL_CD = APOL.LOC_CD(+)
           AND BKG.POD_CD = APOD.LOC_CD(+)
           AND VVD.POL_CD = BPOL.LOC_CD(+)
           AND VVD.POD_CD = BPOD.LOC_CD(+)
           AND BKG.DEL_CD = DEL.LOC_CD(+)
           AND VVD.POD_CD = @[pod_cd]
           AND BKG.BKG_NO = VVD.BKG_NO
           AND BKG.POD_CD <> 'XXXXX'
           AND BKG.BKG_NO = CNTR.BKG_NO
           AND BKG.BKG_NO = DOC.BKG_NO
           AND BKG.BKG_NO = BCS.BKG_NO
           AND BCS.BKG_CUST_TP_CD = 'S'
           AND BKG.BKG_NO = BCC.BKG_NO
           AND BCC.BKG_CUST_TP_CD = 'C'
           AND BKG.BKG_NO = BCN.BKG_NO
           AND BCN.BKG_CUST_TP_CD = 'N'
           AND NVL(BKG.BKG_STS_CD, ' ') NOT IN ('X','A')
           AND '1' = '1'
           AND MDM.LOC_CD = BKG.DEL_CD
           AND CNTR.BKG_NO = CM.BKG_NO (+)
           AND CNTR.CNTR_NO = CM.CNTR_NO (+)
           AND CM.CNTR_MF_SEQ (+) = 1
           
           AND CNTR.BKG_NO = SEAL.BKG_NO(+)
           AND CNTR.CNTR_NO = SEAL.CNTR_NO(+)
           AND CNTR_SEAL_SEQ(+) = 1
           
         GROUP BY CNTR.CNTR_NO,
               CNTR.CNTR_TPSZ_CD,
               SEAL.CNTR_SEAL_NO,
               SEAL.SEAL_KND_CD,
               SEAL.SEAL_PTY_TP_CD,       
               CNTR.CNTR_WGT,
               DOC.ACT_WGT,
               CNTR.PCK_QTY,
               BKG.BKG_NO,
               BKG.BL_NO||BKG.BL_TP_CD,
               BKG.POR_CD,
               BKG.POL_CD,
               BKG.POD_CD,
               BKG.DEL_CD,
               BKG.BLCK_STWG_CD,
               CNTR.RCV_TERM_CD,
               CNTR.DE_TERM_CD,
               BKG.POL_CD,
               VVD.POL_CD,
               BKG.POD_CD,
               VVD.POD_CD,
               BKG.BKG_CGO_TP_CD,
               BKG.HOT_DE_FLG,
               BKG.CUST_TO_ORD_FLG,
               BCN.CUST_NM,
               CNTR.SOC_FLG,
               BKG.STWG_CD,
               CM.HAMO_TRF_CD,
               CM.CMDT_HS_CD,
               CNTR.CNTR_VOL_QTY,
               CNTR_TPSZ_CD,
               CNTR.PCK_TP_CD,
               BKG.POR_NOD_CD,
               BKG.POL_NOD_CD,
               BKG.POD_NOD_CD,
               BKG.DEL_NOD_CD,
               BKG.CUST_TO_ORD_FLG,
               VVD.POL_CD,
               VVD.POL_YD_CD,
               VVD.POD_CD,
               VVD.POD_YD_CD,
               CNTR.MEAS_QTY,
               BKG.PRCT_FLG,
               CNTR.DCGO_FLG,
               CNTR.RC_FLG,
               CNTR.AWK_CGO_FLG,
               CNTR.RD_CGO_FLG,
               CNTR.HNGR_FLG,
               DEST_YD_CD,
               ORG_YD_CD,
               CNMV_EVNT_DT
         ORDER BY POL_CD,
               POD_CD,
               CNTR_NO,
               BKG_NO 
        ) T           
    ) TT        
			]]></sql>
			<params>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
