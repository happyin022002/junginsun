<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="AGNCommApprovalDBDAOAddCsrHeaderApInvDtrbInfoCSQL">
			<desc><![CDATA[AP_INV_DTRB에 데이터를 생성한다.

2016.01.15 박다은 ASA Clearing(965113) CSR 생성시 Activity Date 보완
2016.03.31 박다은 DTRB_COA_VVD_CD 의 SERVICE LANE 정보를 ATTR_CTNT14 에 입력.(null 항차의 경우 COM 처리) 
2016.05.30 박다은 INV_AMT 생성 시 MDM_CURRENCY 의 DP_PRCS_KNT 에 따라 round 처리하여 interface.
2016.06.22 박다은 SQL 튜닝
2016.09.19 박다은 [CSR-#18799] Activity Date 변경 - Agent Comm. 은 Sail arrival date 기준, Other Comm. 은 VVD 의 첫번째 loading port 의 ETD 기준]]></desc>
			<sql><![CDATA[
INSERT
      INTO AP_INV_DTRB
         ( 
           CSR_NO,
           LINE_SEQ,
           LINE_NO,
           LINE_TP_LU_CD,
           INV_AMT,
           INV_DESC,
           INV_TAX_CD,
           DTRB_COA_CO_CD,
           DTRB_COA_RGN_CD,
           DTRB_COA_CTR_CD,
           DTRB_COA_ACCT_CD,
           DTRB_COA_VVD_CD,
           DTRB_COA_INTER_CO_CD,
           DTRB_COA_FTU_N1ST_CD,
           DTRB_COA_FTU_N2ND_CD,
           ATTR_CATE_NM,
           ATTR_CTNT1,
           ATTR_CTNT2,
           ATTR_CTNT3,
           ATTR_CTNT4,
           ATTR_CTNT5,
           ATTR_CTNT6,
           ATTR_CTNT7,
           ATTR_CTNT8,
           ATTR_CTNT9,
           ATTR_CTNT10,
           ATTR_CTNT11,
           ATTR_CTNT12,
           ATTR_CTNT13,
           ATTR_CTNT14,
           ATTR_CTNT15,
           BKG_NO,
           CNTR_TPSZ_CD,
           ACT_VVD_CD,
           PLN_SCTR_DIV_CD,
           SO_CRR_CD,
           YD_CD,
           FTU_USE_CTNT1,
           FTU_USE_CTNT2,
           FTU_USE_CTNT3,
           FTU_USE_CTNT4,
           FTU_USE_CTNT5,
           EAI_EVNT_DT,
           CRE_USR_ID,
           CRE_DT
         )
    SELECT
           Y.CSR_NO,
           ROW_NUMBER() OVER (ORDER BY X.ATT1, X.CMPY, X.REGION, X.CENTER, X.ACCT, X.VVD) AS LINE_SEQ,
           DENSE_RANK() OVER (ORDER BY X.ATT1, X.CMPY, X.REGION, X.CENTER, X.ACCT, X.VVD, X.ATT7) AS LINE_NUMBER,
           X.LOOKUP,
           X.INV_AMT,
           X.INV_DESC,
           X.TAX_CD,
           X.CMPY,
           X.REGION,
           X.CENTER,
           X.ACCT,
           X.VVD,
           X.INTR_CMPY,
           X.FUTR1,
           X.FUTR2,
           X.ATT_CTLG,
           X.ATT1,
           X.ATT2,
           X.ATT3,
           X.ATT4,
           X.ATT5,
           X.ATT6,
           X.ATT7,
           X.ATT8,
           X.ATT9,
           X.ATT10,
           X.ATT11,
           X.ATT12,
           X.ATT13,
           X.ATT14,
           X.ATT15,
           X.BKG_NO,
           X.TPSZ,
           X.REV_VVD,
           X.DIV_CD,
           X.CARRIER,
           X.YARD,
           X.COST_CODE,
           X.QTY,
           X.TMNL_CD,
           X.AGNT,
           X.SUB_FLG,
           SYSDATE                                                                       AS EAI_EVNT_DT,
           @[cre_usr_id]                                                                 AS CRE_USR_ID,
           SYSDATE                                                                       AS CRE_DT
      FROM
         ( /* General */
               
               
               SELECT
                      A.VNDR_SEQ AS VNDR,
                      'ITEM' AS LOOKUP,
                    ROUND(NVL(B.PAY_IF_DTRB_AMT, A.PAY_IF_AMT), M.DP_PRCS_KNT)             AS INV_AMT,
                    (     SELECT
                                 SUBSTR (ACCT_ENG_NM, 1, 39)
                            FROM MDM_ACCOUNT
                           WHERE ACCT_CD = A.COMM_STND_COST_CD
                    )
                   || ' '
                   /*|| SUBSTR (TRIM (A.OTR_COMM_ACCT_CTNT), 1, 200)*/                   AS INV_DESC,
                      ''                                                                 AS TAX_CD,
                      '01'  AS CMPY,
                    (     SELECT
                                 NVL(MAX(FINC_RGN_CD), '00')
                            FROM MDM_ORGANIZATION
                           WHERE OFC_CD = A.AP_OFC_CD
                    )                                                                    AS REGION,
                    (     SELECT
                                 AP_CTR_CD
                            FROM MDM_ORGANIZATION
                           WHERE OFC_CD = A.AP_OFC_CD
                    )                                                                    AS CENTER,
                      A.COMM_STND_COST_CD ACCT,
                    (     SELECT
                            CASE SUBSTR(REV_VVD_CD, 0, 2)
                            WHEN 'FD'
                            THEN 'CFDR'||SUBSTR(REV_VVD_CD, 3, 4)||'EE'
                            ELSE REV_VVD_CD
                             END
                            FROM ACM_AGN_BKG_INFO
                           WHERE BKG_NO = A.BKG_NO
                    )                                                                    AS VVD,
                    (     SELECT NVL(LTRIM(SUBS_CO_CD), '00')
                            FROM MDM_VENDOR
                           WHERE VNDR_SEQ = A.VNDR_SEQ
                    )                                                                    AS INTR_CMPY,
                      '000000'                                                           AS FUTR1,
                      '000000'                                                           AS FUTR2,
                      A.COMM_STND_COST_CD                                                AS ATT_CTLG,
                      A.AUD_NO                                                           AS ATT1,--NVL(A.INV_NO, A.AUD_NO)
                      SUBSTR(@[gl_dt], 0, 4)
                   || '/'
                   || SUBSTR(@[gl_dt], 5, 2)
                   || '/'
                   || SUBSTR(@[gl_dt], 7, 2)
                   || ' 00:00:00'                                                        AS ATT2,
                      A.AC_OCCR_INFO_CD                                                	 AS ATT3,
                      ''                                                                 AS ATT4,
                      ''                                                                 AS ATT5,
                      SAC_TRUNK_VVD_RLANE_FNC(A.BKG_NO)                                  AS ATT6, -- Revenue Lane
                      SAC_TRUNK_VVD_TRD_FNC(A.BKG_NO)                                    AS ATT7, -- Trade Code
                      ''                                                                 AS ATT8,
                      ''                                                                 AS ATT9,
                      ''                                                                 AS ATT10,
                      A.SAIL_ARR_DT                                                      AS ATT11, --Activity Date
                      A.AR_OFC_CD                                                        AS ATT12, --Activity Place 
                      ''                                                                 AS ATT13,
                      (SELECT MAX(SLAN_CD) 
                                FROM AR_MST_REV_VVD
                               WHERE 1=1
                                 --AND VSL_CD||SKD_VOY_NO||SKD_DIR_CD||RLANE_DIR_CD  
                                 AND (VSL_CD,SKD_VOY_NO,SKD_DIR_CD,RLANE_DIR_CD)
                                         IN  
                                 (     SELECT
                                    --CASE SUBSTR(REV_VVD_CD, 0, 2)
                                    --WHEN 'FD'
                                    --THEN 'CFDR'||SUBSTR(REV_VVD_CD, 3, 4)||'EE'
                                    --ELSE REV_VVD_CD
                                    -- END
                                 CASE WHEN SUBSTR(REV_VVD_CD, 1, 2) = 'FD' THEN 'CFDR' ELSE SUBSTR(REV_VVD_CD, 1, 4) END AS VSL_CD
                               , CASE WHEN SUBSTR(REV_VVD_CD, 1, 2) = 'FD' THEN SUBSTR(REV_VVD_CD, 3, 4) ELSE SUBSTR(REV_VVD_CD, 5, 4) END AS SKD_VOY_NO
                               , CASE WHEN SUBSTR(REV_VVD_CD, 1, 2) = 'FD' THEN 'E' ELSE SUBSTR(REV_VVD_CD, 9, 1) END AS SKD_DIR_CD
                               , CASE WHEN SUBSTR(REV_VVD_CD, 1, 2) = 'FD' THEN 'E' ELSE SUBSTR(REV_VVD_CD, 10, 1) END AS RLANE_DIR_CD
                            FROM ACM_AGN_BKG_INFO
                           WHERE BKG_NO = A.BKG_NO
                    )                              
                                                                                                                                          )  AS ATT14, --Service Lane

                      ''                                                                 AS ATT15,
                      A.BKG_NO,
                      B.CNTR_TPSZ_CD                                                     AS TPSZ,
                 CASE A.AC_SLAN_CD||SUBSTR(A.AC_VSL_CD, 0, 2)
                 WHEN 'RBCFD'
                 THEN 'CFDR'
                   || SUBSTR (A.AC_VSL_CD, 3, 2)
                   || SUBSTR (AC_SKD_VOY_NO, 0, 2)
                   || 'EE'
                 ELSE A.AC_VSL_CD
                   || A.AC_SKD_VOY_NO
                   || A.AC_SKD_DIR_CD
                   || NVL(A.AC_REV_DIR_CD, A.AC_SKD_DIR_CD)
                  END                                                                    AS REV_VVD,
                      'C'                                                                AS DIV_CD,
                      ''                                                                 AS CARRIER,
                      ''                                                                 AS YARD,
                      ''                                                                 AS COST_CODE,
                      B.BKG_VOL_QTY QTY,
                      ''                                                                 AS TMNL_CD,
                      A.AGN_CD AGNT,
                      A.OFC_CHR_CD                                                       AS SUB_FLG,
                      A.CSR_NO                                                           AS CSR_NO
                 FROM ACM_AGN_COMM     A,
                      ACM_AGN_COMM_DTL B,
                      MDM_CURRENCY     M
                WHERE A.AR_OFC_CD         = @[ar_ofc_cd]
                  AND A.AGN_CD            = @[agn_cd]
                  AND A.IF_DT         IS NULL
                  AND A.AC_STS_CD  = 'AS'
				#if(${aud_no} != '')
                  AND A.AUD_NO
                   IN
                   (
                      ${aud_no}
                   )
				#end
                  AND A.AUD_NO     IS NOT NULL
                  AND A.BKG_NO            = B.BKG_NO(+)
                  AND A.AGN_CD            = B.AGN_CD(+)
                  AND A.IO_BND_CD         = B.IO_BND_CD(+)
                  AND A.AC_TP_CD          = B.AC_TP_CD(+)
                  --AND A.AC_SEQ            = B.AC_SEQ(+)
                  AND B.AC_SEQ  IN (A.AC_SEQ, A.AC_SEQ+1000)
                  AND M.CURR_CD           = A.CURR_CD
                  AND M.DELT_FLG          = 'N' 
            UNION ALL /* 상계정산 대리점 */
               SELECT
                      A.VNDR_SEQ AS VNDR,
                      'ITEM' AS LOOKUP,

                    SUM (-ROUND(NVL(B.PAY_IF_DTRB_AMT, A.PAY_IF_AMT), M.DP_PRCS_KNT))     AS INV_AMT,
                    (     SELECT
                                 SUBSTR (ACCT_ENG_NM, 1, 39)
                            FROM MDM_ACCOUNT
                           WHERE ACCT_CD = '954113'
                    )
                   || ' '
                   /*|| SUBSTR (TRIM (A.OTR_COMM_ACCT_CTNT), 1, 200)*/                   AS INV_DESC,
                      ''                                                                 AS TAX_CD,
                      '01'                                                               AS CMPY,
                    (     SELECT
                                 NVL(MAX(FINC_RGN_CD), '00')
                            FROM MDM_ORGANIZATION
                           WHERE OFC_CD = A.AP_OFC_CD
                    )                                                                    AS REGION,
                    (     SELECT
                                 AP_CTR_CD
                            FROM MDM_ORGANIZATION
                           WHERE OFC_CD = A.AP_OFC_CD
                    )                                                                    AS CENTER,
                      '954113'                                                           AS ACCT,
                      '0000000000'                                                       AS VVD,
                    (     SELECT NVL(LTRIM(SUBS_CO_CD), '00')
                            FROM MDM_VENDOR
                           WHERE VNDR_SEQ = A.VNDR_SEQ
                    )                                                                    AS INTR_CMPY,
                      '000000'                                                           AS FUTR1,
                      '000000'                                                           AS FUTR2,
                      '954113' AS ATT_CTLG,
                      A.AUD_NO                                                           AS ATT1,
                      SUBSTR(@[gl_dt], 0, 4)
                   || '/'
                   || SUBSTR(@[gl_dt], 5, 2)
                   || '/'
                   || SUBSTR(@[gl_dt], 7, 2)
                   || ' 00:00:00'                                                        AS ATT2,
                      A.AC_OCCR_INFO_CD                                                  AS ATT3,
                      ''                                                                 AS ATT4,
                      ''                                                                 AS ATT5,
                      ''                                                                 AS ATT6,
                      ''                                                                 AS ATT7,
                      ''                                                                 AS ATT8,
                      ''                                                                 AS ATT9,
                      ''                                                                 AS ATT10,
					(SELECT ASA_PRD_TO_DT 
   					   FROM SAR_ASA_MST
					  WHERE ASA_NO = @[asa_no])                                          AS ATT11, --Activity Date
                      A.AR_OFC_CD                                                        AS ATT12, --Activity Place 
                      ''                                                                 AS ATT13,
                      'COM'                                                       		 AS ATT14, --Service Lane
                      ''                                                                 AS ATT15,
                      ''                                                                 AS BKG_NO,
                      ''                                                                 AS TPSZ,
                      ''                                                                 AS REV_VVD,
                      ''                                                                 AS DIV_CD,
                      ''                                                                 AS CARRIER,
                      ''                                                                 AS YARD,
                      ''                                                                 AS COST_CODE,
                      0                                                                  AS QTY,
                      ''                                                                 AS TMNL_CD,
                      A.AGN_CD                                                           AS AGNT,
                      A.OFC_CHR_CD                                                       AS SUB_FLG,
                      A.CSR_NO                                                           AS CSR_NO
                 FROM ACM_AGN_COMM     A,
                      ACM_AGN_COMM_DTL B,
                      MDM_CURRENCY     M
                WHERE A.AR_OFC_CD         = @[ar_ofc_cd]
                  AND A.AGN_CD            = @[agn_cd]
                  AND A.IF_DT         IS NULL
                  AND A.AC_STS_CD  = 'AS'
				#if(${aud_no} != '')
                  AND A.AUD_NO
                   IN
                    (
                      ${aud_no}
                    )
				#end
                  AND A.AUD_NO     IS NOT NULL
                  AND 'O'
                   IN
                    (     SELECT
                                 SO_IF_CD
                            FROM MDM_ORGANIZATION
                           WHERE OFC_CD = A.AGN_CD
                    )
                  AND A.BKG_NO            = B.BKG_NO(+)
                  AND A.AGN_CD            = B.AGN_CD(+)
                  AND A.IO_BND_CD         = B.IO_BND_CD(+)
                  AND A.AC_TP_CD          = B.AC_TP_CD(+)
                  AND B.AC_SEQ  IN (A.AC_SEQ, A.AC_SEQ+1000)
                  AND M.CURR_CD           = A.CURR_CD
                  AND M.DELT_FLG          = 'N' 
             GROUP BY A.VNDR_SEQ,
                      A.AP_OFC_CD,
                      A.AUD_NO,
                      A.AC_OCCR_INFO_CD,
                      A.AGN_CD,
                      A.OFC_CHR_CD,
                      A.CSR_NO,
                      A.AR_OFC_CD,
                      A.AC_SLAN_CD
                      --,A.OTR_COMM_ACCT_CTNT
            UNION ALL /* VAT */
               SELECT
                      A.VNDR_SEQ                                                         AS VNDR,
                      'ITEM'                                                             AS LOOKUP,
                      ROUND (SUM (NVL (B.PAY_IF_DTRB_AMT*NVL(A.INV_TAX_RT, 0)/100, A.PAY_IF_AMT*NVL (A.INV_TAX_RT, 0)/100)), M.DP_PRCS_KNT) AS INV_AMT,
                      A.AUD_NO
                   || ' '
                   /*|| A.OTR_COMM_ACCT_CTNT*/                                           AS INV_DESC,
                      ''                                                           		 AS TAX_CD,
                      '01'                                                               AS company,
                      @[finc_rgn_cd]                                                     AS REGION,
                      @[ap_ctr_cd]                                                       AS CENTER,
                      '111821'                                                           AS ACCT,
                      '0000000000'                                                       AS VVD,
                    (     SELECT
                                 NVL(LTRIM(SUBS_CO_CD), '00')
                            FROM MDM_VENDOR
                           WHERE VNDR_SEQ = A.VNDR_SEQ
                    )                                                                    AS INTR_CMPY,
                      '000000'                                                           AS FUTURE1,
                      '000000'                                                           AS FUTURE2,
                      '111821'                                                           AS ATT_CTLG,
                      A.AUD_NO                                        		             AS ATT1,--NVL (A.INV_NO, A.AUD_NO)
                      SUBSTR (@[gl_dt], 0, 4)
                   || '/'
                   || SUBSTR (@[gl_dt], 5, 2)
                   || '/'
                   || SUBSTR (@[gl_dt], 7, 2)
                   || ' 00:00:00'                                                        AS ATT2,
                      A.AC_OCCR_INFO_CD                                                  AS ATT3,
                      ''                                                                 AS ATT4,
                      ''                                                                 AS ATT5,
                      ''                                                                 AS ATT6,
                      ''                                                                 AS ATT7,
                      ''                                                                 AS ATT8,
                      ''                                                                 AS ATT9,
                      ''                                                                 AS ATT10,
                      NVL(@[gl_dt], A.SAIL_ARR_DT)                                       AS ATT11, --Activity Date
                      A.AR_OFC_CD                                                        AS ATT12, --Activity Place 
                      ''                                                                 AS ATT13,
                      'COM'                                                       		 AS ATT14, --Service Lane
                      ''                                                                 AS ATT15,
                      ''                                                                 AS BKG_NO,
                      ''                                                                 AS TPSZ,
                      '0000000000'                                                       AS REV_VVD,
                      'C'                                                                AS DIV_CD,
                      ''                                                                 AS CARRIER,
                      ''                                                                 AS YARD,
                      ''                                                                 AS COST_CODE,
                      0                                                                  AS QTY,
                      ''                                                                 AS TMNL_CD,
                      A.AGN_CD AGNT,
                      A.OFC_CHR_CD SUB_FLG,
                      A.CSR_NO CSR_NO
                 FROM ACM_AGN_COMM A,
                      ACM_AGN_COMM_DTL B,
                      MDM_CURRENCY M
                WHERE A.AR_OFC_CD         = @[ar_ofc_cd]
                  AND A.AGN_CD            = @[agn_cd]
                  AND (SELECT SUBSTR(LOC_CD, 1, 2)  
  						 FROM MDM_ORGANIZATION M 
						WHERE M.OFC_CD = A.AR_OFC_CD) <> 'JP' 
                  AND A.IF_DT         IS NULL
                  AND A.AC_STS_CD  = 'AS'
				#if(${aud_no} != '')
                  AND A.AUD_NO
                   IN
                    (
                      ${aud_no}
                    )
				#end
                  AND A.AUD_NO     IS NOT NULL
                  AND A.INV_TAX_RT       >  0
                  AND A.BKG_NO            = B.BKG_NO(+)
                  AND A.AGN_CD            = B.AGN_CD(+)
                  AND A.IO_BND_CD         = B.IO_BND_CD(+)
                  AND A.AC_TP_CD          = B.AC_TP_CD(+)
                  AND B.AC_SEQ  IN (A.AC_SEQ, A.AC_SEQ+1000)
                  AND A.CURR_CD           = M.CURR_CD
                  AND M.DELT_FLG          = 'N'      
             GROUP BY A.CURR_CD,
                      M.DP_PRCS_KNT,
                      VNDR_SEQ,
                      A.AUD_NO,--NVL (A.INV_NO, A.AUD_NO),
                      --A.OTR_COMM_ACCT_CTNT,
                      TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC('KRPUS', SYSDATE, A.AC_OCCR_INFO_CD), 'YYYYMMDD'),
                      A.AC_OCCR_INFO_CD,
                      A.AGN_CD,
                      A.OFC_CHR_CD,
                      A.CSR_NO,
                      A.AR_OFC_CD,
                      A.AC_SLAN_CD,
                      A.SAIL_ARR_DT
               HAVING SUM (NVL (B.PAY_IF_DTRB_AMT*A.INV_TAX_RT, A.IF_AMT*A.INV_TAX_RT)) <> 0
            UNION ALL /* VAT JP*/
               SELECT
                      A.VNDR_SEQ                                                         AS VNDR,
                      'TAX'                                                             AS LOOKUP,
                      ROUND (SUM (NVL (B.PAY_IF_DTRB_AMT*NVL(A.INV_TAX_RT, 0)/100, A.PAY_IF_AMT*NVL (A.INV_TAX_RT, 0)/100)), M.DP_PRCS_KNT) AS INV_AMT,  
                      A.AUD_NO
                   || ' '
                   /*|| A.OTR_COMM_ACCT_CTNT*/                                           AS INV_DESC,
                      'E3'                                                           	 AS TAX_CD,
                      '01'                                                               AS company,
                      @[finc_rgn_cd]                                                     AS REGION,
                      @[ap_ctr_cd]                                                       AS CENTER,
                      '111811'                                                           AS ACCT,
                      '0000000000'                                                       AS VVD,
                    (     SELECT
                                 NVL(LTRIM(SUBS_CO_CD), '00')
                            FROM MDM_VENDOR
                           WHERE VNDR_SEQ = A.VNDR_SEQ
                    )                                                                    AS INTR_CMPY,
                      '000000'                                                           AS FUTURE1,
                      '000000'                                                           AS FUTURE2,
                      '111811'                                                           AS ATT_CTLG,
                      A.AUD_NO                                        		             AS ATT1,--NVL (A.INV_NO, A.AUD_NO)
                      SUBSTR (@[gl_dt], 0, 4)
                   || '/'
                   || SUBSTR (@[gl_dt], 5, 2)
                   || '/'
                   || SUBSTR (@[gl_dt], 7, 2)
                   || ' 00:00:00'                                                        AS ATT2,
                      A.AC_OCCR_INFO_CD                                                  AS ATT3,
                      ''                                                                 AS ATT4,
                      ''                                                                 AS ATT5,
                      ''                                                                 AS ATT6,
                      ''                                                                 AS ATT7,
                      ''                                                                 AS ATT8,
                      ''                                                                 AS ATT9,
                      ''                                                                 AS ATT10,
                      NVL(@[gl_dt], A.SAIL_ARR_DT)                                       AS ATT11, --Activity Date
                      A.AR_OFC_CD                                                        AS ATT12, --Activity Place 
                      ''                                                                 AS ATT13,
                      'COM'                                                       		 AS ATT14, --Service Lane
                      ''                                                                 AS ATT15,
                      ''                                                                 AS BKG_NO,
                      ''                                                                 AS TPSZ,
                      '0000000000'                                                       AS REV_VVD,
                      'C'                                                                AS DIV_CD,
                      ''                                                                 AS CARRIER,
                      ''                                                                 AS YARD,
                      ''                                                                 AS COST_CODE,
                      0                                                                  AS QTY,
                      ''                                                                 AS TMNL_CD,
                      A.AGN_CD AGNT,
                      A.OFC_CHR_CD SUB_FLG,
                      A.CSR_NO CSR_NO
                 FROM ACM_AGN_COMM A,
                      ACM_AGN_COMM_DTL B,
                      MDM_CURRENCY  M
                WHERE A.AR_OFC_CD         = @[ar_ofc_cd]
                  AND A.AGN_CD            = @[agn_cd]
                  AND (SELECT SUBSTR(LOC_CD, 1, 2)  
  						 FROM MDM_ORGANIZATION M 
						WHERE M.OFC_CD = A.AR_OFC_CD) = 'JP' 
                  AND A.IF_DT         IS NULL
                  AND A.AC_STS_CD  = 'AS'
				#if(${aud_no} != '')
                  AND A.AUD_NO
                   IN
                    (
                      ${aud_no}
                    )
				#end
                  AND A.AUD_NO     IS NOT NULL
                  AND A.INV_TAX_RT       >  0
                  AND A.BKG_NO            = B.BKG_NO(+)
                  AND A.AGN_CD            = B.AGN_CD(+)
                  AND A.IO_BND_CD         = B.IO_BND_CD(+)
                  AND A.AC_TP_CD          = B.AC_TP_CD(+)
                  AND B.AC_SEQ  IN (A.AC_SEQ, A.AC_SEQ+1000)
                  AND A.CURR_CD           = M.CURR_CD
                  AND M.DELT_FLG          = 'N'   
             GROUP BY A.CURR_CD,
                      M.DP_PRCS_KNT,
                      VNDR_SEQ,
                      A.AUD_NO,--NVL (A.INV_NO, A.AUD_NO),
                      --A.OTR_COMM_ACCT_CTNT,
                      TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC('KRPUS', SYSDATE, A.AC_OCCR_INFO_CD), 'YYYYMMDD'),
                      A.AC_OCCR_INFO_CD,
                      A.AGN_CD,
                      A.OFC_CHR_CD,
                      A.CSR_NO,
                      A.AR_OFC_CD,
                      A.AC_SLAN_CD,
                      A.SAIL_ARR_DT
               HAVING SUM (NVL (B.PAY_IF_DTRB_AMT*A.INV_TAX_RT, A.IF_AMT*A.INV_TAX_RT)) <> 0         

         UNION ALL

          /* OTHER COMM */

               SELECT
                      A.VNDR_SEQ AS VNDR,
                      'ITEM' AS LOOKUP,
                    ROUND(NVL(A.PAY_IF_AMT, A.IF_AMT), M.DP_PRCS_KNT)                      AS INV_AMT,
                    (     SELECT
                                 SUBSTR (ACCT_ENG_NM, 1, 39)
                            FROM MDM_ACCOUNT
                           WHERE ACCT_CD = A.COMM_STND_COST_CD
                    )
                   || ' '
                   || SUBSTR (TRIM (A.OTR_COMM_RMK), 1, 200)                   			 AS INV_DESC,
                      ''                                                                 AS TAX_CD,
                      '01'  AS CMPY,
                    (     SELECT
                                 NVL(MAX(FINC_RGN_CD), '00')
                            FROM MDM_ORGANIZATION
                           WHERE OFC_CD = A.AP_OFC_CD
                    )                                                                    AS REGION,
                    (     SELECT
                                 AP_CTR_CD
                            FROM MDM_ORGANIZATION
                           WHERE OFC_CD = A.AP_OFC_CD
                    )                                                                    AS CENTER,
                      A.COMM_STND_COST_CD ACCT,
                    (     SELECT
                            CASE SUBSTR(C.AC_VSL_CD, 0, 2)
                            WHEN 'FD'
                            THEN 'CFDR'||SUBSTR(C.AC_VSL_CD, 3, 4)||'EE'
                            ELSE C.AC_VSL_CD||C.AC_SKD_VOY_NO||C.AC_SKD_DIR_CD||NVL(C.AC_REV_DIR_CD, C.AC_SKD_DIR_CD)
                             END
                            FROM ACM_AGN_OTR_COMM C
                           WHERE C.OTR_COMM_NO = A.OTR_COMM_NO
                    )                                                                    AS VVD,
                    (     SELECT NVL(LTRIM(SUBS_CO_CD), '00')
                            FROM MDM_VENDOR
                           WHERE VNDR_SEQ = A.VNDR_SEQ
                    )                                                                    AS INTR_CMPY,
                      '000000'                                                           AS FUTR1,
                      '000000'                                                           AS FUTR2,
                      A.COMM_STND_COST_CD                                                AS ATT_CTLG,
                      A.AUD_NO                                                           AS ATT1,--NVL(A.INV_NO, A.AUD_NO)
                      SUBSTR(@[gl_dt], 0, 4)
                   || '/'
                   || SUBSTR(@[gl_dt], 5, 2)
                   || '/'
                   || SUBSTR(@[gl_dt], 7, 2)
                   || ' 00:00:00'                                                        AS ATT2,
                      A.AC_OCCR_INFO_CD                                                AS ATT3,
                      ''                                                                 AS ATT4,
                      ''                                                                 AS ATT5,
                      ''                                                                 AS ATT6,
                      ''                                                                 AS ATT7,
                      ''                                                                 AS ATT8,
                      ''                                                                 AS ATT9,
                      ''                                                                 AS ATT10,
                      ( SELECT TO_CHAR(MIN(VPS_ETD_DT), 'YYYYMMDD')
                          FROM ACM_AGN_OTR_COMM AOC
                             , VSK_VSL_PORT_SKD SKD
                         WHERE 1=1
                           and AOC.AGN_CD = A.AGN_CD
                           AND AOC.OTR_COMM_NO = A.OTR_COMM_NO
                           AND AOC.AC_VSL_CD      = SKD.VSL_CD
                           AND AOC.AC_SKD_VOY_NO  = SKD.SKD_VOY_NO
                           AND AOC.AC_SKD_DIR_CD  = SKD.SKD_DIR_CD
                           AND NVL(SKD.SKD_CNG_STS_CD,'*') <> 'S'   
                           AND SKD.TURN_PORT_IND_CD IN ('Y','N')
                         GROUP BY VSL_CD, SKD_VOY_NO, SKD_DIR_CD  )                      AS ATT11, --Activity Date
                      A.AR_OFC_CD                                                        AS ATT12, --Activity Place 
                      ''                                                                 AS ATT13,

					  (SELECT MAX(SLAN_CD) 
                         FROM AR_MST_REV_VVD
                        WHERE 1=1
                          --AND VSL_CD||SKD_VOY_NO||SKD_DIR_CD||RLANE_DIR_CD IN
                          AND (VSL_CD,SKD_VOY_NO,SKD_DIR_CD,RLANE_DIR_CD) IN
                    (     SELECT
                            --CASE SUBSTR(C.AC_VSL_CD, 0, 2)
                            --WHEN 'FD'
                            --THEN 'CFDR'||SUBSTR(C.AC_VSL_CD, 3, 4)||'EE'
                            --ELSE C.AC_VSL_CD||C.AC_SKD_VOY_NO||C.AC_SKD_DIR_CD||NVL(C.AC_REV_DIR_CD, C.AC_SKD_DIR_CD)
                            -- END
                                 CASE WHEN SUBSTR(C.AC_VSL_CD, 1, 2) = 'FD' THEN 'CFDR' ELSE C.AC_VSL_CD END AS VSL_CD
                               , CASE WHEN SUBSTR(C.AC_VSL_CD, 1, 2) = 'FD' THEN SUBSTR(C.AC_VSL_CD, 3, 4) ELSE C.AC_SKD_VOY_NO END AS SKD_VOY_NO
                               , CASE WHEN SUBSTR(C.AC_VSL_CD, 1, 2) = 'FD' THEN 'E' ELSE C.AC_SKD_DIR_CD END AS SKD_DIR_CD
                               , CASE WHEN SUBSTR(C.AC_VSL_CD, 1, 2) = 'FD' THEN 'E' ELSE NVL(C.AC_REV_DIR_CD, C.AC_SKD_DIR_CD) END AS RLANE_DIR_CD
                            FROM ACM_AGN_OTR_COMM C
                           WHERE C.OTR_COMM_NO = A.OTR_COMM_NO
                    )  
                                                                                                                                          )   AS ATT14, --Service Lane

                      ''                                                                 AS ATT15,
                      A.OTR_COMM_NO,
                      'BX'                                                     AS TPSZ,
                 CASE A.AC_SLAN_CD||SUBSTR(A.AC_VSL_CD, 0, 2)
                 WHEN 'RBCFD'
                 THEN 'CFDR'
                   || SUBSTR (A.AC_VSL_CD, 3, 2)
                   || SUBSTR (AC_SKD_VOY_NO, 0, 2)
                   || 'EE'
                 ELSE A.AC_VSL_CD
                   || A.AC_SKD_VOY_NO
                   || A.AC_SKD_DIR_CD
                   || NVL(A.AC_REV_DIR_CD, A.AC_SKD_DIR_CD)
                  END                                                                    AS REV_VVD,
                      'C'                                                                AS DIV_CD,
                      ''                                                                 AS CARRIER,
                      ''                                                                 AS YARD,
                      ''                                                                 AS COST_CODE,
                      1 QTY,
                      ''                                                                 AS TMNL_CD,
                      A.AGN_CD AGNT,
                      A.OFC_CHR_CD                                                       AS SUB_FLG,
                      A.CSR_NO                                                           AS CSR_NO
                 FROM ACM_AGN_OTR_COMM     A,
                      MDM_CURRENCY         M
                WHERE A.AR_OFC_CD         = @[ar_ofc_cd]
                  AND A.AGN_CD            = @[agn_cd]
                  AND A.IF_DT         IS NULL
                  AND A.AC_STS_CD  = 'AS'
				#if(${aud_no} != '')
                  AND A.AUD_NO 
                   IN
                    (
                      ${aud_no}
                    )
				#end
                  AND A.AUD_NO     IS NOT NULL
				  AND A.CURR_CD     = M.CURR_CD
				  AND M.DELT_FLG    = 'N'    
            UNION ALL /* 상계정산 대리점 */
               SELECT
                      A.VNDR_SEQ AS VNDR,
                      'ITEM' AS LOOKUP,
                    SUM (-ROUND(NVL(A.PAY_IF_AMT, A.IF_AMT), M.DP_PRCS_KNT))               AS INV_AMT,
                    (     SELECT
                                 SUBSTR (ACCT_ENG_NM, 1, 39)
                            FROM MDM_ACCOUNT
                           WHERE ACCT_CD = '954113'
                    )
                   || ' '
                   || SUBSTR (TRIM (A.OTR_COMM_RMK), 1, 200)                   AS INV_DESC,
                      ''                                                                 AS TAX_CD,
                      '01'                                                               AS CMPY,
                    (     SELECT
                                 NVL(MAX(FINC_RGN_CD), '00')
                            FROM MDM_ORGANIZATION
                           WHERE OFC_CD = A.AP_OFC_CD
                    )                                                                    AS REGION,
                    (     SELECT
                                 AP_CTR_CD
                            FROM MDM_ORGANIZATION
                           WHERE OFC_CD = A.AP_OFC_CD
                    )                                                                    AS CENTER,
                      '954113'                                                           AS ACCT,
                      '0000000000'                                                       AS VVD,
                    (     SELECT NVL(LTRIM(SUBS_CO_CD), '00')
                            FROM MDM_VENDOR
                           WHERE VNDR_SEQ = A.VNDR_SEQ
                    )                                                                    AS INTR_CMPY,
                      '000000'                                                           AS FUTR1,
                      '000000'                                                           AS FUTR2,
                      '954113' AS ATT_CTLG,
                      A.AUD_NO                                                           AS ATT1,
                      SUBSTR(@[gl_dt], 0, 4)
                   || '/'
                   || SUBSTR(@[gl_dt], 5, 2)
                   || '/'
                   || SUBSTR(@[gl_dt], 7, 2)
                   || ' 00:00:00'                                                        AS ATT2,
                      A.AC_OCCR_INFO_CD                                                  AS ATT3,
                      ''                                                                 AS ATT4,
                      ''                                                                 AS ATT5,
                      ''                                                                 AS ATT6,
                      ''                                                                 AS ATT7,
                      ''                                                                 AS ATT8,
                      ''                                                                 AS ATT9,
                      ''                                                                 AS ATT10,
					(SELECT ASA_PRD_TO_DT 
   					   FROM SAR_ASA_MST
					  WHERE ASA_NO = @[asa_no])                                          AS ATT11, --Activity Date
                      A.AR_OFC_CD                                                        AS ATT12, --Activity Place 
                      ''                                                                 AS ATT13,
                      'COM'                                                       		 AS ATT14, --Service Lane
                      ''                                                                 AS ATT15,
                      ''                                                                 AS BKG_NO,
                      ''                                                                 AS TPSZ,
                      ''                                                                 AS REV_VVD,
                      ''                                                                 AS DIV_CD,
                      ''                                                                 AS CARRIER,
                      ''                                                                 AS YARD,
                      ''                                                                 AS COST_CODE,
                      0                                                                  AS QTY,
                      ''                                                                 AS TMNL_CD,
                      A.AGN_CD                                                           AS AGNT,
                      A.OFC_CHR_CD                                                      AS SUB_FLG,
                      A.CSR_NO                                                           AS CSR_NO
                 FROM ACM_AGN_OTR_COMM     A,
                      MDM_CURRENCY         M
                WHERE A.AR_OFC_CD         = @[ar_ofc_cd]
                  AND A.AGN_CD            = @[agn_cd]
                  AND A.IF_DT         IS NULL
                  AND A.AC_STS_CD  = 'AS'
				#if(${aud_no} != '')
                  AND A.AUD_NO 
                   IN
                    (
                      ${aud_no}
                    )
				#end
                  AND A.AUD_NO     IS NOT NULL
                  AND 'O'
                   IN
                    (     SELECT
                                 SO_IF_CD
                            FROM MDM_ORGANIZATION
                           WHERE OFC_CD = A.AGN_CD
                    )
                  AND A.CURR_CD = M.CURR_CD
                  AND M.DELT_FLG = 'N'  
             GROUP BY A.VNDR_SEQ,
                      A.AP_OFC_CD,
                      A.AUD_NO,
                      A.AC_OCCR_INFO_CD,
                      A.AGN_CD,
                      A.OFC_CHR_CD,
                      A.CSR_NO,
                      A.OTR_COMM_RMK,
                      A.AR_OFC_CD,
                      A.AC_SLAN_CD
            UNION ALL /* VAT */
               SELECT
                      A.VNDR_SEQ                                                         AS VNDR,
                      'ITEM'                                                             AS LOOKUP,
                      ROUND (SUM (NVL (A.PAY_IF_AMT*NVL(A.INV_TAX_RT, 0)/100, A.PAY_IF_AMT*NVL (A.INV_TAX_RT, 0)/100)), M.DP_PRCS_KNT) AS INV_AMT, 
                      A.AUD_NO
                   || ' '
                   || A.OTR_COMM_RMK                                           AS INV_DESC,
                      ''                                                           AS TAX_CD,
                      '01'                                                               AS company,
                      @[finc_rgn_cd]                                                       AS REGION,
                      @[ap_ctr_cd]                                                       AS CENTER,
                      '111821'                                                           AS ACCT,
                      '0000000000'                                                       AS VVD,
                    (     SELECT
                                 NVL(LTRIM(SUBS_CO_CD), '00')
                            FROM MDM_VENDOR
                           WHERE VNDR_SEQ = A.VNDR_SEQ
                    )                                                                    AS INTR_CMPY,
                      '000000'                                                           AS FUTURE1,
                      '000000'                                                           AS FUTURE2,
                      '111821'                                                           AS ATT_CTLG,
                      A.AUD_NO                                        		             AS ATT1,--NVL (A.INV_NO, A.AUD_NO)
                      SUBSTR (@[gl_dt], 0, 4)
                   || '/'
                   || SUBSTR (@[gl_dt], 5, 2)
                   || '/'
                   || SUBSTR (@[gl_dt], 7, 2)
                   || ' 00:00:00'                                                        AS ATT2,
                      A.AC_OCCR_INFO_CD                                                  AS ATT3,
                      ''                                                                 AS ATT4,
                      ''                                                                 AS ATT5,
                      ''                                                                 AS ATT6,
                      ''                                                                 AS ATT7,
                      ''                                                                 AS ATT8,
                      ''                                                                 AS ATT9,
                      ''                                                                 AS ATT10,
                      @[gl_dt]                      									 AS ATT11, --Activity Date
                      A.AR_OFC_CD                                                        AS ATT12, --Activity Place 
                      ''                                                                 AS ATT13,
                      'COM'                                                       		 AS ATT14, --Service Lane
                      ''                                                                 AS ATT15,
                      ''                                                                 AS BKG_NO,
                      ''                                                                 AS TPSZ,
                      '0000000000'                                                       AS REV_VVD,
                      'C'                                                                AS DIV_CD,
                      ''                                                                 AS CARRIER,
                      ''                                                                 AS YARD,
                      ''                                                                 AS COST_CODE,
                      0                                                                  AS QTY,
                      ''                                                                 AS TMNL_CD,
                      A.AGN_CD AGNT,
                      A.OFC_CHR_CD SUB_FLG,
                      A.CSR_NO CSR_NO
                 FROM ACM_AGN_OTR_COMM A,
                      MDM_CURRENCY     M
                WHERE A.AR_OFC_CD         = @[ar_ofc_cd]
                  AND A.AGN_CD            = @[agn_cd]
                  AND (SELECT SUBSTR(LOC_CD, 1, 2)  
  						 FROM MDM_ORGANIZATION M 
						WHERE M.OFC_CD = A.AR_OFC_CD) <> 'JP'               
                  AND A.IF_DT         IS NULL
                  AND A.AC_STS_CD  = 'AS'
				#if(${aud_no} != '')
                  AND A.AUD_NO 
                   IN
                    (
                      ${aud_no}
                    )
				#end
                  AND A.AUD_NO     IS NOT NULL
                  AND A.INV_TAX_RT       >  0
                  AND A.CURR_CD = M.CURR_CD
                  AND M.DELT_FLG = 'N'
             GROUP BY A.CURR_CD,
                      M.DP_PRCS_KNT,
                      VNDR_SEQ,
                      A.AUD_NO,--NVL (A.INV_NO, A.AUD_NO),
                      A.OTR_COMM_RMK,
                      TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC('KRPUS', SYSDATE, A.AC_OCCR_INFO_CD), 'YYYYMMDD'),
                      A.AC_OCCR_INFO_CD,
                      A.AGN_CD,
                      A.OFC_CHR_CD,
                      A.CSR_NO,
                      A.AR_OFC_CD,
                      A.AC_SLAN_CD
               HAVING SUM (NVL (A.PAY_IF_AMT*A.INV_TAX_RT, A.IF_AMT*A.INV_TAX_RT)) <> 0
            UNION ALL /* VAT JP*/
               SELECT
                      A.VNDR_SEQ                                                         AS VNDR,
                      'TAX'                                                             AS LOOKUP,
                      ROUND (SUM (NVL (A.PAY_IF_AMT*NVL(A.INV_TAX_RT, 0)/100, A.PAY_IF_AMT*NVL (A.INV_TAX_RT, 0)/100)), M.DP_PRCS_KNT) AS INV_AMT,  
                      A.AUD_NO
                   || ' '
                   || A.OTR_COMM_RMK                                          			 AS INV_DESC,
                      'E3'                                                           	 AS TAX_CD,
                      '01'                                                               AS company,
                      @[finc_rgn_cd]                                                     AS REGION,
                      @[ap_ctr_cd]                                                       AS CENTER,
                      '111811'                                                           AS ACCT,
                      '0000000000'                                                       AS VVD,
                    (     SELECT
                                 NVL(LTRIM(SUBS_CO_CD), '00')
                            FROM MDM_VENDOR
                           WHERE VNDR_SEQ = A.VNDR_SEQ
                    )                                                                    AS INTR_CMPY,
                      '000000'                                                           AS FUTURE1,
                      '000000'                                                           AS FUTURE2,
                      '111811'                                                           AS ATT_CTLG,
                      A.AUD_NO                                        		             AS ATT1,--NVL (A.INV_NO, A.AUD_NO)
                      SUBSTR (@[gl_dt], 0, 4)
                   || '/'
                   || SUBSTR (@[gl_dt], 5, 2)
                   || '/'
                   || SUBSTR (@[gl_dt], 7, 2)
                   || ' 00:00:00'                                                        AS ATT2,
                      A.AC_OCCR_INFO_CD                                                  AS ATT3,
                      ''                                                                 AS ATT4,
                      ''                                                                 AS ATT5,
                      ''                                                                 AS ATT6,
                      ''                                                                 AS ATT7,
                      ''                                                                 AS ATT8,
                      ''                                                                 AS ATT9,
                      ''                                                                 AS ATT10,
                      @[gl_dt]                      									 AS ATT11, --Activity Date
                      A.AR_OFC_CD                                                        AS ATT12, --Activity Place 
                      ''                                                                 AS ATT13,
                      'COM'                                                       		 AS ATT14, --Service Lane
                      ''                                                                 AS ATT15,
                      ''                                                                 AS BKG_NO,
                      ''                                                                 AS TPSZ,
                      '0000000000'                                                       AS REV_VVD,
                      'C'                                                                AS DIV_CD,
                      ''                                                                 AS CARRIER,
                      ''                                                                 AS YARD,
                      ''                                                                 AS COST_CODE,
                      0                                                                  AS QTY,
                      ''                                                                 AS TMNL_CD,
                      A.AGN_CD AGNT,
                      A.OFC_CHR_CD SUB_FLG,
                      A.CSR_NO CSR_NO
                 FROM ACM_AGN_OTR_COMM A,
                      MDM_CURRENCY     M
                WHERE A.AR_OFC_CD         = @[ar_ofc_cd]
                  AND A.AGN_CD            = @[agn_cd]
                  AND (SELECT SUBSTR(LOC_CD, 1, 2)  
  						 FROM MDM_ORGANIZATION M 
						WHERE M.OFC_CD = A.AR_OFC_CD) = 'JP'                
                  AND A.IF_DT         IS NULL
                  AND A.AC_STS_CD  = 'AS'
				#if(${aud_no} != '')
                  AND A.AUD_NO 
                   IN
                    (
                      ${aud_no}
                    )
				#end
                  AND A.AUD_NO     IS NOT NULL
                  AND A.INV_TAX_RT       >  0
                  AND A.CURR_CD = M.CURR_CD
                  AND M.DELT_FLG = 'N'
             GROUP BY A.CURR_CD,
                      M.DP_PRCS_KNT,
                      VNDR_SEQ,
                      A.AUD_NO,--NVL (A.INV_NO, A.AUD_NO),
                      A.OTR_COMM_RMK,
                      TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC('KRPUS', SYSDATE, A.AC_OCCR_INFO_CD), 'YYYYMMDD'),
                      A.AC_OCCR_INFO_CD,
                      A.AGN_CD,
                      A.OFC_CHR_CD,
                      A.CSR_NO,
                      A.AR_OFC_CD,
                      A.AC_SLAN_CD
               HAVING SUM (NVL (A.PAY_IF_AMT*A.INV_TAX_RT, A.IF_AMT*A.INV_TAX_RT)) <> 0               
         ) X,
         (
               SELECT
                      CSR_NO,
                      VNDR_NO 
                 FROM AP_INV_HDR
                WHERE CSR_NO = @[csr_no]
         ) Y
     WHERE X.CSR_NO = Y.CSR_NO
       AND X.VNDR   = Y.VNDR_NO 			]]></sql>
			<params>
				<param name="cre_usr_id" type="12" value="" out="N"/>
				<param name="gl_dt" type="12" value="" out="N"/>
				<param name="ar_ofc_cd" type="12" value="" out="N"/>
				<param name="agn_cd" type="12" value="" out="N"/>
				<param name="asa_no" type="12" value="" out="N"/>
				<param name="finc_rgn_cd" type="12" value="" out="N"/>
				<param name="ap_ctr_cd" type="12" value="" out="N"/>
				<param name="csr_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
