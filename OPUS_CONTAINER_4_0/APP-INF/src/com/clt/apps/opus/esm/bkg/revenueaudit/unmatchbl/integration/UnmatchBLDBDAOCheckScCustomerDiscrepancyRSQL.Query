<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="UnmatchBLDBDAOCheckScCustomerDiscrepancyRSQL">
			<desc><![CDATA[checkScCustomerDiscrepancy]]></desc>
			<sql><![CDATA[
WITH
SC AS
(
/*******************************************************************************************
계약 정보 조회
*******************************************************************************************/
SELECT * FROM (
SELECT  SS.PROP_NO    ,
        SS.AMDT_SEQ   ,
        SS.SVC_SCP_CD
FROM    BKG_BOOKING     BK  ,
        MDM_LOCATION    L1  ,
        MDM_LOCATION    L4  ,
        PRI_SP_HDR      SH  ,
        PRI_SP_MN       SM  ,
        PRI_SP_SCP_MN   SS
WHERE   L1.LOC_CD       = BK.POR_CD
AND     L4.LOC_CD       = BK.DEL_CD
AND     SH.SC_NO        = BK.SC_NO
AND     SM.PROP_NO      = SH.PROP_NO
AND     SM.PROP_STS_CD  = 'F'       -- FILED S/C
AND     SS.PROP_NO      = SM.PROP_NO
AND     SS.AMDT_SEQ     = SM.AMDT_SEQ
AND     SS.SVC_SCP_CD   IN (BK.SVC_SCP_CD)
AND     ( SELECT BKG_REV_APLY_DT_PKG.BKG_GET_REV_APLY_DT_FNC(@[bkg_no], @[ca_flg]) FROM DUAL )
        BETWEEN SS.EFF_DT AND SS.EXP_DT
AND     BK.BKG_NO       = @[bkg_no]
AND     @[ca_flg]       = 'N'
ORDER BY DECODE(SS.SVC_SCP_CD,'ACE',1,'MXE',2,'TPE',3)
)
WHERE ROWNUM = 1

UNION ALL

SELECT * FROM (
SELECT  SS.PROP_NO    ,
        SS.AMDT_SEQ   ,
        SS.SVC_SCP_CD
FROM    BKG_BKG_HIS     BK  ,
        MDM_LOCATION    L1  ,
        MDM_LOCATION    L4  ,
        PRI_SP_HDR      SH  ,
        PRI_SP_MN       SM  ,
        PRI_SP_SCP_MN   SS
WHERE   L1.LOC_CD       = BK.POR_CD
AND     L4.LOC_CD       = BK.DEL_CD
AND     SH.SC_NO        = BK.SC_NO
AND     SM.PROP_NO      = SH.PROP_NO
AND     SM.PROP_STS_CD  = 'F'       -- FILED S/C
AND     SS.PROP_NO      = SM.PROP_NO
AND     SS.AMDT_SEQ     = SM.AMDT_SEQ
AND     SS.SVC_SCP_CD   IN (BK.SVC_SCP_CD)
AND     ( SELECT BKG_REV_APLY_DT_PKG.BKG_GET_REV_APLY_DT_FNC(@[bkg_no], @[ca_flg]) FROM DUAL )
        BETWEEN SS.EFF_DT AND SS.EXP_DT
AND     BK.BKG_NO       = @[bkg_no]
AND     BK.CORR_NO      = 'TMP0000001'  -- CORRECTION 중인 DATA 를 나타내는 고정된 상수값
AND     @[ca_flg]       = 'Y'
ORDER BY DECODE(SS.SVC_SCP_CD,'ACE',1,'MXE',2,'TPE',3)
)
WHERE ROWNUM = 1
) ,
C1 AS
(
/*******************************************************************************************
고객 DATA 비교
*******************************************************************************************/

SELECT  'X'
FROM    (
        /* BKG CUSTOMER */
        SELECT  BC.CUST_CNT_CD  ,
                BC.CUST_SEQ     ,
                ( SELECT UPPER(SUBSTR(A.CUST_LGL_ENG_NM, 1, 6)) FROM MDM_CUSTOMER A WHERE A.CUST_CNT_CD = BC.CUST_CNT_CD AND A.CUST_SEQ = BC.CUST_SEQ ) CUST_NM
        FROM    BKG_CUSTOMER BC
        WHERE   BC.BKG_NO         = @[bkg_no]
        AND     BC.BKG_CUST_TP_CD IN ( 'S', 'C', 'N', 'F' )
        AND     BC.CUST_CNT_CD    IS NOT NULL
        AND     BC.CUST_SEQ       <> 0
        AND     @[ca_flg]         = 'N'
		UNION
        SELECT  BB.BKG_CTRL_PTY_CUST_CNT_CD ,
                BB.BKG_CTRL_PTY_CUST_SEQ    ,
                ( SELECT UPPER(SUBSTR(A.CUST_LGL_ENG_NM, 1, 6)) FROM MDM_CUSTOMER A WHERE A.CUST_CNT_CD = BB.BKG_CTRL_PTY_CUST_CNT_CD AND A.CUST_SEQ = BB.BKG_CTRL_PTY_CUST_SEQ ) CUST_NM
        FROM    BKG_BOOKING BB
        WHERE   BB.BKG_NO         = @[bkg_no]
        AND     BB.BKG_CTRL_PTY_CUST_CNT_CD    IS NOT NULL
        AND     BB.BKG_CTRL_PTY_CUST_SEQ       <> 0
        AND     @[ca_flg]         = 'N'

        UNION ALL

        SELECT  BC.CUST_CNT_CD  ,
                BC.CUST_SEQ     ,
                ( SELECT UPPER(SUBSTR(A.CUST_LGL_ENG_NM, 1, 6)) FROM MDM_CUSTOMER A WHERE A.CUST_CNT_CD = BC.CUST_CNT_CD AND A.CUST_SEQ = BC.CUST_SEQ ) CUST_NM
        FROM    BKG_CUST_HIS BC
        WHERE   BC.BKG_NO         = @[bkg_no]
        AND     BC.CORR_NO        = 'TMP0000001'  -- CORRECTION 중인 DATA 를 나타내는 고정된 상수값
        AND     BC.BKG_CUST_TP_CD IN ( 'S', 'C', 'N', 'F' )
        AND     BC.CUST_CNT_CD    IS NOT NULL
        AND     BC.CUST_SEQ       <> 0
        AND     @[ca_flg]         = 'Y'

        UNION
        SELECT  BB.BKG_CTRL_PTY_CUST_CNT_CD ,
                BB.BKG_CTRL_PTY_CUST_SEQ    ,
                ( SELECT UPPER(SUBSTR(A.CUST_LGL_ENG_NM, 1, 6)) FROM MDM_CUSTOMER A WHERE A.CUST_CNT_CD = BB.BKG_CTRL_PTY_CUST_CNT_CD AND A.CUST_SEQ = BB.BKG_CTRL_PTY_CUST_SEQ ) CUST_NM
        FROM    BKG_BKG_HIS BB
        WHERE   BB.BKG_NO         = @[bkg_no]
        AND     BB.CORR_NO        = 'TMP0000001'
        AND     BB.BKG_CTRL_PTY_CUST_CNT_CD    IS NOT NULL
        AND     BB.BKG_CTRL_PTY_CUST_SEQ       <> 0
        AND     @[ca_flg]         = 'Y'
        ) BC,
        (
        /* CONTRACT CUSTOMER */
        SELECT  CP.CUST_CNT_CD  CUST_CNT_CD ,
                CP.CUST_SEQ     CUST_SEQ    ,
                ( SELECT UPPER(SUBSTR(A.CUST_LGL_ENG_NM, 1, 6)) FROM MDM_CUSTOMER A WHERE A.CUST_CNT_CD = CP.CUST_CNT_CD AND A.CUST_SEQ = CP.CUST_SEQ ) CUST_NM
        FROM    SC  ,
                PRI_SP_CTRT_PTY CP
        WHERE   CP.PROP_NO            = SC.PROP_NO
        AND     CP.AMDT_SEQ           = SC.AMDT_SEQ
        AND     CP.PRC_CTRT_PTY_TP_CD = 'C'
        UNION ALL
        /* AFFILIATE */
        SELECT  SA.CUST_CNT_CD  ,
                SA.CUST_SEQ     ,
                ( SELECT UPPER(SUBSTR(A.CUST_LGL_ENG_NM, 1, 6)) FROM MDM_CUSTOMER A WHERE A.CUST_CNT_CD = SA.CUST_CNT_CD AND A.CUST_SEQ = SA.CUST_SEQ ) CUST_NM
        FROM    SC  ,
                PRI_SP_AFIL SA
        WHERE   SA.PROP_NO  = SC.PROP_NO
        AND     SA.AMDT_SEQ = SC.AMDT_SEQ
        ) SC
WHERE   (
            (
                BC.CUST_CNT_CD  = SC.CUST_CNT_CD
            AND BC.CUST_SEQ     = SC.CUST_SEQ
            )
        OR  BC.CUST_NM  = SC.CUST_NM
        )
AND     ROWNUM      = 1
)
SELECT  'B'   UMCH_TP_CD      ,
        '[Shipper]['
          ||  DECODE(@[ca_flg],
                'N', ( SELECT CUST_CNT_CD || LPAD(CUST_SEQ, 6, '0') FROM BKG_CUSTOMER WHERE BKG_NO = @[bkg_no] AND BKG_CUST_TP_CD = 'S' ),
                'Y', ( SELECT CUST_CNT_CD || LPAD(CUST_SEQ, 6, '0') FROM BKG_CUST_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO = 'TMP0000001' AND BKG_CUST_TP_CD = 'S' )
                )
          ||  ']' || CHR(10) || '[Consignee]['
          ||  DECODE(@[ca_flg],
                'N', ( SELECT CUST_CNT_CD || LPAD(CUST_SEQ, 6, '0') FROM BKG_CUSTOMER WHERE BKG_NO = @[bkg_no] AND BKG_CUST_TP_CD = 'C' ),
                'Y', ( SELECT CUST_CNT_CD || LPAD(CUST_SEQ, 6, '0') FROM BKG_CUST_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO = 'TMP0000001' AND BKG_CUST_TP_CD = 'C' )
                )
          ||  ']' || CHR(10) || '[Notify]['
          ||  DECODE(@[ca_flg],
                'N', ( SELECT CUST_CNT_CD || LPAD(CUST_SEQ, 6, '0') FROM BKG_CUSTOMER WHERE BKG_NO = @[bkg_no] AND BKG_CUST_TP_CD = 'N' ),
                'Y', ( SELECT CUST_CNT_CD || LPAD(CUST_SEQ, 6, '0') FROM BKG_CUST_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO = 'TMP0000001' AND BKG_CUST_TP_CD = 'N' )
                )

          ||  ']' || CHR(10) || '[F/Forwarder]['
          ||  DECODE(@[ca_flg],
                'N', ( SELECT CUST_CNT_CD || LPAD(CUST_SEQ, 6, '0') FROM BKG_CUSTOMER WHERE BKG_NO = @[bkg_no] AND BKG_CUST_TP_CD = 'F' ),
                'Y', ( SELECT CUST_CNT_CD || LPAD(CUST_SEQ, 6, '0') FROM BKG_CUST_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO = 'TMP0000001' AND BKG_CUST_TP_CD = 'F' )
                )
          ||  ']' || CHR(10) || '[Contract Party]['
          ||  DECODE('N',
                'N', ( SELECT BKG_CTRL_PTY_CUST_CNT_CD || LPAD(BKG_CTRL_PTY_CUST_SEQ, 6, '0') FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no] ),
                'Y', ( SELECT BKG_CTRL_PTY_CUST_CNT_CD || LPAD(BKG_CTRL_PTY_CUST_SEQ, 6, '0') FROM BKG_BKG_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO = 'TMP0000001' )
                )   
          ||  ']' BKG_ITM_LOG ,
        (
        SELECT  '[Customer][' || CUST_CNT_CD || LPAD(CUST_SEQ, 6, '0') || ']'
        FROM    PRI_SP_CTRT_PTY CP
        WHERE   ( CP.PROP_NO, CP.AMDT_SEQ ) = ( SELECT PROP_NO, AMDT_SEQ FROM SC )
        AND     PRC_CTRT_PTY_TP_CD  = 'C'
        )
        ||
        (
        SELECT  CHR(10) || '[Affiliate]'
        FROM    DUAL
        WHERE   EXISTS  (
                        SELECT  'X'
                        FROM    PRI_SP_AFIL SA
                        WHERE   ( SA.PROP_NO, SA.AMDT_SEQ ) = ( SELECT PROP_NO, AMDT_SEQ FROM SC )
                        AND     SA.SRC_INFO_CD  <> 'AD'
                        )
        )
        ||
        (
        SELECT  REPLACE(RTRIM(REPLACE(LTRIM(SYS_CONNECT_BY_PATH(CUST_CD || DECODE(MOD(ROW_NUMBER, 5), 0, '/'), ';'), ';'), '/;', CHR(10)) ,'/'), ';', '')
        FROM    (
                SELECT  '[' || CUST_CNT_CD || LPAD(CUST_SEQ, 6, '0') || ']' CUST_CD ,
                        ROW_NUMBER() OVER ( ORDER BY AFIL_SEQ ) ROW_NUMBER  ,
                        COUNT(1) OVER () CNT
                FROM    PRI_SP_AFIL SA
                WHERE   ( SA.PROP_NO, SA.AMDT_SEQ ) = ( SELECT PROP_NO, AMDT_SEQ FROM SC )
                AND     SA.SRC_INFO_CD  <> 'AD'
                )
        WHERE   LEVEL   = LEAST(CNT, 20)
        START WITH ROW_NUMBER = 1
        CONNECT BY
                ROW_NUMBER        = PRIOR ROW_NUMBER + 1
        )   CTRT_ITM_LOG    ,
        'U'   MTCH_UMCH_TP_CD ,
        ( SELECT UMCH_TP_DESC FROM BKG_REV_UMCH_TP WHERE UMCH_TP_CD = 'B' ) UMCH_TP_DESC  ,
        ( SELECT INTG_CD_VAL_DP_DESC FROM COM_INTG_CD_DTL WHERE INTG_CD_ID = 'CD02456' AND INTG_CD_VAL_CTNT = 'U' ) MTCH_UMCH_TP_DESC
FROM    DUAL
WHERE   NOT EXISTS ( SELECT 'X' FROM C1 )
AND	    NOT EXISTS ( SELECT 'X' --S/C Customer의 Type이 ‘NVOCC’인 경우 Error B 심사대상에서 제외
					 FROM BKG_BOOKING BK, 
						  PRI_SP_HDR  SH,
						  PRI_SP_MN   SM,
						  PRI_SP_SCP_MN SS,
						  PRI_SP_CTRT_CUST_TP CT
					 WHERE 1=1
					 AND   SH.SC_NO = BK.SC_NO
					 AND   SM.PROP_NO = SH.PROP_NO
					 AND   SM.PROP_STS_CD ='F'
				     AND   SS.PROP_NO = SM.PROP_NO
					 AND   SS.AMDT_SEQ = SM.AMDT_SEQ
					 AND   SS.SVC_SCP_CD IN (BK.SVC_SCP_CD,DECODE(BK.SVC_SCP_CD,'ACE','TPE','MXE','TPE'))
					 AND   SS.PROP_NO = CT.PROP_NO
					 AND   SS.AMDT_SEQ = CT.AMDT_SEQ
					 AND   CT.PRC_CTRT_PTY_TP_CD ='C'
					 AND   CT.PRC_CTRT_CUST_TP_CD ='N'
					 AND     ( SELECT BKG_REV_APLY_DT_PKG.BKG_GET_REV_APLY_DT_FNC(@[bkg_no], @[ca_flg]) FROM DUAL )
					       BETWEEN SS.EFF_DT AND SS.EXP_DT
					 AND     BK.BKG_NO       = @[bkg_no]
					 AND     @[ca_flg]       = 'N'
					 UNION ALL
					 SELECT 'X' 
					 FROM BKG_BKG_HIS BK, 
						  PRI_SP_HDR  SH,
						  PRI_SP_MN   SM,
						  PRI_SP_SCP_MN SS,
						  PRI_SP_CTRT_CUST_TP CT
					 WHERE 1=1
					 AND   SH.SC_NO = BK.SC_NO
					 AND   SM.PROP_NO = SH.PROP_NO
					 AND   SM.PROP_STS_CD ='F'
				     AND   SS.PROP_NO = SM.PROP_NO
					 AND   SS.AMDT_SEQ = SM.AMDT_SEQ
					 AND   SS.SVC_SCP_CD IN (BK.SVC_SCP_CD,DECODE(BK.SVC_SCP_CD,'ACE','TPE','MXE','TPE'))
					 AND   SS.PROP_NO = CT.PROP_NO
					 AND   SS.AMDT_SEQ = CT.AMDT_SEQ
					 AND   CT.PRC_CTRT_PTY_TP_CD ='C'
					 AND   CT.PRC_CTRT_CUST_TP_CD ='N'
					 AND     ( SELECT BKG_REV_APLY_DT_PKG.BKG_GET_REV_APLY_DT_FNC(@[bkg_no], @[ca_flg]) FROM DUAL )
					       BETWEEN SS.EFF_DT AND SS.EXP_DT
					 AND     BK.BKG_NO       = @[bkg_no]
					 AND     BK.CORR_NO      = 'TMP0000001'  
					 AND     @[ca_flg]       = 'Y'
					)
/*******************************************************************************************
신규 BKG 만 대상으로 한다.
*******************************************************************************************/

AND     LENGTH(@[bkg_no]) = 12			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="ca_flg" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
