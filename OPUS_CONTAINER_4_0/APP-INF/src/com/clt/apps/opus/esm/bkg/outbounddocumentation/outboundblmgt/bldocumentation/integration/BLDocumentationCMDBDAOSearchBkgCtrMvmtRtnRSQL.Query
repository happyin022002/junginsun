<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BLDocumentationCMDBDAOSearchBkgCtrMvmtRtnRSQL">
			<desc><![CDATA[BLDocumentationCMDBDAOSearchBkgCtrMvmtRtnR]]></desc>
			<sql><![CDATA[
SELECT 
    BKG_NO,
    ERR_MSG_CD,
    CNT_CD,
    SYS_AREA_GRP_CD,
    CNTR_NO
FROM (
SELECT /*+ ORDERED USE_NL(BC B B1) */
       B1.BKG_NO , 'BKG95065' ERR_MSG_CD, '' CNT_CD, '' SYS_AREA_GRP_CD, BC.CNTR_NO
FROM BKG_CONTAINER BC, BKG_BOOKING B, BKG_BOOKING B1
WHERE 1=1 
AND B.BKG_NO = @[bkg_no]
AND B.BKG_NO <> B1.BKG_NO
AND B1.BKG_NO = BC.BKG_NO
AND BC.CNTR_NO = @[cntr_no]
AND BC.CRE_DT >= (SYSDATE - 90) 
AND B1.BKG_CGO_TP_CD ='F'
AND (B1.BKG_STS_CD = 'W' OR B1.BKG_STS_CD = 'F')
AND (BC.RC_FLG = 'Y' OR BC.DCGO_FLG = 'Y' OR BC.AWK_CGO_FLG = 'Y')
AND NOT EXISTS (SELECT /*+ ORDERED USE_NL(BC BK) */
                       'X'
                 FROM  BKG_CONTAINER BC, BKG_BOOKING BK
                 WHERE 1=1                                    
                   AND BK.BKG_NO = BC.BKG_NO
                   AND BC.CNTR_PRT_FLG ='Y'
                   AND BC.CNTR_NO =  @[cntr_no]
                   AND BC.CRE_DT >= (SYSDATE - 90)
                   AND BK.VSL_CD = B.VSL_CD
                   AND BK.SKD_VOY_NO = B.SKD_VOY_NO
                   AND BK.SKD_DIR_CD = B.SKD_DIR_CD
				   AND ROWNUM = 1 
)
AND NOT EXISTS (SELECT /*+ ORDERED USE_NL(BC BK) */
                       'X' 
				 FROM  BKG_CONTAINER BC, BKG_BOOKING BK
				 WHERE BK.FM_BKG_NO = @[bkg_no]
				   AND BK.BL_NO_TP = '9'
				   AND BK.BKG_NO = BC.BKG_NO
				   AND BC.CNTR_NO = @[cntr_no]
                   AND BC.CRE_DT >= (SYSDATE - 90)
				)    
AND @[mvmt_sts_cd] = 'OC' 
UNION
SELECT /*+ ORDERED USE_NL(BC B B1) */
       B1.BKG_NO , 'BKG00966' ERR_MSG_CD, '' CNT_CD, '' SYS_AREA_GRP_CD, BC.CNTR_NO
FROM BKG_CONTAINER BC, BKG_BOOKING B, BKG_BOOKING B1
WHERE 1=1 
AND B.BKG_NO = @[bkg_no]
AND B.BKG_NO <> B1.BKG_NO
AND B.VSL_CD = B1.VSL_CD
AND B.SKD_VOY_NO = B1.SKD_VOY_NO
AND B.SKD_DIR_CD = B1.SKD_DIR_CD
AND B1.BKG_NO = BC.BKG_NO
AND BC.CNTR_NO = @[cntr_no]
AND BC.CRE_DT >= (SYSDATE - 90) /* 오래된 bkg_no과 연결된 cntr_no는 해당 없음 */
AND B1.BKG_CGO_TP_CD ='F'
AND (B1.BKG_STS_CD = 'W' OR B1.BKG_STS_CD = 'F')
AND NOT EXISTS (SELECT /*+ ORDERED USE_NL(BC BK) */
                       'X'
                 FROM  BKG_CONTAINER BC, BKG_BOOKING BK
                 WHERE 1=1                                    
                   AND BC.CNTR_PRT_FLG ='Y'
                   AND BK.BKG_NO = BC.BKG_NO
                   AND BC.CNTR_NO =  @[cntr_no]
                   AND BC.CRE_DT >= (SYSDATE - 90) /* 오래된 bkg_no과 연결된 cntr_no는 해당 없음 */
                   AND BK.VSL_CD = B.VSL_CD
                   AND BK.SKD_VOY_NO = B.SKD_VOY_NO
                   AND BK.SKD_DIR_CD = B.SKD_DIR_CD
				   AND ROWNUM = 1 
)
AND NOT EXISTS (SELECT /*+ ORDERED USE_NL(BC BK) */
                       'X' 
				 FROM  BKG_CONTAINER BC, BKG_BOOKING BK
				 WHERE BK.FM_BKG_NO = @[bkg_no]
				   AND BK.BL_NO_TP = '9'
				   AND BK.BKG_NO = BC.BKG_NO
				   AND BC.CNTR_NO = @[cntr_no]
                   AND BC.CRE_DT >= (SYSDATE - 90) /* 오래된 bkg_no과 연결된 cntr_no는 해당 없음 */
				)                 
AND (CASE WHEN (SELECT HRD.ATTR_CTNT5  
            FROM   BKG_HRD_CDG_CTNT HRD
            WHERE 1=1
            AND HRD.HRD_CDG_ID ='OSCAR_MVMT_CHK'
            ) = 'N' THEN 'Y'
    ELSE 
NVL(
(SELECT 'Y' FROM 
(SELECT /*+ ORDERED USE_NL(BK B1 VVD1 VVD2 SKD1 SKD2 CNTR) */
                                SKD1.VPS_PORT_CD POL_PORT,
                                SKD2.VPS_PORT_CD POD_PORT,
                                ROW_NUMBER() OVER( ORDER BY VVD1.VSL_PRE_PST_CD, VVD1.VSL_SEQ, SKD1.CLPT_SEQ) ROW_SEQ
                                ,SKD1.CLPT_SEQ AS POL_CLPT_SEQ
                                ,SKD2.CLPT_SEQ AS POD_CLPT_SEQ
                                ,SKD1.VPS_ETD_DT
                                ,SKD2.VPS_ETA_DT
                         FROM                               
                              BKG_CONTAINER CNTR,
                              BKG_BOOKING B1,
                              BKG_BOOKING BK,
                              BKG_VVD VVD1, 
                              BKG_VVD VVD2,
                              VSK_VSL_PORT_SKD SKD1,
                              VSK_VSL_PORT_SKD SKD2
                        WHERE 1=1
                        AND CNTR.CNTR_NO = @[cntr_no]
                        AND CNTR.CRE_DT >= (SYSDATE - 90) /* 오래된 bkg_no과 연결된 cntr_no는 해당 없음 */
                        AND B1.BKG_NO = @[bkg_no]
                        AND B1.BKG_NO <> BK.BKG_NO
                        AND BK.VSL_CD = B1.VSL_CD
                        AND BK.SKD_VOY_NO = B1.SKD_VOY_NO
                        AND BK.SKD_DIR_CD = B1.SKD_DIR_CD
                        AND BK.BKG_NO = CNTR.BKG_NO
                        AND BK.BKG_NO <> @[bkg_no]
                        AND BK.BKG_NO = VVD1.BKG_NO
                        AND BK.BKG_NO = VVD2.BKG_NO
                        AND VVD1.VSL_CD = BK.VSL_CD
                        AND VVD1.SKD_VOY_NO = BK.SKD_VOY_NO
                        AND VVD1.SKD_DIR_CD = BK.SKD_DIR_CD                        
                        AND VVD2.VSL_CD = BK.VSL_CD
                        AND VVD2.SKD_VOY_NO = BK.SKD_VOY_NO
                        AND VVD2.SKD_DIR_CD = BK.SKD_DIR_CD                        

                        AND VVD1.VSL_CD = SKD1.VSL_CD
                        AND VVD1.SKD_VOY_NO = SKD1.SKD_VOY_NO
                        AND VVD1.SKD_DIR_CD = SKD1.SKD_DIR_CD
                        AND VVD1.POL_CD = SKD1.VPS_PORT_CD
                        AND VVD1.POL_CLPT_IND_SEQ  = SKD1.CLPT_IND_SEQ 
                        AND VVD2.VSL_CD = SKD2.VSL_CD
                        AND VVD2.SKD_VOY_NO = SKD2.SKD_VOY_NO
                        AND VVD2.SKD_DIR_CD = SKD2.SKD_DIR_CD
                        AND VVD2.POD_CD = SKD2.VPS_PORT_CD
                        AND VVD2.POD_CLPT_IND_SEQ  = SKD2.CLPT_IND_SEQ
                        AND NVL(SKD1.SKD_CNG_STS_CD,'X')  <> 'S'
                        AND NVL(SKD2.SKD_CNG_STS_CD,'X')  <> 'S'
                        ) A,
                        (
                         SELECT /*+ ORDERED USE_NL(BK VVD1 VVD2 SKD1 SKD2) */
                                SKD1.VPS_PORT_CD POL_PORT,
                                SKD2.VPS_PORT_CD POD_PORT,
                                ROW_NUMBER() OVER( ORDER BY VVD1.VSL_PRE_PST_CD, VVD1.VSL_SEQ, SKD1.CLPT_SEQ) ROW_SEQ
                                ,SKD1.CLPT_SEQ AS POL_CLPT_SEQ
                                ,SKD2.CLPT_SEQ AS POD_CLPT_SEQ
                                ,SKD1.VPS_ETD_DT
                                ,SKD2.VPS_ETA_DT
                         FROM BKG_BOOKING BK,
                              BKG_VVD VVD1, 
                              BKG_VVD VVD2,
                              VSK_VSL_PORT_SKD SKD1,
                              VSK_VSL_PORT_SKD SKD2
                        WHERE 1=1
                        
                        AND BK.BKG_NO = @[bkg_no]
                        AND BK.BKG_NO = VVD1.BKG_NO
                        AND BK.BKG_NO = VVD2.BKG_NO
                        AND VVD1.VSL_CD = BK.VSL_CD
                        AND VVD1.SKD_VOY_NO = BK.SKD_VOY_NO
                        AND VVD1.SKD_DIR_CD = BK.SKD_DIR_CD                        
                        AND VVD2.VSL_CD = BK.VSL_CD
                        AND VVD2.SKD_VOY_NO = BK.SKD_VOY_NO
                        AND VVD2.SKD_DIR_CD = BK.SKD_DIR_CD                        
                        AND VVD1.VSL_CD = SKD1.VSL_CD
                        AND VVD1.SKD_VOY_NO = SKD1.SKD_VOY_NO
                        AND VVD1.SKD_DIR_CD = SKD1.SKD_DIR_CD
                        AND VVD1.POL_CD = SKD1.VPS_PORT_CD
                        AND VVD1.POL_CLPT_IND_SEQ  = SKD1.CLPT_IND_SEQ 
                        AND VVD2.VSL_CD = SKD2.VSL_CD
                        AND VVD2.SKD_VOY_NO = SKD2.SKD_VOY_NO
                        AND VVD2.SKD_DIR_CD = SKD2.SKD_DIR_CD
                        AND VVD2.POD_CD = SKD2.VPS_PORT_CD
                        AND VVD2.POD_CLPT_IND_SEQ  = SKD2.CLPT_IND_SEQ
                        AND NVL(SKD1.SKD_CNG_STS_CD,'X')  <> 'S'
                        AND NVL(SKD2.SKD_CNG_STS_CD,'X')  <> 'S'
                        ) B
                        WHERE A.POL_CLPT_SEQ < B.POD_CLPT_SEQ
                          AND A.POD_CLPT_SEQ > B.POL_CLPT_SEQ
                          AND ROWNUM =1 
 ) , 'N')
END ) = 'Y'
AND NOT EXISTS (SELECT 'X'
                  FROM (SELECT CNTR_NO
                              ,CNMV_CYC_NO
                              ,MVMT_STS_CD
                              ,ROW_NUMBER() OVER(PARTITION BY CNTR_NO ORDER BY CNMV_YR DESC, CNMV_ID_NO DESC, CNMV_SEQ DESC) RN
                          FROM CTM_MOVEMENT
                         WHERE CNTR_NO = @[cntr_no]) CTM
                 WHERE @[mvmt_sts_cd] = 'OC'
                   AND CTM.MVMT_STS_CD = 'OP'
                   AND CTM.RN = 2)
UNION
SELECT /*+ ORDERED USE_NL(HRD A B) */
       B.BKG_NO , 'BKG00966' ERR_MSG_CD, '' CNT_CD, '' SYS_AREA_GRP_CD, A.CNTR_NO
FROM   BKG_HRD_CDG_CTNT HRD, CTM_BKG_CNTR A, CTM_BOOKING B
WHERE  A.BKG_NO = B.BKG_NO
AND    A.CNTR_NO = @[cntr_no]
AND    A.CRE_DT >= (SYSDATE - 90) /* 오래된 bkg_no과 연결된 cntr_no는 해당 없음 */
AND    B.BKG_NO <> @[bkg_no]
AND    A.CNMV_CYC_NO IS NOT NULL
AND    B.BKG_CGO_TP_CD = 'F'
AND    (B.BKG_STS_CD = 'W' OR B.BKG_STS_CD = 'F')
AND    A.CNMV_STS_CD NOT IN ('ID','MT')
AND    HRD.HRD_CDG_ID ='OSCAR_MVMT_CHK'
AND    HRD.ATTR_CTNT1 = 'Y'
AND    COALESCE((SELECT  /*+ INDEX_DESC(VPS XAK11VSK_VSL_PORT_SKD) */
                    VPS.VPS_ETA_DT 
              FROM VSK_VSL_PORT_SKD VPS
             WHERE B.VSL_CD       = VPS.VSL_CD
               AND B.SKD_VOY_NO   = VPS.SKD_VOY_NO
               AND B.SKD_DIR_CD   = VPS.SKD_DIR_CD
               AND B.POD_CD       = VPS.VPS_PORT_CD 
               AND ROWNUM = 1) , B.VPS_ETD_DT + NVL(( SELECT ROUND(MAX(PR.TZTM_HRS)/24, 5)
                                                        FROM PRD_OCN_ROUT PR
                                                       WHERE B.POL_CD       = PR.ORG_LOC_CD
                                                         AND B.POD_CD       = PR.DEST_LOC_CD
                                                         AND PR.UPD_IND_CD != 'D' ), 80)
               , SYSDATE ) > SYSDATE - 60
AND   (SELECT CASE WHEN SIGN(MC.CNMV_CYC_NO - A.CNMV_CYC_NO) IN (-1, 0) THEN 'CHK'
                   ELSE
                       DECODE(MC.CNMV_CYC_NO - A.CNMV_CYC_NO, 1, 'CHK', 2, 'CHK', 'NOT')
                   END
         FROM MST_CONTAINER MC 
        WHERE A.CNTR_NO = MC.CNTR_NO
          AND ROWNUM  = 1) = 'CHK'
AND NOT EXISTS (SELECT 'Y' FROM BKG_CONTAINER BCNTR, BKG_BOOKING BK
                WHERE 1=1
                  AND BCNTR.BKG_NO = @[bkg_no]
                  AND BCNTR.CNTR_NO = @[cntr_no]
                  AND BCNTR.BKG_NO = BK.BKG_NO
                  AND BK.BKG_STS_CD <> 'X'
                  AND ROWNUM =1 
                )
AND NOT EXISTS (SELECT 'Y' --Why????
                FROM BKG_BOOKING BK
                WHERE 1=1
                  AND BK.BKG_NO = @[bkg_no]
                  AND BK.VSL_CD = B.VSL_CD
                  AND BK.SKD_VOY_NO = B.SKD_VOY_NO
                  AND BK.SKD_DIR_CD = B.SKD_DIR_CD
                 )    
UNION
SELECT /*+ ORDERED USE_NL(HRD A B) */
       B.BKG_NO , 'BKG00966' ERR_MSG_CD, '' CNT_CD, '' SYS_AREA_GRP_CD, A.CNTR_NO
FROM   BKG_HRD_CDG_CTNT HRD, CTM_BKG_CNTR A, CTM_BOOKING B
WHERE  A.BKG_NO = B.BKG_NO
AND    A.CNTR_NO = @[cntr_no]
AND    A.CRE_DT >= (SYSDATE - 90) /* 오래된 bkg_no과 연결된 cntr_no는 해당 없음 */
AND    B.BKG_NO <> @[bkg_no]
AND    B.BKG_NO <> @[bkg_no]
AND    A.CNMV_CYC_NO IN('9999','9998')
AND    B.BKG_CGO_TP_CD = 'F'
AND    (B.BKG_STS_CD = 'W' OR B.BKG_STS_CD = 'F')
AND HRD.HRD_CDG_ID ='OSCAR_MVMT_CHK'
AND HRD.ATTR_CTNT2 = 'Y'
AND ROWNUM = 1
UNION
SELECT /*+ ORDERED USE_NL(HRD A B) */
       B.BKG_NO , 'BKG95063' ERR_MSG_CD, '' CNT_CD, '' SYS_AREA_GRP_CD, A.CNTR_NO
FROM   BKG_HRD_CDG_CTNT HRD, CTM_BKG_CNTR A, CTM_BOOKING B
WHERE  A.BKG_NO = B.BKG_NO
AND    A.CNTR_NO = @[cntr_no]
AND    A.CRE_DT >= (SYSDATE - 90) /* 오래된 bkg_no과 연결된 cntr_no는 해당 없음 */
AND    B.BKG_NO <> @[bkg_no]
AND    B.BKG_CGO_TP_CD = 'F'
AND    (B.BKG_STS_CD = 'W' OR B.BKG_STS_CD = 'F')
AND    A.CNMV_CYC_NO IS NOT NULL
AND    A.CNMV_STS_CD NOT IN ('ID','MT')
AND    COALESCE((SELECT  /*+ INDEX_DESC(VPS XAK11VSK_VSL_PORT_SKD) */
                    VPS.VPS_ETA_DT 
              FROM VSK_VSL_PORT_SKD VPS
             WHERE B.VSL_CD       = VPS.VSL_CD
               AND B.SKD_VOY_NO   = VPS.SKD_VOY_NO
               AND B.SKD_DIR_CD   = VPS.SKD_DIR_CD
               AND B.POD_CD       = VPS.VPS_PORT_CD 
               AND ROWNUM = 1) , B.VPS_ETD_DT + NVL(( SELECT ROUND(MAX(PR.TZTM_HRS)/24, 5)
                                                        FROM PRD_OCN_ROUT PR
                                                       WHERE B.POL_CD       = PR.ORG_LOC_CD
                                                         AND B.POD_CD       = PR.DEST_LOC_CD
                                                         AND PR.UPD_IND_CD != 'D' ), 80)
               , SYSDATE ) > SYSDATE - 60
AND   (SELECT CASE WHEN SIGN(MC.CNMV_CYC_NO - A.CNMV_CYC_NO) IN (-1, 0) THEN 'CHK'
                   ELSE
                       DECODE(MC.CNMV_CYC_NO - A.CNMV_CYC_NO, 1, 'CHK', 2, 'CHK', 'NOT')
                   END
         FROM MST_CONTAINER MC
        WHERE A.CNTR_NO = MC.CNTR_NO
          AND ROWNUM  = 1) = 'CHK'
AND    EXISTS (SELECT 'Y' FROM COM_SYS_AREA_GRP_ID A1, BKG_BOOKING A2, MST_CONTAINER MST
               WHERE  A2.BKG_NO = @[bkg_no]
                 AND  A2.POL_CD LIKE A1.CNT_CD || '%'
                 AND  A1.CO_IND_CD = 'H'
                 AND  A1.SVR_USD_FLG = 'Y'
                 AND  A1.SYS_AREA_GRP_ID <> MST.SYS_AREA_GRP_ID
                 AND  MST.CNTR_NO = A.CNTR_NO
                 AND  A2.BKG_CGO_TP_CD = 'F'
                 AND  (A2.BKG_STS_CD = 'W' OR A2.BKG_STS_CD = 'F')
			     AND  MST.CNMV_STS_CD IN ('OP','OC')
				 AND  MST.BKG_NO <> A2.BKG_NO
                 AND  ROWNUM =1 )
AND HRD.HRD_CDG_ID ='OSCAR_MVMT_CHK'
AND HRD.ATTR_CTNT3 = 'Y'
UNION ALL
SELECT /*+ ORDERED USE_NL(HRD A) */
       A.BKG_NO BKG_NO , 'BKG08046' ERR_MSG_CD, '' CNT_CD, '' SYS_AREA_GRP_CD, A.CNTR_NO
FROM   BKG_HRD_CDG_CTNT HRD, CTM_MOVEMENT A
WHERE 1=1
AND    A.CNTR_NO = @[cntr_no]
AND    A.MVMT_STS_CD IN ('ID','MT')
AND    EXISTS (SELECT COUNT(1) FROM CTM_MOVEMENT CTM
               WHERE CTM.CNTR_NO = A.CNTR_NO
               AND   ROWNUM <= 2  -- 2개까지만 count하면 원하는 결과를 알수 있음.
               HAVING COUNT(1) = 1
               )
AND    EXISTS (SELECT 'Y' FROM COM_SYS_AREA_GRP_ID A1, BKG_BOOKING A2, MST_CONTAINER MST
               WHERE  A2.BKG_NO = @[bkg_no]
                 AND  A2.POL_CD LIKE A1.CNT_CD || '%'
                 AND  A1.CO_IND_CD = 'H'
                 AND  A1.SVR_USD_FLG = 'Y'
                 AND  A1.SYS_AREA_GRP_ID <> MST.SYS_AREA_GRP_ID
                 AND  MST.CNTR_NO = A.CNTR_NO
                 AND  A2.BKG_CGO_TP_CD = 'F'
                 AND  (A2.BKG_STS_CD = 'W' OR A2.BKG_STS_CD = 'F')
			     AND  MST.CNMV_STS_CD IN ('OP','OC')
				 AND  MST.BKG_NO <> A2.BKG_NO
                 AND  ROWNUM =1 )
AND HRD.HRD_CDG_ID ='OSCAR_MVMT_CHK'
AND HRD.ATTR_CTNT4 = 'Y'
AND ROWNUM =1 
)
WHERE 1=1
AND    ROWNUM = 1			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="cntr_no" type="12" value="" out="N"/>
				<param name="mvmt_sts_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
