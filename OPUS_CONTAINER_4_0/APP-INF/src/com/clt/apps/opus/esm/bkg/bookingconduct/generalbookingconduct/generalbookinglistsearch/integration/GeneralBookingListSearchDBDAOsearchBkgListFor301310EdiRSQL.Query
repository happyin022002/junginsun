<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="GeneralBookingListSearchDBDAOsearchBkgListFor301310EdiRSQL">
			<desc><![CDATA[searchBkgListFor301310Edi]]></desc>
			<sql><![CDATA[
SELECT /*+ opt_param('_optimizer_skip_scan_enabled', 'false') */ 
          BKG_NO
        , STATUS
        , BL_NO
        , CUST_TP_CD
        , CUST_CD
        , REPLACE(CUST_NM, CHR(10), ' ') CUST_NM
        , SC_NO
        , GROUP_EDI_ID
		, (SELECT /*+ INDEX(CUST XAK1BKG_CUSTOMER) */
                  DECODE(CUST_SEQ, '0', '', CUST_CNT_CD||TRIM(TO_CHAR(CUST_SEQ, '000000')))
			 FROM BKG_CUSTOMER CUST 
            WHERE CUST.BKG_NO = MST.BKG_NO 
              AND BKG_CUST_TP_CD = 'E') EDI_REF
        , RECEIVER_NAME
		, VVD
        , POR_CD
        , POL_CD
        , POD_CD
        , DEL_CD
        , SENT_DT
        , SND_USR_ID
        , (SELECT usr_nm FROM com_user WHERE usr_id = SND_USR_ID AND ROWNUM = 1) SND_USR_NM
        , SENT_STATUS
        , ACK
        , EDI_RECEIVE_ID RCV_ID
        , GROUP_EDI_ID GROUP_ID
        , CUST_CD REF_CODE
  FROM (SELECT  /*+ INDEX(CUST XAK1BKG_CUSTOMER) */
				MST.BKG_NO
                , BK.BKG_STS_CD STATUS
                , BK.BL_NO||BK.BL_TP_CD BL_NO
                , SUBSTR(RANK, 2, 2) CUST_TP_CD
                , CUST.CUST_CNT_CD||TRIM(TO_CHAR(CUST.CUST_SEQ, '000009')) CUST_CD
                , CUST.CUST_NM
                , BK.SC_NO
                , MST.GROUP_EDI_ID
                , MST.EDI_RECEIVE_ID
                , MST.RECEIVER_NAME
				, MST.VVD
                , BK.POR_CD
                , BK.POL_CD
                , BK.POD_CD
                , BK.DEL_CD
                , TO_CHAR(NTC.SND_RQST_DT, 'YYYY-MM-DD') SENT_DT
                , NTC.SND_USR_ID
                , DECODE(NTC.BKG_NTC_SND_RSLT_CD, 'A', 'Success', 'E', 'Fail', null) SENT_STATUS
                , null ACK
		        , NTC.HIS_SEQ
				, NTC.NTC_VIA_CD
				, NTC.NTC_KND_CD
          FROM BKG_CUSTOMER CUST, BKG_BOOKING BK, BKG_NTC_HIS NTC, 
                (SELECT BKG_NO
                        , MIN(RANK) RANK
                        , GROUP_EDI_ID
                        , EDI_RECEIVE_ID
                        , RECEIVER_NAME
						, VVD
                   FROM 
                        (SELECT /*+ INDEX(CUST XAK1BKG_CUSTOMER) */
                                 BK.BKG_NO
                                , MIN(TP_RANK.RANK) RANK
                                , EDI_BY_CUST.GROUP_EDI_ID
                                , EDI_BY_CUST.EDI_RECEIVE_ID
                                , EDI_BY_CUST.RECEIVER_NAME
								, VVD.VSL_CD||VVD.SKD_VOY_NO||VVD.SKD_DIR_CD VVD
                          FROM BKG_CUSTOMER CUST
                                , BKG_BOOKING BK
                                , BKG_VVD VVD
								, BKG_BL_ISS ISS
                                , (SELECT  GRP.ESVC_GRP_CD           GROUP_EDI_ID
                                         , GRP.CUST_TRD_PRNR_ID     EDI_RECEIVE_ID
                                         , GRP.ESVC_GRP_NM          RECEIVER_NAME
                                         , grp_CUST.CNT_CD   
                                         , grp_CUST.CUST_SEQ 
                                   FROM BKG_EDI_GRP_CUST GRP_CUST, BKG_EDI_GRP GRP
                                  WHERE GRP.ESVC_GRP_CD         = GRP_CUST.ESVC_GRP_CD
                                    AND GRP.CO_CD               = GRP_CUST.CO_CD
                                    AND GRP.ESVC_GRP_DELT_FLG   = 'N'
                                    AND GRP_CUST.CNT_CD         > ' '
                                    AND GRP_CUST.CUST_SEQ       > 0
                                    AND GRP_CUST.DELT_FLG       = 'N'
#if (${msg_type_cd} == 'B')-- booking receipt
                                    AND GRP_CUST.BKG_CFM_FLG    = 'Y'
                                    AND 1=2
#end
#if (${msg_type_cd} == 'D')--draft b/l
                                    AND GRP_CUST.BL_DRFT_FLG    = 'Y'
#end
#if(${edi_group_id} != '' && ${edi_receive_nm} != '')
	#if(${edi_group_id} == 'G')--Group ID
                                    AND GRP.ESVC_GRP_CD  like @[edi_receive_nm]||'%'
	#end
	#if(${edi_group_id} == 'R')--Receive ID
                                    AND GRP.CUST_TRD_PRNR_ID like @[edi_receive_nm]||'%'
	#end
	#if(${edi_group_id} == 'N')--receive name
                                    AND GRP.ESVC_GRP_NM  like @[edi_receive_nm]||'%'
	#end
#end
                                    ) EDI_BY_CUST               
                                , (
                                   SELECT ATTR_CTNT1 AS RCV_TP
                                        , HRD_CDG_ID_SEQ||ATTR_CTNT2 AS RANK
                                     FROM BKG_HRD_CDG_CTNT
                                    WHERE 'CUSTOMER_TYPE_ORDER' = HRD_CDG_ID
                                   ) TP_RANK
                         WHERE EDI_BY_CUST.CNT_CD   = CUST.CUST_CNT_CD 
                           AND EDI_BY_CUST.CUST_SEQ = CUST.CUST_SEQ
                           AND BK.BKG_NO        = CUST.BKG_NO
                           AND BK.BKG_NO        = ISS.BKG_NO(+)
                           AND BK.BKG_NO        = VVD.BKG_NO
                           AND BK.POL_CD        = VVD.POL_CD
                           AND VVD.VSL_PRE_PST_CD IN ('T', 'S')
                           AND CUST.BKG_CUST_TP_CD = TP_RANK.RCV_TP
                           AND BK.BKG_STS_CD    IN ('F', 'W', 'S')
                           AND BK.BKG_CGO_TP_CD <> 'P'

                        ---------------------------조건절 시작   
#if (${bkg_no} != '')
                           AND BK.BKG_NO = @[bkg_no]
#elseif(${multiBkgNo} != '')
       AND BK.BKG_NO IN (
       #foreach($multiBkgNoVal IN ${multiBkgNo})        
          #if($velocityCount < $multiBkgNo.size()) '$multiBkgNoVal', #else '$multiBkgNoVal' #end
       #end
       )
#end
#if (${bl_no} != '')
                           AND BK.BL_NO  = @[bl_no]
#end
                        ---------------------------bkg or b/l no입력시 다른 조건 제외함

#if (${bkg_from_dt} != '')
                           AND BK.BKG_CRE_DT > TO_DATE(REPLACE(@[bkg_from_dt],'-',''),'RRRRMMDD')
#end
#if (${bkg_to_dt} != '')
                           AND BK.BKG_CRE_DT < TO_DATE(REPLACE(@[bkg_to_dt],'-',''),'RRRRMMDD') + 1
#end

#if (${vvd} != '')
                           AND VVD.VSL_CD     = SUBSTR(@[vvd], 1, 4)
                           AND VVD.SKD_VOY_NO = SUBSTR(@[vvd], 5, 4)
                           AND VVD.SKD_DIR_CD = SUBSTR(@[vvd], 9, 1)
#end

#if (${pol_cd} != '')
                           AND BK.POL_CD = @[pol_cd]
#end
#if (${pod_cd} != '')
                           AND BK.POD_CD = @[pod_cd]
#end
#if (${del_cd} != '')
                           AND BK.DEL_CD = @[del_cd]
#end
#if (${bkg_ofc_cd} != '')
                           AND BK.BKG_OFC_CD = @[bkg_ofc_cd]
#end
#if (${bkg_stf_cd} != '')
                           AND UPPER(BK.DOC_USR_ID) = UPPER(@[bkg_stf_cd])
#end
#if (${sls_ofc_cd} != '')
                           AND BK.OB_SLS_OFC_CD = @[sls_ofc_cd]
#end
#if (${sales_rep} != '')
                           AND BK.OB_SREP_CD = @[sales_rep]
#end
#if (${bl_ofc_cd} != '')
                           AND ISS.OBL_ISS_OFC_CD = @[bl_ofc_cd]
#end
#if (${cust_tp_cd} != 'All' && ${cust_tp_cd} != '')
                           AND CUST.BKG_CUST_TP_CD = @[cust_tp_cd]
#end
#if (${cust_cnt_cd} != '')
                           AND CUST.CUST_CNT_CD = @[cust_cnt_cd]
#end
#if (${cust_seq} != '')
                           AND CUST.CUST_SEQ = TO_NUMBER(@[cust_seq])
#end
#if (${cust_nm} != '')
                           AND CUST.CUST_NM LIKE UPPER(@[cust_nm])||'%'
#end
                         GROUP BY BK.BKG_NO
                                , EDI_BY_CUST.GROUP_EDI_ID
                                , EDI_BY_CUST.EDI_RECEIVE_ID
                                , EDI_BY_CUST.RECEIVER_NAME
								, VVD.VSL_CD||VVD.SKD_VOY_NO||VVD.SKD_DIR_CD
                         UNION
                          SELECT /*+ INDEX(CUST XAK1BKG_CUSTOMER) */
                                  BK.BKG_NO
                                , (SELECT HRD_CDG_ID_SEQ||ATTR_CTNT2
                                     FROM BKG_HRD_CDG_CTNT
                                    WHERE 'CUSTOMER_TYPE_ORDER' = HRD_CDG_ID
                                      AND 7 = HRD_CDG_ID_SEQ) AS RANK
                                , EDI_BY_SC.GROUP_EDI_Id
                                , EDI_BY_SC.EDI_RECEIVE_ID
                                , EDI_BY_SC.RECEIVER_NAME
								, VVD.VSL_CD||VVD.SKD_VOY_NO||VVD.SKD_DIR_CD VVD
                          FROM BKG_CUSTOMER CUST
                                , BKG_BOOKING BK
                                , BKG_VVD VVD
								, BKG_BL_ISS ISS
                                , (SELECT  GRP.ESVC_GRP_CD          GROUP_EDI_ID
                                         , GRP.CUST_TRD_PRNR_ID     EDI_RECEIVE_ID
                                         , GRP.ESVC_GRP_NM          RECEIVER_NAME
                                         , GRP_CUST.SC_NO
                                   FROM BKG_EDI_GRP GRP, BKG_EDI_GRP_CUST GRP_CUST
                                  WHERE GRP.ESVC_GRP_CD         = GRP_CUST.ESVC_GRP_CD
                                    AND GRP.CO_CD               = GRP_CUST.CO_CD      
                                    AND GRP.ESVC_GRP_DELT_FLG   = 'N'
                                    AND GRP_CUST.SC_NO          > ' '              
                                    AND GRP_CUST.DELT_FLG       = 'N'

#if (${msg_type_cd} == 'B')-- booking receipt
                                    AND GRP_CUST.BKG_CFM_FLG    = 'Y'
                                    AND 1=2
#end
#if (${msg_type_cd} == 'D')--draft b/l
                                    AND GRP_CUST.BL_DRFT_FLG    = 'Y'
#end

#if (${edi_group_id} != '' && ${edi_receive_nm} != '')
	#if(${edi_group_id} == 'G')--Group ID
                                    AND GRP.ESVC_GRP_CD  like @[edi_receive_nm]||'%'
	#end
	#if(${edi_group_id} == 'R')--Receive ID
                                    AND GRP.CUST_TRD_PRNR_ID like @[edi_receive_nm]||'%'
	#end
	#if(${edi_group_id} == 'N')--receive name
                                    AND GRP.ESVC_GRP_NM  like @[edi_receive_nm]||'%'
	#end
#end
                                    ) EDI_BY_SC
                         WHERE EDI_BY_SC.SC_NO  = BK.SC_NO
                           AND BK.BKG_NO        = CUST.BKG_NO
                           AND BK.BKG_NO        = ISS.BKG_NO(+)
                           AND BK.BKG_NO        = VVD.BKG_NO
                           AND BK.POL_CD        = VVD.POL_CD
                           AND VVD.VSL_PRE_PST_CD IN ('T', 'S')
                           AND BK.BKG_STS_CD    IN ('F', 'A')
                           AND BK.BKG_CGO_TP_CD <> 'P'
                        ---------------------------조건절 시작   
#if (${bkg_no} != '')
                           AND BK.BKG_NO = @[bkg_no]
#elseif(${multiBkgNo} != '')
       AND BK.BKG_NO IN (
       #foreach($multiBkgNoVal IN ${multiBkgNo})        
          #if($velocityCount < $multiBkgNo.size()) '$multiBkgNoVal', #else '$multiBkgNoVal' #end
       #end
       )
#end
#if (${bl_no} != '')
                           AND BK.BL_NO  = @[bl_no]
#end
                        ---------------------------bkg or b/l no입력시 다른 조건 제외함

#if (${bkg_from_dt} != '')
                           AND BK.BKG_CRE_DT > TO_DATE(@[bkg_from_dt], 'yyyy-mm-dd')
#end
#if (${bkg_to_dt} != '')
                           AND BK.BKG_CRE_DT < TO_DATE(@[bkg_to_dt],   'yyyy-mm-dd') + 1
#end

#if (${vvd} != '')
                           AND VVD.VSL_CD     = SUBSTR(@[vvd], 1, 4)
                           AND VVD.SKD_VOY_NO = SUBSTR(@[vvd], 5, 4)
                           AND VVD.SKD_DIR_CD = SUBSTR(@[vvd], 9, 1)
#end

#if (${pol_cd} != '')
                           AND BK.POL_CD = @[pol_cd]
#end
#if (${pod_cd} != '')
                           AND BK.POD_CD = @[pod_cd]
#end
#if (${del_cd} != '')
                           AND BK.DEL_CD = @[del_cd]
#end
#if (${bkg_ofc_cd} != '')
                           AND BK.BKG_OFC_CD = @[bkg_ofc_cd]
#end
#if (${bkg_stf_cd} != '')
                           AND BK.DOC_USR_ID = @[bkg_stf_cd]
#end
#if (${sls_ofc_cd} != '')
                           AND BK.OB_SLS_OFC_CD = @[sls_ofc_cd]
#end
#if (${sales_rep} != '')
                           AND BK.OB_SREP_CD = @[sales_rep]
#end
#if (${bl_ofc_cd} != '')
                           AND ISS.OBL_ISS_OFC_CD = @[bl_ofc_cd]
#end
#if (${cust_tp_cd} != 'All' && ${cust_tp_cd} != '')
                           AND CUST.BKG_CUST_TP_CD = @[cust_tp_cd]
#end
#if (${cust_cnt_cd} != '')
                           AND CUST.CUST_CNT_CD = @[cust_cnt_cd]
#end
#if (${cust_seq} != '')
                           AND CUST.CUST_SEQ = TO_NUMBER(@[cust_seq])
#end
#if (${cust_nm} != '')
                           AND CUST.CUST_NM LIKE UPPER(@[cust_nm])||'%'
#end
#if (${sc_no} != '')
                           AND BK.SC_NO = @[sc_no]
#end
                           )
                   GROUP BY BKG_NO
                        , GROUP_EDI_ID
                        , EDI_RECEIVE_ID
                        , RECEIVER_NAME
						, VVD) MST                
          WHERE MST.BKG_NO             = CUST.BKG_NO(+)
            AND SUBSTR(MST.RANK, 2, 1) = CUST.BKG_CUST_TP_CD(+)
            AND MST.BKG_NO             = BK.BKG_NO
            AND MST.BKG_NO             = NTC.BKG_NO    (+)
            AND 'E'                    = NTC.NTC_VIA_CD(+)

#if (${msg_type_cd} == 'B')-- booking receipt
            AND 'BK'                   = NTC.NTC_KND_CD(+)
#end
#if (${msg_type_cd} == 'D')--draft b/l
            AND 'BL'                   = NTC.NTC_KND_CD(+)
#end
			AND MST.EDI_RECEIVE_ID 	   = NTC.EDI_ID(+)
			AND MST.GROUP_EDI_ID   	   = NTC.ESVC_GRP_CD(+)
			
        ) MST
 WHERE 1 = 1
   AND ((HIS_SEQ IS NOT NULL AND HIS_SEQ = (SELECT MAX(HIS.HIS_SEQ) 
                                              FROM BKG_NTC_HIS HIS
                                             WHERE HIS.BKG_NO = MST.BKG_NO
                                               AND HIS.NTC_VIA_CD = MST.NTC_VIA_CD
                                               AND HIS.NTC_KND_CD = MST.NTC_KND_CD
											   AND HIS.EDI_ID     = MST.EDI_RECEIVE_ID
											   AND HIS.ESVC_GRP_CD= MST.GROUP_EDI_ID))
        OR
      (HIS_SEQ IS NULL))                                   
#if (${edi_sent_sts_cd} != 'All' && ${edi_sent_sts_cd} == 'Y')
 --edi_sent_status = sent
 AND SENT_DT IS NOT NULL
#end
#if (${edi_sent_sts_cd} != 'All' && ${edi_sent_sts_cd} == 'N')
 --edi_sent_status = unsent
 AND SENT_DT IS NULL
#end
#if (${msg_type_cd} == 'B')-- booking receipt
UNION ALL
SELECT BKG_NO
       , STATUS
       , BL_NO
       , CUST_TP_CD
       , CUST_CD
       , '' CUST_NM
       , SC_NO
       , GROUP_EDI_ID
		   , CUST_CD EDI_REF
       , RECEIVER_NAME
		   , VVD
       , POR_CD
       , POL_CD
       , POD_CD
       , DEL_CD
       , SENT_DT
       , SND_USR_ID
       , (SELECT usr_nm FROM com_user WHERE usr_id = SND_USR_ID AND ROWNUM = 1) SND_USR_NM
       , SENT_STATUS
       , ACK
       , EDI_RECEIVE_ID RCV_ID
       , GROUP_EDI_ID GROUP_ID
       , CUST_CD REF_CODE
FROM (        
      SELECT MST.BKG_NO
            ,MST.STATUS
            ,MST.BL_NO
            ,MST.CUST_TP_CD
            ,MST.CUST_CD
            ,'' CUST_NM
            ,MST.SC_NO
            ,MST.GROUP_EDI_ID
            ,MST.EDI_RECEIVE_ID
            ,'' RECEIVER_NAME
            ,MST.VVD
            ,MST.POR_CD
            ,MST.POL_CD
            ,MST.POD_CD
            ,MST.DEL_CD
            ,TO_CHAR(NTC.SND_RQST_DT, 'YYYY-MM-DD') SENT_DT
            ,NTC.SND_USR_ID
            ,DECODE(NTC.BKG_NTC_SND_RSLT_CD, 'A', 'Success', 'E', 'Fail', null) SENT_STATUS
            ,null ACK
            ,NTC.HIS_SEQ
            ,NTC.NTC_VIA_CD
            ,NTC.NTC_KND_CD
      FROM (
            SELECT BK.BKG_NO
                   ,BK.BKG_STS_CD STATUS
                   ,BK.BL_NO||BK.BL_TP_CD BL_NO
                   ,'UN' CUST_TP_CD
                   ,BHCC.ATTR_CTNT2 CUST_CD
                   ,'' CUST_NM
                   ,BK.SC_NO
                   ,BHCC.ATTR_CTNT3 AS GROUP_EDI_ID
                   ,BHCC.ATTR_CTNT1 AS EDI_RECEIVE_ID
                   ,BHCC.ATTR_CTNT2 AS REF_CODE
                   ,VVD.VSL_CD||VVD.SKD_VOY_NO||VVD.SKD_DIR_CD VVD
                   ,BK.POR_CD
                   ,BK.POL_CD
                   ,BK.POD_CD
                   ,BK.DEL_CD
            FROM BKG_BOOKING BK
                 ,BKG_HRD_CDG_CTNT BHCC
                 ,BKG_VVD VVD
            	 ,BKG_BL_ISS ISS
            WHERE 1=1     
            AND BHCC.HRD_CDG_ID = 'CUSTOMER_301U'
            AND EXISTS (SELECT 'X' FROM BKG_CUSTOMER BC WHERE BC.BKG_NO = BK.BKG_NO
                                                        AND BC.CUST_CNT_CD||BC.CUST_SEQ = BHCC.ATTR_CTNT2)
            AND NOT EXISTS (SELECT 'X' FROM BKG_XTER_RQST_MST MST WHERE MST.BKG_NO = BK.BKG_NO
                                                                  AND MST.DOC_TP_CD = 'B'
                                                                  AND MST.BKG_UPLD_STS_CD = 'F'
                                                                  AND BHCC.ATTR_CTNT1 = CASE WHEN MST.XTER_SNDR_ID <> 'PEGASUS' THEN MST.XTER_SNDR_ID
                                                                                      ELSE (SELECT BHCC1.ATTR_CTNT2 
                                                                                            FROM BKG_HRD_CDG_CTNT BHCC1
                                                                                            WHERE BHCC1.HRD_CDG_ID = 'CUSTOMER_301_EDI_ID'
                                                                                            AND BHCC1.ATTR_CTNT1 = MST.PGSS_EDI_ID
                                                                                            AND ROWNUM = 1) END
                                                                  AND MST.XTER_RQST_VIA_CD <> 'WEB')
            AND BK.BKG_NO        = ISS.BKG_NO(+)
            AND BK.BKG_NO        = VVD.BKG_NO
            AND BK.POL_CD        = VVD.POL_CD
            AND VVD.VSL_PRE_PST_CD IN ('T', 'S')
            AND BK.BKG_STS_CD    IN ('F', 'W', 'S')
            AND BK.BKG_CGO_TP_CD <> 'P'                                                      
#if (${bkg_no} != '')
                           AND BK.BKG_NO = @[bkg_no]
#elseif(${multiBkgNo} != '')
       AND BK.BKG_NO IN (
       #foreach($multiBkgNoVal IN ${multiBkgNo})        
          #if($velocityCount < $multiBkgNo.size()) '$multiBkgNoVal', #else '$multiBkgNoVal' #end
       #end
       )
#end
#if (${bl_no} != '')
                           AND BK.BL_NO  = @[bl_no]
#end
                        ---------------------------bkg or b/l no입력시 다른 조건 제외함

#if (${bkg_from_dt} != '')
                           AND BK.BKG_CRE_DT > TO_DATE(REPLACE(@[bkg_from_dt],'-',''),'RRRRMMDD')
#end
#if (${bkg_to_dt} != '')
                           AND BK.BKG_CRE_DT < TO_DATE(REPLACE(@[bkg_to_dt],'-',''),'RRRRMMDD') + 1
#end

#if (${vvd} != '')
                           AND VVD.VSL_CD     = SUBSTR(@[vvd], 1, 4)
                           AND VVD.SKD_VOY_NO = SUBSTR(@[vvd], 5, 4)
                           AND VVD.SKD_DIR_CD = SUBSTR(@[vvd], 9, 1)
#end

#if (${pol_cd} != '')
                           AND BK.POL_CD = @[pol_cd]
#end
#if (${pod_cd} != '')
                           AND BK.POD_CD = @[pod_cd]
#end
#if (${del_cd} != '')
                           AND BK.DEL_CD = @[del_cd]
#end
#if (${bkg_ofc_cd} != '')
                           AND BK.BKG_OFC_CD = @[bkg_ofc_cd]
#end
#if (${bkg_stf_cd} != '')
                           AND UPPER(BK.DOC_USR_ID) = UPPER(@[bkg_stf_cd])
#end
#if (${sls_ofc_cd} != '')
                           AND BK.OB_SLS_OFC_CD = @[sls_ofc_cd]
#end
#if (${sales_rep} != '')
                           AND BK.OB_SREP_CD = @[sales_rep]
#end
#if (${bl_ofc_cd} != '')
                           AND ISS.OBL_ISS_OFC_CD = @[bl_ofc_cd]
#end
                                                                  
            UNION ALL                                                      
            SELECT MST.BKG_NO
                   ,BK.BKG_STS_CD STATUS
                   ,BK.BL_NO||BK.BL_TP_CD BL_NO
                   ,'' CUST_TP_CD
                   ,'' CUST_CD
                   ,'' CUST_NM
                   ,BK.SC_NO
                   ,'' GROUP_EDI_ID
                   ,(SELECT BHCC.ATTR_CTNT3
                     FROM BKG_HRD_CDG_CTNT BHCC
                     WHERE BHCC.HRD_CDG_ID = 'CUSTOMER_301_EDI_ID'
                     AND   BHCC.ATTR_CTNT2 = CASE WHEN MST.XTER_SNDR_ID <> 'PEGASUS' THEN MST.XTER_SNDR_ID
                                             ELSE (SELECT BHCC1.ATTR_CTNT2 FROM BKG_HRD_CDG_CTNT BHCC1
                                                                           WHERE BHCC1.HRD_CDG_ID = 'CUSTOMER_301_EDI_ID'
                                                                           AND BHCC1.ATTR_CTNT1 = MST.PGSS_EDI_ID) END
                     AND ROWNUM = 1) AS EDI_RECEIVE_ID 
                    ,'' REF_CODE
                    ,VVD.VSL_CD||VVD.SKD_VOY_NO||VVD.SKD_DIR_CD VVD
                    ,BK.POR_CD
                    ,BK.POL_CD
                    ,BK.POD_CD
                    ,BK.DEL_CD
            FROM BKG_BOOKING BK
                 ,BKG_XTER_RQST_MST MST
                 ,BKG_VVD VVD
            		 ,BKG_BL_ISS ISS
            WHERE MST.BKG_NO =  BK.BKG_NO
            AND MST.DOC_TP_CD = 'B'
            AND MST.BKG_UPLD_STS_CD = 'F'
            AND MST.XTER_RQST_VIA_CD <> 'WEB'
            AND MST.XTER_RQST_SEQ = (SELECT MAX(MST1.XTER_RQST_SEQ) FROM BKG_XTER_RQST_MST MST1 
                                                                    WHERE MST.XTER_SNDR_ID = MST1.XTER_SNDR_ID 
                                                                    AND MST.BKG_NO = MST1.BKG_NO
                                                                    AND MST1.DOC_TP_CD = 'B'
                                                                    AND MST1.BKG_UPLD_STS_CD = 'F'
                                                                    AND MST1.XTER_RQST_VIA_CD <> 'WEB'
                                                                 )  
            AND BK.BKG_NO        = ISS.BKG_NO(+)
            AND BK.BKG_NO        = VVD.BKG_NO
            AND BK.POL_CD        = VVD.POL_CD
            AND VVD.VSL_PRE_PST_CD IN ('T', 'S')
            AND BK.BKG_STS_CD    IN ('F', 'W', 'S')
            AND BK.BKG_CGO_TP_CD <> 'P'                                                        
#if (${bkg_no} != '')
                           AND BK.BKG_NO = @[bkg_no]
#elseif(${multiBkgNo} != '')
       AND BK.BKG_NO IN (
       #foreach($multiBkgNoVal IN ${multiBkgNo})        
          #if($velocityCount < $multiBkgNo.size()) '$multiBkgNoVal', #else '$multiBkgNoVal' #end
       #end
       )
#end
#if (${bl_no} != '')
                           AND BK.BL_NO  = @[bl_no]
#end
                        ---------------------------bkg or b/l no입력시 다른 조건 제외함

#if (${bkg_from_dt} != '')
                           AND BK.BKG_CRE_DT > TO_DATE(REPLACE(@[bkg_from_dt],'-',''),'RRRRMMDD')
#end
#if (${bkg_to_dt} != '')
                           AND BK.BKG_CRE_DT < TO_DATE(REPLACE(@[bkg_to_dt],'-',''),'RRRRMMDD') + 1
#end

#if (${vvd} != '')
                           AND VVD.VSL_CD     = SUBSTR(@[vvd], 1, 4)
                           AND VVD.SKD_VOY_NO = SUBSTR(@[vvd], 5, 4)
                           AND VVD.SKD_DIR_CD = SUBSTR(@[vvd], 9, 1)
#end

#if (${pol_cd} != '')
                           AND BK.POL_CD = @[pol_cd]
#end
#if (${pod_cd} != '')
                           AND BK.POD_CD = @[pod_cd]
#end
#if (${del_cd} != '')
                           AND BK.DEL_CD = @[del_cd]
#end
#if (${bkg_ofc_cd} != '')
                           AND BK.BKG_OFC_CD = @[bkg_ofc_cd]
#end
#if (${bkg_stf_cd} != '')
                           AND UPPER(BK.DOC_USR_ID) = UPPER(@[bkg_stf_cd])
#end
#if (${sls_ofc_cd} != '')
                           AND BK.OB_SLS_OFC_CD = @[sls_ofc_cd]
#end
#if (${sales_rep} != '')
                           AND BK.OB_SREP_CD = @[sales_rep]
#end
#if (${bl_ofc_cd} != '')
                           AND ISS.OBL_ISS_OFC_CD = @[bl_ofc_cd]
#end
            ) MST
           ,BKG_NTC_HIS NTC
      WHERE  MST.BKG_NO             = NTC.BKG_NO    (+)
      AND 'E'                    = NTC.NTC_VIA_CD(+)
      AND 'BK'                   = NTC.NTC_KND_CD(+)
      AND MST.EDI_RECEIVE_ID 	   = NTC.EDI_ID(+)
      AND NVL(MST.GROUP_EDI_ID,'ZZZZZ') = NVL(NTC.ESVC_GRP_CD(+),'ZZZZZ')

#if(${edi_group_id} != '' && ${edi_receive_nm} != '')
	#if(${edi_group_id} == 'G')--Group ID
                                    AND MST.GROUP_EDI_ID  like @[edi_receive_nm]||'%'
	#end
	#if(${edi_group_id} == 'R')--Receive ID
                                    AND MST.EDI_RECEIVE_ID like @[edi_receive_nm]||'%'
	#end
#end

) MST
WHERE 1 = 1
   AND ((HIS_SEQ IS NOT NULL AND HIS_SEQ = (SELECT MAX(HIS.HIS_SEQ) 
                                              FROM BKG_NTC_HIS HIS
                                             WHERE HIS.BKG_NO = MST.BKG_NO
                                               AND HIS.NTC_VIA_CD = MST.NTC_VIA_CD
                                               AND HIS.NTC_KND_CD = MST.NTC_KND_CD
                      											   AND HIS.EDI_ID     = MST.EDI_RECEIVE_ID
                      											   AND NVL(HIS.ESVC_GRP_CD,'ZZZZZ')= NVL(MST.GROUP_EDI_ID,'ZZZZZ')))
        OR (HIS_SEQ IS NULL))  
#if (${edi_sent_sts_cd} != 'All' && ${edi_sent_sts_cd} == 'Y')
 --edi_sent_status = sent
 AND SENT_DT IS NOT NULL
#end
#if (${edi_sent_sts_cd} != 'All' && ${edi_sent_sts_cd} == 'N')
 --edi_sent_status = unsent
 AND SENT_DT IS NULL
#end
#end			]]></sql>
			<params>
				<param name="edi_receive_nm" type="12" value="" out="N"/>
				<param name="bkg_no" type="12" value="CHIYB185049" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
				<param name="bkg_from_dt" type="12" value="" out="N"/>
				<param name="bkg_to_dt" type="12" value="" out="N"/>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="del_cd" type="12" value="" out="N"/>
				<param name="bkg_ofc_cd" type="12" value="" out="N"/>
				<param name="bkg_stf_cd" type="12" value="" out="N"/>
				<param name="sls_ofc_cd" type="12" value="" out="N"/>
				<param name="sales_rep" type="12" value="" out="N"/>
				<param name="bl_ofc_cd" type="12" value="" out="N"/>
				<param name="cust_tp_cd" type="12" value="" out="N"/>
				<param name="cust_cnt_cd" type="12" value="" out="N"/>
				<param name="cust_seq" type="12" value="" out="N"/>
				<param name="cust_nm" type="12" value="" out="N"/>
				<param name="sc_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
