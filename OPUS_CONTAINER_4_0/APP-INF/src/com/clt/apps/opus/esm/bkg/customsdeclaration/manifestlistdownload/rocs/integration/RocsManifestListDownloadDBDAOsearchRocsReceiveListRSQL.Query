<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="RocsManifestListDownloadDBDAOsearchRocsReceiveListRSQL">
			<desc><![CDATA[EDI 현황]]></desc>
			<sql><![CDATA[
#if (${vsl_cd}!= '')
SELECT	DECODE(A.RTM_EDI_MSG_TP_CD,'A','ACCEPT','R','REJECT') RTM_EDI_MSG_TP_CD,
		A.MSG_SND_DT,
		A.BL_NO,
		A.RTM_EDI_ERR_ID,
		A.ERR_DESC,
		A.ERR_CTNT,
		A.OFC_CD,
		A.CRE_USR_ID,
		B.ROWCNT,
		C.VVD VVD_NUMBER,
		C.POL_CD,
		C.POD_CD,
		'C' HIST
FROM	BKG_CSTMS_RTM_EDI_LOG A,
		( SELECT MAX ( MSG_SND_DT ) MAX_MSG_DT,
				BL_NO,
				COUNT ( RTM_EDI_MSG_TP_CD ) ROWCNT
			FROM BKG_CSTMS_RTM_EDI_LOG
		   WHERE RCV_SND_DIV_CD = 'R'
     		 GROUP BY BL_NO                       )  B,
		( SELECT 
			DISTINCT D.BL_NO BL_NO,
			D.MSG_SND_DT MAX_MSG_DT,
			D.VSL_CD||D.SKD_VOY_NO||D.SKD_DIR_CD VVD,
			D.POL_CD POL_CD,
			D.POD_CD POD_CD
			FROM BKG_CSTMS_RTM_EDI_LOG D, 
				(SELECT MAX(MSG_SND_DT) MAX_MSG_DT, BL_NO 
				FROM BKG_CSTMS_RTM_EDI_LOG 
				WHERE RCV_SND_DIV_CD = 'S'
#if (${vsl_cd}!= '')
				AND   VSL_CD	=	@[vsl_cd]
				AND   SKD_VOY_NO =  @[skd_voy_no]
				AND   SKD_DIR_CD   = @[skd_dir_cd]
#end 
				GROUP BY BL_NO) E
			WHERE RCV_SND_DIV_CD = 'S'
			AND D.BL_NO = E.BL_NO
			AND D.MSG_SND_DT = E.MAX_MSG_DT
#if (${vsl_cd}!= '')
			AND    D.VSL_CD	=	@[vsl_cd]
			AND    D.SKD_VOY_NO =  @[skd_voy_no]
			AND    D.SKD_DIR_CD   = @[skd_dir_cd]
#end
#if (${bl_no}!= '')
       		AND D.BL_NO	=	@[bl_no]
#end							   
#if (${pol_cd}!= '')
			AND	D.POL_CD	=	@[pol_cd]
#end

#if (${pod_cd}!= '' )
			AND	D.POD_CD	=	@[pod_cd]
#end
			GROUP BY D.MSG_SND_DT, D.BL_NO, D.VSL_CD||D.SKD_VOY_NO||D.SKD_DIR_CD, D.POL_CD, D.POD_CD
) C
WHERE	A.RCV_SND_DIV_CD = 'R' 
#if (${msg_type}!= '')
	AND  RTM_EDI_MSG_TP_CD	=	@[msg_type]
#end
	AND A.MSG_SND_DT = B.MAX_MSG_DT
	AND	A.BL_NO	= B.BL_NO
	AND	A.BL_NO = C.BL_NO
ORDER BY A.RTM_EDI_MSG_TP_CD, A.BL_NO, A.MSG_SND_DT
#else
SELECT	DECODE(A.RTM_EDI_MSG_TP_CD,'A','ACCEPT','R','REJECT') RTM_EDI_MSG_TP_CD,
		A.MSG_SND_DT,
		A.BL_NO,
		A.RTM_EDI_ERR_ID,
		A.ERR_DESC,
		A.ERR_CTNT,
		A.OFC_CD,
		A.CRE_USR_ID,
		B.ROWCNT,
		C.VVD VVD_NUMBER,
		C.POL_CD,
		C.POD_CD,
		'C' HIST
FROM	BKG_CSTMS_RTM_EDI_LOG A,
		( SELECT MAX ( MSG_SND_DT ) MAX_MSG_DT,
				BL_NO,
				COUNT ( RTM_EDI_MSG_TP_CD ) ROWCNT
			FROM BKG_CSTMS_RTM_EDI_LOG
		   WHERE RCV_SND_DIV_CD = 'R'
#if (${vsl_cd}!= '')
			 AND VSL_CD	=	@[vsl_cd]
			 AND SKD_VOY_NO =  @[skd_voy_no]
			 AND SKD_DIR_CD   = @[skd_dir_cd]
#end 
#if (${msg_type}!= '')
       		 AND RTM_EDI_MSG_TP_CD	=	@[msg_type]
#end
#if (${bl_no}!= '')
       		 AND BL_NO	=	@[bl_no]
#end
#if (${vps_eta_start_dt}!= '' && ${date_gubun}== '2')     	        
        	 AND MSG_SND_DT >= TO_DATE(REPLACE(REPLACE(@[vps_eta_start_dt], '-', ''), '/', '') ||' '|| REPLACE(REPLACE(@[fromtime], ':', '')||'00', '-',''),'YYYYMMDDHH24:MI:SS')
#end
#if (${vps_eta_end_dt}!= '' && ${date_gubun}== '2')		  
         	 AND MSG_SND_DT <= TO_DATE(REPLACE(REPLACE(@[vps_eta_end_dt], '-', ''), '/', '') ||' '|| REPLACE(REPLACE(@[totime], ':', '')||'59', '-',''),'YYYYMMDDHH24:MI:SS')
#end
     		 GROUP BY BL_NO                       )  B,
		( SELECT 
			DISTINCT D.BL_NO BL_NO,
			D.MSG_SND_DT MAX_MSG_DT,
			D.VSL_CD||D.SKD_VOY_NO||D.SKD_DIR_CD VVD,
			D.POL_CD POL_CD,
			D.POD_CD POD_CD
			FROM BKG_CSTMS_RTM_EDI_LOG D, 
				(SELECT MAX(MSG_SND_DT) MAX_MSG_DT, BL_NO 
				FROM BKG_CSTMS_RTM_EDI_LOG 
				WHERE RCV_SND_DIV_CD = 'S'
#if (${vsl_cd}!= '')
				AND   VSL_CD	=	@[vsl_cd]
				AND   SKD_VOY_NO =  @[skd_voy_no]
				AND   SKD_DIR_CD   = @[skd_dir_cd]
#end 
				GROUP BY BL_NO) E
			WHERE RCV_SND_DIV_CD = 'S'
			AND D.BL_NO = E.BL_NO
			AND D.MSG_SND_DT = E.MAX_MSG_DT
#if (${vsl_cd}!= '')
			AND    D.VSL_CD	=	@[vsl_cd]
			AND    D.SKD_VOY_NO =  @[skd_voy_no]
			AND    D.SKD_DIR_CD   = @[skd_dir_cd]
#end
							   
#if (${pol_cd}!= '')
			AND	D.POL_CD	=	@[pol_cd]
#end

#if (${pod_cd}!= '' )
			AND	D.POD_CD	=	@[pod_cd]
#end
			GROUP BY D.MSG_SND_DT, D.BL_NO, D.VSL_CD||D.SKD_VOY_NO||D.SKD_DIR_CD, D.POL_CD, D.POD_CD
) C
WHERE	A.RCV_SND_DIV_CD = 'R' 
#if (${msg_type}!= '')
	AND  RTM_EDI_MSG_TP_CD	=	@[msg_type]
#end
	AND A.MSG_SND_DT = B.MAX_MSG_DT
	AND	A.BL_NO	= B.BL_NO
	AND	A.BL_NO	= C.BL_NO(+)
ORDER BY A.RTM_EDI_MSG_TP_CD, A.BL_NO, A.MSG_SND_DT
#end			]]></sql>
			<params>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="msg_type" type="12" value="" out="N"/>
				<param name="vps_eta_start_dt" type="12" value="" out="N"/>
				<param name="fromtime" type="12" value="" out="N"/>
				<param name="vps_eta_end_dt" type="12" value="" out="N"/>
				<param name="totime" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
