<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="EurCustomsTransmissionDBDAOsearchBlCustRSQL">
			<desc><![CDATA[ENS 쪽 CUST 정보를 조회 한다.]]></desc>
			<sql><![CDATA[
/* Eur24BlCustListVOs Eur24CustomsTransmissionDBDAOSearchBlCust ( String blNo , String vslCd , String skdVoyNo , String skdDirCd , String cstmsPortCd) */
SELECT *
FROM (
SELECT 
  DECODE(BKG_CUST_TP_CD,'C','CN','F','CG','S','CZ','CX') AS BL_PT_TYPE /* 76 CN-Consignee, CZ-Shipper, CG-Forwarder, CX-Notify  */
 , '' AS BL_PT_TIN /* 77 */
 , EORI_NO            AS  BL_PT_EORI       /* 78 */
 , BKG_SPCLCHAR_CONV_FNC(CUST_NM,'X')      AS  BL_PT_NAME       /* 79 */
 , BKG_SPCLCHAR_CONV_FNC(CUST_ADDR,'X')    AS  BL_PT_ADDRESS    /* 80 */
 , EUR_CSTMS_ST_NM    AS  BL_PT_STREET     /* 81 */
 , CUST_CTY_NM        AS  BL_PT_CITY       /* 82 */
 , CUST_ZIP_ID        AS  BL_PT_POSTAL_CD  /* 83 */
 , CSTMS_DECL_CNT_CD  AS  BL_PT_CNT_CD     /* 84 */    
 , (SELECT ATTR_CTNT2
      FROM BKG_CSTMS_CD_CONV_CTNT
     WHERE CNT_CD       = 'EU'
       AND CSTMS_DIV_ID = 'BL_PT_AG_ATLAS'
       AND ATTR_CTNT1   = X.CUST_CNT_CD || X.CUST_SEQ
   ) AS BL_PT_AG_ATLAS
 ,   VSL_CD,            SKD_VOY_NO,       SKD_DIR_CD,  BL_NO,      CSTMS_PORT_CD, BKG_CUST_TP_CD
 , TRDR_ID_NO,        EORI_NO,          CUST_NM,     CUST_ADDR,    CUST_CTY_NM
 , CSTMS_DECL_CNT_CD, CUST_ZIP_ID 
 , CRE_USR_ID, CRE_DT,UPD_USR_ID,       UPD_DT
FROM  BKG_CSTMS_EUR_CUST X
WHERE (X.VSL_CD, X.SKD_VOY_NO, X.SKD_DIR_CD, X.BL_NO, X.CSTMS_PORT_CD) = (
            SELECT VSL_CD, SKD_VOY_NO, SKD_DIR_CD, BL_NO, CSTMS_PORT_CD
            FROM BKG_CSTMS_ADV_EUR_SND
            WHERE 1=1
            AND MSG_SND_NO = (
                            SELECT NVL(MAX(A.MSG_SND_NO), ' ')
                            FROM BKG_CSTMS_ADV_EUR_SND A 
                            WHERE A.MSG_SND_NO LIKE @[bl_no] ||'%'
                            AND EUR_EDI_MSG_TP_ID = 'ENS'
                            GROUP BY A.BL_NO
                        )
        )            
AND BKG_CUST_TP_CD IN ('N','F','S')
UNION ALL
SELECT /* EDI 전송시 Consignee 항목 bkg_booking.CUST_TO_ORD_FLG='Y') 일때, Notify 정보 사용. S -SHIPPER, N-NOTIFY */
  'CN' AS BL_PT_TYPE /* 76 */
 , '' AS BL_PT_TIN /* 77 */
 , EORI_NO            AS  BL_PT_EORI       /* 78 */
 , BKG_SPCLCHAR_CONV_FNC(CUST_NM,'X')      AS  BL_PT_NAME       /* 79 */
 , BKG_SPCLCHAR_CONV_FNC(CUST_ADDR,'X')    AS  BL_PT_ADDRESS    /* 80 */
 , EUR_CSTMS_ST_NM    AS  BL_PT_STREET     /* 81 */
 , CUST_CTY_NM        AS  BL_PT_CITY       /* 82 */
 , CUST_ZIP_ID        AS  BL_PT_POSTAL_CD  /* 83 */
 , CSTMS_DECL_CNT_CD  AS  BL_PT_CNT_CD     /* 84 */    
 , (SELECT ATTR_CTNT2
      FROM BKG_CSTMS_CD_CONV_CTNT
     WHERE CNT_CD       = 'EU'
       AND CSTMS_DIV_ID = 'BL_PT_AG_ATLAS'
       AND ATTR_CTNT1   = X.CUST_CNT_CD || X.CUST_SEQ
   ) AS BL_PT_AG_ATLAS
 ,   VSL_CD,            SKD_VOY_NO,       SKD_DIR_CD,  BL_NO,      CSTMS_PORT_CD, BKG_CUST_TP_CD
 , TRDR_ID_NO,        EORI_NO,          CUST_NM,     CUST_ADDR,    CUST_CTY_NM
 , CSTMS_DECL_CNT_CD, CUST_ZIP_ID
 , CRE_USR_ID, CRE_DT,UPD_USR_ID,       UPD_DT
FROM  BKG_CSTMS_EUR_CUST X
WHERE (X.VSL_CD, X.SKD_VOY_NO, X.SKD_DIR_CD, X.BL_NO, X.CSTMS_PORT_CD) = (
            SELECT VSL_CD, SKD_VOY_NO, SKD_DIR_CD, BL_NO, CSTMS_PORT_CD
            FROM BKG_CSTMS_ADV_EUR_SND
            WHERE 1=1
            AND MSG_SND_NO = (
                            SELECT NVL(MAX(A.MSG_SND_NO), ' ')
                            FROM BKG_CSTMS_ADV_EUR_SND A 
                            WHERE A.MSG_SND_NO LIKE @[bl_no] ||'%'
                            AND EUR_EDI_MSG_TP_ID = 'ENS'
                            GROUP BY A.BL_NO
                        )
        )            
AND BKG_CUST_TP_CD = DECODE((SELECT CUST_TO_ORD_FLG FROM BKG_BOOKING WHERE BL_NO = X.BL_NO), 'Y','N','C')
)
ORDER BY DECODE(BL_PT_TYPE,'CZ',1,'CN',2,'CX',3,4)			]]></sql>
			<params>
				<param name="bl_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
