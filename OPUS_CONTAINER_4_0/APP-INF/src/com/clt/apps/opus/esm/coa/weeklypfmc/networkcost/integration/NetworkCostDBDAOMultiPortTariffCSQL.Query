<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="NetworkCostDBDAOMultiPortTariffCSQL">
			<desc><![CDATA[]]></desc>
			<sql><![CDATA[
MERGE INTO COA_PORT_TRF B1 USING
(
 SELECT @[cost_yrmon]           COST_YRMON
      , @[slan_cd]              SLAN_CD
      , @[skd_dir_cd]           SKD_DIR_CD
      , NVL(@[tml_cd], @[port]||@[cy]) TML_CD
      , @[locl_curr_cd]         LOCL_CURR_CD
      , @[locl_port_amt]        LOCL_PORT_AMT
      , @[locl_cnl_amt]         LOCL_CNL_AMT
      , DECODE(@[upload_flg], 'Y', MAX(ROUND(@[locl_port_amt]/USD_LOCL_XCH_RT,3)) KEEP(DENSE_RANK FIRST ORDER BY ACCT_XCH_RT_YRMON DESC)
                            , @[port_usd_amt]) PORT_USD_AMT
      , DECODE(@[upload_flg], 'Y', MAX(ROUND(@[locl_cnl_amt]/USD_LOCL_XCH_RT,3)) KEEP(DENSE_RANK FIRST ORDER BY ACCT_XCH_RT_YRMON DESC)
                            , @[cnl_usd_amt]) CNL_USD_AMT
      , @[cre_usr_id]           CRE_USR_ID
      , @[upd_usr_id]           UPD_USR_ID
      , @[vsl_clss_capa]        VSL_CLSS_CAPA  
   FROM DUAL A
      , GL_MON_XCH_RT B
  WHERE B.ACCT_XCH_RT_YRMON BETWEEN TO_CHAR(ADD_MONTHS(TO_DATE(@[cost_yrmon],'YYYYMM'),-1),'YYYYMM') AND @[cost_yrmon]	
    AND B.ACCT_XCH_RT_LVL   = '1' 		
    AND B.CURR_CD = @[locl_curr_cd]
)
B2 ON (     B1.COST_YRMON       = B2.COST_YRMON 
        AND B1.SLAN_CD          = B2.SLAN_CD 
        AND B1.SKD_DIR_CD       = B2.SKD_DIR_CD 
        AND B1.VSL_CLSS_CAPA    = B2.VSL_CLSS_CAPA
        AND B1.TML_CD           = B2.TML_CD
        AND B1.LOCL_CURR_CD     = B2.LOCL_CURR_CD )
WHEN MATCHED THEN
         UPDATE
            SET B1.LOCL_PORT_AMT= B2.LOCL_PORT_AMT
              , B1.LOCL_CNL_AMT = B2.LOCL_CNL_AMT
              , B1.PORT_USD_AMT = B2.PORT_USD_AMT
              , B1.CNL_USD_AMT  = B2.CNL_USD_AMT
              , B1.UPD_USR_ID   = B2.UPD_USR_ID
              , B1.UPD_DT       = SYSDATE 
WHEN NOT MATCHED THEN
         INSERT (
                B1.COST_YRMON
              , B1.SLAN_CD
              , B1.SKD_DIR_CD
              , B1.TML_CD
              , B1.LOCL_CURR_CD
              , B1.LOCL_PORT_AMT
              , B1.LOCL_CNL_AMT
              , B1.PORT_USD_AMT
              , B1.CNL_USD_AMT
              , B1.CRE_USR_ID
              , B1.CRE_DT
              , B1.UPD_USR_ID
              , B1.UPD_DT
              , B1.VSL_CLSS_CAPA )
         VALUES (
                B2.COST_YRMON
              , B2.SLAN_CD
              , B2.SKD_DIR_CD
              , B2.TML_CD
              , B2.LOCL_CURR_CD
              , B2.LOCL_PORT_AMT
              , B2.LOCL_CNL_AMT
              , B2.PORT_USD_AMT
              , B2.CNL_USD_AMT
              , B2.CRE_USR_ID
              , SYSDATE
              , B2.UPD_USR_ID
              , SYSDATE
              , B2.VSL_CLSS_CAPA )			]]></sql>
			<params>
				<param name="cost_yrmon" type="12" value="" out="Y"/>
				<param name="slan_cd" type="12" value="" out="Y"/>
				<param name="skd_dir_cd" type="12" value="" out="Y"/>
				<param name="tml_cd" type="12" value="" out="Y"/>
				<param name="port" type="12" value="" out="N"/>
				<param name="cy" type="12" value="" out="N"/>
				<param name="locl_curr_cd" type="12" value="" out="Y"/>
				<param name="locl_port_amt" type="12" value="" out="Y"/>
				<param name="locl_cnl_amt" type="12" value="" out="Y"/>
				<param name="upload_flg" type="12" value="" out="N"/>
				<param name="port_usd_amt" type="12" value="" out="Y"/>
				<param name="cnl_usd_amt" type="12" value="" out="Y"/>
				<param name="cre_usr_id" type="12" value="" out="Y"/>
				<param name="upd_usr_id" type="12" value="" out="Y"/>
				<param name="vsl_clss_capa" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
