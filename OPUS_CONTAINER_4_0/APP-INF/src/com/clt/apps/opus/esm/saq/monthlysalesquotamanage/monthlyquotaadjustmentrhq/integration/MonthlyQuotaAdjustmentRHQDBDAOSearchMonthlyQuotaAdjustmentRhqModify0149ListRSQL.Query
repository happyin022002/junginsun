<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="MonthlyQuotaAdjustmentRHQDBDAOSearchMonthlyQuotaAdjustmentRhqModify0149ListRSQL">
			<desc><![CDATA[MonthlyQuotaAdjustmentRHQ 세부 조정을 위한 조회]]></desc>
			<sql><![CDATA[
WITH TMP_INPUT_PARMAS AS
	   (SELECT
		    MQTA_STEP_CD,
		    BSE_YR,
		    BSE_QTR_CD,
		    TRD_CD,
		    DIR_CD,
		    MQTA_VER_NO,
		    SAQ_STS_CD,
		    GLINE_VER_NO,
		    CRE_OFC_CD,
		    INCL_PORT_FLG
	    FROM   SAQ_MON_QTA_STEP_VER
	    WHERE  MQTA_STEP_CD = @[mqta_step_cd]
	    AND    GLINE_VER_NO = @[gline_ver_no]
	    AND    MQTA_VER_NO = @[mqta_ver_no]
	    AND    BSE_YR = @[bse_yr]
	    AND    BSE_QTR_CD = @[bse_qtr_cd]
	    AND    TRD_CD = @[trd_cd]
	    AND    DIR_CD = @[dir_cd] )

	SELECT SUB_TRD_CD, LANE_GRP, OFC_CD,
		MIN(CASE WHEN CODE='cur' THEN GRP_SEQ END) AS GRP_SEQ1,
		MIN(CASE WHEN CODE='cur' THEN TOT_LOD END) AS LOAD1,
		MIN(CASE WHEN CODE='cur' THEN TOT_RPB END) AS G_RPB1,
		MIN(CASE WHEN CODE='next1' THEN GRP_SEQ END) AS GRP_SEQ2,
		MIN(CASE WHEN CODE='next1' THEN TOT_LOD END) AS LOAD2,
		MIN(CASE WHEN CODE='next1' THEN TOT_RPB END) AS G_RPB2,
		MIN(CASE WHEN CODE='next2' THEN GRP_SEQ END) AS GRP_SEQ3,
		MIN(CASE WHEN CODE='next2' THEN TOT_LOD END) AS LOAD3,
		MIN(CASE WHEN CODE='next2' THEN TOT_RPB END) AS G_RPB3,
		MIN(TOT_BSA) TOT_BSA,
		MIN(RLANE_CD) RLANE_CD,
		MIN(SPRT_GRP_CD) SPRT_GRP_CD,
		MIN(BSA_GRP_CD) BSA_GRP_CD,
		MIN(CTRT_RGN_OFC_CD) CTRT_RGN_OFC_CD,
		MIN(BSE_MON) BSE_MON,
		MIN(TRD_CD) TRD_CD

	FROM
	   (
	   SELECT
	    RHQ.BSE_YR,
	    DECODE(RHQ.BSE_YR||RHQ.BSE_MON, RHQ.BSE_YR||@[month1], 'cur',
		TO_CHAR(ADD_MONTHS(TO_DATE(RHQ.BSE_YR||@[month2],'yyyymm'),1),'yyyymm'), 'next1',
		TO_CHAR(ADD_MONTHS(TO_DATE(RHQ.BSE_YR||@[month3],'yyyymm'),2),'yyyymm'), 'next2') CODE,

	    RANK() OVER (PARTITION BY RHQ.BSE_MON, SUBSTR(VVD.LANE_GRP, 0,7), RHQ.CTRT_RGN_OFC_CD ORDER BY SUBSTR(VVD.LANE_GRP, 9))  AS GRP_SEQ,
	    RHQ.SUB_TRD_CD, --hidden
	    RHQ.RLANE_CD AS RLANE_CD,  --hidden
	    RHQ.SPRT_GRP_CD AS SPRT_GRP_CD,  --hidden
	    RHQ.BSA_GRP_CD AS BSA_GRP_CD,  --hidden
	    RHQ.CTRT_RGN_OFC_CD AS CTRT_RGN_OFC_CD,  --hidden
	    RHQ.BSE_MON AS BSE_MON, --hidden
	    VVD.LANE_GRP AS LANE_GRP,
	    RHQ.CTRT_RGN_OFC_CD AS OFC_CD,
	    VVD.TOT_BSA AS TOT_BSA ,
	    RHQ.LOD_QTY / @[unit_flag] AS TOT_LOD ,
	    RHQ.GRS_RPB_REV * @[unit_flag] AS TOT_RPB,
		VVD.TRD_CD

	 FROM   TMP_INPUT_PARMAS INP,

	       (
		SELECT -- saq_mon_tgt_vvd_adj BSA
		    VVD.BSE_MON,
		    VVD.SUB_TRD_CD,
		    VVD.RLANE_CD,
		    VVD.SPRT_GRP_CD,
		    VVD.BSA_GRP_CD,
		    VVD.TRD_CD,
		    (VVD.RLANE_CD||'-'||VVD.SPRT_GRP_CD||'-'||VVD.BSA_GRP_CD) AS LANE_GRP,
		    MIN(VVD.FNL_BSA_CAPA) AS TOT_BSA
		FROM   SAQ_MON_TGT_VVD_ADJ VVD, TMP_INPUT_PARMAS INP
		WHERE  VVD.BSE_YR = INP.BSE_YR
		AND    VVD.BSE_QTR_CD = INP.BSE_QTR_CD
		AND    VVD.GLINE_VER_NO = INP.GLINE_VER_NO
		AND    VVD.TRD_CD = INP.TRD_CD
		AND    VVD.DIR_CD = INP.DIR_CD
		GROUP BY VVD.BSE_MON, VVD.SUB_TRD_CD,VVD.RLANE_CD,VVD.SPRT_GRP_CD,VVD.BSA_GRP_CD,VVD.TRD_CD

		) VVD,
	       SAQ_MON_QTA_RHQ RHQ
	WHERE  RHQ.MQTA_STEP_CD = INP.MQTA_STEP_CD
	AND    RHQ.BSE_YR = INP.BSE_YR
	AND    RHQ.BSE_QTR_CD = INP.BSE_QTR_CD
	AND    RHQ.TRD_CD = INP.TRD_CD
	AND    RHQ.DIR_CD = INP.DIR_CD
	AND    RHQ.MQTA_VER_NO = INP.MQTA_VER_NO
	AND    RHQ.BSE_MON = VVD.BSE_MON
	AND    RHQ.SUB_TRD_CD = VVD.SUB_TRD_CD
	AND    RHQ.RLANE_CD = VVD.RLANE_CD
	AND    RHQ.SPRT_GRP_CD = VVD.SPRT_GRP_CD
	AND    RHQ.BSA_GRP_CD = VVD.BSA_GRP_CD
	)

	GROUP BY SUB_TRD_CD, LANE_GRP, OFC_CD
	ORDER BY SUB_TRD_CD, LANE_GRP, OFC_CD			]]></sql>
			<params>
				<param name="mqta_step_cd" type="12" value="" out="N"/>
				<param name="gline_ver_no" type="12" value="" out="N"/>
				<param name="mqta_ver_no" type="12" value="" out="N"/>
				<param name="bse_yr" type="12" value="" out="N"/>
				<param name="bse_qtr_cd" type="12" value="" out="N"/>
				<param name="trd_cd" type="12" value="" out="N"/>
				<param name="dir_cd" type="12" value="" out="N"/>
				<param name="month1" type="12" value="" out="N"/>
				<param name="month2" type="12" value="" out="N"/>
				<param name="month3" type="12" value="" out="N"/>
				<param name="unit_flag" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
