<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BookingMasterMgtDBDAOSearchBDRTimeVORSQL">
			<desc><![CDATA[Manual로 BDR을 처리]]></desc>
			<sql><![CDATA[
SELECT	T.BKG_NO
,		T.BL_NO
,       T.VSL_CD
,       T.SKD_VOY_NO
,       T.SKD_DIR_CD
,		T.VVD_CD
,       T.SLAN_CD
,       T.POL_CD
,       T.POD_CD
,       T.VPS_PORT_CD
,       T.BDR_DYS
,       T.ETD_DT
,       T.BDR_DATE
,       T.BDR_FLG
,		T.BKG_STS_CD
,		T.CRE_USR_ID
,		T.CRE_DT
,		T.UPD_USR_ID
,		T.USR_NM
,   	T.OFC_CD
,		T.UPD_DT
,		T.RDO_TRUNK_FEEDER
,		T.TOT_BOOKING_CNT
,       T.VVD_BDR
,       CASE WHEN T.BDR_FLG != 'Y' THEN T.TOT_BOOKING_CNT - T.BTR_BOOKING_CNT ELSE T.BTR_BOOKING_CNT END BTR_BOOKING_CNT
,       'B' cgor_team_cd
,       'B/L BDR' cgo_evnt_nm
,       to_char(sysdate,'yyyymmddhh24mmss') evnt_dt
,       'SYS' evnt_ofc_cd
,       'BDRBookingSetting' evnt_usr_id
,       'N' obl_chk
,      (SELECT CASE WHEN (A.BL_TP_CD||B.OBL_RLSE_FLG) = 'WY' THEN 'Y' 
                                     WHEN B.OBL_SRND_FLG = 'Y'	THEN 'Y' 
                                     ELSE 'N' END
       	FROM 	BKG_BOOKING A,
        		BKG_BL_ISS B
        WHERE 	A.BKG_NO = B.BKG_NO
        AND 	A.BKG_NO = T.BKG_NO) AS OBL_ISS_FLAG

--,       (SELECT ISS.OBL_ISS_FLG FROM BKG_BL_ISS ISS WHERE ISS.BKG_NO = T.BKG_NO ) AS OBL_ISS_FLAG
,		T.BKG_BDR_USR_ID
, 		T.BKG_MNL_BDR_UPD_DT
,		T.BKG_OFC_CD
,		T.VVD_BDR_USR_ID
, 		T.VVD_MNL_BDR_UPD_DT
,		T.VVD_OFC_CD
FROM 	(
SELECT 	A.BKG_NO
,		A.BL_NO
,       B.VSL_CD
,       B.SKD_VOY_NO
,       B.SKD_DIR_CD
,		B.VSL_CD || B.SKD_VOY_NO || B.SKD_DIR_CD VVD_CD
,       B.SLAN_CD
,       B.POL_CD
,       B.POD_CD
,       D.VPS_PORT_CD
,       DECODE(@[rdo_trunk_feeder], 'T', C.TRNK_BDR_DYS, C.FDR_BDR_DYS) BDR_DYS
,		TO_CHAR(D.VPS_ETD_DT, 'YYYY-MM-DD HH24:MI') ETD_DT
,       (SELECT BDR_DT FROM BKG_BL_DOC K WHERE K.BKG_NO = A.BKG_NO) AS BDR_DATE
,       G.BDR_FLG
,		A.BKG_STS_CD
,		G.CRE_USR_ID
,		G.CRE_DT
,		G.UPD_USR_ID
,   	U.USR_NM
,   	U.OFC_CD
,		G.UPD_DT
,		'' RDO_TRUNK_FEEDER
,       CASE WHEN  TRNK_AUTO_BDR_FLG = 'Y' OR TRNK_MNL_BDR_FLG = 'Y' OR TRNK_BDR_FLG = 'Y'
                           OR FDR_AUTO_BDR_FLG = 'Y' OR FDR_MNL_BDR_FLG = 'Y' OR FDR_BDR_FLG = 'Y' THEN
                           'Yes' ELSE 'No' END  AS VVD_BDR
,		COUNT(*) OVER() TOT_BOOKING_CNT
,       COUNT(*) OVER(PARTITION BY G.BDR_FLG) BTR_BOOKING_CNT
,		F.BDR_USR_ID VVD_BDR_USR_ID
,		F.MNL_BDR_UPD_DT VVD_MNL_BDR_UPD_DT
,		V.OFC_CD VVD_OFC_CD
,		G.BDR_USR_ID BKG_BDR_USR_ID
,		G.MNL_BDR_UPD_DT BKG_MNL_BDR_UPD_DT 
,		W.OFC_CD BKG_OFC_CD
  FROM BKG_BOOKING A,
       BKG_VVD B,
       BKG_BDR_TM C,
       VSK_VSL_PORT_SKD D
#if (${bkg_no} != '') 
		,VSK_VSL_PORT_SKD E,
#else 
	,
       (SELECT VSL_CD,
               SKD_VOY_NO,
               SKD_DIR_CD,
               VPS_PORT_CD,
               CLPT_IND_SEQ
          FROM VSK_VSL_PORT_SKD
         WHERE 1=1
#if (${vvd_cd} != '') 	
		 AND   VSL_CD = SUBSTR(@[vvd_cd],1,4)
         AND   SKD_VOY_NO = SUBSTR(@[vvd_cd],5,4)
         AND   SKD_DIR_CD = SUBSTR(@[vvd_cd],9,1)
#end
         ) E,
#end	
       BKG_VVD_BDR_LOG F,
       BKG_BL_DOC G,
	   COM_USER U,
	   COM_USER V,
	   COM_USER W			
 WHERE 1=1
 AND    A.BKG_STS_CD <> 'X'
 --AND	A.BKG_STS_CD IN ('F','S')   
 AND   A.BKG_CGO_TP_CD != 'P'
 AND   B.BKG_NO = A.BKG_NO 
 AND   B.VSL_PRE_PST_CD = DECODE(@[rdo_trunk_feeder], 'T', 'T', 'S') 
 AND   B.VSL_SEQ = DECODE(@[rdo_trunk_feeder], 'T', '0', '1') 

#if (${vvd_cd} != '') 
 AND   B.VSL_CD = SUBSTR(@[vvd_cd],1,4)
 AND   B.SKD_VOY_NO = SUBSTR(@[vvd_cd],5,4)
 AND   B.SKD_DIR_CD = SUBSTR(@[vvd_cd],9,1)
#end

#if (${pol_cd} != '') 
 AND   B.POL_CD = @[pol_cd]
 AND   B.POD_CD = NVL(@[pod_cd], B.POD_CD) 
#end 
 
#if (${bkg_no} != '') 
 AND   A.BKG_NO = @[bkg_no]
#end
 AND   C.SLAN_CD(+) = B.SLAN_CD 
 AND   C.SKD_DIR_CD(+) = B.SKD_DIR_CD 
 AND   C.POL_CD(+) = B.POL_CD 
 AND   C.POD_CD(+) = B.POD_CD 
 AND   D.VSL_CD = B.VSL_CD 
 AND   D.SKD_VOY_NO = B.SKD_VOY_NO 
 AND   D.SKD_DIR_CD = B.SKD_DIR_CD 
 AND   D.VPS_PORT_CD = B.POL_CD 
 AND   D.CLPT_IND_SEQ = B.POL_CLPT_IND_SEQ 
 AND   D.VSL_CD = E.VSL_CD 
 AND   D.SKD_VOY_NO = E.SKD_VOY_NO 
 AND   D.SKD_DIR_CD = E.SKD_DIR_CD
 AND   D.VPS_PORT_CD = E.VPS_PORT_CD 
 AND   D.CLPT_IND_SEQ = E.CLPT_IND_SEQ 
 AND   B.VSL_CD = F.VSL_CD(+) 
 AND   B.SKD_VOY_NO = F.SKD_VOY_NO(+) 
 AND   B.SKD_DIR_CD = F.SKD_DIR_CD(+) 
 AND   B.POL_CLPT_IND_SEQ = F.POL_CLPT_IND_SEQ(+) 
 AND   B.POD_CLPT_IND_SEQ = F.POD_CLPT_IND_SEQ(+) 
 AND   B.POL_CD = F.POL_CD(+) 
 AND   B.POD_CD = F.POD_CD(+)
 AND   A.BKG_NO = G.BKG_NO
 AND   G.UPD_USR_ID = U.USR_ID(+)
 AND   F.BDR_USR_ID = V.USR_ID(+)
 AND   G.BDR_USR_ID = W.USR_ID(+)
) T
WHERE  1=1
#if (${bdr_flg} != '') 
AND BDR_FLG  = 	 @[bdr_flg] 
#end
ORDER BY T.BKG_NO
,		T.BL_NO
,       T.VSL_CD
,       T.SKD_VOY_NO
,       T.SKD_DIR_CD
,		T.VVD_CD			]]></sql>
			<params>
				<param name="rdo_trunk_feeder" type="12" value="T" out="N"/>
				<param name="vvd_cd" type="12" value="AFSDFDSFDFSDF" out="N"/>
				<param name="pol_cd" type="12" value="SDFSD" out="N"/>
				<param name="pod_cd" type="12" value="SDFSDF" out="N"/>
				<param name="bkg_no" type="12" value="SFSDFSDFSDF" out="N"/>
				<param name="bdr_flg" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
