<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="IsraelCustomsTransmissionDBDAOsearchBlGeneralRSQL">
			<desc><![CDATA[searchBlGeneral]]></desc>
			<sql><![CDATA[
SELECT

DECODE(MSG_ID,'915','FROBDAT','FROBAMD') AS MSG_ID_CD

,Z.*
FROM (
SELECT

 BL_NO||'.'||LPAD(PRN_SEQ,3,'0')||'.'||DECODE(MRN,NULL,'915','913') AS PRN
,DECODE(MRN,NULL,'915','913') AS MSG_ID

,BKG_GET_TOKEN_FNC(CTMS_SETUP,1) AS CT_NAME
,BKG_GET_TOKEN_FNC(CTMS_SETUP,2) AS CT_POSITION
,BKG_GET_TOKEN_FNC(CTMS_SETUP,3) AS CT_EMAIL
,BKG_GET_TOKEN_FNC(CTMS_SETUP,4) AS CT_TEL
,BKG_GET_TOKEN_FNC(CTMS_SETUP,5) AS CT_FAX

,Y.*

FROM (
SELECT 
    (SELECT COUNT(*)+1 FROM BKG_CSTMS_EUR_IB_SND
     WHERE 1=1
	   AND CNT_CD = 'IL'
       AND EDI_MSG_TP_ID ='ILC'
	   AND BL_NO = BK.BL_NO
    ) AS PRN_SEQ

   , (SELECT MVMT_REF_NO FROM BKG_CSTMS_EUR_IB_RCV
     WHERE 1=1
	   AND CNT_CD = 'IL'
       AND MSG_RCV_NO = (SELECT MAX(MSG_SND_NO)
                             FROM BKG_CSTMS_EUR_IB_SND
                            WHERE 1=1
                              AND CNT_CD = 'IL'
                              AND BL_NO          = BK.BL_NO
                              AND CSTMS_PORT_CD  = BV.POL_CD
                              AND (VSL_CD != BV.VSL_CD 
                               OR SKD_VOY_NO != BV.SKD_VOY_NO 
                               OR SKD_DIR_CD != BV.SKD_DIR_CD) )
     ) AS MRN

   , VSL.LLOYD_NO AS TRANS_IDENTITY
   , VSL.VSL_RGST_CNT_CD  AS TRANS_NATION
   , VSL.VSL_ENG_NM AS VSL_NAME
   , BD.POL_CD AS LOAD_LOC_CD
   , BD.POL_NM AS LOAD_LOC_NAME
   , '' AS LOAD_OFC_CD
   , TO_CHAR(SKD1.VPS_ETD_DT,'yyyymmddhh24miss') AS LOAD_LOC_ETD
  
   , BK.POD_CD AS UNLOAD_LOC_CD

   , (SELECT LOC_NM 
        FROM MDM_LOCATION 
       WHERE LOC_CD = BK.POD_CD
      ) AS UNLOAD_LOC_NAME

    , TO_CHAR(SKD2.INIT_ETA_DT,'yyyymmddhh24miss') AS UNLOAD_LOC_ETA    
    , TO_CHAR(SKD2.INIT_ETA_DT,'yyyymmddhh24miss') AS UNLOAD_LOC_ETA_HIS    

--   , (SELECT A.EUR_CSTMS_OFC_ID FROM BKG_CSTMS_EUR_CD_STUP A
--       WHERE A.PORT_CD = X.CSTMS_PORT_CD
--         AND A.TML_CD IN ('ALL',X.CSTMS_YD_CD)
--          AND ROWNUM=1 
--      ) AS UNLOAD_OFC_CD /* 21 */ 
   , '' AS UNLOAD_OFC_CD
   
   , (SELECT /*+ INDEX_DESC(K XAK4VSK_VSL_PORT_SKD) */ VPS_PORT_CD
       FROM VSK_VSL_PORT_SKD K
      WHERE K.VSL_CD = SKD3.VSL_CD
        AND K.SKD_VOY_NO = SKD3.SKD_VOY_NO
        AND K.SKD_DIR_CD = SKD3.SKD_DIR_CD
        AND K.CLPT_SEQ < SKD3.CLPT_SEQ
        AND NVL(K.PORT_SKD_STS_CD, ' ') != 'S'
        AND K.CLPT_SEQ >= SKD1.CLPT_SEQ
        AND K.CLPT_SEQ <= SKD2.CLPT_SEQ
        AND ROWNUM = 1 
      ) AS PREV_LOC_CD      

   , (SELECT /*+ INDEX(K XAK4VSK_VSL_PORT_SKD) */ VPS_PORT_CD
        FROM VSK_VSL_PORT_SKD K
       WHERE K.VSL_CD = SKD3.VSL_CD
         AND K.SKD_VOY_NO = SKD3.SKD_VOY_NO
         AND K.SKD_DIR_CD = SKD3.SKD_DIR_CD
         AND K.CLPT_SEQ = SKD3.CLPT_SEQ
         AND NVL(K.PORT_SKD_STS_CD, ' ') != 'S'
         AND K.CLPT_SEQ >= SKD1.CLPT_SEQ
         AND K.CLPT_SEQ <= SKD2.CLPT_SEQ
         AND ROWNUM = 1 
     ) AS NEXT_LOC_CD

   , (SELECT /*+ INDEX(K XAK4VSK_VSL_PORT_SKD) */ TO_CHAR(INIT_ETA_DT,'yyyymmddhh24')||'0000'
        FROM VSK_VSL_PORT_SKD K
        WHERE K.VSL_CD = SKD3.VSL_CD
          AND K.SKD_VOY_NO = SKD3.SKD_VOY_NO
          AND K.SKD_DIR_CD = SKD3.SKD_DIR_CD
          AND K.CLPT_SEQ = SKD3.CLPT_SEQ
          AND NVL(K.PORT_SKD_STS_CD, ' ') != 'S'
          AND K.CLPT_SEQ >= SKD1.CLPT_SEQ
          AND K.CLPT_SEQ <= SKD2.CLPT_SEQ
          AND ROWNUM = 1 
      ) AS NEXT_LOC_ETA

   , (SELECT /*+ INDEX(K XAK4VSK_VSL_PORT_SKD) */ B.LOC_NM
        FROM VSK_VSL_PORT_SKD K,MDM_LOCATION B
       WHERE K.VSL_CD = SKD3.VSL_CD
         AND K.SKD_VOY_NO = SKD3.SKD_VOY_NO
         AND K.SKD_DIR_CD = SKD3.SKD_DIR_CD
         AND K.CLPT_SEQ = SKD3.CLPT_SEQ
         AND K.VPS_PORT_CD= B.LOC_CD
         AND NVL(K.PORT_SKD_STS_CD, ' ') != 'S'
         AND K.CLPT_SEQ >= SKD1.CLPT_SEQ
         AND K.CLPT_SEQ <= SKD2.CLPT_SEQ
         AND ROWNUM = 1 
     ) AS NEXT_LOC_NAME


  , (SELECT /*+ INDEX(K XAK4VSK_VSL_PORT_SKD) */ B.EUR_CSTMS_OFC_ID
       FROM VSK_VSL_PORT_SKD K,BKG_CSTMS_EUR_CD_STUP B
      WHERE K.VSL_CD = SKD3.VSL_CD
        AND K.SKD_VOY_NO = SKD3.SKD_VOY_NO
        AND K.SKD_DIR_CD = SKD3.SKD_DIR_CD
        AND K.CLPT_SEQ = SKD3.CLPT_SEQ
        AND B.PORT_CD = K.VPS_PORT_CD
        AND B.TML_CD IN ('ALL',K.YD_CD)
        AND NVL(K.PORT_SKD_STS_CD, ' ') != 'S'
        AND K.CLPT_SEQ >= SKD1.CLPT_SEQ
        AND K.CLPT_SEQ <= SKD2.CLPT_SEQ
        AND ROWNUM = 1 
    ) AS NEXT_OFC_CD


   , BK.BL_NO AS BLNBR
   , VSL.LLOYD_NO AS BL_TRANS_IDENTITY
   , VSL.VSL_RGST_CNT_CD AS BL_TRANS_NATION
   
   , BD.POL_CD      AS  BLPOL
   , BD.POL_NM      AS  POL_FULLNAME
   , BD.POD_CD      AS  BLPOD
   , BD.POD_NM      AS  POD_FULLNAME
--   , (SELECT A.EUR_CSTMS_OFC_ID FROM BKG_CSTMS_EUR_CD_STUP A
--       WHERE A.PORT_CD = X.POD_CD  AND A.TML_CD IN ('ALL',X.POD_YD_CD)
--        AND ROWNUM=1) AS POD_OFC_CD
   , '' AS POD_OFC_CD
   , BD.DEL_CD      AS  BLDEL
   , BD.DEL_NM      AS  DEL_FULLNAME
   , BD.PCK_QTY     AS  BLPKG
   , NVL((SELECT CSTMS_PCK_TP_CD
              FROM BKG_CSTMS_PCK_TP_CONV AA
             WHERE AA.CNT_CD = 'IL'
               AND AA.PCK_TP_CD = BD.PCK_TP_CD
           ),BD.PCK_TP_CD)  AS  BLPKGU

   , BD.MEAS_QTY    AS  BLMEA
   , BD.MEAS_UT_CD  AS  BLMEAU
   , BK.CMDT_CD     AS  COMMODITY
   , '' AS TRANS_DOC_NO
   , '' AS TRANS_DOC_NAME
   , '' AS CUSTOMS_STATUS_CD
   , '' AS PROCESS_INFO
   , '' AS PROCESS_TYPE
   , '' AS AEO_STATUS
   , '' AS PART_SHIPMENT
   , '' AS CONSIGN_PLACE
   , TO_CHAR(GLOBALDATE_PKG.TIME_LOCAL_FNC(BK.POD_CD),'YYYYMMDDHH24MISS') AS DECLARE_DATE
   , BK.POD_CD AS DECLARE_LOC
   , (SELECT LOC_NM FROM MDM_LOCATION 
       WHERE LOC_CD = BK.POD_CD
      ) AS DECLARE_LOC_NAME
   , DECODE((SELECT FRT_TERM_CD FROM BKG_RATE WHERE 1=1 AND BKG_NO = BK.BKG_NO), 'P', 'H', 'Z') AS PAYMENT_CD
   , DECODE( BK.CUST_TO_ORD_FLG , 'Y','10600','') AS SPECIAL_REMARKS
   , BKG_SPCLCHAR_CONV_CLOB_FNC(BD.CSTMS_DESC,'X') AS DESCS
    
 , BKG_JOIN_FULL_CLOB_FNC(CURSOR(SELECT BKG_SPCLCHAR_CONV_CLOB_FNC(MK_DESC,'X') FROM BKG_BOOKING A, BKG_BL_MK_DESC B
                             WHERE A.BKG_NO = BD.BKG_NO
                               AND A.BKG_NO = B.BKG_NO
    ),'$@$') AS MARKNO

-- , (SELECT  CNTC_NM||','||CNTC_PSN_NM||','||CNTC_EML||','||CNTC_PHN_NO||','||CNTC_FAX_NO
--	 FROM BKG_CSTMS_EUR_CD_STUP
--    WHERE PORT_CD = BV.POD_YD_CD
--	  AND TML_CD  IN ('ALL',BV.POD_YD_CD )
--      AND ROWNUM =1 
--     ) AS CTMS_SETUP
   , '' AS CTMS_SETUP 

 , BV.VSL_CD,    BV.SKD_VOY_NO,  BV.SKD_DIR_CD,  BK.BL_NO,      BV.POD_YD_CD
 , BK.POL_CD AS BKG_POL_CD,   BK.POD_CD AS BKG_POD_CD,    BD.POL_CD,      BD.POD_CD,     BD.DEL_CD
 , BD.POL_NM,    BD.POD_NM,        BD.DEL_NM,        BD.PCK_QTY,      BD.PCK_TP_CD
 , BD.MEAS_QTY,  BD.MEAS_UT_CD,    BK.CMDT_CD,     '' AS TRSP_DOC_NO,  '' AS CSTMS_DECL_DT,  '' AS DECL_LOC_CD
 , BD.CRE_USR_ID, BD.CRE_DT, BD.UPD_USR_ID,  BD.UPD_DT   
FROM BKG_BL_DOC BD 
   , BKG_BOOKING BK
   , BKG_VVD BV
   , MDM_VSL_CNTR VSL 
   , VSK_VSL_PORT_SKD SKD1 , VSK_VSL_PORT_SKD SKD2 
   ,(
    SELECT *
           FROM VSK_VSL_PORT_SKD K
          WHERE K.VSL_CD = @[vsl_cd]
            AND K.SKD_VOY_NO = @[skd_voy_no]
            AND K.SKD_DIR_CD = @[skd_dir_cd]
            AND NVL(K.PORT_SKD_STS_CD, ' ') != 'S'
            AND K.VPS_PORT_CD LIKE 'IL%'
            AND ROWNUM = 1
            ORDER BY CLPT_SEQ   
   ) SKD3

WHERE 1=1
AND BD.BKG_NO = BK.BKG_NO
AND BK.BKG_NO = BV.BKG_NO
AND BK.BKG_STS_CD NOT IN ('X', 'S')

AND BV.VSL_CD = VSL.VSL_CD
AND BV.VSL_CD = SKD1.VSL_CD
AND BV.SKD_VOY_NO = SKD1.SKD_VOY_NO
AND BV.SKD_DIR_CD = SKD1.SKD_DIR_CD
AND BV.POL_CD = SKD1.VPS_PORT_CD
AND SKD1.CLPT_IND_SEQ = 1

AND BV.VSL_CD = SKD2.VSL_CD
AND BV.SKD_VOY_NO = SKD2.SKD_VOY_NO
AND BV.SKD_DIR_CD = SKD2.SKD_DIR_CD
AND BV.POD_CD = SKD2.VPS_PORT_CD
AND SKD2.CLPT_IND_SEQ = 1

AND BV.VSL_CD = @[vsl_cd]
AND BV.SKD_VOY_NO = @[skd_voy_no]
AND BV.SKD_DIR_CD = @[skd_dir_cd]
AND BV.POL_CD = @[cstms_port_cd]
AND BK.BL_NO = @[bl_no]

) Y
)Z			]]></sql>
			<params>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="cstms_port_cd" type="12" value="" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
