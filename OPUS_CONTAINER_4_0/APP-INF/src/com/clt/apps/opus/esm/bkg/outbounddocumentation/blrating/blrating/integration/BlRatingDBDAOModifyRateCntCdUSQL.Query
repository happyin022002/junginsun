<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BlRatingDBDAOModifyRateCntCdUSQL">
			<desc><![CDATA[ModifyRateCntCd]]></desc>
			<sql><![CDATA[
#if (${ca_flg} =='Y')
	#if(${bkg_no} !='')
    UPDATE BKG_RT_HIS
SET PPD_PAYR_CNT_CD = (SELECT CASE WHEN (POR_L.CONTI_CD ='F' OR POR_L.CONTI_CD = 'E') 
                                        AND(F.CUST_SEQ IS NOT NULL AND NVL(F.CUST_SEQ,'') <> '0') 
                                        AND EXISTS (SELECT 'Y' 
                                                    FROM MDM_LOCATION FL 
                                                    WHERE  FL.CONTI_CD ='E'
                                                    AND  FL.DELT_FLG ='N'
                                                    AND  FL.CNT_CD = F.CUST_CNT_CD
                                                    AND ROWNUM =1 )
                                    THEN F.CUST_CNT_CD
                               ELSE CR_RT_P.CUST_CNT_CD
                               END UP_PPD_PAYR_CNT_CD
                       FROM  BKG_BKG_HIS BK, BKG_RT_HIS RT, BKG_CUST_HIS F, BKG_CUST_HIS N, MDM_LOCATION POR_L, MDM_LOCATION DEL_L,
                             MDM_ORGANIZATION OFC, 
                            (SELECT ROWNUM,A.* FROM 
            				    (
            				--PPD RULE 1 FF CASE
        					SELECT BKG.BKG_NO BKG_NO,
        					        10 AS FLG,
        					        'S' AS BKG_CUST_TP_CD,
        						 CR_CLT_OFC_CD AS OFC_CD,
        					     F.CUST_CNT_CD CUST_CNT_CD,
            					 F.CUST_SEQ CUST_SEQ,
            					 C.CUST_LGL_ENG_NM CUST_NM
        					FROM   MDM_CR_CUST CUST,
        					       BKG_BKG_HIS BKG,
                                   MDM_CUSTOMER C,
            					   BKG_CUST_HIS F,
                                   MDM_ORGANIZATION O  
        					      
        					WHERE  BKG.BKG_NO = @[bkg_no]
        					AND    BKG.CORR_NO ='TMP0000001'
            				AND    BKG.BKG_NO = F.BKG_NO
        					AND    F.CORR_NO = 'TMP0000001'
        					AND    F.BKG_CUST_TP_CD = 'F'
        					AND    F.CUST_CNT_CD = C.CUST_CNT_CD
        					AND    F.CUST_SEQ = C.CUST_SEQ
        					AND    C.DELT_FLG ='N'
        					AND    NVL(C.NMD_CUST_FLG,'N') ='N'
        					AND    CUST.CUST_CNT_CD = F.CUST_CNT_CD
        					AND    CUST.CUST_SEQ = F.CUST_SEQ
        					AND    BKG.BKG_OFC_CD = O.OFC_CD
        					AND    O.DELT_FLG ='N'
        					AND    NVL(O.PPD_PTY_TP_CD,'S') ='F'
            				AND    0 < CUST.OB_CR_TERM_DYS
        					AND    CUST.CR_ST_DT  <= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BKG_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO ='TMP0000001')
        					AND    CUST.CR_END_DT >= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BKG_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO ='TMP0000001')
        					AND    CUST.DELT_FLG ='N'
        					UNION
        					--PPD RULE 2 SH CASE
        					SELECT BKG.BKG_NO BKG_NO,
        					        11 AS FLG,
        					        'S' AS BKG_CUST_TP_CD,
        						 CR_CLT_OFC_CD AS OFC_CD,
        						 S.CUST_CNT_CD CUST_CNT_CD,
            					 S.CUST_SEQ CUST_SEQ,
            					 C.CUST_LGL_ENG_NM CUST_NM
        					FROM   MDM_CR_CUST CUST,
        					       BKG_BKG_HIS BKG,
                                   MDM_CUSTOMER C,
            					   BKG_CUST_HIS S
        					WHERE  BKG.BKG_NO = @[bkg_no]
        					AND	   BKG.CORR_NO = 'TMP0000001'
            				AND    BKG.BKG_NO = S.BKG_NO
            				AND    S.CORR_NO = 'TMP0000001'
            				AND    S.BKG_CUST_TP_CD = 'S'
        					AND    S.CUST_CNT_CD = C.CUST_CNT_CD
        					AND    S.CUST_SEQ = C.CUST_SEQ
        					AND    C.DELT_FLG ='N'
        					AND    NVL(C.NMD_CUST_FLG,'N') ='N'
        					AND    CUST.CUST_CNT_CD = S.CUST_CNT_CD
        					AND    CUST.CUST_SEQ = S.CUST_SEQ
            				AND    0 < CUST.OB_CR_TERM_DYS
        					AND    CUST.CR_ST_DT  <= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BKG_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO ='TMP0000001')
        					AND    CUST.CR_END_DT >= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BKG_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO ='TMP0000001')
        					AND    CUST.DELT_FLG ='N'
        					UNION
        					--PPD RULE 3 FF CASE
        					--????????????????? MDM OFFICE ?? OFC_TP_CD?? QT ??????? POR ?? FINC_CTRL_OFC_CD ???????
        					SELECT B.BKG_NO BKG_NO,
        					        12 AS FLG,
        					        'S' AS BKG_CUST_TP_CD,
        					        DECODE(O.OFC_TP_CD,'QT',L.FINC_CTRL_OFC_CD,C.OFC_CD) OFC_CD,
        					        F.CUST_CNT_CD,
        					        F.CUST_SEQ,
        					        C.CUST_LGL_ENG_NM AS CUST_NM
        					FROM    BKG_BKG_HIS B,
        					        BKG_CUST_HIS F,
        					        MDM_CUSTOMER C,
        							MDM_ORGANIZATION O,
        							MDM_LOCATION L
        					WHERE  B.BKG_NO = @[bkg_no]
            				AND  F.BKG_NO = B.BKG_NO
            				AND  F.BKG_CUST_TP_CD = 'F'
            				AND  F.CUST_CNT_CD = C.CUST_CNT_CD
            				AND  F.CUST_SEQ = C.CUST_SEQ
            				AND  C.DELT_FLG ='N'
            				AND  O.DELT_FLG ='N'
            				AND  L.DELT_FLG ='N'
            				AND  B.BKG_OFC_CD = O.OFC_CD 
            				AND  NVL(C.NMD_CUST_FLG,'N') ='N'	
            				AND  NVL(O.PPD_PTY_TP_CD,'S') ='F'
            				AND  B.POR_CD = L.LOC_CD
            				AND  B.CORR_NO = 'TMP0000001'
            				AND  F.CORR_NO = 'TMP0000001'
        					UNION 
        
        					--PPD RULE 4 SH CASE
        					--????????????????? MDM OFFICE ?? OFC_TP_CD?? QT ??????? POR ?? FINC_CTRL_OFC_CD ???????
        					SELECT B.BKG_NO BKG_NO,
        					        13 AS FLG,
        					        'S' AS BKG_CUST_TP_CD,
        					        DECODE(O.OFC_TP_CD,'QT',L.FINC_CTRL_OFC_CD,C.OFC_CD) OFC_CD,
        					        C.CUST_CNT_CD,
        					        C.CUST_SEQ,
        					        C.CUST_LGL_ENG_NM AS CUST_NM
        					FROM    BKG_BKG_HIS B,
        					        BKG_CUST_HIS S,
        					        MDM_CUSTOMER C,
        							MDM_ORGANIZATION O,
        							MDM_LOCATION L
        					WHERE  B.BKG_NO = @[bkg_no]
        					AND    S.BKG_NO = B.BKG_NO
        					AND    B.CORR_NO ='TMP0000001'
        					AND    S.CORR_NO ='TMP0000001'
        					AND    S.BKG_CUST_TP_CD = 'S'
        					AND    S.CUST_CNT_CD = C.CUST_CNT_CD
        					AND    S.CUST_SEQ = C.CUST_SEQ
        					AND    C.DELT_FLG ='N'
        					AND    O.DELT_FLG ='N'
        					AND    L.DELT_FLG ='N'
        					AND    C.OFC_CD = O.OFC_CD 
        					AND    NVL(C.NMD_CUST_FLG,'N') ='N'	
        					AND    B.POR_CD = L.LOC_CD
        					ORDER BY FLG
            					) A
            					WHERE ROWNUM = 1) CR_RT_P
                       WHERE  BK.BKG_NO =@[bkg_no]
                       AND  BK.BKG_STS_CD <>'X'
                       AND  BK.BKG_NO = RT.BKG_NO
                       AND  BK.BKG_NO = N.BKG_NO
                       AND  BK.BKG_NO = F.BKG_NO
                       AND  N.BKG_CUST_TP_CD ='N'
                       AND  F.BKG_CUST_TP_CD ='F'
                       AND  BK.POR_CD = POR_L.LOC_CD
                       AND  POR_L.DELT_FLG ='N'
                       AND  BK.DEL_CD = DEL_L.LOC_CD
                       AND  DEL_L.DELT_FLG ='N'
                       AND  DEL_L.FINC_CTRL_OFC_CD = OFC.OFC_CD
                       AND  OFC.DELT_FLG='N'
                       AND  BK.BKG_NO = CR_RT_P.BKG_NO(+)
            		   AND  BK.CORR_NO ='TMP0000001'
              		   AND  RT.CORR_NO ='TMP0000001'
               		   AND  N.CORR_NO ='TMP0000001'
               		   AND  F.CORR_NO ='TMP0000001'),
    PPD_PAYR_CUST_SEQ = (SELECT CASE WHEN (POR_L.CONTI_CD ='F' OR POR_L.CONTI_CD = 'E') 
                                          AND(F.CUST_SEQ IS NOT NULL AND NVL(F.CUST_SEQ,'') <> '0') 
                                          AND EXISTS (SELECT 'Y' 
                                                      FROM MDM_LOCATION FL 
                                                      WHERE  FL.CONTI_CD ='E' 
                                                      AND  FL.DELT_FLG ='N'
                                                      AND  FL.CNT_CD = F.CUST_CNT_CD
                                                      AND ROWNUM =1 )
                                    THEN F.CUST_SEQ
                               ELSE CR_RT_P.CUST_SEQ
                               END UP_PPD_PAYR_CUST_SEQ
                       FROM  BKG_BKG_HIS BK, BKG_RT_HIS RT, BKG_CUST_HIS F, BKG_CUST_HIS N, MDM_LOCATION POR_L, MDM_LOCATION DEL_L,
                             MDM_ORGANIZATION OFC, 
                            (SELECT ROWNUM,A.* FROM 
            				    (
            					        					--PPD RULE 1 FF CASE
        					SELECT BKG.BKG_NO BKG_NO,
        					        10 AS FLG,
        					        'S' AS BKG_CUST_TP_CD,
        						 CR_CLT_OFC_CD AS OFC_CD,
        					     F.CUST_CNT_CD CUST_CNT_CD,
            					 F.CUST_SEQ CUST_SEQ,
            					 C.CUST_LGL_ENG_NM CUST_NM
        					FROM   MDM_CR_CUST CUST,
        					       BKG_BKG_HIS BKG,
                                   MDM_CUSTOMER C,
            					   BKG_CUST_HIS F,
                                   MDM_ORGANIZATION O  
        					      
        					WHERE  BKG.BKG_NO = @[bkg_no]
        					AND    BKG.CORR_NO ='TMP0000001'
            				AND    BKG.BKG_NO = F.BKG_NO
        					AND    F.CORR_NO = 'TMP0000001'
        					AND    F.BKG_CUST_TP_CD = 'F'
        					AND    F.CUST_CNT_CD = C.CUST_CNT_CD
        					AND    F.CUST_SEQ = C.CUST_SEQ
        					AND    C.DELT_FLG ='N'
        					AND    NVL(C.NMD_CUST_FLG,'N') ='N'
        					AND    CUST.CUST_CNT_CD = F.CUST_CNT_CD
        					AND    CUST.CUST_SEQ = F.CUST_SEQ
        					AND    BKG.BKG_OFC_CD = O.OFC_CD
        					AND    O.DELT_FLG ='N'
        					AND    NVL(O.PPD_PTY_TP_CD,'S') ='F'
            				AND    0 < CUST.OB_CR_TERM_DYS
        					AND    CUST.CR_ST_DT  <= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BKG_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO ='TMP0000001')
        					AND    CUST.CR_END_DT >= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BKG_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO ='TMP0000001')
        					AND    CUST.DELT_FLG ='N'
        					UNION
        					--PPD RULE 2 SH CASE
        					SELECT BKG.BKG_NO BKG_NO,
        					        11 AS FLG,
        					        'S' AS BKG_CUST_TP_CD,
        						 CR_CLT_OFC_CD AS OFC_CD,
        						 S.CUST_CNT_CD CUST_CNT_CD,
            					 S.CUST_SEQ CUST_SEQ,
            					 C.CUST_LGL_ENG_NM CUST_NM
        					FROM   MDM_CR_CUST CUST,
        					       BKG_BKG_HIS BKG,
                                   MDM_CUSTOMER C,
            					   BKG_CUST_HIS S
        					WHERE  BKG.BKG_NO = @[bkg_no]
        					AND	   BKG.CORR_NO = 'TMP0000001'
            				AND    BKG.BKG_NO = S.BKG_NO
            				AND    S.CORR_NO = 'TMP0000001'
            				AND    S.BKG_CUST_TP_CD = 'S'
        					AND    S.CUST_CNT_CD = C.CUST_CNT_CD
        					AND    S.CUST_SEQ = C.CUST_SEQ
        					AND    C.DELT_FLG ='N'
        					AND    NVL(C.NMD_CUST_FLG,'N') ='N'
        					AND    CUST.CUST_CNT_CD = S.CUST_CNT_CD
        					AND    CUST.CUST_SEQ = S.CUST_SEQ
            				AND    0 < CUST.OB_CR_TERM_DYS
        					AND    CUST.CR_ST_DT  <= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BKG_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO ='TMP0000001')
        					AND    CUST.CR_END_DT >= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BKG_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO ='TMP0000001')
        					AND    CUST.DELT_FLG ='N'
        					UNION
        					--PPD RULE 3 FF CASE
        					--????????????????? MDM OFFICE ?? OFC_TP_CD?? QT ??????? POR ?? FINC_CTRL_OFC_CD ???????
        					SELECT B.BKG_NO BKG_NO,
        					        12 AS FLG,
        					        'S' AS BKG_CUST_TP_CD,
        					        DECODE(O.OFC_TP_CD,'QT',L.FINC_CTRL_OFC_CD,C.OFC_CD) OFC_CD,
        					        F.CUST_CNT_CD,
        					        F.CUST_SEQ,
        					        C.CUST_LGL_ENG_NM AS CUST_NM
        					FROM    BKG_BKG_HIS B,
        					        BKG_CUST_HIS F,
        					        MDM_CUSTOMER C,
        							MDM_ORGANIZATION O,
        							MDM_LOCATION L
        					WHERE  B.BKG_NO = @[bkg_no]
            				AND  F.BKG_NO = B.BKG_NO
            				AND  F.BKG_CUST_TP_CD = 'F'
            				AND  F.CUST_CNT_CD = C.CUST_CNT_CD
            				AND  F.CUST_SEQ = C.CUST_SEQ
            				AND  C.DELT_FLG ='N'
            				AND  O.DELT_FLG ='N'
            				AND  L.DELT_FLG ='N'
            				AND  B.BKG_OFC_CD = O.OFC_CD 
            				AND  NVL(C.NMD_CUST_FLG,'N') ='N'	
            				AND  NVL(O.PPD_PTY_TP_CD,'S') ='F'
            				AND  B.POR_CD = L.LOC_CD
            				AND  B.CORR_NO = 'TMP0000001'
            				AND  F.CORR_NO = 'TMP0000001'
        					UNION 
        
        					--PPD RULE 4 SH CASE
        					--????????????????? MDM OFFICE ?? OFC_TP_CD?? QT ??????? POR ?? FINC_CTRL_OFC_CD ???????
        					SELECT B.BKG_NO BKG_NO,
        					        13 AS FLG,
        					        'S' AS BKG_CUST_TP_CD,
        					        DECODE(O.OFC_TP_CD,'QT',L.FINC_CTRL_OFC_CD,C.OFC_CD) OFC_CD,
        					        C.CUST_CNT_CD,
        					        C.CUST_SEQ,
        					        C.CUST_LGL_ENG_NM AS CUST_NM
        					FROM    BKG_BKG_HIS B,
        					        BKG_CUST_HIS S,
        					        MDM_CUSTOMER C,
        							MDM_ORGANIZATION O,
        							MDM_LOCATION L
        					WHERE  B.BKG_NO = @[bkg_no]
        					AND    S.BKG_NO = B.BKG_NO
        					AND    B.CORR_NO ='TMP0000001'
        					AND    S.CORR_NO ='TMP0000001'
        					AND    S.BKG_CUST_TP_CD = 'S'
        					AND    S.CUST_CNT_CD = C.CUST_CNT_CD
        					AND    S.CUST_SEQ = C.CUST_SEQ
        					AND    C.DELT_FLG ='N'
        					AND    O.DELT_FLG ='N'
        					AND    L.DELT_FLG ='N'
        					AND    C.OFC_CD = O.OFC_CD 
        					AND    NVL(C.NMD_CUST_FLG,'N') ='N'	
        					AND    B.POR_CD = L.LOC_CD
        					ORDER BY FLG

            					) A
            					WHERE ROWNUM = 1) CR_RT_P
                       WHERE  BK.BKG_NO =@[bkg_no]
                       AND  BK.BKG_STS_CD <>'X'
                       AND  BK.BKG_NO = RT.BKG_NO
                       AND  BK.BKG_NO = N.BKG_NO
                       AND  BK.BKG_NO = F.BKG_NO
                       AND  N.BKG_CUST_TP_CD ='N'
                       AND  F.BKG_CUST_TP_CD ='F'
                       AND  BK.POR_CD = POR_L.LOC_CD
                       AND  POR_L.DELT_FLG ='N'
                       AND  BK.DEL_CD = DEL_L.LOC_CD
                       AND  DEL_L.DELT_FLG ='N'
                       AND  DEL_L.FINC_CTRL_OFC_CD = OFC.OFC_CD
                       AND  OFC.DELT_FLG='N'
                       AND  BK.BKG_NO = CR_RT_P.BKG_NO(+)
            		   AND  BK.CORR_NO ='TMP0000001'
              		   AND  RT.CORR_NO ='TMP0000001'
               		   AND  N.CORR_NO ='TMP0000001'
               		   AND  F.CORR_NO ='TMP0000001'),
    CLT_PAYR_CNT_CD = ( SELECT CASE WHEN BK.CUST_TO_ORD_FLG='Y' AND ( NVL(N.CUST_CNT_CD,'')||N.CUST_SEQ = '0' OR N.CUST_CNT_CD||N.CUST_SEQ IS NULL OR N.CUST_SEQ IS NULL )
                                    THEN OFC.REP_CUST_CNT_CD --FIN_OFC 의 AR CUSTOMER
                                    WHEN BK.CUST_TO_ORD_FLG='Y' AND ( NVL(N.CUST_CNT_CD,'')||N.CUST_SEQ <> '0' AND N.CUST_CNT_CD||N.CUST_SEQ IS NOT NULL AND N.CUST_SEQ IS NOT NULL )
                                    THEN N.CUST_CNT_CD    -- NOTIFY
                                    ELSE CR_RT_C.CUST_CNT_CD  -- NOT NULL 을 위해 DEFALUT 
                                    END UP_CLT_PAYR_CNT_CD
                             FROM  BKG_BKG_HIS BK, BKG_RT_HIS RT, BKG_CUST_HIS F, BKG_CUST_HIS N, MDM_LOCATION POR_L, MDM_LOCATION DEL_L,
                                    MDM_ORGANIZATION OFC, 
                    					(SELECT ROWNUM,A.* FROM 
                    					(
                    					--CCT
                    					SELECT  BKG.BKG_NO AS BKG_NO,
                    					        21 AS FLG,
                    					        'C' AS BKG_CUST_TP_CD,
                    					        CR_CLT_OFC_CD AS OFC_CD,
                    					        BCUST.CUST_CNT_CD AS CUST_CNT_CD,
                    					        BCUST.CUST_SEQ AS CUST_SEQ,
                    					        MCUST.CUST_LGL_ENG_NM AS CUST_NM
                    					FROM    MDM_CR_CUST CUST,
                    					        BKG_BKG_HIS BKG,
                    					        BKG_CUST_HIS BCUST,
                    					        MDM_CUSTOMER MCUST
                    					WHERE  BKG.BKG_NO = @[bkg_no]
                    					AND    BKG.BKG_NO = BCUST.BKG_NO
                    					AND    BCUST.BKG_CUST_TP_CD = 'C'
                    					AND    CUST.CUST_CNT_CD = BCUST.CUST_CNT_CD
                    					AND    CUST.CUST_SEQ = BCUST.CUST_SEQ
                    					AND    BCUST.CUST_CNT_CD = MCUST.CUST_CNT_CD
                    					AND    BCUST.CUST_SEQ = MCUST.CUST_SEQ    
                    					AND    IB_CR_TERM_DYS > 0
                    					AND    CR_ST_DT  <= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BKG_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO ='TMP0000001')
                    					AND    CR_END_DT >= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BKG_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO ='TMP0000001')
                    					AND    MCUST.DELT_FLG ='N'
                    					AND    NVL(MCUST.NMD_CUST_FLG,'N') ='N'
                    					AND    CUST.DELT_FLG ='N'
                    					AND    BKG.CORR_NO ='TMP0000001'
                    					AND    BCUST.CORR_NO ='TMP0000001'
                    					UNION
                    					--CCT OFFICE CODE2
                    					SELECT B.BKG_NO BKG_NO,
                    					        22 AS FLG,
                    					        'C' AS BKG_CUST_TP_CD,
                    					        FINC_CTRL_OFC_CD AS OFC_CD,
                    					        S.CUST_CNT_CD  AS CUST_CNT_CD,
                    					        NVL(S.CUST_SEQ,'1') AS CUST_SEQ,
                    					        C.CUST_LGL_ENG_NM AS CUST_NM
                    					FROM    MDM_LOCATION M, 
                    					        BKG_BKG_HIS B, 
                    					        BKG_CUST_HIS S,
                    					        MDM_CUSTOMER C
                    					WHERE  B.BKG_NO = @[bkg_no]
                    					AND    S.BKG_NO = B.BKG_NO
                    					AND    S.BKG_CUST_TP_CD = 'C'
                    					AND    S.CUST_CNT_CD = C.CUST_CNT_CD
                    					AND    S.CUST_SEQ = C.CUST_SEQ
                    					AND    B.DEL_CD = M.LOC_CD
                    					AND    C.DELT_FLG = 'N'
                    					AND	NVL(C.NMD_CUST_FLG,'N') ='N'
                    					AND B.CORR_NO ='TMP0000001'
                    					AND S.CORR_NO ='TMP0000001'
                    					UNION
                    					--REP CUSTOMER
                    					SELECT BKG_NO,
                    					        31 AS FLG,
                    					        'R'AS BKG_CUST_TP_CD,
                    					        (SELECT  FINC_CTRL_OFC_CD
                    					            FROM MDM_LOCATION
                    					            WHERE LOC_CD = (SELECT DEL_CD
                    					                            FROM  BKG_BKG_HIS
                    					                            WHERE BKG_NO =@[bkg_no]
                    												AND CORR_NO ='TMP0000001')) AS OFC_CD,
                    					        REP_CUST_CNT_CD AS CUST_CNT_CD,
                    					        REP_CUST_SEQ AS CUST_SEQ,
                    					        MCUST.CUST_LGL_ENG_NM AS CUST_NM
                    					FROM   MDM_ORGANIZATION OFC, 
                    					        BKG_BKG_HIS BKG,
                    					        MDM_CUSTOMER MCUST
                    					WHERE  BKG.BKG_NO = @[bkg_no]
                    					AND    REP_CUST_CNT_CD = MCUST.CUST_CNT_CD
                    					AND    REP_CUST_SEQ = MCUST.CUST_SEQ
                    					AND    MCUST.DELT_FLG ='N'
                    					AND	NVL(MCUST.NMD_CUST_FLG,'N') ='N'
                    					AND BKG.CORR_NO ='TMP0000001'
                    					AND    OFC.OFC_CD = NVL((SELECT CR_CLT_OFC_CD
                    					                        FROM MDM_CR_CUST
                    					                        WHERE (CUST_CNT_CD, CUST_SEQ) = (SELECT CUST_CNT_CD, CUST_SEQ
                    					                                                            FROM   BKG_BKG_HIS B,
                    					                                                                    BKG_CUST_HIS C
                    					                                                            WHERE  B.BKG_NO = @[bkg_no]
                    					                                                            AND    C.BKG_NO = B.BKG_NO
                    																				AND B.CORR_NO ='TMP0000001'
                    																				AND C.CORR_NO ='TMP0000001'
                    					                                                            AND    C.BKG_CUST_TP_CD = 'C'
                    																				)
                    					                        AND 0 < IB_CR_TERM_DYS
                    											AND MCUST.DELT_FLG ='N'
                    					                        AND CR_ST_DT  <= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BKG_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO ='TMP0000001')
                    					                        AND CR_END_DT >= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BKG_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO ='TMP0000001')),
                    					                    (SELECT  FINC_CTRL_OFC_CD
                    					                        FROM MDM_LOCATION
                    					                        WHERE LOC_CD = (SELECT DEL_CD
                    					                                        FROM  BKG_BKG_HIS
                    					                                        WHERE BKG_NO =@[bkg_no]
                    															AND CORR_NO ='TMP0000001')
                    					                    )
                    					                    )
                    					                    ORDER BY FLG
                    					) A
                    					WHERE 
                    					ROWNUM = 1) CR_RT_C
                    					
                             WHERE  BK.BKG_NO =@[bkg_no]
                               AND  BK.BKG_STS_CD <>'X'
                               AND  BK.BKG_NO = RT.BKG_NO
                               AND  BK.BKG_NO = N.BKG_NO
                               AND  BK.BKG_NO = F.BKG_NO
                               AND  N.BKG_CUST_TP_CD ='N'
                               AND  F.BKG_CUST_TP_CD ='F'
                               AND  BK.POR_CD = POR_L.LOC_CD
                               AND  POR_L.DELT_FLG ='N'
                               AND  BK.DEL_CD = DEL_L.LOC_CD
                               AND  DEL_L.DELT_FLG ='N'
                               AND  DEL_L.FINC_CTRL_OFC_CD = OFC.OFC_CD
                               AND  OFC.DELT_FLG='N'
                               AND  BK.BKG_NO = CR_RT_C.BKG_NO(+)
                    		   AND  BK.CORR_NO ='TMP0000001'
                      		   AND  RT.CORR_NO ='TMP0000001'
                       		   AND  N.CORR_NO ='TMP0000001'
                       		   AND  F.CORR_NO ='TMP0000001'),
    CLT_PAYR_CUST_SEQ= (SELECT CASE WHEN BK.CUST_TO_ORD_FLG='Y' AND ( NVL(N.CUST_CNT_CD,'')||N.CUST_SEQ = '0' OR N.CUST_CNT_CD||N.CUST_SEQ IS NULL OR N.CUST_SEQ IS NULL)
                                    THEN OFC.REP_CUST_SEQ   --FIN_OFC 의 AR CUSTOMER
                                    WHEN BK.CUST_TO_ORD_FLG='Y' AND ( NVL(N.CUST_CNT_CD,'')||N.CUST_SEQ <> '0' AND N.CUST_CNT_CD||N.CUST_SEQ IS NOT NULL AND N.CUST_SEQ IS NOT NULL)
                                    THEN N.CUST_SEQ       -- NOTIFY
                                    ELSE CR_RT_C.CUST_SEQ -- NOT NULL 을 위해 DEFALUT 
                                    END UP_CLT_PAYR_CUST_SEQ
                             FROM  BKG_BKG_HIS BK, BKG_RT_HIS RT, BKG_CUST_HIS F, BKG_CUST_HIS N, MDM_LOCATION POR_L, MDM_LOCATION DEL_L,
                                    MDM_ORGANIZATION OFC, 
                    					(SELECT ROWNUM,A.* FROM 
                    					(
                    					--CCT
                    					SELECT  BKG.BKG_NO AS BKG_NO,
                    					        21 AS FLG,
                    					        'C' AS BKG_CUST_TP_CD,
                    					        CR_CLT_OFC_CD AS OFC_CD,
                    					        BCUST.CUST_CNT_CD AS CUST_CNT_CD,
                    					        BCUST.CUST_SEQ AS CUST_SEQ,
                    					        MCUST.CUST_LGL_ENG_NM AS CUST_NM
                    					FROM    MDM_CR_CUST CUST,
                    					        BKG_BKG_HIS BKG,
                    					        BKG_CUST_HIS BCUST,
                    					        MDM_CUSTOMER MCUST
                    					WHERE  BKG.BKG_NO = @[bkg_no]
                    					AND    BKG.BKG_NO = BCUST.BKG_NO
                    					AND    BCUST.BKG_CUST_TP_CD = 'C'
                    					AND    CUST.CUST_CNT_CD = BCUST.CUST_CNT_CD
                    					AND    CUST.CUST_SEQ = BCUST.CUST_SEQ
                    					AND    BCUST.CUST_CNT_CD = MCUST.CUST_CNT_CD
                    					AND    BCUST.CUST_SEQ = MCUST.CUST_SEQ    
                    					AND    IB_CR_TERM_DYS > 0
                    					AND    CR_ST_DT  <= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BKG_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO ='TMP0000001')
                    					AND    CR_END_DT >= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BKG_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO ='TMP0000001')
                    					AND    MCUST.DELT_FLG ='N'
                    					AND    NVL(MCUST.NMD_CUST_FLG,'N') ='N'
                    					AND    CUST.DELT_FLG ='N'
                    					AND    BKG.CORR_NO ='TMP0000001'
                    					AND    BCUST.CORR_NO ='TMP0000001'
                    					UNION
                    					--CCT OFFICE CODE2
                    					SELECT B.BKG_NO BKG_NO,
                    					        22 AS FLG,
                    					        'C' AS BKG_CUST_TP_CD,
                    					        FINC_CTRL_OFC_CD AS OFC_CD,
                    					        S.CUST_CNT_CD  AS CUST_CNT_CD,
                    					        NVL(S.CUST_SEQ,'1') AS CUST_SEQ,
                    					        C.CUST_LGL_ENG_NM AS CUST_NM
                    					FROM    MDM_LOCATION M, 
                    					        BKG_BKG_HIS B, 
                    					        BKG_CUST_HIS S,
                    					        MDM_CUSTOMER C
                    					WHERE  B.BKG_NO = @[bkg_no]
                    					AND    S.BKG_NO = B.BKG_NO
                    					AND    S.BKG_CUST_TP_CD = 'C'
                    					AND    S.CUST_CNT_CD = C.CUST_CNT_CD
                    					AND    S.CUST_SEQ = C.CUST_SEQ
                    					AND    B.DEL_CD = M.LOC_CD
                    					AND    C.DELT_FLG = 'N'
                    					AND	NVL(C.NMD_CUST_FLG,'N') ='N'
                    					AND B.CORR_NO ='TMP0000001'
                    					AND S.CORR_NO ='TMP0000001'
                    					UNION
                    					--REP CUSTOMER
                    					SELECT BKG_NO,
                    					        31 AS FLG,
                    					        'R'AS BKG_CUST_TP_CD,
                    					        (SELECT  FINC_CTRL_OFC_CD
                    					            FROM MDM_LOCATION
                    					            WHERE LOC_CD = (SELECT DEL_CD
                    					                            FROM  BKG_BKG_HIS
                    					                            WHERE BKG_NO =@[bkg_no]
                    												AND CORR_NO ='TMP0000001')) AS OFC_CD,
                    					        REP_CUST_CNT_CD AS CUST_CNT_CD,
                    					        REP_CUST_SEQ AS CUST_SEQ,
                    					        MCUST.CUST_LGL_ENG_NM AS CUST_NM
                    					FROM   MDM_ORGANIZATION OFC, 
                    					        BKG_BKG_HIS BKG,
                    					        MDM_CUSTOMER MCUST
                    					WHERE  BKG.BKG_NO = @[bkg_no]
                    					AND    REP_CUST_CNT_CD = MCUST.CUST_CNT_CD
                    					AND    REP_CUST_SEQ = MCUST.CUST_SEQ
                    					AND    MCUST.DELT_FLG ='N'
                    					AND	NVL(MCUST.NMD_CUST_FLG,'N') ='N'
                    					AND BKG.CORR_NO ='TMP0000001'
                    					AND    OFC.OFC_CD = NVL((SELECT CR_CLT_OFC_CD
                    					                        FROM MDM_CR_CUST
                    					                        WHERE (CUST_CNT_CD, CUST_SEQ) = (SELECT CUST_CNT_CD, CUST_SEQ
                    					                                                            FROM   BKG_BKG_HIS B,
                    					                                                                    BKG_CUST_HIS C
                    					                                                            WHERE  B.BKG_NO = @[bkg_no]
                    					                                                            AND    C.BKG_NO = B.BKG_NO
                    																				AND B.CORR_NO ='TMP0000001'
                    																				AND C.CORR_NO ='TMP0000001'
                    					                                                            AND    C.BKG_CUST_TP_CD = 'C'
                    																				)
                    					                        AND 0 < IB_CR_TERM_DYS
                    											AND MCUST.DELT_FLG ='N'
                    					                        AND CR_ST_DT  <= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BKG_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO ='TMP0000001')
                    					                        AND CR_END_DT >= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BKG_HIS WHERE BKG_NO = @[bkg_no] AND CORR_NO ='TMP0000001')),
                    					                    (SELECT  FINC_CTRL_OFC_CD
                    					                        FROM MDM_LOCATION
                    					                        WHERE LOC_CD = (SELECT DEL_CD
                    					                                        FROM  BKG_BKG_HIS
                    					                                        WHERE BKG_NO =@[bkg_no]
                    															AND CORR_NO ='TMP0000001')
                    					                    )
                    					                    )
                    					                    ORDER BY FLG
                    					) A
                    					WHERE 
                    					ROWNUM = 1) CR_RT_C
                    					
                             WHERE  BK.BKG_NO =@[bkg_no]
                               AND  BK.BKG_STS_CD <>'X'
                               AND  BK.BKG_NO = RT.BKG_NO
                               AND  BK.BKG_NO = N.BKG_NO
                               AND  BK.BKG_NO = F.BKG_NO
                               AND  N.BKG_CUST_TP_CD ='N'
                               AND  F.BKG_CUST_TP_CD ='F'
                               AND  BK.POR_CD = POR_L.LOC_CD
                               AND  POR_L.DELT_FLG ='N'
                               AND  BK.DEL_CD = DEL_L.LOC_CD
                               AND  DEL_L.DELT_FLG ='N'
                               AND  DEL_L.FINC_CTRL_OFC_CD = OFC.OFC_CD
                               AND  OFC.DELT_FLG='N'
                               AND  BK.BKG_NO = CR_RT_C.BKG_NO(+)
                    		   AND  BK.CORR_NO ='TMP0000001'
                      		   AND  RT.CORR_NO ='TMP0000001'
                       		   AND  N.CORR_NO ='TMP0000001'
                       		   AND  F.CORR_NO ='TMP0000001'),
    UPD_USR_ID = @[user_id],
    UPD_DT = SYSDATE  
WHERE BKG_NO = @[bkg_no]
AND CORR_NO ='TMP0000001'
	#end
#else
	#if(${bkg_no} !='')
UPDATE BKG_RATE
SET PPD_PAYR_CNT_CD = (SELECT CASE WHEN (POR_L.CONTI_CD ='F' OR POR_L.CONTI_CD = 'E') AND(F.CUST_SEQ IS NOT NULL AND NVL(F.CUST_SEQ,'') <> '0') AND EXISTS (SELECT 'Y' FROM MDM_LOCATION FL 
                                                                                                WHERE  FL.CONTI_CD ='E' 
                                                                                                  AND  FL.DELT_FLG ='N'
                                                                                                  AND  FL.CNT_CD = F.CUST_CNT_CD
                                                                                                  AND ROWNUM =1 )
                                        THEN F.CUST_CNT_CD
                                   ELSE CR_RT_P.CUST_CNT_CD
                                   END UP_PPD_PAYR_CNT_CD
                         FROM  BKG_BOOKING BK, BKG_RATE RT, BKG_CUSTOMER F, BKG_CUSTOMER N, MDM_LOCATION POR_L, MDM_LOCATION DEL_L,
                                        MDM_ORGANIZATION OFC, 
                                        (SELECT ROWNUM,A.* FROM 
                        				    (
                        					
					--PPD RULE 1 FF CASE
					SELECT BKG.BKG_NO BKG_NO,
					        10 AS FLG,
					        'S' AS BKG_CUST_TP_CD,
						 CR_CLT_OFC_CD AS OFC_CD,
 						 F.CUST_CNT_CD CUST_CNT_CD,
    					 F.CUST_SEQ CUST_SEQ,
    					 C.CUST_LGL_ENG_NM CUST_NM
					FROM   MDM_CR_CUST CUST,
					       BKG_BOOKING BKG,
                           MDM_CUSTOMER C,
    					   BKG_CUSTOMER F,
                           MDM_ORGANIZATION O
					WHERE  BKG.BKG_NO = @[bkg_no]
    				AND    BKG.BKG_NO = F.BKG_NO
    				AND    F.BKG_CUST_TP_CD = 'F'
					AND    F.CUST_CNT_CD = C.CUST_CNT_CD
					AND    F.CUST_SEQ = C.CUST_SEQ
					AND    C.DELT_FLG ='N'
					AND    NVL(C.NMD_CUST_FLG,'N') ='N'
					AND    CUST.CUST_CNT_CD = F.CUST_CNT_CD
					AND    CUST.CUST_SEQ = F.CUST_SEQ
					AND    BKG.BKG_OFC_CD = O.OFC_CD
					AND    O.DELT_FLG ='N'
					AND    NVL(O.PPD_PTY_TP_CD,'S') ='F'
    				AND    0 < CUST.OB_CR_TERM_DYS
					AND    CUST.CR_ST_DT  <= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no])
					AND    CUST.CR_END_DT >= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no])
					AND    CUST.DELT_FLG ='N'
					UNION
					--PPD RULE 2 SH CASE
					SELECT BKG.BKG_NO BKG_NO,
					        11 AS FLG,
					        'S' AS BKG_CUST_TP_CD,
						 CR_CLT_OFC_CD AS OFC_CD,
    					 S.CUST_CNT_CD CUST_CNT_CD,
    					 S.CUST_SEQ CUST_SEQ,
    					 C.CUST_LGL_ENG_NM CUST_NM
					FROM   MDM_CR_CUST CUST,
    					   BKG_BOOKING BKG,
                           MDM_CUSTOMER C,
    					   BKG_CUSTOMER S
					WHERE  BKG.BKG_NO = @[bkg_no]
    				AND    BKG.BKG_NO = S.BKG_NO
    				AND    S.BKG_CUST_TP_CD = 'S'
					AND    S.CUST_CNT_CD = C.CUST_CNT_CD
					AND    S.CUST_SEQ = C.CUST_SEQ
					AND    C.DELT_FLG ='N'
					AND    NVL(C.NMD_CUST_FLG,'N') ='N'
					AND    CUST.CUST_CNT_CD = S.CUST_CNT_CD
					AND    CUST.CUST_SEQ = S.CUST_SEQ
    				AND    0 < CUST.OB_CR_TERM_DYS
					AND    CUST.CR_ST_DT  <= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no])
					AND    CUST.CR_END_DT >= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no])
					AND    CUST.DELT_FLG ='N'
					UNION
					--PPD RULE 3 FF CASE
					--????????????????? MDM OFFICE ?? OFC_TP_CD?? QT ??????? POR ?? FINC_CTRL_OFC_CD ???????
					SELECT B.BKG_NO BKG_NO,
					        12 AS FLG,
					        'S' AS BKG_CUST_TP_CD,
					        DECODE(O.OFC_TP_CD,'QT',L.FINC_CTRL_OFC_CD,C.OFC_CD) OFC_CD,
    						F.CUST_CNT_CD,
    						F.CUST_SEQ,
    						C.CUST_LGL_ENG_NM AS CUST_NM
					FROM    BKG_BOOKING B,
					        BKG_CUSTOMER F,
					        MDM_CUSTOMER C,
							MDM_ORGANIZATION O,
							MDM_LOCATION L
					WHERE  B.BKG_NO = @[bkg_no]
    				AND  F.BKG_NO = B.BKG_NO
    				AND  F.BKG_CUST_TP_CD = 'F'
    				AND  F.CUST_CNT_CD = C.CUST_CNT_CD
    				AND  F.CUST_SEQ = C.CUST_SEQ
    				AND  C.DELT_FLG ='N'
    				AND  O.DELT_FLG ='N'
    				AND  L.DELT_FLG ='N'
    				AND  B.BKG_OFC_CD = O.OFC_CD 
    				AND  NVL(C.NMD_CUST_FLG,'N') ='N'	
    				AND  NVL(O.PPD_PTY_TP_CD,'S') ='F'
    				AND  B.POR_CD = L.LOC_CD
					UNION
					--PPD RULE 4 SH CASE
					--????????????????? MDM OFFICE ?? OFC_TP_CD?? QT ??????? POR ?? FINC_CTRL_OFC_CD ???????
					SELECT B.BKG_NO BKG_NO,
					        13 AS FLG,
					        'S' AS BKG_CUST_TP_CD,
					        DECODE(O.OFC_TP_CD,'QT',L.FINC_CTRL_OFC_CD,C.OFC_CD) OFC_CD,
					        C.CUST_CNT_CD,
					        C.CUST_SEQ,
					        C.CUST_LGL_ENG_NM AS CUST_NM
					FROM    BKG_BOOKING B,
					        BKG_CUSTOMER S,
					        MDM_CUSTOMER C,
							MDM_ORGANIZATION O,
							MDM_LOCATION L
					WHERE  B.BKG_NO = @[bkg_no]
					AND    S.BKG_NO = B.BKG_NO
					AND    S.BKG_CUST_TP_CD = 'S'
					AND    S.CUST_CNT_CD = C.CUST_CNT_CD
					AND    S.CUST_SEQ = C.CUST_SEQ
					AND    C.DELT_FLG ='N'
					AND    O.DELT_FLG ='N'
					AND    L.DELT_FLG ='N'
					AND    C.OFC_CD = O.OFC_CD 
					AND    NVL(C.NMD_CUST_FLG,'N') ='N'	
					AND    B.POR_CD = L.LOC_CD
					ORDER BY FLG
					
                        					) A
                        					WHERE ROWNUM = 1) CR_RT_P
                        					
                                 WHERE  BK.BKG_NO =@[bkg_no]
                                   AND  BK.BKG_STS_CD <>'X'
                                   AND  BK.BKG_NO = RT.BKG_NO
                                   AND  BK.BKG_NO = N.BKG_NO
                                   AND  BK.BKG_NO = F.BKG_NO
                                   AND  N.BKG_CUST_TP_CD ='N'
                                   AND  F.BKG_CUST_TP_CD ='F'
                                   AND  BK.POR_CD = POR_L.LOC_CD
                                   AND  POR_L.DELT_FLG ='N'
                                   AND  BK.DEL_CD = DEL_L.LOC_CD
                                   AND  DEL_L.DELT_FLG ='N'
                                   AND  DEL_L.FINC_CTRL_OFC_CD = OFC.OFC_CD
                                   AND  OFC.DELT_FLG='N'
                                   AND  BK.BKG_NO = CR_RT_P.BKG_NO(+)),
    PPD_PAYR_CUST_SEQ = (SELECT CASE WHEN (POR_L.CONTI_CD ='F' OR POR_L.CONTI_CD = 'E') AND(F.CUST_SEQ IS NOT NULL AND NVL(F.CUST_SEQ,'') <> '0') AND EXISTS (SELECT 'Y' FROM MDM_LOCATION FL 
                                                                                            WHERE  FL.CONTI_CD ='E' 
                                                                                              AND  FL.DELT_FLG ='N'
                                                                                              AND  FL.CNT_CD = F.CUST_CNT_CD
                                                                                              AND ROWNUM =1 )
                                    THEN F.CUST_SEQ
                               ELSE CR_RT_P.CUST_SEQ
                               END UP_PPD_PAYR_CUST_SEQ
                             FROM  BKG_BOOKING BK, BKG_RATE RT, BKG_CUSTOMER F, BKG_CUSTOMER N, MDM_LOCATION POR_L, MDM_LOCATION DEL_L,
                                    MDM_ORGANIZATION OFC, 
                                    (SELECT ROWNUM,A.* FROM 
                    				    (
                    					
					--PPD RULE 1 FF CASE
					SELECT BKG.BKG_NO BKG_NO,
					        10 AS FLG,
					        'S' AS BKG_CUST_TP_CD,
						 CR_CLT_OFC_CD AS OFC_CD,
 						 F.CUST_CNT_CD CUST_CNT_CD,
    					 F.CUST_SEQ CUST_SEQ,
    					 C.CUST_LGL_ENG_NM CUST_NM
					FROM   MDM_CR_CUST CUST,
					       BKG_BOOKING BKG,
                           MDM_CUSTOMER C,
    					   BKG_CUSTOMER F,
                           MDM_ORGANIZATION O
					WHERE  BKG.BKG_NO = @[bkg_no]
    				AND    BKG.BKG_NO = F.BKG_NO
    				AND    F.BKG_CUST_TP_CD = 'F'
					AND    F.CUST_CNT_CD = C.CUST_CNT_CD
					AND    F.CUST_SEQ = C.CUST_SEQ
					AND    C.DELT_FLG ='N'
					AND    NVL(C.NMD_CUST_FLG,'N') ='N'
					AND    CUST.CUST_CNT_CD = F.CUST_CNT_CD
					AND    CUST.CUST_SEQ = F.CUST_SEQ
					AND    BKG.BKG_OFC_CD = O.OFC_CD
					AND    O.DELT_FLG ='N'
					AND    NVL(O.PPD_PTY_TP_CD,'S') ='F'
    				AND    0 < CUST.OB_CR_TERM_DYS
					AND    CUST.CR_ST_DT  <= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no])
					AND    CUST.CR_END_DT >= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no])
					AND    CUST.DELT_FLG ='N'
					UNION
					--PPD RULE 2 SH CASE
					SELECT BKG.BKG_NO BKG_NO,
					        11 AS FLG,
					        'S' AS BKG_CUST_TP_CD,
						 CR_CLT_OFC_CD AS OFC_CD,
    					 S.CUST_CNT_CD CUST_CNT_CD,
    					 S.CUST_SEQ CUST_SEQ,
    					 C.CUST_LGL_ENG_NM CUST_NM
					FROM   MDM_CR_CUST CUST,
    					   BKG_BOOKING BKG,
                           MDM_CUSTOMER C,
    					   BKG_CUSTOMER S
					WHERE  BKG.BKG_NO = @[bkg_no]
    				AND    BKG.BKG_NO = S.BKG_NO
    				AND    S.BKG_CUST_TP_CD = 'S'
					AND    S.CUST_CNT_CD = C.CUST_CNT_CD
					AND    S.CUST_SEQ = C.CUST_SEQ
					AND    C.DELT_FLG ='N'
					AND    NVL(C.NMD_CUST_FLG,'N') ='N'
					AND    CUST.CUST_CNT_CD = S.CUST_CNT_CD
					AND    CUST.CUST_SEQ = S.CUST_SEQ
    				AND    0 < CUST.OB_CR_TERM_DYS
					AND    CUST.CR_ST_DT  <= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no])
					AND    CUST.CR_END_DT >= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no])
					AND    CUST.DELT_FLG ='N'
					UNION
					--PPD RULE 3 FF CASE
					--????????????????? MDM OFFICE ?? OFC_TP_CD?? QT ??????? POR ?? FINC_CTRL_OFC_CD ???????
					SELECT B.BKG_NO BKG_NO,
					        12 AS FLG,
					        'S' AS BKG_CUST_TP_CD,
					        DECODE(O.OFC_TP_CD,'QT',L.FINC_CTRL_OFC_CD,C.OFC_CD) OFC_CD,
    						F.CUST_CNT_CD,
    						F.CUST_SEQ,
    						C.CUST_LGL_ENG_NM AS CUST_NM
					FROM    BKG_BOOKING B,
					        BKG_CUSTOMER F,
					        MDM_CUSTOMER C,
							MDM_ORGANIZATION O,
							MDM_LOCATION L
					WHERE  B.BKG_NO = @[bkg_no]
    				AND  F.BKG_NO = B.BKG_NO
    				AND  F.BKG_CUST_TP_CD = 'F'
    				AND  F.CUST_CNT_CD = C.CUST_CNT_CD
    				AND  F.CUST_SEQ = C.CUST_SEQ
    				AND  C.DELT_FLG ='N'
    				AND  O.DELT_FLG ='N'
    				AND  L.DELT_FLG ='N'
    				AND  B.BKG_OFC_CD = O.OFC_CD 
    				AND  NVL(C.NMD_CUST_FLG,'N') ='N'	
    				AND  NVL(O.PPD_PTY_TP_CD,'S') ='F'
    				AND  B.POR_CD = L.LOC_CD
					UNION
					--PPD RULE 4 SH CASE
					--????????????????? MDM OFFICE ?? OFC_TP_CD?? QT ??????? POR ?? FINC_CTRL_OFC_CD ???????
					SELECT B.BKG_NO BKG_NO,
					        13 AS FLG,
					        'S' AS BKG_CUST_TP_CD,
					        DECODE(O.OFC_TP_CD,'QT',L.FINC_CTRL_OFC_CD,C.OFC_CD) OFC_CD,
					        C.CUST_CNT_CD,
					        C.CUST_SEQ,
					        C.CUST_LGL_ENG_NM AS CUST_NM
					FROM    BKG_BOOKING B,
					        BKG_CUSTOMER S,
					        MDM_CUSTOMER C,
							MDM_ORGANIZATION O,
							MDM_LOCATION L
					WHERE  B.BKG_NO = @[bkg_no]
					AND    S.BKG_NO = B.BKG_NO
					AND    S.BKG_CUST_TP_CD = 'S'
					AND    S.CUST_CNT_CD = C.CUST_CNT_CD
					AND    S.CUST_SEQ = C.CUST_SEQ
					AND    C.DELT_FLG ='N'
					AND    O.DELT_FLG ='N'
					AND    L.DELT_FLG ='N'
					AND    C.OFC_CD = O.OFC_CD 
					AND    NVL(C.NMD_CUST_FLG,'N') ='N'	
					AND    B.POR_CD = L.LOC_CD
					ORDER BY FLG
					
                    					) A
                    					WHERE ROWNUM = 1) CR_RT_P
                    					
                             WHERE  BK.BKG_NO =@[bkg_no]
                               AND  BK.BKG_STS_CD <>'X'
                               AND  BK.BKG_NO = RT.BKG_NO
                               AND  BK.BKG_NO = N.BKG_NO
                               AND  BK.BKG_NO = F.BKG_NO
                               AND  N.BKG_CUST_TP_CD ='N'
                               AND  F.BKG_CUST_TP_CD ='F'
                               AND  BK.POR_CD = POR_L.LOC_CD
                               AND  POR_L.DELT_FLG ='N'
                               AND  BK.DEL_CD = DEL_L.LOC_CD
                               AND  DEL_L.DELT_FLG ='N'
                               AND  DEL_L.FINC_CTRL_OFC_CD = OFC.OFC_CD
                               AND  OFC.DELT_FLG='N'
                               AND  BK.BKG_NO = CR_RT_P.BKG_NO(+)),
    CLT_PAYR_CNT_CD = (SELECT CASE WHEN BK.CUST_TO_ORD_FLG='Y' AND ( NVL(N.CUST_CNT_CD,'')||N.CUST_SEQ = '0' OR N.CUST_CNT_CD||N.CUST_SEQ IS NULL OR N.CUST_SEQ IS NULL)
                                    THEN OFC.REP_CUST_CNT_CD --FIN_OFC 의 AR CUSTOMER
                                    WHEN BK.CUST_TO_ORD_FLG='Y' AND ( NVL(N.CUST_CNT_CD,'')||N.CUST_SEQ <> '0' AND N.CUST_CNT_CD||N.CUST_SEQ IS NOT NULL AND N.CUST_SEQ IS NOT NULL )
                                    THEN N.CUST_CNT_CD    -- NOTIFY
                                    ELSE CR_RT_C.CUST_CNT_CD  -- NOT NULL 을 위해 DEFALUT 
                                    END UP_CLT_PAYR_CNT_CD
                        FROM  BKG_BOOKING BK, BKG_RATE RT, BKG_CUSTOMER F, BKG_CUSTOMER N, MDM_LOCATION POR_L, MDM_LOCATION DEL_L,
                              MDM_ORGANIZATION OFC, 
            					(SELECT ROWNUM,A.* FROM 
            					(
            					--CCT
            					SELECT  BKG.BKG_NO AS BKG_NO,
            					        21 AS FLG,
            					        'C' AS BKG_CUST_TP_CD,
            					        CR_CLT_OFC_CD AS OFC_CD,
            					        BCUST.CUST_CNT_CD AS CUST_CNT_CD,
            					        BCUST.CUST_SEQ AS CUST_SEQ,
            					        MCUST.CUST_LGL_ENG_NM AS CUST_NM
            					FROM    MDM_CR_CUST CUST,
            					        BKG_BOOKING BKG,
            					        BKG_CUSTOMER BCUST,
            					        MDM_CUSTOMER MCUST
            					WHERE  BKG.BKG_NO = @[bkg_no]
            					AND    BKG.BKG_NO = BCUST.BKG_NO
            					AND    BCUST.BKG_CUST_TP_CD = 'C'
            					AND    CUST.CUST_CNT_CD = BCUST.CUST_CNT_CD
            					AND    CUST.CUST_SEQ = BCUST.CUST_SEQ
            					AND    BCUST.CUST_CNT_CD = MCUST.CUST_CNT_CD
            					AND    BCUST.CUST_SEQ = MCUST.CUST_SEQ    
            					AND    IB_CR_TERM_DYS > 0
            					AND    CR_ST_DT  <= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no])
            					AND    CR_END_DT >= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no])
            					AND    MCUST.DELT_FLG ='N'
            					AND    NVL(MCUST.NMD_CUST_FLG,'N') ='N'
            					AND    CUST.DELT_FLG ='N'
            					UNION
            					--CCT OFFICE CODE2
            					SELECT B.BKG_NO BKG_NO,
            					        22 AS FLG,
            					        'C' AS BKG_CUST_TP_CD,
            					        FINC_CTRL_OFC_CD AS OFC_CD,
            					        S.CUST_CNT_CD  AS CUST_CNT_CD,
            					        NVL(S.CUST_SEQ,'1') AS CUST_SEQ,
            					        C.CUST_LGL_ENG_NM AS CUST_NM
            					FROM    MDM_LOCATION M, 
            					        BKG_BOOKING B, 
            					        BKG_CUSTOMER S,
            					        MDM_CUSTOMER C
            					WHERE  B.BKG_NO = @[bkg_no]
            					AND    S.BKG_NO = B.BKG_NO
            					AND    S.BKG_CUST_TP_CD = 'C'
            					AND    S.CUST_CNT_CD = C.CUST_CNT_CD
            					AND    S.CUST_SEQ = C.CUST_SEQ
            					AND    B.DEL_CD = M.LOC_CD
            					AND    C.DELT_FLG = 'N'
            					AND	NVL(C.NMD_CUST_FLG,'N') ='N'
            					UNION
            					--REP CUSTOMER
            					SELECT BKG_NO,
            					        31 AS FLG,
            					        'R'AS BKG_CUST_TP_CD,
            					        (SELECT  FINC_CTRL_OFC_CD
            					            FROM MDM_LOCATION
            					            WHERE LOC_CD = (SELECT DEL_CD
            					                            FROM  BKG_BOOKING
            					                            WHERE BKG_NO =@[bkg_no])) AS OFC_CD,
            					        REP_CUST_CNT_CD AS CUST_CNT_CD,
            					        REP_CUST_SEQ AS CUST_SEQ,
            					        MCUST.CUST_LGL_ENG_NM AS CUST_NM
            					FROM   MDM_ORGANIZATION OFC, 
            					        BKG_BOOKING BKG,
            					        MDM_CUSTOMER MCUST
            					WHERE  BKG.BKG_NO = @[bkg_no]
            					AND    REP_CUST_CNT_CD = MCUST.CUST_CNT_CD
            					AND    REP_CUST_SEQ = MCUST.CUST_SEQ
            					AND    MCUST.DELT_FLG ='N'
            					AND	NVL(MCUST.NMD_CUST_FLG,'N') ='N'
            					AND    OFC.OFC_CD = NVL((SELECT CR_CLT_OFC_CD
            					                        FROM MDM_CR_CUST
            					                        WHERE (CUST_CNT_CD, CUST_SEQ) = (SELECT CUST_CNT_CD, CUST_SEQ
            					                                                            FROM   BKG_BOOKING B,
            					                                                                    BKG_CUSTOMER C
            					                                                            WHERE  B.BKG_NO = @[bkg_no]
            					                                                            AND    C.BKG_NO = B.BKG_NO
            					                                                            AND    C.BKG_CUST_TP_CD = 'C'
            																				)
            					                        AND 0 < IB_CR_TERM_DYS
            											AND MCUST.DELT_FLG ='N'
            					                        AND CR_ST_DT  <= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no])
            					                        AND CR_END_DT >= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no])),
            					                    (SELECT  FINC_CTRL_OFC_CD
            					                        FROM MDM_LOCATION
            					                        WHERE LOC_CD = (SELECT DEL_CD
            					                                        FROM  BKG_BOOKING
            					                                        WHERE BKG_NO =@[bkg_no])
            					                    )
            					                    )
            					                    ORDER BY FLG
            					) A
            					WHERE 
            					ROWNUM = 1) CR_RT_C
            					
                     WHERE  BK.BKG_NO =@[bkg_no]
                       AND  BK.BKG_STS_CD <>'X'
                       AND  BK.BKG_NO = RT.BKG_NO
                       AND  BK.BKG_NO = N.BKG_NO
                       AND  BK.BKG_NO = F.BKG_NO
                       AND  N.BKG_CUST_TP_CD ='N'
                       AND  F.BKG_CUST_TP_CD ='F'
                       AND  BK.POR_CD = POR_L.LOC_CD
                       AND  POR_L.DELT_FLG ='N'
                       AND  BK.DEL_CD = DEL_L.LOC_CD
                       AND  DEL_L.DELT_FLG ='N'
                       AND  DEL_L.FINC_CTRL_OFC_CD = OFC.OFC_CD
                       AND  OFC.DELT_FLG='N'
                       AND  BK.BKG_NO = CR_RT_C.BKG_NO(+)),
    CLT_PAYR_CUST_SEQ = (SELECT CASE WHEN BK.CUST_TO_ORD_FLG='Y' AND ( NVL(N.CUST_CNT_CD,'')||N.CUST_SEQ = '0' OR N.CUST_CNT_CD||N.CUST_SEQ IS NULL OR N.CUST_SEQ IS NULL)
                                THEN OFC.REP_CUST_SEQ   --FIN_OFC 의 AR CUSTOMER
                                WHEN BK.CUST_TO_ORD_FLG='Y' AND ( NVL(N.CUST_CNT_CD,'')||N.CUST_SEQ <> '0' AND N.CUST_CNT_CD||N.CUST_SEQ IS NOT NULL AND N.CUST_SEQ IS NOT NULL)
                                THEN N.CUST_SEQ       -- NOTIFY
                                ELSE CR_RT_C.CUST_SEQ -- NOT NULL 을 위해 DEFALUT 
                                END UP_CLT_PAYR_CUST_SEQ
                         FROM  BKG_BOOKING BK, BKG_RATE RT, BKG_CUSTOMER F, BKG_CUSTOMER N, MDM_LOCATION POR_L, MDM_LOCATION DEL_L,
                                MDM_ORGANIZATION OFC, 
                					(SELECT ROWNUM,A.* FROM 
                					(
                					--CCT
                					SELECT  BKG.BKG_NO AS BKG_NO,
                					        21 AS FLG,
                					        'C' AS BKG_CUST_TP_CD,
                					        CR_CLT_OFC_CD AS OFC_CD,
                					        BCUST.CUST_CNT_CD AS CUST_CNT_CD,
                					        BCUST.CUST_SEQ AS CUST_SEQ,
                					        MCUST.CUST_LGL_ENG_NM AS CUST_NM
                					FROM    MDM_CR_CUST CUST,
                					        BKG_BOOKING BKG,
                					        BKG_CUSTOMER BCUST,
                					        MDM_CUSTOMER MCUST
                					WHERE  BKG.BKG_NO = @[bkg_no]
                					AND    BKG.BKG_NO = BCUST.BKG_NO
                					AND    BCUST.BKG_CUST_TP_CD = 'C'
                					AND    CUST.CUST_CNT_CD = BCUST.CUST_CNT_CD
                					AND    CUST.CUST_SEQ = BCUST.CUST_SEQ
                					AND    BCUST.CUST_CNT_CD = MCUST.CUST_CNT_CD
                					AND    BCUST.CUST_SEQ = MCUST.CUST_SEQ    
                					AND    IB_CR_TERM_DYS > 0
                					AND    CR_ST_DT  <= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no])
                					AND    CR_END_DT >= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no])
                					AND    MCUST.DELT_FLG ='N'
                					AND    NVL(MCUST.NMD_CUST_FLG,'N') ='N'
                					AND    CUST.DELT_FLG ='N'
                					UNION
                					--CCT OFFICE CODE2
                					SELECT B.BKG_NO BKG_NO,
                					        22 AS FLG,
                					        'C' AS BKG_CUST_TP_CD,
                					        FINC_CTRL_OFC_CD AS OFC_CD,
                					        S.CUST_CNT_CD  AS CUST_CNT_CD,
                					        NVL(S.CUST_SEQ,'1') AS CUST_SEQ,
                					        C.CUST_LGL_ENG_NM AS CUST_NM
                					FROM    MDM_LOCATION M, 
                					        BKG_BOOKING B, 
                					        BKG_CUSTOMER S,
                					        MDM_CUSTOMER C
                					WHERE  B.BKG_NO = @[bkg_no]
                					AND    S.BKG_NO = B.BKG_NO
                					AND    S.BKG_CUST_TP_CD = 'C'
                					AND    S.CUST_CNT_CD = C.CUST_CNT_CD
                					AND    S.CUST_SEQ = C.CUST_SEQ
                					AND    B.DEL_CD = M.LOC_CD
                					AND    C.DELT_FLG = 'N'
                					AND	NVL(C.NMD_CUST_FLG,'N') ='N'
                					UNION
                					--REP CUSTOMER
                					SELECT BKG_NO,
                					        31 AS FLG,
                					        'R'AS BKG_CUST_TP_CD,
                					        (SELECT  FINC_CTRL_OFC_CD
                					            FROM MDM_LOCATION
                					            WHERE LOC_CD = (SELECT DEL_CD
                					                            FROM  BKG_BOOKING
                					                            WHERE BKG_NO =@[bkg_no])) AS OFC_CD,
                					        REP_CUST_CNT_CD AS CUST_CNT_CD,
                					        REP_CUST_SEQ AS CUST_SEQ,
                					        MCUST.CUST_LGL_ENG_NM AS CUST_NM
                					FROM   MDM_ORGANIZATION OFC, 
                					        BKG_BOOKING BKG,
                					        MDM_CUSTOMER MCUST
                					WHERE  BKG.BKG_NO = @[bkg_no]
                					AND    REP_CUST_CNT_CD = MCUST.CUST_CNT_CD
                					AND    REP_CUST_SEQ = MCUST.CUST_SEQ
                					AND    MCUST.DELT_FLG ='N'
                					AND	NVL(MCUST.NMD_CUST_FLG,'N') ='N'
                					AND    OFC.OFC_CD = NVL((SELECT CR_CLT_OFC_CD
                					                        FROM MDM_CR_CUST
                					                        WHERE (CUST_CNT_CD, CUST_SEQ) = (SELECT CUST_CNT_CD, CUST_SEQ
                					                                                            FROM   BKG_BOOKING B,
                					                                                                    BKG_CUSTOMER C
                					                                                            WHERE  B.BKG_NO = @[bkg_no]
                					                                                            AND    C.BKG_NO = B.BKG_NO
                					                                                            AND    C.BKG_CUST_TP_CD = 'C'
                																				)
                					                        AND 0 < IB_CR_TERM_DYS
                											AND MCUST.DELT_FLG ='N'
                					                        AND CR_ST_DT  <= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no])
                					                        AND CR_END_DT >= (SELECT TO_CHAR(BKG_CRE_DT,'RRRRMMDD') FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no])),
                					                    (SELECT  FINC_CTRL_OFC_CD
                					                        FROM MDM_LOCATION
                					                        WHERE LOC_CD = (SELECT DEL_CD
                					                                        FROM  BKG_BOOKING
                					                                        WHERE BKG_NO =@[bkg_no])
                					                    )
                					                    )
                					                    ORDER BY FLG
                					) A
                					WHERE 
                					ROWNUM = 1) CR_RT_C
                					
                         WHERE  BK.BKG_NO =@[bkg_no]
                           AND  BK.BKG_STS_CD <>'X'
                           AND  BK.BKG_NO = RT.BKG_NO
                           AND  BK.BKG_NO = N.BKG_NO
                           AND  BK.BKG_NO = F.BKG_NO
                           AND  N.BKG_CUST_TP_CD ='N'
                           AND  F.BKG_CUST_TP_CD ='F'
                           AND  BK.POR_CD = POR_L.LOC_CD
                           AND  POR_L.DELT_FLG ='N'
                           AND  BK.DEL_CD = DEL_L.LOC_CD
                           AND  DEL_L.DELT_FLG ='N'
                           AND  DEL_L.FINC_CTRL_OFC_CD = OFC.OFC_CD
                           AND  OFC.DELT_FLG='N'
                           AND  BK.BKG_NO = CR_RT_C.BKG_NO(+)),
    UPD_USR_ID = @[user_id],
    UPD_DT = SYSDATE  
WHERE BKG_NO = @[bkg_no]
	#end
#end			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="user_id" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
