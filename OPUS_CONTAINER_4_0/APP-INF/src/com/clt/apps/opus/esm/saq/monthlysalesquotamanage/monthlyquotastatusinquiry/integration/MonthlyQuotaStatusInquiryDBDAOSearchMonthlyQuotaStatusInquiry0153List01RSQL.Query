<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="MonthlyQuotaStatusInquiryDBDAOSearchMonthlyQuotaStatusInquiry0153List01RSQL">
			<desc><![CDATA[Process Status
2011.02.17 GLOBALDATE_PKG.TIME_CONV_OFC_FNC 수정]]></desc>
			<sql><![CDATA[
WITH SEQ AS (										
			     SELECT 									
				     INTG_CD_VAL_CTNT,							
				     INTG_CD_VAL_DP_SEQ 						
			     FROM 									
				     COM_INTG_CD_DTL							
			     WHERE 									
				     INTG_CD_ID='CD00926'						
			     ORDER BY 									
				     INTG_CD_VAL_DP_SEQ ) 						
		    , STEP_CD AS (									
			     SELECT 									
				  INTG_CD_VAL_DP_SEQ  CODE, 						
				  INTG_CD_VAL_DP_DESC  TEXT						
			     FROM  									
				  COM_INTG_CD_DTL                    					
			     WHERE 									
				  INTG_CD_ID = 'CD01214'                    				
			     ORDER BY 									
				  INTG_CD_VAL_DP_SEQ)   						
		    , COM_FLAG AS ( 									
				 SELECT  INTG_CD_VAL_DP_SEQ  CODE, 					
					     INTG_CD_VAL_DP_DESC  TEXT					
				 FROM  									
					 COM_INTG_CD_DTL                    				
				 WHERE 									
					 INTG_CD_ID = 'CD01213'                    			
				 ORDER 									
					BY INTG_CD_VAL_DP_SEQ ) 					
			, STP_DT AS (				
    		 	 SELECT 				
    		 		 MQTA_STEP_CD,			
    		 		BSE_YR,			
    		 		BSE_QTR_CD,			
    		 		TRD_CD,			
    		 		DIR_CD,			
    		 		CRE_OFC_CD,			
    		 		MQTA_VER_NO,			
    		 		DRFT_CFM_GDT,			
    		 		FNL_CFM_GDT			
    		 	FROM SAQ_MON_QTA_STEP_VER )				
		   	, TGT_GRP AS ( 										
		   		SELECT								
		  			TRD_CD,								
		  		 	SAQ_TGT_GRP_CD								
		  	    FROM									
		    	 	SAQ_TGT_GRP_TRD_V  )									
		    , UPD AS (										
			     SELECT 									
				     MQTA_STEP_CD,							
				     BSE_YR,								
				     BSE_QTR_CD,								
				     TRD_CD,								
				     DIR_CD,								
				     SUBSTR(MQTA_VER_NO, 1,LENGTH(MQTA_VER_NO)-9) CRE_OFC_CD,		
				     SUBSTR(MQTA_VER_NO, 1,LENGTH(MQTA_VER_NO)-2) MQTA_VER_GRP_NO,		
				     MAX(UPD_DT) UPD_DT							
			     FROM 									
	   		 	 SAQ_MON_QTA_TRD 													
			     GROUP BY 									
				     MQTA_STEP_CD,							
				     BSE_YR,								
				     BSE_QTR_CD,								
				     TRD_CD,								
				     DIR_CD,								
				     SUBSTR(MQTA_VER_NO, 1,LENGTH(MQTA_VER_NO)-9),			
				     SUBSTR(MQTA_VER_NO, 1,LENGTH(MQTA_VER_NO)-2)			
			     UNION ALL									
			     SELECT 									
				     MQTA_STEP_CD,							
				     BSE_YR,								
				     BSE_QTR_CD,								
				     TRD_CD,								
				     DIR_CD,								
				     SUBSTR(MQTA_VER_NO, 1,LENGTH(MQTA_VER_NO)-9) CRE_OFC_CD,		
				     SUBSTR(MQTA_VER_NO, 1,LENGTH(MQTA_VER_NO)-2) MQTA_VER_GRP_NO,		
				     MAX(UPD_DT) UPD_DT							
			     FROM 									
				   SAQ_MON_QTA_RHQ							
			     GROUP BY 									
				     MQTA_STEP_CD,							
				     BSE_YR,								
				     BSE_QTR_CD,								
				     TRD_CD,								
				     DIR_CD,								
				     SUBSTR(MQTA_VER_NO, 1,LENGTH(MQTA_VER_NO)-9),			
				     SUBSTR(MQTA_VER_NO, 1,LENGTH(MQTA_VER_NO)-2)  			
			     UNION ALL									
			     SELECT 									
				     MQTA_STEP_CD,							
				     BSE_YR,								
				     BSE_QTR_CD,								
				     TRD_CD,								
				     DIR_CD,								
				     SUBSTR(MQTA_VER_NO, 1,LENGTH(MQTA_VER_NO)-9) CRE_OFC_CD,		
				     SUBSTR(MQTA_VER_NO, 1,LENGTH(MQTA_VER_NO)-2) MQTA_VER_GRP_NO,		
				     MAX(UPD_DT) UPD_DT							
			     FROM 									
				   SAQ_MON_QTA_LOD_TGT							
			     GROUP BY 									
				     MQTA_STEP_CD,							
				     BSE_YR,								
				     BSE_QTR_CD,								
				     TRD_CD,								
				     DIR_CD,								
				     SUBSTR(MQTA_VER_NO, 1,LENGTH(MQTA_VER_NO)-9),			
				     SUBSTR(MQTA_VER_NO, 1,LENGTH(MQTA_VER_NO)-2))  				
		    , DATA AS										
		    ( 											
			    SELECT 									
				CASE WHEN VER.MQTA_STEP_CD='01' THEN '1'				
				    WHEN VER.MQTA_STEP_CD='02' THEN '2'					
				    WHEN VER.MQTA_STEP_CD='03' THEN '3'          			
				    WHEN VER.MQTA_STEP_CD='04' THEN '5' 				
				    WHEN VER.MQTA_STEP_CD='08' THEN '9' 				
				    WHEN VER.MQTA_STEP_CD='09' THEN '10' 					
				END AS SEQ,								
				VER.MQTA_STEP_CD,        						
				VER.BSE_YR,								
				VER.BSE_QTR_CD,								
				VER.TRD_CD,								
				VER.DIR_CD,								
				VER.MQTA_VER_NO,							
				VER.GLINE_VER_NO,							
				VER.CRE_OFC_CD, 							
				VER.SAQ_STS_CD,								
				SEQ.INTG_CD_VAL_DP_SEQ STS_SEQ						
			    FROM SAQ_MON_QTA_STEP_VER VER, SEQ						
			    WHERE VER.MQTA_STEP_CD IN ('01','02','03','04','05','06', '08', '09' )			
			    AND VER.SAQ_STS_CD <> 'XX'					
			    AND SEQ.INTG_CD_VAL_CTNT = VER.SAQ_STS_CD					
		            AND VER.BSE_YR = @[year]							
		            AND VER.BSE_QTR_CD = @[quarter]							
		            AND VER.TRD_CD LIKE @[trd_cd]||'%'							
		            AND VER.DIR_CD LIKE @[dir_cd]||'%'            						
													
			    UNION ALL									
			    										
			    SELECT 									
				CASE WHEN VER.MQTA_STEP_CD='02' THEN '4'				
				END AS SEQ,								
				VER.MQTA_STEP_CD,        						
				VER.BSE_YR,								
				VER.BSE_QTR_CD,								
				VER.TRD_CD,								
				VER.DIR_CD,								
				VER.MQTA_VER_NO,							
				VER.GLINE_VER_NO,							
				VER.CRE_OFC_CD, 							
				VER.SAQ_STS_CD,								
				SEQ.INTG_CD_VAL_DP_SEQ STS_SEQ						
		    											
			    FROM SAQ_MON_QTA_STEP_VER VER, SEQ						
			    WHERE VER.MQTA_STEP_CD IN ('02')					
			    AND VER.SAQ_STS_CD <> 'XX'					
			    AND SEQ.INTG_CD_VAL_DP_SEQ > 5						
			    AND SEQ.INTG_CD_VAL_CTNT = VER.SAQ_STS_CD					
		            AND VER.BSE_YR = @[year]							
		            AND VER.BSE_QTR_CD = @[quarter]							
		            AND VER.TRD_CD LIKE @[trd_cd]||'%'							
		            AND VER.DIR_CD LIKE @[dir_cd]||'%'            						
			    ) 										
		    , MAX_STS AS (									
			SELECT 										
				SEQ,									
				BSE_YR,									
				BSE_QTR_CD,								
				TRD_CD,									
				DIR_CD,									
				GLINE_VER_NO,								
				CRE_OFC_CD,								
				MAX(STS_SEQ) MAX_STS							
			FROM 										
				DATA									
			GROUP BY 									
				SEQ,									
				BSE_YR,									
				BSE_QTR_CD,								
				TRD_CD,									
				DIR_CD,									
				GLINE_VER_NO,								
				CRE_OFC_CD             							
			    )										
		    , MST AS (    									
		     SELECT 										
			DATA.SEQ,									
			STEP_CD.TEXT STEP,								
			CASE WHEN DATA.SEQ='1' AND STS_SEQ >3 THEN '1'          			
			 WHEN DATA.SEQ='2' AND STS_SEQ >3 THEN '1' 					
			 WHEN DATA.SEQ='3' AND STS_SEQ >7 THEN '1'  					
			 WHEN DATA.SEQ='4' AND STS_SEQ >6 THEN '1'  					
			 WHEN DATA.SEQ='5' AND STS_SEQ >3 THEN '1'  					
			 WHEN DATA.SEQ='6' AND STS_SEQ >3 THEN '1'   					
			 WHEN DATA.SEQ='7' AND STS_SEQ >7 THEN '1'   					
			 WHEN DATA.SEQ='8' AND STS_SEQ >6 THEN '1' 					
			 WHEN DATA.SEQ='9' AND STS_SEQ >3 THEN '1' 					
			 WHEN DATA.SEQ='10' AND STS_SEQ >6 THEN '1' 						
			 ELSE '2'    									
			END AS COM_FLAG,       								
			DATA.MQTA_STEP_CD,       							
			DATA.BSE_YR,									
			DATA.BSE_QTR_CD,									
			DATA.TRD_CD,									
			DATA.DIR_CD,									
			DATA.CRE_OFC_CD,								
			DATA.MQTA_VER_NO,								
			DATA.GLINE_VER_NO,								
			SUBSTR(DATA.MQTA_VER_NO, 1, LENGTH(DATA.MQTA_VER_NO)-2)              		
			||'-'||SUBSTR(DATA.MQTA_VER_NO, LENGTH(DATA.MQTA_VER_NO)-1)      		
			||DECODE(SAQ_STS_CD, '00', '','XX','', '-'||SAQ_STS_CD) VERSION,         	
			DATA.STS_SEQ									
													
		FROM DATA, MAX_STS, STEP_CD								
		WHERE 											
			STEP_CD.CODE = DATA.SEQ								
		       AND DATA.SEQ = MAX_STS.SEQ							
		       AND DATA.BSE_YR = MAX_STS.BSE_YR							
		       AND DATA.BSE_QTR_CD =MAX_STS.BSE_QTR_CD						
		       AND DATA.TRD_CD = MAX_STS.TRD_CD							
		       AND DATA.DIR_CD = MAX_STS.DIR_CD							
		       AND DATA.CRE_OFC_CD = MAX_STS.CRE_OFC_CD						
		       AND DATA.GLINE_VER_NO = MAX_STS.GLINE_VER_NO					
		       AND DATA.STS_SEQ = MAX_STS.MAX_STS						
		     )    										
		    											
		SELECT 											
			CASE WHEN FDATA.SEQ IN ( '9', '10' ) THEN 'Load Target'										
			ELSE 'Sales Quota'										
			END AS STAGE,										
			CASE WHEN FDATA.SEQ IN ( '9', '10' ) THEN TO_CHAR(TO_NUMBER(FDATA.SEQ)-8)										
			ELSE FDATA.SEQ										
			END AS SEQ,											
		    FDATA.STEP,	

    #if (${grp_flg} == "1") 
		    FDATA.TRD_GRP_STATUS GRP_STATUS,							
		    TGT_GRP.SAQ_TGT_GRP_CD FILTER1,								
		    FDATA.TRD_CD FILTER2,								
		    FDATA.DIR_CD FILTER3,								
		    FDATA.CRE_OFC_CD FILTER4,								
	#else
		    FDATA.ORG_GRP_STATUS GRP_STATUS,							
		    FDATA.CRE_OFC_CD FILTER1,     							
		    TGT_GRP.SAQ_TGT_GRP_CD FILTER2,								
		    FDATA.TRD_CD FILTER3,								
		    FDATA.DIR_CD FILTER4,								
	#end
		    FDATA.PR_OFC_CD, 									
		    FDATA.SUB_OFC_CD, 									
		    FDATA.VERSION, 									
		    CASE WHEN FDATA.VERSION IS NULL THEN 									
		   		TO_CHAR(GLOBALDATE_PKG.TIME_CONV_OFC_FNC(COM_ConstantMgr_PKG.COM_getHeadOfficeCode_FNC() ,UPD.UPD_DT, @[ofc_cd] ),'yyyy/mm/dd hh24:mi') 									
		    ELSE 									
		    	TO_CHAR(GLOBALDATE_PKG.TIME_CONV_OFC_FNC('GMT', 									
		   			 CASE WHEN FDATA.SEQ IN  ('1','2','6','8') THEN STP_DT.DRFT_CFM_GDT  									
		    		 ELSE STP_DT.FNL_CFM_GDT 									
		    		 END 									
		    		 , @[ofc_cd] ),'yyyy/mm/dd hh24:mi') 									
		    		 END AS UPD_DT, 									
		    FDATA.BSE_YR,									
		    FDATA.BSE_QTR_CD,									
		    FDATA.MQTA_VER_GRP_NO MQTA_VER_NO,									
		    FDATA.STATUS   									
		    											
		    											
		FROM	 										
		    (   										
		    SELECT DISTINCT									
			MST.SEQ,									
			MST.STEP,           								
			FLG.TEXT STATUS,								
    #if (${grp_flg} == "1") 
		    CASE WHEN TRD_GRP_COM.MX_FLG='1' THEN 'Completed'				
		    ELSE 'In Progress'								
		    END AS  TRD_GRP_STATUS, 							
	#else
			CASE WHEN ORG_GRP_COM.MX_FLG='1' THEN 'Completed'				
			ELSE 'In Progress'								
			END AS  ORG_GRP_STATUS, 							
	#end
			MST.COM_FLAG,									
			MST.MQTA_STEP_CD,								
			MST.BSE_YR,									
			MST.BSE_QTR_CD,									
			MST.TRD_CD,									
			MST.DIR_CD,									
			CASE WHEN MST.SEQ IN ('6','8','10' ) THEN NVL(PRNT.N2ND_PRNT_OFC_CD,'UNKNOWN')||' / '||MST.CRE_OFC_CD									
    		ELSE MST.CRE_OFC_CD									
    		END AS CRE_OFC_CD,									
    		PRNT.N2ND_PRNT_OFC_CD PR_OFC_CD,									
    		MST.CRE_OFC_CD SUB_OFC_CD,									
			MST.GLINE_VER_NO,								
			SUBSTR(MST.MQTA_VER_NO, 1,LENGTH(MST.MQTA_VER_NO)-2) MQTA_VER_GRP_NO,								
			CASE WHEN MST.STS_SEQ < 3 THEN ''						
			ELSE MST.VERSION								
			END AS VERSION									
													
			   										
		    FROM 										
			MST, COM_FLAG FLG, MAX_STS,	SAQ_ORGANIZATION_V PRNT,						
    #if (${grp_flg} == "1") 
		        (										
		        SELECT SEQ, BSE_YR,BSE_QTR_CD,TRD_CD,DIR_CD,MAX(COM_FLAG) MX_FLG			
		        FROM MST									
		        GROUP BY SEQ, BSE_YR,BSE_QTR_CD,TRD_CD,DIR_CD					
		        ) TRD_GRP_COM									
	#else
			    (										
			    SELECT SEQ, BSE_YR,BSE_QTR_CD,CRE_OFC_CD,MAX(COM_FLAG) MX_FLG			
			    FROM MST									
			    GROUP BY SEQ, BSE_YR,BSE_QTR_CD,CRE_OFC_CD						
			    ) ORG_GRP_COM									
	#end
													
		    WHERE 										
			MST.COM_FLAG = FLG.CODE 							
	#if(${grp_flg} == "1") 
		    AND TRD_GRP_COM.SEQ = MST.SEQ  							
		    AND TRD_GRP_COM.BSE_YR = MST.BSE_YR						
		    AND TRD_GRP_COM.BSE_QTR_CD = MST.BSE_QTR_CD						
		    AND TRD_GRP_COM.TRD_CD = MST.TRD_CD						
		    AND TRD_GRP_COM.DIR_CD = MST.DIR_CD						
	#else
		    AND ORG_GRP_COM.SEQ = MST.SEQ  							
		    AND ORG_GRP_COM.BSE_YR = MST.BSE_YR							
		    AND ORG_GRP_COM.BSE_QTR_CD = MST.BSE_QTR_CD						
		    AND ORG_GRP_COM.CRE_OFC_CD = MST.CRE_OFC_CD						
	#end
		    AND MST.SEQ  = MAX_STS.SEQ								
		    AND MST.BSE_YR  = MAX_STS.BSE_YR							
		    AND MST.BSE_QTR_CD  = MAX_STS.BSE_QTR_CD							
		    AND MST.TRD_CD  = MAX_STS.TRD_CD							
		    AND MST.DIR_CD  = MAX_STS.DIR_CD							
		    AND MST.CRE_OFC_CD  = MAX_STS.CRE_OFC_CD						
		    AND MST.GLINE_VER_NO  = MAX_STS.GLINE_VER_NO					
		    AND MST.STS_SEQ = MAX_STS.MAX_STS							
		    AND PRNT.OFC_CD = MST.CRE_OFC_CD(+)							
													
		    ) FDATA, UPD, STP_DT, TGT_GRP    									
		    											
		WHERE 											
			   UPD.MQTA_STEP_CD(+) = FDATA.MQTA_STEP_CD					
		    AND UPD.BSE_YR(+) = FDATA.BSE_YR							
		    AND UPD.BSE_QTR_CD(+) = FDATA.BSE_QTR_CD							
		    AND UPD.TRD_CD(+) = FDATA.TRD_CD							
		    AND UPD.DIR_CD(+) = FDATA.DIR_CD							
		    AND UPD.MQTA_VER_GRP_NO(+) = FDATA.MQTA_VER_GRP_NO	
		    AND STP_DT.MQTA_STEP_CD(+) = FDATA.MQTA_STEP_CD							
		    AND STP_DT.BSE_YR(+) = FDATA.BSE_YR							
		    AND STP_DT.BSE_QTR_CD(+) = FDATA.BSE_QTR_CD							
		    AND STP_DT.TRD_CD(+) = FDATA.TRD_CD							
		    AND STP_DT.DIR_CD(+) = FDATA.DIR_CD							
		    AND STP_DT.MQTA_VER_NO(+) = SUBSTR(FDATA.VERSION, 1,LENGTH(FDATA.VERSION)-6)||SUBSTR(FDATA.VERSION, LENGTH(FDATA.VERSION)-4,2)							
		    AND TGT_GRP.TRD_CD = FDATA.TRD_CD		
	#if(${step} != "0") 	    
		 	AND FDATA.SEQ = @[step]										
	#end
	#if(${sts} != "0") 	    
		 	AND FDATA.COM_FLAG = @[sts]											
	#end
		ORDER BY 										
		    STAGE DESC,										
		    SEQ,										
			GRP_STATUS,	
			
    #if(${grp_flg} == "1") 
				FILTER1,									
				FILTER2,									
				FILTER3,									
				STATUS DESC,									
				FILTER4,									
				PR_OFC_CD,									
				SUB_OFC_CD,									
	#else
				PR_OFC_CD,									
				SUB_OFC_CD,											
				STATUS DESC,											
				FILTER1,									
				FILTER2,									
				FILTER3,									
				FILTER4,											
	#end
			VERSION,									
			UPD_DT			]]></sql>
			<params>
				<param name="year" type="12" value="" out="N"/>
				<param name="quarter" type="12" value="" out="N"/>
				<param name="trd_cd" type="12" value="" out="N"/>
				<param name="dir_cd" type="12" value="" out="N"/>
				<param name="ofc_cd" type="12" value="" out="N"/>
				<param name="step" type="12" value="" out="N"/>
				<param name="sts" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
