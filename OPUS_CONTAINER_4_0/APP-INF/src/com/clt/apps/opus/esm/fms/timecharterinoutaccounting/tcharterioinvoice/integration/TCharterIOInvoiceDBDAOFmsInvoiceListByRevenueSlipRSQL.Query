<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TCharterIOInvoiceDBDAOFmsInvoiceListByRevenueSlipRSQL">
			<desc><![CDATA[Hire Revenue Retrieve / Window Select]]></desc>
			<sql><![CDATA[
SELECT NVL(C.TO_YRMON,SUBSTR(C.CHTR_INV_DT, 1, 6)) AS TO_YRMON
     , B.PPAY_HIR_NO
     , D.ACCT_ITM_NM
     , C.ACCT_CD
     , A.CUST_CNT_CD
     , A.CUST_SEQ
     , C.CURR_CD
     , (SELECT SUM(INV_AMT)
          FROM FMS_INV_DTL
         WHERE FLET_CTRT_NO = C.FLET_CTRT_NO
           AND FLET_ISS_TP_CD = C.FLET_ISS_TP_CD
           AND INV_SEQ = C.INV_SEQ
           AND ACCT_CD = C.ACCT_CD
           AND INV_DESC = C.INV_DESC
           AND ACCT_ITM_SEQ = C.ACCT_ITM_SEQ) INV_AMT
     , C.INV_DESC
     , (SELECT MAX(AR_CTR_CD)
          FROM MDM_ORGANIZATION
         WHERE OFC_CD = @[slp_ofc_cd]) AR_CTR_CD
     , (SELECT MAX(LOC_CD)
          FROM MDM_ORGANIZATION
         WHERE OFC_CD = @[slp_ofc_cd]) LOC_CD
     , (SUBSTR(C.FLET_CTRT_NO,1,4) || SUBSTR(C.FLET_CTRT_NO,13,3) || MAX(LPAD(C.INV_SEQ,3,'0')) || MIN(LPAD(C.INV_DTL_SEQ,2,'0'))) TO_INV_NO
     , TO_CHAR(C.EFF_DT,'YYYYMMDD') EFF_DT
     , TO_CHAR(C.EXP_DT,'YYYYMMDD') EXP_DT
     , C.INV_SEQ
     , C.FLET_CTRT_NO
     , C.FLET_ISS_TP_CD
     , MIN(C.INV_DTL_SEQ) AS INV_DTL_SEQ
     , DENSE_RANK() OVER(ORDER BY B.PPAY_HIR_NO||SUBSTR(C.INV_DESC,1, INSTR(C.INV_DESC,'(')) || TO_CHAR(B.EFF_DT,'YYYY-MM-DD HH24:MI') ||'~'|| TO_CHAR(B.EXP_DT,'YYYY-MM-DD HH24:MI') ||')') AS GRP_NO
     , SUBSTR(C.INV_DESC,1, INSTR(C.INV_DESC,'(')) || TO_CHAR(B.EFF_DT,'YYYY-MM-DD HH24:MI') ||'~'|| TO_CHAR(B.EXP_DT,'YYYY-MM-DD HH24:MI') ||')' AS ORI_INV_DESC
  FROM FMS_CONTRACT A
     , FMS_INVOICE B
     , FMS_INV_DTL C
     , FMS_ACCT_ITM D
 WHERE 1=1
   AND A.FLET_CTRT_NO = @[flet_ctrt_no]
   AND A.FLET_CTRT_NO = B.FLET_CTRT_NO
   AND B.FLET_CTRT_NO = C.FLET_CTRT_NO
   AND B.FLET_ISS_TP_CD = C.FLET_ISS_TP_CD
   AND B.INV_SEQ = C.INV_SEQ
   AND C.SLP_TP_CD IS NULL
   AND C.CURR_CD = @[curr_cd]
   AND C.ACCT_CD = D.ACCT_CD
   AND C.ACCT_ITM_SEQ = D.ACCT_ITM_SEQ
   AND B.FLET_ISS_TP_CD = 'PRE' /*2015.10.13 ACCOUNT 에서 등록된 부분을 빼기 위해 조건 추가.*/
   AND NOT EXISTS ( SELECT 'X'
                      FROM FMS_ACCT_ITM AI
                         , FMS_ACCT_CATE AC
                     WHERE AI.ACCT_CD = AC.ACCT_CD
                       AND AI.ACCT_ITM_SEQ = AC.ACCT_ITM_SEQ
                       AND AC.FLET_ACCT_CATE_CD = 'BR' /*Brokerage*/
                       AND AI.ACCT_CD = C.ACCT_CD
                       AND ROWNUM = 1 )
 GROUP BY NVL(C.TO_YRMON,SUBSTR(C.CHTR_INV_DT, 1, 6))
     , B.PPAY_HIR_NO
     , D.ACCT_ITM_NM
     , C.ACCT_CD
     , C.ACCT_ITM_SEQ
     , A.CUST_CNT_CD
     , A.CUST_SEQ
     , C.CURR_CD
     , C.INV_DESC
     , C.EFF_DT
     , C.EXP_DT
     , C.INV_SEQ
     , C.FLET_CTRT_NO
     , C.FLET_ISS_TP_CD
     , B.EFF_DT
     , B.EXP_DT
 ORDER BY B.PPAY_HIR_NO
     , SUBSTR(C.INV_DESC, INSTR(REPLACE(C.INV_DESC, '-', '/'), '/', 1, 1) - 4, 4)|| SUBSTR(C.INV_DESC, INSTR(REPLACE(C.INV_DESC, '-', '/'), '/', 1, 1) + 1, 2)|| SUBSTR(C.INV_DESC, INSTR(REPLACE(C.INV_DESC, '-', '/'), '/', 1, 2) + 1, 2)
     , C.ACCT_CD			]]></sql>
			<params>
				<param name="slp_ofc_cd" type="12" value="" out="N"/>
				<param name="flet_ctrt_no" type="12" value="" out="N"/>
				<param name="curr_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
