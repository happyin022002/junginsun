<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="RocsManifestListDownloadDBDAOsearchInboundBlListRSQL">
			<desc><![CDATA[ROCS system내에 I/B B/L File Form으로 출력할 대상 B/L List를 조회한다.]]></desc>
			<sql><![CDATA[
SELECT VVD_NM, VVD_NUMBER, FRM_CRN_NUMBER, MAX(CNTR_TPSZ_DESC) CNTR_TPSZ_DESC,
	SUBSTR(MAX(CNTR_NO_CD),0,11) CNTR_NO, SUBSTR(MAX(CNTR_NO_CD),12) CNTR_TPSZ_CD,
	MAX(CNTR_NO_CD) CNTR_NO_CD,
    MAX(PCK_DESC) PCK_DESC, CNTR_WGT_UT_CD, BL_NO||BL_TP_CD BL_NO, POL_CD, POD_CD,
    NTFY_ADDR, BKG_TTL_QTY, BKG_TTL_QTY_UT_CD, BKG_NO, MAX(CNTR_MF_DESC) CNTR_MF_DESC,
    IB_FILE_SEQ, MAX_BRB_IF_SEQ, DEM_FREE_DT, RCV_TERM_CD,DE_TERM_CD, PCK_QTY
FROM
(SELECT VVD_NM, VVD_NUMBER, FRM_CRN_NUMBER, CNTR_TPSZ_DESC, CNTR_NO||CNTR_TPSZ_CD CNTR_NO_CD,
    PCK_DESC, CNTR_WGT_UT_CD, BL_NO, BL_TP_CD, POL_CD, POD_CD,
    NTFY_ADDR, BKG_TTL_QTY, BKG_TTL_QTY_UT_CD, BKG_NO, CNTR_MF_DESC,
    IB_FILE_SEQ, MAX_BRB_IF_SEQ, DEM_FREE_DT, RCV_TERM_CD, DE_TERM_CD,
    COUNT(DISTINCT CNTR_NO) OVER(PARTITION BY BL_NO) PCK_QTY
FROM
(SELECT	A.VVD_NM,
	A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD VVD_NUMBER,
	A.VSL_CALL_REF_NO FRM_CRN_NUMBER,
	C.CNTR_NO,
	C.CNTR_TPSZ_DESC,
	C.CNTR_TPSZ_CD,
	C.PCK_DESC,
	C.CNTR_WGT_UT_CD,
	B.BL_NO,
	B.BL_TP_CD,
	B.POL_CD,
	B.POD_CD,
	TRANSLATE(SUBSTR(B.NTFY_ADDR,1,INSTR(B.NTFY_ADDR,'@@')-1), CHR(13)||CHR(10), ' ') NTFY_ADDR,
	B.BKG_TTL_QTY,
	B.BKG_TTL_QTY_UT_CD,
	B.BKG_NO,
	D.CNTR_MF_DESC,
	NVL(B.IB_FILE_SEQ, 0) IB_FILE_SEQ,
	F.MAX_BRB_IF_SEQ,
	TO_CHAR(A.DEM_FREE_DT, 'YYYYMMDD' ) DEM_FREE_DT,
	NVL(BKG.RCV_TERM_CD,' ') RCV_TERM_CD,
	NVL(BKG.DE_TERM_CD,' ') DE_TERM_CD
  FROM	BKG_CSTMS_RTM_VSL A,
	BKG_CSTMS_RTM_BL B,
	BKG_CONTAINER BKG,
	BKG_CSTMS_RTM_CNTR C,
	BKG_CSTMS_RTM_CGO_MF D,
	BKG_BL_MK_DESC E,
	( SELECT VSL_CALL_REF_NO,
		MAX ( NVL ( IB_FILE_SEQ, 0 ) ) MAX_BRB_IF_SEQ
		 FROM BKG_CSTMS_RTM_BL
		GROUP BY VSL_CALL_REF_NO
	) F
 WHERE	  A.VSL_CALL_REF_NO       = B.VSL_CALL_REF_NO
	AND   A.VSL_CALL_REF_NO       = C.VSL_CALL_REF_NO
	AND   B.VSL_CALL_REF_NO       = F.VSL_CALL_REF_NO
	AND   B.BKG_NO      = C.BKG_NO
	AND   C.BKG_NO      = BKG.BKG_NO
	AND   C.CNTR_NO 	= BKG.CNTR_NO
	AND   A.VSL_CALL_REF_NO       = D.VSL_CALL_REF_NO
	AND   C.BKG_NO      = D.BKG_NO
	AND   C.CNTR_NO		= D.CNTR_NO
	AND   D.CNTR_MF_SEQ = 1
	AND   C.BKG_NO      = E.BKG_NO
	AND	  E.MK_SEQ = 1
    AND   A.VSL_CD = B.VSL_CD
    AND   A.SKD_VOY_NO = B.SKD_VOY_NO
    AND   A.SKD_DIR_CD = B.SKD_DIR_CD
#if (${frm_crn_number}!= '') 	
    AND	  A.VSL_CALL_REF_NO		=	@[frm_crn_number]  
#end
#if (${vsl_cd}!= '') 
    AND   A.VSL_CD        = @[vsl_cd]              
#end
#if (${skd_voy_no}!= '') 
    AND   A.SKD_VOY_no    = @[skd_voy_no]
#end
#if (${skd_dir_cd}!= '') 
    AND   A.SKD_DIR_CD    = @[skd_dir_cd]
#end
#if (${pol_cd}!= '') 
	AND   B.POL_CD = @[pol_cd]
#end
	GROUP BY VVD_NM,
	A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD,
	A.VSL_CALL_REF_NO ,
	C.CNTR_NO,
	C.CNTR_TPSZ_DESC,
	C.CNTR_TPSZ_CD,
	C.PCK_DESC,
	C.CNTR_WGT_UT_CD,
	B.BL_NO,
	B.BL_TP_CD,
	B.POL_CD,
	B.POD_CD,
	TRANSLATE(SUBSTR(B.NTFY_ADDR,1,INSTR(B.NTFY_ADDR,'@@')-1), CHR(13)||CHR(10), ' '),
	B.BKG_TTL_QTY,
	B.BKG_TTL_QTY_UT_CD,
	B.BKG_NO,
	D.CNTR_MF_DESC,
	NVL(B.IB_FILE_SEQ, 0),
	F.MAX_BRB_IF_SEQ,
	TO_CHAR(A.DEM_FREE_DT, 'YYYYMMDD' ) ,
	NVL(BKG.RCV_TERM_CD,' '),
	NVL(BKG.DE_TERM_CD,' ')
    ORDER BY C.CNTR_NO))
    GROUP BY  VVD_NM, VVD_NUMBER, FRM_CRN_NUMBER,
     CNTR_WGT_UT_CD, BL_NO, BL_TP_CD, POL_CD, POD_CD,
     NTFY_ADDR, BKG_TTL_QTY, BKG_TTL_QTY_UT_CD, BKG_NO, 
     IB_FILE_SEQ, MAX_BRB_IF_SEQ, DEM_FREE_DT, RCV_TERM_CD, DE_TERM_CD, PCK_QTY
	ORDER BY IB_FILE_SEQ			]]></sql>
			<params>
				<param name="frm_crn_number" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
