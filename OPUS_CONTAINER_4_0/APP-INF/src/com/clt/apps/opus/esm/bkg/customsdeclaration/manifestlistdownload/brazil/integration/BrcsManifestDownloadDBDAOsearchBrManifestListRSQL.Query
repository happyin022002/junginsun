<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BrcsManifestDownloadDBDAOsearchBrManifestListRSQL">
			<desc><![CDATA[Brazil세관에서 대상 조회를 한다.
searchBrManifestList]]></desc>
			<sql><![CDATA[
SELECT  MAIN.BL_NO                                                       AS BL_NO
      , SUM(MAIN.C_BL_NO) OVER (ORDER BY BL_NO)                          AS BL_GROUP
      , MAIN.BKG_NO                                                      AS BKG_NO
      , MAIN.BKG_CGO_TP_CD                                               AS SEARCH_BKG_CGO_TP_CD
      , MAIN.CUST_TO_ORD_FLG                                             AS CUST_TO_ORD_FLG
      , MAIN.SHIPPER_CUST_NM                                             AS SHIPPER_CUST_NM
      , MAIN.OB_SHPR_TAX_NO                                              AS OB_SHPR_TAX_NO
      , MAIN.SHPR_TAX_NO                                                 AS SHPR_TAX_NO
      , MAIN.CONSIGNEE_CUST_NM                                           AS CONSIGNEE_CUST_NM
      , MAIN.OB_CNEE_TAX_NO                                              AS OB_CNEE_TAX_NO
      , MAIN.CNEE_TAX_NO                                                 AS CNEE_TAX_NO
      , MAIN.NOTIFY_CUST_NM                                              AS NOTIFY_CUST_NM
      , MAIN.OB_NTFY_TAX_NO                                              AS OB_NTFY_TAX_NO
      , MAIN.NTFY_TAX_NO                                                 AS NTFY_TAX_NO
      , MAIN.BRZ_DECL_NO                                                 AS BRZ_DECL_NO
      , MAIN.IF_FLAG                                                     AS IF_FLAG
      , MAIN.CNTR_NO                                                     AS CNTR_NO
      , MAIN.PCK_QTY                                                     AS PCK_QTY
      , MAIN.PCK_TP_CD                                                   AS PCK_TP_CD
      , MAIN.WEIGHT                                                      AS WEIGHT
      , MAIN.WGT_UT_CD                                                   AS WGT_UT_CD
      , MAIN.MEASURE                                                     AS MEASURE
      , MAIN.MEAS_UT_CD                                                  AS MEAS_UT_CD
      , MAIN.NCM_NO                                                      AS NCM_NO
      , MAIN.NCM_MULTI_NO                                                AS NCM_MULTI_NO
      , MAIN.CSTMS_DESC                                                  AS CSTMS_DESC
      , MAIN.BOOKING_CMDT_NM                                             AS BOOKING_CMDT_NM
      , MAIN.CNTR_MF_SEQ                                                 AS CNTR_MF_SEQ
      , MAIN.VVD_CD                                                      AS VVD_CD
      , MAIN.POL_CD                                                      AS POL_CD
      , MAIN.POD_CD                                                      AS POD_CD
      , MAIN.DEL_CD                                                      AS DEL_CD
      , MAIN.OFT                                                         AS OFT
      , CASE WHEN @[io_type] = 'O' THEN MAIN.OTH
                                   ELSE MAIN.DTH
         END                                                             AS CAP
      , NVL(MAIN.BRZ_CSTMS_DUV_NM, ' ')                                  AS BR_DUV
      , NVL(MAIN.BRZ_CSTMS_MF_ID, ' ')                                   AS BR_MID
      , DECODE(MAIN.IF_FLAG, 'Y', '1', '0')                              AS NCM_MULTI_POP
      , DECODE(NVL(INSTR(MAIN.NCM_MULTI_NO, ',', 1), 0), 0, 'N', 'Y')    AS NCM_MULTI_FLG
      -- Data Delete 버튼이 보이게 하는 여부
	   ,NVL((SELECT 'Y'  
             FROM BKG_CSTMS_CD_CONV_CTNT
	         WHERE CNT_CD = 'US'
             AND CSTMS_DIV_ID = 'NA_STAFF'
             AND DELT_FLG = 'N'
             AND ATTR_CTNT1 = @[upd_usr_id]
             AND ROWNUM = 1), 'N') AS NA_STF_FLG
  FROM  (SELECT  B.BL_NO
               , DECODE(LAG(B.BL_NO) OVER ( ORDER BY B.BL_NO, B.CNTR_NO, B.CNTR_MF_SEQ) , B.BL_NO, 0, 1) AS C_BL_NO
               , B.BKG_NO
               , B.BKG_CGO_TP_CD
               , B.CUST_TO_ORD_FLG
               , (SELECT  REPLACE(CUST_NM, CHR(13)||CHR(10), ' ')
                    FROM  BKG_CUSTOMER
                   WHERE  BKG_NO = B.BKG_NO
                     AND  BKG_CUST_TP_CD = 'S'
                 )                                                       AS SHIPPER_CUST_NM
               , B.SHPR_TAX_NO                                           AS OB_SHPR_TAX_NO
               , DECODE(BL.BL_NO, NULL, B.SHPR_TAX_NO, BL.SHPR_TAX_NO)   AS SHPR_TAX_NO
               , (SELECT  REPLACE(CUST_NM, CHR(13)||CHR(10), ' ')
                    FROM  BKG_CUSTOMER
                   WHERE  BKG_NO = B.BKG_NO
                     AND  BKG_CUST_TP_CD = 'C'
                 )                                                       AS CONSIGNEE_CUST_NM
               , B.CNEE_TAX_NO                                           AS OB_CNEE_TAX_NO
               , DECODE(BL.BL_NO, NULL, B.CNEE_TAX_NO, BL.CNEE_TAX_NO)   AS CNEE_TAX_NO
               , (SELECT  REPLACE(CUST_NM, CHR(13)||CHR(10), ' ')
                    FROM  BKG_CUSTOMER
                   WHERE  BKG_NO = B.BKG_NO
                     AND  BKG_CUST_TP_CD = 'N'
                 )                                                       AS NOTIFY_CUST_NM
               , B.NTFY_TAX_NO                                           AS OB_NTFY_TAX_NO
               , DECODE(BL.BL_NO, NULL, B.NTFY_TAX_NO, BL.NTFY_TAX_NO)   AS NTFY_TAX_NO
               , DECODE(BL.BL_NO, NULL, B.BRZ_DECL_NO, BL.BRZ_DECL_NO)   AS BRZ_DECL_NO
               , DECODE(BL.BL_NO, NULL, 'N', 'Y')                        AS IF_FLAG
               , B.CNTR_NO
               , B.PCK_QTY
               , B.PCK_TP_CD
               , B.CNTR_MF_WGT AS WEIGHT
               , B.WGT_UT_CD
               , B.MEAS_QTY    AS MEASURE
               , B.MEAS_UT_CD
               , DECODE(BL.BL_NO, NULL, B.NCM_NO, BC.BRZ_CMDT_CD)        AS NCM_NO
               , BKG_JOIN_FNC(CURSOR(SELECT BRZ_CMDT_CD
                                       FROM BKG_CSTMS_BRZ_CNTR_MF_DTL
                                      WHERE BL_NO       = B.BL_NO
                                        AND CNTR_NO     = B.CNTR_NO
                                        AND CNTR_MF_SEQ = B.CNTR_MF_SEQ
                                     )
                              )                                          AS NCM_MULTI_NO
               ,(SELECT Z.CMDT_DESC
                   FROM BKG_CSTMS_CMDT Z
                  WHERE Z.CNT_CD = 'BR'
                    AND Z.MF_CMDT_CD = DECODE(BL.BL_NO, NULL, B.NCM_NO, BC.BRZ_CMDT_CD)
                )                                                        AS CSTMS_DESC
               , (SELECT  CMDT_NM
                    FROM  MDM_COMMODITY
                   WHERE  CMDT_CD = B.CMDT_CD
                 ) BOOKING_CMDT_NM
               , B.CNTR_MF_SEQ
               , NVL((SELECT  'Y'
                        FROM  BKG_CHG_RT
                       WHERE  BKG_NO = B.BKG_NO
                         AND  CHG_CD = 'OFT'
                         AND  ROWNUM = 1
                     ),'N') AS OFT
               , NVL((SELECT  'Y'
                        FROM  BKG_CHG_RT
                       WHERE  BKG_NO = B.BKG_NO
                         AND  CHG_CD = 'OTH'
                         AND  ROWNUM = 1
                      ),'N') AS OTH
               , NVL((SELECT  'Y'
                        FROM  BKG_CHG_RT
                       WHERE  BKG_NO = B.BKG_NO
                         AND  CHG_CD = 'DTH'
                         AND  ROWNUM = 1
                      ),'N') DTH
               , BL.BRZ_CSTMS_DUV_NM
               , BL.BRZ_CSTMS_MF_ID
               , B.VVD_CD
               , B.POL_CD
               , B.POD_CD
               , B.DEL_CD
           FROM  (SELECT  B.BKG_CGO_TP_CD
                        , B.BKG_NO
                        , B.BL_NO,B.CMDT_CD
                        , D.CNTR_MF_SEQ
                        , C.CNTR_NO
                        , B.CUST_TO_ORD_FLG
                        , MAX(D.PCK_QTY) PCK_QTY
                        , MAX(NVL(D.PCK_TP_CD, C.PCK_TP_CD) ) PCK_TP_CD
                        , MAX(D.CNTR_MF_WGT) CNTR_MF_WGT
                        , MAX(NVL(D.WGT_UT_CD, C.WGT_UT_CD) ) WGT_UT_CD
                        , MAX(D.MEAS_QTY) MEAS_QTY
                        , MAX(NVL(D.MEAS_UT_CD, C.MEAS_UT_CD) ) MEAS_UT_CD
                        , MAX(D.NCM_NO) NCM_NO
                        , MAX(V.VSL_CD||V.SKD_VOY_NO||V.SKD_dIR_cD) VVD_CD
                        , MAX(V.POL_CD) POL_CD
                        , MAX(V.POD_CD) POD_CD
                        , MAX(B.DEL_CD) DEL_CD
                        , MAX(A.XPT_IMP_SEQ) XPT_IMP_SEQ
                        , MAX(A.SHPR_TAX_NO) SHPR_TAX_NO
                        , MAX(A.CNEE_TAX_NO) CNEE_TAX_NO
                        , MAX(A.NTFY_TAX_NO) NTFY_TAX_NO
                        , MAX(A.BRZ_DECL_NO) BRZ_DECL_NO
                        , MAX(A.BRZ_CMDT_CD) BRZ_CMDT_CD
                    FROM  BKG_BOOKING       B
                        , BKG_VVD           V
                        , BKG_CONTAINER     C
                        , BKG_CNTR_MF_DESC  D
                        , BKG_XPT_IMP_LIC   A
                   WHERE  1 = 1
                     AND  B.BKG_NO  = V.BKG_NO
                     AND  B.BKG_NO  = C.BKG_NO(+)
                     AND  C.BKG_NO  = D.BKG_NO(+)
                     AND  C.CNTR_NO = D.CNTR_NO(+)
                     AND  B.BKG_NO  = A.BKG_NO(+)
                     AND  A.IO_BND_CD(+) = @[io_type]
                     AND  (B.BKG_STS_CD IN ('F','W')
                           OR (B.BKG_STS_CD = 'S' AND B.SPLIT_RSN_CD ='M')
                          )
#if (${vvd_cd} != '')
                     AND  V.VSL_CD     = SUBSTR (@[vvd_cd], 1, 4)
                     AND  V.SKD_VOY_NO = SUBSTR (@[vvd_cd], 5, 4)
                     AND  V.SKD_DIR_CD = SUBSTR (@[vvd_cd], 9, 1)
#end
#if (${pol_cd} != '')
                     AND  V.POL_CD        = @[pol_cd]
#end
#if (${pod_cd} != '')
                     AND  V.POD_CD        = @[pod_cd]
#end
#if (${bl_no} != '')
                     AND  B.BL_NO         = @[bl_no]
                     AND  DECODE( @[io_type], 'O', SUBSTR(V.POL_CD,1,2), SUBSTR(V.POD_CD,1,2) )  = 'BR'
#end
#if (${bkg_cgo_tp_cd} == 'F')
                     AND  B.BKG_CGO_TP_CD IN ('F', 'R')
#elseif (${bkg_cgo_tp_cd} == 'P')
                     AND  B.BKG_CGO_TP_CD IN ('P')
#end
#if (${del_cd} != '')
                     AND  B.DEL_CD        = @[del_cd]
#end
                GROUP BY  B.BKG_CGO_TP_CD
                        , B.BKG_NO
                        , B.BL_NO,B.CMDT_CD
                        , B.CUST_TO_ORD_FLG
                        , D.CNTR_MF_SEQ
                        , C.CNTR_NO
                 ) B
                 , BKG_CSTMS_BRZ_BL          BL
                 , BKG_CSTMS_BRZ_CNTR_MF_DTL BC
            WHERE  1 = 1
              AND  B.BL_NO             = BL.BL_NO(+)
              AND  B.BL_NO             = BC.BL_NO(+)
              AND  B.CNTR_NO           = BC.CNTR_NO(+)
              AND  B.CNTR_MF_SEQ       = BC.CNTR_MF_SEQ(+)
              AND  BC.MF_DTL_SEQ(+)    = 1
#if (${br_duv} != '')
              AND  UPPER(BL.BRZ_CSTMS_DUV_NM) = @[br_duv]
#end

#if (${br_mid} != '')
              AND  UPPER(BL.BRZ_CSTMS_MF_ID)  = @[br_mid]
#end
         ORDER BY  BL_NO
                 , CNTR_NO
                 , B.CNTR_MF_SEQ
      ) MAIN
 WHERE  1 = 1
#if (${cnpj_no} != '')
   AND  UPPER(CNEE_TAX_NO) = @[cnpj_no]
#end
#if (${error_type} == '2')
  #if (${io_type} == 'O')
  AND  (   NVL(CNEE_TAX_NO, ' ') = ' '
        OR NVL(BRZ_DECL_NO, ' ') = ' '
        OR NVL(PCK_QTY, 0) = 0
        OR NVL(PCK_TP_CD, ' ') = ' '
        OR NVL(WEIGHT, 0) = 0
        OR NVL(MEASURE, 0) = 0
        OR NVL(NCM_NO, ' ') = ' '
)
  #end
  #if (${io_type} == 'I')
  AND  (   NVL(SHPR_TAX_NO, ' ') = ' '
        OR NVL(PCK_QTY, 0) = 0
        OR NVL(PCK_TP_CD, ' ') = ' '
        OR NVL(WEIGHT, 0) = 0
        OR NVL(MEASURE, 0) = 0
        OR NVL(NCM_NO, ' ') = ' '
       )
  #end
#end			]]></sql>
			<params>
				<param name="io_type" type="12" value="" out="N"/>
				<param name="upd_usr_id" type="12" value="" out="N"/>
				<param name="vvd_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
				<param name="del_cd" type="12" value="" out="N"/>
				<param name="br_duv" type="12" value="" out="N"/>
				<param name="br_mid" type="12" value="" out="N"/>
				<param name="cnpj_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
