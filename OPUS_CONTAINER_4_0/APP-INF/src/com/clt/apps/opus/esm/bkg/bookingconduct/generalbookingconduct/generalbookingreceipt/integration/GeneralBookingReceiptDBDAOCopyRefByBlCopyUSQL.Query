<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="GeneralBookingReceiptDBDAOCopyRefByBlCopyUSQL">
			<desc><![CDATA[CopyRefByBlCopy]]></desc>
			<sql><![CDATA[
MERGE INTO BKG_REFERENCE REF
USING (
    SELECT
          BKG_NO
        , REF_SEQ
        , BKG_REF_TP_CD
        , CUST_REF_NO_CTNT
        , CNTR_NO
        , CNTR_MF_SEQ
        , CPY_DESC_FLG
        , NVL((SELECT MAX(REF_SEQ)
               FROM BKG_REFERENCE
               WHERE BKG_NO=@[copy_bkg_no]),0)+ROWNUM AS MAX_REF_SEQ
    FROM BKG_REFERENCE
    WHERE BKG_NO = @[bkg_no]
    AND BKG_REF_TP_CD IN ('FMCN','FFNO')
) T
ON (REF.BKG_NO = @[copy_bkg_no] AND REF.BKG_REF_TP_CD = T.BKG_REF_TP_CD)
WHEN MATCHED THEN
    UPDATE SET
          CUST_REF_NO_CTNT  = T.CUST_REF_NO_CTNT
        , CNTR_NO           = T.CNTR_NO
        , CNTR_MF_SEQ       = T.CNTR_MF_SEQ
        , CPY_DESC_FLG      = T.CPY_DESC_FLG
        , UPD_USR_ID        = @[usr_id]
        , UPD_DT            = SYSDATE
WHEN NOT MATCHED THEN
    INSERT (
          BKG_NO
        , REF_SEQ
        , BKG_REF_TP_CD
        , CUST_REF_NO_CTNT
        , CNTR_NO
        , CNTR_MF_SEQ
        , CPY_DESC_FLG
        , CRE_USR_ID
        , CRE_DT
        , UPD_USR_ID
        , UPD_DT
    ) VALUES (
          @[copy_bkg_no]
        , T.MAX_REF_SEQ
        , T.BKG_REF_TP_CD
        , T.CUST_REF_NO_CTNT
        , T.CNTR_NO
        , T.CNTR_MF_SEQ
        , T.CPY_DESC_FLG
        , @[usr_id]
        , SYSDATE
        , @[usr_id]
        , SYSDATE
    )			]]></sql>
			<params>
				<param name="copy_bkg_no" type="12" value="" out="N"/>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="usr_id" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
