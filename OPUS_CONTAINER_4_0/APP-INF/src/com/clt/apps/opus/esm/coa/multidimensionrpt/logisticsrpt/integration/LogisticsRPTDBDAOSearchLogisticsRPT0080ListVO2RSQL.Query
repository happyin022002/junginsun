<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="LogisticsRPTDBDAOSearchLogisticsRPT0080ListVO2RSQL">
			<desc><![CDATA[ESM_COA_0080화면에서  DETAIL에 대한 쿼리입니다.]]></desc>
			<sql><![CDATA[
SELECT   P_REPORT
		,TRD_CD   
		,RLANE_CD
		,DIR_CD
		,P_LOAD
		,COA_GET_CD_NM_FNC('CD01065', DECODE(COST_ACT_GRP_TP_CD, 'N', 'TM', 'TR')) LGS_KPI_COST_GRP_NM
	    ,COST_IO_BND_CD IN_OUT
	    ,COA_GET_CD_NM_FNC(DECODE( P_KPITYPE, '1','CD01064', 'CD00950'), KPI_CD) KPI_NM
		,SUM(VOL) VOL
		,SUM(TM_AMT+TR_AMT) TOTAL_COST
		,SUM(TM_AMT+TR_AMT)/DECODE(SUM(VOL), 0 , 1, SUM(VOL)) UNIT_COST
FROM (SELECT   C3.BKG_NO
			  ,C1.P_REPORT
			  ,C1.P_LOAD
			  ,C2.TRD_CD
			  ,DECODE(C1.P_REPORT, 'T', 'X', C2.RLANE_CD) RLANE_CD
			  ,DECODE(C1.P_REPORT, 'T', 'X', C2.DIR_CD) DIR_CD
			  ,C5.COST_ACT_GRP_TP_CD
			  ,CASE C5.COST_ACT_GRP_CD 
			        WHEN 'PRWD' THEN 'O' 
			        WHEN 'POWD' THEN 'I'
			        WHEN 'TRWD' THEN 'R' 
			   ELSE C5.COST_IO_BND_CD 
			   END AS COST_IO_BND_CD
			  ,C1.P_KPITYPE
			  ,DECODE(C1.P_KPITYPE,'1'
			           ,DECODE(C5.STTL_FLG, 'Y', 'ST', C5.LGS_KPI_MN_CD)
			           ,DECODE(C1.P_SHTL, 'Y', 'SHTL', C5.LGS_KPI_CD)) KPI_CD   /*Shuttle의 경우*/
              ,AVG(NVL(C5.BKG_QTY, 0)) AS VOL
              ,AVG(NVL(C5.VOID_20FT_QTY, 0) + NVL(C5.VOID_40FT_QTY, 0) * 2) AS VOID_VOL
              ,SUM(C5.FCNTR_STVG_TTL_AMT) AS TM_AMT 
			  ,SUM(C5.FCNTR_TRSP_TTL_AMT) AS TR_AMT
		FROM (SELECT   		 @[f_year] P_YEAR
				            ,@[s_cost_yrmon2] P_COST_MON
				            ,@[f_fm_mon] P_FM_MON
				            ,@[f_to_mon] P_TO_MON
				            ,@[f_sls_mon] P_SLS_MON
				            ,@[s_cost_wk2] P_COST_WK
				            ,@[f_fm_wk] P_FM_WK
				            ,@[f_to_wk] P_TO_WK
				            ,@[f_split_mw] P_SPLIT_MW
				            ,@[f_report] P_REPORT
				            ,NVL(@[s_trd_cd], @[f_trd_cd]) P_TRD_CD   
				            ,NVL(@[s_rlane_cd], @[f_rlane_cd]) P_RLANE_CD   
				            ,NVL(@[s_skd_dir_cd], @[f_skd_dir_cd]) P_SKD_DIR_CD 
				            ,@[f_kpi_type] P_KPITYPE
				            ,@[f_lgs_mn_kpi_cd] P_LGS_KPI_MN_CD
				            ,@[f_lgs_kpi_cd] P_LGS_KPI_CD
				            ,@[f_incld_mt] P_INCLD_MT				            
                    		,@[s_load] P_LOAD   
				            ,DECODE(@[f_lgs_mn_kpi_cd], 'ST', 'Y', 'N') P_MN_SHTL   /*맨앞이 세팅할넘 P_LGS_KPI_MN_CD*/
				            ,DECODE(@[f_lgs_kpi_cd], 'SHTL', 'Y', 'N') P_SHTL 		/*맨앞이 세팅할넘 P_LGS_KPI_CD*/
				FROM DUAL) C1
				          ,COA_MON_VVD C2
				          ,COA_RGST_BKG C3
				          ,COA_BKG_LGS_SMRY C5
				WHERE 1 = 1
		 			#if (${f_chkprd} == 'W')
		      		   #if (${s_cost_yrmon2} != '')
		            	  AND SLS_YRMON = C1.P_YEAR||C1.P_COST_MON 
		             	  AND COST_WK = C1.P_COST_WK		
		      		   #elseif (${s_cost_yrmon2} == '' && ${f_sls_mon} != '')	       
                   		  AND SLS_YRMON LIKE C1.P_YEAR||C1.P_SLS_MON			
  					      AND COST_WK BETWEEN C1.P_FM_WK AND C1.P_TO_WK	
  				       #else 
  					      AND SLS_YRMON LIKE C1.P_YEAR||'%'  				
  					      AND COST_WK BETWEEN C1.P_FM_WK AND C1.P_TO_WK	
  				       #end
  				    #elseif (${f_chkprd} == 'M')     	        	
		               #if (${s_cost_yrmon2} != '')
      				      AND COST_YRMON = C1.P_YEAR||C1.P_COST_MON  			
      				   #else
      				      AND COST_YRMON BETWEEN C1.P_YEAR||C1.P_FM_MON AND C1.P_YEAR||C1.P_TO_MON 
      				   #end				
			        #end
		            #if (${s_trd_cd} != '')
      				      AND C2.TRD_CD = C1.P_TRD_CD 
      		        #end
			        #if (${s_rlane_cd} != '' || ${f_rlane_cd} != '')
      		              AND C2.RLANE_CD = C1.P_RLANE_CD
      		        #end
			        #if (${s_skd_dir_cd} != '' || ${f_skd_dir_cd} != '')
      		              AND C2.DIR_CD = C1.P_SKD_DIR_CD 
      		        #end
		            #if (${f_lgs_kpi_cd} != '' && ${f_kpi_type} == '2')
	      	           #if (${f_lgs_kpi_cd} == 'SHTL')
      			          AND C5.STTL_FLG = 'Y'
                       #else
				          AND C5.LGS_KPI_CD = C1.P_LGS_KPI_CD
      				   #end   
      		        #end                 
			        #if (${f_lgs_mn_kpi_cd} != '' && ${f_kpi_type} == '1')
      		           #if (${f_lgs_mn_kpi_cd} == 'ST')
		      		      AND C5.STTL_FLG = 'Y'
        			   #else
			              AND C5.LGS_KPI_MN_CD = C1.P_LGS_KPI_MN_CD
      				   #end   
      		        #end
		            #if (${f_incld_mt} == '')
			              AND C5.COST_ACT_GRP_CD  NOT IN ('NIBC','NOBC')			
      		        #end
      		
                          AND C3.BKG_STS_CD IN('F', 'S')
      				      AND C3.BL_NO_TP IN('M', '0')
      				      AND C2.DELT_FLG NOT IN('Y')
      				      AND C3.BKG_CGO_TP_CD NOT IN('P')
      				      AND C2.VSL_CD = C3.VSL_CD
      				      AND C2.SKD_VOY_NO = C3.SKD_VOY_NO
      				      AND C2.DIR_CD = C3.DIR_CD
      				      AND C2.TRD_CD = C3.TRD_CD
      				      AND C2.RLANE_CD = C3.RLANE_CD
      				      AND C2.IOC_CD = C3.IOC_CD
      				      AND C3.BKG_NO = C5.BKG_NO
			 GROUP BY C3.BKG_NO
 		             ,C1.P_REPORT
				     ,C1.P_LOAD
		             ,C2.TRD_CD
				     ,DECODE(C1.P_REPORT, 'T', 'X', C2.RLANE_CD)
				     ,DECODE(C1.P_REPORT, 'T', 'X', C2.DIR_CD)
				     ,C5.COST_ACT_GRP_TP_CD
				     ,CASE C5.COST_ACT_GRP_CD 
				             WHEN 'PRWD' THEN 'O' 
				             WHEN 'POWD' THEN 'I'
				             WHEN 'TRWD' THEN 'R' 
				             ELSE C5.COST_IO_BND_CD 
				       END
				     ,C1.P_KPITYPE
				     ,DECODE(C1.P_KPITYPE,'1' 
				     			,DECODE(C5.STTL_FLG, 'Y', 'ST', C5.LGS_KPI_MN_CD)
				    			,DECODE(C1.P_SHTL, 'Y', 'SHTL', C5.LGS_KPI_CD)
			          )
      )
GROUP BY P_REPORT
		,P_LOAD
		,TRD_CD
		,RLANE_CD
		,DIR_CD
		,COA_GET_CD_NM_FNC('CD01065', DECODE(COST_ACT_GRP_TP_CD, 'N', 'TM', 'TR'))
		,COST_IO_BND_CD
		,COA_GET_CD_NM_FNC(DECODE( P_KPITYPE, '1','CD01064', 'CD00950'), KPI_CD) 
ORDER BY TRD_CD
        ,RLANE_CD
        ,DIR_CD
		,COA_GET_CD_NM_FNC('CD01065', DECODE(COST_ACT_GRP_TP_CD, 'N', 'TM', 'TR'))
		,COST_IO_BND_CD			]]></sql>
			<params>
				<param name="f_year" type="12" value="" out="N"/>
				<param name="s_cost_yrmon2" type="12" value="" out="N"/>
				<param name="f_fm_mon" type="12" value="" out="N"/>
				<param name="f_to_mon" type="12" value="" out="N"/>
				<param name="f_sls_mon" type="12" value="" out="N"/>
				<param name="s_cost_wk2" type="12" value="" out="N"/>
				<param name="f_fm_wk" type="12" value="" out="N"/>
				<param name="f_to_wk" type="12" value="" out="N"/>
				<param name="f_split_mw" type="12" value="" out="N"/>
				<param name="f_report" type="12" value="" out="N"/>
				<param name="s_trd_cd" type="12" value="" out="N"/>
				<param name="f_trd_cd" type="12" value="" out="N"/>
				<param name="s_rlane_cd" type="12" value="" out="N"/>
				<param name="f_rlane_cd" type="12" value="" out="N"/>
				<param name="s_skd_dir_cd" type="12" value="" out="N"/>
				<param name="f_skd_dir_cd" type="12" value="" out="N"/>
				<param name="f_kpi_type" type="12" value="" out="N"/>
				<param name="f_lgs_mn_kpi_cd" type="12" value="" out="N"/>
				<param name="f_lgs_kpi_cd" type="12" value="" out="N"/>
				<param name="f_incld_mt" type="12" value="" out="N"/>
				<param name="s_load" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
