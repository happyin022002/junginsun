<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="EurCustomsTransmissionDBDAOsearchBlLdfBatchRSQL">
			<desc><![CDATA[SitPro 에서 BL LDF 다운로드 후 BL정보가 수정되면 대상 BL을 조회해서 LDF 파일을 재다운로드한다.
대상 BL을 조회하는 쿼리임 (현재는 베트남의 경우만 적용함)]]></desc>
			<sql><![CDATA[
SELECT TB.*
      ,ROW_NUMBER() OVER(PARTITION BY VVD_CD, DECODE(BND_CD, 'I', POD_CD, POL_CD) ORDER BY VVD_CD, DECODE(BND_CD, 'I', POD_CD, POL_CD), BKG_NO) AS pagerows
  FROM (
SELECT VVD.*
      ,BKG.VSL_CD || BKG.SKD_VOY_NO || BKG.SKD_DIR_CD AS TVVD_CD
      ,BKG.POL_CD AS B_POL_CD
      ,BKG.POD_CD AS B_POD_CD
      ,NVL(MAX(LDF.BL_LDF_DL_DT), MAX(HIS.CRE_DT)-1) AS LDF_DT
      ,MAX(HIS.CRE_DT)       AS HIS_DT
  FROM (SELECT A.BKG_NO
              ,A.VVD_CD
              ,A.POL_CD
              ,A.POD_CD
              ,A.BND_CD
          FROM (
                SELECT VVD.BKG_NO
                      ,VVD.VSL_CD || VVD.SKD_VOY_NO || VVD.SKD_DIR_CD AS VVD_CD
                      ,VVD.POL_CD
                      ,'' AS POD_CD
                      ,'0' AS BND_CD
                  FROM VSK_VSL_PORT_SKD SKD
                      ,BKG_VVD          VVD
                 WHERE 1=1
                   AND SKD.VPS_PORT_CD = VVD.POL_CD
                   AND SKD.VSL_CD      = VVD.VSL_CD
                   AND SKD.SKD_VOY_NO  = VVD.SKD_VOY_NO
                   AND SKD.SKD_DIR_CD  = VVD.SKD_DIR_CD
                   AND SKD.VPS_PORT_CD LIKE 'VN%'
                   AND SKD.VPS_ETA_DT > SYSDATE - 100
                UNION ALL
                SELECT VVD.BKG_NO
                      ,VVD.VSL_CD || VVD.SKD_VOY_NO || VVD.SKD_DIR_CD AS VVD_CD
                      ,'' AS POL_CD
                      ,VVD.POD_CD AS POD_CD
                      ,'I' AS BND_CD
                  FROM VSK_VSL_PORT_SKD SKD
                      ,BKG_VVD          VVD
                 WHERE 1=1
                   AND SKD.VPS_PORT_CD = VVD.POD_CD
                   AND SKD.VSL_CD      = VVD.VSL_CD
                   AND SKD.SKD_VOY_NO  = VVD.SKD_VOY_NO
                   AND SKD.SKD_DIR_CD  = VVD.SKD_DIR_CD
                   AND SKD.VPS_PORT_CD LIKE 'VN%'
                   AND SKD.VPS_ETA_DT > SYSDATE - 100
               ) A
       ) VVD
       ,BKG_BOOKING               BKG
       ,BKG_HIS_MST               HIS
       ,BKG_CSTMS_BL_LOD_FCTR_LOG LDF
 WHERE 1=1
   AND VVD.BKG_NO = BKG.BKG_NO
   AND VVD.BKG_NO = HIS.BKG_NO
   AND VVD.BKG_NO = LDF.BKG_NO(+)
   AND HIS.CRE_DT > SYSDATE - 1
   GROUP BY VVD.BKG_NO
           ,VVD.VVD_CD
           ,VVD.POL_CD
           ,VVD.POD_CD
           ,VVD.BND_CD
           ,BKG.VSL_CD || BKG.SKD_VOY_NO || BKG.SKD_DIR_CD 
           ,BKG.POL_CD 
           ,BKG.POD_CD 
      ) TB
 WHERE TB.HIS_DT > TB.LDF_DT			]]></sql>
			<params>
			</params>
		</query>
	</querys>
</sqls>
