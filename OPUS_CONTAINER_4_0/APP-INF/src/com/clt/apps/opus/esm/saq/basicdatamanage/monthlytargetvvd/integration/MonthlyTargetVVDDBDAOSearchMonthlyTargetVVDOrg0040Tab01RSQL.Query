<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="MonthlyTargetVVDDBDAOSearchMonthlyTargetVVDOrg0040Tab01RSQL">
			<desc><![CDATA[   ]]></desc>
			<sql><![CDATA[
WITH GRP_MAX AS (
    SELECT  TRD_CD,RLANE_CD,DIR_CD,
            MAX(SPRT_GRP_CD) MAX_GRP_CD,
            SUBSTR(MAX(SPRT_GRP_CD),0,1) MAX_SPRT_GRP_CD,
            SUBSTR(MAX(SPRT_GRP_CD),2,2) MAX_BSA_GRP_CD            
    FROM 
    (
    SELECT 
           TRD_CD, RLANE_CD, DIR_CD, 
           'A'||(V.BSA_GRP_CD)  SPRT_GRP_CD
    FROM SAQ_MON_TGT_BSA_GRP V
    WHERE V.BSE_YR = @[year] 
#if (${trade} != '')     
      AND V.TRD_CD = @[trade]  
#end
#if (${bound} != '')       
	  AND V.DIR_CD = @[bound]
#end	  
    UNION ALL
    SELECT 
           TRD_CD, RLANE_CD, DIR_CD, 
           (SPRT_GRP_CD||BSA_GRP_CD) SPRT_GRP_CD
    FROM   SAQ_MON_TGT_VVD M
    WHERE  M.BSE_YR = @[year]
    AND    M.BSE_QTR_CD = @[quarter]
#if (${trade} != '')     
    AND M.TRD_CD = @[trade]  
#end
#if (${bound} != '')     
    AND M.DIR_CD = @[bound] 
#end    
    )  A
--    WHERE 1=1
--        AND rlane_cd IN ( 'AUPAE', 'CMXAE' , 'IMUAE')
    GROUP BY   --FLAG, 
               TRD_CD, RLANE_CD, DIR_CD
)       
,
GRP_CAPA AS (
    SELECT  
            TRD_CD,RLANE_CD,DIR_CD,
            NVL(MAX(T_SPRT_GRP_CD) , MAX(G_SPRT_GRP_CD) ) SPRT_GRP_CD,
            NVL(MAX(T_BSA_GRP_CD) , MAX(G_BSA_GRP_CD) )  BSA_GRP_CD,            

            MAX(MAX(MAX_SPRT_GRP_CD)) OVER(PARTITION BY  TRD_CD, RLANE_CD,  DIR_CD) MAX_SPRT_GRP_CD,
            FNL_BSA_CAPA
    FROM 
    (
    SELECT 'BSA_GROUP' FLAG,
           TRD_CD, RLANE_CD, DIR_CD, 
           'A'  G_SPRT_GRP_CD,
           (V.BSA_GRP_CD) G_BSA_GRP_CD,
           NULL  T_SPRT_GRP_CD,
           NULL  T_BSA_GRP_CD,
           'A'||(V.BSA_GRP_CD)  MAX_SPRT_GRP_CD,
           FNL_BSA_CAPA
    FROM SAQ_MON_TGT_BSA_GRP V
    WHERE V.BSE_YR = @[year] 
#if (${trade} != '')     
      AND V.TRD_CD = @[trade]  
#end
#if (${bound} != '')       
	  AND V.DIR_CD = @[bound]
#end	  
    UNION ALL
    SELECT 'TGT_VVD' FLAG,
           TRD_CD, RLANE_CD, DIR_CD, 
           NULL G_SPRT_GRP_CD,
           NULL G_BSA_GRP_CD,
           (SPRT_GRP_CD) T_SPRT_GRP_CD,
           (BSA_GRP_CD)  T_BSA_GRP_CD, 
           (SPRT_GRP_CD||BSA_GRP_CD) MAX_SPRT_GRP_CD,
           FNL_BSA_CAPA
    FROM   SAQ_MON_TGT_VVD M
    WHERE  M.BSE_YR = @[year]
    AND    M.BSE_QTR_CD = @[quarter]
#if (${trade} != '')      
    AND M.TRD_CD = @[trade] 
#end
#if (${bound} != '')      
    AND M.DIR_CD = @[bound] 
#end    
    )  A
--    WHERE 1=1
--        AND rlane_cd IN ( 'AUPAE', 'CMXAE' )
    GROUP BY   --FLAG, 
               TRD_CD, RLANE_CD, DIR_CD, FNL_BSA_CAPA 

),
COA_MON_VVD_V AS ( 
    SELECT  
        V.TRD_CD, V.RLANE_CD,  
        V.VSL_CD, V.SKD_VOY_NO, V.DIR_CD , 
        V.SLS_YRMON, 
        V.COST_WK , 
        V.SUB_TRD_CD, V.IOC_CD, V.VVD_SEQ, 
        V.LST_LODG_PORT_ETD_DT, 
        V.LST_LODG_PORT_CD 
    FROM COA_MON_VVD V 
    WHERE   V.SLS_YRMON BETWEEN @[year]||@[month] AND @[year]||@[month2] 
#if (${trade} != '') 
      AND V.TRD_CD = @[trade] 
#end
#if (${bound} != '') 
	  AND V.DIR_CD = @[bound]
#end
        AND V.RLANE_CD <> 'RBCCO'
        AND V.SUB_TRD_CD <> 'IP'    
        AND (V.DELT_FLG IS NULL OR V.DELT_FLG = 'N') 
    
)

--------SELECT START --------------------------------------------
SELECT A.TRD_CD,A.RLANE_CD, A.DIR_CD,
       A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD,
       --A.SPRT_GRP_CD,
       -- 2010.05.03 대표 Group 관련 CSR 
       SUBSTR( SPRT_GRP.SPRT_GRP_CD, A.RANK_1,  1 )  SPRT_GRP_CD ,
       --NVL(A.BSA_GRP_CD , '01' ) BSA_GRP_CD,
       '01' BSA_GRP_CD,
        SUBSTR( SPRT_GRP.SPRT_GRP_CD,
            (MAX( A.RANK_1 )  OVER(PARTITION BY A.TRD_CD, A.RLANE_CD, A.DIR_CD) )
         ,  1 )||'01'   GRP_MAX,

	   A.BSE_MON,A.BSE_WK,
       A.SUB_TRD_CD, A.IOC_CD, A.VVD_SEQ,
       A.FNL_BSA_CAPA,
       TO_CHAR(A.FNL_BSA_CAPA,'FM099999999990') AS STR_FNL_BSA_CAPA,
       A.UPD_RMK,
       A.ETD_DT,
       A.LST_LODG_PORT_CD
FROM (

----------------------------------------------------

    SELECT 
        V.TRD_CD, V.RLANE_CD, V.DIR_CD, 
        V.VSL_CD, V.SKD_VOY_NO, V.DIR_CD SKD_DIR_CD,
		-- 2010.05.03 대표 Group 관련 CSR 
		GC.SPRT_GRP_CD,
		GC.BSA_GRP_CD,
		GM.MAX_GRP_CD GRP_MAX,
        
        DENSE_RANK() OVER(PARTITION BY V.TRD_CD, V.RLANE_CD, V.DIR_CD --, M.FNL_BSA_CAPA 
                            ORDER BY   V.TRD_CD, V.RLANE_CD, V.DIR_CD, ROUND(NVL(M.FNL_CO_BSA_CAPA, 0))
                         )  RANK_1,      

        --TO_NUMBER (GM.MAX_BSA_GRP_CD )  MAX_NUM,
		--INSTR( 'ABCDEFGHIJKLMNOPQRSTUVWXYZ', GM.MAX_SPRT_GRP_CD)  MAX_NUM,
        --NVL(GC.GRP_CD, '01') BSA_GRP_CD, 
        --NVL(TO_CHAR(GM.GRP_CD, 'FM00'), '00') GRP_MAX,
        SUBSTR(V.SLS_YRMON, 5) BSE_MON,
        V.COST_WK BSE_WK,
        V.SUB_TRD_CD, V.IOC_CD, V.VVD_SEQ,
        ROUND(NVL(M.FNL_CO_BSA_CAPA, 0)) FNL_BSA_CAPA,
        '' UPD_RMK,
        TO_CHAR(V.LST_LODG_PORT_ETD_DT, 'YYYY/MM/DD HH24:MI:SS') ETD_DT,
        V.LST_LODG_PORT_CD,
        V.LST_LODG_PORT_ETD_DT,V.SLS_YRMON,V.COST_WK
    FROM COA_MON_VVD_V V, BSA_VVD_MST M, GRP_CAPA GC, GRP_MAX GM, 
         SAQ_TGT_GRP_TRD T
    WHERE 1=1
        AND V.TRD_CD = T.TRD_CD  
        AND V.DIR_CD = T.DIR_CD
        AND V.SUB_TRD_CD = T.SUB_TRD_CD
        AND V.TRD_CD = M.TRD_CD(+) 
        AND V.RLANE_CD = M.RLANE_CD(+) 
        AND V.VSL_CD = M.VSL_CD(+) 
        AND V.SKD_VOY_NO = M.SKD_VOY_NO(+) 
        AND V.DIR_CD = M.SKD_DIR_CD(+) 
        -- GSM MAX CAPA JOIN        
        AND M.TRD_CD = GC.TRD_CD(+)
        AND M.RLANE_CD = GC.RLANE_CD(+)
        AND M.SKD_DIR_CD = GC.DIR_CD(+)
        AND ROUND(NVL(M.FNL_CO_BSA_CAPA, 0)) = GC.FNL_BSA_CAPA(+)
        -- GSM MAX JOIN
        AND V.TRD_CD = GM.TRD_CD(+)
        AND V.RLANE_CD = GM.RLANE_CD(+)
        AND V.DIR_CD = GM.DIR_CD(+)
        --AND V.RLANE_CD IN ('NE4AE')
) A	,
    (
    SELECT 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' SPRT_GRP_CD
    FROM    DUAL
    ) SPRT_GRP
ORDER BY A.SUB_TRD_CD, A.RLANE_CD,A.SLS_YRMON,A.COST_WK, A.LST_LODG_PORT_ETD_DT			]]></sql>
			<params>
				<param name="year" type="12" value="" out="N"/>
				<param name="trade" type="12" value="" out="N"/>
				<param name="bound" type="12" value="" out="N"/>
				<param name="quarter" type="12" value="" out="N"/>
				<param name="month" type="12" value="" out="N"/>
				<param name="month2" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
