<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="JapanTerminalTransmissionDBDAOsearchVesselListForBkgRouteRSQL">
			<desc><![CDATA[]]></desc>
			<sql><![CDATA[
SELECT V.VSL_CD||V.SKD_VOY_NO||V.SKD_DIR_CD AS VVD_CD,
       NVL(S.OB_CSSM_VOY_NO, V.SKD_VOY_NO||V.SKD_DIR_CD) AS JP_TML_VSL_NO,
       B.POL_CD,
       B.POL_NOD_CD AS POL_YD_CD,
       B.POR_CD,
       B.POR_NOD_CD AS POR_YD_CD,
       M.CALL_SGN_NO,
       TO_CHAR(S.VPS_ETA_DT-14, 'YYYY-MM-DD') AS BAT_SKD_PRD_FM_DT,
       TO_CHAR(S.VPS_ETA_DT, 'YYYY-MM-DD') AS BAT_SKD_PRD_TO_DT,
       (SELECT DECODE(NVL(A.ACT_CRR_CD, B.CRR_CD), COM_ConstantMgr_PKG.COM_getCompanyCode_FNC(), 'Y', 'N')
          FROM VSK_VSL_SKD A,
               MDM_VSL_CNTR B
         WHERE 1 = 1
           AND A.VSL_CD = SUBSTR(@[in_vvd_cd], 1, 4)
           AND A.SKD_VOY_NO = SUBSTR(@[in_vvd_cd], 5, 4)
           AND A.SKD_DIR_CD = SUBSTR(@[in_vvd_cd], 9, 1)
           AND A.VSL_CD = B.VSL_CD ) AS CHK_VSL_FLG

  FROM BKG_VVD V,
       BKG_BOOKING B,
       VSK_VSL_PORT_SKD S,
       MDM_VSL_CNTR M

 WHERE 1 = 1
   AND V.VSL_CD = SUBSTR(@[in_vvd_cd], 1, 4)
   AND V.SKD_VOY_NO = SUBSTR(@[in_vvd_cd], 5, 4)
   AND V.SKD_DIR_CD = SUBSTR(@[in_vvd_cd], 9, 1)
#if(${in_pol_cd} == '') --조회 검색 조건 없을 시
   AND V.POL_CD LIKE 'JP%'
#else
   AND V.POL_CD=@[in_pol_cd]
#end
   AND B.BKG_NO=V.BKG_NO
   AND B.POL_CD=V.POL_CD
#if(${in_por_cd} != '')
   AND B.POR_CD=@[in_por_cd]
#end
#if (${in_bat_skd_prd_fm_dt} != '')
   AND S.VPS_ETA_DT-14 >= TO_DATE(@[in_bat_skd_prd_fm_dt], 'YYYY-MM-DD')
#end
#if (${in_bat_skd_prd_to_dt} != '')
   AND S.VPS_ETA_DT <= TO_DATE(@[in_bat_skd_prd_to_dt], 'YYYY-MM-DD') + 0.99999
#end
   AND S.VSL_CD = V.VSL_CD
   AND S.SKD_VOY_NO = V.SKD_VOY_NO
   AND S.SKD_DIR_CD = V.SKD_DIR_CD
   AND S.VPS_PORT_CD = V.POL_CD
   AND S.CLPT_IND_SEQ = V.POL_CLPT_IND_SEQ --double calling 여부 문의
   AND M.VSL_CD = V.VSL_CD
   AND B.BKG_STS_CD != 'X'
   AND NOT EXISTS(SELECT 'Y'
                    FROM BKG_TML_EDI_JP_BAT_VVD_SKD S
                   WHERE 1 = 1
                     AND V.VSL_CD = S.VSL_CD
                     AND V.SKD_VOY_NO = S.SKD_VOY_NO
                     AND V.SKD_DIR_CD = S.SKD_DIR_CD
                     AND B.POL_CD = S.POL_CD
                     AND B.POL_NOD_CD = S.POL_YD_CD
                     AND B.POR_CD = S.POR_CD
                     AND (B.POR_NOD_CD = S.POR_YD_CD OR B.POR_NOD_CD IS NULL) ) -- check aleady exist in SKD
 GROUP BY V.VSL_CD,
       V.SKD_VOY_NO,
       V.SKD_DIR_CD,
       NVL(S.OB_CSSM_VOY_NO, V.SKD_VOY_NO||V.SKD_DIR_CD),
       B.POL_CD,
       B.POL_NOD_CD,
       B.POR_CD,
       B.POR_NOD_CD,
       S.VPS_ETA_DT,
       M.CALL_SGN_NO
			]]></sql>
			<params>
				<param name="in_vvd_cd" type="12" value="" out="N"/>
				<param name="in_pol_cd" type="12" value="" out="N"/>
				<param name="in_por_cd" type="12" value="" out="N"/>
				<param name="in_bat_skd_prd_fm_dt" type="12" value="" out="N"/>
				<param name="in_bat_skd_prd_to_dt" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
