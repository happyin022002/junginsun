<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="UsaCustomsTransmissionDBDAOsearchBlInfoRSQL">
			<desc><![CDATA[]]></desc>
			<sql><![CDATA[
SELECT CASE WHEN MF_STS_CD = 'D'
            THEN RPAD('A01' || COM_ConstantMgr_PKG.COM_getScacCode_FNC() || LOC_AMS_PORT || 'D' || RPAD(BL_NO, 12, ' ') || RPAD(' ', 10, ' ') || '03', 80, ' ') || CHR(10)
            WHEN SND_YN = 'Y'
            THEN RPAD('A01' || COM_ConstantMgr_PKG.COM_getScacCode_FNC() || LOC_AMS_PORT || 'D' || RPAD(BL_NO, 12, ' ') || RPAD(' ', 10, ' ') || '03', 80, ' ') || CHR(10)
              || RPAD('A01' || COM_ConstantMgr_PKG.COM_getScacCode_FNC() || LOC_AMS_PORT || 'A' || RPAD(BL_NO, 12, ' ') || RPAD(' ', 10, ' ') || '03', 80, ' ') || CHR(10)
            ELSE RPAD('A01' || COM_ConstantMgr_PKG.COM_getScacCode_FNC() || LOC_AMS_PORT || 'A' || RPAD(BL_NO, 12, ' ') || RPAD(' ', 10, ' ') || '03', 80, ' ') || CHR(10)
        END A01
      ,RPAD('B01' || RPAD(BL_NO, 12, ' ') || LPAD(CSTMS_POL_AMS_PORT_CD, 5, '0') || PCK_QTY || RPAD(AMS_PCK_TP_CD, 5, ' ') || CGO_WGT || WGT_UT_CD || LADING_STATUS ||
            CASE WHEN @[trsm_msg_tp_cd] <> 'AI'
                 THEN ' '
                 WHEN IT_ITNO LIKE '%' || IT_NO || '%' AND MF_NO = 'X'
                 THEN '1'
                 WHEN IT_ITNO LIKE '%' || IT_NO || '%' AND MF_NO <> 'X'
                 THEN ' '
                 ELSE '0'
             END
           , 80, ' ') || CHR(10) AS B01
      ,RPAD('B01' || RPAD(BL_NO, 12, ' ') || LPAD(CSTMS_POL_AMS_PORT_CD, 5, '0') || PCK_QTY || RPAD(AMS_PCK_TP_CD, 5, ' ') || CGO_WGT || WGT_UT_CD || LADING_STATUS_ISF5
           , 80, ' ') || CHR(10) AS B01ISF5
      ,RPAD('B02' || LPAD(TRUNC(NVL(MEAS_QTY,0)), 8, '0') || '  ' || 'CM' || RPAD(NVL(UPPER(POR_NM), ' '), 17, ' ') || RPAD(' ', 12, ' ') || SECOND_NOTIFY_PARTY1 || SECOND_NOTIFY_PARTY2 || RPAD(NVL(POL_LAST_AMS, ' '), 5, ' ')
           , 80, ' ') || CHR(10) AS B02
      ,RPAD('B04' || 'OB ' || COM_ConstantMgr_PKG.COM_getScacCode_FNC() || MF_NO, 80, ' ') || CHR(10) AS B04
      ,RPAD('B04' || 'OL ' || COM_ConstantMgr_PKG.COM_getScacCode_FNC() || PRE_MF_NO, 80, ' ') || CHR(10) B04_2
      ,RPAD('B04' || 'CSK' || DECODE(SUBSTR(FPOD_CD,1,2), 'US', DEL_AMS_PORT_CD, CSTMS_POD_AMS_PORT_CD), 80, ' ') || CHR(10) ||
       RPAD('B04' || 'CSK' || DEL_AMS_PORT_CD, 80, ' ') || CHR(10) B04ISF5
      ,IT_ITNO
      ,IT_ITTYPE
      ,IT_HUB
      ,IT_LST_USA
      ,IT_DEL
      ,WGT_VAL
      ,IT_PKG_QTY
      ,IT_PKG_AMS
      ,IT_IPI_LOCAL
      ,CMDT_CD
      ,AMS_CODE
      ,MF_NO
      ,BL_NO
      ,DECODE(MF_NO, 'X', BL_NO, MF_NO) AS MBL_NO
      ,DECODE(ACT_FILE_SKD_DIR_CD, 'E', 'E', SKD_DIR_CD) AS ACT_FILE_SKD_DIR_CD
      ,FPOD_CD
      ,BOOKING_POD_CD
      ,MF_STS_CD
      ,CSTMS_LOC_CD
      ,VPS_ETA_DT
      ,VSL_CD || SKD_VOY_NO || SKD_DIR_CD AS VVD
      ,CSTMS_POD_CD
      ,CSTMS_POL_CD
      ,FULL_MTY_CD
      ,IT_NO
      ,CSTMS_PORT_CD
      ,LOC_AMS_PORT
      ,VSL_ENG_NM
      ,LLOYD_NO
      ,VSL_RGST_CNT_CD
      ,NEXT_VSL_ENG_NM
      ,PTT_FRM_CD
      ,BKG_NO
      ,VVD_ORDER

  FROM (SELECT NVL((SELECT ATTR_CTNT2
                      FROM BKG_CSTMS_CD_CONV_CTNT
                     WHERE CNT_CD='US'
                       AND CSTMS_DIV_ID='AMS_TML_CD_MAP'
                       AND ATTR_CTNT1= DECODE(VVD.POD_YD_CD, '', IT.POD_NOD_CD, VVD.POD_YD_CD)
                       AND ROWNUM=1
                    ), NVL(LOC7.LOC_AMS_PORT_CD, '    ')) AS LOC_AMS_PORT
              ,COM_ConstantMgr_PKG.COM_getScacCode_FNC() || IT.VSL_CD || IT.SKD_VOY_NO || IT.SKD_DIR_CD || IT.CSTMS_POD_CD AS CRR_BAT_NO
              ,DECODE(IT.FULL_MTY_CD,
                       'M', LPAD(NVL((SELECT COUNT(BC.CNTR_NO) FROM BKG_CONTAINER BC WHERE BC.BKG_NO = BKG.BKG_NO), '1'), 10, '0')
                          , LPAD(TRUNC(NVL(IT.PCK_QTY,0)), 10, '0')
                     ) AS PCK_QTY
              ,DECODE(IT.FULL_MTY_CD,
                       'M', LPAD(NVL((SELECT COUNT(BC.CNTR_NO) FROM BKG_CONTAINER BC WHERE BC.BKG_NO = BKG.BKG_NO), '1'), 10, '0')
                          , LPAD(TRUNC(NVL(IT.CGO_WGT,0)), 10, '0')
                     ) AS CGO_WGT
              ,NVL(NVL((SELECT CSTMS_PCK_TP_CD
                          FROM BKG_CSTMS_PCK_TP_CONV AA
                         WHERE AA.CNT_CD = 'US'
                           AND AA.PCK_TP_CD = IT.AMS_PCK_TP_CD
                        ),IT.AMS_PCK_TP_CD)
                   ,'PKGS') AS AMS_PCK_TP_CD
              ,NVL(SUBSTR(IT.WGT_UT_CD, 1, 2),'KG') AS WGT_UT_CD
              ,DECODE(IT.FULL_MTY_CD,
                       'M', DECODE(IBD.CSTMS_CLR_TP_CD, 'F', 'B', 'V','B','2')
                           ,DECODE(IBD.CSTMS_CLR_TP_CD,
                                  'F', DECODE(NVL(IT.MF_NO, 'MASTER'), 'MASTER',DECODE(IT.CSTMS_FILE_TP_CD, '3', 'B', 'O'), 'P'),
                                  'V', DECODE(NVL(IT.MF_NO, 'MASTER'), 'MASTER',DECODE(IT.CSTMS_FILE_TP_CD, '3', 'B', 'O'), 'P'),
                                  DECODE(NVL(IT.MF_NO, 'MASTER'), 'MASTER', DECODE(IT.CSTMS_FILE_TP_CD, '3', '0', 'M'),  'N')
                                  )
                     ) AS LADING_STATUS
              ,DECODE(IT.FULL_MTY_CD,
                       'M', DECODE(IBD.CSTMS_CLR_TP_CD, 'F', 'B', 'V','B','2')
                           ,DECODE(IBD.CSTMS_CLR_TP_CD,
                                  'F', DECODE(NVL(IT.MF_NO, 'MASTER'), 'MASTER',DECODE(IT.CSTMS_FILE_TP_CD, '3', 'Q', 'Q'), 'R'),
                                  'V', DECODE(NVL(IT.MF_NO, 'MASTER'), 'MASTER',DECODE(IT.CSTMS_FILE_TP_CD, '3', 'Q', 'Q'), 'R'),
                                  DECODE(NVL(IT.MF_NO, 'MASTER'), 'MASTER', DECODE(IT.CSTMS_FILE_TP_CD, '3', 'T', 'T'),  'S')
                                  )
                     ) AS LADING_STATUS_ISF5
              ,DECODE(IT.MF_NO, NULL, (SELECT NVL(MAX(DECODE(ATTR_CTNT2, 'ALL', ATTR_CTNT3, IT.CSTMS_POD_CD, ATTR_CTNT3)), '    ')
                                         FROM BKG_CSTMS_CD_CONV_CTNT
                                        WHERE CNT_CD = 'US'
                                          AND CSTMS_DIV_ID = 'SC_FIRMS_CD_MAP'
                                          AND ATTR_CTNT1 = BKG.SC_NO
                                          AND DELT_FLG = 'N'
                                      )
                                     ,COM_ConstantMgr_PKG.COM_getScacCode_FNC()
                     ) AS SECOND_NOTIFY_PARTY1
              ,(SELECT NVL(MAX(DECODE (ATTR_CTNT1, IT.POD_NOD_CD, ATTR_CTNT2)), '    ')
                  FROM BKG_CSTMS_CD_CONV_CTNT
                 WHERE CNT_CD = 'US'
                   AND CSTMS_DIV_ID = 'LOC_FIRMS_CD_MAP'
                   AND DELT_FLG = 'N'
               ) AS SECOND_NOTIFY_PARTY2
              ,(SELECT LOC_AMS_PORT_CD
                  FROM VSK_VSL_PORT_SKD A
                      ,MDM_LOCATION     B
                 WHERE A.VPS_PORT_CD = B.LOC_CD
                   AND A.VSL_CD      = IT.VSL_CD
                   AND A.SKD_VOY_NO  = IT.SKD_VOY_NO
                   AND A.SKD_DIR_CD  = IT.SKD_DIR_CD
                   AND NVL(A.SKD_CNG_STS_CD, ' ') <> 'S'
                   AND A.VPS_ETA_DT  = (SELECT MAX(VPS_ETA_DT)
                                          FROM VSK_VSL_PORT_SKD
                                         WHERE VSL_CD      = IT.VSL_CD
                                           AND SKD_VOY_NO  = IT.SKD_VOY_NO
                                           AND SKD_DIR_CD  = IT.SKD_DIR_CD
                                           AND NVL(SKD_CNG_STS_CD, 'X') <> 'S'
                                           AND VPS_ETA_DT  < (SELECT MIN(VPS_ETA_DT)
                                                                FROM VSK_VSL_PORT_SKD
                                                               WHERE VSL_CD        = IT.VSL_CD
                                                                 AND SKD_VOY_NO    = IT.SKD_VOY_NO
                                                                 AND SKD_DIR_CD    = IT.SKD_DIR_CD
                                                                 AND CLPT_SEQ <> 1
                                                                 AND NVL(SKD_CNG_STS_CD, 'X') <> 'S'
                                                                 AND VPS_PORT_CD   = IT.CSTMS_PORT_CD
                                                             )
                                           AND VPS_PORT_CD NOT IN (SELECT ATTR_CTNT1
                                                                     FROM BKG_CSTMS_CD_CONV_CTNT
                                                                    WHERE CNT_CD = 'US'
                                                                      AND CSTMS_DIV_ID='CANAL_LOC_CD')
                                           AND SUBSTR(VPS_PORT_CD,1,2) NOT IN ('US', (SELECT ATTR_CTNT1
                                                                                       FROM BKG_CSTMS_CD_CONV_CTNT
                                                                                      WHERE CNT_CD='US'
                                                                                        AND CSTMS_DIV_ID='US_CNT_CD_LIST'))
                                       )
                   AND ROWNUM = 1
               ) AS POL_LAST_AMS
              ,NVL((SELECT TO_CHAR(MAX(VPS_ETA_DT),'MMDDRR')
                      FROM VSK_VSL_PORT_SKD
                     WHERE VSL_CD = IT.VSL_CD
                       AND SKD_VOY_NO = IT.SKD_VOY_NO
                       AND SKD_DIR_CD = IT.SKD_DIR_CD
                       AND VPS_PORT_CD = IT.CSTMS_PORT_CD
                       AND VPS_ETA_DT <= (SELECT MIN(VPS_ETA_DT)
                                            FROM VSK_VSL_PORT_SKD
                                           WHERE VSL_CD = IT.VSL_CD
                                             AND SKD_VOY_NO = IT.SKD_VOY_NO
                                             AND SKD_DIR_CD = IT.SKD_DIR_CD
                                             AND CLPT_SEQ <> 1
                                             AND NVL(SKD_CNG_STS_CD, 'X') <> 'S'
                                             AND VPS_PORT_CD = IT.CSTMS_POD_CD)
                   ), NVL((SELECT TO_CHAR(MAX(VPS_ETA_DT),'MMDDRR')
                             FROM VSK_VSL_PORT_SKD
                            WHERE VSL_CD = IT.VSL_CD
                              AND SKD_VOY_NO = IT.SKD_VOY_NO
                              AND SKD_DIR_CD = IT.SKD_DIR_CD
                              AND VPS_PORT_CD = IT.CSTMS_PORT_CD
                              AND VPS_ETA_DT <= (SELECT MAX(VPS_ETA_DT)
                                                   FROM VSK_VSL_PORT_SKD
                                                  WHERE VSL_CD = IT.VSL_CD
                                                    AND SKD_VOY_NO = IT.SKD_VOY_NO
                                                    AND SKD_DIR_CD = IT.SKD_DIR_CD
                                                    AND CLPT_SEQ <> 1
                                                    AND NVL(SKD_CNG_STS_CD, 'X') <> 'S'
                                                    AND VPS_PORT_CD = IT.CSTMS_POD_CD)
                          ), '')
                  ) AS VPS_ETA_DT
              ,NVL(NVL((SELECT CSTMS_PCK_TP_CD
                          FROM BKG_CSTMS_PCK_TP_CONV AA
                         WHERE AA.CNT_CD = 'US'
                           AND AA.PCK_TP_CD = IT.AMS_PCK_TP_CD
                        ),IT.AMS_PCK_TP_CD)
                  ,'PKG  ') AS IT_PKG_AMS
              ,(SELECT ATTR_CTNT1
                  FROM BKG_CSTMS_CD_CONV_CTNT
                 WHERE CNT_CD = 'US'
                   AND CSTMS_DIV_ID = 'AMS_ASGN_CO_CD'
                   AND CSTMS_DIV_ID_SEQ = 1
                   AND DELT_FLG ='N'
                   AND ROWNUM = 1
               ) AS IT_NO
              ,DOC.MEAS_QTY
              ,LOC4.LOC_NM AS POR_NM
              ,IT.VSL_CD
              ,IT.SKD_VOY_NO
              ,IT.SKD_DIR_CD
              ,IT.CSTMS_POD_CD
              ,IT.CSTMS_POL_CD
              ,VSL.VSL_RGST_CNT_CD
              ,VSL.VSL_ENG_NM
              ,VSL.LLOYD_NO
              ,NVL(LOC.LOC_AMS_PORT_CD, ' ') AS CSTMS_POL_AMS_PORT_CD
              ,IT.PRE_MF_NO
              ,LOC6.LOC_AMS_PORT_CD AS DEL_AMS_PORT_CD
              ,LOC5.LOC_AMS_PORT_CD AS CSTMS_POD_AMS_PORT_CD
              ,NVL(IBD.IBD_TRSP_NO,' ') IT_ITNO
              ,NVL(IBD.IBD_TRSP_TP_CD,'  ') IT_ITTYPE -- 61,62,63
              ,NVL(IT.HUB_LOC_CD,' ') IT_HUB
              ,NVL(IT.USA_LST_LOC_CD,' ') IT_LST_USA
              ,NVL(IT.DEL_CD,' ') IT_DEL
              ,SUBSTR(TO_CHAR(IT.CGO_WGT*20,'09999999'),2) WGT_VAL
              ,SUBSTR(TO_CHAR(NVL(IT.PCK_QTY,0),'0999999999'),2) IT_PKG_QTY
              ,NVL(IBD.CSTMS_CLR_TP_CD,' ') IT_IPI_LOCAL
              ,NVL(BKG.CMDT_CD,' ') CMDT_CD
              ,DECODE(IBD.IBD_TRSP_TP_CD,'61',LOC3.LOC_AMS_PORT_CD,'62',LOC2.LOC_AMS_PORT_CD,'63',LOC2.LOC_AMS_PORT_CD,LOC3.LOC_AMS_PORT_CD) AMS_CODE
              ,SUBSTR(IT.BL_NO, 1, 12) BL_NO --RPAD(IT.BL_NO, 12, ' ') BL_NO
              ,NVL(IT.MF_NO, 'X') MF_NO
              ,ACT_FILE_SKD_DIR_CD
              ,IT.POD_CD FPOD_CD
              ,BKG.POD_CD BOOKING_POD_CD
              ,IT.MF_STS_CD
              ,IT.CSTMS_LOC_CD
              ,IT.FULL_MTY_CD
              ,IT.CSTMS_PORT_CD
              ,IT.BKG_NO
              ,(SELECT C.VSL_ENG_NM
                  FROM MDM_VSL_CNTR C
                 WHERE C.VSL_CD = (SELECT /*+ INDEX_ASC(BKG_VVD XPKBKG_VVD) */ B.VSL_CD
                                     FROM BKG_VVD B
                                    WHERE B.BKG_NO = IT.BKG_NO
                                      AND B.VSL_PRE_PST_CD||B.VSL_SEQ > VVD.VSL_PRE_PST_CD||VVD.VSL_SEQ
                                      AND ROWNUM = 1 )) AS NEXT_VSL_ENG_NM
              ,IBD.PTT_FRM_CD
              ,NVL((SELECT 'Y'
                      FROM BKG_CSTMS_ADV_SND_LOG     SND
                          ,BKG_CSTMS_ADV_RCV_LOG     RCV
                          ,BKG_CSTMS_ADV_EDI_BL_RSPN EDI
                     WHERE 1=1
                       AND EDI.CNT_CD     = SND.CNT_CD
                       AND EDI.CRR_BAT_NO = SND.CRR_BAT_NO
                       AND EDI.BL_NO      = IT.BL_NO
                       AND SND.CNT_CD     = RCV.CNT_CD
                       AND SND.CRR_BAT_NO = RCV.CRR_BAT_NO
                       AND SND.IO_BND_CD  = RCV.IO_BND_CD
                       AND SND.CNT_CD     = 'US'
                       AND SND.IO_BND_CD  = 'I'
                       AND SND.TRSM_MSG_TP_ID IN ('MI','AI')
                       AND SND.VSL_CD     = IT.VSL_CD
                       AND SND.SKD_VOY_NO = IT.SKD_VOY_NO
                       AND SND.SKD_DIR_CD = IT.SKD_DIR_CD
                       AND SND.POL_CD     = IT.CSTMS_POL_CD
                       AND SND.POD_CD     = IT.CSTMS_POD_CD
                       AND NOT EXISTS (SELECT '1'
                                        FROM BKG_CSTMS_ADV_RCV_LOG_DTL DTL
                                       WHERE RCV.CNT_CD = DTL.CNT_CD
                                         AND RCV.RCV_DT = DTL.RCV_DT
                                         AND RCV.IO_BND_CD = DTL.IO_BND_CD
                                         AND RCV.RCV_SEQ = DTL.RCV_SEQ
                                         AND DTL.MSG_DESC LIKE 'W01' || EDI.BL_NO || '%'
                                     )
                       AND ROWNUM = 1
               ), 'N') AS SND_YN
              ,VVD.VSL_PRE_PST_CD||VVD.VSL_SEQ VVD_ORDER

          FROM BKG_CSTMS_ADV_BL  IT
              ,MDM_LOCATION      LOC  --CSTMS_POL_CD
              ,MDM_LOCATION      LOC2 --USA_LST_LOC_CD
              ,MDM_LOCATION      LOC3 --HUB_LOC_CD
              ,MDM_LOCATION      LOC4 --POR_CD
              ,MDM_LOCATION      LOC5 --CSTMS_POD_CD
              ,MDM_LOCATION      LOC6 --DEL_CD
              ,MDM_LOCATION      LOC7 --CSTMS_PORT_CD
              ,BKG_BOOKING       BKG
              ,BKG_CSTMS_ADV_IBD IBD
              ,BKG_BL_DOC        DOC
              ,MDM_VSL_CNTR      VSL
              ,BKG_VVD           VVD
         WHERE IT.CNT_CD         = 'US'
           AND IT.BL_NO          = @[bl_no]
           AND IT.CSTMS_POL_CD   = LOC.LOC_CD
           AND IT.USA_LST_LOC_CD = LOC2.LOC_CD(+)
           AND IT.HUB_LOC_CD     = LOC3.LOC_CD(+)
           AND IT.POR_CD         = LOC4.LOC_CD(+)
           AND IT.CSTMS_POD_CD   = LOC5.LOC_CD(+)
           AND IT.DEL_CD         = LOC6.LOC_CD(+)
           AND IT.CSTMS_PORT_CD  = LOC7.LOC_CD(+)
           AND IT.BKG_NO         = BKG.BKG_NO(+)
           AND IT.BL_NO          = IBD.BL_NO(+)
           AND IT.CNT_CD         = IBD.CNT_CD(+)
           AND IT.BKG_NO         = DOC.BKG_NO(+)
           AND IT.VSL_CD         = VSL.VSL_CD
           AND IT.BKG_NO         = VVD.BKG_NO(+)
           AND IT.VSL_CD         = VVD.VSL_CD(+)
           AND IT.SKD_VOY_NO     = VVD.SKD_VOY_NO(+)
           AND IT.SKD_DIR_CD     = VVD.SKD_DIR_CD(+)
    ) BL

ORDER BY VVD_ORDER DESC			]]></sql>
			<params>
				<param name="trsm_msg_tp_cd" type="12" value="" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
