<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="NetworkCostDBDAOCreatePortTariffFromPSOCSQL">
			<desc><![CDATA[CreatePortTariffFromPSO]]></desc>
			<sql><![CDATA[
MERGE INTO COA_PORT_TRF A1 
USING (SELECT 'PSO' SLAN_CD
             , VSL_CD
             , SKD_VOY_NO
             , SKD_DIR_CD
             , TML_CD
             , PORT_USD_AMT
             , CRE_USR_ID
             , CRE_DT
             , UPD_USR_ID
             , UPD_DT
          FROM (SELECT --PSO_BZTP_CD
                       VSL_CD
                     , SKD_VOY_NO
                     , SKD_DIR_CD
                     , YD_CD TML_CD
                     , WRK_DT
                     , WRK_SEQ
                     , LAST_VALUE (WRK_DT IGNORE NULLS) OVER (PARTITION BY VSL_CD, SKD_VOY_NO, SKD_DIR_CD
                         ORDER BY WRK_DT, WRK_SEQ ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) LST_WRK_DT
                     , LAST_VALUE (WRK_SEQ IGNORE NULLS) OVER (PARTITION BY VSL_CD, SKD_VOY_NO, SKD_DIR_CD
                         ORDER BY WRK_DT, WRK_SEQ ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) LST_WRK_SEQ
                     --, SRC_PSO_BZTP_CD
                     , INV_USD_AMT PORT_USD_AMT
                     , CRE_USR_ID
                     , CRE_DT
                     , UPD_USR_ID
                     , UPD_DT
                  FROM PSO_TGT_VVD_EXPN
                 WHERE PSO_BZTP_CD = '7'
                   AND VSL_CD = @[vsl_cd]
                   AND SKD_VOY_NO = @[skd_voy_no]
                   AND SKD_DIR_CD = @[skd_dir_cd])
         WHERE WRK_DT=LST_WRK_DT
           AND WRK_SEQ=LST_WRK_SEQ) A2 
ON (A1.SLAN_CD = A2.SLAN_CD
       AND A1.VSL_CD = A2.VSL_CD
       AND A1.SKD_VOY_NO = A2.SKD_VOY_NO
       AND A1.SKD_DIR_CD = A2.SKD_DIR_CD
       AND A1.TML_CD = A2.TML_CD)
WHEN MATCHED THEN
    UPDATE
       SET A1.PORT_USD_AMT = A2.PORT_USD_AMT
         , A1.UPD_USR_ID = A2.UPD_USR_ID
         , A1.UPD_DT = A2.UPD_DT
WHEN NOT MATCHED THEN
    INSERT (A1.SLAN_CD
             , A1.VSL_CD
             , A1.SKD_VOY_NO
             , A1.SKD_DIR_CD
             , A1.TML_CD
             , A1.PORT_USD_AMT
             , A1.CRE_USR_ID
             , A1.CRE_DT
             , A1.UPD_USR_ID
             , A1.UPD_DT)
    VALUES (A2.SLAN_CD
             , A2.VSL_CD
             , A2.SKD_VOY_NO
             , A2.SKD_DIR_CD
             , A2.TML_CD
             , A2.PORT_USD_AMT
             , A2.CRE_USR_ID
             , A2.CRE_DT
             , A2.UPD_USR_ID
             , A2.UPD_DT)			]]></sql>
			<params>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
