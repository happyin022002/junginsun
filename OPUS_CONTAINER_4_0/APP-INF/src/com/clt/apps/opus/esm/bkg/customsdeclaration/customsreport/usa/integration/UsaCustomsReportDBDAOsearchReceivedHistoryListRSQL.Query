<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="UsaCustomsReportDBDAOsearchReceivedHistoryListRSQL">
			<desc><![CDATA[RcvHistListDetailVO]]></desc>
			<sql><![CDATA[
SELECT *
  FROM (
SELECT TB.CNT_CD
      ,TB.IO_BND_CD
      ,TO_CHAR(TB.RCV_DT, 'YYYY-MM-DD HH24:MI:SS') AS RCV_DT
      ,TB.RCV_SEQ
      ,TB.RCV_MSG_TP_ID
      ,DECODE(RS.DSPO_CD, NULL, DECODE(TB.AAD, NULL, '', TB.AAD), RS.DSPO_CD) AS DSPO_CD
      ,TB.VVD
      ,TB.POL_CD
      ,TB.POD_CD
      ,BL.CSTMS_POD_CD AS VPOD_CD
      ,TB.CSTMS_BAT_NO
      ,TB.SCAC_CD
      ,DECODE(TOT_CNT, NULL, TB.BL_NO) AS BL_NO
      ,TB.TOT_CNT
      ,TB.SUC_CNT
      ,TB.ERR_CNT
      ,TB.REASON
      ,CASE WHEN TB.REASON IS NOT NULL OR TB.ERR_CNT > 0
            THEN 'Y' 
            ELSE 'N'
        END RJCT_FLG
      ,ROW_NUMBER() OVER(ORDER BY RCV_DT DESC, RCV_SEQ, TOT_CNT) AS RNUM
      ,COUNT(*) OVER() AS TOTAL
  FROM (
        SELECT LOG.CNT_CD
              ,LOG.IO_BND_CD
              ,LOG.RCV_DT
              ,LOG.RCV_SEQ
              ,LOG.RCV_MSG_TP_ID
              ,LOG.VVD
              ,LOG.POL_CD
              ,LOG.POD_CD
              ,LOG.CSTMS_BAT_NO
              ,LOG.SCAC_CD
              ,MAX(LOG.BL_NO) AS BL_NO
              ,(SELECT 'AAD' 
                  FROM BKG_CSTMS_ADV_RCV_LOG_DTL DTL
                 WHERE LOG.CNT_CD     = DTL.CNT_CD
                   AND LOG.IO_BND_CD  = DTL.IO_BND_CD
                   AND LOG.RCV_DT     = DTL.RCV_DT
                   AND LOG.RCV_SEQ    = DTL.RCV_SEQ
                   AND DTL.MSG_DESC   LIKE 'R06AAD%'
                   AND ROWNUM = 1) AS AAD
              ,DECODE(LOG.RCV_MSG_TP_ID, 'MR', SUM(TOT_CNT), 'AR', DECODE(SUM(LOG.TOT_CNT), 1, NULL, SUM(LOG.TOT_CNT))) AS TOT_CNT
              ,CASE WHEN LOG.RCV_MSG_TP_ID = 'MR' AND SUM(ERR_CNT) = 0 AND MAX(REASON) IS NOT NULL
                    THEN 0
                    WHEN LOG.RCV_MSG_TP_ID = 'MR'
                    THEN SUM(TOT_CNT) - SUM(ERR_CNT)
                    WHEN LOG.RCV_MSG_TP_ID = 'AR' AND SUM(LOG.TOT_CNT) > 1
                    THEN SUM(TOT_CNT) - SUM(ERR_CNT)
                    ELSE NULL
                END SUC_CNT
              ,CASE WHEN LOG.RCV_MSG_TP_ID = 'MR' AND SUM(ERR_CNT) = 0 AND MAX(REASON) IS NOT NULL
                    THEN SUM(TOT_CNT)
                    WHEN LOG.RCV_MSG_TP_ID = 'MR'
                    THEN SUM(ERR_CNT)
                    WHEN LOG.RCV_MSG_TP_ID = 'AR' AND SUM(LOG.TOT_CNT) > 1
                    THEN SUM(ERR_CNT)
                    ELSE NULL
                END ERR_CNT
              ,CASE WHEN LOG.RCV_MSG_TP_ID = 'MR' AND SUM(ERR_CNT) = 0 AND MAX(REASON) IS NOT NULL
                    THEN MAX(REASON	)
                    WHEN LOG.RCV_MSG_TP_ID = 'MR'
                    THEN NULL
                    WHEN LOG.RCV_MSG_TP_ID = 'AR' AND SUM(LOG.TOT_CNT) > 1
                    THEN NULL
                    ELSE MAX(REASON)
                END REASON
          FROM (
                SELECT LOG.CNT_CD
                      ,LOG.IO_BND_CD
                      ,LOG.RCV_DT
                      ,LOG.RCV_SEQ
                      ,LOG.RCV_MSG_TP_ID
                      ,LOG.VVD
                      ,LOG.POL_CD
                      ,LOG.POD_CD
                      ,LOG.CSTMS_BAT_NO
                      ,LOG.SCAC_CD
                      ,LOG.BL_NO
                      ,MAX(REASON) AS REASON
                      ,CASE WHEN LOG.RCV_MSG_TP_ID IN ('MR', 'AR')
                            THEN 1
                            ELSE 0
                        END TOT_CNT
                      ,CASE WHEN LOG.RCV_MSG_TP_ID IN ('MR', 'AR')
                            THEN NVL((SELECT 1
                                        FROM BKG_CSTMS_ADV_RCV_LOG_DTL DTL
                                       WHERE LOG.CNT_CD     = DTL.CNT_CD
                                         AND LOG.IO_BND_CD  = DTL.IO_BND_CD
                                         AND LOG.RCV_DT     = DTL.RCV_DT
                                         AND LOG.RCV_SEQ    = DTL.RCV_SEQ
                                         AND DTL.MSG_DESC   LIKE 'W01' || LOG.BL_NO || '%'
                                         AND ROWNUM = 1
                                      ), 0)
                            ELSE 0
                        END ERR_CNT
                  FROM (

                SELECT LOG.CNT_CD
                      ,LOG.IO_BND_CD
                      ,LOG.RCV_DT
                      ,LOG.RCV_SEQ
                      ,LOG.RCV_MSG_TP_ID
                      ,LOG.VSL_CD || LOG.SKD_VOY_NO || LOG.SKD_DIR_CD AS VVD
                      ,LOG.POL_CD
                      ,LOG.POD_CD
                      ,LOG.CSTMS_BAT_NO
                      ,LOG.SCAC_CD
                      ,NVL(BLR.BL_NO, LOG.BL_NO) AS BL_NO
                      ,BKG_JOIN_FNC((CURSOR(SELECT SUBSTR(DTL.MSG_DESC, 40)
                                              FROM BKG_CSTMS_ADV_RCV_LOG_DTL DTL
                                             WHERE LOG.CNT_CD     = DTL.CNT_CD
                                               AND LOG.IO_BND_CD  = DTL.IO_BND_CD
                                               AND LOG.RCV_DT     = DTL.RCV_DT
                                               AND LOG.RCV_SEQ    = DTL.RCV_SEQ
		                                       AND (DTL.MSG_DESC   LIKE 'W01 %'
                                                   OR DTL.MSG_DESC LIKE 'W01' || NVL(BLR.BL_NO, 'XXX') || '%'
                                                   OR DTL.MSG_DESC LIKE 'W01' || NVL(CNTR.CNTR_NO, 'XXX') || '%') 
                                             GROUP BY DTL.RCV_MSG_DTL_SEQ, DTL.MSG_DESC
                                             ORDER BY DTL.RCV_MSG_DTL_SEQ
                                            )
                                     ), CHR(10)) AS REASON
                  FROM BKG_CSTMS_ADV_RCV_LOG     LOG
                      ,BKG_CSTMS_ADV_EDI_BL_RSPN BLR
                      ,BKG_CSTMS_ADV_CNTR        CNTR
                 WHERE LOG.CNT_CD        = 'US'
                   AND LOG.IO_BND_CD     = 'I'
                   AND LOG.CNT_CD        = BLR.CNT_CD(+)
                   AND LOG.CRR_BAT_NO    = BLR.CRR_BAT_NO(+)
                   AND BLR.CNT_CD        = CNTR.CNT_CD(+)
                   AND BLR.BL_NO         = CNTR.BL_NO(+)
#if (${rcv_msg_tp_id} != '' && ${rcv_msg_tp_id} != 'AL')
                   AND LOG.RCV_MSG_TP_ID = @[rcv_msg_tp_id]
#end
#if (${vsl_cd} != '')
                   AND LOG.VSL_CD     = @[vsl_cd]
                   AND LOG.SKD_VOY_NO = @[skd_voy_no]
                   AND LOG.SKD_DIR_CD = @[skd_dir_cd]
#end
#if (${pol_cd} != '')
                   AND LOG.POL_CD = @[pol_cd]
#end
#if (${pod_cd} != '')
                   AND LOG.POD_CD = @[pod_cd]
#end
#if (${cstms_bat_no} != '')
                   AND LOG.CSTMS_BAT_NO = @[cstms_bat_no]
#end
#if (${scac_cd} != '')
                   AND LOG.SCAC_CD = @[scac_cd]
#end
#if (${bl_no} != '')
                   AND NVL(LOG.BL_NO, BLR.BL_NO)  = @[bl_no]
#end
#if (${fromd} != '')
                   AND LOG.RCV_DT >= TO_DATE(REPLACE(REPLACE(@[fromd], '-', ''), '/', '') ||' '|| REPLACE(REPLACE(@[fromt], ':', ''), '-',''),'YYYYMMDD HH24MI')
#end
#if (${tod} != '')
                   AND LOG.RCV_DT <= TO_DATE(REPLACE(REPLACE(@[tod], '-', ''), '/', '') ||' '|| REPLACE(REPLACE(@[tot], ':', ''), '-',''),'YYYYMMDD HH24MI')
#end
               ) LOG
         GROUP BY LOG.CNT_CD
              ,LOG.IO_BND_CD
              ,LOG.RCV_DT
              ,LOG.RCV_SEQ
              ,LOG.RCV_MSG_TP_ID
              ,LOG.VVD
              ,LOG.POL_CD
              ,LOG.POD_CD
              ,LOG.CSTMS_BAT_NO
              ,LOG.SCAC_CD
              ,LOG.BL_NO
               ) LOG
         GROUP BY LOG.CNT_CD
              ,LOG.IO_BND_CD
              ,LOG.RCV_DT
              ,LOG.RCV_SEQ
              ,LOG.RCV_MSG_TP_ID
              ,LOG.VVD
              ,LOG.POL_CD
              ,LOG.POD_CD
              ,LOG.CSTMS_BAT_NO
              ,LOG.SCAC_CD

        UNION ALL

        SELECT LOG.CNT_CD
              ,LOG.IO_BND_CD
              ,LOG.RCV_DT
              ,LOG.RCV_SEQ
              ,LOG.RCV_MSG_TP_ID
              ,LOG.VVD
              ,LOG.POL_CD
              ,LOG.POD_CD
              ,LOG.CSTMS_BAT_NO
              ,LOG.SCAC_CD
              ,LOG.BL_NO
              ,(SELECT 'AAD' 
                  FROM BKG_CSTMS_ADV_RCV_LOG_DTL DTL
                 WHERE LOG.CNT_CD     = DTL.CNT_CD
                   AND LOG.IO_BND_CD  = DTL.IO_BND_CD
                   AND LOG.RCV_DT     = DTL.RCV_DT
                   AND LOG.RCV_SEQ    = DTL.RCV_SEQ
                   AND DTL.MSG_DESC   LIKE 'R06AAD%'
                   AND ROWNUM = 1) AS AAD 
              ,NULL
              ,NULL
              ,NULL
              ,LOG.REASON
          FROM (SELECT LOG.CNT_CD
                      ,LOG.IO_BND_CD
                      ,LOG.RCV_DT
                      ,LOG.RCV_SEQ
                      ,LOG.RCV_MSG_TP_ID
                      ,LOG.VSL_CD || LOG.SKD_VOY_NO || LOG.SKD_DIR_CD AS VVD
                      ,LOG.POL_CD
                      ,LOG.POD_CD
                      ,LOG.CSTMS_BAT_NO
                      ,LOG.SCAC_CD
                      ,BLR.BL_NO
                      ,NULL
                      ,NULL
                      ,NULL
                      ,BKG_JOIN_FNC((CURSOR(SELECT SUBSTR(DTL2.MSG_DESC, 40) 
                                              FROM BKG_CSTMS_ADV_RCV_LOG_DTL DTL2
                                             WHERE LOG.CNT_CD     = DTL2.CNT_CD
                                               AND LOG.IO_BND_CD  = DTL2.IO_BND_CD
                                               AND LOG.RCV_DT     = DTL2.RCV_DT
                                               AND LOG.RCV_SEQ    = DTL2.RCV_SEQ
                                               AND DTL2.MSG_DESC   LIKE 'W01' || BLR.BL_NO || '%'
                                             ORDER BY DTL2.RCV_MSG_DTL_SEQ
                                            )
                                     ), CHR(10)) AS REASON
                      ,ROW_NUMBER() OVER(PARTITION BY DTL.RCV_DT, DTL.RCV_SEQ, SUBSTR(DTL.MSG_DESC, 4, 12) ORDER BY DTL.RCV_DT, DTL.RCV_SEQ, DTL.RCV_MSG_DTL_SEQ)  AS RNUM
                  FROM BKG_CSTMS_ADV_RCV_LOG     LOG
                      ,BKG_CSTMS_ADV_EDI_BL_RSPN BLR
                      ,BKG_CSTMS_ADV_RCV_LOG_DTL DTL
                 WHERE 1=1
                   AND LOG.CNT_CD        = 'US'
                   AND LOG.IO_BND_CD     = 'I'
                   AND LOG.RCV_MSG_TP_ID IN ('MR', 'AR')
                   AND LOG.CNT_CD     = BLR.CNT_CD
                   AND LOG.CRR_BAT_NO = BLR.CRR_BAT_NO
                   AND LOG.CNT_CD     = DTL.CNT_CD
                   AND LOG.IO_BND_CD  = DTL.IO_BND_CD
                   AND LOG.RCV_DT     = DTL.RCV_DT
                   AND LOG.RCV_SEQ    = DTL.RCV_SEQ
                   AND DTL.MSG_DESC   LIKE 'W01' || BLR.BL_NO || '%'
                   AND DECODE(LOG.RCV_MSG_TP_ID, 'AR', (SELECT COUNT(*)
                                                          FROM BKG_CSTMS_ADV_EDI_BL_RSPN AA
                                                         WHERE LOG.CNT_CD     = AA.CNT_CD
                                                           AND LOG.CRR_BAT_NO = AA.CRR_BAT_NO
                                                        )
                                                     , 2) > 1
#if (${rcv_msg_tp_id} != '' && ${rcv_msg_tp_id} != 'AL')
                   AND LOG.RCV_MSG_TP_ID = @[rcv_msg_tp_id]
#end
#if (${vsl_cd} != '')
                   AND LOG.VSL_CD     = @[vsl_cd]
                   AND LOG.SKD_VOY_NO = @[skd_voy_no]
                   AND LOG.SKD_DIR_CD = @[skd_dir_cd]
#end
#if (${pol_cd} != '')
                   AND LOG.POL_CD = @[pol_cd]
#end
#if (${pod_cd} != '')
                   AND LOG.POD_CD = @[pod_cd]
#end
#if (${cstms_bat_no} != '')
                   AND LOG.CSTMS_BAT_NO = @[cstms_bat_no]
#end
#if (${scac_cd} != '')
                   AND LOG.SCAC_CD = @[scac_cd]
#end
#if (${bl_no} != '')
                   AND BLR.BL_NO = @[bl_no]
#end
#if (${fromd} != '')
                   AND LOG.RCV_DT >= TO_DATE(REPLACE(REPLACE(@[fromd], '-', ''), '/', '') ||' '|| REPLACE(REPLACE(@[fromt], ':', ''), '-',''),'YYYYMMDD HH24MI')
#end
#if (${tod} != '')
                   AND LOG.RCV_DT <= TO_DATE(REPLACE(REPLACE(@[tod], '-', ''), '/', '') ||' '|| REPLACE(REPLACE(@[tot], ':', ''), '-',''),'YYYYMMDD HH24MI')
#end
               ) LOG
         WHERE RNUM = 1
     ) TB
      ,BKG_CSTMS_ADV_BL BL
      ,BKG_CSTMS_ADV_RSLT RS
 WHERE TB.CNT_CD = BL.CNT_CD(+)
   AND TB.BL_NO  = BL.BL_NO(+)
   AND TB.CNT_CD = RS.CNT_CD(+)
   AND TB.BL_NO  = RS.BL_NO(+)
   AND TB.CSTMS_BAT_NO = RS.CSTMS_BAT_NO(+)
     )
 WHERE RNUM BETWEEN @[start_no] AND @[end_no]			]]></sql>
			<params>
				<param name="rcv_msg_tp_id" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="cstms_bat_no" type="12" value="" out="N"/>
				<param name="scac_cd" type="12" value="" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
				<param name="fromd" type="12" value="" out="N"/>
				<param name="fromt" type="12" value="" out="N"/>
				<param name="tod" type="12" value="" out="N"/>
				<param name="tot" type="12" value="" out="N"/>
				<param name="start_no" type="12" value="" out="N"/>
				<param name="end_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
