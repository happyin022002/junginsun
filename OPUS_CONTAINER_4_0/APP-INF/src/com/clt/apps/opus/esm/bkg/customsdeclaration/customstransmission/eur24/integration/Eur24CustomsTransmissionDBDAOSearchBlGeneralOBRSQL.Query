<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="Eur24CustomsTransmissionDBDAOSearchBlGeneralOBRSQL">
			<desc><![CDATA[Eur24CustomsTransmissionDBDAOSearchBlGeneralOBRSQL
* History
2012.06.07 김보배 [CHM-201218012] [BKG] [Spain EXS] Previous Doc Ref#관련 Subplace 항목추가 (MEDCUSRPL F/File, EXS F/File, EXS BL inquiry screen)]]></desc>
			<sql><![CDATA[
/*  Eur24BlinfoVO Eur24CustomsTransmissionDBDAOSearchBlGeneralOB ( String blNo , String vslCd , String skdVoyNo , String skdDirCd , String cstmsPortCd) */
SELECT
 DECODE(MSG_ID,'615','EXSDAT','EXSAMD') AS MSG_ID_CD     
,Z.*
FROM (
SELECT
 BL_NO||'.'||LPAD(PRN_SEQ,3,'0')||'.'||DECODE(MRN,NULL,'615','613') AS PRN /* 4 */
,DECODE(MRN,NULL,'615','613') AS MSG_ID
,BKG_GET_TOKEN_FNC(CTMS_SETUP,1) AS CT_NAME
,BKG_GET_TOKEN_FNC(CTMS_SETUP,2) AS CT_POSITION
,BKG_GET_TOKEN_FNC(CTMS_SETUP,3) AS CT_EMAIL
,BKG_GET_TOKEN_FNC(CTMS_SETUP,4) AS CT_TEL
,BKG_GET_TOKEN_FNC(CTMS_SETUP,5) AS CT_FAX
,BKG_GET_TOKEN_FNC(CTMS_SETUP,6) AS CUSTOMS_LODGE_OFC
,'XSUM' AS PREVIOUS_DOC_TYPE

,BKG_GET_TOKEN_FNC(PREVIOUS_DOC_INFO,1) AS PREVIOUS_DOC_REF
,BKG_GET_TOKEN_FNC(PREVIOUS_DOC_INFO,2) AS PRE_VSL_DCHG_YD_NM

,Y.*
FROM (
SELECT 
    (SELECT COUNT(*)+1 FROM BKG_CSTMS_EUR_IO_SND
     WHERE EUR_EDI_MSG_TP_ID ='EXS'
     AND BL_NO = X.BL_NO
    ) AS PRN_SEQ
   , X.MVMT_REF_NO AS MRN /* 7 */
   , VSL.LLOYD_NO AS TRANS_IDENTITY /* 11 */   
   , VSL.VSL_RGST_CNT_CD  AS TRANS_NATION /* 12 */       
   , VSL.VSL_ENG_NM AS VSL_NAME /* 13 */  
    
   , X.CSTMS_PORT_CD AS LOAD_LOC_CD /* 14 */
   , (SELECT LOC_NM FROM MDM_LOCATION WHERE LOC_CD = X.CSTMS_PORT_CD) AS LOAD_LOC_NAME /* 15 */
   , (SELECT DECODE(PORT_CD,'MTMAR','MT000113',A.EUR_CSTMS_OFC_ID) FROM BKG_CSTMS_EUR_CD_STUP A
       WHERE A.PORT_CD = X.CSTMS_PORT_CD  AND A.TML_CD IN ('ALL',X.CSTMS_YD_CD)
        AND ROWNUM=1 
      ) AS LOAD_OFC_CD /* 16 */ 

   , TO_CHAR(SKD1.VPS_ETD_DT,'yyyymmddhh24miss') AS LOAD_LOC_ETD /* 17 */   

   , X.POD_CD AS UNLOAD_LOC_CD /* 18 */
   , X.POD_NM AS UNLOAD_LOC_NAME /* 19 */
   , CASE WHEN VSL.CRR_CD = 'UAC' OR VSL.CRR_CD = 'HPL' THEN TO_CHAR(SKD2.INIT_ETA_DT,'yyyymmdd')||'120000'
          ELSE TO_CHAR(SKD2.INIT_ETA_DT,'yyyymmddhh24')||'0000'
     END AS UNLOAD_LOC_ETA /* 20 */     

   , '' AS UNLOAD_OFC_CD /* 21 */
   
   , (SELECT /*+ INDEX_DESC(K XAK4VSK_VSL_PORT_SKD) */ VPS_PORT_CD
       FROM VSK_VSL_PORT_SKD K
      WHERE K.VSL_CD = SKD2.VSL_CD
        AND K.SKD_VOY_NO = SKD2.SKD_VOY_NO
        AND K.SKD_DIR_CD = SKD2.SKD_DIR_CD
        AND K.CLPT_SEQ < SKD2.CLPT_SEQ
        AND ROWNUM = 1 
      ) AS PREV_LOC_CD /* 22 */

   , (SELECT /*+ INDEX(K XAK4VSK_VSL_PORT_SKD) */ VPS_PORT_CD
        FROM VSK_VSL_PORT_SKD K
        WHERE K.VSL_CD = SKD2.VSL_CD
          AND K.SKD_VOY_NO = SKD2.SKD_VOY_NO
          AND K.SKD_DIR_CD = SKD2.SKD_DIR_CD
          AND K.CLPT_SEQ > SKD2.CLPT_SEQ
          AND ROWNUM = 1 
      ) AS NEXT_LOC_CD /* 23 */
     

   , (SELECT /*+ INDEX(K XAK4VSK_VSL_PORT_SKD) */ B.LOC_NM
        FROM VSK_VSL_PORT_SKD K,MDM_LOCATION B
        WHERE K.VSL_CD = SKD2.VSL_CD
          AND K.SKD_VOY_NO = SKD2.SKD_VOY_NO
          AND K.SKD_DIR_CD = SKD2.SKD_DIR_CD
          AND K.CLPT_SEQ > SKD2.CLPT_SEQ
          AND K.VPS_PORT_CD= B.LOC_CD
          AND ROWNUM = 1 
       ) AS NEXT_LOC_NAME /* 24 */
    , (SELECT /*+ INDEX(K XAK4VSK_VSL_PORT_SKD) */ B.EUR_CSTMS_OFC_ID
        FROM VSK_VSL_PORT_SKD K,BKG_CSTMS_EUR_CD_STUP B
        WHERE K.VSL_CD = SKD2.VSL_CD
          AND K.SKD_VOY_NO = SKD2.SKD_VOY_NO
          AND K.SKD_DIR_CD = SKD2.SKD_DIR_CD
          AND K.CLPT_SEQ > SKD2.CLPT_SEQ
          AND B.PORT_CD = K.VPS_PORT_CD
		  AND B.TML_CD IN ('ALL',K.YD_CD)
          AND ROWNUM = 1 
       ) AS NEXT_OFC_CD  /*  25 */
	   ,(SELECT STUP.EUR_CSTMS_OFC_ID
FROM (SELECT *
      FROM(
            SELECT A.VSL_CD
            , A.SKD_VOY_NO
            , A.SKD_DIR_CD
            , SLAN_CD
            , A.VPS_PORT_CD AS EU_LAST_PORT
            , A.VPS_PORT_CD
            , A.EU_LAST_PORT_YD_CD
            , A.CLPT_SEQ
            , A.CLPT_IND_SEQ
               , CASE WHEN LAG( EU ) OVER (PARTITION BY A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD
                                                 ORDER BY A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.CLPT_SEQ DESC ) IS NULL
                             AND EU IS NOT NULL
                             AND CLPT_SEQ >1 
                            THEN 'EULAST'
                        END EU_FLAG
            FROM(
                 SELECT A.VSL_CD 
                    , A.SKD_VOY_NO
                    , A.SKD_DIR_CD
                    , SLAN_CD 
                    , A.VPS_PORT_CD 
                    , A.YD_CD          AS EU_LAST_PORT_YD_CD 
                    , ROW_NUMBER() OVER (PARTITION BY A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD
                                      ORDER BY A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.CLPT_SEQ ) AS CLPT_SEQ
                    , A.CLPT_IND_SEQ
                    , B.ATTR_CTNT1 EU
                    FROM VSK_VSL_PORT_SKD A
                    , BKG_CSTMS_CD_CONV_CTNT B
                    WHERE 1=1
                    AND A.VSL_CD = @[vsl_cd]
                    AND A.SKD_VOY_NO = @[skd_voy_no]
                    AND A.SKD_DIR_CD = @[skd_dir_cd]
                    AND NVL(SKD_CNG_STS_CD, 'X') <> 'S'
                    AND B.CSTMS_DIV_ID(+)='EU_MEMBER_CNT'
                    AND B.CNT_CD(+) = 'EU'
                    AND SUBSTR(A.VPS_PORT_CD, 1, 2) = B.ATTR_CTNT1(+) 
                    AND B.ATTR_CTNT1 IS NOT NULL
                    ) A
                 )SKD
				WHERE  SKD.EU_FLAG IS NOT NULL
        )SKD , BKG_CSTMS_EUR_CD_STUP STUP
        WHERE SKD.EU_LAST_PORT_YD_CD LIKE DECODE(STUP.TML_CD,'ALL','%',STUP.TML_CD)
        AND SUBSTR(STUP.EUR_CSTMS_OFC_ID,1,2) = SUBSTR(SKD.EU_LAST_PORT_YD_CD,1,2)) AS EU_LST_OFC_CD
  , X.BL_NO AS BLNBR /* 46 */
   , VSL.LLOYD_NO AS BL_TRANS_IDENTITY /* 47 */   
   , VSL.VSL_RGST_CNT_CD AS BL_TRANS_NATION/* 48 */      
   
   , X.POL_CD      AS  BLPOL         /* 49 */ 
   , POL_NM      AS  POL_FULLNAME  /* 50 */ 
   , X.POD_CD      AS  BLPOD         /* 51 */ 
   , POD_NM      AS  POD_FULLNAME  /* 52 */ 
   , (SELECT A.EUR_CSTMS_OFC_ID FROM BKG_CSTMS_EUR_CD_STUP A
       WHERE A.PORT_CD = X.POD_CD  AND A.TML_CD IN ('ALL',X.CSTMS_YD_CD)
        AND ROWNUM=1) AS POD_OFC_CD
   , X.DEL_CD      AS  BLDEL         /* 53 */ 
   , DEL_NM      AS  DEL_FULLNAME  /* 54 */ 
   , PCK_QTY     AS  BLPKG         /* 55 */ 
  , NVL((SELECT CSTMS_PCK_TP_CD
	   FROM BKG_CSTMS_PCK_TP_CONV
	  WHERE CNT_CD ='EU'
        AND RCVR_ID = 'ENS'
        AND PCK_TP_CD = X.PCK_TP_CD),X.PCK_TP_CD)  AS  BLPKGU  /* 56 */ 

   , MEAS_QTY    AS  BLMEA         /* 57 */ 
   , MEAS_UT_CD  AS  BLMEAU        /* 58 */ 
   , X.CMDT_CD     AS  COMMODITY     /* 59 */ 
   , TRSP_DOC_NO AS  TRANS_DOC_NO  /* 60 */
   , '' AS TRANS_DOC_NAME /* 61 */
   , '' AS CUSTOMS_STATUS_CD /* 62 */
   , '' AS PROCESS_INFO /* 63 */
   , '' AS PROCESS_TYPE /* 64 */
   , '' AS AEO_STATUS /* 65 */
   , '' AS PART_SHIPMENT /* 66 */
   , '' AS CONSIGN_PLACE /* 67 */
   , TO_CHAR(GLOBALDATE_PKG.TIME_LOCAL_FNC(CSTMS_PORT_CD),'YYYYMMDDHH24MISS') AS DECLARE_DATE /* 68 */
   , CSTMS_PORT_CD AS DECLARE_LOC /* 69 */
   , (SELECT LOC_NM FROM MDM_LOCATION 
       WHERE LOC_CD = X.CSTMS_PORT_CD
      ) AS DECLARE_LOC_NAME /* 70 */
   , '' AS PAYMENT_CD /* 71 */
   , DECODE( BKG.CUST_TO_ORD_FLG , 'Y','10600','') AS SPECIAL_REMARKS /* 74 */
   , BKG_SPCLCHAR_CONV_CLOB_FNC(CSTMS_DESC,'X') AS DESCS /* 93 */
    
 , BKG_JOIN_FULL_CLOB_FNC(CURSOR(SELECT BKG_SPCLCHAR_CONV_CLOB_FNC(MK_DESC,'X') FROM BKG_BOOKING A, BKG_BL_MK_DESC B
                             WHERE A.BL_NO = X.BL_NO
                               AND A.BKG_NO = B.BKG_NO
    ),'$@$') AS MARKNO /* 96 */

 , (SELECT  DECODE(PORT_CD,'MTMAR',CNTC_NM||','||CNTC_PSN_NM||','||CNTC_EML||','||CNTC_PHN_NO||','||CNTC_FAX_NO||','||'MT000113'
			,CNTC_NM||','||CNTC_PSN_NM||','||CNTC_EML||','||CNTC_PHN_NO||','||CNTC_FAX_NO||','||EUR_CSTMS_OFC_ID)
	 FROM BKG_CSTMS_EUR_CD_STUP
    WHERE PORT_CD = X.CSTMS_PORT_CD
	  AND TML_CD  IN ('ALL',X.CSTMS_YD_CD )
      AND ROWNUM =1 
     ) AS CTMS_SETUP

 , X.VSL_CD,     X.SKD_VOY_NO,  X.SKD_DIR_CD,  X.BL_NO,      CSTMS_PORT_CD
 , BKG_POL_CD,   BKG_POD_CD,    X.POL_CD,      X.POD_CD,     X.DEL_CD
 , POL_NM,       POD_NM,        DEL_NM,        PCK_QTY,      PCK_TP_CD
 , MEAS_QTY,     MEAS_UT_CD,    X.CMDT_CD,     TRSP_DOC_NO,  CSTMS_DECL_DT,  DECL_LOC_CD
 , X.CRE_USR_ID, X.CRE_DT,      X.UPD_USR_ID,  X.UPD_DT   
 , X.ACT_WGT,    X.WGT_UT_CD /* EXS ONLY */
 , X.CSTMS_YD_CD  AS LOAD_TMNL_LOC_CD  /* EXS ONLY */
, (SELECT YD_NM FROM MDM_YARD WHERE YD_CD = X.CSTMS_YD_CD ) AS LOAD_TMNL_NAME  /* EXS ONLY */

,(SELECT  
    NVL(DECODE(CNT_CD, 'ES', MF_NO || REF_GDS_ITM_NM, REF_GDS_ITM_NM),'') ||','||PRE_VSL_DCHG_YD_NM FROM BKG_CSTMS_EUR_CRN_RCV
	WHERE BL_NO =X.BL_NO AND MSG_FUNC_ID = 'F' AND ROWNUM = 1) AS PREVIOUS_DOC_INFO

FROM BKG_CSTMS_EUR_IO_BL X, MDM_VSL_CNTR VSL , VSK_VSL_PORT_SKD SKD1,VSK_VSL_PORT_SKD SKD2 , BKG_BOOKING BKG

WHERE X.VSL_CD =  VSL.VSL_CD
AND X.VSL_cD = SKD1.VSL_cD
AND X.SKD_VOY_NO =SKD1.SKD_VOY_NO
AND X.SKD_DIR_CD =SKD1.SKD_DIR_CD
AND X.POL_CD= SKD1.VPS_PORT_CD
AND SKD1.CLPT_IND_SEQ = 1

AND X.VSL_cD = SKD2.VSL_cD
AND X.SKD_VOY_NO =SKD2.SKD_VOY_NO
AND X.SKD_DIR_CD =SKD2.SKD_DIR_CD
AND X.CSTMS_PORT_CD= SKD2.VPS_PORT_CD
AND SKD2.CLPT_IND_SEQ = 1

AND X.BL_NO = BKG.BL_NO
AND X.BND_TP_CD = 'O'
AND X.VSL_CD   = @[vsl_cd]
AND X.SKD_VOY_NO = @[skd_voy_no]
AND X.SKD_DIR_CD = @[skd_dir_cd]
AND X.BL_NO      = @[bl_no]
AND X.CSTMS_PORT_CD = @[cstms_port_cd]

) Y
)Z			]]></sql>
			<params>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
				<param name="cstms_port_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
