<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="AGTAuditDBDAOModifyAGTCommForRequestRSQL">
			<desc><![CDATA[ModifyAGTCommForRequestSelect]]></desc>
			<sql><![CDATA[
SELECT
           @[bkg_no]               AS BKG_NO,
           @[ar_ofc_cd]            AS AR_OFC_CD,
           @[agn_cd]               AS AGN_CD,
           @[ac_seq]               AS AC_SEQ,
           @[upd_usr_id]           AS UPD_USR_ID,
           @[ac_rqst_usr_id]       AS AC_RQST_USR_ID,
           @[ac_rqst_usr_eml]      AS AC_RQST_USR_EML,
           ACT_IF_LOCL_COMM_AMT,
           COMM_VSL_CD,
           COMM_SKD_VOY_NO,
           COMM_SKD_DIR_CD,
           SVC_SCP_CD,
           IO_BND_CD,
           CURR_CD,
           AC_TP_CD,
           BKG_CRE_DT,
           XCH_RT_APLY_LVL,
         (     SELECT
                      NVL(X.INV_XCH_RT,0)
                 FROM INV_VVD_XCH_RT X
                WHERE X.VSL_CD         = A.COMM_VSL_CD
                  AND X.SKD_VOY_NO     = A.COMM_SKD_VOY_NO
                  AND X.SKD_DIR_CD     = A.COMM_SKD_DIR_CD
                  AND X.SVC_SCP_CD
                   IN
                    ( nvl(A.SVC_SCP_CD,'OTH')
                    )
                  AND X.IO_BND_CD      = A.IO_BND_CD
                  AND X.PORT_CD        = A.PORT_CD
                  AND X.LOCL_CURR_CD     = A.CURR_CD
                  AND X.CHG_CURR_CD        = 'USD'
         )                                                         AS VVD_XCH_RT,
         (     SELECT INV_XCH_RT
                 FROM INV_CUST_AND_DLY_XCH_RT
                WHERE CUST_CNT_CD   = 'XX'
                  AND CUST_SEQ      = 0
                  AND IO_BND_CD     = @[io_bnd_cd]
                  AND FM_DT    >= SUBSTR (A.SAIL_ARR_DT, 0, 8)
                  AND TO_DT    <= SUBSTR (A.SAIL_ARR_DT, 0, 8)
                  AND CHG_CURR_CD       = 'USD'
                  AND LOCL_CURR_CD  = A.CURR_CD
         )                                                         AS DLY_XCH_RT
      FROM
         (     SELECT
                      A.ACT_IF_LOCL_COMM_AMT,
                      A.COMM_VSL_CD,
  	                  A.COMM_SKD_VOY_NO,
                      A.COMM_SKD_DIR_CD,
                      B.SVC_SCP_CD,
                      A.IO_BND_CD,
                 CASE A.IO_BND_CD
                 WHEN 'O'
                 THEN
                 CASE D.CONTI_CD
                 WHEN 'E'
                 THEN NVL(C.PRE_RLY_PORT_CD, C.POL_CD)
                 ELSE C.POL_CD
                  END
                 ELSE
                 CASE D.CONTI_CD
                 WHEN 'E'
                 THEN NVL(C.PST_RLY_PORT_CD, C.POD_CD)
                 ELSE C.POD_CD
                  END
                  END                                    AS PORT_CD,
                      A.CURR_CD,
                      A.AC_TP_CD,
                      TO_CHAR(C.BKG_CRE_DT, 'YYYYMMDD')  AS BKG_CRE_DT,
                      A.XCH_RT_APLY_LVL,
                      A.SAIL_ARR_DT
                 FROM AGT_AGN_COMM        A,
                      AGT_COMM_BKG_INFO   B,
                      BKG_BOOKING         C,
                      MDM_LOCATION        D
                WHERE A.AGN_CD            = @[agn_cd]
                  AND A.BKG_NO            = @[bkg_no]
                  AND A.IO_BND_CD         = @[io_bnd_cd]
                  AND A.AC_TP_CD         <> 'T'         --OTHER COMMISSION은 제외
                  AND A.AC_SEQ            = @[ac_seq]
                  AND A.COMM_PROC_STS_CD  = 'CS'
                  AND A.CRE_USR_ID       != 'COST'
                  AND A.BKG_NO            = B.BKG_NO 
                  AND A.COMM_OCCR_INFO_CD = D.LOC_CD(+)  
                  AND A.BKG_NO            = C.BKG_NO(+)
         ) A			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="Y"/>
				<param name="ar_ofc_cd" type="12" value="" out="Y"/>
				<param name="agn_cd" type="12" value="" out="Y"/>
				<param name="ac_seq" type="12" value="" out="Y"/>
				<param name="upd_usr_id" type="12" value="" out="Y"/>
				<param name="ac_rqst_usr_id" type="12" value="" out="Y"/>
				<param name="ac_rqst_usr_eml" type="12" value="" out="Y"/>
				<param name="io_bnd_cd" type="12" value="" out="Y"/>
			</params>
		</query>
	</querys>
</sqls>
