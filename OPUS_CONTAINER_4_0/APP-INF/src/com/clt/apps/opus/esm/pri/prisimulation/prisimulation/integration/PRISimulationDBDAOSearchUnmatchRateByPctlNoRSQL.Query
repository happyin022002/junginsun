<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="PRISimulationDBDAOSearchUnmatchRateByPctlNoRSQL">
			<desc><![CDATA[PRISimulationDBDAOSearchUnmatchRateByPctlNoRSQL]]></desc>
			<sql><![CDATA[
WITH CHG AS
(
/* VERIFY - 'Y' */
 SELECT   
         AUTO_RAT_FLG
        ,PCTL_NO
        ,CNTR_SZ_CD
        ,SUBSTR(CNTR_SZ_CD,1,1) AS CNTR_TP_CD
        ,CMDT_CD
        ,CMDT_CD AS GRP_CMDT
        ,(SELECT CMDT_NM FROM MDM_COMMODITY M WHERE M.CMDT_CD = RT.CMDT_CD) AS CMDT_NM
        ,CMDT_SEQ
        ,RT_SEQ
        ,FRT_TERM_CD
        ,CGO_CATE_CD AS CGO_TP_CD
        ,IMDG_CLSS_CD
        ,CHG_CD
        ,CURR_CD
        ,RAT_UT_CD
        ,BKG_QTY
        ,RAT_AS_QTY
        ,CHG_UT_AMT
        ,CHG_AMT
        ,RCV_TERM_CD
        ,DE_TERM_CD
        ,FRT_INCL_XCLD_DIV_CD
        ,APLY_XCH_RTO
        ,NOTE_RT_SEQ
        ,PROP_NO
        ,AMDT_SEQ
--        ,SVC_SCP_CD
        ,GEN_SPCL_RT_TP_CD
        ,CMDT_HDR_SEQ
        ,ROUT_SEQ
        ,(SELECT TO_CHAR(RT_APLY_DT,'YYYYMMDD') FROM PRI_SIM_RT WHERE PCTL_NO = RT.PCTL_NO AND ROWNUM = 1) RT_APLY_DT
        ,ORG_INLND_HLG_AMT
        ,DEST_INLND_HLG_AMT
        ,ORG_ARB_AMT
        ,DEST_ARB_AMT
        ,SOC_FLG
   FROM PRI_SIM_CHG_RT RT
  WHERE PCTL_NO = @[pctl_no]
    AND CHG_CD = 'OFT'
    AND RT.AUTO_RAT_FLG ='Y'

UNION

/* UNMATCH - 'N' */
SELECT 
         AUTO_RAT_FLG
        ,PCTL_NO
        ,CNTR_SZ_CD
        ,SUBSTR(CNTR_SZ_CD,1,1) AS CNTR_TP_CD
        ,CMDT_CD
        ,CMDT_CD AS GRP_CMDT
        ,(SELECT CMDT_NM FROM MDM_COMMODITY M WHERE M.CMDT_CD = RT.CMDT_CD) AS CMDT_NM
        ,CMDT_SEQ
        ,RT_SEQ
        ,FRT_TERM_CD
        ,CGO_CATE_CD AS CGO_TP_CD
        ,IMDG_CLSS_CD
        ,CHG_CD
        ,CURR_CD
        ,RAT_UT_CD
        ,BKG_QTY
        ,RAT_AS_QTY
        ,CHG_UT_AMT
        ,CHG_AMT
        ,RCV_TERM_CD
        ,DE_TERM_CD
        ,FRT_INCL_XCLD_DIV_CD
        ,APLY_XCH_RTO
        ,NOTE_RT_SEQ
        ,PROP_NO
        ,AMDT_SEQ
--        ,SVC_SCP_CD
        ,GEN_SPCL_RT_TP_CD
        ,CMDT_HDR_SEQ
        ,ROUT_SEQ
        ,(SELECT TO_CHAR(RT_APLY_DT,'YYYYMMDD') FROM PRI_SIM_RT WHERE PCTL_NO = RT.PCTL_NO AND ROWNUM = 1) RT_APLY_DT
        ,ORG_INLND_HLG_AMT
        ,DEST_INLND_HLG_AMT
        ,ORG_ARB_AMT
        ,DEST_ARB_AMT
        ,SOC_FLG
   FROM PRI_SIM_CHG_RT RT
  WHERE PCTL_NO = @[pctl_no]
    AND CHG_CD = 'OFT'
    AND RT.AUTO_RAT_FLG ='N'
    AND NOT EXISTS (SELECT 'Y' FROM PRI_SIM_CHG_RT RT1
                    WHERE 1=1
                      AND RT1.CHG_CD ='OFT'
                      AND RT1.PCTL_NO = RT.PCTL_NO
                      AND RT1.CNTR_SZ_CD = RT.CNTR_SZ_CD
                      AND RT1.CMDT_CD = RT.CMDT_CD
                      AND RT1.CGO_CATE_CD = RT.CGO_CATE_CD
                      AND RT1.CHG_CD = RT.CHG_CD
                      AND RT1.CURR_CD = RT.CURR_CD
                      AND RT1.RAT_UT_CD = RT.RAT_UT_CD
                      AND RT1.CHG_AMT = RT.CHG_AMT
                      AND RT1.RCV_TERM_CD = RT.RCV_TERM_CD
                      AND RT1.DE_TERM_CD = RT.DE_TERM_CD
                      AND RT1.AUTO_RAT_FLG ='Y'
        )
)


SELECT X.*
      ,X.BASE_RT+X.SCHG_RT AS TTL_RT
  FROM (
    SELECT OFT.*
              ,OFT.OFT_CNTR_SZ_CD AS ORG_CNTR_SZ_CD
              ,(SELECT CNTR_SZ_CD ||'0' 
                  FROM MDM_CNTR_TP_SZ 
                 WHERE CNTR_TPSZ_CD = OFT.OFT_CNTR_SZ_CD 
                   AND DELT_FLG = 'N'
                   AND ROWNUM =1 ) AS CNTR_SZ_CD
          ,ROUND(OFT.APLY_XCH_RTO * OFT.CHG_AMT,2) AS BASE_RT
          ,(SELECT NVL(SUM(OTH.APLY_XCH_RTO * OTH.CHG_AMT),0)
              FROM PRI_SIM_CHG_RT OTH
             WHERE OFT.PCTL_NO = OTH.PCTL_NO
               AND OFT.OFT_CNTR_SZ_CD = OTH.CNTR_SZ_CD
               AND OFT.GRP_CMDT = OTH.CMDT_CD
               AND OFT.CMDT_SEQ = OTH.CMDT_SEQ
               AND OFT.AUTO_RAT_FLG = OTH.AUTO_RAT_FLG
               AND OTH.CHG_CD <> 'OFT'
               AND OTH.RAT_UT_CD NOT IN ('CM','MT')--금액은 의미없음
               AND OTH.FRT_INCL_XCLD_DIV_CD = 'N'
           ) AS SCHG_RT
          ,NVL((SELECT 'Y'
              FROM PRI_SIM_CHG_RT OTH
             WHERE OFT.PCTL_NO = OTH.PCTL_NO
               AND OFT.OFT_CNTR_SZ_CD = OTH.CNTR_SZ_CD
               AND OFT.GRP_CMDT = OTH.CMDT_CD
               AND OFT.CMDT_SEQ = OTH.CMDT_SEQ
               AND OFT.AUTO_RAT_FLG = OTH.AUTO_RAT_FLG
               AND OTH.CHG_CD = 'GOH'
               AND OTH.FRT_INCL_XCLD_DIV_CD = 'N'
           ),'N') AS GOH_YN
          ,(SELECT NVL(SUM(OTH.APLY_XCH_RTO * OTH.CHG_AMT),0)
              FROM PRI_SIM_CHG_RT OTH
             WHERE OFT.PCTL_NO = OTH.PCTL_NO
               AND OFT.OFT_CNTR_SZ_CD = OTH.CNTR_SZ_CD
               AND OFT.GRP_CMDT = OTH.CMDT_CD
               AND OFT.CMDT_SEQ = OTH.CMDT_SEQ
               AND OFT.AUTO_RAT_FLG = OTH.AUTO_RAT_FLG
               AND OTH.CHG_CD = 'GOH'
               AND OTH.FRT_INCL_XCLD_DIV_CD = 'N'
           ) AS GOH_AMT
      FROM (
    /* grp cmdt */
            SELECT CHG.AUTO_RAT_FLG
                  ,CHG.PCTL_NO
                  ,CHG.CNTR_SZ_CD AS OFT_CNTR_SZ_CD
                  ,CHG.CNTR_TP_CD
                  ,GRP.CMDT_CD
                  ,GRP.GRP_CMDT
                  ,GRP.CMDT_NM
                  ,CHG.CMDT_SEQ
                  ,CHG.RT_SEQ
                  ,CHG.FRT_TERM_CD
                  ,CHG.CGO_TP_CD
                  ,CHG.IMDG_CLSS_CD
                  ,CHG.CHG_CD
                  ,CHG.CURR_CD
                  ,CHG.RAT_UT_CD
                  ,CHG.BKG_QTY
                  ,CHG.RAT_AS_QTY
                  ,CHG.CHG_UT_AMT
                  ,CHG.CHG_AMT
                  ,CHG.RCV_TERM_CD
                  ,CHG.DE_TERM_CD
                  ,CHG.FRT_INCL_XCLD_DIV_CD
                  ,CHG.APLY_XCH_RTO
                  ,CHG.NOTE_RT_SEQ
                  ,CHG.PROP_NO
                  ,CHG.AMDT_SEQ
--                  ,CHG.SVC_SCP_CD
                  ,CHG.GEN_SPCL_RT_TP_CD
                  ,CHG.CMDT_HDR_SEQ
                  ,CHG.ROUT_SEQ
                  ,CHG.RT_APLY_DT
                  ,CHG.ORG_INLND_HLG_AMT
                  ,CHG.DEST_INLND_HLG_AMT
                  ,CHG.ORG_ARB_AMT
                  ,CHG.DEST_ARB_AMT
                  ,CHG.SOC_FLG
              FROM CHG
                   ,(SELECT G.PRC_GRP_CMDT_CD AS GRP_CMDT,
                            D.PRC_CMDT_DEF_CD AS CMDT_CD,
                            (SELECT CMDT_NM FROM MDM_COMMODITY WHERE CMDT_CD = D.PRC_CMDT_DEF_CD) AS CMDT_NM
#if (${ctrt_tp} == 'S') 
                      FROM    PRI_SP_SCP_GRP_CMDT     G ,
                              PRI_SP_SCP_GRP_CMDT_DTL D
#else
                      FROM    PRI_RP_SCP_GRP_CMDT     G ,
                              PRI_RP_SCP_GRP_CMDT_DTL D
#end
                     WHERE D.PROP_NO         = G.PROP_NO
                       AND D.AMDT_SEQ        = G.AMDT_SEQ
                       AND D.SVC_SCP_CD      = G.SVC_SCP_CD
                       AND D.GRP_CMDT_SEQ    = G.GRP_CMDT_SEQ
                       AND D.SRC_INFO_CD     <> 'AD'
                       AND (D.PROP_NO, D.AMDT_SEQ, D.SVC_SCP_CD) = (SELECT PROP_NO, AMDT_SEQ, SVC_SCP_CD 
                                                                      FROM PRI_SIM_CHG_RT C 
                                                                     WHERE C.PCTL_NO = @[pctl_no]
                                                                       AND C.CHG_CD = 'OFT'
                                                                       AND C.PROP_NO IS NOT NULL
                                                                       AND ROWNUM=1)
                    )   GRP
             WHERE 1=1
               AND CHG.CMDT_CD = GRP.GRP_CMDT
               AND CHG.CMDT_CD LIKE 'G%'
               
        UNION ALL
    
    /* individual */  
            SELECT CHG.*
              FROM CHG
             WHERE 1=1
               AND CHG.CMDT_CD NOT LIKE 'G%'
    
    ) OFT
) X
 WHERE CNTR_SZ_CD IS NOT NULL
#if (${cmdt_cd} != '') 
   AND CMDT_CD = @[cmdt_cd]
#end
ORDER BY PCTL_NO, AUTO_RAT_FLG DESC, CMDT_NM, CMDT_CD, ORG_CNTR_SZ_CD, CMDT_SEQ			]]></sql>
			<params>
				<param name="pctl_no" type="12" value="" out="N"/>
				<param name="cmdt_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
