<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="GeneralBookingSearchDBDAOSearchCustomsHistRSQL">
			<desc><![CDATA[GeneralBookingSearchDBDAOSearchCustomsHistRSQL]]></desc>
			<sql><![CDATA[
SELECT  DECODE(SUBSTR(T.PORT,0,2),'US','USAMS','CA','Canada AIC',T.PORT) AS PORT
,       T.PORT_NM
,       XDT.BY_SEQ
,       DECODE(XDT.BY_SEQ,1,T.DOWNLOAD_FLAG,T.CUST_STATUS) AS CUST_STATUS
,       DECODE(XDT.BY_SEQ,1,T.DOWNLOAD_FLAG,NVL(T.CUST_STATUS_NM,'Manifest Transmit')) AS CUST_STATUS_NM
,       DECODE(XDT.BY_SEQ,1,T.DOWNLOAD_DT,T.MF_SND_DT) AS MF_SND_DT
,       DECODE(XDT.BY_SEQ,1,T.GMT_DOWNLOAD_DT,T.GMT_MF_SND_DT) AS GMT_DT
,		NVL((SELECT USR.USR_NM  
               FROM COM_USER USR 
              WHERE UPPER(USR.USR_ID) = UPPER(DECODE(XDT.BY_SEQ, 1, T.DOWN_USR_ID, T.SEND_USER_ID))
                AND NVL(USE_FLG, 'Y') = 'Y'
                AND ROWNUM = 1),DECODE(XDT.BY_SEQ, 1, T.DOWN_USR_ID, T.SEND_USER_ID))  CRE_USR_ID
,       DECODE(XDT.BY_SEQ, 1, T.DOWN_OFC_NM, T.SEND_OFC_NM) AS OFC_NM
FROM  ( 
SELECT CS.CSTMS_PORT_CD AS PORT
      ,(SELECT M.LOC_NM
        FROM   MDM_LOCATION M
        WHERE  M.LOC_CD = CS.CSTMS_PORT_CD) PORT_NM
      ,DECODE(IF_DT,NULL,'','DownLoad') DOWNLOAD_FLAG
      ,TO_CHAR(IF_DT, 'YYYY-MM-DD HH24:MI') DOWNLOAD_DT
	  ,TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC('USNYC',IF_DT, 'GMT'), 'YYYY-MM-DD HH24:MI') GMT_DOWNLOAD_DT
      ,CS.CSTMS_MF_TP_CD CUST_STATUS
      ,(SELECT B.INTG_CD_VAL_DESC
        FROM   COM_INTG_CD_DTL B
        WHERE  INTG_CD_ID = 'CD02235' AND
               B.INTG_CD_VAL_CTNT = CS.CSTMS_MF_TP_CD) CUST_STATUS_NM
      ,TO_CHAR(DECODE(CS.CSTMS_MF_TP_CD,'MI',CS.MF_SND_DT,CS.AMDT_SND_DT),'YYYY-MM-DD HH24:MI') MF_SND_DT
      ,TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC('USNYC',DECODE(CS.CSTMS_MF_TP_CD,'MI',CS.MF_SND_DT,CS.AMDT_SND_DT), 'GMT'), 'YYYY-MM-DD HH24:MI') GMT_MF_SND_DT
      ,CS.CRE_USR_ID AS DOWN_USR_ID
      ,U.CRE_USR_ID AS SEND_USER_ID
      ,(SELECT OFC.OFC_CD FROM COM_USER OFC WHERE OFC.USR_ID = CS.CRE_USR_ID) AS DOWN_OFC_NM
      ,(SELECT OFC.OFC_CD FROM COM_USER OFC WHERE OFC.USR_ID = U.CRE_USR_ID) AS SEND_OFC_NM
FROM   BKG_CSTMS_ADV_BL CS,
	   ( SELECT DISTINCT L.CNT_CD,
						 L.SND_DT AS SND_DATE,
						 L.TRSM_MSG_TP_ID,
						 L.SND_USR_ID CRE_USR_ID,
						 L.SND_USR_OFC_CD OFC_CD,
						 E.BL_NO
		 FROM BKG_CSTMS_ADV_SND_LOG L,
			  BKG_CSTMS_ADV_EDI_BL_RSPN E
		 WHERE 1=1
		   AND L.CNT_CD = E.CNT_CD(+)
		   AND L.CRR_BAT_NO = E.CRR_BAT_NO(+)
		   AND L.IO_BND_CD ='I'
		   AND E.BL_NO = (SELECT BL_NO FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no])
		   AND L.SND_DT IN (SELECT MAX(SND_DT)
							FROM BKG_CSTMS_ADV_SND_LOG L,
								 BKG_CSTMS_ADV_EDI_BL_RSPN E
						    WHERE L.IO_BND_CD = 'I'
							  AND L.CNT_CD = E.CNT_CD(+)
							  AND L.CRR_BAT_NO = E.CRR_BAT_NO(+)
							  AND E.BL_NO = (SELECT BL_NO FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no])
						    )
		) U
WHERE  CS.BL_NO = (SELECT BL_NO FROM BKG_BOOKING WHERE BKG_NO = @[bkg_no])
  AND  CS.BL_NO = U.BL_NO
) T
,(SELECT ROWNUM BY_SEQ
        FROM   DUAL
        CONNECT BY LEVEL <= 2) XDT
ORDER BY   T.PORT,XDT.BY_SEQ			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
