<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="IndiaManifestListDownloadDBDAOsearchIndiaManifestListByVvdPortRSQL">
			<desc><![CDATA[신고대상을 조회해 온다.- H/BL도 대상임]]></desc>
			<sql><![CDATA[
SELECT
        '' 						IGM_NO 	/* 상위 배정보 VO 생성을 위해 */
        ,''						IGM_DATE/* 상위 배정보 VO 생성을 위해 */
        ,''						VSL_NM 	/* 상위 배정보 VO 생성을 위해 */
        ,''						ETA_DT 	/* 상위 배정보 VO 생성을 위해 */
        ,BL_NO
        ,MERGE_BL_NO
        ,SUM(C_BL_NO) OVER (ORDER BY ENTRY_TP, DEL_CD, POL_CD, BL_NO, HBL_NO, HBL_IND) GROUP_SEQ 
        ,HBL_NO
        ,POL_CD
        ,POD_CD
        ,POD_NOD_CD
        ,DEL_CD
        ,DEL_NOD_CD
        ,ENTRY_TP
        ,DEST_CD
        ,CFS_CD
        ,IAL
        ,MODE_TRANS
        ,CUSTOMER_NAME
        ,BL_CUST_TP
        ,HBL_IND
        ,BCD_DESC
        ,ITEM_TP
        ,BD_AREA_CD
        ,TRNS_OPR_ID
        ,IDA_LINE_NO
        ,VVD_CD
        ,DOWN_CHECK
FROM
(
	SELECT
	    SUB1.BL_NO              BL_NO
	    ,SUB1.BL_NO             MERGE_BL_NO
	    ,SUB1.HBL_NO        	HBL_NO
	    ,SUB1.POL_CD        	POL_CD
	    ,SUB1.POD_CD        	POD_CD
		,SUBSTR(SUB1.POD_NOD_CD, 6, 2)        POD_NOD_CD
	    ,SUB1.DEL_CD        	DEL_CD
		,SUBSTR(SUB1.DEL_NOD_CD, 6, 2)        DEL_NOD_CD
	    ,DECODE(NVL(BCIB.NVOCC_REF_NO,''), '', NVL(SUB1.ENTRY_TP,''), BCIB.BL_DECL_TP_CD) ENTRY_TP
	    ,DECODE(NVL(BCIB.NVOCC_REF_NO,''), '', NVL(SUB1.DEST_CD,''), BCIB.IDA_DEST_CD) DEST_CD
	    ,DECODE(NVL(BCIB.NVOCC_REF_NO,''), '', NVL(SUB1.CFS_CD,''), BCIB.IDA_CFS_ID) CFS_CD
	    ,DECODE(NVL(BCIB.NVOCC_REF_NO,''), '', NVL(SUB1.IAL,''), BCIB.IAL_RGN_CD) IAL
	    ,DECODE(NVL(BCIB.NVOCC_REF_NO,''), '', NVL(SUB1.MODE_TRANS,''), BCIB.IDA_TRSP_CD) MODE_TRANS
	    ,DECODE(NVL(BCIB.NVOCC_REF_NO,''), '', NVL(SUB1.CUSTOMER_NAME,''), BCIB.CNEE_NM) CUSTOMER_NAME
	    ,DECODE(NVL(BCIB.NVOCC_REF_NO,''), '', NVL(SUB1.BL_CUST_TP,''), BCIB.IDA_CSTMS_BL_TP_CD)   	BL_CUST_TP
	    ,SUB1.HBL_IND       	HBL_IND
	    ,SUB1.BCD_DESC   	    BCD_DESC
	    ,DECODE(DECODE(NVL(BCIB.NVOCC_REF_NO, ''), '', NVL(SUB1.ITEM_TP, ''), BCIB.IDA_CSTMS_ITM_TP_CD), '', 'O', BCIB.IDA_CSTMS_ITM_TP_CD)  ITEM_TP
		,DECODE(NVL(BCIB.NVOCC_REF_NO, ''), '',SUB1.CFS_BOND_CD, BCIB.BD_AREA_CD)   	BD_AREA_CD
	    ,DECODE(NVL(BCIB.NVOCC_REF_NO,''), '', SUB1.TRNS_OPR_ID, BCIB.TRNS_OPR_ID)    	TRNS_OPR_ID
	    ,BCIB.IDA_LINE_NO       IDA_LINE_NO
		,@[vvd_cd]	VVD_CD	
		,DECODE(BCIB.VSL_CD||BCIB.SKD_VOY_NO||BCIB.SKD_DIR_CD||BCIB.POD_CD||BCIB.BL_NO||BCIB.NVOCC_REF_NO, '', 'N', 'Y') DOWN_CHECK
		,DECODE(LAG(SUB1.BL_NO) OVER ( ORDER BY SUB1.ENTRY_TP, SUB1.DEL_CD, SUB1.POL_CD, SUB1.BL_NO, SUB1.HBL_NO, SUB1.HBL_IND) , SUB1.BL_NO, 0, 1) C_BL_NO
	FROM
	    (
	    SELECT 
	            DISTINCT BB.BL_NO BL_NO
	            ,DECODE(BH.HBL_NO, '', BB.BL_NO, BH.HBL_NO) HBL_NO
	            ,BB.POL_CD                             POL_CD
                ,BB.POD_CD                             POD_CD
                ,BB.POD_NOD_CD                         POD_NOD_CD              
                ,BB.DEL_CD                             DEL_CD
                ,BB.DEL_NOD_CD                         DEL_NOD_CD
	            ,'LC'                                  ENTRY_TP
                ,(
                    SELECT DECODE(COUNT(OTR_DCHG_CD), 1, MIN(OTR_DCHG_CD), BCIV.OTR_DCHG_YD_ID)
                    FROM BKG_DCHG_LOC
                    WHERE 1=1
                    AND NVL(LOC_CD , ' ') LIKE 'IN' || '%'
                    AND LOC_CD = BB.DEL_CD
					AND YD_CD = BB.DEL_NOD_CD
                 ) DEST_CD

	    		,BCIV.IDA_CFS_ID                       CFS_CD
	    		,''                                    IAL
	    		,''                                    MODE_TRANS
	    		,REPLACE(REPLACE(BC.CUST_NM, CHR(10), ''),CHR(9),' ') CUSTOMER_NAME
	    		,BB.KR_CSTMS_CUST_TP_CD                BL_CUST_TP
	    		,DECODE(BH.HBL_NO, '', '00', BH.HBL_SEQ)   HBL_IND
	    		,REPLACE(REPLACE(DECODE(BH.HBL_NO, '', SUBSTR(BBD.CSTMS_DESC, 1, 44), SUBSTR(BH.BL_GDS_DESC, 1, 44)), CHR(10), ''),CHR(9),' ') BCD_DESC
	    		,''                                 ITEM_TP
				,''									CFS_BOND_CD
	    		,''				                    TRNS_OPR_ID
	    		,BCIV.VSL_CD                        VSL_CD
	    		,BCIV.SKD_VOY_NO                    SKD_VOY_NO
	    		,BCIV.SKD_DIR_CD                    SKD_DIR_CD
	    FROM    BKG_BOOKING BB
	            ,MDM_CUSTOMER MC
	            ,BKG_CUSTOMER BC    
	            ,BKG_BL_DOC BBD
	            ,BKG_BL_MK_DESC BBMD
	            ,BKG_HBL BH
	            ,BKG_CSTMS_IDA_VSL BCIV
	            ,(SELECT	BKG_VVD.BKG_NO
	    					,BKG_VVD.VSL_CD
	        		FROM	BKG_VVD
	        		WHERE	BKG_VVD.VSL_CD        = SUBSTR(@[vvd_cd], 1, 4)
	        		AND	BKG_VVD.SKD_VOY_NO        = SUBSTR(@[vvd_cd], 5, 4)
	        		AND	BKG_VVD.SKD_DIR_CD        = SUBSTR(@[vvd_cd], 9, 1)
	        		AND	BKG_VVD.POD_CD           = @[pod_cd]
				) BV
	    WHERE	BB.POD_CD                 = @[pod_cd]
		#if (${empty_check} != 'on') 
	    AND     BB.BKG_CGO_TP_CD         <>  'P'
		#end
	    AND	    BB.BKG_STS_CD		      <> 'X'
	    AND	    BB.POD_CD		        = BB.DEL_CD
	    AND	    BB.BKG_NO		        = BV.BKG_NO
	    AND	    BB.BKG_NO		        = BBD.BKG_NO
	    AND	    BB.BKG_NO               = BBMD.BKG_NO(+)
	    AND	    BB.BKG_NO               = BH.BKG_NO(+)
	    AND	    BC.BKG_NO		        = BB.BKG_NO
	    AND	    BC.BKG_CUST_TP_CD       = 'C'
	    AND	    MC.CUST_CNT_CD(+)       = BC.CUST_CNT_CD
	    AND	    MC.CUST_SEQ(+)          = BC.CUST_SEQ

	    AND	    BCIV.VSL_CD             = SUBSTR(@[vvd_cd], 1, 4)
	    AND	    BCIV.SKD_VOY_NO         = SUBSTR(@[vvd_cd], 5, 4)
	    AND	    BCIV.SKD_DIR_CD         = SUBSTR(@[vvd_cd], 9, 1)
	    AND	    BCIV.POD_CD             = @[pod_cd]
	#if (${pol_cd} != '') 
	    AND	    BB.POL_CD               LIKE @[pol_cd] || '%'
	#end
	    AND     ( 1 <= (   SELECT COUNT(HBL_NO)
	                    FROM BKG_HBL A
	                    WHERE BB.BKG_NO = A.BKG_NO )  OR
	            0 = (   SELECT COUNT(HBL_NO)
	                    FROM BKG_HBL A
	                    WHERE BB.BKG_NO = A.BKG_NO) )
	                    
	    UNION ALL
	    
	    SELECT 
	            DISTINCT BB.BL_NO BL_NO
	            ,DECODE(BH.HBL_NO, '', BB.BL_NO, BH.HBL_NO) HBL_NO
	            ,BB.POL_CD                             POL_CD
                ,BB.POD_CD                             POD_CD
                ,BB.POD_NOD_CD                         POD_NOD_CD              
                ,BB.DEL_CD                             DEL_CD
                ,BB.DEL_NOD_CD                         DEL_NOD_CD
	            ,'TI'                                  ENTRY_TP
                ,(
                    SELECT DECODE(COUNT(OTR_DCHG_CD), 1, MIN(OTR_DCHG_CD), BCIV.OTR_DCHG_YD_ID)
                    FROM BKG_DCHG_LOC
                    WHERE 1=1
                    AND NVL(LOC_CD , ' ') LIKE 'IN' || '%'
                    AND LOC_CD = BB.DEL_CD
					AND YD_CD = BB.DEL_NOD_CD
                 ) DEST_CD

				,''                                    CFS_CD
	    		,''                                    IAL
	    		,'T'                                    MODE_TRANS
	    		,REPLACE(REPLACE(BC.CUST_NM, CHR(10), ''),CHR(9),' ') CUSTOMER_NAME
	    		,BB.KR_CSTMS_CUST_TP_CD                BL_CUST_TP
	    		,DECODE(BH.HBL_NO, '', '00', BH.HBL_SEQ)   HBL_IND
	    		,REPLACE(REPLACE(DECODE(BH.HBL_NO, '', SUBSTR(BBD.CSTMS_DESC, 1, 44), SUBSTR(BH.BL_GDS_DESC, 1, 44)), CHR(10), ''),CHR(9),' ') BCD_DESC
	    		,''                                 ITEM_TP
				  ,''																	CFS_BOND_CD
	    		,BCIV.TRNS_OPR_ID                   TRNS_OPR_ID
	    		,BCIV.VSL_CD                        VSL_CD
	    		,BCIV.SKD_VOY_NO                    SKD_VOY_NO
	    		,BCIV.SKD_DIR_CD                    SKD_DIR_CD
	    FROM    BKG_BOOKING BB
	            ,MDM_CUSTOMER MC
	            ,BKG_CUSTOMER BC    
	            ,BKG_BL_DOC BBD
	            ,BKG_BL_MK_DESC BBMD
	            ,BKG_HBL BH
	            ,BKG_CSTMS_IDA_VSL BCIV
	            ,BKG_DCHG_LOC BDL
	            ,(SELECT	BKG_VVD.BKG_NO
	    					,BKG_VVD.VSL_CD
	        		FROM	BKG_VVD
	        		WHERE	BKG_VVD.VSL_CD        = SUBSTR(@[vvd_cd], 1, 4)
	        		AND	BKG_VVD.SKD_VOY_NO        = SUBSTR(@[vvd_cd], 5, 4)
	        		AND	BKG_VVD.SKD_DIR_CD        = SUBSTR(@[vvd_cd], 9, 1)
	        		AND	BKG_VVD.POD_CD           = @[pod_cd]
				) BV
	    WHERE	BB.POD_CD                 = @[pod_cd]
		#if (${empty_check} != 'on') 
	    AND     BB.BKG_CGO_TP_CD          <> 'P'
		#end
	    AND	    BB.BKG_STS_CD		      <> 'X'
	    AND	    BB.POD_CD		        <> BB.DEL_CD
	    AND	    BB.BKG_NO		        = BV.BKG_NO
	    AND	    BB.BKG_NO		        = BBD.BKG_NO
	    AND	    BB.BKG_NO               = BBMD.BKG_NO(+)
	    AND	    BB.BKG_NO               = BH.BKG_NO(+)
	    AND	    BC.BKG_NO		        = BB.BKG_NO
	    AND     BB.DEL_CD               = BDL.OTR_DCHG_CD(+)
	    AND     BB.DEL_CD||BB.DEL_NOD_CD = BDL.YD_CD(+)
	    AND	    BC.BKG_CUST_TP_CD       = 'C'
	    AND	    MC.CUST_CNT_CD(+)       = BC.CUST_CNT_CD
	    AND	    MC.CUST_SEQ(+)          = BC.CUST_SEQ

	    AND	    BCIV.VSL_CD             = SUBSTR(@[vvd_cd], 1, 4)
	    AND	    BCIV.SKD_VOY_NO         = SUBSTR(@[vvd_cd], 5, 4)
	    AND	    BCIV.SKD_DIR_CD         = SUBSTR(@[vvd_cd], 9, 1)
	    AND	    BCIV.POD_CD             = @[pod_cd]
	#if (${pol_cd} != '') 
	    AND	    BB.POL_CD               LIKE @[pol_cd] || '%'
	#end
	    AND     ( 1 <= (   SELECT COUNT(HBL_NO)
	                    FROM BKG_HBL A
	                    WHERE BB.BKG_NO = A.BKG_NO )  OR
	            0 = (   SELECT COUNT(HBL_NO)
	                    FROM BKG_HBL A
	                    WHERE BB.BKG_NO = A.BKG_NO ) )
	                    
	    UNION ALL
	    
	    SELECT 
	            DISTINCT BB.BL_NO BL_NO
	            ,DECODE(BH.HBL_NO, '', BB.BL_NO, BH.HBL_NO) HBL_NO
	            ,BB.POL_CD                             POL_CD
                ,BB.POD_CD                             POD_CD
                ,BB.POD_NOD_CD                         POD_NOD_CD              
                ,BB.DEL_CD                             DEL_CD
                ,BB.DEL_NOD_CD                         DEL_NOD_CD
	            ,'TC'                                  ENTRY_TP
                ,(
                    SELECT DECODE(COUNT(OTR_DCHG_CD), 1, MIN(OTR_DCHG_CD), BCIV.OTR_DCHG_YD_ID)
                    FROM BKG_DCHG_LOC
                    WHERE 1=1
                    AND NVL(LOC_CD , ' ') LIKE 'IN' || '%'
                    AND LOC_CD = BB.DEL_CD
					AND YD_CD = BB.DEL_NOD_CD
                 ) DEST_CD
	    		
				,''                                    CFS_CD
	    		,''                                    IAL
	    		,''                                    MODE_TRANS
	    		,REPLACE(REPLACE(BC.CUST_NM, CHR(10), ''),CHR(9),' ') CUSTOMER_NAME
	    		,BB.KR_CSTMS_CUST_TP_CD                BL_CUST_TP
	    		,DECODE(BH.HBL_NO, '', '00', BH.HBL_SEQ)   HBL_IND
	    		,REPLACE(REPLACE(DECODE(BH.HBL_NO, '', SUBSTR(BBD.CSTMS_DESC, 1, 44), SUBSTR(BH.BL_GDS_DESC, 1, 44)), CHR(10), ''),CHR(9),' ') BCD_DESC
	    		,''                                 ITEM_TP
				  ,''																	CFS_BOND_CD
	    		,BCIV.TRNS_OPR_ID                   TRNS_OPR_ID
	    		,BCIV.VSL_CD                        VSL_CD
	    		,BCIV.SKD_VOY_NO                    SKD_VOY_NO
	    		,BCIV.SKD_DIR_CD                    SKD_DIR_CD
	    FROM    BKG_BOOKING BB
	            ,MDM_CUSTOMER MC
	            ,BKG_CUSTOMER BC    
	            ,BKG_BL_DOC BBD
	            ,BKG_BL_MK_DESC BBMD
	            ,BKG_HBL BH
	            ,BKG_CSTMS_IDA_VSL BCIV
	            ,(SELECT	BKG_VVD.BKG_NO
	    					,BKG_VVD.VSL_CD
	        		FROM	BKG_VVD
	        		WHERE	BKG_VVD.VSL_CD        = SUBSTR(@[vvd_cd], 1, 4)
	        		AND	BKG_VVD.SKD_VOY_NO        = SUBSTR(@[vvd_cd], 5, 4)
	        		AND	BKG_VVD.SKD_DIR_CD        = SUBSTR(@[vvd_cd], 9, 1)
	        		AND	BKG_VVD.POD_CD           = @[pod_cd]
				) BV
	            ,(  
	                SELECT  A.BKG_NO
	                FROM
	                   (
	                      SELECT   BKG_BOOKING.BKG_NO
	                      FROM     BKG_BOOKING
	                               ,BKG_VVD
	                               ,(
	                               SELECT  BKG_VVD.BKG_NO
	                                       ,BKG_VVD.POL_CD
	                                       ,BKG_VVD.POD_CD
	                               FROM    BKG_VVD
	                               WHERE   BKG_VVD.VSL_CD          	= SUBSTR(@[vvd_cd], 1, 4)
	                                AND    BKG_VVD.SKD_VOY_NO       = SUBSTR(@[vvd_cd], 5, 4)
	                                AND    BKG_VVD.SKD_DIR_CD       = SUBSTR(@[vvd_cd], 9, 1)
	                                AND    BKG_VVD.POL_CD         IN (  	SELECT VPS_PORT_CD FROM VSK_VSL_PORT_SKD
	                                                                        WHERE  VSL_CD            = SUBSTR(@[vvd_cd], 1, 4)
	                                                                        AND    SKD_VOY_NO        = SUBSTR(@[vvd_cd], 5, 4)
	                                                                        AND    SKD_DIR_CD        = SUBSTR(@[vvd_cd], 9, 1)
	                                                                        AND    CLPT_SEQ     <   (
	                                                                                                     SELECT  MAX(CLPT_SEQ)    FROM    VSK_VSL_PORT_SKD
	                                                                                                     WHERE   VSL_CD        = SUBSTR(@[vvd_cd], 1, 4)
	                                                                                                     AND    SKD_VOY_NO     = SUBSTR(@[vvd_cd], 5, 4)
	                                                                                                     AND    SKD_DIR_CD     = SUBSTR(@[vvd_cd], 9, 1)
	                                                                                                     AND     VPS_PORT_CD    = @[pod_cd]
	                                                                                                     ) )
	                                )    BKG_VVD2
	                      WHERE   BKG_BOOKING.BKG_NO        =   BKG_VVD2.BKG_NO
	                      AND     BKG_BOOKING.POD_CD        <>   @[pod_cd]
	                      AND     BKG_VVD.BKG_NO            =   BKG_VVD2.BKG_NO
	                      AND     BKG_VVD.POL_CD            =   @[pod_cd]
	                   )        A
	                   ,(
	                      SELECT   BKG_BOOKING.BKG_NO
	                      FROM     BKG_BOOKING
	                               ,BKG_VVD
	                               ,(
	                               SELECT  BKG_VVD.BKG_NO
	                                       ,BKG_VVD.POL_CD
	                                       ,BKG_VVD.POD_CD
	                               FROM    BKG_VVD
	                               WHERE   BKG_VVD.VSL_CD         = SUBSTR(@[vvd_cd], 1, 4)
	                                AND    BKG_VVD.SKD_VOY_NO     = SUBSTR(@[vvd_cd], 5, 4)
	                                AND    BKG_VVD.SKD_DIR_CD     = SUBSTR(@[vvd_cd], 9, 1)
	                                )    BKG_VVD2
	                      WHERE   BKG_BOOKING.BKG_NO        =   BKG_VVD2.BKG_NO
	                      AND     BKG_BOOKING.POD_CD        <>   @[pod_cd]
	                      AND     BKG_VVD.BKG_NO            =   BKG_VVD2.BKG_NO
	                      AND     BKG_VVD.POD_CD            =   @[pod_cd]
	                   )        B
	                   WHERE   A.BKG_NO         =   B.BKG_NO
	            ) TS

	    WHERE	1=1
		#if (${empty_check} != 'on') 
		AND 	BB.BKG_CGO_TP_CD          <> 'P'
		#end
	    AND	    BB.BKG_STS_CD		      <> 'X'
	    AND	    BB.POD_CD		        = BB.DEL_CD
	    AND	    BB.BKG_NO		        = BV.BKG_NO
	    AND	    BB.BKG_NO		        = BBD.BKG_NO
	    AND	    BB.BKG_NO               = BBMD.BKG_NO(+)
	    AND	    BB.BKG_NO               = BH.BKG_NO(+)
	    AND	    BC.BKG_NO		        = BB.BKG_NO
	    AND	    BC.BKG_CUST_TP_CD       = 'C'
	    AND	    MC.CUST_CNT_CD(+)       = BC.CUST_CNT_CD
	    AND	    MC.CUST_SEQ(+)          = BC.CUST_SEQ
	    AND		BB.BKG_NO				= TS.BKG_NO

	    AND	    BCIV.VSL_CD             = SUBSTR(@[vvd_cd], 1, 4)
	    AND	    BCIV.SKD_VOY_NO         = SUBSTR(@[vvd_cd], 5, 4)
	    AND	    BCIV.SKD_DIR_CD         = SUBSTR(@[vvd_cd], 9, 1)
	    AND	    BCIV.POD_CD             = @[pod_cd]
	#if (${pol_cd} != '') 
	    AND	    BB.POL_CD               LIKE @[pol_cd] || '%'
	#end
	    AND     ( 1 <= (   SELECT COUNT(HBL_NO)
	                    FROM BKG_HBL A
	                    WHERE BB.BKG_NO = A.BKG_NO )  OR
	            0 = (   SELECT COUNT(HBL_NO)
	                    FROM BKG_HBL A
	                    WHERE BB.BKG_NO = A.BKG_NO )  AND  BH.HBL_SEQ = '01' )
	    ) SUB1
	    , BKG_CSTMS_IDA_BL BCIB
	WHERE SUB1.VSL_CD       =  BCIB.VSL_CD(+)
	AND   SUB1.SKD_VOY_NO   =  BCIB.SKD_VOY_NO(+)
	AND   SUB1.SKD_DIR_CD   =  BCIB.SKD_DIR_CD(+)
	AND   SUB1.POD_CD       =  BCIB.POD_CD(+)
	AND   SUB1.BL_NO        =  BCIB.BL_NO(+)
	AND   SUB1.HBL_NO       = BCIB.NVOCC_REF_NO(+)
	AND   BCIB.VSL_CD(+)       = SUBSTR(@[vvd_cd], 1, 4)
	AND   BCIB.SKD_VOY_NO(+)   = SUBSTR(@[vvd_cd], 5, 4)
	AND   BCIB.SKD_DIR_CD(+)   = SUBSTR(@[vvd_cd], 9, 1)
	AND   BCIB.POD_CD(+)       = @[pod_cd]
)

WHERE 1=1
#if (${entry_type} != '0' && ${entry_type} != '')
AND ENTRY_TP = DECODE(@[entry_type], '1', 'LC'
								   , '2', 'TI'
								   , '3', 'TC' )
#end
ORDER BY ENTRY_TP, DEL_CD, POL_CD, BL_NO, HBL_NO, HBL_IND			]]></sql>
			<params>
				<param name="vvd_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="entry_type" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
