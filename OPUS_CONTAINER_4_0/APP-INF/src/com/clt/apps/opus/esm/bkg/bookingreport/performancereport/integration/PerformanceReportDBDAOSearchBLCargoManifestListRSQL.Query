<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="PerformanceReportDBDAOSearchBLCargoManifestListRSQL">
			<desc><![CDATA[PerformanceReportDBDAOSearchBLCargoManifestListRSQL]]></desc>
			<sql><![CDATA[
/* For Select */
SELECT 
ROWNUM SEQ_NO
, '               '||DECODE(@[mode_type] ,'I', 'POL: '|| GROUP_POL_POD ||'    ETD:'|| GROUP_ETD_ETA
                                             , 'POD: '|| GROUP_POL_POD ||'    ETA:'|| GROUP_ETD_ETA ) GROUP_TITLE
, '        '||'Total Package: '|| TRIM(TO_CHAR(TOTAL_PKG,'9,999,990'))||'    Total Weight:'|| TRIM(TO_CHAR(TOTAL_KGS,'9,999,999,990.999'))||' KGS('|| TRIM(TO_CHAR(TOTAL_LBS,'9,999,999,990.999'))||' LBS)' AS GROUP_TOTAL
, Z.*        
FROM ( SELECT  SUM(PKG3) OVER( PARTITION BY GROUP_POL_POD, GROUP_ETD_ETA) TOTAL_PKG 
             , SUM(KGS) OVER( PARTITION BY GROUP_POL_POD, GROUP_ETD_ETA ) TOTAL_KGS 
             , SUM(LBS) OVER( PARTITION BY GROUP_POL_POD, GROUP_ETD_ETA ) TOTAL_LBS
             , Y.*
        FROM ( SELECT  BKG_GET_TOKEN_FNC(X.HEADER,1) HD_VVD_CD
                     , BKG_GET_TOKEN_FNC(X.HEADER,2) HD_POL_POD
                     , BKG_GET_TOKEN_FNC(X.HEADER,3) HD_POL_POD_CD
                     , BKG_GET_TOKEN_FNC(X.HEADER,4) HD_ETA_ETD
                     , BKG_GET_TOKEN_FNC(X.HEADER,5) HD_ETA_ETD_CD
                     , DECODE(@[mode_type] ,'I','Inbound','Outbound') HD_MODE_TYPE
                     
                     , BKG_GET_TOKEN_FNC(X.PRE_POST,2) PRE_POST_VVD
                     , BKG_GET_TOKEN_FNC(X.PRE_POST,3) PRE_POST_POL_CD
                     , BKG_GET_TOKEN_FNC(X.PRE_POST,4) PRE_POST_POL_YD_CD
                     , BKG_GET_TOKEN_FNC(X.PRE_POST,5) PRE_POST_POD_CD
                     , BKG_GET_TOKEN_FNC(X.PRE_POST,6) PRE_POST_POD_YD_CD
                     , X.*
                FROM ( SELECT  
                           B.BKG_NO,b.bkg_cgo_tp_cd,
                           B.BL_NO,
                           B.POR_CD,
                           B.POL_CD,
                           SUBSTR(B.POL_NOD_CD,6) AS POL_YD_CD,
                           B.POD_CD,
                           SUBSTR(B.POD_NOD_CD,6) AS POD_YD_CD,
                           B.DEL_CD,
                           SUBSTR(B.DEL_NOD_CD,6) AS DEL_YD_CD,
                           
                           B.RCV_TERM_CD      AS  RD_CD1,
                           B.DE_TERM_CD       AS  RD_CD2,
                           
                           /* L/T cargo route  CHECK*/
                           DECODE(B.POL_CD,A.POL_CD,'L','T')  AS LT,
                           B.BKG_CGO_TP_CD    AS EF,
						   TRIM(TO_CHAR(NVL(D.PCK_QTY, 0),'9,999,990')) AS PKG1,
                           D.PCK_TP_CD        AS PKG2, 
						   NVL(D.PCK_QTY, 0) AS PKG3,

						   TRIM(TO_CHAR(NVL(D.ACT_WGT, 0),'999,999,990.999')) AS WGT1,
                           D.WGT_UT_CD        AS WGT2,

                           B.TWN_SO_NO        AS SO_NO,                          
                           B.REP_CMDT_CD      AS REP, 
                           DECODE(NVL(B.ADV_SHTG_CD,'N'),'1','Y','N') AS AS_CD,
                           B.DCGO_FLG     AS DG,                           
                           B.RC_FLG       AS RF,   
                           B.AWK_CGO_FLG  AS AW, 
                           B.BB_CGO_FLG   AS BB, 
                           D.BDR_FLG      AS BDR, 
                           D.BDR_CNG_FLG  AS CA, 

                           NVL(D.MEAS_QTY, 0) AS MEAS_QTY,
                           D.MEAS_UT_CD, 
                                                                
						   DECODE(NVL(D.WGT_UT_CD,' '),'LBS', ROUND(NVL(D.ACT_WGT,0)*0.4536,3),NVL(D.ACT_WGT,0))    AS KGS,
						   DECODE(NVL(D.WGT_UT_CD,' '),'KGS', ROUND(NVL(D.ACT_WGT,0)*2.2046,3),NVL(D.ACT_WGT,0))    AS LBS,

                           DECODE(NVL(D.MEAS_UT_CD,' '),'CBF', ROUND(NVL(D.MEAS_QTY,0)*0.0283,3),NVL(D.MEAS_QTY,0)) AS CBF,
                           DECODE(NVL(D.MEAS_UT_CD,' '),'CBM', ROUND(NVL(D.MEAS_QTY,0)*35.315,3),NVL(D.MEAS_QTY,0)) AS CBM,
                           

                           /* feeder vvd,pol,pod CHECK*/
                           DECODE(@[mode_type], 'I', ( SELECT  MIN('I'||VSL_PRE_PST_CD||VSL_SEQ||','||VSL_CD||SKD_VOY_NO||SKD_DIR_CD||','||POL_CD||','||SUBSTR(POL_YD_CD,6)||','||POD_CD ||','||SUBSTR(POD_YD_CD,6))
                                                        FROM    BKG_VVD
                                                       WHERE   BKG_NO          = A.BKG_NO
                                                         AND     POL_cd         = A.POD_CD
                                                         AND     VSL_PRE_PST_CD||VSL_SEQ  > ( SELECT  VSL_PRE_PST_CD||VSL_SEQ
                                                                                                FROM    BKG_VVD
                                                                                                WHERE   BKG_NO          = A.BKG_NO
                                                                                                AND     VSL_CD          = A.VSL_CD
                                                                                                AND     SKD_VOY_NO      = A.SKD_VOY_NO
                                                                                                AND     SKD_DIR_CD      = A.SKD_DIR_CD
                                                                                                AND     POD_cd         = A.POD_CD)
                                                                GROUP BY VSL_CD||SKD_VOY_NO||SKD_DIR_CD,POL_CD,POD_CD)
                                                   , ( SELECT 'O'||','||VSL_CD||SKD_VOY_NO||SKD_DIR_CD||','||POL_CD||','||SUBSTR(POL_YD_CD,6)||','||POD_CD ||','||SUBSTR(POD_YD_CD,6)
                                                        FROM BKG_VVD
                                                       WHERE BKG_NO        = A.BKG_NO 
                                                         AND POD_CD       = A.POL_CD)
                                ) AS PRE_POST,                          
                           
                           
                           /* result Header */
                           DECODE(@[mode_type],'I', ( SELECT VSL_CD||SKD_VOY_NO||SKD_DIR_CD||',POD,'||VPS_PORT_CD||',ETA,'||TO_CHAR(VPS_ETA_DT,'YYYY-MM-DD')
                                                        FROM VSK_VSL_PORT_SKD
                                                       WHERE VSL_CD = A.VSL_CD 
                                                         AND SKD_VOY_NO = A.SKD_VOY_NO 
                                                         AND SKD_DIR_CD  =  A.SKD_DIR_CD
                                                         AND VPS_PORT_CD =  A.POD_CD 
                                                         AND CLPT_IND_SEQ = (SELECT MIN(CLPT_IND_SEQ) 
                                                                               FROM VSK_VSL_PORT_SKD
                                                                              WHERE VSL_CD = A.VSL_CD
                                                                                AND SKD_VOY_NO = A.SKD_VOY_NO
                                                                                AND SKD_DIR_CD = A.SKD_DIR_CD
                                                                                AND NVL(SKD_CNG_STS_CD, ' ') <> 'S'
                                                                                AND VPS_PORT_CD = A.POD_CD))
                                                  , ( SELECT VSL_CD||SKD_VOY_NO||SKD_DIR_CD||',POL,'||VPS_PORT_CD||',ETD,'||TO_CHAR(VPS_ETD_DT,'YYYY-MM-DD')
                                                        FROM VSK_VSL_PORT_SKD
                                                       WHERE VSL_CD = A.VSL_CD
                                                         AND SKD_VOY_NO = A.SKD_VOY_NO
                                                         AND SKD_DIR_CD = A.SKD_DIR_CD
                                                         AND VPS_PORT_CD = A.POL_CD
                                                         AND CLPT_IND_SEQ = (SELECT MAX(CLPT_IND_SEQ) 
                                                                               FROM VSK_VSL_PORT_SKD
                                                                              WHERE  VSL_CD = A.VSL_CD
                                                                                AND  SKD_VOY_NO = A.SKD_VOY_NO
                                                                                AND  SKD_DIR_CD = A.SKD_DIR_CD
                                                                                AND  VPS_PORT_CD = A.POL_CD))
                                  ) AS HEADER ,
                          /* GROUP TITLE ETD,ETA*/
                         DECODE(@[mode_type], 'I', (SELECT TO_CHAR(VPS_ETD_DT,'YYYY-MM-DD HH24:MI')
                                                     FROM VSK_VSL_PORT_SKD
                                                    WHERE VSL_CD = A.VSL_CD
                                                      AND SKD_VOY_NO = A.SKD_VOY_NO
                                                      AND SKD_DIR_CD = A.SKD_DIR_CD
                                                      AND VPS_PORT_CD = A.POL_CD
                                                      AND CLPT_IND_SEQ = '1')
                                               , (SELECT  TO_CHAR(VPS_ETA_DT,'YYYY-MM-DD HH24:MI')
                                                    FROM  VSK_VSL_PORT_SKD
                                                   WHERE  VSL_CD = A.VSL_CD
                                                     AND  SKD_VOY_NO = A.SKD_VOY_NO
                                                     AND  SKD_DIR_CD = A.SKD_DIR_CD
                                                     AND  VPS_PORT_CD = A.POD_CD
                                                     AND  CLPT_IND_SEQ = '1')
                                ) AS GROUP_ETD_ETA, 
                          /* Group Title POL & POD */
                          DECODE(@[mode_type],'I',A.POL_CD,A.POD_CD)  AS GROUP_POL_POD
                      FROM BKG_VVD A, BKG_BOOKING B,BKG_BL_DOC D
                      WHERE  A.bkg_no = B.bkg_no
                      AND    B.bkg_no = D.bkg_no
                      AND    B.BKG_STS_CD NOT IN ('X','S')

                      /* vvd_cd */
                      #if(${vvd_cd} != '' ) 
                      AND    A.VSL_CD     = SUBSTR(@[vvd_cd], 1, 4)
                      AND    A.SKD_VOY_NO = SUBSTR(@[vvd_cd], 5, 4)
                      AND    A.SKD_DIR_CD = SUBSTR(@[vvd_cd], 9, 1) 
                      #end
                      
                      /* pol_cd */
		              #if(${pol_cd} != '' )                       
                      AND    A.POL_CD = @[pol_cd]
                      #end
                      
                      /* pol_yd_cd */
		              #if(${pol_yd_cd} != '' )                       
                      AND    SUBSTR(B.POL_NOD_CD,6) = @[pol_yd_cd]
                      #end
                    
                 	  /* pod_cd */
                      #if(${pod_cd} != '' ) 
                      AND A.POD_CD = @[pod_cd] 
                      #end

                      /* pod_yd_cd */
                      #if(${pod_yd_cd} != '' ) 
                      AND SUBSTR(B.POD_NOD_CD,6) = @[pod_yd_cd]
                      #end
                      
                      /* CARGO TYPE */
                     #if(${cargo_type} != 'ALL' ) 
                     AND    B.BKG_CGO_TP_CD = @[cargo_type] 
                     #end

                      /* CARGO_ROUTE */
                     #if(${cargo_route} != 'ALL' ) 
                     AND DECODE(B.POL_CD,A.POL_CD,'L','T') = @[cargo_route] 
                     #end
                     
                     /* br_por_cd */
                     #if(${br_por_cd} != '' ) 
                     AND B.POR_CD LIKE @[br_por_cd] ||'%'
                     #end

                     /* br_pol_cd */
                     #if(${br_pol_cd} != '' ) 
                     AND B.POL_CD LIKE  @[br_pol_cd] ||'%'
                     #end
                     
                    /* br_pod_cd */
                     #if(${br_pod_cd} != '' ) 
                     AND B.POD_CD LIKE  @[br_pod_cd] ||'%'
                     #end

                     /* br_del_cd */
                     #if(${br_del_cd} != '' ) 
                     AND B.DEL_CD LIKE  @[br_del_cd] ||'%'
                     #end
                      
                ) X
                 WHERE 1 = 1 
                 
          ) Y
          WHERE 1 =1
        /* fdr_vvd_cd */
		#if(${fdr_vvd_cd} != '' ) 
		 AND PRE_POST_VVD = @[fdr_vvd_cd] 
		#end

		/* fdr_pol_cd */
		#if(${fdr_pol_cd} != '' ) 
		 AND PRE_POST_POL_CD = @[fdr_pol_cd] 
		#end

		/* fdr_pol_yd_cd */
		#if(${fdr_pol_yd_cd} != '' ) 
		 AND PRE_POST_POL_YD_CD = @[fdr_pol_yd_cd] 
		#end

		/* fdr_pod_cd */
		#if(${fdr_pod_cd} != '' ) 
		 AND PRE_POST_POL_CD = @[fdr_pod_cd] 
		#end

		/* fdr_pod_yd_cd */
		#if(${fdr_pod_yd_cd} != '' ) 
		 AND PRE_POST_POD_YD_CD = @[fdr_pod_yd_cd] 
		#end          
        
        ORDER BY GROUP_POL_POD, GROUP_ETD_ETA , ${order_by}
  ) Z			]]></sql>
			<params>
				<param name="mode_type" type="12" value="" out="N"/>
				<param name="vvd_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pol_yd_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="pod_yd_cd" type="12" value="" out="N"/>
				<param name="cargo_type" type="12" value="" out="N"/>
				<param name="cargo_route" type="12" value="" out="N"/>
				<param name="br_por_cd" type="12" value="" out="N"/>
				<param name="br_pol_cd" type="12" value="" out="N"/>
				<param name="br_pod_cd" type="12" value="" out="N"/>
				<param name="br_del_cd" type="12" value="" out="N"/>
				<param name="fdr_vvd_cd" type="12" value="" out="N"/>
				<param name="fdr_pol_cd" type="12" value="" out="N"/>
				<param name="fdr_pol_yd_cd" type="12" value="" out="N"/>
				<param name="fdr_pod_cd" type="12" value="" out="N"/>
				<param name="fdr_pod_yd_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
