<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="DailyForecastManageDBDAOSpcFileImptCustMapgCSQL">
			<desc><![CDATA[File Import Save를 수행한다.

2016.04.11  rlane_cd = @[rlane_cd] 추가]]></desc>
			<sql><![CDATA[
MERGE INTO SPC_SLS_REP_CUST_MAPG A USING 
( 
WITH PARAMS AS 
       (SELECT @[vsl_cd] AS VSL_CD  
            , @[skd_voy_no] AS SKD_VOY_NO 
            , @[skd_dir_cd] AS SKD_DIR_CD 
            , @[rlane_cd] AS RLANE_CD
            , @[dir_cd] AS DIR_CD 
            , @[ioc_ts_cd] AS IOC_TS_CD 
            , @[cust_cnt_cd] AS CUST_CNT_CD 
            , @[cust_seq] AS CUST_SEQ 
            , @[fcast_cust_tp_cd] AS FCAST_CUST_TP_CD
            , @[fcast_ofc_cd] AS FCAST_OFC_CD
            , @[upd_usr_id] AS USR_ID 
            --20160203.ADD
            , @[ctrt_cust_cnt_cd] AS CTRT_CUST_CNT_CD
            , @[ctrt_cust_seq]    AS CTRT_CUST_SEQ
         FROM DUAL 
       ) 
SELECT NVL(@[srep_usr_id],SR.SREP_CD) AS SREP_CD 
     , C.TRD_CD 
     , C.SUB_TRD_CD 
     , NVL(P.RLANE_CD, C.RLANE_CD) AS RLANE_CD
     , C.DIR_CD 
     , P.IOC_TS_CD 
     , P.CUST_CNT_CD 
     , P.CUST_SEQ 
     , P.FCAST_CUST_TP_CD
     , SAQ_GET_REP_TRD_FNC(NVL(P.RLANE_CD, C.RLANE_CD)) AS REP_TRD_CD 
     , SAQ_GET_REP_SUB_TRD_FNC(NVL(P.RLANE_CD, C.RLANE_CD)) AS REP_SUB_TRD_CD
     , O.N2ND_PRNT_OFC_CD AS SLS_RHQ_CD 
     , O.N3RD_PRNT_OFC_CD AS SLS_AQ_CD 
     , O.N4TH_PRNT_OFC_CD AS SLS_RGN_OFC_CD
     , NVL(O.N5TH_PRNT_OFC_CD, O.N4TH_PRNT_OFC_CD) AS SLS_OFC_CD
     , P.FCAST_OFC_CD
     , P.USR_ID AS CRE_USR_ID 
     , SYSDATE AS CRE_DT 
     , P.USR_ID AS UPD_USR_ID 
     , SYSDATE AS UPD_DT 
     --20160203.ADD
     ,(SELECT NVL(MAX(FCAST_SEQ),0)+1
         FROM SPC_SLS_REP_CUST_MAPG
        WHERE 1=1
          AND SREP_CD = NVL(@[srep_usr_id],SR.SREP_CD)
          AND TRD_CD = C.TRD_CD
          AND SUB_TRD_CD = C.SUB_TRD_CD
          AND RLANE_CD  = NVL(P.RLANE_CD, C.RLANE_CD) 
          AND DIR_CD  = C.DIR_CD
          AND IOC_TS_CD  = P.IOC_TS_CD
          AND CUST_CNT_CD = P.CUST_CNT_CD
          AND CUST_SEQ = P.CUST_SEQ
          AND FCAST_CUST_TP_CD = P.FCAST_CUST_TP_CD) AS FCAST_SEQ	
     , P.CTRT_CUST_CNT_CD
     , P.CTRT_CUST_SEQ
  FROM SPC_OFC_LVL O 
     , 
       (SELECT SREP_CD 
         FROM 
              (SELECT SREP_CD 
                FROM MDM_SLS_REP 
               WHERE OFC_CD = @[fcast_ofc_cd] 
                     AND DELT_FLG = 'N' 
            ORDER BY SREP_CD 
              ) 
        WHERE ROWNUM = '1' 
       ) SR
     , PARAMS P 
     , COA_WK_PRD W
     , 
       (SELECT IOC_CD
            , VSL_CD
            , SKD_VOY_NO
            , DIR_CD 
            , RLANE_CD
            , TRD_CD
            , SUB_TRD_CD 
         FROM COA_MON_VVD 
        WHERE 1=1 
              AND IOC_CD = 'O' 
              AND VSL_CD = @[vsl_cd] 
              AND SKD_VOY_NO = @[skd_voy_no] 
              AND DIR_CD = @[skd_dir_cd]
              AND RLANE_CD = @[rlane_cd] 
              AND 'O' = DECODE(@[ioc_ts_cd], 'O', 'O', 'I') 
           UNION ALL 
       SELECT T3.IOC_CD
            , T3.VSL_CD
            , T3.SKD_VOY_NO
            , T3.DIR_CD 
            , T3.RLANE_CD
            , T4.TRD_CD 
            , T4.SUB_TRD_CD 
         FROM 
              (SELECT IOC_CD
                   , VSL_CD
                   , SKD_VOY_NO
                   , DIR_CD 
                   , MAX(RLANE_CD) AS RLANE_CD 
                FROM COA_MON_VVD 
               WHERE 1=1 
                     AND IOC_CD = DECODE(@[ioc_ts_cd], 'O', 'O', 'I') 
                     AND VSL_CD = @[vsl_cd] 
                     AND SKD_VOY_NO = @[skd_voy_no] 
                     AND DIR_CD = @[skd_dir_cd]
                     AND RLANE_CD = @[rlane_cd] 
               GROUP BY IOC_CD
                   , VSL_CD
                   , SKD_VOY_NO
                   , DIR_CD 
              ) T3 
            , MDM_DTL_REV_LANE T4 
        WHERE 1=1 
              AND T3.RLANE_CD = T4.RLANE_CD 
              AND FM_CONTI_CD IN 
              (SELECT CONTI_CD 
                FROM MDM_LOCATION 
               WHERE 1=1 
                     AND LOC_CD = SUBSTR(@[pol_yd_cd], 1, 5) 
              ) 
              AND TO_CONTI_CD IN 
              (SELECT CONTI_CD 
                FROM MDM_LOCATION 
               WHERE 1=1 
                     AND LOC_CD = SUBSTR(@[pol_yd_cd], 1, 5) 
              ) 
              AND T4.DELT_FLG = 'N' 
              AND T3.DIR_CD = T4.VSL_SLAN_DIR_CD 
              AND T3.IOC_CD = T4.IOC_CD 
              AND 'I' = DECODE(@[ioc_ts_cd], 'O', 'O', 'I') 
       )C 
 WHERE 1=1 
       AND O.OFC_CD = P.FCAST_OFC_CD 
       AND O.OFC_APLY_FM_YRWK <= W.COST_YR || W.COST_WK 
       AND O.OFC_APLY_TO_YRWK >= W.COST_YR || W.COST_WK 
       AND W.SLS_FM_DT <= TO_CHAR(SYSDATE, 'YYYYMMDD') 
       AND W.SLS_TO_DT >= TO_CHAR(SYSDATE, 'YYYYMMDD') ) B 
ON ( A.SREP_CD = B.SREP_CD 
     AND A.TRD_CD = B.TRD_CD 
     AND A.SUB_TRD_CD = B.SUB_TRD_CD 
     AND A.RLANE_CD = B.RLANE_CD 
     AND A.DIR_CD = B.DIR_CD 
     AND A.IOC_TS_CD = B.IOC_TS_CD 
     AND A.CUST_CNT_CD = B.CUST_CNT_CD 
     AND A.CUST_SEQ = B.CUST_SEQ 
     AND A.FCAST_CUST_TP_CD = B.FCAST_CUST_TP_CD 
     AND NVL(A.CTRT_CUST_CNT_CD,'00') = NVL(B.CTRT_CUST_CNT_CD,'00')		--20160203.ADD : PK FCAST_SEQ 의미 = CTRT_CUST_CNT_CD + CTRT_CUST_SEQ
     AND NVL(A.CTRT_CUST_SEQ,0) = NVL(B.CTRT_CUST_SEQ,0)) 

WHEN MATCHED THEN 
    UPDATE 
           SET A.UPD_USR_ID = B.UPD_USR_ID 
         , A.UPD_DT = SYSDATE 

WHEN NOT MATCHED THEN 
    INSERT 
           ( 
               A.SREP_CD 
             , A.TRD_CD 
             , A.SUB_TRD_CD 
             , A.RLANE_CD 
             , A.DIR_CD 
             , A.IOC_TS_CD 
             , A.CUST_CNT_CD 
             , A.CUST_SEQ 
             , A.FCAST_CUST_TP_CD
             , A.REP_TRD_CD 
             , A.REP_SUB_TRD_CD 
             , A.SLS_RHQ_CD 
             , A.SLS_AQ_CD 
             , A.SLS_RGN_OFC_CD 
             , A.SLS_OFC_CD 
             , A.FCAST_OFC_CD 
             , A.CRE_USR_ID 
             , A.CRE_DT 
             , A.UPD_USR_ID 
             , A.UPD_DT 
             --20160203.ADD
             , FCAST_SEQ 
             , CTRT_CUST_CNT_CD
             , CTRT_CUST_SEQ
           ) 
           VALUES 
           ( 
               B.SREP_CD 
             , B.TRD_CD 
             , B.SUB_TRD_CD 
             , B.RLANE_CD 
             , B.DIR_CD 
             , B.IOC_TS_CD 
             , B.CUST_CNT_CD 
             , B.CUST_SEQ 
             , B.FCAST_CUST_TP_CD
             , B.REP_TRD_CD 
             , B.REP_SUB_TRD_CD 
             , B.SLS_RHQ_CD 
             , B.SLS_AQ_CD 
             , B.SLS_RGN_OFC_CD 
             , B.SLS_OFC_CD 
             , B.FCAST_OFC_CD 
             , B.CRE_USR_ID 
             , B.CRE_DT 
             , B.UPD_USR_ID 
             , B.UPD_DT 
             --20160203.ADD
             , B.FCAST_SEQ
             , B.CTRT_CUST_CNT_CD
             , B.CTRT_CUST_SEQ
           )			]]></sql>
			<params>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="rlane_cd" type="12" value="" out="N"/>
				<param name="dir_cd" type="12" value="" out="N"/>
				<param name="ioc_ts_cd" type="12" value="" out="N"/>
				<param name="cust_cnt_cd" type="12" value="" out="N"/>
				<param name="cust_seq" type="12" value="" out="N"/>
				<param name="fcast_cust_tp_cd" type="12" value="" out="N"/>
				<param name="fcast_ofc_cd" type="12" value="" out="N"/>
				<param name="upd_usr_id" type="12" value="" out="N"/>
				<param name="ctrt_cust_cnt_cd" type="12" value="" out="N"/>
				<param name="ctrt_cust_seq" type="12" value="" out="N"/>
				<param name="srep_usr_id" type="12" value="" out="N"/>
				<param name="pol_yd_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
