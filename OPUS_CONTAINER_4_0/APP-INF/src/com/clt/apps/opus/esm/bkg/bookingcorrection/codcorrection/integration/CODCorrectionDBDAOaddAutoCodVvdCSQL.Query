<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CODCorrectionDBDAOaddAutoCodVvdCSQL">
			<desc><![CDATA[Booking Creation, E-BKG/SI Upload 화면에서 Auto COD VVD를 insert한다]]></desc>
			<sql><![CDATA[
insert into bkg_cod_vvd
(BKG_NO
, COD_RQST_SEQ
, VVD_OP_CD
, VSL_PRE_PST_CD
, VSL_SEQ
, VSL_CD
, SKD_VOY_NO
, SKD_DIR_CD
, SLAN_CD
, POL_YD_CD
, POD_YD_CD
, POL_CLPT_IND_SEQ
, POD_CLPT_IND_SEQ
, CRE_USR_ID
, CRE_DT
, UPD_USR_ID
, UPD_DT
)
select BKG_NO
        , @[cod_rqst_seq]
        , 'O' VVD_OP_CD
        , VSL_PRE_PST_CD
        , VSL_SEQ
        , VSL_CD
        , SKD_VOY_NO
        , SKD_DIR_CD
        , SLAN_CD
        , POL_YD_CD
        , POD_YD_CD
        , POL_CLPT_IND_SEQ
        , POD_CLPT_IND_SEQ
        , CRE_USR_ID
        , CRE_DT
        , UPD_USR_ID
        , UPD_DT
FROM BKG_VVD
WHERE BKG_NO = @[bkg_no]
UNION
select @[bkg_no] bkg_no
        , @[cod_rqst_seq]
		, 'N' VVD_OP_CD
        , 'S' vsl_pre_post_cd
        , rownum vsl_seq
        , VSL_CD                    vsl_cd
        , SKD_VOY_NO                skd_voy_no
        , decode(nvl(VSL_CD, 'X'), 'X', null, SKD_DIR_CD) skd_dir_cd
        , VSL_SLAN_CD               slan_cd
        , org_nod_cd                pol_yd_cd
        , DEST_NOD_CD               pod_yd_cd
        , ORG_CLPT_IND_SEQ          pol_clpt_ind_seq
        , DEST_CLPT_IND_SEQ         pod_clpt_ind_seq
        , @[usr_id]
        , sysdate
        , @[usr_id]
        , sysdate
  from prd_prod_ctl_rout_dtl dtl
 where TRSP_MOD_CD in ('VD', 'WD')
   and PCTL_IO_BND_CD = 'T'
   AND SUBSTR(ORG_NOD_CD, 1, 5) <> SUBSTR(DEST_NOD_CD, 1, 5)
   and pctl_no = @[pctl_no]
   and pctl_seq < ( select pctl_seq
                      from prd_prod_ctl_rout_dtl dtl, bkg_booking bk, prd_prod_ctl_mst prd
                     where prd.pctl_no    = @[pctl_no]
					   and prd.pctl_no 	  = dtl.pctl_no
					   and bk.bkg_no      = @[bkg_no]
                       and dtl.vsl_cd     = prd.trnk_vsl_cd
                       and dtl.skd_voy_no = prd.trnk_skd_voy_no
                       and dtl.skd_dir_cd = prd.trnk_skd_dir_cd
					   AND dtl.TZ_DWLL_TM_HRS = (select max(TZ_DWLL_TM_HRS) 
            			                   		  from prd_prod_ctl_rout_dtl max_dwll
		                		                 where max_dwll.pctl_no  = @[pctl_no]
        		                	    	       and dtl.TRSP_MOD_CD in ('VD', 'WD')
                		            		       and dtl.vsl_cd      = max_dwll.vsl_cd
                        				           and dtl.skd_voy_no  = max_dwll.skd_voy_no 
                         	       		  		   and dtl.skd_dir_cd  = max_dwll.skd_dir_cd)
					)                                
 union
select @[bkg_no] bkg_no
        , @[cod_rqst_seq]
		, 'N' VVD_OP_CD
        , 'T' vsl_pre_post_cd
        , 0 vsl_seq
        , VSL_CD                    vsl_cd
        , SKD_VOY_NO                skd_voy_no
        , decode(nvl(VSL_CD, 'X'), 'X', null, SKD_DIR_CD) skd_dir_cd
        , VSL_SLAN_CD               slan_cd
        , org_nod_cd                pol_yd_cd
        , DEST_NOD_CD               pod_yd_cd
        , ORG_CLPT_IND_SEQ          pol_clpt_ind_seq
        , DEST_CLPT_IND_SEQ         pod_clpt_ind_seq
        , @[usr_id]
        , sysdate
        , @[usr_id]
        , sysdate
  from prd_prod_ctl_rout_dtl dtl
 where TRSP_MOD_CD in ('VD', 'WD')
   and PCTL_IO_BND_CD = 'T'
   AND SUBSTR(ORG_NOD_CD, 1, 5) <> SUBSTR(DEST_NOD_CD, 1, 5)
   and pctl_no  = @[pctl_no]
   and pctl_seq = ( select pctl_seq
                      from prd_prod_ctl_rout_dtl dtl, bkg_booking bk, prd_prod_ctl_mst prd
                     where prd.pctl_no    = @[pctl_no]
					   and prd.pctl_no 	  = dtl.pctl_no
					   and bk.bkg_no      = @[bkg_no]
                       and dtl.vsl_cd     = prd.trnk_vsl_cd
                       and dtl.skd_voy_no = prd.trnk_skd_voy_no
                       and dtl.skd_dir_cd = prd.trnk_skd_dir_cd
					   AND dtl.TZ_DWLL_TM_HRS = (select max(TZ_DWLL_TM_HRS) 
            			                   		  from prd_prod_ctl_rout_dtl max_dwll
		                		                 where max_dwll.pctl_no  = @[pctl_no]
        		                	    	       and dtl.TRSP_MOD_CD in ('VD', 'WD')
                		            		       and dtl.vsl_cd      = max_dwll.vsl_cd
                        				           and dtl.skd_voy_no  = max_dwll.skd_voy_no 
                         	       		  		   and dtl.skd_dir_cd  = max_dwll.skd_dir_cd)
					)                                                         
 union
select @[bkg_no] bkg_no
        , @[cod_rqst_seq]
		, 'N' VVD_OP_CD
        , 'U' vsl_pre_post_cd
        , rownum vsl_seq
        , VSL_CD                    vsl_cd
        , SKD_VOY_NO                skd_voy_no
        , decode(nvl(VSL_CD, 'X'), 'X', null, SKD_DIR_CD) skd_dir_cd
        , VSL_SLAN_CD               slan_cd
        , org_nod_cd                pol_yd_cd
        , DEST_NOD_CD               pod_yd_cd
        , ORG_CLPT_IND_SEQ          pol_clpt_ind_seq
        , DEST_CLPT_IND_SEQ         pod_clpt_ind_seq
        , @[usr_id]
        , sysdate
        , @[usr_id]
        , sysdate
  from prd_prod_ctl_rout_dtl dtl
 where TRSP_MOD_CD in ('VD', 'WD')
   and PCTL_IO_BND_CD = 'T'
   AND SUBSTR(ORG_NOD_CD, 1, 5) <> SUBSTR(DEST_NOD_CD, 1, 5)
   and pctl_no = @[pctl_no]
   and pctl_seq > ( select pctl_seq
                      from prd_prod_ctl_rout_dtl dtl, bkg_booking bk, prd_prod_ctl_mst prd
                     where prd.pctl_no    = @[pctl_no]
					   and prd.pctl_no 	  = dtl.pctl_no
					   and bk.bkg_no      = @[bkg_no]
                       and dtl.vsl_cd     = prd.trnk_vsl_cd
                       and dtl.skd_voy_no = prd.trnk_skd_voy_no
                       and dtl.skd_dir_cd = prd.trnk_skd_dir_cd
					   AND dtl.TZ_DWLL_TM_HRS = (select max(TZ_DWLL_TM_HRS) 
            			                   		  from prd_prod_ctl_rout_dtl max_dwll
		                		                 where max_dwll.pctl_no  = @[pctl_no]
        		                	    	       and dtl.TRSP_MOD_CD in ('VD', 'WD')
                		            		       and dtl.vsl_cd      = max_dwll.vsl_cd
                        				           and dtl.skd_voy_no  = max_dwll.skd_voy_no 
                         	       		  		   and dtl.skd_dir_cd  = max_dwll.skd_dir_cd)
					)			]]></sql>
			<params>
				<param name="cod_rqst_seq" type="12" value="" out="N"/>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="usr_id" type="12" value="" out="N"/>
				<param name="pctl_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
