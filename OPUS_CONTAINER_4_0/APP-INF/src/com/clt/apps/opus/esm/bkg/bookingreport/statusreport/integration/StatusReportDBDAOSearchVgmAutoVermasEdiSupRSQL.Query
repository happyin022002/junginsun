<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="StatusReportDBDAOSearchVgmAutoVermasEdiSupRSQL">
			<desc><![CDATA[Search VGM Auto VERMAS EDI SUP]]></desc>
			<sql><![CDATA[
SELECT EDI_RECEIVE_ID,
       REF_CODE,
       EDI_SND_ID,
       BKG_NO,
       NTC_KND_CD
  FROM ( SELECT EDI_RECEIVE_ID,
                REF_CODE,
                EDI_SND_ID,
                BKG_NO,
                NTC_KND_CD,
                ROW_NUMBER() OVER (PARTITION BY EDI_RECEIVE_ID, REF_CODE, EDI_SND_ID ORDER BY DECODE(NTC_KND_CD,'VC','1','VP','2','VT')) DUP_CHK
           FROM (SELECT DISTINCT EY.RCVR_TRD_PRNR_ID AS EDI_RECEIVE_ID ,
                                 EY.PRNR_SUB_LNK_CD AS REF_CODE ,
                                 EY.SNDR_TRD_PRNR_ID AS EDI_SND_ID,
                                 BB.BKG_NO,
                                 'VC' NTC_KND_CD
                   FROM BKG_EDI_TRD_PRNR_SUB_LNK EY,
                        BKG_EDI_SUB_LNK_MSG MSG,
                        BKG_BOOKING BB
                  WHERE BB.BKG_NO = @[bkg_no]
                    AND EY.TRD_PRNR_SUB_LNK_SEQ = MSG.TRD_PRNR_SUB_LNK_SEQ
                    AND EY.PRNR_SUB_LNK_DIV_CD = '1'
                    AND MSG.EDI_MSG_TP_ID = 'VGM'
                    AND MSG.MSG_TP_DESC = '1'
                    AND EDI_MSG_IND_CD = 31
                    AND (EY.PRNR_SUB_LNK_CD = BB.POR_NOD_CD
                        OR EY.PRNR_SUB_LNK_CD = BB.FULL_RTN_YD_CD
                        OR EY.PRNR_SUB_LNK_CD = BB.MTY_RTN_YD_CD )
                 UNION ALL
                 SELECT DISTINCT EY.RCVR_TRD_PRNR_ID AS EDI_RECEIVE_ID ,
                                 EY.PRNR_SUB_LNK_CD AS REF_CODE ,
                                 EY.SNDR_TRD_PRNR_ID AS EDI_SND_ID,
                                 BB.BKG_NO,
                                'VP' NTC_KND_CD
                   FROM BKG_EDI_TRD_PRNR_SUB_LNK EY,
                        BKG_EDI_SUB_LNK_MSG MSG,
                        BKG_BOOKING BB
                  WHERE BB.BKG_NO = @[bkg_no]
                    AND EY.TRD_PRNR_SUB_LNK_SEQ = MSG.TRD_PRNR_SUB_LNK_SEQ
                    AND EY.PRNR_SUB_LNK_DIV_CD = '1'
                    AND MSG.EDI_MSG_TP_ID = 'VGM'
                    AND MSG.MSG_TP_DESC = '1'
                    AND EDI_MSG_IND_CD = 32
                    AND EY.PRNR_SUB_LNK_CD = BB.POL_NOD_CD
                 UNION ALL
                 SELECT DISTINCT EY.RCVR_TRD_PRNR_ID AS EDI_RECEIVE_ID ,
                                 EY.PRNR_SUB_LNK_CD AS REF_CODE ,
                                 EY.SNDR_TRD_PRNR_ID AS EDI_SND_ID,
                                 BB.BKG_NO,
                                'VT' NTC_KND_CD
                   FROM BKG_EDI_TRD_PRNR_SUB_LNK EY,
                        BKG_EDI_SUB_LNK_MSG MSG,
                        BKG_BOOKING BB
                  WHERE BB.BKG_NO = @[bkg_no]
                    AND EY.TRD_PRNR_SUB_LNK_SEQ = MSG.TRD_PRNR_SUB_LNK_SEQ
                    AND EY.PRNR_SUB_LNK_DIV_CD = '1'
                    AND MSG.EDI_MSG_TP_ID = 'VGM'
                    AND MSG.MSG_TP_DESC = '1'
                    AND EDI_MSG_IND_CD = 33
                    AND EXISTS (SELECT 'Y' 
                                  FROM BKG_VVD 
                                 WHERE BB.BKG_NO = BKG_NO 
                                   AND EY.PRNR_SUB_LNK_CD = POL_YD_CD 
                                   AND BB.POL_NOD_CD <> POL_YD_CD)
             )
         GROUP BY EDI_RECEIVE_ID ,
                  REF_CODE,
                  EDI_SND_ID,
                  BKG_NO,
                  NTC_KND_CD
        )
 WHERE DUP_CHK = 1			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
