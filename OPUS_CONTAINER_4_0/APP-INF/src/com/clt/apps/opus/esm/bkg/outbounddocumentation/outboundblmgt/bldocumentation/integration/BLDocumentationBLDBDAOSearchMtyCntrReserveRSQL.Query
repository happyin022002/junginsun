<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BLDocumentationBLDBDAOSearchMtyCntrReserveRSQL">
			<desc><![CDATA[Cntr가 이미 다른 Booking에 예약중인지 확인]]></desc>
			<sql><![CDATA[
SELECT BKG_NO
  FROM (SELECT BK.BKG_NO
          FROM bkg_container cntr
               , bkg_BOOKING Bk
         WHERE cntr.cntr_no     = @[cntr_no]
           AND cntr.cnmv_cyc_no = 9999           --DUMMY CYCLE(MT ATTACH, ACTUAL MOVEMENT 없음)
           AND cntr.bkg_no      = Bk.bkg_no
           AND BK.BKG_STS_CD    <> 'X'
		   AND BK.BKG_STS_CD    <> 'S'--CANCEL/MEMO SPLIT MASTER 제외
           AND ROWNUM = 1
        UNION ALL
        SELECT BK.BKG_NO
          FROM BKG_CONTAINER CNTR
                , BKG_BOOKING BK
                , BKG_VVD VVD
         WHERE CNTR.CNTR_NO     = @[cntr_no]    --같은 CNTR
           AND CNTR.BKG_NO      = BK.BKG_NO
           AND CNTR.BKG_NO      = VVD.BKG_NO
           AND BK.BKG_CGO_TP_CD = 'P'           --EMPTY BKG
           AND BK.BKG_STS_CD    <> 'X'
		   AND BK.BKG_STS_CD    <> 'S'--CANCEL/MEMO SPLIT MASTER 제외
           AND BK.POL_CD        = VVD.POL_CD 
           AND VVD.VSL_CD       = substr(@[vvd], 1, 4)      --첫 배가 같음
           AND VVD.SKD_VOY_NO   = substr(@[vvd], 5, 4)
           AND VVD.SKD_DIR_CD   = substr(@[vvd], 9, 1)
           AND BK.POL_CD        = @[pol_cd]       --ORIGIN이 같음
           AND BK.BKG_NO        <> @[bkg_no] --저장하려는 BKG과 다른 BKG이 있으면 예약
           AND ROWNUM = 1
        UNION ALL
        SELECT BK.BKG_NO
          FROM BKG_CONTAINER CNTR
                , BKG_BOOKING BK
         WHERE CNTR.CNTR_NO     = @[cntr_no]    --같은 CNTR
           AND CNTR.BKG_NO      =  BK.BKG_NO
           AND BK.BKG_CGO_TP_CD = 'P'           --EMPTY BKG
           AND BK.BKG_STS_CD    <> 'X'
		   AND BK.BKG_STS_CD    <> 'S'--CANCEL/MEMO SPLIT MASTER 제외
           AND BK.POL_CD        = @[pol_cd]      --ORIGIN이 같음
           AND BK.BKG_NO        <> @[bkg_no]     --저장하려는 BKG과 다른 BKG
           AND NVL(CNTR.CGO_RCV_DT, BK.BKG_CRE_DT) > SYSDATE - 7 --금일 기준 -7일 이내에 ATTACH인 게 있으면 예약
           AND ROWNUM = 1)
 WHERE ROWNUM = 1 --하나라도 있으면 예약			]]></sql>
			<params>
				<param name="cntr_no" type="12" value="" out="N"/>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="bkg_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
