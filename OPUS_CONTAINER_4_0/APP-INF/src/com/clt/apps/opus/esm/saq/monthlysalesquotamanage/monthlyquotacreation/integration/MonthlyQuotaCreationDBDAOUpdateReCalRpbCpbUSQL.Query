<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="MonthlyQuotaCreationDBDAOUpdateReCalRpbCpbUSQL">
			<desc><![CDATA[Ofiice 명 수정 후 RPB, CPB를 재 계산한다.]]></desc>
			<sql><![CDATA[
MERGE INTO SAQ_MON_FCAST_TRNS A 
USING  
    (SELECT MQTA_MDL_VER_NO 
         , ST_DT 
         , TRD_CD 
         , SUB_TRD_CD 
         , RLANE_CD 
         , DIR_CD 
         , CTRT_OFC_CD 
         , SLS_OFC_CD 
         , DECODE(MAX(TOT_TEU), 0, MAX(CM_UC_AMT), ROUND(MAX(TOT_CPB)/MAX(TOT_TEU))) AS CM_UC_AMT 
         , DECODE(MAX(TOT_TEU), 0, MAX(GRS_RPB_REV), ROUND(MAX(TOT_RPB)/MAX(TOT_TEU))) AS GRS_RPB_REV 
      FROM 
           (SELECT MQTA_MDL_VER_NO 
                , ST_DT 
                , TRD_CD 
                , SUB_TRD_CD 
                , IOC_CD 
                , RLANE_CD 
                , DIR_CD 
                , CTRT_OFC_CD 
                , SLS_OFC_CD 
                , LOD_QTY 
                , CM_UC_AMT 
                , GRS_RPB_REV 
                , SUM(LOD_QTY) OVER (PARTITION BY MQTA_MDL_VER_NO, ST_DT, TRD_CD, SUB_TRD_CD, IOC_CD, RLANE_CD, DIR_CD ) AS TOT_TEU 
                , SUM(CM_UC_AMT * LOD_QTY) OVER (PARTITION BY MQTA_MDL_VER_NO, ST_DT, TRD_CD, SUB_TRD_CD, IOC_CD, RLANE_CD, DIR_CD ) AS TOT_CPB 
                , SUM(GRS_RPB_REV * LOD_QTY) OVER (PARTITION BY MQTA_MDL_VER_NO, ST_DT, TRD_CD, SUB_TRD_CD, IOC_CD, RLANE_CD, DIR_CD ) AS TOT_RPB 
             FROM SAQ_MON_FCAST_TRNS 
            WHERE 1=1 
                  AND MQTA_MDL_VER_NO = @[mqta_mdl_ver_no]
                  AND CTRT_OFC_CD = @[chng_ctrt_ofc_cd] 
                  AND SLS_OFC_CD = @[chng_sls_ofc_cd] 
           ) 
     GROUP BY MQTA_MDL_VER_NO 
         , ST_DT 
         , TRD_CD 
         , SUB_TRD_CD 
         , IOC_CD
         , RLANE_CD 
         , DIR_CD 
         , CTRT_OFC_CD 
         , SLS_OFC_CD 
    ) B 
ON (B.MQTA_MDL_VER_NO = A.MQTA_MDL_VER_NO 
    AND B.ST_DT = A.ST_DT 
    AND B.TRD_CD = A.TRD_CD 
    AND B.SUB_TRD_CD = A.SUB_TRD_CD 
    AND B.RLANE_CD = A.RLANE_CD 
    AND B.DIR_CD = A.DIR_CD 
    AND B.CTRT_OFC_CD = A.CTRT_OFC_CD 
    AND B.SLS_OFC_CD = A.SLS_OFC_CD) 
WHEN MATCHED THEN 
       UPDATE 
              SET A.CM_UC_AMT = B.CM_UC_AMT 
            , A.GRS_RPB_REV = B.GRS_RPB_REV 
            , UPD_USR_ID = @[user_id] 
            , UPD_DT = SYSDATE			]]></sql>
			<params>
				<param name="mqta_mdl_ver_no" type="12" value="" out="N"/>
				<param name="chng_ctrt_ofc_cd" type="12" value="" out="N"/>
				<param name="chng_sls_ofc_cd" type="12" value="" out="N"/>
				<param name="user_id" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
