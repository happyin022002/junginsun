<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="LaneSimulationDBDAOSearchBSAbyVVDListRSQL">
			<desc><![CDATA[VSL ê³¼ BSA I/F]]></desc>
			<sql><![CDATA[
#set( $bsa_op_jb_cd = ['001', '002','003'] )
#set( $num = ['01', '02','03','04','05'] )

SELECT  
        B1.VSL_CD 
       ,B1.CHK_FLAG 
       ,B1.DIR_CD  SKD_DIR_CD
       ,B1.VSL_OSHP_CD 
       ,B1.VOP_CD 
       ,B1.VSL_CLSS
       ,B1.BSA_CAPA 
       ,B1.VSL_CLSS_CAPA 
       ,B1.FNL_CO_BSA_CAPA 
#foreach( $jb_index in $bsa_op_jb_cd )
	#foreach( $n_index in $num )
       ,MAX(DECODE(B1.BSA_OP_JB_CD, '$jb_index', DECODE(B1.CNT, TO_NUMBER($n_index), NVL(B1.CRR_BSA_CAPA,0)))) BSA$jb_index$n_index
       ,MAX(DECODE(B1.BSA_OP_JB_CD, '$jb_index', DECODE(B1.CNT, TO_NUMBER($n_index), DECODE(NVL(B1.CRR_BSA_CAPA,0),0,0,B1.CRR_PERF_AMT/B1.CRR_BSA_CAPA)))) AMT$jb_index$n_index
    #end
#end
       ,B1.VSL_FLG
    FROM ( 
        SELECT    A1.COST_YRMON 
#if (${r_vsl} != '') 
		  		 ,DECODE(A1.VSL_CD${r_vsl}) CHK_FLAG
#else 
				 ,'N' AS CHK_FLAG
#end
                 ,DECODE(NVL(A5.VSL_FLG,'*'),'*','N',A5.VSL_FLG)  VSL_FLG
                 ,A1.VSL_CD 
                 ,A1.SKD_VOY_NO 
                 ,A1.DIR_CD 
                 ,NVL(A5.VSL_OSHP_CD,'OTH') VSL_OSHP_CD 
                 ,NVL(A5.VOP_CD,'OTH') VOP_CD 
                 ,NVL(A5.VSL_CLSS,'') VSL_CLSS
                 ,A3.BSA_CAPA 
                 ,NVL(A5.VSL_CLSS_CAPA,'') VSL_CLSS_CAPA 
                 ,A3.FNL_CO_BSA_CAPA 
                 ,A4.BSA_OP_JB_CD BSA_OP_JB_CD1 
                 ,DECODE(A4.BSA_OP_JB_CD, '004','002','005','003','001') BSA_OP_JB_CD 
                 ,A4.CRR_CD 
                 ,A4.CRR_BSA_CAPA 
                 ,A4.CRR_PERF_AMT 
                 ,ROW_NUMBER() OVER(PARTITION BY A1.VSL_CD, A1.SKD_VOY_NO, A1.DIR_CD, DECODE(A4.BSA_OP_JB_CD, '004','002','005','003','001') 
                                    ORDER BY A1.VSL_CD, A1.SKD_VOY_NO, A1.DIR_CD,DECODE(A4.BSA_OP_JB_CD, '004','002','005','003','001'),A4.CRR_BSA_CAPA DESC,A4.CRR_CD) CNT 
             FROM COA_MON_VVD A1 
                 ,COA_LANE_RGST A2 
                 ,BSA_VVD_MST A3 
                 ,BSA_VVD_CRR_PERF A4 
                 ,( 
                  SELECT '' VSL_FLG
                         ,X.VSL_CD
                         ,X.VSL_OSHP_CD
                         ,X.VOP_CD
                         ,DECODE(Y.SUB_TRD_CAPA,0, X.STND_LDB_CAPA,Y.SUB_TRD_CAPA) VSL_CLSS_CAPA
                         ,X.VSL_CLSS_CAPA AS VSL_CLSS
                         ,X.DELT_FLG
                  FROM COA_VSL_RGST X,
                      (
                       SELECT B.VSL_CD, MAX(B.SUB_TRD_CAPA) SUB_TRD_CAPA,B.VSL_SEQ
                         FROM MDM_SUB_TRD A, COA_VSL_SUB_TRD_CAPA B 
                        WHERE A.SUB_TRD_CD = B.SUB_TRD_CD 
                          AND A.DELT_FLG   = 'N'
                          AND A.TRD_CD     <> 'COM'
                        GROUP BY B.VSL_CD, B.VSL_SEQ
                       ) Y
                  WHERE X.VSL_CD             = Y.VSL_CD(+)
                    AND X.VSL_SEQ            = Y.VSL_SEQ(+)
                    AND X.VSL_TP_CD          = 'C'
                    AND NVL(X.DELT_FLG, 'N') = 'N'
                    AND LST_FLG = 'Y'
                  UNION ALL
                  SELECT 'Y' VSL_FLG, VSL_CD, VSL_OSHP_CD, VOP_CD, STND_LDB_CAPA VSL_CLSS_CAPA, VSL_CLSS_CAPA AS VSL_CLSS, 'N' DELT_FLG
                    FROM COA_SIM_VSL_RGST
                 ) A5 
           WHERE A1.TRD_CD     = A3.TRD_CD 
             AND A1.RLANE_CD   = A3.RLANE_CD 
             AND A1.IOC_CD     = A3.IOC_CD 
             AND A1.VSL_CD     = A3.VSL_CD 
             AND A1.SKD_VOY_NO = A3.SKD_VOY_NO 
             AND A1.DIR_CD     = A3.SKD_DIR_CD 
             AND A1.TRD_CD     = A2.TRD_CD 
             AND A1.RLANE_CD   = A2.RLANE_CD 
             AND A1.DIR_CD     = A2.DIR_CD 
             AND A1.IOC_CD     = A2.IOC_CD 
             AND A1.VSL_CD     = A5.VSL_CD 
             AND NVL(A5.DELT_FLG, 'N')   = 'N' 
             AND NVL(A1.DELT_FLG, 'N')   = 'N' 
             AND NVL(A2.DELT_FLG, 'N')   = 'N' 
             AND A3.TRD_CD     = A4.TRD_CD(+) 
             AND A3.RLANE_CD   = A4.RLANE_CD(+) 
             AND A3.VSL_CD     = A4.VSL_CD(+) 
             AND A3.SKD_VOY_NO = A4.SKD_VOY_NO(+) 
             AND A3.SKD_DIR_CD = A4.SKD_DIR_CD(+) 
             AND A4.CRR_CD(+)  != COM_ConstantMgr_PKG.COM_getCompanyCode_FNC
             AND A1.SLS_YRMON  LIKE @[f_year] || '%' 
             AND A1.COST_WK    BETWEEN @[f_fm_wk] AND @[f_to_wk]        
		#if (${trd_cd} != '') 
			 AND A1.TRD_CD     = @[trd_cd]
		#end
		#if (${rlane_cd} != '')
			 AND A1.RLANE_CD   = @[rlane_cd]
		#end 
		#if (${dir_cd} != '') 
			 AND A1.DIR_CD     = @[dir_cd]
		#end
		#if (${ioc_cd} != '') 
			 AND A1.IOC_CD     = @[ioc_cd]
		#end
		#if (${vsl} == 0) 
			 AND A1.VSL_CD    IN (${vsl})
		#end
           ORDER BY A1.VSL_CD, A1.SKD_VOY_NO, A1.DIR_CD,BSA_OP_JB_CD, CNT 
         ) B1 
  WHERE B1.CNT <= 5 
  GROUP BY  
           B1.VSL_CD 
          ,B1.CHK_FLAG 
          ,B1.VSL_FLG
          ,B1.DIR_CD 
          ,B1.VSL_OSHP_CD 
          ,B1.VOP_CD 
          ,B1.VSL_CLSS
          ,B1.BSA_CAPA 
          ,B1.VSL_CLSS_CAPA 
          ,B1.FNL_CO_BSA_CAPA 
 ORDER BY B1.VSL_CD, B1.DIR_CD			]]></sql>
			<params>
				<param name="f_year" type="12" value="2009" out="N"/>
				<param name="f_fm_wk" type="12" value="33" out="N"/>
				<param name="f_to_wk" type="12" value="33" out="N"/>
				<param name="trd_cd" type="12" value="TPS" out="N"/>
				<param name="rlane_cd" type="12" value="CAXTP" out="N"/>
				<param name="dir_cd" type="12" value="E" out="N"/>
				<param name="ioc_cd" type="12" value="O" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
