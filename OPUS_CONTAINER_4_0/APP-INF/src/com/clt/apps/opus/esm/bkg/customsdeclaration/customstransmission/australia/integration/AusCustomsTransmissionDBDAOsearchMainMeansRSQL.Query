<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="AusCustomsTransmissionDBDAOsearchMainMeansRSQL">
			<desc><![CDATA[MAIN MEANS 정보를 조회한다.]]></desc>
			<sql><![CDATA[
SELECT '20' MAIN_MEANS_TYPE,
       NVL((SELECT UPPER(TRIM(VSL_ENG_NM))
              FROM MDM_VSL_CNTR
             WHERE VSL_CD = A.VSL_CD), @[frm_vsl_eng_nm]) AS MAIN_NAME,
       @[vvd_cd] AS MAIN_VVD,
       NVL(A.IB_CSSM_VOY_NO, '') AS CON_MAIN_VVD,
       (CASE
           WHEN @[d_type] = 'O' OR @[d_type] ='P'
              THEN 'B'
           ELSE 'V'
        END) AS MAIN_MODE,
       '' AS MAIN_SSR,
       'L' AS L_MAIN_ID_TYPE,
       NVL((SELECT UPPER(TRIM(LLOYD_NO))
              FROM MDM_VSL_CNTR
             WHERE VSL_CD = A.VSL_CD ), '') AS L_MAIN_ID,
       'C' AS C_MAIN_ID_TYPE,
       NVL((SELECT UPPER(TRIM(CALL_SGN_NO))
              FROM MDM_VSL_CNTR
             WHERE VSL_CD = A.VSL_CD ), '') AS C_MAIN_ID,
       '' AS MAIN_NATION,
       '' AS MAIN_LICENSE,
       'ETA1' AS BKG_DATE_TYPE_ETA1,
       NVL(TO_CHAR(A.VPS_ETA_DT, 'YYYYMMDDHH24MI'), '') AS BKG_DATE_ETA1, --Arrival DATE
       'ETD1' AS BKG_DATE_TYPE_ETD1,
       NVL(TO_CHAR(A.VPS_ETA_DT, 'YYYYMMDDHH24MI'), '') AS BKG_DATE_ETD1, --Departure DATE
       'ETD0' AS BKG_DATE_TYPE_ETD0,
       NVL(B.PRE_ETD, '') AS BKG_DATE_ETD0,    --etd previous port of call
       'ETA2' AS BKG_DATE_TYPE_ETA2,
       NVL(B.NEXT_ETA, '') AS BKG_DATE_ETA2,    -- eta next port of call
       'BER' AS BKG_LOC_TYPE_BER,
       A.YD_CD AS BKG_LOC_BER,   -- Berth
       'LC1' AS BKG_LOC_TYPE_LC1,
       @[port_cd] AS BKG_LOC_LC1,    -- port of call
       'LC0' AS BKG_LOC_TYPE_LC0,
       B.PRE_PORT_CD AS BKG_LOC_LC0,    --  previous port of call
       'LC2' BKG_LOC_TYPE_LC2,
       B.NEXT_PORT_CD AS BKG_LOC_LC2    -- next port of call

  FROM VSK_VSL_PORT_SKD A,
       (SELECT PRE.PRE_PORT_CD,
               PRE.PRE_ETD,
               NEX.NEXT_PORT_CD,
               NEX.NEXT_ETA
          FROM (SELECT MAX(YD_CD) AS PRE_PORT_CD,
                       MAX(TO_CHAR(VPS_ETD_DT, 'YYYYMMDDHH24MI')) AS PRE_ETD
                  FROM VSK_VSL_PORT_SKD
                 WHERE VSL_CD = SUBSTR(@[vvd_cd], 1, 4)
                   AND SKD_VOY_NO = SUBSTR(@[vvd_cd], 5, 4)
                   AND SKD_DIR_CD = SUBSTR(@[vvd_cd], 9, 1)
                   AND CLPT_SEQ IN (SELECT CLPT_SEQ - 1
                                      FROM VSK_VSL_PORT_SKD
                                     WHERE VSL_CD = SUBSTR(@[vvd_cd], 1, 4)
                                       AND SKD_VOY_NO = SUBSTR(@[vvd_cd], 5, 4)
                                       AND SKD_DIR_CD = SUBSTR(@[vvd_cd], 9, 1)
                                       AND VPS_PORT_CD = @[port_cd]
                                       AND NVL(SKD_CNG_STS_CD, ' ') <> 'S')) PRE,
               (SELECT MAX(YD_CD) AS NEXT_PORT_CD,
                       MAX(TO_CHAR(VPS_ETA_DT, 'YYYYMMDDHH24MI')) AS NEXT_ETA
                  FROM VSK_VSL_PORT_SKD
                 WHERE VSL_CD = SUBSTR(@[vvd_cd], 1, 4)
                   AND SKD_VOY_NO = SUBSTR(@[vvd_cd], 5, 4)
                   AND SKD_DIR_CD = SUBSTR(@[vvd_cd], 9, 1)
                   AND CLPT_SEQ IN (SELECT CLPT_SEQ + 1
                                      FROM VSK_VSL_PORT_SKD
                                     WHERE VSL_CD = SUBSTR(@[vvd_cd], 1, 4)
                                       AND SKD_VOY_NO = SUBSTR(@[vvd_cd], 5, 4)
                                       AND SKD_DIR_CD = SUBSTR(@[vvd_cd], 9, 1)
                                       AND VPS_PORT_CD = @[port_cd]
                                       AND NVL(SKD_CNG_STS_CD, ' ') <> 'S')) NEX) B
 WHERE 1 = 1
   AND A.VSL_CD = SUBSTR(@[vvd_cd], 1, 4)
   AND A.SKD_VOY_NO = SUBSTR(@[vvd_cd], 5, 4)
   AND A.SKD_DIR_CD = SUBSTR(@[vvd_cd], 9, 1)
   AND A.VPS_PORT_CD = @[port_cd]
   AND A.CLPT_IND_SEQ = (SELECT MIN(A.CLPT_IND_SEQ)
                           FROM VSK_VSL_PORT_SKD A
                          WHERE A.VSL_CD = SUBSTR(@[vvd_cd], 1, 4)
                            AND A.SKD_VOY_NO = SUBSTR(@[vvd_cd], 5, 4)
                            AND A.SKD_DIR_CD = SUBSTR(@[vvd_cd], 9, 1)
                            AND A.VPS_PORT_CD = @[port_cd]
                            AND NVL(A.SKD_CNG_STS_CD, ' ') <> 'S')
   AND NVL(A.SKD_CNG_STS_CD, ' ') <> 'S'			]]></sql>
			<params>
				<param name="frm_vsl_eng_nm" type="12" value="" out="N"/>
				<param name="vvd_cd" type="12" value="" out="N"/>
				<param name="d_type" type="12" value="" out="N"/>
				<param name="port_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
