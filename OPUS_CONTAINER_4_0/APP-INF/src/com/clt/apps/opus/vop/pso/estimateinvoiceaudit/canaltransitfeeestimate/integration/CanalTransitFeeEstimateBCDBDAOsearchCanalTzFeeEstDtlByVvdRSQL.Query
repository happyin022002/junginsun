<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CanalTransitFeeEstimateBCDBDAOsearchCanalTzFeeEstDtlByVvdRSQL">
			<desc><![CDATA[VVD별 상세 운항통합비를 조회합니다.
-------------------------------------------------------------------
** 변경이력 **
-------------------------------------------------------------------
[CHM-201005061-01]
Due Date를 무조건 ETA-1 기준으로 조회
(이후 로직에서 휴일연산함)
-------------------------------------------------------------------
]]></desc>
			<sql><![CDATA[
SELECT   SUZ_NET_TONG_WGT,
           LOCL_XCH_RT,
           TR_VOL_VAL,
           SCG_RT_AMT,
           DUE_DT,
           VNDR_SEQ,
           PSO_BZTP_CD,
           VSL_CD,
           SKD_VOY_NO,
           SKD_DIR_CD,
           YD_CD,
           CALL_SEQ,
           LGS_COST_CD,
           LGS_COST_FULL_NM,
           RQST_AMT,
           DIFF_RMK,
           CALC_AMT,
           YD_CHG_NO,
           YD_CHG_VER_SEQ,
           DFLT_XPR_DESC,
           SYS_XPR_DESC,
           DFLT_SYS_XPR_DESC,
           INV_NO,
		   INV_RGST_NO,
           (SELECT   x.cntr_pnm_capa
              FROM   mdm_vsl_cntr x
             WHERE   x.vsl_cd = Z.vsl_cd)
              cntr_pnm_capa,
 VSL_CD||SKD_VOY_NO||SKD_DIR_CD VVD
    FROM   (select 
 max(SUZ_NET_TONG_WGT) SUZ_NET_TONG_WGT
,max(LOCL_XCH_RT) LOCL_XCH_RT
,max(TR_VOL_VAL) TR_VOL_VAL    
,max(SCG_RT_AMT) SCG_RT_AMT    
,max(DUE_DT) DUE_DT
,max(VNDR_SEQ) VNDR_SEQ    
,max(PSO_BZTP_CD) PSO_BZTP_CD    
,max(VSL_CD) VSL_CD    
,max(SKD_VOY_NO)     SKD_VOY_NO
,max(SKD_DIR_CD) SKD_DIR_CD    
,max(YD_CD) YD_CD   
,max(CALL_SEQ) CALL_SEQ    
,LGS_COST_CD    
,max(LGS_COST_FULL_NM) LGS_COST_FULL_NM    
,max(RQST_AMT) RQST_AMT    
,max(DIFF_RMK) DIFF_RMK    
,max(CALC_AMT) CALC_AMT    
,YD_CHG_NO    
,YD_CHG_VER_SEQ    
,max(DFLT_XPR_DESC) DFLT_XPR_DESC    
,max(SYS_XPR_DESC) SYS_XPR_DESC    
,max(DFLT_SYS_XPR_DESC) DFLT_SYS_XPR_DESC    
,max(INV_NO) INV_NO 
,max(INV_RGST_NO) INV_RGST_NO
from 
(select 
T5.SUZ_NET_TONG_WGT,
T5.LOCL_XCH_RT,
T5.TR_VOL_VAL,
T5.SCG_RT_AMT,
(SELECT   TO_CHAR(VPS_ETA_DT-1, 'YYYYMMDD')
  FROM   vsk_vsl_port_skd
 WHERE       VSL_CD = substr(@[vvd], 1, 4)
         AND SKD_VOY_NO = substr(@[vvd], 5, 4)
         AND SKD_DIR_CD= substr(@[vvd], 9, 1)
         AND YD_CD = @[yd_cd]) DUE_DT,
T5.VNDR_SEQ,
T1.PSO_BZTP_CD,T1.VSL_CD,T1.SKD_VOY_NO,T1.SKD_DIR_CD,T1.YD_CD,T1.CALL_SEQ
, nvl(T2.LGS_COST_CD, T1.LGS_COST_CD) lgs_cost_cd
, (select x.LGS_COST_FULL_NM from TES_LGS_COST x where x.LGS_COST_CD = T1.LGS_COST_CD) LGS_COST_FULL_NM
,T1.RQST_AMT
,replace(replace(T1.DIFF_RMK, chr(13), to_char(00)), chr(10), to_char(1)) DIFF_RMK
,null CALC_AMT
,T2.yd_chg_no
,T2.yd_chg_ver_seq
,T4.DFLT_XPR_DESC
,T4.SYS_XPR_DESC
,T4.DFLT_SYS_XPR_DESC
,'' INV_NO
,'' INV_RGST_NO
from pso_cnl_tz_fee T5, pso_cnl_tz_fee_dtl T1, (
select lgs_cost_cd, max(yd_chg_no) yd_chg_no, max(yd_chg_ver_seq) yd_chg_ver_seq from pso_yd_chg
where yd_cd = @[yd_cd]--'EGSCA10'
and vndr_seq = @[vndr_seq]--100870
and to_date(@[rev_yrmon], 'yyyymm') between eff_dt and exp_dt
group by lgs_cost_cd ) T2  , pso_yd_chg_xpr T3, pso_chg_xpr T4
where 
    T5.VSL_CD = T1.VSL_CD
AND T5.SKD_VOY_NO = T1.SKD_VOY_NO
AND T5.SKD_DIR_CD= T1.SKD_DIR_CD
AND T5.CALL_SEQ = T1.CALL_SEQ
AND T5.YD_CD = T1.YD_CD
and     T2.LGS_COST_CD  (+) like T1.LGS_COST_CD || '%'
and   T2.yd_chg_no = T3.yd_chg_no   (+)
and   T2.yd_chg_ver_seq = T3.yd_chg_ver_seq (+)
and   T3.chg_xpr_no = T4.chg_xpr_no (+)
and   T5.PSO_BZTP_CD = '5'
#if( ${call_seq} != '')
AND   T5.CALL_SEQ = @[call_seq]
#end
#if( ${vndr_seq} != '')
AND   T5.VNDR_SEQ = @[vndr_seq]
#end
#if( ${yd_cd} != '' ) 
AND T5.YD_CD = @[yd_cd]--'EGSCA10'
#end 
#if( ${vvd} != '')
AND T5.VSL_CD = substr(@[vvd], 1, 4)
AND T5.SKD_VOY_NO = substr(@[vvd], 5, 4)
AND T5.SKD_DIR_CD= substr(@[vvd], 9, 1)
#end
AND (@[sts] <> 10 and @[sts] <> 12)   -- ('12' <> 10 and '12' <> 12 )
union all
SELECT   T5.SUZ_NET_TONG_WGT,
         T5.LOCL_XCH_RT,
         T5.TR_VOL_VAL,
         T5.SCG_RT_AMT,
		 (select TO_CHAR(NVL(p.ap_pay_dt,x.due_dt), 'YYYYMMDD') 
		    from pso_charge x, ap_pay_inv p
			where x.ISS_CTY_CD = T6.ISS_CTY_CD 
			and x.SO_SEQ = T6.SO_SEQ
			and x.inv_no = p.inv_no(+)
			and p.delt_flg(+) = 'N'
			) DUE_DT,
         T5.VNDR_SEQ,
         T1.PSO_BZTP_CD,
         T1.VSL_CD,
         T1.SKD_VOY_NO,
         T1.SKD_DIR_CD,
         T1.YD_CD,
         T1.CALL_SEQ,
         T1.LGS_COST_CD,
         (SELECT   x.LGS_COST_FULL_NM
            FROM   TES_LGS_COST x
           WHERE   x.LGS_COST_CD = T1.LGS_COST_CD)
            LGS_COST_FULL_NM,
         T1.RQST_AMT,
         REPLACE (REPLACE (T1.DIFF_RMK, CHR (13), TO_CHAR (00)),
                  CHR (10),
                  TO_CHAR (1))
            DIFF_RMK,
         T1.CALC_AMT,
         T1.yd_chg_no,
         T1.yd_chg_ver_seq,
         T1.XPR_DESC,
		 T1.foml_DESC,
         '' DFLT_SYS_XPR_DESC,
         T6.INV_NO,
         T6.INV_RGST_NO /*2009.12.15 add*/
  FROM   pso_cnl_tz_fee T5,
         pso_cnl_tz_fee_dtl T1,
         pso_charge T6
 WHERE       T5.VSL_CD = T1.VSL_CD
         AND T5.SKD_VOY_NO = T1.SKD_VOY_NO
         AND T5.SKD_DIR_CD = T1.SKD_DIR_CD
         AND T5.CALL_SEQ = T1.CALL_SEQ
         AND T5.YD_CD = T1.YD_CD
         AND T6.ISS_CTY_CD = T5.ISS_CTY_CD
         AND T6.SO_SEQ = T5.SO_SEQ
         AND T5.PSO_BZTP_CD = '5'
         AND T5.CNL_TZ_BZTP_CD = 'E'
		 AND T5.REV_YRMON = @[rev_yrmon]
#if( ${vndr_seq} != '')
AND   T5.VNDR_SEQ = @[vndr_seq]
#end
#if( ${yd_cd} != '' ) 
AND T5.YD_CD = @[yd_cd]--'EGSCA10'
#end 
#if( ${vvd} != '')
AND T5.VSL_CD = substr(@[vvd], 1, 4)
AND T5.SKD_VOY_NO = substr(@[vvd], 5, 4)
AND T5.SKD_DIR_CD= substr(@[vvd], 9, 1)
#end
AND ( @[sts] = 10 or @[sts] = 12 )  --('12' = 10 or 12 = 12 )
)
group by lgs_cost_cd, yd_chg_no, yd_chg_ver_seq
) Z
ORDER BY   Z.lgs_cost_cd			]]></sql>
			<params>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="yd_cd" type="12" value="" out="N"/>
				<param name="vndr_seq" type="12" value="" out="N"/>
				<param name="rev_yrmon" type="12" value="" out="N"/>
				<param name="call_seq" type="12" value="" out="N"/>
				<param name="sts" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
