<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="VSKCodeFinderDBDAOIdentifyProperVVDinCandidateRSQL">
			<desc><![CDATA[Identifying proper VVD in Candidate]]></desc>
			<sql><![CDATA[
SELECT  XX.VSL_SLAN_CD
     ,  XX.VSL_CD
     ,  XX.SKD_VOY_NO
     ,  XX.SKD_DIR_CD

	 ,  XX.VPS_PORT_CD
	 ,  XX.CLPT_IND_SEQ

     ,  XX.CALL_SGN_NO
     ,  XX.LLOYD_NO
     ,  XX.POL_CD
     ,  XX.MATCHED_VVD_COUNT
     ,  XX.EFFECTIVE_VVD_CHK_RSLT_CD
     ,  XX.EFFECTIVE_VVD_CHK_RSLT_RMK
     ,  XX.MATCH_RNK

FROM    (      
  
--=================================================================
SELECT      PS.SLAN_CD			AS VSL_SLAN_CD
		 ,	PS.VSL_CD
         ,  PS.SKD_VOY_NO
         ,  PS.SKD_DIR_CD
         ,  PS.VPS_PORT_CD
         ,  PS.CLPT_IND_SEQ

         --,  PS.CLPT_SEQ
         --,  PS.IB_CSSM_VOY_NO
         --,  PS.OB_CSSM_VOY_NO

		 ,  ''					AS CALL_SGN_NO
		 ,  ''					AS LLOYD_NO
		 ,	''					AS POL_CD
		 ,  ''					AS MATCHED_VVD_COUNT
		 ,  ''					AS EFFECTIVE_VVD_CHK_RSLT_CD
		 ,	''					AS EFFECTIVE_VVD_CHK_RSLT_RMK

     	,  	CASE 	WHEN PS.OB_CSSM_VOY_NO 				= @[ob_cssm_voy_no] AND PS.VPS_PORT_CD = @[pol_cd]	THEN '1'
					WHEN SUBSTR(PS.OB_CSSM_VOY_NO,2,5) 	= @[ob_cssm_voy_no] AND PS.VPS_PORT_CD = @[pol_cd]	THEN '2'
					WHEN PS.OB_CSSM_VOY_NO 				= @[ob_cssm_voy_no] THEN '3'
					WHEN SUBSTR(PS.OB_CSSM_VOY_NO,2,5) 	= @[ob_cssm_voy_no] THEN '4'
                    WHEN SUBSTR(PS.SKD_VOY_NO,2,5)||PS.SKD_DIR_CD 	= @[ob_cssm_voy_no] AND PS.VPS_PORT_CD = @[pol_cd] THEN '5'
                    WHEN SUBSTR(PS.SKD_VOY_NO,2,5)||PS.SKD_DIR_CD 	= @[ob_cssm_voy_no] THEN '6'
             		ELSE '9'
        	END  	AS MATCH_RNK

FROM        VSK_VSL_PORT_SKD    		PS
WHERE       1 = 1
AND         PS.TURN_PORT_IND_CD 		IN ('Y','N')
AND			NVL(PS.SKD_CNG_STS_CD,'*')	<> 'S'
AND         PS.VT_ADD_CALL_FLG  		IS NULL       --:Excluding Virtual Add Calling Port:--

--AND         PS.CLPT_IND_SEQ     		= (	SELECT     MAX(PPS.CLPT_IND_SEQ)
--                                   			FROM       VSK_VSL_PORT_SKD 		PPS
--                                   			WHERE      PPS.VSL_CD       		= PS.VSL_CD
--                                   			AND        PPS.SKD_VOY_NO   		= PS.SKD_VOY_NO
--                                   			AND        PPS.SKD_DIR_CD   		= PS.SKD_DIR_CD
--                                   			AND        PPS.VPS_PORT_CD  		= PS.VPS_PORT_CD
--								   			AND        PPS.VT_ADD_CALL_FLG 		IS NULL
--                                  			)

----AND			PS.VPS_PORT_CD			= [pol_cd]

AND         PS.VSL_CD           
            IN
            (
            --==================================================================
            SELECT  XX.VSL_CD
                  --, XX.CALL_SGN_NO
                  --, XX.LLOYD_NO
                  --, XX.DELT_FLG
            FROM    (
                    ------------------------------------------------------------       
                    SELECT  X.*
                          , DENSE_RANK() OVER (ORDER BY VSL_CD_1ST_RNK ASC, DELT_FLG ASC) VSL_CD_2ND_RNK
                    FROM    (
                            ----------------------------------------------------
                            SELECT  X.DELT_FLG
                                  , X.VSL_CD
                                  , X.CALL_SGN_NO
                                  , X.LLOYD_NO
                                  , CASE WHEN X.CALL_SGN_NO = @[call_sgn_no] THEN '1'
                                         WHEN X.LLOYD_NO    = @[lloyd_no]	 THEN '2'
                                         ELSE ''
                                    END  AS VSL_CD_1ST_RNK
                            FROM    MDM_VSL_CNTR      		X
                            WHERE   (X.CALL_SGN_NO     		= @[call_sgn_no]
                                     OR
                                     X.LLOYD_NO        		= @[lloyd_no]
                                    )                                  
                            ----------------------------------------------------   
                            ) X           
                    ------------------------------------------------------------
                    ) XX     
            WHERE   XX.VSL_CD_2ND_RNK                  		= '1'     
            --==================================================================               
            ) 
AND         (PS.OB_CSSM_VOY_NO                          	= @[ob_cssm_voy_no]
			 OR
			 SUBSTR(PS.OB_CSSM_VOY_NO,2,5)                  = @[ob_cssm_voy_no]
			 OR 
             SUBSTR(PS.SKD_VOY_NO,2,5)||PS.SKD_DIR_CD		= @[ob_cssm_voy_no] 
			)

ORDER BY 	CASE 	WHEN PS.OB_CSSM_VOY_NO 				= @[ob_cssm_voy_no] AND PS.VPS_PORT_CD = @[pol_cd]	THEN '1'
					WHEN SUBSTR(PS.OB_CSSM_VOY_NO,2,5) 	= @[ob_cssm_voy_no] AND PS.VPS_PORT_CD = @[pol_cd]	THEN '2'
					WHEN PS.OB_CSSM_VOY_NO 				= @[ob_cssm_voy_no] THEN '3'
					WHEN SUBSTR(PS.OB_CSSM_VOY_NO,2,5) 	= @[ob_cssm_voy_no] THEN '4'
                    WHEN SUBSTR(PS.SKD_VOY_NO,2,5)||PS.SKD_DIR_CD 	= @[ob_cssm_voy_no] AND PS.VPS_PORT_CD = @[pol_cd] THEN '5'
                    WHEN SUBSTR(PS.SKD_VOY_NO,2,5)||PS.SKD_DIR_CD 	= @[ob_cssm_voy_no] THEN '6'
             		ELSE '9'
        	END					ASC
		,	PS.CLPT_IND_SEQ		DESC
) XX        

--=================================================================
WHERE    ROWNUM                      = 1			]]></sql>
			<params>
				<param name="ob_cssm_voy_no" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="call_sgn_no" type="12" value="" out="N"/>
				<param name="lloyd_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
