<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="GeneralInvoiceAuditDBDAOGetYearlyVesselCallPortRSQL">
			<desc><![CDATA[당해년도 특정 port의 모든 선박(feeder 제외)의 calling count
2014.3.05 이윤정 [선반영] VPS_ETB_DT 기준 변경 (해당연도 1월1일 ~ 현재일)
2014.04.21 SKY [선반영] 조회 시점 VVD의 대상 Port의 ETB 기준으로 count를 할 수 있도록
로직 수정
[2015.07.21]Virtual Add Calling 처리. VSK_VSL_PORT_SKD.NVL(VT_ADD_CALL_FLG, 'N') = 'N'
[2015.12.03]MDM_VSL_CNTR.FDR_DIV_CD 조건 주석처리.
[2015.03.18]Default 0 추가.]]></desc>
			<sql><![CDATA[
SELECT DECODE(NVL(COUNT(*),0), 0, 0, MAX(RNUM)) RNUM /*2015.03.18 Default 0 처리*/
  FROM (SELECT ROW_NUMBER() OVER (ORDER BY VPS_ETA_DT) RNUM
             , T1.VSL_CD
             , T1.SKD_VOY_NO
             , T1.SKD_DIR_CD
             , T1.VSL_SLAN_CD
             , T2.VPS_PORT_CD
             , T2.YD_CD
             , T2.VPS_ETA_DT
             , T2.VPS_ETB_DT
             , T2.VPS_ETD_DT
          FROM VSK_VSL_SKD T1
             , VSK_VSL_PORT_SKD T2
             , MDM_VSL_CNTR T3
             , MDM_VSL_SVC_LANE T4
             , (SELECT VP.VSL_CD
                     , VP.VPS_PORT_CD
                     , MAX(TO_DATE(TO_CHAR(VP.VPS_ETB_DT,'YYYY')||'0101','YYYYMMDD')) MAX_VPS_ETB_DT
                  FROM VSK_VSL_PORT_SKD VP
                 WHERE 1=1
                   AND VP.VSL_CD        = SUBSTR(@[vvd],1,4)
                   AND VP.SKD_VOY_NO    = SUBSTR(@[vvd],5,4)
                   AND VP.SKD_DIR_CD    = SUBSTR(@[vvd],9)
                   AND VP.VPS_PORT_CD   = SUBSTR(@[yd_cd], 1, 5)
                   AND VP.YD_CD         = @[yd_cd]
                   AND VP.CLPT_IND_SEQ  = @[clpt_ind_seq]
                   AND NVL(VP.VT_ADD_CALL_FLG, 'N') = 'N' /*2015.07.21 Add*/
                 GROUP BY VP.VSL_CD
                     , VP.VPS_PORT_CD
                ) V
         WHERE T1.VSL_CD        = T2.VSL_CD
           AND T1.SKD_VOY_NO    = T2.SKD_VOY_NO
           AND T1.SKD_DIR_CD    = T2.SKD_DIR_CD
           AND T1.VSL_CD        = T3.VSL_CD
           AND T1.VSL_SLAN_CD   = T4.VSL_SLAN_CD
           AND T2.VPS_PORT_CD   = V.VPS_PORT_CD
           AND T2.VPS_ETB_DT BETWEEN V.MAX_VPS_ETB_DT AND SYSDATE
           AND T2.TURN_PORT_IND_CD IN ('Y', 'N')
           AND NVL(T2.SKD_CNG_STS_CD,' ')   <> 'S'
           AND NVL(T2.VT_ADD_CALL_FLG, 'N') = 'N' /*2015.07.21 Add*/
           AND T4.VSL_SVC_TP_CD             <> 'O'
       ) T
 WHERE T.VSL_CD     = SUBSTR(@[vvd],1,4)
   AND T.SKD_VOY_NO = SUBSTR(@[vvd],5,4)
   AND T.SKD_DIR_CD = SUBSTR(@[vvd],9)
			]]></sql>
			<params>
				<param name="vvd" type="12" value="ACKT0024S" out="N"/>
				<param name="yd_cd" type="12" value="KRPUS01" out="N"/>
				<param name="clpt_ind_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
