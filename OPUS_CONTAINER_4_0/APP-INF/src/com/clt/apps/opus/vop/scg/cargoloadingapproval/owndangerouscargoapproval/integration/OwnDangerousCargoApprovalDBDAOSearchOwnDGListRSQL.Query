<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="OwnDangerousCargoApprovalDBDAOSearchOwnDGListRSQL">
			<desc><![CDATA[DG-Part1, DG-Part2조회]]></desc>
			<sql><![CDATA[
SELECT 
       BOOKING_NO ,
       BKG_STS_CD ,
       DG_CNTR_SEQ ,
       CNTR_CGO_SEQ ,
       RQST_DAY ,
       SPCL_CGO_AUTH_CD ,
       SPCL_CGO_AUTH_RJCT_CD ,
       APRO_REF_NO ,
       CASE WHEN EDI_CHK 		<> 'Y' OR EDI_CHK IS NULL				THEN '0' 
			WHEN EDI_SND_NO 	= 'Y'  									THEN '1'
            WHEN MAX(SPCL_CGO_AUTH_CD) OVER(PARTITION BY RNK )  <> 'P' 	THEN '0'
            ELSE '1'
       END EDI_CHK_TYPE,
       CASE WHEN EML_CHK = 'S' 				                                             THEN '1' 
			WHEN EML_CHK = 'N' OR  MAX(SPCL_CGO_AUTH_CD) OVER(PARTITION BY RNK )  <> 'P' THEN '0'
            ELSE '1'
       END EML_CHK_TYPE,
       EDI_SND_NO ,
       EML_SND_NO ,
       EML_SND_HIS_FLG ,
       EDI_SND_HIS_FLG ,
       EML_CHK ,
       EML_ADDR ,
       PRE_SEQ ,
       EDI_MSG_STS_CD ,
       EDI_DEL_STS_CD ,
       SLAN_CD ,
       VSL_CD ,
       VSL_NM ,
       SKD_VOY_NO ,
       SKD_DIR_CD ,
       PRP_SHP_NM ,
       DIFF_RMK ,
       DCGO_STS_CD ,
       CRR_CD ,
       CRR_CODE ,
       POR_CD ,
       POL_CD ,
       EDI_CHK ,
       MAPG_TRSM_BND_CD ,
       MAPG_TRSM_DT ,
       MAPG_TRSM_SPCL_CGO_CATE_CD ,
       MAPG_PRNR_SPCL_CGO_SEQ ,
       MAPG_EDI_TRSM_STS_CD ,
       VPS_ETA_DT ,
       POD_CD ,
       DEL_CD ,
       CNTR_TPSZ_CD ,
       DG_TP ,
       IMDG_UN_NO ,
       IMDG_SEGR_GRP_NM ,
       IMDG_UN_NO_SEQ ,
       IMDG_CLSS_CD ,
       IMDG_SUBS_RSK_LBL_CD ,
       MRN_POLUT_FLG ,
       IMDG_PCK_GRP_CD ,
       IMDG_LMT_QTY_FLG ,
       IMDG_EXPT_QTY_FLG ,
       FLSH_PNT_CDO_TEMP ,
       GRS_WGT ,
       NET_WGT ,
       PSA_NO ,
       HCDG_FLG ,
       BKG_NO ,
       SPCL_CGO_APRO_RQST_SEQ ,
       SPCL_CGO_RQST_SEQ ,
       VSL_PRE_PST_CD ,
       VSL_SEQ ,
       CNTR_NO ,
       DCGO_REF_NO ,
       DCGO_SEQ ,
       DCGO_QTY ,
       LST_RQST_DAT_FLG ,
       BKG_RCV_TERM_CD ,
       BKG_DE_TERM_CD ,
       POL_CLPT_IND_SEQ ,
       POD_CLPT_IND_SEQ ,
       POL_YD_CD ,
       POD_YD_CD ,
       RGN_SHP_OPR_CD ,
       SPCL_CGO_CATE_CD ,
       SPCL_CGO_AUTH_NO ,
       AUTH_OFC_CD ,
       SPCL_CGO_AUTH_SEQ ,
       NET_WGT_SUM ,
       SCG_FLG ,
       RQST_AUTH_CD ,
       RQST_OFC_CD ,
       RQST_DT ,
       RQST_GDT ,
       RQST_USR_ID ,
       AUTH_DT ,
       AUTH_GDT ,
       AUTH_USR_ID ,
       SPCL_CGO_AUTH_RMK ,
       SPCL_RQST_DESC ,
       IN_IMDG_PCK_QTY1 ,
       OUT_IMDG_PCK_QTY1 ,
       INTMD_IMDG_PCK_QTY1 ,
       IMDG_SEGR_GRP_NO ,
       RSD_FLG ,
       CFR_FLG ,
       ITM_STS_CD ,
       --2016-07-01
       UPD_DT 
FROM(
    SELECT RANK() OVER( ORDER BY A.VPS_ETA_DT, A.SLAN_CD, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.CRR_CD, A.POL_CD, A.POD_CD, A.BKG_NO ) AS RNK
         , BOOKING_NO
         , BKG_STS_CD
         , DG_CNTR_SEQ
         , CNTR_CGO_SEQ
         , RQST_DAY
         , SPCL_CGO_AUTH_CD
         , SPCL_CGO_AUTH_RJCT_CD
         , APRO_REF_NO

         , EDI_SND_NO
         , EML_SND_NO


         ,(SELECT  MAX(CASE WHEN EM.EML_PROC_STS_CD IS NOT NULL AND  EM2.EML_PROC_STS_CD IS NULL THEN DECODE(EM.EML_PROC_STS_CD, '1','W','3','Y','4','F','')
                            WHEN EM.EML_PROC_STS_CD IS NULL AND  EM2.EML_PROC_STS_CD IS NOT NULL THEN DECODE(EM2.EML_PROC_STS_CD,'1','W','3','Y','4','F','')
                            WHEN EM.EML_PROC_STS_CD = EM2.EML_PROC_STS_CD                        THEN DECODE(EM.EML_PROC_STS_CD, '1','W','3','Y','4','F','')
                            WHEN EM.EML_PROC_STS_CD <> EM2.EML_PROC_STS_CD                       THEN 'W'
                            ELSE ''
                       END) 
              FROM SCG_VVD_APRO_RQST RQ ,
                   COM_EML_SND_INFO EM ,
                   COM_EML_SND_INFO EM2
             WHERE 1 = 1
               AND RQ.INDIV_EML_SND_NO = EM.EML_SND_NO(+)
               AND RQ.OALL_EML_SND_NO  = EM2.EML_SND_NO(+)
               AND RQ.BKG_NO           = A.BOOKING_NO   
               AND RQ.VSL_PRE_PST_CD   = A.VSL_PRE_PST_CD
               AND RQ.VSL_SEQ          = A.VSL_SEQ
               AND RQ.VSL_CD           = A.VSL_CD
               AND RQ.SKD_VOY_NO       = A.SKD_VOY_NO
               AND RQ.SKD_DIR_CD       = A.SKD_DIR_CD
          ) EML_SND_HIS_FLG
            
            
         , CASE WHEN (SELECT COUNT(1) 
                      FROM   SCG_VVD_APRO_RQST   RQ
                      WHERE  1 = 1
                      AND    RQ.BKG_NO           = A.BOOKING_NO   
                      AND    RQ.VSL_PRE_PST_CD   = A.VSL_PRE_PST_CD
                      AND    RQ.VSL_SEQ          = A.VSL_SEQ
                      AND    RQ.VSL_CD           = A.VSL_CD
                      AND    RQ.SKD_VOY_NO       = A.SKD_VOY_NO
                      AND    RQ.SKD_DIR_CD       = A.SKD_DIR_CD
                      AND    RQ.MAPG_EDI_TRSM_STS_CD = 'S'     
                      ) > 0  THEN 'Y'
                 ELSE ''
            END  EDI_SND_HIS_FLG 

         , EML_CHK

         , EML_ADDR
         , PRE_SEQ
         , DECODE(EDI_MSG_STS_CD, 'NR', 'N', EDI_MSG_STS_CD) EDI_MSG_STS_CD
         , DECODE(EDI_MSG_STS_CD, 'NR', 'Y', 'N')            EDI_DEL_STS_CD
         , SLAN_CD
         , VSL_CD
         , VSL_NM
         , SKD_VOY_NO
         , SKD_DIR_CD
         , PRP_SHP_NM
         , DIFF_RMK
         , DCGO_STS_CD
         , CRR_CD
         , CRR_CODE
         , POR_CD
         , POL_CD
         , EDI_CHK
         , MAPG_TRSM_BND_CD
         , MAPG_TRSM_DT
         , MAPG_TRSM_SPCL_CGO_CATE_CD
         , MAPG_PRNR_SPCL_CGO_SEQ
         , MAPG_EDI_TRSM_STS_CD
         , VPS_ETA_DT
         , POD_CD
         , DEL_CD
         , CNTR_TPSZ_CD
         , DG_TP
         , IMDG_UN_NO
         , IMDG_SEGR_GRP_NM
         , IMDG_UN_NO_SEQ
         , IMDG_CLSS_CD
         , IMDG_SUBS_RSK_LBL_CD
         , MRN_POLUT_FLG
         , IMDG_PCK_GRP_CD
         , IMDG_LMT_QTY_FLG
         , IMDG_EXPT_QTY_FLG
         , FLSH_PNT_CDO_TEMP
         , GRS_WGT
         , NET_WGT
         , PSA_NO
         , HCDG_FLG
         , BKG_NO
         , SPCL_CGO_APRO_RQST_SEQ
         , SPCL_CGO_RQST_SEQ
         , VSL_PRE_PST_CD
         , VSL_SEQ
         , CNTR_NO
         , DCGO_REF_NO
         , DCGO_SEQ
         , DCGO_QTY
         , LST_RQST_DAT_FLG
         , BKG_RCV_TERM_CD
         , BKG_DE_TERM_CD
         , POL_CLPT_IND_SEQ
         , POD_CLPT_IND_SEQ
         , POL_YD_CD
         , POD_YD_CD
         , RGN_SHP_OPR_CD
         , SPCL_CGO_CATE_CD
         , SPCL_CGO_AUTH_NO
         , AUTH_OFC_CD
         , SPCL_CGO_AUTH_SEQ
         , NET_WGT_SUM
         , SCG_FLG
         , RQST_AUTH_CD
         , RQST_OFC_CD
         , RQST_DT
         , RQST_GDT
         , RQST_USR_ID
         , AUTH_DT
         , AUTH_GDT
         , AUTH_USR_ID
         , SPCL_CGO_AUTH_RMK
         , SPCL_RQST_DESC
         , IN_IMDG_PCK_QTY1
         , OUT_IMDG_PCK_QTY1
         , INTMD_IMDG_PCK_QTY1
         , IMDG_SEGR_GRP_NO
         , NVL(RSD_FLG, 'N') RSD_FLG
         , CFR_FLG
         , ITM_STS_CD
          --2016-07-01
         , UPD_DT
     FROM (
    SELECT	A.BKG_NO AS BOOKING_NO,
            A.BKG_STS_CD,
            A.DG_CNTR_SEQ,
            A.CNTR_CGO_SEQ, 
            ROUND(NVL(GLOBALDATE_PKG.TIME_CONV_FNC(COM_ConstantMgr_PKG.COM_getBaseLocationCode_FNC(),SYSDATE,'GMT'), SYSDATE) - A.RQST_GDT,1) AS RQST_DAY, 
            DECODE(NVL(G.SPCL_CGO_AUTH_CD,'R'),'R',DECODE(A.SPCL_RQST_FLG,'Y','S','')||'R'||A.SPCL_CGO_RQST_SEQ,G.SPCL_CGO_AUTH_CD) AS SPCL_CGO_AUTH_CD,
            SUBSTR(DECODE(NVL(G.SPCL_CGO_AUTH_CD,'R'),'R',DECODE(A.SPCL_RQST_FLG,'Y','','')||'R'||A.SPCL_CGO_RQST_SEQ,G.SPCL_CGO_AUTH_CD),1,1) AS SPCL_CGO_AUTH_CD_CHK, 
            G.SPCL_CGO_AUTH_RJCT_CD, 
            G.APRO_REF_NO

        ,	DECODE(A.MAPG_EDI_TRSM_STS_CD, 'S', 'Y', 'SX', 'Y', NVL(A.MAPG_EDI_TRSM_STS_CD, '')) AS EDI_SND_NO
        ,	(SELECT DECODE(EML_PROC_STS_CD,'1','W','3','Y','4','F','')
             FROM   COM_EML_SND_INFO   	EM
             WHERE  EM.EML_SND_NO 		= A.OALL_EML_SND_NO) AS EML_SND_NO

        ,	CASE WHEN LENGTH(NVL(TRIM(A.OALL_EML_SND_NO),0)) = 1 AND A.CRR_CD IN ('HLC', 'OOL', 'HMM', 'HSD')	/*'HAM'*/ 
                    THEN 'Y'
                 WHEN LENGTH(NVL(TRIM(A.OALL_EML_SND_NO),0)) > 1
                    THEN 'S'
                 ELSE 'N' 
            END  AS EML_CHK

        ,	(
             SELECT CNTC_PSON_EML_CTNT
               FROM SCG_CNTC_PNT
              WHERE RGN_SHP_OPR_CD = @[rgn_shp_opr_cd]
                AND CRR_CD = A.CRR_CD
                AND SLAN_CD = A.SLAN_CD
                AND SPCL_CGO_CATE_CD = 'DG'
                AND CNTC_PSON_EML_CTNT IS NOT NULL
                AND DELT_FLG != 'Y'              
                AND ROWNUM = 1
            ) EML_ADDR ,
            A.PRE_SEQ,
			
			--:2016-05-03:No need this column:--
			NULL			AS EDI_MSG_STS_CD,

            A.SLAN_CD, 
            A.VSL_CD, 
            A.VSL_ENG_NM AS VSL_NM,
            A.SKD_VOY_NO,
            A.SKD_DIR_CD,
            A.PRP_SHP_NM,
            A.DIFF_RMK,
            DECODE(A.DCGO_STS_CD, 'L', 'Liquid', 'G', 'GAS', 'P', 'PASTE', 'S', 'SOLID','') DCGO_STS_CD,
            A.CRR_CD,
            '' CRR_CODE,
            A.POR_CD, 
            A.POL_CD, 
            CASE WHEN A.CRR_CD IN ('HLC', 'OOL', 'HMM', 'HSD') THEN 
                 (SELECT CASE WHEN A.CRR_CD IN('HLC') AND CONTI_CD IN ('A', 'E', 'M') THEN 'Y'
                              WHEN A.CRR_CD IN ('OOL', 'HMM', 'HSD') AND CONTI_CD = 'E' THEN 'Y'
                         ELSE 'N'
                     END EDI_CHK
                    FROM MDM_LOCATION 
                   WHERE LOC_CD = A.POL_CD
                     AND NVL(DELT_FLG, 'N') <> 'Y'	
                 )
            END EDI_CHK ,
            A.MAPG_TRSM_BND_CD,
            A.MAPG_TRSM_DT,
            A.MAPG_TRSM_SPCL_CGO_CATE_CD,
            A.MAPG_PRNR_SPCL_CGO_SEQ,
            A.MAPG_EDI_TRSM_STS_CD,
            TO_CHAR(A.VPS_ETA_DT,'YYYY-MM-DD HH24:MI') AS VPS_ETA_DT,
            A.POD_CD, 
            A.DEL_CD, 
            A.CNTR_TPSZ_CD, 
            'DD' AS DG_TP, 
            A.IMDG_UN_NO, 
            ( SELECT LISTAGG (X.IMDG_SEGR_GRP_NO||'|'||X.IMDG_SEGR_GRP_NM, ',') WITHIN GROUP (ORDER BY X.IMDG_SEGR_GRP_NO||'|'||X.IMDG_SEGR_GRP_NM)
                FROM SCG_IMDG_SEGR_GRP X
                   , SCG_IMDG_SEGR_GRP_DTL Y
               WHERE X.IMDG_SEGR_GRP_NO = Y.IMDG_SEGR_GRP_NO
                 AND Y.IMDG_UN_NO = A.IMDG_UN_NO
               GROUP BY Y.IMDG_UN_NO 
            ) IMDG_SEGR_GRP_NM, 
            A.IMDG_UN_NO_SEQ, 
            A.IMDG_CLSS_CD, 
            A.IMDG_SUBS_RSK_LBL_CD1 
            ||DECODE(A.IMDG_SUBS_RSK_LBL_CD2,NULL,NULL,'/') 
            ||A.IMDG_SUBS_RSK_LBL_CD2 
            ||DECODE(A.IMDG_SUBS_RSK_LBL_CD3,NULL,NULL,'/') 
            ||A.IMDG_SUBS_RSK_LBL_CD3 
            ||DECODE(A.IMDG_SUBS_RSK_LBL_CD4,NULL,NULL, '/') 
            ||A.IMDG_SUBS_RSK_LBL_CD4 AS IMDG_SUBS_RSK_LBL_CD, 		 
            A.MRN_POLUT_FLG, 
            DECODE(A.IMDG_PCK_GRP_CD,'N',NULL, 
                                     '1','I', 
                                     '2','II', 
                                     '3','III') AS IMDG_PCK_GRP_CD, 
            A.IMDG_LMT_QTY_FLG, 
            A.IMDG_EXPT_QTY_FLG, 
            A.FLSH_PNT_CDO_TEMP, 
            A.GRS_WGT, 
            A.NET_WGT, 
            A.PSA_NO, 
            A.HCDG_FLG, 
            A.BKG_NO, 
            A.SPCL_CGO_APRO_RQST_SEQ, 
            A.SPCL_CGO_RQST_SEQ, 
            A.VSL_PRE_PST_CD, 
            A.VSL_SEQ, 
            A.CNTR_NO, 
            A.DCGO_REF_NO,
            A.DCGO_SEQ, 
            A.DCGO_QTY, 
            A.LST_RQST_DAT_FLG, 
            A.BKG_RCV_TERM_CD, 
            A.BKG_DE_TERM_CD, 
            A.POL_CLPT_IND_SEQ, 
            A.POD_CLPT_IND_SEQ, 
            A.POL_YD_CD, 
            A.POD_YD_CD, 
            A.RGN_SHP_OPR_CD, 
            A.SPCL_CGO_CATE_CD, 
            G.SPCL_CGO_AUTH_NO, 
            G.AUTH_OFC_CD, 
            G.SPCL_CGO_AUTH_SEQ, 
            SCG_GET_MPA1_NET_FNC(A.VSL_CD,A.SKD_VOY_NO,A.SKD_DIR_CD,A.POL_CD, 
                                 A.POD_CD,A.IMDG_CLSS_CD) AS NET_WGT_SUM, 
            '' AS SCG_FLG, 
            '' AS RQST_AUTH_CD, 
            A.RQST_OFC_CD, 
            TO_CHAR(A.RQST_DT,'YYYY-MM-DD HH24:MI') AS RQST_DT, 
            TO_CHAR(A.RQST_GDT,'YYYY-MM-DD HH24:MI') AS RQST_GDT, 
            A.RQST_USR_ID, 
            TO_CHAR(G.AUTH_DT,'YYYY-MM-DD HH24:MI')AS AUTH_DT, 
            TO_CHAR(G.AUTH_GDT,'YYYY-MM-DD HH24:MI')AS AUTH_GDT, 
            G.AUTH_USR_ID, 
            G.SPCL_CGO_AUTH_RMK, 
            A.SPCL_RQST_DESC, 
            A.IN_IMDG_PCK_QTY1, 
            A.OUT_IMDG_PCK_QTY1, 
            A.INTMD_IMDG_PCK_QTY1,
            A.IMDG_SEGR_GRP_NO,
            A.RSD_FLG,
            A.CFR_FLG,
             CASE 
                 WHEN(SELECT /*+ INDEX_DESC(XPKSCG_AUTHORIZATION) */ COUNT(BKG_NO) FROM SCG_AUTHORIZATION WHERE BKG_NO = A.BKG_NO AND SPCL_CGO_CATE_CD = 'DG' AND SPCL_CGO_AUTH_CD IN ('Y','N') AND ROWNUM = 1 ) >= 1 THEN 
                     (SELECT  DECODE(COUNT(B.BKG_NO), 0,
                                     'N',
                                      DECODE(MAX(B.IMDG_CLSS_CD||B.IMDG_UN_NO||B.IMDG_UN_NO_SEQ||B.PRP_SHP_NM||B.HZD_DESC||B.GRS_WGT||B.NET_WGT||B.IMDG_PCK_GRP_CD||B.PSA_NO||B.FLSH_PNT_CDO_TEMP||B.EMS_NO||B.MRN_POLUT_FLG||B.EMER_CNTC_PHN_NO_CTNT||B.EMER_CNTC_PSON_NM||B.CERTI_NO||B.NET_EXPLO_WGT||B.OUT_IMDG_PCK_QTY1||B.OUT_IMDG_PCK_CD1||B.OUT_IMDG_PCK_QTY2||B.OUT_IMDG_PCK_CD2||B.IN_IMDG_PCK_QTY1||B.IN_IMDG_PCK_CD1||B.IN_IMDG_PCK_QTY2||B.IN_IMDG_PCK_CD2),
                                             MAX(S.IMDG_CLSS_CD||S.IMDG_UN_NO||S.IMDG_UN_NO_SEQ||S.PRP_SHP_NM||S.HZD_DESC||S.GRS_WGT||S.NET_WGT||S.IMDG_PCK_GRP_CD||S.PSA_NO||S.FLSH_PNT_CDO_TEMP||S.EMS_NO||S.MRN_POLUT_FLG||S.EMER_CNTC_PHN_NO_CTNT||S.EMER_CNTC_PSON_NM||S.CERTI_NO||S.NET_EXPLO_WGT||S.OUT_IMDG_PCK_QTY1||S.OUT_IMDG_PCK_CD1||S.OUT_IMDG_PCK_QTY2||S.OUT_IMDG_PCK_CD2||S.IN_IMDG_PCK_QTY1||S.IN_IMDG_PCK_CD1||S.IN_IMDG_PCK_QTY2||S.IN_IMDG_PCK_CD2),
                                             '','U'
                                             )
                                     )
                        FROM BKG_DG_CGO B,
                             SCG_DG_CGO S
                       WHERE B.BKG_NO = A.BKG_NO
                         AND B.DCGO_SEQ = A.DCGO_SEQ
                         AND S.SPCL_CGO_APRO_RQST_SEQ = (SELECT MAX(SPCL_CGO_APRO_RQST_SEQ) FROM SCG_AUTHORIZATION WHERE BKG_NO=A.BKG_NO AND SPCL_CGO_CATE_CD = 'DG' AND SPCL_CGO_AUTH_CD IN ('Y','N'))
                         AND B.BKG_NO = S.BKG_NO
                         AND B.DCGO_SEQ = S.DCGO_SEQ
                      )       
                ELSE ''
             END ITM_STS_CD
			--2016-06-28
            -- ,ROW_NUMBER() OVER (PARTITION BY NVL(G.BKG_NO, A.BKG_NO), NVL(G.SPCL_CGO_APRO_RQST_SEQ, A.SPCL_CGO_APRO_RQST_SEQ), NVL(G.DCGO_SEQ, A.DCGO_SEQ), NVL(G.VSL_PRE_PST_CD, A.VSL_PRE_PST_CD), NVL(G.VSL_SEQ, A.VSL_SEQ)
        	--ORDER BY DECODE(G.APRO_REF_NO,NULL,9,1), G.UPD_DT DESC) AS CORR_AUTH_SEQ
            --2016-07-01
		     ,NVL(G.UPD_DT, sysdate) AS UPD_DT

    FROM	
        (	SELECT 	
                #if (${scg_flg} == 'DG1' || ${scg_flg} == 'DG2' || ${auth_flg} == 'ALL') 
                    /*+ ORDERED USE_NL(B C V E D F A) */ 
                #end
                    A.BKG_NO, 
                    A.BKG_STS_CD, 
                    C.SLAN_CD, 
                    B.SPCL_CGO_APRO_RQST_SEQ, 
                    B.SPCL_CGO_RQST_SEQ, 
                    B.SPCL_CGO_CATE_CD, 
                    B.DCGO_QTY, 
                    B.POR_CD, 
                    B.DEL_CD,

                    --::2015-06-20::--B.EML_SND_NO, 
                    --::2015-06-20::--C.EML_SND_NO	AS	VVD_EML_SND_NO

                    C.INDIV_EML_SND_NO,
                    C.OALL_EML_SND_NO,

                    B.LST_RQST_DAT_FLG, 
                    B.BKG_RCV_TERM_CD, 
                    B.BKG_DE_TERM_CD, 
                    B.RQST_OFC_CD, 
                    B.RQST_DT, 
                    B.RQST_GDT, 
                    B.RQST_USR_ID, 
                    C.MAPG_TRSM_BND_CD,
                    C.MAPG_TRSM_DT,
                    C.MAPG_TRSM_SPCL_CGO_CATE_CD,
                    C.MAPG_PRNR_SPCL_CGO_SEQ,
                    C.MAPG_EDI_TRSM_STS_CD,
                    C.VSL_PRE_PST_CD, 
                    C.VSL_SEQ, 
                    C.VSL_CD, 
                    (SELECT MAX(SC1.SPCL_CGO_APRO_RQST_SEQ) SPCL_CGO_APRO_RQST_SEQ
                       FROM SCG_APRO_RQST SC1 
                          , SCG_VVD_APRO_RQST SC2
                      WHERE SC1.BKG_NO                 = C.BKG_NO
                        AND SC2.MAPG_EDI_TRSM_STS_CD   = 'S'
                        AND SC1.BKG_NO                 = SC2.BKG_NO
                        AND SC1.SPCL_CGO_APRO_RQST_SEQ = SC2.SPCL_CGO_APRO_RQST_SEQ
                        AND SC2.VSL_PRE_PST_CD         = C.VSL_PRE_PST_CD
                    )PRE_SEQ,
                    (SELECT SUM(DECODE(SC2.MAPG_EDI_TRSM_STS_CD, 'S', 1, 0)) MAPG_EDI_TRSM_STS_CD_CNT
                       FROM SCG_APRO_RQST SC1 
                          , SCG_VVD_APRO_RQST SC2
                      WHERE SC1.BKG_NO                 = C.BKG_NO
                        AND SC2.MAPG_EDI_TRSM_STS_CD   = 'S'
                        AND SC1.BKG_NO                 = SC2.BKG_NO
                        AND SC1.SPCL_CGO_APRO_RQST_SEQ = SC2.SPCL_CGO_APRO_RQST_SEQ
                        AND SC2.VSL_PRE_PST_CD         = C.VSL_PRE_PST_CD
                    )PRE_TRSM_STS_CD_CNT,
                    D.VSL_ENG_NM, 
                    C.SKD_VOY_NO, 
                    C.SKD_DIR_CD, 
                    C.POL_CD, 
                    C.POD_CD, 
                    C.POL_CLPT_IND_SEQ, 
                    C.POD_CLPT_IND_SEQ, 
                    C.POL_YD_CD, 
                    C.POD_YD_CD, 
                    NVL(G.ACT_CRR_CD,D.CRR_CD) CRR_CD,
                    E.RGN_SHP_OPR_CD, 
                    F.DCGO_REF_NO,
                    F.DCGO_SEQ, 
                    F.DG_CNTR_SEQ, 
                    F.CNTR_CGO_SEQ, 
                    F.CNTR_NO, 
                    F.CNTR_TPSZ_CD, 
                    F.IMDG_UN_NO, 
                    F.IMDG_UN_NO_SEQ, 
                    F.IMDG_CLSS_CD, 
                    F.IMDG_SUBS_RSK_LBL_CD1,
                    F.IMDG_SUBS_RSK_LBL_CD2,
                    F.IMDG_SUBS_RSK_LBL_CD3,
                    F.IMDG_SUBS_RSK_LBL_CD4,
                    F.MRN_POLUT_FLG, 
                    F.IMDG_PCK_GRP_CD, 
                    F.IMDG_LMT_QTY_FLG, 
                    F.IMDG_EXPT_QTY_FLG, 
                    F.FLSH_PNT_CDO_TEMP, 
                    F.GRS_WGT, 
                    F.NET_WGT, 
                    F.IN_IMDG_PCK_QTY1, 
                    F.OUT_IMDG_PCK_QTY1, 
                    F.INTMD_IMDG_PCK_QTY1, 
                    F.PSA_NO, 
                    F.HCDG_FLG, 
                    F.SPCL_RQST_FLG, 
                    F.SPCL_RQST_DESC,
                    V.VPS_ETA_DT,
                    F.PRP_SHP_NM,
                    F.DIFF_RMK,
                    F.DCGO_STS_CD,
                    F.IMDG_SEGR_GRP_NO,
                    F.RSD_FLG,
                    F.CFR_FLG
            FROM	SCG_APRO_RQST 			B
                ,	SCG_VVD_APRO_RQST 		C
                ,	SCG_RGN_SHP_OPR_PORT 	E
                ,	MDM_VSL_CNTR 			D
                ,	
                    #if (${scg_flg} == 'SCG_DG' && ${auth_flg} != 'ALL')
                    SCG_DG_CGO F 
                    #else
                    BKG_DG_CGO F
                    #end
                ,	BKG_BOOKING 			A
                ,	VSK_VSL_PORT_SKD 		V
                ,	VSK_VSL_SKD 			G
            WHERE	B.SPCL_CGO_CATE_CD 			= 'DG'
            AND		B.LST_RQST_DAT_FLG 			= 'Y'
            AND 	B.BKG_NO 					= C.BKG_NO
            AND 	B.SPCL_CGO_APRO_RQST_SEQ 	= C.SPCL_CGO_APRO_RQST_SEQ
            AND 	C.POL_CD 					= E.LOC_CD
            AND 	C.VSL_CD 					= D.VSL_CD
            AND 	D.DELT_FLG 					= 'N'
            AND 	E.DELT_FLG 					= 'N'
            AND 	B.BKG_NO 					= F.BKG_NO
            AND 	F.SPCL_CGO_APRO_CD 			IS NOT NULL
            AND 	V.VSL_CD 					= C.VSL_CD
            AND 	V.SKD_VOY_NO 				= C.SKD_VOY_NO
            AND 	V.SKD_DIR_CD 				= C.SKD_DIR_CD
            AND     C.VSL_CD                    = G.VSL_CD
            AND     C.SKD_VOY_NO                = G.SKD_VOY_NO
            AND     C.SKD_DIR_CD                = G.SKD_DIR_CD
            AND 	V.VPS_PORT_CD 				= C.POL_CD
            AND 	V.CLPT_IND_SEQ 				= C.POL_CLPT_IND_SEQ
            AND 	B.BKG_NO 					= A.BKG_NO


        #if (${prp_shp_nm} != '') 
            AND 	UPPER(F.PRP_SHP_NM) 				LIKE '%'||UPPER(@[prp_shp_nm])||'%'
        #end

        #if (${scg_flg} == 'DG1' || ${scg_flg} == 'DG2' || ${auth_flg} == 'ALL') 
            AND 	B.RQST_DT 					> SYSTIMESTAMP - 300
            AND 	V.VPS_ETA_DT 				> SYSTIMESTAMP - 300
            AND 	F.SPCL_CGO_APRO_CD 			NOT IN ('C','D','N')
            AND 	A.BKG_STS_CD 				!= 'X'
            
            /*2014.12.08 dg part1, dg part2 통합
            #if (${scg_flg} == 'DG1' || ${scg_flg} == 'DG2')
                #if (${scg_flg} == 'DG1')
                    AND 	(F.BKG_NO, F.DG_CNTR_SEQ) IN (
                #else
                    AND 	(F.BKG_NO, F.DG_CNTR_SEQ) NOT IN (
                #end
                    SELECT BKG_NO, DG_CNTR_SEQ 
                      FROM BKG_DG_CGO 
                     WHERE BKG_NO = B.BKG_NO 
                       AND (IMDG_CLSS_CD LIKE '1%' OR IMDG_CLSS_CD LIKE '2%' OR IMDG_CLSS_CD LIKE '7%' OR IMDG_CLSS_CD='5.2' OR PSA_NO = '1')) 
            #end
            */
        #else
            AND 	A.BKG_STS_CD 				!= 'X'
            AND 	B.SPCL_CGO_APRO_RQST_SEQ 	= F.SPCL_CGO_APRO_RQST_SEQ
            AND 	F.SPCL_CGO_APRO_CD 			NOT IN ('C','D')
        #end
        
        #if (${rgn_shp_opr_cd} != '') 
            AND		E.RGN_SHP_OPR_CD 	= @[rgn_shp_opr_cd]
        #end

        #if ($slan_cd.size() > 0) 
            AND 	C.SLAN_CD IN ( 
                    #foreach($key IN ${slan_cd}) 
                        #if($velocityCount < $slan_cd.size()) 
                            '$key', 
                        #else 
                            '$key' 
                        #end 
                    #end 
                    )
        #end

        #if (${vsl_cd} != '') 
            AND		C.VSL_CD 			IN ( @[vsl_cd] )
        #end

        #if (${imdg_un_no} != '') 
            AND 	F.IMDG_UN_NO 		= @[imdg_un_no]
        #end

        #if (${imdg_un_no_seq} != '') 
            AND 	F.IMDG_UN_NO_SEQ 	= @[imdg_un_no_seq]
        #end

        #if (${imdg_clss_cd} != '') 
            AND 	F.IMDG_CLSS_CD 		= @[imdg_clss_cd]
        #end

        #if (${skd_voy_no} != '') 
            AND		C.SKD_VOY_NO 		IN ( @[skd_voy_no] )
        #end

        #if (${skd_dir_cd} != '') 
            AND 	C.SKD_DIR_CD 		IN ( @[skd_dir_cd] )
        #end
        
        #if (${pol_cd} != '') 
            AND 	C.POL_CD 			= @[pol_cd]
        #end

        #if (${pod_cd} != '') 
            AND 	C.POD_CD 			= @[pod_cd]
        #end

        #if (${val_opr_tp_cd} == 'H')
            AND 	D.CRR_CD 			= COM_ConstantMgr_PKG.COM_getCompanyCode_FNC()
        #end
        
        #if (${val_opr_tp_cd} == 'O')
            AND		D.CRR_CD 			!= COM_ConstantMgr_PKG.COM_getCompanyCode_FNC()
        #end  	
        
        --2016-06-23 검색 조건 추가 --
        #if (${booking_no} != '') 
            AND 	A.BKG_NO 			= @[booking_no]
        #end

        #if (${dcgo_ref_no} != '') 
            AND 	F.DCGO_REF_NO 		= @[dcgo_ref_no]
        #end
        --2016-06-23 검색 조건 추가 --

        #if (${shpr_nm} != '') 
            AND 	A.BKG_NO IN (
                        SELECT 	SH.BKG_NO
                        FROM 	BKG_CUSTOMER SH
                        WHERE 	SH.BKG_CUST_TP_CD = 'S'
                        AND 	SH.CUST_NM LIKE '%'||@[shpr_nm]||'%'
                    )
        #end

        #if (${from_eta_dt} != '' && ${to_eta_dt} != '') 
            AND V.VPS_ETA_DT BETWEEN TO_DATE(@[from_eta_dt],'YYYYMMDD') AND TO_DATE(@[to_eta_dt],'YYYYMMDD')+0.99999
        #elseif (${from_eta_dt} != '') 
            AND DECODE(C.VSL_PRE_PST_CD,'U',V.VPS_ETA_DT,B.RQST_DT)	<= NVL(GLOBALDATE_PKG.TIME_CONV_FNC(COM_ConstantMgr_PKG.COM_getBaseLocationCode_FNC(),SYSDATE,BKG_COM_USER_LOC_FNC(@[usr_id])), SYSDATE) + TO_NUMBER(@[from_eta_dt])
        #end
                                               
            ) A, 
            --2016-07-14 SCG_AUTHORIZATION 중복 데이터 추출 후 JOIN --
            (
            SELECT CC.* FROM 
            (
            SELECT ROW_NUMBER() OVER (PARTITION BY NVL(AA.BKG_NO, BB.BKG_NO), NVL(AA.SPCL_CGO_APRO_RQST_SEQ, BB.SPCL_CGO_APRO_RQST_SEQ), NVL(AA.DCGO_SEQ, BB.DCGO_SEQ), NVL(AA.VSL_PRE_PST_CD, BB.VSL_PRE_PST_CD), NVL(AA.VSL_SEQ, BB.VSL_SEQ)
        	ORDER BY DECODE(AA.APRO_REF_NO,NULL,9,1), AA.UPD_DT DESC) AS CORR_AUTH_SEQ
            ,AA.*
            FROM
            SCG_AUTHORIZATION AA, 
            SCG_AUTHORIZATION BB 
            WHERE   AA.BKG_NO = BB.BKG_NO
             AND 	AA.SPCL_CGO_APRO_RQST_SEQ 	= BB.SPCL_CGO_APRO_RQST_SEQ 
             AND 	AA.VSL_PRE_PST_CD 			= BB.VSL_PRE_PST_CD 
             AND 	AA.VSL_SEQ 					= BB.VSL_SEQ  
             AND    AA.DCGO_SEQ                 = BB.DCGO_SEQ
             AND    AA.SPCL_CGO_AUTH_SEQ        = BB.SPCL_CGO_AUTH_SEQ
            ) CC
            WHERE CC.CORR_AUTH_SEQ = 1
            )G
            --2016-07-14 SCG_AUTHORIZATION 중복 데이터 추출 후 JOIN --
    WHERE	A.BKG_NO 					= G.BKG_NO (+) 
    AND 	A.SPCL_CGO_APRO_RQST_SEQ 	= G.SPCL_CGO_APRO_RQST_SEQ (+) 
    AND 	A.VSL_PRE_PST_CD 			= G.VSL_PRE_PST_CD (+) 
    AND 	A.VSL_SEQ 					= G.VSL_SEQ (+) 
    AND 	A.DCGO_SEQ 					= G.DCGO_SEQ (+) 
    #if (${apro_ref_no} != '') 
    AND     G.APRO_REF_NO 		= @[apro_ref_no]
    #end
    )A
    WHERE 1=1

    #if (${auth_flg} == 'A') 
        AND	NVL(SPCL_CGO_AUTH_CD_CHK,'R') IN ('R','P')
    #end
    #if (${auth_flg} == 'P') 
        AND	SPCL_CGO_AUTH_CD_CHK 		  = 'P'
    #end
    #if (${auth_flg} == 'R') 
        AND NVL(SPCL_CGO_AUTH_CD_CHK,'R') = 'R'
    #end


    #if (${auth_flg} == 'Y') 
        AND SPCL_CGO_AUTH_CD_CHK    	= 'Y'
    #end
    #if (${auth_flg} == 'U') 
        AND SPCL_CGO_AUTH_CD_CHK 	    = 'R'
    #end
    #if (${auth_flg} == 'N') 
        AND SPCL_CGO_AUTH_CD_CHK		= 'N'
    #end
    #if (${auth_flg} == 'YN')
        AND SPCL_CGO_AUTH_CD_CHK		IN ('Y','N')
    #end

    #if (${auth_flg} == 'ALL') 
        AND SPCL_CGO_AUTH_CD_CHK     	IN ('R','P')
    #end
    --2016-06-28
    --  AND  A.CORR_AUTH_SEQ 			= 1  
)             
WHERE RNK < 1000
ORDER BY RNK, DG_CNTR_SEQ, CNTR_CGO_SEQ			]]></sql>
			<params>
				<param name="rgn_shp_opr_cd" type="12" value="" out="N"/>
				<param name="prp_shp_nm" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="imdg_un_no" type="12" value="" out="N"/>
				<param name="imdg_un_no_seq" type="12" value="" out="N"/>
				<param name="imdg_clss_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="booking_no" type="12" value="" out="N"/>
				<param name="dcgo_ref_no" type="12" value="" out="N"/>
				<param name="shpr_nm" type="12" value="" out="N"/>
				<param name="from_eta_dt" type="12" value="" out="N"/>
				<param name="to_eta_dt" type="12" value="" out="N"/>
				<param name="usr_id" type="12" value="" out="N"/>
				<param name="apro_ref_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
