<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ReceiveEdiFromParnterLinesMgtDBDAOScgPrnrTrsmDtlUnmapCSQL">
			<desc><![CDATA[SCG_PRNR_TRSM_DTL_UNMAP 데이터 INSERT]]></desc>
			<sql><![CDATA[
INSERT INTO SCG_PRNR_TRSM_DTL_UNMAP
      	(  	TRSM_BND_CD
      	,  	TRSM_DT
      	,  	SPCL_CGO_CATE_CD
      	,  	PRNR_SPCL_CGO_SEQ
		,	PRNR_SPCL_CGO_SUB_SEQ
      	,  	EDI_UNMAP_SEQ

		,	CNTR_SEQ
		,	CGO_SEQ

      	,  	EDI_UNMAP_DTL_CD
		,	EDI_UNMAP_DTL_DESC

      	,  	CRE_USR_ID
      	,  	CRE_DT
      	,  	UPD_USR_ID
      	,  	UPD_DT
      	)

SELECT 		C.TRSM_BND_CD
     	, 	C.TRSM_DT
     	, 	C.SPCL_CGO_CATE_CD
     	, 	C.PRNR_SPCL_CGO_SEQ
	 	, 	MP.CGO_MAPG_SEQ						AS NEW_PRNR_SPCL_CGO_SUB_SEQ
      	,   ROW_NUMBER() OVER (PARTITION BY A.TRSM_BND_CD,A.TRSM_DT,A.SPCL_CGO_CATE_CD,A.PRNR_SPCL_CGO_SEQ ORDER BY NVL(UN1.EDI_UNMAP_DTL_CD,UN2.EDI_UNMAP_DTL_CD) ASC)

	 	, 	MP.CNTR_SEQ
     	, 	MP.CGO_SEQ      

    	,  	NVL(UN1.EDI_UNMAP_DTL_CD  ,UN2.EDI_UNMAP_DTL_CD		) 
    	,  	NVL(UN1.EDI_UNMAP_DTL_DESC,UN2.EDI_UNMAP_DTL_DESC	)

		,	C.CRE_USR_ID
		,	C.CRE_DT
		,	C.UPD_USR_ID
		,	C.UPD_DT

FROM 		SCG_PRNR_SPCL_CGO_TRSM_HDR 		A
    	, 	SCG_PRNR_SPCL_CGO_CNTR_LOG 		B
    	, 	SCG_PRNR_SPCL_CGO_DTL_LOG  		C
		, 	SCG_PRNR_SPCL_CGO_SEQ_MAPG 		MP

  		, 	SCG_PRNR_CNTR_LOG_UNMAP     	UN1
  		, 	SCG_PRNR_CGO_DTL_LOG_UNMAP  	UN2

WHERE 		A.TRSM_BND_CD       			= @[trsm_bnd_cd]
AND 		A.TRSM_DT           			= TO_DATE(@[trsm_dt],'YYYY-MM-DD')
AND 		A.SPCL_CGO_CATE_CD  			= @[spcl_cgo_cate_cd]
AND 		A.PRNR_SPCL_CGO_SEQ 			= @[prnr_spcl_cgo_seq]
AND 		A.TRSM_BND_CD       			= B.TRSM_BND_CD
AND 		A.TRSM_DT           			= B.TRSM_DT
AND 		A.SPCL_CGO_CATE_CD  			= B.SPCL_CGO_CATE_CD
AND 		A.PRNR_SPCL_CGO_SEQ 			= B.PRNR_SPCL_CGO_SEQ
AND 		A.TRSM_BND_CD       			= C.TRSM_BND_CD				
AND 		A.TRSM_DT           			= C.TRSM_DT					
AND 		A.SPCL_CGO_CATE_CD  			= C.SPCL_CGO_CATE_CD		
AND 		A.PRNR_SPCL_CGO_SEQ 			= C.PRNR_SPCL_CGO_SEQ		

---------------------------------------------------------------------
AND 		A.PRNR_SPCL_CGO_SEQ 			= MP.PRNR_SPCL_CGO_SEQ
AND 		B.CNTR_SEQ          			= MP.CNTR_SEQ
AND 		C.EDI_ITM_SEQ       			= MP.EDI_ITM_SEQ 
---------------------------------------------------------------------

--===================================================================
AND B.TRSM_BND_CD             				= UN1.TRSM_BND_CD         	(+)
AND B.TRSM_DT                 				= UN1.TRSM_DT             	(+)
AND B.SPCL_CGO_CATE_CD        				= UN1.SPCL_CGO_CATE_CD    	(+)
AND B.PRNR_SPCL_CGO_SEQ       				= UN1.PRNR_SPCL_CGO_SEQ   	(+)
AND B.CNTR_SEQ                				= UN1.CNTR_SEQ            	(+)

AND C.TRSM_BND_CD             				= UN2.TRSM_BND_CD         	(+)
AND C.TRSM_DT                 				= UN2.TRSM_DT             	(+)
AND C.SPCL_CGO_CATE_CD        				= UN2.SPCL_CGO_CATE_CD    	(+)
AND C.PRNR_SPCL_CGO_SEQ       				= UN2.PRNR_SPCL_CGO_SEQ   	(+) 
AND C.PRNR_SPCL_CGO_SUB_SEQ   				= UN2.PRNR_SPCL_CGO_SUB_SEQ (+)

AND NVL(UN1.EDI_UNMAP_DTL_CD,UN2.EDI_UNMAP_DTL_CD) IS NOT NULL
--===================================================================		

AND NOT EXISTS (SELECT	'' 
                FROM 	SCG_PRNR_SPCL_CGO_TRSM_ERR 	ERR
                WHERE 	A.TRSM_BND_CD       		= ERR.TRSM_BND_CD
                AND 	A.TRSM_DT           		= ERR.TRSM_DT
                AND 	A.SPCL_CGO_CATE_CD  		= ERR.SPCL_CGO_CATE_CD
                AND 	A.PRNR_SPCL_CGO_SEQ 		= ERR.PRNR_SPCL_CGO_SEQ
                )
AND NOT EXISTS (SELECT 	'' 
                FROM 	SCG_PRNR_SPCL_CGO_DTL_ERR 	ERR
                WHERE 	C.TRSM_BND_CD           	= ERR.TRSM_BND_CD
                AND 	C.TRSM_DT               	= ERR.TRSM_DT
                AND 	C.SPCL_CGO_CATE_CD      	= ERR.SPCL_CGO_CATE_CD
                AND 	C.PRNR_SPCL_CGO_SEQ     	= ERR.PRNR_SPCL_CGO_SEQ
                AND 	C.PRNR_SPCL_CGO_SUB_SEQ 	= ERR.PRNR_SPCL_CGO_SUB_SEQ				
                )			]]></sql>
			<params>
				<param name="trsm_bnd_cd" type="12" value="" out="N"/>
				<param name="trsm_dt" type="12" value="" out="N"/>
				<param name="spcl_cgo_cate_cd" type="12" value="" out="N"/>
				<param name="prnr_spcl_cgo_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
