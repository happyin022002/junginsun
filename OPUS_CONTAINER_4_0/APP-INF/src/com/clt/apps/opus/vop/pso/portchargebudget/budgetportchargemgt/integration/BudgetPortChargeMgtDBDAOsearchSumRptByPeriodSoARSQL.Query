<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BudgetPortChargeMgtDBDAOsearchSumRptByPeriodSoARSQL">
			<desc><![CDATA[PSO_PORT_EXPN_DIV 테이블에 추가]]></desc>
			<sql><![CDATA[
SELECT AMT.LANE_PORT VSL_SLAN_CD
     , AMT.ACCT_CD LGS_COST_CD
     , SUM(BUDGET_AMOUNT) BUDGET_AMOUNT
     , SUM(BUDGET_CALL) BUDGET_CALL
     , SUM(ESTIMA_AMOUNT) ESTIMA_AMOUNT
     , SUM(ESTIMA_CALL) ESTIMA_CALL
     , SUM(ACTUAL_AMOUNT) ACTUAL_AMOUNT
     , SUM(ACTUAL_CALL) ACTUAL_CALL
     , NVL(SUM(BUDGET_AMOUNT), 0) - NVL(SUM(ACTUAL_AMOUNT), 0) BUDGET_VS_ACTUAL_AMOUNT
     , NVL(SUM(BUDGET_CALL), 0) - NVL(SUM(ACTUAL_CALL), 0) BUDGET_VS_ACTUAL_CALL
     , NVL(SUM(ESTIMA_AMOUNT), 0) - NVL(SUM(ACTUAL_AMOUNT), 0) ESTIMA_VS_ACTUAL_AMOUNT
     , NVL(SUM(ESTIMA_CALL), 0) - NVL(SUM(ACTUAL_CALL), 0) ESTIMA_VS_ACTUAL_CALL
     , NVL(SUM(BUDGET_AMOUNT), 0) - NVL(SUM(ESTIMA_AMOUNT), 0) BUDGET_VS_ESTIMA_AMOUNT
     , NVL(SUM(BUDGET_CALL), 0) - NVL(SUM(ESTIMA_CALL), 0) BUDGET_VS_ESTIMA_CALL
  FROM (
        SELECT LANE_PORT
             , ACCT_CD
             , SUM(BUDGET_AMOUNT) BUDGET_AMOUNT
             , SUM(ESTIMA_AMOUNT) ESTIMA_AMOUNT
             , SUM(ACTUAL_AMOUNT) ACTUAL_AMOUNT
          FROM (
                -- bud amt
                SELECT VSL_SLAN_CD AS LANE_PORT
                     , CST.ACCT_CD AS ACCT_CD
                     , SUM(NVL(INV_USD_AMT, 0)) AS BUDGET_AMOUNT
                     , NULL AS BUDGET_CALL
                     , NULL AS ESTIMA_AMOUNT
                     , NULL AS ESTIMA_CALL
                     , NULL AS ACTUAL_AMOUNT
                     , NULL AS ACTUAL_CALL
                  FROM PSO_TGT_VVD T21
                     , PSO_TGT_YD_EXPN T22
                     , TES_LGS_COST CST
                     , MDM_VSL_CNTR VSL
                 WHERE T21.VSL_CD = T22.VSL_CD(+)
                   AND T21.SKD_VOY_NO = T22.SKD_VOY_NO(+)
                   AND T21.SKD_DIR_CD = T22.SKD_DIR_CD(+)
                   AND T22.LGS_COST_CD = CST.LGS_COST_CD(+)
                   AND T21.PSO_BZTP_CD = 1
                   AND T21.PSO_BZTP_CD = T22.PSO_BZTP_CD
                   AND T21.VSL_CD = VSL.VSL_CD
                   AND T22.REV_YRMON BETWEEN @[cre_dt_fr] AND @[cre_dt_to]
                    ---adding options
				#if(${vsl_slan_cd}!='')
                   AND T21.VSL_SLAN_CD = @[vsl_slan_cd]
				#end
                ---adding options
				#if(${port_cd}!='' && ${term_code}=='')
					AND T22.YD_CD LIKE @[port_cd] || '%'
				#end
				#if(${port_cd}!='' && ${term_code}!='')
	                AND T22.YD_CD IN ('${term_code}')
				#end
				---adding options
				#if(${combo1}!='ALL' and ${combo1}!='')
                	AND CST.ACCT_CD = @[combo1]
				#end
                ---adding options
				#if(${combo2}!='ALL' and ${combo2}!='')
                	AND VSL.CNTR_VSL_CLSS_CAPA = @[combo2]
                #end
                 GROUP BY VSL_SLAN_CD, CST.ACCT_CD
                 UNION ALL
                -- Est amt
                SELECT VSL_SLAN_CD AS LANE_PORT
                     , CST.ACCT_CD AS ACCT_CD
                     , NULL AS BUDGET_AMOUNT
                     , NULL AS BUDGET_CALL
                     , SUM(NVL(INV_USD_AMT, 0)) AS ESTIMA_AMOUNT
                     , NULL AS ESTIMA_CALL
                     , NULL AS ACTUAL_AMOUNT
                     , NULL AS ACTUAL_CALL
                  FROM PSO_TGT_VVD T21
                     , PSO_TGT_YD_EXPN T22
                     , TES_LGS_COST CST
                     , MDM_VSL_CNTR VSL
                 WHERE T21.VSL_CD = T22.VSL_CD(+)
                   AND T21.SKD_VOY_NO = T22.SKD_VOY_NO(+)
                   AND T21.SKD_DIR_CD = T22.SKD_DIR_CD(+)
                   AND T22.LGS_COST_CD = CST.LGS_COST_CD(+)
                   AND T21.PSO_BZTP_CD = 2
                   AND T21.PSO_BZTP_CD = T22.PSO_BZTP_CD
                   AND T21.VSL_CD = VSL.VSL_CD
                   AND T22.REV_YRMON BETWEEN @[cre_dt_fr] AND @[cre_dt_to]
                   ---adding options
				#if(${vsl_slan_cd}!='')
                AND    T21.VSL_SLAN_CD = @[vsl_slan_cd]
				#end

                ---adding options
				#if(${port_cd}!='' && ${term_code}=='')
				AND    T22.YD_CD LIKE @[port_cd] || '%'
				#end
				#if(${port_cd}!='' && ${term_code}!='')
                AND    T22.YD_CD IN ('${term_code}')
				#end
				
                ---adding options
				#if(${combo1}!='ALL' and ${combo1}!='')
                AND    CST.ACCT_CD = @[combo1]
				#end

                ---adding options
				#if(${combo2}!='ALL' and ${combo2}!='')
                AND    VSL.CNTR_VSL_CLSS_CAPA = @[combo2]
                #end
                 GROUP BY VSL_SLAN_CD, CST.ACCT_CD
                 UNION ALL
                -- Actual amt
                SELECT /*+ index(t10 XPKAR_MST_REV_VVD) */
                       SUBSTR(T10.RLANE_CD, 1, 3) AS LANE_PORT
                     , CST.ACCT_CD AS ACCT_CD
                     , NULL AS BUDGET_AMOUNT
                     , NULL AS BUDGET_CALL
                     , NULL AS ESTIMA_AMOUNT
                     , NULL AS ESTIMA_CALLACTUAL_AMOUNT
                     , SUM(USD_AMT) AS ACTUAL_AMOUNT
                     , NULL AS ACTUAL_CALL
                  FROM PSO_CHARGE SOH
                     , PSO_CHG_DTL SOD
                     , AR_MST_REV_VVD T10
                     , TES_LGS_COST CST
                     , MDM_VSL_CNTR VSL
                 WHERE SOD.AR_YRMON BETWEEN @[cre_dt_fr] AND @[cre_dt_to]
                   AND SOH.ISS_CTY_CD = SOD.ISS_CTY_CD
                   AND SOH.SO_SEQ = SOD.SO_SEQ
                   AND SOD.LGS_COST_CD = CST.LGS_COST_CD
                   AND SOD.VSL_CD = VSL.VSL_CD(+)
                   AND SOD.VSL_CD = T10.VSL_CD
                   AND SOD.SKD_VOY_NO = LPAD(T10.SKD_VOY_NO,4,'0')
                   AND SOD.SKD_DIR_CD = T10.SKD_DIR_CD
                   AND SOD.REV_DIR_CD = T10.RLANE_DIR_CD
                   AND SOD.RLANE_CD = T10.RLANE_CD
                   AND T10.DELT_FLG = 'N' /*2015.09.11 Add*/
                   ---adding options
				#if(${vsl_slan_cd}!='')
                	AND T10.SLAN_CD = @[vsl_slan_cd]
				#end

                ---adding options
				#if(${port_cd}!='' && ${term_code}=='')
					AND SOH.YD_CD LIKE @[port_cd] || '%'
				#end
				#if(${port_cd}!='' && ${term_code}!='')
                	AND SOH.YD_CD IN ('${term_code}')
				#end
				
                ---adding options
				#if(${combo1}!='ALL' and ${combo1}!='')
                	AND CST.ACCT_CD = @[combo1]
				#end

                ---adding options
				#if(${combo2}!='ALL' and ${combo2}!='')
                	AND VSL.CNTR_VSL_CLSS_CAPA = @[combo2]
                #end 
                 GROUP BY SUBSTR(T10.RLANE_CD, 1, 3), CST.ACCT_CD
               )
         GROUP BY LANE_PORT, ACCT_CD
       ) AMT
     , (
        -- Bud call
        SELECT VSL_SLAN_CD AS LANE_PORT
             , ACCT_CD
             , COUNT(VVD) AS BUDGET_CALL
          FROM (SELECT T21.VSL_SLAN_CD AS VSL_SLAN_CD
                     , SUBSTR(T22.YD_CD, 1, 5) AS LANE_PORT
                     , CST.ACCT_CD AS ACCT_CD
                     , T21.VSL_CD||T21.SKD_VOY_NO||T21.SKD_DIR_CD AS VVD
                  FROM PSO_TGT_VVD T21
                     , PSO_TGT_YD_EXPN T22
                     , TES_LGS_COST CST
                     , MDM_VSL_CNTR VSL
                 WHERE T21.VSL_CD = T22.VSL_CD(+)
                   AND T21.SKD_VOY_NO = T22.SKD_VOY_NO(+)
                   AND T21.SKD_DIR_CD = T22.SKD_DIR_CD(+)
                   AND T22.LGS_COST_CD = CST.LGS_COST_CD(+)
                   AND T21.PSO_BZTP_CD = 1
                   AND T21.PSO_BZTP_CD = T22.PSO_BZTP_CD
                   AND T21.VSL_CD = VSL.VSL_CD
                   AND T22.REV_YRMON BETWEEN @[cre_dt_fr] AND @[cre_dt_to]
                   ---adding options
					#if(${vsl_slan_cd}!='')
					AND T21.VSL_SLAN_CD = @[vsl_slan_cd]
					#end

					---adding options
					#if(${port_cd}!='' && ${term_code}=='')
					AND T22.YD_CD LIKE @[port_cd] || '%'
					#end
					#if(${port_cd}!='' && ${term_code}!='')
					AND T22.YD_CD IN (@[term_code])
					#end
					
					---adding options
					#if(${combo1}!='ALL' and ${combo1}!='')
					AND CST.ACCT_CD = @[combo1]
					#end

					---adding options
					#if(${combo2}!='ALL' and ${combo2}!='')
					AND VSL.CNTR_VSL_CLSS_CAPA = @[combo2]
					#end
                 GROUP BY T21.PSO_BZTP_CD
                     , T21.VSL_SLAN_CD
                     , SUBSTR(T22.YD_CD, 1, 5)
                     , CST.ACCT_CD
                     , T21.VSL_CD||T21.SKD_VOY_NO||T21.SKD_DIR_CD 
               )
         GROUP BY VSL_SLAN_CD, ACCT_CD 
       ) BC
     , (
        -- Est call
        SELECT VSL_SLAN_CD AS LANE_PORT
             , ACCT_CD
             , COUNT(VVD) AS ESTIMA_CALL
          FROM (SELECT T21.VSL_SLAN_CD AS VSL_SLAN_CD
                     , SUBSTR(T22.YD_CD, 1, 5) AS LANE_PORT
                     , CST.ACCT_CD AS ACCT_CD
                     , T21.VSL_CD||T21.SKD_VOY_NO||T21.SKD_DIR_CD AS VVD
                  FROM PSO_TGT_VVD T21
                     , PSO_TGT_YD_EXPN T22
                     , TES_LGS_COST CST
                     , MDM_VSL_CNTR VSL
                 WHERE T21.VSL_CD = T22.VSL_CD
                   AND T21.SKD_VOY_NO = T22.SKD_VOY_NO
                   AND T21.SKD_DIR_CD = T22.SKD_DIR_CD
                   AND T22.LGS_COST_CD = CST.LGS_COST_CD
                   AND T21.PSO_BZTP_CD = 2
                   AND T21.PSO_BZTP_CD = T22.PSO_BZTP_CD
                   AND T21.VSL_CD = VSL.VSL_CD
                   AND T22.REV_YRMON BETWEEN @[cre_dt_fr] AND @[cre_dt_to]
                   ---adding options
					#if(${vsl_slan_cd}!='')
					AND T21.VSL_SLAN_CD = @[vsl_slan_cd]
					#end

					---adding options
					#if(${port_cd}!='' && ${term_code}=='')
					AND T22.YD_CD LIKE @[port_cd] || '%'
					#end
					#if(${port_cd}!='' && ${term_code}!='')
					AND T22.YD_CD IN (@[term_code])
					#end
					
					---adding options
					#if(${combo1}!='ALL' and ${combo1}!='')
					AND CST.ACCT_CD = @[combo1]
					#end

					---adding options
					#if(${combo2}!='ALL' and ${combo2}!='')
					AND VSL.CNTR_VSL_CLSS_CAPA = @[combo2]
					#end
                 GROUP BY T21.PSO_BZTP_CD
                     , T21.VSL_SLAN_CD
                     , SUBSTR(T22.YD_CD, 1, 5)
                     , CST.ACCT_CD
                     , T21.VSL_CD||T21.SKD_VOY_NO||T21.SKD_DIR_CD 
               )
         GROUP BY VSL_SLAN_CD
             , ACCT_CD 
       ) EC
     , (
        -- Actual call
        SELECT VSL_SLAN_CD AS LANE_PORT
             , ACCT_CD
             , COUNT(VVD) AS ACTUAL_CALL
          FROM (SELECT /*+ index(t10 XPKAR_MST_REV_VVD) */
                  T10.SLAN_CD AS VSL_SLAN_CD
                     , SUBSTR(SOH.YD_CD, 1, 5) AS LANE_PORT
                     , CST.ACCT_CD AS ACCT_CD
                     , SOD.SKD_VOY_NO||SOD.SKD_VOY_NO||SOD.SKD_DIR_CD AS VVD
                  FROM PSO_CHARGE SOH
                     , PSO_CHG_DTL SOD
                     , AR_MST_REV_VVD T10
                     , TES_LGS_COST CST
                     , MDM_VSL_CNTR VSL
                 WHERE SOD.AR_YRMON BETWEEN @[cre_dt_fr] AND @[cre_dt_to]
                   AND SOH.ISS_CTY_CD = SOD.ISS_CTY_CD
                   AND SOH.SO_SEQ = SOD.SO_SEQ
                   AND SOD.LGS_COST_CD = CST.LGS_COST_CD
                   AND SOD.VSL_CD = VSL.VSL_CD(+)
                   AND SOD.VSL_CD = T10.VSL_CD
                   AND SOD.SKD_VOY_NO = T10.SKD_VOY_NO
                   AND SOD.SKD_DIR_CD = T10.SKD_DIR_CD
                   AND SOD.REV_DIR_CD = T10.RLANE_DIR_CD
                   AND SOD.RLANE_CD = T10.RLANE_CD
                   AND T10.DELT_FLG = 'N' /*2015.09.11 Add*/
                   ---adding options
					#if(${vsl_slan_cd}!='')
					AND T10.SLAN_CD = @[vsl_slan_cd]
					#end

					---adding options
					#if(${port_cd}!='' && ${term_code}=='')
					AND SOH.YD_CD LIKE @[port_cd] || '%'
					#end
					#if(${port_cd}!='' && ${term_code}!='')
					AND SOH.YD_CD IN (@[term_code])
					#end
					
					---adding options
					#if(${combo1}!='ALL' and ${combo1}!='')
					AND CST.ACCT_CD = @[combo1]
					#end

					---adding options
					#if(${combo2}!='ALL' and ${combo2}!='')
					AND VSL.CNTR_VSL_CLSS_CAPA = @[combo2]
					#end 
                 GROUP BY T10.SLAN_CD
                     , SUBSTR(SOH.YD_CD, 1, 5)
                     , CST.ACCT_CD
                     , SOD.SKD_VOY_NO||SOD.SKD_VOY_NO||SOD.SKD_DIR_CD 
               )
         GROUP BY VSL_SLAN_CD
             , ACCT_CD 
       ) AC
 WHERE 1 = 1
   AND AMT.LANE_PORT = BC.LANE_PORT(+)
   AND AMT.ACCT_CD = BC.ACCT_CD(+)
   AND AMT.LANE_PORT = EC.LANE_PORT(+)
   AND AMT.ACCT_CD = EC.ACCT_CD(+)
   AND AMT.LANE_PORT = AC.LANE_PORT(+)
   AND AMT.ACCT_CD = AC.ACCT_CD(+)
 GROUP BY AMT.LANE_PORT, AMT.ACCT_CD
 ORDER BY AMT.LANE_PORT, AMT.ACCT_CD			]]></sql>
			<params>
				<param name="cre_dt_fr" type="12" value="" out="N"/>
				<param name="cre_dt_to" type="12" value="" out="N"/>
				<param name="vsl_slan_cd" type="12" value="" out="N"/>
				<param name="port_cd" type="12" value="" out="N"/>
				<param name="combo1" type="12" value="" out="N"/>
				<param name="combo2" type="12" value="" out="N"/>
				<param name="term_code" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
