<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BudgetPortChargeMgtDBDAOsearchBudEstDtlByMonCostRSQL">
			<desc><![CDATA[searchBudEstDtlByMonCost]]></desc>
			<sql><![CDATA[
SELECT MM YYYY_MM
     , VVD
     , LOC
     , LANE
     --, DECODE([gubun], 0, LOC, 1, LANE) LANE
     , ACCT ACCOUNT_CODE
     , BUG_AMT BUDGET
     , EST_AMT ESTIMATE
     , ACT_AMT ACTUAL
  FROM (SELECT MM
             , VVD
             , LANE
             , LOC
             , ACCT
             , SUM(DECODE(TP,'1',AMT,0)) BUG_AMT
             , SUM(DECODE(TP,'2',AMT,0)) EST_AMT
             , SUM(DECODE(TP,'3',AMT,0)) ACT_AMT
          FROM (SELECT '1' TP
                     , T11.REV_YRMON MM
                     , T10.VSL_CD||T10.SKD_VOY_NO||T10.SKD_DIR_CD VVD
                     , T10.VSL_SLAN_CD LANE
                     , CST.ACCT_CD ACCT
                     , SUBSTR(T11.YD_CD,1,5) LOC
                     , SUM(INV_USD_AMT) AMT
                  FROM PSO_TGT_VVD T10
                     , PSO_TGT_YD_EXPN T11
                     , MDM_VSL_CNTR VSL
                     , TES_LGS_COST CST
                 WHERE 1 = 1
                   AND T10.VSL_CD = T11.VSL_CD
                   AND T10.SKD_VOY_NO = T11.SKD_VOY_NO
                   AND T10.SKD_DIR_CD = T11.SKD_DIR_CD
                   AND T10.PSO_BZTP_CD = '1'
                   AND T10.PSO_BZTP_CD = T11.PSO_BZTP_CD
                   AND T11.REV_YRMON BETWEEN REPLACE(@[cre_dt_fr],'-','') AND REPLACE(@[cre_dt_to],'-','')
                   AND T10.VSL_CD = VSL.VSL_CD
                   AND T11.LGS_COST_CD = CST.LGS_COST_CD
                   AND CST.ACCT_CD = @[acct_cd]
                   #if(${vsl_cls}!='')
                    AND VSL.CNTR_VSL_CLSS_CAPA  = @[vsl_cls]
                   #end
                   #if(${lane_cd}!='')
                    AND T10.VSL_SLAN_CD = @[lane_cd]  
                   #end
                   #if(${loc_cd}!='' && ${term_cd}=='')
                    AND SUBSTR(T11.YD_CD,1,5) = @[loc_cd] 
                   #end
				   #if(${loc_cd}!='' && ${term_cd}!='')	
						AND T11.YD_CD IN (
				             #foreach($key IN ${term_cd_list})
             					#if($velocityCount < $term_cd_list.size()) '$key', #else '$key' #end
				             #end
         				)
				   #end
                 GROUP BY T11.REV_YRMON , T10.VSL_CD, T10.SKD_VOY_NO, T10.SKD_DIR_CD, T10.VSL_SLAN_CD,CST.ACCT_CD,SUBSTR(T11.YD_CD,1,5)
                 UNION ALL
                 SELECT /*+ INDEX(T10 XPKAR_MST_REV_VVD) */
                  '3' TP
                     , SOD.AR_YRMON AS MM
                     , SOD.VSL_CD||SOD.SKD_VOY_NO||SOD.SKD_DIR_CD VVD
                     , T10.SLAN_CD LANE
                     , CST.ACCT_CD ACCT
                     , SUBSTR(SOH.YD_CD, 1, 5) AS LOC
                     , SUM(SOD.USD_AMT) AS AMT
                  FROM PSO_CHARGE SOH
                     ,PSO_CHG_DTL SOD
                     ,AR_MST_REV_VVD T10
                     ,TES_LGS_COST CST
                     ,MDM_VSL_CNTR VSL
                 WHERE SOD.AR_YRMON BETWEEN REPLACE(@[cre_dt_fr],'-','') AND REPLACE(@[cre_dt_to],'-','')
                   AND SOH.ISS_CTY_CD = SOD.ISS_CTY_CD
                   AND SOH.SO_SEQ = SOD.SO_SEQ
                   AND SOD.LGS_COST_CD = CST.LGS_COST_CD
                   AND SOD.VSL_CD = VSL.VSL_CD(+)
                   AND SOD.VSL_CD = T10.VSL_CD
                   AND SOD.SKD_VOY_NO = LPAD(T10.SKD_VOY_NO,4,'0')
                   AND SOD.SKD_DIR_CD = T10.SKD_DIR_CD
                   AND SOD.REV_DIR_CD = T10.RLANE_DIR_CD
                   AND SOD.RLANE_CD = T10.RLANE_CD
                   AND T10.DELT_FLG = 'N' /*2015.09.11 Add*/
                   AND CST.ACCT_CD = @[acct_cd]
                   #if(${vsl_cls}!='')
                    AND VSL.CNTR_VSL_CLSS_CAPA  = @[vsl_cls]
                   #end
                   #if(${lane_cd}!='')
                    AND T10.SLAN_CD = @[lane_cd]  
                   #end 
                   #if(${loc_cd}!='' && ${term_cd}=='')
                   AND SUBSTR(SOH.YD_CD,1,5) = @[loc_cd] 
                   #end
				   #if(${loc_cd}!='' && ${term_cd}!='')	
						AND SOH.YD_CD IN (
				             #foreach($key IN ${term_cd_list})
             					#if($velocityCount < $term_cd_list.size()) '$key', #else '$key' #end
				             #end
         				)
				   #end
                 GROUP BY SOD.AR_YRMON , SOD.VSL_CD, SOD.SKD_VOY_NO, SOD.SKD_DIR_CD, T10.SLAN_CD,CST.ACCT_CD,SUBSTR(SOH.YD_CD,1,5)
                 UNION ALL
				SELECT '2' TP
                     , T22.REV_YRMON AS MM
                     , T22.VSL_CD||T22.SKD_VOY_NO||T22.SKD_DIR_CD VVD
                     , T21.VSL_SLAN_CD LANE
                     , CST.ACCT_CD AS ACCT
                     , SUBSTR(T22.YD_CD, 1, 5) AS LOC
                     , SUM(NVL(INV_USD_AMT, 0)) AS AMT
                  FROM PSO_TGT_VVD T21
                      ,PSO_TGT_YD_EXPN T22
                      ,TES_LGS_COST CST
                      ,MDM_VSL_CNTR VSL
                 WHERE T21.VSL_CD = T22.VSL_CD
                   AND T21.SKD_VOY_NO = T22.SKD_VOY_NO
                   AND T21.SKD_DIR_CD = T22.SKD_DIR_CD
                   AND T22.LGS_COST_CD = CST.LGS_COST_CD
                   AND T21.PSO_BZTP_CD = 2
                   AND T21.PSO_BZTP_CD = T22.PSO_BZTP_CD
                   AND T21.VSL_CD = VSL.VSL_CD
                   AND T22.REV_YRMON BETWEEN REPLACE(@[cre_dt_fr],'-','') AND REPLACE(@[cre_dt_to],'-','')
                   AND CST.ACCT_CD = @[acct_cd]
                   #if(${vsl_cls}!='')
                    AND VSL.CNTR_VSL_CLSS_CAPA  = @[vsl_cls]
				   #end
				   #if(${lane_cd}!='')
                    AND T21.VSL_SLAN_CD = @[lane_cd]  
				   #end
                   #if(${loc_cd}!='' && ${term_cd}=='')
                   AND SUBSTR(T22.YD_CD,1,5) = @[loc_cd] 
				   #end
				   #if(${loc_cd}!='' && ${term_cd}!='')	
						AND T22.YD_CD IN (
				             #foreach($key IN ${term_cd_list})
             					#if($velocityCount < $term_cd_list.size()) '$key', #else '$key' #end
				             #end
         				)
				   #end
                 GROUP BY T22.REV_YRMON, T22.VSL_CD, T22.SKD_VOY_NO, T22.SKD_DIR_CD, T21.VSL_SLAN_CD,CST.ACCT_CD , SUBSTR(T22.YD_CD, 1, 5)
               )
         GROUP BY MM, VVD, LANE, LOC, ACCT )
 ORDER BY MM, LANE, VVD, ACCT, LOC			]]></sql>
			<params>
				<param name="cre_dt_fr" type="12" value="" out="N"/>
				<param name="cre_dt_to" type="12" value="" out="N"/>
				<param name="acct_cd" type="12" value="" out="N"/>
				<param name="vsl_cls" type="12" value="" out="N"/>
				<param name="lane_cd" type="12" value="" out="N"/>
				<param name="loc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
