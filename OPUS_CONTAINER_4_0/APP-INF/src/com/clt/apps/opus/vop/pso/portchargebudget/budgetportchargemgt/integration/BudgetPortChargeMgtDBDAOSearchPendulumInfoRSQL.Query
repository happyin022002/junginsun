<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BudgetPortChargeMgtDBDAOSearchPendulumInfoRSQL">
			<desc><![CDATA[Pendulum 정보 Search]]></desc>
			<sql><![CDATA[
SELECT T02.YD_CD
     , T02.TURN_PORT_FLG
     , T02.TURN_PORT_IND_CD
     , T02.RLANE_DIR_CD
     , CASE
         WHEN T02.PEND_TURN_PORT_IND_CD = 'Y' THEN 'O'
         WHEN T02.PEND_TURN_PORT_IND_CD = 'F' THEN 'I'
         WHEN T02.PEND_TURN_PORT_IND_CD = 'N' THEN 'B' /* Both : In/Out */
       END AS IB_BND
     , T02.VSL_SLAN_CD AS SLAN_CD
     , TO_CHAR(T02.VPS_ETD_DT,'YYYYMMDD') AS VPS_ETD_DT
     , T02.RLANE_CD
     , T02.REV_YRMON
     , (/*VSK_PF_SKD_DTL.TURN_PORT_IND_CD 체크.*/
        SELECT NVL(CASE WHEN T4.VSL_SLAN_DIR_SEQ = 1 AND T2.TURN_PORT_IND_CD = 'N' AND T2.PORT_ROTN_SEQ = 1 THEN 'Y'
                        ELSE T2.TURN_PORT_IND_CD
                   END,'N')
          FROM VSK_PF_SKD T1
             , VSK_PF_SKD_DTL T2
             , MDM_VSL_SVC_LANE T3
             , MDM_VSL_SVC_LANE_DIR T4
         WHERE T1.VSL_SLAN_CD   = T2.VSL_SLAN_CD
           AND T1.PF_SVC_TP_CD  = T2.PF_SVC_TP_CD
           AND T1.VSL_SLAN_CD   = T3.VSL_SLAN_CD
           AND T2.VSL_SLAN_CD   = T4.VSL_SLAN_CD
           AND T2.SKD_DIR_CD    = T4.VSL_SLAN_DIR_CD
           AND T1.VSL_SLAN_CD   = T02.VSL_SLAN_CD
           AND T2.PORT_CD       = SUBSTR(T02.YD_CD, 1, 5)
           AND T2.SKD_DIR_CD    = T02.SKD_DIR_CD
           AND T1.SLAN_STND_FLG = 'Y'
           AND T3.DELT_FLG      = 'N'
           AND T2.TURN_PORT_IND_CD <> 'F'
           AND ROWNUM           = 1
       ) AS PF_TURN_PORT_IND_CD
     , T02.VSL_CD 
     , T02.SKD_VOY_NO 
     , T02.SKD_DIR_CD
     , T02.CLPT_IND_SEQ
  FROM (SELECT T01.*
             , CASE WHEN IB_RTO = 0   THEN CASE WHEN OB_RTO = 50 THEN 'Y' WHEN OB_RTO = 100 THEN 'N' END
                    WHEN IB_RTO = 50  THEN CASE WHEN OB_RTO = 0  THEN 'F' WHEN OB_RTO = 50  THEN 'F' END
                    WHEN IB_RTO = 100 THEN 'N'
               END AS PEND_TURN_PORT_IND_CD
          FROM (SELECT DISTINCT T5.CLPT_SEQ AS PORT_SEQ
                     , T5.YD_CD
                     , NVL(T2.IB_RTO,0) AS IB_RTO
                     , NVL(T2.OB_RTO,0) AS OB_RTO
                     , T2.REV_DIR_CD AS RLANE_DIR_CD
                     , T1.VSL_SLAN_CD
                     , T5.VPS_ETD_DT
                     , T5.TURN_PORT_FLG
                     , T5.TURN_PORT_IND_CD
                     , T5.VSL_CD 
                     , T5.SKD_VOY_NO 
                     , T5.SKD_DIR_CD
                     , T2.RLANE_CD
                     , (SELECT MAX(REV_YRMON)
                          FROM GL_ESTM_REV_VVD B
                         WHERE B.EXE_YRMON      = REPLACE(@[exe_yrmon] , '-', '') /*EXE_YRMON*/
                           AND B.VSL_CD         = T5.VSL_CD
                           AND B.SKD_VOY_NO     = T5.SKD_VOY_NO
                           AND B.SKD_DIR_CD     = T5.SKD_DIR_CD
                           AND B.RLANE_CD       = T2.RLANE_CD
                           AND B.REV_DIR_CD     = T2.REV_DIR_CD
                        ) AS REV_YRMON
                     , T5.CLPT_IND_SEQ
                  FROM VSK_VSL_SKD          T1
                     , PSO_PORT_EXPN_DIV    T2
                     --, GL_ESTM_REV_VVD      T4
                     , VSK_VSL_PORT_SKD     T5
                 WHERE 1=1
                   AND T5.VSL_CD        = @[vsl_cd] 
                   AND T5.SKD_VOY_NO    = @[skd_voy_no]
                   AND T5.SKD_DIR_CD    = @[skd_dir_cd]
                   AND T5.VPS_PORT_CD   = SUBSTR (@[yd_cd], 1, 5)
                   AND T5.YD_CD         = @[yd_cd]
                   AND T5.CLPT_IND_SEQ  = @[clpt_ind_seq]
                   AND NVL(T5.VT_ADD_CALL_FLG, 'N') = 'N' /*2015.07.21 Add*/
                   AND NVL(T5.SKD_CNG_STS_CD, ' ') != 'S'
                   AND T5.VSL_CD        = T1.VSL_CD
                   AND T5.SKD_VOY_NO    = T1.SKD_VOY_NO
                   AND T5.SKD_DIR_CD    = T1.SKD_DIR_CD
                   AND T1.VSL_SLAN_CD   = T2.SLAN_CD
                   AND T1.SKD_DIR_CD    = T2.SKD_DIR_CD
                   AND T5.VPS_PORT_CD   = T2.LOC_CD                   
                 ORDER BY T5.CLPT_SEQ
               ) T01
         WHERE 1=1 ) T02
 WHERE 1=1
   --AND T02.YD_CD = 'CNSHA12' -- Test Yd
 --ORDER BY PORT_SEQ			]]></sql>
			<params>
				<param name="exe_yrmon" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="yd_cd" type="12" value="" out="N"/>
				<param name="clpt_ind_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
