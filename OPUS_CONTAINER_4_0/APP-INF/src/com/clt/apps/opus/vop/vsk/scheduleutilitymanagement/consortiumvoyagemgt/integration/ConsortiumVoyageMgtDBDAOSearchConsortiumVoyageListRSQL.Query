<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ConsortiumVoyageMgtDBDAOSearchConsortiumVoyageListRSQL">
			<desc><![CDATA[SearchConsortiumVoyageList]]></desc>
			<sql><![CDATA[
SELECT  A.SLAN_CD AS VSL_SLAN_CD
	  ,	A.VSL_CD
      ,	A.SKD_VOY_NO
	  ,	A.SKD_DIR_CD
	  ,	A.VPS_PORT_CD
	  , A.CLPT_SEQ
	  , A.TURN_PORT_FLG
	  , A.TURN_SKD_VOY_NO
	  , A.TURN_SKD_DIR_CD
      , A.CSSM_VOY_INIT_CRE_FLG
	  , A.TURN_PORT_IND_CD
	  , A.VT_ADD_CALL_FLG
	  , A.CLPT_IND_SEQ
	  ,(SELECT LISTAGG(SKD_DIR_CD, ':') WITHIN GROUP (ORDER BY MIN(PORT_ROTN_SEQ))
        FROM VSK_PF_SKD_DTL 
        WHERE VSL_SLAN_CD  = A.SLAN_CD
        AND PF_SVC_TP_CD = B.PF_SKD_TP_CD 
        GROUP BY SKD_DIR_CD) SKD_DIR_CD_ORD
	  ,	TO_CHAR(PF_ETA_DT  , 'YYYY-MM-DD HH24:MI') AS PF_ETA_DT
	  ,	TO_CHAR(PF_ETB_DT  , 'YYYY-MM-DD HH24:MI') AS PF_ETB_DT	 
	  ,	TO_CHAR(PF_ETD_DT  , 'YYYY-MM-DD HH24:MI') AS PF_ETD_DT 
	  ,	TO_CHAR(INIT_ETA_DT, 'YYYY-MM-DD HH24:MI') AS INIT_ETA_DT 
	  ,	TO_CHAR(INIT_ETB_DT, 'YYYY-MM-DD HH24:MI') AS INIT_ETB_DT 
	  ,	TO_CHAR(INIT_ETD_DT, 'YYYY-MM-DD HH24:MI') AS INIT_ETD_DT 
	  ,	TO_CHAR(VPS_ETA_DT , 'YYYY-MM-DD HH24:MI') AS VPS_ETA_DT 
	  ,	TO_CHAR(VPS_ETB_DT , 'YYYY-MM-DD HH24:MI') AS VPS_ETB_DT
	  ,	TO_CHAR(VPS_ETD_DT , 'YYYY-MM-DD HH24:MI') AS VPS_ETD_DT
	  ,	A.IB_CSSM_VOY_NO IB_CSSM_VOY_NO
	  ,	A.OB_CSSM_VOY_NO OB_CSSM_VOY_NO
	  ,	A.UPD_USR_ID     UPD_USR_ID
	  ,	TO_CHAR(A.UPD_DT,'YYYYMMDDHH24MISS')         UPD_DT
	  , CASE WHEN A.TURN_PORT_IND_CD IN ('D','V','F') THEN 'V' 
			 WHEN A.CLPT_SEQ = '1' AND A.TURN_PORT_FLG = 'Y' THEN 'Y' 
        ELSE A.TURN_PORT_IND_CD
        END REAL_TURN_PORT_IND_CD -- P/F 상 첫번째 Port의 TURN_PORT_IND 를 'Y'로 표시하기 위한 조건 

	,	CASE 	WHEN A.TURN_PORT_IND_CD IN ('Y','N') THEN NULL
            	ELSE RANK() OVER (PARTITION BY A.VSL_CD,A.SKD_VOY_NO,A.SKD_DIR_CD ORDER BY DECODE(A.TURN_PORT_IND_CD,'F',1,'D',2,'V',2,9) ASC, A.VPS_ETB_DT ASC) 
       	END  	VIR_PORT_CLPT_SEQ

       , CASE   WHEN A.TURN_PORT_IND_CD IN ('Y','N') THEN
                (SELECT		MIN(PS.CLPT_SEQ)
              	FROM      	VSK_VSL_PORT_SKD      PS
              	WHERE     	PS.VSL_CD             = A.VSL_CD
              	AND       	PS.SKD_VOY_NO         = A.SKD_VOY_NO
              	AND       	PS.SKD_DIR_CD         = A.SKD_DIR_CD
              	AND       	PS.TURN_SKD_VOY_NO    IS NOT NULL
              	AND       	PS.TURN_PORT_IND_CD   IN ('Y','N')
              	)
              	ELSE NULL
        END 	FIRST_TURN_PORT_CLPT_SEQ

       , CASE	WHEN A.TURN_PORT_IND_CD IN ('Y','N') AND A.TURN_SKD_VOY_NO IS NOT NULL THEN ROW_NUMBER() OVER (PARTITION BY A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD ORDER BY DECODE(A.TURN_SKD_VOY_NO,NULL,9,1) ASC, A.CLPT_SEQ ASC)
				ELSE NULL
		END		REAL_CLPT_SEQ

   FROM VSK_VSL_PORT_SKD 	A
      , VSK_VSL_SKD 		B
  WHERE 1 = 1
    #if (${vsl_slan_cd} != '') 
    AND A.SLAN_CD      			= @[vsl_slan_cd]
    #end
    --::2015-05-15:by TOP::--AND A.CLPT_IND_SEQ 			= 1
	AND A.VSL_CD       			= B.VSL_CD
    AND A.SKD_VOY_NO   			= B.SKD_VOY_NO
	AND	A.SKD_DIR_CD   			= B.SKD_DIR_CD

    --AND B.SKD_DIR_CD 			= XX.SKD_DIR_CD
    --AND B.PF_SKD_TP_CD 		= XX.PF_SVC_TP_CD
	

	#if(${vsl_cd} == '' || ${skd_voy_no} == '')  
      #if (${fm_dt} != '')       
      AND EXISTS (SELECT 1 FROM VSK_VSL_PORT_SKD SKD
                   WHERE SKD.VPS_ETB_DT BETWEEN TO_DATE(REPLACE(@[fm_dt], '-', ''), 'YYYYMMDD') AND TO_DATE(REPLACE(@[to_dt], '-', ''), 'YYYYMMDD')
                   -- AND CLPT_SEQ    = 1
                    AND VSL_CD      = A.VSL_CD
                    AND SKD_VOY_NO  = A.SKD_VOY_NO
                    AND SKD_DIR_CD  = A.SKD_DIR_CD
                 )
      #end
	#end
#if(${cv_cbm2} == '1')
AND 
	A.CSSM_VOY_INIT_CRE_FLG ='Y'
#elseif(${cv_cbm2} == '2')
AND
	A.CSSM_VOY_INIT_CRE_FLG ='N'
#end

	
	#if (${vsl_cd} != '') 
	AND A.VSL_CD = @[vsl_cd]
    #end

	#if (${skd_voy_no} != '') 
	AND A.SKD_VOY_NO = @[skd_voy_no]
    #end

	#if (${skd_dir_cd} != '') 
	AND A.SKD_DIR_CD = @[skd_dir_cd]
    #end
    
    #if (${chk_virtual_port} == '')
    AND TURN_PORT_IND_CD NOT IN ('D','V','F')
	#end

  ORDER BY 		SLAN_CD
	     	, 	VSL_CD
         	, 	SKD_VOY_NO
	     	, DECODE(SKD_DIR_CD, SUBSTR(SKD_DIR_CD_ORD, 1, 1), 1, SUBSTR(SKD_DIR_CD_ORD, 3, 1), 2, 3)
			--,	PORT_ORD_SEQ
         	, 	CLPT_SEQ
         	, 	VPS_ETA_DT			]]></sql>
			<params>
				<param name="vsl_slan_cd" type="12" value="" out="N"/>
				<param name="fm_dt" type="12" value="" out="N"/>
				<param name="to_dt" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
