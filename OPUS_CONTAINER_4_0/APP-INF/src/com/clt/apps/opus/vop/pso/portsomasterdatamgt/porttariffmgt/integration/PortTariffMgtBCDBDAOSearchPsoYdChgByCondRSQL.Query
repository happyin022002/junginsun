<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="PortTariffMgtBCDBDAOSearchPsoYdChgByCondRSQL">
			<desc><![CDATA[DESC Enter..]]></desc>
			<sql><![CDATA[
WITH V_PSO_YD_CHG AS (
       SELECT A.YD_CHG_NO
             ,A.YD_CHG_VER_SEQ
             ,A.YD_CD
             ,C.ACCT_CD ACCT_CD
             ,A.LGS_COST_CD COST_CD
             ,A.VNDR_SEQ
             ,A.CPLS_FLG
             ,A.LST_FLG
             ,DENSE_RANK() OVER(ORDER BY A.YD_CD, C.ACCT_CD, A.LGS_COST_CD) AS GRP_NO
             ,COUNT(*) OVER(PARTITION BY A.YD_CD, C.ACCT_CD, A.LGS_COST_CD ORDER BY A.YD_CD, C.ACCT_CD, A.LGS_COST_CD) AS GRP_COST_CNT
             ,COUNT(*) OVER(PARTITION BY A.YD_CD, C.ACCT_CD, A.LGS_COST_CD, A.VNDR_SEQ ORDER BY A.YD_CD, C.ACCT_CD, A.LGS_COST_CD, A.VNDR_SEQ) AS GRP_VNDR_CNT
             ,TO_CHAR(A.EFF_DT, 'YYYY-MM-DD') EFF_DT
             ,TO_CHAR(A.EXP_DT, 'YYYY-MM-DD') EXP_DT
             ,A.CURR_CD
             ,A.CRE_USR_ID
             ,B.VNDR_LGL_ENG_NM VNDR_NM
             ,'' PORT_CD
             ,'' YARD_CD
             ,'' FROM_DATE
             ,'' TO_DATE
             ,(SELECT NVL(SACAI.ACCL_FLG, 'N')
                 FROM SCO_AP_COST_ACT_INFO SACAI
                WHERE 1=1
                  AND SACAI.SRC_MDL_CD = 'PSO'
                  AND NVL(SACAI.ENBL_FLG, 'N') = 'N'
                  AND SACAI.ACT_COST_CD = A.LGS_COST_CD 
               ) AS ACCL_FLG
          FROM PSO_YD_CHG A
             ,MDM_VENDOR B
             ,TES_LGS_COST C
         WHERE 1=1
--Period
           AND A.EFF_DT <= TO_DATE(NVL(REPLACE(@[to_dt], '-', ''), '99991231'), 'YYYYMMDD') -- to_dt  가 없을 경우, '99991231'
           AND A.EXP_DT >= TO_DATE(NVL(REPLACE(@[from_dt], '-', ''), '10000101'), 'YYYYMMDD') -- from_dt가 없을 경우, '10000101'
--Port
#if(${yard_cd} != '')
           AND A.YD_CD IN (
                   #foreach($key IN ${arr_yard_cd}) 
       		           #if($velocityCount < $arr_yard_cd.size())
  		                   @[port_cd] || '$key',
		               #else
		                   @[port_cd] || '$key'
		               #end
	               #end
               )
#else
    #if(${port_cd} != '')
           AND A.YD_CD LIKE @[port_cd] || '__'
    #end
#end

--Account
#if(${cost_cd} != '')
           AND A.LGS_COST_CD = @[cost_cd]
#else
    #if(${acct_cd} != '')
           AND A.LGS_COST_CD IN (SELECT X.LGS_COST_CD                         
                         FROM   TES_LGS_COST X
                               ,MDM_ACCOUNT  Y 
                         WHERE  1=1
                         AND    X.ACCT_CD = Y.ACCT_CD
                         AND    X.LGS_COST_SUBJ_CD IN ('PT', 'CN')
                         AND    X.LGS_COST_CD_CLSS_LVL = 'A'
                         AND    Y.ACCT_CD = @[acct_cd]
                        ) 
    #end
#end
           AND A.VNDR_SEQ = B.VNDR_SEQ
           AND A.LGS_COST_CD = C.LGS_COST_CD
         ORDER BY A.YD_CD
             , C.ACCT_CD
             , A.LGS_COST_CD
             , A.VNDR_SEQ
             , TO_CHAR(A.EFF_DT, 'YYYY-MM-DD')
             , TO_CHAR(A.EXP_DT, 'YYYY-MM-DD')
             , A.YD_CHG_VER_SEQ 
  )
--SELECT * FROM V_PSO_YD_CHG;
SELECT A.*
     , CASE WHEN A.GRP_COST_CNT <> A.GRP_VNDR_CNT AND A.GRP_COST_CNT > 1 AND A.CHK_CPLS_CNT = 0 AND A.ACCL_FLG = 'Y' 
            THEN 'N'
            ELSE 'Y'
       END AS CHK_CPLS_FLG
  FROM (SELECT A.*
             , (SELECT COUNT(*)
                  FROM V_PSO_YD_CHG V
                 WHERE V.YD_CD      = A.YD_CD
                   AND V.ACCT_CD    = A.ACCT_CD
                   AND V.COST_CD    = A.COST_CD
                   AND V.GRP_NO     = A.GRP_NO
                   AND V.CPLS_FLG   = 'Y' 
                ) AS CHK_CPLS_CNT
          FROM V_PSO_YD_CHG A 
       ) A 
 ORDER BY A.YD_CD
     , A.ACCT_CD
     , A.COST_CD
     , A.VNDR_SEQ
     , A.EFF_DT
     , A.EXP_DT
     , A.YD_CHG_VER_SEQ			]]></sql>
			<params>
				<param name="to_dt" type="12" value="" out="N"/>
				<param name="from_dt" type="12" value="" out="N"/>
				<param name="port_cd" type="12" value="" out="N"/>
				<param name="cost_cd" type="12" value="" out="N"/>
				<param name="acct_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
