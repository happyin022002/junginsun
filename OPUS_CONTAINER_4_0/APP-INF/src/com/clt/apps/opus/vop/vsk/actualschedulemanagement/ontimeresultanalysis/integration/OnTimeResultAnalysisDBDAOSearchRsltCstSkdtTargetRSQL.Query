<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="OnTimeResultAnalysisDBDAOSearchRsltCstSkdtTargetRSQL">
			<desc><![CDATA[Vessel Port Schedule 을 이용한 지연 조회]]></desc>
			<sql><![CDATA[
/*
SELECT
	 '' VSL_SLAN_CD
	,'' VSL_CD
	,'' SKD_VOY_NO
	,'' SUB_TRD_DIR_CD
	,'' VPS_PORT_CD
	,'' CLPT_IND_SEQ
	,'' CLPT_SEQ
	,'' SKD_DIR_CD
	,'' YD_CD
	,'' PF_ETB_DT
	,'' PF_ETD_DT
	,'' ACT_BRTH_DT
	,'' ACT_DEP_DT
	,'' CONTI_CD
	,'' ARR_DLAY_RSN_CD1
	,'' ARR_DLAY_RSN_CD2
	,'' DEP_DLAY_RSN_CD1
	,'' DEP_DLAY_RSN_CD2
	,'' ACT_INP_YRMON
	,'' ARR_DLAY_HRS1
	,'' ARR_DLAY_HRS2
	,'' DEP_DLAY_HRS1
	,'' DEP_DLAY_HRS2
	,'' TURN_PORT_IND_CD
	,'' SKD_CNG_STS_CD
FROM DUAL
*/
SELECT
	T1.VSL_SLAN_CD
    ,T1.VSL_CD
    ,@[voy_no] AS SKD_VOY_NO
    ,@[dir_cd] AS SUB_TRD_DIR_CD
    ,T1.VPS_PORT_CD
    ,T1.CLPT_IND_SEQ
    ,ROWNUM AS CLPT_SEQ
    ,DECODE(Y, '0', T1.SKD_DIR_CD, '1', T1.TURN_SKD_DIR_CD) AS SKD_DIR_CD
    ,T1.YD_CD
    ,TO_CHAR(T1.PF_ETB_DT, 'YYYY-MM-DD HH24:MI') PF_ETB_DT
    ,TO_CHAR(T1.PF_ETD_DT, 'YYYY-MM-DD HH24:MI') PF_ETD_DT
    ,TO_CHAR(T2.ACT_BRTH_DT, 'YYYY-MM-DD HH24:MI') ACT_BRTH_DT
    ,TO_CHAR(T2.ACT_DEP_DT, 'YYYY-MM-DD HH24:MI') ACT_DEP_DT
    ,T1.CONTI_CD
    ,T1.VSL_DLAY_RSN_CD AS ARR_DLAY_RSN_CD1
    ,T2.VSL_ARR_DLAY_RSN_CD AS ARR_DLAY_RSN_CD2
    ,T2.VSL_BRTH_DLAY_RSN_CD AS DEP_DLAY_RSN_CD1
    ,T2.VSL_DEP_DLAY_RSN_CD AS DEP_DLAY_RSN_CD2
	,TO_CHAR(T2.ACT_DEP_DT, 'YYYYMM') ACT_INP_YRMON
	,'0' ARR_DLAY_HRS1
	,'0' ARR_DLAY_HRS2
	,'0' DEP_DLAY_HRS1
	,'0' DEP_DLAY_HRS2
	,T1.TURN_PORT_IND_CD
	,T1.SKD_CNG_STS_CD
FROM (
    SELECT T1.* FROM (
        SELECT T1.*, DECODE(T1.TURN_PORT_IND_CD, 'N', 0, 'Y', 0, X) Y FROM (
            SELECT 
				T1.VSL_SLAN_CD
                ,T2.VSL_CD
                ,CASE WHEN (T2.TURN_PORT_IND_CD = 'D' OR T2.TURN_PORT_IND_CD = 'V' OR T2.TURN_PORT_IND_CD = 'F') THEN
                    T2.TURN_SKD_VOY_NO
                ELSE
                    T2.SKD_VOY_NO
                END AS SKD_VOY_NO
                ,CASE WHEN (T2.TURN_PORT_IND_CD = 'D' OR T2.TURN_PORT_IND_CD = 'V' OR T2.TURN_PORT_IND_CD = 'F') THEN
                    T2.TURN_SKD_DIR_CD
                ELSE
                    T2.SKD_DIR_CD
                END SKD_DIR_CD
                ,CASE WHEN (T2.TURN_PORT_IND_CD = 'D' OR T2.TURN_PORT_IND_CD = 'V' OR T2.TURN_PORT_IND_CD = 'F') THEN
                    T2.TURN_CLPT_IND_SEQ
                ELSE
                    T2.CLPT_IND_SEQ
                END AS CLPT_IND_SEQ
                ,T2.VPS_PORT_CD 
                ,T2.YD_CD
                ,T2.PF_ETB_DT
                ,T2.PF_ETD_DT
                ,T2.TURN_PORT_IND_CD
                ,T2.TURN_SKD_DIR_CD
                ,DECODE(T3.CONTI_CD, 'F', 'E', T3.CONTI_CD) CONTI_CD /* 아프리카는 유럽 CONTI_CD로 처리 */
                ,T2.VSL_DLAY_RSN_CD
                ,T2.SKD_CNG_STS_CD
                ,RANK() OVER(PARTITION BY T2.TURN_PORT_IND_CD ORDER BY T2.CLPT_SEQ ASC) X
            FROM VSK_VSL_SKD T1, VSK_VSL_PORT_SKD T2, MDM_LOCATION T3
            WHERE 1=1
            AND T1.VSL_CD = T2.VSL_CD
            AND T1.SKD_VOY_NO = T2.SKD_VOY_NO
            AND T1.SKD_DIR_CD = T2.SKD_DIR_CD
            AND T1.VSL_CD = @[vsl_cd]
            AND T1.SKD_VOY_NO = @[voy_no]
            AND T1.SKD_DIR_CD = @[dir_cd]
            AND T2.TURN_PORT_IND_CD != 'V'
--			AND NVL(T2.SKD_CNG_STS_CD, ' ') != 'S'
            AND T3.LOC_CD = T2.VPS_PORT_CD
			AND T2.VT_ADD_CALL_FLG IS NULL
#if (${clpt_seq} != '') 
            AND TO_CHAR(T2.CLPT_SEQ) IN (
#foreach( $key in ${clpt_seq}) 
            #if($velocityCount < $clpt_seq.size())
                '$key',
            #else
                '$key'
            #end
#end
            )
#end
            ORDER BY T2.CLPT_SEQ
        ) T1
    ) T1
    WHERE T1.Y <= 1
) T1, VSK_ACT_PORT_SKD T2
WHERE 1=1
AND T1.VSL_CD = T2.VSL_CD(+)
AND T1.SKD_VOY_NO = T2.SKD_VOY_NO(+)
AND T1.SKD_DIR_CD = T2.SKD_DIR_CD(+)
AND T1.VPS_PORT_CD = T2.VPS_PORT_CD(+)
AND T1.CLPT_IND_SEQ = T2.CLPT_IND_SEQ(+)			]]></sql>
			<params>
				<param name="voy_no" type="12" value="" out="N"/>
				<param name="dir_cd" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
