<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="VesselScheduleMgtDBDAOSearchAutoSkdUpdateRSQL">
			<desc><![CDATA[DESC Enter..]]></desc>
			<sql><![CDATA[
SELECT  T31.LVL, T31.VSL_CD, T31.SKD_VOY_NO, T31.SKD_DIR_CD
        , T31.VPS_PORT_CD, T31.CLPT_IND_SEQ, T31.CLPT_SEQ
		, T31.YD_CD, T31.SLAN_CD, T31.ACT_INP_FLG
        , TO_CHAR(T31.PF_ETA_DT, 'YYYYMMDDHH24MI') AS PF_ETA_DT
		, TO_CHAR(T31.PF_ETB_DT, 'YYYYMMDDHH24MI') AS PF_ETB_DT
		, TO_CHAR(T31.PF_ETD_DT, 'YYYYMMDDHH24MI') AS PF_ETD_DT
        , TO_CHAR(T31.INIT_ETA_DT, 'YYYYMMDDHH24MI') AS INIT_ETA_DT
		, TO_CHAR(T31.INIT_ETB_DT, 'YYYYMMDDHH24MI') AS INIT_ETB_DT
		, TO_CHAR(T31.INIT_ETD_DT, 'YYYYMMDDHH24MI') AS INIT_ETD_DT
        , TO_CHAR(T31.VPS_ETA_DT, 'YYYYMMDDHH24MI') AS VPS_ETA_DT
		, TO_CHAR(T31.VPS_ETB_DT, 'YYYYMMDDHH24MI') AS VPS_ETB_DT
		, TO_CHAR(T31.VPS_ETD_DT, 'YYYYMMDDHH24MI') AS VPS_ETD_DT
        , T31.TURN_PORT_FLG, T31.TURN_PORT_IND_CD, T31.TURN_SKD_VOY_NO, T31.TURN_SKD_DIR_CD, T31.TURN_CLPT_IND_SEQ
		, NVL(T31.PORT_BUF_HRS, T32.PORT_BUF_HRS) AS PORT_BUF_HRS
		, NVL(T31.SEA_BUF_HRS, T32.SEA_BUF_HRS) AS SEA_BUF_HRS
        , T31.VSL_SLAN_CD, T31.PF_SKD_TP_CD
		, T31.AUTO_SKD_CNG_FLG
        , T32.MNVR_IN_HRS, T32.ACT_WRK_HRS, T32.MNVR_OUT_HRS, T32.TZTM_HRS
        , (
            SELECT GMT_HRS/60.0 FROM MDM_LOCATION
             WHERE LOC_CD = T31.VPS_PORT_CD
          ) AS GMT_HRS
FROM    (
        SELECT  T21.LVL, T21.VSL_CD, T21.SKD_VOY_NO, T21.SKD_DIR_CD
                , T22.VPS_PORT_CD, T22.CLPT_IND_SEQ, T22.CLPT_SEQ
				, T22.YD_CD, T22.SLAN_CD, T22.ACT_INP_FLG
                , T22.PF_ETA_DT, T22.PF_ETB_DT, T22.PF_ETD_DT
                , T22.INIT_ETA_DT, T22.INIT_ETB_DT, T22.INIT_ETD_DT
                , T22.VPS_ETA_DT, T22.VPS_ETB_DT, T22.VPS_ETD_DT
                , T22.TURN_PORT_FLG, T22.TURN_PORT_IND_CD, T22.TURN_SKD_VOY_NO, T22.TURN_SKD_DIR_CD, T22.TURN_CLPT_IND_SEQ
				, T22.PORT_BUF_HRS, T22.SEA_BUF_HRS
				, T22.AUTO_SKD_CNG_FLG
				
                -- auto update 당일 체크 로직 주석 
                -- ACT_AUTO_UPDATE일경우 다음 PORT의 시간 계산을 하지 않음
                -- 2015.01.08  DONGSOO 주석 처리함 
                /*
				, CASE WHEN T22.AUTO_SKD_CNG_FLG = 'Y' 
							OR (TO_CHAR(T22.UPD_DT, 'YYYYMMDD') = TO_CHAR(SYSDATE, 'YYYYMMDD') AND T22.UPD_USR_ID != 'ACT_AUTO_UPDATE') 
					   THEN 'Y' 
					   ELSE 'N' 
				  END AS AUTO_SKD_CNG_FLG
	             */
                , T23.VSL_SLAN_CD
                , T23.PF_SKD_TP_CD
        FROM    (
                SELECT  LEVEL AS LVL
                        , T11.VSL_CD, T11.SKD_VOY_NO, T11.SKD_DIR_CD
                        , T11.TURN_SKD_VOY_NO, T11.TURN_SKD_DIR_CD
                FROM    (
                        SELECT  DISTINCT
                                T1.VSL_CD, T1.SKD_VOY_NO, T1.SKD_DIR_CD
                                , T1.TURN_SKD_VOY_NO, T1.TURN_SKD_DIR_CD
                        FROM    VSK_VSL_PORT_SKD T1, VSK_VSL_PORT_SKD T2
                        WHERE   T1.VSL_CD = @[vsl_cd]
                        AND     T1.VSL_CD = T2.VSL_CD
                        AND     T1.TURN_SKD_VOY_NO = T2.SKD_VOY_NO
                        AND     T1.TURN_SKD_DIR_CD = T2.SKD_DIR_CD
                        AND     T1.TURN_PORT_IND_CD IN ('F', 'V', 'D')
                        AND     T2.TURN_PORT_FLG = 'Y'
                        ) T11
                START WITH SKD_VOY_NO = @[skd_voy_no] AND SKD_DIR_CD = @[skd_dir_cd]

                CONNECT BY 		PRIOR TURN_SKD_VOY_NO = SKD_VOY_NO 
							AND PRIOR TURN_SKD_DIR_CD = SKD_DIR_CD
							AND	PRIOR VSL_CD		  = VSL_CD

                UNION ALL
                SELECT  DISTINCT 1 AS LVL
                        , VSL_CD, SKD_VOY_NO, SKD_DIR_CD
                        , TURN_SKD_VOY_NO, TURN_SKD_DIR_CD
                FROM    VSK_VSL_PORT_SKD T3
                WHERE   VSL_CD = @[vsl_cd] 
				AND 	SKD_VOY_NO = @[skd_voy_no] 
				AND 	SKD_DIR_CD = @[skd_dir_cd]
                AND     1 = NVL(
                                   (SELECT 2 
                                    FROM VSK_VSL_PORT_SKD 
                                    WHERE VSL_CD = T3.VSL_CD
                                    AND SKD_VOY_NO = T3.SKD_VOY_NO
                                    AND SKD_DIR_CD = T3.SKD_DIR_CD
                                    AND (TURN_PORT_FLG = 'Y' OR TURN_PORT_IND_CD IN ('F', 'V', 'D')) AND ROWNUM = 1)
                            , 1)            /* Turnning 이 없을 경우 입력한 Port 및 그 이후의 Port 를 조회하기 위해 */
                UNION ALL
                SELECT  DISTINCT 2 AS LVL
                        , VSL_CD, TURN_SKD_VOY_NO AS SKD_VOY_NO, TURN_SKD_DIR_CD AS SKD_DIR_CD
                        , '' AS TURN_SKD_VOY_NO, '' AS TURN_SKD_DIR_CD
                FROM    VSK_VSL_PORT_SKD T4
                WHERE   VSL_CD = @[vsl_cd] 
				AND 	SKD_VOY_NO = @[skd_voy_no] 
				AND 	SKD_DIR_CD = @[skd_dir_cd]
				AND     TURN_PORT_IND_CD IN ('F', 'V', 'D')
                AND     1 = NVL(
                                   (SELECT 2 
                                    FROM VSK_VSL_PORT_SKD 
                                    WHERE VSL_CD = T4.VSL_CD
                                    AND SKD_VOY_NO = T4.TURN_SKD_VOY_NO
                                    AND SKD_DIR_CD = T4.TURN_SKD_DIR_CD
                                    AND TURN_PORT_IND_CD IN ('F', 'V', 'D')
                                    AND ROWNUM = 1)
                            , 1)            /* Virtual 의 Virtual 이 없을 경우 입력한 Port 이후의 Port 를 조회하기 위해 */
                ) T21, VSK_VSL_PORT_SKD T22, VSK_VSL_SKD T23
        WHERE   1 = 1
        AND     T21.VSL_CD = T23.VSL_CD
        AND     T21.SKD_VOY_NO = T23.SKD_VOY_NO
        AND     T21.SKD_DIR_CD = T23.SKD_DIR_CD
        AND     T21.VSL_CD       = T22.VSL_CD
        AND     T21.SKD_VOY_NO   = T22.SKD_VOY_NO
        AND     T21.SKD_DIR_CD   = T22.SKD_DIR_CD
--        AND     T22.AUTO_SKD_CNG_FLG   = 'N'                                    	/* 스케줄 고정 PORT 제외(주석처리 - 스케줄 고정 PORT 조회되어야 함) */
        AND     (T22.SKD_CNG_STS_CD IS NULL OR T22.SKD_CNG_STS_CD != 'S')       	/* SKIP 제외 */
        AND     (LVL = 1 AND TURN_PORT_IND_CD NOT IN ('F', 'V', 'D') OR LVL = 2)	/* 마지막 VVD 만 Virtual 조회 */
        AND     (
                    (T21.LVL = 1 AND T22.CLPT_SEQ >= (
                                                        SELECT  CLPT_SEQ
                                                        FROM    VSK_VSL_PORT_SKD 
                                                        WHERE   VSL_CD = @[vsl_cd]
                                                        AND     SKD_VOY_NO = @[skd_voy_no]
                                                        AND     SKD_DIR_CD = @[skd_dir_cd]
                                                        AND     VPS_PORT_CD = @[vps_port_cd]
                                                        AND     CLPT_IND_SEQ = @[clpt_ind_seq]
                                                    )
                    ) OR T21.LVL > 1
                )                   /* 입력한 VVD 부터 나오도록 찾는다.(START PORT) */
        AND     T21.LVL <=  2     	/* 입력한 VVD 다음 Direction 까지만 나오도록 찾는다.(END PORT) */
        ) T31, (
                SELECT	T1.VSL_SLAN_CD, T1.PF_SVC_TP_CD, T1.PORT_CD, DECODE(VIRT_FLG, 'V', T1.DIR_CD2, T2.SKD_DIR_CD) AS SKD_DIR_CD
                        , T1.CLPT_SEQ, T2.PORT_ROTN_SEQ, T2.YD_CD, CALL_YD_IND_SEQ, TURN_PORT_FLG, TURN_PORT_IND_CD, ETB_DY_CD, ETB_DY_NO
    					, ETB_TM_HRMNT, ETD_DY_CD, ETD_DY_NO, ETD_TM_HRMNT, LNK_DIST, LNK_SPD, TZTM_HRS
    					, SEA_BUF_HRS, SEA_BUF_SPD, MNVR_IN_HRS, MNVR_OUT_HRS
    					, IB_IPCGO_QTY, IB_OCN_CGO_QTY, OB_IPCGO_QTY
    					, OB_OCN_CGO_QTY, TML_PROD_QTY, CRN_KNT, ACT_WRK_HRS, PORT_BUF_HRS, CRE_USR_ID, CRE_DT, UPD_USR_ID, UPD_DT
    			FROM	(
                        SELECT 	NVL(T3.VSL_SLAN_CD	, T1.VSL_SLAN_CD	) AS VSL_SLAN_CD
                                , NVL(T3.PF_SVC_TP_CD	, T1.PF_SVC_TP_CD	) AS PF_SVC_TP_CD
                                , NVL(T3.PORT_CD		, T1.PORT_CD		) AS PORT_CD
                                , DECODE(T3.SKD_DIR_CD, NULL, (	SELECT	S.VSL_SLAN_DIR_CD
                            									FROM	MDM_VSL_SVC_LANE_DIR S
                            									WHERE	1 = 1
                            									AND		T1.VSL_SLAN_CD	= S.VSL_SLAN_CD
                            									AND		T1.SKD_DIR_CD	!= S.VSL_SLAN_DIR_CD
                            									AND		S.DELT_FLG		= 'N'
                            									AND		ROWNUM			= 1
                            								  ), T1.SKD_DIR_CD
                                  ) AS SKD_DIR_CD
                                , DECODE(T3.CLPT_SEQ, NULL, (   SELECT	T1.CLPT_SEQ
                            									FROM	VSK_PF_SKD_DTL M
                            									WHERE	1 = 1
                            									AND		T1.VSL_SLAN_CD	= M.VSL_SLAN_CD
                            									AND		T1.PF_SVC_TP_CD	= M.PF_SVC_TP_CD
                            									AND		T1.SKD_DIR_CD	= (
                                                        									SELECT	S.VSL_SLAN_DIR_CD
                                                        									FROM	MDM_VSL_SVC_LANE_DIR S
                                                        									WHERE	1 = 1
                                                        									AND		T1.VSL_SLAN_CD	= S.VSL_SLAN_CD
                                                        									AND		T1.SKD_DIR_CD	=S.VSL_SLAN_DIR_CD
                                                        									AND		S.DELT_FLG		= 'N'
    								                                                      )
                                								AND		T1.PORT_CD		= M.PORT_CD
                                								AND		T1.CLPT_SEQ		= M.CLPT_SEQ
                                								AND     M.TURN_PORT_IND_CD != 'F'
                                								), T1.CLPT_SEQ
                                  ) AS CLPT_SEQ
                                , DECODE(T3.SKD_DIR_CD, NULL, 'V', 'N') AS VIRT_FLG
                                , T1.SKD_DIR_CD AS DIR_CD2
    					FROM  	VSK_PF_CALL_PORT T1, MDM_VSL_SVC_LANE_DIR T2, VSK_PF_SKD_DTL T3
    					WHERE  	1	= 1
    					AND		T1.VSL_SLAN_CD	= T2.VSL_SLAN_CD
    					AND		T1.SKD_DIR_CD	= T2.VSL_SLAN_DIR_CD
    					AND		T1.VSL_SLAN_CD	= T3.VSL_SLAN_CD 	(+)
    					AND		T1.PF_SVC_TP_CD	= T3.PF_SVC_TP_CD	(+)
    					AND		T1.SKD_DIR_CD	= T3.SKD_DIR_CD		(+)
    					AND		T1.PORT_CD		= T3.PORT_CD		(+)
    					AND		T1.CLPT_SEQ		= T3.CLPT_SEQ		(+)
    					AND     T3.TURN_PORT_IND_CD(+) != 'F'
    --					AND		T1.VSL_SLAN_CD 	= 'CNX'
    --					AND		T1.PF_SVC_TP_CD = '4002'
    					) T1, VSK_PF_SKD_DTL T2
    			WHERE 1 = 1
    			AND  T1.VSL_SLAN_CD = T2.VSL_SLAN_CD
    			AND  T1.PF_SVC_TP_CD = T2.PF_SVC_TP_CD
    			AND  T1.PORT_CD  = T2.PORT_CD
    			AND  T1.SKD_DIR_CD = T2.SKD_DIR_CD
    			AND  T1.CLPT_SEQ  = T2.CLPT_SEQ
               ) T32
WHERE   1 = 1
AND     T31.VSL_SLAN_CD  = T32.VSL_SLAN_CD(+)
AND     T31.PF_SKD_TP_CD = T32.PF_SVC_TP_CD(+)
AND     T31.SKD_DIR_CD   = T32.SKD_DIR_CD(+)
AND     T31.VPS_PORT_CD  = T32.PORT_CD (+)
AND     T31.CLPT_IND_SEQ = T32.CLPT_SEQ(+)
ORDER BY T31.LVL, T31.CLPT_SEQ			]]></sql>
			<params>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="vps_port_cd" type="12" value="" out="N"/>
				<param name="clpt_ind_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
