<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BudgetPortChargeMgtBCDBDAOgetRevLaneDirRSQL">
			<desc><![CDATA[Rev Lane Diirction Search]]></desc>
			<sql><![CDATA[
WITH V_PARAM AS (    
    SELECT @[vsl_cd]        AS VSL_CD
         , @[skd_voy_no]    AS SKD_VOY_NO
         , @[skd_dir_cd]    AS SKD_DIR_CD
         , @[yd_cd]         AS YD_CD
         , @[clpt_ind_seq]  AS CLPT_IND_SEQ
         , REPLACE(@[exe_yrmon],'-','')         AS EXE_YRMON
      FROM DUAL                     
)
, V_PORT_SKD AS (
    /*디폴트로 1건이 나타나도록 처리 함.*/
    SELECT *
      FROM (
            SELECT '1' AS ORD 
                 --, VPS.TURN_PORT_FLG
                 , DECODE(VPS.TURN_PORT_IND_CD,'N',DECODE(VPS.TURN_PORT_FLG,'Y','Y','N'),'Y') AS TURN_PORT_FLG
                 , VPS.VSL_CD
                 , VPS.SKD_VOY_NO
                 , VPS.SKD_DIR_CD
                 , VPS.YD_CD
                 , P.EXE_YRMON
              FROM VSK_VSL_PORT_SKD VPS
                 , V_PARAM P
             WHERE 1=1
               AND NVL(VPS.VT_ADD_CALL_FLG, 'N') = 'N' /*2015.07.21 Add*/
               AND NVL(VPS.SKD_CNG_STS_CD, ' ') != 'S'
               AND VPS.VSL_CD = P.VSL_CD
               AND VPS.TURN_SKD_VOY_NO = P.SKD_VOY_NO
               AND VPS.TURN_SKD_DIR_CD = P.SKD_DIR_CD
               AND VPS.YD_CD = P.YD_CD
               AND VPS.CLPT_IND_SEQ = P.CLPT_IND_SEQ
               AND ROWNUM = 1 /*무조건 1건 나오지만 혹시 몰라서*/  
           UNION 
           SELECT '2' AS ORD
                 , 'N' AS TURN_PORT_FLG
                 , P.VSL_CD
                 , P.SKD_VOY_NO
                 , P.SKD_DIR_CD
                 , P.YD_CD
                 , P.EXE_YRMON
              FROM V_PARAM P
    )
    WHERE ROWNUM = 1      
)
--SELECT * FROM V_PORT_SKD;
, V_NORMAL_PORT AS (
    SELECT L.RLANE_CD ||'|'|| L.REV_DIR_CD ||'|'|| L.REV_YRMON  AS REV_DATA
         , L.RLANE_CD
      FROM (
            SELECT L.EXE_YRMON
                 , L.REV_YRMON
                 , L.REV_DIR_CD
                 , L.RLANE_CD
              FROM GL_ESTM_REV_VVD L
                 , V_PARAM P
             WHERE L.VSL_CD     = P.VSL_CD
               AND L.SKD_VOY_NO = P.SKD_VOY_NO
               AND L.SKD_DIR_CD = P.SKD_DIR_CD
               --AND L.EXE_YRMON  = P.EXE_YRMON
               AND L.RLANE_CD   = NVL(PSO_GET_REV_LANE_FNC(P.VSL_CD, P.SKD_VOY_NO, P.SKD_DIR_CD, SUBSTR (P.YD_CD, 1, 5)), L.RLANE_CD)
             ORDER BY L.EXE_YRMON DESC
           ) L
     WHERE 1=1
       AND ROWNUM = 1
)
--SELECT * FROM V_NORMAL_PORT;

, V_TURNING_PORT AS (
    SELECT L.RLANE_CD ||'|'|| L.REV_DIR_CD ||'|'|| L.REV_YRMON  AS REV_DATA
      FROM (
            SELECT L.EXE_YRMON
                 , L.REV_YRMON
                 , L.REV_DIR_CD
                 , L.RLANE_CD
              FROM V_NORMAL_PORT A
                 , GL_ESTM_REV_VVD L
                 , V_PARAM P
             WHERE 1=1
               AND L.VSL_CD     = P.VSL_CD
               AND L.SKD_VOY_NO = P.SKD_VOY_NO
               AND L.SKD_DIR_CD = P.SKD_DIR_CD
               AND L.RLANE_CD   = A.RLANE_CD
             ORDER BY L.EXE_YRMON DESC
           ) L
     WHERE 1=1
       AND ROWNUM = 1
)

--SELECT * FROM V_TURNING_PORT;
SELECT DECODE(NVL(PK.TURN_PORT_FLG,'N'),'Y', (SELECT TP.REV_DATA FROM V_TURNING_PORT TP) , (SELECT NP.REV_DATA FROM V_NORMAL_PORT NP))
  FROM V_PORT_SKD PK			]]></sql>
			<params>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="yd_cd" type="12" value="" out="N"/>
				<param name="clpt_ind_seq" type="12" value="" out="N"/>
				<param name="exe_yrmon" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
