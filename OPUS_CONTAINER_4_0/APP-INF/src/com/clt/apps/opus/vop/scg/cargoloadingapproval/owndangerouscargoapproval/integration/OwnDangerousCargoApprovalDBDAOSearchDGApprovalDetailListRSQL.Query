<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="OwnDangerousCargoApprovalDBDAOSearchDGApprovalDetailListRSQL">
			<desc><![CDATA[DG-Part1, DG-Part2조회]]></desc>
			<sql><![CDATA[
SELECT    SLAN_CD
         , VSL_CD
         , VSL_NM
         , SKD_VOY_NO
         , SKD_DIR_CD
         , POR_CD
         , POL_CD
         , POL_CLPT_IND_SEQ
         , POD_CD
         , POD_CLPT_IND_SEQ
         , DEL_CD
         , CRR_CD
         , CGO_OPR_CD
         , BKG_NO
         , DCGO_REF_NO
         , EML_SND_HIS_FLG
         , BKG_STS_CD
         , SPCL_CGO_AUTH_CD AS AUTH_STS_CD 
         , SPCL_CGO_AUTH_CD     
         , SPCL_CGO_AUTH_CD_CHK
         , SPCL_CGO_AUTH_RJCT_CD
         , APRO_REF_NO
         , SPCL_CNTR_SEQ
         , SPCL_CGO_SEQ
         , CNTR_TPSZ_CD
         , DG_TP
         , IMDG_UN_NO
         , IMDG_UN_NO_SEQ
         , IMDG_CLSS_CD     
         , PRP_SHP_NM
         , IMDG_SUBS_RSK_LBL_CD     
         , MRN_POLUT_FLG
         , IMDG_PCK_GRP_CD
         , IMDG_LMT_QTY_FLG
         , IMDG_EXPT_QTY_FLG
         , RSD_FLG     
         , FLSH_PNT_CDO_TEMP
         , GRS_WGT
         , NET_WGT     
         , PSA_NO     
         , RQST_DT     
         , AUTH_DT
         , VPS_ETA_DT
         , DIFF_RMK
         , IMDG_SEGR_GRP_NM     
         , DCGO_STS_CD
         , NET_WGT_SUM     
         , SPCL_CGO_APRO_RQST_SEQ
         , VSL_PRE_PST_CD
         , VSL_SEQ
         , SPCL_CGO_AUTH_SEQ
         , SPCL_CGO_CATE_CD     
         , DCGO_SEQ
         , RGN_SHP_OPR_CD
         , SPCL_CGO_AUTH_NO
         , SPCL_CGO_AUTH_RMK
         , POL_YD_CD
         , POD_YD_CD
         , SPCL_CGO_RQST_SEQ
         , CFR_FLG
         , BKG_REF_NO
         , PRNR_CGO_RQST_SEQ 
FROM(
    SELECT ORD_SEQ
         , SLAN_CD
         , VSL_CD
         , VSL_NM
         , SKD_VOY_NO
         , SKD_DIR_CD
         , POR_CD
         , POL_CD
         , POL_CLPT_IND_SEQ
         , POD_CD
         , POD_CLPT_IND_SEQ
         , DEL_CD
         , CRR_CD
         , '' CGO_OPR_CD
         , BKG_NO
         , DCGO_REF_NO
         ,(SELECT  MAX(CASE WHEN EM.EML_PROC_STS_CD IS NOT NULL AND  EM2.EML_PROC_STS_CD IS NULL THEN DECODE(EM.EML_PROC_STS_CD, '1','W','3','Y','4','F','')
                            WHEN EM.EML_PROC_STS_CD IS NULL AND  EM2.EML_PROC_STS_CD IS NOT NULL THEN DECODE(EM2.EML_PROC_STS_CD,'1','W','3','Y','4','F','')
                            WHEN EM.EML_PROC_STS_CD = EM2.EML_PROC_STS_CD                        THEN DECODE(EM.EML_PROC_STS_CD, '1','W','3','Y','4','F','')
                            WHEN EM.EML_PROC_STS_CD <> EM2.EML_PROC_STS_CD                       THEN 'W'
                            ELSE ''
                       END) 
              FROM SCG_VVD_APRO_RQST RQ ,
                   COM_EML_SND_INFO EM ,
                   COM_EML_SND_INFO EM2
             WHERE 1 = 1
               AND RQ.INDIV_EML_SND_NO = EM.EML_SND_NO(+)
               AND RQ.OALL_EML_SND_NO  = EM2.EML_SND_NO(+)
               AND RQ.BKG_NO           = A.BOOKING_NO   
               AND RQ.VSL_PRE_PST_CD   = A.VSL_PRE_PST_CD
               AND RQ.VSL_SEQ          = A.VSL_SEQ
               AND RQ.VSL_CD           = A.VSL_CD
               AND RQ.SKD_VOY_NO       = A.SKD_VOY_NO
               AND RQ.SKD_DIR_CD       = A.SKD_DIR_CD
          ) EML_SND_HIS_FLG
         , BKG_STS_CD
         , SPCL_CGO_AUTH_CD     
         , SPCL_CGO_AUTH_CD_CHK
         , SPCL_CGO_AUTH_RJCT_CD
         , APRO_REF_NO
         , DG_CNTR_SEQ  AS SPCL_CNTR_SEQ
         , CNTR_CGO_SEQ  AS SPCL_CGO_SEQ
         , CNTR_TPSZ_CD
         , DG_TP
         , IMDG_UN_NO
         , DECODE(IMDG_UN_NO_SEQ,'0','',IMDG_UN_NO_SEQ) IMDG_UN_NO_SEQ
         , IMDG_CLSS_CD     
         , PRP_SHP_NM
         , IMDG_SUBS_RSK_LBL_CD     
         , MRN_POLUT_FLG
         , IMDG_PCK_GRP_CD
         , IMDG_LMT_QTY_FLG
         , IMDG_EXPT_QTY_FLG
         , NVL(RSD_FLG, 'N') RSD_FLG     
         , FLSH_PNT_CDO_TEMP
         , GRS_WGT
         , NET_WGT     
         , PSA_NO     
         , RQST_DT     
         , AUTH_DT
         , VPS_ETA_DT
         , DIFF_RMK
         , IMDG_SEGR_GRP_NM     
         , DCGO_STS_CD
         , NET_WGT_SUM     
         , SPCL_CGO_APRO_RQST_SEQ||'' SPCL_CGO_APRO_RQST_SEQ
         , VSL_PRE_PST_CD
         , VSL_SEQ||'' VSL_SEQ
         , SPCL_CGO_AUTH_SEQ||'' SPCL_CGO_AUTH_SEQ
         , SPCL_CGO_CATE_CD     
         , DCGO_SEQ||'' DCGO_SEQ
         , RGN_SHP_OPR_CD
         , SPCL_CGO_AUTH_NO
         , SPCL_CGO_AUTH_RMK
         , POL_YD_CD
         , POD_YD_CD
         , SPCL_CGO_RQST_SEQ
         , CFR_FLG
         , BKG_NO AS BKG_REF_NO
         , PRNR_CGO_RQST_SEQ
     FROM (
    SELECT	1 AS ORD_SEQ,
            A.BKG_NO AS BOOKING_NO,
            A.BKG_STS_CD,
            A.DG_CNTR_SEQ,
            A.CNTR_CGO_SEQ, 
            ROUND(NVL(GLOBALDATE_PKG.TIME_CONV_FNC(COM_ConstantMgr_PKG.COM_getBaseLocationCode_FNC(),SYSDATE,'GMT'), SYSDATE) - A.RQST_GDT,1) AS RQST_DAY, 
            DECODE(NVL(G.SPCL_CGO_AUTH_CD,'R'),'R',DECODE(A.SPCL_RQST_FLG,'Y','S','')||'R'||A.SPCL_CGO_RQST_SEQ,G.SPCL_CGO_AUTH_CD) AS SPCL_CGO_AUTH_CD,
            SUBSTR(DECODE(NVL(G.SPCL_CGO_AUTH_CD,'R'),'R',DECODE(A.SPCL_RQST_FLG,'Y','','')||'R'||A.SPCL_CGO_RQST_SEQ,G.SPCL_CGO_AUTH_CD),1,1) AS SPCL_CGO_AUTH_CD_CHK, 
            G.SPCL_CGO_AUTH_RJCT_CD, 
            G.APRO_REF_NO,
            A.SLAN_CD, 
            A.VSL_CD, 
            A.VSL_ENG_NM AS VSL_NM,
            A.SKD_VOY_NO,
            A.SKD_DIR_CD,
            A.PRP_SHP_NM,
            A.DIFF_RMK,
            DECODE(A.DCGO_STS_CD, 'L', 'Liquid', 'G', 'GAS', 'P', 'PASTE', 'S', 'SOLID','') DCGO_STS_CD,
            A.CRR_CD,
            '' CRR_CODE,
            A.POR_CD, 
            A.POL_CD, 
            TO_CHAR(A.VPS_ETA_DT,'YYYY-MM-DD HH24:MI') AS VPS_ETA_DT,
            A.POD_CD, 
            A.DEL_CD, 
            A.CNTR_TPSZ_CD, 
            'DD' AS DG_TP, 
            A.IMDG_UN_NO, 
            ( SELECT LISTAGG (X.IMDG_SEGR_GRP_NO||'|'||X.IMDG_SEGR_GRP_NM, ',') WITHIN GROUP (ORDER BY X.IMDG_SEGR_GRP_NO||'|'||X.IMDG_SEGR_GRP_NM)
                FROM SCG_IMDG_SEGR_GRP X
                   , SCG_IMDG_SEGR_GRP_DTL Y
               WHERE X.IMDG_SEGR_GRP_NO = Y.IMDG_SEGR_GRP_NO
                 AND Y.IMDG_UN_NO = A.IMDG_UN_NO
               GROUP BY Y.IMDG_UN_NO 
            ) IMDG_SEGR_GRP_NM, 
            A.IMDG_UN_NO_SEQ, 
            A.IMDG_CLSS_CD, 
            A.IMDG_SUBS_RSK_LBL_CD1 
            ||DECODE(A.IMDG_SUBS_RSK_LBL_CD2,NULL,NULL,'/') 
            ||A.IMDG_SUBS_RSK_LBL_CD2 
            ||DECODE(A.IMDG_SUBS_RSK_LBL_CD3,NULL,NULL,'/') 
            ||A.IMDG_SUBS_RSK_LBL_CD3 
            ||DECODE(A.IMDG_SUBS_RSK_LBL_CD4,NULL,NULL, '/') 
            ||A.IMDG_SUBS_RSK_LBL_CD4 AS IMDG_SUBS_RSK_LBL_CD, 		 
            A.MRN_POLUT_FLG, 
            DECODE(A.IMDG_PCK_GRP_CD,'N',NULL, 
                                     '1','I', 
                                     '2','II', 
                                     '3','III') AS IMDG_PCK_GRP_CD, 
            A.IMDG_LMT_QTY_FLG, 
            A.IMDG_EXPT_QTY_FLG, 
            A.FLSH_PNT_CDO_TEMP, 
            A.GRS_WGT, 
            A.NET_WGT, 
            A.PSA_NO, 
            A.BKG_NO, 
            A.SPCL_CGO_APRO_RQST_SEQ, 
            A.SPCL_CGO_RQST_SEQ, 
            A.VSL_PRE_PST_CD, 
            A.VSL_SEQ, 
            A.CNTR_NO, 
            A.DCGO_REF_NO,
            A.DCGO_SEQ, 
            A.DCGO_QTY, 
            A.LST_RQST_DAT_FLG, 
            A.POL_CLPT_IND_SEQ, 
            A.POD_CLPT_IND_SEQ, 
            A.POL_YD_CD, 
            A.POD_YD_CD, 
            A.RGN_SHP_OPR_CD, 
            A.SPCL_CGO_CATE_CD, 
            G.SPCL_CGO_AUTH_NO, 
            G.AUTH_OFC_CD, 
            G.SPCL_CGO_AUTH_SEQ, 
            SCG_GET_MPA1_NET_FNC(A.VSL_CD,A.SKD_VOY_NO,A.SKD_DIR_CD,A.POL_CD, 
                                 A.POD_CD,A.IMDG_CLSS_CD) AS NET_WGT_SUM, 
            TO_CHAR(A.RQST_DT,'YYYY-MM-DD HH24:MI') AS RQST_DT, 
            TO_CHAR(A.RQST_GDT,'YYYY-MM-DD HH24:MI') AS RQST_GDT, 
            A.RQST_USR_ID, 
            TO_CHAR(G.AUTH_DT,'YYYY-MM-DD HH24:MI')AS AUTH_DT, 
            G.SPCL_CGO_AUTH_RMK, 
            A.IMDG_SEGR_GRP_NO,
            A.RSD_FLG,
            A.CFR_FLG,
            '' PRNR_CGO_RQST_SEQ
			--2016-04-14 Duplicated data 조회 방지.
			,	ROW_NUMBER() OVER (PARTITION BY NVL(G.BKG_NO, A.BKG_NO), NVL(G.SPCL_CGO_APRO_RQST_SEQ, A.SPCL_CGO_APRO_RQST_SEQ), NVL(G.DCGO_SEQ, A.DCGO_SEQ), NVL(G.VSL_PRE_PST_CD, A.VSL_PRE_PST_CD), NVL(G.VSL_SEQ, A.VSL_SEQ)
            	ORDER BY DECODE(G.APRO_REF_NO,NULL,9,1), G.UPD_DT DESC) AS CORR_AUTH_SEQ

    FROM	
        (	SELECT 	
                    A.BKG_NO, 
                    A.BKG_STS_CD, 
                    C.SLAN_CD, 
                    B.SPCL_CGO_APRO_RQST_SEQ, 
                    B.SPCL_CGO_RQST_SEQ, 
                    B.SPCL_CGO_CATE_CD, 
                    B.DCGO_QTY, 
                    B.POR_CD, 
                    B.DEL_CD,

                    C.INDIV_EML_SND_NO,
                    C.OALL_EML_SND_NO,

                    B.LST_RQST_DAT_FLG, 
                    B.RQST_DT, 
                    B.RQST_GDT, 
                    B.RQST_USR_ID, 
                    C.VSL_PRE_PST_CD, 
                    C.VSL_SEQ, 
                    C.VSL_CD, 
                    D.VSL_ENG_NM, 
                    C.SKD_VOY_NO, 
                    C.SKD_DIR_CD, 
                    C.POL_CD, 
                    C.POD_CD, 
                    C.POL_CLPT_IND_SEQ, 
                    C.POD_CLPT_IND_SEQ, 
                    C.POL_YD_CD, 
                    C.POD_YD_CD, 
                    NVL(G.ACT_CRR_CD,D.CRR_CD) CRR_CD,
                    E.RGN_SHP_OPR_CD, 
                    F.DCGO_REF_NO,
                    F.DCGO_SEQ, 
                    F.DG_CNTR_SEQ, 
                    F.CNTR_CGO_SEQ, 
                    F.CNTR_NO, 
                    F.CNTR_TPSZ_CD, 
                    F.IMDG_UN_NO, 
                    F.IMDG_UN_NO_SEQ, 
                    F.IMDG_CLSS_CD, 
                    F.IMDG_SUBS_RSK_LBL_CD1,
                    F.IMDG_SUBS_RSK_LBL_CD2,
                    F.IMDG_SUBS_RSK_LBL_CD3,
                    F.IMDG_SUBS_RSK_LBL_CD4,
                    F.MRN_POLUT_FLG, 
                    F.IMDG_PCK_GRP_CD, 
                    F.IMDG_LMT_QTY_FLG, 
                    F.IMDG_EXPT_QTY_FLG, 
                    F.FLSH_PNT_CDO_TEMP, 
                    F.GRS_WGT, 
                    F.NET_WGT, 
                    F.PSA_NO, 
                    F.SPCL_RQST_FLG, 
                    V.VPS_ETA_DT,
                    F.PRP_SHP_NM,
                    F.DIFF_RMK,
                    F.DCGO_STS_CD,
                    F.IMDG_SEGR_GRP_NO,
                    F.RSD_FLG,
                    F.CFR_FLG
            FROM	SCG_APRO_RQST 			B
                ,	SCG_VVD_APRO_RQST 		C
                ,	SCG_RGN_SHP_OPR_PORT 	E
                ,	MDM_VSL_CNTR 			D
                ,	BKG_DG_CGO F 
                ,	BKG_BOOKING 			A
                ,	VSK_VSL_PORT_SKD 		V
                ,	VSK_VSL_SKD 			G
            WHERE	B.SPCL_CGO_CATE_CD 			= 'DG'
            AND		B.LST_RQST_DAT_FLG 			= 'Y'
            AND 	B.BKG_NO 					= C.BKG_NO
            AND 	B.SPCL_CGO_APRO_RQST_SEQ 	= C.SPCL_CGO_APRO_RQST_SEQ
            AND 	C.POL_CD 					= E.LOC_CD
            AND 	C.VSL_CD 					= D.VSL_CD
            AND 	D.DELT_FLG 					= 'N'
            AND 	E.DELT_FLG 					= 'N'
            AND 	B.BKG_NO 					= F.BKG_NO
            AND 	F.SPCL_CGO_APRO_CD 			IS NOT NULL
            AND 	V.VSL_CD 					= C.VSL_CD
            AND 	V.SKD_VOY_NO 				= C.SKD_VOY_NO
            AND 	V.SKD_DIR_CD 				= C.SKD_DIR_CD
            AND     C.VSL_CD                    = G.VSL_CD
            AND     C.SKD_VOY_NO                = G.SKD_VOY_NO
            AND     C.SKD_DIR_CD                = G.SKD_DIR_CD
            AND 	V.VPS_PORT_CD 				= C.POL_CD
            AND 	V.CLPT_IND_SEQ 				= C.POL_CLPT_IND_SEQ
            AND 	B.BKG_NO 					= A.BKG_NO


        #if (${prp_shp_nm} != '') 
            AND 	UPPER(F.PRP_SHP_NM) 				LIKE '%'||UPPER(@[prp_shp_nm])||'%'
        #end

            AND 	A.BKG_STS_CD 				!= 'X'
            AND 	F.SPCL_CGO_APRO_CD 			NOT IN ('C','D')
        
        #if (${rgn_shp_opr_cd} != '') 
            AND		E.RGN_SHP_OPR_CD 	= @[rgn_shp_opr_cd]
        #end

        #if ($slan_cd.size() > 0) 
            AND 	C.SLAN_CD IN ( 
                    #foreach($key IN ${slan_cd}) 
                        #if($velocityCount < $slan_cd.size()) 
                            '$key', 
                        #else 
                            '$key' 
                        #end 
                    #end 
                    )
        #end

        #if (${vsl_cd} != '') 
            AND		C.VSL_CD 			IN ( @[vsl_cd] )
        #end

        #if (${imdg_un_no} != '') 
            AND 	F.IMDG_UN_NO 		= @[imdg_un_no]
        #end

        #if (${imdg_un_no_seq} != '') 
            AND 	F.IMDG_UN_NO_SEQ 	= @[imdg_un_no_seq]
        #end

        #if (${imdg_clss_cd} != '') 
            AND 	F.IMDG_CLSS_CD 		= @[imdg_clss_cd]
        #end

        #if (${skd_voy_no} != '') 
            AND		C.SKD_VOY_NO 		IN ( @[skd_voy_no] )
        #end

        #if (${skd_dir_cd} != '') 
            AND 	C.SKD_DIR_CD 		IN ( @[skd_dir_cd] )
        #end
        
        #if (${pol_cd} != '') 
            AND 	C.POL_CD 			= @[pol_cd]
        #end

        #if (${pod_cd} != '') 
            AND 	C.POD_CD 			= @[pod_cd]
        #end

        #if (${val_opr_tp_cd} == 'H')
            AND 	D.CRR_CD 			= COM_ConstantMgr_PKG.COM_getCompanyCode_FNC()
        #end
        
        #if (${val_opr_tp_cd} == 'O')
            AND		D.CRR_CD 			!= COM_ConstantMgr_PKG.COM_getCompanyCode_FNC()
        #end  	
        
        #if (${booking_no} != '') 
            AND 	A.BKG_NO 			= @[booking_no]
        #end

        #if (${dcgo_ref_no} != '') 
            AND 	F.DCGO_REF_NO 		= @[dcgo_ref_no]
        #end

        #if (${shpr_nm} != '') 
            AND 	A.BKG_NO IN (
                        SELECT 	SH.BKG_NO
                        FROM 	BKG_CUSTOMER SH
                        WHERE 	SH.BKG_CUST_TP_CD = 'S'
                        AND 	SH.CUST_NM LIKE '%'||@[shpr_nm]||'%'
                    )
        #end

        #if (${from_eta_dt} != '' && ${to_eta_dt} != '') 
            AND V.VPS_ETA_DT BETWEEN TO_DATE(@[from_eta_dt],'YYYYMMDD') AND TO_DATE(@[to_eta_dt],'YYYYMMDD')+0.99999
        #elseif (${from_eta_dt} != '') 
            AND DECODE(C.VSL_PRE_PST_CD,'U',V.VPS_ETA_DT,B.RQST_DT)	<= NVL(GLOBALDATE_PKG.TIME_CONV_FNC(COM_ConstantMgr_PKG.COM_getBaseLocationCode_FNC(),SYSDATE,BKG_COM_USER_LOC_FNC(@[usr_id])), SYSDATE) + TO_NUMBER(@[from_eta_dt])
        #end

                                                       
            ) A, 
            SCG_AUTHORIZATION G
    WHERE	A.BKG_NO 					= G.BKG_NO (+) 
    AND 	A.SPCL_CGO_APRO_RQST_SEQ 	= G.SPCL_CGO_APRO_RQST_SEQ (+) 
    AND 	A.VSL_PRE_PST_CD 			= G.VSL_PRE_PST_CD (+) 
    AND 	A.VSL_SEQ 					= G.VSL_SEQ (+) 
    AND 	A.DCGO_SEQ 					= G.DCGO_SEQ (+) 
    #if (${apro_ref_no} != '') 
    AND     G.APRO_REF_NO 				= @[apro_ref_no]
    #end
    )A
    WHERE 	1 = 1
	AND  	A.CORR_AUTH_SEQ 			= 1

    #if (${auth_flg} == 'Y') 
        AND SPCL_CGO_AUTH_CD_CHK    	= 'Y'
    #end
    #if (${auth_flg} == 'U') 
        AND SPCL_CGO_AUTH_CD_CHK 	    = 'R'
    #end
    #if (${auth_flg} == 'N') 
        AND SPCL_CGO_AUTH_CD_CHK		= 'N'
    #end
    #if (${auth_flg} == 'YN')
        AND SPCL_CGO_AUTH_CD_CHK		IN ('Y','N','R','P')
    #end
    #if (${scg_all_flg} != 'Y')
        AND ORD_SEQ IS NULL
    #end
UNION ALL

    SELECT		2 AS ORD_SEQ
            ,   XX.SLAN_CD
            ,	XX.VSL_CD
            ,	XX.VSL_NM
            ,	XX.SKD_VOY_NO
            ,	XX.SKD_DIR_CD
            ,   '' POR_CD
            ,	XX.POL_CD
            ,	XX.POL_CLPT_IND_SEQ
            ,	XX.POD_CD
            ,	XX.POD_CLPT_IND_SEQ
            ,   '' DEL_CD 
            ,	XX.CRR_CD
            ,	XX.CGO_OPR_CD
            ,	XX.BOOKING_NO 
            ,  	XX.DCGO_REF_NO
            ,  	XX.EML_SND_HIS_FLG        
            ,   '' BKG_STS_CD
            ,	XX.AUTH_STS_CD AS SPCL_CGO_AUTH_CD
            ,   '' SPCL_CGO_AUTH_CD_CHK
            ,	XX.SPCL_CGO_AUTH_RJCT_CD
            ,	XX.APRO_REF_NO
            ,	XX.SPCL_CNTR_SEQ
            ,	XX.SPCL_CGO_SEQ        
            ,	XX.CNTR_TPSZ_CD
            ,   '' DG_TP
            ,	XX.IMDG_UN_NO
            ,	XX.IMDG_UN_NO_SEQ
            ,	XX.IMDG_CLSS_CD        
            ,	XX.PRP_SHP_NM
            ,	XX.IMDG_SUBS_RSK_LBL_CD
            ,	XX.MRN_POLUT_FLG
            ,	XX.IMDG_PCK_GRP_CD
            ,	XX.IMDG_LMT_QTY_FLG
            ,	XX.IMDG_EXPT_QTY_FLG
            ,	XX.RSD_FLG
            ,	XX.FLSH_PNT_CDO_TEMP
            ,	XX.GRS_WGT
            ,	XX.NET_WGT
            ,	XX.PSA_NO        
            ,	XX.CGO_RQST_DT AS RQST_DT
            ,	XX.AUTH_DT
            ,   '' AS VPS_ETA_DT 
            ,	XX.DIFF_RMK
            ,	XX.IMDG_SEGR_GRP_NM
            ,	XX.DCGO_STS_CD
            ,  	XX.NET_WGT_SUM        
            ,   '' SPCL_CGO_APRO_RQST_SEQ
            ,   '' VSL_PRE_PST_CD
            ,   '' VSL_SEQ
            ,   '' SPCL_CGO_AUTH_SEQ
            ,   XX.SPCL_CGO_CATE_CD     
            ,   '' DCGO_SEQ
            ,	XX.RGN_SHP_OPR_CD        
            ,   '' SPCL_CGO_AUTH_NO
            ,	XX.SPCL_CGO_AUTH_RMK       
            ,   '' POL_YD_CD
            ,   '' POD_YD_CD
            ,   XX.SPCL_CGO_RQST_SEQ
            ,   '' CFR_FLG
            ,	XX.BKG_REF_NO
            ,   XX.PRNR_CGO_RQST_SEQ
    FROM   (
         --=============================================================================
    SELECT 		
        RQS.RGN_SHP_OPR_CD
    ,   RQS.SRC_TP_CD
    ,   RQS.VSL_CD
    ,   MDM.VSL_ENG_NM VSL_NM
    ,   RQS.SKD_VOY_NO
    ,	RQS.SKD_DIR_CD
    ,	RQS.SLAN_CD
    ,   RQS.CRR_CD
    ,	CGO.CGO_OPR_CD
    ,	RQS.POL_CD
    ,   NVL(RQS.POL_CLPT_IND_SEQ, '1')  POL_CLPT_IND_SEQ
    ,	TO_CHAR(RQS.ETA_DT, 'YYYY-MM-DD HH24:MI') ETA_DT
    ,	RQS.POD_CD
    ,   NVL(RQS.POD_CLPT_IND_SEQ, '1') POD_CLPT_IND_SEQ
    ,	RQS.BKG_REF_NO
    ,	RQS.SPCL_CGO_RQST_SEQ
    ,	CGO.SPCL_CNTR_SEQ
    ,	CGO.SPCL_CGO_SEQ
    #if (${scg_flg} == 'AWK' || ${scg_flg} == 'SCG_AWK' || ${scg_flg} == 'SCG_45') 
    ,   CGO.AUTH_STS_CD
    #else
    ,   DECODE(CGO.AUTH_STS_CD,'R',DECODE(CGO.SPCL_RQST_FLG,'Y','S','')||'R'||CGO.SPCL_CGO_RQST_SEQ, CGO.AUTH_STS_CD) AS AUTH_STS_CD
    #end
    ,	DECODE(CGO.APRO_REF_NO,'0','',CGO.APRO_REF_NO) APRO_REF_NO
    ,   CGO.SPCL_CGO_AUTH_RJCT_CD                      AS SPCL_CGO_AUTH_RJCT_CD
    ,   CGO.SPCL_CGO_AUTH_RMK                          AS SPCL_CGO_AUTH_RMK
    ,	CGO.CNTR_TPSZ_CD
    ,	DECODE(CGO.IMDG_UN_NO,'0','',CGO.IMDG_UN_NO) IMDG_UN_NO
    ,   ( SELECT LISTAGG (X.IMDG_SEGR_GRP_NO||'|'||X.IMDG_SEGR_GRP_NM, ',') WITHIN GROUP (ORDER BY X.IMDG_SEGR_GRP_NO||'|'||X.IMDG_SEGR_GRP_NM)
            FROM SCG_IMDG_SEGR_GRP X
               , SCG_IMDG_SEGR_GRP_DTL Y
           WHERE X.IMDG_SEGR_GRP_NO = Y.IMDG_SEGR_GRP_NO
             AND Y.IMDG_UN_NO       = CGO.IMDG_UN_NO
           GROUP BY Y.IMDG_UN_NO 
        ) IMDG_SEGR_GRP_NM 
    ,   CGO.IMDG_SEGR_GRP_NO AS IMDG_SEGR_GRP_NO 
    ,	DECODE(CGO.IMDG_UN_NO_SEQ,'0','',CGO.IMDG_UN_NO_SEQ) IMDG_UN_NO_SEQ
    ,	CGO.IMDG_CLSS_CD
    ,	(DECODE(CGO.N1ST_IMDG_SUBS_RSK_LBL_CD,'0','',CGO.N1ST_IMDG_SUBS_RSK_LBL_CD)||DECODE(NVL(CGO.N2ND_IMDG_SUBS_RSK_LBL_CD,''),'','','0','','/')
       ||DECODE(CGO.N2ND_IMDG_SUBS_RSK_LBL_CD,'0','',CGO.N2ND_IMDG_SUBS_RSK_LBL_CD)||DECODE(NVL(CGO.N3RD_IMDG_SUBS_RSK_LBL_CD,''),'','','0','','/')
       ||DECODE(CGO.N3RD_IMDG_SUBS_RSK_LBL_CD,'0','',CGO.N3RD_IMDG_SUBS_RSK_LBL_CD)||DECODE(NVL(CGO.N4TH_IMDG_SUBS_RSK_LBL_CD,''),'','','0','','/')
       ||DECODE(CGO.N4TH_IMDG_SUBS_RSK_LBL_CD,'0','',CGO.N4TH_IMDG_SUBS_RSK_LBL_CD)) IMDG_SUBS_RSK_LBL_CD
    ,	CGO.MRN_POLUT_FLG
    ,   DECODE(CGO.IMDG_PCK_GRP_CD,'1','I','2','II','3','III','') IMDG_PCK_GRP_CD
    ,	CGO.IMDG_LMT_QTY_FLG
    ,	CGO.IMDG_EXPT_QTY_FLG
    ,   NVL(CGO.RSD_FLG, 'N') AS RSD_FLG
    ,   CGO.FLSH_PNT_CDO_TEMP FLSH_PNT_CDO_TEMP

    ,	CGO.GRS_WGT
    ,	CGO.NET_WGT
    ,   DECODE(CGO.PSA_NO,'0','',CGO.PSA_NO) PSA_NO
    ,   TO_CHAR(NVL(GLOBALDATE_PKG.TIME_CONV_FNC( GLOBALDATE_PKG.GET_LOCCD_FNC(RQS.RQST_OFC_CD), CGO_RQST_DT,'GMT'), CGO_RQST_DT),'YYYY-MM-DD HH24:MI') CGO_RQST_DT
    ,	DECODE(CGO.AUTH_STS_CD,'R','',TO_CHAR(CGO.AUTH_DT,'YYYY-MM-DD')) AUTH_DT
    ,	RQS.UPD_DT
    ,   CGO.AUTH_STS_CD AUTH_FLG
    ,   RQS.BKG_REF_NO BOOKING_NO
    ,   CGO.STS_CT
    ,   CGO.PRP_SHP_NM        PRP_SHP_NM
    ,   CGO.HZD_DESC          HZD_DESC
    ,   CGO.DCGO_STS_CD       DCGO_STS_CD
    ,   CGO.DIFF_RMK   		  DIFF_RMK
    ,	CGO.SPCL_CGO_CATE_CD   AS SPCL_CGO_CATE_CD
    ,   SCG_GET_MPA1_NET_FNC(RQS.VSL_CD, RQS.SKD_VOY_NO, RQS.SKD_DIR_CD, RQS.POL_CD, RQS.POD_CD, CGO.IMDG_CLSS_CD) AS NET_WGT_SUM
    ,   CGO.DCGO_REF_NO   AS DCGO_REF_NO
    ,   CASE WHEN (SELECT COUNT(1) 
                   FROM   SCG_PRNR_APRO_RQST  RQ
                        , COM_EML_SND_INFO    EM
                   WHERE  1 = 1
                   AND    RQ.EML_SND_NO       = EM.EML_SND_NO
                   AND    EM.EML_PROC_STS_CD  = '1'           -- ::'1'-'W','3'-'Y','4'-'F':: --
                   AND    RQ.CRR_CD           = RQS.CRR_CD
                   AND    RQ.BKG_REF_NO       = RQS.BKG_REF_NO
                   AND    RQ.VSL_CD           = RQS.VSL_CD
                   AND    RQ.SKD_VOY_NO       = RQS.SKD_VOY_NO
                   AND    RQ.SKD_DIR_CD       = RQS.SKD_DIR_CD
                   AND	  RQ.POL_CD			  = RQS.POL_CD
                   AND	  RQ.POD_CD			  = RQS.POD_CD
                   ) > 0  THEN 'W'
             WHEN (SELECT COUNT(1) 
                   FROM   SCG_PRNR_APRO_RQST  RQ
                        , COM_EML_SND_INFO    EM
                   WHERE  1 = 1
                   AND    RQ.EML_SND_NO       = EM.EML_SND_NO
                   AND    EM.EML_PROC_STS_CD  = '3'           -- ::'1'-'W','3'-'Y','4'-'F':: --
                   AND    RQ.CRR_CD           = RQS.CRR_CD
                   AND    RQ.BKG_REF_NO       = RQS.BKG_REF_NO
                   AND    RQ.VSL_CD           = RQS.VSL_CD
                   AND    RQ.SKD_VOY_NO       = RQS.SKD_VOY_NO
                   AND    RQ.SKD_DIR_CD       = RQS.SKD_DIR_CD
                   AND	  RQ.POL_CD			  = RQS.POL_CD
                   AND	  RQ.POD_CD			  = RQS.POD_CD
                   ) > 0  THEN 'Y'
             WHEN (SELECT COUNT(1) 
                   FROM   SCG_PRNR_APRO_RQST  RQ
                        , COM_EML_SND_INFO    EM
                   WHERE  1 = 1
                   AND    RQ.EML_SND_NO       = EM.EML_SND_NO
                   AND    EM.EML_PROC_STS_CD  = '4'           -- ::'1'-'W','3'-'Y','4'-'F':: --
                   AND    RQ.CRR_CD           = RQS.CRR_CD
                   AND    RQ.BKG_REF_NO       = RQS.BKG_REF_NO
                   AND    RQ.VSL_CD           = RQS.VSL_CD
                   AND    RQ.SKD_VOY_NO       = RQS.SKD_VOY_NO
                   AND    RQ.SKD_DIR_CD       = RQS.SKD_DIR_CD
                   AND	  RQ.POL_CD			  = RQS.POL_CD
                   AND	  RQ.POD_CD			  = RQS.POD_CD
                   ) > 0  THEN 'F'
              ELSE ''
         END  EML_SND_HIS_FLG
    ,	CGO.PRNR_CGO_RQST_SEQ||'' AS PRNR_CGO_RQST_SEQ
    FROM SCG_PRNR_APRO_RQST      RQS
       , (
         SELECT T.*
              , AVG(DECODE(T.AUTH_STS_CD,'Y',1,'N',2,-999)) OVER (PARTITION BY T.CRR_CD, T.BKG_REF_NO, T.SPCL_CGO_RQST_SEQ) STS_CT
           FROM SCG_PRNR_APRO_RQST_CGO T
         ) CGO
       , SCG_IMDG_UN_NO          SUN
       , MDM_VSL_CNTR            MDM
    WHERE 1=1
    #if (${rgn_shp_opr_cd} != '')
      AND RQS.RGN_SHP_OPR_CD    = @[rgn_shp_opr_cd]
    #end
    #if (${vsl_cd} != '')
      AND RQS.VSL_CD            = @[vsl_cd]
    #end
    #if (${skd_voy_no} != '')
      AND RQS.SKD_VOY_NO        = @[skd_voy_no]
    #end
    #if (${skd_dir_cd} != '')
      AND RQS.SKD_DIR_CD        = @[skd_dir_cd]
    #end
    #if (${scg_flg} == 'DG1' || ${scg_flg} == 'SCG_DG') 
      AND RQS.DG_FLG            = 'Y'
      AND RQS.AWK_FLG           = 'N'
    #elseif (${scg_flg} == 'AWK' || ${scg_flg} == 'SCG_AWK' || ${scg_flg} == 'SCG_45') 
      AND RQS.DG_FLG            = 'N'
      AND RQS.AWK_FLG           = 'Y'
    #if (${scg_flg} == 'SCG_AWK') 
      --::2015-04-07::--AND CGO.CNTR_TPSZ_CD <> 'D7'
    #end
    #if (${scg_flg} == 'SCG_45') 
      --::2015-04-07::--AND CGO.CNTR_TPSZ_CD = 'D7'
    #end
    #end
      AND RQS.CRR_CD            = CGO.CRR_CD
      AND RQS.BKG_REF_NO        = CGO.BKG_REF_NO
      AND RQS.PRNR_CGO_RQST_SEQ = CGO.PRNR_CGO_RQST_SEQ
      AND RQS.SPCL_CGO_RQST_SEQ = CGO.SPCL_CGO_RQST_SEQ
      AND RQS.VSL_CD            = MDM.VSL_CD
      AND MDM.DELT_FLG 		    = 'N' 
      AND CGO.IMDG_UN_NO        = SUN.IMDG_UN_NO(+)
      AND CGO.IMDG_UN_NO_SEQ    = SUN.IMDG_UN_NO_SEQ(+)

      AND RQS.LST_RQST_DAT_FLG 	= 'Y'
    -- VOP_SCG_0023(Approved)
    #if (${auth_flg} == 'Y') 
      AND (CGO.STS_CT = 1 OR CGO.AUTH_STS_CD = 'Y')
    -- VOP_SCG_0023(Reject)
    #elseif (${auth_flg} == 'N')
      AND CGO.AUTH_STS_CD = 'N'
    -- VOP_SCG_0023(Unapproved)
    #elseif (${auth_flg} == 'U')
      AND CGO.AUTH_STS_CD IN ('R','P')
    -- VOP_SCG_0023(ALL)
    #elseif (${auth_flg} == 'YN')
      AND (CGO.STS_CT = 1 OR (CGO.AUTH_STS_CD IN('Y','N','R','P')))
    -- VOP_SCG_0022
    #elseif (${auth_flg} == 'S')
      #if (${func_flg} == 'MNL')
        AND RQS.SRC_TP_CD  <> 'EDI' --20150723
        AND (CGO.AUTH_STS_CD IN('Y','N','R','P','C') OR CGO.AUTH_STS_CD IS NULL)
      #else
        AND RQS.SRC_TP_CD = 'EDI' 
        --:2015-12-23:--AND RQS.EDI_UNMAP_KND_CD IS NOT NULL
        AND CGO.AUTH_STS_CD IS NULL
      #end
    -- VOP_SCG_5001(Pending)
    #elseif (${auth_flg} == 'P')
      AND CGO.AUTH_STS_CD = 'P'
    -- VOP_SCG_5001(Request)
    #elseif (${auth_flg} == 'R')
      AND CGO.AUTH_STS_CD = 'R'
    -- VOP_SCG_5001(ALL)
    #else
    AND (CGO.AUTH_STS_CD IN('R','P') OR ((CGO.AUTH_STS_CD = 'Y' OR CGO.AUTH_STS_CD = 'N') AND CGO.STS_CT < 1))
    #end
    #if ($slan_cd.size() > 0) 
      AND RQS.SLAN_CD IN ( 
        #foreach($key IN ${slan_cd}) 
          #if($velocityCount < $slan_cd.size()) 
            '$key', 
          #else 
            '$key' 
          #end 
        #end 
      )
    #end
    #if (${pol_cd} != '')
      AND RQS.POL_CD = @[pol_cd]
    #end
    #if (${pod_cd} != '')
      AND RQS.POD_CD = @[pod_cd]
    #end
    #if (${cgo_opr_cd} != '')
      AND CGO.CGO_OPR_CD = @[cgo_opr_cd]
    #end
    #if (${booking_no} != '') 
      AND RQS.BKG_REF_NO = @[booking_no]
    #end
    #if (${apro_ref_no} != '') 
      AND CGO.APRO_REF_NO = @[apro_ref_no]
    #end
    #if (${imdg_un_no} != '') 
      AND CGO.IMDG_UN_NO = @[imdg_un_no]
    #end
    #if (${imdg_un_no_seq} != '') 
      AND CGO.IMDG_UN_NO_SEQ = @[imdg_un_no_seq]
    #end
    #if (${imdg_clss_cd} != '') 
      AND CGO.IMDG_CLSS_CD = @[imdg_clss_cd]
    #end
    #if (${prp_shp_nm} != '') 
      AND CGO.PRP_SHP_NM LIKE '%'||@[prp_shp_nm]||'%'
    #end
    #if (${apro_ref_no} != '') 
      AND CGO.APRO_REF_NO = @[apro_ref_no]
    #end
    #if (${from_eta_dt} != '' && ${to_eta_dt} != '') 
        AND RQS.ETA_DT BETWEEN TO_DATE(@[from_eta_dt],'YYYYMMDD') AND TO_DATE(@[to_eta_dt],'YYYYMMDD')+0.99999
    #elseif (${from_eta_dt} != '') 
        AND RQS.ETA_DT	<= NVL(GLOBALDATE_PKG.TIME_CONV_FNC(COM_ConstantMgr_PKG.COM_getBaseLocationCode_FNC(),SYSDATE,BKG_COM_USER_LOC_FNC(@[upd_usr_id])), SYSDATE) + TO_NUMBER(@[from_eta_dt])
    #end
    #if (${src_tp_cd} != '')
        AND RQS.SRC_TP_CD = @[src_tp_cd]
    #end
    #if (${dcgo_ref_no} != '')
        AND CGO.DCGO_REF_NO = @[dcgo_ref_no]
    #end


    #if (${func_flg} == 'MNL')

        #if (${from_req_dt} != '') 
        AND TO_DATE(DECODE(CGO.AUTH_STS_CD, NULL,
            TO_CHAR(NVL(GLOBALDATE_PKG.TIME_CONV_FNC(GLOBALDATE_PKG.GET_LOCCD_FNC(RQS.RQST_OFC_CD), CGO.UPD_DT,'GMT'), CGO.UPD_DT),'YYYYMMDD'),
            TO_CHAR(NVL(GLOBALDATE_PKG.TIME_CONV_FNC(GLOBALDATE_PKG.GET_LOCCD_FNC(RQS.RQST_OFC_CD), CGO.CGO_RQST_DT,'GMT'), CGO.CGO_RQST_DT),'YYYYMMDD')
            ),'YYYYMMDD')	>= TO_DATE(@[from_req_dt],'YYYYMMDD')
        #end
        #if (${to_req_dt} != '') 
        AND TO_DATE(DECODE(CGO.AUTH_STS_CD, NULL,
            TO_CHAR(NVL(GLOBALDATE_PKG.TIME_CONV_FNC(GLOBALDATE_PKG.GET_LOCCD_FNC(RQS.RQST_OFC_CD), CGO.UPD_DT,'GMT'), CGO.UPD_DT),'YYYYMMDD'),
            TO_CHAR(NVL(GLOBALDATE_PKG.TIME_CONV_FNC(GLOBALDATE_PKG.GET_LOCCD_FNC(RQS.RQST_OFC_CD), CGO.CGO_RQST_DT,'GMT'), CGO.CGO_RQST_DT),'YYYYMMDD')
            ),'YYYYMMDD')	<= TO_DATE(@[to_req_dt],'YYYYMMDD')+0.99999
        #end

    #else

        #if (${from_req_dt} != '') 
        AND	RQS.CRE_DT	>= TO_DATE(@[from_req_dt]	,'YYYYMMDD')
        #end
        #if (${to_req_dt} != '') 
        AND	RQS.CRE_DT	<= TO_DATE(@[to_req_dt]		,'YYYYMMDD')+0.99999
        #end

    #end

    #if (${func_flg} == 'EDI')
    AND RQS.EDI_UNMAP_KND_CD IS NOT NULL
    #end

         --=============================================================================
        ) XX
) 
ORDER BY ORD_SEQ,
         VPS_ETA_DT,
         CGO_OPR_CD,
         SLAN_CD,
         VSL_CD ,
         SKD_VOY_NO,
         SKD_DIR_CD,
         CRR_CD,
         POL_CD,
         POD_CD,
         BKG_NO,
         SPCL_CNTR_SEQ,
         SPCL_CGO_SEQ			]]></sql>
			<params>
				<param name="prp_shp_nm" type="12" value="" out="N"/>
				<param name="rgn_shp_opr_cd" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="imdg_un_no" type="12" value="" out="N"/>
				<param name="imdg_un_no_seq" type="12" value="" out="N"/>
				<param name="imdg_clss_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
				<param name="booking_no" type="12" value="" out="N"/>
				<param name="dcgo_ref_no" type="12" value="" out="N"/>
				<param name="shpr_nm" type="12" value="" out="N"/>
				<param name="from_eta_dt" type="12" value="" out="N"/>
				<param name="to_eta_dt" type="12" value="" out="N"/>
				<param name="usr_id" type="12" value="" out="N"/>
				<param name="apro_ref_no" type="12" value="" out="N"/>
				<param name="cgo_opr_cd" type="12" value="" out="N"/>
				<param name="upd_usr_id" type="12" value="" out="N"/>
				<param name="src_tp_cd" type="12" value="" out="N"/>
				<param name="from_req_dt" type="12" value="" out="N"/>
				<param name="to_req_dt" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
