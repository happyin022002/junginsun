<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="GeneralInvoiceAuditDBDAOgetRevLaneDirRSQL">
			<desc><![CDATA[getRevLaneDir
[2016.03.18]Rev. Lane 수정처리.]]></desc>
			<sql><![CDATA[
WITH V_PARAM AS (    
    SELECT @[vsl_cd]        AS VSL_CD
         , @[skd_voy_no]    AS SKD_VOY_NO
         , @[skd_dir_cd]    AS SKD_DIR_CD
         , @[yd_cd]         AS YD_CD
         , NVL(@[clpt_ind_seq], (SELECT MIN(PS.CLPT_IND_SEQ) 
                       FROM VSK_VSL_PORT_SKD PS 
                      WHERE 1=1
                        AND PS.VSL_CD       = @[vsl_cd]
                        AND PS.SKD_VOY_NO   = @[skd_voy_no]
                        AND PS.SKD_DIR_CD   = @[skd_dir_cd] 
                        AND PS.YD_CD        = @[yd_cd]
                        AND NVL(PS.SKD_CNG_STS_CD, ' ') != 'S'
                        AND NVL(PS.VT_ADD_CALL_FLG, 'N') = 'N' /*2015.07.21 Add*/
                      )) AS CLPT_IND_SEQ
      FROM DUAL                     
)
, V_PORT_SKD AS (
    /*디폴트로 1건이 나타나도록 처리 함.*/
    SELECT A.*
         , (SELECT MAX(L.RLANE_CD) ||'|'|| MAX(L.RLANE_DIR_CD) ||'|'|| MAX(L.REV_YRMON) AS REV_DATA
              FROM AR_MST_REV_VVD L
                 , V_PARAM P
             WHERE L.VSL_CD     = P.VSL_CD
               AND L.SKD_VOY_NO = P.SKD_VOY_NO
               AND L.SKD_DIR_CD = P.SKD_DIR_CD
               AND L.DELT_FLG   = 'N' /*2015.09.11 Add*/
               AND ROWNUM       = 1 /*Default AR REV VVD 1건만 잡는다.*/) AS DFLT_REV_DATA
      FROM (               
            SELECT *
              FROM (
                    SELECT '1' AS ORD
                         , VPS.TURN_PORT_FLG
                         , VPS.VSL_CD
                         , VPS.SKD_VOY_NO
                         , VPS.SKD_DIR_CD
                         , VPS.YD_CD
                      FROM VSK_VSL_PORT_SKD VPS
                         , V_PARAM P
                     WHERE 1=1
                       AND NVL(VPS.VT_ADD_CALL_FLG, 'N') = 'N' /*2015.07.21 Add*/
                       AND NVL(VPS.SKD_CNG_STS_CD, ' ') != 'S'
                       AND VPS.VSL_CD = P.VSL_CD
                       AND VPS.TURN_SKD_VOY_NO = P.SKD_VOY_NO
                       AND VPS.TURN_SKD_DIR_CD = P.SKD_DIR_CD
                       AND VPS.YD_CD = P.YD_CD
                       AND VPS.TURN_CLPT_IND_SEQ = P.CLPT_IND_SEQ
                       AND ROWNUM = 1 /*무조건 1건 나오지만 혹시 몰라서*/  
                   UNION 
                   SELECT '2' AS ORD
                         , 'N' AS TURN_PORT_FLG
                         , P.VSL_CD
                         , P.SKD_VOY_NO
                         , P.SKD_DIR_CD
                         , P.YD_CD
                      FROM V_PARAM P
                  )
            WHERE ROWNUM = 1  
          ) A
)
--SELECT * FROM V_PORT_SKD;
, V_NORMAL_PORT AS (
    SELECT COUNT(L.RLANE_DIR_CD) AS CNT
         , MAX(L.RLANE_CD) ||'|'|| MAX(L.RLANE_DIR_CD) ||'|'|| MAX(L.REV_YRMON) AS REV_DATA
      FROM AR_MST_REV_VVD L
         , V_PARAM P
     WHERE L.VSL_CD     = P.VSL_CD
       AND L.SKD_VOY_NO = P.SKD_VOY_NO
       AND L.SKD_DIR_CD = P.SKD_DIR_CD
       AND L.DELT_FLG   = 'N' /*2015.09.11 Add*/
       AND L.RLANE_CD   = NVL(PSO_GET_REV_LANE_FNC(P.VSL_CD, P.SKD_VOY_NO, P.SKD_DIR_CD, SUBSTR (P.YD_CD, 1, 5)), L.RLANE_CD)
)
--SELECT * FROM V_NORMAL_PORT;
, V_TURNING_PORT AS (
    SELECT COUNT(L.RLANE_DIR_CD) AS CNT
         , MAX(A.RLANE_CD) ||'|'|| MAX(L.RLANE_DIR_CD) ||'|'|| MAX(L.REV_YRMON) AS REV_DATA
      FROM (SELECT MAX(L.RLANE_CD) RLANE_CD
              FROM AR_MST_REV_VVD L
                 , V_PORT_SKD VPK
             WHERE L.VSL_CD     = VPK.VSL_CD
               AND L.SKD_VOY_NO = VPK.SKD_VOY_NO
               AND L.SKD_DIR_CD = VPK.SKD_DIR_CD
               AND L.DELT_FLG   = 'N' /*2015.09.11 Add*/
               AND L.RLANE_CD   = NVL(PSO_GET_REV_LANE_FNC(VPK.VSL_CD, VPK.SKD_VOY_NO, VPK.SKD_DIR_CD, SUBSTR (VPK.YD_CD, 1, 5)), L.RLANE_CD) ) A
         , AR_MST_REV_VVD L
         , V_PARAM P
     WHERE 1=1
       AND L.VSL_CD     = P.VSL_CD
       AND L.SKD_VOY_NO = P.SKD_VOY_NO
       AND L.SKD_DIR_CD = P.SKD_DIR_CD
       AND L.RLANE_CD   = A.RLANE_CD
       AND L.DELT_FLG   = 'N' /*2015.09.11 Add 2016.03.22*/
)

--SELECT * FROM V_TURNING_PORT;
SELECT DECODE(NVL(PK.TURN_PORT_FLG,'N'),'Y', (SELECT DECODE(TP.CNT, 0, PK.DFLT_REV_DATA, TP.REV_DATA) FROM V_TURNING_PORT TP)
                                           , (SELECT DECODE(NP.CNT, 0, PK.DFLT_REV_DATA, NP.REV_DATA) FROM V_NORMAL_PORT NP)
       ) AS REV_DATA
  FROM V_PORT_SKD PK			]]></sql>
			<params>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="yd_cd" type="12" value="" out="N"/>
				<param name="clpt_ind_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
