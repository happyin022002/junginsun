<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ReceiveEdiFromPartnerLinesDBDAOIdentifyProperUNInformationfromIMDGMasterRSQL">
			<desc><![CDATA[IMDG Master 데이터에서 UN NO SEQ 및 EMS 데이터 찾기]]></desc>
			<sql><![CDATA[
SELECT    MAX(XX.MAPPING_RNK)                       					AS MAPPING_RNK
	   ,  MAX(XX.IMDG_AMDT_NO)  										AS IMDG_AMDT_NO
       ,  MAX(XX.IMDG_UN_NO)											AS IMDG_UN_NO
       ,  MAX(XX.IMDG_UN_NO_SEQ)										AS IMDG_UN_NO_SEQ
       ,  MAX(XX.PRP_SHP_NM)											AS PRP_SHP_NM
	   ,  MAX(XX.IMDG_TEC_NM)                     						AS IMDG_TEC_NM
       ,  MAX(XX.IMDG_PCK_GRP_CD_CTNT)									AS IMDG_PCK_GRP_CD_CTNT
	   ,  MAX(XX.IMDG_COMP_GRP_CD)										AS IMDG_COMP_GRP_CD
       ,  MAX(XX.EMS_NO)												AS EMS_NO
       ,  MAX((DECODE(SRSK_LBL_RNK,'1',XX.IMDG_SUBS_RSK_LBL_CD,'')))	AS N1ST_IMDG_SUBS_RSK_LBL_CD
       ,  MAX((DECODE(SRSK_LBL_RNK,'2',XX.IMDG_SUBS_RSK_LBL_CD,'')))	AS N2ND_IMDG_SUBS_RSK_LBL_CD
       ,  MAX((DECODE(SRSK_LBL_RNK,'3',XX.IMDG_SUBS_RSK_LBL_CD,'')))	AS N3RD_IMDG_SUBS_RSK_LBL_CD
       ,  MAX((DECODE(SRSK_LBL_RNK,'4',XX.IMDG_SUBS_RSK_LBL_CD,'')))	AS N4TH_IMDG_SUBS_RSK_LBL_CD

       ,  MAX((DECODE(SRSK_LBL_RNK,'5',XX.IMDG_SUBS_RSK_LBL_CD,'')))	AS N5TH_IMDG_SUBS_RSK_LBL_CD
       ,  MAX((DECODE(SRSK_LBL_RNK,'6',XX.IMDG_SUBS_RSK_LBL_CD,'')))	AS N6TH_IMDG_SUBS_RSK_LBL_CD
       ,  MAX((DECODE(SRSK_LBL_RNK,'7',XX.IMDG_SUBS_RSK_LBL_CD,'')))	AS N7TH_IMDG_SUBS_RSK_LBL_CD
       ,  MAX((DECODE(SRSK_LBL_RNK,'8',XX.IMDG_SUBS_RSK_LBL_CD,'')))	AS N8TH_IMDG_SUBS_RSK_LBL_CD

FROM      (
          --===========================================================================================
          SELECT    XX.IMDG_AMDT_NO
                 ,  XX.IMDG_UN_NO
                 ,  XX.IMDG_UN_NO_SEQ
                 ,  XX.PRP_SHP_NM
				 ,  XX.IMDG_TEC_NM
                 ,  XX.IMDG_PCK_GRP_CD_CTNT
				 ,	XX.IMDG_COMP_GRP_CD
                 ,  XX.EMS_NO
                 ,  YY.IMDG_SUBS_RSK_LBL_CD
                 ,  ROW_NUMBER() OVER (PARTITION BY YY.IMDG_UN_NO,YY.IMDG_UN_NO_SEQ ORDER BY YY.IMDG_SUBS_RSK_LBL_CD ASC) SRSK_LBL_RNK
				 ,  XX.MAPPING_RNK
          FROM      (
          			---------------------------------------------------------------------------------------------
					SELECT		*
					FROM		(
					---------------------------------------------------------------------------------------------
					
					SELECT		*
					FROM		(
								---------------------------------------------------------------------------------
          			SELECT    	X.IMDG_AMDT_NO
                 			,  	X.IMDG_UN_NO
                 			,  	X.IMDG_UN_NO_SEQ
                 			,  	X.PRP_SHP_NM
							,	Y.IMDG_TEC_NM
                 			,  	X.IMDG_PCK_GRP_CD						AS IMDG_PCK_GRP_CD_CTNT
							,	X.IMDG_COMP_GRP_CD
                 			,  	X.IMDG_EMER_NO  						AS EMS_NO
                 			,  	CASE 	WHEN X.PRP_SHP_NM       		= @[prp_shp_nm] AND NVL(Y.IMDG_TEC_NM,'*')	= NVL(@[imdg_tec_nm],'*') 				THEN '01'
										WHEN @[imdg_tec_nm]				IS NOT NULL     AND @[imdg_tec_nm]			= Y.IMDG_TEC_NM							THEN '11'
										WHEN @[imdg_tec_nm]				IS NOT NULL     AND UPPER(@[imdg_tec_nm])	= UPPER(Y.IMDG_TEC_NM)					THEN '12'
										WHEN @[imdg_tec_nm]				IS NOT NULL     AND Y.IMDG_TEC_NM			IS NULL									THEN '13'

										WHEN @[imdg_tec_nm]				IS NULL			AND X.PRP_SHP_NM       		= @[prp_shp_nm]   						THEN '21'
                         				WHEN @[imdg_tec_nm]				IS NULL			AND	LTRIM(RTRIM(X.PRP_SHP_NM))  LIKE LTRIM(RTRIM(@[prp_shp_nm])) 	THEN '22'
                         				WHEN @[imdg_tec_nm]				IS NULL			AND	@[prp_shp_nm]       		LIKE '%'||X.PRP_SHP_NM||'%' 		THEN '23'
										ELSE																												     NULL
                    			END  	AS MAPPING_RNK
          			FROM      	SCG_IMDG_UN_NO    						X
							,	SCG_IMDG_UN_NO_ORG_RACT					Y	
          			WHERE     	1 = 1
					AND			X.IMDG_UN_NO							= Y.IMDG_UN_NO					(+)
					AND			X.IMDG_UN_NO_SEQ						= Y.IMDG_UN_NO_SEQ				(+)
					AND       	NVL(X.IMDG_AMDT_NO,'*')       			= NVL(@[imdg_amdt_no],'*')
					AND			X.IMDG_UN_NO      						= @[imdg_un_no_ctnt]
          			AND       	DECODE(X.IMDG_PCK_GRP_CD,NULL,'*','I','1','II','2','III','3',X.IMDG_PCK_GRP_CD)
                                      									= DECODE(@[imdg_pck_grp_cd_ctnt],NULL,'*','I','1','II','2','III','3',@[imdg_pck_grp_cd_ctnt])
          			
					--:2015-08-28:--AND       	[prp_shp_nm]       					LIKE '%'||X.PRP_SHP_NM||'%'
          			--AND       	LTRIM(RTRIM([prp_shp_nm]))				= X.PRP_SHP_NM
					--:2016-10-11: PSN 공백 제거 
          			--AND       	REPLACE([prp_shp_nm],' ','')				= REPLACE(X.PRP_SHP_NM, ' ','')
 					--:2016-10-19: PSN 쉼표,마침표, 공백 제거 후 문자열 비교 
					AND REPLACE(REPLACE(REPLACE(@[prp_shp_nm], ' ', ''), '.', ''), ',', '') = REPLACE(REPLACE(REPLACE(X.PRP_SHP_NM, ' ', ''), '.', ''), ',', '')

		  			AND			NVL(X.CFR_FLG,'N')						= NVL(@[cfr_flg],'N')

					AND			X.IMDG_CLSS_CD    						= @[imdg_clss_cd_ctnt]		/* ADDING ON 11st SEP 2015 */

					--:2015-08-18:--AND			NVL([imdg_tec_nm],'*')	= NVL(Y.IMDG_TEC_NM,'*')
								---------------------------------------------------------------------------------
								) X
					WHERE		X.MAPPING_RNK							IS NOT NULL
					ORDER BY	X.MAPPING_RNK							ASC
							,	X.IMDG_UN_NO_SEQ						ASC
								) Y
					WHERE		ROWNUM									= 1
                    ---------------------------------------------------------------------------------------------
                    ) XX
                ,   SCG_IMDG_SUBS_RSK_LBL   							YY
          WHERE     XX.IMDG_UN_NO           							= YY.IMDG_UN_NO       			(+)
          AND       XX.IMDG_UN_NO_SEQ       							= YY.IMDG_UN_NO_SEQ   			(+)	
          --===========================================================================================
          ) XX
GROUP BY  XX.IMDG_AMDT_NO
       ,  XX.IMDG_UN_NO
       ,  XX.IMDG_UN_NO_SEQ
       ,  XX.PRP_SHP_NM
       ,  XX.IMDG_PCK_GRP_CD_CTNT
       ,  XX.EMS_NO			]]></sql>
			<params>
				<param name="prp_shp_nm" type="12" value="" out="N"/>
				<param name="imdg_tec_nm" type="12" value="" out="N"/>
				<param name="imdg_amdt_no" type="12" value="" out="N"/>
				<param name="imdg_un_no_ctnt" type="12" value="" out="N"/>
				<param name="imdg_pck_grp_cd_ctnt" type="12" value="" out="N"/>
				<param name="cfr_flg" type="12" value="" out="N"/>
				<param name="imdg_clss_cd_ctnt" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
