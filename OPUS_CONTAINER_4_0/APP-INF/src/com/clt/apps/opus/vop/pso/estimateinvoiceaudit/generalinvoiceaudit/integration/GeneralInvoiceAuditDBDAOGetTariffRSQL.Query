<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="GeneralInvoiceAuditDBDAOGetTariffRSQL">
			<desc><![CDATA[조회조건내, 최종 Version의 Tariff 가져오기]]></desc>
			<sql><![CDATA[
WITH V_YD_CHG AS (
        SELECT DISTINCT A.*
          FROM (SELECT C.YD_CHG_NO
                     , C.YD_CHG_VER_SEQ
                     , TO_CHAR(C.EFF_DT, 'YYYY-MM-DD') EFF_DT
                     , TO_CHAR(C.EXP_DT, 'YYYY-MM-DD') EXP_DT
                     , C.CURR_CD
                     , C.CPLS_FLG
                     , C.LST_FLG
                     , C.LGS_COST_CD
                     , C.VNDR_SEQ
                     , COUNT( * ) OVER (PARTITION BY C.YD_CD, C.LGS_COST_CD ORDER BY C.YD_CD, C.LGS_COST_CD) AS CNT
                  FROM PSO_YD_CHG C
                 WHERE C.YD_CD LIKE @[port_cd] || @[yard_cd]
                   AND TO_DATE(REPLACE(@[issue_date], '-', ''), 'YYYYMMDD') BETWEEN C.EFF_DT AND C.EXP_DT
                   AND C.LST_FLG = 'Y'
                 GROUP BY C.YD_CHG_NO
                     , C.YD_CHG_VER_SEQ
                     , C.YD_CD
                     , TO_CHAR(C.EFF_DT, 'YYYY-MM-DD')
                     , TO_CHAR(C.EXP_DT, 'YYYY-MM-DD')
                     , C.CURR_CD
                     , C.CPLS_FLG
                     , C.LST_FLG
                     , C.LGS_COST_CD
                     , C.VNDR_SEQ ) A
         WHERE 1=1
#if( ${cpls_flg} != '' && ${cpls_flg} == 'Y' )
           --Compulsory flag Y 일대 아래 조건 활성.
           AND (CASE WHEN A.CNT >= 2 THEN 'Y' ELSE A.CPLS_FLG END) = A.CPLS_FLG 
#end
    )
--SELECT *  FROM V_YD_CHG
SELECT A.YD_CHG_NO
     , A.YD_CHG_VER_SEQ
     , A.EFF_DT
     , A.EXP_DT
     , A.CURR_CD
     , A.CPLS_FLG
     , A.LST_FLG
     , A.LGS_COST_CD AS COST_CD
     , A.VNDR_SEQ
     , B.ACCT_CD
     , C.VNDR_LGL_ENG_NM
  FROM V_YD_CHG A
     , TES_LGS_COST B
     , MDM_VENDOR C
 WHERE 1 = 1
#if (${vndr_seq_all_flg} != '' && ${vndr_seq_all_flg} != 'Y') 
		 AND A.VNDR_SEQ IN (
             #foreach($key IN ${vndr_seq})
             	#if($velocityCount < $vndr_seq.size()) '$key', #else '$key' #end
             #end
         )
#end
#if (${cost_cd_all_flg} != '' && ${cost_cd_all_flg} != 'Y') 
		 AND A.LGS_COST_CD IN (
             #foreach(${key2} IN ${cost_cd})
             	#if($velocityCount < $cost_cd.size()) '$key2', #else '$key2' #end
             #end
         )
#end
   AND A.LGS_COST_CD    = B.LGS_COST_CD
   AND A.VNDR_SEQ       = C.VNDR_SEQ 			]]></sql>
			<params>
				<param name="port_cd" type="12" value="" out="N"/>
				<param name="yard_cd" type="12" value="" out="N"/>
				<param name="issue_date" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
