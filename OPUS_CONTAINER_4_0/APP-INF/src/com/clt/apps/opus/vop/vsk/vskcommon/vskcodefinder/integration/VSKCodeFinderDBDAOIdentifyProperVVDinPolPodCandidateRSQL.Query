<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="VSKCodeFinderDBDAOIdentifyProperVVDinPolPodCandidateRSQL">
			<desc><![CDATA[POL, POD 고려한 VVD 추출하기]]></desc>
			<sql><![CDATA[
SELECT      PS.SLAN_CD			AS VSL_SLAN_CD
		 ,	PS.VSL_CD
         ,  PS.SKD_VOY_NO
         ,  PS.SKD_DIR_CD
         ,  PS.VPS_PORT_CD
         ,  PS.CLPT_IND_SEQ
         ,  PS.CLPT_SEQ
         ,  PS.IB_CSSM_VOY_NO
         ,  PS.OB_CSSM_VOY_NO

		 ,  ''					AS CALL_SGN_NO
		 ,  ''					AS LLOYD_NO
		 ,	''					AS POL_CD
		 ,  ''					AS MATCHED_VVD_COUNT
		 ,  ''					AS EFFECTIVE_VVD_CHK_RSLT_CD
		 ,	''					AS EFFECTIVE_VVD_CHK_RSLT_RMK
FROM        VSK_VSL_PORT_SKD    PS
     ,      VSK_VSL_PORT_SKD    PPS
WHERE       1 = 1
AND         PS.VSL_CD           = PPS.VSL_CD
AND         PS.SKD_VOY_NO       = PPS.SKD_VOY_NO
AND         PS.SKD_DIR_CD       = PPS.SKD_DIR_CD
AND         PS.CLPT_SEQ         < PPS.CLPT_SEQ
AND         PS.VT_ADD_CALL_FLG  IS NULL       --:Excluding Virtual Add Calling Port:--
AND         PS.TURN_PORT_IND_CD IN ('Y','N')

AND			NVL(PS.SKD_CNG_STS_CD,'*')	<> 'S'
AND			NVL(PPS.SKD_CNG_STS_CD,'*')	<> 'S'

AND         PS.CLPT_SEQ     	= (SELECT     MAX(P1.CLPT_SEQ)
                                   FROM       VSK_VSL_PORT_SKD 		P1
                                   WHERE      P1.VSL_CD       		= PS.VSL_CD
                                   AND        P1.SKD_VOY_NO   		= PS.SKD_VOY_NO
                                   AND        P1.SKD_DIR_CD   		= PS.SKD_DIR_CD
                                   AND        P1.VPS_PORT_CD  		= PS.VPS_PORT_CD
								   AND        P1.VT_ADD_CALL_FLG 	IS NULL
                                  )
AND         PPS.CLPT_SEQ     	= (SELECT     MAX(P1.CLPT_SEQ)
                                   FROM       VSK_VSL_PORT_SKD 		P1
                                   WHERE      P1.VSL_CD       		= PPS.VSL_CD
                                   AND        P1.SKD_VOY_NO   		= PPS.SKD_VOY_NO
                                   AND        P1.SKD_DIR_CD   		= PPS.SKD_DIR_CD
                                   AND        P1.VPS_PORT_CD  		= PPS.VPS_PORT_CD
                                  )

AND         PS.VSL_CD           
            IN
            (
            --==================================================================
            SELECT  XX.VSL_CD
                  --, XX.CALL_SGN_NO
                  --, XX.LLOYD_NO
                  --, XX.DELT_FLG
            FROM    (
                    ------------------------------------------------------------       
                    SELECT  X.*
                          , DENSE_RANK() OVER (ORDER BY VSL_CD_1ST_RNK ASC, DELT_FLG ASC) VSL_CD_2ND_RNK
                    FROM    (
                            ----------------------------------------------------
                            SELECT  X.DELT_FLG
                                  , X.VSL_CD
                                  , X.CALL_SGN_NO
                                  , X.LLOYD_NO
                                  , CASE WHEN X.CALL_SGN_NO = @[call_sgn_no] THEN '1'
                                         WHEN X.LLOYD_NO    = @[lloyd_no]	 THEN '2'
                                         ELSE ''
                                    END  AS VSL_CD_1ST_RNK
                            FROM    MDM_VSL_CNTR      		X
                            WHERE   (X.CALL_SGN_NO     		= @[call_sgn_no]
                                     OR
                                     X.LLOYD_NO        		= @[lloyd_no]
                                    )                                 
                            ----------------------------------------------------   
                            ) X           
                    ------------------------------------------------------------
                    ) XX     
            WHERE   XX.VSL_CD_2ND_RNK                  		= '1'     
            --==================================================================               
            ) 
AND         (
				PS.OB_CSSM_VOY_NO                          	= @[ob_cssm_voy_no]
			OR
				SUBSTR(PS.OB_CSSM_VOY_NO,1,4)              	= @[ob_cssm_voy_no]
			)
AND         PS.VPS_PORT_CD                             		= @[pol_cd]
AND         PPS.VPS_PORT_CD                             	= @[pod_cd]			]]></sql>
			<params>
				<param name="call_sgn_no" type="12" value="" out="N"/>
				<param name="lloyd_no" type="12" value="" out="N"/>
				<param name="ob_cssm_voy_no" type="12" value="" out="N"/>
				<param name="pol_cd" type="12" value="" out="N"/>
				<param name="pod_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
