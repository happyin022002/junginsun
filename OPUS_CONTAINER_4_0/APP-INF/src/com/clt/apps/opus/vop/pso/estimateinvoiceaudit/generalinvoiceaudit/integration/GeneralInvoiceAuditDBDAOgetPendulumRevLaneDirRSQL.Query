<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="GeneralInvoiceAuditDBDAOgetPendulumRevLaneDirRSQL">
			<desc><![CDATA[Pendulum RevlaneDir search]]></desc>
			<sql><![CDATA[
WITH V_PENDULUM AS (
        SELECT V.VSL_CD
             , V.SKD_VOY_NO
             , V.SKD_DIR_CD
             , V.TURN TURN
             , V.SLAN_CD
             , V.VPS_PORT_CD
             , V.RLANE_DIR_CD
             , V.OB_RTO
             , V.IB_RTO
             , V.RLANE_CD
             , V.CNT
          FROM (
                SELECT V.VSL_CD
                     , V.SKD_VOY_NO
                     , V.SKD_DIR_CD
                     , V.TURN TURN
                     , V.SLAN_CD
                     , V.VPS_PORT_CD
                     , D.REV_DIR_CD RLANE_DIR_CD
                     , NVL(OB_RTO,0) OB_RTO
                     , NVL(IB_RTO,0) IB_RTO
                     , D.RLANE_CD
                     , COUNT(1) OVER (PARTITION BY V.VPS_PORT_CD) AS CNT
                  FROM PSO_PORT_EXPN_DIV D
                     , (SELECT DISTINCT B.VSL_CD
                             , B.SKD_VOY_NO
                             , B.SKD_DIR_CD
                             , A.TURN_PORT_FLG TURN
                             , A.SLAN_CD
                             , A.VPS_PORT_CD
                          FROM VSK_VSL_SKD B
                             , VSK_VSL_PORT_SKD A
                         WHERE 1=1
                           AND B.VSL_CD = @[vsl_cd]
                           AND B.SKD_VOY_NO = @[skd_voy_no]
                           AND B.SKD_DIR_CD = @[skd_dir_cd]
                           AND B.VSL_CD = A.VSL_CD
                           AND B.SKD_VOY_NO = A.SKD_VOY_NO
                           AND B.SKD_DIR_CD = A.SKD_DIR_CD
                           AND A.VPS_PORT_CD = SUBSTR (@[yd_cd], 1, 5)
                           AND A.YD_CD = @[yd_cd]
                           AND NVL (A.SKD_CNG_STS_CD, 'X') <> 'S'
                           --AND A.TURN_PORT_IND_CD IN ('N', 'Y')
                           AND A.CLPT_IND_SEQ = (SELECT MIN(P.CLPT_IND_SEQ) 
                                                   FROM VSK_VSL_PORT_SKD P 
                                                  WHERE 1=1
                                                    AND P.VSL_CD = @[vsl_cd]
                                                    AND P.SKD_VOY_NO = @[skd_voy_no]
                                                    AND P.SKD_DIR_CD = @[skd_dir_cd]
                                                    AND P.VPS_PORT_CD = SUBSTR (@[yd_cd], 1, 5)
                                                    AND P.YD_CD = @[yd_cd]
                                                    --AND P.TURN_PORT_IND_CD IN ('N', 'Y')
                                                    AND NVL(P.SKD_CNG_STS_CD, ' ') != 'S'
                                                 ) 
                       ) V
                 WHERE 1 = 1
                   AND V.SLAN_CD = D.SLAN_CD
                   AND V.SKD_DIR_CD = D.SKD_DIR_CD
                   AND V.VPS_PORT_CD = D.LOC_CD 
#if (${io_bnd} != '' && ${io_bnd} == 'IN') 
                 ORDER BY NVL(IB_RTO,0) DESC -- InBound
#elseif (${io_bnd} != '' && ${io_bnd} == 'OUT') 
                 ORDER BY NVL(OB_RTO,0) DESC -- OutBound
#else 
                 ORDER BY NVL(OB_RTO,0) DESC -- 아무것도 걸리지 않게 하기 위해 임의값을 넣는다..
#end
               ) V
         WHERE 1=1
           --AND V.CNT >= 1
#if (${io_bnd} != '' && ${io_bnd} == 'IN') 
           --AND V.IB_RTO > 0 -- InBound
           AND ROWNUM = 1
#elseif (${io_bnd} != '' && ${io_bnd} == 'OUT') 
           --AND V.OB_RTO > 0 -- OutBound
           AND ROWNUM = 1
#else 
           AND  V.OB_RTO > 100 -- 아무것도 걸리지 않게 하기 위해 임의값을 넣는다..
#end
      )
SELECT CASE WHEN MAX(V.RLANE_CD) IS NOT NULL THEN MAX(V.RLANE_CD || '|' || V.RLANE_DIR_CD ||'|'|| L.REV_YRMON)
            ELSE NULL
       END AS RLANE_CD
  FROM AR_MST_REV_VVD L
     , V_PENDULUM V
 WHERE L.VSL_CD = V.VSL_CD
   AND L.SKD_VOY_NO = V.SKD_VOY_NO
   AND L.SKD_DIR_CD = V.SKD_DIR_CD
   AND L.DELT_FLG = 'N' /*2015.09.11 Add*/
   AND L.RLANE_CD = NVL(V.RLANE_CD, L.RLANE_CD)			]]></sql>
			<params>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="yd_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
