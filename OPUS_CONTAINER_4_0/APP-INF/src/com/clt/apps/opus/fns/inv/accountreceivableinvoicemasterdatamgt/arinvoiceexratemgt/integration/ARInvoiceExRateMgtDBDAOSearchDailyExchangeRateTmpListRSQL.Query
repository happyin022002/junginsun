<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ARInvoiceExRateMgtDBDAOSearchDailyExchangeRateTmpListRSQL">
			<desc><![CDATA[SearchDailyExchangeRateTmpList]]></desc>
			<sql><![CDATA[
SELECT 
   AR_OFC_CD
 , IO_BND_CD
 , FM_DT
 , TO_DT
 , CHG_CURR_CD
 , LOCL_CURR_CD
 , INV_XCH_RT
 , XCH_RT_TP_CD
 , LATEST_RATE
 , ROUND(INV_XCH_RT / LATEST_RATE, 6) AS DIV_RATE
 , 'XX' CUST_CNT_CD
 , 0 AS CUST_SEQ 
 , ATTR_CTNT1 AS TMP_PK
 , ATTR_CTNT2 AS TMP_IB_FLAG 
 , ATTR_CTNT3 AS IVS_XCH_RT
 , ATTR_CTNT4 AS CNG_RMK 
 , ATTR_CTNT5 AS UPD_USR_ID
 , DECODE(ATTR_CTNT2, 'I', DECODE(CNT,0,'OK','DUP'), 'OK') AS DUP_CHK
 , VVD_CNT
FROM
(SELECT /*+ USE_MERGE(VRT) */
   TMP.AR_OFC_CD
 , TMP.IO_BND_CD
 , TMP.FM_DT
 , TMP.TO_DT
 , TMP.CHG_CURR_CD
 , TMP.LOCL_CURR_CD
 , TMP.INV_XCH_RT
 , NVL(D.XCH_RT_USD_TP_CD,'V') XCH_RT_TP_CD 
 , TMP.ATTR_CTNT1 
 , TMP.ATTR_CTNT2
 , TMP.ATTR_CTNT3
 , TMP.ATTR_CTNT4
 , TMP.ATTR_CTNT5 
 --, NVL(MAX(VRT.INV_XCH_RT) KEEP (DENSE_RANK FIRST ORDER BY VRT.FM_DT DESC), TMP.INV_XCH_RT ) AS LATEST_RATE 
 , NVL(MAX(DECODE(D.XCH_RT_RVS_FLG,'Y',VRT.IVS_XCH_RT,VRT.INV_XCH_RT)) KEEP (DENSE_RANK FIRST ORDER BY VRT.FM_DT DESC), DECODE(D.XCH_RT_RVS_FLG,'Y',TO_NUMBER(TMP.ATTR_CTNT3),TMP.INV_XCH_RT) ) AS LATEST_RATE 
 , COUNT(ICD.AR_OFC_CD) CNT
 , COUNT(DISTINCT CRT.VSL_CD) VVD_CNT 
 , D.XCH_RT_RVS_FLG
FROM --INV_DLY_XCH_RT_TMP TMP
             (
             SELECT              NVL(TMP.AR_OFC_CD, OFC.AR_OFC_CD) AS AR_OFC_CD
                           , TMP.IO_BND_CD
                           , TMP.FM_DT
                           , TMP.TO_DT
                           , TMP.CHG_CURR_CD
                           , TMP.LOCL_CURR_CD
                           , TMP.INV_XCH_RT
                           , TMP.XCH_RT_TP_CD
                           , TMP.ATTR_CTNT1
                           , TMP.ATTR_CTNT2
                           , TMP.ATTR_CTNT3
                           , TMP.ATTR_CTNT4
                           , TMP.ATTR_CTNT5
             FROM INV_DLY_XCH_RT_TMP TMP 
             ,(           SELECT AR_OFC_CD
                           FROM MDM_ORGANIZATION 
                           WHERE AR_OFC_CD IN (${arOfcList})
                     GROUP BY AR_OFC_CD
               ) OFC    
             ) TMP
             , INV_AR_STUP_OFC D
             , INV_CUST_AND_DLY_XCH_RT ICD
    , INV_VVD_XCH_RT CRT
    , INV_CUST_AND_DLY_XCH_RT VRT
WHERE TMP.AR_OFC_CD = D.AR_OFC_CD(+) 
AND   TMP.LOCL_CURR_CD = ICD.LOCL_CURR_CD(+)
AND   TMP.CHG_CURR_CD = ICD.CHG_CURR_CD(+)
AND   TMP.IO_BND_CD = ICD.IO_BND_CD(+)
AND   ICD.CUST_CNT_CD(+) ='XX'
AND   ICD.CUST_SEQ(+) = 0
AND   NVL(TMP.XCH_RT_TP_CD,'V') = ICD.XCH_RT_TP_CD(+)
AND   TMP.AR_OFC_CD = ICD.AR_OFC_CD(+)
AND   TMP.FM_DT = ICD.FM_DT(+)
AND   TMP.TO_DT = ICD.TO_DT(+)  
AND   CRT.XCH_RT_DT(+)     = TMP.FM_DT
AND   CRT.IO_BND_CD(+)     = TMP.IO_BND_CD
AND   CRT.LOCL_CURR_CD(+)  = TMP.LOCL_CURR_CD
AND   CRT.CHG_CURR_CD (+)  = TMP.CHG_CURR_CD
AND   CRT.AR_OFC_CD(+)     = TMP.AR_OFC_CD
AND   VRT.LOCL_CURR_CD(+) = TMP.LOCL_CURR_CD
AND   VRT.CHG_CURR_CD(+) = TMP.CHG_CURR_CD
AND   VRT.IO_BND_CD(+) = TMP.IO_BND_CD
AND   VRT.CUST_CNT_CD(+) ='XX'
AND   VRT.CUST_SEQ(+) = 0
AND   NVL(VRT.XCH_RT_TP_CD(+),'V') = NVL('V','V')
AND   VRT.AR_OFC_CD(+) = TMP.AR_OFC_CD
AND   VRT.FM_DT(+) < TMP.FM_DT
GROUP BY TMP.AR_OFC_CD
 , TMP.IO_BND_CD
 , TMP.FM_DT
 , TMP.TO_DT
 , TMP.CHG_CURR_CD
 , TMP.LOCL_CURR_CD
 , TMP.INV_XCH_RT
 , NVL(D.XCH_RT_USD_TP_CD,'V')
 , TMP.ATTR_CTNT1 
 , TMP.ATTR_CTNT2
 , TMP.ATTR_CTNT3
 , TMP.ATTR_CTNT4
 , TMP.ATTR_CTNT5 
 , D.XCH_RT_RVS_FLG
)
ORDER BY AR_OFC_CD, CHG_CURR_CD			]]></sql>
			<params>
			</params>
		</query>
	</querys>
</sqls>
