<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CarrierSettlementProcessDBDAOSearchMccDtlListByCarNLaneRSQL">
			<desc><![CDATA[DESC Enter..]]></desc>
			<sql><![CDATA[
WITH V_JOO_SETTLEMENT
AS
(
SELECT DENSE_RANK() OVER (ORDER BY ORD)||'. '||T.JO_STL_ITM_NM JO_STL_ITM_CD_NM
     , T.ORD
     , A1.JO_STL_ITM_CD
     , A1.RLANE_CD
     , A1.LOCL_CURR_CD
     , A1.VVD
     , SUM(A1.BSA_QTY) AS BSA_QTY
     , A1.BSA_SLT_PRC
     , SUM(A1.STL_LOCL_AMT) AS STL_LOCL_AMT
     , CASE WHEN A1.JO_STL_ITM_CD='S/H' OR A1.JO_STL_ITM_CD ='OPR' THEN '['||A1.PRE_STL_RMK||'] '||LISTAGG (A1.STL_RMK, ',') WITHIN GROUP (ORDER BY A1.STL_RMK)
            ELSE LISTAGG (A1.STL_RMK, ',') WITHIN GROUP (ORDER BY A1.STL_RMK)
       END AS STL_RMK
     , A1.ORD_SEQ
  FROM (SELECT DECODE(A.JO_STL_ITM_CD,'OPR','S/H',A.JO_STL_ITM_CD) AS JO_STL_ITM_CD
             , A.RLANE_CD
             , A.LOCL_CURR_CD
             , A.VVD
             , SUM(A.BSA_QTY) AS BSA_QTY
             , A.BSA_SLT_PRC
             , SUM(A.STL_LOCL_AMT) AS STL_LOCL_AMT
             , SUBSTR(DECODE(A.STL_RMK,NULL,NULL,','||A.STL_RMK)|| DECODE(SUM(A.SAIL_DYS),NULL,NULL,',Sail Days:'||CASE WHEN SUM(A.SAIL_DYS) > 0 THEN TO_CHAR(ROUND(SUM(A.STL_LOCL_AMT)/(SUM(A.BSA_QTY)*A.BSA_SLT_PRC), 3) ,'FM999,990.999') ELSE NULL END), 2) AS STL_RMK
             , A.PRE_STL_RMK
             , A.ORD_SEQ
          FROM (SELECT A.JO_STL_ITM_CD
                     , A.RLANE_CD
                     , A.LOCL_CURR_CD
                     , A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD||A.REV_DIR_CD VVD
                     , DECODE(A.STL_ADJ_FLG,'Y',B.BSA_QTY,CASE WHEN A.JO_STL_ITM_CD = 'R/F' AND A.JO_MNU_NM = 'R/F' THEN A.USD_SLT_BSA_QTY ELSE A.BSA_QTY END) AS BSA_QTY
                     , DECODE(A.STL_ADJ_FLG,'Y',B.BSA_SLT_PRC,CASE WHEN A.JO_STL_ITM_CD = 'R/F' AND A.JO_MNU_NM = 'R/F' THEN A.RF_SCG_PRC ELSE A.BSA_SLT_PRC END) AS BSA_SLT_PRC
                     , NVL(B.STL_LOCL_AMT, A.STL_LOCL_AMT) AS STL_LOCL_AMT
                     , A.SAIL_DYS
                     , SUBSTR(DECODE(A.STL_RMK,NULL,NULL,','||A.STL_RMK)||DECODE(A.FM_PORT_CD,NULL,NULL,DECODE(A.JO_MNU_NM,'RDR',DECODE(A.TO_PORT_CD, NULL,',RDR Port:'||A.FM_PORT_CD,','||A.FM_PORT_CD||'-'||A.TO_PORT_CD), ','||A.FM_PORT_CD||DECODE(A.TO_PORT_CD,NULL,NULL,'-'||A.TO_PORT_CD))), 2) AS STL_RMK
                     , C.JO_STL_ITM_NM AS PRE_STL_RMK
                     , C.ORD_SEQ
                  FROM JOO_SETTLEMENT A
                     , JOO_STL_DTL B
                     , JOO_STL_ITM C
                 WHERE A.ACCT_YRMON = REPLACE(@[acct_yrmon],'-')
                   AND A.ACCT_YRMON = B.ACCT_YRMON (+)
                   AND A.STL_VVD_SEQ = B.STL_VVD_SEQ(+)
                   AND A.STL_SEQ = B.STL_SEQ (+)
                   AND A.STL_LOCL_AMT<>0
                   #if (${rlane_cds} != '') 
                        AND A.RLANE_CD IN (
                       #foreach($key IN ${rlane_cds}) 
                            #if($velocityCount < $rlane_cds.size()) '$key', #else '$key' #end
                       #end
                        )
                   #end
                   #if (${jo_crr_cd} != '')
                    AND A.JO_CRR_CD = @[jo_crr_cd]
                   #end
                   #if (${trd_cd} != '')
                    AND A.TRD_CD = @[trd_cd]
                   #end
                   #if (${rev_dir_cd} != '')
                    AND A.RE_DIVR_CD = @[rev_dir_cd]
                   #end
                    AND A.JO_STL_ITM_CD = C.JO_STL_ITM_CD
                ) A
         GROUP BY A.JO_STL_ITM_CD
             , A.RLANE_CD
             , A.LOCL_CURR_CD
             , A.VVD
             , A.BSA_SLT_PRC
             , A.STL_RMK
             , A.PRE_STL_RMK
             , A.ORD_SEQ
        )A1
     , (SELECT ORD_SEQ AS ORD
             , JO_STL_ITM_CD
             , JO_STL_ITM_NM
          FROM JOO_STL_ITM) T
 WHERE T.JO_STL_ITM_CD = A1.JO_STL_ITM_CD
 GROUP BY T.ORD
     , T.JO_STL_ITM_NM
     , A1.JO_STL_ITM_CD
     , A1.RLANE_CD
     , A1.LOCL_CURR_CD
     , A1.VVD
     , A1.BSA_SLT_PRC
     , A1.PRE_STL_RMK
     , A1.ORD_SEQ
)
SELECT JO_STL_ITM_CD_NM
     , LOCL_CURR_CD
     , ORD
     , JO_STL_ITM_CD
     , RLANE_CD
     , VVD
     , DECODE(BSA_QTY, 0, NULL, BSA_QTY) AS BSA_QTY
     , DECODE(BSA_SLT_PRC, 0, NULL, BSA_SLT_PRC) AS BSA_SLT_PRC
     , STL_LOCL_AMT
     , STL_RMK
  FROM (
    /*Raw Data*/
    SELECT S.JO_STL_ITM_CD_NM
         , S.ORD
         , S.ORD_SEQ
         , S.JO_STL_ITM_CD
         , S.RLANE_CD
         , S.LOCL_CURR_CD
         , S.VVD
         , S.BSA_QTY
         , S.BSA_SLT_PRC
         , S.STL_LOCL_AMT
         , S.STL_RMK
      FROM V_JOO_SETTLEMENT S
     UNION ALL
     /*JO_STL_ITM_CD_NM, RLANE_CD, LOCL_CURR_CD Total Data*/
     SELECT RL.JO_STL_ITM_CD_NM 
         , RL.ORD
         , RL.ORD_SEQ
         , RL.JO_STL_ITM_CD
         , RL.RLANE_CD
         , RL.LOCL_CURR_CD
         , 'Total' AS VVD
         , NULL AS BSA_QTY
         , NULL AS BSA_SLT_PRC
         , SUM(RL.STL_LOCL_AMT) AS STL_LOCL_AMT
         , NULL AS STL_RMK
      FROM V_JOO_SETTLEMENT RL
      GROUP BY RL.JO_STL_ITM_CD_NM, RL.ORD, RL.ORD_SEQ, RL.JO_STL_ITM_CD, RL.RLANE_CD, RL.LOCL_CURR_CD 
     UNION ALL
     /*JO_STL_ITM_CD_NM, LOCL_CURR_CD Total Data*/
     SELECT ITM.JO_STL_ITM_CD_NM 
         , ITM.ORD
         , ITM.ORD_SEQ
         , ITM.JO_STL_ITM_CD
         , 'Total' RLANE_CD
         , ITM.LOCL_CURR_CD
         , NULL AS VVD
         , NULL AS BSA_QTY
         , NULL AS BSA_SLT_PRC
         , SUM(ITM.STL_LOCL_AMT) AS STL_LOCL_AMT
         , NULL AS STL_RMK
      FROM V_JOO_SETTLEMENT ITM
      GROUP BY ITM.JO_STL_ITM_CD_NM, ITM.ORD, ITM.ORD_SEQ, ITM.JO_STL_ITM_CD, ITM.LOCL_CURR_CD 
     UNION ALL
     /*LOCL_CURR_CD Total Data*/
     SELECT 'Total' AS JO_STL_ITM_CD_NM 
         , NULL AS ORD
         , NULL AS ORD_SEQ
         , NULL AS JO_STL_ITM_CD
         , NULL RLANE_CD
         , TOT.LOCL_CURR_CD
         , NULL AS VVD
         , NULL AS BSA_QTY
         , NULL AS BSA_SLT_PRC
         , SUM(TOT.STL_LOCL_AMT) AS STL_LOCL_AMT
         , NULL AS STL_RMK
      FROM V_JOO_SETTLEMENT TOT
      GROUP BY TOT.LOCL_CURR_CD 
  )
 ORDER BY ORD, RLANE_CD, VVD , LOCL_CURR_CD, ORD_SEQ, STL_RMK			]]></sql>
			<params>
				<param name="acct_yrmon" type="12" value="" out="N"/>
				<param name="jo_crr_cd" type="12" value="" out="N"/>
				<param name="trd_cd" type="12" value="" out="N"/>
				<param name="rev_dir_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
