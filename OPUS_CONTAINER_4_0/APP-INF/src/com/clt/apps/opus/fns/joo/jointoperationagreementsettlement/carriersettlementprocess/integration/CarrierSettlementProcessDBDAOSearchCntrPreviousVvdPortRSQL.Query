<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CarrierSettlementProcessDBDAOSearchCntrPreviousVvdPortRSQL">
			<desc><![CDATA[previous VVD and Port search
[2015.07.21]Virtual Add Calling 처리. VSK_VSL_PORT_SKD.NVL(VT_ADD_CALL_FLG, 'N') = 'N']]></desc>
			<sql><![CDATA[
WITH V_VVD AS(
        SELECT VPS.*
          FROM (SELECT VPS.VSL_CD
                     , VPS.SKD_VOY_NO AS SKD_VOY_NO
                     , VPS.SKD_DIR_CD AS SKD_DIR_CD
                     , VPS.VPS_PORT_CD AS VPS_PORT_CD
                     , VPS.CLPT_SEQ AS CLPT_SEQ
                     , VPS.CLPT_IND_SEQ AS CLPT_IND_SEQ
                     , VPS.VPS_ETD_DT
                     , VPS.TURN_SKD_VOY_NO
                     , VPS.TURN_SKD_DIR_CD
                     , VPS.TURN_CLPT_IND_SEQ
                  FROM VSK_VSL_SKD VSL
                     , MDM_VSL_CNTR MVL
                     , VSK_VSL_PORT_SKD VPS
                     , MDM_VSL_SVC_LANE_DIR MVS
                 WHERE 1=1
                   AND VSL.VSL_CD = @[vsl_cd]
                   AND VSL.SKD_VOY_NO = @[voy_no]
				   #if (${dir_cd} != '') 
				   AND VSL.SKD_DIR_CD = @[dir_cd]
				   #end
                   AND VSL.VSL_CD = MVL.VSL_CD
                   AND VSL.VSL_CD = VPS.VSL_CD
                   AND VSL.SKD_VOY_NO = VPS.SKD_VOY_NO
                   AND VSL.SKD_DIR_CD = VPS.SKD_DIR_CD
                   AND (VPS.TURN_PORT_IND_CD IS NULL OR VPS.TURN_PORT_IND_CD NOT IN ('D', 'V', 'F'))
                   AND (VPS.SKD_CNG_STS_CD IS NULL   OR VPS.SKD_CNG_STS_CD != 'S')
                   AND NVL(VPS.VT_ADD_CALL_FLG, 'N') = 'N' /*2015.07.21 Add*/
                   AND VSL.VSL_SLAN_CD = MVS.VSL_SLAN_CD
                   AND VSL.SKD_DIR_CD = MVS.VSL_SLAN_DIR_CD
                 ORDER BY MVS.VSL_SLAN_DIR_SEQ, VPS.CLPT_SEQ ) VPS
         WHERE ROWNUM = 1 )
SELECT VPS.VSL_CD
     , VPS.SKD_VOY_NO AS SKD_VOY_NO
     , VPS.SKD_DIR_CD AS SKD_DIR_CD
     , VPS.VPS_PORT_CD AS VPS_PORT_CD
     , VPS.CLPT_SEQ AS CLPT_SEQ
     , VPS.CLPT_IND_SEQ AS CLPT_IND_SEQ
     , VPS.VPS_ETD_DT
     , VPS.TURN_SKD_VOY_NO
     , VPS.TURN_SKD_DIR_CD
     , VPS.TURN_CLPT_IND_SEQ
  FROM VSK_VSL_SKD VSL
     , MDM_VSL_CNTR MVL
     , VSK_VSL_PORT_SKD VPS
     , MDM_VSL_SVC_LANE_DIR MVS
     , V_VVD SVV
 WHERE 1=1
   AND VPS.VSL_CD = SVV.VSL_CD
   AND VPS.SKD_VOY_NO = SVV.TURN_SKD_VOY_NO
   AND VPS.SKD_DIR_CD = SVV.TURN_SKD_DIR_CD
   AND VSL.VSL_CD = MVL.VSL_CD
   AND VSL.VSL_CD = VPS.VSL_CD
   AND VSL.SKD_VOY_NO = VPS.SKD_VOY_NO
   AND VSL.SKD_DIR_CD = VPS.SKD_DIR_CD
   AND VPS.CLPT_SEQ = ( SELECT MAX(CLPT_SEQ)
                          FROM VSK_VSL_PORT_SKD V
                         WHERE V.VSL_CD = VPS.VSL_CD
                           AND V.SKD_VOY_NO = VPS.SKD_VOY_NO
                           AND V.SKD_DIR_CD = VPS.SKD_DIR_CD
                           AND (V.TURN_PORT_IND_CD IS NULL OR V.TURN_PORT_IND_CD NOT IN ('D', 'V', 'F'))
                           AND (V.SKD_CNG_STS_CD IS NULL   OR V.SKD_CNG_STS_CD != 'S')
                           AND NVL(V.VT_ADD_CALL_FLG, 'N') = 'N' /*2015.07.21 Add*/ )
   AND (VPS.TURN_PORT_IND_CD IS NULL OR VPS.TURN_PORT_IND_CD NOT IN ('D', 'V', 'F'))
   AND (VPS.SKD_CNG_STS_CD IS NULL   OR VPS.SKD_CNG_STS_CD != 'S')
   AND NVL(VPS.VT_ADD_CALL_FLG, 'N') = 'N' /*2015.07.21 Add*/
   AND ROWNUM = 1			]]></sql>
			<params>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="voy_no" type="12" value="" out="N"/>
				<param name="dir_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
