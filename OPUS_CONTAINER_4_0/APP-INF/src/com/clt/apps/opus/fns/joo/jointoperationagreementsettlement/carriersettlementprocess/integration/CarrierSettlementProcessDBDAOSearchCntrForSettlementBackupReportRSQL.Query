<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CarrierSettlementProcessDBDAOSearchCntrForSettlementBackupReportRSQL">
			<desc><![CDATA[SearchCntrForSettlementBackupReport
[2015.07.21]Virtual Add Calling 처리. VSK_VSL_PORT_SKD.NVL(VT_ADD_CALL_FLG, 'N') = 'N']]></desc>
			<sql><![CDATA[
SELECT P.*
  FROM (
    SELECT ROWNUM NUM
         , P.SLAN_CD
         , P.VSL_CD
         , P.VOY_NO
         , P.DIR_CD
         , P.IB_CSSM_VOY_NO 
         , P.OB_CSSM_VOY_NO
         , P.POL
         , P.POD
         , P.OPR_CD
         , P.ID
         , P.ORI_POSITION
         , P.SZTP
         , P.WEIGHT
         , P.FE
         , NVL(P.TEUS, 1) AS TEUS
         , SUBSTR(
           DECODE(P.COD_TXT  ,NULL, NULL, ','||P.COD_TXT) ||
           DECODE(P.IMDG_TXT ,NULL, NULL, ','||P.IMDG_TXT)||
           DECODE(P.TEMP_TXT ,NULL, NULL, ','||P.TEMP_TXT)||
           DECODE(P.OOG_TXT  ,NULL, NULL, ','||P.OOG_TXT), 2) AS WARNING
         , SUBSTR(
           DECODE(P.IMDG  ,NULL, NULL, ','||P.IMDG )||
           DECODE(P.IMDG2 ,NULL, NULL, ','||P.IMDG2)||
           DECODE(P.IMDG3 ,NULL, NULL, ','||P.IMDG3)||
           DECODE(P.IMDG4 ,NULL, NULL, ','||P.IMDG4), 2) AS IMO
         , P.TEMP
         , P.OVS
         , P.OVP
         , P.OVH
         , P.COD
         , P.ACT_DEP_ATD_DT
         , P.LOAD_CALL
         , P.DISCH_ATD_DT
         , P.DISCH_CALL
         , P.COD_TXT
         , P.IMDG_TXT
         , P.TEMP_TXT
         , P.OOG_TXT
         , P.IMDG2
         , P.IMDG3
         , P.IMDG4
         , P.STATUS
         , P.CRR_CD
      FROM (       
            SELECT VSL.VSL_SLAN_CD AS SLAN_CD 
                 , BAY.VSL_CD
                 , BAY.VOY_NO
                 , BAY.DIR_CD
                 , VPS.IB_CSSM_VOY_NO 
                 , VPS.OB_CSSM_VOY_NO
                 , BAY.PORT_CD
                 , BAY.POL
                 , BAY.POD
                 , BAY.OPR_CD
                 , BAY.ID
                 , BAY.BAY||BAY.ROWW||BAY.TIER AS ORI_POSITION
                 , BAY.SZTP
                 , BAY.WEIGHT
                 , BAY.FE
                 , (SELECT NVL(COM.ATTR_CTNT3,0)
                      FROM JOO_COM_PPT COM
                         , JOO_COM_PPT TPSZ
                     WHERE 1=1
                       AND TPSZ.PPT_CD = 'TPSZ MAP'
                       AND TPSZ.ATTR_CTNT1 IS NOT NULL
                       AND TPSZ.ATTR_CTNT1 = BAY.SZTP
                       AND COM.PPT_CD = 'TEU CONVERSION'
                       AND COM.ATTR_CTNT2 IS NOT NULL
                       AND TPSZ.ATTR_CTNT2 = COM.ATTR_CTNT2
                       AND COM.ATTR_CTNT1 = VSL.VSL_SLAN_CD
                       AND ROWNUM = 1) AS TEUS
                 , BAY.IMDG
                 , BAY.IMDG2
                 , BAY.IMDG3
                 , BAY.IMDG4
                 , BAY.TEMP
                 , BAY.OVS
                 , BAY.OVP
                 , BAY.OVH
                 , BAY.COD
                 , DECODE(BAY.COD, NULL, NULL, 'COD') AS COD_TXT
                 , DECODE(BAY.IMDG||BAY.IMDG2||BAY.IMDG3||BAY.IMDG4,NULL,NULL,'DG') AS IMDG_TXT
                 , DECODE(BAY.TEMP, NULL, NULL,'TMP') AS TEMP_TXT
                 , DECODE(BAY.OVS||BAY.OVP||BAY.OVH, NULL,NULL,'OOG') AS OOG_TXT
                 , BAY.STATUS
                 , VPS.VSL_CD||VPS.SKD_VOY_NO || VPS.SKD_DIR_CD ||'-'|| VPS.VPS_PORT_CD ||'-'|| VPS.CLPT_IND_SEQ ||'-'||VPS.CLPT_SEQ||'-'||TO_CHAR(VPS_ETD_DT ,'YYYY-MM-DD HH24:MI')
                 , BAY.VOY_NO||'_'||BAY.POL||BAY.DIR_CD AS LOAD_CALL
                 , TO_CHAR(VPS.VPS_ETD_DT ,'YYYY-MM-DD HH24:MI') AS ACT_DEP_ATD_DT
                 , (
                        SELECT NVL(S1.TURN_SKD_VOY_NO,S1.SKD_VOY_NO) ||'_'||BAY.POD||NVL(S1.TURN_SKD_DIR_CD,S1.SKD_DIR_CD)
                          FROM VSK_VSL_PORT_SKD S1
                         WHERE S1.VSL_CD       = VPS.VSL_CD
                           AND S1.SKD_VOY_NO   = VPS.SKD_VOY_NO
                           AND S1.SKD_DIR_CD   = VPS.SKD_DIR_CD 
                           --AND (S1.TURN_PORT_IND_CD IS NULL OR S1.TURN_PORT_IND_CD NOT IN ('D', 'V', 'F'))
                           AND (S1.SKD_CNG_STS_CD IS NULL OR S1.SKD_CNG_STS_CD != 'S')
                           AND S1.VPS_ETD_DT > VPS.VPS_ETD_DT
                           AND S1.VPS_PORT_CD  = BAY.POD
                           AND ROWNUM = 1
                   ) AS DISCH_CALL
                 , (
                        SELECT MIN(TO_CHAR(VPS_ETD_DT ,'YYYY-MM-DD HH24:MI')) AS VPS_ETD_DT
                          FROM VSK_VSL_PORT_SKD S1
                         WHERE S1.VSL_CD       = VPS.VSL_CD
                           AND S1.SKD_VOY_NO   = VPS.SKD_VOY_NO
                           AND S1.SKD_DIR_CD   = VPS.SKD_DIR_CD 
                           --AND (S1.TURN_PORT_IND_CD IS NULL OR S1.TURN_PORT_IND_CD NOT IN ('D', 'V', 'F'))
                           AND (S1.SKD_CNG_STS_CD IS NULL OR S1.SKD_CNG_STS_CD != 'S')
                           AND S1.VPS_ETD_DT > VPS.VPS_ETD_DT
                           AND S1.VPS_PORT_CD  = BAY.POD
                   ) AS DISCH_ATD_DT
                 , NVL(VSL.ACT_CRR_CD,MVL.CRR_CD) AS CRR_CD
              FROM BAY_PLAN BAY
                 , VSK_VSL_SKD VSL
                 , MDM_VSL_CNTR MVL
                 , VSK_VSL_PORT_SKD VPS
             WHERE 1=1
               AND BAY.PLAN_TYPE = 'F' 
               AND BAY.VSL_CD = VSL.VSL_CD
               AND BAY.VOY_NO = VSL.SKD_VOY_NO
               AND BAY.DIR_CD = VSL.SKD_DIR_CD
               AND VSL.VSL_CD = MVL.VSL_CD
               AND BAY.VSL_CD   = VPS.VSL_CD
               AND BAY.VOY_NO   = VPS.SKD_VOY_NO
               AND BAY.DIR_CD   = VPS.SKD_DIR_CD
               AND BAY.PORT_CD  = VPS.VPS_PORT_CD
               AND BAY.PORT_CD  = BAY.POL
               AND (VPS.TURN_PORT_IND_CD IS NULL OR VPS.TURN_PORT_IND_CD NOT IN ('D', 'V', 'F'))
               AND (VPS.SKD_CNG_STS_CD IS NULL OR VPS.SKD_CNG_STS_CD != 'S')
               AND NVL(VPS.VT_ADD_CALL_FLG, 'N') = 'N' /*2015.07.21 Add*/
               #if (${slan_cd} != '') 
               AND BAY.OPR_CD = @[slan_cd]
			   #end      
         	   #if (${vsl_cd} != '') 
               AND BAY.VSL_CD = @[vsl_cd]
			   #end
	           #if (${voy_no} != '') 
               AND BAY.VOY_NO = @[voy_no]
               #end
               #if (${dir_cd} != '') 
               AND BAY.DIR_CD = @[dir_cd]
               #end
        ) P
 ) P
 WHERE 1=1
#if (${excel_flg} == '' && ${startno} != '')   
   AND NUM BETWEEN @[startno] AND @[endno]
#end			]]></sql>
			<params>
				<param name="slan_cd" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="voy_no" type="12" value="" out="N"/>
				<param name="dir_cd" type="12" value="" out="N"/>
				<param name="startno" type="12" value="" out="N"/>
				<param name="endno" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
