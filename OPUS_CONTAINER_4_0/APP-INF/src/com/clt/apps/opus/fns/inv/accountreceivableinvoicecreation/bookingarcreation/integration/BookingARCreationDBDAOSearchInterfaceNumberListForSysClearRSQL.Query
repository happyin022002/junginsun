<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BookingARCreationDBDAOSearchInterfaceNumberListForSysClearRSQL">
			<desc><![CDATA[SYS CLEAR 대상 INTERFACE NUMBER를 구한다.]]></desc>
			<sql><![CDATA[
SELECT DISTINCT AR_IF_NO   -- 반드시 DISTINCT를 반드시 사용해야 함. 삭제하지 말것
  FROM (SELECT Y.BL_SRC_NO ,Y.REV_TP_CD, Y.ACT_CUST_CNT_CD, Y.ACT_CUST_SEQ, Y.VSL_CD, Y.SKD_VOY_NO, Y.SKD_DIR_CD        
          FROM (SELECT AR_OFC_CD,BL_SRC_NO,REV_TP_CD,CURR_CD,SUM(CHG_AMT) S_CHG_AMT, ACT_CUST_CNT_CD, ACT_CUST_SEQ, VSL_CD, SKD_VOY_NO, SKD_DIR_CD
                  FROM (SELECT A.AR_IF_NO,A.AR_OFC_CD,A.BL_SRC_NO,A.ACT_CUST_CNT_CD,A.ACT_CUST_SEQ,A.VSL_CD,A.SKD_VOY_NO,A.SKD_DIR_CD
                               ,DECODE(A.REV_TP_CD,'M','M','B','B','C','B') REV_TP_CD,B.CURR_CD,SUM(B.CHG_AMT) CHG_AMT     -- 5) M 은 M 끼리 , B,C 는 합쳐서
                           FROM INV_AR_MN A,INV_AR_CHG B
                          WHERE A.AR_OFC_CD = @[ar_ofc_cd]   
                            AND A.INV_ISS_FLG ='N'                          -- 4) 이 때, INV_AR_MN 테이블이므로 주의할것
                            AND A.BL_INV_CFM_DT IS NOT NULL                 -- 3)
                            AND NVL(A.INV_DELT_DIV_CD,'N') <> 'Y'           -- 2)
                            AND A.AR_IF_NO = B.AR_IF_NO
                            #if (${bl_src_no} != '')
                            AND A.BL_SRC_NO = @[bl_src_no]
                            #end
                            #if (${act_cust_cnt_cd} != '')
                            AND A.ACT_CUST_CNT_CD = @[act_cust_cnt_cd]
                            #end
                            #if (${act_cust_seq} != '')
                            AND A.ACT_CUST_SEQ = @[act_cust_seq]
                            #end
                            #if (${vsl_cd} != '')
                            AND A.VSL_CD = @[vsl_cd]
                            #end
                            #if (${skd_voy_no} != '')
                            AND A.SKD_VOY_NO = @[skd_voy_no]
                            #end
                            #if (${skd_dir_cd} != '')
                            AND A.SKD_DIR_CD = @[skd_dir_cd]
                            #end
                          GROUP BY A.AR_IF_NO, A.AR_OFC_CD, A.BL_SRC_NO, A.ACT_CUST_CNT_CD, A.ACT_CUST_SEQ, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, DECODE(A.REV_TP_CD,'M','M','B','B','C','B'), B.CURR_CD
                    )  
                  GROUP BY AR_OFC_CD, BL_SRC_NO, REV_TP_CD, CURR_CD, ACT_CUST_CNT_CD, ACT_CUST_SEQ, VSL_CD, SKD_VOY_NO, SKD_DIR_CD
                 HAVING COUNT(AR_IF_NO) > 1                                         -- 7)
                )X,
                (SELECT A.BL_SRC_NO, CURR_CD, SUM(B.CHG_AMT) CHG_AMT, DECODE(A.REV_TP_CD,'M','M','B','B','C','B') REV_TP_CD
                        , A.ACT_CUST_CNT_CD, A.ACT_CUST_SEQ, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD
                           FROM INV_AR_MN A,INV_AR_CHG B
                          WHERE A.AR_OFC_CD = @[ar_ofc_cd]  
                            AND A.INV_ISS_FLG ='N'                          -- 4) 이 때, INV_AR_MN 테이블이므로 주의할것
                            AND A.BL_INV_CFM_DT IS NOT NULL                 -- 3)
                            AND NVL(A.INV_DELT_DIV_CD,'N') <> 'Y'           -- 2)
                            AND A.AR_IF_NO = B.AR_IF_NO
                            #if (${bl_src_no} != '')
                            AND A.BL_SRC_NO = @[bl_src_no]
                            #end
                            #if (${act_cust_cnt_cd} != '')
                            AND A.ACT_CUST_CNT_CD = @[act_cust_cnt_cd]
                            #end
                            #if (${act_cust_seq} != '')
                            AND A.ACT_CUST_SEQ = @[act_cust_seq]
                            #end
                            #if (${vsl_cd} != '')
                            AND A.VSL_CD = @[vsl_cd]
                            #end
                            #if (${skd_voy_no} != '')
                            AND A.SKD_VOY_NO = @[skd_voy_no]
                            #end
                            #if (${skd_dir_cd} != '')
                            AND A.SKD_DIR_CD = @[skd_dir_cd]
                            #end
                          GROUP BY A.BL_SRC_NO, CURR_CD, DECODE(A.REV_TP_CD,'M','M','B','B','C','B'), A.ACT_CUST_CNT_CD, A.ACT_CUST_SEQ, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD
                          , A.ACT_CUST_CNT_CD, A.ACT_CUST_SEQ, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD
                )Y
          WHERE X.BL_SRC_NO = Y.BL_SRC_NO
            AND X.REV_TP_CD = Y.REV_TP_CD
            AND X.ACT_CUST_CNT_CD = Y.ACT_CUST_CNT_CD
            AND X.ACT_CUST_SEQ = Y.ACT_CUST_SEQ
            AND X.VSL_CD = Y.VSL_CD
            AND X.SKD_VOY_NO = Y.SKD_VOY_NO
            AND X.SKD_DIR_CD = Y.SKD_DIR_CD
          GROUP BY Y.BL_SRC_NO ,Y.REV_TP_CD, Y.ACT_CUST_CNT_CD, Y.ACT_CUST_SEQ, Y.VSL_CD, Y.SKD_VOY_NO, Y.SKD_DIR_CD        
         HAVING SUM(DECODE(CHG_AMT,0,0,1)) = 0                        -- 6)
       ) A,
       (SELECT A.AR_IF_NO,A.BL_SRC_NO
              ,DECODE(A.REV_TP_CD,'M','M','B','B','C','B') REV_TP_CD
               , A.ACT_CUST_CNT_CD, A.ACT_CUST_SEQ, A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD
          FROM INV_AR_MN A,INV_AR_CHG B
         WHERE A.AR_OFC_CD = @[ar_ofc_cd]   
           AND A.INV_ISS_FLG ='N'  -- 이 때, INV_AR_MN 테이블이므로 주의할것
           AND A.BL_INV_CFM_DT IS NOT NULL
           AND NVL(A.INV_DELT_DIV_CD,'N') <> 'Y'
           AND A.AR_IF_NO = B.AR_IF_NO 
           #if (${bl_src_no} != '')
            AND A.BL_SRC_NO = @[bl_src_no]
            #end
            #if (${act_cust_cnt_cd} != '')
            AND A.ACT_CUST_CNT_CD = @[act_cust_cnt_cd]
            #end
            #if (${act_cust_seq} != '')
            AND A.ACT_CUST_SEQ = @[act_cust_seq]
            #end
            #if (${vsl_cd} != '')
            AND A.VSL_CD = @[vsl_cd]
            #end
            #if (${skd_voy_no} != '')
            AND A.SKD_VOY_NO = @[skd_voy_no]
            #end
            #if (${skd_dir_cd} != '')
            AND A.SKD_DIR_CD = @[skd_dir_cd]
            #end
      ) B
  WHERE A.BL_SRC_NO = B.BL_SRC_NO 
    AND A.REV_TP_CD = B.REV_TP_CD
    AND A.ACT_CUST_CNT_CD = B.ACT_CUST_CNT_CD
    AND A.ACT_CUST_SEQ = B.ACT_CUST_SEQ
    AND A.VSL_CD = B.VSL_CD
    AND A.SKD_VOY_NO = B.SKD_VOY_NO
    AND A.SKD_DIR_CD = B.SKD_DIR_CD    			]]></sql>
			<params>
				<param name="ar_ofc_cd" type="12" value="" out="N"/>
				<param name="bl_src_no" type="12" value="" out="N"/>
				<param name="act_cust_cnt_cd" type="12" value="" out="N"/>
				<param name="act_cust_seq" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
