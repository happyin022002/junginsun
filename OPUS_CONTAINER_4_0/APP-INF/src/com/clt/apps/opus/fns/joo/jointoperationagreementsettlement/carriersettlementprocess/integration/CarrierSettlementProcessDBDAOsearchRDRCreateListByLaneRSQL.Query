<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CarrierSettlementProcessDBDAOsearchRDRCreateListByLaneRSQL">
			<desc><![CDATA[RDR Upload Inquiry 조회
[2015.07.21]Virtual Add Calling 처리. VSK_VSL_PORT_SKD.NVL(VT_ADD_CALL_FLG, 'N') = 'N']]></desc>
			<sql><![CDATA[
SELECT 
 S.SLAN_CD
,VSL_CD,VOY_NO
,DIR_CD,CLPT_SEQ
,PORT_CD
,TO_CHAR(VPS_ETD_DT,'YYYYMMDDHH24MI') AS VPS_ETD_DT
,SKD_CNG_STS_CD
,REGION,H_YN  pagerows
,TO_CHAR(UPDATE_TIME,'YYYYMMDDHH24MI') AS UPDATE_TIME
FROM ( 
    SELECT V.SLAN_CD ,
           V.VSL_CD ,
           V.SKD_VOY_NO VOY_NO ,
           V.SKD_DIR_CD DIR_CD ,
           NVL2(R2.REGION,V.CLPT_SEQ,NULL) CLPT_SEQ,
           NVL2(R2.REGION,V.VPS_PORT_CD,NULL) PORT_CD,
           NVL2(R2.REGION,V.VPS_ETD_DT,NULL) VPS_ETD_DT,
           NVL2(R2.REGION,R2.UPDATE_TIME,NULL) UPDATE_TIME,
           DECODE( R2.REGION, NULL, NULL,  DECODE(V.SKD_CNG_STS_CD, 'A', 'Additional calling', 'C', 'Change calling', 'I', 'Phase in', 'O', 'Phase out', 'R', 'Reverse calling', 'S', 'Skip calling', NULL) ) SKD_CNG_STS_CD ,
           R2.REGION,
           NVL2(R2.REGION,'Y','N') H_YN
    FROM   VSK_VSL_PORT_SKD V,
           RDR_HEADER R2
    WHERE  R2.VSL_CD(+)  = V.VSL_CD
    AND    R2.VOY_NO(+)  = V.SKD_VOY_NO
    AND    R2.DIR_CD(+)  = V.SKD_DIR_CD
    AND    R2.PORT_CD(+) = V.VPS_PORT_CD
    AND    R2.REGION IS  NOT NULL
    AND    V.VPS_ETA_DT BETWEEN TO_DATE(@[fromDt], 'YYYYMMDD') AND TO_DATE(@[toDt], 'YYYYMMDD') + 0.99999
    AND    V.SLAN_CD = @[lane]
    AND    NVL(V.VT_ADD_CALL_FLG, 'N') = 'N' /*2015.07.21 Add*/
    UNION ALL
    SELECT   V.SLAN_CD ,
           V.VSL_CD ,
           V.SKD_VOY_NO VOY_NO ,
           V.SKD_DIR_CD DIR_CD ,
          NULL CLPT_SEQ,
           ''PORT_CD,
           NULL VPS_ETD_DT,
           NULL UPDATE_TIME,
           '' SKD_CNG_STS_CD ,
           '' REGION,
           'N'H_YN
    FROM   VSK_VSL_PORT_SKD V 
    WHERE   
          NOT EXISTS (SELECT 'Y'  FROM RDR_HEADER R3 WHERE R3.VSL_CD= V.VSL_CD AND R3.VOY_NO  = V.SKD_VOY_NO AND R3.DIR_CD   = V.SKD_DIR_CD  ) 
    AND    V.VPS_ETA_DT BETWEEN TO_DATE(@[fromDt], 'YYYYMMDD') AND TO_DATE(@[toDt], 'YYYYMMDD') + 0.99999
    AND    V.SLAN_CD = @[lane]
    AND    NVL(V.VT_ADD_CALL_FLG, 'N') = 'N' /*2015.07.21 Add*/
    ) S 
GROUP BY S.SLAN_CD,VSL_CD,VOY_NO,DIR_CD,CLPT_SEQ,PORT_CD,VPS_ETD_DT,SKD_CNG_STS_CD,REGION,H_YN,UPDATE_TIME
ORDER BY S.VSL_CD,S.VOY_NO,S.DIR_CD, S.VPS_ETD_DT			]]></sql>
			<params>
				<param name="fromDt" type="12" value="" out="N"/>
				<param name="toDt" type="12" value="" out="N"/>
				<param name="lane" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
