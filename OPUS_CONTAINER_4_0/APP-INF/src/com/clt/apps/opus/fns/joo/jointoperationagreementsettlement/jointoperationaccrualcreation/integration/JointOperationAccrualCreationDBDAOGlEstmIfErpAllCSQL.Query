<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="JointOperationAccrualCreationDBDAOGlEstmIfErpAllCSQL">
			<desc><![CDATA[[2015.03.18]exeYrmon All Delete and All Insert ]]></desc>
			<sql><![CDATA[
INSERT INTO GL_ESTM_IF_ERP (
	  EXE_YRMON
    , SYS_SRC_ID
    , REV_YRMON
    , ACCT_CD
    , ESTM_SEQ_NO
    , AGMT_NO
    , WO_NO
    , BIZ_UT_ID
    , LOC_CD
    , VSL_CD
    , SKD_VOY_NO
    , SKD_DIR_CD
    , REV_DIR_CD
    , CNTR_TPSZ_CD
    , CNTR_QTY
    , BSA_SLT_QTY
    , CRR_CD
    , SLT_COST_AMT
    , CUST_CNT_CD
    , CUST_SEQ
    , VVD_DUR_NO
    , HIR_DT_AMT
    , ESTM_AMT
    , ACT_AMT
    , ACCL_AMT
    , ESTM_VVD_TP_CD
    , ESTM_IOC_DIV_CD
    , ESTM_VVD_HDR_ID
    , ESTM_BC_DIV_CD
    , OP_LSE_DIV_FLG
    , TTL_TRF_AMT
    , VNDR_INV_NO
    , LOCL_CURR_CD
    , ACT_DT
    , ACT_PLC_CD
    , SLAN_CD
    , ACCT_DTL_CD
    , COST_ACT_PLC_CD
    , CRE_USR_ID
    , CRE_DT
    , UPD_USR_ID
    , UPD_DT
)
SELECT A.EXE_YRMON          /* PK - EXE_YRMON */
     , A.SYS_SRC_ID         /* PK - SYS_SRC_ID */
     , A.REV_YRMON          /* PK - REV_YRMON */
     , A.ACCT_CD            /* PK - ACCT_CD */
     , (A.ESTM_SEQ_NO + ROWNUM) /* PK - ESTM_SEQ_NO */
     , A.JO_STL_JB_CD       /* AGMT_NO */
     , A.RLANE_CD           /* WO_NO */
     , A.JO_CNTR_DIV_CTNT   /* BIZ_UT_ID */
     , A.LOC_CD             /* LOC_CD */
     , A.VSL_CD             /*VSL_CD */
     , A.SKD_VOY_NO         /*SKD_VOY_NO */
     , A.SKD_DIR_CD         /*SKD_DIR_CD */
     , A.REV_DIR_CD         /*REV_DIR_CD */
     , NULL                 /*CNTR_TPSZ_CD */
     , 0                    /*CNTR_QTY */
     , A.BSA_QTY            /*BSA_SLT_QTY */
     , A.JO_CRR_CD          /*CRR_CD */
     , A.BSA_SLT_PRC        /*SLT_COST_AMT */
     , A.CUST_CNT_CD        /*CUST_CNT_CD */
     , A.CUST_SEQ           /*CUST_SEQ */
     , NULL                 /*VVD_DUR_NO */
     , 0                    /*HIR_DT_AMT */
     , A.ESTM_AMT           /*ESTM_AMT */
     , A.ACT_AMT            /*ACT_AMT */
     , A.ACCL_AMT           /*ACCL_AMT */
     , A.ESTM_VVD_TP_CD     /*ESTM_VVD_TP_CD */
     , A.JO_IOC_DIV_CD      /*ESTM_IOC_DIV_CD */
     , A.ESTM_VVD_HDR_ID    /*ESTM_VVD_HDR_ID */
     , A.CNTR_BLK_DIV_CD    /*ESTM_BC_DIV_CD */
     , 'N'                  /*OP_LSE_DIV_FLG */
     , 0                    /*TTL_TRF_AMT */
     , NULL                 /*VNDR_INV_NO */
     , 'USD'                /*LOCL_CURR_CD */
     , A.ACT_DT             /*ACT_DT */
     , NULL                 /*ACT_PLC_CD 첫번째 포트*/
     , SUBSTR(A.RLANE_CD, 1,3) /*SLAN_CD */
     , NULL                 /*ACCT_DTL_CD */
     , NULL                 /*COST_ACT_PLC_CD */
     , @[usr_id]            /*CRE_USR_ID */
     , SYSDATE              /*CRE_DT */
     , @[usr_id]            /*UPD_USR_ID  */
     , SYSDATE              /*UPD_DT  */
  FROM (
        SELECT /*+INDEX(A XPKJOO_ESTM_ACT_RSLT)*/
               NVL((SELECT /*+INDEX_DESC(G XPKGL_ESTM_IF_ERP)*/
                          NVL(MAX(G.ESTM_SEQ_NO),0)
                          FROM GL_ESTM_IF_ERP G
                         WHERE G.EXE_YRMON = REPLACE(A.EXE_YRMON,'-','')
                           AND G.SYS_SRC_ID = A.SYS_SRC_ID
                           AND G.REV_YRMON = REPLACE(A.REV_YRMON,'-','')
                           AND G.ACCT_CD = A.ACCT_CD
                           AND ROWNUM =1),1) AS ESTM_SEQ_NO
             , A.EXE_YRMON
             , A.REV_YRMON
             , A.JO_CRR_CD
             , A.CUST_CNT_CD
             , A.CUST_SEQ
             , A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD||A.REV_DIR_CD AS VVD
             , A.VSL_CD
             , A.SKD_VOY_NO
             , A.SKD_DIR_CD
             , A.REV_DIR_CD
             , A.RLANE_CD
             , A.JO_STL_JB_CD
             , (SELECT C.INTG_CD_VAL_DP_DESC
                  FROM COM_INTG_CD_DTL C
                 WHERE C.INTG_CD_ID = 'CD01866'
                   AND C.INTG_CD_VAL_CTNT = A.JO_STL_JB_CD
                   AND ROWNUM = 1) AS JO_STL_JB_NM
             , A.BSA_QTY
             , A.BSA_SLT_PRC
             , A.ACCT_CD
             , A.ESTM_ACT_SEQ
             , A.ESTM_AMT
             , A.ACT_AMT
             , A.ACCL_AMT
             , A.ESTM_VVD_TP_CD
             , A.ESTM_VVD_HDR_ID
             , A.JO_IOC_DIV_CD
             , A.SYS_SRC_ID
             , A.JO_CNTR_DIV_CTNT
             , A.LOC_CD
             , A.ACCL_AMT_CORR_FLG
             , A.CNTR_BLK_DIV_CD
             , A.ACT_DT
             , A.JO_STL_ITM_CD
             , A.TRD_CD
          FROM (
                SELECT A.EXE_YRMON
                     , A.REV_YRMON
                     , A.ACCT_CD
                     , A.JO_CRR_CD
                     , A.RLANE_CD
                     , A.VSL_CD
                     , A.SKD_VOY_NO
                     , A.SKD_DIR_CD
                     , A.REV_DIR_CD
                     , A.ACCL_AMT_CORR_FLG
                     , MAX(A.ESTM_VVD_TP_CD) AS ESTM_VVD_TP_CD
                     , MAX(A.ESTM_ACT_SEQ) AS ESTM_ACT_SEQ
                     , A.JO_STL_JB_CD AS JO_STL_JB_CD
                     , MAX(A.BSA_QTY) AS BSA_QTY
                     , MAX(A.BSA_SLT_PRC) AS BSA_SLT_PRC
                     , SUM(A.ESTM_AMT) AS ESTM_AMT
                     , SUM(A.ACT_AMT) AS ACT_AMT
                     , SUM(A.ACCL_AMT) AS ACCL_AMT
                     , MAX(A.SYS_SRC_ID) AS SYS_SRC_ID
                     , MAX(A.LOC_CD) AS LOC_CD
                     , MAX(A.JO_IOC_DIV_CD) AS JO_IOC_DIV_CD
                     , MAX(A.ESTM_VVD_HDR_ID) AS ESTM_VVD_HDR_ID
                     , MAX(A.JO_CNTR_DIV_CTNT) AS JO_CNTR_DIV_CTNT
                     , MAX(A.CNTR_BLK_DIV_CD) AS CNTR_BLK_DIV_CD
                     , MAX(A.ACT_DT) AS ACT_DT
                     , MAX(A.JO_STL_ITM_CD) AS JO_STL_ITM_CD
                     , MAX(B.TRD_CD) AS TRD_CD
                     , CASE WHEN A.ACCT_CD LIKE '4%' THEN B.CUST_CNT_CD
                            WHEN A.ACCT_CD LIKE '5%' THEN ''
                       END AS CUST_CNT_CD
                     , CASE WHEN A.ACCT_CD LIKE '4%' THEN B.CUST_SEQ
                            WHEN A.ACCT_CD LIKE '5%' THEN B.VNDR_SEQ
                       END AS CUST_SEQ
                     , A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD||A.REV_DIR_CD AS VVD
                  FROM JOO_ESTM_ACT_RSLT A
                     , JOO_CARRIER B
                 WHERE 1=1
                   AND A.EXE_YRMON = REPLACE(@[exe_yrmon],'-','')
                   AND A.JO_CRR_CD = B.JO_CRR_CD
                   AND A.RLANE_CD = B.RLANE_CD
                 GROUP BY A.EXE_YRMON
                     , A.REV_YRMON
                     , A.JO_CRR_CD
                     , B.CUST_CNT_CD
                     , B.CUST_SEQ
                     , B.VNDR_SEQ
                     , A.VSL_CD
                     , A.SKD_VOY_NO
                     , A.SKD_DIR_CD
                     , A.REV_DIR_CD
                     , A.RLANE_CD
                     , A.JO_STL_JB_CD
                     , A.ACCT_CD
                     , A.ACCL_AMT_CORR_FLG
                 ORDER BY A.ACCT_CD
                     , A.REV_YRMON
                     , A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD||A.REV_DIR_CD 
                ) A 
       ) A
 WHERE 1=1			]]></sql>
			<params>
				<param name="usr_id" type="12" value="" out="N"/>
				<param name="exe_yrmon" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
