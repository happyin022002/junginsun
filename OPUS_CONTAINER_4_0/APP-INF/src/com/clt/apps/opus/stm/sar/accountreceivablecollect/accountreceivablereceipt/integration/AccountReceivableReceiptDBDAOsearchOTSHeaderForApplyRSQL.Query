<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="AccountReceivableReceiptDBDAOsearchOTSHeaderForApplyRSQL">
			<desc><![CDATA[Apply 대상 OTS header 정보 조회]]></desc>
			<sql><![CDATA[
SELECT DISTINCT A.RHQ_CD 
	   , A.OTS_OFC_CD OFC_CD
	   , A.BL_NO
       , A.BKG_NO
       , A.INV_NO
       , B.INV_OFC_CD OTS_OFC_CD
       , A.BIL_TO_CUST_CNT_CD
       , A.BIL_TO_CUST_SEQ
       , A.BIL_TO_CUST_CNT_CD||'-'||LPAD(A.BIL_TO_CUST_SEQ, 6, '0') BIL_TO_CUST_CD
       , A.VSL_CD||A.SKD_VOY_NO||A.DIR_CD LOCL_VVD_CD
       , A.TRNK_VVD_CD
       , A.SAIL_ARR_DT
       , DECODE(A.BKG_IO_BND_CD, 'O', 'O/B', 'I/B') IO_BND_CD
       , A.DUE_DT
       , A.CUST_SREP_CD SREP_CD
       , A.OTS_RMK
	   , (SELECT INTG_CD_VAL_DP_DESC              
          FROM COM_INTG_CD_DTL
          WHERE INTG_CD_ID = 'CD02060'
          AND INTG_CD_VAL_CTNT = A.XCH_RT_TP_CD) XCH_RT_TP_NM
	   , A.XCH_RT_TP_CD
       , A.XCH_RT_DT
       , A.CR_MK_FLG CR_FLG
       , A.OTS_SRC_CD AR_FINC_SRC_CD
	   , A.MAX_AR_IF_NO
	   , B.INV_OFC_CD||A.BL_NO||A.INV_NO RCT_APLY_HDR_SEQ
	   , 'N' RCT_APLY_FLG
	   , A.INV_DT
FROM SAR_OTS_HDR A,
     SAR_OTS_HIS B
WHERE A.RHQ_CD = B.RHQ_CD
AND A.OTS_OFC_CD = B.OTS_OFC_CD
AND A.BL_NO = B.BL_NO
AND A.INV_NO = B.INV_NO
AND A.RHQ_CD = @[rhq_cd]
#if(${ots_cd} == 'COU')
    AND A.OTS_OFC_CD = @[rep_ots_ofc_cd]
#else
    AND A.OTS_OFC_CD = @[ots_ofc_cd]
#end
#if(${bl_no} != '')
    AND A.BL_NO = @[bl_no]
#end
#if(${ots_smry_cd} == 'INV')
    #if(${inv_no} != '')
        AND A.INV_NO = @[inv_no]
    #else
        AND A.INV_NO <> '**********'
    #end
#else
    #if(${inv_no} != '')
        AND A.INV_NO = @[inv_no]
    #else
        AND A.INV_NO = '**********'
    #end
#end
#if(${ots_srch_flg} == 'Y')
	AND B.INV_OFC_CD = @[ots_ofc_cd]
#end
AND B.OTS_HIS_TP_CD = 'OTS'
AND A.STL_FLG = 'N'
#if (${local_chg_flag} == 'Y')
        #if (${invoice_type} == 'NFRT')
			#if (${bound_type} == 'L')
            AND B.REV_TP_SRC_CD IN ('MIV','MIC','MOS')             
			#else
            AND ( B.REV_TP_SRC_CD LIKE 'M%' AND B.REV_TP_SRC_CD NOT IN ('MDM','MDT') )
            #end 
	    #else
        AND A.BKG_IO_BND_CD = @[bound_type]  
        AND ( B.REV_TP_SRC_CD IN ('MDM','MDT','MOS') OR B.REV_TP_SRC_CD LIKE 'B%' OR B.REV_TP_SRC_CD LIKE 'C%' )  
        #end
#end
AND EXISTS (SELECT 'X'
       		FROM SAR_OTS_HIS P,
            	 SAR_OTS_CHG Q
       		WHERE P.OTS_HIS_SEQ = Q.OTS_HIS_SEQ
       		AND P.RHQ_CD = B.RHQ_CD
       		AND P.INV_OFC_CD = B.INV_OFC_CD
       		AND P.BL_NO = B.BL_NO
       		AND P.INV_NO = B.INV_NO
            #if (${local_chg_flag} == 'Y')
				#if (${invoice_type} == 'NFRT')
					#if (${bound_type} == 'L') 
                    AND P.REV_TP_SRC_CD IN ('MIV','MIC','MOS')    
                    AND (Q.CHG_TP_CD IN ( SELECT D.LU_CD
                                          FROM   SCO_LU_HDR H,  SCO_LU_DTL D
                                          WHERE  H.LU_TP_CD = D.LU_TP_CD
                                          AND    H.LU_APPL_CD = 'SAR'
                                          AND    D.LU_TP_CD = 'TH LOCAL CHARGE'
                                          AND    D.ENBL_FLG = 'Y') OR Q.TJ_SRC_NM  = 'VAT')
					#else
                    AND ( P.REV_TP_SRC_CD LIKE 'M%' AND P.REV_TP_SRC_CD NOT IN ('MDM','MDT') )
                    AND (Q.CHG_TP_CD NOT IN (SELECT D.LU_CD
                                             FROM   SCO_LU_HDR H,  SCO_LU_DTL D
                                             WHERE  H.LU_TP_CD = D.LU_TP_CD
                                             AND    H.LU_APPL_CD = 'SAR'
                                             AND    D.LU_TP_CD = 'TH LOCAL CHARGE'
                                             AND    D.ENBL_FLG = 'Y'))
					AND Q.TJ_SRC_NM  != 'VAT'
					#end
				#else
                AND ( P.REV_TP_SRC_CD IN ('MDM','MDT','MOS') OR P.REV_TP_SRC_CD LIKE 'B%' OR P.REV_TP_SRC_CD LIKE 'C%' ) 
                #end
			#end
       		GROUP BY P.RHQ_CD
         			, P.INV_OFC_CD
       	 			, P.BL_NO
         			, P.INV_NO
         			, Q.CHG_TP_CD
         			, Q.BL_CURR_CD
       		HAVING SUM(Q.BAL_AMT) != 0)
ORDER BY B.INV_OFC_CD			]]></sql>
			<params>
				<param name="rhq_cd" type="12" value="" out="N"/>
				<param name="rep_ots_ofc_cd" type="12" value="" out="N"/>
				<param name="ots_ofc_cd" type="12" value="" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
				<param name="inv_no" type="12" value="" out="N"/>
				<param name="bound_type" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
