<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="AccountPayableInvoiceDBDAOSearchInvoiceReceiptListRSQL">
			<desc><![CDATA[조건을 기준으로 전표 결재 이후에 지불 하기 위한 접수 대상인 Invoice Slip 내역 조회]]></desc>
			<sql><![CDATA[
SELECT  SIH.OFC_CD           AS OFC_CD
      , SIH.INV_NO           AS INV_NO
      , SIH.VNDR_NO          AS VNDR_NO
      , MV.VNDR_LGL_ENG_NM   AS VNDR_LGL_ENG_NM
      , SIH.INV_CURR_CD      AS INV_CURR_CD
      , TRIM(OPUSADM.SAP_GET_CUR_AMT_FNC(SIH.INV_CURR_CD, SIH.INV_AMT)) AS INV_AMT
      , SIH.INV_DESC         AS INV_DESC
      , SIH.AP_PAY_GRP_LU_CD AS AP_PAY_GRP_LU_CD
      , SPS.DUE_DT           AS DUE_DT
      , SIH.PAY_MZD_LU_CD    AS PAY_MZD_LU_CD
      , SIH.INV_TERM_NM      AS INV_TERM_NM
      , SIH.INV_DT           AS INV_DT
      , SIH.ATTR_CTNT13      AS INV_RCT_NO
      , SIH.CRE_DT           AS CRE_DT
      , SBB.BANK_NM          AS BANK_NM
      , SBB.BANK_BRNC_NM     AS BANK_BRNC_NM
      , SBA.BANK_ACCT_NO     AS BANK_ACCT_NO
      , SIH.INV_SEQ          AS INV_SEQ
      , SPS.PAY_STS_FLG      AS PAY_STS_FLG
      , SIH.GL_DT            AS GL_DT
      , SIH.CRE_USR_ID       AS USR_ID
      , SIH.AP_INV_SRC_CD    AS AP_INV_SRC_CD
FROM    SAP_INV_HDR SIH
      , SAP_PAY_SKD SPS
      , MDM_VENDOR MV
      , MDM_ORGANIZATION MO
      , SAP_BANK_ACCT SBA
      , SAP_BANK_BRNC SBB
WHERE   SIH.INV_SEQ = SPS.INV_SEQ
AND     SPS.ROWID = (SELECT  MAX(SPS2.ROWID)
                     FROM    SAP_PAY_SKD SPS2
                     WHERE   SPS2.INV_SEQ = SIH.INV_SEQ)
AND     TO_NUMBER(SIH.VNDR_NO) = MV.VNDR_SEQ
AND     SIH.OFC_CD = MO.OFC_CD 
AND     SIH.INV_CXL_DT IS NULL
AND     EXISTS (SELECT  'X' FROM SAP_INV_DTL SID WHERE SIH.INV_SEQ = SID.INV_SEQ AND MTCH_STS_FLG = 'A')
AND     NVL(SIH.ATTR_CTNT15, 'C') <> 'N'
AND     ((SIH.INV_NO LIKE '02%' AND SIH.ATTR_CTNT12 IS NOT NULL) OR (SIH.INV_NO NOT LIKE '02%' AND SIH.ATTR_CTNT15 = 'Y'))
AND     SPS.XTER_BANK_ACCT_SEQ = SBA.BANK_ACCT_SEQ(+)
AND     SBA.BANK_BRNC_SEQ = SBB.BANK_BRNC_SEQ(+)
AND     ((SIH.INV_AMT <> 0 AND (SELECT  NVL(SUM(SID.DTRB_AMT), 0)
                                FROM    SAP_INV_DTL SID
                                WHERE   SIH.INV_SEQ = SID.INV_SEQ 
                                AND     SID.LINE_TP_LU_CD <> 'PREPAY') <> 0) OR SIH.INV_AMT = 0 )
AND     SIH.OFC_CD = @[ofc_cd]
   AND  SIH.INV_DT BETWEEN TO_DATE(@[inv_dt_fm], 'YYYY-MM-DD') AND TO_DATE(@[inv_dt_to], 'YYYY-MM-DD') + 0.99999
#if (${gl_dt_fm} != '' && ${gl_dt_to} != '')
   AND  SIH.GL_DT BETWEEN TO_CHAR(TO_DATE(@[gl_dt_fm],'YYYY-MM-DD'),'YYYYMMDD') AND TO_CHAR(TO_DATE(@[gl_dt_to],'YYYY-MM-DD') + 0.99999,'YYYYMMDD')
#end
#if (${ap_pay_grp_lu_cd} != '')
   AND  SIH.AP_PAY_GRP_LU_CD = @[ap_pay_grp_lu_cd]
#end
#if (${inv_no} != '')
   AND  SIH.INV_NO = @[inv_no]
#end
#if (${vndr_no} != '')
   AND  SIH.VNDR_NO = @[vndr_no]
#end 
#if (${rct_flg} == 'N')
   AND  SIH.ATTR_CTNT13 IS NULL  -- Not Received
#else
   AND  SIH.ATTR_CTNT13 IS NOT NULL  -- Received
#end
#if (${curr_flg} == 'Y')
   AND  SIH.INV_CURR_CD = ( SELECT MO.AR_CURR_CD FROM MDM_ORGANIZATION MO WHERE MO.OFC_CD = @[ofc_cd] AND ROWNUM = 1)
#elseif (${curr_flg} == 'N')
   AND  SIH.INV_CURR_CD <> ( SELECT MO.AR_CURR_CD FROM MDM_ORGANIZATION MO WHERE MO.OFC_CD = @[ofc_cd] AND ROWNUM = 1)
#end
#if (${pay_sts_flg} != '')
   AND  SIH.PAY_STS_FLG = @[pay_sts_flg]   -- Y : PAID, N : UNPAID
#end
   AND  NVL(SIH.ATTR_CTNT15, 'N') = @[attr_ctnt15]   -- Y : Approve
			]]></sql>
			<params>
				<param name="ofc_cd" type="12" value="" out="N"/>
				<param name="inv_dt_fm" type="12" value="" out="N"/>
				<param name="inv_dt_to" type="12" value="" out="N"/>
				<param name="gl_dt_fm" type="12" value="" out="N"/>
				<param name="gl_dt_to" type="12" value="" out="N"/>
				<param name="ap_pay_grp_lu_cd" type="12" value="" out="N"/>
				<param name="inv_no" type="12" value="" out="N"/>
				<param name="vndr_no" type="12" value="" out="N"/>
				<param name="pay_sts_flg" type="12" value="" out="N"/>
				<param name="attr_ctnt15" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
