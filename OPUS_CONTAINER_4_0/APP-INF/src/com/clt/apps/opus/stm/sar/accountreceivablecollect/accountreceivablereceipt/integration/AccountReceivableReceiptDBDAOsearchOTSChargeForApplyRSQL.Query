<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="AccountReceivableReceiptDBDAOsearchOTSChargeForApplyRSQL">
			<desc><![CDATA[Apply 대상 OTS Charge 정보 조회]]></desc>
			<sql><![CDATA[
SELECT T.INV_OFC_CD OTS_OFC_CD 
       , P.BL_NO
       , P.INV_NO
       , P.CHG_TP_CD RCT_APLY_CHG_CD
       , P.BL_CURR_CD RCT_APLY_SRC_CURR_CD
	   , SAR_GET_FMT_MASK_FNC(P.BL_CURR_CD, NVL(SUM(P.BAL_AMT), 0)) OTS_BAL_AMT
	   , SAR_GET_FMT_MASK_FNC(P.BL_CURR_CD, NVL(SUM(P.BAL_AMT), 0)) OTS_APLY_AMT
       , DECODE(@[rct_curr_cd], R.OFC_CURR_CD, Q.LOCL_XCH_RT, 'USD', Q.USD_XCH_RT, DECODE(@[rct_curr_cd], P.BL_CURR_CD, 1, 0)) OTS_XCH_RT
	   , DECODE(@[rct_curr_cd], R.OFC_CURR_CD, Q.LOCL_XCH_RT, 'USD', Q.USD_XCH_RT, DECODE(@[rct_curr_cd], P.BL_CURR_CD, 1, 0)) RCT_APLY_XCH_RT
	   , @[rct_curr_cd] RCT_CURR_CD
	   , SAR_GET_FMT_MASK_FNC(@[rct_curr_cd], ROUND(NVL(SUM(P.BAL_AMT), 0) * NVL(DECODE(@[rct_curr_cd], R.OFC_CURR_CD, Q.LOCL_XCH_RT, 'USD', Q.USD_XCH_RT, DECODE(@[rct_curr_cd], P.BL_CURR_CD, 1, 0)), 0), (SELECT DP_PRCS_KNT FROM MDM_CURRENCY WHERE CURR_CD = @[rct_curr_cd]))) RCT_APLY_AMT
	   , SUM(ROUND(NVL(SUM(P.BAL_AMT), 0) * NVL(DECODE(@[rct_curr_cd], R.OFC_CURR_CD, Q.LOCL_XCH_RT, 'USD', Q.USD_XCH_RT, DECODE(@[rct_curr_cd], P.BL_CURR_CD, 1, 0)), 0), (SELECT DP_PRCS_KNT FROM MDM_CURRENCY WHERE CURR_CD = @[rct_curr_cd]))) OVER() TTL_APLY_AMT
	   , S.DP_PRCS_KNT
	   , T.INV_OFC_CD||P.BL_NO||P.INV_NO RCT_APLY_HDR_SEQ
	   , 'N' RCT_APLY_FLG
FROM SAR_OTS_CHG P,
     SAR_OTS_DTL Q,
     SAR_OTS_HDR R,
     SAR_OTS_HIS T,
     MDM_CURRENCY S
WHERE P.RHQ_CD = Q.RHQ_CD
AND P.OTS_OFC_CD = Q.OTS_OFC_CD
AND P.BL_NO = Q.BL_NO
AND P.INV_NO = Q.INV_NO
AND P.BL_CURR_CD = Q.BL_CURR_CD
AND P.CHG_TP_CD = Q.CHG_TP_CD
AND R.RHQ_CD = T.RHQ_CD
AND R.OTS_OFC_CD = T.OTS_OFC_CD
AND R.BL_NO = T.BL_NO
AND R.INV_NO = T.INV_NO  
AND P.OTS_HIS_SEQ = T.OTS_HIS_SEQ
AND P.BL_CURR_CD = S.CURR_CD
AND R.RHQ_CD = @[rhq_cd]
#if(${ots_cd} == 'COU')
    AND R.OTS_OFC_CD = @[rep_ots_ofc_cd]
#else
    AND R.OTS_OFC_CD = @[ots_ofc_cd]
#end
#if(${bl_no} != '')
    AND R.BL_NO = @[bl_no]
#end
#if(${ots_smry_cd} == 'INV')
    #if(${inv_no} != '')
        AND R.INV_NO = @[inv_no]
    #else
        AND R.INV_NO <> '**********'
    #end
#else
    #if(${inv_no} != '')
        AND R.INV_NO = @[inv_no]
    #else
        AND R.INV_NO = '**********'
    #end
#end
#if(${ots_srch_flg} == 'Y')
    AND T.INV_OFC_CD = @[ots_ofc_cd]
#end 
#if (${chg_tp_cd} != '')
    AND P.CHG_TP_CD = @[chg_tp_cd]
#end
#if (${bl_curr_cd} != '')
    AND P.BL_CURR_CD = @[bl_curr_cd]
#end


	#if (${local_chg_flag} == 'Y')
        #if (${invoice_type} == 'NFRT')
			#if (${bound_type} == 'L')
            AND T.REV_TP_SRC_CD IN ('MIV','MIC','MOS')
			AND (P.CHG_TP_CD IN (SELECT D.LU_CD
                                 FROM   SCO_LU_HDR H,  SCO_LU_DTL D
                                 WHERE  H.LU_TP_CD = D.LU_TP_CD
                                 AND    H.LU_APPL_CD = 'SAR'
                                 AND    D.LU_TP_CD = 'TH LOCAL CHARGE'
                                 AND    D.ENBL_FLG = 'Y') OR P.TJ_SRC_NM  = 'VAT')
			#else           
			AND T.REV_TP_SRC_CD LIKE 'M%' 
            AND T.REV_TP_SRC_CD NOT IN ('MDM','MDT')
			AND (P.CHG_TP_CD NOT IN (SELECT D.LU_CD
                                     FROM   SCO_LU_HDR H,  SCO_LU_DTL D
                                     WHERE  H.LU_TP_CD = D.LU_TP_CD
                                     AND    H.LU_APPL_CD = 'SAR'
                                     AND    D.LU_TP_CD = 'TH LOCAL CHARGE'
                                     AND    D.ENBL_FLG = 'Y'))  
            AND P.TJ_SRC_NM  != 'VAT'
            #end 
	    #else
        AND R.BKG_IO_BND_CD = @[bound_type]   
        AND ( T.REV_TP_SRC_CD IN ('MDM','MDT','MOS') OR T.REV_TP_SRC_CD LIKE 'B%' OR T.REV_TP_SRC_CD LIKE 'C%' )  
        #end
	#end



AND T.OTS_HIS_TP_CD = 'OTS'
AND R.STL_FLG = 'N'
GROUP BY T.INV_OFC_CD
       	 , P.BL_NO
         , P.INV_NO
         , P.CHG_TP_CD
         , P.BL_CURR_CD
		 , S.DP_PRCS_KNT
         , Q.USD_XCH_RT
         , Q.LOCL_XCH_RT
		 , R.OFC_CURR_CD
HAVING NVL(SUM(P.BAL_AMT), 0) != 0
ORDER BY P.CHG_TP_CD
       	 , P.BL_CURR_CD			]]></sql>
			<params>
				<param name="rct_curr_cd" type="12" value="" out="N"/>
				<param name="rhq_cd" type="12" value="" out="N"/>
				<param name="rep_ots_ofc_cd" type="12" value="" out="N"/>
				<param name="ots_ofc_cd" type="12" value="" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
				<param name="inv_no" type="12" value="" out="N"/>
				<param name="chg_tp_cd" type="12" value="" out="N"/>
				<param name="bl_curr_cd" type="12" value="" out="N"/>
				<param name="bound_type" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
