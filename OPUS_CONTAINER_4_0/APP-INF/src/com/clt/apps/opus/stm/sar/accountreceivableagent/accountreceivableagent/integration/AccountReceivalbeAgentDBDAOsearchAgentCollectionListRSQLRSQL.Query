<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="AccountReceivalbeAgentDBDAOsearchAgentCollectionListRSQLRSQL">
			<desc><![CDATA[Agent Collection List Inquiry]]></desc>
			<sql><![CDATA[
SELECT 
 ASA_NO         ,BL_NO      ,INV_NO  ,CHG_TP_CD      ,ASA_CLT_SEQ     , AR_OFC_CD
,VVD_CD         ,PORT_CD                    ,DECODE(SUM(USD_AMT),0,0,MAX(ASA_XCH_RT1)) ASA_XCH_RT1     ,@[asa_curr_cd] ASA_CURR_CD
,ASA_XCH_RT2    ,ASA_RMK    ,AGN_CD         ,SVC_SCP_CD      ,EFF_DT
,IB_OB_CD       ,MAX(GL_YRMON) GL_YRMON   ,@[asa_curr_cd] LOCL_CURR_CD   ,SAIL_ARR_DT     ,DUE_DT
,CASE WHEN SUM(TTL_AMT) >= 0 THEN 'C' ELSE 'R'  END  ASA_TP_CD
,SUM(TTL_AMT) TTL_AMT
,SUM(USD_AMT) USD_AMT
,SUM(CHG_USD_AMT) CHG_USD_AMT
,SUM(EQV_LOCL_AMT) EQV_LOCL_AMT
,SUM(LOCL_AMT) LOCL_AMT

,MIN (DECODE (RN, 1, N3RD_CURR_CD)) N3RD_CURR_CD1  ,MIN (DECODE (RN, 1, N3RD_AMT)) N3RD_AMT1 ,MIN (DECODE (RN, 1, N3RD_XCH_RT)) N3RD_XCH_RT1 ,MIN (DECODE (RN, 1, N3RD_LOCL_AMT)) N3RD_LOCL_AMT1
,MIN (DECODE (RN, 2, N3RD_CURR_CD)) N3RD_CURR_CD2  ,MIN (DECODE (RN, 2, N3RD_AMT)) N3RD_AMT2 ,MIN (DECODE (RN, 2, N3RD_XCH_RT)) N3RD_XCH_RT2 ,MIN (DECODE (RN, 2, N3RD_LOCL_AMT)) N3RD_LOCL_AMT2
,MIN (DECODE (RN, 3, N3RD_CURR_CD)) N3RD_CURR_CD3  ,MIN (DECODE (RN, 3, N3RD_AMT)) N3RD_AMT3 ,MIN (DECODE (RN, 3, N3RD_XCH_RT)) N3RD_XCH_RT3 ,MIN (DECODE (RN, 3, N3RD_LOCL_AMT)) N3RD_LOCL_AMT3
,MIN (DECODE (RN, 4, N3RD_CURR_CD)) N3RD_CURR_CD4  ,MIN (DECODE (RN, 4, N3RD_AMT)) N3RD_AMT4 ,MIN (DECODE (RN, 4, N3RD_XCH_RT)) N3RD_XCH_RT4 ,MIN (DECODE (RN, 4, N3RD_LOCL_AMT)) N3RD_LOCL_AMT4
,SUM(N3RD_LOCL_AMT) EQV_LOCL_AMT2

,'' OPTION1      ,'' OPTION2        ,'' ASA_NO1      ,'' ASA_NO2      ,'' ASA_NO3
,'' BND          ,'' GL_YRMON_FM	,'' GL_YRMON_TO	 ,'' DUE_DT_FM	  ,'' DUE_DT_TO
,@[usr_id] AS USR_ID
FROM 
(
SELECT 
@[asa_no1]||@[asa_no2]||@[asa_no3]                              ASA_NO           
,SOH.BL_NO                                                      BL_NO                        
,SOH.INV_NO                                                     INV_NO                        
,SOD.CHG_TP_CD                                                  CHG_TP_CD 
,''                                                             ASA_CLT_SEQ
,SOH.OTS_OFC_CD                                                 AR_OFC_CD      
,SOH.VSL_CD||SOH.SKD_VOY_NO ||SOH.DIR_CD                        VVD_CD     
,DECODE(SOH.BKG_IO_BND_CD, 'O', SOH.POL_CD, 'I', SOH.POD_CD)    PORT_CD  
,TO_CHAR(TO_DATE(SOH.DUE_DT,'YYYYMMDD'),'YYYY-MM-DD')           DUE_DT

 --ar_currency_code      SOH.OFC_CURR_CD
 --invoice_currency_code SOD.BL_CURR_CD 
,CASE WHEN TP.TTL_AMT >= 0 THEN 'C' ELSE 'R' END                ASA_TP_CD

,NVL(DECODE(SOD.BL_CURR_CD,'USD',SOD.BAL_LOCL_AMT,0),0) 
+ 
NVL(DECODE(SOD.BL_CURR_CD, 'USD',0,SOH.OFC_CURR_CD,SOD.BAL_LOCL_AMT),0)                                                    
+ 
NVL(DECODE(SOD.BL_CURR_CD,'USD',0,SOH.OFC_CURR_CD,0, SOD.BAL_LOCL_AMT),0)    
                                                                       TTL_AMT

,DECODE(SOD.BL_CURR_CD,'USD',SOD.BAL_AMT,0)                            USD_AMT         
,DECODE(SOD.BL_CURR_CD,'USD',LOCL_XCH_RT,0)  ASA_XCH_RT1
,NVL(DECODE(SOD.BL_CURR_CD,'USD',SOD.BAL_LOCL_AMT,0),0)  
                                                                       EQV_LOCL_AMT
 
,SOH.OFC_CURR_CD                                                       ASA_CURR_CD 
,NVL(DECODE(SOD.BL_CURR_CD,'USD',0,SOH.OFC_CURR_CD,SOD.BAL_AMT),0)     LOCL_AMT        

,1    
                                                                       ASA_XCH_RT2
          
, NVL(DECODE(SOD.BL_CURR_CD,'USD',0,SOH.OFC_CURR_CD,SOD.BAL_AMT),0)      
                                                                      CHG_USD_AMT          
,''                                         ASA_RMK 
,SOH.OTS_OFC_CD                             AGN_CD
,SOH.SVC_SCP_CD                             SVC_SCP_CD 
,SOH.SAIL_ARR_DT                            EFF_DT
,SOH.BKG_IO_BND_CD                          IB_OB_CD 
,SUBSTR(REPLACE(@[gl_yrmon_to],'-',''),1,6) GL_YRMON 
,SOH.OFC_CURR_CD                            LOCL_CURR_CD
,SOH.SAIL_ARR_DT                            SAIL_ARR_DT

,DECODE(SOD.BL_CURR_CD,'USD','',SOH.OFC_CURR_CD,'', SOD.BL_CURR_CD)     N3RD_CURR_CD   
,DECODE(SOD.BL_CURR_CD,'USD','',SOH.OFC_CURR_CD,'', SOD.BAL_AMT)        N3RD_AMT
,DECODE(SOD.BL_CURR_CD,'USD','',SOH.OFC_CURR_CD,'', SOD.LOCL_XCH_RT)    N3RD_XCH_RT

,DECODE(SOD.BL_CURR_CD,'USD','',SOH.OFC_CURR_CD,'', SOD.BAL_LOCL_AMT)
       																     N3RD_LOCL_AMT
       
,ROW_NUMBER () OVER (PARTITION BY SOH.BL_NO, SOH.INV_NO, SOD.CHG_TP_CD ORDER BY SOH.BL_NO, SOH.INV_NO,DECODE(SOD.BL_CURR_CD,'USD','ZZZ',SOH.OFC_CURR_CD,'ZZZ', SOD.BL_CURR_CD))             RN

FROM SAR_OTS_HDR SOH, 
     SAR_OTS_DTL SOD,
     MDM_CUSTOMER MC, 
     MDM_CR_CUST MCC,
     MDM_ORGANIZATION MO ,
 
     ( SELECT SOH.RHQ_CD, SOH.OTS_OFC_CD, SOH.BL_NO  , SOH.INV_NO, SOD.CHG_TP_CD
           ,SUM(NVL(DECODE(SOD.BL_CURR_CD,'USD',0,SOH.OFC_CURR_CD,SOD.BAL_AMT),0))   LOCL_AMT
           ,SUM(NVL(DECODE(SOD.BL_CURR_CD,'USD',SOD.BAL_LOCL_AMT,0) ,0)  )   EQV_LOCL_AMT 
           ,SUM(NVL(DECODE(SOD.BL_CURR_CD,'USD',0,SOH.OFC_CURR_CD,0, SOD.BAL_LOCL_AMT),0))  EQV_LOCL_AMT2
           ,SUM(
                 NVL(DECODE(SOD.BL_CURR_CD,'USD',SOD.BAL_LOCL_AMT,0),0) 
                   + 
                 NVL(DECODE(SOD.BL_CURR_CD, 'USD',0,SOH.OFC_CURR_CD,SOD.BAL_LOCL_AMT),0)     
                   + 
                 NVL(DECODE(SOD.BL_CURR_CD,'USD',0,SOH.OFC_CURR_CD,0, SOD.BAL_LOCL_AMT),0)
              )                     TTL_AMT
        FROM SAR_OTS_HDR SOH, 
             SAR_OTS_DTL SOD,
             MDM_ORGANIZATION MO
        WHERE 1=1
            AND SOH.RHQ_CD              = SOD.RHQ_CD
            AND SOH.OTS_OFC_CD          = SOD.OTS_OFC_CD
            AND SOH.BL_NO               = SOD.BL_NO 
            AND SOH.INV_NO              = SOD.INV_NO

            AND SOH.OTS_OFC_CD          = @[ar_ofc_cd]
            AND SOH.BL_NO               = NVL(@[bl_no],SOH.BL_NO)
            AND SOH.OTS_OFC_CD          = MO.OFC_CD
            
            AND EXISTS ( SELECT 'A' FROM SAR_OTS_HIS SOS WHERE 1=1 
                                     AND SOH.RHQ_CD              = SOS.RHQ_CD
                                     AND SOH.OTS_OFC_CD          = SOS.OTS_OFC_CD
                                     AND SOH.BL_NO               = SOS.BL_NO 
                                     AND SOH.INV_NO              = SOS.INV_NO
                                     AND SOS.OTS_HIS_TP_CD       = 'OTS'
                                     AND SUBSTR(SOS.GL_DT,1,6)  <= SUBSTR(REPLACE(@[gl_yrmon_to],'-',''),1,6) )
      GROUP BY SOH.RHQ_CD, SOH.OTS_OFC_CD, SOH.BL_NO,SOH.INV_NO, SOD.CHG_TP_CD
       ) TP
WHERE 1=1
AND SOH.RHQ_CD              = SOD.RHQ_CD            
AND SOH.OTS_OFC_CD          = SOD.OTS_OFC_CD
AND SOH.BL_NO               = SOD.BL_NO 
AND SOH.INV_NO              = SOD.INV_NO

AND SOH.BIL_TO_CUST_CNT_CD  = MC.CUST_CNT_CD
AND SOH.BIL_TO_CUST_SEQ     = MC.CUST_SEQ  
AND MC.CUST_CNT_CD          = MCC.CUST_CNT_CD  (+)
AND MC.CUST_SEQ             = MCC.CUST_SEQ  (+)
AND SOH.OTS_OFC_CD          = @[ar_ofc_cd]

AND SOH.BL_NO               = NVL(@[bl_no],SOH.BL_NO)
AND SOH.OTS_OFC_CD          = MO.OFC_CD 

AND SOH.RHQ_CD              = TP.RHQ_CD
AND SOH.OTS_OFC_CD          = TP.OTS_OFC_CD
AND SOH.BL_NO               = TP.BL_NO 
AND SOH.INV_NO               = TP.INV_NO
AND SOD.CHG_TP_CD           = TP.CHG_TP_CD 
AND ( ( NVL(TP.LOCL_AMT, 0) <> 0)    OR   ( NVL(TP.EQV_LOCL_AMT, 0) <> 0)  OR     ( NVL(TP.EQV_LOCL_AMT2, 0) <> 0) )
AND SOH.REV_TP_SRC_CD != 'ASA'

#if (${option2} == 'V' )       
    #if ( ${bnd} != 'ALL'  ) 
       AND SOH.BKG_IO_BND_CD  =  @[bnd] 
    #end
    
    #if ( ${vvd_cd} != '' )
       AND SOH.VSL_CD||SOH.SKD_VOY_NO ||SOH.DIR_CD = @[vvd_cd]
    #end  
    
    #if ( ${svc_scp_cd} != '' )
      AND SOH.SVC_SCP_CD = @[svc_scp_cd]
    #end  
    
    #if ( ${port_cd} != '' )
      AND DECODE(SOH.BKG_IO_BND_CD, 'O', SOH.POL_CD, 'I', SOH.POD_CD) = @[port_cd]
    #end  
    
#elseif ( ${option2} == 'D' )
    
    #if ( ${due_dt_fm} != '' )
         AND SOH.DUE_DT >=  REPLACE(@[due_dt_fm],'-','')       
    #end                   
    #if ( ${due_dt_to} != '' )
         AND SOH.DUE_DT <=  REPLACE(@[due_dt_to],'-','')       
    #end                           
    
#end


)
GROUP BY  
 ASA_NO         ,BL_NO      ,INV_NO   ,CHG_TP_CD      ,ASA_CLT_SEQ     ,AR_OFC_CD
,VVD_CD         ,PORT_CD    ,ASA_CURR_CD
,ASA_XCH_RT2    ,ASA_RMK    ,AGN_CD         ,SVC_SCP_CD      ,EFF_DT
,IB_OB_CD          ,LOCL_CURR_CD   ,SAIL_ARR_DT     ,DUE_DT
#if (${option1} == 'C' )
	HAVING SUM(TTL_AMT) >= 0 
#elseif (${option1} == 'R' )
    HAVING SUM(TTL_AMT) < 0 
#end
ORDER BY ASA_NO         ,BL_NO      ,INV_NO   ,CHG_TP_CD			]]></sql>
			<params>
				<param name="asa_curr_cd" type="12" value="" out="N"/>
				<param name="usr_id" type="12" value="" out="N"/>
				<param name="asa_no1" type="12" value="" out="N"/>
				<param name="asa_no2" type="12" value="" out="N"/>
				<param name="asa_no3" type="12" value="" out="N"/>
				<param name="gl_yrmon_to" type="12" value="" out="N"/>
				<param name="ar_ofc_cd" type="12" value="" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
				<param name="bnd" type="12" value="" out="N"/>
				<param name="vvd_cd" type="12" value="" out="N"/>
				<param name="svc_scp_cd" type="12" value="" out="N"/>
				<param name="port_cd" type="12" value="" out="N"/>
				<param name="due_dt_fm" type="12" value="" out="N"/>
				<param name="due_dt_to" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
