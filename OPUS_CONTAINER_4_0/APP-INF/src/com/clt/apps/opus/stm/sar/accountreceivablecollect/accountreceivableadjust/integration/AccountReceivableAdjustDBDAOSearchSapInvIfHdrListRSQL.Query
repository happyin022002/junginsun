<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="AccountReceivableAdjustDBDAOSearchSapInvIfHdrListRSQL">
			<desc><![CDATA[Retrieve AP INTERFACE Header Info]]></desc>
			<sql><![CDATA[
#if(${sys_tp_cd} == 'ADJ')

SELECT 
       #if(${rvs_flg} == 'N')
            CASE WHEN SIGN(SUM(SAD.ADJ_CRS_CURR_AMT) + MAX(SAH.GAIN_AND_LSS_AMT)) = -1 THEN
                    OPUSADM.SAP_GEN_INV_NUM_FNC ('02','C',@[usr_id],SAH.AP_OFC_CD)
                 ELSE
                    OPUSADM.SAP_GEN_INV_NUM_FNC ('02','S',@[usr_id],SAH.AP_OFC_CD)
            END AS INV_NO,
       #else
            CASE WHEN SIGN(SUM(SAD.ADJ_CRS_CURR_AMT) + MAX(SAH.GAIN_AND_LSS_AMT)) = 1 THEN
                    OPUSADM.SAP_GEN_INV_NUM_FNC ('02','C',@[usr_id],SAH.AP_OFC_CD)
                 ELSE
                    OPUSADM.SAP_GEN_INV_NUM_FNC ('02','S',@[usr_id],SAH.AP_OFC_CD)
            END AS INV_NO,
       #end 
       
       #if(${rvs_flg} == 'N')
            DECODE(SIGN(SUM(SAD.ADJ_CRS_CURR_AMT) + MAX(SAH.GAIN_AND_LSS_AMT)),-1, 'CREDIT','STANDARD') AS INV_TP_LU_CD,
       #else
            DECODE(SIGN(SUM(SAD.ADJ_CRS_CURR_AMT) + MAX(SAH.GAIN_AND_LSS_AMT)),1, 'CREDIT','STANDARD') AS INV_TP_LU_CD,
       #end
       
       (
          SELECT MAX(ADJ_APLY_DT) 
          FROM SAR_ADJ_HIS SAHH
          WHERE SAHH.ADJ_NO = SAH.ADJ_NO
       ) AS INV_DT,
       SAH.VNDR_NO AS VNDR_NO,
       
       #if(${rvs_flg} == 'N')
            SUM(SAD.ADJ_CRS_CURR_AMT) AS INV_AMT, 
       #else
            (-1) * SUM(SAD.ADJ_CRS_CURR_AMT) AS INV_AMT,
       #end
       
       SAD.ADJ_CRS_CURR_CD AS INV_CURR_CD,
       
       #if(${ap_curr_cd} == ${func_curr_cd} )
            1 AS INV_XCH_RT,
            NULL AS INV_XCH_RT_TP_CD,
       #else
            (SELECT ROUND(GLXR.CONV_XCH_RT, 6) AS CONV_XCH_RT
              FROM GL_DLY_XCH_RT GLXR 
              WHERE GLXR.ACCT_XCH_RT_DT = @[ap_gl_dt]
              AND GLXR.FM_CURR_CD = @[ap_curr_cd]
              AND GLXR.TO_CURR_CD = @[func_curr_cd]) AS INV_XCH_RT,
            1 AS INV_XCH_RT_TP_CD,
       #end 
       
       @[ap_gl_dt] AS INV_XCH_DT,
       MV.GEN_PAY_TERM_CD AS INV_TERM_NM,
       SAH.AP_RMK AS INV_DESC, 
       'Refund' AS ATTR_CATE_NM,
       NULL AS ATTR_CTNT2,
       SAH.ADJ_NO AS ATTR_CTNT4,
       NULL AS ATTR_CTNT7,
       'NEW' AS INV_IF_STS_CD,
       'AR' AS IF_SRC_NM,
       SAD.ADJ_CRS_CURR_CD AS INV_PAY_CURR_CD,
       MV.PAY_MZD_CD AS AP_PAY_MZD_LU_CD,
       MO.AP_OFC_CD || '_O/EXP' AS PAY_GRP_LU_CD,
       (
          SELECT MAX(ADJ_APLY_DT) 
          FROM SAR_ADJ_HIS SAHH
          WHERE SAHH.ADJ_NO = SAH.ADJ_NO
       ) AS INV_RCV_DT,
       @[ap_gl_dt] AS GL_DT,
       SAH.AP_OFC_CD AS OFC_CD,  
       (
          SELECT MAX(ADJ_APLY_DT) 
          FROM SAR_ADJ_HIS SAHH
          WHERE SAHH.ADJ_NO = SAH.ADJ_NO
       ) AS INV_TERM_DT,     
       '01' AS CO_CD,
       MO.FINC_RGN_CD AS CNT_CD,
       MO.AP_CTR_CD AS CTR_CD,
       DECODE(NVL(MV.INTER_CO_FLG,'N'), 'Y',NVL(MV.SUBS_CO_CD,'00'),'00') AS INTER_CO_CD
FROM SAR_ADJ_HDR SAH, 
     SAR_ADJ_DTL SAD,
     MDM_ORGANIZATION MO,
     MDM_VENDOR MV
WHERE SAH.OTS_ADJ_SEQ = SAD.OTS_ADJ_SEQ
AND SAH.ADJ_NO = @[adj_no]
AND MO.OFC_CD = SAH.AP_OFC_CD
AND MV.VNDR_SEQ = SAH.VNDR_NO 
GROUP BY SAH.ADJ_NO,  
       SAH.ADJ_TP_CD, 
       SAH.BIL_TO_CUST_CNT_CD,
       SAH.BIL_TO_CUST_SEQ, 
       SAD.ADJ_CRS_CURR_CD, 
       SAH.VNDR_NO, 
       SAH.AP_OFC_CD, 
       -- 2016.01.18 block DECODE(SIGN(SAD.ADJ_AMT),-1, 'CREDIT','STANDARD'),
	   MV.GEN_PAY_TERM_CD,
       SAH.AP_RMK,
       DECODE(NVL(MV.INTER_CO_FLG,'N'), 'Y',NVL(MV.SUBS_CO_CD,'00'),'00'),
       MO.FINC_RGN_CD,
       MO.AP_CTR_CD,
       MV.PAY_MZD_CD,
       MO.AP_OFC_CD
#elseif(${sys_tp_cd} == 'OFF')

SELECT           
       #if(${rvs_flg} == 'N')
           SUM(SOM.OFFST_XCH_AMT) * (-1)  AS INV_AMT, 
       #else
           SUM(SOM.OFFST_XCH_AMT)  AS INV_AMT,
       #end
       @[ap_gl_dt] AS INV_DT,
       SOM.VNDR_NO AS VNDR_NO,
       SOM.OFFST_CURR_CD AS INV_CURR_CD,
       #if(${ap_curr_cd} == ${func_curr_cd} )
            1 AS INV_XCH_RT,
            NULL AS INV_XCH_RT_TP_CD,
       #else
            (SELECT ROUND(GLXR.CONV_XCH_RT, 6) AS CONV_XCH_RT
              FROM GL_DLY_XCH_RT GLXR 
              WHERE GLXR.ACCT_XCH_RT_DT = @[ap_gl_dt]
              AND GLXR.FM_CURR_CD = @[ap_curr_cd]
              AND GLXR.TO_CURR_CD = @[func_curr_cd]) AS INV_XCH_RT,
              '1' AS INV_XCH_RT_TP_CD,
       #end
       @[ap_gl_dt] AS INV_XCH_DT,
       MV.GEN_PAY_TERM_CD AS INV_TERM_NM,
       'ARAP CLEARING ' ||SOM.AP_RMK||' '||SOM.AR_OFFST_NO AS INV_DESC,
       'AR AP Offset' AS ATTR_CATE_NM,
       SOM.AR_OFFST_NO AS ATTR_CTNT2,
       NULL AS ATTR_CTNT4,
       NULL AS ATTR_CTNT7,
       'NEW' AS INV_IF_STS_CD,
       'AR' AS IF_SRC_NM,
       SOM.OFFST_CURR_CD AS INV_PAY_CURR_CD,
       MV.PAY_MZD_CD AS AP_PAY_MZD_LU_CD,
       MO.AP_OFC_CD || '_O/EXP' AS PAY_GRP_LU_CD,
       (
          SELECT MAX(ADJ_APLY_DT) 
          FROM SAR_ADJ_HIS SAHH
          WHERE SAHH.ADJ_NO = SOM.AR_OFFST_NO
       )  AS INV_RCV_DT,
       @[ap_gl_dt] AS GL_DT,
       SOM.OFC_CD AS OFC_CD,       
       MAX(SOM.AP_INV_TERM_DT) AS INV_TERM_DT,
       '01' AS CO_CD,
       --변경
       --MO.FINC_RGN_CD AS CNT_CD,
       --MO.AP_CTR_CD AS CTR_CD,
       --DECODE(NVL(MV.INTER_CO_FLG,'N'), 'Y',NVL(MV.SUBS_CO_CD,'00'),'00') AS INTER_CO_CD
       SLC.SGM_CTNT2 CNT_CD,
       SLC.SGM_CTNT3 CTR_CD,
       SLC.SGM_CTNT5 INTER_CO_CD,
       --추가
       SLC.SGM_CTNT6 VVD_CD 
FROM SAR_OFFST_MST SOM, 
     MDM_ORGANIZATION MO,
     MDM_VENDOR MV,
     --추가
     SAP_INV_HDR   SIH,
     SCO_LEGR_CD_CMB SLC
WHERE SOM.AR_OFFST_NO = @[adj_no]
AND MO.OFC_CD = SOM.OFC_CD
AND MV.VNDR_SEQ = SOM.VNDR_NO 
--추가
AND   SOM.AP_INV_NO = SIH.INV_NO
AND   SIH.LIAB_CD_CMB_SEQ = SLC.CD_CMB_SEQ
AND SOM.OFFST_TP_CD = 'AP'
GROUP BY SOM.VNDR_NO,
       SOM.OFFST_CURR_CD,
          MV.GEN_PAY_TERM_CD,
       'ARAP CLEARING ' ||SOM.AP_RMK||' '||SOM.AR_OFFST_NO,
       SOM.AR_OFFST_NO,
       SOM.OFFST_CURR_CD,
       SOM.OFC_CD,
       '01',
       --변경
       --MO.FINC_RGN_CD,
       --MO.AP_CTR_CD,
       --DECODE(NVL(MV.INTER_CO_FLG,'N'), 'Y',NVL(MV.SUBS_CO_CD,'00'),'00')
       SLC.SGM_CTNT2,
       SLC.SGM_CTNT3,
       SLC.SGM_CTNT5,
       --추가
       SLC.SGM_CTNT6,
       MV.PAY_MZD_CD,
       MO.AP_OFC_CD
#end			]]></sql>
			<params>
				<param name="usr_id" type="12" value="" out="N"/>
				<param name="ap_gl_dt" type="12" value="" out="N"/>
				<param name="ap_curr_cd" type="12" value="" out="N"/>
				<param name="func_curr_cd" type="12" value="" out="N"/>
				<param name="adj_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
