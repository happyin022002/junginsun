<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="AccountReceivableOutstandingDBDAOsearchApplyOutstandingListRSQL">
			<desc><![CDATA[Apply 대상 OTS 정보 조회]]></desc>
			<sql><![CDATA[
SELECT RHQ_CD
       , OTS_OFC_CD
       , BL_NO 
       , BKG_NO
       , INV_NO
       , OTS_SRC_CD
       , BIL_TO_CUST_CNT_CD
       , BIL_TO_CUST_SEQ
       , BIL_TO_CUST_CD
       , CUST_NM
       , SHP_TO_CUST_CNT_CD
       , SHP_TO_CUST_SEQ   
       , SHP_TO_CUST_CD
       , LOCL_VVD_CD
       , CHG_TP_CD
       , BL_CURR_CD
	   , SAR_GET_FMT_MASK_FNC(BL_CURR_CD, NVL(SUM(BAL_AMT), 0)) OTS_BAL_AMT
       , SAR_GET_FMT_MASK_FNC(OFC_CURR_CD, SUM(LOCL_BAL_AMT)) LOCL_BAL_AMT
       , SAR_GET_FMT_MASK_FNC('USD', SUM(USD_BAL_AMT)) USD_BAL_AMT
       , DUE_DT
       , OVER_DUE
	   , OTS_RMK
	   , OTS_SMRY_CD
	   , OTS_CD
	   , REP_OTS_OFC_CD    
       , RCT_APLY_HDR_SEQ
       , RCT_APLY_FLG
       , OFC_CD
       , TRNK_VVD_CD
       , SAIL_ARR_DT
       , IO_BND_CD
       , SREP_CD
       , XCH_RT_TP_CD
       , XCH_RT_DT
       , CR_FLG
       , AR_FINC_SRC_CD
       , MAX_AR_IF_NO
       , INV_DT
       , RCT_APLY_CHG_CD
       , RCT_APLY_SRC_CURR_CD
       , NVL(SUM(BAL_AMT), 0) OTS_APLY_AMT
       , OTS_XCH_RT
	   , RCT_APLY_XCH_RT
       , RCT_CURR_CD
       , ROUND(NVL(SUM(BAL_AMT), 0) * NVL(DECODE(@[rct_curr_cd], OFC_CURR_CD, LOCL_XCH_RT, 'USD', USD_XCH_RT, DECODE(@[rct_curr_cd], BL_CURR_CD, 1, 0)), 0), (SELECT DP_PRCS_KNT FROM MDM_CURRENCY WHERE CURR_CD = @[rct_curr_cd])) RCT_APLY_AMT
       , DP_PRCS_KNT
	   , HDR_DUP_FLG
FROM (
        SELECT Q.RHQ_CD
               , S.INV_OFC_CD OTS_OFC_CD
               , Q.BL_NO 
               , Q.BKG_NO
               , Q.INV_NO
               , S.OTS_SRC_CD
               , Q.BIL_TO_CUST_CNT_CD
               , Q.BIL_TO_CUST_SEQ
               , Q.BIL_TO_CUST_CNT_CD||'-'||LPAD(Q.BIL_TO_CUST_SEQ, 6, '0') BIL_TO_CUST_CD
               , NVL(U.LOCL_NM, T.CUST_LGL_ENG_NM) CUST_NM
               , Q.SHP_TO_CUST_CNT_CD
               , Q.SHP_TO_CUST_SEQ   
               , Q.SHP_TO_CUST_CNT_CD||'-'||LPAD(Q.SHP_TO_CUST_SEQ, 6, '0') SHP_TO_CUST_CD
               , Q.VSL_CD||Q.SKD_VOY_NO||Q.DIR_CD LOCL_VVD_CD
               , P.CHG_TP_CD
               , P.BL_CURR_CD
               , P.BAL_AMT
               , ROUND(NVL(P.BAL_AMT, 0) * NVL(R.LOCL_XCH_RT, 0), V.DP_PRCS_KNT) LOCL_BAL_AMT
               , ROUND(NVL(P.BAL_AMT, 0) * NVL(R.USD_XCH_RT, 0), 2) USD_BAL_AMT
               , Q.DUE_DT
               , TO_DATE(REPLACE(@[as_of_date], '-', ''), 'YYYYMMDD') - TO_DATE(Q.DUE_DT, 'YYYYMMDD') OVER_DUE
               , Q.OTS_RMK
               , @[ots_smry_cd] OTS_SMRY_CD
               , @[ots_cd] OTS_CD
               , @[rep_ots_ofc_cd] REP_OTS_OFC_CD    
               , S.INV_OFC_CD||Q.BL_NO||Q.INV_NO RCT_APLY_HDR_SEQ
               , 'N' RCT_APLY_FLG
               , Q.OTS_OFC_CD OFC_CD
               , Q.TRNK_VVD_CD
               , Q.SAIL_ARR_DT
               , Q.BKG_IO_BND_CD IO_BND_CD
               , Q.CUST_SREP_CD SREP_CD
               , Q.XCH_RT_TP_CD
               , Q.XCH_RT_DT
               , Q.CR_MK_FLG CR_FLG
               , Q.OTS_SRC_CD AR_FINC_SRC_CD
               , Q.MAX_AR_IF_NO
               , Q.INV_DT
               , P.CHG_TP_CD RCT_APLY_CHG_CD
               , P.BL_CURR_CD RCT_APLY_SRC_CURR_CD
               , DECODE(@[rct_curr_cd], Q.OFC_CURR_CD, R.LOCL_XCH_RT, 'USD', R.USD_XCH_RT, DECODE(@[rct_curr_cd], P.BL_CURR_CD, 1, 0)) OTS_XCH_RT
               , DECODE(@[rct_curr_cd], Q.OFC_CURR_CD, R.LOCL_XCH_RT, 'USD', R.USD_XCH_RT, DECODE(@[rct_curr_cd], P.BL_CURR_CD, 1, 0)) RCT_APLY_XCH_RT
               , @[rct_curr_cd] RCT_CURR_CD
               , Q.OFC_CURR_CD
               , R.LOCL_XCH_RT
               , R.USD_XCH_RT
               , (SELECT DP_PRCS_KNT FROM MDM_CURRENCY WHERE CURR_CD = P.BL_CURR_CD) DP_PRCS_KNT
            #if (${ots_dtl_flg} == 'Y') 
               , NVL((SELECT 'Y'
                      FROM SAR_OTS_RCT_TMP
                      WHERE OTS_RCT_TMP_SEQ = @[ots_rct_tmp_seq]
                      AND RCT_APLY_HDR_NO = S.INV_OFC_CD||Q.BL_NO||Q.INV_NO
                      AND RCT_APLY_FLG = 'N'
                      AND ROWNUM = 1), 'N') HDR_DUP_FLG
            #else
               , 'N' HDR_DUP_FLG
            #end
               , SUM(NVL(P.BAL_AMT, 0)) OVER (PARTITION BY S.INV_OFC_CD, Q.BL_NO, Q.BIL_TO_CUST_CNT_CD, Q.BIL_TO_CUST_SEQ, Q.VSL_CD, Q.SKD_VOY_NO, Q.DIR_CD, P.BL_CURR_CD) OFFSET_AMT
        FROM SAR_OTS_CHG P,
             SAR_OTS_HDR Q,
             SAR_OTS_DTL R,
             SAR_OTS_HIS S,
             MDM_CUSTOMER T,
             MDM_CR_CUST U,
             MDM_CURRENCY V
        WHERE P.RHQ_CD = Q.RHQ_CD
        AND P.OTS_OFC_CD = Q.OTS_OFC_CD
        AND P.BL_NO = Q.BL_NO
        AND P.INV_NO = Q.INV_NO
        AND P.RHQ_CD = R.RHQ_CD
        AND P.OTS_OFC_CD = R.OTS_OFC_CD
        AND P.BL_NO = R.BL_NO
        AND P.INV_NO = R.INV_NO
        AND P.BL_CURR_CD = R.BL_CURR_CD
        AND P.CHG_TP_CD = R.CHG_TP_CD
        AND Q.RHQ_CD = S.RHQ_CD
        AND Q.OTS_OFC_CD = S.OTS_OFC_CD
        AND Q.BL_NO = S.BL_NO
        AND Q.INV_NO = S.INV_NO   
        AND P.OTS_HIS_SEQ = S.OTS_HIS_SEQ
        AND Q.BIL_TO_CUST_CNT_CD = T.CUST_CNT_CD
        AND Q.BIL_TO_CUST_SEQ = T.CUST_SEQ
        AND Q.BIL_TO_CUST_CNT_CD = U.CUST_CNT_CD(+)
        AND Q.BIL_TO_CUST_SEQ = U.CUST_SEQ(+)
        AND Q.OFC_CURR_CD = V.CURR_CD
        AND Q.RHQ_CD = @[rhq_cd]
        #if(${ots_cd} == 'COU')
            AND Q.OTS_OFC_CD = @[rep_ots_ofc_cd]
        #else
            AND Q.OTS_OFC_CD = @[ofc_cd]
        #end
        #if (${bil_to_cust_cnt_cd} != '' )
            AND Q.BIL_TO_CUST_CNT_CD = @[bil_to_cust_cnt_cd]
        #end
        #if (${bil_to_cust_seq} != '') 
            AND Q.BIL_TO_CUST_SEQ = @[bil_to_cust_seq]
        #end   
        #if (${vvd_cd1} != '' || ${vvd_cd2} != '' || ${vvd_cd3} != '' || ${vvd_cd4} != '' || ${vvd_cd5} != '' || ${vvd_cd6} != '' || ${vvd_cd7} != '' ||
             ${vvd_cd8} != '' || ${vvd_cd9} != '' || ${vvd_cd10} != '' || ${vvd_cd11} != '' || ${vvd_cd12} != '' || ${vvd_cd13} != '' || ${vvd_cd14} != '') 
            AND Q.VSL_CD||Q.SKD_VOY_NO||Q.DIR_CD IN (@[vvd_cd1], @[vvd_cd2], @[vvd_cd3], @[vvd_cd4], @[vvd_cd5], @[vvd_cd6], @[vvd_cd7], @[vvd_cd8], @[vvd_cd9], @[vvd_cd10], @[vvd_cd11], @[vvd_cd12], @[vvd_cd13], @[vvd_cd14])
        #end


            #if (${local_chg_flag} == 'Y')
                #if (${invoice_type} == 'NFRT')
                    #if (${bkg_io_bnd_cd} == 'L')
                    AND S.REV_TP_SRC_CD IN ('MIV','MIC','MOS')
                    AND (P.CHG_TP_CD IN ( SELECT D.LU_CD
                                          FROM   SCO_LU_HDR H,  SCO_LU_DTL D
                                          WHERE  H.LU_TP_CD = D.LU_TP_CD
                                          AND    H.LU_APPL_CD = 'SAR'
                                          AND    D.LU_TP_CD = 'TH LOCAL CHARGE'
                                          AND    D.ENBL_FLG = 'Y') 
                         OR P.TJ_SRC_NM  = 'VAT')
                    #else  
                    AND S.REV_TP_SRC_CD LIKE 'M%'          
                    AND S.REV_TP_SRC_CD NOT IN ('MDM','MDT')
                    AND (P.CHG_TP_CD NOT IN ( SELECT D.LU_CD
                                              FROM   SCO_LU_HDR H,  SCO_LU_DTL D
                                              WHERE  H.LU_TP_CD = D.LU_TP_CD
                                              AND    H.LU_APPL_CD = 'SAR'
                                              AND    D.LU_TP_CD = 'TH LOCAL CHARGE'
                                              AND    D.ENBL_FLG = 'Y'
                                             )
                        )  
                    AND P.TJ_SRC_NM  != 'VAT'
                    #end 
                #else
                AND Q.BKG_IO_BND_CD = @[bkg_io_bnd_cd]   
                AND ( S.REV_TP_SRC_CD IN ('MDM','MDT','MOS') OR S.REV_TP_SRC_CD LIKE 'B%' OR S.REV_TP_SRC_CD LIKE 'C%' )  
                #end
            #else
                #if (${bkg_io_bnd_cd} != 'A') 
                AND Q.BKG_IO_BND_CD = @[bkg_io_bnd_cd]       
                #end
            #end



        #if (${over_due_fm} != '')
            AND TO_DATE(REPLACE(@[as_of_date], '-', ''), 'YYYYMMDD') - TO_DATE(Q.DUE_DT, 'YYYYMMDD') >= @[over_due_fm]    
        #end
        #if (${over_due_to} != '')
            AND TO_DATE(REPLACE(@[as_of_date], '-', ''), 'YYYYMMDD') - TO_DATE(Q.DUE_DT, 'YYYYMMDD') <= @[over_due_to]    
        #end
        #if (${ots_src_cd} != '')
            AND S.OTS_SRC_CD = @[ots_src_cd]
        #end
        #if (${if_from_dt} != '')
            AND TO_CHAR(S.IF_DT, 'YYYYMMDD') >= REPLACE(@[if_from_dt], '-', '')
        #end
        #if (${if_to_dt} != '')
            AND TO_CHAR(S.IF_DT, 'YYYYMMDD') <= REPLACE(@[if_to_dt], '-', '')
        #end 
        #if (${bl_no1} != '' || ${bl_no2} != '' || ${bl_no3} != '' || ${bl_no4} != '' || ${bl_no5} != '' || ${bl_no6} != '' || ${bl_no7} != '') 
            #if(${ots_smry_cd} == 'INV')
                AND Q.INV_NO IN (@[bl_no1], @[bl_no2], @[bl_no3], @[bl_no4], @[bl_no5], @[bl_no6], @[bl_no7])
            #else
                AND Q.BL_NO IN (@[bl_no1], @[bl_no2], @[bl_no3], @[bl_no4], @[bl_no5], @[bl_no6], @[bl_no7])
            #end
        #end    
        #if(${ots_smry_cd} == 'INV')
            AND Q.INV_NO <> '**********'
        #else
            AND Q.INV_NO = '**********'
        #end
        #if (${chg_tp_cd} != '')
            AND P.CHG_TP_CD = @[chg_tp_cd]
        #end
        #if (${tj_src_nm} != '')    	
            AND P.TJ_SRC_NM = @[tj_src_nm]
        #end
        AND S.OTS_HIS_TP_CD = 'OTS'
        AND Q.STL_FLG = 'N'
        #if (${ots_dtl_flg} == 'Y')   
        AND NOT EXISTS (SELECT 'X'
                        FROM SAR_OTS_RCT_TMP
                        WHERE OTS_RCT_TMP_SEQ = @[ots_rct_tmp_seq]
                        AND RCT_APLY_HDR_NO = S.INV_OFC_CD||Q.BL_NO||Q.INV_NO
                        AND RCT_APLY_CHG_CD = P.CHG_TP_CD 
                        AND RCT_APLY_SRC_CURR_CD = P.BL_CURR_CD
                        AND RCT_APLY_FLG = 'N')
        #end
)
#if (${ofst_chk} == 'Y')  
    WHERE OFFSET_AMT = 0
#end
GROUP BY RHQ_CD
       , OTS_OFC_CD
       , BL_NO
       , BKG_NO
       , INV_NO
       , OTS_SRC_CD
       , BIL_TO_CUST_CNT_CD
       , BIL_TO_CUST_SEQ
       , BIL_TO_CUST_CD
       , CUST_NM
       , SHP_TO_CUST_CNT_CD
       , SHP_TO_CUST_SEQ   
       , SHP_TO_CUST_CD
       , LOCL_VVD_CD
       , CHG_TP_CD
       , BL_CURR_CD
       , OFC_CURR_CD
       , DUE_DT
       , OVER_DUE
	   , OTS_RMK
       , OTS_SMRY_CD
	   , OTS_CD
	   , REP_OTS_OFC_CD
       , RCT_APLY_HDR_SEQ
       , RCT_APLY_FLG
       , OFC_CD
       , TRNK_VVD_CD
       , SAIL_ARR_DT
       , IO_BND_CD
       , SREP_CD
       , XCH_RT_TP_CD
       , XCH_RT_DT
       , CR_FLG
       , AR_FINC_SRC_CD
       , MAX_AR_IF_NO
       , INV_DT
       , LOCL_XCH_RT
       , USD_XCH_RT
       , RCT_APLY_CHG_CD
       , RCT_APLY_SRC_CURR_CD
       , OTS_XCH_RT
	   , RCT_APLY_XCH_RT
       , RCT_CURR_CD
       , DP_PRCS_KNT
	   , HDR_DUP_FLG
HAVING NVL(SUM(BAL_AMT), 0) != 0
ORDER BY OTS_OFC_CD
         , BL_NO
         , INV_NO
         , CHG_TP_CD
         , BL_CURR_CD			]]></sql>
			<params>
				<param name="rct_curr_cd" type="12" value="" out="N"/>
				<param name="as_of_date" type="12" value="" out="N"/>
				<param name="ots_smry_cd" type="12" value="" out="N"/>
				<param name="ots_cd" type="12" value="" out="N"/>
				<param name="rep_ots_ofc_cd" type="12" value="" out="N"/>
				<param name="ots_rct_tmp_seq" type="12" value="" out="N"/>
				<param name="rhq_cd" type="12" value="" out="N"/>
				<param name="ofc_cd" type="12" value="" out="N"/>
				<param name="bil_to_cust_cnt_cd" type="12" value="" out="N"/>
				<param name="bil_to_cust_seq" type="12" value="" out="N"/>
				<param name="vvd_cd1" type="12" value="" out="N"/>
				<param name="vvd_cd2" type="12" value="" out="N"/>
				<param name="vvd_cd3" type="12" value="" out="N"/>
				<param name="vvd_cd4" type="12" value="" out="N"/>
				<param name="vvd_cd5" type="12" value="" out="N"/>
				<param name="vvd_cd6" type="12" value="" out="N"/>
				<param name="vvd_cd7" type="12" value="" out="N"/>
				<param name="vvd_cd8" type="12" value="" out="N"/>
				<param name="vvd_cd9" type="12" value="" out="N"/>
				<param name="vvd_cd10" type="12" value="" out="N"/>
				<param name="vvd_cd11" type="12" value="" out="N"/>
				<param name="vvd_cd12" type="12" value="" out="N"/>
				<param name="vvd_cd13" type="12" value="" out="N"/>
				<param name="vvd_cd14" type="12" value="" out="N"/>
				<param name="bkg_io_bnd_cd" type="12" value="" out="N"/>
				<param name="over_due_fm" type="12" value="" out="N"/>
				<param name="over_due_to" type="12" value="" out="N"/>
				<param name="ots_src_cd" type="12" value="" out="N"/>
				<param name="if_from_dt" type="12" value="" out="N"/>
				<param name="if_to_dt" type="12" value="" out="N"/>
				<param name="bl_no1" type="12" value="" out="N"/>
				<param name="bl_no2" type="12" value="" out="N"/>
				<param name="bl_no3" type="12" value="" out="N"/>
				<param name="bl_no4" type="12" value="" out="N"/>
				<param name="bl_no5" type="12" value="" out="N"/>
				<param name="bl_no6" type="12" value="" out="N"/>
				<param name="bl_no7" type="12" value="" out="N"/>
				<param name="chg_tp_cd" type="12" value="" out="N"/>
				<param name="tj_src_nm" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
