<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="AccountPayableInvoiceDBDAOSearchInvoiceSlipListRSQL">
			<desc><![CDATA[STP_SAP_0030 Invoice Slip Inquiry - Invoice Header Retrieve]]></desc>
			<sql><![CDATA[
SELECT  SIH.INV_NO                 AS INV_NO
      , MV.VNDR_LGL_ENG_NM         AS VNDR_LGL_ENG_NM
      , SIH.INV_DT                 AS INV_DT
      , SIH.INV_CURR_CD            AS INV_CURR_CD
      , OPUSADM.SAP_GET_CUR_AMT_FNC(SIH.INV_CURR_CD, SIH.INV_AMT) AS INV_AMT
      , CU.USR_NM                  AS USR_NM
      , SIH.INV_TP_LU_CD           AS INV_TP_LU_CD
      , (CASE WHEN SIH.ATTR_CTNT15 IS NULL AND SIH.INV_CXL_DT IS NULL THEN 'Unapproved'
              WHEN SIH.ATTR_CTNT15 = 'Y' AND SIH.INV_CXL_DT IS NULL THEN 'Approved'
              WHEN SIH.ATTR_CTNT15 = 'N' AND SIH.INV_CXL_DT IS NOT NULL THEN 'Cancelled' END) AS APPROVAL
      , SIH.INV_DESC               AS INV_DESC
      , SIH.ATTR_CTNT13            AS RECEIPT_NO
      , CU2.USR_NM                 AS REJECTED_BY
      , SIH.INV_SEQ                AS INV_SEQ
      , SIH.OFC_CD                 AS OFC_CD
      , SIH.GL_DT                  AS GL_DT
      , DECODE(SIH.ATTR_CTNT12, NULL, 'N', 'Y') AS SUBMIT_FLAG
      , SIH.AP_INV_SRC_CD          AS AP_INV_SRC_CD
      , 'G5'|| ML.CNT_CD || LPAD(TO_CHAR(MV.VNDR_SEQ),6, '0') AS VNDR_CD
      , (SELECT  SPH.PAY_DT
         FROM    SAP_PAY_HDR SPH, SAP_PAY_DTL SPD
         WHERE   SPH.PAY_SEQ = SPD.PAY_SEQ AND SPD.INV_SEQ = SIH.INV_SEQ AND ROWNUM = 1) AS PAY_DT
FROM    SAP_INV_HDR SIH
      , MDM_VENDOR MV
      , COM_USER CU
      , COM_USER CU2
      , MDM_ORGANIZATION MO
      , MDM_LOCATION ML
WHERE   TO_NUMBER(SIH.VNDR_NO) = MV.VNDR_SEQ
AND     SIH.CRE_USR_ID = CU.USR_ID 
AND     SIH.CXL_USR_ID = CU2.USR_ID(+)
AND     MV.OFC_CD = MO.OFC_CD(+)
AND     MO.LOC_CD = ML.LOC_CD(+)
AND     SIH.INV_DT >= TO_DATE(@[inv_dt_fr],'YYYY-MM-DD')
AND     SIH.INV_DT <  TO_DATE(@[inv_dt_to],'YYYY-MM-DD')  + 1
#if (${ofc_cd} != '')
   AND  SIH.OFC_CD = @[ofc_cd]
#else
   AND  SAP_OFC_SECURITY_FNC(SAP_GET_AP_OFFICE_FNC('', @[usr_id]), SIH.OFC_CD, 'INCLUDE_ALL', '') = 'Y'
#end
#if (${ap_inv_src_cd} != '')
   AND  SIH.AP_INV_SRC_CD = @[ap_inv_src_cd]
#end
#if (${inv_no} != '')
   AND  SIH.INV_NO = @[inv_no]
#end
#if (${gl_dt_fr} != '')
   AND  SIH.GL_DT >= REPLACE(@[gl_dt_fr],'-' ,'')
#end
#if (${gl_dt_to} != '')
   AND  SIH.GL_DT <= REPLACE(@[gl_dt_to],'-' ,'')
#end
#if (${vendor_inv_no} != '')
   AND  SIH.INV_SEQ IN (SELECT SID.INV_SEQ FROM SAP_INV_DTL SID WHERE SID.ATTR_CTNT1 = @[vendor_inv_no] )
#end
#if (${ap_pay_grp_lu_cd} != '')
   AND  SIH.AP_PAY_GRP_LU_CD = @[ap_pay_grp_lu_cd]
#end
#if (${vndr_no} != '')
   AND  SIH.VNDR_NO = @[vndr_no]
#end
#if (${inv_curr_cd} != '')
   AND  SIH.INV_CURR_CD = @[inv_curr_cd]
#end
#if (${approval} == 'U')--Unapproved
   AND  SIH.ATTR_CTNT15 IS NULL 
   AND  SIH.INV_CXL_DT IS NULL
#elseif (${approval} == 'A')--Approved
   AND  SIH.ATTR_CTNT15 = 'Y' 
   AND  SIH.INV_CXL_DT IS NULL
#elseif (${approval} == 'C')--Cancelled
   AND  SIH.ATTR_CTNT15 = 'N'
   AND  SIH.INV_CXL_DT IS NOT NULL
#end
ORDER BY SIH.INV_NO			]]></sql>
			<params>
				<param name="inv_dt_fr" type="12" value="" out="N"/>
				<param name="inv_dt_to" type="12" value="" out="N"/>
				<param name="ofc_cd" type="12" value="" out="N"/>
				<param name="usr_id" type="12" value="" out="N"/>
				<param name="ap_inv_src_cd" type="12" value="" out="N"/>
				<param name="inv_no" type="12" value="" out="N"/>
				<param name="gl_dt_fr" type="12" value="" out="N"/>
				<param name="gl_dt_to" type="12" value="" out="N"/>
				<param name="vendor_inv_no" type="12" value="" out="N"/>
				<param name="ap_pay_grp_lu_cd" type="12" value="" out="N"/>
				<param name="vndr_no" type="12" value="" out="N"/>
				<param name="inv_curr_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
