<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="AccountReceivableOutstandingIFDBDAOsearchIFSakuraASAListRSQL">
			<desc><![CDATA[searchIFSakuraASAList]]></desc>
			<sql><![CDATA[
#if (${check_if_no} == '' )
SELECT DISTINCT
       sohi.if_no AS ref_doc_no
#else

#if (${grp_yn} == 'Y' )
SELECT
	MAX(IF_SEQ_NO) IF_SEQ_NO,
	MAX(REC_ID) REC_ID,
	ACCT_CO_CD,
	IF_DOC_TP_CD,
	DOC_DT,
	PST_DT,
	REF_DOC_NO,
	DOC_HDR_CD,
	CURR_CD, 
	TAX_CALC_AUTO_FLG,
	PST_KEY_CD,
	VAT_TAX_CD,
	SUM(LOCL_AMT) LOCL_AMT,
	SUM(DOC_AMT) DOC_AMT,
	SUM(LOCL_TAX_AMT) LOCL_TAX_AMT,
	SUM(DOC_TAX_AMT) DOC_TAX_AMT,
	ASGN_NO,
	ITM_DESC,
	PLN_DT,
	COST_CTR_CD,
	ORD_NO,
	MN_ASET_NO,
	SUB_ASET_NO,
	ASET_TJ_TP_CD,
	ASET_VAL_DT,
	GL_ACCT_NO,
	CUST_NO,
	VNDR_CRTR_ACCT_NO,
	DUE_DT_CALC_BSEL_DT,
	PAY_MZD_CD,
	STE_CNTRL_BANK_IND_CD,
	MTRL_NO,
	FUEL_LAND_QTY,
	MEAS_BSE_UT_CD,
	PFITCTR_CD,
	ALTN_ACCT_NO,
	BIZ_PRNR_REF_KEY_CD1,
	BIZ_PRNR_REF_KEY_CD2,
	LINE_ITM_REF_KEY_CD,
	INSTR_KEY_CD1,
	INSTR_KEY_CD2,
	INSTR_KEY_CD3,
	PAY_REF_CD,
	AUTOMTC_PAY_CURR_CD,
	PAY_CURR_AMT,
	CTRT_NO,
	CTRT_TP_CD,
	PAY_RSN_CD,
	CLSS_CD,
	ACT_PLC_CD,
	ENTR_EXPN_ID,
	BUD_MGMT_DIV_CD,
	ACT_DT,
	VSL_CD,
	VVL_CD,
	HUS_BANK_ID,
	PAY_BLCK_KEY_CD,
	MAX(N1ST_LODG_PORT_CD) N1ST_LODG_PORT_CD,
	MAX(N1ST_LODG_PORT_ETD_DT) N1ST_LODG_PORT_ETD_DT,
	MAX(LST_DCHG_PORT_CD) LST_DCHG_PORT_CD,
	MAX(LST_DCHG_PORT_ETA_DT) LST_DCHG_PORT_ETA_DT,
	MAX(TRD_CD) TRD_CD,
	MAX(TRNK_VVD_CD) TRNK_VVD_CD,
	REC_TP_CD,
	NULL SLAN_CD,
	NULL BKG_QTY,
	MAX(ASA_FLG) ASA_FLG,
    CRE_USR_ID,
    UPD_USR_ID
FROM (
#end
-- Invoice(ASA)
SELECT --DISTINCT
      --  SAR_AR_IF_SEQ.NEXTVAL  as AR_IF_Seq
     NULL AS If_Seq_No
     , '' AS rec_id
     , '1000' AS acct_co_cd
     , 'H8' AS if_doc_tp_Cd -- 20151005 v.3.2 H1에서 H8로 변경
     , TO_CHAR(SOHI.IF_DT,'YYYYMMDD') AS doc_dt
     , SOHI.GL_DT AS pst_dt
     --20150213 wskim 변경
     --, substr(sohi.if_no, 1, length(sohi.if_no)-1) AS ref_doc_no
     #if($check_if_nos.size() > 1)
	 	,SUBSTR(SOHI.IF_NO,1,LENGTH(SOHI.IF_NO) -1) AS REF_DOC_NO
	 #else
     	,SOHI.IF_NO AS REF_DOC_NO 
     #end 
     , NULL AS doc_hdr_cd
     , SOH.OFC_CURR_CD AS curr_cd
     ,'' AS tax_calc_auto_flg
     /* 20150102
     , DECODE(SODT.ACCT_CLSS_CD,'REC',DECODE(SIGN(SOC.INV_AMT),1,'01',-1,'11'), 'REV',DECODE(SIGN(SOC.INV_AMT),1,'11',-1,'01'),
                                'EXCH_GAIN', DECODE(SIGN(SOC.INV_AMT),1,'50',-1,'40'), 'EXCH_LOSS',DECODE(SIGN(SOC.INV_AMT),1,'50',-1,'40'),
                                'HDR_RND',DECODE(SIGN(SOC.INV_AMT),1,'50',-1,'40')) AS pst_key_cd */
     /* 20150205 wskim 차/대 구분 로직 변경
     , DECODE(SODT.ACCT_CLSS_CD,'REC',DECODE(SIGN(SOC.INV_AMT),1,'01',-1,'11'), 'REV',DECODE(SIGN(SOC.INV_AMT),1,'11',-1,'01'),
                                'EXCH_GAIN', DECODE(SIGN(SOC.INV_AMT),1,'50',-1,'40'), 'EXCH_LOSS',DECODE(SIGN(SOC.INV_AMT),1,'40',-1,'50'),
                                'HDR_RND',DECODE(SIGN(SOC.INV_AMT),1,'50',-1,'40')) AS pst_key_cd */
     -- 20160421 PST Key 조건 수정
     , CASE
             WHEN SODT.ACCT_CLSS_CD IN ('REC', 'REV') THEN
                 DECODE(NVL(SODT.ACCT_DR_AMT, 0)+ NVL(SODT.INP_DR_AMT, 0), 0, '11', '01')
             WHEN SODT.ACCT_CLSS_CD IN ('EXCH_GAIN', 'EXCH_LOSS', 'HDR_RND') THEN
                 DECODE(NVL(SODT.ACCT_DR_AMT, 0)+ NVL(SODT.INP_DR_AMT, 0), 0, '50', '40')
        END            AS pst_key_cd 
     --20160421                                 
     --20150227 wskim V1.9 적용 
/*     , CASE
           WHEN SODT.ACCT_CLSS_CD = 'HDR_RND' THEN
               DECODE((SELECT MA.ACCT_CD
                       FROM  MDM_ACCOUNT MA
                            ,MDM_CHARGE MC
                       WHERE MA.ACCT_CD = MC.CO_CHG_ACCT_CD
                       AND MC.CHG_CD = SODT.CHG_TP_CD
                       AND ROWNUM=1),'411111', 'B0','D0')
       END  AS vat_tax_cd    */ 
       
      /* 20150924 tax_cd 로직 변경 */
       , CASE
           WHEN SODT.ACCT_CLSS_CD = 'HDR_RND' THEN
                CASE
                  WHEN  ((SOH.BKG_IO_BND_CD ='O' and SUBSTR(SOH.POL_CD,1,2)='JP')or (SOH.BKG_IO_BND_CD ='I' and SUBSTR(SOH.POD_CD,1,2)='JP')) THEN
                           'B0'
                  ELSE
                           'D0'
                 END
           ELSE
               ''
        END   AS vat_tax_cd       
     /* 20150102
     , DECODE(SODT.CURR_CD, 'JPY','',DECODE(SIGN(SOC.INV_AMT),1,SODT.ACCT_DR_AMT,-1,SODT.ACCT_CR_AMT)) AS locl_amt
     , DECODE(SIGN(SOHI.OTS_AMT),1,SODT.INP_DR_AMT,-1,SODT.INP_CR_AMT) AS doc_amt*/
     /* 20150204 */
     -- 20150716 STM AR인 경우 SAKURA I/F 위한 GL 컬럼으로 변경
     ,CASE
         WHEN SOHI.OTS_SRC_CD ='STM AR' THEN
           DECODE(SOH.OFC_CURR_CD, 'JPY','',DECODE(NVL(SODT.GL_ACCT_DR_AMT,0),0,SODT.GL_ACCT_CR_AMT, SODT.GL_ACCT_DR_AMT)) 
         WHEN SOHI.OTS_SRC_CD ='STM AP' THEN
           DECODE(SOH.OFC_CURR_CD, 'JPY','',DECODE(NVL(SODT.ACCT_DR_AMT,0),0,SODT.ACCT_CR_AMT,SODT.ACCT_DR_AMT)) 
      END AS locl_amt
      /* 20150119
     , DECODE(NVL(SODT.INP_DR_AMT,0),0,SODT.INP_CR_AMT,SODT.INP_DR_AMT)AS doc_amt */
     --20150205 wskim format mask 기준 currency 변경
     --, TO_NUMBER(SAR_GET_CUR_AMT_FNC(SODT.CURR_CD, ABS(NVL(SODT.INP_DR_AMT, 0) - NVL(SODT.INP_CR_AMT, 0)) * SOD.LOCL_XCH_RT)) AS doc_amt
     -- 20150716 STM AR인 경우 SAKURA I/F 위한 GL 컬럼으로 변경
     ,CASE
         WHEN SOHI.OTS_SRC_CD ='STM AR' THEN
           TO_NUMBER(SAR_GET_CUR_AMT_FNC(SOH.OFC_CURR_CD, ABS(NVL(SODT.GL_INP_DR_AMT, 0) - NVL(SODT.GL_INP_CR_AMT, 0)) * SOD.LOCL_XCH_RT)) 
         WHEN SOHI.OTS_SRC_CD ='STM AP' THEN   
           TO_NUMBER(SAR_GET_CUR_AMT_FNC(SOH.OFC_CURR_CD, ABS(NVL(SODT.INP_DR_AMT, 0) - NVL(SODT.INP_CR_AMT, 0)) * SOD.LOCL_XCH_RT)) 
     END AS doc_amt
     ,'' AS locl_tax_amt     
     ,'' AS doc_tax_amt
     , SOH.BL_NO AS asgn_no
     , '' AS itm_desc
     , '' AS pln_dt
     
     /* 20150102
     , DECODE(SODT.ACCT_CLSS_CD,'EXCH_GAIN','TBD-A101',
                                'EXCH_LOSS','TBD-A101',
                                'HDR_RND','TBD-A101','') AS cost_ctr_cd -- 향후  MDA svc_scp 에서 profit_center_code 가져옴 */
     --20150408 OTS_History의 svc_scp_cd로 변환값 찾도록 변경                            
     , DECODE(SODT.ACCT_CLSS_CD,'EXCH_GAIN',
                                (SELECT MODI_COST_CTR_CD 
                                 FROM MDM_SVC_SCP
                                 WHERE SVC_SCP_CD =SOHI.SVC_SCP_CD),
                                'EXCH_LOSS',
                                (SELECT MODI_COST_CTR_CD 
                                 FROM MDM_SVC_SCP
                                 WHERE SVC_SCP_CD =SOHI.SVC_SCP_CD),
                                'HDR_RND',
                                (SELECT MODI_COST_CTR_CD 
                                 FROM MDM_SVC_SCP
                                 WHERE SVC_SCP_CD =SOHI.SVC_SCP_CD),'') AS cost_ctr_cd                          
                                
                               
     ,'' AS ord_no
     ,'' AS mn_aset_no
     ,'' AS sub_aset_no
     ,'' AS aset_tj_tp_cd
     ,'' AS aset_val_dt
     , DECODE(SODT.ACCT_CLSS_CD,'EXCH_GAIN','8225101000',
                                'EXCH_LOSS','8325401000',
                                --20150130 wskim HDR_RND 7001000000 
                                --'HDR_RND',DECODE(SIGN(SOC.INV_AMT),1,'8225101000',-1,'8325401000'),'') AS gl_acct_no 
                                'HDR_RND','7001000000','') AS gl_acct_no
      /*20150122*/
     , DECODE(SODT.ACCT_CLSS_CD,'REC',
                                (SELECT MODI_AGN_CD
                                  FROM MDM_ORGANIZATION MO
                                  WHERE MO.OFC_CD=SOH.CLT_OFC_CD
                                  AND rownum=1),
                                  'REV',
                                 (SELECT MODI_AGN_CD
                                  FROM MDM_ORGANIZATION MO
                                  WHERE MO.OFC_CD=SOH.CLT_OFC_CD
                                  AND rownum=1),'') AS cust_no 
     ,'' AS vndr_crtr_acct_no
      --20150302 wskim 로직변경. v2.0
     ,CASE 
          WHEN SODT.ACCT_CLSS_CD IN ('REC', 'REV') THEN
              SOH.DUE_DT
          ELSE
              ''
      END    AS due_dt_calc_bsel_dt
     ,'' AS pay_mzd_cd
     ,'' AS ste_cntrl_bank_ind_cd
     ,'' AS mtrl_no
     ,'' AS fuel_land_qty
     ,'' AS meas_bse_ut_cd
     /* 20150102
     , DECODE(SODT.ACCT_CLSS_CD,'EXCH_GAIN','TBD-A101',
                                'EXCH_LOSS','TBD-A101',
                                'HDR_RND','TBD-A101','') AS pfitctr_cd -- 향후  MDA_svc_scp 에서 profit_center_code 가져옴 */
     --20150408 OTS_History의 svc_scp_cd로 변환값 찾도록 변경
     , DECODE(SODT.ACCT_CLSS_CD,'EXCH_GAIN',
                                (SELECT MODI_COST_CTR_CD 
                                 FROM MDM_SVC_SCP
                                 WHERE SVC_SCP_CD =SOHI.SVC_SCP_CD),
                                'EXCH_LOSS',
                                (SELECT MODI_COST_CTR_CD 
                                 FROM MDM_SVC_SCP
                                 WHERE SVC_SCP_CD =SOHI.SVC_SCP_CD),
                                'HDR_RND',
                                (SELECT MODI_COST_CTR_CD 
                                 FROM MDM_SVC_SCP
                                 WHERE SVC_SCP_CD =SOHI.SVC_SCP_CD),'') AS pfitctr_cd                          
                                
     , DECODE(SODT.ACCT_CLSS_CD,'REC', '5360000000','REV','5360000000','') AS altn_acct_no 
     , DECODE(SODT.ACCT_CLSS_CD,'REC', 'A106','REV','A106','') AS biz_prnr_ref_key_cd1 
     ,'' AS biz_prnr_ref_key_cd2
     ,'' AS line_itm_ref_key_cd
     ,'' AS instr_key_cd1
     ,'' AS instr_key_cd2
     ,'' AS instr_key_cd3
     , DECODE(SODT.ACCT_CLSS_CD,'REC', '42','REV','41','') AS pay_ref_cd
     , '' AS automtc_pay_curr_cd
     , '' AS pay_curr_amt
     /*20150121
     , (SELECT MODI_VNDR_CD
        FROM MDM_VENDOR MV, MDM_ORGANIZATION MO
        WHERE MV.VNDR_SEQ = MO.Vndr_Seq
        AND MO.OFC_CD=SOH.CLT_OFC_CD
        AND rownum=1) AS ctrt_no */
    , (SELECT MODI_AGN_CD
        FROM MDM_ORGANIZATION MO
        WHERE MO.OFC_CD=SOH.CLT_OFC_CD
        AND rownum=1) AS ctrt_no
     ,'Z' AS ctrt_tp_cd
     ,'' AS pay_rsn_cd
     ,'' AS clss_cd
     , DECODE(SODT.ACCT_CLSS_CD,'REV','','REC','',
             (SELECT ML.MODI_LOC_CD
               FROM MDM_LOCATION ML
              WHERE ML.LOC_CD = (SELECT LOC_CD 
                                 FROM MDM_ORGANIZATION
                                 WHERE OFC_CD = 'SOH.CLT_OFC_CD')
              )) AS act_plc_cd 
     ,'' AS entr_expn_id
     ,'' AS bud_mgmt_div_cd
     , DECODE(SODT.ACCT_CLSS_CD,'REV', '','REC','',TO_CHAR(SOHI.IF_DT,'YYYYMMDD')) AS act_dt
     ,'' AS vsl_cd 
     ,'' AS vvl_Cd 
     ,'' AS hus_bank_id
     ,'' AS pay_blck_key_cd
     ,SODT.OTS_DTRB_SEQ	
     --20141229 wskim Accrual 요청 추가 시작
     ,SOH.POL_CD AS N1ST_LODG_PORT_CD
     ,(SELECT VVP.VPS_ETD_DT
       FROM   VSK_VSL_PORT_SKD VVP
       WHERE  VSL_CD      = SUBSTR(SOH.TRNK_VVD_CD,1,4)
       AND    SKD_VOY_NO  = SUBSTR(SOH.TRNK_VVD_CD, 5, 4) 
       AND    SKD_DIR_CD  = SUBSTR(SOH.TRNK_VVD_CD, 9, 1) 
       AND    VPS_PORT_CD = SOH.POL_CD)  AS N1ST_LODG_PORT_ETD_DT 
     ,SOH.POD_CD AS LST_DCHG_PORT_CD 
      /*20150123*/
     ,(SELECT VVP.VPS_ETA_DT
       FROM   VSK_VSL_PORT_SKD VVP
       WHERE  VSL_CD      = SUBSTR(SOH.TRNK_VVD_CD,1,4)
       AND    SKD_VOY_NO  = SUBSTR(SOH.TRNK_VVD_CD, 5, 4) 
       AND    SKD_DIR_CD  = SUBSTR(SOH.TRNK_VVD_CD, 9, 1) 
       AND    VPS_PORT_CD = SOH.POD_CD)  AS LST_DCHG_PORT_ETA_DT
     , (SELECT MDR.TRD_CD
       FROM   AR_MST_REV_VVD AMR,
              MDM_DTL_REV_LANE MDR 
       WHERE  AMR.RLANE_CD = MDR.RLANE_CD
       AND    AMR.VSL_CD||AMR.SKD_VOY_NO||AMR.SKD_DIR_CD||AMR.RLANE_DIR_CD = SOHI.REV_VVD_CD 
       AND    MDR.VSL_SLAN_DIR_CD = SUBSTR(SOHI.REV_VVD_CD, 9, 1)
       AND    MDR.FM_CONTI_CD = (SELECT CONTI_CD  
                                 FROM   MDM_LOCATION
                                 WHERE  LOC_CD = SOHI.POL_CD
                                )
       AND    MDR.TO_CONTI_CD = (SELECT CONTI_CD  
                                 FROM   MDM_LOCATION
                                 WHERE  LOC_CD = SOHI.POD_CD
                                )
       )   AS TRD_CD
     , SOH.TRNK_VVD_CD   AS TRNK_VVD_CD
     --20141229 wskim Accrual 요청 추가 끝
     ,SODT.ACCT_CLSS_CD AS REC_TP_CD  -- 20150129 추가 SAR_AR_IF(REC_TP_CD)에 넣어주세요
     --20150224 wskim Accrual 요청. ASA Flag 추가. SAR_AR_IF.ASA_FLG에 Insert
     ,'Y' AS ASA_FLG
     ,SODT.CRE_USR_ID
	 ,SODT.UPD_USR_ID
#end
   FROM SAR_OTS_HDR SOH
     , SAR_OTS_DTL SOD
     , SAR_OTS_CHG SOC
     , SAR_OTS_HIS SOHI
     , SAR_OTS_DTRB SODT
     , (SELECT SLD.LU_CD CURR_CD
          FROM SCO_LU_HDR SLH
             ,SCO_LU_DTL SLD
         WHERE SLH.LU_APPL_CD ='SCO'
           AND SLH.LU_TP_CD ='FUNCTIONAL CURRENCY'
           AND SLH.LU_TP_CD = SLD.LU_TP_CD) FC
 WHERE SOH.RHQ_CD = SOD.RHQ_CD
   AND SOH.OTS_OFC_CD = SOD.OTS_OFC_CD
   AND SOH.BL_NO = SOD.BL_NO
   AND SOH.INV_NO = SOD.INV_NO
   AND SOD.RHQ_CD = SOC.RHQ_CD
   AND SOD.OTS_OFC_CD = SOC.OTS_OFC_CD
   AND SOD.BL_NO = SOC.BL_NO
   AND SOD.INV_NO = SOC.INV_NO
   --20150206 wskim chg_tp_cd 조건 추가
   AND SOD.CHG_TP_CD = SOC.CHG_TP_CD   
   AND SOD.BL_CURR_CD = SOC.BL_CURR_CD      
   AND SOC.RHQ_CD = SOHI.RHQ_CD
   AND SOC.OTS_OFC_CD = SOHI.OTS_OFC_CD
   AND SOC.BL_NO = SOHI.BL_NO
   AND SOC.INV_NO = SOHI.INV_NO
   AND SOHI.OTS_HIS_SEQ = SODT.OTS_HIS_SEQ
   AND SOC.OTS_HIS_SEQ = SODT.OTS_HIS_SEQ
   --20150206 wskim chg_tp_cd 조건 추가
   AND SOC.CHG_TP_CD = SODT.CHG_TP_CD   
   AND SOD.BL_CURR_CD = SODT.CURR_CD /*20150119 추가 */
   --20150206 wskim chg_tp_cd 조건 추가
   AND SOC.INV_AMT <> 0
   --20150213 wskim AGT -> ASA 로 변경
   AND SOHI.REV_TP_SRC_CD = 'ASA'
   AND (NVL(SODT.GL_INP_DR_AMT,0)+NVL(SODT.GL_INP_CR_AMT,0) + NVL(SODT.GL_ACCT_DR_AMT,0)+NVL(SODT.GL_ACCT_CR_AMT,0) ) <>0
   #if (${check_if_no} != '' )
   AND SOHI.IF_NO IN (
		#foreach( $key IN ${check_if_nos}) 
 			#if($velocityCount < $check_if_nos.size())
    			'$key',
 			#else
  				'$key'
 			#end
		#end
   ) 
   #end
   AND SODT.AR_IF_STS_CD = @[check_status]
#if (${grp_yn} == 'Y' )
) GROUP BY
 ACCT_CO_CD
,IF_DOC_TP_CD
,DOC_DT
,PST_DT
,REF_DOC_NO
,DOC_HDR_CD
,CURR_CD
,TAX_CALC_AUTO_FLG
,PST_KEY_CD
,VAT_TAX_CD
,ASGN_NO
,ITM_DESC
,PLN_DT
,COST_CTR_CD
,ORD_NO
,MN_ASET_NO
,SUB_ASET_NO
,ASET_TJ_TP_CD
,ASET_VAL_DT
,GL_ACCT_NO
,CUST_NO
,VNDR_CRTR_ACCT_NO
,DUE_DT_CALC_BSEL_DT
,PAY_MZD_CD
,STE_CNTRL_BANK_IND_CD
,MTRL_NO
,FUEL_LAND_QTY
,MEAS_BSE_UT_CD
,PFITCTR_CD
,ALTN_ACCT_NO
,BIZ_PRNR_REF_KEY_CD1
,BIZ_PRNR_REF_KEY_CD2
,LINE_ITM_REF_KEY_CD
,INSTR_KEY_CD1
,INSTR_KEY_CD2
,INSTR_KEY_CD3
,PAY_REF_CD
,AUTOMTC_PAY_CURR_CD
,PAY_CURR_AMT
,CTRT_NO
,CTRT_TP_CD
,PAY_RSN_CD
,CLSS_CD
,ACT_PLC_CD
,ENTR_EXPN_ID
,BUD_MGMT_DIV_CD
,ACT_DT
,VSL_CD
,VVL_CD
,HUS_BANK_ID
,PAY_BLCK_KEY_CD
,REC_TP_CD
,CRE_USR_ID
,UPD_USR_ID
#end			]]></sql>
			<params>
				<param name="check_status" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
