<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="AccountReceivableOutstandingDBDAOModifyBKGOutstandingUSQL">
			<desc><![CDATA[ModifyBKGOutstanding]]></desc>
			<sql><![CDATA[
MERGE INTO BKG_OUTSTANDING A
USING (
            SELECT OTS_OFC_CD OFC_CD
                , BL_NO CLT_BL_NO
                , INV_NO
                , OFC_CURR_CD
                , BIL_TO_CUST_CNT_CD||LPAD(BIL_TO_CUST_SEQ, 6, '0') BIL_TO_CUST_CD
                , CR_MK_FLG CR_FLG
                , BKG_IO_BND_CD OTS_BND_TP_CD
                , BKG_NO OTS_BKG_NO
                , TO_DATE(DUE_DT, 'YYYY-MM-DD') OTS_DUE_DT
                , NVL((SELECT 'Y'
       	   		       FROM SAR_OTS_DTL
       	   		       WHERE RHQ_CD = SOH.RHQ_CD
       	   		       AND OTS_OFC_CD = SOH.OTS_OFC_CD
       	   		       AND BL_NO = SOH.BL_NO
       	   		       AND INV_NO = SOH.INV_NO
		   		       HAVING SUM(BAL_AMT) <= 0), 'N') OTS_STL_FLG
                , XCH_RT_TP_CD
                , OTS_RMK CLT_RMK
                , OTS_GRP_TP_CD
                , OTS_TP_CD OTS_OCCR_TP_CD
                , CLT_OFC_CD LST_CLT_OFC_CD
                , CRE_USR_ID
                , UPD_USR_ID
            FROM SAR_OTS_HDR SOH
            WHERE RHQ_CD = @[rhq_cd]
            AND OTS_OFC_CD = @[ots_ofc_cd]
            AND BL_NO = @[bl_no]
            AND INV_NO = @[inv_no]
            AND BKG_IO_BND_CD = 'I'
        ) B
ON (A.OFC_CD = B.OFC_CD
    AND A.CLT_BL_NO = B.CLT_BL_NO
    AND A.INV_NO = B.INV_NO)       
WHEN MATCHED THEN 
    UPDATE 
        SET A.OFC_CURR_CD = B.OFC_CURR_CD
            , A.BIL_TO_CUST_CD = B.BIL_TO_CUST_CD
            , A.CR_FLG = B.CR_FLG
            , A.OTS_BND_TP_CD = B.OTS_BND_TP_CD
            , A.OTS_BKG_NO = B.OTS_BKG_NO
            , A.OTS_DUE_DT = B.OTS_DUE_DT
            , A.OTS_STL_FLG = B.OTS_STL_FLG
            , A.XCH_RT_TP_CD = B.XCH_RT_TP_CD
            , A.CLT_RMK = B.CLT_RMK
            , A.OTS_GRP_TP_CD = B.OTS_GRP_TP_CD
            , A.OTS_OCCR_TP_CD = B.OTS_OCCR_TP_CD
            , A.LST_CLT_OFC_CD = B.LST_CLT_OFC_CD
            , A.LST_UPD_CHK_DT = SYSDATE          
            , A.UPD_DT = SYSDATE
            , A.UPD_USR_ID = B.UPD_USR_ID
			, A.CNG_IND_FLG = 'Y'
WHEN NOT MATCHED THEN
    INSERT (
            A.OFC_CD
            , A.CLT_BL_NO
            , A.INV_NO
            , A.OFC_CURR_CD
            , A.BIL_TO_CUST_CD
            , A.CR_FLG
            , A.OTS_BND_TP_CD
            , A.OTS_BKG_NO
            , A.OTS_DUE_DT
            , A.OTS_STL_FLG
            , A.XCH_RT_TP_CD
            , A.CLT_RMK
            , A.OTS_GRP_TP_CD
            , A.OTS_OCCR_TP_CD
            , A.LST_CLT_OFC_CD
            , A.LST_UPD_CHK_DT
            , A.CRE_DT
            , A.CRE_USR_ID
            , A.UPD_DT
            , A.UPD_USR_ID
			, A.CNG_IND_FLG
           )
    VALUES (
            B.OFC_CD
            , B.CLT_BL_NO
            , B.INV_NO
            , B.OFC_CURR_CD
            , B.BIL_TO_CUST_CD
            , B.CR_FLG
            , B.OTS_BND_TP_CD
            , B.OTS_BKG_NO
            , B.OTS_DUE_DT
            , B.OTS_STL_FLG
            , B.XCH_RT_TP_CD
            , B.CLT_RMK
            , B.OTS_GRP_TP_CD
            , B.OTS_OCCR_TP_CD
            , B.LST_CLT_OFC_CD
            , SYSDATE
            , SYSDATE
            , B.CRE_USR_ID
            , SYSDATE
            , B.UPD_USR_ID
			, 'Y'
           )			]]></sql>
			<params>
				<param name="rhq_cd" type="12" value="" out="N"/>
				<param name="ots_ofc_cd" type="12" value="" out="N"/>
				<param name="bl_no" type="12" value="" out="N"/>
				<param name="inv_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
