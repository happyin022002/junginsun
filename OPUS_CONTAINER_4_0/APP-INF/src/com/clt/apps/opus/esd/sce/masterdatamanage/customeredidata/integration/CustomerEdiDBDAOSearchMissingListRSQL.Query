<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CustomerEdiDBDAOSearchMissingListRSQL">
			<desc><![CDATA[dumy]]></desc>
			<sql><![CDATA[
select totcnt,  s_vvd, s_bkg_no, s_cntr_no,  por_cd, pol_cd,
                  pod_cd,  del_cd,   EDI_STS_CD, edi_sub_sts_cd,edi_snd_knt,
                    act_dt1, act_dt2, nod_cd, cre_dt1, cre_dt2, cop_no,
                    s_bl_no,max_edi_snd_knt,gmt_dt1,  gmt_dt2, 
                    rbtn , '' flag
  from(
        select  lst.*
               ,CEIL(rownum/@[pagerows]) page , COUNT(1) OVER() TOTCNT   
         from(
              select /*+ USE_NL(sts dtl) */
                    dtl.vvd AS s_vvd, dtl.bkg_no AS s_bkg_no,  dtl.cntr_no AS s_cntr_no,  dtl.por_cd, dtl.pol_cd,
                    dtl.pod_cd,  dtl.del_cd,  dtl.EDI_STS_CD, dtl.edi_sub_sts_cd,dtl.edi_snd_knt,
                    dtl.act_dt1, dtl.act_dt2, nod_cd, dtl.cre_dt1, dtl.cre_dt2, dtl.cop_no,
                    dtl.bl_no AS s_bl_no,
                    max_edi_snd_knt,
                    dtl.gmt_dt1,  dtl.gmt_dt2,
                    decode(edi_snd_knt, null, '', case when max_edi_snd_knt= edi_snd_knt then '0' else '' end) rbtn
              from (
                    select --  /*+ USE_NL(a r) */
                           --  /*+leading(r) USE_HASH(A,r)*/
                           vvd, a.bkg_no, a.cntr_no, por_cd,  pol_cd, pod_cd,del_cd,   '' flg,
                           a.EDI_STS_CD, r.edi_snd_knt ,to_char(r.act_dt, 'yyyymmdd') act_dt1, to_char(r.act_dt, 'hh24miss') act_dt2,
                           r.nod_cd , to_char(r.upd_dt, 'yyyymmdd') cre_dt1,to_char(r.upd_dt, 'hh24miss') cre_dt2,
                           a.cop_no ,  r.bl_no,  r.act_dt, a.edi_sub_sts_cd ,r.max_edi_snd_knt max_edi_snd_knt
                          ,to_char(r.gmt_dt, 'yyyymmdd') gmt_dt1, to_char(r.gmt_dt, 'hh24miss') gmt_dt2 --20071129 LocalTime
                          ,a.exp_ind
                     from (
                           -------  join 1 start
                           select /*+ index(d XAK5SCE_EDI_SND_RSLT) */
                                  d.EDI_GRP_CD, d.bkg_no, d.cntr_no, d.EDI_STS_CD,d.EDI_SUB_STS_CD
                                  ,d.act_dt, d.gmt_dt, d.edi_snd_knt EDI_SND_KNt, d.upd_dt, d.nod_cd
                                  ,BL_NO
                                  ,MAX(d.EDI_SND_KNT) OVER ( PARTITION BY d.bkg_no, d.cntr_no, d.EDI_STS_CD, d.EDI_SUB_STS_CD) max_edi_snd_knt
                             from SCE_EDI_SND_RSLT d
                         #if (${vvd} == '' && ${bkg_no} == '' && ${bl_no} == '' && ${cntr_no} == '') 
          	                     , ( 
	          	                    SELECT 
                                             /*+ i ndex (VSK_VSL_PORT_SKD XAK1VSK_VSL_PORT_SKD)     */                 
                                            VSL_CD || SKD_VOY_NO || SKD_DIR_CD vvd   
	                                  FROM  VSK_VSL_PORT_SKD    
	              		             WHERE NVL(SKD_CNG_STS_CD, ' ') <> 'S'        
	                 	               AND CLPT_IND_SEQ = '1'    

                                  #if (${pol_fromdate} != '' || ${pol_todate} != '')
	        	   		               AND  VPS_ETD_DT BETWEEN TO_DATE( @[pol_fromdate], 'YYYYMMDD' ) AND TO_DATE( @[pol_todate], 'YYYYMMDD' ) + 0.9999  
	        	                       and VPS_PORT_CD LIKE  @[pol]  ||'%'   
	        	                       and NVL(TURN_PORT_IND_CD, ' ') NOT IN ('V', 'D', 'F')  

                                  #end

	                              #if (${pod_fromdate} != '' || ${pod_todate} != '')
	        	   		               AND VPS_ETA_DT BETWEEN TO_DATE( @[pod_fromdate], 'YYYYMMDD' ) AND TO_DATE( @[pod_todate], 'YYYYMMDD' ) + 0.9999  
	        	                       and VPS_PORT_CD LIKE  @[pod] ||'%'   
	        	                       and NVL(TURN_PORT_IND_CD, ' ') IN ('N', 'V', 'D', 'F')  
                                  #end
	                            ) v          
                          where d.VSL_CD      = substr(v.vvd, 1, 4)    
	                        and d.SKD_VOY_NO  = substr(v.vvd, 5, 4)     
	                        and d.SKD_DIR_CD  = substr(v.vvd, 9, 1)    
                      #elseif (${bkg_no} != '')

        	             where (d.bkg_no)    
                                          in (
                                            #foreach($ele in ${bkg_no})
                                               #if($velocityCount == 1) /*if-10s*/
                                                  ('$ele')
                                               #else
                                                  ,('$ele')
                                               #end /*if-10e*/
                                            #end
                                           ) 
 
                      #elseif (${bl_no} != '')
        	                   , (   select bkg_no 
        	                           from bkg_booking	
        		 		              where (bl_no) 
                                                   in (
                                                        #foreach($ele in ${bl_no})
                                                            #if($velocityCount == 1) /*if-10s*/
                                                              ('$ele')
                                                            #else
                                                             ,('$ele')
                                                            #end /*if-10e*/
                                                       #end
                                                      ) 
        			             ) v   			
        	                where  d.bkg_no = v.bkg_no 
                      #elseif (${cntr_no} != '') 	

                        	where d.CNTR_NO 
                                          in (
                                            #foreach($ele in ${cntr_no})
                                               #if($velocityCount == 1) /*if-10s*/
                                                  ('$ele')
                                               #else
                                                  ,('$ele')
                                               #end /*if-10e*/
                                            #end
                                           ) 	    
                      #elseif (${vvd} != '')
                        
 
        	               where d.VSL_CD||d.SKD_VOY_NO||d.SKD_DIR_CD  
                                                                      in (
                                                                          #foreach($ele in ${vvd})
                                                                              #if($velocityCount == 1) /*if-10s*/
                                                                                 ('$ele')
                                                                              #else
                                                                                  ,('$ele')
                                                                              #end /*if-10e*/
                                                                          #end
                                                                         ) 	
                     #end
    
        	    and d.EDI_STS_CD = @[edi_sts]         
        	   and d.EDI_SUB_STS_CD = @[cust_sts]        
               and d.EDI_GRP_CD  = @[cs_grp_id]
               -----  join 1 end     
               ) r ,                       
              ( 
                ---- join 2 start
               SELECT /*+ USE_NL(hb e cgo) */ distinct hb.vvd,hb.bkg_no, hb.cntr_no, hb.por_cd ,  hb.pol_cd, hb.pod_cd,
                     hb.del_cd , cgo.EDI_STND_STS_CD edi_sts_cd , cgo.cust_edi_sts_cd edi_sub_sts_cd --20071114
                     , e.edi_grp_cd edi_grp_cd, hb.cop_no,
                     case when
                               --T/S 가 없는 Shipment
                              (ts_chk is null  and cgo.EDI_STND_STS_CD in ('VAT','UVT','AET','VDT'))
                              --O/B 구간 Rail이 아닌 Shipment
                               or (substr(rail_chk, 1, 1) <> 'I'  and cgo.EDI_STND_STS_CD in ('ALO','RLO','ARO','URO','FOTRDO','FOTRAD'))
                              --I/B 구간 Rail이 아닌 Shipment
                               or (substr(rail_chk, 2, 1) <> 'I' and cgo.EDI_STND_STS_CD in ('ALN','RLN','ARN','URN','FITRAD',  'FITRDO','AVN', 'ACN','AFN', 'AON',  'NT'))
                               --I/B 구간 Rail이 아닌 Shipment
                               or  (substr(rail_chk, 2, 1) = 'I' and  cgo.EDI_STND_STS_CD in ('AVL','ACL','AFL','AOL'))
                               --DEL이 ‘US’가 아닌 것
                               or (substr(hb.del_cd, 1, 2) <> 'US' and  cgo.EDI_STND_STS_CD in ('CT','CC','CU','HR','PA','PQ','AVN','AVL','ACN','ACL'))
                               --DEL이 ‘CA,MX’가 아닌 것
                               or (substr(hb.del_cd, 1, 2) <> 'CA' and substr(hb.del_cd, 1, 2) <> 'MX' and cgo.EDI_STND_STS_CD in ('OB','AFN','AFL','AON','AOL'))
                               --DEL이 ‘US,CA,MX’가 아닌 것
                               or (substr(hb.del_cd, 1, 2) <> 'US' and substr(hb.del_cd, 1, 2) <> 'CA' and substr(hb.del_cd, 1, 2) <> 'MX' and cgo.EDI_STND_STS_CD in ('NFT','FTR'))
                               then  'EXP'
                          else 'N/A'
                     end EXP_IND
              FROM (
                     SELECT /*+ ordered */   DISTINCT  h.trnk_vsl_cd||h.trnk_skd_voy_no||h.trnk_skd_dir_cd vvd,
                            h.bkg_no, h.cntr_no, h.cop_no,
                            substr(h.por_nod_cd,1,5) por_cd, substr(h.pol_nod_cd,1,5) pol_cd, substr(h.pod_nod_cd,1,5) pod_cd, substr(h.del_nod_cd,1,5)del_cd,
                             h.COP_RAIL_CHK_CD rail_chk, m.N1ST_TS_PORT_CD ts_chk
	
        

                    #if (${vvd} == '' && ${bkg_no} == '' && ${bl_no} == '' && ${cntr_no} == '') 
	        		   from	
	        		       (
	        		         SELECT 
                                    /*+ i ndex (VSK_VSL_PORT_SKD XAK1VSK_VSL_PORT_SKD)     */
	        				         VSL_CD || SKD_VOY_NO || SKD_DIR_CD vvd  
	        			       FROM VSK_VSL_PORT_SKD	
	        			      where NVL(SKD_CNG_STS_CD, ' ') <> 'S'	
	        			     	AND CLPT_IND_SEQ = '1'   
                           #if (${pol_fromdate} != '' || ${pol_todate} != '')	        
	        	   	         	AND  VPS_ETD_DT BETWEEN TO_DATE( @[pol_fromdate], 'YYYYMMDD' ) AND TO_DATE( @[pol_todate], 'YYYYMMDD' ) + 0.9999  
	        	                and VPS_PORT_CD LIKE  @[pol] ||'%'   
	        	                and NVL(TURN_PORT_IND_CD, ' ') NOT IN ('V', 'D', 'F') 

                           #end	        
                           #if (${pod_fromdate} != '' || ${pod_todate} != '')

	        	   	   	        AND VPS_ETA_DT BETWEEN TO_DATE( @[pod_fromdate], 'YYYYMMDD' ) AND TO_DATE( @[pod_todate], 'YYYYMMDD' ) + 0.9999  
	        	                and VPS_PORT_CD LIKE  @[pod] ||'%'   
	        	                and NVL(TURN_PORT_IND_CD, ' ') IN ('N', 'V', 'D', 'F')  

                           #end
	        
	        		  	   ) v	
	        		       , sce_cop_hdr h
	        		  	   , prd_prod_ctl_mst m	 
	        		where  h.TRNK_VSL_CD = substr(v.vvd, 1, 4) 		
	                  and  h.TRNK_SKD_VOY_NO = substr(v.vvd, 5, 4) 		
	                  and  h.TRNK_SKD_DIR_CD = substr(v.vvd, 9, 1) 
	                  AND  m.pctl_no = h.pctl_no 
                  #elseif (${bkg_no} != '')
        			 FROM sce_cop_hdr h, prd_prod_ctl_mst m    
 	                where (h.bkg_no)   
                                     in (
                                          #foreach($ele in ${bkg_no})
                                             #if($velocityCount == 1) /*if-10s*/
                                                ('$ele')
                                             #else
                                               ,('$ele')
                                             #end /*if-10e*/
                                          #end
                                        ) 
                  #elseif (${bl_no} != '')
        			  from (   select bkg_no 
        			             from bkg_booking	
        					    where (bl_no) 
                                              in (
                                                   #foreach($ele in ${bl_no})
                                                      #if($velocityCount == 1) /*if-10s*/
                                                         ('$ele')
                                                      #else
                                                         ,('$ele')
                                                      #end /*if-10e*/
                                                   #end
                                                 )		
        					) v ,sce_cop_hdr h       
        			   where  h.bkg_no = v.bkg_no 
                  #elseif (${cntr_no} != '')	

    				  FROM sce_cop_hdr h, prd_prod_ctl_mst m    

	                  where h.cntr_no 
                                     in (
                                          #foreach($ele in ${cntr_no})
                                             #if($velocityCount == 1) /*if-10s*/
                                                ('$ele')
                                             #else
                                               ,('$ele')
                                             #end /*if-10e*/
                                          #end
                                        ) 
                  #elseif (${vvd} != '')	
    				  FROM sce_cop_hdr h, prd_prod_ctl_mst m   
	         	     where h.TRNK_VSL_CD||h.TRNK_SKD_VOY_NO||h.TRNK_SKD_DIR_CD  
                                                                               in (
                                                                                    #foreach($ele in ${vvd})
                                                                                        #if($velocityCount == 1) /*if-10s*/
                                                                                            ('$ele')
                                                                                        #else
                                                                                            ,('$ele')
                                                                                        #end /*if-10e*/
                                                                                    #end
                                                                                  )  
                  #end
   
                  #if (${cop_status} == 'C')
        	           and      h.cop_sts_cd  = 'F'	
                  #elseif (${cop_status} == 'I')		            
                       and      h.cop_sts_cd  = 'T'	
                  #else		            
        	           and  h.cop_sts_cd  IN ('C', 'T', 'F')          	
                  #end
                       AND      h.cntr_no <> 'COMU0000000'
                	   AND      m.pctl_no = h.pctl_no   		
                  #if (${por} != '')        
  	                   AND h.por_nod_cd LIKE @[por]||'%'                                                             
                  #end
                  #if (${pol} != '')        
  	                   AND h.pol_nod_cd LIKE @[pol] ||'%'                                                             

                  #end
                  #if (${pod} != '')        
    	                  AND h.pod_nod_cd LIKE @[pod] ||'%'                                                             
                  #end
                  #if (${del} != '')        
  	                   AND h.del_nod_cd LIKE @[del] ||'%'                                                             
                  #end

                  #if (${trs_mode} != 'A')    
                      #if (${trs_mode} == 'Y')                                  
         		       AND decode(H.COP_RAIL_CHK_CD,'','XX',H.COP_RAIL_CHK_CD) IN ('OI', 'XI')  
                      #else 

        		       AND decode(H.COP_RAIL_CHK_CD,'','XX',H.COP_RAIL_CHK_CD) NOT IN ('OI', 'XI')    

                      #end

                 #end
             ) hb,    EDI_GRP_CUST e,   edi_grp_cgo cgo, bkg_booking r, bkg_customer bkg_cust
       WHERE hb.bkg_no = bkg_cust.bkg_no
         and hb.bkg_no = r.bkg_no
         and ( (e.CUST_CNT_CD = bkg_cust.CUST_CNT_CD -- S
         and    e.CUST_SEQ = bkg_cust.CUST_SEQ
         and    bkg_cust_tp_cd = 'S' 
               )
             or (e.CUST_CNT_CD = bkg_cust.CUST_CNT_CD -- C
                 and e.CUST_SEQ = bkg_cust.CUST_SEQ
                 and bkg_cust_tp_cd = 'C' 
                )
            or (e.CUST_CNT_CD = bkg_cust.CUST_CNT_CD -- A
                and e.CUST_SEQ = bkg_cust.CUST_SEQ
                and bkg_cust_tp_cd = 'A' 
               )
            or (e.CUST_CNT_CD = bkg_cust.CUST_CNT_CD -- N
               and e.CUST_SEQ = bkg_cust.CUST_SEQ
               and bkg_cust_tp_cd = 'N' 
               )
            or (e.CUST_CNT_CD = bkg_cust.CUST_CNT_CD -- F
               and e.CUST_SEQ = bkg_cust.CUST_SEQ
               and bkg_cust_tp_cd = 'F' 
               )
            or (e.CUST_CNT_CD = bkg_cust.CUST_CNT_CD -- E
               and e.CUST_SEQ = bkg_cust.CUST_SEQ
               and bkg_cust_tp_cd = 'E' 
               )
            or (e.sc_no = case when e.bkg_ctrt_div_cd is null or e.bkg_ctrt_div_cd = '1' then r.sc_no else r.rfa_no end /*2009.08.05 VIP 315 대상으로 RFA No. 추가*/ )
          )        
        
       AND E.EDI_GRP_CD = @[cs_grp_id]    		
       AND cgo.EDI_STND_STS_CD in (@[edi_sts])    		
       AND e.edi_grp_cd = cgo.edi_grp_cd     		
       and E.CGO_TRC_SVC_FLG <> 'N' 
        --- join 2 end 
      ) a      		
 where a.edi_grp_cd = r.EDI_GRP_CD(+)	
   and a.bkg_no = r.bkg_no(+)		
   and a.cntr_no = r.cntr_no(+) 	
   and a.EDI_STS_CD = r.EDI_STS_CD(+)	
   and a.edi_sub_sts_cd = r.edi_sub_sts_cd(+)	
   and r.EDI_SND_KNt(+) = 1 
   ) dtl , EDI_CGO_STND_STS sts	
 where sts.EDI_STND_STS_CD = dtl.edi_sts_cd
    and dtl.edi_sts_cd	= @[edi_sts]
 	and dtl.exp_ind   = 'N/A'   
    #if (${diff} == '1')     
    and dtl.gmt_dt2 is null  	
    #end
  and dtl.edi_sub_sts_cd = @[cust_sts] 	        
  	order by vvd, bkg_no, cntr_no,  max_edi_snd_knt, dtl.edi_snd_knt 
)lst
)lst
where page = @[i_page]			]]></sql>
			<params>
				<param name="pagerows" type="12" value="" out="N"/>
				<param name="pol_fromdate" type="12" value="" out="N"/>
				<param name="pol_todate" type="12" value="" out="N"/>
				<param name="pol" type="12" value="" out="N"/>
				<param name="pod_fromdate" type="12" value="" out="N"/>
				<param name="pod_todate" type="12" value="" out="N"/>
				<param name="pod" type="12" value="" out="N"/>
				<param name="edi_sts" type="12" value="" out="N"/>
				<param name="cust_sts" type="12" value="" out="N"/>
				<param name="cs_grp_id" type="12" value="" out="N"/>
				<param name="por" type="12" value="" out="N"/>
				<param name="del" type="12" value="" out="N"/>
				<param name="i_page" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
