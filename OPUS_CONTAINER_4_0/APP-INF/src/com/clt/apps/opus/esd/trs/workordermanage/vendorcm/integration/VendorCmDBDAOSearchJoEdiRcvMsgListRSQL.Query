<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="VendorCmDBDAOSearchJoEdiRcvMsgListRSQL">
			<desc><![CDATA[VendorCmDBDAOSearchJoEdiRcvMsgList]]></desc>
			<sql><![CDATA[
WITH ENTY_MSG AS
(
  SELECT 'EQ' CD ,'Equipment Number' NM FROM DUAL
  UNION ALL
  SELECT 'CNTCNM','Contact Name' FROM DUAL
  UNION ALL 
  SELECT 'CNTCTE' ,'Contact Phone' FROM DUAL
  UNION ALL
  SELECT 'BKG','BKG' FROM DUAL
  UNION ALL
  SELECT 'BL' ,'BL' FROM DUAL
  UNION ALL
  SELECT 'CUTOFF','Cut off Date'FROM DUAL
)
SELECT X.VND_CM_GROUP
      ,X.TRSP_WO_OFC_CTY_CD
      ,X.TRSP_WO_SEQ
      ,X.WO_NO
      ,X.TRSP_SO_OFC_CTY_CD
      ,X.TRSP_SO_SEQ
      ,X.SO_NO
      ,X.EQ_COP_NO
      ,X.RCV_MSG_SEQ
      ,X.RCV_MSG_TP_CD
      ,X.RCV_MSG_TP_CD_NM
	  ,X.RCV_MSG
      ,X.EDI_RJCT_RSN_CD
      ,X.EDI_RJCT_RSN_CD_NM
      ,X.N_LGS_COST_CD
      ,X.N_LGS_COST_CD_NM
      ,X.N_CURR_CD
      ,DECODE(X.RCV_MSG, 'Charges',  TO_CHAR(X.N_RCV_AMT), X.RCV_MSG_DESC) N_RCV_AMT
      ,X.N_FUEL_RTO
      ,X.O_CURR_CD
      ,CASE WHEN X.RCV_MSG = 'Charges' THEN TO_CHAR(X.O_RCV_AMT) ELSE X.OLD_RCV_MSG_DESC END  O_RCV_AMT   
      ,X.O_FUEL_RTO
      ,X.RCV_MSG_STS_CD
      ,X.LOCL_CRE_DT
      ,X.CRE_USR_ID
      ,X.CRE_DT
      ,X.UPD_USR_ID
      ,X.UPD_DT
      ,X.MAX_RCV_MSG_SEQ
      ,Y.INTG_CD_VAL_DP_SEQ
  FROM (SELECT H.TRSP_SO_OFC_CTY_CD || H.TRSP_SO_SEQ || '-' || H.EDI_MSG_SEQ VND_CM_GROUP
              ,T.TRSP_WO_OFC_CTY_CD
              ,T.TRSP_WO_SEQ
              ,T.TRSP_WO_OFC_CTY_CD || T.TRSP_WO_SEQ AS WO_NO
              ,T.TRSP_SO_OFC_CTY_CD
              ,T.TRSP_SO_SEQ
              ,T.TRSP_SO_OFC_CTY_CD || T.TRSP_SO_SEQ AS SO_NO
              ,NVL(SO.EQ_NO, SO.COP_NO) AS EQ_COP_NO
              ,T.RCV_MSG_SEQ
              ,T.RCV_MSG_TP_CD
              ,C.INTG_CD_VAL_DP_DESC AS RCV_MSG_TP_CD_NM
			  ,T.RCV_MSG
			  ,T.RCV_MSG_DESC
              ,T.EDI_RJCT_RSN_CD
              ,D.INTG_CD_VAL_DP_DESC AS EDI_RJCT_RSN_CD_NM
              ,T.LGS_COST_CD AS N_LGS_COST_CD
              ,CASE WHEN T.LGS_COST_CD = 'TRCOST' THEN 'Basic Cost'
                    ELSE NVL((SELECT INTG_CD_VAL_DP_DESC
                            FROM COM_INTG_CD_DTL KK
                           WHERE KK.INTG_CD_VAL_CTNT = DECODE(SUBSTR(T.LGS_COST_CD, 3, 2), 'FU', 'SCFAAL', T.LGS_COST_CD)
                             AND INTG_CD_ID = 'CD30002'), NVL((SELECT NM FROM ENTY_MSG EM WHERE EM.CD = T.LGS_COST_CD), T.LGS_COST_CD))
               END  N_LGS_COST_CD_NM
              ,T.CURR_CD AS N_CURR_CD
              ,T.RCV_AMT AS N_RCV_AMT
              ,T.FUEL_RTO AS N_FUEL_RTO
              ,CASE
                 WHEN T.LGS_COST_CD = 'TRCOST' AND NVL(DTL.LGS_COST_CD, 'X') = 'X' THEN SO.CURR_CD
				 WHEN SUBSTR(T.LGS_COST_CD, 3, 2) = 'FU' AND NVL(DTL.LGS_COST_CD, 'X') <> 'X' THEN SO.CURR_CD
                 WHEN NVL(DTL.LGS_COST_CD, 'X') <> 'X' THEN SO.CURR_CD
                 ELSE ''
               END AS O_CURR_CD
              ,NVL(T.OLD_RCV_AMT, 0) AS O_RCV_AMT
              ,T.OLD_FUEL_RTO AS O_FUEL_RTO
		      ,T.OLD_RCV_MSG_DESC 
              ,T.RCV_MSG_STS_CD
              ,TO_CHAR(H.LOCL_CRE_DT, 'YYYY-MM-DD HH24:MI:SS') LOCL_CRE_DT
              ,T.CRE_USR_ID
              ,T.CRE_DT
              ,T.UPD_USR_ID
              ,T.UPD_DT
              ,H.EDI_MSG_SEQ AS MAX_RCV_MSG_SEQ              
          FROM TRS_EDI_USA_RCV_MSG T
              ,TRS_EDI_WRK_ORD_HIS H
              ,COM_INTG_CD_DTL     C
              ,COM_INTG_CD_DTL     D
              ,TRS_TRSP_SVC_ORD    SO
              ,TRS_TRSP_SCG_DTL    DTL
         WHERE 1=1
           AND (T.TRSP_SO_OFC_CTY_CD, T.TRSP_SO_SEQ) IN (
                #foreach($code IN ${soArrays})  
                  #if($velocityCount == 1)  
                    (SUBSTR('$code', 1, 3), SUBSTR('$code', 4))
                  #else  
                     ,(SUBSTR('$code', 1, 3), SUBSTR('$code', 4))
                  #end 
                #end 
            )
		   AND DECODE(@[history], 'Y', T.RCV_MSG_SEQ, 0) = DECODE(@[history], 'Y', TO_NUMBER(NVL(@[rcv_msg_seq], '0')), 0)
           AND T.TRSP_SO_OFC_CTY_CD = H.TRSP_SO_OFC_CTY_CD
           AND T.TRSP_SO_SEQ = H.TRSP_SO_SEQ
           AND T.RCV_MSG_SEQ = H.EDI_MSG_SEQ
           AND T.TRSP_SO_OFC_CTY_CD = SO.TRSP_SO_OFC_CTY_CD
           AND T.TRSP_SO_SEQ = SO.TRSP_SO_SEQ
		   AND DECODE(@[history], 'Y', 'X', NVL(T.RCV_MSG_STS_CD, 'NULL')) = DECODE(@[history], 'Y', 'X', 'NULL')	
           AND T.RCV_MSG_TP_CD = C.INTG_CD_VAL_CTNT(+)
           AND C.INTG_CD_ID(+) = 'CD30028'
           AND T.EDI_RJCT_RSN_CD = D.INTG_CD_VAL_CTNT(+)
           AND D.INTG_CD_ID(+) = 'CD30025'
           AND T.TRSP_SO_OFC_CTY_CD = DTL.TRSP_SO_OFC_CTY_CD(+)
           AND T.TRSP_SO_SEQ = DTL.TRSP_SO_SEQ(+)
           AND T.LGS_COST_CD = DTL.LGS_COST_CD(+)
		   AND DTL.SCG_DTL_SEQ(+) = 1
		) X
      ,COM_INTG_CD_DTL Y
 WHERE X.N_LGS_COST_CD = Y.INTG_CD_VAL_CTNT(+)
   AND Y.INTG_CD_ID(+) = 'CD30002'
 ORDER BY X.VND_CM_GROUP
         ,X.WO_NO
         ,X.EQ_COP_NO
         ,X.RCV_MSG_SEQ
         ,X.RCV_MSG_TP_CD
         ,DECODE(X.N_LGS_COST_CD, 'TRCOST', 1, DECODE(SUBSTR(X.N_LGS_COST_CD, 3, 2), 'FU', 2, Y.INTG_CD_VAL_DP_SEQ + 2))			]]></sql>
			<params>
				<param name="history" type="12" value="" out="N"/>
				<param name="rcv_msg_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
