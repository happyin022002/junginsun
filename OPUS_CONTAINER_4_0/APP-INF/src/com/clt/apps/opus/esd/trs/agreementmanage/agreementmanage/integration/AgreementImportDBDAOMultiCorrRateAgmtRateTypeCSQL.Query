<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="AgreementImportDBDAOMultiCorrRateAgmtRateTypeCSQL">
			<desc><![CDATA[Rate Type Update]]></desc>
			<sql><![CDATA[
INSERT INTO TRS_AGMT_RT_TP (
 TRSP_AGMT_OFC_CTY_CD
,TRSP_AGMT_SEQ
,TRSP_AGMT_RT_TP_SER_NO
,TRSP_AGMT_RT_TP_CD
,TRSP_BND_CD
,CGO_TP_CD
,SPCL_CGO_CNTR_TP_CD
,CUST_NOMI_TRKR_FLG
,CUST_CNT_CD
,CUST_SEQ
,TRSP_COST_MOD_CD
,AGMT_TRSP_TP_CD
,CMDT_GRP_CD
,RAIL_SVC_TP_CD
,DELT_FLG
,CRE_USR_ID
,CRE_DT
,CRE_OFC_CD
,UPD_USR_ID
,UPD_OFC_CD
,UPD_DT
)
SELECT TRSP_AGMT_OFC_CTY_CD,
       TRSP_AGMT_SEQ,
       (SELECT NVL(MAX(TRSP_AGMT_RT_TP_SER_NO),0) FROM TRS_AGMT_RT_TP WHERE TRSP_AGMT_OFC_CTY_CD = XX.TRSP_AGMT_OFC_CTY_CD AND TRSP_AGMT_SEQ = XX.TRSP_AGMT_SEQ)
         + RANK() OVER ( PARTITION BY TRSP_AGMT_OFC_CTY_CD, TRSP_AGMT_SEQ
                         ORDER BY TRSP_AGMT_RT_TP_CD,
                                  TRSP_BND_CD,
                                  CGO_TP_CD,
                                  SPCL_CGO_CNTR_TP_CD,
                                  CUST_NOMI_TRKR_FLG,
                                  CUST_CNT_CD,
                                  CUST_SEQ,
                                  TRSP_COST_MOD_CD,
                                  AGMT_TRSP_TP_CD,
                                  CMDT_GRP_CD,
                                  RAIL_SVC_TP_CD) 
       AS TRSP_AGMT_RT_TP_SER_NO,
       TRSP_AGMT_RT_TP_CD,
	   TRSP_BND_CD,
       CGO_TP_CD,
	   SPCL_CGO_CNTR_TP_CD,
       CUST_NOMI_TRKR_FLG,
       CUST_CNT_CD,
       CUST_SEQ,
       TRSP_COST_MOD_CD,
       AGMT_TRSP_TP_CD,
       CMDT_GRP_CD,
       RAIL_SVC_TP_CD,
       DELT_FLG,
       @[fm_account_usr_id],
       SYSDATE,
       @[fm_account_ofc_cd],
       @[fm_account_usr_id],
       @[fm_account_ofc_cd],
       SYSDATE
  FROM 
       (
        SELECT X.TRSP_AGMT_OFC_CTY_CD,
               X.TRSP_AGMT_SEQ,
               X.TRSP_AGMT_RT_TP_CD,
               X.TRSP_COST_MOD_CD,
               X.AGMT_TRSP_TP_CD,
			   X.TRSP_BND_CD,
               X.CGO_TP_CD,
			   X.SPCL_CGO_CNTR_TP_CD,
               X.CUST_NOMI_TRKR_FLG,
               X.CUST_CNT_CD,
               X.CUST_SEQ,
               X.CMDT_GRP_CD,
               X.RAIL_SVC_TP_CD,
               MAX(X.DELT_FLG) DELT_FLG,
               (
                SELECT /*+ INDEX_DESC(TRS_AGMT_RT_TP XPKTRS_AGMT_RT_TP) */
                       TRSP_AGMT_RT_TP_SER_NO
                  FROM TRS_AGMT_RT_TP
                 WHERE TRSP_AGMT_OFC_CTY_CD          = X.TRSP_AGMT_OFC_CTY_CD
                   AND TRSP_AGMT_SEQ                 = X.TRSP_AGMT_SEQ
                   AND TRSP_AGMT_RT_TP_CD            = X.TRSP_AGMT_RT_TP_CD
                   AND TRSP_COST_MOD_CD              = X.TRSP_COST_MOD_CD
                   AND AGMT_TRSP_TP_CD               = X.AGMT_TRSP_TP_CD
                   AND NVL(TRSP_BND_CD, 'N')         = NVL(X.TRSP_BND_CD, 'N')
                   AND CGO_TP_CD                     = X.CGO_TP_CD
                   AND NVL(SPCL_CGO_CNTR_TP_CD, 'N') = NVL(X.SPCL_CGO_CNTR_TP_CD, 'N')
                   AND CUST_NOMI_TRKR_FLG            = X.CUST_NOMI_TRKR_FLG
                   AND CUST_CNT_CD                   = X.CUST_CNT_CD
                   AND CUST_SEQ                      = X.CUST_SEQ
                   AND CMDT_GRP_CD                   = X.CMDT_GRP_CD
                   AND RAIL_SVC_TP_CD                = X.RAIL_SVC_TP_CD
                   AND ROWNUM = 1
               ) AS TRSP_AGMT_RT_TP_SER_NO
          FROM TRS_AGMT_TMP X
         WHERE X.TRSP_TMP_SEQ = @[trsp_tmp_seq]
           AND X.ROW_NO IS NOT NULL
         GROUP BY X.TRSP_AGMT_OFC_CTY_CD,
                  X.TRSP_AGMT_SEQ,
                  X.TRSP_AGMT_RT_TP_CD,
                  X.TRSP_COST_MOD_CD,
                  X.AGMT_TRSP_TP_CD,
				  X.TRSP_BND_CD,
                  X.CGO_TP_CD,
				  X.SPCL_CGO_CNTR_TP_CD,
                  X.CUST_NOMI_TRKR_FLG,
                  X.CUST_CNT_CD,
                  X.CUST_SEQ,
                  X.CMDT_GRP_CD,
                  X.RAIL_SVC_TP_CD
       ) XX
 WHERE TRSP_AGMT_RT_TP_SER_NO IS NULL			]]></sql>
			<params>
				<param name="fm_account_usr_id" type="12" value="" out="N"/>
				<param name="fm_account_ofc_cd" type="12" value="" out="N"/>
				<param name="trsp_tmp_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
