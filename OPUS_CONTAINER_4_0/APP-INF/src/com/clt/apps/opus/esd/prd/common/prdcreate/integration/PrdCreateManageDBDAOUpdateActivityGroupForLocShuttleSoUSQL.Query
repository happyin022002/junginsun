<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="PrdCreateManageDBDAOUpdateActivityGroupForLocShuttleSoUSQL">
			<desc><![CDATA[PrdCreateManageDBDAOUpdateActivityGroupForLocShuttleSoUSQL]]></desc>
			<sql><![CDATA[
UPDATE PRD_PROD_CTL_ACT_GRP_DTL D   
SET TRSP_SO_STS_CD = 'U'   
WHERE N1ST_NOD_CD||N2ND_NOD_CD =   
(   
    SELECT   
        CASE WHEN PRE='TD' AND SUBSTR(PRE_ORG,1,5) = SUBSTR(PRE_DEST,1,5) THEN PRE_ORG||PRE_DEST   
             WHEN POST='TD' AND SUBSTR(POST_ORG,1,5) = SUBSTR(POST_DEST,1,5) THEN POST_ORG||POST_ORG   
        END ORG   
    FROM   
    (   
        SELECT ID.ROUT_ORG_NOD_CD, ID.ROUT_DEST_NOD_CD, ID.ROUT_SEQ,   
        ID.LNK_ORG_NOD_CD, ID.LNK_DEST_NOD_CD, ID.ROUT_DTL_SEQ, ID.TRSP_MOD_CD,   
        LAG(id.TRSP_MOD_CD,1)  OVER(PARTITION BY ID.ROUT_ORG_NOD_CD,ID.ROUT_DEST_NOD_CD,ID.ROUT_SEQ ORDER BY ID.ROUT_ORG_NOD_CD,ID.ROUT_DEST_NOD_CD,ID.ROUT_DTL_SEQ) PRE,   
        LAG(LNK_ORG_NOD_CD,1)  OVER(PARTITION BY ID.ROUT_ORG_NOD_CD,ID.ROUT_DEST_NOD_CD,ID.ROUT_SEQ ORDER BY ID.ROUT_ORG_NOD_CD,ID.ROUT_DEST_NOD_CD,ID.ROUT_DTL_SEQ) PRE_ORG,   
        LAG(LNK_DEST_NOD_CD,1)  OVER(PARTITION BY ID.ROUT_ORG_NOD_CD,ID.ROUT_DEST_NOD_CD,ID.ROUT_SEQ ORDER BY ID.ROUT_ORG_NOD_CD,ID.ROUT_DEST_NOD_CD,ID.ROUT_DTL_SEQ) PRE_DEST,   
        LEAD(id.TRSP_MOD_CD,1) OVER(PARTITION BY ID.ROUT_ORG_NOD_CD,ID.ROUT_DEST_NOD_CD,ID.ROUT_SEQ ORDER BY ID.ROUT_ORG_NOD_CD,ID.ROUT_DEST_NOD_CD,ID.ROUT_DTL_SEQ)  POST,   
        LEAD(LNK_ORG_NOD_CD,1) OVER(PARTITION BY ID.ROUT_ORG_NOD_CD,ID.ROUT_DEST_NOD_CD,ID.ROUT_SEQ ORDER BY ID.ROUT_ORG_NOD_CD,ID.ROUT_DEST_NOD_CD,ID.ROUT_DTL_SEQ)  POST_ORG,   
        LEAD(LNK_DEST_NOD_CD,1) OVER(PARTITION BY ID.ROUT_ORG_NOD_CD,ID.ROUT_DEST_NOD_CD,ID.ROUT_SEQ ORDER BY ID.ROUT_ORG_NOD_CD,ID.ROUT_DEST_NOD_CD,ID.ROUT_DTL_SEQ)  POST_DEST   
        FROM PRD_INLND_ROUT_MST IM,  PRD_INLND_ROUT_DTL ID,   
        (   
            SELECT ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ   
            FROM PRD_PROD_CTL_ACT_GRP_DTL   
            WHERE COST_ACT_GRP_TP_CD='L'   
            AND PCTL_IO_BND_CD IN( 'I','O')   
            AND TRSP_MOD_CD='TD'   
            AND ROUT_SEQ > 0   
            AND PCTL_NO LIKE @[hd_pctl_no]||'%'   
            AND ROWNUM =1   
        ) AD   
        WHERE IM.ROUT_ORG_NOD_CD= AD.ROUT_ORG_NOD_CD   
        AND IM.ROUT_DEST_NOD_CD= AD.ROUT_DEST_NOD_CD   
        AND IM.ROUT_SEQ = AD.ROUT_SEQ   
        AND IM.ROUT_ORG_NOD_CD= ID.ROUT_ORG_NOD_CD   
        AND IM.ROUT_DEST_NOD_CD= ID.ROUT_DEST_NOD_CD   
        AND IM.ROUT_SEQ = ID.ROUT_SEQ   
        AND IM.ROUT_PLN_CD IN ('82','87')   
    )   
    WHERE TRSP_MOD_CD='RD' and  (SUBSTR(PRE_ORG,1,5) = SUBSTR(PRE_DEST,1,5) or SUBSTR(POST_ORG,1,5) = SUBSTR(POST_DEST,1,5) ) and rownum =1  
)   
AND PCTL_NO LIKE @[hd_pctl_no]||'%'  
AND TRSP_MOD_CD='TD'   
AND PCTL_IO_BND_CD IN ('I','O')   
AND TRSP_SO_STS_CD ='P'   
AND SUBSTR(N1ST_NOD_CD,1,5) = SUBSTR(N2ND_NOD_CD,1,5)   
AND SUBSTR(N2ND_NOD_CD,1,5) = SUBSTR(NVL(N3RD_NOD_CD,N2ND_NOD_CD) ,1,5)   
AND SUBSTR(NVL(N3RD_NOD_CD,'X'),1,5) = SUBSTR( DECODE(N3RD_NOD_CD,'','X',DECODE(N4TH_NOD_CD,'',SUBSTR(NVL(N3RD_NOD_CD,'X'),1,5),N4TH_NOD_CD)) ,1,5)			]]></sql>
			<params>
				<param name="hd_pctl_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
