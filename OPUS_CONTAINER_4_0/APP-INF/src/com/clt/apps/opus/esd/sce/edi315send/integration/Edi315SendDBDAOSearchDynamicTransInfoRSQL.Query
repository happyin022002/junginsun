<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="Edi315SendDBDAOSearchDynamicTransInfoRSQL">
			<desc><![CDATA[동적 TransInfo 조회]]></desc>
			<sql><![CDATA[
SELECT TRANS_TP_CD
     , VSL_CD||SKD_VOY_NO||SKD_DIR_CD AS VVD
     , COP_DTL_SEQ -- 다음 단계의 Parameter
     , NOD_CD
     , TRANS_TP_CD||TO_CHAR(ROWNUM + 1) AS TRANS_TP_KEY /*OBSTRT, OBIMD 2개의 아이템 다음에 오기대문에 Key 를 만들때 +2 를 해준다.*/ -- OBSTRT를 포함하기 위해 + 1
  FROM (SELECT TRANS_TP_CD
             , VSL_CD
             , SKD_VOY_NO
             , SKD_DIR_CD
             , NOD_CD -- 0715 추가
             , COP_DTL_SEQ
          FROM (SELECT 'OBIMD' AS TRANS_TP_CD
                     , '' AS VSL_CD
                     , '' AS SKD_VOY_NO
                     , '' AS SKD_DIR_CD
                     , NOD_CD AS NOD_CD -- 0715 추가
                     , COP_DTL_SEQ
                  FROM SCE_COP_HDR SCH
                     , SCE_COP_DTL SCD
                 WHERE SCH.COP_NO = @[cop_no] --paremter
                   AND SCH.COP_NO = SCD.COP_NO
                   AND SUBSTR(ACT_CD,2,1) = 'O'
                   AND SUBSTR(ACT_CD,5,2) IN  ('DO') -- 출발지 기준 조회
                   AND SUBSTR(ACT_CD,1,1) = 'F'
                   AND SUBSTR(SCH.POR_NOD_CD, 1, 5) <> SUBSTR(SCH.POL_NOD_CD,1,5)
                 UNION ALL
                SELECT DECODE(VSL_PRE_PST_CD, 'S','TRNKPC', 'T', 'TRNKMC', 'U','TRNKOC') AS TRANS_TP_CD
                     , BV.VSL_CD
                     , BV.SKD_VOY_NO
                     , BV.SKD_DIR_CD
                     , POL_YD_CD AS NOD_CD -- 0717 추가 
                     , MIN(COP_DTL_SEQ)
                  FROM SCE_COP_HDR SCH
                     , MDM_VSL_CNTR MVC
                     , BKG_VVD BV
                     , VSK_VSL_PORT_SKD SKD
                     , MDM_VSL_SVC_LANE MV
                     , SCE_COP_DTL SCD
                 WHERE SCH.COP_STS_CD IN ('C', 'T', 'F')
                   AND SCH.COP_NO = @[cop_no] --parameter
                   AND BV.VSL_CD = MVC.VSL_CD(+)
                   AND SCH.BKG_NO = BV.BKG_NO
                   AND SKD.SKD_VOY_NO(+) = BV.SKD_VOY_NO
                   AND SKD.SKD_DIR_CD(+) = BV.SKD_DIR_CD
                   AND SKD.VPS_PORT_CD(+) = BV.POL_YD_CD
                   AND SKD.CLPT_IND_SEQ(+) = BV.POL_CLPT_IND_SEQ
                   AND BV.SLAN_CD = MV.VSL_SLAN_CD(+)
                   AND SUBSTR(SCD.NOD_CD, 1, 5)  = SUBSTR(BV.POL_YD_CD, 1, 5)
                   AND SCH.COP_NO = SCD.COP_NO
                   AND SCD.VSL_CD is not null
                   GROUP BY DECODE(VSL_PRE_PST_CD, 'S','TRNKPC', 'T', 'TRNKMC', 'U','TRNKOC') 
                     , BV.VSL_CD
                     , BV.SKD_VOY_NO
                     , BV.SKD_DIR_CD
                     , POL_YD_CD
                 UNION ALL
            SELECT 'TRNKTT' AS TRANS_TP_CD
                     , '' AS VSL_CD
                     , '' AS SKD_VOY_NO
                     , '' AS SKD_DIR_CD
                     , NOD_CD AS NOD_CD -- 0715 추가
                     , COP_DTL_SEQ
                  FROM SCE_COP_DTL
                 WHERE COP_NO = @[cop_no] --paremter
                   AND ACT_CD = 'FTTMDO'
                 UNION ALL
            SELECT 'IBIMD' AS TRANS_TP_CD
                     , '' AS VSL_CD
                     , '' AS SKD_VOY_NO
                     , '' AS SKD_DIR_CD
                     , NOD_CD AS NOD_CD -- 0715 추가
                     , COP_DTL_SEQ
                  FROM SCE_COP_HDR SCH
                     , SCE_COP_DTL SCD
                 WHERE SCH.COP_NO = @[cop_no] --paremter
                   AND SCH.COP_NO = SCD.COP_NO
                   AND SUBSTR(ACT_CD,2,1) = 'I'
                   AND SUBSTR(ACT_CD,5,2) IN ('AD') --- 도착지 
                   AND SUBSTR(ACT_CD,1,1) = 'F'
                   AND SUBSTR(SCH.DEL_NOD_CD, 1, 5) <> SUBSTR(SCH.POD_NOD_CD,1,5) -- IMD 
        )
         ORDER BY COP_DTL_SEQ 
    )			]]></sql>
			<params>
				<param name="cop_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
