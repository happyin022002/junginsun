<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="PrdCreateManageDBDAOUpdatePrdDtlLnkCnstUSQL">
			<desc><![CDATA[PrdCreateManageDBDAOUpdatePrdDtlLnkCnstUSQL]]></desc>
			<sql><![CDATA[
UPDATE 		PRD_PROD_CTL_ROUT_DTL D2   
SET 		D2.CNST_FLG 
			= 
			(   
            SELECT 	RD_SVC   
            FROM 	(   
                	SELECT		SVC
							,	PCTL_NO 
							,	ORG_NOD_CD
							,	DEST_NOD_CD
							,	TRSP_MOD_CD
							,	PRI  
							,	DECODE(SUBSTR(CNTR_TPSZ_CD,1,1),'R',DECODE(@[rd_f],'Y',DECODE(SVC,'X',DECODE(CNTR_TPSZ_CD,CNTR_TP_CD,''),SVC),SVC),SVC) RD_SVC  
                	FROM 		(	   
                     			SELECT  	DECODE(NVL(SVC_USE_FLG, 'Y'), 'N', 'X', 'L') SVC 
										,	PCTL_CNST_ITM_NM  
										,	D.ORG_NOD_CD
										, 	D.DEST_NOD_CD
										,	C.CNTR_TP_CD
										,	Q.CNTR_TPSZ_CD
										,	D.TRSP_MOD_CD   
										,	D.PCTL_NO   
										,	ROW_NUMBER() OVER(PARTITION BY D.PCTL_NO,D.ORG_NOD_CD,D.DEST_NOD_CD,D.TRSP_MOD_CD ORDER BY DECODE(LENGTH(C.LNK_ORG_NOD_CD),7,1,5,2,3),DECODE(LENGTH(C.LNK_DEST_NOD_CD),7,1,5,2,3),C.LNK_ORG_NOD_CD,C.LNK_DEST_NOD_CD,D.TRSP_MOD_CD,DECODE(NVL(SVC_USE_FLG,'Y'),'N','X','L') DESC) PRI   
                     			FROM 		PRD_LNK_CNST_MGMT 				C
										, 	PRD_PROD_CTL_QTY 				Q 
										, 	PRD_PROD_CTL_ROUT_DTL 			D   
                     					,	PRD_PROD_CTL_MST 				M 
			                     WHERE 		1 = 1
								 AND 		D.PCTL_NO   					LIKE @[hd_pctl_no]||'%'   
			                     AND 		M.PCTL_NO 						= D.PCTL_NO    
			                     AND 		D.NOD_LNK_DIV_CD 				= 'L'   
			                     AND 		D.PCTL_NO 						= Q.PCTL_NO   

								 -- :2016-12-16-FRI: -------------------------------------------------------------------------------
			                     AND 		D.ORG_NOD_CD 					LIKE C.LNK_ORG_NOD_CD||'%'   
			                     AND 		D.DEST_NOD_CD 					LIKE C.LNK_DEST_NOD_CD||'%'  

								 ----AND		CASE 	WHEN NVL(C.LNK_ORG_NOD_CD,'ALL') = 'ALL' THEN 'ALL'
               					----					WHEN NVL(C.LNK_ORG_NOD_CD,'ALL') <>'ALL' THEN C.LNK_ORG_NOD_CD
               					----					ELSE '*'
          						----			END                 			= CASE	WHEN NVL(C.LNK_ORG_NOD_CD,'ALL') = 'ALL' THEN 'ALL'
                                ----     												WHEN NVL(C.LNK_ORG_NOD_CD,'ALL') <>'ALL' THEN SUBSTR(D.ORG_NOD_CD,1,LENGTH(C.LNK_ORG_NOD_CD))
                                ----     												ELSE '**'
                                ----											  END
								---- AND		CASE 	WHEN NVL(C.LNK_DEST_NOD_CD,'ALL') = 'ALL' THEN 'ALL'
               					----					WHEN NVL(C.LNK_DEST_NOD_CD,'ALL') <>'ALL' THEN C.LNK_DEST_NOD_CD
               					----					ELSE '*'
          						----			END                 			= CASE 	WHEN NVL(C.LNK_DEST_NOD_CD,'ALL') = 'ALL' THEN 'ALL'
                                ----     												WHEN NVL(C.LNK_DEST_NOD_CD,'ALL') <>'ALL' THEN SUBSTR(D.DEST_NOD_CD,1,LENGTH(C.LNK_DEST_NOD_CD))
                                ----     												ELSE '**'
                                ----											  END   
								 -----------------------------------------------------------------------------------------------------
 
			                     AND 		D.TRSP_MOD_CD 					= DECODE(C.TRSP_MOD_CD, 'AL' ,D.TRSP_MOD_CD, C.TRSP_MOD_CD )  
			                     AND 		NVL(M.CMDT_CD	, '*')  		= NVL(C.CMDT_CD, NVL(M.CMDT_CD,'*'))    
			                     AND 		NVL(C.DELT_FLG	, 'N') 			= 'N'   
			                     AND 		NVL(C.SPCL_CGO_CNTR_TP_CD,'AL') = (	CASE 	WHEN NVL(C.SPCL_CGO_CNTR_TP_CD	,'AL') 	= 'AL' 										THEN NVL(C.SPCL_CGO_CNTR_TP_CD,'AL')
			                                                                 			WHEN NVL(M.DG_SPCL_FLG			,'N') 	= 'Y' AND NVL(M.RF_SPCL_FLG		,'N') = 'Y' THEN 'RD'
			                                                                 			WHEN NVL(M.DG_SPCL_FLG			,'N') 	= 'Y' AND NVL(M.SPCL_AWK_CGO_FLG,'N') = 'Y' THEN 'AD'
			                                                                 			WHEN NVL(M.DG_SPCL_FLG			,'N') 	= 'Y' 										THEN 'DG'
			                                                                 			WHEN NVL(M.RF_SPCL_FLG			,'N') 	= 'Y' 										THEN 'RF'
			                                                                 			WHEN NVL(M.SPCL_AWK_CGO_FLG		,'N') 	= 'Y' 										THEN 'AK'
			                                                                 			WHEN NVL(M.BB_SPCL_FLG			,'N') 	= 'Y' 										THEN 'BB'
			                                                                 			WHEN NVL(M.DG_SPCL_FLG			,'N') 	= 'N' AND NVL(M.RF_SPCL_FLG,'N') ='N' AND NVL(M.SPCL_AWK_CGO_FLG,'N') = 'N' AND NVL(M.BB_SPCL_FLG,'N') = 'N' THEN 'GP'
			                                                             		END
																				)
			                     AND 		Q.CNTR_TPSZ_CD 					LIKE NVL(C.CNTR_TP_CD,'%')||NVL(C.CNTR_SZ_CD,'%')
			                     AND 		(   
			                    				(   
			                    				TRUNC(TO_DATE(NVL(C.EFF_FM_DT,'19000101'),'yyyy/mm/dd hh24:mi:ss')) <= D.ARR_ST_DT 
												AND   
			                    				D.ARR_ST_DT < TRUNC(TO_DATE(NVL(C.EFF_TO_DT,'25000101'),'yyyy/mm/dd hh24:mi:ss')+1)   
			                    				) 
												OR   
			                    				(   
			                    				TRUNC(TO_DATE(NVL(C.EFF_FM_DT,'19000101'),'yyyy/mm/dd hh24:mi:ss')) <= D.DEP_FSH_DT 
												AND   
			                    				D.DEP_FSH_DT < TRUNC(TO_DATE(NVL(C.EFF_TO_DT,'25000101'),'yyyy/mm/dd hh24:mi:ss')+1)   
			                    				)   
			                    			)   
			                	)   
					)   
			        WHERE 		PRI 		= 1 
					AND 		PCTL_NO 	= D2.PCTL_NO   
			        AND 		ORG_NOD_CD 	= D2.ORG_NOD_CD   
			        AND 		DEST_NOD_CD = D2.DEST_NOD_CD   
			        AND 		TRSP_MOD_CD = D2.TRSP_MOD_CD   
			        AND 		ROWNUM 		= 1    
 
	  		)   
WHERE 		D2.PCTL_NO 			LIKE @[hd_pctl_no]||'%'   
AND 		D2.NOD_LNK_DIV_CD 	= 'L'			]]></sql>
			<params>
				<param name="rd_f" type="12" value="" out="N"/>
				<param name="hd_pctl_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
