<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="BkgCopManageDBDAOSearchCopToRcvTroRSQL">
			<desc><![CDATA[container 가 detach 되거나 cancel 될 COP 의 tro 정보를 대신 관리할 cop 를 선정한다.
선정 기준 :
1. cancel 되지 않음
2. container 가 존재하는 것이 1순위, 없는 것이 후순위
3. ob tro 와 무관할것
4. flex height 를 감안하여 호환 가능한 tpsz 를 가진 cop]]></desc>
			<sql><![CDATA[
SELECT COP_NO,
  BKG_NO,
  COP_STS_CD,
  OB_TRO_FLG,
  CNTR_NO,
  CFM_OB_DOR_ARR_DT
FROM (
    SELECT A.COP_NO,
      A.BKG_NO,
      A.COP_STS_CD,
      A.OB_TRO_FLG,
      A.CNTR_NO,
	  TO_CHAR(M.CFM_OB_DOR_ARR_DT, 'YYYYMMDDHH24MISS') AS CFM_OB_DOR_ARR_DT
    FROM SCE_COP_HDR A,
      BKG_BOOKING B,
      SCE_COP_HDR M
    WHERE A.BKG_NO = B.BKG_NO
      AND A.BKG_NO = M.BKG_NO
      AND M.COP_NO = @[cop_no]
      AND A.COP_STS_CD != 'X'
      AND A.OB_TRO_FLG = 'N'
	  AND M.OB_TRO_FLG = 'Y'
      AND (CASE WHEN NVL(B.FLEX_HGT_FLG, 'N') = 'Y'
          AND A.CNTR_TPSZ_CD IN (
            SELECT CNTR_TPSZ_CD
            FROM SCE_COP_CNTR_REPO_RULE
            WHERE (CNTR_TPSZ_CD = M.CNTR_TPSZ_CD
                  OR PROV_CNTR_TPSZ_CD = M.CNTR_TPSZ_CD)
              AND NVL(ACT_FLG, 'N') = 'Y') THEN 'TRUE' WHEN NVL(B.FLEX_HGT_FLG, 'N') = 'N'
          AND A.CNTR_TPSZ_CD = M.CNTR_TPSZ_CD THEN 'TRUE' ELSE 'FALSE' END) = 'TRUE'
    ORDER BY DECODE(A.CNTR_NO, 'COMU0000000', 2, 1) )
WHERE 
COP_STS_CD != 'X'
AND CNTR_NO != 'COMU0000000'
AND ROWNUM = 1			]]></sql>
			<params>
				<param name="cop_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
