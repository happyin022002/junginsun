<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CopDetailReceiveDBDAOSearchAutoMVMTRSQL">
			<desc><![CDATA[SearchAutoMVMT]]></desc>
			<sql><![CDATA[
SELECT 
CNTR_NO
,BKG_NO
,ACT_STS_MAPG_CD
,NOD_CD
,ACT_DT
,EDI_MSG_TP_CD
,CRE_TP_CD
,CRE_USR_ID
,VNDR_SEQ
,BND_VSKD_SEQ_CD
,ACT_DAT_RCV_DT
,VSL_CD
,SKD_VOY_NO
,SKD_DIR_CD
,UPD_USR_ID
,CLPT_IND_SEQ
,VSL_DLAY_RSN_CD
,VSL_DLAY_RSN_DESC
,VPS_LOC_CD
,ACT_CD
,RAIL_DEST_N1ST_ETA_DT
,ACT_GDT
,CNMV_YR
,CNMV_ID_NO
,CNMV_SEQ
,CNMV_SPLIT_NO
,CNMV_CYC_NO
,IMDT_EXT_FLG
FROM 
(
SELECT 
@[cntr_no] AS CNTR_NO
,@[bkg_no] AS BKG_NO
,DECODE(@[act_rcv_tp_cd],'21','ATA','22','ATB','23','ATD',@[act_sts_mapg_cd]) AS ACT_STS_MAPG_CD
,@[nod_cd] AS NOD_CD
,TO_CHAR(to_date(@[act_dt],'YYYYMMDDHH24MI'), 'YYYY/MM/DD HH24:MI:SS') AS ACT_DT
,@[edi_msg_tp_cd] AS EDI_MSG_TP_CD
,@[cre_tp_cd]  AS CRE_TP_CD
,@[cre_usr_id] AS CRE_USR_ID
,@[vndr_seq] AS VNDR_SEQ
,@[bnd_vskd_seq_cd] AS BND_VSKD_SEQ_CD
,TO_CHAR( GLOBALDATE_PKG.TIME_CONV_FNC('KRSEL', sysdate, substr(@[nod_cd],1,5)),'YYYY/MM/DD HH24:MI:SS' )  ACT_DAT_RCV_DT
,@[vsl_cd] AS VSL_CD
,@[skd_voy_no] AS SKD_VOY_NO
,@[skd_dir_cd] AS SKD_DIR_CD
,@[cre_usr_id] AS UPD_USR_ID
,@[vps_port_cd] AS VPS_PORT_CD
,@[clpt_ind_seq] AS CLPT_IND_SEQ
,@[vsl_dlay_rsn_cd] AS VSL_DLAY_RSN_CD
,@[vsl_dlay_rsn_desc] AS VSL_DLAY_RSN_DESC
,@[vps_loc_cd] AS VPS_LOC_CD
,@[act_cd] AS ACT_CD
,to_date(@[rail_dest_n1st_eta_dt],'YYYY/MM/DD HH24:MI:SS') AS RAIL_DEST_N1ST_ETA_DT
,(CASE WHEN SUBSTR(@[nod_cd],1,5) IS NOT NULL
       THEN GLOBALDATE_PKG.TIME_CONV_FNC(SUBSTR(@[nod_cd],1,5), to_date(@[act_dt],'YYYYMMDDHH24MI'), 'GMT')
  END) AS ACT_GDT
,@[cnmv_yr] AS CNMV_YR
,TO_NUMBER(@[cnmv_id_no]) AS CNMV_ID_NO
,TO_NUMBER(@[cnmv_seq]) AS CNMV_SEQ
,@[cnmv_split_no] AS CNMV_SPLIT_NO
,TO_NUMBER(@[cnmv_cyc_no]) AS CNMV_CYC_NO
,@[imdt_ext_flg] AS IMDT_EXT_FLG
FROM DUAL

UNION

SELECT TO_CHAR(CNTR_NO)	CNTR_NO
,TO_CHAR(BKG_NO) BKG_NO
,TO_CHAR(MVMT_STS_CD) ACT_STS_MAPG_CD
,TO_CHAR(ORG_YD_CD) NOD_CD
,TO_CHAR(CNMV_EVNT_DT,'YYYY/MM/DD HH24:MI:SS') ACT_DT
,TO_CHAR(CASE WHEN MVMT_EDI_MSG_TP_ID is null
     THEN ( CASE WHEN MVMT_CRE_TP_CD in ('A', 'C', 'L','N','M','U','E')
                 THEN 'SYSTEM'
                 WHEN MVMT_CRE_TP_CD is null
                 THEN SUBSTR(CRE_USR_ID,1,10)
            END
          )
     ELSE MVMT_EDI_MSG_TP_ID
 END) EDI_MSG_TP_CD
,TO_CHAR(MVMT_CRE_TP_CD) CRE_TP_CD
,'SCEFND' CRE_USR_ID
,TO_CHAR(VNDR_SEQ) VNDR_SEQ
,TO_CHAR(OB_CNTR_FLG) BND_VSKD_SEQ_CD
,TO_CHAR(UPD_LOCL_DT,'YYYY/MM/DD HH24:MI:SS') ACT_DAT_RCV_DT
,TO_CHAR(CRNT_VSL_CD) VSL_CD
,TO_CHAR(CRNT_SKD_VOY_NO) SKD_VOY_NO
,TO_CHAR(CRNT_SKD_DIR_CD) SKD_DIR_CD
,CRE_USR_ID AS UPD_USR_ID
,'' AS VPS_PORT_CD
,'' AS CLPT_IND_SEQ
,'' AS VSL_DLAY_RSN_CD
,'' AS VSL_DLAY_RSN_DESC
,'' AS VPS_LOC_CD
,'' AS ACT_CD
,NULL AS RAIL_DEST_N1ST_ETA_DT
,(CASE WHEN SUBSTR(ORG_YD_CD,1,5) IS NOT NULL
       THEN GLOBALDATE_PKG.TIME_CONV_FNC(SUBSTR(ORG_YD_CD,1,5), CNMV_EVNT_DT, 'GMT')
  END) AS ACT_GDT
,CNMV_YR
,CNMV_ID_NO
,CNMV_SEQ
,CNMV_SPLIT_NO
,CNMV_CYC_NO
,imdt_ext_flg
FROM CTM_MOVEMENT
WHERE CNTR_NO=TO_CHAR(@[cntr_no])
AND   CNMV_EVNT_DT = TO_DATE(@[act_dt],'YYYYMMDDHH24MI')
AND		(
			MVMT_STS_CD <> TO_CHAR(@[act_sts_mapg_cd])
			OR
			( MVMT_STS_CD = TO_CHAR(@[act_sts_mapg_cd]) AND ORG_YD_CD <> @[nod_cd] )

		)

union

SELECT 
		TO_CHAR(CNTR_NO)	CNTR_NO
		,TO_CHAR(BKG_NO) BKG_NO
		,TO_CHAR(MVMT_STS_CD) ACT_STS_MAPG_CD
		,TO_CHAR(ORG_YD_CD) NOD_CD
		,TO_CHAR(CNMV_EVNT_DT,'YYYY/MM/DD HH24:MI:SS') ACT_DT
		,TO_CHAR(CASE WHEN MVMT_EDI_MSG_TP_ID is null
			 THEN ( CASE WHEN MVMT_CRE_TP_CD in ('A', 'C', 'L','N','M','U','E')
						 THEN 'SYSTEM'
						 WHEN MVMT_CRE_TP_CD is null
						 THEN SUBSTR(CRE_USR_ID,1,10)
					END
				  )
			 ELSE MVMT_EDI_MSG_TP_ID
		 END) EDI_MSG_TP_CD
		,TO_CHAR(MVMT_CRE_TP_CD) CRE_TP_CD
		,'SCE_U_FND' CRE_USR_ID
		,TO_CHAR(VNDR_SEQ) VNDR_SEQ
		,TO_CHAR(OB_CNTR_FLG) BND_VSKD_SEQ_CD
        ,TO_CHAR(UPD_LOCL_DT,'YYYY/MM/DD HH24:MI:SS') ACT_DAT_RCV_DT
		,TO_CHAR(CRNT_VSL_CD) VSL_CD
		,TO_CHAR(CRNT_SKD_VOY_NO) SKD_VOY_NO
		,TO_CHAR(CRNT_SKD_DIR_CD) SKD_DIR_CD
		,CRE_USR_ID AS UPD_USR_ID
		,'' AS VPS_PORT_CD
		,'' AS CLPT_IND_SEQ
		,'' AS VSL_DLAY_RSN_CD
		,'' AS VSL_DLAY_RSN_DESC
		,'' AS VPS_LOC_CD
		,'' AS ACT_CD
		,NULL AS RAIL_DEST_N1ST_ETA_DT
		,(CASE WHEN SUBSTR(ORG_YD_CD,1,5) IS NOT NULL
			   THEN GLOBALDATE_PKG.TIME_CONV_FNC(SUBSTR(ORG_YD_CD,1,5), CNMV_EVNT_DT, 'GMT')
		  END) AS ACT_GDT
		,CNMV_YR
		,CNMV_ID_NO
		,CNMV_SEQ
		,CNMV_SPLIT_NO
		,CNMV_CYC_NO
		,imdt_ext_flg
FROM	CTM_MOVEMENT	M	
WHERE	1 = 1
AND		M.CNTR_NO				=	@[cntr_no]
AND		M.CNMV_CYC_NO			IN	( TO_NUMBER(@[cnmv_cyc_no]), (TO_NUMBER(@[cnmv_cyc_no]) - 1) )
AND		M.MVMT_CRE_TP_CD	IN ('U','S')
AND		NOT EXISTS	(
						SELECT	'A'
						FROM	SCE_ACT_RCV_IF	I
						WHERE	1	=	1
						AND		I.BKG_NO			=	M.BKG_NO
						AND		I.CNTR_NO			=	M.CNTR_NO
						AND		I.ACT_STS_MAPG_CD	=	M.MVMT_STS_CD
						AND		I.NOD_CD			=	M.ORG_YD_CD
						AND		I.ACT_DT			=	M.CNMV_EVNT_DT
					)
)
ORDER BY CNTR_NO, CNMV_YR, CNMV_ID_NO, CNMV_SEQ			]]></sql>
			<params>
				<param name="cntr_no" type="12" value="" out="N"/>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="act_rcv_tp_cd" type="12" value="" out="N"/>
				<param name="act_sts_mapg_cd" type="12" value="" out="N"/>
				<param name="nod_cd" type="12" value="" out="N"/>
				<param name="act_dt" type="12" value="" out="N"/>
				<param name="edi_msg_tp_cd" type="12" value="" out="N"/>
				<param name="cre_tp_cd" type="12" value="" out="N"/>
				<param name="cre_usr_id" type="12" value="" out="N"/>
				<param name="vndr_seq" type="12" value="" out="N"/>
				<param name="bnd_vskd_seq_cd" type="12" value="" out="N"/>
				<param name="vsl_cd" type="12" value="" out="N"/>
				<param name="skd_voy_no" type="12" value="" out="N"/>
				<param name="skd_dir_cd" type="12" value="" out="N"/>
				<param name="vps_port_cd" type="12" value="" out="N"/>
				<param name="clpt_ind_seq" type="12" value="" out="N"/>
				<param name="vsl_dlay_rsn_cd" type="12" value="" out="N"/>
				<param name="vsl_dlay_rsn_desc" type="12" value="" out="N"/>
				<param name="vps_loc_cd" type="12" value="" out="N"/>
				<param name="act_cd" type="12" value="" out="N"/>
				<param name="rail_dest_n1st_eta_dt" type="12" value="" out="N"/>
				<param name="cnmv_yr" type="12" value="" out="N"/>
				<param name="cnmv_id_no" type="12" value="" out="N"/>
				<param name="cnmv_seq" type="12" value="" out="N"/>
				<param name="cnmv_split_no" type="12" value="" out="N"/>
				<param name="cnmv_cyc_no" type="12" value="" out="N"/>
				<param name="imdt_ext_flg" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
