<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="Edi315SendDBDAOSearchLocationInfoRSQL">
			<desc><![CDATA[edi 315 Location info
[2015.07.08]LOC_FAC_TP NYK Add]]></desc>
			<sql><![CDATA[
SELECT DISTINCT NOD_CD, SPLC_CD,LOC_DK_CD ,NVL(LOC_NM,LOC_NM1) LOC_NM , LOC_CITY_NM ,LOC_STAT_CD ,LOC_CNT_CD , LOC_TRANS_MODE, LOC_FAC_TP
FROM(
SELECT 
		CASE 
             WHEN @[loc_tp_cd] = 'FRCTY' THEN SCH.POR_NOD_CD
             WHEN @[loc_tp_cd] = 'TOCTY' THEN SCH.DEL_NOD_CD
             ELSE NOD_CD
          END AS NOD_CD 	 
     	,
		CASE 
             WHEN @[loc_tp_cd] = 'FRCTY' THEN (SELECT SPLC_CD FROM SCE_RAIL_SPLC WHERE YD_CD = SCH.POR_NOD_CD AND ROWNUM=1)
             WHEN @[loc_tp_cd] = 'TOCTY' THEN (SELECT SPLC_CD FROM SCE_RAIL_SPLC WHERE YD_CD = SCH.DEL_NOD_CD AND ROWNUM=1)
             ELSE (SELECT SPLC_CD FROM SCE_RAIL_SPLC WHERE YD_CD = SCD.NOD_CD AND ROWNUM=1)
          END AS SPLC_CD 
     	,
		CASE 
             WHEN @[loc_tp_cd] = 'FRCTY' THEN (SELECT LOC_AMS_PORT_CD FROM MDM_LOCATION WHERE LOC_CD = SUBSTR(SCH.POR_NOD_CD, 1, 5))
             WHEN @[loc_tp_cd] = 'TOCTY' THEN (SELECT LOC_AMS_PORT_CD FROM MDM_LOCATION WHERE LOC_CD = SUBSTR(SCH.DEL_NOD_CD, 1, 5))
             ELSE (SELECT LOC_AMS_PORT_CD FROM MDM_LOCATION WHERE LOC_CD = SUBSTR(SCD.NOD_CD, 1, 5))
          END AS LOC_DK_CD 
     	,
		CASE 
             WHEN @[loc_tp_cd] = 'FRCTY' THEN (SELECT YD_NM FROM MDM_YARD WHERE YD_CD = SCH.POR_NOD_CD AND ROWNUM=1)
             WHEN @[loc_tp_cd] = 'TOCTY' THEN (SELECT YD_NM FROM MDM_YARD WHERE YD_CD = SCH.DEL_NOD_CD AND ROWNUM=1)
             ELSE (SELECT YD_NM FROM MDM_YARD WHERE YD_CD =SCD.NOD_CD )
          END AS LOC_NM 
        ,          
        CASE 
             WHEN @[loc_tp_cd] = 'FRCTY' THEN (SELECT LOC_NM FROM MDM_LOCATION WHERE LOC_CD = SUBSTR(SCH.POR_NOD_CD ,1 ,5))
             WHEN @[loc_tp_cd] = 'TOCTY' THEN (SELECT LOC_NM FROM MDM_LOCATION WHERE LOC_CD = SUBSTR(SCH.DEL_NOD_CD ,1 ,5))
             ELSE (SELECT LOC_NM FROM MDM_LOCATION WHERE LOC_CD = SUBSTR(SCD.NOD_CD ,1 ,5) )
          END AS LOC_NM1 
     	,
		CASE 
             WHEN @[loc_tp_cd] = 'FRCTY' THEN (SELECT LOC_NM FROM MDM_LOCATION WHERE LOC_CD = SUBSTR(SCH.POR_NOD_CD, 1, 5))
             WHEN @[loc_tp_cd] = 'TOCTY' THEN (SELECT LOC_NM FROM MDM_LOCATION WHERE LOC_CD = SUBSTR(SCH.DEL_NOD_CD, 1, 5))
             ELSE (SELECT LOC_NM FROM MDM_LOCATION WHERE LOC_CD = SUBSTR(NOD_CD,1,5))
          END AS LOC_CITY_NM
     	,
		CASE 
             WHEN @[loc_tp_cd] = 'FRCTY' THEN (SELECT STE_CD FROM MDM_LOCATION WHERE LOC_CD = SUBSTR(SCH.POR_NOD_CD, 1, 5))
             WHEN @[loc_tp_cd] = 'TOCTY' THEN (SELECT STE_CD FROM MDM_LOCATION WHERE LOC_CD = SUBSTR(SCH.DEL_NOD_CD, 1, 5))
             ELSE (SELECT STE_CD FROM MDM_LOCATION WHERE LOC_CD = SUBSTR(NOD_CD,1,5))
          END AS LOC_STAT_CD 
     	,
		CASE 
             WHEN @[loc_tp_cd] = 'FRCTY' THEN (SELECT CNT_CD FROM MDM_LOCATION WHERE LOC_CD = SUBSTR(SCH.POR_NOD_CD, 1, 5))
             WHEN @[loc_tp_cd] = 'TOCTY' THEN (SELECT CNT_CD FROM MDM_LOCATION WHERE LOC_CD = SUBSTR(SCH.DEL_NOD_CD, 1, 5))
             ELSE (SELECT CNT_CD FROM MDM_LOCATION WHERE LOC_CD = SUBSTR(NOD_CD,1,5))
          END AS LOC_CNT_CD
     	,DECODE(SUBSTR(SCD.ACT_CD, 3,1),'W','F',SUBSTR(SCD.ACT_CD, 3,1)) AS LOC_TRANS_MODE 
        ,DECODE(SUBSTR(SCD.ACT_CD, 4,1),'M','T','R','R','Z','C','D') AS LOC_FAC_TP /*2015.07.08 NYK Add*/
  FROM 	SCE_COP_DTL SCD
      ,	SCE_COP_HDR SCH
#if (${trans_tp_cd} == 'TRNKPC' || ${trans_tp_cd} == 'TRNKMC' || ${trans_tp_cd} == 'TRNKOC')
      , BKG_VVD BV
#end
 WHERE  SCD.COP_NO = SCH.COP_NO
   AND 	SCH.COP_NO = @[cop_no]
#if (${trans_tp_cd} == 'OBSTRT')
	#if (${loc_tp_cd} == 'FRCTY')
	--AND  SUBSTR(SCD.ACT_CD,2,1) = 'O' 
    AND SCH.POR_NOD_CD = SCD.NOD_CD   -- 조건 추가
	ORDER BY SCD.COP_DTL_SEQ ASC
	#elseif(${loc_tp_cd} == 'EP') 
	AND SCD.ACT_CD = 'MOTYDO'
	#elseif(${loc_tp_cd} == 'OBDR') 
	AND SCD.ACT_CD = 'MOTZAD'
	#elseif(${loc_tp_cd} == 'FR') 
	AND SCD.ACT_CD = ( SELECT ACT_CD FROM SCE_COP_DTL WHERE COP_NO = @[cop_no] AND ACT_CD IN ('FOTYAD','FOTRAD','FOTMAD') AND COP_DTL_SEQ = (SELECT MIN(COP_DTL_SEQ) FROM SCE_COP_DTL WHERE COP_NO = @[cop_no] AND ACT_CD IN ('FOTYAD','FOTRAD','FOTMAD')))
	#end
#end

#if (${trans_tp_cd} == 'OBIMD')
	#if (${loc_tp_cd} == 'START')
    AND  SCD.COP_DTL_SEQ =  @[cop_dtl_seq]  --- 출발지     위에서 조회한 SEQ
    #elseif(${loc_tp_cd} == 'END')
    AND SCD.COP_DTL_SEQ = (SELECT MIN(COP_DTL_SEQ) 
                             FROM SCE_COP_DTL 
                            WHERE COP_NO = @[cop_no] 
                              AND SUBSTR(ACT_CD, 5,2) = 'AD'  -- 직후 도착지 FM - TO 를 다 가져오기 위해
                              AND COP_DTL_SEQ > @[cop_dtl_seq])      
    #end
#end
#if (${trans_tp_cd} == 'IBIMD')
	#if (${loc_tp_cd} == 'START')
    AND  SCD.COP_DTL_SEQ = (SELECT MAX(COP_DTL_SEQ) 
                              FROM SCE_COP_DTL 
                             WHERE COP_NO = @[cop_no]
                               AND SUBSTR(ACT_CD, 5,2) = 'DO'  --- 도착지의 직전 출발지
                               AND COP_DTL_SEQ < @[cop_dtl_seq]) 
    #elseif(${loc_tp_cd} == 'END')
    AND  SCD.COP_DTL_SEQ =  @[cop_dtl_seq]  --- 도착지       
    #end
#end

#if (${trans_tp_cd} == 'TRNKPC')
    AND SCH.BKG_NO = BV.BKG_NO
    AND SCD.VSL_CD(+) = BV.VSL_CD
    AND SCD.SKD_VOY_NO(+) = BV.SKD_VOY_NO
    AND SCD.SKD_DIR_CD(+) = BV.SKD_DIR_CD
    AND BV.VSL_PRE_PST_CD = 'S'

	#if (${loc_tp_cd} == 'LP')
    AND SUBSTR(BV.POL_YD_CD, 1, 5) = SUBSTR(@[loc_yd_cd], 1, 5)
    AND SCD.ACT_CD IN ('FLWMLO', 'FLVMLO','FTVMLO') -- TRNKPC, LP 
	#elseif(${loc_tp_cd} == 'DP')
    AND SUBSTR(BV.POD_YD_CD, 1, 5) = SUBSTR(@[loc_yd_cd], 1, 5)
	AND SCD.ACT_CD IN ('FTWMUD','FTVMUD','FUWMUD') -- TRNKPC, DP
	#end
#end

#if (${trans_tp_cd} == 'TRNKMC')
    AND SCH.BKG_NO = BV.BKG_NO
    AND SCD.VSL_CD(+) = BV.VSL_CD
    AND SCD.SKD_VOY_NO(+) = BV.SKD_VOY_NO
    AND SCD.SKD_DIR_CD(+) = BV.SKD_DIR_CD
    AND BV.VSL_PRE_PST_CD = 'T'

	#if (${loc_tp_cd} == 'LP') 
    AND SUBSTR(BV.POL_YD_CD, 1, 5) = SUBSTR(@[loc_yd_cd], 1, 5)
	AND SCD.ACT_CD IN ('FTVMLO','FLVMLO','FLWMLO','FTWMLO') -- TRNKMC, LP
	#elseif(${loc_tp_cd} == 'DP')
    AND SUBSTR(BV.POD_YD_CD, 1, 5) = SUBSTR(@[loc_yd_cd], 1, 5)
    AND SCD.ACT_CD IN ('FTVMUD','FUVMAD','FLWMAD','FUWMAD') -- TRNKMC, DP 
	#end
#end

#if (${trans_tp_cd} == 'TRNKOC')
    AND SCH.BKG_NO = BV.BKG_NO
    AND SCD.VSL_CD(+) = BV.VSL_CD
    AND SCD.SKD_VOY_NO(+) = BV.SKD_VOY_NO
    AND SCD.SKD_DIR_CD(+) = BV.SKD_DIR_CD
    AND BV.VSL_PRE_PST_CD = 'U'

	#if (${loc_tp_cd} == 'LP') 
    AND SUBSTR(BV.POL_YD_CD, 1, 5) = SUBSTR(@[loc_yd_cd], 1, 5)
	AND SCD.ACT_CD   IN ('FLWMLO','FTVMLO','FTWMLO') -- TRNKOC, LP
	#elseif(${loc_tp_cd} == 'DP') 
    AND SUBSTR(BV.POD_YD_CD, 1, 5) = SUBSTR(@[loc_yd_cd], 1, 5)
	AND SCD.ACT_CD   IN ('FUWMUD','FUVMUD','FTVMUD','FTWMUD') -- TRNKOC, DP
	#end
#end

#if (${trans_tp_cd} == 'TRNKTT')
	#if (${loc_tp_cd} == 'START') 
	AND SCD.ACT_CD = 'FTTMDO'
	#elseif(${loc_tp_cd} == 'END') 
	AND SCD.ACT_CD = 'FTTMAD'
	#end
#end
 
#if (${trans_tp_cd} == 'IBEND')
	#if (${loc_tp_cd} == 'LIBH')
    AND  SUBSTR(SCD.ACT_CD,1,2) = 'FI' --20150813 수정    
    AND  SUBSTR(SCD.ACT_CD,4,1) <> 'Z'
    ORDER BY SCD.COP_DTL_SEQ DESC
	#elseif(${loc_tp_cd} == 'IBDR') 
	AND SCD.ACT_CD = 'FITZAD'
	#elseif(${loc_tp_cd} == 'ER') 
	AND SCD.ACT_CD = 'MITYAD'
	#elseif(${loc_tp_cd} == 'TOCTY') 
	AND  SUBSTR(SCD.ACT_CD,2,1) = 'I'
	
	ORDER BY SCD.COP_DTL_SEQ ASC
	#end
#end
)
WHERE ROWNUM  = 1			]]></sql>
			<params>
				<param name="loc_tp_cd" type="12" value="" out="N"/>
				<param name="cop_no" type="12" value="" out="N"/>
				<param name="cop_dtl_seq" type="12" value="" out="N"/>
				<param name="loc_yd_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
