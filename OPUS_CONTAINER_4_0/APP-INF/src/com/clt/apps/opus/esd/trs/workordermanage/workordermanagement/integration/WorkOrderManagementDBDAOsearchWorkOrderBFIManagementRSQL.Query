<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="WorkOrderManagementDBDAOsearchWorkOrderBFIManagementRSQL">
			<desc><![CDATA[searchWorkOrderBFIManagement]]></desc>
			<sql><![CDATA[
SELECT   DECODE(GROUPING_ID(TRSP_WO_NO),0,DECODE(BFI.BZC_AMT_DESC,'','',MAX(BFI.CRE_OFC_CD)),'') AS CRE_OFC_CD
       , DECODE(GROUPING_ID(TRSP_WO_NO),0,DECODE(BFI.BZC_AMT_DESC,'','',MAX(BFI.FM_DT )),'') AS FM_DT
       , DECODE(GROUPING_ID(TRSP_WO_NO),0,DECODE(BFI.BZC_AMT_DESC,'','',MAX(BFI.TO_DT )),'') AS TO_DT
       , DECODE(GROUPING_ID(TRSP_WO_NO),0,DECODE(BFI.BZC_AMT_DESC,'','',MAX(BFI.WO_VNDR_SEQ )),'') AS WO_VNDR_SEQ
       , DECODE(GROUPING_ID(TRSP_WO_NO),0,DECODE(BFI.BZC_AMT_DESC,'','',MAX(BFI.VNDR_LGL_ENG_NM )),'') AS VNDR_LGL_ENG_NM
       , DECODE(GROUPING_ID(TRSP_WO_NO),0,DECODE(BFI.BZC_AMT_DESC,'','',MAX(BFI.VNDR_EML)),'') AS VNDR_EML
       , DECODE(GROUPING_ID(TRSP_WO_NO),0,DECODE(BFI.BZC_AMT_DESC,'','',MAX(BFI.TODAY_DT )),'') AS TODAY_DT
       , DECODE(GROUPING_ID(TRSP_WO_NO),0,DECODE(BFI.BZC_AMT_DESC,'','',MAX(BFI.CNTC_PSON_NM )),'') AS CNTC_PSON_NM
       , TRSP_WO_NO
       , DECODE(GROUPING_ID(TRSP_WO_NO),0,DECODE(BFI.BZC_AMT_DESC,'','',MAX(BFI.EQ_TPSZ_CD )),'') AS EQ_TPSZ_CD
       , DECODE(GROUPING_ID(TRSP_WO_NO),0,DECODE(BFI.BZC_AMT_DESC,'','',MAX(BFI.FM_NOD_CD )),'') AS FM_NOD_CD
       , DECODE(GROUPING_ID(TRSP_WO_NO),0,DECODE(BFI.BZC_AMT_DESC,'','',MAX(BFI.VIA_NOD_CD )),'') AS VIA_NOD_CD
       , DECODE(GROUPING_ID(TRSP_WO_NO),0,DECODE(BFI.BZC_AMT_DESC,'','',MAX(BFI.TO_NOD_CD )),'') AS TO_NOD_CD
       , DECODE(GROUPING_ID(TRSP_WO_NO),0,DECODE(BFI.BZC_AMT_DESC,'','',MAX(BFI.DOR_NOD_CD )),'') AS DOR_NOD_CD
       , DECODE(GROUPING_ID(TRSP_WO_NO),0,DECODE(BFI.BZC_AMT_DESC,'','',MAX(BFI.DOR_NOD_PLN_DT )),'') AS  DOR_NOD_PLN_DT
       , CURR_CD
       , DECODE(GROUPING_ID(TRSP_WO_NO),0,NVL(BFI.BZC_AMT_DESC,'Total'),NVL(BFI.BZC_AMT_DESC,'Grand Total')) AS BZC_AMT_DESC
       , TRIM(TO_CHAR(ROUND(SUM(BFI.BZC_AMT),2),'9999999990.00')) AS BZC_AMT
       , DECODE(GROUPING_ID(TRSP_WO_NO),0,DECODE(BFI.BZC_AMT_DESC,'','',MAX(BFI.EQ_NO )),'') AS EQ_NO
       , DECODE(GROUPING_ID(TRSP_WO_NO),0,DECODE(BFI.BZC_AMT_DESC,'','',MAX(BFI.CGO_TP_CD )),'') AS CGO_TP_CD
       , DECODE(GROUPING_ID(TRSP_WO_NO),0,DECODE(BFI.BZC_AMT_DESC,'','',MAX(BFI.TRS_SUB_STS_CD )),'') AS TRS_SUB_STS_CD
       , MAX(BFI.CNT)
       , DECODE(GROUPING_ID(TRSP_WO_NO),0,DECODE(NVL(BFI.BZC_AMT_DESC,'Total'),'Total',MAX(BFI.CNT)+1,MAX(BFI.CNT)),DECODE(NVL(BFI.BZC_AMT_DESC,'Grand Total'),'Grand Total',MAX(BFI.CNT)+2))
FROM
(
SELECT  
    TSO.TRSP_SO_SEQ,
    TWO.CRE_OFC_CD	
    ,NVL(TO_CHAR(TO_DATE(@[fm_dt],'YYYY-MM-DD'),'YYYY-MM-DD'),TO_CHAR(SYSDATE,'YYYY-MM-DD')) AS FM_DT	
    ,NVL(TO_CHAR(TO_DATE(@[to_dt],'YYYY-MM-DD'),'YYYY-MM-DD'),TO_CHAR(SYSDATE,'YYYY-MM-DD')) AS TO_DT			
    ,TWO.WO_VNDR_SEQ	
    ,MVE.VNDR_LGL_ENG_NM	
    ,VCP.VNDR_EML	
    ,TO_CHAR(SYSDATE,'YYYY-MM-DD') AS TODAY_DT		
    ,MVE.CNTC_PSON_NM
    ,TWO.TRSP_WO_OFC_CTY_CD||TWO.TRSP_WO_SEQ  AS TRSP_WO_NO
    ,TSO.EQ_TPSZ_CD
    ,TSO.FM_NOD_CD	
    ,TSO.VIA_NOD_CD	
    ,TSO.TO_NOD_CD	
    ,TSO.DOR_NOD_CD	
    ,DECODE(TSO.TRSP_SO_TP_CD,'Y',DECODE(TSO.TRSP_COST_DTL_MOD_CD,'DR',TO_CHAR(TSO.DOR_NOD_PLN_DT,'YYYY-MM-DD'),DECODE(TSO.TRSP_COST_DTL_MOD_CD,'CY',TO_CHAR(TSO.LST_NOD_PLN_DT,'YYYY-MM-DD'),TO_CHAR(TWO.LOCL_CRE_DT,'YYYY-MM-DD'))),'') AS DOR_NOD_PLN_DT
    ,TSO.CURR_CD		
    ,DECODE(CNT.NO,1,'Basic Amount',2,'Negotiated  Amount',3,'Fuel Amount',4,'Additional Amount') BZC_AMT_DESC
    ,DECODE(CNT.NO,1,BZC_AMT,2,NEGO_AMT,3,FUEL_SCG_AMT,4,ETC_ADD_AMT) BZC_AMT
    ,TSO.EQ_NO			
    ,DECODE(TSO.CGO_TP_CD,'F','Full','F','Empty', NVL(TSO.CGO_TP_CD,''))	CGO_TP_CD
    ,DECODE(TSO.TRS_SUB_STS_CD,'DF','Draft','OR','Ordered','AC','Accepted','ST','Started','CM','Completed') AS TRS_SUB_STS_CD
    ,CNT.NO CNT
FROM 
TRS_TRSP_WRK_ORD TWO,
TRS_TRSP_SVC_ORD TSO,
MDM_VENDOR MVE,
(SELECT  VCP.VNDR_SEQ,LISTAGG(VCP.VNDR_EML, '; ') 
        WITHIN GROUP 
        (ORDER BY VNDR_EML) VNDR_EML
 FROM    MDM_VNDR_CNTC_PNT VCP
 WHERE   VCP.CNTC_DIV_CD = 'EMAIL'
 AND     DELT_FLG = 'N'
 GROUP BY VCP.VNDR_SEQ 
 ) VCP,
(
   SELECT '1' AS NO FROM DUAL UNION SELECT '2' AS NO FROM DUAL UNION SELECT '3' AS NO FROM DUAL UNION SELECT '4' AS NO FROM DUAL
) CNT
WHERE   TWO.TRSP_WO_OFC_CTY_CD = TSO.TRSP_WO_OFC_CTY_CD
AND     TWO.TRSP_WO_SEQ = TSO.TRSP_WO_SEQ
AND     TSO.VNDR_SEQ = MVE.VNDR_SEQ
AND     TSO.VNDR_SEQ = VCP.VNDR_SEQ(+) -- 2015.02.05    Hyungwook Choi - Requested by Chang-Hyun Jun
AND     TWO.DELT_FLG = 'N'  
AND     TSO.DELT_FLG = 'N'  
AND     TSO.TRSP_SO_STS_CD = 'I'
AND     TSO.INV_NO IS NULL
AND     TSO.TRS_SUB_STS_CD IN ('ST', 'CM') 
AND     TWO.LOCL_CRE_DT BETWEEN TO_DATE(@[fm_dt]||'000000','YYYYMMDDHH24MISS') AND TO_DATE(@[to_dt]||'235959','YYYYMMDDHH24MISS')


#if (${cre_ofc_cd} != '')
	AND TWO.CRE_OFC_CD = @[cre_ofc_cd]
#end

#if (${vndr_seq} != '')
	#if (${temp_not_sp} == 'N')
		AND	TWO.WO_VNDR_SEQ IN (
	#else
		AND	TWO.WO_VNDR_SEQ NOT IN (
	#end
		#foreach ($user_vndrSeqs IN ${vndrSeqs})
			#if($velocityCount < $vndrSeqs.size())
				'$user_vndrSeqs',
			#else
				'$user_vndrSeqs'
			#end
		#end			  
	)
#end

ORDER BY TSO.TRSP_SO_OFC_CTY_CD,TSO.TRSP_SO_SEQ,CNT.NO
) BFI

WHERE BFI.BZC_AMT > 0 -- 2015.02.05    Hyungwook Choi - Requested by Chang-Hyun Jun

GROUP BY ROLLUP(TRSP_WO_NO,DECODE(CNT,1,'Basic Amount',2,'Negotiated  Amount',3,'Fuel Amount',4,'Additional Amount')),CURR_CD,EQ_NO
ORDER BY CURR_CD,EQ_NO,TRSP_WO_NO,DECODE(GROUPING_ID(TRSP_WO_NO),0,DECODE(NVL(BFI.BZC_AMT_DESC,'Total'),'Total',MAX(BFI.CNT)+1,MAX(BFI.CNT)),DECODE(NVL(BFI.BZC_AMT_DESC,'Grand Total'),'Grand Total',MAX(BFI.CNT)+2))			]]></sql>
			<params>
				<param name="fm_dt" type="12" value="" out="N"/>
				<param name="to_dt" type="12" value="" out="N"/>
				<param name="cre_ofc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
