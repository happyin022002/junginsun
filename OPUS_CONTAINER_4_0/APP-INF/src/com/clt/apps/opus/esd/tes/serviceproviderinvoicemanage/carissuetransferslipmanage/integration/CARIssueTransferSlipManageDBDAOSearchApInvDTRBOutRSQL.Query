<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CARIssueTransferSlipManageDBDAOSearchApInvDTRBOutRSQL">
			<desc><![CDATA[SearchApInvDTRBOut]]></desc>
			<sql><![CDATA[
SELECT LINE_SEQ, ROWNUM LINE_NO, LINE_TP_LU_CD, CSR_AMT,
		INV_DESC, INV_TAX_CD, DTRB_COA_CO_CD, DTRB_COA_RGN_CD, DTRB_COA_CTR_CD, DTRB_COA_ACCT_CD,
		DTRB_COA_VVD_CD, DTRB_COA_INTER_CO_CD, DTRB_COA_FTU_N1ST_CD, DTRB_COA_FTU_N2ND_CD,
		ATTR_CATE_NM, ATTR_CTNT1, ATTR_CTNT2, ATTR_CTNT3, ATTR_CTNT4, ATTR_CTNT5,
		SAC_TRUNK_VVD_RLANE_FNC(BKG_NO) AS ATTR_CTNT6, SAC_TRUNK_VVD_TRD_FNC(BKG_NO) AS ATTR_CTNT7, ATTR_CTNT8, ATTR_CTNT9, ATTR_CTNT10, ATTR_CTNT11,
		ATTR_CTNT12, ATTR_CTNT13, ATTR_CTNT14, ATTR_CTNT15, BKG_NO, 
		CNTR_TPSZ_CD, ACT_VVD_CD, PLN_SCTR_DIV_CD, SO_CRR_CD, YD_CD, FTU_USE_CTNT1,
		FTU_USE_CTNT2, FTU_USE_CTNT3, FTU_USE_CTNT4, FTU_USE_CNTR5, CRE_DT, CRE_USR_ID, EAI_EVNT_DT
 FROM (
 SELECT LINE_SEQ, LINE_NO, LINE_TP_LU_CD, 
       DECODE(CURR,'JPY',ROUND((CSR_AMT/RATE)*FTU_USE_CTNT2),
                   'TWD',ROUND((CSR_AMT/RATE)*FTU_USE_CTNT2),
                   'KRW',ROUND((CSR_AMT/RATE)*FTU_USE_CTNT2),
                   'IDR',ROUND((CSR_AMT/RATE)*FTU_USE_CTNT2), 
                   'CLP',ROUND((CSR_AMT/RATE)*FTU_USE_CTNT2),
                   'DJF',ROUND((CSR_AMT/RATE)*FTU_USE_CTNT2),
                   'VND',ROUND((CSR_AMT/RATE)*FTU_USE_CTNT2),
                   'VUV',ROUND((CSR_AMT/RATE)*FTU_USE_CTNT2),
                   'XAF',ROUND((CSR_AMT/RATE)*FTU_USE_CTNT2),
                   'XPF',ROUND((CSR_AMT/RATE)*FTU_USE_CTNT2),
	                     ROUND((CSR_AMT/RATE)*FTU_USE_CTNT2,2)) CSR_AMT,
	   INV_DESC, INV_TAX_CD, DTRB_COA_CO_CD, DTRB_COA_RGN_CD, DTRB_COA_CTR_CD, DTRB_COA_ACCT_CD,
	   DTRB_COA_VVD_CD, DTRB_COA_INTER_CO_CD, DTRB_COA_FTU_N1ST_CD, DTRB_COA_FTU_N2ND_CD,
	   ATTR_CATE_NM, ATTR_CTNT1, ATTR_CTNT2, ATTR_CTNT3, ATTR_CTNT4, ATTR_CTNT5,
	   ATTR_CTNT6, ATTR_CTNT7, ATTR_CTNT8, ATTR_CTNT9, ATTR_CTNT10, ATTR_CTNT11,
	   ATTR_CTNT12, ATTR_CTNT13, ATTR_CTNT14, ATTR_CTNT15, BKG_NO,
	   CNTR_TPSZ_CD, ACT_VVD_CD, PLN_SCTR_DIV_CD, SO_CRR_CD, YD_CD, FTU_USE_CTNT1,
	   FTU_USE_CTNT2, FTU_USE_CTNT3, FTU_USE_CTNT4, FTU_USE_CNTR5, CRE_DT, CRE_USR_ID, EAI_EVNT_DT
 FROM (
	   SELECT @[line_seq]                                                     LINE_SEQ,
			  ''                                                      LINE_NO,
			  'ITEM'                                                  LINE_TP_LU_CD,
			  CSR_AMT,
			  INV_DESC,
			  @[inv_tax_cd]                                                       INV_TAX_CD,
			  '01'                                                    DTRB_COA_CO_CD,
			  DTRB_COA_RGN_CD,
			  DTRB_COA_CTR_CD,
			  DTRB_COA_ACCT_CD,
			  DTRB_COA_VVD_CD,
			  DTRB_COA_INTER_CO_CD,
			  '000000'                                                DTRB_COA_FTU_N1ST_CD,
			  '000000'                                                DTRB_COA_FTU_N2ND_CD,
			  ATTR_CATE_NM,
			  ATTR_CTNT1,
			  ATTR_CTNT2,
			  ATTR_CTNT3,
			  NULL                                                    ATTR_CTNT4,
			  NULL                                                    ATTR_CTNT5,
			  NULL                                                    ATTR_CTNT6,
			  NULL                                                    ATTR_CTNT7,
			  NULL                                                    ATTR_CTNT8,
			  NULL                                                    ATTR_CTNT9,
			  NULL                                                    ATTR_CTNT10,
			  ATTR_CTNT11                                             ATTR_CTNT11,
			  ATTR_CTNT12                                             ATTR_CTNT12,
			  NULL                                                    ATTR_CTNT13,
			  LANE_CD                                                 ATTR_CTNT14,
			  'A'                                                     ATTR_CTNT15,
			  BKG_NO,
			  M.CNTR_TPSZ_CD,                                        --수정(20070723)
			  ACT_VVD_CD,
			  PLN_SCTR_DIV_CD,
			  SO_CRR_CD,
			  YD_CD,
			  FTU_USE_CTNT1,
			  NVL(FTU_USE_CTNT2,1)                                    FTU_USE_CTNT2,
			  FTU_USE_CTNT3,
			  NULL                                                    FTU_USE_CTNT4,
			  NULL                                                    FTU_USE_CNTR5,
			  GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC(@[ofc_cd])                    CRE_DT,
			  @[cre_usr_id]                                                       CRE_USR_ID,
			  NVL(RATE,1)                                             RATE,
			  CURR,
			  '' EAI_EVNT_DT
	   FROM
	   ( SELECT DISTINCT
			  ( SELECT ACCT_ENG_NM
				FROM   MDM_ACCOUNT
				WHERE  ACCT_CD = D.ACCT_CD )                          INV_DESC,
			  ( SELECT FINC_RGN_CD
				FROM   MDM_ORGANIZATION
				WHERE  OFC_CD = H.COST_OFC_CD )                        DTRB_COA_RGN_CD,
			  ( SELECT AP_CTR_CD
				FROM   MDM_ORGANIZATION
				WHERE  OFC_CD = H.COST_OFC_CD )                        DTRB_COA_CTR_CD,
			  D.ACCT_CD                                               DTRB_COA_ACCT_CD,
			  NVL(L.FINC_VSL_CD||L.FINC_SKD_VOY_NO||L.FINC_SKD_DIR_CD,
				  '0000000000')                                       DTRB_COA_VVD_CD,
			  ( SELECT NVL(SUBS_CO_CD,'00')
				FROM   MDM_VENDOR
				WHERE  VNDR_SEQ = H.VNDR_SEQ )                        DTRB_COA_INTER_CO_CD,
			  D.ACCT_CD                                               ATTR_CATE_NM,
			  H.INV_NO                                                ATTR_CTNT1,
			  TO_CHAR(H.ISS_DT,'YYYY/MM/DD HH24:MI:SS')               ATTR_CTNT2,
			  SUBSTR(H.YD_CD,1,5)                                     ATTR_CTNT3,
			  NVL(NVL((SELECT DISTINCT TO_CHAR(ATB_DT,'YYYYMMDD')
           				 FROM TES_TML_SO_VVD_LIST
			            WHERE TML_SO_OFC_CTY_CD = H.TML_SO_OFC_CTY_CD
           				  AND TML_SO_SEQ = H.TML_SO_SEQ
			              AND VSL_CD = D.VSL_CD
           				  AND SKD_VOY_NO = D.SKD_VOY_NO
				          AND SKD_DIR_CD = D.SKD_DIR_CD
                          AND IO_BND_CD  = D.IO_BND_CD),H.TO_PRD_DT),D.WRK_DT) ATTR_CTNT11,
			  CASE WHEN (D.LGS_COST_CD = 'SVDRFL')
                   OR   (D.LGS_COST_CD = 'SVDRMT')
                   OR   (D.LGS_COST_CD = 'SVDRTS')
                   THEN (SELECT LOC_CD
			               FROM MDM_VENDOR
			              WHERE VNDR_SEQ = @[vndr_seq]) 
			  ELSE H.YD_CD
			  END ATTR_CTNT12,
			  L.BKG_NO                                                BKG_NO,
			  L.CNTR_TPSZ_CD                                          CNTR_TPSZ_CD,
			  DECODE(H.TML_INV_TP_CD,'TM',
				NVL(L.VSL_CD||L.SKD_VOY_NO||L.SKD_DIR_CD,L.FINC_VSL_CD||L.FINC_SKD_VOY_NO||L.FINC_SKD_DIR_CD),
				L.FINC_VSL_CD||L.FINC_SKD_VOY_NO||L.FINC_SKD_DIR_CD) ACT_VVD_CD,
			  DECODE(SUBSTR(D.LGS_COST_CD,1,2),'ET','T',
				DECODE((SELECT YD_OSHP_CD FROM MDM_YARD WHERE YD_CD = H.YD_CD),'O',
				DECODE(NVL(TRIM(D.TML_CRR_CD),'NYK'),'NYK','C','T'),'C')) PLN_SCTR_DIV_CD,
			  TRIM(D.TML_CRR_CD)        	                           SO_CRR_CD,
			  H.YD_CD                                                 YD_CD,
			  D.LGS_COST_CD                                           FTU_USE_CTNT1,
			  COUNT(L.CNTR_NO)                                        FTU_USE_CTNT2,
			  D.VOL_TR_UT_CD                                          FTU_USE_CTNT3,
			  H.CURR_CD                                               CURR,
			  NVL((SELECT DISTINCT SLAN_CD
                     FROM AR_MST_REV_VVD
                    WHERE L.FINC_VSL_CD                 = VSL_CD
                      AND L.FINC_SKD_VOY_NO             = SKD_VOY_NO
                      AND SUBSTR(L.FINC_SKD_DIR_CD,1,1) = SKD_DIR_CD
                      AND SUBSTR(L.FINC_SKD_DIR_CD,2,1) = RLANE_DIR_CD
                	  AND ROWNUM = 1),'COM') LANE_CD		
	   FROM   TES_TML_SO_HDR H, TES_TML_SO_DTL D, TES_TML_SO_CNTR_LIST L
	   WHERE  H.INV_NO              = @[inv_no]
	   AND    H.VNDR_SEQ            = @[vndr_seq]
	   AND    H.TML_INV_STS_CD      = 'C'
	   AND    NVL(H.DELT_FLG,'N')   <> 'Y'
	   AND    H.TML_SO_OFC_CTY_CD   = D.TML_SO_OFC_CTY_CD
	   AND    H.TML_SO_SEQ          = D.TML_SO_SEQ
--		       AND    D.CALC_COST_GRP_CD    <> 'SP'
	   AND    D.CALC_COST_GRP_CD    NOT IN ('SD','SP','EQ')  --수정(20080111)
	   AND    D.CALC_TP_CD          = 'A'
	   AND    NVL(D.INV_AMT,0)      <> 0
	   AND    H.TML_SO_OFC_CTY_CD   = L.TML_SO_OFC_CTY_CD
	   AND    H.TML_SO_SEQ          = L.TML_SO_SEQ
	   AND    L.VRFY_RSLT_IND_CD       = 'CO'
	   AND    DECODE(H.TML_INV_TP_CD,
						'TM',DECODE(SUBSTR(D.LGS_COST_CD,1,2),'TP',NVL(L.RVIS_IND_FLG,'N'),'TM',NVL(L.TML_RVIS_IND_FLG,'N'),'SR',NVL(L.STO_RVIS_IND_FLG,'N'),'SV',NVL(L.STV_RVIS_IND_FLG,'N'),'CG',NVL(L.CGO_RVIS_IND_FLG,'N')),
						'ON',DECODE(SUBSTR(D.LGS_COST_CD,1,2),'TP',NVL(L.RVIS_IND_FLG,'N'),'TM',NVL(L.TML_RVIS_IND_FLG,'N'),'SR',NVL(L.STO_RVIS_IND_FLG,'N'),'SV',NVL(L.STV_RVIS_IND_FLG,'N'),'CG',NVL(L.CGO_RVIS_IND_FLG,'N')),
						'OF',NVL(L.TML_RVIS_IND_FLG,'N'),
						'ST','N') <> 'Y'
	   AND    NVL(L.CNTR_TPSZ_CD,'N')     = NVL(D.CNTR_TPSZ_CD,'N')
--		       AND    DECODE('TM',NVL(L.IO_BND_CD,'N'),'ON',NVL(L.IO_BND_CD,'N'),'OF','N','ST','N')
--		              = DECODE('TM',NVL(D.IO_BND_CD,'N'),'ON',NVL(D.IO_BND_CD,'N'),'OF','N','ST','N')
--		       AND    DECODE('TM',NVL(L.IOC_CD,'N'),'ON',NVL(L.IOC_CD,'N'),'OF','N','ST','N')
--		              = DECODE('TM',NVL(D.IOC_CD,'N'),'ON',NVL(D.IOC_CD,'N'),'OF','N','ST','N')
--		       AND    DECODE('TM',NVL(L.LANE_CD,'N'),'ON',NVL(L.LANE_CD,'N'),'OF','N','ST','N')
--		              = DECODE('TM',NVL(D.LANE_CD,'N'),'ON',NVL(D.LANE_CD,'N'),'OF','N','ST','N')
--		       AND    DECODE(H.TML_INV_TP_CD,'TM',
----		                DECODE(L.BB_CGO_FLG,'Y','BB',DECODE(L.LOCL_TS_IND_CD,'T','TS',DECODE(L.CNTR_STY_CD,'F','FL','MT'))),
--		                DECODE(L.BB_CGO_FLG,'Y','BB',DECODE(L.LOCL_TS_IND_CD,'T',DECODE(L.CNTR_STY_CD,'F','TS','TM'),DECODE(L.CNTR_STY_CD,'F','FL','MT'))),
--		                'ON',DECODE(CNTR_STY_CD,'F','F','M'),'OF',DECODE(L.CNTR_STY_CD,'F','FL','MT'),'ST',DECODE(L.LOCL_TS_IND_CD,'T','TS',DECODE(L.CNTR_STY_CD,'F','FL','MT')))
--		              = DECODE(H.TML_INV_TP_CD,'TM',SUBSTR(D.LGS_COST_CD,5,2),'ON',SUBSTR('TMNDRF',6,1),'OF',SUBSTR(D.LGS_COST_CD,5,2),
--		                'ST',SUBSTR(D.LGS_COST_CD,5,2))
--수정(20070920) -- B
	   AND    DECODE(H.TML_INV_TP_CD,'TM',NVL(L.IO_BND_CD,'N'),'ON',NVL(L.IO_BND_CD,'N'),'OF','N','ST','N')
			  = DECODE(H.TML_INV_TP_CD,'TM',NVL(D.IO_BND_CD,'N'),'ON',NVL(D.IO_BND_CD,'N'),'OF','N','ST','N')
	   AND    DECODE(H.TML_INV_TP_CD,'TM',NVL(L.IOC_CD,'N'),'ON',NVL(L.IOC_CD,'N'),'OF','N','ST','N')
			  = DECODE(H.TML_INV_TP_CD,'TM',NVL(D.IOC_CD,'N'),'ON',NVL(D.IOC_CD,'N'),'OF','N','ST','N')
	   AND    DECODE(H.TML_INV_TP_CD,'TM',NVL(L.LANE_CD,'N'),'ON',NVL(L.LANE_CD,'N'),'OF','N','ST','N')
			  = DECODE(H.TML_INV_TP_CD,'TM',NVL(D.LANE_CD,'N'),'ON',NVL(D.LANE_CD,'N'),'OF','N','ST','N')
	   AND    DECODE(H.TML_INV_TP_CD,'TM',
				DECODE(L.BB_CGO_FLG,'Y','BB',DECODE(L.LOCL_TS_IND_CD,'T',DECODE(L.CNTR_STY_CD,'F','TS','TM'),DECODE(L.CNTR_STY_CD,'F','FL','MT'))),
				'ON',DECODE(L.CNTR_STY_CD,'F','F','M'),'OF',DECODE(L.CNTR_STY_CD,'F','FL','MT'),'ST',DECODE(L.LOCL_TS_IND_CD,'T','TS',DECODE(L.CNTR_STY_CD,'F','FL','MT')))
			  = DECODE(H.TML_INV_TP_CD,'TM',SUBSTR(D.LGS_COST_CD,5,2),'ON',SUBSTR(D.LGS_COST_CD,6,1),'OF',SUBSTR(D.LGS_COST_CD,5,2),
				'ST',SUBSTR(D.LGS_COST_CD,5,2))
	   AND    DECODE(H.TML_INV_TP_CD,'TM',NVL(L.DCGO_CLSS_CD,'N'),'ON',NVL(L.DCGO_CLSS_CD,'N'),'OF','N','ST','N')
			  = DECODE(H.TML_INV_TP_CD,'TM',NVL(D.DCGO_IND_CD,'N'),'ON',NVL(D.DCGO_IND_CD,'N'),'OF','N','ST','N')
	   AND    DECODE(H.TML_INV_TP_CD,'TM',DECODE(D.TML_TRNS_MOD_CD,'','S','S','S','O','O',NVL(L.TML_TRNS_MOD_CD,'S')),'N')
			  = DECODE(H.TML_INV_TP_CD,'TM',NVL(D.TML_TRNS_MOD_CD,'S'),'N')
	   AND    DECODE(H.TML_INV_TP_CD,'TM',DECODE(SUBSTR(D.LGS_COST_CD,5,2),'TS','F','N'),'N')
			  = DECODE(H.TML_INV_TP_CD,'TM',DECODE(SUBSTR(D.LGS_COST_CD,5,2),'TS',L.CNTR_STY_CD,'N'),'N')
--수정(20070920) -- E
	   GROUP BY D.ACCT_CD,H.COST_OFC_CD,NVL(L.FINC_VSL_CD||L.FINC_SKD_VOY_NO||L.FINC_SKD_DIR_CD,'0000000000'),
				H.VNDR_SEQ,H.INV_NO,TO_CHAR(H.ISS_DT,'YYYY/MM/DD HH24:MI:SS'),H.YD_CD,
				L.BKG_NO,L.CNTR_TPSZ_CD,
				DECODE(H.TML_INV_TP_CD,'TM',
				NVL(L.VSL_CD||L.SKD_VOY_NO||L.SKD_DIR_CD,L.FINC_VSL_CD||L.FINC_SKD_VOY_NO||L.FINC_SKD_DIR_CD),
				L.FINC_VSL_CD||L.FINC_SKD_VOY_NO||L.FINC_SKD_DIR_CD), L.FINC_VSL_CD, L.FINC_SKD_VOY_NO, L.FINC_SKD_DIR_CD, D.LGS_COST_CD,
				D.TML_CRR_CD,D.VOL_TR_UT_CD,H.CURR_CD,D.LANE_CD,H.TML_SO_OFC_CTY_CD,H.TML_SO_SEQ,D.VSL_CD,D.SKD_VOY_NO,D.SKD_DIR_CD,H.TO_PRD_DT,D.WRK_DT,D.IO_BND_CD) M,
	  ( SELECT D.LGS_COST_CD, D.CNTR_TPSZ_CD, D.TML_CRR_CD, SUM(NVL(D.INV_AMT,0)) CSR_AMT                   --수정(20070723)
		FROM   TES_TML_SO_HDR H, TES_TML_SO_DTL D
		WHERE  H.INV_NO              = @[inv_no]
		AND    H.VNDR_SEQ            = @[vndr_seq]
		AND    H.TML_INV_STS_CD      = 'C'
		AND    NVL(H.DELT_FLG,'N')   <> 'Y'
		AND    H.TML_SO_OFC_CTY_CD   = D.TML_SO_OFC_CTY_CD
		AND    H.TML_SO_SEQ          = D.TML_SO_SEQ
--		        AND    D.CALC_COST_GRP_CD    <> 'SP'
		AND    D.CALC_COST_GRP_CD    NOT IN ('SD','SP','EQ')  --수정(20080111)
		AND    D.CALC_TP_CD          = 'A'
		AND    NVL(D.INV_AMT,0)      <> 0
		GROUP BY D.LGS_COST_CD, D.CNTR_TPSZ_CD, D.TML_CRR_CD ) A,                                           --수정(20070723)
	  ( SELECT D.LGS_COST_CD, D.CNTR_TPSZ_CD, D.TML_CRR_CD, COUNT(L.CNTR_NO) RATE                           --수정(20070723)
		FROM   TES_TML_SO_HDR H, TES_TML_SO_DTL D, TES_TML_SO_CNTR_LIST L
		WHERE  H.INV_NO              = @[inv_no]
		AND    H.VNDR_SEQ            = @[vndr_seq]
		AND    H.TML_INV_STS_CD      = 'C'
		AND    NVL(H.DELT_FLG,'N')   <> 'Y'
		AND    H.TML_SO_OFC_CTY_CD   = D.TML_SO_OFC_CTY_CD
		AND    H.TML_SO_SEQ          = D.TML_SO_SEQ
--		        AND    D.CALC_COST_GRP_CD    <> 'SP'
		AND    D.CALC_COST_GRP_CD    NOT IN ('SD','SP','EQ')  --수정(20080111)
		AND    D.CALC_TP_CD          = 'A'
		AND    NVL(D.INV_AMT,0)      <> 0
		AND    H.TML_SO_OFC_CTY_CD   = L.TML_SO_OFC_CTY_CD
		AND    H.TML_SO_SEQ          = L.TML_SO_SEQ
		AND    L.VRFY_RSLT_IND_CD       = 'CO'
		 AND    DECODE(H.TML_INV_TP_CD,
						'TM',DECODE(SUBSTR(D.LGS_COST_CD,1,2),'TP',NVL(L.RVIS_IND_FLG,'N'),'TM',NVL(L.TML_RVIS_IND_FLG,'N'),'SR',NVL(L.STO_RVIS_IND_FLG,'N'),'SV',NVL(L.STV_RVIS_IND_FLG,'N'),'CG',NVL(L.CGO_RVIS_IND_FLG,'N')),
						'ON',DECODE(SUBSTR(D.LGS_COST_CD,1,2),'TP',NVL(L.RVIS_IND_FLG,'N'),'TM',NVL(L.TML_RVIS_IND_FLG,'N'),'SR',NVL(L.STO_RVIS_IND_FLG,'N'),'SV',NVL(L.STV_RVIS_IND_FLG,'N'),'CG',NVL(L.CGO_RVIS_IND_FLG,'N')),
						'OF',NVL(L.TML_RVIS_IND_FLG,'N'),
						'ST','N') <> 'Y'
		AND    NVL(L.CNTR_TPSZ_CD,'N')     = NVL(D.CNTR_TPSZ_CD,'N')
--		        AND    DECODE('TM',NVL(L.IO_BND_CD,'N'),'ON',NVL(L.IO_BND_CD,'N'),'OF','N','ST','N')
--		               = DECODE('TM',NVL(D.IO_BND_CD,'N'),'ON',NVL(D.IO_BND_CD,'N'),'OF','N','ST','N')
--		        AND    DECODE('TM',NVL(L.IOC_CD,'N'),'ON',NVL(L.IOC_CD,'N'),'OF','N','ST','N')
--		               = DECODE('TM',NVL(D.IOC_CD,'N'),'ON',NVL(D.IOC_CD,'N'),'OF','N','ST','N')
--		        AND    DECODE('TM',NVL(L.LANE_CD,'N'),'ON',NVL(L.LANE_CD,'N'),'OF','N','ST','N')
--		               = DECODE('TM',NVL(D.LANE_CD,'N'),'ON',NVL(D.LANE_CD,'N'),'OF','N','ST','N')
--		        AND    DECODE(H.TML_INV_TP_CD,'TM',
----		                 DECODE(L.BB_CGO_FLG,'Y','BB',DECODE(L.LOCL_TS_IND_CD,'T','TS',DECODE(L.CNTR_STY_CD,'F','FL','MT'))),
--		                 DECODE(L.BB_CGO_FLG,'Y','BB',DECODE(L.LOCL_TS_IND_CD,'T',DECODE(L.CNTR_STY_CD,'F','TS','TM'),DECODE(L.CNTR_STY_CD,'F','FL','MT'))),
--		                 'ON',DECODE(CNTR_STY_CD,'F','F','M'),'OF',DECODE(L.CNTR_STY_CD,'F','FL','MT'),'ST',DECODE(L.LOCL_TS_IND_CD,'T','TS',DECODE(L.CNTR_STY_CD,'F','FL','MT')))
--		               = DECODE(H.TML_INV_TP_CD,'TM',SUBSTR(D.LGS_COST_CD,5,2),'ON',SUBSTR('TMNDRF',6,1),'OF',SUBSTR(D.LGS_COST_CD,5,2),
--		                 'ST',SUBSTR(D.LGS_COST_CD,5,2))
--수정(20070920) -- B
		AND    DECODE(H.TML_INV_TP_CD,'TM',NVL(L.IO_BND_CD,'N'),'ON',NVL(L.IO_BND_CD,'N'),'OF','N','ST','N')
			   = DECODE(H.TML_INV_TP_CD,'TM',NVL(D.IO_BND_CD,'N'),'ON',NVL(D.IO_BND_CD,'N'),'OF','N','ST','N')
		AND    DECODE(H.TML_INV_TP_CD,'TM',NVL(L.IOC_CD,'N'),'ON',NVL(L.IOC_CD,'N'),'OF','N','ST','N')
			   = DECODE(H.TML_INV_TP_CD,'TM',NVL(D.IOC_CD,'N'),'ON',NVL(D.IOC_CD,'N'),'OF','N','ST','N')
		AND    DECODE(H.TML_INV_TP_CD,'TM',NVL(L.LANE_CD,'N'),'ON',NVL(L.LANE_CD,'N'),'OF','N','ST','N')
			   = DECODE(H.TML_INV_TP_CD,'TM',NVL(D.LANE_CD,'N'),'ON',NVL(D.LANE_CD,'N'),'OF','N','ST','N')
		AND    DECODE(H.TML_INV_TP_CD,'TM',
				 DECODE(L.BB_CGO_FLG,'Y','BB',DECODE(L.LOCL_TS_IND_CD,'T',DECODE(L.CNTR_STY_CD,'F','TS','TM'),DECODE(L.CNTR_STY_CD,'F','FL','MT'))),
				 'ON',DECODE(L.CNTR_STY_CD,'F','F','M'),'OF',DECODE(L.CNTR_STY_CD,'F','FL','MT'),'ST',DECODE(L.LOCL_TS_IND_CD,'T','TS',DECODE(L.CNTR_STY_CD,'F','FL','MT')))
			   = DECODE(H.TML_INV_TP_CD,'TM',SUBSTR(D.LGS_COST_CD,5,2),'ON',SUBSTR(D.LGS_COST_CD,6,1),'OF',SUBSTR(D.LGS_COST_CD,5,2),
				 'ST',SUBSTR(D.LGS_COST_CD,5,2))
		AND    DECODE(H.TML_INV_TP_CD,'TM',NVL(L.DCGO_CLSS_CD,'N'),'ON',NVL(L.DCGO_CLSS_CD,'N'),'OF','N','ST','N')
			   = DECODE(H.TML_INV_TP_CD,'TM',NVL(D.DCGO_IND_CD,'N'),'ON',NVL(D.DCGO_IND_CD,'N'),'OF','N','ST','N')
		AND    DECODE(H.TML_INV_TP_CD,'TM',DECODE(D.TML_TRNS_MOD_CD,'','S','S','S','O','O',NVL(L.TML_TRNS_MOD_CD,'S')),'N')
			   = DECODE(H.TML_INV_TP_CD,'TM',NVL(D.TML_TRNS_MOD_CD,'S'),'N')
		AND    DECODE(H.TML_INV_TP_CD,'TM',DECODE(SUBSTR(D.LGS_COST_CD,5,2),'TS','F','N'),'N')
			   = DECODE(H.TML_INV_TP_CD,'TM',DECODE(SUBSTR(D.LGS_COST_CD,5,2),'TS',L.CNTR_STY_CD,'N'),'N')
--수정(20070920) -- E
		GROUP BY D.LGS_COST_CD, D.CNTR_TPSZ_CD, D.TML_CRR_CD ) R                   --수정(20070723)
		WHERE M.FTU_USE_CTNT1 = A.LGS_COST_CD
		AND   M.CNTR_TPSZ_CD  = A.CNTR_TPSZ_CD                       --수정(20070723)
		AND   M.FTU_USE_CTNT1 = R.LGS_COST_CD
		AND   M.CNTR_TPSZ_CD  = R.CNTR_TPSZ_CD                       --수정(20070723)
        AND   NVL(M.SO_CRR_CD,'N') = NVL(A.TML_CRR_CD,'N')  
        AND   NVL(A.TML_CRR_CD,'N') = NVL(R.TML_CRR_CD,'N')) 
	UNION ALL
	SELECT --DISTINCT
		   @[line_seq]                                 LINE_SEQ,
		   ''                                                      LINE_NO,
		   'ITEM'                                                  LINE_TP_LU_CD,
		   DECODE(H.CURR_CD,'JPY',ROUND(SUM(NVL(D.INV_AMT,0))),
                            'TWD',ROUND(SUM(NVL(D.INV_AMT,0))),
                            'KRW',ROUND(SUM(NVL(D.INV_AMT,0))),
                            'IDR',ROUND(SUM(NVL(D.INV_AMT,0))),
                            'CLP',ROUND(SUM(NVL(D.INV_AMT,0))),
                            'DJF',ROUND(SUM(NVL(D.INV_AMT,0))),
                            'VND',ROUND(SUM(NVL(D.INV_AMT,0))),
                            'VUV',ROUND(SUM(NVL(D.INV_AMT,0))),
                            'XAF',ROUND(SUM(NVL(D.INV_AMT,0))),
                            'XPF',ROUND(SUM(NVL(D.INV_AMT,0))),
                                  ROUND(SUM(NVL(D.INV_AMT,0)),2)) CSR_AMT,  --수정(20070523)
		   ( SELECT ACCT_ENG_NM
			 FROM   MDM_ACCOUNT
			 WHERE  ACCT_CD = D.ACCT_CD )                          INV_DESC,
		   @[inv_tax_cd]                                                       INV_TAX_CD,
		   '01'                                                    DTRB_COA_CO_CD,
		   ( SELECT FINC_RGN_CD
			 FROM   MDM_ORGANIZATION
			 WHERE  OFC_CD = H.COST_OFC_CD  )                       DTRB_COA_RGN_CD,
		   ( SELECT AP_CTR_CD
			 FROM   MDM_ORGANIZATION
			 WHERE  OFC_CD = H.COST_OFC_CD  )                       DTRB_COA_CTR_CD,
		   D.ACCT_CD                                               DTRB_COA_ACCT_CD,
		   DECODE(D.ACCT_CD,'954113','0000000000', NVL(D.FINC_VSL_CD||D.FINC_SKD_VOY_NO||D.FINC_SKD_DIR_CD, '0000000000')) DTRB_COA_VVD_CD,
		   ( SELECT NVL(SUBS_CO_CD,'00')
			 FROM   MDM_VENDOR
			 WHERE  VNDR_SEQ = H.VNDR_SEQ )                        DTRB_COA_INTER_CO_CD,
		   '000000'                                                DTRB_COA_FTU_N1ST_CD,
		   '000000'                                                DTRB_COA_FTU_N2ND_CD,
		   D.ACCT_CD                                               ATTR_CATE_NM,
		   H.INV_NO                                                ATTR_CTNT1,
		   TO_CHAR(H.ISS_DT,'YYYY/MM/DD HH24:MI:SS')               ATTR_CTNT2,
		   SUBSTR(H.YD_CD,1,5)                                     ATTR_CTNT3,
		   NULL                                                    ATTR_CTNT4,
		   NULL                                                    ATTR_CTNT5,
		   NULL                                                    ATTR_CTNT6,
		   NULL                                                    ATTR_CTNT7,
		   NULL                                                    ATTR_CTNT8,
		   NULL                                                    ATTR_CTNT9,
		   NULL                                                    ATTR_CTNT10,		   
		   NVL(NVL((SELECT DISTINCT TO_CHAR(ATB_DT,'YYYYMMDD')
           				 FROM TES_TML_SO_VVD_LIST
			            WHERE TML_SO_OFC_CTY_CD = H.TML_SO_OFC_CTY_CD
           				  AND TML_SO_SEQ = H.TML_SO_SEQ
			              AND VSL_CD = D.VSL_CD
           				  AND SKD_VOY_NO = D.SKD_VOY_NO
				          AND SKD_DIR_CD = D.SKD_DIR_CD
                          AND IO_BND_CD  = D.IO_BND_CD),H.TO_PRD_DT),D.WRK_DT) ATTR_CTNT11,	
		   CASE WHEN (D.LGS_COST_CD = 'SVDRFL')
                  OR (D.LGS_COST_CD = 'SVDRMT')
                  OR (D.LGS_COST_CD = 'SVDRTS')
                THEN (SELECT LOC_CD
			            FROM MDM_VENDOR
			           WHERE VNDR_SEQ = @[vndr_seq]) 
		   ELSE H.YD_CD
		   END ATTR_CTNT12,
		   NULL                                                    ATTR_CTNT13,
		   NVL((SELECT DISTINCT SLAN_CD
                  FROM AR_MST_REV_VVD
                 WHERE D.FINC_VSL_CD                 = VSL_CD
                   AND D.FINC_SKD_VOY_NO             = SKD_VOY_NO
                   AND SUBSTR(D.FINC_SKD_DIR_CD,1,1) = SKD_DIR_CD
                   AND SUBSTR(D.FINC_SKD_DIR_CD,2,1) = RLANE_DIR_CD
			       AND ROWNUM       = 1),'COM')        ATTR_CTNT14,
--		           'M'                                                     ATTR_CTNT15,
		   D.CALC_TP_CD                                            ATTR_CTNT15,       --수정(20080111)
		   NULL                                                    BKG_NO,
		   NULL                                                    CNTR_TPSZ_CD,
		   DECODE(H.TML_INV_TP_CD,'TM',
				  NVL(D.VSL_CD||D.SKD_VOY_NO||D.SKD_DIR_CD,D.FINC_VSL_CD||D.FINC_SKD_VOY_NO||D.FINC_SKD_DIR_CD),
				  D.FINC_VSL_CD||D.FINC_SKD_VOY_NO||D.FINC_SKD_DIR_CD)  ACT_VVD_CD,
		   DECODE(SUBSTR(D.LGS_COST_CD,1,2),'ET','T',
			   DECODE((SELECT YD_OSHP_CD FROM MDM_YARD WHERE YD_CD = H.YD_CD),'O',
			DECODE(NVL(TRIM(D.TML_CRR_CD),'NYK'),'NYK','C','T'),'C')) PLN_SCTR_DIV_CD,
		   TRIM(D.TML_CRR_CD) 			                            SO_CRR_CD,
		   H.YD_CD                                                 YD_CD,
		   D.LGS_COST_CD                                           FTU_USE_CTNT1,
		   D.RVIS_VOL_QTY                                          FTU_USE_CTNT2,
		   D.VOL_TR_UT_CD                                          FTU_USE_CTNT3,
		   NULL                                                    FTU_USE_CTNT4,
		   NULL                                                    FTU_USE_CNTR5,
		   GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC(@[ofc_cd])                    CRE_DT,
		   @[cre_usr_id]                                                       CRE_USR_ID,
		   ''                                                      EAI_EVNT_DT
	FROM   TES_TML_SO_HDR H, TES_TML_SO_DTL D
	WHERE  H.INV_NO              = @[inv_no]
	AND    H.VNDR_SEQ            = @[vndr_seq]
	AND    H.TML_INV_STS_CD      = 'C'
	AND    NVL(H.DELT_FLG,'N')   <> 'Y'
	AND    H.TML_SO_OFC_CTY_CD   = D.TML_SO_OFC_CTY_CD(+)
	AND    H.TML_SO_SEQ          = D.TML_SO_SEQ(+)
    --		    AND    ( D.CALC_COST_GRP_CD    = 'SP'
	AND    ( D.CALC_COST_GRP_CD    IN ('SD','SP','EQ')   --수정(20080111)
	OR       D.CALC_TP_CD          = 'M' )
	AND    NVL(D.INV_AMT,0)      <> 0                         --추가(20070523)
	GROUP BY TO_CHAR(D.TML_SO_DTL_SEQ), '', 'ITEM', D.ACCT_CD, @[inv_tax_cd], '01', H.COST_OFC_CD ,
			 H.TML_INV_TP_CD, D.FINC_VSL_CD||D.FINC_SKD_VOY_NO||D.FINC_SKD_DIR_CD, H.VNDR_SEQ, H.INV_NO, H.ISS_DT,
			 SUBSTR(H.YD_CD,1,5), NVL(D.VSL_CD||D.SKD_VOY_NO||D.SKD_DIR_CD,D.FINC_VSL_CD||D.FINC_SKD_VOY_NO||D.FINC_SKD_DIR_CD),
			 DECODE(SUBSTR(D.LGS_COST_CD,1,2),'TP','C','SV','C','T'), D.TML_CRR_CD, H.YD_CD, D.LGS_COST_CD, D.RVIS_VOL_QTY, D.VOL_TR_UT_CD,
--		             GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC(), , H.CURR_CD
			 GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC(@[ofc_cd]), @[vndr_seq], H.CURR_CD, D.CALC_TP_CD  --(20080111)
			 , D.LANE_CD,H.TML_SO_OFC_CTY_CD,H.TML_SO_SEQ,D.VSL_CD,D.SKD_VOY_NO,D.SKD_DIR_CD,H.TO_PRD_DT,D.WRK_DT,D.FINC_VSL_CD,D.FINC_SKD_VOY_NO,D.FINC_SKD_DIR_CD,D.IO_BND_CD
	UNION ALL
 SELECT DISTINCT
		@[line_seq]                                                       LINE_SEQ,
		''                                                      LINE_NO,
		'ITEM'                                                  LINE_TP_LU_CD,
		DECODE(H.CURR_CD,'JPY',ROUND(-NVL(H.WHLD_TAX_AMT,0)),
                         'TWD',ROUND(-NVL(H.WHLD_TAX_AMT,0)),
                         'KRW',ROUND(-NVL(H.WHLD_TAX_AMT,0)),      
                         'IDR',ROUND(-NVL(H.WHLD_TAX_AMT,0)),       
                         'CLP',ROUND(-NVL(H.WHLD_TAX_AMT,0)),  
                         'DJF',ROUND(-NVL(H.WHLD_TAX_AMT,0)),  
                         'VND',ROUND(-NVL(H.WHLD_TAX_AMT,0)),  
                         'VUV',ROUND(-NVL(H.WHLD_TAX_AMT,0)),  
                         'XAF',ROUND(-NVL(H.WHLD_TAX_AMT,0)),  
                         'XPF',ROUND(-NVL(H.WHLD_TAX_AMT,0)),        
		                       ROUND(-NVL(H.WHLD_TAX_AMT,0),2)) CSR_AMT,      
		'WITHHOLDING TAX'                                       INV_DESC,
		@[inv_tax_cd]                                                       INV_TAX_CD,
		'01'                                                    DTRB_COA_CO_CD,
		( SELECT FINC_RGN_CD
		  FROM   MDM_ORGANIZATION
		  WHERE  OFC_CD = H.COST_OFC_CD )                        DTRB_COA_RGN_CD,
		( SELECT AP_CTR_CD
		  FROM   MDM_ORGANIZATION
		  WHERE  OFC_CD = H.COST_OFC_CD )                        DTRB_COA_CTR_CD,
		'211691'                                                DTRB_COA_ACCT_CD,
		'0000000000'                                            DTRB_COA_VVD_CD,
		( SELECT NVL(SUBS_CO_CD,'00')
		  FROM   MDM_VENDOR
		  WHERE  VNDR_SEQ = H.VNDR_SEQ )                        DTRB_COA_INTER_CO_CD,
		'000000'                                                DTRB_COA_FTU_N1ST_CD,
		'000000'                                                DTRB_COA_FTU_N2ND_CD,
		'211691'                                                ATTR_CATE_NM,
		H.INV_NO                                                ATTR_CTNT1,
		TO_CHAR(H.ISS_DT,'YYYY/MM/DD HH24:MI:SS')               ATTR_CTNT2,
		SUBSTR(H.YD_CD,1,5)                                     ATTR_CTNT3,
		NULL                                                    ATTR_CTNT4,
		NULL                                                    ATTR_CTNT5,
		NULL                                                    ATTR_CTNT6,
		NULL                                                    ATTR_CTNT7,
		NULL                                                    ATTR_CTNT8,
		NULL                                                    ATTR_CTNT9,
		NULL                                                    ATTR_CTNT10,
		NVL(NVL((SELECT DISTINCT TO_CHAR(MAX(ATB_DT),'YYYYMMDD')
           		   FROM TES_TML_SO_VVD_LIST
			      WHERE TML_SO_OFC_CTY_CD = H.TML_SO_OFC_CTY_CD
           		    AND TML_SO_SEQ = H.TML_SO_SEQ),H.TO_PRD_DT),H.WRK_DT) ATTR_CTNT11,
		H.YD_CD                                                 ATTR_CTNT12,
		NULL                                                    ATTR_CTNT13,
		'COM'                                                   ATTR_CTNT14,
		NULL                                                    ATTR_CTNT15,
		NULL                                                    BKG_NO,
		NULL                                                    CNTR_TPSZ_CD,
		NULL                                                    ACT_VVD_CD,
		NULL                                                    PLN_SCTR_DIV_CD,
		NULL                                                    SO_CRR_CD,
		H.YD_CD                                                 YD_CD,
		NULL                                                    FTU_USE_CTNT1,
		NULL                                                    FTU_USE_CTNT2,
		NULL                                                    FTU_USE_CTNT3,
		NULL                                                    FTU_USE_CTNT4,
		NULL                                                    FTU_USE_CNTR5,
		GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC(@[ofc_cd])                    CRE_DT,
		@[cre_usr_id]                                                       CRE_USR_ID,
		''                                                      EAI_EVNT_DT
 FROM   TES_TML_SO_HDR H
 WHERE  H.INV_NO              = @[inv_no]
 AND    H.VNDR_SEQ            = @[vndr_seq]
 AND    H.TML_INV_STS_CD      = 'C'
 AND    NVL(H.DELT_FLG,'N')   <> 'Y'
 AND    NVL(H.WHLD_TAX_AMT,0) <> 0             --추가(20070523)
 )			]]></sql>
			<params>
				<param name="line_seq" type="12" value="" out="N"/>
				<param name="inv_tax_cd" type="12" value="" out="N"/>
				<param name="ofc_cd" type="12" value="" out="N"/>
				<param name="cre_usr_id" type="12" value="" out="N"/>
				<param name="vndr_seq" type="12" value="" out="N"/>
				<param name="inv_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
