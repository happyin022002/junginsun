<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ProductCatalogCreateDBDAOSearchProductCatalogInternalMst_1RSQL">
			<desc><![CDATA[SearchProductCatalogInternalMst_1]]></desc>
			<sql><![CDATA[
SELECT por_cd
      ,ob_itchg_ctnt
      ,pol_cd	  
      ,RTRIM(MAX(DECODE(ts.rk, 1, REPLACE(ts.vsl_slan_cd, '-(', '('))) || n1st_ts_port_cd || MAX(DECODE(ts.rk, 2, ts.vsl_slan_cd)) || n2nd_ts_port_cd || MAX(DECODE(ts.rk, 3, ts.vsl_slan_cd)) || n3rd_ts_port_cd || MAX(DECODE(ts.rk, 4, ts.vsl_slan_cd)), '-') ts_route
      ,pod_cd	  
      ,ib_itchg_ctnt
      ,del_cd
      ,LPAD(FLOOR(ttl_tztm_hrs / 24), 2, 0) || LPAD(MOD(ttl_tztm_hrs, 24), 2, 0) ttl_tztm_hrs
      ,DECODE(TRIM(cnst_flg), 'X','1', '3') remark_img
      ,DECODE(TRIM(cnst_flg), 'X','N',NULL,NULL,'Y') remark
      ,round(ttl_expn_amt, 2) total_cost
      ,trnk_aval_spc
      ,m.pctl_no
      ,(select vsl_slan_cd from vsk_vsl_skd v where v.vsl_cd = trnk_vsl_cd and v.skd_voy_no = trnk_skd_voy_no and v.skd_dir_cd = trnk_skd_dir_cd)||'-'||trnk_vsl_cd || trnk_skd_voy_no || trnk_skd_dir_cd trnk_vvd
      ,(select vsl_slan_cd from vsk_vsl_skd v where v.vsl_cd = trnk_vsl_cd and v.skd_voy_no = trnk_skd_voy_no and v.skd_dir_cd = trnk_skd_dir_cd) trnk_lane
      ,mty_pkup_yd_cd
      ,por_nod_cd
	  ,pol_nod_cd
	  ,pod_nod_cd
      ,del_nod_cd
      ,m.rout_cnst_seq
      ,DECODE(rout_flag, 'S', 'Standard', 'T', 'Temporary', 'V', 'Validation', 'N', 'Not Used', 'A', 'Add Call', 'D', 'Deleted', 'G', 'Guide') rout_flag
      ,DECODE(rout_flag, 'G', 1, 'S', 1, 'T', 3, 'A', 4, 'V', 5, 'N', 6, 'D', 7) ord
      ,(SELECT TO_CHAR(MAX(D.ARR_ST_DT),'MON DD HH24:MI') FROM PRD_PROD_CTL_ROUT_DTL D WHERE D.PCTL_NO = M.PCTL_NO AND D.PCTL_IO_BND_CD ='O') port_cct
      ,TO_CHAR((CASE (SELECT COUNT(*)
                   FROM prd_prod_ctl_mst m1
                  WHERE m1.POL_NOD_CD = (SELECT /*+ index(A XPKPRD_PROD_CTL_ROUT_DTL) */ DEST_NOD_CD
                                           FROM prd_prod_ctl_rout_dtl dtl
                                          WHERE dtl.pctl_no = m1.pctl_no
                                            AND dtl.DEST_NOD_TP_CD <> 'Z'
                                            AND dtl.NOD_LNK_DIV_CD = 'L'
                                            AND dtl.MTY_YD_FLG = 'N'
                                            AND rownum = 1)
                    AND m1.pctl_no = M.PCTL_NO)
                 WHEN 0 THEN
                  (NVL(PRD_GET_INLND_CCT_FNC(M.PCTL_NO),
                       (SELECT /*+INDEX_DESC(DTL XPKPRD_PROD_CTL_ROUT_DTL)*/
                         DTL.ARR_ST_DT
                          FROM PRD_PROD_CTL_ROUT_DTL DTL
                              ,PRD_INLND_ROUT_MST    O
                         WHERE DTL.PCTL_NO = M.PCTL_NO
                           AND DTL.PCTL_IO_BND_CD = 'O'
                           AND DTL.ROUT_ORG_NOD_CD = O.ROUT_ORG_NOD_CD
                           AND DTL.ROUT_DEST_NOD_CD = O.ROUT_DEST_NOD_CD
                           AND DTL.ROUT_SEQ = O.ROUT_SEQ
                           AND DTL.ORG_NOD_CD = O.FULL_RTN_YD_CD
                           AND DTL.ROUT_SEQ > 0
                           AND DTL.NOD_LNK_DIV_CD = 'N'
                           AND ROWNUM = 1
                        UNION ALL
                        SELECT /*+INDEX_DESC(DTL XPKPRD_PROD_CTL_ROUT_DTL)*/
                         DTL.ARR_ST_DT
                          FROM PRD_PROD_CTL_ROUT_DTL DTL
                         WHERE DTL.PCTL_NO = M.PCTL_NO
                           AND DTL.PCTL_IO_BND_CD = 'O'
                           AND DTL.ROUT_SEQ = 0
                           AND ROWNUM = 1)))  
                     
                 ELSE	PRD_COMMON_PKG.PRD_GET_CCT_BY_PC_FNC(M.PCTL_NO)
               END),
               'YYYY-MM-DD HH24:MI') AS ful_rtn_cct
      ,(SELECT /*+INDEX_ASC(DTL XPKPRD_PROD_CTL_ROUT_DTL)*/
               TO_CHAR(DTL.DEP_FSH_DT,'MON DD HH24:MI')
          FROM PRD_PROD_CTL_ROUT_DTL DTL, PRD_INLND_ROUT_MST I
         WHERE DTL.PCTL_NO = M.PCTL_NO
           AND DTL.PCTL_IO_BND_CD = 'I'
           AND DTL.ROUT_ORG_NOD_CD = I.ROUT_ORG_NOD_CD
           AND DTL.ROUT_DEST_NOD_CD = I.ROUT_DEST_NOD_CD
           AND DTL.ROUT_SEQ = I.ROUT_SEQ
           AND DTL.DEST_NOD_CD = I.FULL_PKUP_YD_CD
           AND DTL.ROUT_SEQ > 0
           AND DTL.NOD_LNK_DIV_CD = 'N'
           AND ROWNUM=1
         UNION ALL
        SELECT /*+INDEX_ASC(DTL XPKPRD_PROD_CTL_ROUT_DTL)*/
               TO_CHAR(DTL.DEP_FSH_DT,'MON DD HH24:MI')
          FROM PRD_PROD_CTL_ROUT_DTL DTL
         WHERE DTL.PCTL_NO = M.PCTL_NO
           AND DTL.PCTL_IO_BND_CD = 'I'
           AND DTL.ROUT_SEQ = 0
           AND ROWNUM=1
       ) AS last_avail_dt

      ----,LPAD(FLOOR(M.CML_OCN_TZTM_HRS/24), 2, 0) CML_OCN_TZTM_HRS
      ----,LPAD(TRUNC((M.CML_OCN_TZTM_HRS + M.CML_INLND_TZTM_HRS) / 24), 2, 0)  CML_INLND_TZTM_HRS

      ,LPAD(FLOOR(ROUND(M.CML_OCN_TZTM_HRS)/24),2,'0')						||'D'||LPAD(MOD(ROUND(M.CML_OCN_TZTM_HRS),24),2,'0')						||'H' AS CML_OCN_TZTM_HRS
      ,LPAD(FLOOR(ROUND(M.CML_OCN_TZTM_HRS+M.CML_INLND_TZTM_HRS)/24),2,'0')	||'D'||LPAD(MOD(ROUND(M.CML_OCN_TZTM_HRS+M.CML_INLND_TZTM_HRS),24),2,'0')	||'H' AS CML_INLND_TZTM_HRS

	  ,OCN_ROUT_PRIO_CD
  FROM prd_prod_ctl_mst m
      ,(SELECT pctl_no
              ,RANK() OVER(PARTITION BY pctl_no ORDER BY pctl_seq) rk
              ,'-(' || vsl_slan_cd || ')-' vsl_slan_cd
              ,upd_ind_cd rout_flag
			  ,OCN_ROUT_PRIO_CD
          FROM prd_prod_ctl_rout_dtl dtl
              ,prd_ocn_rout          rout
         WHERE pctl_no LIKE @[pctl_no] || '%'
           AND vsl_slan_cd IS NOT NULL
           AND dtl.rout_org_nod_cd = rout.org_loc_cd(+)
           AND dtl.rout_dest_nod_cd = rout.dest_loc_cd(+)
           AND dtl.rout_seq = rout.rout_seq(+)) ts     
 WHERE m.pctl_no LIKE @[pctl_no] || '%'
   AND m.pctl_no = ts.pctl_no(+)
 GROUP BY por_cd
         ,ob_itchg_ctnt
         ,pol_cd
         ,n1st_ts_port_cd
         ,n2nd_ts_port_cd
         ,n3rd_ts_port_cd
         ,pod_cd
         ,ib_itchg_ctnt
         ,del_cd
         ,LPAD(FLOOR(ttl_tztm_hrs / 24), 2, 0) || LPAD(MOD(ttl_tztm_hrs, 24), 2, 0)
         ,ttl_expn_amt
         ,trnk_aval_spc
         ,cnst_flg
         ,m.pctl_no
         ,m.rout_cnst_seq
         ,trnk_vsl_cd
         ,trnk_skd_voy_no
         ,trnk_skd_dir_cd
         ,mty_pkup_yd_cd
         ,por_nod_cd
		 ,pol_nod_cd
		 ,pod_nod_cd
         ,del_nod_cd		 
         ,rout_flag
         ,cml_ocn_tztm_hrs
         ,cml_inlnd_tztm_hrs
         ,OCN_ROUT_PRIO_CD
 order by ord, ttl_expn_amt, ttl_tztm_hrs
 			]]></sql>
			<params>
				<param name="pctl_no" type="12" value="t2134123123" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
