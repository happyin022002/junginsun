<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="WorkOrderIssueDBDAOsearchWorkOrderIssueBySoNoRSQL">
			<desc><![CDATA[searchWorkOrderIssueBySoNo]]></desc>
			<sql><![CDATA[
SELECT 
	TO_CHAR(NVL(RCL.MNL_SET_DT,RCL.SYS_SET_DT), 'YYYY-MM-DD HH24:MI:SS') R_CCT,
    TO_CHAR(NVL(PCL.MNL_SET_DT,PCL.SYS_SET_DT), 'YYYY-MM-DD HH24:MI:SS') T_CCT,
    'N' WO_ISSUED,
    CASE WHEN WO_RJCT_FLG = 'Y' THEN '1' ELSE '0' END REJECTED_CHECK ,  
    A.EQ_NO ,
    A.EQ_TPSZ_CD ,
    A.EQ_KND_CD ,
    CASE
     WHEN A.TRSP_BND_CD = 'I' THEN
      (SELECT ECC_CD
         FROM MDM_EQ_ORZ_CHT
        WHERE SCC_CD = (SELECT SCC_CD FROM MDM_LOCATION WHERE LOC_CD = SUBSTR(A.TO_NOD_CD, 1, 5))
          AND ROWNUM = 1)
     ELSE
      (SELECT ECC_CD
         FROM MDM_EQ_ORZ_CHT
        WHERE SCC_CD = (SELECT SCC_CD FROM MDM_LOCATION WHERE LOC_CD = SUBSTR(A.FM_NOD_CD, 1, 5))
          AND ROWNUM = 1)
    END AS ECC_CD,    
    A.CGO_TP_CD ,
    COMMCODE_PKG.GET_COMDTL_NAME_FNC('CD00748', A.CGO_TP_CD) AS CGO_TP_NM ,
    A.TRSP_COST_DTL_MOD_CD ,
    COMMCODE_PKG.GET_COMDTL_NAME_FNC('CD00594', A.TRSP_COST_DTL_MOD_CD) AS TRSP_COST_DTL_MOD_NM ,
    A.TRSP_SO_CMB_SEQ ,
    A.TRSP_CRR_MOD_CD ,
    COMMCODE_PKG.GET_COMDTL_NAME_FNC('CD00283', A.TRSP_CRR_MOD_CD) AS TRSP_CRR_MOD_NM ,
    SUBSTR(A.FM_NOD_CD, 1, 5) FM_LOC_VALUE ,
    SUBSTR(A.FM_NOD_CD, 6, 2) FM_YARD_VALUE ,
    SUBSTR(A.VIA_NOD_CD, 1, 5) VIA_LOC_VALUE ,
    SUBSTR(A.VIA_NOD_CD, 6, 2) VIA_YARD_VALUE ,
    SUBSTR(A.TO_NOD_CD, 1, 5) TO_LOC_VALUE ,
    SUBSTR(A.TO_NOD_CD, 6, 2) TO_YARD_VALUE ,
    SUBSTR(A.DOR_NOD_CD, 1, 5) DOR_LOC_VALUE ,
    SUBSTR(A.DOR_NOD_CD, 6, 2) DOR_YARD_VALUE ,
    A.CUST_CNT_CD||A.CUST_SEQ CUST_CNT_CD_SEQ ,
    A.ACT_CUST_CNT_CD||A.ACT_CUST_SEQ   ACT_CUST_CD ,  -- 추가 
    A.CUST_NOMI_TRKR_FLG ,
    A.CUST_CNT_CD ,
    A.CUST_SEQ ,
    A.DOR_DE_ADDR ,
    A.MLT_STOP_DE_FLG ,
    A.CNTR_WGT ,
    A.WGT_MEAS_UT_CD WGT_UT_CD,
    A.CNTR_KGS_WGT,  -- 추가 
    A.CNTR_LBS_WGT,  -- 추가 
    A.SPCL_CGO_CNTR_TP_CD,  -- 추가 
    CASE WHEN D.DCGO_FLG ='Y' THEN 'DG' WHEN D.BB_CGO_FLG ='Y' THEN 'BB' WHEN D.AWK_CGO_FLG='Y' THEN 'AK' WHEN D.RC_FLG ='Y' THEN 'RF' WHEN D.RD_CGO_FLG ='Y' THEN 'RD' ELSE '' END BKGSPE ,
    -- TRS_AGMT_RATE_CC_PKG.GET_CAL_DIST_BTWN_NOD_FNC( 'KM' , 'D' , A.TRSP_COST_DTL_MOD_CD , A.TRSP_BND_CD , A.FM_NOD_CD , A.VIA_NOD_CD , A.DOR_NOD_CD , A.TO_NOD_CD ) AS DISTANCE ,
    -- TRS_AGMT_RATE_CC_PKG.GET_CAL_DIST_BTWN_NOD_FNC( 'ML' , 'D' , A.TRSP_COST_DTL_MOD_CD , A.TRSP_BND_CD , A.FM_NOD_CD , A.VIA_NOD_CD , A.DOR_NOD_CD , A.TO_NOD_CD ) AS DISTANCE_UOM ,
    ' ' MORE_CANDIDATES ,
    A.TRSP_RQST_ORD_REV_AMT REVENUE ,
    A.REV_CURR_CD ,
    A.N3PTY_BIL_FLG ,
    A.BKG_NO BKG_NO ,
    A.BL_NO BL_NO ,
    A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD T_VVD ,
    A.SLAN_CD LANE ,
    FDR_VSL_CD||FDR_SKD_VOY_NO||FDR_SKD_DIR_CD FDR_VVD ,
    NVL(A.DTN_USE_FLG, 'N') DTN_USE_FLG ,
    NVL(A.WO_BL_NO_ISS_FLG, 'N') WO_BL_NO_ISS_FLG ,
    TO_CHAR(A.LOCL_CRE_DT, 'YYYY-MM-DD HH24:MI:SS') SO_CRE_DT ,
    TO_CHAR(WRK.LOCL_CRE_DT, 'YYYY-MM-DD HH24:MI:SS') WO_ISSUE_DT ,
    '' WO_RJCT_DT,  -- TO_CHAR(WRK.WO_RJCT_DT, 'YYYY-MM-DD HH24:MI:SS') WO_RJCT_DT	,
    DECODE(A.TRSP_SO_TP_CD, 'M', A.INTER_RMK, 'H', A.INTER_RMK, 
    		DECODE((SELECT MAX(RMK.BKG_NO)
	   				FROM TRS_INTER_RMK RMK
	  				WHERE RMK.BKG_NO IN (A.BKG_NO, 'DUM000000000')
					AND NVL(RMK.EQ_NO, 'X') = NVL2(RMK.EQ_NO, A.EQ_NO, 'X')
					AND NVL(RMK.TRSP_SO_OFC_CTY_CD, 'XX') = NVL2(RMK.TRSP_SO_OFC_CTY_CD, A.TRSP_SO_OFC_CTY_CD, 'XX')
					AND NVL(RMK.TRSP_SO_SEQ, '99999') = NVL2(RMK.TRSP_SO_SEQ, A.TRSP_SO_SEQ, '99999')
					AND NVL(RMK.DELT_FLG, 'X') = 'N'), '', '', 'Y')) AS INTER_RMK ,
    DECODE(A.TRSP_SO_TP_CD, 'M', '', 'H', '', '1') INTER_RMK_IMG ,
    A.SPCL_INSTR_RMK ,
    WRK.WO_RMK ,
    --DECODE(STK.SO_SEQ, NULL, 'N', 'Y') AS MTY_RR_FLG ,
    NVL((SELECT 'Y' FROM CIM_CNTR_STK STK WHERE A.TRSP_SO_OFC_CTY_CD = STK.SO_OFC_CTY_CD AND A.TRSP_SO_SEQ = STK.SO_SEQ GROUP BY SO_SEQ),'N') MTY_RR_FLG,
    A.TRSP_SO_OFC_CTY_CD||A.TRSP_SO_SEQ AS TRSP_SO_OFC_CTY_CD_SEQ ,
    A.TRSP_SO_OFC_CTY_CD ,
    A.TRSP_SO_SEQ ,
    A.TRSP_SO_SEQ AS surcharge_key,
    A.TRSP_SO_TP_CD ,
    A.TRSP_WO_OFC_CTY_CD||A.TRSP_WO_SEQ AS TRSP_WO_OFC_CTY_CD_SEQ ,
    A.TRSP_WO_OFC_CTY_CD ,
    A.TRSP_WO_SEQ ,
    A.CRE_OFC_CD ,
    TO_CHAR(A.LOCL_CRE_DT, 'YYYYMMDDHH24MISS') CRE_DT ,

    DECODE(VNDR.DELT_FLG, 'Y', '', A.VNDR_SEQ) AS VNDR_SEQ ,
    DECODE(VNDR.DELT_FLG, 'Y', '', A.VNDR_SEQ) AS PRESET_VNDR_SEQ ,
    DECODE(VNDR.DELT_FLG, 'Y', '', VNDR.VNDR_LGL_ENG_NM) AS VNDR_NM ,
    NVL(VNDR.WO_EDI_USE_FLG, 'N') WO_EDI_USE_FLG ,
    A.TRSP_DFLT_VNDR_FLG AS DEFAULT_SP_FLG ,
    DECODE(A.CUST_NOMI_TRKR_FLG, 'Y', 'CNT', 'NYK') PO_SP_TYPE,
    NVL(A.TRSP_FRST_FLG , 'N') TRSP_FRST_FLG ,
    A.TRSP_RJCT_RSN_CD ,
    A.TRSP_RQST_BKG_FLG ,
    A.TRSP_SO_CMB_TP_CD ,
    A.TRSP_BND_CD ,
    A.CMDT_CD ,
    A.FM_NOD_CD ,
    A.VIA_NOD_CD ,
    A.DOR_NOD_CD ,
    A.TO_NOD_CD ,
    CASE WHEN TRSP_SO_CMB_TP_CD = 'BD' THEN COUNT(A.TRSP_SO_SEQ) OVER (PARTITION BY TRSP_SO_CMB_TP_CD, TRSP_SO_CMB_SEQ) ELSE 1 END BUNDLING_NO ,
    NVL(A.CURR_CD, @[BIL_CURR_CD]) AS CURR_CD,
    A.WGT_MEAS_UT_CD ,
    A.ETC_ADD_AMT ,
    A.BZC_AMT ,
    A.FUEL_SCG_AMT ,
    A.NEGO_AMT ,
    ( NVL(A.BZC_AMT, 0) + NVL(A.NEGO_AMT, 0) + NVL(A.FUEL_SCG_AMT, 0) + NVL(A.ETC_ADD_AMT, 0) ) AS WO_TOT_AMT ,
    (
    SELECT ROUND((TO_NUMBER( NVL(A.BZC_AMT, 0) + NVL(A.NEGO_AMT, 0) + NVL(A.FUEL_SCG_AMT, 0) + NVL(A.ETC_ADD_AMT, 0) ) / RAT.USD_LOCL_XCH_RT), 2) WO_TOT_AMT_USD
    FROM GL_MON_XCH_RT RAT
    WHERE RAT.CURR_CD = A.CURR_CD
    AND RAT.ACCT_XCH_RT_LVL = '1'
    AND RAT.ACCT_XCH_RT_YRMON = TO_CHAR(SYSDATE, 'YYYYMM') ) AS WO_TOT_AMT_USD ,
    '' WO_RJCT_INDCT ,
    DECODE(A.CUST_NOMI_TRKR_FLG, 'Y', 'CNT', 'COM') AS SP_TYPE ,
    A.TRSP_AGMT_RT_TP_CD ,
    COMMCODE_PKG.GET_COMDTL_NAME_FNC('CD00954',A.TRSP_AGMT_RT_TP_CD) AS TRSP_AGMT_RT_TP_NM,
    A.TRO_SEQ,
    A.TRSP_AGMT_WY_TP_CD,
    COMMCODE_PKG.GET_COMDTL_NAME_FNC('CD00762',A.TRSP_SO_CMB_TP_CD) AS TRSP_SO_CMB_TP_NM,															 
    COMMCODE_PKG.GET_COMDTL_NAME_FNC('CD00279',A.TRSP_SO_TP_CD)	AS TRSP_SO_TP_NM,															 
    TO_CHAR(A.N1ST_NOD_PLN_DT, 'YYYY-MM-DD') N1ST_NOD_PLN_DT,						 
    TO_CHAR(A.N1ST_NOD_PLN_DT, 'HH24:MI:SS') N1ST_NOD_PLN_TM,						 
    TO_CHAR(A.LST_NOD_PLN_DT, 'YYYY-MM-DD') LST_NOD_PLN_DT,							 
    TO_CHAR(A.LST_NOD_PLN_DT, 'HH24:MI:SS') LST_NOD_PLN_TM,							 
    TO_CHAR(A.DOR_NOD_PLN_DT, 'YYYY-MM-DD') DOR_NOD_PLN_DT,							 
    TO_CHAR(A.DOR_NOD_PLN_DT, 'HH24:MI:SS') DOR_NOD_PLN_TM,							 
    A.COP_NO,																		 
    A.COST_ACT_GRP_SEQ,
    A.COST_ACT_GRP_CD COST_ACT_GRP_CD,
    DECODE (A.TRSP_COST_DTL_MOD_CD,'DR', DECODE (NVL (A.TRO_SEQ, ''),'', 'N','Y'),'') TRO_CNFM,
    DECODE(A.TRSP_COST_DTL_MOD_CD,'DR', A.TRO_SEQ, '') AS TRO_SEQ,
    (SELECT LISTAGG(DECODE(NVL(U.EQ_SUBST_CGO_QTY, 0), 0, U.CNTR_TPSZ_CD ||' '||U.OP_CNTR_QTY, U.CNTR_TPSZ_CD||' '||U.OP_CNTR_QTY ||'-SUB '||U.EQ_SUBST_CNTR_TPSZ_CD ||' '||U.EQ_SUBST_CGO_QTY ), ', ') WITHIN GROUP (ORDER BY U.BKG_NO)
       FROM BKG_QUANTITY U
      WHERE U.BKG_NO(+)       = A.BKG_NO) AS BKG_QTY,
    A.IB_VVD_CD,																		 
    A.OB_VVD_CD,																		 
    A.REF_ID,																		 
    NVL(USR1.USR_NM,A.CRE_USR_ID)	SO_CRE_NM,
    NVL(USR2.USR_NM,WRK.UPD_USR_ID)	WO_CRE_NM,														 
    A.FCTRY_NM,					 
    A.DOR_PST_CD,																	 
    A.CNTC_PSON_PHN_NO,																 
    A.CNTC_PSON_FAX_NO,																 
    A.CNTC_PSON_NM,																	 
    A.TRO_CFM_OFC_CD,																 
    A.TRO_CFM_USR_ID,																 
    TO_CHAR(A.TRO_CFM_UPD_DT, 'YYYY-MM-DD') AS TRO_CFM_UPD_DT,						 
    TO_CHAR(A.TRO_CFM_UPD_DT, 'HH24:MI:SS') AS TRO_CFM_UPD_TM,						 
    (SELECT REPLACE (CUST_NM, CHR (13) || CHR (10),' ')
    FROM BKG_CUSTOMER CUST
    WHERE CUST.BKG_NO = A.BKG_NO
    AND CUST.BKG_CUST_TP_CD = 'S' ) AS SHPR_CUST_NM,
    (SELECT REPLACE (CUST_NM, CHR (13) || CHR (10),' ')
    FROM BKG_CUSTOMER CUST
    WHERE CUST.BKG_NO = A.BKG_NO
    AND CUST.BKG_CUST_TP_CD = 'C' ) AS CNEE_CUST_NM,
    (SELECT REPLACE (CUST_NM, CHR (13) || CHR (10),' ')
    FROM BKG_CUSTOMER CUST
    WHERE CUST.BKG_NO = A.BKG_NO
    AND CUST.BKG_CUST_TP_CD = 'N' ) AS NTFY_CUST_NM	,																 
    A.N3PTY_BIL_BZC_AMT	AS N3PTY_BZC_AMT,											 
    A.N3PTY_VNDR_SEQ AS N3PTY_BZC_VNDR_SEQ,											 
    A.N3PTY_OFC_CD AS N3PTY_BZC_OFC_CD,												 
    A.N3PTY_DESC AS N3PTY_BZC_DESC,													 
    A.N3PTY_CUST_SEQ AS N3PTY_BZC_CUST_SEQ,											 
    A.N3PTY_CUST_CNT_CD AS N3PTY_BZC_CUST_CNT_CD,									 
    A.N3PTY_BIL_TP_CD AS N3PTY_BZC_TP_CD
FROM TRS_TRSP_SVC_ORD A
    ,BKG_BOOKING B
    ,BKG_CONTAINER D
    -- ,TRS_AGMT_DIST DIST
    ,MDM_VENDOR VNDR
    ,TRS_TRSP_WRK_ORD WRK
    -- ,CIM_CNTR_STK STK
    ,COM_USER USR1
    ,COM_USER USR2
    -- 2015.04.24 CHAN WOO PARK
    ,BKG_CLZ_TM RCL
    ,BKG_CLZ_TM PCL
WHERE A.BKG_NO =B.BKG_NO(+)  
    AND A.BKG_NO =D.BKG_NO(+)  
    AND A.EQ_NO = D.CNTR_NO(+)  
    -- AND A.FM_NOD_CD = DIST.FM_NOD_CD(+)  
    -- AND A.TO_NOD_CD = DIST.TO_NOD_CD(+)  
    AND A.VNDR_SEQ = VNDR.VNDR_SEQ (+)  
    AND A.TRSP_WO_OFC_CTY_CD =WRK.TRSP_WO_OFC_CTY_CD (+)  
    AND A.TRSP_WO_SEQ =WRK.TRSP_WO_SEQ (+)  
    AND NVL(A.DELT_FLG, 'N') = 'N'  
    -- AND NVL(VNDR.DELT_FLG, 'N') = 'N'  
    -- AND A.TRSP_SO_OFC_CTY_CD = STK.SO_OFC_CTY_CD(+)
    -- AND A.TRSP_SO_SEQ = STK.SO_SEQ(+)
    AND A.TRSP_SO_OFC_CTY_CD = SUBSTR(@[form_usr_ofc_cd],1,3)
    AND	NVL(A.UPD_USR_ID,A.CRE_USR_ID)	=USR1.USR_ID (+)
    AND	WRK.CRE_USR_ID                	=USR2.USR_ID (+)
    -- 2015.04.24 CHAN WOO PARK
    AND A.BKG_NO = RCL.BKG_NO(+)
    AND RCL.CLZ_TP_CD(+) = 'R'
    AND A.BKG_NO = PCL.BKG_NO(+)
    AND PCL.CLZ_TP_CD(+) = 'T'

#if($so_no.size() > 0)  
    AND (A.TRSP_SO_OFC_CTY_CD,A.TRSP_SO_SEQ) IN (
        #foreach($code IN ${so_no})  
            #if($velocityCount == 1)  
                (SUBSTR('$code', 1, 3),SUBSTR('$code', 4, 11))
            #else  
               ,(SUBSTR('$code', 1, 3),SUBSTR('$code', 4, 11))  
            #end  
        #end
    )
#end			]]></sql>
			<params>
				<param name="BIL_CURR_CD" type="12" value="" out="N"/>
				<param name="form_usr_ofc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
