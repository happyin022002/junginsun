<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="WorkOrderMainDBDAOAddTrsEdiUsaRcvMsgCSQL">
			<desc><![CDATA[WorkOrderMainDBDAOAddTrsEdiUsaRcvMsg]]></desc>
			<sql><![CDATA[
#if (${chg_compare} == 'Y')
insert into TRS_EDI_USA_RCV_MSG (
   TRSP_SO_OFC_CTY_CD
  ,TRSP_SO_SEQ
  ,RCV_MSG_SEQ
  ,RCV_MSG_SUB_SEQ
  ,TRSP_WO_OFC_CTY_CD
  ,TRSP_WO_SEQ
  ,LGS_COST_CD
  ,CURR_CD
  ,RCV_AMT
  ,FUEL_RTO
  ,RCV_MSG_STS_CD
  ,CRE_USR_ID
  ,CRE_DT
  ,UPD_USR_ID
  ,UPD_DT
  ,RCV_MSG_TP_CD
  ,EDI_RJCT_RSN_CD
  ,RCV_MSG
  ,RCV_MSG_DESC
  ,OLD_RCV_AMT
  ,OLD_FUEL_RTO
  ,OLD_RCV_MSG_DESC
)
  select @[trsp_so_ofc_cty_cd] TRSP_SO_OFC_CTY_CD
        ,@[trsp_so_seq] TRSP_SO_SEQ
        ,@[rcv_msg_seq] RCV_MSG_SEQ
        ,NVL((SELECT MAX(RCV_MSG_SUB_SEQ) + 1 FROM TRS_EDI_USA_RCV_MSG WHERE TRSP_SO_OFC_CTY_CD = @[trsp_so_ofc_cty_cd] AND TRSP_SO_SEQ = @[trsp_so_seq] AND RCV_MSG_SEQ = @[rcv_msg_seq]), 1) RCV_MSG_SUB_SEQ
        ,@[trsp_wo_ofc_cty_cd] TRSP_WO_OFC_CTY_CD
        ,@[trsp_wo_seq] TRSP_WO_SEQ
        ,@[lgs_cost_cd] LGS_COST_CD
        ,@[curr_cd] CURR_CD
        ,@[rcv_amt] RCV_AMT
        ,@[fuel_rto] FUEL_RTO
        ,@[rcv_msg_sts_cd] RCV_MSG_STS_CD
        ,'EDIUSER' CRE_USR_ID
        ,sysdate CRE_DT
        ,'EDIUSER' UPD_USR_ID
        ,sysdate UPD_DT
        ,@[rcv_msg_tp_cd] RCV_MSG_TP_CD
        ,@[edi_rjct_rsn_cd] EDI_RJCT_RSN_CD
        ,@[rcv_msg] RCV_MSG
        ,@[rcv_msg_desc] RCV_MSG_DESC
	    ,nvl((select sum(o.scg_amt) from trs_trsp_scg_dtl o where o.trsp_so_ofc_cty_cd = @[trsp_so_ofc_cty_cd]	 and o.trsp_so_seq = @[trsp_so_seq]	 and o.lgs_cost_cd = @[lgs_cost_cd]), 0) OLD_RCV_AMT
	    ,@[old_fuel_rto] OLD_FUEL_RTO
	    ,@[old_rcv_msg_desc] OLD_RCV_MSG_DESC
    from dual
   where (select count(*) from (
				select lgs_cost_cd cnt
            		from trs_trsp_scg_dtl s
           		where s.trsp_so_ofc_cty_cd = @[trsp_so_ofc_cty_cd]
             	  and s.trsp_so_seq = @[trsp_so_seq]
             	  and s.lgs_cost_cd = @[lgs_cost_cd]
				 group by s.trsp_so_ofc_cty_cd
						 ,s.trsp_so_seq
						 ,s.lgs_cost_cd
			     having SUM(nvl(s.scg_amt, 0)) = @[rcv_amt])) = 0
#else
MERGE INTO TRS_EDI_USA_RCV_MSG T
USING DUAL D
ON (
      T.TRSP_SO_OFC_CTY_CD = @[trsp_so_ofc_cty_cd] 
  AND T.TRSP_SO_SEQ = @[trsp_so_seq] 
  AND T.RCV_MSG_SEQ = @[rcv_msg_seq]
  AND T.LGS_COST_CD = @[lgs_cost_cd]
)
WHEN MATCHED THEN
  UPDATE SET 
	     T.RCV_AMT    = NVL(T.RCV_AMT, 0) + NVL(${rcv_amt}, 0)
		,T.OLD_RCV_AMT = NVL((SELECT SUM(NVL(O.SCG_AMT, 0)) FROM TRS_TRSP_SCG_DTL O WHERE TRSP_SO_OFC_CTY_CD = @[trsp_so_ofc_cty_cd] AND TRSP_SO_SEQ = @[trsp_so_seq] AND LGS_COST_CD = @[lgs_cost_cd]), 0)
        ,T.UPD_USR_ID = 'EDIUSER'
        ,T.UPD_DT     = SYSDATE
WHEN NOT MATCHED THEN
  INSERT (
     TRSP_SO_OFC_CTY_CD
    ,TRSP_SO_SEQ
    ,RCV_MSG_SEQ
    ,RCV_MSG_SUB_SEQ
    ,TRSP_WO_OFC_CTY_CD
    ,TRSP_WO_SEQ
    ,LGS_COST_CD
    ,CURR_CD
    ,RCV_AMT
    ,FUEL_RTO
    ,RCV_MSG_STS_CD
    ,CRE_USR_ID
    ,CRE_DT
    ,UPD_USR_ID
    ,UPD_DT
    ,RCV_MSG_TP_CD
    ,EDI_RJCT_RSN_CD
	,RCV_MSG
	,RCV_MSG_DESC
	,OLD_RCV_AMT
	,OLD_FUEL_RTO
	,OLD_RCV_MSG_DESC
) VALUES (
   @[trsp_so_ofc_cty_cd]
  ,@[trsp_so_seq]
  ,@[rcv_msg_seq]
  ,NVL((SELECT MAX(RCV_MSG_SUB_SEQ) + 1 FROM TRS_EDI_USA_RCV_MSG WHERE TRSP_SO_OFC_CTY_CD = @[trsp_so_ofc_cty_cd] AND TRSP_SO_SEQ = @[trsp_so_seq] AND RCV_MSG_SEQ = @[rcv_msg_seq]), 1)
  ,@[trsp_wo_ofc_cty_cd]
  ,@[trsp_wo_seq]
  ,@[lgs_cost_cd]
  ,@[curr_cd]
  ,@[rcv_amt]
  ,@[fuel_rto]
  ,@[rcv_msg_sts_cd]
  ,'EDIUSER'
  ,SYSDATE
  ,'EDIUSER'
  ,SYSDATE
  ,@[rcv_msg_tp_cd]
  ,@[edi_rjct_rsn_cd]
  ,@[rcv_msg]
  ,@[rcv_msg_desc]
  ,@[old_rcv_amt]
  ,@[old_fuel_rto]
  ,@[old_rcv_msg_desc]
)
#end			]]></sql>
			<params>
				<param name="trsp_so_ofc_cty_cd" type="12" value="" out="N"/>
				<param name="trsp_so_seq" type="12" value="" out="N"/>
				<param name="rcv_msg_seq" type="12" value="" out="N"/>
				<param name="trsp_wo_ofc_cty_cd" type="12" value="" out="N"/>
				<param name="trsp_wo_seq" type="12" value="" out="N"/>
				<param name="lgs_cost_cd" type="12" value="" out="N"/>
				<param name="curr_cd" type="12" value="" out="N"/>
				<param name="rcv_amt" type="12" value="" out="N"/>
				<param name="fuel_rto" type="12" value="" out="N"/>
				<param name="rcv_msg_sts_cd" type="12" value="" out="N"/>
				<param name="rcv_msg_tp_cd" type="12" value="" out="N"/>
				<param name="edi_rjct_rsn_cd" type="12" value="" out="N"/>
				<param name="rcv_msg" type="12" value="" out="N"/>
				<param name="rcv_msg_desc" type="12" value="" out="N"/>
				<param name="old_fuel_rto" type="12" value="" out="N"/>
				<param name="old_rcv_msg_desc" type="12" value="" out="N"/>
				<param name="old_rcv_amt" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
