<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CSMSendDBDAOAddFlatFileCSQL">
			<desc><![CDATA[AddFlatFile]]></desc>
			<sql><![CDATA[
INSERT 
INTO SCE_CNTR_STS_MSG_FLT_FILE ( 
EDI_SND_YRMONDY, 
EDI_SND_SEQ, 
EDI_SND_DESC, 
EDI_STS_CD, 
BL_NO, 
BKG_NO,
CRE_USR_ID,
CRE_DT, 
UPD_USR_ID, 
UPD_DT, 
ACT_RCV_DT, 
ACT_RCV_NO 
) 
( 
		select /*+ index_asc (SCE_CNTR_STS_MSG_TGT XPKSCE_CNTR_STS_MSG_TGT) */ 
		@[edi_snd_yrmondy],  --to_char(sysdate, 'yymmdd')
		@[edi_snd_seq],  --sce_cntr_sts_msg_flt_file_seq1.nextval
		
        --------------- edi message start -----------------------
        chr(34)||chr(34)||chr(44) --  Equipment Category
    
        ||chr(34)||substr(tgt.cntr_no,1,4)||chr(34)||chr(44) --Equipment Category,
    
        ||chr(34)||chr(34)||chr(44)  -- Equipment Number Prefix
    
        ||chr(34)||substr(tgt.cntr_no,5,6)||chr(34)||chr(44) --Equipment Number,Equipment Number Suffix
    
        ||chr(34)||substr(tgt.cntr_no,11,1)||chr(34)||chr(44)  --Equipment Check Digit
    
        ||chr(34)||decode(bkg.bkg_cgo_tp_cd,'F','L','E')||chr(34)||chr(44) --Equipment Status
    
        ||chr(34)||chr(34)||chr(44)  --Equipment Owner
    
        ||chr(34)||chr(34)||chr(44)  --Equipment Operator
    
        ||chr(34)||mcts.CNTR_TPSZ_ISO_CD||chr(34)||chr(44)
    
        ||chr(34)||STND_EDI_STS_CD||chr(34)||chr(44) -- Equipment Event Code
    
        ||chr(34)||TO_CHAR(TGT.ACT_DT, 'YYYYMMDD')||chr(34)||chr(44)  -- Equipment Size Type Code,Equipment Event Code,Equipment Event Date
    
        ||chr(34)||TO_CHAR(TGT.ACT_DT, 'HH24MISS')||chr(34)||chr(44) --Equipment Event Time
    
        ||chr(34)||'LT'||chr(34)||chr(44)  -- Equipment Event Time Zone
    
        ||chr(34)||DECODE(SUBSTR(tgt.nod_cd,1,5), BKG.por_cd, 'R', BKG.del_CD, 'E', BKG.POL_CD,'T', BKG.POD_CD, 'T','5')||chr(34)||chr(44) --Location Function Code
    
        ||chr(34)||'UN'||chr(34)||chr(44) --Equipment Event Location Code Qualifier
    
        ||chr(34)||(SELECT UN_LOC_CD FROM MDM_LOCATION WHERE LOC_CD = SUBSTR(TGT.NOD_CD,1,5))||chr(34)||chr(44) -- Equipment Event Location Code
    
        ||chr(34)||(SELECT YD_NM FROM MDM_YARD WHERE YD_CD = NOD_CD)||chr(34)||chr(44)     --Equipment Event Location Name 
    
        ||chr(34)||chr(34)||chr(44) -- Leave blank,
    
        ||chr(34)||(SELECT LOC_NM FROM MDM_LOCATION WHERE LOC_CD = SUBSTR(TGT.NOD_CD,1,5))||chr(34)||chr(44)  -- Equipment Event Location City Name
    
        ||chr(34)||(SELECT STE_CD FROM MDM_LOCATION WHERE LOC_CD = SUBSTR(TGT.NOD_CD,1,5)AND SUBSTR(TGT.NOD_CD,1,2) IN ('US','CA'))||chr(34)||chr(44) --  Equipment Event Location State Code,
    
        ||chr(34)||(SELECT STE_NM FROM MDM_STATE S, MDM_LOCATION L WHERE L.LOC_CD = SUBSTR(TGT.NOD_CD,1,5) AND S.STE_CD = L.STE_CD AND L.CNT_CD = S.CNT_CD AND S.DELT_FLG = 'N' AND SUBSTR(TGT.NOD_CD,1,2) IN ('US','CA'))||chr(34)||chr(44)    --  Equipment Event Location State Name,
    
        ||chr(34)||(SELECT ZIP_CD FROM MDM_YARD WHERE YD_CD = NOD_CD)||chr(34)||chr(44) --  Equipment Event Location Postal Code
    
        ||chr(34)||SUBSTR(tgt.nod_cd,1,2)||chr(34)||chr(44) -- Equipment Event Location Country Code
    
        ||chr(34)||(SELECT CNT_NM FROM MDM_COUNTRY C, MDM_LOCATION L WHERE L.LOC_CD = SUBSTR(TGT.NOD_CD,1,5) AND C.CNT_CD = L.CNT_CD)||chr(34)||chr(44) -- Equipment Event Location Country Name,  
    
        ||chr(34)||'BN'||chr(34)||chr(44)  -- Reference Number Qualifier
    
        ||chr(34)||bkg.bkg_no||chr(34)||chr(44) --Reference Number,
    
        ||chr(34)||nvl(decode(LLOYD_NO, 'T.B.N.', 'TBN', VSL.LLOYD_NO), ' ')||chr(34)||chr(44) --lloyd number
    
        ||chr(34)||'L'||chr(34)||chr(44)  --Reference Number,    Vessel Code,Vessel Code Qualifier
    
        ||chr(34)||REPLACE(vsl.VSL_ENG_NM, CHR(39), ' ')||chr(34)||chr(44)
    
        ||chr(34)||(SELECT CNT_NM FROM MDM_COUNTRY WHERE CNT_CD = VSL_RGST_CNT_CD)||chr(34)||chr(44)  --Vessel Name,Vessel Country of Registry
    
        ||chr(34)||tgt.vsl_cd||tgt.skd_voy_no||chr(34)||chr(44) 
    
        ||chr(34)||DECODE(tgt.skd_dir_cd, 'W', 'West', 'E', 'East', 'S', 'South', 'N','North', '')||chr(34)||chr(44)    --Voyage Number,Voyage Direction,
    
        ||chr(34)||chr(34)||chr(44)  --Vessel Owner Code
    
        ||chr(34)||(select DECODE(CRR_CD, 'OTH','', CRR_CD) FROM MDM_VSL_CNTR M WHERE M.VSL_CD = VSL.VSL_CD)||chr(34)||chr(44)   --Vessel Operator Code
    
        ||chr(34)||(select DECODE(CRR_CD, 'OTH','','NYKU') FROM MDM_VSL_CNTR M WHERE M.VSL_CD = VSL.VSL_CD)||chr(34)||chr(44)  --Vessel Carrier Code
    
        ||chr(34)||DECODE(SUBSTR(tgt.nod_cd,1,5), BKG.por_cd, 'R', BKG.del_CD, 'E', BKG.POL_CD,'T', BKG.POD_CD, 'T',bkg.PRE_RLY_PORT_CD, 'L', '5')||chr(34)||chr(44) --Location Function Code,  --Equipment Port Function Code
    
        ||chr(34)||'UN'||chr(34)||chr(44) --Equipment Port Location Code Qualifier,
    
        ||chr(34)||SUBSTR(tgt.nod_cd,1,5)||chr(34)||chr(44) -- Equipment Port Location Code
    
        ||chr(34)||(SELECT LOC_NM FROM MDM_LOCATION WHERE LOC_CD = SUBSTR(TGT.NOD_CD,1,5))||chr(34)||chr(44)  -- Equipment Port Location Name
    
        ||chr(34)||chr(34)||chr(44) -- Equipment Port Location City Code BLANK
    
        ||chr(34)||(SELECT LOC_NM FROM MDM_LOCATION WHERE LOC_CD = SUBSTR(TGT.NOD_CD,1,5))||chr(34)||chr(44)  -- Equipment Port Location City Name
    
        ||chr(34)||(SELECT STE_CD FROM MDM_LOCATION WHERE LOC_CD = SUBSTR(TGT.NOD_CD,1,5)AND SUBSTR(TGT.NOD_CD,1,2) IN ('US','CA'))||chr(34)||chr(44) --  Equipment Event Location State Code
    
        ||chr(34)||(SELECT STE_NM FROM MDM_STATE S, MDM_LOCATION L WHERE L.LOC_CD = SUBSTR(TGT.NOD_CD,1,5) AND S.STE_CD = L.STE_CD AND L.CNT_CD = S.CNT_CD AND S.DELT_FLG = 'N' AND SUBSTR(TGT.NOD_CD,1,2) IN ('US','CA'))||chr(34)||chr(44)     --  Equipment Event Location State Name
    
        ||chr(34)||yd.zip_cd||chr(34)||chr(44)
        ||chr(34)||substr(tgt.nod_cd,1,2)||chr(34)||chr(44)  -- Equipment Port Location State Name, Equipment Port Location Postal Code,Equipment Port Location Country Code 
    
        ||chr(34)||(SELECT REPLACE(CNT_NM, CHR(39), ' ') FROM MDM_COUNTRY WHERE  CNT_CD = substr(tgt.nod_cd,1,2))||chr(34)||chr(44)  --Equipment Port Location Country Name
    
        ||chr(34)||DECODE(STND_EDI_STS_CD, 'AE','ACA','UV','EDD','')||chr(34)||chr(44)
    
        ||chr(34)||DECODE(STND_EDI_STS_CD, 'AE',TO_CHAR(TGT.ACT_DT, 'YYYYMMDD'),'UV',TO_CHAR(TGT.ACT_DT, 'YYYYMMDD'),'')||chr(34)||chr(44) --Equipment Port Date Qualifier, event_date
    
        ||chr(34)||DECODE(STND_EDI_STS_CD, 'AE',TO_CHAR(TGT.ACT_DT, 'HH24MISS'),'UV',TO_CHAR(TGT.ACT_DT, 'HH24MISS'),'')||chr(34)||chr(44)
        ||chr(34)||'LT'||chr(34),   
   		--------------- edi message end -----------------------
		@[stnd_edi_sts_cd],  --mapg.stnd_edi_sts_cd
		bkg.bl_no, 
		bkg.bkg_no, 
		tgt.CRE_USR_ID, 
		sysdate, 
		tgt.UPD_USR_ID, 
		sysdate, 
		tgt.act_rcv_dt, 
		tgt.act_rcv_no 
		from ( 
				SELECT ACT_RCV_DT, 
				  ACT_RCV_NO, 
				  BKG_NO, 
				  CNTR_NO, 
				  ACT_DT, 
				  ACT_STS_MAPG_CD, 
				  NOD_CD, 
				  ACT_RCV_TP_CD, 
				  ACT_UMCH_TP_CD, 
				  UMCH_CHK_DT, 
				  VSL_CD, 
				  SKD_VOY_NO, 
				  SKD_DIR_CD, 
				  VPS_PORT_CD, 
				  CLPT_IND_SEQ, 
				  EDI_MSG_TP_CD, 
				  BND_VSKD_SEQ_CD, 
				  COP_EVNT_SEQ, 
				  ACT_DAT_RCV_DT, 
				  RAIL_DEST_N1ST_ETA_DT, 
				  CNTR_CGO_TP_CD, 
				  CNMV_CO_CD, 
				  CRE_USR_ID, 
				  CRE_DT, 
				  UPD_USR_ID, 
				  UPD_DT ,
  				  @[stnd_edi_sts_cd] STND_EDI_STS_CD
				FROM SCE_CNTR_STS_MSG_TGT
		    	WHERE   1 = 1 
#if (${is_multi_rows} != 'T') 
					AND ACT_RCV_DT = @[act_rcv_dt] AND ACT_RCV_NO = @[act_rcv_no]
#end					
		      		AND ACT_UMCH_TP_CD = 'XX' 
			 		AND ROWNUM = 1
		  ) TGT, 
		  bkg_booking bkg,
		  BKG_BL_DOC bkgd,
		  BKG_CUSTOMER bkgc, 
		  BKG_CONTAINER cntr, 
		  BKG_CNTR_SEAL_NO cntrs, 
		  --TRS_TRSP_SO_PKUP_CNTR trs, 
		  ( 
		    select bkg_no, 
		      max(decode(port_id_cd, 'POL', eta_lmt, '')) as pol_eta_lmt, 
		      max(decode(port_id_cd, 'POL', eta_gmt, '')) as pol_eta_gmt, 
		      max(decode(port_id_cd, 'POL', etd_lmt, '')) as pol_etd_lmt, 
		      max(decode(port_id_cd, 'POL', etd_gmt, '')) as pol_etd_gmt, 
		      max(decode(port_id_cd, 'POD', eta_lmt, '')) as pod_eta_lmt, 
		      max(decode(port_id_cd, 'POD', eta_gmt, '')) as pod_eta_gmt, 
		      max(decode(port_id_cd, 'POD', etd_lmt, '')) as pod_etd_lmt, 
		      max(decode(port_id_cd, 'POD', etd_gmt, '')) as pod_etd_gmt 
		    from ( 
		        select bkg.bkg_no, 
		          bkg.pol_cd as port_cd, 
		          'POL' as port_id_cd, 
		          TO_CHAR(vsk.VPS_ETA_DT, 'YYYYMMDDHH24MI') as ETA_LMT, 
		          TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC(vsk.VPS_PORT_CD, vsk.VPS_ETA_DT, 'GMT'), 'YYYYMMDDHH24MI') AS ETA_GMT, 
		          TO_CHAR(vsk.VPS_ETD_DT, 'YYYYMMDDHH24MI') AS ETD_LMT, 
		          TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC(vsk.VPS_PORT_CD, vsk.VPS_ETD_DT, 'GMT'), 'YYYYMMDDHH24MI') AS ETD_GMT 
		        from bkg_booking bkg, 
		          BKG_CUSTOMER bkgc,
		          sce_cntr_sts_msg_tgt tgt, 
		          BKG_VVD vvd, 
		          vsk_vsl_port_skd vsk 
		        where 
		        
#if (${is_multi_rows} != 'T') 
					ACT_RCV_DT = @[act_rcv_dt] AND ACT_RCV_NO = @[act_rcv_no] AND		
#end		
						
		      		act_umch_tp_cd = 'XX' 
		          and bkg.bkg_no = tgt.bkg_no 
		          and bkg.bkg_no = vvd.bkg_no 
		          AND BKGC.BKG_NO = BKG.BKG_NO
		          AND BKGC.BKG_CUST_TP_CD = 'C'
		          and vvd.vsl_cd = vsk.vsl_cd (+) 
		          and vvd.skd_voy_no = vsk.skd_voy_no (+) 
		          and vvd.skd_dir_cd = vsk.skd_dir_cd (+) 
		          and vvd.pod_cd = vsk.vps_port_cd (+) 
		          and bkg.pol_cd = vvd.pod_cd 
		        union all 
		        select bkg.bkg_no, 
		          bkg.pod_cd as port_cd, 
		          'POD' as port_ind_cd, 
		          TO_CHAR(vsk.VPS_ETA_DT, 'YYYYMMDDHH24MI') as ETA_LMT, 
		          TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC(vsk.VPS_PORT_CD, vsk.VPS_ETA_DT, 'GMT'), 'YYYYMMDDHH24MI') AS eta_gmt, 
		          TO_CHAR(vsk.VPS_ETD_DT, 'YYYYMMDDHH24MI') AS ETD_LMT, 
		          TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC(vsk.VPS_PORT_CD, vsk.VPS_ETD_DT, 'GMT'), 'YYYYMMDDHH24MI') AS etd_gmt 
		        from bkg_booking bkg, 
		          BKG_CUSTOMER bkgc,
		          sce_cntr_sts_msg_tgt tgt, 
		          BKG_VVD vvd, 
		          vsk_vsl_port_skd vsk 
		    	 where 
		    	 
#if (${is_multi_rows} != 'T') 
					ACT_RCV_DT = @[act_rcv_dt] AND ACT_RCV_NO = @[act_rcv_no] AND		
#end	
					
		      	   act_umch_tp_cd = 'XX' 
		          and bkg.bkg_no = tgt.bkg_no 
		          and bkg.bkg_no = vvd.bkg_no 
		          AND BKGC.BKG_NO = BKG.BKG_NO
		          AND BKGC.BKG_CUST_TP_CD = 'C'		          
		          and vvd.vsl_cd = vsk.vsl_cd (+) 
		          and vvd.skd_voy_no = vsk.skd_voy_no (+) 
		          and vvd.skd_dir_cd = vsk.skd_dir_cd (+) 
		          and vvd.pod_cd = vsk.vps_port_cd (+) 
		          and bkg.pod_cd = vvd.pod_cd ) 
		    group by bkg_no ) dinfo, 
		  mdm_location por, 
		  mdm_location pol, 
		  mdm_location pod, 
		  mdm_location del, 
		  mdm_location rly, 
		  mdm_yard yd, 
		  mdm_location yd_rl, 
		  mdm_vsl_cntr vsl,
          MDM_CNTR_TP_SZ mcts 
		where tgt.bkg_no = bkg.bkg_no 
		  and tgt.bkg_no = cntr.bkg_no 
		  and tgt.cntr_no = cntr.cntr_no 
		  and cntr.bkg_no = cntrs.bkg_no(+)
		  and cntr.cntr_no = cntrs.cntr_no(+)
		  and cntrs.cntr_seal_seq(+) = 1
		  and bkgd.bkg_no = bkg.bkg_no
		  and bkgc.bkg_no = bkg.bkg_no
		  and bkgc.bkg_cust_tp_cd = 'C'
		  --and tgt.cntr_no = trs.cntr_no (+) 
		  --and tgt.bkg_no = trs.bkg_no (+) 
		  and tgt.bkg_no = dinfo.bkg_no 
		  and bkg.por_cd = por.loc_cd (+) 
		  and bkg.pol_cd = pol.loc_cd (+) 
		  and bkg.pod_cd = pod.loc_cd (+) 
		  and bkg.del_cd = del.loc_cd (+) 
		  and tgt.nod_cd = yd.yd_cd (+) 
		  and bkg.PRE_RLY_PORT_CD = rly.loc_cd (+) 
		  and yd.loc_cd = yd_rl.loc_cd 
		  and vsl.vsl_cd (+) = tgt.vsl_cd 
          and cntr.cntr_tpsz_cd = mcts.cntr_tpsz_cd(+)  
)			]]></sql>
			<params>
				<param name="edi_snd_yrmondy" type="12" value="" out="N"/>
				<param name="edi_snd_seq" type="12" value="" out="N"/>
				<param name="stnd_edi_sts_cd" type="12" value="" out="N"/>
				<param name="act_rcv_dt" type="12" value="" out="N"/>
				<param name="act_rcv_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
