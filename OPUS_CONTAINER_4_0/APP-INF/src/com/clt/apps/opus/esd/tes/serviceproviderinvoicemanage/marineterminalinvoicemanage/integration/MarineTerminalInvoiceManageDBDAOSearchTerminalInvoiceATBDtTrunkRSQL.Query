<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="MarineTerminalInvoiceManageDBDAOSearchTerminalInvoiceATBDtTrunkRSQL">
			<desc><![CDATA[SearchTerminalInvoiceATBDtTrunk
2016.07.13 VVD, YD_CD가 존재 하지 않을시에 YD_CD의 국가에 걸린 VVD의 ATB 조회 추가.]]></desc>
			<sql><![CDATA[
SELECT ATB_DT
  FROM (SELECT RNK_TP_CD
             , ATB_DT
          FROM (SELECT 1 AS RNK_TP_CD /*1순위 : 선택된 YD와 VVD의 ATB */
                     , LISTAGG (ATB_DT, '#') WITHIN GROUP (ORDER BY ATB_DT) AS ATB_DT
                  FROM (SELECT (SELECT DECODE(L.VSL_SVC_TP_CD,'O',DECODE((SELECT M.CRR_CD FROM MDM_VSL_CNTR M WHERE M.VSL_CD=S.VSL_CD),'TSG','H','C'),'H')
                                  FROM VSK_VSL_SKD S
                                     , MDM_VSL_SVC_LANE L
                                 WHERE S.VSL_CD         = SUBSTR(@[vvd],1,4)
                                   AND S.SKD_VOY_NO     = SUBSTR(@[vvd],5,4)
                                   AND S.SKD_DIR_CD     = SUBSTR(@[vvd],9,1)
                                   AND S.VSL_SLAN_CD    = L.VSL_SLAN_CD(+) 
                                )||'|' ||TO_CHAR(V.VPS_ETB_DT,'YYYY-MM-DD')||'|'||A.REV_YRMON ||'|'||V.CALL_YD_IND_SEQ AS ATB_DT
                                --||TO_CHAR(NVL(V.ACT_BRTH_DT,V.VPS_ETB_DT),'YYYY-MM-DD')||'|'||A.REV_YRMON ATB_DT 
                             , ROWNUM ROW_ID
                          FROM VSK_VSL_PORT_SKD V
                             , AR_MST_REV_VVD A
                         WHERE V.VSL_CD         = SUBSTR(@[vvd],1,4)
                           AND V.SKD_VOY_NO     = SUBSTR(@[vvd],5,4)
                           AND V.SKD_DIR_CD     = SUBSTR(@[vvd],9,1)
                           --AND V.VPS_PORT_CD    = SUBSTR([yd_cd],1,5)
                           AND V.YD_CD          = @[yd_cd]
                           AND V.VSL_CD         = A.VSL_CD(+)
                           AND V.SKD_VOY_NO     = A.SKD_VOY_NO(+)
                           AND V.SKD_DIR_CD     = A.SKD_DIR_CD(+)
                         ORDER BY V.CLPT_IND_SEQ 
                       )
                 UNION ALL
                SELECT 2 AS RNK_TP_CD /*2순위 : 선택된 YD와 VVD의 ATB + YD의 국가에 속한 VVD의 ATB*/
                     , LISTAGG (ATB_DT, '#') WITHIN GROUP ( ORDER BY ATB_DT) AS ATB_DT
                  FROM (SELECT (SELECT DECODE(L.VSL_SVC_TP_CD,'O',DECODE((SELECT M.CRR_CD FROM MDM_VSL_CNTR M WHERE M.VSL_CD=S.VSL_CD),'TSG','H','C'),'H')
                                  FROM VSK_VSL_SKD S
                                     , MDM_VSL_SVC_LANE L
                                 WHERE S.VSL_CD         = SUBSTR(@[vvd],1,4)
                                   AND S.SKD_VOY_NO     = SUBSTR(@[vvd],5,4)
                                   AND S.SKD_DIR_CD     = SUBSTR(@[vvd],9,1)
                                   AND S.VSL_SLAN_CD    = L.VSL_SLAN_CD(+) 
                                )||'|' ||TO_CHAR(V.VPS_ETB_DT,'YYYY-MM-DD')||'|'||A.REV_YRMON ||'|'||V.CALL_YD_IND_SEQ AS ATB_DT
                                 --||TO_CHAR(NVL(V.ACT_BRTH_DT,V.VPS_ETB_DT),'YYYY-MM-DD')||'|'||A.REV_YRMON ATB_DT 
                             , ROWNUM ROW_ID
                          FROM VSK_VSL_PORT_SKD V
                             , AR_MST_REV_VVD A
                         WHERE V.VSL_CD         = SUBSTR(@[vvd],1,4)
                           AND V.SKD_VOY_NO     = SUBSTR(@[vvd],5,4)
                           AND V.SKD_DIR_CD     = SUBSTR(@[vvd],9,1)
                           AND (V.VPS_PORT_CD   = SUBSTR(@[yd_cd],1,5) OR SUBSTR(V.VPS_PORT_CD,1,2) = SUBSTR(@[yd_cd],1,2)) /*2016.07.13 존재 하지 않을시 국가에 걸린 VVD의 ATB 조회*/
                           AND V.VSL_CD         = A.VSL_CD(+)
                           AND V.SKD_VOY_NO     = A.SKD_VOY_NO(+)
                           AND V.SKD_DIR_CD     = A.SKD_DIR_CD(+)
                         ORDER BY V.CLPT_IND_SEQ 
                      ) 
               )
         WHERE 1=1
           AND ATB_DT IS NOT NULL 
         ORDER BY RNK_TP_CD /*2016.07.20 RNK_TP_CD 1 > 2 순으로 하기 위해 Ordering*/  
       )
 WHERE 1=1
   AND ROWNUM = 1 /*첫번째의 데이타를 기준으로 한다.*/			]]></sql>
			<params>
				<param name="vvd" type="12" value="" out="N"/>
				<param name="yd_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
