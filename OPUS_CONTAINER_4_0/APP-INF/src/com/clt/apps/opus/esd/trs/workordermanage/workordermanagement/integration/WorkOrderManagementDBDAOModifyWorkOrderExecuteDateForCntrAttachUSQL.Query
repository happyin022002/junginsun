<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="WorkOrderManagementDBDAOModifyWorkOrderExecuteDateForCntrAttachUSQL">
			<desc><![CDATA[WorkOrderManagementDBDAOModifyWorkOrderExecuteDateForCntrAttach]]></desc>
			<sql><![CDATA[
MERGE INTO TRS_TRSP_SVC_ORD SO
  USING (SELECT /*+ INDEX_DESC(S XPKCTM_MOVEMENT) */
          S.MVMT_STS_CD, S.ORG_YD_CD, S.BKG_NO, TO_CHAR(S.CNMV_EVNT_DT, 'YYYYMMDDHH24MI') CNMV_EVNT_DT, S.WO_NO, S.CNTR_NO
           FROM CTM_MOVEMENT S
          WHERE CNTR_NO = NVL(@[cntr_no], (select eq_no from trs_trsp_svc_ord where trsp_so_ofc_cty_cd = @[trsp_so_ofc_cty_cd] and trsp_so_seq = @[trsp_so_seq]))
            AND BKG_NO = @[bkg_no]
            AND NVL(S.MVMT_CRE_TP_CD, 'X') NOT IN ('C', 'A')
            AND ROWNUM = 1) MV
  ON (		SO.TRSP_SO_OFC_CTY_CD = @[trsp_so_ofc_cty_cd] 
		AND SO.TRSP_SO_SEQ = @[trsp_so_seq]
		AND SO.BKG_NO = MV.BKG_NO 
		AND SO.EQ_NO = MV.CNTR_NO 
		AND DELT_FLG = 'N'
	 )
  WHEN MATCHED THEN
    UPDATE
       SET SO.WO_EXE_DT      = 
           (CASE 	WHEN NVL(SO.TRS_SUB_STS_CD, 'XX') = 'CM' THEN SO.WO_EXE_DT
					WHEN SO.TRSP_SO_TP_CD = 'Y' AND SO.TRSP_COST_DTL_MOD_CD <> 'DR' AND MV.ORG_YD_CD = SO.FM_NOD_CD AND MV.MVMT_STS_CD IN ('EN', 'TN', 'OP', 'ID') THEN TO_DATE(MV.CNMV_EVNT_DT, 'YYYYMMDDHH24MI')
             		ELSE SO.WO_EXE_DT
           END)
          ,SO.ORG_GATE_OUT_DT =
           (CASE    WHEN NVL(SO.TRS_SUB_STS_CD, 'XX') = 'CM' THEN SO.ORG_GATE_OUT_DT
					WHEN MV.MVMT_STS_CD IN ('EN', 'TN', 'OP', 'ID') AND MV.ORG_YD_CD = SO.FM_NOD_CD THEN TO_DATE(MV.CNMV_EVNT_DT, 'YYYYMMDDHH24MI')
             		ELSE SO.ORG_GATE_OUT_DT
           END)
          ,SO.DEST_GATE_IN_DT =
           (CASE    WHEN NVL(SO.TRS_SUB_STS_CD, 'XX') = 'CM' THEN SO.DEST_GATE_IN_DT
					WHEN MV.MVMT_STS_CD IN ('OC', 'IC', 'MT') AND MV.ORG_YD_CD = SO.TO_NOD_CD THEN	TO_DATE(MV.CNMV_EVNT_DT, 'YYYYMMDDHH24MI')
             		ELSE SO.DEST_GATE_IN_DT
           END)
          ,SO.TRS_SUB_STS_CD =
           (CASE	WHEN NVL(SO.TRS_SUB_STS_CD, 'XX') = 'CM' THEN SO.TRS_SUB_STS_CD
					WHEN MV.MVMT_STS_CD IN ('EN', 'TN', 'OP', 'ID') AND MV.ORG_YD_CD = SO.FM_NOD_CD THEN	'ST'
             		WHEN MV.MVMT_STS_CD IN ('OC', 'IC', 'MT') AND MV.ORG_YD_CD = SO.TO_NOD_CD THEN	'CM'
             		ELSE SO.TRS_SUB_STS_CD
           END)
           ,SO.UPD_USR_ID = @[upd_usr_id]
		   ,SO.LOCL_UPD_DT = GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC(SO.CRE_OFC_CD)	
		   ,SO.UPD_DT = SYSDATE			]]></sql>
			<params>
				<param name="cntr_no" type="12" value="" out="N"/>
				<param name="trsp_so_ofc_cty_cd" type="12" value="" out="N"/>
				<param name="trsp_so_seq" type="12" value="" out="N"/>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="upd_usr_id" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
