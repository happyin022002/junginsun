<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="PrdCreateManageDBDAOUpdateCmlTztmHrsUSQL">
			<desc><![CDATA[pdateCmlTztmHrs]]></desc>
			<sql><![CDATA[
UPDATE    PRD_PROD_CTL_MST      X
SET       X.CML_OCN_TZTM_HRS    = (
                                    (SELECT  MAX(D.DEP_FSH_DT)
                                     FROM    PRD_PROD_CTL_ROUT_DTL  D
                                     WHERE   D.PCTL_NO              = X.PCTL_NO
                                     AND     D.PCTL_IO_BND_CD       = 'T'
                                    )
                                    -
                                    (SELECT  MIN(D.ARR_ST_DT)
                                     FROM    PRD_PROD_CTL_ROUT_DTL  D
                                     WHERE   D.PCTL_NO              = X.PCTL_NO
                                     AND     D.PCTL_IO_BND_CD       = 'T'
                                    )
                                  )*24

      ,   X.CML_INLND_TZTM_HRS  = (
									-- ::O/B Transit Time:: --
                                    (SELECT  MIN(D.ARR_ST_DT)
                                     FROM    PRD_PROD_CTL_ROUT_DTL  D
                                     WHERE   D.PCTL_NO              = X.PCTL_NO
                                     AND     D.PCTL_IO_BND_CD       = 'T'
                                    )
                                    -
                                    CASE WHEN X.BKG_RCV_TERM_CD = 'Y' AND X.POR_CD = X.POL_CD THEN	/* ONLY FOR O/B PORT TRANSPORTATION :GAP:PCT&Terminal.Gate-In */
                                        (SELECT  MIN(D.ARR_ST_DT)
                                         FROM    PRD_PROD_CTL_ROUT_DTL  D
                                         WHERE   D.PCTL_NO              = X.PCTL_NO
                                         AND     D.PCTL_IO_BND_CD       = 'O'
                                         AND     D.MTY_YD_FLG           = 'N'
                                         AND     D.PCTL_SEQ             > (SELECT   MIN(DD.PCTL_SEQ)
                                                                           FROM     PRD_PROD_CTL_ROUT_DTL DD
                                                                           WHERE    DD.PCTL_NO            = D.PCTL_NO
                                                                           AND      DD.PCTL_IO_BND_CD     = D.PCTL_IO_BND_CD
                                                                           AND      DD.NOD_LNK_DIV_CD     = 'L'
                                                                           )
                                        )
										WHEN X.BKG_RCV_TERM_CD = 'Y' AND X.POR_CD <> X.POL_CD THEN	/* ONLY FOR Except O/B PORT TRANSPORTATION */
                                        (SELECT  MIN(D.DEP_FSH_DT)
                                         FROM    PRD_PROD_CTL_ROUT_DTL  D
                                         WHERE   D.PCTL_NO              = X.PCTL_NO
                                         AND     D.PCTL_IO_BND_CD       = 'O'
                                         AND     D.MTY_YD_FLG           = 'N'
                                         AND     D.PCTL_SEQ             > (SELECT   MIN(DD.PCTL_SEQ)
                                                                           FROM     PRD_PROD_CTL_ROUT_DTL DD
                                                                           WHERE    DD.PCTL_NO            = D.PCTL_NO
                                                                           AND      DD.PCTL_IO_BND_CD     = D.PCTL_IO_BND_CD
                                                                           AND      DD.NOD_LNK_DIV_CD     = 'L'
                                                                           )
                                        )
                                         WHEN X.BKG_RCV_TERM_CD = 'D' THEN
                                        (SELECT  MIN(D.DEP_FSH_DT)
                                         FROM    PRD_PROD_CTL_ROUT_DTL  D
                                         WHERE   D.PCTL_NO              = X.PCTL_NO
                                         AND     D.PCTL_IO_BND_CD       = 'O'
                                         AND     D.MTY_YD_FLG           = 'N'
                                         AND     D.PCTL_SEQ             > (SELECT   MIN(DD.PCTL_SEQ)
                                                                           FROM     PRD_PROD_CTL_ROUT_DTL DD
                                                                           WHERE    DD.PCTL_NO            = D.PCTL_NO
                                                                           AND      DD.PCTL_IO_BND_CD     = D.PCTL_IO_BND_CD
                                                                           AND      DD.NOD_LNK_DIV_CD     = 'L'
                                                                           )
                                        )
                                         WHEN X.BKG_RCV_TERM_CD = 'S' THEN
                                        (SELECT  MIN(D.ARR_ST_DT)
                                     	 FROM    PRD_PROD_CTL_ROUT_DTL  D
                                     	 WHERE   D.PCTL_NO              = X.PCTL_NO
                                     	 AND     D.PCTL_IO_BND_CD       = 'T'
                                    	) 
										ELSE
                                        (SELECT  MIN(D.ARR_ST_DT)
                                         FROM    PRD_PROD_CTL_ROUT_DTL  D
                                         WHERE   D.PCTL_NO              = X.PCTL_NO
                                         AND     D.PCTL_IO_BND_CD       = 'O'
                                         AND     D.MTY_YD_FLG           = 'N'
                                         AND     D.PCTL_SEQ             > (SELECT   MIN(DD.PCTL_SEQ)
                                                                           FROM     PRD_PROD_CTL_ROUT_DTL DD
                                                                           WHERE    DD.PCTL_NO            = D.PCTL_NO
                                                                           AND      DD.PCTL_IO_BND_CD     = D.PCTL_IO_BND_CD
                                                                           AND      DD.NOD_LNK_DIV_CD     = 'L'
                                                                           )
                                        )                                         
                                    END
                                  )*24
                                  +
                                  (
									-- ::I/B Transit Time:: --
                                    CASE WHEN X.BKG_DE_TERM_CD = 'Y' THEN
                                        (SELECT  MAX(D.ARR_ST_DT)
                                         FROM    PRD_PROD_CTL_ROUT_DTL  D
                                         WHERE   D.PCTL_NO              = X.PCTL_NO
                                         AND     D.PCTL_IO_BND_CD       = 'I'
                                         AND     D.MTY_YD_FLG           = 'N'
                                         AND     D.PCTL_SEQ             < (SELECT   MAX(DD.PCTL_SEQ)
                                                                           FROM     PRD_PROD_CTL_ROUT_DTL DD
                                                                           WHERE    DD.PCTL_NO            = D.PCTL_NO
                                                                           AND      DD.PCTL_IO_BND_CD     = D.PCTL_IO_BND_CD
                                                                           AND      DD.NOD_LNK_DIV_CD     = 'L'
                                                                           )
                                        )
                                         WHEN X.BKG_DE_TERM_CD = 'D' THEN
                                        (SELECT  MAX(D.ARR_ST_DT)
                                         FROM    PRD_PROD_CTL_ROUT_DTL  D
                                         WHERE   D.PCTL_NO              = X.PCTL_NO
                                         AND     D.PCTL_IO_BND_CD       = 'I'
                                         AND     D.MTY_YD_FLG           = 'N'
                                         AND     D.PCTL_SEQ             < (SELECT   MAX(DD.PCTL_SEQ)
                                                                           FROM     PRD_PROD_CTL_ROUT_DTL DD
                                                                           WHERE    DD.PCTL_NO            = D.PCTL_NO
                                                                           AND      DD.PCTL_IO_BND_CD     = D.PCTL_IO_BND_CD
                                                                           AND      DD.NOD_LNK_DIV_CD     = 'L'
                                                                           )
                                        )  
                                         WHEN X.BKG_DE_TERM_CD = 'S' THEN
                                    	(SELECT  MAX(D.DEP_FSH_DT)
                                     	 FROM    PRD_PROD_CTL_ROUT_DTL  D
                                     	 WHERE   D.PCTL_NO              = X.PCTL_NO
                                     	 AND     D.PCTL_IO_BND_CD       = 'T'
                                    	)
										ELSE
                                        (SELECT  MAX(D.ARR_ST_DT)
                                         FROM    PRD_PROD_CTL_ROUT_DTL  D
                                         WHERE   D.PCTL_NO              = X.PCTL_NO
                                         AND     D.PCTL_IO_BND_CD       = 'I'
                                         AND     D.MTY_YD_FLG           = 'N'
                                         AND     D.PCTL_SEQ             < (SELECT   MAX(DD.PCTL_SEQ)
                                                                           FROM     PRD_PROD_CTL_ROUT_DTL DD
                                                                           WHERE    DD.PCTL_NO            = D.PCTL_NO
                                                                           AND      DD.PCTL_IO_BND_CD     = D.PCTL_IO_BND_CD
                                                                           AND      DD.NOD_LNK_DIV_CD     = 'L'
                                                                           )
                                        )
                                         
                                    END
                                    -
                                    (SELECT  MAX(D.DEP_FSH_DT)
                                     FROM    PRD_PROD_CTL_ROUT_DTL  D
                                     WHERE   D.PCTL_NO              = X.PCTL_NO
                                     AND     D.PCTL_IO_BND_CD       = 'T'
                                    )
                                  )*24 

WHERE     X.PCTL_NO             LIKE @[hd_pctl_no]||'%'     


----UPDATE PRD_PROD_CTL_MST X
----   SET CML_OCN_TZTM_HRS   = NVL(((SELECT MAX(NVL(V.VPS_ETA_DT, D.DEP_FSH_DT))
----                                    FROM PRD_PROD_CTL_ROUT_DTL D
----                                        ,VSK_VSL_PORT_SKD      V
----                                   WHERE D.PCTL_NO = X.PCTL_NO
----                                     AND D.PCTL_SEQ = (SELECT MAX(D2.PCTL_SEQ) FROM PRD_PROD_CTL_ROUT_DTL D2 WHERE D2.PCTL_NO = X.PCTL_NO AND D2.PCTL_IO_BND_CD = 'T')
----                                     AND V.VSL_CD(+) = D.VSL_CD
----                                     AND V.SKD_VOY_NO(+) = D.SKD_VOY_NO
----                                     AND V.SKD_DIR_CD(+) = D.SKD_DIR_CD
----                                     AND V.YD_CD(+) = D.DEST_NOD_CD
----                                     AND V.CLPT_IND_SEQ(+) = D.DEST_CLPT_IND_SEQ
----                                     AND V.SLAN_CD(+) = D.VSL_SLAN_CD
----                                     AND V.VPS_PORT_CD(+) = SUBSTR(D.DEST_NOD_CD, 1, 5)) -
----                                (SELECT MIN(NVL(V.VPS_ETD_DT, D.ARR_ST_DT))
----                                    FROM PRD_PROD_CTL_ROUT_DTL D
----                                        ,VSK_VSL_PORT_SKD      V
----                                   WHERE D.PCTL_NO = X.PCTL_NO
----                                     AND D.PCTL_SEQ = (SELECT MIN(D2.PCTL_SEQ) FROM PRD_PROD_CTL_ROUT_DTL D2 WHERE D2.PCTL_NO = X.PCTL_NO AND D2.PCTL_IO_BND_CD = 'T')
----                                     AND V.VSL_CD(+) = D.VSL_CD
----                                     AND V.SKD_VOY_NO(+) = D.SKD_VOY_NO
----                                     AND V.SKD_DIR_CD(+) = D.SKD_DIR_CD
----                                     AND V.YD_CD(+) = D.ORG_NOD_CD
----                                     AND V.CLPT_IND_SEQ(+) = D.ORG_CLPT_IND_SEQ
----                                     AND V.SLAN_CD(+) = D.VSL_SLAN_CD
----                                     AND V.VPS_PORT_CD(+) = SUBSTR(D.ORG_NOD_CD, 1, 5))),
----                                0) * 24,
----       CML_INLND_TZTM_HRS =
----       NVL((SELECT NVL(SUM(TZTM), 0) + 24
----          FROM (SELECT A.PCTL_NO
----                      ,NVL(CASE WHEN MAX(K.POR_CD) = MAX(K.POL_CD) THEN 0
----                                ELSE SUM(NVL(TZ_DWLL_TM_HRS, 0)) + SUM(NVL(Y.DRY_AVG_DWLL_HRS, 0))
----                           END, 0) TZTM
----                  FROM PRD_PROD_CTL_ROUT_DTL A
----                      ,MDM_YARD              Y
----                      ,PRD_PROD_CTL_MST      K
----                 WHERE A.PCTL_IO_BND_CD IN ('O')
----                   AND A.NOD_LNK_DIV_CD = 'L'
----                   AND A.DEST_NOD_CD = Y.YD_CD(+)
----                   AND A.DEST_NOD_TP_CD <> 'Z'
----                   AND A.PCTL_NO = K.PCTL_NO
----                 GROUP BY A.PCTL_NO
----                UNION ALL
----                SELECT A.PCTL_NO
----                      ,NVL(CASE WHEN MAX(K.POD_CD) = MAX(K.DEL_CD) THEN 0
----                            	ELSE SUM(NVL(TZ_DWLL_TM_HRS, 0)) + SUM(NVL(Y.DRY_AVG_DWLL_HRS, 0))
----                       	   END, 0) TZTM
----                  FROM PRD_PROD_CTL_ROUT_DTL A
----                      ,MDM_YARD              Y
----                      ,PRD_PROD_CTL_MST      K
----                 WHERE A.PCTL_IO_BND_CD IN ('I')
----                   AND A.NOD_LNK_DIV_CD = 'L'
----                   AND A.DEST_NOD_CD = Y.YD_CD(+)
----                   AND A.ORG_NOD_TP_CD <> 'Z'
----				   AND A.PCTL_SEQ NOT IN (DECODE(K.BKG_RCV_TERM_CD, 'D', 2, 0), (SELECT MAX(PCTL_SEQ) - 1 FROM PRD_PROD_CTL_ROUT_DTL WHERE PCTL_NO = K.PCTL_NO))	
----                   AND A.PCTL_NO = K.PCTL_NO
----                 GROUP BY A.PCTL_NO) IO
----         WHERE IO.PCTL_NO = X.PCTL_NO), 0)
---- WHERE PCTL_NO LIKE [hd_pctl_no] || '%'			]]></sql>
			<params>
				<param name="hd_pctl_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
