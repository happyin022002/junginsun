<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ExceptionReportDBDAOSearchNotifyFailureCountRSQL">
			<desc><![CDATA[Exception Noti Failure Report]]></desc>
			<sql><![CDATA[
SELECT  COUNT(1) OVER(PARTITION BY '1') AS TOT_CNT,t2.* 
-- vo columns  
,'' fail_fm_dt,'' fail_to_dt,'' occur_fm_dt,'' occur_to_dt
,'' cust_cnt_seq,'' sc_no,'' bkg_fm_dt,'' bkg_to_dt
FROM   ( 
SELECT  /*+ FIRST_ROWS */ t1.* 
        
 FROM  ( 
 select 
      mst.cop_expt_no expt_no, 

      mst.bkg_no bkg_no, 
      mst.mst_bl_no bl_no,
      mst.cop_no cop_no, 
      mst.cntr_no cntr_no, 
      etp.cop_expt_tp_nm i_expt_type, 
      etp.cop_expt_tp_dtl_nm i_exptdtl_type, 
      mst.shpr_cnt_cd||mst.shpr_seq shipper, 
      mst.cnee_cnt_cd||mst.cnee_seq consignee, 
      mst.ntfy_cnt_cd||mst.ntfy_seq notify, 
      mst.trnk_vvd_cd vvd, 
      mst.por_cd , 
      mst.pol_cd , 
      mst.pod_cd , 
      mst.del_cd , 
      to_char(mst.occr_dt,'yyyy-mm-dd hh24:mi') occur_dt, 
      --mst.cre_ofc_cd occur_ofc, 
	  mst.cre_ofc_cd ,
      mst.occr_nod_cd , 
      SUBSTR(TO_CHAR(NUMTODSINTERVAL(TO_NUMBER(CASE WHEN mst.COP_EXPT_TP_CD = '1' THEN (CASE WHEN mst.TO_ACT_DT IS NULL 
              THEN (GLOBALDATE_PKG.TIME_CONV_FNC(COM_ConstantMgr_PKG.COM_getBaseLocationCode_FNC(), SYSDATE, SUBSTR(mst.OCCR_NOD_CD,1,5))-mst.FM_ESTM_DT) 
              ELSE (mst.TO_ACT_DT-mst.FM_ACT_DT) END) 
              WHEN mst.COP_EXPT_TP_CD = '2' THEN (mst.TO_ESTM_DT-mst.FM_ESTM_DT) END),'DAY')+NUMTODSINTERVAL(30,'MINUTE'),'DD HH24:MI'), 8, 12)  delay_dt, 
      '' logi_gid, 
      '' logi_mail, 
      '' cust_gid, 
      '' cust_mail, 
      '' urt_gid, 
      '' urt_mail, 
      mst.fm_act_cd f_act, 
      to_char(mst.fm_act_dt,'yyyy-mm-dd hh24:mi') f_actdt, 
      mst.to_act_cd t_act, 
      to_char(mst.to_act_dt,'yyyy-mm-dd hh24:mi') t_actdt 
      ,fa.act_nm fm_act_nm 
      ,ta.act_nm to_act_nm 
 from sce_expt_mst mst, bkg_booking bkg,  mdm_activity fa, mdm_activity ta, sce_expt_subsc_mst subscmst, 
	     (SELECT SUBSTR(EXPT_CD,1,1) COP_EXPT_TP_CD, SUBSTR(EXPT_CD,1,3) COP_EXPT_TP_DTL_CD 
		        ,MAX(DTL.EXPT_CD_NM) COP_EXPT_TP_DTL_NM, MAX(TP.EXPT_CD_NM) COP_EXPT_TP_NM 
		  FROM (SELECT SUBSTR(EXPT_CD,1,1) EXPT_TP, EXPT_CD_NM FROM SCE_EXPT_CD 
		        WHERE SUBSTR(EXPT_CD, 2, LENGTH(EXPT_CD) ) = '0000000' AND ACT_FLG = 'Y') TP 
		       ,SCE_EXPT_CD DTL 
		  WHERE DTL.EXPT_CD LIKE '%00000' 
		  AND   DTL.EXPT_CD NOT LIKE '%0000000' 
		  AND   DTL.ACT_FLG = 'Y' 
		  AND   SUBSTR(DTL.EXPT_CD,1,1) = TP.EXPT_TP 
		  GROUP BY SUBSTR(DTL.EXPT_CD,1,1), SUBSTR(DTL.EXPT_CD,1,3)) etp 
 where mst.bkg_no = bkg.bkg_no 
 	and mst.cre_ofc_cd=subscmst.NTFD_OFC_CD 
 	and subscmst.ACT_FLG='Y' 
 	and mst.cop_expt_tp_cd = etp.cop_expt_tp_cd 
 	and mst.cop_expt_tp_dtl_cd = etp.cop_expt_tp_dtl_cd 
 	and mst.ntfd_flg = 'N' 
 	and mst.COP_EXPT_STS_CD = 'O' 
 	and fa.act_cd(+) = mst.fm_act_cd 
 	and ta.act_cd(+) = DECODE(SUBSTR(mst.expt_cd,1,1),'2',mst.fm_act_cd,mst.to_act_cd) 


/* condition - fail_fm_dt */
#if (${fail_fm_dt} != '')
	AND mst.cre_dt >=  TO_DATE( @[fail_fm_dt]||'00:00:00', 'YYYY-MM-DD HH24:MI:SS')
#end

/* condition - fail_to_dt */
#if (${fail_to_dt} != '')
	AND mst.cre_dt <=  TO_DATE( @[fail_to_dt]||'23:59:59', 'YYYY-MM-DD HH24:MI:SS')
#end

/* condition - occr_fm_dt */
#if (${occur_fm_dt} != '')
	AND mst.occr_dt  >=  TO_DATE( @[occur_fm_dt]||'00:00:00', 'YYYY-MM-DD HH24:MI:SS')
#end

/* condition - occr_to_dt */
#if (${occur_to_dt} != '')
	AND mst.occr_dt  <=  TO_DATE( @[occur_to_dt]||'23:59:59', 'YYYY-MM-DD HH24:MI:SS')
#end

/* condition - i_expt_type */
#if (${i_expt_type} != '' && ${i_expt_type} != 'ALL') 
	AND etp.cop_expt_tp_cd = SUBSTR(@[i_expt_type],1,1)
#end

/* condition - i_exptdtl_type */
#if (${i_exptdtl_type} != '' && ${i_exptdtl_type} != 'ALL')
	AND etp.cop_expt_tp_dtl_nm  = @[i_exptdtl_type]
#end

/* condition - occr_nod_cd  : Occured Location */
#if (${occr_nod_cd} != '')
	AND mst.occr_nod_cd like @[occr_nod_cd]||'%'
#end

/* condition - occr_ofc */
#if (${occr_ofc} != '') 
AND mst.cre_ofc_cd IN (
#foreach($ele IN ${occr_ofc})
#if($velocityCount == 1 ) 
'$ele'
#else 
,'$ele' 
#end 
#end
) 
#end

/* condition - cust_cnt_seq */
#if (${cust_cnt_seq} != '') 
	AND (mst.shpr_cnt_cd||mst.shpr_seq = @[cust_cnt_seq] OR mst.cnee_cnt_cd||mst.cnee_seq = @[cust_cnt_seq] or mst.ntfy_cnt_cd||mst.ntfy_seq = @[cust_cnt_seq] )
#end

/* condition - sc_no */
#if (${sc_no} != '') 
	AND mst.sc_no =  @[sc_no]
#end

/* condition - bkg date */	
#if (${bkg_fm_dt} != '') 
AND mst.LST_BKG_DT >= TO_DATE( @[bkg_fm_dt]||'00:00:00', 'YYYY-MM-DD HH24:MI:SS') 
#end 
#if (${bkg_to_dt} != '') 
AND mst.LST_BKG_DT <= TO_DATE( @[bkg_to_dt]||'23:59:59', 'YYYY-MM-DD HH24:MI:SS')  
#end 

/* condition - bkg_no */
#if (${bkg_no} != '') 
	AND (bkg.bkg_no) IN (
	#foreach($ele IN ${bkg_no})
		#if($velocityCount == 1 ) 
			('$ele')
		#else 
			,('$ele') 
		#end 
	#end
	)
#end

/* condition - bl_no */
#if (${bl_no} != '') 
	AND (mst.mst_bl_no) IN (
	#foreach($ele IN ${bl_no})
		#if($velocityCount == 1 ) 
		'$ele'
		#else 
		,'$ele' 
		#end 
	#end
	)
#end

/* condition - cntr_no */
#if (${cntr_no} != '') 
AND mst.cntr_no IN (
#foreach($ele IN ${cntr_no})
#if($velocityCount == 1 ) 
'$ele'
#else 
,'$ele' 
#end 
#end
) 
#end

/* condition - cop_no */
#if (${cop_no} != '') 
AND mst.cop_no IN (
#foreach($ele IN ${cop_no})
#if($velocityCount == 1 ) 
'$ele'
#else 
,'$ele' 
#end 
#end
) 
#end

/* condition - vvd */
#if (${vvd} != '') 
AND mst.TRNK_VVD_CD IN (
#foreach($ele IN ${vvd})
#if($velocityCount == 1 ) 
'$ele'
#else 
,'$ele' 
#end 
#end
) 
#end

/* condition - por_cd */
#if (${por_cd} != '') 
AND mst.POR_CD IN (
#foreach($ele IN ${por_cd})
#if($velocityCount == 1 ) 
'$ele'
#else 
,'$ele' 
#end 
#end
)
#end

/* condition - pol_cd */
#if (${pol_cd} != '') 
AND mst.POL_CD IN (
#foreach($ele IN ${pol_cd})
#if($velocityCount == 1 ) 
'$ele'
#else 
,'$ele' 
#end 
#end
)
#end

/* condition - pod_cd */
#if (${pod_cd} != '') 
AND mst.POD_CD IN (
#foreach($ele IN ${pod_cd})
#if($velocityCount == 1 ) 
'$ele'
#else 
,'$ele' 
#end 
#end
)
#end

/* condition - del_cd */
#if (${del_cd} != '') 
AND mst.DEL_CD IN (
#foreach($ele IN ${del_cd})
#if($velocityCount == 1 ) 
'$ele'
#else 
,'$ele' 
#end 
#end
)
#end


 ) t1 ) t2			]]></sql>
			<params>
				<param name="fail_fm_dt" type="12" value="" out="N"/>
				<param name="fail_to_dt" type="12" value="" out="N"/>
				<param name="occur_fm_dt" type="12" value="" out="N"/>
				<param name="occur_to_dt" type="12" value="" out="N"/>
				<param name="i_expt_type" type="12" value="" out="N"/>
				<param name="i_exptdtl_type" type="12" value="" out="N"/>
				<param name="occr_nod_cd" type="12" value="" out="N"/>
				<param name="cust_cnt_seq" type="12" value="" out="N"/>
				<param name="sc_no" type="12" value="" out="N"/>
				<param name="bkg_fm_dt" type="12" value="" out="N"/>
				<param name="bkg_to_dt" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
