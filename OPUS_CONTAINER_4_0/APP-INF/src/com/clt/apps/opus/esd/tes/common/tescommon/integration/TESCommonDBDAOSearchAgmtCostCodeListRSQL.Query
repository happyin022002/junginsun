<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="TESCommonDBDAOSearchAgmtCostCodeListRSQL">
			<desc><![CDATA[SearchAgmtCostCodeList]]></desc>
			<sql><![CDATA[
SELECT COST_CODE --, COST_CODE COST_CODE_TXT
FROM(
SELECT DISTINCT DECODE(1,0,C.LGS_COST_CD,DECODE(C.LGS_COST_CD,CD,TP,C.LGS_COST_CD)) COST_CODE
FROM ( SELECT COUNT(T.LGS_COST_CD) CNT,
     T.LGS_COST_CD TP,
     T.THRP_LGS_COST_CD CD,
     H.TML_AGMT_OFC_CTY_CD CTY,
     H.TML_AGMT_SEQ SEQ,
     H.TML_AGMT_VER_NO NO
    FROM   TES_TML_AGMT_HDR H, TES_TML_AGMT_THRP_COST T
    WHERE  H.YD_CD            = @[yd_cd]
    AND    H.VNDR_SEQ         = @[vndr_seq]
    AND    H.TML_AGMT_STS_CD = 'C'
    AND    H.DELT_FLG        = 'N'


#if (${agmt_ftr_inv_tp_cd} == 'MT') 
    AND    TO_CHAR(H.EFF_FM_DT,'YYYYMMDD') <= REPLACE(@[atb_dt],'-') -- ATB Date([atb_dt]) ==> Marine Terminal Invoice
    AND    TO_CHAR(H.EFF_TO_DT,'YYYYMMDD') >= REPLACE(@[atb_dt],'-') -- ATB Date([atb_dt]) ==> Marine Terminal Invoice

#elseif (${agmt_ftr_inv_tp_cd} == 'ST' || ${agmt_ftr_inv_tp_cd} == 'OS')
       AND    TO_CHAR(H.EFF_FM_DT,'YYYYMMDD') <= REPLACE(@[fm_prd_dt],'-') -- From Period Date([fm_prd_dt]) ==> Marine Storage/OFF Dock Sotrage Invoice 
       AND    TO_CHAR(H.EFF_TO_DT,'YYYYMMDD') >= REPLACE(@[fm_prd_dt],'-') -- From Period Date([fm_prd_dt]) ==> Marine Storage/OFF Dock Sotrage Invoice 

#elseif (${agmt_ftr_inv_tp_cd} == 'OT' || ${agmt_ftr_inv_tp_cd} == 'OFON' || ${agmt_ftr_inv_tp_cd} == 'OTOS')
       AND    TO_CHAR(H.EFF_FM_DT,'YYYYMMDD') <= REPLACE(@[to_prd_dt],'-') -- To Period Date([to_prd_dt]) ==> OFF Dock Terminal Invoice (ON Dock 비용계산시)
       AND    TO_CHAR(H.EFF_TO_DT,'YYYYMMDD') >= REPLACE(@[to_prd_dt],'-') -- To Period Date([to_prd_dt]) ==> OFF Dock Terminal Invoice (ON Dock 비용계산시)

#elseif (${agmt_ftr_inv_tp_cd} == 'ON')
    AND    TO_CHAR(H.EFF_FM_DT,'YYYYMMDD') <= REPLACE(@[min_wrk_dt],'-') -- Min Work Date([min_wrk_dt]) ==> OnDock Rail Invoice
    AND    TO_CHAR(H.EFF_TO_DT,'YYYYMMDD') >= REPLACE(@[min_wrk_dt],'-') -- Max Work Date([max_wrk_dt]) ==> OnDock Rail Invoice

#end

    AND    H.TML_AGMT_VER_NO = ( SELECT MAX(M.TML_AGMT_VER_NO)
         FROM   TES_TML_AGMT_HDR M
         WHERE  M.YD_CD               = @[yd_cd]
         AND    M.VNDR_SEQ            = @[vndr_seq]
         AND    M.TML_AGMT_STS_CD     = 'C'
         AND    M.DELT_FLG            = 'N'

#if (${agmt_ftr_inv_tp_cd} == 'MT') 
            AND    TO_CHAR(M.EFF_FM_DT,'YYYYMMDD') <= REPLACE(@[atb_dt],'-') -- ATB Date([atb_dt]) ==> Marine Terminal Invoice
            AND    TO_CHAR(M.EFF_TO_DT,'YYYYMMDD') >= REPLACE(@[atb_dt],'-')) -- ATB Date([atb_dt]) ==> Marine Terminal Invoice

#elseif (${agmt_ftr_inv_tp_cd} == 'ST' || ${agmt_ftr_inv_tp_cd} == 'OS')
            AND    TO_CHAR(M.EFF_FM_DT,'YYYYMMDD') <= REPLACE(@[fm_prd_dt],'-') -- From Period Date([fm_prd_dt]) ==> Marine Storage/OFF Dock Sotrage Invoice 
            AND    TO_CHAR(M.EFF_TO_DT,'YYYYMMDD') >= REPLACE(@[fm_prd_dt],'-')) -- From Period Date([fm_prd_dt]) ==> Marine Storage/OFF Dock Sotrage Invoice 

#elseif (${agmt_ftr_inv_tp_cd} == 'OT' || ${agmt_ftr_inv_tp_cd} == 'OFON' || ${agmt_ftr_inv_tp_cd} == 'OTOS')
            AND    TO_CHAR(M.EFF_FM_DT,'YYYYMMDD') <= REPLACE(@[to_prd_dt],'-') -- To Period Date([to_prd_dt]) ==> OFF Dock Terminal Invoice (ON Dock 비용계산시)
            AND    TO_CHAR(M.EFF_TO_DT,'YYYYMMDD') >= REPLACE(@[to_prd_dt],'-')) -- To Period Date([to_prd_dt]) ==> OFF Dock Terminal Invoice (ON Dock 비용계산시)

#elseif (${agmt_ftr_inv_tp_cd} == 'ON')
            AND    TO_CHAR(M.EFF_FM_DT,'YYYYMMDD') <= REPLACE(@[min_wrk_dt],'-') -- Min Work Date([min_wrk_dt]) ==> OnDock Rail Invoice
            AND    TO_CHAR(M.EFF_TO_DT,'YYYYMMDD') >= REPLACE(@[min_wrk_dt],'-')) -- Max Work Date([max_wrk_dt]) ==> OnDock Rail Invoice
#else
			AND 1=2 )
#end

    AND    H.TML_AGMT_OFC_CTY_CD = T.TML_AGMT_OFC_CTY_CD(+)
    AND    H.TML_AGMT_SEQ        = T.TML_AGMT_SEQ(+)
    AND    H.TML_AGMT_VER_NO     = T.TML_AGMT_VER_NO(+)
    GROUP BY H.TML_AGMT_OFC_CTY_CD, H.TML_AGMT_SEQ, H.TML_AGMT_VER_NO,
    T.LGS_COST_CD, T.THRP_LGS_COST_CD ) A, TES_TML_SO_COST C, TES_TML_AGMT_DTL D
WHERE  C.COST_CALC_MZD_CD = 'A'
AND    C.TML_AGMT_MGMT_CD = 'A'


#if (${agmt_ftr_inv_tp_cd} == 'MT')
AND    C.MRN_TML_FLG = 'Y'  -- Marine Terminal Invoice

#elseif (${agmt_ftr_inv_tp_cd} == 'ON')
AND    C.ODCK_RAIL_CHG_FLG = 'Y' -- OnDock Rail Invoice

#elseif (${agmt_ftr_inv_tp_cd} == 'OT' || ${agmt_ftr_inv_tp_cd} == 'OTOS' )
AND    C.FDCK_CY_TML_FLG = 'Y' -- OFF Dock Terminal Invoice

#elseif (${agmt_ftr_inv_tp_cd} == 'OS')
AND    C.FDCK_CY_STO_FLG = 'Y' -- OFF Dock Storage Invoice

#elseif (${agmt_ftr_inv_tp_cd} == 'OFON')
AND    C.MRN_TML_FLG = 'Y' AND C.LGS_COST_CD LIKE 'TMND%'  -- OFF Dock 화면에서 ON Dock 비용계산시

#elseif (${agmt_ftr_inv_tp_cd} == 'ST')
AND    C.STO_INV_FLG = 'Y'  -- Marine Storage Invoice 

#end

AND    D.TML_AGMT_OFC_CTY_CD = A.CTY
AND    D.TML_AGMT_SEQ = A.SEQ
AND    D.TML_AGMT_VER_NO  = A.NO
AND    C.LGS_COST_CD = D.LGS_COST_CD
AND    DECODE(A.CNT,0,DECODE(SUBSTR(C.LGS_COST_CD,1,2),'TP','N','Y'),'Y') = 'Y' 
AND    D.THRP_COST_CD_FLG IS NULL
)

--OTOS이면 OS용
#if (${agmt_ftr_inv_tp_cd} == 'OTOS') 
UNION ALL

SELECT COST_CODE --, COST_CODE COST_CODE_TXT
FROM(
SELECT DISTINCT DECODE(1,0,C.LGS_COST_CD,DECODE(C.LGS_COST_CD,CD,TP,C.LGS_COST_CD)) COST_CODE
FROM ( SELECT COUNT(T.LGS_COST_CD) CNT,
     T.LGS_COST_CD TP,
     T.THRP_LGS_COST_CD CD,
     H.TML_AGMT_OFC_CTY_CD CTY,
     H.TML_AGMT_SEQ SEQ,
     H.TML_AGMT_VER_NO NO
    FROM   TES_TML_AGMT_HDR H, TES_TML_AGMT_THRP_COST T
    WHERE  H.YD_CD            = @[yd_cd]
    AND    H.VNDR_SEQ         = @[vndr_seq]
    AND    H.TML_AGMT_STS_CD = 'C'
    AND    H.DELT_FLG        = 'N'

    AND    TO_CHAR(H.EFF_FM_DT,'YYYYMMDD') <= REPLACE(@[fm_prd_dt],'-') -- From Period Date([fm_prd_dt]) ==> Marine Storage/OFF Dock Sotrage Invoice 
    AND    TO_CHAR(H.EFF_TO_DT,'YYYYMMDD') >= REPLACE(@[fm_prd_dt],'-') -- From Period Date([fm_prd_dt]) ==> Marine Storage/OFF Dock Sotrage Invoice 

    AND    H.TML_AGMT_VER_NO = ( SELECT MAX(M.TML_AGMT_VER_NO)
         FROM   TES_TML_AGMT_HDR M
         WHERE  M.YD_CD               = @[yd_cd]
         AND    M.VNDR_SEQ            = @[vndr_seq]
         AND    M.TML_AGMT_STS_CD     = 'C'
         AND    M.DELT_FLG            = 'N'

         AND    TO_CHAR(M.EFF_FM_DT,'YYYYMMDD') <= REPLACE(@[fm_prd_dt],'-') -- From Period Date([fm_prd_dt]) ==> Marine Storage/OFF Dock Sotrage Invoice 
         AND    TO_CHAR(M.EFF_TO_DT,'YYYYMMDD') >= REPLACE(@[fm_prd_dt],'-')) -- From Period Date([fm_prd_dt]) ==> Marine Storage/OFF Dock Sotrage Invoice 

    AND    H.TML_AGMT_OFC_CTY_CD = T.TML_AGMT_OFC_CTY_CD(+)
    AND    H.TML_AGMT_SEQ        = T.TML_AGMT_SEQ(+)
    AND    H.TML_AGMT_VER_NO     = T.TML_AGMT_VER_NO(+)
    GROUP BY H.TML_AGMT_OFC_CTY_CD, H.TML_AGMT_SEQ, H.TML_AGMT_VER_NO,
    T.LGS_COST_CD, T.THRP_LGS_COST_CD ) A, TES_TML_SO_COST C, TES_TML_AGMT_DTL D
WHERE  C.COST_CALC_MZD_CD = 'A'
AND    C.TML_AGMT_MGMT_CD = 'A'

AND    C.FDCK_CY_STO_FLG = 'Y' -- OFF Dock Storage Invoice
AND    D.TML_AGMT_OFC_CTY_CD = A.CTY
AND    D.TML_AGMT_SEQ = A.SEQ
AND    D.TML_AGMT_VER_NO  = A.NO
AND    C.LGS_COST_CD = D.LGS_COST_CD
AND    DECODE(A.CNT,0,DECODE(SUBSTR(C.LGS_COST_CD,1,2),'TP','N','Y'),'Y') = 'Y' 
AND    D.THRP_COST_CD_FLG IS NULL
)

#end			]]></sql>
			<params>
				<param name="yd_cd" type="12" value="" out="N"/>
				<param name="vndr_seq" type="12" value="" out="N"/>
				<param name="atb_dt" type="12" value="" out="N"/>
				<param name="fm_prd_dt" type="12" value="" out="N"/>
				<param name="to_prd_dt" type="12" value="" out="N"/>
				<param name="min_wrk_dt" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
