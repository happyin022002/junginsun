<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CSRIssueTransferSlipManageDBDAOCorrectRfndInvCsrCorrAmtUSQL">
			<desc><![CDATA[REFUND    AMOUNT CORRECTION]]></desc>
			<sql><![CDATA[
UPDATE       TRS_TRSP_RFND_INV RFF																																
SET         (RFF.CSR_RFND_MON_KNT, RFF.CSR_RFND_CORR_AMT)                                                                                               		
				   =  (                                                                                                                 		
					SELECT                                                                                                          		
						   RF.RFND_MON_KNT	                                                                                     		
						 , CASE NVL((SELECT DP_PRCS_KNT FROM MDM_CURRENCY WHERE CURR_CD = W.INV_CURR_CD AND NVL(DELT_FLG, 'N') = 'N'), 0) WHEN  0 THEN ROUND(TRSP_RFND_INV_AMT, 0)                             		
							ELSE                                     ROUND(TRSP_RFND_INV_AMT, 2)                             		
						   END                                                                                                  		
						   -                                                                                                    		
						   CASE NVL((SELECT DP_PRCS_KNT FROM MDM_CURRENCY WHERE CURR_CD = W.INV_CURR_CD), 0) WHEN 0  THEN ROUND((RF.TRSP_RFND_INV_AMT/RFND_MON_KNT), 0)          		
							ELSE                                     ROUND((RF.TRSP_RFND_INV_AMT/RFND_MON_KNT), 2)          		
						   END * RFND_MON_KNT	                                                                                  		
					FROM       TRS_TRSP_INV_WRK   W                                                                                 		
						 , (                                                                                                    		
						      SELECT                                                                                            		
							       RF.INV_NO                                                                                		
							    ,  RF.INV_VNDR_SEQ                                                                          		
							    ,  RF.SUB_INV_SEQ                                                                           		
							    ,  RF.TRSP_RFND_INV_AMT                                                                     		
							    ,  RF.HNDL_PRD_FM_DT                                                                        		
							    ,  RF.HNDL_PRD_TO_DT                                                                        		
							    ,  TO_NUMBER(MONTHS_BETWEEN	(TO_DATE(TO_CHAR(HNDL_PRD_TO_DT,'YYYYMM'), 'YYYYMM'),TO_DATE(TO_CHAR(HNDL_PRD_FM_DT,'YYYYMM'), 'YYYYMM'))) + 1 RFND_MON_KNT		                                           					
						      FROM TRS_TRSP_RFND_INV RF                                                                     		
						   )  RF                                                                                                		
					WHERE      W.INV_NO              = RF.INV_NO                                                                    		
					AND        W.INV_VNDR_SEQ        = RF.INV_VNDR_SEQ                                                              		
					AND        RF.INV_NO             = RFF.INV_NO                                                                   		
					AND        RF.INV_VNDR_SEQ       = RFF.INV_VNDR_SEQ                                                             		
					AND        RF.SUB_INV_SEQ        = RFF.SUB_INV_SEQ                                                              		
				      )                                                                                                                 		
WHERE       1 = 1                                                                                                                                      			
AND         RFF.INV_VNDR_SEQ       		= @[INV_VNDR_SEQ]

#if ($INV_NO.size() > 0) 
	AND	RFF.INV_NO	IN	(
		#foreach( ${key} in ${INV_NO}) 
			#if($velocityCount < $INV_NO.size()) 
				'$key', 
			#else 
				'$key' 
			#end 
		#end
	)
#end			]]></sql>
			<params>
				<param name="INV_VNDR_SEQ" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
