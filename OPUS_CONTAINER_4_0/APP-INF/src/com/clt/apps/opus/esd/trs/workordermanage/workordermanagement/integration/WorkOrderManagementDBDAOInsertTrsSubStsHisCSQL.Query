<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="WorkOrderManagementDBDAOInsertTrsSubStsHisCSQL">
			<desc><![CDATA[WorkOrderManagementDBDAOInsertTrsSubStsHis]]></desc>
			<sql><![CDATA[
INSERT INTO TRS_SUB_STS_HIS (
   TRSP_SO_OFC_CTY_CD
  ,TRSP_SO_SEQ
  ,HIS_SEQ
  ,PRE_TRSP_SUB_STS_CD
  ,CRNT_TRSP_SUB_STS_CD
  ,CRE_USR_ID
  ,CRE_DT
  ,UPD_USR_ID
  ,UPD_DT
) SELECT TRSP_SO_OFC_CTY_CD
        ,TRSP_SO_SEQ
        ,TRS_SUB_STS_HIS_SEQ1.NEXTVAL AS HIS_SEQ
        ,SO.TRS_SUB_STS_CD
        ,(CASE WHEN @[mvmt_sts_cd] IN ('EN', 'TN', 'OP', 'ID') AND @[node_cd] = SO.FM_NOD_CD THEN 'ST'
               WHEN @[mvmt_sts_cd] IN ('OC', 'IC', 'MT') AND @[node_cd] = SO.TO_NOD_CD THEN 'CM'
               ELSE  SO.TRS_SUB_STS_CD
         END)
        ,@[upd_usr_id]
        ,SYSDATE
        ,@[upd_usr_id]
        ,SYSDATE
    FROM TRS_TRSP_SVC_ORD SO
   WHERE (SO.EQ_NO = @[cntr_no] OR SO.COP_NO = (SELECT COP_NO FROM SCE_COP_HDR WHERE BKG_NO = @[bkg_no] AND CNTR_NO = @[cntr_no]))
     AND SO.BKG_NO = @[bkg_no]
     AND NVL2(@[wo_no], SO.TRSP_WO_OFC_CTY_CD || SO.TRSP_WO_SEQ, 'XXX') = NVL(@[wo_no], 'XXX')
     AND INSTR(SO.FM_NOD_CD || SO.TO_NOD_CD || SO.VIA_NOD_CD, @[node_cd]) > 0
     AND SO.DELT_FLG = 'N'
     AND NVL(SO.TRS_SUB_STS_CD, 'XX') <> 'CM'
     AND NVL(SO.TRS_SUB_STS_CD, 'X') <> NVL((CASE WHEN @[mvmt_sts_cd] IN ('EN', 'TN', 'OP', 'ID') AND @[node_cd] = SO.FM_NOD_CD THEN 'ST'
                                                  WHEN @[mvmt_sts_cd] IN ('OC', 'IC', 'MT') AND @[node_cd] = SO.TO_NOD_CD THEN 'CM'
                                                  ELSE  SO.TRS_SUB_STS_CD
                                             END), 'X')
	 AND NVL(@[mvmt_cre_tp_cd], 'X') <> 'A'			]]></sql>
			<params>
				<param name="mvmt_sts_cd" type="12" value="" out="N"/>
				<param name="node_cd" type="12" value="" out="N"/>
				<param name="upd_usr_id" type="12" value="" out="N"/>
				<param name="cntr_no" type="12" value="" out="N"/>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="wo_no" type="12" value="" out="N"/>
				<param name="mvmt_cre_tp_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
