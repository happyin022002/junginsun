<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="OCPChgColmanageDBDAOSearchOCPChgListVORSQL">
			<desc><![CDATA[SearchOCPChgListVO 생성]]></desc>
			<sql><![CDATA[
SELECT
         (
               SELECT
                      LOC.EQ_CTRL_OFC_CD
                 FROM MDM_LOCATION LOC
                WHERE LOC.LOC_CD = SUBSTR (MVM.ORG_YD_CD, 1, 5)
         )                                          AS CTRL_OFC_CD,
         (
               SELECT
                      BKG.BKG_STS_CD
                 FROM BKG_BOOKING  BKG
                WHERE BKG.BKG_NO = MVM.BKG_NO
         )                                          AS BKG_STS_CD,
           MVM.BKG_NO,
           MVM.CNTR_NO,
           MVM.CNTR_TPSZ_CD                         AS TS_CD,
         (
               SELECT
                      BKG.RCV_TERM_CD
                 FROM BKG_BOOKING  BKG
                WHERE BKG.BKG_NO = MVM.BKG_NO
         )                                          AS RCV_TM,
         (
               SELECT
                      BKG.DE_TERM_CD
                 FROM BKG_BOOKING  BKG
                WHERE BKG.BKG_NO = MVM.BKG_NO
         )                                          AS DEL_TM,           
         (
               SELECT
                      SHR.CUST_CNT_CD
                   || LTRIM (TO_CHAR (NVL (SHR.CUST_SEQ, 0), '000000'))
                 FROM BKG_CUSTOMER     SHR
                WHERE SHR.BKG_CUST_TP_CD = 'N'
                  AND SHR.BKG_NO         = MVM.BKG_NO
         )                                          AS SHPR_NO,
         (
               SELECT
                      CNE.CUST_CNT_CD
                   || LTRIM (TO_CHAR (NVL (CNE.CUST_SEQ, 0), '000000'))
                 FROM BKG_CUSTOMER     CNE
                WHERE CNE.BKG_CUST_TP_CD = 'N'
                  AND CNE.BKG_NO         = MVM.BKG_NO
         )                                          AS CNEE_NO,
         (
               SELECT
                      BKG.POR_CD
                 FROM BKG_BOOKING  BKG
                WHERE BKG.BKG_NO = MVM.BKG_NO
         )                                          AS POR_CD,
         (
               SELECT
                      BKG.POL_CD
                 FROM BKG_BOOKING  BKG
                WHERE BKG.BKG_NO = MVM.BKG_NO
         )                                          AS POL_CD,
         (
               SELECT
                      BKG.POD_CD
                 FROM BKG_BOOKING  BKG
                WHERE BKG.BKG_NO = MVM.BKG_NO
         )                                          AS POD_CD,
         (
               SELECT
                      BKG.DEL_CD
                 FROM BKG_BOOKING  BKG
                WHERE BKG.BKG_NO = MVM.BKG_NO
         )                                          AS DEL_CD,
         (
               SELECT
                      NVL (BKG.SC_NO, BKG.RFA_NO)
                 FROM BKG_BOOKING BKG
                WHERE BKG.BKG_NO = MVM.BKG_NO
         )                                          AS SC_RFA_CD,
         (
               SELECT
                      MV2.ORG_YD_CD
                 FROM CTM_MOVEMENT MV2
                WHERE MV2.BKG_NO      = MVM.BKG_NO
                  AND MV2.CNTR_NO     = MVM.CNTR_NO
                  AND MV2.MVMT_STS_CD = 'ID'
                  AND ROWNUM = 1
         )                                          AS IB_RLSE_CD,
         (
               SELECT
                      TO_CHAR (MV2.CNMV_EVNT_DT, 'YYYYMMDD')
                 FROM CTM_MOVEMENT MV2
                WHERE MV2.BKG_NO      = MVM.BKG_NO
                  AND MV2.CNTR_NO     = MVM.CNTR_NO
                  AND MV2.MVMT_STS_CD = 'ID'
                  AND ROWNUM = 1
         )                                          AS IB_RLSE_DT,
         (
               SELECT
                      COUNT (1)
                 FROM CTM_MOVEMENT MV2
                WHERE MV2.BKG_NO      = MVM.BKG_NO
                  AND MV2.CNTR_NO     = MVM.CNTR_NO
                  AND MV2.CNMV_CYC_NO = MV2.CNMV_CYC_NO
                  AND MV2.MVMT_STS_CD = 'ID'
         )                                          AS IB_RLSE_CNT,
           MVM.ORG_YD_CD                            AS MT_RTN_CD,
           TO_CHAR (MVM.CNMV_EVNT_DT, 'YYYYMMDD')   AS MT_RTN_DT,
         (
               SELECT
                      BCR.CURR_CD
                 FROM BKG_CHG_RT           BCR,
                      AGT_CNTR_PERTP_MPG_V MPG
                WHERE BCR.CHG_CD = 'OCP'
                  AND MVM.CNTR_TPSZ_CD     = MPG.CNTR_TP
                  AND BCR.RAT_UT_CD
                   IN
                    (
                      'BX', 'BL', 'UN', 'PC', 'HC', MPG.REP_TP, MVM.CNTR_TPSZ_CD
                    )
                  AND BCR.BKG_NO = MVM.BKG_NO
                  AND ROWNUM = 1
         )                                          AS BKG_OCP_TP,
         (
               SELECT
                      BCR.CHG_AMT / RAT_AS_QTY
                 FROM BKG_CHG_RT           BCR,
                      AGT_CNTR_PERTP_MPG_V MPG
                WHERE BCR.CHG_CD = 'OCP'
                  AND MVM.CNTR_TPSZ_CD     = MPG.CNTR_TP
                  AND BCR.RAT_UT_CD
                   IN
                    (
                      'BX', 'BL', 'UN', 'PC', 'HC', MPG.REP_TP, MVM.CNTR_TPSZ_CD
                    )
                  AND BCR.BKG_NO = MVM.BKG_NO
                  AND ROWNUM = 1
         )                                          AS BKG_OCP_AMT,
         (
               SELECT
                      SUBSTR
                    ( XMLAGG
                    ( XMLELEMENT
                    ( A,',' || OTS.N3PTY_NO
                    )
                    ).EXTRACT('//text()') --'//text()'는 반드시 소문자이어야 합니다.
                    , 2
                    ) 
                 FROM TPB_OTS_DTL OTS
                WHERE OTS.BKG_NO    = MVM.BKG_NO
                  AND OTS.CRE_DT
                    =
                    (
                          SELECT
                                 MIN (OTD.CRE_DT)
                            FROM TPB_OTS_DTL OTD
                           WHERE OTD.BKG_NO = OTS.BKG_NO
                    )
                  AND OTS.IF_RHQ_CD       ='NYCNA'
                  AND OTS.N3PTY_BIL_TP_CD ='TR'
             GROUP BY OTS.BKG_NO
         )                                          AS TPB_CD,
         CASE
         WHEN EXISTS (
                SELECT
                        1
                FROM TRS_EXPN_AUD_RMK RMK
                WHERE RMK.BKG_NO = MVM.BKG_NO
				  AND EAS_EXPN_TP_CD = 'CO' 
         )
         THEN 'Y'
         ELSE 'N'
         END                                        AS RMK_CTNT
      FROM CTM_MOVEMENT MVM
     WHERE MVM.MVMT_STS_CD = 'MT'
       AND SUBSTR (MVM.ORG_YD_CD, 1, 2)
        IN
         (
               SELECT
             DISTINCT LOC.CNT_CD
                 FROM MDM_LOCATION LOC
                WHERE LOC.CONTI_CD       = 'M'
                  AND LOC.DELT_FLG     <>  'Y'
         )
       AND
         (
               SELECT
                 CASE
                 WHEN MVM.BKG_NO IS NULL
                 THEN 'XXXXXX'
                 ELSE SUBSTR (MV2.ORG_YD_CD, 1, 5)
                  END
                 FROM CTM_MOVEMENT MV2
                WHERE MV2.CNTR_NO    = MVM.CNTR_NO
                  AND MV2.CNMV_YR    = MVM.CNMV_YR
                  AND MV2.CNMV_ID_NO = MVM.CNMV_ID_NO
                  AND MV2.CNMV_ID_NO = MVM.CNMV_ID_NO
         ) = SUBSTR (MVM.ORG_YD_CD, 1, 5) 
       AND
         (
               SELECT
                      SUBSTR (MV2.ORG_YD_CD, 1, 5)
                 FROM CTM_MOVEMENT MV2
                WHERE MV2.CNTR_NO    = MVM.CNTR_NO
                  AND MV2.CNMV_YR    = MVM.CNMV_YR
                  AND MV2.CNMV_ID_NO = MVM.CNMV_ID_NO
                  AND MV2.CNMV_ID_NO = MVM.CNMV_ID_NO
         )
    NOT IN
         (
               SELECT
                 CASE
                 WHEN SUBSTR (MVM.ORG_YD_CD, 1, 5) = 'USLGB'
                  AND SUBSTR (MV2.ORG_YD_CD, 1, 5) = 'USLAX'
                 THEN SUBSTR (MVM.ORG_YD_CD, 1, 5)
                 WHEN SUBSTR (MVM.ORG_YD_CD, 1, 5) = 'USKCK'
                  AND SUBSTR (MV2.ORG_YD_CD, 1, 5) = 'USMKC'
                 THEN SUBSTR (MVM.ORG_YD_CD, 1, 5)
                 WHEN SUBSTR (MVM.ORG_YD_CD, 1, 5) = 'USSEA'
                  AND SUBSTR (MV2.ORG_YD_CD, 1, 5) = 'USTIW'
                 THEN SUBSTR (MVM.ORG_YD_CD, 1, 5)
                 WHEN SUBSTR (MVM.ORG_YD_CD, 1, 5) = 'USCHS'
                  AND SUBSTR (MV2.ORG_YD_CD, 1, 5) = 'USSAV'
                 THEN SUBSTR (MVM.ORG_YD_CD, 1, 5)
--                 WHEN SUBSTR (MVM.ORG_YD_CD, 1, 5) = 'USTLL'
--                  AND SUBSTR (MV2.ORG_YD_CD, 1, 5) = 'USDAL'
--                 THEN SUBSTR (MVM.ORG_YD_CD, 1, 5)
--                 WHEN SUBSTR (MVM.ORG_YD_CD, 1, 5) = 'USBOS'
--                  AND SUBSTR (MV2.ORG_YD_CD, 1, 5) = 'USNYC'
--                 THEN SUBSTR (MVM.ORG_YD_CD, 1, 5)
--                 WHEN SUBSTR (MVM.ORG_YD_CD, 1, 5) = 'USILM'
--                  AND SUBSTR (MV2.ORG_YD_CD, 1, 5) = 'USSAV'
--                 THEN SUBSTR (MVM.ORG_YD_CD, 1, 5)
                 WHEN SUBSTR (MVM.ORG_YD_CD, 1, 5) = 'USLAX'
                  AND SUBSTR (MV2.ORG_YD_CD, 1, 5) = 'USLGB'
                 THEN SUBSTR (MVM.ORG_YD_CD, 1, 5)
                 WHEN SUBSTR (MVM.ORG_YD_CD, 1, 5) = 'USMKC'
                  AND SUBSTR (MV2.ORG_YD_CD, 1, 5) = 'USKCK'
                 THEN SUBSTR (MVM.ORG_YD_CD, 1, 5)
                 WHEN SUBSTR (MVM.ORG_YD_CD, 1, 5) = 'USTIW'
                  AND SUBSTR (MV2.ORG_YD_CD, 1, 5) = 'USSEA'
                 THEN SUBSTR (MVM.ORG_YD_CD, 1, 5)
                 WHEN SUBSTR (MVM.ORG_YD_CD, 1, 5) = 'USSAV'
                  AND SUBSTR (MV2.ORG_YD_CD, 1, 5) = 'USCHS'
                 THEN SUBSTR (MVM.ORG_YD_CD, 1, 5)
                 WHEN SUBSTR (MVM.ORG_YD_CD, 1, 5) = 'USDAL'
                  AND SUBSTR (MV2.ORG_YD_CD, 1, 5) = 'USTLL'
                 THEN SUBSTR (MVM.ORG_YD_CD, 1, 5)
                 WHEN SUBSTR (MVM.ORG_YD_CD, 1, 5) = 'USNYC'
                  AND SUBSTR (MV2.ORG_YD_CD, 1, 5) = 'USBOS'
                 THEN SUBSTR (MVM.ORG_YD_CD, 1, 5)
                 WHEN SUBSTR (MVM.ORG_YD_CD, 1, 5) = 'USSAV'
                  AND SUBSTR (MV2.ORG_YD_CD, 1, 5) = 'USILM'
                 THEN SUBSTR (MVM.ORG_YD_CD, 1, 5)
                 WHEN SUBSTR (MV2.ORG_YD_CD, 1, 2) <> 'US'
                 THEN SUBSTR (MVM.ORG_YD_CD, 1, 5)
                 ELSE SUBSTR (MV2.ORG_YD_CD, 1, 5)
                  END
                 FROM CTM_MOVEMENT MV2
                WHERE MV2.BKG_NO      = MVM.BKG_NO
                  AND MV2.CNTR_NO     = MVM.CNTR_NO
                  AND MV2.CNMV_CYC_NO = MV2.CNMV_CYC_NO
                  AND MV2.MVMT_STS_CD = 'ID'
         )
       AND EXISTS
         (
               SELECT
                      1
                 FROM BKG_BOOKING  BKG
                WHERE BKG.BKG_CGO_TP_CD = 'F'
                  AND BKG.BKG_NO = MVM.BKG_NO
                  AND NVL (BKG.OCP_CD,'X') <>  SUBSTR (MVM.ORG_YD_CD, 1, 5)
         )
----+++++++++++++++++++++++++++++++++++++++++++++++++++++++++--
----++ BOOKING NUMBER Condition +++++++++++++++++++++++++++++--
----+++++++++++++++++++++++++++++++++++++++++++++++++++++++++--
#if (${s_bkg_no} != '')
       AND MVM.BKG_NO = @[s_bkg_no] --:BKG_NO
#end
--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++--
--++ MT Return Period Condition +++++++++++++++++++++++++++--
--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++--
#if (${fm_dt} != '')
       AND MVM.CNMV_EVNT_DT
   BETWEEN TO_DATE (@[fm_dt], 'YYYYMMDD')           --:FR_DT
       AND TO_DATE (@[to_dt], 'YYYYMMDD') + 0.99999 --:TO_DT
#end
--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++--
--++ Control Office Condition +++++++++++++++++++++++++++++--
--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++--
#if (${s_ctrl_ofc_cd} != '')
       AND EXISTS
         (
               SELECT
                      1
                 FROM BKG_BOOKING  BKG,
                      MDM_LOCATION LOC
                WHERE BKG.BKG_CGO_TP_CD = 'F'
                  AND BKG.DEL_CD = LOC.LOC_CD
                  AND BKG.BKG_NO = MVM.BKG_NO
                  AND LOC.EQ_CTRL_OFC_CD = @[s_ctrl_ofc_cd] --:EQ_CTRL_OFC_CD
         )
#end
--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++--
--++ MT Return Loc/Yard Condition +++++++++++++++++++++++++--
--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++--
#if (${s_mt_rtn_cd} != '')
      AND MVM.ORG_YD_CD LIKE @[s_mt_rtn_cd]  --:ORG_YD_CD
#end
--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++--
--++ Consignee Condition ++++++++++++++++++++++++++++++++++--
--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++--
#if (${s_cnee_no} != '')
       AND EXISTS
         (
               SELECT
                      1
                 FROM BKG_CUSTOMER     CNE
                WHERE CNE.BKG_CUST_TP_CD = 'N'
                  AND CNE.BKG_NO         = MVM.BKG_NO
                  AND CNE.CUST_CNT_CD    = SUBSTR (@[s_cnee_no], 1, 2)                   --:CNEE_CD
                  AND CNE.CUST_SEQ       = TO_NUMBER (NVL (SUBSTR (@[s_cnee_no], 3), 0)) --:CNEE_CD
         )
#end
--PK CNTR_NO+CNMV_YR+CNMV_ID_NO
--13 BKG_NO+CNTR_NO+CNMV_CYC_NO+MVMT_STS_CD+CNMV_EVNT_DT
--06 MVMT_STS_CD+ORG_YD_CD+CNMV_EVNT_DT
--			]]></sql>
			<params>
				<param name="s_bkg_no" type="12" value="" out="N"/>
				<param name="fm_dt" type="12" value="" out="N"/>
				<param name="to_dt" type="12" value="" out="N"/>
				<param name="s_ctrl_ofc_cd" type="12" value="" out="N"/>
				<param name="s_mt_rtn_cd" type="12" value="" out="N"/>
				<param name="s_cnee_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
