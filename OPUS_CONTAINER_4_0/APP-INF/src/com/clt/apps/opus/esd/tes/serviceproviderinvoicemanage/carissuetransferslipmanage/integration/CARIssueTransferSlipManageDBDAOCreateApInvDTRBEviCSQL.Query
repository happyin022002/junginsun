<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CARIssueTransferSlipManageDBDAOCreateApInvDTRBEviCSQL">
			<desc><![CDATA[CreateApInvDTRBEvi]]></desc>
			<sql><![CDATA[
INSERT INTO AP_INV_DTRB (
		CSR_NO, LINE_SEQ, LINE_NO, LINE_TP_LU_CD, INV_AMT,
		INV_DESC, INV_TAX_CD, DTRB_COA_CO_CD, DTRB_COA_RGN_CD, DTRB_COA_CTR_CD,
		DTRB_COA_ACCT_CD, DTRB_COA_VVD_CD, DTRB_COA_INTER_CO_CD, DTRB_COA_FTU_N1ST_CD, DTRB_COA_FTU_N2ND_CD,
		ATTR_CATE_NM, ATTR_CTNT1, ATTR_CTNT2, ATTR_CTNT3, ATTR_CTNT4,
		ATTR_CTNT5, ATTR_CTNT6, ATTR_CTNT7, ATTR_CTNT8, ATTR_CTNT9,
		ATTR_CTNT10, ATTR_CTNT11, ATTR_CTNT12, ATTR_CTNT13, ATTR_CTNT14,
		ATTR_CTNT15, BKG_NO, CNTR_TPSZ_CD, ACT_VVD_CD,
		PLN_SCTR_DIV_CD, SO_CRR_CD, YD_CD, FTU_USE_CTNT1, FTU_USE_CTNT2,
		FTU_USE_CTNT3, FTU_USE_CTNT4, FTU_USE_CTNT5, CRE_DT, CRE_USR_ID,
		EAI_EVNT_DT)
  SELECT CSR_NO, (select nvl(max(LINE_SEQ),0)+1 from AP_INV_DTRB where csr_no = @[csr_no]) LINE_SEQ,  ROWNUM+(select nvl(max(LINE_NO),0) from AP_INV_DTRB where csr_no = @[csr_no]) LINE_NO, LINE_TP_LU_CD, CSR_AMT,
  INV_DESC, INV_TAX_CD, DTRB_COA_CO_CD, DTRB_COA_RGN_CD, DTRB_COA_CTR_CD, DTRB_COA_ACCT_CD,
  DTRB_COA_VVD_CD, DTRB_COA_INTER_CO_CD, DTRB_COA_FTU_N1ST_CD, DTRB_COA_FTU_N2ND_CD,
  ATTR_CATE_NM, ATTR_CTNT1, ATTR_CTNT2, ATTR_CTNT3, ATTR_CTNT4, ATTR_CTNT5,
  ATTR_CTNT6, ATTR_CTNT7, ATTR_CTNT8, ATTR_CTNT9, ATTR_CTNT10, ATTR_CTNT11,
  ATTR_CTNT12, ATTR_CTNT13, ATTR_CTNT14, ATTR_CTNT15, BKG_NO,
  CNTR_TPSZ_CD, ACT_VVD_CD, PLN_SCTR_DIV_CD, SO_CRR_CD, YD_CD, FTU_USE_CTNT1,
  FTU_USE_CTNT2, FTU_USE_CTNT3, FTU_USE_CTNT4, FTU_USE_CNTR5, CRE_DT, CRE_USR_ID, EAI_EVNT_DT FROM	(
  SELECT CSR_NO, LINE_SEQ, LINE_NO, LINE_TP_LU_CD, NVL(ROUND(SUM(CSR_AMT),2),0) CSR_AMT,
		 INV_DESC, INV_TAX_CD, DTRB_COA_CO_CD, DTRB_COA_RGN_CD, DTRB_COA_CTR_CD, DTRB_COA_ACCT_CD,
		 DTRB_COA_VVD_CD, DTRB_COA_INTER_CO_CD, DTRB_COA_FTU_N1ST_CD, DTRB_COA_FTU_N2ND_CD,
		 ATTR_CATE_NM, MAX(ATTR_CTNT1) ATTR_CTNT1, MAX(ATTR_CTNT2) ATTR_CTNT2, ATTR_CTNT3, ATTR_CTNT4, ATTR_CTNT5,
		 ATTR_CTNT6, ATTR_CTNT7, ATTR_CTNT8, ATTR_CTNT9, ATTR_CTNT10, ATTR_CTNT11,
		 ATTR_CTNT12, ATTR_CTNT13, ATTR_CTNT14, ATTR_CTNT15, BKG_NO, 
		 CNTR_TPSZ_CD, ACT_VVD_CD, PLN_SCTR_DIV_CD, SO_CRR_CD, YD_CD, FTU_USE_CTNT1,
		 FTU_USE_CTNT2, FTU_USE_CTNT3, FTU_USE_CTNT4, FTU_USE_CNTR5, CRE_DT, CRE_USR_ID, EAI_EVNT_DT
  FROM ( SELECT     DISTINCT @[csr_no]                             CSR_NO,
           ''                                                      LINE_SEQ,
		   ''                                                      LINE_NO,
		   ( SELECT DECODE(SUBSTR(LOC_CD,1,2),'JP','TAX','ITEM')
		   FROM   MDM_ORGANIZATION
		   WHERE  OFC_CD = H.COST_OFC_CD  )                        LINE_TP_LU_CD,
		   DECODE(H.CURR_CD,'KRW',ROUND(NVL(H.VAT_AMT,0)),
                            'JPY',ROUND(NVL(H.VAT_AMT,0)),
                            'TWD',ROUND(NVL(H.VAT_AMT,0)),
                            'CLP',ROUND(NVL(H.VAT_AMT,0)),
                            'DJF',ROUND(NVL(H.VAT_AMT,0)),
                            'IDR',ROUND(NVL(H.VAT_AMT,0)),
                            'VND',ROUND(NVL(H.VAT_AMT,0)),
                            'VUV',ROUND(NVL(H.VAT_AMT,0)),
                            'XAF',ROUND(NVL(H.VAT_AMT,0)),
                            'XPF',ROUND(NVL(H.VAT_AMT,0)),
                                  ROUND(NVL(H.VAT_AMT,0),2)) CSR_AMT,           
		   H.INV_NO                                                INV_DESC,
		   ( SELECT DECODE(SUBSTR(LOC_CD, 1, 2), 'JP', (SELECT SLD.LU_CD --||'('||SLD.LU_DESC||')' --, SLD.ATTR_CTNT1, SLD.ATTR_CTNT2
                                                          FROM SCO_LU_HDR SLH, SCO_LU_DTL SLD
                                                         WHERE SLH.LU_TP_CD = SLD.LU_TP_CD
                                                           AND SLH.LU_TP_CD = 'AP TAX CODE'
                                                           AND NVL(SLD.ENBL_FLG, 'Y') = 'Y'
                                                           AND NVL(SLD.LU_ST_DT, SYSDATE) >= SYSDATE
                                                           AND SLH.LU_APPL_CD = 'SAP'
                                                           AND SLD.ATTR_CTNT2 = 'Y'), '')
			FROM MDM_ORGANIZATION
			WHERE  OFC_CD = H.COST_OFC_CD  )                        INV_TAX_CD,
		   '01'                                                     DTRB_COA_CO_CD,
		   ( SELECT FINC_RGN_CD
			 FROM   MDM_ORGANIZATION
			 WHERE  OFC_CD = H.COST_OFC_CD  )                       DTRB_COA_RGN_CD,
		   ( SELECT AP_CTR_CD
			 FROM   MDM_ORGANIZATION
			 WHERE  OFC_CD = H.COST_OFC_CD  )                       DTRB_COA_CTR_CD,
		  ( SELECT DECODE(SUBSTR(LOC_CD, 1, 2), 'JP', (SELECT SLD.LU_CD --, SLD.LU_DESC
												         FROM SCO_LU_HDR SLH, SCO_LU_DTL SLD
												        WHERE SLH.LU_TP_CD = SLD.LU_TP_CD
												          AND SLH.LU_TP_CD = 'AP TAX ACCOUNT'
												          AND NVL(SLD.ENBL_FLG, 'Y') = 'Y'
												          AND SLD.ATTR_CTNT1 = 'INTERNAL'
												          AND NVL(SLD.LU_ST_DT, SYSDATE) >= SYSDATE
													      AND SLH.LU_APPL_CD = 'SAP'
												          AND ROWNUM = 1 )
													, (SELECT SLD.LU_CD --, SLD.LU_DESC
												         FROM SCO_LU_HDR SLH, SCO_LU_DTL SLD
											        	WHERE SLH.LU_TP_CD = SLD.LU_TP_CD
												          AND SLH.LU_TP_CD = 'AP TAX ACCOUNT'
											          	  AND NVL(SLD.ENBL_FLG, 'Y') = 'Y'
											          	AND SLD.ATTR_CTNT1 = 'EXTERNAL'
											          	AND NVL(SLD.LU_ST_DT, SYSDATE) >= SYSDATE
											          	AND SLH.LU_APPL_CD = 'SAP'
											          	AND ROWNUM = 1))
			FROM MDM_ORGANIZATION
			WHERE  OFC_CD = H.COST_OFC_CD  )                       DTRB_COA_ACCT_CD,
		   '0000000000'                                            DTRB_COA_VVD_CD,
		   ( SELECT NVL(SUBS_CO_CD,'00')
			 FROM   MDM_VENDOR
			 WHERE  VNDR_SEQ = H.VNDR_SEQ )                        DTRB_COA_INTER_CO_CD,
		   '000000'                                                DTRB_COA_FTU_N1ST_CD,
		   '000000'                                                DTRB_COA_FTU_N2ND_CD,
		  ( SELECT DECODE(SUBSTR(LOC_CD, 1, 2), 'JP', (SELECT SLD.LU_CD --, SLD.LU_DESC
												         FROM SCO_LU_HDR SLH, SCO_LU_DTL SLD
												        WHERE SLH.LU_TP_CD = SLD.LU_TP_CD
												          AND SLH.LU_TP_CD = 'AP TAX ACCOUNT'
												          AND NVL(SLD.ENBL_FLG, 'Y') = 'Y'
												          AND SLD.ATTR_CTNT1 = 'INTERNAL'
												          AND NVL(SLD.LU_ST_DT, SYSDATE) >= SYSDATE
													      AND SLH.LU_APPL_CD = 'SAP'
												          AND ROWNUM = 1 )
													, (SELECT SLD.LU_CD --, SLD.LU_DESC
												         FROM SCO_LU_HDR SLH, SCO_LU_DTL SLD
											        	WHERE SLH.LU_TP_CD = SLD.LU_TP_CD
												          AND SLH.LU_TP_CD = 'AP TAX ACCOUNT'
											          	  AND NVL(SLD.ENBL_FLG, 'Y') = 'Y'
											          	AND SLD.ATTR_CTNT1 = 'EXTERNAL'
											          	AND NVL(SLD.LU_ST_DT, SYSDATE) >= SYSDATE
											          	AND SLH.LU_APPL_CD = 'SAP'
											          	AND ROWNUM = 1))
			FROM MDM_ORGANIZATION
			WHERE  OFC_CD = H.COST_OFC_CD  )                        ATTR_CATE_NM,
		   H.INV_NO                                                ATTR_CTNT1,
		   TO_CHAR(H.ISS_DT,'YYYY/MM/DD HH24:MI:SS')               ATTR_CTNT2,
		   SUBSTR(H.YD_CD,1,5)                                     ATTR_CTNT3,
		   NULL                                                    ATTR_CTNT4,
		   NULL                                                    ATTR_CTNT5,
		   NULL                                                    ATTR_CTNT6,
		   NULL                                                    ATTR_CTNT7,
		   NULL                                                    ATTR_CTNT8,
		   NULL                                                    ATTR_CTNT9,
		   NULL                                                    ATTR_CTNT10,
		   NVL(NVL((SELECT DISTINCT TO_CHAR(MAX(ATB_DT),'YYYYMMDD')
           			  FROM TES_TML_SO_VVD_LIST
			         WHERE TML_SO_OFC_CTY_CD = H.TML_SO_OFC_CTY_CD
           			   AND TML_SO_SEQ = H.TML_SO_SEQ),H.TO_PRD_DT),H.WRK_DT) ATTR_CTNT11,
		   H.YD_CD                                                 ATTR_CTNT12,
		   NULL                                                    ATTR_CTNT13,
		   'COM'                                                   ATTR_CTNT14,
		   NULL                                                    ATTR_CTNT15,
		   NULL                                                    BKG_NO,
		   NULL                                                    CNTR_TPSZ_CD,
		   NULL                                                    ACT_VVD_CD,
		   NULL                                                    PLN_SCTR_DIV_CD,
		   NULL                                                    SO_CRR_CD,
		   H.YD_CD                                                 YD_CD,
		   NULL                                                    FTU_USE_CTNT1,
		   NULL                                                    FTU_USE_CTNT2,
		   NULL                                                    FTU_USE_CTNT3,
		   NULL                                                    FTU_USE_CTNT4,
		   NULL                                                    FTU_USE_CNTR5,
		   GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC(@[ofc_cd])                     CRE_DT,
		   @[cre_usr_id]                                                       CRE_USR_ID,
		   ''                                                      EAI_EVNT_DT
		 FROM   TES_TML_SO_HDR H 
		 WHERE  1=1

	#if (${vel_inv_no} != '')
	AND H.inv_no IN (
	#foreach($vel_inv_no_num IN ${vel_inv_no})
		#if($velocityCount < $vel_inv_no.size())
		'$vel_inv_no_num',
		#else
		'$vel_inv_no_num'
		#end
	#end
	)
	#else
	#end
			 AND    H.VNDR_SEQ            = @[vndr_seq]
			 AND    H.TML_INV_STS_CD      = 'C'
			 AND    NVL(H.DELT_FLG,'N')   <> 'Y'
	  )
	  GROUP BY CSR_NO, LINE_SEQ, LINE_NO, LINE_TP_LU_CD, INV_DESC, INV_TAX_CD, DTRB_COA_CO_CD, DTRB_COA_RGN_CD,
			   DTRB_COA_CTR_CD, DTRB_COA_ACCT_CD, DTRB_COA_VVD_CD, DTRB_COA_INTER_CO_CD, DTRB_COA_FTU_N1ST_CD,
			   DTRB_COA_FTU_N2ND_CD, ATTR_CATE_NM, ATTR_CTNT3, ATTR_CTNT4, ATTR_CTNT5,
			   ATTR_CTNT6, ATTR_CTNT7, ATTR_CTNT8, ATTR_CTNT9, ATTR_CTNT10, ATTR_CTNT11, ATTR_CTNT12, ATTR_CTNT13,
			   ATTR_CTNT14, ATTR_CTNT15, BKG_NO, CNTR_TPSZ_CD, ACT_VVD_CD, PLN_SCTR_DIV_CD, SO_CRR_CD,
			   YD_CD, FTU_USE_CTNT1, FTU_USE_CTNT2, FTU_USE_CTNT3, FTU_USE_CTNT4, FTU_USE_CNTR5, CRE_DT, CRE_USR_ID)			]]></sql>
			<params>
				<param name="csr_no" type="12" value="" out="N"/>
				<param name="ofc_cd" type="12" value="" out="N"/>
				<param name="cre_usr_id" type="12" value="" out="N"/>
				<param name="vndr_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
