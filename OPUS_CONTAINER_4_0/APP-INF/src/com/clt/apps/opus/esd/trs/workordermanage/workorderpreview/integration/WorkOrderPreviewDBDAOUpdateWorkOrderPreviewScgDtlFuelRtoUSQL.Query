<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="WorkOrderPreviewDBDAOUpdateWorkOrderPreviewScgDtlFuelRtoUSQL">
			<desc><![CDATA[WorkOrderPreviewDBDAOUpdateWorkOrderPreviewScgDtlFuelRto]]></desc>
			<sql><![CDATA[
UPDATE TRS_TRSP_SCG_DTL T
   SET T.FUEL_RTO =
       (SELECT DECODE(AGMT_SCG_RT_DIV_CD, 'F', '0', 'R', FUEL_SURCHARGE_RATE_OR_PERCENT, '') FUEL_SURCHARGE_RATE_OR_PERCENT
          FROM (SELECT E.TRSP_AGMT_OFC_CTY_CD
                      ,E.TRSP_AGMT_SEQ
                      ,E.TRSP_AGMT_RT_TP_SER_NO
                      ,C.TRSP_SCG_CD
                      ,CASE
                         WHEN E.TRSP_AGMT_EQ_TP_SZ_CD IS NULL THEN 9
                         WHEN E.TRSP_AGMT_EQ_TP_SZ_CD = 'ALAL' THEN 4
                         WHEN E.TRSP_AGMT_EQ_TP_SZ_CD LIKE '%AL%' THEN 2
                         WHEN E.TRSP_AGMT_EQ_TP_SZ_CD = O.EQ_TPSZ_CD THEN 1
                         ELSE 3
                       END EQ_TPSZ_PRIOR_ORDER
                      ,E.CURR_CD AS LOCAL_SCG_CURR_CD_OR_PERCENT
                      ,NVL(E.TRSP_ONE_WY_RT, E.TRSP_RND_RT) FUEL_SURCHARGE_RATE_OR_PERCENT
                      ,E.AGMT_SCG_RT_DIV_CD
                      ,C.TRSP_AGMT_SCG_NOD_SEQ
                      ,E.TRSP_AGMT_SCG_RT_SEQ
                      ,B.TRSP_BND_CD
                      ,B.SPCL_CGO_CNTR_TP_CD
                  FROM TRS_AGMT_APLY_VNDR A
                      ,TRS_AGMT_RT_TP     B
                      ,TRS_AGMT_SCG_NOD   C
                      ,TRS_AGMT_SCG_RT    E
                      ,TRS_TRSP_SVC_ORD   O
                 WHERE O.TRSP_SO_OFC_CTY_CD = @[trsp_so_ofc_cty_cd]
                   AND O.TRSP_SO_SEQ = @[trsp_so_seq]
                   AND A.TRSP_AGMT_OFC_CTY_CD = B.TRSP_AGMT_OFC_CTY_CD
                   AND A.TRSP_AGMT_SEQ = B.TRSP_AGMT_SEQ
                   AND B.TRSP_AGMT_OFC_CTY_CD = C.TRSP_AGMT_OFC_CTY_CD
                   AND B.TRSP_AGMT_SEQ = C.TRSP_AGMT_SEQ
                   AND B.TRSP_AGMT_RT_TP_SER_NO = C.TRSP_AGMT_RT_TP_SER_NO
                   AND C.TRSP_AGMT_OFC_CTY_CD = E.TRSP_AGMT_OFC_CTY_CD
                   AND C.TRSP_AGMT_SEQ = E.TRSP_AGMT_SEQ
                   AND C.TRSP_AGMT_RT_TP_SER_NO = E.TRSP_AGMT_RT_TP_SER_NO
                   AND C.TRSP_AGMT_SCG_NOD_SEQ = E.TRSP_AGMT_SCG_NOD_SEQ
                   AND B.TRSP_AGMT_OFC_CTY_CD = O.TRSP_AGMT_OFC_CTY_CD
                   AND B.TRSP_AGMT_SEQ = O.TRSP_AGMT_SEQ
                   AND C.TRSP_SCG_CD IN (SELECT INTG_CD_VAL_CTNT FROM COM_INTG_CD_DTL
                                          WHERE INTG_CD_ID = 'CD30002'
                                            AND INTG_CD_VAL_CTNT IN ('SCFAAL', 'SCFCAL'))
                   AND E.EQ_KND_CD = O.EQ_KND_CD
                   AND DECODE(O.EQ_KND_CD, 'USRAIL', '0', A.VNDR_SEQ) = DECODE(O.EQ_KND_CD, 'USRAIL', '0', O.VNDR_SEQ)
                   AND C.AGMT_ROUT_ALL_FLG = CASE
                         WHEN C.FM_NOD_CD = '0000000' AND C.TO_NOD_CD = '0000000' THEN  'Y'
                         ELSE 'N'
                       END
                   AND C.FM_NOD_CD = CASE
                         WHEN C.TRSP_SCG_CD = 'SCFAAL' THEN '0000000'
                         ELSE DECODE(LENGTH(C.FM_NOD_CD), 7, O.FM_NOD_CD, 5, SUBSTR(O.FM_NOD_CD, 1, 5))
                       END
                   AND C.VIA_NOD_CD = CASE
                         WHEN C.TRSP_SCG_CD = 'SCFAAL' THEN '0000000'
                         ELSE NVL(DECODE(LENGTH(C.VIA_NOD_CD), 7, O.VIA_NOD_CD, 5, SUBSTR(O.VIA_NOD_CD, 1, 5)), '0000000')
                       END
                   AND C.DOR_NOD_CD = CASE
                         WHEN C.TRSP_SCG_CD = 'SCFAAL' THEN '0000000'
                         ELSE NVL(DECODE(LENGTH(C.DOR_NOD_CD), 7, O.DOR_NOD_CD, 5, SUBSTR(O.DOR_NOD_CD, 1, 5)), '0000000')
                       END
                   AND C.TO_NOD_CD = CASE
                         WHEN C.TRSP_SCG_CD = 'SCFAAL' THEN '0000000'
                         ELSE DECODE(LENGTH(C.TO_NOD_CD), 7, O.TO_NOD_CD, 5, SUBSTR(O.TO_NOD_CD, 1, 5))
                       END
                   AND E.EFF_FM_DT <= O.CRE_DT
                   AND E.EFF_TO_DT >= O.CRE_DT
                   AND CASE
                         WHEN C.TRSP_SCG_CD = 'SCOWAL' THEN TRS_COMMON_PKG.GET_CONV_WGT_TO_KG_FNC(E.WGT_MEAS_UT_CD, E.TO_WGT)
                         ELSE 1
                       END > CASE
                         WHEN C.TRSP_SCG_CD = 'SCOWAL' THEN TRS_COMMON_PKG.GET_CONV_WGT_TO_KG_FNC(O.WGT_MEAS_UT_CD, O.CNTR_WGT)
                         ELSE 0
                       END
                   AND E.TRSP_AGMT_EQ_TP_SZ_CD IN (O.EQ_TPSZ_CD, SUBSTR(O.EQ_TPSZ_CD, 1, 1) || 'AL', 'AL' || SUBSTR(O.EQ_TPSZ_CD, 2, 1), 'ALAL')
                   AND CASE
                         WHEN O.TRSP_CRR_MOD_CD IN ('WD', 'WT', 'TW', 'WR', 'RW') AND O.TRSP_BND_CD = 'T' THEN DECODE(B.TRSP_BND_CD, NULL, 'T', 'A', 'T', B.TRSP_BND_CD)
                         ELSE 'T'
                       END = 'T'
                   AND (B.SPCL_CGO_CNTR_TP_CD IS NULL OR CASE
                         WHEN O.SPCL_CGO_CNTR_TP_CD IS NULL THEN B.SPCL_CGO_CNTR_TP_CD
                         ELSE O.SPCL_CGO_CNTR_TP_CD
                       END = B.SPCL_CGO_CNTR_TP_CD)
                 ORDER BY C.TRSP_SCG_CD DESC
                         ,EQ_TPSZ_PRIOR_ORDER ASC
                         ,B.CMDT_GRP_CD ASC
                         ,LENGTH(DECODE(C.FM_NOD_CD, '0000000', 'N/A', C.FM_NOD_CD)) DESC
                         ,LENGTH(DECODE(C.VIA_NOD_CD, '0000000', 'N/A', C.VIA_NOD_CD)) DESC
                         ,LENGTH(DECODE(C.DOR_NOD_CD, '0000000', 'N/A', C.DOR_NOD_CD)) DESC
                         ,LENGTH(DECODE(C.TO_NOD_CD, '0000000', 'N/A', C.TO_NOD_CD)) DESC
                         ,CASE
                            WHEN O.TRSP_CRR_MOD_CD IN ('WD', 'WT', 'TW', 'WR', 'RW') AND O.TRSP_BND_CD = 'T' THEN B.TRSP_BND_CD
                            ELSE NULL
                          END DESC
                         ,B.SPCL_CGO_CNTR_TP_CD
                         ,E.TRSP_AGMT_SCG_RT_SEQ DESC
                         ,NVL(E.TRSP_ONE_WY_RT, E.TRSP_RND_RT))
         WHERE ROWNUM = 1)
 WHERE TRSP_SO_OFC_CTY_CD = @[trsp_so_ofc_cty_cd]
   AND TRSP_SO_SEQ = @[trsp_so_seq]
   AND SUBSTR(T.LGS_COST_CD, 3, 2) = 'FU'			]]></sql>
			<params>
				<param name="trsp_so_ofc_cty_cd" type="12" value="" out="N"/>
				<param name="trsp_so_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
