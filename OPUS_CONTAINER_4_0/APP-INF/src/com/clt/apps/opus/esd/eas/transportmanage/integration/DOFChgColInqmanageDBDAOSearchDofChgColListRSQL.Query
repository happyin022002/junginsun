<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="DOFChgColInqmanageDBDAOSearchDofChgColListRSQL">
			<desc><![CDATA[searchDofChgColList SELECT LIST]]></desc>
			<sql><![CDATA[
--DOFChgColInqmanageDBDAOSearchDofChgColListRSQL
    SELECT
           ''                                AS SEQ,
           MAIN.CRE_OFC_CD,
           MAIN.BKG_NO,
           MAIN.BL_NO,
           CS.CUST_LGL_ENG_NM                AS CUST_CD,
           MAIN.CNTR_NO,
           MAIN.CNTR_TPSZ_CD,
           MAIN.POR_CD,
           MAIN.POL_CD,
           MAIN.POD_CD,
           MAIN.DEL_CD,
           TO_CHAR(MAIN.CRE_DT,'YYYY/MM/DD') AS CRE_DT,
           MAIN.CNTR_RTN_YD_CD,
           MAIN.ORG_YD_CD,
           NVL(MAIN.CURR_CD,'EUR')           AS CURR_CD,
      CASE
      WHEN MAX(NVL(MAIN.CHRR_FRT_TAX_VAL,0)) > 1000000000
      THEN MAX(NVL(MAIN.CHRR_FRT_TAX_VAL,0)) / 10000000000
      ELSE MAX(NVL(MAIN.CHRR_FRT_TAX_VAL,0))
       END                                   AS TAR_AMT,
           SUM(NVL(MAIN.TRNS_REV_AMT,0))     AS TRO_AMT,
           MAX(NVL(MAIN.TRNS_REV_AMT,0))     AS TRO_AMT_MX,
           SUM(NVL(MAIN.DIF_AMT,0))          AS DOD_AMT,
           MAX(NVL(MAIN.DIF_AMT,0))          AS DOD_AMT_MX
      FROM
         (
               SELECT
                      TMP.CRE_OFC_CD,
                      TMP.BKG_NO,
                      TMP.BL_NO,
                      TMP.CUST_CNT_CD,
                      TMP.CUST_SEQ,
                      TMP.CNTR_NO,
                      TMP.CNTR_TPSZ_CD,
                      TMP.POR_CD,
                      TMP.POL_CD,
                      TMP.POD_CD,
                      TMP.DEL_CD,
                      TMP.CRE_DT,
                      TMP.CNTR_RTN_YD_CD,
                      TMP.ORG_YD_CD,
                      TMP.CURR_CD,
                      TMP.DIF_AMT,
                      TMP.TRNS_REV_AMT,
                 CASE TRF.CONTI_CD
                 WHEN NULL
                 THEN TRF.CHRR_FRT_TAX_VAL
				 WHEN ' '
                 THEN TRF.CHRR_FRT_TAX_VAL
                 WHEN
                    (
                          SELECT
                                 LOC.CONTI_CD
                            FROM MDM_LOCATION LOC
                           WHERE LOC.DELT_FLG = 'N'
                             AND LOC.LOC_CD   = TMP.POR_CD 
                    )
                 THEN TRF.CHRR_FRT_TAX_VAL * 10000000000
                 ELSE 0
                  END AS CHRR_FRT_TAX_VAL
                 FROM
                    (
----------------------------------------------------------------------------------------------------------------------
                          SELECT
                                 BTR.CRE_OFC_CD,
                                 BTR.BKG_NO,
                                 BKG.BL_NO BL_NO,
                                 BCS.CUST_CNT_CD,
                                 BCS.CUST_SEQ,
                                 BCN.CNTR_NO,
                                 BCN.CNMV_ID_NO,
                                 BCN.CNMV_YR,
                                 BCN.CNTR_TPSZ_CD,
                                 BTR.CNTR_RTN_YD_CD,
                                 BKG.POR_CD,
                                 BKG.POL_CD,
                                 BKG.POD_CD,
                                 BKG.DEL_CD,
                                 BTR.CRE_DT,
                                 CMV.MVMT_STS_CD,
                                 CMV.ORG_YD_CD,
                                 BTR.CURR_CD,
                               (
                                 NVL (BTR.TRNS_REV_AMT, 0)
                               + NVL (BTR.NMF_TRNS_REV_AMT,0)
                               )                                AS TRNS_REV_AMT,
                                 ARM.LOCL_CURR_CD               AS AR_CURR_CD,
                                 SUM
                               (
                               (
                                     SELECT
                                            SUM (CHG_AMT * INV_XCH_RT)
                                       FROM INV_AR_CHG ARC
                                      WHERE ARC.CHG_CD   = 'DOD'
                                        AND ARC.AR_IF_NO = ARM.AR_IF_NO
                               )
                               )                               AS DIF_AMT
                            FROM BKG_EUR_TRO   BTR,
                                 BKG_BOOKING   BKG,
                                 BKG_CUSTOMER  BCS,
                                 BKG_CONTAINER BCN,
                                 CTM_MOVEMENT  CMV,
                                 INV_AR_MN     ARM
                           WHERE  1=1
						    #if( ${ctrl_ofc_cd} != '' )
							AND    BTR.CRE_OFC_CD = @[ctrl_ofc_cd]
							#end
							#if ( ${search_choice} == 'MM' )
							AND    TO_CHAR(BTR.CRE_DT,'YYYYMM')= @[tromonth]
							#else
							AND    TO_CHAR(BTR.CRE_DT,'YYYYMMDD') >= @[fromtrodate]
							AND    TO_CHAR(BTR.CRE_DT,'YYYYMMDD') <= @[totrodate] + 0.999
							#end
                             AND BTR.HLG_TP_CD                    = 'M'
                             AND BTR.IO_BND_CD                    = 'I'
                             AND BTR.BKG_NO                       = BKG.BKG_NO
                             AND BTR.BKG_NO                       = BCN.BKG_NO
                             AND BTR.BKG_NO                       = BCS.BKG_NO
                             AND SUBSTR (BTR.CNTR_RTN_YD_CD,1,5) != BKG.POD_CD
                             AND BTR.CNTR_NO    = BCN.CNTR_NO
                             AND BCN.CNTR_NO    = CMV.CNTR_NO
                             AND BCN.CNMV_ID_NO = CMV.CNMV_ID_NO
                             AND BCN.CNMV_YR    = CMV.CNMV_YR
                             AND BTR.BKG_NO     = ARM.BKG_NO(+)
                             AND BTR.IO_BND_CD  = ARM.IO_BND_CD(+)
                             AND BCS.BKG_CUST_TP_CD
                               =
                               (
                                     SELECT
                                            MIN (BCS2.BKG_CUST_TP_CD)
                                       FROM BKG_CUSTOMER BCS2
                                      WHERE BCS2.BKG_NO = BCS.BKG_NO
                                        AND BCS2.BKG_CUST_TP_CD
                                         IN
                                          (
                                            'C','N'
                                          )
                               )
                        GROUP BY BTR.CRE_OFC_CD,
                                 BTR.BKG_NO,
                                 BKG.BL_NO,
                                 BCS.CUST_CNT_CD,
                                 BCS.CUST_SEQ,
                                 BCN.CNTR_NO,
                                 BCN.CNMV_ID_NO,
                                 BCN.CNMV_YR,
                                 BCN.CNTR_TPSZ_CD,
                                 BTR.CNTR_RTN_YD_CD,
                                 BKG.POR_CD,
                                 BKG.POL_CD,
                                 BKG.POD_CD,
                                 BKG.DEL_CD,
                                 BTR.CRE_DT,
                                 CMV.MVMT_STS_CD,
                                 CMV.ORG_YD_CD,
                                 BTR.CURR_CD,
                               (
                                 NVL (BTR.TRNS_REV_AMT, 0)
                               + NVL (BTR.NMF_TRNS_REV_AMT,0)
                               ) ,
                                 ARM.LOCL_CURR_CD
----------------------------------------------------------------------------------------------------------------------
                    ) TMP,
                    (
                          SELECT
                                 X.EFF_DT,
                                 X.FM_LOC_CD,
                                 X.CONTI_CD,
                                 X.CNT_CD,
                                 X.CUST_SEQ,
                                 X.CNTR_TP_CD,
                                 X.CHRR_FRT_TAX_VAL,
                                 X.CURR_CD
                            FROM TRS_DRFF_CHG_TRF X,
                               (
                                     SELECT
                                            FM_LOC_CD,
                                            CNT_CD,
                                            CUST_SEQ,
                                            MAX (EFF_DT) EFF_DT
                                       FROM TRS_DRFF_CHG_TRF
                                   GROUP BY FM_LOC_CD,
                                            CNT_CD,
                                            CUST_SEQ
                               ) Y
                           WHERE  X.EFF_DT    = Y.EFF_DT
                             AND X.FM_LOC_CD = Y.FM_LOC_CD
                             AND X.CNT_CD    = Y.CNT_CD
                             AND X.CUST_SEQ  = Y.CUST_SEQ
                    ) TRF
                WHERE SUBSTR(TMP.CNTR_RTN_YD_CD,1,5) = TRF.FM_LOC_CD(+)
                  AND NVL(TMP.CUST_CNT_CD,'CO')      = TRF.CNT_CD(+)
                  AND NVL(TMP.CUST_SEQ,0) = TRF.CUST_SEQ(+)
                  AND TMP.CNTR_TPSZ_CD = TRF.CNTR_TP_CD(+)
                  AND TRF.CUST_SEQ IS NOT NULL
                UNION
               SELECT
                      XXX.CRE_OFC_CD,
                      XXX.BKG_NO,
                      XXX.BL_NO,
                      XXX.CUST_CNT_CD,
                      XXX.CUST_SEQ,
                      XXX.CNTR_NO,
                      XXX.CNTR_TPSZ_CD,
                      XXX.POR_CD,
                      XXX.POL_CD,
                      XXX.POD_CD,
                      XXX.DEL_CD,
                      XXX.CRE_DT,
                      XXX.CNTR_RTN_YD_CD,
                      XXX.ORG_YD_CD,
                      XXX.CURR_CD,
                      XXX.DIF_AMT,
                      XXX.TRNS_REV_AMT,
                 CASE YYY.CONTI_CD
                 WHEN NULL
                 THEN YYY.CHRR_FRT_TAX_VAL
                 WHEN ' '
                 THEN YYY.CHRR_FRT_TAX_VAL
                 WHEN
                    (
                          SELECT
                                 LOC.CONTI_CD
                            FROM MDM_LOCATION LOC
                           WHERE LOC.DELT_FLG = 'N'
                             AND LOC.LOC_CD   = XXX.POR_CD 
                    )
                 THEN YYY.CHRR_FRT_TAX_VAL * 10000000000
                 ELSE 0
                  END AS CHRR_FRT_TAX_VAL
                 FROM
                    (
                          SELECT
                                 TMP.CRE_OFC_CD,
                                 TMP.BKG_NO,
                                 TMP.BL_NO,
                                 TMP.CUST_CNT_CD,
                                 TMP.CUST_SEQ,
                                 TMP.CNTR_NO,
                                 TMP.CNMV_ID_NO,
                                 TMP.CNMV_YR,
                                 TMP.CNTR_TPSZ_CD,
                                 TMP.CNTR_RTN_YD_CD,
                                 TMP.POR_CD,
                                 TMP.POL_CD,
                                 TMP.POD_CD,
                                 TMP.DEL_CD,
                                 TMP.CRE_DT,
                                 TMP.MVMT_STS_CD,
                                 TMP.ORG_YD_CD,
                                 TMP.CURR_CD,
                                 TMP.TRNS_REV_AMT,
                                 TMP.AR_CURR_CD,
                                 TMP.DIF_AMT
                            FROM
                               (
----------------------------------------------------------------------------------------------------------------------
                          SELECT
                                 BTR.CRE_OFC_CD,
                                 BTR.BKG_NO,
                                 BKG.BL_NO BL_NO,
                                 BCS.CUST_CNT_CD,
                                 BCS.CUST_SEQ,
                                 BCN.CNTR_NO,
                                 BCN.CNMV_ID_NO,
                                 BCN.CNMV_YR,
                                 BCN.CNTR_TPSZ_CD,
                                 BTR.CNTR_RTN_YD_CD,
                                 BKG.POR_CD,
                                 BKG.POL_CD,
                                 BKG.POD_CD,
                                 BKG.DEL_CD,
                                 BTR.CRE_DT,
                                 CMV.MVMT_STS_CD,
                                 CMV.ORG_YD_CD,
                                 BTR.CURR_CD,
                               (
                                 NVL (BTR.TRNS_REV_AMT, 0)
                               + NVL (BTR.NMF_TRNS_REV_AMT,0)
                               )                                AS TRNS_REV_AMT,
                                 ARM.LOCL_CURR_CD               AS AR_CURR_CD,
                                 SUM
                               (
                               (
                                     SELECT
                                            SUM (CHG_AMT * INV_XCH_RT)
                                       FROM INV_AR_CHG ARC
                                      WHERE ARC.CHG_CD   = 'DOD'
                                        AND ARC.AR_IF_NO = ARM.AR_IF_NO
                               )
                               )                               AS DIF_AMT
                            FROM BKG_EUR_TRO   BTR,
                                 BKG_BOOKING   BKG,
                                 BKG_CUSTOMER  BCS,
                                 BKG_CONTAINER BCN,
                                 CTM_MOVEMENT  CMV,
                                 INV_AR_MN     ARM
                           WHERE  1=1
						    #if( ${ctrl_ofc_cd} != '' )
							AND    BTR.CRE_OFC_CD = @[ctrl_ofc_cd]
							#end
							#if( ${search_choice} == 'MM' )
							AND    TO_CHAR(BTR.CRE_DT,'YYYYMM')= @[tromonth]
							#else
							AND    TO_CHAR(BTR.CRE_DT,'YYYYMMDD') >= @[fromtrodate]
							AND    TO_CHAR(BTR.CRE_DT,'YYYYMMDD') <= @[totrodate] + 0.999
							#end
                             AND BTR.HLG_TP_CD                    = 'M'
                             AND BTR.IO_BND_CD                    = 'I'
                             AND BTR.BKG_NO                       = BKG.BKG_NO
                             AND BTR.BKG_NO                       = BCN.BKG_NO
                             AND BTR.BKG_NO                       = BCS.BKG_NO
                             AND SUBSTR (BTR.CNTR_RTN_YD_CD,1,5) != BKG.POD_CD
                             AND BTR.CNTR_NO    = BCN.CNTR_NO
                             AND BCN.CNTR_NO    = CMV.CNTR_NO
                             AND BCN.CNMV_ID_NO = CMV.CNMV_ID_NO
                             AND BCN.CNMV_YR    = CMV.CNMV_YR
                             AND BTR.BKG_NO     = ARM.BKG_NO(+)
                             AND BTR.IO_BND_CD  = ARM.IO_BND_CD(+)
                             AND BCS.BKG_CUST_TP_CD
                               =
                               (
                                     SELECT
                                            MIN (BCS2.BKG_CUST_TP_CD)
                                       FROM BKG_CUSTOMER BCS2
                                      WHERE BCS2.BKG_NO = BCS.BKG_NO
                                        AND BCS2.BKG_CUST_TP_CD
                                         IN
                                          (
                                            'C','N'
                                          )
                               )
                        GROUP BY BTR.CRE_OFC_CD,
                                 BTR.BKG_NO,
                                 BKG.BL_NO,
                                 BCS.CUST_CNT_CD,
                                 BCS.CUST_SEQ,
                                 BCN.CNTR_NO,
                                 BCN.CNMV_ID_NO,
                                 BCN.CNMV_YR,
                                 BCN.CNTR_TPSZ_CD,
                                 BTR.CNTR_RTN_YD_CD,
                                 BKG.POR_CD,
                                 BKG.POL_CD,
                                 BKG.POD_CD,
                                 BKG.DEL_CD,
                                 BTR.CRE_DT,
                                 CMV.MVMT_STS_CD,
                                 CMV.ORG_YD_CD,
                                 BTR.CURR_CD,
                               (
                                 NVL (BTR.TRNS_REV_AMT, 0)
                               + NVL (BTR.NMF_TRNS_REV_AMT,0)
                               ) ,
                                 ARM.LOCL_CURR_CD
----------------------------------------------------------------------------------------------------------------------
                               ) TMP,
                               (
                                     SELECT
                                            X.EFF_DT,
                                            X.FM_LOC_CD,
                                            X.CONTI_CD,
                                            X.CNT_CD,
                                            X.CUST_SEQ,
                                            X.CNTR_TP_CD,
                                            X.CHRR_FRT_TAX_VAL,
                                            X.CURR_CD
                                       FROM TRS_DRFF_CHG_TRF X,
                                          (
                                                SELECT
                                                       FM_LOC_CD,
                                                       CNT_CD,
                                                       CUST_SEQ,
                                                       MAX (EFF_DT) EFF_DT
                                                  FROM TRS_DRFF_CHG_TRF
                                              GROUP BY FM_LOC_CD, CNT_CD, CUST_SEQ
                                          ) Y
                                      WHERE X.EFF_DT = Y.EFF_DT
                                        AND X.FM_LOC_CD = Y.FM_LOC_CD
                                        AND X.CNT_CD = Y.CNT_CD
                                        AND X.CUST_SEQ = Y.CUST_SEQ
                               ) TRF
                           WHERE SUBSTR (TMP.CNTR_RTN_YD_CD,1,5) = TRF.FM_LOC_CD(+)
                             AND NVL (TMP.CUST_CNT_CD,'CO') = TRF.CNT_CD(+)
                             AND NVL (TMP.CUST_SEQ,0) = TRF.CUST_SEQ(+)
                             AND TMP.CNTR_TPSZ_CD = TRF.CNTR_TP_CD(+)
                             AND TRF.CUST_SEQ IS NULL
                   ) XXX,
                   (
                         SELECT
                                S.EFF_DT EFF_DT,
                                S.FM_LOC_CD FM_LOC_CD,
                                S.CONTI_CD CONTI_CD,
                                S.CNT_CD CNT_CD,
                                S.CUST_SEQ CUST_SEQ,
                                S.CNTR_TP_CD CNTR_TP_CD,
                                S.CHRR_FRT_TAX_VAL CHRR_FRT_TAX_VAL,
                                S.CURR_CD CURR_CD
                           FROM TRS_DRFF_CHG_TRF S,
                              (
                                    SELECT
                                           FM_LOC_CD,
                                           CNT_CD,
                                           CUST_SEQ,
                                           MAX (EFF_DT) EFF_DT
                                      FROM TRS_DRFF_CHG_TRF
                                  GROUP BY FM_LOC_CD, CNT_CD,
                                           CUST_SEQ
                               ) T
                           WHERE S.EFF_DT = T.EFF_DT
                             AND S.FM_LOC_CD = T.FM_LOC_CD
                             AND S.CNT_CD = T.CNT_CD
                             AND S.CUST_SEQ = T.CUST_SEQ
                    ) YYY
                WHERE SUBSTR (XXX.CNTR_RTN_YD_CD,1,5) = YYY.FM_LOC_CD(+)
                  AND 'CO' = YYY.CNT_CD(+)
                  AND 0 = YYY.CUST_SEQ(+)
                  AND XXX.CNTR_TPSZ_CD = YYY.CNTR_TP_CD(+)
         ) MAIN,
         MDM_CUSTOMER CS
	 WHERE 1=1
	 #if ( ${return_cy} != '' )
	 AND MAIN.CNTR_RTN_YD_CD LIKE @[return_cy]||'%'
	 #end
	 #if ( ${cust_cd} != '' )
	 AND   MAIN.CUST_CNT_CD||MAIN.CUST_SEQ = @[cust_cd]
	 #end
     AND MAIN.CUST_CNT_CD = CS.CUST_CNT_CD(+)
     AND MAIN.CUST_SEQ = CS.CUST_SEQ(+)
GROUP BY MAIN.CRE_OFC_CD,
         MAIN.BKG_NO,
         MAIN.BL_NO,
         CS.CUST_LGL_ENG_NM,
         CS.CUST_LGL_ENG_NM,
         MAIN.CNTR_NO,
         MAIN.CNTR_TPSZ_CD,
         MAIN.POR_CD,
         MAIN.POL_CD,
         MAIN.POD_CD,
         MAIN.DEL_CD,
         MAIN.CRE_DT,
         MAIN.CNTR_RTN_YD_CD,
         MAIN.ORG_YD_CD,
         NVL(MAIN.CURR_CD,'EUR')			]]></sql>
			<params>
				<param name="ctrl_ofc_cd" type="12" value="" out="N"/>
				<param name="tromonth" type="12" value="" out="N"/>
				<param name="fromtrodate" type="12" value="" out="N"/>
				<param name="totrodate" type="12" value="" out="N"/>
				<param name="return_cy" type="12" value="" out="N"/>
				<param name="cust_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
