<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="StatusInquiryDBDAOSearchInformationOnPendingTPBRSQL">
			<desc><![CDATA[Search Information On Pending TPB]]></desc>
			<sql><![CDATA[
SELECT title, cnt, amt
  FROM (
          SELECT NVL(TITLE,'(Total)') title
                ,NVL(SUM(CNT),0) cnt, NVL(SUM(AMT),0.00) amt, MAX(NO) sort
            FROM (
        --		2009-04-09 O Wan0Ki      1.8 N200903170210, S/O Cancel Notice 추가.
            ------ FOR S/O Cancellation Notice -------------------------
                    SELECT 0 no
                          ,'For Cancellation Notice' title
                          ,COUNT(0) CNT
                          ,SUM( TPB_GET_USD_AMT_FNC( c.if_amt, c.if_curr_cd, SYSDATE ) ) AMT
                      FROM TPB_OTS_DTL c
                          ,(
                              SELECT so_no, if_ofc_cd, src_if_seq_no, if_amt, ofc_cd
                                FROM TPB_OTS_DTL
                               WHERE n3pty_delt_tp_cd = 'N'
                                 AND cxl_flg IS NULL
                           ) d
                     WHERE 1 = 1
                       AND c.n3pty_delt_tp_cd = 'N'
                       AND c.n3pty_bil_tp_cd IN (SELECT n3pty_bil_tp_cd FROM TPB_N3RD_PTY_BIL_TP WHERE act_flg='Y' AND n3pty_bil_tp_cd!='JO')
                       AND c.cxl_flg = 'Y'
                       AND d.so_no = c.so_no
                       AND d.if_ofc_cd = c.if_ofc_cd
                       AND d.src_if_seq_no = c.src_if_seq_no
                       AND d.if_amt = c.if_amt
                       AND NVL(d.ofc_cd,c.if_ofc_cd) IN (@[user_ofc_cd])
                 UNION ALL
            ------ FOR CONFIRMATION -------------------------
                    SELECT 1 no
                          ,'For Confirmation' title
                          ,COUNT(0) CNT
                          ,SUM( TPB_GET_USD_AMT_FNC( IF_AMT, IF_CURR_CD, SYSDATE ) ) AMT
                      FROM TPB_OTS_DTL A
                     WHERE 1 = 1
                       AND A.n3pty_delt_tp_cd IN ('N','S')
                       AND A.n3pty_bil_tp_cd IN ( SELECT n3pty_bil_tp_cd FROM TPB_N3RD_PTY_BIL_TP WHERE act_flg = 'Y' AND n3pty_bil_tp_cd <> 'JO' )
                       AND N3PTY_CFM_CD IN ('I','R')  -- 'N', 'Y'
                       AND A.OFC_CD IN (@[user_ofc_cd]) --- TPB OFFICE
        		--2009-06-25 O Wan-Ki      1.9 [S1V-09P-001] TPB Restructuring 2단계 (Invoice 부분) 보완개발 추가요청 처리.
                       AND A.cxl_flg IS NULL
                 UNION ALL
            ------ FOR INVOICE -------------------------
                    SELECT 2 no
                          ,'For Invoicing' title
                          ,COUNT(0) CNT
                          ,SUM( TPB_GET_USD_AMT_FNC( BAL_AMT, CURR_CD, SYSDATE ) ) AMT
                      FROM TPB_OTS_GRP B, TPB_OTS_GRP_STS C
                     WHERE 1 = 1
                       AND B.n3pty_bil_tp_cd IN ( SELECT n3pty_bil_tp_cd FROM TPB_N3RD_PTY_BIL_TP WHERE act_flg = 'Y' AND n3pty_bil_tp_cd <> 'JO' )
                       AND b.n3pty_no = c.n3pty_no
                       AND C.ots_sts_lst_flg = 'Y'
                       AND B.n3pty_delt_tp_cd IN ('N')
                       AND C.OTS_STS_CD IN ('O','M','J')
                       AND B.VNDR_CUST_DIV_CD IN ('V','C')
                       AND B.ofc_cd IN (@[user_ofc_cd])
                 UNION ALL
            ------ FOR ERP I/F -------------------------
                    SELECT 3 no
                          ,'For ERP I/F' title
                          ,COUNT(0) CNT
                          ,SUM( TPB_GET_USD_AMT_FNC( BAL_AMT, CURR_CD, CFM_DT ) ) AMT
                      FROM TPB_OTS_GRP B, TPB_OTS_GRP_STS C
                     WHERE 1 = 1
                       AND B.n3pty_bil_tp_cd IN ( SELECT n3pty_bil_tp_cd FROM TPB_N3RD_PTY_BIL_TP WHERE act_flg = 'Y' AND n3pty_bil_tp_cd <> 'JO' )
                       AND b.n3pty_no = c.n3pty_no
                       AND C.ots_sts_lst_flg = 'Y'
                       AND B.n3pty_delt_tp_cd IN ('N')
                       AND C.OTS_STS_CD IN ('I')
                       AND B.ofc_cd IN (@[user_ofc_cd])
                 UNION ALL
            ------ FOR ROC -------------------------
                    SELECT 4 no
                          ,'For ROC Request' title
                          ,COUNT(0) CNT
                          ,SUM( TPB_GET_USD_AMT_FNC( BAL_AMT, CURR_CD, CFM_DT ) ) AMT
                      FROM TPB_OTS_GRP B, TPB_OTS_GRP_STS C
                     WHERE 1 = 1
                       AND B.n3pty_bil_tp_cd IN ( SELECT n3pty_bil_tp_cd FROM TPB_N3RD_PTY_BIL_TP WHERE act_flg = 'Y' AND n3pty_bil_tp_cd <> 'JO' )
                       AND b.n3pty_no = c.n3pty_no
                       AND C.ots_sts_lst_flg = 'Y'
                       AND B.n3pty_delt_tp_cd IN ('N')
                       AND C.OTS_STS_CD IN ('O')
                       AND B.VNDR_CUST_DIV_CD IN ('S')
                       AND B.ofc_cd IN (@[user_ofc_cd])
                 UNION ALL
            ------ FOR ROC APPROVAL -------------------------
                    SELECT 5 no
                          ,'For ROC Approval' title
                          ,COUNT(0) CNT
                          ,SUM( TPB_GET_USD_AMT_FNC( BAL_AMT, CURR_CD, CFM_DT ) ) AMT
                      FROM TPB_OTS_GRP B, TPB_OTS_GRP_STS C, TPB_ADJ_STS E
                     WHERE 1 = 1
                       AND b.n3pty_no = c.n3pty_no
                       AND B.n3pty_no = E.n3pty_no
                       AND B.n3pty_bil_tp_cd IN ( SELECT n3pty_bil_tp_cd FROM TPB_N3RD_PTY_BIL_TP WHERE act_flg = 'Y' AND n3pty_bil_tp_cd <> 'JO' )
                       AND B.n3pty_delt_tp_cd IN ('N')
                       AND C.ots_sts_lst_flg = 'Y'
                       AND E.STL_STS_LST_FLG = 'Y'
                       AND C.OTS_STS_CD IN ('R')
                       AND E.N3PTY_STL_TP_CD IN ('O')
                       AND STL_TO_CLT_CNG_OFC_CD IN (@[user_ofc_cd])
                       AND E.STL_APRO_DT IS NULL AND E.STL_RJCT_DT IS NULL
               ) X
         WHERE 1 = 1
      GROUP BY ROLLUP(TITLE)
       )
 ORDER BY decode(title,'(Total)',6,sort)			]]></sql>
			<params>
				<param name="user_ofc_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
