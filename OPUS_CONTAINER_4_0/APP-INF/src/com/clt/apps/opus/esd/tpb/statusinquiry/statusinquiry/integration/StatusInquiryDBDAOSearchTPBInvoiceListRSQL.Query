<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="StatusInquiryDBDAOSearchTPBInvoiceListRSQL">
			<desc><![CDATA[TPB -> Status & Performance -> TPB Invoice Inquiry]]></desc>
			<sql><![CDATA[
##${s_trd_party_val}
SELECT V.OFC_CD
      ,D.N3PTY_NO
      ,R.N3PTY_INV_NO
      ,R.N3PTY_INV_RVIS_CD
      ,R.IF_BL_NO
      ,(SELECT N3PTY_EXPN_TP_CD FROM TPB_N3RD_PTY_BIL_TP WHERE N3PTY_BIL_TP_CD = D.N3PTY_BIL_TP_CD) AS N3PTY_EXPN_TP_CD
      ,R.CURR_CD
      ,R.NET_AMT AS OTS_AMT
      ,R.VAT_AMT
      ,R.INV_AMT
      ,R.CLT_AMT
      ,TO_CHAR(TPB_GET_LCL_DATE_FNC(R.INV_ISS_LOCL_DT,@[s_usr_ofc_cd]),'YYYY-MM-DD HH24:MI') AS INV_ISS_LOCL_DT
      ,R.UPD_USR_ID
      ,R.CLT_AGN_FLG
      ,R.VNDR_CUST_NM AS TRD_PARTY_NM
      ,TO_CHAR(TPB_GET_LCL_DATE_FNC(R.AR_IF_DT,@[s_usr_ofc_cd]),'YYYY-MM-DD HH24:MI') AS AR_IF_DT
      ,(SELECT COUNT(DISTINCT N3PTY_BIL_TP_CD) FROM TPB_INV_RVIS_DTL S WHERE S.N3PTY_INV_NO = R.N3PTY_INV_NO AND S.N3PTY_INV_RVIS_SEQ = R.N3PTY_INV_RVIS_SEQ) AS LENGTH_N3PTY_BIL_TP_CD
      ,R.VNDR_CUST_DIV_CD
      ,CASE R.VNDR_CUST_DIV_CD WHEN 'V' THEN TO_CHAR(R.VNDR_SEQ)
                               WHEN 'C' THEN R.CUST_CNT_CD||R.CUST_SEQ
       END AS TRD_PARTY_CODE
      ,R.N3PTY_INV_RVIS_SEQ N3PTY_INV_HIS_SEQ
	  ,( SELECT B.CNT_CD
           FROM MDM_ORGANIZATION A, 
                MDM_LOCATION B
          WHERE A.LOC_CD=B.LOC_CD
            AND A.OFC_CD=V.OFC_CD
            AND A.DELT_FLG='N'
            AND B.DELT_FLG='N'
            AND ROWNUM = 1 ) AS CNT_CD
  FROM TPB_INVOICE V, 
       TPB_INV_RVIS R,
       TPB_INV_RVIS_DTL D
 WHERE 1 = 1
   AND V.N3PTY_INV_NO = R.N3PTY_INV_NO
   AND R.N3PTY_INV_NO = D.N3PTY_INV_NO
   AND R.N3PTY_INV_RVIS_SEQ = D.N3PTY_INV_RVIS_SEQ
   AND D.N3PTY_INV_RVIS_DTL_SEQ = 1
   AND D.N3PTY_BIL_TP_CD != 'JO'
#if (${s_cond} == '1') 
--invoiced date
   AND R.INV_ISS_LOCL_DT >= TPB_GET_SRCH_DATE_FNC(@[s_sdate],'YYYY-MM-DD',@[s_usr_ofc_cd])
   AND R.INV_ISS_LOCL_DT < TPB_GET_SRCH_DATE_FNC(@[s_edate],'YYYY-MM-DD',@[s_usr_ofc_cd]) + 1
   AND V.OFC_CD IN (
                       SELECT OFC_CD
                         FROM TPB_HNDL_OFC
                        WHERE N3PTY_OFC_TP_CD = 'T' AND DELT_FLG = 'N'
	#if (${s_if_rhq_cd} != '') 
                          AND RHQ_CD = @[s_if_rhq_cd]
    #end
    #if (${s_if_ctrl_cd} != '')
                          AND N3PTY_CTRL_OFC_CD = @[s_if_ctrl_cd]
    #end
    #if (${s_if_ofc_cd} != '')
                          AND OFC_CD = @[s_if_ofc_cd]
    #end
                   )

#elseif (${s_cond} == '2')
--invoice No.
   AND R.N3PTY_INV_NO = SUBSTRB(@[s_n3pty_inv_no_for_search],1,11)
	#if (${s_n3pty_inv_rmd_cd_for_search} != '')
   AND R.N3PTY_INV_RVIS_CD LIKE @[s_n3pty_inv_rmd_cd_for_search]||'%'
	#end 
#elseif (${s_cond} == '3')
--EQ No.
   AND EXISTS (
                SELECT S.N3PTY_INV_NO
                  FROM TPB_INV_RVIS_DTL S
                 WHERE S.EQ_NO = @[s_eq_no]
                   AND S.N3PTY_INV_NO = R.N3PTY_INV_NO
                   AND S.N3PTY_DELT_TP_CD = 'N'
              )
#end
		
--Collection Agency
#if (${s_clt_agn_flg} == 'E') 
--Excluding
   AND R.CLT_AGN_FLG = 'N'  
#elseif (${s_clt_agn_flg} == 'O')
--Only
   AND R.CLT_AGN_FLG = 'Y'  
#end

--ERP I/F

#if (${s_n3pty_inv_sts_cd} == 'E')
--Excluding
   AND R.N3PTY_INV_STS_CD = 'N'  
#elseif (${s_n3pty_inv_sts_cd} == 'O')
--Only
   AND R.N3PTY_INV_STS_CD <> 'N'  
#end

--- 3rd Party --- 
#if (${s_vndr_cust_div_cd} != '')
   AND R.VNDR_CUST_DIV_CD = @[s_vndr_cust_div_cd]
	#if (${s_trd_party_val} != '')
		#if (${s_vndr_cust_div_cd} == 'V')
   AND R.VNDR_SEQ = TO_NUMBER(@[s_trd_party_val])
		#elseif (${s_vndr_cust_div_cd} == 'C')
   AND R.CUST_CNT_CD = SUBSTRB(TRIM(@[s_trd_party_val]),1,2)
			#if ($s_trd_party_val.length() > 2)
   AND R.CUST_SEQ = TO_NUMBER(SUBSTRB(TRIM(@[s_trd_party_val]),3))
			#end
		#elseif (${s_vndr_cust_div_cd} == 'S')
   AND 'Y' = @[s_trd_party_val]
		#end
	#end
#end

-- search version value - A/O/C/R/L
#if (${s_invce_search_version} == 'O')
--ORG
   AND R.N3PTY_INV_RVIS_CD = 'ORG'
#elseif (${s_invce_search_version} == 'C')
--Cxx
   AND R.N3PTY_INV_RVIS_CD LIKE 'C%'
#elseif (${s_invce_search_version} == 'R')
--Rxx
   AND R.N3PTY_INV_RVIS_CD LIKE 'R%'
#elseif (${s_invce_search_version} == 'L')
--Last Version
   AND V.LST_N3PTY_INV_RVIS_SEQ = R.N3PTY_INV_RVIS_SEQ
#end

ORDER BY R.N3PTY_INV_NO ASC, R.N3PTY_INV_RVIS_SEQ ASC			]]></sql>
			<params>
				<param name="s_usr_ofc_cd" type="12" value="" out="N"/>
				<param name="s_sdate" type="12" value="" out="N"/>
				<param name="s_edate" type="12" value="" out="N"/>
				<param name="s_if_rhq_cd" type="12" value="" out="N"/>
				<param name="s_if_ctrl_cd" type="12" value="" out="N"/>
				<param name="s_if_ofc_cd" type="12" value="" out="N"/>
				<param name="s_n3pty_inv_no_for_search" type="12" value="" out="N"/>
				<param name="s_n3pty_inv_rmd_cd_for_search" type="12" value="" out="N"/>
				<param name="s_eq_no" type="12" value="" out="N"/>
				<param name="s_vndr_cust_div_cd" type="12" value="" out="N"/>
				<param name="s_trd_party_val" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
