<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="ProductCatalogCreateDBDAOUpdatePrdMapReInitUSQLUSQL">
			<desc><![CDATA[구주 지역 DOOR 다른 경우 처리를 위한 MAP DATA UPDATE]]></desc>
			<sql><![CDATA[
UPDATE PRD_BKG_COP_MAP MAP SET (MAP.COP_PATT_ORD_NO,MAP.OB_ITCHG_CTNT, MAP.IB_ITCHG_CTNT, MAP.OCN_ITCHG_CTNT) = 
                               (
                                SELECT ORD,PRD_GET_COP_BND_SO_STR_FNC(COP_NO,'0'), PRD_GET_COP_BND_SO_STR_FNC(COP_NO,'I'),PRD_GET_COP_BND_SO_STR_FNC(COP_NO,'T') 
                                FROM 
                                (
                                SELECT COP_NO,(CASE WHEN EUR_OB_FLG ='N' AND EUR_IB_FLG ='N' THEN NULL
                                                     ELSE DENSE_RANK() OVER ( ORDER BY  FULL_RK DESC NULLS LAST , FULL_ROUT )
                                               END) ORD
                                FROM (
                                    SELECT COP_NO,EUR_OB_FLG,EUR_IB_FLG, 
                                           (CASE WHEN EUR_OB_FLG ='N' AND EUR_IB_FLG ='N' 
                                                  THEN NULL
                                                  ELSE COUNT(*) OVER (PARTITION BY MTY_PKUP_YD_CD,MTY_RTN_YD_CD,EUR_OB_FLG,POL_TML_DIFF_FLG,EUR_IB_FLG,POD_TML_DIFF_FLG,OUTBOUND,INBOUND  )
                                            END) FULL_RK,
                                           MTY_PKUP_YD_CD||MTY_RTN_YD_CD||EUR_OB_FLG||POL_TML_DIFF_FLG||EUR_IB_FLG||POD_TML_DIFF_FLG||OUTBOUND||INBOUND FULL_ROUT
                                    FROM 
                                    (
                                        SELECT 
                                        M.COP_NO,
                                        M2.MTY_PKUP_YD_CD,M2.MTY_RTN_YD_CD,
                                        (CASE WHEN (SELECT CONTI_CD FROM MDM_LOCATION WHERE LOC_CD = SUBSTR(B.POR_NOD_CD,1,5)) ='E'
                                                    AND H.OB_TRO_FLG ='Y' AND H.POR_NOD_CD <> B.POR_NOD_CD 
                                        THEN 'Y'
                                        ELSE 'N'
                                        END) EUR_OB_FLG,
                                        DECODE(M3.POL_NOD_CD,M2.POL_NOD_CD,'N','Y') POL_TML_DIFF_FLG,
                                        (CASE WHEN (SELECT CONTI_CD FROM MDM_LOCATION WHERE LOC_CD = SUBSTR(B.DEL_NOD_CD,1,5)) ='E'
                                                    AND H.IB_TRO_FLG ='Y' AND H.DEL_NOD_CD <> B.DEL_NOD_CD 
                                        THEN 'Y'
                                        ELSE 'N'
                                        END) EUR_IB_FLG,
                                        DECODE(M3.POD_NOD_CD,M2.POD_NOD_CD,'N','Y') POD_TML_DIFF_FLG,
                                        (SELECT ROUT_ORG_NOD_CD||ROUT_DEST_NOD_CD||ROUT_SEQ 
                                          FROM PRD_PROD_CTL_ROUT_DTL 
                                          WHERE PCTL_NO =H.PCTL_NO
                                          AND PCTL_SEQ =1) OUTBOUND,
                                        (SELECT ROUT_ORG_NOD_CD||ROUT_DEST_NOD_CD||ROUT_SEQ 
                                          FROM PRD_PROD_CTL_ROUT_DTL 
                                          WHERE PCTL_NO =H.PCTL_NO
                                          AND PCTL_IO_BND_CD ='I'
                                          AND ROWNUM =1) INBOUND
                                        FROM PRD_BKG_COP_MAP M, BKG_BOOKING B, SCE_COP_HDR H, PRD_PROD_CTL_MST M2,PRD_PROD_CTL_MST M3
                                        WHERE M.BKG_NO =@[bkg_no]
                                        AND M.COP_MAPG_SEQ =@[mapSeq]
                                        AND M.BKG_NO = B.BKG_NO
                                        AND M.COP_NO = H.COP_NO
                                        AND M.PCTL_NO = M3.PCTL_NO
                                        AND H.PCTL_NO =M2.PCTL_NO
                                    ) A
                                  )
                                )X 
                              WHERE X.COP_NO =MAP.COP_NO
                              )
WHERE MAP.BKG_NO =@[bkg_no]
AND MAP.COP_MAPG_SEQ =@[mapSeq]			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
				<param name="mapSeq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
