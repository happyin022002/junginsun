<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="WorkOrderManagementDBDAOInsertTrsSubStsHisForCntrAttachCSQL">
			<desc><![CDATA[WorkOrderManagementDBDAOInsertTrsSubStsHisForCntrAttach]]></desc>
			<sql><![CDATA[
INSERT INTO TRS_SUB_STS_HIS
  (TRSP_SO_OFC_CTY_CD
  ,TRSP_SO_SEQ
  ,HIS_SEQ
  ,PRE_TRSP_SUB_STS_CD
  ,CRNT_TRSP_SUB_STS_CD
  ,CRE_USR_ID
  ,CRE_DT
  ,UPD_USR_ID
  ,UPD_DT)
  SELECT TRSP_SO_OFC_CTY_CD
        ,TRSP_SO_SEQ
        ,TRS_SUB_STS_HIS_SEQ1.NEXTVAL AS HIS_SEQ
        ,SO.TRS_SUB_STS_CD
        ,(CASE 	WHEN MV.MVMT_STS_CD IN ('EN', 'TN', 'OP', 'ID') AND MV.ORG_YD_CD = SO.FM_NOD_CD THEN 'ST'
           		WHEN MV.MVMT_STS_CD IN ('OC', 'IC', 'MT') AND MV.ORG_YD_CD = SO.TO_NOD_CD THEN	'CM'
           		ELSE SO.TRS_SUB_STS_CD
         END)
        ,@[upd_usr_id]
        ,SYSDATE
        ,@[upd_usr_id]
        ,SYSDATE
    FROM TRS_TRSP_SVC_ORD SO
        ,(SELECT /*+ INDEX_DESC(S XPKCTM_MOVEMENT) */
           S.MVMT_STS_CD, S.ORG_YD_CD, S.BKG_NO, TO_CHAR(S.CNMV_EVNT_DT, 'YYYYMMDDHH24MI') CNMV_EVNT_DT, S.WO_NO, S.CNTR_NO
            FROM CTM_MOVEMENT S
           WHERE CNTR_NO = NVL(@[cntr_no], (select eq_no from trs_trsp_svc_ord where trsp_so_ofc_cty_cd = @[trsp_so_ofc_cty_cd] and trsp_so_seq = @[trsp_so_seq]))
             AND BKG_NO = @[bkg_no]
             AND NVL(S.MVMT_CRE_TP_CD, 'X') NOT IN ('C', 'A')
             AND ROWNUM = 1) MV
   WHERE SO.TRSP_SO_OFC_CTY_CD = @[trsp_so_ofc_cty_cd]
     AND SO.TRSP_SO_SEQ = @[trsp_so_seq]
     AND SO.EQ_NO = MV.CNTR_NO
     AND SO.BKG_NO = MV.BKG_NO
     AND SO.TRSP_SO_STS_CD <> 'CM'			]]></sql>
			<params>
				<param name="upd_usr_id" type="12" value="" out="N"/>
				<param name="cntr_no" type="12" value="" out="N"/>
				<param name="trsp_so_ofc_cty_cd" type="12" value="" out="N"/>
				<param name="trsp_so_seq" type="12" value="" out="N"/>
				<param name="bkg_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
