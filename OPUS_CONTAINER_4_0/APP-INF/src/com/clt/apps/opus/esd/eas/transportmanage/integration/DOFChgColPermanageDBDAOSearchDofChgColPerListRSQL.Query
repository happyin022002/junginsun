<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="DOFChgColPermanageDBDAOSearchDofChgColPerListRSQL">
			<desc><![CDATA[searchDofChgColPerList SELECT]]></desc>
			<sql><![CDATA[
SELECT '' SEQ, TMP.CNTR_RTN_YD_CD, TMP.D2_QTY, TMP.D4_QTY, TMP.D5_QTY, (TMP.D2_QTY+TMP.D4_QTY+TMP.D5_QTY) CNTR_QTY,
TRF.TRF_D2_QTY, TRF.TRF_D4_QTY, TRF.TRF_D5_QTY,
(TMP.D2_QTY*TRF.TRF_D2_QTY) + (TMP.D4_QTY*TRF.TRF_D4_QTY) + (TMP.D5_QTY*TRF.TRF_D5_QTY) TRF_AMT,
TRO_AMT, DOD_AMT
FROM  (
SELECT SUBSTR(CNTR_RTN_YD_CD,1,5) CNTR_RTN_YD_CD,
SUM(D2_QTY) D2_QTY, SUM(D4_QTY) D4_QTY, SUM(D5_QTY) D5_QTY,
SUM(TRO_AMT) TRO_AMT, SUM(DOD_AMT) DOD_AMT
FROM (
SELECT SUBSTR(CNTR_RTN_YD_CD,1,5) CNTR_RTN_YD_CD,
DECODE(CNTR_TPSZ_CD,'D2',1,0) D2_QTY,
DECODE(CNTR_TPSZ_CD,'D4',1,0) D4_QTY,
DECODE(CNTR_TPSZ_CD,'D5',1,0) D5_QTY,
TRNS_REV_AMT TRO_AMT, DIF_AMT DOD_AMT
FROM (
SELECT A.CRE_OFC_CD, A.BKG_NO, B.BL_NO BL_NO,
E.CUST_CNT_CD, E.CUST_SEQ, C.CNTR_NO,
C.CNMV_ID_NO, C.CNMV_YR, C.CNTR_TPSZ_CD, A.CNTR_RTN_YD_CD,
B.POR_CD, B.POL_CD, B.POD_CD, B.DEL_CD, A.CRE_DT, D.MVMT_STS_CD, D.ORG_YD_CD,
A.CURR_CD, (NVL(A.TRNS_REV_AMT,0)+NVL(A.NMF_TRNS_REV_AMT,0)) TRNS_REV_AMT, AR_IF.AR_INV_CHG_TP_CD,
SUM(AR_IF.AR_CHG_AMT) DIF_AMT
FROM   BKG_EUR_TRO A, BKG_BOOKING B, BKG_CUSTOMER E, BKG_CONTAINER C, CTM_MOVEMENT D,  
(SELECT 
LOCL_CURR_CD AR_CURR_CD,
IO_BND_CD bkg_io_bnd_cd,
BL_SRC_NO bl_no,
BKG_NO bkg_no,
CHG_CD ar_inv_chg_tp_cd,
CHG_AMT ar_chg_amt,
CURR_CD chg_curr_cd,
BL_SRC_NO ar_bl_all_no,
VSL_CD||SKD_VOY_NO||SKD_DIR_CD trnk_vvd_cd,
AR_OFC_CD ar_ofc_cd,
ACT_CUST_CNT_CD||ACT_CUST_SEQ act_cust_cd
FROM INV_AR_MN MN, INV_AR_CHG CHG
WHERE MN.AR_IF_NO = CHG.AR_IF_NO) AR_IF
WHERE  A.CRE_OFC_CD = @[ctrl_ofc_cd]
AND    TO_CHAR(A.CRE_DT,'YYYYMMDD') >= @[fromtrodate]
AND    TO_CHAR(A.CRE_DT,'YYYYMMDD') <= @[totrodate] + 0.999
AND    A.HLG_TP_CD = 'M'
AND    A.IO_BND_CD = 'I'
AND    A.BKG_NO = B.BKG_NO
AND    B.BKG_NO = E.BKG_NO
AND    E.BKG_CUST_TP_CD = ( SELECT MIN(BKG_CUST_TP_CD)
FROM   BKG_CUSTOMER X
WHERE  BKG_NO = E.BKG_NO
AND    BKG_CUST_TP_CD IN ('C','N') )
AND A.BKG_NO = C.BKG_NO
AND A.CNTR_NO = C.CNTR_NO
AND C.CNTR_NO = D.CNTR_NO
AND C.CNMV_ID_NO = D.CNMV_ID_NO
AND C.CNMV_YR = D.CNMV_YR
AND B.BL_NO = AR_IF.AR_BL_ALL_NO(+)
AND AR_IF.AR_INV_CHG_TP_CD = 'DOD'
GROUP BY A.CRE_OFC_CD, A.BKG_NO, B.BL_NO,
E.CUST_CNT_CD, E.CUST_SEQ, C.CNTR_NO,
C.CNMV_ID_NO, C.CNMV_YR, C.CNTR_TPSZ_CD, A.CNTR_RTN_YD_CD,
B.POR_CD, B.POL_CD, B.POD_CD, B.DEL_CD, A.CRE_DT, D.MVMT_STS_CD, D.ORG_YD_CD,
A.CURR_CD,A.TRNS_REV_AMT,A.NMF_TRNS_REV_AMT, AR_IF.AR_INV_CHG_TP_CD, AR_IF.AR_CURR_CD)
)
GROUP BY SUBSTR(CNTR_RTN_YD_CD,1,5)
) TMP,
( SELECT FM_LOC_CD, SUM(TRF_D2_QTY) TRF_D2_QTY, SUM(TRF_D4_QTY) TRF_D4_QTY,
SUM(TRF_D5_QTY) TRF_D5_QTY
FROM (
SELECT X.FM_LOC_CD,
DECODE(X.CNTR_TP_CD,'D2',X.CHRR_FRT_TAX_VAL,0) TRF_D2_QTY,
DECODE(X.CNTR_TP_CD,'D4',X.CHRR_FRT_TAX_VAL,0) TRF_D4_QTY,
DECODE(X.CNTR_TP_CD,'D5',X.CHRR_FRT_TAX_VAL,0) TRF_D5_QTY
FROM   TRS_DRFF_CHG_TRF X,
(SELECT FM_LOC_CD, CNT_CD, CUST_SEQ, MAX(EFF_DT) EFF_DT
FROM TRS_DRFF_CHG_TRF
GROUP BY FM_LOC_CD, CNT_CD, CUST_SEQ ) Y
WHERE  X.EFF_DT = Y.EFF_DT
AND    X.FM_LOC_CD = Y.FM_LOC_CD
AND    X.CNT_CD = Y.CNT_CD
AND    X.CUST_SEQ = Y.CUST_SEQ
)
GROUP BY FM_LOC_CD
) TRF
WHERE TMP.CNTR_RTN_YD_CD = TRF.FM_LOC_CD  (+)
#if ( ${location} != '' )
AND TMP.CNTR_RTN_YD_CD = @[location]
#end			]]></sql>
			<params>
				<param name="ctrl_ofc_cd" type="12" value="" out="N"/>
				<param name="fromtrodate" type="12" value="" out="N"/>
				<param name="totrodate" type="12" value="" out="N"/>
				<param name="location" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
