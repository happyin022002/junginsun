<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="OceanLinkBackEndDBDAOInsertPrdPfTxTmCSQL">
			<desc><![CDATA[insert시 해당 lane, pol, pod를 가지는 ocean link가 존재하면 정보를 업데이트하고, 존재하지 않으면 정보를 추가한다.]]></desc>
			<sql><![CDATA[
MERGE INTO PRD_PF_TZ_TM A
USING DUAL ON ( A.VSL_SLAN_CD       = @[lanecd]
                AND A.FM_PORT_CD    = @[polprot]
                AND A.TO_PORT_CD    = @[podprot]
				AND A.SKD_DIR_CD 	= @[dircd]
              )
              
WHEN MATCHED THEN
    UPDATE SET
          A.TZTM_HRS          =   TO_NUMBER(@[fmt_tztm_hrs])
        , A.FM_PORT_ETB_DY_CD =   @[poletb]
        , A.FM_PORT_ETD_DY_CD =   @[poletd]
        , A.TO_PORT_ETB_DY_CD =   @[podetb]
        , A.TO_PORT_ETD_DY_CD =   @[podetd]
        , A.UPD_OFC_CD        =   @[cre_ofc_cd]
        , A.OCN_LNK_MNL_FLG   =   'Y'
        , A.CRE_USR_ID        =   @[cre_usr_id]
        , A.CRE_DT            =   sysdate
        , A.UPD_USR_ID        =   @[cre_usr_id]
        , A.UPD_DT            =   sysdate
        , A.LNK_RMK           =   @[cre_usr_id]||' has created on '||TO_CHAR(SYSDATE,'Mon-DD,YYYY', 'NLS_DATE_LANGUAGE=ENGLISH')||' : '||@[lnk_rmk]
        , A.DELT_FLG          =   'N'
        , A.LNK_DIST          =   (SELECT NVL(LNK_DIST, 0) 
										 FROM (
										 SELECT SUM(NVL(P.LNK_DIST,D.STND_DIST)) LNK_DIST
										 FROM PRD_PF_TZ_TM P, VSK_PORT_DIST D,
										     (SELECT V.SLAN_CD, V.SKD_DIR_CD, V.VPS_PORT_CD FM_PORT, V.CLPT_SEQ,
										             LEAD(V.VPS_PORT_CD, 1, NULL) OVER (PARTITION BY V.VSL_CD, V.SKD_VOY_NO, V.SKD_DIR_CD ORDER BY V.CLPT_SEQ) TO_PORT
										      FROM VSK_VSL_PORT_SKD V, 
											       (SELECT *
											        FROM(SELECT A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.CLPT_SEQ FM_SEQ, B.CLPT_SEQ TO_SEQ 
											             FROM VSK_VSL_PORT_SKD A, VSK_VSL_PORT_SKD B
											             WHERE A.VSL_CD = B.VSL_CD
											             AND A.SKD_VOY_NO = B.SKD_VOY_NO
											             AND A.SKD_DIR_CD = B.SKD_DIR_CD
											             AND A.CLPT_SEQ < B.CLPT_SEQ
											             AND A.VPS_PORT_CD = @[polprot]
												         AND B.VPS_PORT_CD = @[podprot]
											             AND A.SLAN_CD = @[lanecd]
											             AND A.SKD_DIR_CD = @[dircd]
											             ORDER BY ABS(SYSDATE - A.VPS_ETD_DT)
										           )WHERE ROWNUM = 1) L
												    WHERE V.VSL_CD = L.VSL_CD
												    AND V.SKD_VOY_NO = L.SKD_VOY_NO
												    AND V.SKD_DIR_CD = L.SKD_DIR_CD
												    AND V.CLPT_SEQ BETWEEN L.FM_SEQ AND L.TO_SEQ
											    ) M
											WHERE M.FM_PORT = P.FM_PORT_CD(+)
											AND M.TO_PORT = P.TO_PORT_CD(+)
											AND M.SLAN_CD = P.VSL_SLAN_CD(+)
											AND M.FM_PORT = D.FM_LOC_CD(+)
											AND M.TO_PORT = D.TO_LOC_CD(+)
											AND M.TO_PORT IS NOT NULL )
									)
    WHERE 1=1
    AND A.VSL_SLAN_CD     = @[lanecd]
    AND A.FM_PORT_CD      = @[polprot]
    AND A.TO_PORT_CD      = @[podprot]
    AND A.SKD_DIR_CD      = @[dircd]
    
WHEN NOT MATCHED THEN
    INSERT (
        A.VSL_SLAN_CD
        , A.FM_PORT_CD
        , A.TO_PORT_CD
        , A.TZTM_HRS
        , A.SKD_DIR_CD
        , A.FM_PORT_ETB_DY_CD
        , A.FM_PORT_ETD_DY_CD
        , A.TO_PORT_ETB_DY_CD
        , A.TO_PORT_ETD_DY_CD
        , A.UPD_OFC_CD
        , A.OCN_LNK_MNL_FLG
        , A.CRE_USR_ID
        , A.CRE_DT
        , A.UPD_USR_ID
        , A.UPD_DT
        , A.LNK_RMK
        , A.LNK_DIST
--        , A.DELT_FLG
    ) values (
          @[lanecd]
        , @[polprot]
        , @[podprot]
        , TO_NUMBER(@[fmt_tztm_hrs])
        , @[dircd]
        , @[poletb]
        , @[poletd]
        , @[podetb]
        , @[podetd]
        , @[cre_ofc_cd]
        , 'Y'
        , @[cre_usr_id]
        , sysdate
        , @[cre_usr_id]
        , sysdate
        , @[cre_usr_id]||' has created on '||TO_CHAR(SYSDATE,'Mon-DD,YYYY', 'NLS_DATE_LANGUAGE=ENGLISH')||' : '||@[lnk_rmk]
--        , 'N'
        ,(SELECT NVL(LNK_DIST, 0) 
										 FROM (
										 SELECT SUM(NVL(P.LNK_DIST,D.STND_DIST)) LNK_DIST
										 FROM PRD_PF_TZ_TM P, VSK_PORT_DIST D,
										     (SELECT V.SLAN_CD, V.SKD_DIR_CD, V.VPS_PORT_CD FM_PORT, V.CLPT_SEQ,
										             LEAD(V.VPS_PORT_CD, 1, NULL) OVER (PARTITION BY V.VSL_CD, V.SKD_VOY_NO, V.SKD_DIR_CD ORDER BY V.CLPT_SEQ) TO_PORT
										      FROM VSK_VSL_PORT_SKD V, 
											       (SELECT *
											        FROM(SELECT A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD, A.CLPT_SEQ FM_SEQ, B.CLPT_SEQ TO_SEQ 
											             FROM VSK_VSL_PORT_SKD A, VSK_VSL_PORT_SKD B
											             WHERE A.VSL_CD = B.VSL_CD
											             AND A.SKD_VOY_NO = B.SKD_VOY_NO
											             AND A.SKD_DIR_CD = B.SKD_DIR_CD
											             AND A.CLPT_SEQ < B.CLPT_SEQ
											             AND A.VPS_PORT_CD = @[polprot]
												         AND B.VPS_PORT_CD = @[podprot]
											             AND A.SLAN_CD = @[lanecd]
											             AND A.SKD_DIR_CD = @[dircd]
											             ORDER BY ABS(SYSDATE - A.VPS_ETD_DT)
										           )WHERE ROWNUM = 1) L
												    WHERE V.VSL_CD = L.VSL_CD
												    AND V.SKD_VOY_NO = L.SKD_VOY_NO
												    AND V.SKD_DIR_CD = L.SKD_DIR_CD
												    AND V.CLPT_SEQ BETWEEN L.FM_SEQ AND L.TO_SEQ
											    ) M
											WHERE M.FM_PORT = P.FM_PORT_CD(+)
											AND M.TO_PORT = P.TO_PORT_CD(+)
											AND M.SLAN_CD = P.VSL_SLAN_CD(+)
											AND M.SKD_DIR_CD = P.SKD_DIR_CD(+)
											AND M.FM_PORT = D.FM_LOC_CD(+)
											AND M.TO_PORT = D.TO_LOC_CD(+)
											AND M.TO_PORT IS NOT NULL )
			)
    )			]]></sql>
			<params>
				<param name="lanecd" type="12" value="" out="N"/>
				<param name="polprot" type="12" value="" out="N"/>
				<param name="podprot" type="12" value="" out="N"/>
				<param name="dircd" type="12" value="" out="N"/>
				<param name="fmt_tztm_hrs" type="12" value="" out="N"/>
				<param name="poletb" type="12" value="" out="N"/>
				<param name="poletd" type="12" value="" out="N"/>
				<param name="podetb" type="12" value="" out="N"/>
				<param name="podetd" type="12" value="" out="N"/>
				<param name="cre_ofc_cd" type="12" value="" out="N"/>
				<param name="cre_usr_id" type="12" value="" out="N"/>
				<param name="lnk_rmk" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
