<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="EmptyReleaseRedeliveryOrderMgtDBDAOSearch301EdiKindRSQL">
			<desc><![CDATA[301F 발송을 위해 Edi Kind(CF/BT)를 조회하는 SQL]]></desc>
			<sql><![CDATA[
--BKG CONFIRM
SELECT DISTINCT 'BT' EDI_KIND
FROM BKG_EDI_TRD_PRNR_SUB_LNK EY
     , BKG_EDI_SUB_LNK_MSG MSG
     , BKG_VVD VVD
     , BKG_BOOKING BK
WHERE BK.BKG_NO = @[bkg_no]
AND BK.BKG_NO   = VVD.BKG_NO
AND EY.TRD_PRNR_SUB_LNK_SEQ = MSG.TRD_PRNR_SUB_LNK_SEQ
AND EY.PRNR_SUB_LNK_DIV_CD = '1'
AND MSG.MSG_TP_DESC		  = '1'
AND MSG.EDI_MSG_TP_ID      = '301'
AND EY.TRD_PRNR_SUB_LNK_SEQ IN 
    (SELECT TRD_PRNR_SUB_LNK_SEQ FROM BKG_EDI_SUB_LNK_MSG WHERE EDI_MSG_IND_CD ='1') --1:AUTO
     AND (   (EY.PRNR_SUB_LNK_CD = BK.POL_NOD_CD AND MSG.EDI_MSG_IND_CD IN ('1')) --입력된 찾아진 POL과 같거나
          OR (EY.PRNR_SUB_LNK_CD = VVD.POL_YD_CD AND VVD.VSL_PRE_PST_CD <> 'U' AND MSG.EDI_MSG_IND_CD = '6') --PRE T/S PORT 지정 건이나
          OR (EY.PRNR_SUB_LNK_CD = VVD.POL_YD_CD AND VVD.VSL_PRE_PST_CD =  'U' AND MSG.EDI_MSG_IND_CD = '7') --POST T/S PORT 지정 건
   )
UNION ALL                                     
--FULL RELEASE ORDER 대상   
SELECT DISTINCT 'FC'
FROM BKG_EDI_TRD_PRNR_SUB_LNK EY
    , BKG_EDI_SUB_LNK_MSG MSG
    , BKG_BOOKING BK
WHERE BK.BKG_NO = @[bkg_no]
AND BK.FULL_RTN_YD_CD = EY.PRNR_SUB_LNK_CD
AND EY.TRD_PRNR_SUB_LNK_SEQ = MSG.TRD_PRNR_SUB_LNK_SEQ
AND MSG.EDI_MSG_TP_ID 	= '301'
AND MSG.MSG_TP_DESC	 	= '1'
AND EDI_MSG_IND_CD 	 = '4'     
AND NOT EXISTS (SELECT 'X' 
               FROM BKG_EDI_SUB_LNK_MSG MSG, BKG_EDI_TRD_PRNR_SUB_LNK LNK
               WHERE EDI_MSG_IND_CD ='1' 
               AND MSG.TRD_PRNR_SUB_LNK_SEQ = LNK.TRD_PRNR_SUB_LNK_SEQ
               AND LNK.PRNR_SUB_LNK_CD = BK.POL_NOD_CD
               AND BK.POL_NOD_CD = BK.FULL_RTN_YD_CD)			]]></sql>
			<params>
				<param name="bkg_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
