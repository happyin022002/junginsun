<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="WorkOrderIssueDBDAOSearchTrsSvcOrdBkgChmHisRSQL">
			<desc><![CDATA[SearchTrsSvcOrdBkgChmHis]]></desc>
			<sql><![CDATA[
SELECT T.*
      ,PRE_VAL1 PRE_VAL
  FROM (select K.TRSP_SO_OFC_CTY_CD_SEQ || K.CAT_CATE_SUB|| LPAD(K.TRSP_CNG_SUB_SEQ, 4, '0') AS BKG_CNG_GROUP
			  ,K.*
              ,CASE
                 WHEN CAT_CATE_SUB IN ('VVSV', 'VVTV', 'SCAW') THEN REPLACE(K.COL_NM, ',', '|')
                 WHEN CAT_CATE_SUB = ('SCDG') THEN REPLACE(K.COL_NM, 'IMDG_UN_NO,IMDG_UN_NO_SEQ', 'IMDG_UN_NO|IMDG_UN_NO_SEQ')
                 WHEN CAT_CATE_SUB = ('SCRF') THEN REPLACE(COL_NM, 'CDO_TEMP,FDO_TEMP', 'CDO_TEMP|FDO_TEMP')
                 ELSE COL_NM
               END NEW_COLNM1
              ,CASE
                 WHEN CAT_CATE_SUB IN ('VVSV', 'VVTV', 'SCAW') THEN REPLACE(NEW_VALUE, '@#@', '|')
                 WHEN CAT_CATE_SUB = ('SCDG') THEN (SUBSTR(NEW_VALUE, 0, INSTR(NEW_VALUE, '@#@') - 1) || SUBSTR(NEW_VALUE, INSTR(NEW_VALUE, '@#@') + 3))
                 WHEN CAT_CATE_SUB = ('SCRF') THEN (SUBSTR(NEW_VALUE, 0, INSTR(NEW_VALUE, '@#@') - 1) || SUBSTR(NEW_VALUE, INSTR(NEW_VALUE, '@#@') + 3))
                 ELSE NEW_VALUE
               END NEW_VAL1
              ,CASE
                 WHEN CAT_CATE_SUB IN ('VVSV', 'VVTV', 'SCAW') THEN REPLACE(PREVIOUS_VALUE, '@#@', '|')
                 WHEN CAT_CATE_SUB = ('SCDG') THEN (SUBSTR(PREVIOUS_VALUE, 0, INSTR(PREVIOUS_VALUE, '@#@') - 1) || SUBSTR(PREVIOUS_VALUE, INSTR(PREVIOUS_VALUE, '@#@') + 3))
                 WHEN CAT_CATE_SUB = ('SCRF') THEN (SUBSTR(PREVIOUS_VALUE, 0, INSTR(PREVIOUS_VALUE, '@#@') - 1) || SUBSTR(PREVIOUS_VALUE, INSTR(PREVIOUS_VALUE, '@#@') + 3))
                 ELSE PREVIOUS_VALUE
               END PRE_VAL1
              ,CASE
                 WHEN K.CNG_CATE_CD = 'VV' THEN 'Vessel'
                 WHEN K.CNG_CATE_CD = 'AT' THEN 'Appt'
                 WHEN K.CNG_CATE_CD = 'CN' THEN 'Nature'
                 WHEN K.CNG_CATE_CD = 'CR' THEN 'Release'
                 WHEN K.CAT_CATE_SUB = 'SCRF' THEN 'RF'
                 WHEN K.CAT_CATE_SUB = 'SCDG' THEN 'DG'
                 WHEN K.CAT_CATE_SUB = 'SCAW' THEN 'AK'
				 WHEN K.CNG_CATE_CD  = 'CT'   THEN 'Cut Off Time'
               END CNG_CATE_CD_DESC
              ,'' CNG_CATE_SUB_CD_DESC
              ,'' NOW_READ_VAL
              ,'' PREVIOUS_VAL
              ,'' NEW_COLNM
          FROM (SELECT H.BKG_NO
                      ,C.EQ_NO
                      ,D.CNTR_NO
                      ,C.CNTR_TPSZ_CD AS EQ_TPSZ_CD
                      ,D.CNTR_TPSZ_CD AS BKG_CNTR_TPSZ_CD
                      ,H.TRSP_SO_OFC_CTY_CD || H.TRSP_SO_SEQ AS TRSP_SO_OFC_CTY_CD_SEQ
                      ,H.TRSP_SO_OFC_CTY_CD
                      ,H.TRSP_SO_SEQ
                      ,H.TRSP_SO_SUB_SEQ
                      ,H.TRSP_CNG_SUB_SEQ
                      ,H.CNG_CATE_CD
                      ,H.CNG_CATE_CD || H.CNG_CATE_SUB_CD AS CAT_CATE_SUB
                      ,H.CNG_CATE_SUB_CD
                      ,H.TRSP_SO_OFC_CTY_CD BKG_TRSP_SO_OFC_CTY_CD
                      ,H.TRSP_SO_SEQ AS BKG_TRSP_SO_SEQ
                      ,H.CNG_IND_FLG
                      ,DECODE(H.CNG_IND_FLG, 'N', 'N', H.CNG_IND_FLG) AS BKG_CNG_IND_FLG
                      ,D.COL_NM
                      ,(CASE
                         WHEN H.CNG_CATE_CD = 'SC' AND H.CNG_CATE_SUB_CD = 'DG' THEN H.COL_N1ST_RMK || '@#@' || H.COL_N2ND_RMK
                         WHEN H.CNG_CATE_CD = 'AT' AND H.CNG_CATE_SUB_CD = 'AU' THEN H.COL_N1ST_RMK || '@#@' || H.COL_N2ND_RMK
                         WHEN H.CNG_CATE_CD = 'AT' AND H.CNG_CATE_SUB_CD = 'EU' THEN H.COL_N1ST_RMK || '@#@' || H.COL_N2ND_RMK
                         ELSE H.COL_N1ST_RMK
                       END) NEW_VALUE
                      ,(CASE
                         WHEN H.CNG_CATE_CD = 'SC' AND H.CNG_CATE_SUB_CD = 'DG' THEN H.PRE_COL_N1ST_RMK || '@#@' || H.PRE_COL_N2ND_RMK
                         WHEN H.CNG_CATE_CD = 'AT' AND H.CNG_CATE_SUB_CD = 'AU' THEN H.PRE_COL_N1ST_RMK || '@#@' || H.PRE_COL_N2ND_RMK
                         WHEN H.CNG_CATE_CD = 'AT' AND H.CNG_CATE_SUB_CD = 'EU' THEN H.PRE_COL_N1ST_RMK || '@#@' || H.PRE_COL_N2ND_RMK
                         ELSE H.PRE_COL_N1ST_RMK
                       END) AS PREVIOUS_VALUE
                      ,U.USR_NM USR_NM
                      ,C.CRE_OFC_CD OFC_CD
                      ,H.UPD_USR_ID
                      ,TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC(COM_CONSTANTMGR_PKG.COM_GETBASELOCATIONCODE_FNC(), H.UPD_DT, GLOBALDATE_PKG.GET_LOCCD_FNC(C.CRE_OFC_CD)) , 'YYYY-MM-DD HH24:MI:SS') LOCL_UPD_DT
                      ,TO_CHAR(GLOBALDATE_PKG.TIME_CONV_FNC(COM_CONSTANTMGR_PKG.COM_GETBASELOCATIONCODE_FNC(), H.UPD_DT, 'GMT') , 'YYYY-MM-DD HH24:MI:SS') UPD_DT
                  FROM TRS_TRSP_SVC_ORD_BKG_CNG H
                      ,TRS_TRSP_SVC_ORD_CNG     C
                      ,TRS_TRSP_BKG_CNG         D
                      ,COM_USER                 U
                 WHERE 1=1
                   AND (H.TRSP_SO_OFC_CTY_CD, H.TRSP_SO_SEQ, H.BKG_NO) IN (
                   #foreach($trsp_so_bkg_num IN ${trsp_so_bkg})
                      $trsp_so_bkg_num 
                   #end
                   )    
                   AND H.TRSP_SO_OFC_CTY_CD = C.TRSP_SO_OFC_CTY_CD
                   AND H.TRSP_SO_SEQ = C.TRSP_SO_SEQ
                   AND H.TRSP_SO_SUB_SEQ = C.TRSP_SO_SUB_SEQ
                   AND H.BKG_NO = D.BKG_NO
                   AND H.CNG_CATE_CD = D.CNG_CATE_CD
                   AND H.CNG_CATE_SUB_CD = D.CNG_CATE_SUB_CD
                   AND H.TRSP_CNG_SUB_SEQ = D.TRSP_CNG_SUB_SEQ
                   AND H.UPD_USR_ID = U.USR_ID(+)
                   AND H.CNG_IND_FLG = 'Y'
		) K
) T
ORDER BY BKG_CNG_GROUP			]]></sql>
			<params>
			</params>
		</query>
	</querys>
</sqls>
