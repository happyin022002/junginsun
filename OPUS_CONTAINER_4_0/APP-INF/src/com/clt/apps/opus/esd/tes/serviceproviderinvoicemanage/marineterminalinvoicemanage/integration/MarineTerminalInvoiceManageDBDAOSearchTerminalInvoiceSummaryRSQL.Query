<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="MarineTerminalInvoiceManageDBDAOSearchTerminalInvoiceSummaryRSQL">
			<desc><![CDATA[SearchTerminalInvoiceSummary]]></desc>
			<sql><![CDATA[
SELECT XMLAGG(XMLELEMENT(x,''||BB.LGS_COST_CD||' ') ORDER BY LGS_COST_CD).EXTRACT('//text()').GetStringVal() AS COST_CD, 
       AA.INV_NO, AA.VVD, AA.TML_SO_OFC_CTY_CD, AA.TML_SO_SEQ, AA.INV_TP_CD,AA.TML_INV_TP_CD,AA.TML_INV_STS_CD,AA.TML_INV_RJCT_STS_CD,AA.CRE_DT,AA.LOCL_CRE_DT,AA.INV_OFC_CD,AA.INV_OFC_DEL_FLG,
       AA.COST_OFC_CD,AA.COST_OFC_DEL_FLG,AA.YD_CD,AA.YD_DEL_FLG,AA.CURR_CD,AA.ISS_DT,AA.RCV_DT,AA.EFF_DT,AA.PAY_DUE_DT,AA.PAY_DT,AA.PAY_FLG,AA.HLD_FLG,AA.VNDR_SEQ,AA.VNDR_DEL_FLG, 
       AA.VAT_AMT,AA.WHLD_TAX_AMT,AA.TTL_INV_AMT,AA.DELT_FLG,AA.CSR_NO,AA.CRE_USR_ID,AA.CSR_STATUS,AA.TML_EDI_SO_OFC_CTY_CD,AA.TML_EDI_SO_SEQ,AA.INV_RJCT_RMK,AA.EDI_FLG,AA.RTRO_TML_INV_FLG,
       AA.AUTO_CALC_AMT ,AA.MANUAL_AMT
FROM 
(SELECT INV_NO,  VVD,
TML_SO_OFC_CTY_CD,TML_SO_SEQ,INV_TP_CD,TML_INV_TP_CD,TML_INV_STS_CD,TML_INV_RJCT_STS_CD,CRE_DT,LOCL_CRE_DT,INV_OFC_CD,INV_OFC_DEL_FLG,
COST_OFC_CD,COST_OFC_DEL_FLG,YD_CD,YD_DEL_FLG,CURR_CD,ISS_DT,RCV_DT,EFF_DT,PAY_DUE_DT,PAY_DT,PAY_FLG,HLD_FLG,VNDR_SEQ,VNDR_DEL_FLG, MAX(VAT_AMT) VAT_AMT, MAX(WHLD_TAX_AMT) WHLD_TAX_AMT, MAX(TTL_INV_AMT) TTL_INV_AMT,
DELT_FLG,CSR_NO,CRE_USR_ID,CSR_STATUS,TML_EDI_SO_OFC_CTY_CD,TML_EDI_SO_SEQ,INV_RJCT_RMK,EDI_FLG,RTRO_TML_INV_FLG, SUM(AUTO_CALC_AMT) AUTO_CALC_AMT ,SUM(MANUAL_AMT) MANUAL_AMT
FROM (
SELECT  	/*+ FIRST_ROWS */ D.LGS_COST_CD, 
            H.INV_NO,
            '' VVD,
			H.TML_SO_OFC_CTY_CD,
			H.TML_SO_SEQ,
			DECODE(H.TML_INV_TP_CD,'TM','MR','ON','RC','OF','OC','ST','MS') INV_TP_CD,
			H.TML_INV_TP_CD,
			DECODE(H.TML_INV_STS_CD,'R','RC','C','CF','A','AR','P','AP','D','PD') TML_INV_STS_CD,
			H.TML_INV_RJCT_STS_CD,
 			TO_CHAR(H.CRE_DT,'YYYYMMDD')		CRE_DT,
 			TO_CHAR(H.LOCL_CRE_DT,'YYYYMMDDHH24MISS') LOCL_CRE_DT,
		 	H.INV_OFC_CD,
			(SELECT DELT_FLG FROM MDM_ORGANIZATION WHERE OFC_CD = H.INV_OFC_CD)  INV_OFC_DEL_FLG,
			H.COST_OFC_CD,
			(SELECT DELT_FLG FROM MDM_ORGANIZATION WHERE OFC_CD = H.COST_OFC_CD) COST_OFC_DEL_FLG,
			H.YD_CD,
			(SELECT DELT_FLG FROM MDM_YARD WHERE YD_CD = H.YD_CD)		YD_DEL_FLG,
			H.CURR_CD,
			TO_CHAR(H.ISS_DT,'YYYYMMDD')		ISS_DT,
			TO_CHAR(H.RCV_DT,'YYYYMMDD')		RCV_DT,
		 	TO_CHAR(H.EFF_DT,'YYYYMMDD')		EFF_DT,
			TO_CHAR(H.PAY_DUE_DT,'YYYYMMDD')	PAY_DUE_DT,
			TO_CHAR(H.PAY_DT,'YYYYMMDD')	    PAY_DT,
			H.PAY_FLG,
			H.HLD_FLG,
			LPAD(H.VNDR_SEQ, 6, '0') 	VNDR_SEQ,
			(SELECT DELT_FLG FROM MDM_VENDOR WHERE VNDR_SEQ = H.VNDR_SEQ)	VNDR_DEL_FLG,
		 	H.VAT_AMT,
		 	H.WHLD_TAX_AMT,
			H.TTL_INV_AMT,
			H.DELT_FLG,
			H.CSR_NO,
			H.CRE_USR_ID,
			CASE
			WHEN H.TML_INV_STS_CD = 'R' THEN 'Processing'
			WHEN H.TML_INV_STS_CD = 'C' AND A.IF_FLG IS NULL THEN 'Processing'
			WHEN H.TML_INV_STS_CD = 'A' AND H.TML_INV_RJCT_STS_CD = 'RJ' THEN 'Disapproved'
			WHEN H.TML_INV_STS_CD = 'A' AND A.IF_FLG IS NULL THEN 'Approval Requested'
			WHEN A.IF_FLG = 'Y' AND A.RCV_ERR_FLG IS NULL THEN 'I/F Success'
			WHEN A.IF_FLG IS NULL THEN 'Approval Requested'
			WHEN A.IF_FLG = 'E' THEN 'I/F Error'
			WHEN A.RCV_ERR_FLG = 'E' THEN 'Rejected'
			ELSE 'ALL'
			END CSR_STATUS,
			''  TML_EDI_SO_OFC_CTY_CD,
			NULL  TML_EDI_SO_SEQ,
			H.INV_RJCT_RMK,
			H.EDI_FLG,
			H.RTRO_TML_INV_FLG,
  			DECODE(D.CALC_TP_CD,'A',D.INV_AMT,0) AUTO_CALC_AMT,
  			DECODE(D.CALC_TP_CD,'M',D.INV_AMT,0) MANUAL_AMT
FROM 		TES_TML_SO_HDR H, AP_INV_HDR A, TES_TML_SO_DTL D
WHERE 		(H.DELT_FLG = 'N' or DELT_FLG IS NULL)
AND		H.CSR_NO = A.CSR_NO(+)
AND     H.TML_SO_OFC_CTY_CD = D.TML_SO_OFC_CTY_CD(+)
AND     H.TML_SO_SEQ = D.TML_SO_SEQ(+)

#if (${inv_date_type} == 'I') 
and	h.iss_dt between to_date(@[fm_prd_dt],'yyyy-mm-dd') and to_date(@[to_prd_dt],'yyyy-mm-dd')+0.99999
#elseif (${inv_date_type} == 'R') 
and	h.rcv_dt between to_date(@[fm_prd_dt],'yyyy-mm-dd') and to_date(@[to_prd_dt],'yyyy-mm-dd')+0.99999
#elseif (${inv_date_type} == 'P') 
and	h.locl_upd_dt between to_date(@[fm_prd_dt],'yyyy-mm-dd') and to_date(@[to_prd_dt],'yyyy-mm-dd')+0.99999
#else 
#end

#if (${yd_cd} != '') 
and	h.yd_cd	 =	@[yd_cd]
#else
#end

#if (${inv_no} != '') 
and	h.inv_no	like	'%'||@[inv_no]||'%'
#else
#end

#if (${cost_cd} !='')                                   
AND D.LGS_COST_CD IN (
    #foreach($key IN ${cost_cd})
        #if($velocityCount < $cost_cd.size()) 
			'$key', 
		#else 
			'$key' 
		#end
    #end
    ) 
#end

#if (${vndr_seq} != '') 
and	h.vndr_seq	=	@[vndr_seq]
#else
#end

#if (${cost_ofc_cd} != '') 
and	h.cost_ofc_cd	=	@[cost_ofc_cd]
#else
#end

#if (${inv_ofc_cd} != '') 
and	h.inv_ofc_cd	=	@[inv_ofc_cd]
#else
#end

#if (${tml_inv_sts_cd} != '') 
and	h.tml_inv_sts_cd	=	@[tml_inv_sts_cd]
#else
and	h.tml_inv_sts_cd in ('R','C','A','P','D')
#end

#if (${csr_no} != '') 
and	h.csr_no like	'%'||@[csr_no]||'%'	
#else
#end

#if (${tml_inv_rjct_sts_cd} != '') 
and	h.tml_inv_rjct_sts_cd = @[tml_inv_rjct_sts_cd]
#else
and	h.tml_inv_rjct_sts_cd in ('NL','RJ','RL')
#end

#if (${csr_status} == 'AR') 
AND	A.IF_FLG IS NULL
AND	H.CSR_NO IS NOT NULL
#elseif (${csr_status} == 'PC') 
AND	( H.TML_INV_STS_CD = 'R' OR (H.TML_INV_STS_CD = 'C' AND A.IF_FLG IS NULL) )
#elseif (${csr_status} == 'IE') 
AND	A.IF_FLG = 'E'
#elseif (${csr_status} == 'RJ') 
AND	A.RCV_ERR_FLG = 'E'
#elseif (${csr_status} == 'SC') 
AND	A.IF_FLG = 'Y'	AND A.RCV_ERR_FLG IS NULL
#elseif (${csr_status} == 'DA') 
AND	 H.TML_INV_STS_CD = 'A' AND H.TML_INV_RJCT_STS_CD = 'RJ'
#else 
#end

AND		H.CSR_NO = A.CSR_NO(+)																	

ORDER BY LOCL_CRE_DT DESC, VNDR_SEQ DESC, INV_NO DESC)
GROUP BY INV_NO, TML_SO_OFC_CTY_CD,TML_SO_SEQ,INV_TP_CD,TML_INV_TP_CD,TML_INV_STS_CD,TML_INV_RJCT_STS_CD,CRE_DT,LOCL_CRE_DT,INV_OFC_CD,INV_OFC_DEL_FLG,
COST_OFC_CD,COST_OFC_DEL_FLG,YD_CD,YD_DEL_FLG,CURR_CD,ISS_DT,RCV_DT,EFF_DT,PAY_DUE_DT,PAY_DT,PAY_FLG,HLD_FLG,VNDR_SEQ,VNDR_DEL_FLG, 
DELT_FLG,CSR_NO,CRE_USR_ID,CSR_STATUS,TML_EDI_SO_OFC_CTY_CD,TML_EDI_SO_SEQ,INV_RJCT_RMK,EDI_FLG,RTRO_TML_INV_FLG) AA,
(SELECT DISTINCT H.INV_NO, H.TML_SO_OFC_CTY_CD, H.TML_SO_SEQ, D.LGS_COST_CD 
 FROM TES_TML_SO_HDR H, AP_INV_HDR A, TES_TML_SO_DTL D
 WHERE 1=1
 AND (H.DELT_FLG = 'N' or DELT_FLG IS NULL)
 AND H.CSR_NO = A.CSR_NO(+)
 AND H.TML_SO_OFC_CTY_CD = D.TML_SO_OFC_CTY_CD(+)
 AND H.TML_SO_SEQ = D.TML_SO_SEQ(+)
) BB
WHERE 1=1
AND AA.TML_SO_OFC_CTY_CD = BB.TML_SO_OFC_CTY_CD
AND AA.TML_SO_SEQ        = BB.TML_SO_SEQ
AND AA.INV_NO            = BB.INV_NO     
GROUP BY AA.INV_NO, AA.VVD, AA.TML_SO_OFC_CTY_CD, AA.TML_SO_SEQ, AA.INV_TP_CD,AA.TML_INV_TP_CD,AA.TML_INV_STS_CD,AA.TML_INV_RJCT_STS_CD,AA.CRE_DT,AA.LOCL_CRE_DT,AA.INV_OFC_CD,AA.INV_OFC_DEL_FLG,
       AA.COST_OFC_CD,AA.COST_OFC_DEL_FLG,AA.YD_CD,AA.YD_DEL_FLG,AA.CURR_CD,AA.ISS_DT,AA.RCV_DT,AA.EFF_DT,AA.PAY_DUE_DT,AA.PAY_DT,AA.PAY_FLG,AA.HLD_FLG,AA.VNDR_SEQ,AA.VNDR_DEL_FLG, 
       AA.VAT_AMT,AA.WHLD_TAX_AMT,AA.TTL_INV_AMT,AA.DELT_FLG,AA.CSR_NO,AA.CRE_USR_ID,AA.CSR_STATUS,AA.TML_EDI_SO_OFC_CTY_CD,AA.TML_EDI_SO_SEQ,AA.INV_RJCT_RMK,AA.EDI_FLG,AA.RTRO_TML_INV_FLG,
       AA.AUTO_CALC_AMT ,AA.MANUAL_AMT			]]></sql>
			<params>
				<param name="fm_prd_dt" type="12" value="" out="N"/>
				<param name="to_prd_dt" type="12" value="" out="N"/>
				<param name="yd_cd" type="12" value="" out="N"/>
				<param name="inv_no" type="12" value="" out="N"/>
				<param name="vndr_seq" type="12" value="" out="N"/>
				<param name="cost_ofc_cd" type="12" value="" out="N"/>
				<param name="inv_ofc_cd" type="12" value="" out="N"/>
				<param name="tml_inv_sts_cd" type="12" value="" out="N"/>
				<param name="csr_no" type="12" value="" out="N"/>
				<param name="tml_inv_rjct_sts_cd" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
