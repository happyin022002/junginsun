<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="InlandRouteManageDBDAOUpdateHubLocUSQL">
			<desc><![CDATA[UpdateHubLoc
US,CA,MX에만 적용하던 USA Full이 America Continent로 확장됨에 따라 SUBQUERY 추가]]></desc>
			<sql><![CDATA[
UPDATE prd_inlnd_rout_mst mst 
SET HUB_NOD_CD =  ( 
                    select HUB
                    from ( 
                            select  ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD, ROUT_SEQ, hub 
                            from 
                            ( 
                                select 
                                    ROUT_ORG_NOD_CD, ROUT_dest_NOD_CD, ROUT_SEQ , 
                                    cnt, PCTL_IO_BND_CD , 
                                    decode(PCTL_IO_BND_CD,'O',first_value(LNK_ORG_NOD_CD) over(partition by ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ ), 
                                                          'I',last_value(LNK_DEST_NOD_CD) over(partition by ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ ) 
                                          ) hub 
                                from 
                                ( 
                                    select m.ROUT_ORG_NOD_CD,m.ROUT_DEST_NOD_CD,m.ROUT_SEQ,LNK_ORG_NOD_CD,LNK_DEST_NOD_CD,ROUT_DTL_SEQ,PCTL_IO_BND_CD, 
                                        COUNT (*) OVER (PARTITION BY m.rout_org_nod_cd, m.rout_dest_nod_cd, m.rout_seq 
                                                               ORDER BY m.rout_org_nod_cd, m.rout_dest_nod_cd, m.rout_seq) AS cnt , 
                                        row_number() over (partition by  m.rout_org_nod_cd, m.rout_dest_nod_cd, m.rout_seq 
                                                               ORDER BY m.rout_org_nod_cd, m.rout_dest_nod_cd, m.rout_seq) AS rn 
                                    from prd_inlnd_rout_mst m, prd_inlnd_rout_dtl d 
                                    where m.ROUT_ORG_NOD_CD= d.ROUT_ORG_NOD_CD 
                                    and m.ROUT_DEST_NOD_CD = d.ROUT_DEST_NOD_CD 
                                    and m.ROUT_SEQ = d.ROUT_SEQ 
                                    AND EXISTS ( SELECT 1
                                                 FROM MDM_SUBCONTINENT CONT
                                                      , MDM_COUNTRY MCNT
                                                  WHERE CONT.CONTI_CD = 'M'
                                                    AND MCNT.SCONTI_CD(+) = CONT.SCONTI_CD
                                                    AND MCNT.CNT_CD = SUBSTR(M.ROUT_ORG_NOD_CD,1,2) 
                                               )
                                    and d.TRSP_MOD_CD ='RD' 
                                    AND m.ROUT_ORG_NOD_CD= @[i_rout_org_nod_cd] 
                                    and m.ROUT_DEST_NOD_CD = @[i_rout_dest_nod_cd] 
                                    and m.ROUT_SEQ= to_number(@[i_rout_seq]) 
                                    and NVL(m.DELT_FLG,'N') ='N' 
                                    and m.PCTL_IO_BND_CD in ('I','O') 
                                ) 
                                order by ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ,ROUT_DTL_SEQ 
                            ) 
                            group by ROUT_ORG_NOD_CD,ROUT_DEST_NOD_CD,ROUT_SEQ,hub --,F,L 
                    ) hub 
)
, upd_dt =  sysdate
where mst.ROUT_ORG_NOD_CD = @[i_rout_org_nod_cd] 
and   mst.ROUT_DEST_NOD_CD= @[i_rout_dest_nod_cd] 
and   mst.ROUT_SEQ = to_number(@[i_rout_seq])			]]></sql>
			<params>
				<param name="i_rout_org_nod_cd" type="12" value="" out="N"/>
				<param name="i_rout_dest_nod_cd" type="12" value="" out="N"/>
				<param name="i_rout_seq" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
