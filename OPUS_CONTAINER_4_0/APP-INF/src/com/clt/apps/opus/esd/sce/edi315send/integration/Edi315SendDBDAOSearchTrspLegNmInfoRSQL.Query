<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="Edi315SendDBDAOSearchTrspLegNmInfoRSQL">
			<desc><![CDATA[TRSP_LEG_NM Search.]]></desc>
			<sql><![CDATA[
SELECT SEQ
      , CASE WHEN ACTIVITY_IND1 = 'Y' THEN 'Y'
             WHEN ACTIVITY_IND1 = 'N' AND ACTIVITY_IND2 = 'Y' THEN 'Y' 
             WHEN ACTIVITY_IND1 = 'N' AND ACTIVITY_IND2 = 'N' AND ACTIVITY_IND3 = 'Y' THEN 'Y'
             WHEN ACTIVITY_IND1 = 'N' AND ACTIVITY_IND2 = 'N' AND ACTIVITY_IND3 = 'N' AND ACTIVITY_IND4 = 'Y' THEN 'Y'
             WHEN ACTIVITY_IND1 = 'N' AND ACTIVITY_IND2 = 'N' AND ACTIVITY_IND3 = 'N' AND ACTIVITY_IND4 = 'N' AND ACTIVITY_IND5 = 'Y' THEN 'Y'
             ELSE 'N' END ACTIVITY_IND
       , TRANS_MODE      
  FROM (SELECT SCD.COP_DTL_SEQ SEQ
               , CASE WHEN @[edi_sts_cd] = 'D' OR @[edi_sts_cd] = 'AG'  -- COP에 없는 I/B Delivery Case 처리
                    THEN 
                   NVL((SELECT 'Y'
                      FROM SCE_COP_DTL A
                     WHERE A.COP_NO = @[cop_no]
                       AND A.ACT_CD = 'FITZAD'-- 상수
                       AND SUBSTR(A.NOD_CD, 1, 5) LIKE SUBSTR(@[event_yard_cd], 1, 5) /*PARAMETER    eventYard(Edi315SendVO)*/
                       AND A.COP_DTL_SEQ = SCD.COP_DTL_SEQ), 'N')  ELSE 'N' END ACTIVITY_IND1   
             , CASE WHEN (SELECT 'Y'
                      FROM SCE_COP_DTL A
                     WHERE A.COP_NO = @[cop_no]
                       AND A.STND_EDI_STS_CD = @[edi_sts_cd] /*PARAMEMTER MSGID ediStatus(Edi315SendVO)*/
                       AND SUBSTR(A.NOD_CD, 1, 5) LIKE SUBSTR(@[event_yard_cd], 1, 5) /*PARAMETER    eventYard(Edi315SendVO)*/
                       AND A.COP_DTL_SEQ = SCD.COP_DTL_SEQ) 
               IS NULL THEN 'N' ELSE 'Y' END ACTIVITY_IND2-- 0715 로직 변경
              , CASE WHEN (SELECT 'Y'
                      FROM SCE_COP_DTL A
                     WHERE A.COP_NO = @[cop_no]
                       AND A.ACT_CD = @[edi_sts_cd] /*PARAMEMTER MSGID ediStatus(Edi315SendVO)*/
                       AND SUBSTR(A.NOD_CD, 1, 5) LIKE SUBSTR(@[event_yard_cd], 1, 5) /*PARAMETER    eventYard(Edi315SendVO)*/
                       AND A.COP_DTL_SEQ = SCD.COP_DTL_SEQ) 
               IS NULL THEN 'N' ELSE 'Y' END ACTIVITY_IND3-- 0715 로직 변경
               , CASE  WHEN (SELECT 'Y'
                      FROM SCE_COP_DTL A
                     WHERE A.COP_NO = @[cop_no]
                       AND SUBSTR(A.STND_EDI_STS_CD, 1,1) = SUBSTR(@[edi_sts_cd], 1,1) /*PARAMEMTER MSGID ediStatus(Edi315SendVO)*/
                       AND SUBSTR(A.NOD_CD, 1, 5) LIKE SUBSTR(@[event_yard_cd], 1, 5) /*PARAMETER    eventYard(Edi315SendVO)*/
                       AND A.COP_DTL_SEQ = SCD.COP_DTL_SEQ) 
               IS NULL THEN 'N' ELSE 'Y'  END ACTIVITY_IND4
               , CASE  WHEN (SELECT DECODE(ACT_STS_CD,'F','Y','N')
                          FROM SCE_COP_DTL
                         WHERE COP_NO = @[cop_no]
                           AND COP_DTL_SEQ = ( SELECT COP_DTL_SEQ
                                                  FROM(SELECT ROW_NUMBER() OVER(PARTITION BY B.CNTR_NO ORDER BY C.COP_DTL_SEQ DESC) RN
                                                             ,COP_DTL_SEQ
                                                          FROM SCE_COP_HDR B
                                                             , SCE_COP_DTL C
                                                         WHERE B.COP_NO = @[cop_no]
                                                           AND B.COP_STS_CD IN ('C','T','F')
                                                           AND B.COP_NO = C.COP_NO
                                                           AND C.ACT_STS_CD = 'F' 
                                                       )
                                                 WHERE RN = 1
                                             )
                           AND COP_DTL_SEQ = SCD.COP_DTL_SEQ ) 
               IS NULL THEN 'N'  ELSE 'Y'  END ACTIVITY_IND5 -- 0729 로직 변경
             , DECODE(SUBSTR(SCD.ACT_CD, 3,1),'W','F',SUBSTR(SCD.ACT_CD, 3,1)) AS TRANS_MODE
          FROM SCE_COP_HDR SCH
             , SCE_COP_DTL SCD
         WHERE SCH.BKG_NO = @[bkg_no]
           AND SCH.COP_STS_CD IN ('C', 'T', 'F')
           AND SCH.COP_NO = SCD.COP_NO
           AND SCD.COP_NO = @[cop_no]
           AND SUBSTR(SCD.NOD_CD, 1, 5) LIKE SUBSTR(@[event_yard_cd], 1, 5)
         ORDER BY ACTIVITY_IND1 desc, ACTIVITY_IND2 desc,  ACTIVITY_IND3 desc, ACTIVITY_IND4 desc, ACTIVITY_IND5 desc
       ) A
WHERE CASE WHEN ACTIVITY_IND1 = 'Y' THEN 'Y'
             WHEN ACTIVITY_IND1 = 'N' AND ACTIVITY_IND2 = 'Y' THEN 'Y' 
             WHEN ACTIVITY_IND1 = 'N' AND ACTIVITY_IND2 = 'N' AND ACTIVITY_IND3 = 'Y' THEN 'Y'
             WHEN ACTIVITY_IND1 = 'N' AND ACTIVITY_IND2 = 'N' AND ACTIVITY_IND3 = 'N' AND ACTIVITY_IND4 = 'Y' THEN 'Y'
             WHEN ACTIVITY_IND1 = 'N' AND ACTIVITY_IND2 = 'N' AND ACTIVITY_IND3 = 'N' AND ACTIVITY_IND4 = 'N' AND ACTIVITY_IND5 = 'Y' THEN 'Y'
             ELSE 'N' END = 'Y'
AND ROWNUM = '1'			]]></sql>
			<params>
				<param name="edi_sts_cd" type="12" value="" out="N"/>
				<param name="cop_no" type="12" value="" out="N"/>
				<param name="event_yard_cd" type="12" value="" out="N"/>
				<param name="bkg_no" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
