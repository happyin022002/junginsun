<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="PerformanceInquiryDBDAOSearchEACIssuanceListRSQL">
			<desc><![CDATA[SearchEACIssuanceList]]></desc>
			<sql><![CDATA[
SELECT o.rhq if_rhq_cd, o.n3pty_expn_tp_cd expn_tp_cd
      ,NVL(a.cnt,0) cnt_a, NVL(a.amt,0) amt_a
      ,NVL(b.cnt,0) cnt_b, NVL(b.amt,0) amt_b
      ,NVL(c.cnt,0) cnt_c, NVL(c.amt,0) amt_c
      ,NVL(a.cnt,0)+NVL(b.cnt,0)+NVL(c.cnt,0) cnt_tot
      ,NVL(a.amt,0)+NVL(b.amt,0)+NVL(c.amt,0) amt_tot
  FROM (
        SELECT 0 seq, rhq, n3pty_expn_tp_cd
          FROM (
                  SELECT ofc_cd AS rhq
                    FROM TPB_HNDL_OFC
                   WHERE n3pty_ofc_tp_cd='R' AND DELT_FLG = 'N'
#if (${s_if_rhq_cd} != '') 
			         AND ofc_cd = @[s_if_rhq_cd]
#end
               ) a,
               (  SELECT intg_cd_val_dp_seq seq, intg_cd_val_ctnt n3pty_expn_tp_cd
                    FROM com_intg_cd_dtl
                   WHERE intg_cd_id='CD00578'
               ) b
         WHERE 1 = 1
     UNION ALL
        SELECT 999 seq, '(TOTAL)' rhq, '(TOTAL)' n3pty_expn_tp_cd
          FROM DUAL
       ) o,
       (
          -- Misbilling
          SELECT NVL(m.rhq,'(TOTAL)') rhq, NVL(a.n3pty_expn_tp_cd,'(TOTAL)') n3pty_expn_tp_cd
                ,COUNT(0) cnt
                ,SUM(TPB_GET_USD_AMT_FNC(a.ots_amt,a.curr_cd,TPB_GET_LCL_DATE_FNC(DECODE(c.ots_sts_cd,'E',c.ots_sts_cre_dt,SYSDATE),a.ofc_cd))) amt
            FROM TPB_OTS_GRP a, TPB_OTS_GRP_STS c,
                 (
                    SELECT rhq_cd AS rhq, ofc_cd ofc
                      FROM TPB_HNDL_OFC
                     WHERE n3pty_ofc_tp_cd='T' AND DELT_FLG = 'N'
#if (${s_if_rhq_cd} != '') 
        			   AND rhq_cd = @[s_if_rhq_cd]
#end
                 ) m
           WHERE a.n3pty_no = c.n3pty_no
             AND a.ofc_cd = m.ofc
             AND a.n3pty_delt_tp_cd IN ('N')
             AND c.ots_sts_lst_flg = 'Y'
		     AND a.cfm_dt >= TPB_GET_SRCH_DATE_FNC(@[s_sdate],'YYYY-MM-DD',@[user_ofc_cd])
		     AND a.cfm_dt < TPB_GET_SRCH_DATE_FNC(@[s_edate],'YYYY-MM-DD',@[user_ofc_cd]) + 1
             AND EXISTS ( SELECT 0 FROM TPB_OTS_DTL s WHERE s.n3pty_no=a.n3pty_no AND s.eac_tp_cd IN ('M') )
        GROUP BY ROLLUP(m.rhq, a.n3pty_expn_tp_cd)
          HAVING GROUPING(m.rhq) = 1 OR GROUPING(a.n3pty_expn_tp_cd) = 0
       ) a,
       (
          -- Missing 3rd Party Billing
          SELECT NVL(m.rhq,'(TOTAL)') rhq, NVL(a.n3pty_expn_tp_cd,'(TOTAL)') n3pty_expn_tp_cd
                ,COUNT(0) cnt
                ,SUM(TPB_GET_USD_AMT_FNC(a.ots_amt,a.curr_cd,TPB_GET_LCL_DATE_FNC(DECODE(c.ots_sts_cd,'E',c.ots_sts_cre_dt,SYSDATE),a.ofc_cd))) amt
            FROM TPB_OTS_GRP a, TPB_OTS_GRP_STS c,
                 (
                    SELECT rhq_cd AS rhq, ofc_cd ofc
                      FROM TPB_HNDL_OFC
                     WHERE n3pty_ofc_tp_cd='T' AND DELT_FLG = 'N'
        		#if (${s_if_rhq_cd} != '') 
        			   AND rhq_cd = @[s_if_rhq_cd]
        		#end
                 ) m
           WHERE a.n3pty_no = c.n3pty_no
             AND a.ofc_cd = m.ofc
             AND a.n3pty_delt_tp_cd IN ('N')
             AND c.ots_sts_lst_flg = 'Y'
        	 AND a.cfm_dt >= TPB_GET_SRCH_DATE_FNC(@[s_sdate],'YYYY-MM-DD',@[user_ofc_cd])
        	 AND a.cfm_dt < TPB_GET_SRCH_DATE_FNC(@[s_edate],'YYYY-MM-DD',@[user_ofc_cd]) + 1
             AND EXISTS ( SELECT 0 FROM TPB_OTS_DTL s WHERE s.n3pty_no=a.n3pty_no AND s.eac_tp_cd IN ('T') )
        GROUP BY ROLLUP(m.rhq, a.n3pty_expn_tp_cd)
          HAVING GROUPING(m.rhq) = 1 OR GROUPING(a.n3pty_expn_tp_cd) = 0
       ) b,
       (
          -- Internal Error
          SELECT NVL(m.rhq,'(TOTAL)') rhq, NVL(a.n3pty_expn_tp_cd,'(TOTAL)') n3pty_expn_tp_cd
                ,COUNT(0) cnt
                ,SUM(TPB_GET_USD_AMT_FNC(a.ots_amt,a.curr_cd,TPB_GET_LCL_DATE_FNC(DECODE(c.ots_sts_cd,'E',c.ots_sts_cre_dt,SYSDATE),a.ofc_cd))) amt
            FROM TPB_OTS_GRP a, TPB_OTS_GRP_STS c,
                 (
                    SELECT rhq_cd AS rhq, ofc_cd ofc
                      FROM TPB_HNDL_OFC
                     WHERE n3pty_ofc_tp_cd='T' AND DELT_FLG = 'N'
#if (${s_if_rhq_cd} != '') 
        			   AND rhq_cd = @[s_if_rhq_cd]
#end
                 ) m
           WHERE a.n3pty_no = c.n3pty_no
             AND a.ofc_cd = m.ofc
             AND a.n3pty_delt_tp_cd IN ('N')
             AND c.ots_sts_lst_flg = 'Y'
        	 AND a.cfm_dt >= TPB_GET_SRCH_DATE_FNC(@[s_sdate],'YYYY-MM-DD',@[user_ofc_cd])
        	 AND a.cfm_dt < TPB_GET_SRCH_DATE_FNC(@[s_edate],'YYYY-MM-DD',@[user_ofc_cd]) + 1
             AND EXISTS ( SELECT 0 FROM TPB_OTS_DTL s WHERE s.n3pty_no=a.n3pty_no AND s.eac_tp_cd IN ('I') )
        GROUP BY ROLLUP(m.rhq, a.n3pty_expn_tp_cd)
          HAVING GROUPING(m.rhq) = 1 OR GROUPING(a.n3pty_expn_tp_cd) = 0
       ) c
 WHERE 1 = 1
   AND o.rhq = a.rhq(+) AND o.n3pty_expn_tp_cd = a.n3pty_expn_tp_cd(+)
   AND o.rhq = b.rhq(+) AND o.n3pty_expn_tp_cd = b.n3pty_expn_tp_cd(+)
   AND o.rhq = c.rhq(+) AND o.n3pty_expn_tp_cd = c.n3pty_expn_tp_cd(+)
 ORDER BY o.seq, o.rhq, o.n3pty_expn_tp_cd			]]></sql>
			<params>
				<param name="s_if_rhq_cd" type="12" value="" out="N"/>
				<param name="s_sdate" type="12" value="" out="N"/>
				<param name="user_ofc_cd" type="12" value="" out="N"/>
				<param name="s_edate" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
