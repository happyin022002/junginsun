<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="InlandRouteManageDBDAOlnlandRouteUSRSQL">
			<desc><![CDATA[Inland Route Management USA FULL search]]></desc>
			<sql><![CDATA[
SELECT T1.*
  ,regexp_substr(T1.agr_str, '[^ |]+', 1, 1) curr_cd
  ,regexp_substr(T1.agr_str, '[^ |]+', 1, 2) ttl_cost
FROM (
	SELECT 
		  PRD_GET_INLND_AGMT_RT_FNC(rout_org_nod_cd, rout_dest_nod_cd, rout_seq, 'M') agr_str,
          max(to_number(nvl(prio_seq,0))) OVER (PARTITION BY org_loc, dest_loc  ORDER BY org_loc, dest_loc) AS max_prio_seq, 
	      rout_org_nod_cd, rout_dest_nod_cd, rn, inlnd_rout_bkg_flg  , inlnd_rout_tmp_flg, inlnd_rout_incl_sttl_flg,
	      org_loc,  org_loc_type,
	      dest_loc,  dest_loc_type,
	      rout_seq, nvl(prio_seq,0) prio_seq , prio_seq ori_prio_seq ,  route,
	      sum_tt_time, sum_dw_tt ,
	      ltrim(to_char(trunc(tot_tt/24,0),'00'))||ltrim(to_char(mod(tot_tt,24  ),'00'))  tot_tt,
	      '' hub_search_gb, '' front_gb , '' undefine_nod,
	      max(rn) OVER (PARTITION BY rout_org_nod_cd, rout_dest_nod_cd  ORDER BY rout_org_nod_cd, rout_dest_nod_cd) AS group_gubun,
		  decode(trim(wrs_full_cmdt_cd),'',0,1) wrs_full_cmdt, wrs_full_cmdt_cd,
	      cre_usr_id,cre_ofc_cd,to_char(cre_dt,'yyyy-mm-dd') cre_dt,hub_loc_cd,inlnd_rout_rmk ,hub, delt_flg,
	      rout_pln_cd, upd_usr_id,to_char(upd_dt,'yyyy-mm-dd') upd_dt
	 FROM ( 
	   SELECT rout_org_nod_cd, rout_dest_nod_cd, inlnd_rout_bkg_flg ,inlnd_rout_tmp_flg ,inlnd_rout_incl_sttl_flg,rownum rn, 
		substr( rout_org_nod_cd,1,5) org_loc, substr( rout_org_nod_cd, 6) org_loc_type,
		substr( rout_dest_nod_cd,1,5) dest_loc, substr( rout_dest_nod_cd,6) dest_loc_type,
		rout_seq, prio_seq, route,
		sum_tt_time, sum_dw_tt , (sum_tt_time + sum_dw_tt) tot_tt, wrs_full_cmdt_cd,
		cre_usr_id,cre_ofc_cd,cre_dt ,hub_loc_cd,inlnd_rout_rmk ,hub, delt_flg,rout_pln_cd,
		upd_usr_id, upd_dt
	   FROM ( 
	     SELECT rout_org_nod_cd, rout_dest_nod_cd, rout_seq, prio_seq ,inlnd_rout_bkg_flg ,inlnd_rout_tmp_flg, 
		    inlnd_rout_incl_sttl_flg, 
		    rout_org_nod_cd || ' ( ' || 
		    MAX(DECODE ( cnt,1 ,(DECODE(rout_dtl_seq ,1 , trsp_mod , ''  )), 
					      (DECODE(rout_dtl_seq ,1 , trsp_mod , ''  ))) ) || ' ) ' ||
		    MAX(DECODE(cnt,1,'', DECODE(cnt,1 ,'', DECODE(rout_dtl_seq, 1 , '-'||lnk_dest_nod_cd || ' ( '))))     || 
		    MAX(DECODE ( cnt,1 , '' , (DECODE(rout_dtl_seq ,2 , trsp_mod  || ' ) ', ''  ))) )  || 
		    MAX(DECODE(cnt,1,'', DECODE(cnt,2 ,'', DECODE(rout_dtl_seq, 2 , '-'||lnk_dest_nod_cd || ' ( '))))     ||
		    MAX(DECODE ( cnt,1 , '' , (DECODE(rout_dtl_seq ,3 , trsp_mod || ' ) ', ''  ))) )   ||
		    MAX(DECODE(cnt,1,'', DECODE(cnt,3 ,'', DECODE(rout_dtl_seq, 3 , '-'||lnk_dest_nod_cd  || ' ( '))))    ||
		    MAX(DECODE ( cnt,1 , '' , (DECODE(rout_dtl_seq ,4 , trsp_mod  || ' ) ', ''  ))) )  ||
		    MAX(DECODE(cnt,1,'', DECODE(cnt,4 ,'', DECODE(rout_dtl_seq, 4 , '-'||lnk_dest_nod_cd  || ' ( '))))    || 
		    MAX(DECODE ( cnt,1 , '' , (DECODE(rout_dtl_seq ,5 , trsp_mod || ' ) ', ''  ))) )  || 
		    MAX(DECODE(cnt,1,'', DECODE(cnt,5 ,'', DECODE(rout_dtl_seq, 5 , '-'||lnk_dest_nod_cd  || ' ( '))))    || 
		    MAX(DECODE ( cnt,1 , '' , (DECODE(rout_dtl_seq ,6 , trsp_mod || ' ) ', ''  ))) )    || 
		    MAX(DECODE(cnt,1,'', DECODE(cnt,6 ,'', DECODE(rout_dtl_seq, 6 , '-'||lnk_dest_nod_cd  || ' ( ' ))))   || 
		    MAX(DECODE ( cnt,1 , '' , (DECODE(rout_dtl_seq ,7 , trsp_mod || ' ) ', ''  ))) )    || 
		    MAX(DECODE(cnt,1,'', DECODE(cnt,7 ,'', DECODE(rout_dtl_seq, 7 , '-'||lnk_dest_nod_cd  || ' ( '))))    || 
		    MAX(DECODE ( cnt,1 , '' , (DECODE(rout_dtl_seq ,8 , trsp_mod || ' ) ', ''  ))) )    || 
		    MAX(DECODE(cnt,1,'', DECODE(cnt,8 ,'', DECODE(rout_dtl_seq, 8 , '-'||lnk_dest_nod_cd  || ' ( '))))    || 
		    MAX(DECODE ( cnt,1 , '' , (DECODE(rout_dtl_seq ,9 , trsp_mod || ' ) ' , ''  ))) )  || 
		    MAX(DECODE(cnt,1,'', DECODE(cnt,9 ,'', DECODE(rout_dtl_seq, 9 , '-'||lnk_dest_nod_cd  || ' ( '))))    || 
		    MAX(DECODE ( cnt,1 , '' , (DECODE(rout_dtl_seq ,10, trsp_mod || ' ) ', ''  ))) )    || 
		    MAX(DECODE(cnt,1,'', DECODE(cnt,10,'', DECODE(rout_dtl_seq, 10, '-'||lnk_dest_nod_cd || ' ( '))))     ||
		    MAX(DECODE ( cnt,1 , '' , (DECODE(rout_dtl_seq ,11, trsp_mod || ' ) ' , ''  ))) )  ||
		    MAX(DECODE(cnt,1,'', DECODE(cnt,11,'', DECODE(rout_dtl_seq, 11, '-'||lnk_dest_nod_cd || ' ( '))))     || 
		    MAX(DECODE ( cnt,1 , '' , (DECODE(rout_dtl_seq ,12, trsp_mod || ' ) ', ''  ))) )    || 
		    MAX(DECODE(cnt,1,'', DECODE(cnt,12,'', DECODE(rout_dtl_seq, 12, '-'||lnk_dest_nod_cd || ' ( '))))     || 
		    MAX(DECODE ( cnt,1 , '' , (DECODE(rout_dtl_seq ,13, trsp_mod || ' ) ', ''  ))) )    ||
		    MAX(DECODE(cnt,1,'', DECODE(cnt,13,'', DECODE(rout_dtl_seq, 13, '-'||lnk_dest_nod_cd || ' ( '))))     || 
		    MAX(DECODE ( cnt,1 , '' , (DECODE(rout_dtl_seq ,14, trsp_mod || ' ) ', ''  ))) )    || 
		    MAX(DECODE(cnt,1,'', DECODE(cnt,14,'', DECODE(rout_dtl_seq, 14, '-'||lnk_dest_nod_cd  || ' ( '))))    || 
		    MAX(DECODE ( cnt,1 , '' , (DECODE(rout_dtl_seq ,15, trsp_mod || ' ) ', ''  ))) )    ||
		    MAX(DECODE(cnt,1,'', DECODE(cnt,15,'', DECODE(rout_dtl_seq, 15, '-'||lnk_dest_nod_cd || ' ( '))))     ||
		    MAX(DECODE ( cnt,1 , '' , (DECODE(rout_dtl_seq ,16, trsp_mod || ' ) ', ''  ))) )    || 
		    MAX(DECODE(cnt,1,'', DECODE(cnt,16,'', DECODE(rout_dtl_seq, 16, '-'||lnk_dest_nod_cd  || ' ( ' ))))   || 
		    MAX(DECODE ( cnt,1 , '' , (DECODE(rout_dtl_seq ,17, trsp_mod || ' ) ', ''  ))) )    || 
		    MAX(DECODE(cnt,1,'', DECODE(cnt,17,'', DECODE(rout_dtl_seq, 17, '-'||lnk_dest_nod_cd || ' ( '))))     || 
		    MAX(DECODE ( cnt,1 , '' , (DECODE(rout_dtl_seq ,18, trsp_mod || ' ) ', ''  ))) )    ||
		    MAX(DECODE(cnt,1,'', DECODE(cnt,18,'', DECODE(rout_dtl_seq, 18, '-'||lnk_dest_nod_cd || ' ( '))))     || 
		    MAX(DECODE ( cnt,1 , '' , (DECODE(rout_dtl_seq ,19, trsp_mod || ' ) ', ''  ))) )    || 
		    MAX(DECODE(cnt,1,'', DECODE(cnt,19,'', DECODE(rout_dtl_seq, 19, '-'||lnk_dest_nod_cd || ' ( '))))     || 
		    MAX(DECODE ( cnt,1 , '' , (DECODE(rout_dtl_seq ,20, trsp_mod || ' ) ', ''  ))) )    || 
		    MAX(DECODE(cnt,1,'', DECODE(cnt,20,'', DECODE(rout_dtl_seq, 20, '-'||lnk_dest_nod_cd)))) 
		    ||  '-'||rout_dest_nod_cd as route 
		    , rout_org_nod_cd AS pod0
		    , rout_dest_nod_cd AS del, sum_tt_time, 
		    MAX(DECODE ( cnt,1 , DECODE(rout_dtl_seq ,1 , dest_dw_time , 0  ),
					    DECODE(rout_dtl_seq ,1 , dest_dw_time, 0  )) )  + 
		    MAX(DECODE ( cnt,1 ,0, DECODE(rout_dtl_seq ,2 , dest_dw_time, 0  )) )   + 
		    MAX(DECODE ( cnt,1 ,0, DECODE(rout_dtl_seq ,3 , dest_dw_time, 0  )) )   + 
		    MAX(DECODE ( cnt,1 ,0, DECODE(rout_dtl_seq ,4 , dest_dw_time, 0  )) )   + 
		    MAX(DECODE ( cnt,1 ,0, DECODE(rout_dtl_seq ,5 , dest_dw_time, 0  )) )   + 
		    MAX(DECODE ( cnt,1 ,0, DECODE(rout_dtl_seq ,6 , dest_dw_time, 0  )) )   + 
		    MAX(DECODE ( cnt,1 ,0, DECODE(rout_dtl_seq ,7 , dest_dw_time, 0  )) )   + 
		    MAX(DECODE ( cnt,1 ,0, DECODE(rout_dtl_seq ,8 , dest_dw_time, 0  )) )   + 
		    MAX(DECODE ( cnt,1 ,0, DECODE(rout_dtl_seq ,9 , dest_dw_time, 0  )) )   + 
		    MAX(DECODE ( cnt,1 ,0, DECODE(rout_dtl_seq ,10 , dest_dw_time, 0  )) )   + 
		    MAX(DECODE ( cnt,1 ,0, DECODE(rout_dtl_seq ,11 , dest_dw_time, 0  )) )   + 
		    MAX(DECODE ( cnt,1 ,0, DECODE(rout_dtl_seq ,12 , dest_dw_time, 0  )) )   + 
		    MAX(DECODE ( cnt,1 ,0, DECODE(rout_dtl_seq ,13 , dest_dw_time, 0  )) )   + 
		    MAX(DECODE ( cnt,1 ,0, DECODE(rout_dtl_seq ,14 , dest_dw_time, 0  )) )   + 
		    MAX(DECODE ( cnt,1 ,0, DECODE(rout_dtl_seq ,15 , dest_dw_time, 0  )) )   + 
		    MAX(DECODE ( cnt,1 ,0, DECODE(rout_dtl_seq ,16 , dest_dw_time, 0  )) )   + 
		    MAX(DECODE ( cnt,1 ,0, DECODE(rout_dtl_seq ,17 , dest_dw_time, 0  )) )   + 
		    MAX(DECODE ( cnt,1 ,0, DECODE(rout_dtl_seq ,18 , dest_dw_time, 0  )) )   + 
		    MAX(DECODE ( cnt,1 ,0, DECODE(rout_dtl_seq ,19 , dest_dw_time, 0  )) )   + 
		    MAX(DECODE ( cnt,1 ,0, DECODE(rout_dtl_seq ,20 , dest_dw_time, 0  )) )   sum_dw_tt
		   ,wrs_full_cmdt_cd 
		   ,MAX(DECODE(cnt,1, cre_usr_id, DECODE(rout_dtl_seq,1, cre_usr_id))) cre_usr_id 
		   ,MAX(DECODE(cnt,1, cre_ofc_cd, DECODE(rout_dtl_seq,1, cre_ofc_cd))) cre_ofc_cd
		   ,MAX(DECODE(cnt,1, cre_dt, DECODE(rout_dtl_seq,1, cre_dt))) cre_dt
		   ,MAX(DECODE(cnt,1, HUB_LOC_CD, DECODE(rout_dtl_seq,1, HUB_LOC_CD))) HUB_LOC_CD  
		   ,MAX(DECODE(cnt,1, HUB, DECODE(rout_dtl_seq,1, HUB))) HUB 
		   ,MAX(DECODE(cnt,1, inlnd_rout_rmk, DECODE(rout_dtl_seq,1, inlnd_rout_rmk))) inlnd_rout_rmk   
		   ,MAX(DECODE(cnt,1, DELT_FLG, DECODE(rout_dtl_seq,1, DELT_FLG))) DELT_FLG    
		   ,MAX(DECODE(cnt,1, ROUT_PLN_CD, DECODE(rout_dtl_seq,1, ROUT_PLN_CD))) ROUT_PLN_CD   
		   ,MAX(DECODE(cnt,1, UPD_USR_ID, DECODE(rout_dtl_seq,1, UPD_USR_ID))) UPD_USR_ID     
		   ,MAX(DECODE(cnt,1, UPD_DT, DECODE(rout_dtl_seq,1, UPD_DT))) UPD_DT     
		 FROM ( 

			   SELECT m.rout_org_nod_cd, m.rout_dest_nod_cd, m.rout_seq, decode(m.prio_seq,0,null,m.prio_seq) prio_seq, 
				m.inlnd_rout_bkg_flg ,inlnd_rout_incl_sttl_flg, 
				d.lnk_org_nod_cd,d.lnk_dest_nod_cd, d.rout_dtl_seq,d.trsp_mod_cd,l.tztm_hrs, 
				COUNT (*) OVER (PARTITION BY m.rout_org_nod_cd, m.rout_dest_nod_cd, m.rout_seq 
				   ORDER BY m.rout_org_nod_cd, m.rout_dest_nod_cd, m.rout_seq) AS cnt
				,SUM(l.tztm_hrs) OVER(PARTITION BY m.rout_org_nod_cd, m.rout_dest_nod_cd, m.rout_seq 
				   ORDER BY m.rout_org_nod_cd,m.rout_dest_nod_cd, m.rout_seq) AS sum_tt_time, 
				(SELECT nvl(dry_avg_dwll_hrs,0)  FROM mdm_yard WHERE yd_cd = d.lnk_org_nod_cd ) org_dw_time, 
				(SELECT nvl(dry_avg_dwll_hrs,0)  FROM mdm_yard WHERE yd_cd = d.lnk_dest_nod_cd ) dest_dw_time,
				inlnd_rout_tmp_flg , wrs_full_cmdt_cd,
				m.cre_usr_id,m.cre_ofc_cd,m.cre_dt ,m.inlnd_rout_rmk
				,DECODE(d.trsp_mod_cd,'TD','TRUCK','RD','RAIL','WD','WATER',d.trsp_mod_cd) trsp_mod,M.HUB_LOC_CD,
				(case   when @[r_inbound] = 'B'  then 'OK' 
					when @[r_inbound] = 'I'  and n.nod_tp_cd in ('M','B') and @[r_btn_nod_ty_cd] = 'Z' and n1.nod_tp_cd ='Z' then 'OK' 
					when @[r_inbound] = 'I'  and n.nod_tp_cd in ('M','B') and @[r_btn_nod_ty_cd] = 'Y' and n1.nod_tp_cd <> 'Z' then 'OK' 
					when @[r_inbound] = 'O'  and n1.nod_tp_cd in ('M','B') and @[r_btn_nod_ty_cd] = 'Z' and n.nod_tp_cd ='Z' then 'OK' 
					when @[r_inbound] = 'O'  and n1.nod_tp_cd in ('M','B') and @[r_btn_nod_ty_cd] = 'Y' and n.nod_tp_cd <>'Z' then 'OK' else 'XX'
				 end) check_nod_tp , hub_NOD_CD HUB  ,m.DELT_FLG , m.ROUT_PLN_CD, 
				 m.upd_usr_id, m.upd_dt
			   FROM prd_inlnd_rout_mst m, prd_inlnd_rout_dtl d, prd_inlnd_each_lnk l, prd_node n, prd_node n1 

			   WHERE m.rout_org_nod_cd LIKE @[i_org_cd] ||'%' 
			     AND m.rout_dest_nod_cd LIKE @[i_dest_cd] ||'%' 
			     AND NVL(m.HUB_NOD_CD,'X') LIKE NVL(@[i_hub_loc], NVL(M.HUB_NOD_CD,'X') )||'%'  
			     and m.rout_org_nod_cd = n.nod_cd
			     and m.rout_dest_nod_cd = n1.nod_cd 

			     AND NVL(m.DELT_FLG,'N') = nvl( @[i_del_flg],'N') 

			     AND m.rout_org_nod_cd = d.rout_org_nod_cd 
			     AND m.rout_dest_nod_cd = d.rout_dest_nod_cd 
			     AND m.rout_seq = d.rout_seq 
			     AND d.lnk_org_nod_cd = l.lnk_org_nod_cd 
			     AND d.lnk_dest_nod_cd = l.lnk_dest_nod_cd 
			     AND d.trsp_mod_cd = l.trsp_mod_cd 
			     AND m.PCTL_IO_BND_CD = @[r_inbound]
			   ORDER BY m.rout_seq, d.rout_dtl_seq 

		      ) m 
	     where check_nod_tp ='OK' 
	     GROUP BY m.rout_org_nod_cd, m.rout_dest_nod_cd, m.rout_seq, m.prio_seq,sum_tt_time,INLND_ROUT_BKG_FLG,INLND_ROUT_TMP_FLG, 
		      m.inlnd_rout_incl_sttl_flg, m.wrs_full_cmdt_cd
	     ORDER BY rout_org_nod_cd, rout_dest_nod_cd, prio_seq 
	     )
	)
) T1
ORDER BY   rn			]]></sql>
			<params>
				<param name="r_inbound" type="12" value="1" out="N"/>
				<param name="r_btn_nod_ty_cd" type="12" value="1" out="N"/>
				<param name="i_org_cd" type="12" value="1" out="N"/>
				<param name="i_dest_cd" type="12" value="1" out="N"/>
				<param name="i_hub_loc" type="12" value="1" out="N"/>
				<param name="i_del_flg" type="12" value="1" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
