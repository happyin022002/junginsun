<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="USA404EDIStatusInquiryDBDAOSearchUsa404EdiStatusInquiryRSQL">
			<desc><![CDATA[404 Edi 대상 조회 SQL]]></desc>
			<sql><![CDATA[
SELECT /*+ ORDERED USE_HASH(M) USE_NL(S T) */
    M.INV_NO,
    M.LASTCHK,
    M.COP_NO,
    M.COST_ACT_GRP_SEQ,
    M.SUB_RAIL_SEQ,
    M.VNDR_SEQ,
   (SELECT USA_EDI_CD FROM MDM_VENDOR WHERE VNDR_SEQ = M.VNDR_SEQ AND DELT_FLG = 'N') USA_EDI_CD,
    CASE WHEN M.BIL_ISS_STS_CD = 'I'  THEN DECODE(SIGN((SELECT COUNT(*) FROM TRS_EXPT_ACK_RAIL_VNDR WHERE VNDR_SEQ = M.VNDR_SEQ AND DELT_FLG = 'N')), 1, 'Y', 'N') 
         ELSE 'N'
    END EXPT_ACK_VNDR_FLG,
    M.TRSP_SO_OFC_CTY_CD,
    M.TRSP_SO_SEQ,
    '' CHK1,
    '' CHK2,
    '' CHK3,
    '' CHK4,
    '' CHK5,
    M.WO_RJCT_RSN,
    M.CXL_RQST_FLG,
    M.REPO_PLN_ID,
    M.PLN_YRWK,
    M.REF_ID,
    M.REF_SEQ,
    M.RAIL_CMB_THRU_TP_CD,
    (SELECT INTG_CD_VAL_DP_DESC FROM COM_INTG_CD_DTL WHERE INTG_CD_ID = 'CD00126' AND INTG_CD_VAL_CTNT = M.RAIL_CMB_THRU_TP_CD) RAIL_CMB_THRU_TP_NM,
    M.CRE_OFC_CD,
    M.BKG_CGO_TP_CD,
    M.TRSP_SO_STS_CD,
    M.TRSP_RAIL_BIL_TP_CD,
    M.EQ_NO,
    M.EQ_TPSZ_CD,
    M.CGO_TP_CD,
    M.CRE_DT,
    M.CRE_DT_HMS,
    M.BIL_ISS_STS_CD,
    M.FM_NOD_CD,
    M.FM_NOD_YARD,
    M.TO_NOD_CD,
    M.TO_NOD_YARD,
    M.VNDR_ABBR_NM,
	M.ROUT_PLN_CD,
    M.BL_NO,
    M.BKG_NO,
    M.BIL_EDI_SNT_DT,
    M.BIL_EDI_SNT_DT_HMS,
    M.BIL_EDI_RSNT_DT,
    M.BIL_EDI_RSNT_DT_HMS,
    M.BIL_EDI_RCV_RSLT_CD,
    M.BIL_EDI_RCV_RSLT_DT,
    M.BIL_EDI_RCV_RSLT_DT_HMS,
    (CASE WHEN M.WAYBILL_NO IS NOT NULL THEN M.WAYBILL_NO
          ELSE (
				SELECT P1.WBL_NO
				  FROM (SELECT CT.BKG_NO
							  ,CT.CNTR_NO
							  ,CT.EVNT_YD_CD
							  ,CT.WBL_NO
							  ,ROW_NUMBER() OVER(partition BY CT.BKG_NO, CT.CNTR_NO, CT.EVNT_YD_CD order by MVMT_EDI_TP_CD desc, MVMT_EDI_MSG_TP_ID desc, MVMT_EDI_MSG_AREA_CD desc, MVMT_EDI_MSG_YRMONDY desc, MVMT_EDI_MSG_SEQ desc) RK
						  FROM CTM_MVMT_EDI_MSG CT
						 WHERE 1 = 1
						   and CT.WBL_NO > ' '
						   AND CT.MVMT_EDI_RSLT_CD > ' ') P1
				 WHERE P1.BKG_NO = M.BKG_NO
				   AND P1.CNTR_NO = M.EQ_NO
				   AND P1.EVNT_YD_CD = M.FM_NOD_CD || M.FM_NOD_YARD
				   AND P1.RK = 1
				   AND ROWNUM = 1
				)
     END) WAYBILL_NO,  
    M.MTC_EDI_RCV_RSLT_FLG,
    M.MTC_EDI_RCV_RSLT_DT,
    SUBSTR(M.BKG_SPE, 0, LENGTH(M.BKG_SPE)-1) AS BKG_SPE,
    M.SPCL_CGO_CNTR_TP_CD,
    M.MTC_EDI_RCV_RSLT_DT_HMS,
    M.CFM_MSG_SNT_DT,
    M.CFM_MSG_SNT_DT_HMS,
    M.PROV_VNDR_SEQ,
    M.CXL_RQST_DT,
    M.CXL_RQST_DT_HMS,
    M.CXL_RQST_RSN,
    M.CXL_RQST_RJCT_DT,
    M.CXL_RQST_RJCT_DT_HMS,
    M.CXL_RQST_RJCT_RSN,
    MAX(DECODE(M.CGO_TP_CD, 'M', M.INTER_RMK, 'F', DECODE(M.INTER_RMK_CHK, '', '', 'Y'))) INTER_RMK,
    M.SPCL_INSTR_RMK,
    M.RAIL_ORD_RJCT_FLG,
    TO_CHAR(M.CCREDT, 'YYYYMMDDHH24MISS') AS CCREDT,
    M.BIL_ISS_KNT,
    CASE WHEN LENGTH(S.EDI_RCV_VNDR_ABBR_NM) > 0 OR LENGTH(T.EDI_RCV_VNDR_ABBR_NM) > 0 THEN 'Y'  END AS MTC_EDI_IND_CD,
    M.SLAN_CD,
    M.TRUNKVVD,
    M.CNTR_WGT,
    M.IBD_NO,
    M.RAIL_CRR_REF_NO,
   (SELECT REPLACE(REPLACE(CUST_NM, CHR (13),' '), CHR (10), ' ') FROM BKG_CUSTOMER CUST WHERE CUST.BKG_NO = M.BKG_NO AND CUST.BKG_CUST_TP_CD = 'S') AS SHPR_CUST_NM,
   (SELECT REPLACE(REPLACE(CUST_NM, CHR (13),' '), CHR (10), ' ') FROM BKG_CUSTOMER CUST WHERE CUST.BKG_NO = M.BKG_NO AND CUST.BKG_CUST_TP_CD = 'C') AS CNEE_CUST_NM,
    M.EDI_USR_ID,
    M.TRSP_FRST_FLG,
    M.CMDT_NAME,
    M.REF_NO,
    M.AUTO_XPT_SYS_CD,
    M.AUTO_XPT_SYS_NO,
    M.BKG_CNTR_ATTACHED,
    M.IBD_CSTMS_CLR_LOC_CD,
    M.TRSP_BND_CD,
    MAX(M.CURR_CD) CURR_CD,
    (SUM(NVL(M.BZC_AMT,0)) + SUM(NVL(M.FUEL_SCG_AMT,0)) + SUM(NVL(M.OVR_WGT_SCG_AMT,0)) + SUM(NVL(M.HZD_MTRL_SCG_AMT,0)) + SUM(NVL(M.ETC_ADD_AMT,0))) TOT_AMT,
    SUM(NVL(M.BZC_AMT,0)) BZC_AMT,
    (SUM(NVL(M.FUEL_SCG_AMT,0)) + SUM(NVL(M.OVR_WGT_SCG_AMT,0)) + SUM(NVL(M.HZD_MTRL_SCG_AMT,0)) + SUM(NVL(M.ETC_ADD_AMT,0))) SCG_AMT,
    SUM(NVL(M.FUEL_SCG_AMT,0)) FUEL_SCG_AMT,
    SUM(NVL(M.OVR_WGT_SCG_AMT,0)) OVR_WGT_SCG_AMT,
    SUM(NVL(M.HZD_MTRL_SCG_AMT,0)) HZD_MTRL_SCG_AMT,
    SUM(NVL(M.ETC_ADD_AMT,0)) ETC_ADD_AMT,
    MAX(M.TRSP_AGMT_OFC_CTY_CD) TRSP_AGMT_OFC_CTY_CD,
    MAX(M.TRSP_AGMT_SEQ) TRSP_AGMT_SEQ,
    CASE WHEN MAX(M.BKG_CGO_TP_CD) = 'F' THEN '1' ELSE '0' END POP_IMG,
	NVL((SELECT 'Y' FROM TRS_TRSP_RAIL_BIL_VNDR_SET TT WHERE TT.TRSP_SO_OFC_CTY_CD = M.TRSP_SO_OFC_CTY_CD AND TT.TRSP_SO_SEQ = M.TRSP_SO_SEQ AND TT.INV_NO IS NOT NULL AND ROWNUM = 1), 'N') INV_FLG,
    M.DELT_FLG,
	DECODE(MAX(M.CND_CSTMS_CLR_FLG), 'Y', '1', '0') CND_CSTMS_CLR_FLG,
	MAX(M.UPLN_SO_FLG) UPLN_SO_FLG,
    (SELECT BB.RAIL_BLK_CD FROM BKG_BOOKING BB WHERE BB.BKG_NO = M.BKG_NO) RAIL_BLK_CD
FROM 
    (
        SELECT 
            X.LASTCHK,
            X.INV_NO,
            X.CXL_RQST_FLG,
            X.COP_NO,
            X.COST_ACT_GRP_SEQ,
            X.SUB_RAIL_SEQ,
            X.VNDR_SEQ,
            X.BIL_ISS_KNT,
            X.TRSP_SO_OFC_CTY_CD,
            X.TRSP_SO_SEQ,
            X.REPO_PLN_ID,
            X.PLN_YRWK,
            X.REF_ID,
            X.REF_SEQ,
            X.RAIL_CMB_THRU_TP_CD,
            X.CRE_OFC_CD,
            X.BKG_CGO_TP_CD,
            X.TRSP_SO_STS_CD,
            X.TRSP_RAIL_BIL_TP_CD,
            X.EQ_NO,
            X.EQ_TPSZ_CD,
            X.CGO_TP_CD,
            X.CRE_DT,
            X.CRE_DT_HMS,
            X.BIL_ISS_STS_CD,
            X.FM_NOD_CD,
            X.FM_NOD_YARD,
            X.TO_NOD_CD,
            X.TO_NOD_YARD,
            X.VNDR_ABBR_NM,
			X.ROUT_PLN_CD,
            X.BL_NO,
            X.BKG_NO,
            X.BIL_EDI_SNT_DT,
            X.BIL_EDI_SNT_DT_HMS,
            CASE WHEN X.BIL_EDI_RSNT_DT = '20000101' THEN '' ELSE X.BIL_EDI_RSNT_DT END BIL_EDI_RSNT_DT,
            CASE WHEN X.BIL_EDI_RSNT_DT = '20000101' THEN '' ELSE X.BIL_EDI_RSNT_DT_HMS END BIL_EDI_RSNT_DT_HMS,
            X.BIL_EDI_RCV_RSLT_CD,
            X.BIL_EDI_RCV_RSLT_DT,
            X.BIL_EDI_RCV_RSLT_DT_HMS,
            X.WAYBILL_NO,
            X.MTC_EDI_IND_CD,
            X.MTC_EDI_RCV_RSLT_FLG,
            X.MTC_EDI_RCV_RSLT_DT,
            X.MTC_EDI_RCV_RSLT_DT_HMS,
            X.CFM_MSG_SNT_DT,
            X.CFM_MSG_SNT_DT_HMS,
            X.PROV_VNDR_SEQ,
            X.CXL_RQST_DT,
            X.CXL_RQST_DT_HMS,
            X.CXL_RQST_RSN,
            X.CXL_RQST_RJCT_DT,
            X.CXL_RQST_RJCT_DT_HMS,
            X.CXL_RQST_RJCT_RSN,
            (SELECT MAX(RMK.BKG_NO)
               FROM TRS_INTER_RMK RMK
              WHERE RMK.BKG_NO IN(X.BKG_NO, 'DUM000000000')
                AND NVL(RMK.EQ_NO, 'X') = NVL2(RMK.EQ_NO, X.EQ_NO, 'X')
                AND NVL(RMK.TRSP_SO_OFC_CTY_CD, 'XX') = NVL2(RMK.TRSP_SO_OFC_CTY_CD, X.TRSP_SO_OFC_CTY_CD, 'XX')
                AND NVL(RMK.TRSP_SO_SEQ, '99999') = NVL2(RMK.TRSP_SO_SEQ, X.TRSP_SO_SEQ, '99999')
                AND NVL(RMK.DELT_FLG, 'X') = 'N') AS INTER_RMK_CHK,
            X.INTER_RMK,
            X.SPCL_INSTR_RMK,
            X.SPCL_CGO_CNTR_TP_CD,
            X.RAIL_ORD_RJCT_FLG,
            X.CCREDT,
            X.SLAN_CD,
            X.TRUNKVVD,
            X.CNTR_WGT,
            X.IBD_NO,
            X.RAIL_CRR_REF_NO,
            X.SHPR_CUST_NM,
            X.CNEE_CUST_NM,
            X.EDI_USR_ID,
            X.TRSP_FRST_FLG,
            X.WO_RJCT_RSN,
            X.REF_NO,
            X.BKG_CNTR_ATTACHED,
            X.IBD_CSTMS_CLR_LOC_CD,
            X.POL_NOD_CD,
            X.POD_NOD_CD,
            X.TRSP_BND_CD,
            X.AUTO_XPT_SYS_CD,
            X.AUTO_XPT_SYS_NO
            ,( SELECT REPLACE(MDM_CO.CMDT_NM, CHR(13)||CHR(10), ' ') AS CMDT_NAME
                FROM
                    MDM_COMMODITY MDM_CO,
                    BKG_BOOKING B
                WHERE X.BKG_NO = B.BKG_NO
                AND   B.CMDT_CD = MDM_CO.CMDT_CD
            ) CMDT_NAME
            ,(
                SELECT
                    DECODE( BK.DCGO_FLG , 'Y', 'DG /') || 
                    DECODE( BK.RC_FLG , 'Y', 'RF /') || 
                    DECODE( BK.AWK_CGO_FLG , 'Y', 'AK /') || 
                    DECODE( BK.BB_CGO_FLG , 'Y', 'BB /') || 
                    DECODE( BK.SPCL_HIDE_FLG , 'Y', 'HD /') || 
                    DECODE( BK.FD_GRD_FLG , 'Y', 'FG /') || 
                    DECODE( BK.RAIL_BLK_CD, '', '', 'RB /') AS BKG_SPE
                FROM
                    BKG_BOOKING BK
                WHERE X.BKG_NO = BK.BKG_NO
            ) BKG_SPE,
            X.CURR_CD,
            X.BZC_AMT,
            X.FUEL_SCG_AMT,
            X.OVR_WGT_SCG_AMT,
            X.HZD_MTRL_SCG_AMT,
            X.ETC_ADD_AMT,
            X.TRSP_AGMT_OFC_CTY_CD,
            X.TRSP_AGMT_SEQ,
            X.DELT_FLG,
			X.CND_CSTMS_CLR_FLG,
			X.UPLN_SO_FLG
        FROM    
            (
                SELECT /*+ ORDERED USE_NL(A, B, C, CR, CFM, AGMT, BC, D) */
                    DECODE(C.BIL_ISS_KNT, A.BIL_ISS_KNT, 'Y', NULL , 'Y' ) AS LASTCHK,
                    MAX(B.INV_NO) AS INV_NO,
                    A.CXL_RQST_FLG AS CXL_RQST_FLG,
                    A.COP_NO AS COP_NO,
                    A.COST_ACT_GRP_SEQ AS COST_ACT_GRP_SEQ,
                    MIN(B.SUB_RAIL_SEQ) AS SUB_RAIL_SEQ,
                    MAX(DECODE(B.SUB_RAIL_SEQ, 1, B.VNDR_SEQ)) AS VNDR_SEQ,
                    C.BIL_ISS_KNT AS BIL_ISS_KNT,
                    A.TRSP_SO_OFC_CTY_CD AS TRSP_SO_OFC_CTY_CD,
                    A.TRSP_SO_SEQ AS TRSP_SO_SEQ,
                    A.REPO_PLN_ID AS REPO_PLN_ID,
                    A.PLN_YRWK AS PLN_YRWK,
                    A.REF_ID AS REF_ID,
                    A.REF_SEQ AS REF_SEQ,
                    A.RAIL_CMB_THRU_TP_CD AS RAIL_CMB_THRU_TP_CD,
                    A.CRE_OFC_CD AS CRE_OFC_CD,
                    MAX(A.BKG_CGO_TP_CD) AS BKG_CGO_TP_CD,
                    MAX(DECODE(NVL(C.BIL_ISS_STS_CD, A.TRSP_SO_STS_CD) , 'I', 'EDI Sent' , 'C', 'S/O Created' , 'R', 'S/O Corrected', 'S/O Created')) AS TRSP_SO_STS_CD,
                    MAX(A.TRSP_RAIL_BIL_TP_CD) AS TRSP_RAIL_BIL_TP_CD,                    
                    MAX(A.EQ_NO) AS EQ_NO,
                    MAX(A.EQ_TPSZ_CD) AS EQ_TPSZ_CD,
                    MAX(A.CGO_TP_CD) AS CGO_TP_CD,
                    MAX(TO_CHAR(A.LOCL_CRE_DT, 'YYYYMMDD')) AS CRE_DT,
                    MAX(TO_CHAR(A.LOCL_CRE_DT, 'HH24MISS')) AS CRE_DT_HMS,
                    C.BIL_ISS_STS_CD AS BIL_ISS_STS_CD,
                    MAX(SUBSTR(A.FM_NOD_CD, 1, 5)) AS FM_NOD_CD,
                    MAX(SUBSTR(A.FM_NOD_CD, 6)) AS FM_NOD_YARD,
                    MAX(SUBSTR(A.TO_NOD_CD, 1, 5)) AS TO_NOD_CD,
                    MAX(SUBSTR(A.TO_NOD_CD, 6)) AS TO_NOD_YARD,
                    MAX(DECODE(B.SUB_RAIL_SEQ, 1, D.VNDR_ABBR_NM)) AS VNDR_ABBR_NM,
					MAX(A.ROUT_PLN_CD) AS ROUT_PLN_CD,
                    MAX(A.BL_NO) AS BL_NO,
                    DECODE(A.BIL_ISS_STS_CD , 'I', C.BKG_NO , A.BKG_NO) AS BKG_NO,
                    TO_CHAR(C.BIL_EDI_SNT_DT, 'YYYYMMDD') AS BIL_EDI_SNT_DT,
                    TO_CHAR(C.BIL_EDI_SNT_DT, 'HH24MISS') AS BIL_EDI_SNT_DT_HMS,
                    MAX( TO_CHAR( GREATEST( 
                                            NVL( CR.BIL_EDI_RSND_DT, TO_DATE('20000101', 'YYYYMMDD') ),  
                                            NVL( C.BIL_EDI_RSND_DT, TO_DATE('20000101', 'YYYYMMDD') )
                                            ) , 'YYYYMMDD'
                                )
                        ) AS BIL_EDI_RSNT_DT,
                    MAX( TO_CHAR( GREATEST( 
                                            NVL( CR.BIL_EDI_RSND_DT, TO_DATE('20000101', 'YYYYMMDD') ),  
                                            NVL( C.BIL_EDI_RSND_DT, TO_DATE('20000101', 'YYYYMMDD') )
                                            ) , 'HH24MISS'
                                )
                        ) AS BIL_EDI_RSNT_DT_HMS,
                    C.BIL_EDI_RCV_RSLT_CD,
                    TO_CHAR(C.BIL_EDI_RCV_RSLT_DT, 'YYYYMMDD') AS BIL_EDI_RCV_RSLT_DT,
                    TO_CHAR(C.BIL_EDI_RCV_RSLT_DT, 'HH24MISS') AS BIL_EDI_RCV_RSLT_DT_HMS,
                    C.WBL_NO AS WAYBILL_NO,
                    C.MTC_EDI_IND_CD,
                    C.MTC_EDI_RCV_RSLT_FLG,
                    TO_CHAR(C.MTC_EDI_RCV_RSLT_DT, 'YYYYMMDD') AS MTC_EDI_RCV_RSLT_DT,
                    TO_CHAR(C.MTC_EDI_RCV_RSLT_DT, 'HH24MISS') AS MTC_EDI_RCV_RSLT_DT_HMS,
                    MAX(TO_CHAR(CFM.SND_DT, 'YYYYMMDD')) AS CFM_MSG_SNT_DT,
                    MAX(TO_CHAR(CFM.SND_DT, 'HH24MISS')) AS CFM_MSG_SNT_DT_HMS,
                    MAX(A.PROV_VNDR_SEQ) AS PROV_VNDR_SEQ,
                    MAX(TO_CHAR(A.CXL_RQST_DT, 'YYYYMMDD')) AS CXL_RQST_DT,
                    MAX(TO_CHAR(A.CXL_RQST_DT, 'HH24MISS')) AS CXL_RQST_DT_HMS,
                    MAX(A.CXL_RQST_RSN) AS CXL_RQST_RSN,
                    MAX(TO_CHAR(A.CXL_RQST_RJCT_DT, 'YYYYMMDD')) AS CXL_RQST_RJCT_DT,
                    MAX(TO_CHAR(A.CXL_RQST_RJCT_DT, 'HH24MISS')) AS CXL_RQST_RJCT_DT_HMS,
                    MAX(C.CXL_RQST_RJCT_RSN) AS CXL_RQST_RJCT_RSN,
                    NVL(C.INTER_RMK, A.INTER_RMK) AS INTER_RMK,
                    C.SPCL_INSTR_RMK,
                    MAX(A.SPCL_CGO_CNTR_TP_CD) AS SPCL_CGO_CNTR_TP_CD,
                    C.RAIL_ORD_RJCT_FLG,
                    C.LOCL_CRE_DT AS CCREDT,
                    MAX(A.SLAN_CD) AS SLAN_CD,
                    MAX((A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD)) AS TRUNKVVD,
                    MAX(A.CNTR_WGT) AS CNTR_WGT,
                    MAX(A.IBD_NO) AS IBD_NO,
                    MAX(A.RAIL_CRR_REF_NO) AS RAIL_CRR_REF_NO,
                    MAX(A.SHPR_CUST_NM) AS SHPR_CUST_NM,
                    MAX(A.CNEE_CUST_NM) AS CNEE_CUST_NM,
                    C.CRE_USR_ID AS EDI_USR_ID,
                    MAX(A.TRSP_FRST_FLG) AS TRSP_FRST_FLG,
                    C.WO_RJCT_RSN,
                    MAX(DECODE(B.SUB_RAIL_SEQ, 1, AGMT.AGMT_REF_NO) || DECODE(B.TO_NOD_CD, NULL, '' , A.TO_NOD_CD, '', ' / ') ) || 
                    MAX( DECODE(B.SUB_RAIL_SEQ, 2 , AGMT.AGMT_REF_NO) || DECODE(B.TO_NOD_CD, NULL, '' , A.TO_NOD_CD, '', ' / ') ) || 
                    MAX( DECODE(B.SUB_RAIL_SEQ, 3 , AGMT.AGMT_REF_NO)) AS REF_NO,
                    MAX(DECODE(A.CGO_TP_CD, 'M', NULL, DECODE(BC.CNTR_NO, NULL , 'N', 'Y'))) AS BKG_CNTR_ATTACHED,
                    MAX(A.IBD_CSTMS_CLR_LOC_CD) AS IBD_CSTMS_CLR_LOC_CD,
                    MAX(A.POL_NOD_CD) AS POL_NOD_CD,
                    MAX(A.POD_NOD_CD) AS POD_NOD_CD,
                    MAX(A.TRSP_BND_CD) AS TRSP_BND_CD,
                    A.AUTO_XPT_SYS_CD AS AUTO_XPT_SYS_CD,
                    A.AUTO_XPT_SYS_NO AS AUTO_XPT_SYS_NO,
                    MAX(B.CURR_CD) CURR_CD,
                    SUM(B.BZC_AMT) BZC_AMT,
                    SUM(B.FUEL_SCG_AMT) FUEL_SCG_AMT,
                    SUM(B.OVR_WGT_SCG_AMT) OVR_WGT_SCG_AMT,
                    SUM(B.HZD_MTRL_SCG_AMT) HZD_MTRL_SCG_AMT,
                    SUM(B.ETC_ADD_AMT) ETC_ADD_AMT,
                    MAX(B.TRSP_AGMT_OFC_CTY_CD) TRSP_AGMT_OFC_CTY_CD,
                    MAX(B.TRSP_AGMT_SEQ) TRSP_AGMT_SEQ,
                    MAX(A.DELT_FLG) DELT_FLG,
					MAX(A.CND_CSTMS_CLR_FLG) CND_CSTMS_CLR_FLG,
					MAX(A.UPLN_SO_FLG) UPLN_SO_FLG
                FROM 
                    TRS_TRSP_RAIL_BIL_ORD A,
                    TRS_TRSP_RAIL_BIL_VNDR_SET B,
                    TRS_TRSP_EDI_RAIL_ORD C,
                    TRS_TRSP_EDI_RAIL_ORD_RSND CR,
                    TRS_TRSP_CFM_MSG_HIS CFM,
                    TRS_AGMT_HDR AGMT,
                    BKG_CONTAINER BC,
                    MDM_VENDOR D
                WHERE A.TRSP_SO_OFC_CTY_CD = B.TRSP_SO_OFC_CTY_CD
                AND   A.TRSP_SO_SEQ = B.TRSP_SO_SEQ
                AND   A.TRSP_SO_OFC_CTY_CD = C.TRSP_SO_OFC_CTY_CD (+)
                AND   A.TRSP_SO_SEQ = C.TRSP_SO_SEQ (+)
                AND   A.TRSP_SO_OFC_CTY_CD = CR.TRSP_SO_OFC_CTY_CD (+)
                AND   A.TRSP_SO_SEQ = CR.TRSP_SO_SEQ (+)
                AND   A.TRSP_SO_OFC_CTY_CD = CFM.TRSP_SO_OFC_CTY_CD (+)
                AND   A.TRSP_SO_SEQ = CFM.TRSP_SO_SEQ (+)
                AND   B.TRSP_AGMT_OFC_CTY_CD = AGMT.TRSP_AGMT_OFC_CTY_CD (+)
                AND   B.TRSP_AGMT_SEQ = AGMT.TRSP_AGMT_SEQ (+)
                AND   A.BKG_NO = BC.BKG_NO (+)
                AND   A.EQ_NO = BC.CNTR_NO (+)
                AND   B.VNDR_SEQ = D.VNDR_SEQ
                AND   A.RAIL_CMB_THRU_TP_CD IN ('C1T', 'C2T', 'C3T', 'C2R', 'C3R', 'C2C', 'C3S')
#if(${incHistory} != \'H\')
                AND   A.DELT_FLG = 'N'
#end
                AND   NVL(A.SPND_FLG, 'N') = 'N'
                AND   A.CRE_OFC_CD = @[ctrlOfcCd]
#if($vvd.size() > 0)
 AND ((A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD) IN (
 #foreach($key IN ${vvd})
  #if($velocityCount == 1)      
   ( SUBSTR('$key', 1, 4), SUBSTR('$key', 5, 4), SUBSTR('$key', 9))
  #else
   , ( SUBSTR('$key', 1, 4), SUBSTR('$key', 5, 4), SUBSTR('$key', 9))
  #end
 #end
  )
 )
#end
#if($bl.size() > 0)
 AND (A.BL_NO IN ( 
      #foreach($key IN ${bl})
       #if($velocityCount == 1)
        '$key'
       #else
        ,'$key'
       #end
      #end
     )
  )
#end
#if($cntr.size() > 0)
 AND A.EQ_NO IN (
      #foreach($key IN ${cntr})
       #if($velocityCount == 1)
        '$key'
       #else
        ,'$key'
       #end
      #end
     )
#end
#if($ref_no.size() > 0)
 AND A.REF_ID IN (
      #foreach($key IN ${ref_no})
       #if($velocityCount == 1)
        '$key'
       #else
        ,'$key'
       #end
      #end
     )
#end
#if(${frmDate} != \'\' && ${toDate} != \'\')
 #if(${radDate} == \'DS\')
  AND A.LOCL_CRE_DT BETWEEN TO_DATE(@[frmDate], 'YYYYMMDD') AND TO_DATE(@[toDate], 'YYYYMMDD')+0.99999999
 #elseif(${radDate} == \'DB\')
  AND A.LOCL_CRE_DT BETWEEN TO_DATE(@[frmDate], 'YYYYMMDD')-21 AND TO_DATE(@[toDate], 'YYYYMMDD')+0.99999999
  AND C.BIL_EDI_SNT_DT BETWEEN TO_DATE(@[frmDate], 'YYYYMMDD') AND TO_DATE(@[toDate], 'YYYYMMDD')+0.99999999
 #elseif(${radDate} == \'DC\')
  AND A.CXL_RQST_DT BETWEEN TO_DATE(@[frmDate], 'YYYYMMDD') AND TO_DATE(@[toDate], 'YYYYMMDD')+0.99999999
 #end
#end
#if(${frmNode} != \'\')
 AND A.FM_NOD_CD LIKE @[frmNode]||'%'
#end
#if(${toNode} != \'\')
 AND A.TO_NOD_CD LIKE @[toNode]||'%'
#end
#if(${radVendor} == \'V2\' && ${svcProvid} != \'\')
 AND A.PROV_VNDR_SEQ = @[sSvcProvid]
#elseif(${radVendor} == \'V1\' && ${railRoad} != \'ALL\')
 AND B.VNDR_SEQ = @[railRoad]
#end
#if(${status} != \'ALL\')
 AND A.TRSP_SO_STS_CD = @[status]
#end
#if(${edKind} != \'ALL\')
 AND C.BIL_ISS_STS_CD = @[edKind]
#end
#if(${fuEmpy} != \'ALL\')
 AND A.CGO_TP_CD = @[fuEmpy]
#end
#if(${bound} != \'ALL\')
 AND A.TRSP_BND_CD = @[bound]
#end
#if(${bkgAtch} != \'ALL\')
 #if(${bkgAtch} == \'N\')
  AND BC.CNTR_NO IS NULL
  AND A.BKG_NO IS NOT NULL
 #elseif(${bkgAtch} == \'Y\')
  AND BC.CNTR_NO IS NOT NULL
  AND A.BKG_NO IS NOT NULL
 #end
#end
AND DECODE(@[unplanned], 'ALL', 'X', NVL(A.UPLN_SO_FLG, 'N')) = DECODE(@[unplanned], 'ALL', 'X', @[unplanned])
                GROUP BY
                    DECODE(C.BIL_ISS_KNT , A.BIL_ISS_KNT, 'Y' , NULL , 'Y' ),
                    A.CXL_RQST_FLG,
                    A.COP_NO,
                    A.COST_ACT_GRP_SEQ,
                    C.BIL_ISS_KNT,
                    A.TRSP_SO_OFC_CTY_CD,
                    A.TRSP_SO_SEQ,
                    A.REPO_PLN_ID,
                    A.PLN_YRWK,
                    A.REF_ID,
                    A.REF_SEQ,
                    A.RAIL_CMB_THRU_TP_CD,
                    A.CRE_OFC_CD,
                    A.BIL_ISS_STS_CD,
                    C.BKG_NO,
                    A.BKG_NO,
                    C.BIL_ISS_STS_CD,
                    C.BIL_EDI_SNT_DT,
                    C.BIL_EDI_RCV_RSLT_CD,
                    C.BIL_EDI_RCV_RSLT_DT,
                    C.MTC_EDI_IND_CD,
                    C.MTC_EDI_RCV_RSLT_FLG,
                    C.MTC_EDI_RCV_RSLT_DT,
                    NVL(C.INTER_RMK, A.INTER_RMK),
                    C.SPCL_INSTR_RMK,
                    C.RAIL_ORD_RJCT_FLG,
                    C.LOCL_CRE_DT,
                    C.CRE_USR_ID,
                    C.WO_RJCT_RSN,
                    A.AUTO_XPT_SYS_CD,
                    A.AUTO_XPT_SYS_NO,
                    C.WBL_NO
            ) X
        UNION ALL
        SELECT
            X.LASTCHK,
            X.INV_NO,
            X.CXL_RQST_FLG,
            X.COP_NO,
            X.COST_ACT_GRP_SEQ,
            X.SUB_RAIL_SEQ,
            X.VNDR_SEQ,
            X.BIL_ISS_KNT,
            X.TRSP_SO_OFC_CTY_CD,
            X.TRSP_SO_SEQ,
            X.REPO_PLN_ID,
            X.PLN_YRWK,
            X.REF_ID,
            X.REF_SEQ,
            X.RAIL_CMB_THRU_TP_CD,
            X.CRE_OFC_CD,
            X.BKG_CGO_TP_CD,
            X.TRSP_SO_STS_CD,
            X.TRSP_RAIL_BIL_TP_CD,
            X.EQ_NO,
            X.EQ_TPSZ_CD,
            X.CGO_TP_CD,
            X.CRE_DT,
            X.CRE_DT_HMS,
            X.BIL_ISS_STS_CD,
            X.FM_NOD_CD,
            X.FM_NOD_YARD,
            X.TO_NOD_CD,
            X.TO_NOD_YARD,
            X.VNDR_ABBR_NM,
			X.ROUT_PLN_CD,
            X.BL_NO,
            X.BKG_NO,
            X.BIL_EDI_SNT_DT,
            X.BIL_EDI_SNT_DT_HMS,
            CASE WHEN X.BIL_EDI_RSNT_DT = '20000101' THEN '' ELSE X.BIL_EDI_RSNT_DT END BIL_EDI_RSNT_DT,
            CASE WHEN X.BIL_EDI_RSNT_DT = '20000101' THEN '' ELSE X.BIL_EDI_RSNT_DT_HMS END BIL_EDI_RSNT_DT_HMS,
            X.BIL_EDI_RCV_RSLT_CD,
            X.BIL_EDI_RCV_RSLT_DT,
            X.BIL_EDI_RCV_RSLT_DT_HMS,
            X.WAYBILL_NO,
            X.MTC_EDI_IND_CD,
            X.MTC_EDI_RCV_RSLT_FLG,
            X.MTC_EDI_RCV_RSLT_DT,
            X.MTC_EDI_RCV_RSLT_DT_HMS,
            X.CFM_MSG_SNT_DT,
            X.CFM_MSG_SNT_DT_HMS,
            X.PROV_VNDR_SEQ,
            X.CXL_RQST_DT,
            X.CXL_RQST_DT_HMS,
            X.CXL_RQST_RSN,
            X.CXL_RQST_RJCT_DT,
            X.CXL_RQST_RJCT_DT_HMS,
            X.CXL_RQST_RJCT_RSN,
            (SELECT MAX(RMK.BKG_NO)
               FROM TRS_INTER_RMK RMK
              WHERE RMK.BKG_NO IN(X.BKG_NO, 'DUM000000000')
                AND NVL(RMK.EQ_NO, 'X') = NVL2(RMK.EQ_NO, X.EQ_NO, 'X')
                AND NVL(RMK.TRSP_SO_OFC_CTY_CD, 'XX') = NVL2(RMK.TRSP_SO_OFC_CTY_CD, X.TRSP_SO_OFC_CTY_CD, 'XX')
                AND NVL(RMK.TRSP_SO_SEQ, '99999') = NVL2(RMK.TRSP_SO_SEQ, X.TRSP_SO_SEQ, '99999')
                AND NVL(RMK.DELT_FLG, 'X') = 'N') AS INTER_RMK_CHK,
            X.INTER_RMK,
            X.SPCL_INSTR_RMK,
            X.SPCL_CGO_CNTR_TP_CD,
            X.RAIL_ORD_RJCT_FLG,
            X.CCREDT,
            X.SLAN_CD,
            X.TRUNKVVD,
            X.CNTR_WGT,
            X.IBD_NO,
            X.RAIL_CRR_REF_NO,
            X.SHPR_CUST_NM,
            X.CNEE_CUST_NM,
            X.EDI_USR_ID,
            X.TRSP_FRST_FLG,
            X.WO_RJCT_RSN,            
           ( SELECT AGMT.AGMT_REF_NO AS REF_NO FROM  TRS_AGMT_HDR AGMT  WHERE X.TRSP_AGMT_OFC_CTY_CD = AGMT.TRSP_AGMT_OFC_CTY_CD  AND   X.TRSP_AGMT_SEQ = AGMT.TRSP_AGMT_SEQ ) REF_NO,
            X.BKG_CNTR_ATTACHED,
            X.IBD_CSTMS_CLR_LOC_CD,
            X.POL_NOD_CD,
            X.POD_NOD_CD,
            X.TRSP_BND_CD,
            X.AUTO_XPT_SYS_CD,
            X.AUTO_XPT_SYS_NO
            ,( SELECT REPLACE(MDM_CO.CMDT_NM, CHR(13)||CHR(10), ' ') AS CMDT_NAME FROM MDM_COMMODITY MDM_CO, BKG_BOOKING B WHERE X.BKG_NO = B.BKG_NO AND   B.CMDT_CD = MDM_CO.CMDT_CD ) CMDT_NAME
            ,(
                SELECT
                    DECODE( BK.DCGO_FLG , 'Y', 'DG /') || 
                    DECODE( BK.RC_FLG , 'Y', 'RF /') || 
                    DECODE( BK.AWK_CGO_FLG , 'Y', 'AK /') || 
                    DECODE( BK.BB_CGO_FLG , 'Y', 'BB /') || 
                    DECODE( BK.SPCL_HIDE_FLG , 'Y', 'HD /') || 
                    DECODE( BK.FD_GRD_FLG , 'Y', 'FG /') || 
                    DECODE( BK.RAIL_BLK_CD, '', '', 'RB /') AS BKG_SPE
                FROM BKG_BOOKING BK
                WHERE X.BKG_NO = BK.BKG_NO
            ) BKG_SPE,
            X.CURR_CD,
            X.BZC_AMT,
            X.FUEL_SCG_AMT,
            X.OVR_WGT_SCG_AMT,
            X.HZD_MTRL_SCG_AMT,
            X.ETC_ADD_AMT,
            X.TRSP_AGMT_OFC_CTY_CD,
            X.TRSP_AGMT_SEQ,
            X.DELT_FLG,
			X.CND_CSTMS_CLR_FLG,
			X.UPLN_SO_FLG
        FROM
            (
                SELECT /*+ ORDERED USE_NL(A, B, C, CR, CFM, BC, D) */
                    MAX(DECODE(C.BIL_ISS_KNT, A.BIL_ISS_KNT, 'Y', A.BIL_ISS_KNT-1, 'Y', DECODE(SUBSTR(A.RAIL_CMB_THRU_TP_CD, 2, 1), '3', A.BIL_ISS_KNT-2 ), 'Y', NULL, 'Y')) AS LASTCHK,
                    MAX(B.INV_NO) AS INV_NO,
                    MAX(A.CXL_RQST_FLG) AS CXL_RQST_FLG,
                    MAX(A.COP_NO) AS COP_NO,
                    MAX(A.COST_ACT_GRP_SEQ) AS COST_ACT_GRP_SEQ,
                    B.SUB_RAIL_SEQ,
                    MAX(B.VNDR_SEQ) AS VNDR_SEQ,
                    C.BIL_ISS_KNT AS BIL_ISS_KNT,
                    A.TRSP_SO_OFC_CTY_CD AS TRSP_SO_OFC_CTY_CD,
                    A.TRSP_SO_SEQ AS TRSP_SO_SEQ,
                    MAX(A.REPO_PLN_ID) AS REPO_PLN_ID,
                    MAX(A.PLN_YRWK) AS PLN_YRWK,
                    MAX(A.REF_ID) AS REF_ID,
                    MAX(A.REF_SEQ) AS REF_SEQ,
                    MAX(A.RAIL_CMB_THRU_TP_CD) AS RAIL_CMB_THRU_TP_CD,
                    MAX(A.CRE_OFC_CD) AS CRE_OFC_CD,
                    MAX(A.BKG_CGO_TP_CD) AS BKG_CGO_TP_CD,
                    MAX(DECODE(NVL(C.BIL_ISS_STS_CD, A.TRSP_SO_STS_CD) , 'I', 'EDI Sent' , 'C', 'S/O Created' , 'R', 'S/O Corrected', 'S/O Created')) AS TRSP_SO_STS_CD,
                    MAX(A.TRSP_RAIL_BIL_TP_CD) AS TRSP_RAIL_BIL_TP_CD,
                    MAX(A.EQ_NO) AS EQ_NO,
                    MAX(A.EQ_TPSZ_CD) AS EQ_TPSZ_CD,
                    MAX(A.CGO_TP_CD) AS CGO_TP_CD,
                    MAX(TO_CHAR(A.LOCL_CRE_DT, 'YYYYMMDD')) AS CRE_DT,
                    MAX(TO_CHAR(A.LOCL_CRE_DT, 'HH24MISS')) AS CRE_DT_HMS,
                    MAX(C.BIL_ISS_STS_CD) AS BIL_ISS_STS_CD,
                    MAX(SUBSTR(A.FM_NOD_CD, 1, 5)) AS FM_NOD_CD,
                    MAX(SUBSTR(A.FM_NOD_CD, 6)) AS FM_NOD_YARD,
                    MAX(SUBSTR(A.TO_NOD_CD, 1, 5)) AS TO_NOD_CD,
                    MAX(SUBSTR(A.TO_NOD_CD, 6)) AS TO_NOD_YARD,
                    MAX(D.VNDR_ABBR_NM) AS VNDR_ABBR_NM,
					MAX(A.ROUT_PLN_CD) AS ROUT_PLN_CD,
                    MAX(A.BL_NO) AS BL_NO,
                    MAX(DECODE(A.BIL_ISS_STS_CD, 'I', C.BKG_NO, A.BKG_NO)) AS BKG_NO,
                    MAX(TO_CHAR(C.BIL_EDI_SNT_DT, 'YYYYMMDD')) AS BIL_EDI_SNT_DT,
                    MAX(TO_CHAR(C.BIL_EDI_SNT_DT, 'HH24MISS')) AS BIL_EDI_SNT_DT_HMS,
                    MAX( TO_CHAR( GREATEST( 
                                            NVL( CR.BIL_EDI_RSND_DT, TO_DATE('20000101', 'YYYYMMDD') ),
                                            NVL( C.BIL_EDI_RSND_DT, TO_DATE('20000101', 'YYYYMMDD') )
                                            ) , 'YYYYMMDD'
                                )
                        ) AS BIL_EDI_RSNT_DT,
                    MAX( TO_CHAR( GREATEST( 
                                            NVL( CR.BIL_EDI_RSND_DT, TO_DATE('20000101', 'YYYYMMDD') ),
                                            NVL( C.BIL_EDI_RSND_DT, TO_DATE('20000101', 'YYYYMMDD') )
                                            ) , 'HH24MISS'
                                )
                        ) AS BIL_EDI_RSNT_DT_HMS,
                    MAX(C.BIL_EDI_RCV_RSLT_CD) AS BIL_EDI_RCV_RSLT_CD,
                    MAX(TO_CHAR(C.BIL_EDI_RCV_RSLT_DT, 'YYYYMMDD')) AS BIL_EDI_RCV_RSLT_DT,
                    MAX(TO_CHAR(C.BIL_EDI_RCV_RSLT_DT, 'HH24MISS')) AS BIL_EDI_RCV_RSLT_DT_HMS,
                    C.WBL_NO AS WAYBILL_NO,
                    MAX(C.MTC_EDI_IND_CD) AS MTC_EDI_IND_CD,
                    MAX(C.MTC_EDI_RCV_RSLT_FLG) AS MTC_EDI_RCV_RSLT_FLG,
                    MAX(TO_CHAR(C.MTC_EDI_RCV_RSLT_DT, 'YYYYMMDD')) AS MTC_EDI_RCV_RSLT_DT,
                    MAX(TO_CHAR(C.MTC_EDI_RCV_RSLT_DT, 'HH24MISS')) AS MTC_EDI_RCV_RSLT_DT_HMS,
                    MAX(TO_CHAR(CFM.SND_DT, 'YYYYMMDD')) AS CFM_MSG_SNT_DT,
                    MAX(TO_CHAR(CFM.SND_DT, 'HH24MISS')) AS CFM_MSG_SNT_DT_HMS,
                    MAX(A.PROV_VNDR_SEQ) AS PROV_VNDR_SEQ,
                    MAX(TO_CHAR(A.CXL_RQST_DT, 'YYYYMMDD')) AS CXL_RQST_DT,
                    MAX(TO_CHAR(A.CXL_RQST_DT, 'HH24MISS')) AS CXL_RQST_DT_HMS,
                    MAX(A.CXL_RQST_RSN) AS CXL_RQST_RSN,
                    MAX(TO_CHAR(A.CXL_RQST_RJCT_DT, 'YYYYMMDD')) AS CXL_RQST_RJCT_DT,
                    MAX(TO_CHAR(A.CXL_RQST_RJCT_DT, 'HH24MISS')) AS CXL_RQST_RJCT_DT_HMS,
                    MAX(C.CXL_RQST_RJCT_RSN) AS CXL_RQST_RJCT_RSN,
                    MAX(NVL(C.INTER_RMK, A.INTER_RMK)) AS INTER_RMK,
                    MAX(C.SPCL_INSTR_RMK) AS SPCL_INSTR_RMK,
                    MAX(A.SPCL_CGO_CNTR_TP_CD) AS SPCL_CGO_CNTR_TP_CD,
                    MAX(C.RAIL_ORD_RJCT_FLG) AS RAIL_ORD_RJCT_FLG,
                    MAX(C.LOCL_CRE_DT) AS CCREDT,
                    MAX(A.SLAN_CD) AS SLAN_CD,
                    MAX(A.VSL_CD||A.SKD_VOY_NO||A.SKD_DIR_CD) AS TRUNKVVD,
                    MAX(A.CNTR_WGT) AS CNTR_WGT,
                    MAX(A.IBD_NO) AS IBD_NO,
                    MAX(A.RAIL_CRR_REF_NO) AS RAIL_CRR_REF_NO,
                    MAX(A.SHPR_CUST_NM) AS SHPR_CUST_NM,
                    MAX(A.CNEE_CUST_NM) AS CNEE_CUST_NM,
                    MAX(C.CRE_USR_ID) AS EDI_USR_ID,
                    MAX(A.TRSP_FRST_FLG) AS TRSP_FRST_FLG,
                    MAX(C.WO_RJCT_RSN) AS WO_RJCT_RSN,
                    MAX(DECODE(A.CGO_TP_CD, 'M', NULL, DECODE(BC.CNTR_NO, NULL, 'N', 'Y'))) AS BKG_CNTR_ATTACHED,
                    MAX(A.IBD_CSTMS_CLR_LOC_CD) AS IBD_CSTMS_CLR_LOC_CD,
                    MAX(A.POL_NOD_CD) AS POL_NOD_CD,
                    MAX(A.POD_NOD_CD) AS POD_NOD_CD,
                    MAX(A.TRSP_BND_CD) AS TRSP_BND_CD,
                    A.AUTO_XPT_SYS_CD AS AUTO_XPT_SYS_CD,
                    A.AUTO_XPT_SYS_NO AS AUTO_XPT_SYS_NO,
                    MAX(B.TRSP_AGMT_OFC_CTY_CD) AS TRSP_AGMT_OFC_CTY_CD,
                    MAX(B.TRSP_AGMT_SEQ) AS TRSP_AGMT_SEQ,
                    MAX(B.CURR_CD) CURR_CD,
                    SUM(B.BZC_AMT) BZC_AMT,
                    SUM(B.FUEL_SCG_AMT) FUEL_SCG_AMT,
                    SUM(B.OVR_WGT_SCG_AMT) OVR_WGT_SCG_AMT,
                    SUM(B.HZD_MTRL_SCG_AMT) HZD_MTRL_SCG_AMT,
                    SUM(B.ETC_ADD_AMT) ETC_ADD_AMT,
                    MAX(A.DELT_FLG) DELT_FLG,
					MAX(A.CND_CSTMS_CLR_FLG) CND_CSTMS_CLR_FLG,
					MAX(A.UPLN_SO_FLG) UPLN_SO_FLG
                FROM
                    TRS_TRSP_RAIL_BIL_ORD A,
                    TRS_TRSP_RAIL_BIL_VNDR_SET B,
                    TRS_TRSP_EDI_RAIL_ORD C,
                    TRS_TRSP_EDI_RAIL_ORD_RSND CR,
                    BKG_CONTAINER BC,
                    MDM_VENDOR D,
                    TRS_TRSP_CFM_MSG_HIS CFM
                WHERE A.TRSP_SO_OFC_CTY_CD = B.TRSP_SO_OFC_CTY_CD
                AND   A.TRSP_SO_SEQ = B.TRSP_SO_SEQ
                AND   A.TRSP_SO_OFC_CTY_CD = C.TRSP_SO_OFC_CTY_CD (+)
                AND   A.TRSP_SO_SEQ = C.TRSP_SO_SEQ (+)
                AND   A.TRSP_SO_OFC_CTY_CD = CR.TRSP_SO_OFC_CTY_CD (+)
                AND   A.TRSP_SO_SEQ = CR.TRSP_SO_SEQ (+)
                AND   B.VNDR_SEQ = NVL(C.VNDR_SEQ, B.VNDR_SEQ)
                AND   A.TRSP_SO_OFC_CTY_CD = CFM.TRSP_SO_OFC_CTY_CD (+)
                AND   A.TRSP_SO_SEQ = CFM.TRSP_SO_SEQ (+)
                AND   A.BKG_NO = BC.BKG_NO (+)
                AND   A.EQ_NO = BC.CNTR_NO (+)
                AND   B.VNDR_SEQ = D.VNDR_SEQ
                AND   A.RAIL_CMB_THRU_TP_CD IN ('S2R', 'S3R')
#if(${incHistory} != \'H\')
                AND   A.DELT_FLG = 'N'
#end
                AND   NVL(A.SPND_FLG, 'N') = 'N'
                AND   A.CRE_OFC_CD = @[ctrlOfcCd]               
#if($vvd.size() > 0)
 AND ((A.VSL_CD, A.SKD_VOY_NO, A.SKD_DIR_CD) IN (
 #foreach($key IN ${vvd})
  #if($velocityCount == 1)      
   ( SUBSTR('$key', 1, 4), SUBSTR('$key', 5, 4), SUBSTR('$key', 9))
  #else
   , ( SUBSTR('$key', 1, 4), SUBSTR('$key', 5, 4), SUBSTR('$key', 9))
  #end
 #end
  )
 )
#end
#if($bl.size() > 0)
 AND (A.BL_NO IN ( 
      #foreach($key IN ${bl})
       #if($velocityCount == 1)
        '$key'
       #else
        ,'$key'
       #end
      #end
     )
  )
#end
#if($cntr.size() > 0)
 AND A.EQ_NO IN (
      #foreach($key IN ${cntr})
       #if($velocityCount == 1)
        '$key'
       #else
        ,'$key'
       #end
      #end
     )
#end
#if($ref_no.size() > 0)
 AND A.REF_ID IN (
      #foreach($key IN ${ref_no})
       #if($velocityCount == 1)
        '$key'
       #else
        ,'$key'
       #end
      #end
     )
#end
#if(${frmDate} != \'\' && ${toDate} != \'\')
 #if(${radDate} == \'DS\')
  AND A.LOCL_CRE_DT BETWEEN TO_DATE(@[frmDate], 'YYYYMMDD') AND TO_DATE(@[toDate], 'YYYYMMDD')+0.99999999
 #elseif(${radDate} == \'DB\')
  AND A.LOCL_CRE_DT BETWEEN TO_DATE(@[frmDate], 'YYYYMMDD')-21 AND TO_DATE(@[toDate], 'YYYYMMDD')+0.99999999
  AND C.BIL_EDI_SNT_DT BETWEEN TO_DATE(@[frmDate], 'YYYYMMDD') AND TO_DATE(@[toDate], 'YYYYMMDD')+0.99999999
 #elseif(${radDate} == \'DC\')
  AND A.CXL_RQST_DT BETWEEN TO_DATE(@[frmDate], 'YYYYMMDD') AND TO_DATE(@[toDate], 'YYYYMMDD')+0.99999999
 #end
#end
#if(${frmNode} != \'\')
 AND A.FM_NOD_CD LIKE @[frmNode]||'%'
#end
#if(${toNode} != \'\')
 AND A.TO_NOD_CD LIKE @[toNode]||'%'
#end
#if(${radVendor} == \'V2\' && ${svcProvid} != \'\')
 AND A.PROV_VNDR_SEQ = @[sSvcProvid]
#elseif(${radVendor} == \'V1\' && ${railRoad} != \'ALL\')
 AND B.VNDR_SEQ = @[railRoad]
#end
#if(${status} != \'ALL\')
 AND A.TRSP_SO_STS_CD = @[status]
#end
#if(${edKind} != \'ALL\')
 AND C.BIL_ISS_STS_CD = @[edKind]
#end
#if(${fuEmpy} != \'ALL\')
 AND A.CGO_TP_CD = @[fuEmpy]
#end
#if(${bound} != \'ALL\')
 AND A.TRSP_BND_CD = @[bound]
#end
#if(${bkgAtch} != \'ALL\')
 #if(${bkgAtch} == \'N\')
  AND BC.CNTR_NO IS NULL
  AND A.BKG_NO IS NOT NULL
 #elseif(${bkgAtch} == \'Y\')
  AND BC.CNTR_NO IS NOT NULL
  AND A.BKG_NO IS NOT NULL
 #end
#end
AND DECODE(@[unplanned], 'ALL', 'X', NVL(A.UPLN_SO_FLG, 'N')) = DECODE(@[unplanned], 'ALL', 'X', @[unplanned])
                GROUP BY 
                        A.TRSP_SO_OFC_CTY_CD, 
                        A.TRSP_SO_SEQ, 
                        B.SUB_RAIL_SEQ, 
                        C.BIL_ISS_KNT, 
                        A.AUTO_XPT_SYS_CD, 
                        A.AUTO_XPT_SYS_NO,
                        C.WBL_NO
            ) X
    ) M,
    TRS_TRSP_RAIL_EDI_NOD S,
    TRS_TRSP_RAIL_EDI_NOD T
WHERE NVL(M.POL_NOD_CD, M.FM_NOD_CD||M.FM_NOD_YARD) = S.EDI_RCV_NOD_CD (+)
AND   NVL(M.POD_NOD_CD, M.TO_NOD_CD||M.TO_NOD_YARD) = T.EDI_RCV_NOD_CD (+)
#if(${incHistory} != \'H\')
 AND M.LASTCHK = 'Y'
 AND NOT EXISTS (SELECT 1
                   FROM TRS_TRSP_RAIL_BIL_VNDR_SET S1
                         WHERE S1.TRSP_SO_OFC_CTY_CD = M.TRSP_SO_OFC_CTY_CD
                           AND S1.TRSP_SO_SEQ = M.TRSP_SO_SEQ
                           AND S1.INV_NO IS NOT NULL)
#end
GROUP BY
    M.INV_NO, M.LASTCHK, M.COP_NO, M.COST_ACT_GRP_SEQ, M.SUB_RAIL_SEQ, M.VNDR_SEQ, 
    M.TRSP_SO_OFC_CTY_CD,
    M.TRSP_SO_SEQ,
    M.WO_RJCT_RSN,
    M.CXL_RQST_FLG,
    M.REPO_PLN_ID,
    M.PLN_YRWK,
    M.REF_ID,
    M.REF_SEQ,
    M.RAIL_CMB_THRU_TP_CD,
    M.CRE_OFC_CD,
    M.BKG_CGO_TP_CD,
    M.TRSP_SO_STS_CD,
    M.TRSP_RAIL_BIL_TP_CD,
    M.EQ_NO,
    M.EQ_TPSZ_CD,
    M.CGO_TP_CD,
    M.CRE_DT,
    M.CRE_DT_HMS,
    M.BIL_ISS_STS_CD,
    M.FM_NOD_CD,
    M.FM_NOD_YARD,
    M.TO_NOD_CD,
    M.TO_NOD_YARD,
    M.VNDR_ABBR_NM,
    M.ROUT_PLN_CD,
    M.BL_NO,
    M.BKG_NO,
    M.BIL_EDI_SNT_DT,
    M.BIL_EDI_SNT_DT_HMS,
    M.BIL_EDI_RSNT_DT,
    M.BIL_EDI_RSNT_DT_HMS,
    M.BIL_EDI_RCV_RSLT_DT,
    M.BIL_EDI_RCV_RSLT_DT_HMS,
    M.WAYBILL_NO, 
    M.MTC_EDI_RCV_RSLT_FLG,
    M.MTC_EDI_RCV_RSLT_DT,
    SUBSTR(M.BKG_SPE, 0, LENGTH(M.BKG_SPE)-1),
    M.SPCL_CGO_CNTR_TP_CD,
    M.MTC_EDI_RCV_RSLT_DT_HMS,
    M.CFM_MSG_SNT_DT,
    M.CFM_MSG_SNT_DT_HMS,
    M.PROV_VNDR_SEQ,
    M.CXL_RQST_DT,
    M.CXL_RQST_DT_HMS,
    M.CXL_RQST_RSN,
    M.CXL_RQST_RJCT_DT,
    M.CXL_RQST_RJCT_DT_HMS,
    M.CXL_RQST_RJCT_RSN,
    M.SPCL_INSTR_RMK,
    M.RAIL_ORD_RJCT_FLG,
    TO_CHAR(M.CCREDT, 'YYYYMMDDHH24MISS'),
    M.BIL_ISS_KNT, S.EDI_RCV_VNDR_ABBR_NM, T.EDI_RCV_VNDR_ABBR_NM,
    M.SLAN_CD,
    M.TRUNKVVD,
    M.CNTR_WGT,
    M.IBD_NO,
    M.RAIL_CRR_REF_NO,
    M.SHPR_CUST_NM,
    M.CNEE_CUST_NM,
    M.EDI_USR_ID,
    M.TRSP_FRST_FLG,
    M.CMDT_NAME,
    M.REF_NO,
    M.AUTO_XPT_SYS_CD,
    M.AUTO_XPT_SYS_NO,
    M.BKG_CNTR_ATTACHED,
    M.IBD_CSTMS_CLR_LOC_CD,
    M.TRSP_BND_CD,
    M.BIL_EDI_RCV_RSLT_CD,
    M.DELT_FLG
ORDER BY 
    M.TRSP_SO_OFC_CTY_CD, M.TRSP_SO_SEQ, M.BIL_ISS_KNT DESC			]]></sql>
			<params>
				<param name="ctrlOfcCd" type="12" value="" out="N"/>
				<param name="frmDate" type="12" value="" out="N"/>
				<param name="toDate" type="12" value="" out="N"/>
				<param name="frmNode" type="12" value="" out="N"/>
				<param name="toNode" type="12" value="" out="N"/>
				<param name="sSvcProvid" type="12" value="" out="N"/>
				<param name="railRoad" type="12" value="" out="N"/>
				<param name="status" type="12" value="" out="N"/>
				<param name="edKind" type="12" value="" out="N"/>
				<param name="fuEmpy" type="12" value="" out="N"/>
				<param name="bound" type="12" value="" out="N"/>
				<param name="unplanned" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
