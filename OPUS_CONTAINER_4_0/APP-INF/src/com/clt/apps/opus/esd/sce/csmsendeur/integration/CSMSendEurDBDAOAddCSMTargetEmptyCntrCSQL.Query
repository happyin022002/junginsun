<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="CSMSendEurDBDAOAddCSMTargetEmptyCntrCSQL">
			<desc><![CDATA[Empty Container Movement 를 대상으로 해당 MVMT 에 딸린 Booking 의 VVD 중 POD/DEL 도착까지 구주를 경유하는지
조회하여 대상이면 SCE_CSM_TGT_EUR 에 insert]]></desc>
			<sql><![CDATA[
INSERT
INTO SCE_CSM_TGT_EUR 
(
     ACT_RCV_DT, 
     ACT_RCV_NO, 
     BKG_NO, 
     CNTR_NO, 
     CSM_CNT_CD, 
     ACT_DT, 
     ACT_STS_MAPG_CD, 
     NOD_CD, 
     ACT_RCV_TP_CD, 
     ACT_UMCH_TP_CD, 
     VSL_CD, 
     SKD_VOY_NO, 
     SKD_DIR_CD, 
     COP_EVNT_SEQ, 
     CNTR_CGO_TP_CD, 
     CNMV_CO_CD, 
     CRE_USR_ID, 
     CRE_DT, 
     UPD_USR_ID, 
     UPD_DT 
) 
(

    SELECT 
      TO_CHAR(SYSDATE,'YYYYMMDD') AS ACT_RCV_DT,
      SCE_CSM_TGT_EUR_SEQ1.NEXTVAL AS ACT_RCV_NO, -- SEQUENCE 등록 필요 7자리
      A.BKG_NO,
      A.CNTR_NO,
      CASE WHEN SUBSTR(B.POR_CD,1,2) IN (SELECT CNT_CD FROM MDM_COUNTRY WHERE EU_CNT_FLG = 'Y') THEN SUBSTR(B.POR_CD,1,2) 
                   WHEN SUBSTR(B.POL_CD,1,2) IN (SELECT CNT_CD FROM MDM_COUNTRY WHERE EU_CNT_FLG = 'Y') THEN SUBSTR(B.POL_CD,1,2)
                   WHEN SUBSTR(B.POD_CD,1,2) IN (SELECT CNT_CD FROM MDM_COUNTRY WHERE EU_CNT_FLG = 'Y') THEN SUBSTR(B.POD_CD,1,2)
                   WHEN SUBSTR(B.DEL_CD,1,2) IN (SELECT CNT_CD FROM MDM_COUNTRY WHERE EU_CNT_FLG = 'Y') THEN SUBSTR(B.DEL_CD,1,2)
          ELSE 'XX' END AS CSM_CNT_CD,
      A.CNMV_EVNT_DT AS ACT_DT,
      A.MVMT_STS_CD AS ACT_STS_MAPG_CD,
      A.ORG_YD_CD AS NOD_CD,
      1 AS ACT_RCV_TP_CD,
      '00' AS ACT_UMCH_TP_CD,
      A.CRNT_VSL_CD AS VSL_CD,
      A.CRNT_SKD_VOY_NO AS SKD_VOY_NO,
      A.CRNT_SKD_DIR_CD AS SKD_DIR_CD,
      0 AS COP_EVNT_SEQ,
      A.BKG_CGO_TP_CD AS CNTR_CGO_TP_CD,
      A.CNMV_CO_CD,
      'EMPTY' AS CRE_USR_ID,
      SYSDATE AS CRE_DT,
      'EMPTY' AS UPD_USR_ID,
      SYSDATE AS UPD_DT
    FROM 
      CTM_MOVEMENT A,
      BKG_BOOKING B,
      BKG_VVD V
   WHERE 1=1
     AND A.UPD_DT BETWEEN TO_DATE(TO_CHAR(SYSDATE-(2/24),'YYYYMMDDHH24')||'00','YYYYMMDDHH24MI') AND SYSDATE
     AND A.BKG_CGO_TP_CD = 'P' -- EMPTY CONTAINER
     AND A.BKG_NO = B.BKG_NO
     AND B.BKG_NO = V.BKG_NO
     AND NOT EXISTS (
             SELECT 'X'
               FROM SCE_CSM_TGT_EUR
              WHERE CNTR_NO = A.CNTR_NO
                AND BKG_NO = A.BKG_NO
                AND ACT_STS_MAPG_CD = A.MVMT_STS_CD
             )
     AND (
             EXISTS (
             SELECT 'X' 
               FROM MDM_COUNTRY M
              WHERE 1=1
                AND M.CNT_CD IN (SUBSTR(B.POR_CD,1,2), SUBSTR(B.POL_CD,1,2), SUBSTR(B.POD_CD,1,2), SUBSTR(B.DEL_CD,1,2))
                AND M.EU_CNT_FLG = 'Y'
             )
             OR 
             
             EXISTS (
             SELECT 'X' 
               FROM MDM_COUNTRY M
              WHERE 1=1
                AND M.CNT_CD IN (SUBSTR(V.POL_CD,1,2), SUBSTR(V.POD_CD,1,2))
                AND M.EU_CNT_FLG = 'Y'
             )
         )
)			]]></sql>
			<params>
			</params>
		</query>
	</querys>
</sqls>
