<?xml version="1.0" encoding="UTF-8"?>
<sqls>
	<querys>
		<query name="RailSoManageDBDAOSearch08RailSoManageRSQL">
			<desc><![CDATA[US Rail Empty SO 대상 조회 SQL]]></desc>
			<sql><![CDATA[
SELECT  /*+ INDEX(A XAK3EQR_REPO_EXE_SO_IF) USE_NL(A,  LOC) */ 
	A.SO_IF_DIV_CD TRSP_COST_DTL_MOD_CD, 
	DECODE(A.SO_IF_DIV_CD, 'O', 'On-Hire', 'F', 'Off-Hire', 'Empty Repo') TRSP_COST_DTL_MOD_NAME, 
	A.REF_ID,  
	COUNT(A.REF_ID)  ALLOCATED,  
	SUM( DECODE( SO.TRSP_SO_STS_CD ,'C',1,'R',1,0 )) CRET_QTY,  
	COUNT(SO.WO_ISS_DT ) EDI_QTY,  
	SUM( DECODE(SO.TRSP_SO_SEQ , NULL , 1, 0 )) REMAINING_QTY,  
	SUM( DECODE(SO.TRSP_SO_SEQ , NULL , 1, 0 )) NEEDED_QTY,  
	A.TRSP_MOD_CD TRSP_CRR_MOD_CD, 	
	A.FM_YD_CD FM_NOD_CD, 	
	A.TO_YD_CD TO_NOD_CD, 
	A.CNTR_TPSZ_CD EQ_TPSZ_CD, 
	A.SO_RQST_DT REQUESTED_DATE , 	
	TO_CHAR(GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC( @[sctrlOfcCd] ) ,'RRRRMMDD') CURR_DT 
FROM 
    EQR_REPO_EXE_SO_IF A, 
    TRS_TRSP_RAIL_BIL_ORD SO, 
    MDM_LOCATION LOC 
WHERE A.REPO_PLN_ID = SO.REPO_PLN_ID(+)	
AND   A.PLN_YRWK = SO.PLN_YRWK(+)
AND   A.REF_ID = SO.REF_ID(+)
AND   A.REF_SEQ = SO.REF_SEQ(+) 
AND   A.WO_RQST_FLG = 'Y'
AND   SUBSTR(A.FM_YD_CD, 1, 5) = LOC.LOC_CD 
AND   A.CO_CD = 'H'
AND   A.SO_IF_DIV_CD NOT IN ('O','F')
AND   EXISTS (SELECT 1 FROM MDM_COUNTRY CNTY WHERE CNTY.CNT_CD IN('US', 'CA') AND LOC.CONTI_CD = 'M' AND A.TRSP_MOD_CD = 'R' AND LOC.CNT_CD = CNTY.CNT_CD)

#if(${splanFromDate} != '' && ${splanToDate} != '')
	AND A.SO_RQST_DT BETWEEN @[splanFromDate] AND @[splanToDate]
#end

#if(${sfromLocationCd} != '')
	AND A.FM_YD_CD LIKE @[sfromLocationCd]||'%'
#end

#if(${stoLocationCd} != '')
	AND A.TO_YD_CD LIKE @[stoLocationCd]||'%'
#end

#if($cntr.size() > 0)
	AND A.CNTR_NO IN (
	#foreach($key IN ${cntr})
		#if($velocityCount == 1)						
			'$key'
		#else
			,'$key'
		#end
	#end
	)
#end

#if(${cntrType} != 'ALL')
	AND SUBSTR(A.CNTR_TPSZ_CD, 1, 1) = @[cntrType]
#end

#if(${cntrSize} != 'ALL')
	AND SUBSTR(A.CNTR_TPSZ_CD, 2, 1) = @[cntrSize]
#end

#if($refId.size() > 0)
	AND A.REF_ID IN (
	#foreach($key IN ${refId})
		#if($velocityCount == 1)						
			'$key'
		#else
			,'$key'
		#end
	#end
	)
#end

AND   A.EQ_CTRL_OFC_CD = @[sctrlOfcCd] 
AND   SO.DELT_FLG(+) = 'N'
GROUP BY 
    A.SO_IF_DIV_CD,
    DECODE(A.SO_IF_DIV_CD, 'O', 'On-Hire', 'F', 'Off-Hire', 'Empty Repo'),
	A.REF_ID,
	A.TRSP_MOD_CD,
	A.FM_YD_CD,
	A.TO_YD_CD,
	A.CNTR_TPSZ_CD,
	A.SO_RQST_DT,
	TO_CHAR(GLOBALDATE_PKG.TIME_LOCAL_OFC_FNC( @[sctrlOfcCd] ) ,'RRRRMMDD')
ORDER BY
    A.SO_IF_DIV_CD,
    A.SO_RQST_DT,
    A.REF_ID,
    A.CNTR_TPSZ_CD			]]></sql>
			<params>
				<param name="sctrlOfcCd" type="12" value="" out="N"/>
				<param name="splanFromDate" type="12" value="" out="N"/>
				<param name="splanToDate" type="12" value="" out="N"/>
				<param name="sfromLocationCd" type="12" value="" out="N"/>
				<param name="stoLocationCd" type="12" value="" out="N"/>
				<param name="cntrType" type="12" value="" out="N"/>
				<param name="cntrSize" type="12" value="" out="N"/>
			</params>
		</query>
	</querys>
</sqls>
