
WITH ROUT AS
(
    SELECT RK,RK2,FM_NOD_CD,TO_NOD_CD,MODE_CD,VNDR_SEQ,COMB_MOD,COST_ACT_SEQ,
           LAG_NOD,LAG_COST_ACT_GRP_SEQ,
           (CASE WHEN RK2 = 1 AND LAG_NOD = FM_NOD_CD AND LAG_COST_ACT_GRP_SEQ IS NOT NULL
--                  AND  (SELECT 'X' FROM PRD_PROD_CTL_ROUT_DTL
--                        WHERE PCTL_NO  = (SELECT DECODE(:IO_BND_CD,'O',OB_PCTL_NO,'I',IB_PCTL_NO,PCTL_NO) 
--                                         FROM SCE_COP_HDR
--                                         WHERE COP_NO = :COP_NO)
--                        AND PCTL_IO_BND_CD =:IO_BND_CD 
--                        AND NOD_LNK_DIV_CD = 'L'
--                        AND PCTL_SEQ >   (SELECT MAX(PCTL_SEQ) FROM PRD_PROD_CTL_ROUT_DTL
--                                                WHERE PCTL_NO = (SELECT DECODE(:IO_BND_CD,'O',OB_PCTL_NO,'I',IB_PCTL_NO,PCTL_NO) 
--                                                                 FROM SCE_COP_HDR
--                                                                 WHERE COP_NO = :COP_NO)
--                                                  AND COST_ACT_GRP_SEQ  = LAG_COST_ACT_GRP_SEQ)
--                        AND  PCTL_SEQ <     (SELECT MIN(PCTL_SEQ) FROM PRD_PROD_CTL_ROUT_DTL
--                                                WHERE PCTL_NO = (SELECT DECODE(:IO_BND_CD,'O',OB_PCTL_NO,'I',IB_PCTL_NO,PCTL_NO) 
--                                                                 FROM SCE_COP_HDR
--                                                                 WHERE COP_NO = :COP_NO)
--                                                  AND COST_ACT_GRP_SEQ  = COST_ACT_SEQ)
--                        AND ROWNUM =1 ) IS NULL 
                        THEN -1
                 ELSE 0
           END) LAG_SEQ
                        
    FROM (       
        SELECT DENSE_RANK() OVER (ORDER BY COST_ACT_GRP_SEQ,SEQ) RK,
               DENSE_RANK() OVER (PARTITION BY COST_ACT_GRP_SEQ ORDER BY SEQ) RK2,
               FM_NOD_CD,TO_NOD_CD,MODE_CD,VNDR_SEQ,COMB_MOD,COST_ACT_GRP_SEQ COST_ACT_SEQ,
               LAG(TO_NOD_CD,1) OVER( ORDER BY COST_ACT_GRP_SEQ, SEQ) LAG_NOD,
               LAG(COST_ACT_GRP_SEQ,1) OVER (ORDER BY COST_ACT_GRP_SEQ,SEQ) LAG_COST_ACT_GRP_SEQ
        FROM (
            SELECT SEQ,FM_NOD_CD,TO_NOD_CD,MODE_CD,VNDR_SEQ,COMB_MOD,COST_ACT_GRP_SEQ --XXXXX
            FROM (
                SELECT 
                (                                                                                                
                CASE F_N0                                                                                        
                    WHEN 0 THEN '1'    WHEN 1 THEN '2'  
                    ELSE 'N/A'                                                                                   
                END                                                                                              
                ) SEQ,
                (                                                                                                
                CASE F_N0                                                                                        
                    WHEN 0 THEN SUBSTR(ROUT,1,7)    WHEN 1 THEN SUBSTR(ROUT,16,7)  
                    ELSE 'N/A'                                                                                   
                END                                                                                              
                ) FM_NOD_CD,
                (                                                                                                
                CASE F_N0                                                                                        
                    WHEN 0 THEN SUBSTR(ROUT,16,7)    WHEN 1 THEN SUBSTR(ROUT,31,7)  
                    ELSE 'N/A'                                                                                   
                END                                                                                              
                ) TO_NOD_CD,
                (                                                                                                
                CASE F_N0                                                                                        
                    WHEN 0 THEN SUBSTR(ROUT,8,2)    WHEN 1 THEN SUBSTR(ROUT,23,2)  
                    ELSE 'N/A'                                                                                   
                END                                                                                              
                ) MODE_CD,
                (                                                                                                
                CASE F_N0                                                                                        
                    WHEN 0 THEN TO_NUMBER(SUBSTR(ROUT,10,6))    WHEN 1 THEN TO_NUMBER(SUBSTR(ROUT,25,6))  
                    ELSE NULL                                                                                  
                END                                                                                              
                ) VNDR_SEQ,
                (                                                                                                
                CASE WHEN LENGTH(ROUT) > 22  THEN 'Y' 
                    ELSE 'N'                                                                                  
                END                                                                                              
                ) COMB_MOD,
                TRSP_BND_CD,
                COST_ACT_GRP_SEQ  
                FROM 
                (
                SELECT 
                (CASE 
                    WHEN TRSP_BND_CD = 'O' AND TRIM(DOR_NOD_CD) IS NOT NULL
                           THEN DECODE(TRSP_BND_CD,'O',TRIM(DOR_NOD_CD),TRIM(VIA_NOD_CD))||DECODE(DECODE(TRSP_BND_CD,'O',TRIM(DOR_NOD_CD),TRIM(VIA_NOD_CD)),NULL,NULL,DECODE(TRSP_BND_CD,'O',SUBSTR(TRSP_CRR_MOD_CD,1,1)||'D',DECODE(SUBSTR(TRSP_CRR_MOD_CD,2,1),'D',TRSP_CRR_MOD_CD,SUBSTR(TRSP_CRR_MOD_CD,2,1)||'D')))||
                                  DECODE(DECODE(TRSP_BND_CD,'O',TRIM(DOR_NOD_CD),TRIM(VIA_NOD_CD)),NULL,NULL,LPAD(VNDR_SEQ,6,0))||
                                DECODE(TRSP_BND_CD,'O',TRIM(VIA_NOD_CD),TRIM(DOR_NOD_CD))||DECODE(DECODE(TRSP_BND_CD,'O',TRIM(VIA_NOD_CD),TRIM(DOR_NOD_CD)),NULL,NULL,DECODE(SUBSTR(TRSP_CRR_MOD_CD,2,1),'D',TRSP_CRR_MOD_CD,SUBSTR(TRSP_CRR_MOD_CD,2,1)||'D'))||
                                  DECODE(DECODE(TRSP_BND_CD,'O',TRIM(VIA_NOD_CD),TRIM(DOR_NOD_CD)),NULL,NULL,LPAD(VNDR_SEQ,6,0))||TO_NOD_CD
                      WHEN TRSP_BND_CD = 'I' AND TRIM(DOR_NOD_CD) IS NOT NULL
                           THEN FM_NOD_CD||SUBSTR(TRSP_CRR_MOD_CD,1,1)||'D'||LPAD(VNDR_SEQ,6,0)||
                                DECODE(TRSP_BND_CD,'O',TRIM(DOR_NOD_CD),TRIM(VIA_NOD_CD))||DECODE(DECODE(TRSP_BND_CD,'O',TRIM(DOR_NOD_CD),TRIM(VIA_NOD_CD)),NULL,NULL,DECODE(TRSP_BND_CD,'O',SUBSTR(TRSP_CRR_MOD_CD,1,1)||'D',DECODE(SUBSTR(TRSP_CRR_MOD_CD,2,1),'D',TRSP_CRR_MOD_CD,SUBSTR(TRSP_CRR_MOD_CD,2,1)||'D')))||
                                  DECODE(DECODE(TRSP_BND_CD,'O',TRIM(DOR_NOD_CD),TRIM(VIA_NOD_CD)),NULL,NULL,LPAD(VNDR_SEQ,6,0))||
                                DECODE(TRSP_BND_CD,'O',TRIM(VIA_NOD_CD),TRIM(DOR_NOD_CD))
                           ELSE  
                                FM_NOD_CD||SUBSTR(TRSP_CRR_MOD_CD,1,1)||'D'||LPAD(VNDR_SEQ,6,0)||
                                DECODE(TRSP_BND_CD,'O',TRIM(DOR_NOD_CD),TRIM(VIA_NOD_CD))||DECODE(DECODE(TRSP_BND_CD,'O',TRIM(DOR_NOD_CD),TRIM(VIA_NOD_CD)),NULL,NULL,DECODE(TRSP_BND_CD,'O',SUBSTR(TRSP_CRR_MOD_CD,1,1)||'D',DECODE(SUBSTR(TRSP_CRR_MOD_CD,2,1),'D',TRSP_CRR_MOD_CD,SUBSTR(TRSP_CRR_MOD_CD,2,1)||'D')))||
                                  DECODE(DECODE(TRSP_BND_CD,'O',TRIM(DOR_NOD_CD),TRIM(VIA_NOD_CD)),NULL,NULL,LPAD(VNDR_SEQ,6,0))||
                                DECODE(TRSP_BND_CD,'O',TRIM(VIA_NOD_CD),TRIM(DOR_NOD_CD))||DECODE(DECODE(TRSP_BND_CD,'O',TRIM(VIA_NOD_CD),TRIM(DOR_NOD_CD)),NULL,NULL,DECODE(SUBSTR(TRSP_CRR_MOD_CD,2,1),'D',TRSP_CRR_MOD_CD,SUBSTR(TRSP_CRR_MOD_CD,2,1)||'D'))||
                                  DECODE(DECODE(TRSP_BND_CD,'O',TRIM(VIA_NOD_CD),TRIM(DOR_NOD_CD)),NULL,NULL,LPAD(VNDR_SEQ,6,0))||TO_NOD_CD 
                END) 
                ROUT ,
                TRSP_BND_CD,
                COST_ACT_GRP_SEQ                      
                FROM TRS_TRSP_SVC_ORD                                                                                                         
                WHERE COP_NO = :COP_NO
                AND TRSP_BND_CD = :IO_BND_CD 
                AND DELT_FLG <> 'Y' 
                 ) SVC_ORD,                                                                                               
                (                                                                                                
                    SELECT CPY_NO F_N0 FROM COM_CPY_NO WHERE CPY_NO <=1                                 
                ) ORDER BY 1
            )
            WHERE TO_NOD_CD IS NOT NULL
            UNION ALL
            SELECT 
                TO_CHAR(B.SUB_RAIL_SEQ),
                B.FM_NOD_CD,
                B.TO_NOD_CD,
                B.TRSP_MOD_CD,
                B.VNDR_SEQ,
                (CASE WHEN COUNT(B.SUB_RAIL_SEQ) OVER (PARTITION BY B.TRSP_SO_OFC_CTY_CD ,B.TRSP_SO_SEQ) > 1 --XXXXX
                        THEN 'Y'
                      ELSE  'N'
                 END) COMB_MOD, 
                A.COST_ACT_GRP_SEQ
            FROM TRS_TRSP_RAIL_BIL_ORD A , TRS_TRSP_RAIL_BIL_VNDR_SET B 
            WHERE A.TRSP_SO_OFC_CTY_CD = B.TRSP_SO_OFC_CTY_CD                                                                     
            AND A.TRSP_SO_SEQ = B.TRSP_SO_SEQ                                                                               
            AND A.COP_NO = :COP_NO
            AND A.TRSP_BND_CD = :IO_BND_CD 
            AND A.DELT_FLG <> 'Y' 
            UNION ALL
            SELECT TO_CHAR(DENSE_RANK() OVER ( PARTITION BY G.COST_ACT_GRP_SEQ ORDER BY D.COP_GRP_SEQ,D.COP_DTL_SEQ)) RK,
            D.NOD_CD, '' TO_NOD, '' MODE_CD, NULL VNDR_SEQ, NULL COMB_MOD, G.COST_ACT_GRP_SEQ 
            FROM SCE_COP_DTL D,SCE_COP_GRP G,PRD_PROD_CTL_ROUT_DTL D2,
            (SELECT PCTL_NO, PCTL_SEQ,
            LAG(COST_ACT_GRP_SEQ, 1) OVER ( PARTITION BY PCTL_NO ORDER BY PCTL_SEQ) LAG_SEQ,
            LEAD(COST_ACT_GRP_SEQ, 1) OVER ( PARTITION BY PCTL_NO ORDER BY PCTL_SEQ) LEAD_SEQ                 
            FROM PRD_PROD_CTL_ROUT_DTL
            WHERE PCTL_NO  = (SELECT DECODE(:IO_BND_CD,'O',OB_PCTL_NO,'I',IB_PCTL_NO,PCTL_NO) 
                             FROM SCE_COP_HDR
                             WHERE COP_NO = :COP_NO)
            AND PCTL_IO_BND_CD =:IO_BND_CD
            ) D3
            WHERE D.COP_NO = :COP_NO
            AND D.ACT_DT IS NOT NULL
            AND D.ACT_STS_CD ='F'
            AND G.COP_NO = D.COP_NO
            AND G.COP_GRP_SEQ = D.COP_GRP_SEQ 
            AND G.BND_VSKD_SEQ_CD =:IO_BND_CD
            AND G.NOD_LNK_IND_CD ='N'
            AND D2.PCTL_NO = (SELECT DECODE(:IO_BND_CD,'O',OB_PCTL_NO,'I',IB_PCTL_NO,PCTL_NO) 
                             FROM SCE_COP_HDR
                             WHERE COP_NO = :COP_NO)
            AND D2.PCTL_IO_BND_CD =:IO_BND_CD
            AND D2.COST_ACT_GRP_SEQ = G.COST_ACT_GRP_SEQ
            AND D2.ORG_NOD_CD = D.NOD_CD
            AND D3.PCTL_NO = D2.PCTL_NO
            AND D3.PCTL_SEQ = D2.PCTL_SEQ
            AND NOT EXISTS  
            (SELECT 'X' FROM TRS_TRSP_SVC_ORD S  
            WHERE G.COP_NO = S.COP_NO  
            AND NVL(S.DELT_FLG,'N') <> 'Y'  
            AND ( G.COST_ACT_GRP_SEQ = S.COST_ACT_GRP_SEQ  
               OR D3.LEAD_SEQ  = S.COST_ACT_GRP_SEQ  
               OR D3.LAG_SEQ = S.COST_ACT_GRP_SEQ 
               OR D.NOD_CD = S.FM_NOD_CD
               OR D.NOD_CD = S.TO_NOD_CD
               OR D.NOD_CD = S.VIA_NOD_CD
               OR D.NOD_CD = S.DOR_NOD_CD 
               )  
            )  
            AND NOT EXISTS  
            (SELECT 'X' FROM TRS_TRSP_RAIL_BIL_ORD R , TRS_TRSP_RAIL_BIL_VNDR_SET V 
            WHERE G.COP_NO = R.COP_NO  
            AND NVL(R.DELT_FLG,'N') <> 'Y' 
            AND R.TRSP_SO_OFC_CTY_CD = V.TRSP_SO_OFC_CTY_CD
            AND R.TRSP_SO_SEQ = V.TRSP_SO_SEQ
            AND ( G.COST_ACT_GRP_SEQ = R.COST_ACT_GRP_SEQ  
               OR D3.LEAD_SEQ  = R.COST_ACT_GRP_SEQ  
               OR D3.LAG_SEQ = R.COST_ACT_GRP_SEQ  
               OR D.NOD_CD = V.FM_NOD_CD
               OR D.NOD_CD =V.TO_NOD_CD
               )  
            )  
            ORDER BY 6,1  
        ) 
     )
) 
SELECT  
REPLACE(  
REPLACE(MAX(  
               SYS_CONNECT_BY_PATH(  
               DECODE(LAG_SEQ,-1,NULL,   
                           DECODE(RK2,1,'%'||ROUT.FM_NOD_CD||DECODE(TO_NOD_CD,NULL,NULL,'@*'),NULL) 
                       	  )||  
               ROUT.MODE_CD||DECODE(TO_NOD_CD,NULL,NULL,'@*')||  
               LPAD(ROUT.VNDR_SEQ,6,0)||'@*'||ROUT.COMB_MOD||DECODE(TO_NOD_CD,NULL,NULL,'@*')||  
               ROUT.TO_NOD_CD  
               , '-')  
               ),'@*','-')||'%'  
        ,'-%','%') TS_STRING  
FROM ROUT  
START WITH ROUT.RK = 1  
CONNECT BY PRIOR ROUT.RK   = ROUT.RK -1      ;